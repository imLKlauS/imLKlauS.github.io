import{_ as s,h as l,p as o,j as n,k as a,l as e,m as t,s as c,t as p,v as r,q as E,x as y}from"../../assets/app-56b13812.js";import"../@vueuse/@vueuse.2d040ebb.js";import"../animejs/animejs.7aacf446.js";const i=JSON.parse('{"title":"缓存+分布式锁在Java项目中的应用","description":"","frontmatter":{"cover":"https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/wallhaven-281d5y_1920x1080.png","title":"缓存+分布式锁在Java项目中的应用","date":"2023-04-24T19:32:34.000Z","categories":"Java","tags":["Redis","Spring Cache","Spring Session","Redisson"],"top":180,"outline":"deep"},"headers":[{"level":2,"title":"Ⅰ.仿京东购物车系统","slug":"i-仿京东购物车系统","link":"#i-仿京东购物车系统","children":[{"level":3,"title":"1、购物车需求","slug":"_1、购物车需求","link":"#_1、购物车需求","children":[]},{"level":3,"title":"2、添加购物车","slug":"_2、添加购物车","link":"#_2、添加购物车","children":[]},{"level":3,"title":"3、购物车列表","slug":"_3、购物车列表","link":"#_3、购物车列表","children":[]},{"level":3,"title":"4、添加购物车成功页","slug":"_4、添加购物车成功页","link":"#_4、添加购物车成功页","children":[]},{"level":3,"title":"5、删除购物项","slug":"_5、删除购物项","link":"#_5、删除购物项","children":[]},{"level":3,"title":"6、改变购物项数量","slug":"_6、改变购物项数量","link":"#_6、改变购物项数量","children":[]},{"level":3,"title":"7、选中购物项","slug":"_7、选中购物项","link":"#_7、选中购物项","children":[]},{"level":3,"title":"8、获取当前登录用户的购物项列表","slug":"_8、获取当前登录用户的购物项列表","link":"#_8、获取当前登录用户的购物项列表","children":[]}]},{"level":2,"title":"Ⅱ.解决分布式下session共享问题","slug":"ii-解决分布式下session共享问题","link":"#ii-解决分布式下session共享问题","children":[{"level":3,"title":"1、session原理","slug":"_1、session原理","link":"#_1、session原理","children":[]},{"level":3,"title":"2、分布式下session共享问题","slug":"_2、分布式下session共享问题","link":"#_2、分布式下session共享问题","children":[]},{"level":3,"title":"3、解决 - session复制","slug":"_3、解决-session复制","link":"#_3、解决-session复制","children":[]},{"level":3,"title":"4、解决 - 客户端存储","slug":"_4、解决-客户端存储","link":"#_4、解决-客户端存储","children":[]},{"level":3,"title":"5、解决 - hash一致性","slug":"_5、解决-hash一致性","link":"#_5、解决-hash一致性","children":[]},{"level":3,"title":"6、解决 - 统一存储","slug":"_6、解决-统一存储","link":"#_6、解决-统一存储","children":[]},{"level":3,"title":"7、解决 - 不同服务，子域session共享","slug":"_7、解决-不同服务-子域session共享","link":"#_7、解决-不同服务-子域session共享","children":[]},{"level":3,"title":"8、SpringSession核心原理","slug":"_8、springsession核心原理","link":"#_8、springsession核心原理","children":[]},{"level":3,"title":"9、应用","slug":"_9、应用","link":"#_9、应用","children":[]}]},{"level":2,"title":"Ⅲ.商品系统缓存所有分类","slug":"iii-商品系统缓存所有分类","link":"#iii-商品系统缓存所有分类","children":[{"level":3,"title":"一、缓存","slug":"一、缓存","link":"#一、缓存","children":[]},{"level":3,"title":"二、缓存失效问题","slug":"二、缓存失效问题","link":"#二、缓存失效问题","children":[]},{"level":3,"title":"三、缓存数据一致性","slug":"三、缓存数据一致性","link":"#三、缓存数据一致性","children":[]},{"level":3,"title":"四、分布式锁","slug":"四、分布式锁","link":"#四、分布式锁","children":[]},{"level":3,"title":"五、Spring Cache","slug":"五、spring-cache","link":"#五、spring-cache","children":[]}]}],"relativePath":"pages/posts/Application of Cache + distributed locking in Java project.md","path":"D:\\\\Learning\\\\myblog\\\\valaxy-blog\\\\imklaus.github.io-main\\\\pages\\\\posts\\\\Application of Cache + distributed locking in Java project.md","lastUpdated":null}'),u=JSON.parse('{"title":"缓存+分布式锁在Java项目中的应用","description":"","frontmatter":{"cover":"https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/wallhaven-281d5y_1920x1080.png","title":"缓存+分布式锁在Java项目中的应用","date":"2023-04-24T19:32:34.000Z","categories":"Java","tags":["Redis","Spring Cache","Spring Session","Redisson"],"top":180,"outline":"deep"},"headers":[{"level":2,"title":"Ⅰ.仿京东购物车系统","slug":"i-仿京东购物车系统","link":"#i-仿京东购物车系统","children":[{"level":3,"title":"1、购物车需求","slug":"_1、购物车需求","link":"#_1、购物车需求","children":[]},{"level":3,"title":"2、添加购物车","slug":"_2、添加购物车","link":"#_2、添加购物车","children":[]},{"level":3,"title":"3、购物车列表","slug":"_3、购物车列表","link":"#_3、购物车列表","children":[]},{"level":3,"title":"4、添加购物车成功页","slug":"_4、添加购物车成功页","link":"#_4、添加购物车成功页","children":[]},{"level":3,"title":"5、删除购物项","slug":"_5、删除购物项","link":"#_5、删除购物项","children":[]},{"level":3,"title":"6、改变购物项数量","slug":"_6、改变购物项数量","link":"#_6、改变购物项数量","children":[]},{"level":3,"title":"7、选中购物项","slug":"_7、选中购物项","link":"#_7、选中购物项","children":[]},{"level":3,"title":"8、获取当前登录用户的购物项列表","slug":"_8、获取当前登录用户的购物项列表","link":"#_8、获取当前登录用户的购物项列表","children":[]}]},{"level":2,"title":"Ⅱ.解决分布式下session共享问题","slug":"ii-解决分布式下session共享问题","link":"#ii-解决分布式下session共享问题","children":[{"level":3,"title":"1、session原理","slug":"_1、session原理","link":"#_1、session原理","children":[]},{"level":3,"title":"2、分布式下session共享问题","slug":"_2、分布式下session共享问题","link":"#_2、分布式下session共享问题","children":[]},{"level":3,"title":"3、解决 - session复制","slug":"_3、解决-session复制","link":"#_3、解决-session复制","children":[]},{"level":3,"title":"4、解决 - 客户端存储","slug":"_4、解决-客户端存储","link":"#_4、解决-客户端存储","children":[]},{"level":3,"title":"5、解决 - hash一致性","slug":"_5、解决-hash一致性","link":"#_5、解决-hash一致性","children":[]},{"level":3,"title":"6、解决 - 统一存储","slug":"_6、解决-统一存储","link":"#_6、解决-统一存储","children":[]},{"level":3,"title":"7、解决 - 不同服务，子域session共享","slug":"_7、解决-不同服务-子域session共享","link":"#_7、解决-不同服务-子域session共享","children":[]},{"level":3,"title":"8、SpringSession核心原理","slug":"_8、springsession核心原理","link":"#_8、springsession核心原理","children":[]},{"level":3,"title":"9、应用","slug":"_9、应用","link":"#_9、应用","children":[]}]},{"level":2,"title":"Ⅲ.商品系统缓存所有分类","slug":"iii-商品系统缓存所有分类","link":"#iii-商品系统缓存所有分类","children":[{"level":3,"title":"一、缓存","slug":"一、缓存","link":"#一、缓存","children":[]},{"level":3,"title":"二、缓存失效问题","slug":"二、缓存失效问题","link":"#二、缓存失效问题","children":[]},{"level":3,"title":"三、缓存数据一致性","slug":"三、缓存数据一致性","link":"#三、缓存数据一致性","children":[]},{"level":3,"title":"四、分布式锁","slug":"四、分布式锁","link":"#四、分布式锁","children":[]},{"level":3,"title":"五、Spring Cache","slug":"五、spring-cache","link":"#五、spring-cache","children":[]}]}],"relativePath":"pages/posts/Application of Cache + distributed locking in Java project.md","path":"D:\\\\Learning\\\\myblog\\\\valaxy-blog\\\\imklaus.github.io-main\\\\pages\\\\posts\\\\Application of Cache + distributed locking in Java project.md","lastUpdated":null}'),d={name:"pages/posts/Application of Cache + distributed locking in Java project.md",data:()=>({data:u,frontmatter:u.frontmatter,$frontmatter:u.frontmatter}),setup(){const s=l();s.meta.frontmatter=Object.assign(s.meta.frontmatter,u.frontmatter),o("pageData",u)}},g=c("hr",null,null,-1),F={id:"i-仿京东购物车系统",tabindex:"-1"},D=c("ul",null,[c("li",null,[p("购物车Redis数据结构选型： "),c("ul",null,[c("li",null,[p("双层 Map："),c("code",null,"Map<String,Map<String,String>>"),c("ul",null,[c("li",null,"第一层 Map，Key 是用户 id"),c("li",null,"第二层 Map，Key 是购物车中商品 id，值是购物项数据")])])])]),c("li",null,[p("购物车两个核心功能：新增商品到购物车、查询购物车 "),c("ul",null,[c("li",null,[p("新增商品：判断是否登录 "),c("ul",null,[c("li",null,"是：则添加商品到后台 Redis 中，把 user 的唯一标识符作为 key。"),c("li",null,"否：则添加商品到后台 Redis 中，使用随机生成的 user-key 作为 key。")])])])]),c("li",null,[p("查询购物车列表：判断是否登录 "),c("ul",null,[c("li",null,"否：直接根据 user-key 查询 Redis 中数据并展示"),c("li",null,"是：已登录，则需要先根据 user-key 查询 Redis 是否有数据。"),c("li",null,"有：需要提交到后台添加到 Redis ，合并数据，而后查询。"),c("li",null,"否：直接去后台查询 Redis ，而后返回")])])],-1),A={id:"_1、购物车需求",tabindex:"-1"},C={id:"_1-、需求描述",tabindex:"-1"},h=c("ul",null,[c("li",null,[p("用户可以在登录状态下将商品添加到购物车【用户购物车/在线购物车】 "),c("ul",null,[c("li",null,"放入数据库"),c("li",null,"mongodb"),c("li",null,[p("放入 redis（采用） "),c("ul",null,[c("li",null,"登录以后，会将临时购物车的数据全部合并过来，并清空临时购物车；")])])])]),c("li",null,[p("用户可以在未登录状态下将商品添加到购物车【游客购物车/离线购物车/临时购物车】 "),c("ul",null,[c("li",null,"放入 localstorage（客户端存储，后台不存）"),c("li",null,"cookie"),c("li",null,"WebSQL"),c("li",null,[p("放入 redis（采用） "),c("ul",null,[c("li",null,"浏览器即使关闭，下次进入，临时购物车数据都在")])])])]),c("li",null,"用户可以使用购物车一起结算下单"),c("li",null,"给购物车添加商品"),c("li",null,"用户可以查询自己的购物车"),c("li",null,"用户可以在购物车中修改购买商品的数量。"),c("li",null,"用户可以在购物车中删除商品。"),c("li",null,"选中不选中商品"),c("li",null,"在购物车中展示商品优惠信息"),c("li",null,"提示购物车商品价格变化")],-1),m={id:"_2-、数据结构",tabindex:"-1"},k=c("figure",null,[c("img",{src:"https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230410200320343.png",alt:"image-20230410200320343",loading:"lazy",decoding:"async"})],-1),b=c("blockquote",null,[c("ul",null,[c("li",null,[c("code",null,"Map<String k1,Map<String k2,CartItemInfo>>"),p(" | 在redis中")]),c("li",null,"k1：标识每一个用户的购物车 | key:用户标识"),c("li",null,"k2：购物项的商品id | value:Hash（k：商品id，v：购物项详情）")])],-1),B=c("figure",null,[c("img",{src:"https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230424202014610.png",alt:"image-20230424202014610",loading:"lazy",decoding:"async"})],-1),S=c("p",null,"因此每一个购物项信息，都是一个对象，基本字段包括：",-1),I=c("div",{class:"language-json"},[c("button",{title:"Copy Code",class:"copy"}),c("span",{class:"lang"},"json"),c("pre",{class:"shiki github-dark vp-code-dark"},[c("code",null,[c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"{")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"\t"),c("span",{style:{color:"#FDAEB7","font-style":"italic"}},"skuId"),c("span",{style:{color:"#E1E4E8"}},": "),c("span",{style:{color:"#79B8FF"}},"2131241"),c("span",{style:{color:"#E1E4E8"}},",")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"\t"),c("span",{style:{color:"#FDAEB7","font-style":"italic"}},"check"),c("span",{style:{color:"#E1E4E8"}},": "),c("span",{style:{color:"#79B8FF"}},"true"),c("span",{style:{color:"#E1E4E8"}},",")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"\t"),c("span",{style:{color:"#FDAEB7","font-style":"italic"}},"title"),c("span",{style:{color:"#E1E4E8"}},": "),c("span",{style:{color:"#9ECBFF"}},'"Apple iphone....."'),c("span",{style:{color:"#E1E4E8"}},",")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"\t"),c("span",{style:{color:"#FDAEB7","font-style":"italic"}},"defaultImage"),c("span",{style:{color:"#E1E4E8"}},": "),c("span",{style:{color:"#9ECBFF"}},'"..."'),c("span",{style:{color:"#E1E4E8"}},",")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"\t"),c("span",{style:{color:"#FDAEB7","font-style":"italic"}},"price"),c("span",{style:{color:"#E1E4E8"}},": "),c("span",{style:{color:"#79B8FF"}},"4999"),c("span",{style:{color:"#E1E4E8"}},",")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"\t"),c("span",{style:{color:"#FDAEB7","font-style":"italic"}},"count"),c("span",{style:{color:"#E1E4E8"}},": "),c("span",{style:{color:"#79B8FF"}},"1"),c("span",{style:{color:"#E1E4E8"}},",")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"\t"),c("span",{style:{color:"#FDAEB7","font-style":"italic"}},"totalPrice"),c("span",{style:{color:"#E1E4E8"}},": "),c("span",{style:{color:"#79B8FF"}},"4999"),c("span",{style:{color:"#E1E4E8"}},",")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"\t"),c("span",{style:{color:"#FDAEB7","font-style":"italic"}},"skuSaleVO"),c("span",{style:{color:"#E1E4E8"}},": {"),c("span",{style:{color:"#FDAEB7","font-style":"italic"}},"..."),c("span",{style:{color:"#E1E4E8"}},"}")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"}")])])]),c("pre",{class:"shiki github-light vp-code-light"},[c("code",null,[c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"{")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"\t"),c("span",{style:{color:"#B31D28","font-style":"italic"}},"skuId"),c("span",{style:{color:"#24292E"}},": "),c("span",{style:{color:"#005CC5"}},"2131241"),c("span",{style:{color:"#24292E"}},",")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"\t"),c("span",{style:{color:"#B31D28","font-style":"italic"}},"check"),c("span",{style:{color:"#24292E"}},": "),c("span",{style:{color:"#005CC5"}},"true"),c("span",{style:{color:"#24292E"}},",")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"\t"),c("span",{style:{color:"#B31D28","font-style":"italic"}},"title"),c("span",{style:{color:"#24292E"}},": "),c("span",{style:{color:"#032F62"}},'"Apple iphone....."'),c("span",{style:{color:"#24292E"}},",")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"\t"),c("span",{style:{color:"#B31D28","font-style":"italic"}},"defaultImage"),c("span",{style:{color:"#24292E"}},": "),c("span",{style:{color:"#032F62"}},'"..."'),c("span",{style:{color:"#24292E"}},",")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"\t"),c("span",{style:{color:"#B31D28","font-style":"italic"}},"price"),c("span",{style:{color:"#24292E"}},": "),c("span",{style:{color:"#005CC5"}},"4999"),c("span",{style:{color:"#24292E"}},",")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"\t"),c("span",{style:{color:"#B31D28","font-style":"italic"}},"count"),c("span",{style:{color:"#24292E"}},": "),c("span",{style:{color:"#005CC5"}},"1"),c("span",{style:{color:"#24292E"}},",")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"\t"),c("span",{style:{color:"#B31D28","font-style":"italic"}},"totalPrice"),c("span",{style:{color:"#24292E"}},": "),c("span",{style:{color:"#005CC5"}},"4999"),c("span",{style:{color:"#24292E"}},",")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"\t"),c("span",{style:{color:"#B31D28","font-style":"italic"}},"skuSaleVO"),c("span",{style:{color:"#24292E"}},": {"),c("span",{style:{color:"#B31D28","font-style":"italic"}},"..."),c("span",{style:{color:"#24292E"}},"}")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"}")])])])],-1),f=c("p",null,"另外，购物车中不止一条数据，因此最终会是对象的数组。即：",-1),v=c("div",{class:"language-json"},[c("button",{title:"Copy Code",class:"copy"}),c("span",{class:"lang"},"json"),c("pre",{class:"shiki github-dark vp-code-dark"},[c("code",null,[c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"[")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"\t{"),c("span",{style:{color:"#FDAEB7","font-style":"italic"}},"..."),c("span",{style:{color:"#E1E4E8"}},"},{"),c("span",{style:{color:"#FDAEB7","font-style":"italic"}},"..."),c("span",{style:{color:"#E1E4E8"}},"},{"),c("span",{style:{color:"#FDAEB7","font-style":"italic"}},"..."),c("span",{style:{color:"#E1E4E8"}},"}")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"]")])])]),c("pre",{class:"shiki github-light vp-code-light"},[c("code",null,[c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"[")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"\t{"),c("span",{style:{color:"#B31D28","font-style":"italic"}},"..."),c("span",{style:{color:"#24292E"}},"},{"),c("span",{style:{color:"#B31D28","font-style":"italic"}},"..."),c("span",{style:{color:"#24292E"}},"},{"),c("span",{style:{color:"#B31D28","font-style":"italic"}},"..."),c("span",{style:{color:"#24292E"}},"}")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"]")])])])],-1),L=c("blockquote",null,[c("p",null,[p("Redis 有 5 种不同数据结构，这里选择哪一种比较合适呢？"),c("code",null,"Map<String, List<String>>")]),c("ul",null,[c("li",null,[p("首先不同用户应该有独立的购物车，因此购物车应该以用户的作为 key 来存储，Value 是 用户的所有购物车信息。这样看来基本的"),c("code",null,"k-v"),p("结构就可以了。")]),c("li",null,[p("但是，我们对购物车中的商品进行增、删、改操作，基本都需要根据商品 id 进行判断， 为了方便后期处理，我们的购物车也应该是"),c("code",null,"k-v"),p("结构，key 是商品 id，value 才是这个商品的 购物车信息。 综上所述，我们的购物车结构是一个双层 Map：Map<String,Map<String,String>>")]),c("li",null,"第一层 Map，Key 是用户 id"),c("li",null,"第二层 Map，Key 是购物车中商品 id，值是购物项数据")])],-1),_={id:"_3-、流程",tabindex:"-1"},R=c("p",null,"参照京东",-1),T=c("figure",null,[c("img",{src:"https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230425192047077.png",alt:"image-20230425192047077",loading:"lazy",decoding:"async"})],-1),j=c("p",null,"user-key 是随机生成的 id，不管有没有登录都会有这个 cookie 信息。",-1),O=c("p",null,"两个功能：新增商品到购物车、查询购物车。",-1),x=c("ul",null,[c("li",null,[c("p",null,"新增商品：判断是否登录"),c("ul",null,[c("li",null,"是：则添加商品到后台 Redis 中，把 user 的唯一标识符作为 key。")])]),c("li",null,[c("p",null,"否：则添加商品到后台 redis 中，使用随机生成的 user-key 作为 key。")]),c("li",null,[c("p",null,"查询购物车列表：判断是否登录"),c("ul",null,[c("li",null,"否：直接根据 user-key 查询 redis 中数据并展示"),c("li",null,"是：已登录，则需要先根据 user-key 查询 redis 是否有数据。"),c("li",null,"有：需要提交到后台添加到 redis，合并数据，而后查询。"),c("li",null,"否：直接去后台查询 redis，而后返回。")])])],-1),V={id:"_4-、引入依赖",tabindex:"-1"},z=c("div",{class:"language-xml"},[c("button",{title:"Copy Code",class:"copy"}),c("span",{class:"lang"},"xml"),c("pre",{class:"shiki github-dark vp-code-dark"},[c("code",null,[c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"\x3c!-- 引入redis --\x3e")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"<"),c("span",{style:{color:"#85E89D"}},"dependency"),c("span",{style:{color:"#E1E4E8"}},">")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"  <"),c("span",{style:{color:"#85E89D"}},"groupId"),c("span",{style:{color:"#E1E4E8"}},">org.springframework.boot</"),c("span",{style:{color:"#85E89D"}},"groupId"),c("span",{style:{color:"#E1E4E8"}},">")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"  <"),c("span",{style:{color:"#85E89D"}},"artifactId"),c("span",{style:{color:"#E1E4E8"}},">spring-boot-starter-data-redis</"),c("span",{style:{color:"#85E89D"}},"artifactId"),c("span",{style:{color:"#E1E4E8"}},">")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"</"),c("span",{style:{color:"#85E89D"}},"dependency"),c("span",{style:{color:"#E1E4E8"}},">")])])]),c("pre",{class:"shiki github-light vp-code-light"},[c("code",null,[c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"\x3c!-- 引入redis --\x3e")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"<"),c("span",{style:{color:"#22863A"}},"dependency"),c("span",{style:{color:"#24292E"}},">")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"  <"),c("span",{style:{color:"#22863A"}},"groupId"),c("span",{style:{color:"#24292E"}},">org.springframework.boot</"),c("span",{style:{color:"#22863A"}},"groupId"),c("span",{style:{color:"#24292E"}},">")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"  <"),c("span",{style:{color:"#22863A"}},"artifactId"),c("span",{style:{color:"#24292E"}},">spring-boot-starter-data-redis</"),c("span",{style:{color:"#22863A"}},"artifactId"),c("span",{style:{color:"#24292E"}},">")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"</"),c("span",{style:{color:"#22863A"}},"dependency"),c("span",{style:{color:"#24292E"}},">")])])])],-1),w={id:"_2、添加购物车",tabindex:"-1"},M=c("ul",null,[c("li",null,[p("用户信息数据传输To "),c("ul",null,[c("li",null,"tempUser = false表示默认是登录用户，即将用户唯一id作为缓存key"),c("li",null,"tempUser = true表示是游客身份，系统将生成随机码user-key作为缓存key")])])],-1),U=c("div",{class:"language-java"},[c("button",{title:"Copy Code",class:"copy"}),c("span",{class:"lang"},"java"),c("pre",{class:"shiki github-dark vp-code-dark"},[c("code",null,[c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"@"),c("span",{style:{color:"#F97583"}},"ToString")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"@"),c("span",{style:{color:"#F97583"}},"Data")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#F97583"}},"public"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#F97583"}},"class"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#B392F0"}},"UserInfoTo"),c("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#F97583"}},"private"),c("span",{style:{color:"#E1E4E8"}}," Long userId;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#F97583"}},"private"),c("span",{style:{color:"#E1E4E8"}}," String userKey;"),c("span",{style:{color:"#6A737D"}},"//一定封装")]),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#F97583"}},"private"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#F97583"}},"boolean"),c("span",{style:{color:"#E1E4E8"}}," tempUser "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#79B8FF"}},"false"),c("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"}")])])]),c("pre",{class:"shiki github-light vp-code-light"},[c("code",null,[c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"@"),c("span",{style:{color:"#D73A49"}},"ToString")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"@"),c("span",{style:{color:"#D73A49"}},"Data")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#D73A49"}},"public"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#D73A49"}},"class"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#6F42C1"}},"UserInfoTo"),c("span",{style:{color:"#24292E"}}," {")]),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#D73A49"}},"private"),c("span",{style:{color:"#24292E"}}," Long userId;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#D73A49"}},"private"),c("span",{style:{color:"#24292E"}}," String userKey;"),c("span",{style:{color:"#6A737D"}},"//一定封装")]),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#D73A49"}},"private"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#D73A49"}},"boolean"),c("span",{style:{color:"#24292E"}}," tempUser "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#005CC5"}},"false"),c("span",{style:{color:"#24292E"}},";")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"}")])])])],-1),J=c("ul",null,[c("li",null,"购物车拦截器")],-1),P=c("div",{class:"language-java"},[c("button",{title:"Copy Code",class:"copy"}),c("span",{class:"lang"},"java"),c("pre",{class:"shiki github-dark vp-code-dark"},[c("code",null,[c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"/**")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}}," * 拦截器")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}}," * 在执行目标方法之前，判断用户的登录状态，并封装传递给controller目标请求")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}}," * "),c("span",{style:{color:"#F97583"}},"@author"),c("span",{style:{color:"#6A737D"}}," Klaus")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}}," * @date 2022/9/19")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}}," */")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#F97583"}},"public"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#F97583"}},"class"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#B392F0"}},"CartInterceptor"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#F97583"}},"implements"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#B392F0"}},"HandlerInterceptor"),c("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#F97583"}},"public"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#F97583"}},"static"),c("span",{style:{color:"#E1E4E8"}}," ThreadLocal<"),c("span",{style:{color:"#F97583"}},"UserInfoTo"),c("span",{style:{color:"#E1E4E8"}},"> threadLocal "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#F97583"}},"new"),c("span",{style:{color:"#E1E4E8"}}," ThreadLocal<>();")]),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"    /**")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"     * 目标方法执行之前")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"     * "),c("span",{style:{color:"#F97583"}},"@param"),c("span",{style:{color:"#6A737D"}}," "),c("span",{style:{color:"#FFAB70"}},"request")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"     * "),c("span",{style:{color:"#F97583"}},"@param"),c("span",{style:{color:"#6A737D"}}," "),c("span",{style:{color:"#FFAB70"}},"response")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"     * "),c("span",{style:{color:"#F97583"}},"@param"),c("span",{style:{color:"#6A737D"}}," "),c("span",{style:{color:"#FFAB70"}},"handler")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"     * "),c("span",{style:{color:"#F97583"}},"@return")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"     * "),c("span",{style:{color:"#F97583"}},"@throws"),c("span",{style:{color:"#6A737D"}}," "),c("span",{style:{color:"#B392F0"}},"Exception")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"     */")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    @"),c("span",{style:{color:"#F97583"}},"Override")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#F97583"}},"public"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#F97583"}},"boolean"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#B392F0"}},"preHandle"),c("span",{style:{color:"#E1E4E8"}},"(HttpServletRequest "),c("span",{style:{color:"#FFAB70"}},"request"),c("span",{style:{color:"#E1E4E8"}},", HttpServletResponse "),c("span",{style:{color:"#FFAB70"}},"response"),c("span",{style:{color:"#E1E4E8"}},",")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"                             Object "),c("span",{style:{color:"#FFAB70"}},"handler"),c("span",{style:{color:"#E1E4E8"}},") "),c("span",{style:{color:"#F97583"}},"throws"),c("span",{style:{color:"#E1E4E8"}}," Exception {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        UserInfoTo userInfoTo "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#F97583"}},"new"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#B392F0"}},"UserInfoTo"),c("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        HttpSession session "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," request."),c("span",{style:{color:"#B392F0"}},"getSession"),c("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        MemberRespVo member "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," (MemberRespVo) session."),c("span",{style:{color:"#B392F0"}},"getAttribute"),c("span",{style:{color:"#E1E4E8"}},"(AuthServerConstant.LOGIN_USER);")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        "),c("span",{style:{color:"#F97583"}},"if"),c("span",{style:{color:"#E1E4E8"}}," (member "),c("span",{style:{color:"#F97583"}},"!="),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#79B8FF"}},"null"),c("span",{style:{color:"#E1E4E8"}},"){")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"            "),c("span",{style:{color:"#6A737D"}},"//用户登录")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"            userInfoTo."),c("span",{style:{color:"#B392F0"}},"setUserId"),c("span",{style:{color:"#E1E4E8"}},"(member."),c("span",{style:{color:"#B392F0"}},"getId"),c("span",{style:{color:"#E1E4E8"}},"());")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        }")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        "),c("span",{style:{color:"#F97583"}},"Cookie"),c("span",{style:{color:"#E1E4E8"}},"[] cookies "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," request."),c("span",{style:{color:"#B392F0"}},"getCookies"),c("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        "),c("span",{style:{color:"#F97583"}},"if"),c("span",{style:{color:"#E1E4E8"}}," (cookies "),c("span",{style:{color:"#F97583"}},"!="),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#79B8FF"}},"null"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#F97583"}},"&&"),c("span",{style:{color:"#E1E4E8"}}," cookies.length "),c("span",{style:{color:"#F97583"}},">"),c("span",{style:{color:"#79B8FF"}},"0"),c("span",{style:{color:"#E1E4E8"}},"){")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"            "),c("span",{style:{color:"#F97583"}},"for"),c("span",{style:{color:"#E1E4E8"}}," (Cookie cookie "),c("span",{style:{color:"#F97583"}},":"),c("span",{style:{color:"#E1E4E8"}}," cookies) {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"                "),c("span",{style:{color:"#6A737D"}},"//user-key")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"                String name "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," cookie."),c("span",{style:{color:"#B392F0"}},"getName"),c("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"                "),c("span",{style:{color:"#F97583"}},"if"),c("span",{style:{color:"#E1E4E8"}}," (name."),c("span",{style:{color:"#B392F0"}},"equals"),c("span",{style:{color:"#E1E4E8"}},"(CartConstant.TEMP_USER_COOKIE_NAME)){")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"                    "),c("span",{style:{color:"#6A737D"}},"//user-key:  afrwgrgrg3r")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"                    userInfoTo."),c("span",{style:{color:"#B392F0"}},"setUserKey"),c("span",{style:{color:"#E1E4E8"}},"(cookie."),c("span",{style:{color:"#B392F0"}},"getValue"),c("span",{style:{color:"#E1E4E8"}},"());")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"                    userInfoTo."),c("span",{style:{color:"#B392F0"}},"setTempUser"),c("span",{style:{color:"#E1E4E8"}},"("),c("span",{style:{color:"#79B8FF"}},"true"),c("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"                }")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"            }")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        }")]),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        "),c("span",{style:{color:"#6A737D"}},"//如果没有临时用户一定分配一个临时用户")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        "),c("span",{style:{color:"#F97583"}},"if"),c("span",{style:{color:"#E1E4E8"}}," (StringUtils."),c("span",{style:{color:"#B392F0"}},"isEmpty"),c("span",{style:{color:"#E1E4E8"}},"(userInfoTo."),c("span",{style:{color:"#B392F0"}},"getUserKey"),c("span",{style:{color:"#E1E4E8"}},"())){")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"            String uuid "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," UUID."),c("span",{style:{color:"#B392F0"}},"randomUUID"),c("span",{style:{color:"#E1E4E8"}},"()."),c("span",{style:{color:"#B392F0"}},"toString"),c("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"            userInfoTo."),c("span",{style:{color:"#B392F0"}},"setUserKey"),c("span",{style:{color:"#E1E4E8"}},"(uuid);")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        }")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        "),c("span",{style:{color:"#6A737D"}},"//目标方法执行之前")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        threadLocal."),c("span",{style:{color:"#B392F0"}},"set"),c("span",{style:{color:"#E1E4E8"}},"(userInfoTo);")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        "),c("span",{style:{color:"#F97583"}},"return"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#79B8FF"}},"true"),c("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"    /**")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"     * 业务执行之后，分配临时用户，让浏览器保存")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"     * "),c("span",{style:{color:"#F97583"}},"@param"),c("span",{style:{color:"#6A737D"}}," "),c("span",{style:{color:"#FFAB70"}},"request")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"     * "),c("span",{style:{color:"#F97583"}},"@param"),c("span",{style:{color:"#6A737D"}}," "),c("span",{style:{color:"#FFAB70"}},"response")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"     * "),c("span",{style:{color:"#F97583"}},"@param"),c("span",{style:{color:"#6A737D"}}," "),c("span",{style:{color:"#FFAB70"}},"handler")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"     * "),c("span",{style:{color:"#F97583"}},"@param"),c("span",{style:{color:"#6A737D"}}," "),c("span",{style:{color:"#FFAB70"}},"modelAndView")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"     * "),c("span",{style:{color:"#F97583"}},"@throws"),c("span",{style:{color:"#6A737D"}}," "),c("span",{style:{color:"#B392F0"}},"Exception")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"     */")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    @"),c("span",{style:{color:"#F97583"}},"Override")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#F97583"}},"public"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#F97583"}},"void"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#B392F0"}},"postHandle"),c("span",{style:{color:"#E1E4E8"}},"(HttpServletRequest "),c("span",{style:{color:"#FFAB70"}},"request"),c("span",{style:{color:"#E1E4E8"}},", HttpServletResponse "),c("span",{style:{color:"#FFAB70"}},"response"),c("span",{style:{color:"#E1E4E8"}},", Object "),c("span",{style:{color:"#FFAB70"}},"handler"),c("span",{style:{color:"#E1E4E8"}},", ModelAndView "),c("span",{style:{color:"#FFAB70"}},"modelAndView"),c("span",{style:{color:"#E1E4E8"}},") "),c("span",{style:{color:"#F97583"}},"throws"),c("span",{style:{color:"#E1E4E8"}}," Exception {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        UserInfoTo userInfoTo "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," threadLocal."),c("span",{style:{color:"#B392F0"}},"get"),c("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        "),c("span",{style:{color:"#6A737D"}},"//如果没有临时用户一定保存一个临时用户，默认不是")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        "),c("span",{style:{color:"#F97583"}},"if"),c("span",{style:{color:"#E1E4E8"}}," ("),c("span",{style:{color:"#F97583"}},"!"),c("span",{style:{color:"#E1E4E8"}},"userInfoTo."),c("span",{style:{color:"#B392F0"}},"isTempUser"),c("span",{style:{color:"#E1E4E8"}},"()){")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"            "),c("span",{style:{color:"#6A737D"}},"//是临时用户")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"            "),c("span",{style:{color:"#6A737D"}},"//将user-key放入cookie")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"            Cookie cookie "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#F97583"}},"new"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#B392F0"}},"Cookie"),c("span",{style:{color:"#E1E4E8"}},"(CartConstant.TEMP_USER_COOKIE_NAME, userInfoTo."),c("span",{style:{color:"#B392F0"}},"getUserKey"),c("span",{style:{color:"#E1E4E8"}},"());")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"            "),c("span",{style:{color:"#6A737D"}},"//作用域")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"            cookie."),c("span",{style:{color:"#B392F0"}},"setDomain"),c("span",{style:{color:"#E1E4E8"}},"("),c("span",{style:{color:"#9ECBFF"}},'"gulimall.com"'),c("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"            "),c("span",{style:{color:"#6A737D"}},"//持续延迟临时用户的过期时间")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"            cookie."),c("span",{style:{color:"#B392F0"}},"setMaxAge"),c("span",{style:{color:"#E1E4E8"}},"(CartConstant.TEMP_USER_COOKIE_TIMEOUT);")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"            "),c("span",{style:{color:"#6A737D"}},"//响应头里加入cookie")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"            response."),c("span",{style:{color:"#B392F0"}},"addCookie"),c("span",{style:{color:"#E1E4E8"}},"(cookie);")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        }")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"}")])])]),c("pre",{class:"shiki github-light vp-code-light"},[c("code",null,[c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"/**")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}}," * 拦截器")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}}," * 在执行目标方法之前，判断用户的登录状态，并封装传递给controller目标请求")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}}," * "),c("span",{style:{color:"#D73A49"}},"@author"),c("span",{style:{color:"#6A737D"}}," Klaus")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}}," * @date 2022/9/19")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}}," */")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#D73A49"}},"public"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#D73A49"}},"class"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#6F42C1"}},"CartInterceptor"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#D73A49"}},"implements"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#6F42C1"}},"HandlerInterceptor"),c("span",{style:{color:"#24292E"}}," {")]),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#D73A49"}},"public"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#D73A49"}},"static"),c("span",{style:{color:"#24292E"}}," ThreadLocal<"),c("span",{style:{color:"#D73A49"}},"UserInfoTo"),c("span",{style:{color:"#24292E"}},"> threadLocal "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#D73A49"}},"new"),c("span",{style:{color:"#24292E"}}," ThreadLocal<>();")]),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"    /**")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"     * 目标方法执行之前")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"     * "),c("span",{style:{color:"#D73A49"}},"@param"),c("span",{style:{color:"#6A737D"}}," "),c("span",{style:{color:"#E36209"}},"request")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"     * "),c("span",{style:{color:"#D73A49"}},"@param"),c("span",{style:{color:"#6A737D"}}," "),c("span",{style:{color:"#E36209"}},"response")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"     * "),c("span",{style:{color:"#D73A49"}},"@param"),c("span",{style:{color:"#6A737D"}}," "),c("span",{style:{color:"#E36209"}},"handler")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"     * "),c("span",{style:{color:"#D73A49"}},"@return")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"     * "),c("span",{style:{color:"#D73A49"}},"@throws"),c("span",{style:{color:"#6A737D"}}," "),c("span",{style:{color:"#6F42C1"}},"Exception")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"     */")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    @"),c("span",{style:{color:"#D73A49"}},"Override")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#D73A49"}},"public"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#D73A49"}},"boolean"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#6F42C1"}},"preHandle"),c("span",{style:{color:"#24292E"}},"(HttpServletRequest "),c("span",{style:{color:"#E36209"}},"request"),c("span",{style:{color:"#24292E"}},", HttpServletResponse "),c("span",{style:{color:"#E36209"}},"response"),c("span",{style:{color:"#24292E"}},",")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"                             Object "),c("span",{style:{color:"#E36209"}},"handler"),c("span",{style:{color:"#24292E"}},") "),c("span",{style:{color:"#D73A49"}},"throws"),c("span",{style:{color:"#24292E"}}," Exception {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        UserInfoTo userInfoTo "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#D73A49"}},"new"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#6F42C1"}},"UserInfoTo"),c("span",{style:{color:"#24292E"}},"();")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        HttpSession session "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," request."),c("span",{style:{color:"#6F42C1"}},"getSession"),c("span",{style:{color:"#24292E"}},"();")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        MemberRespVo member "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," (MemberRespVo) session."),c("span",{style:{color:"#6F42C1"}},"getAttribute"),c("span",{style:{color:"#24292E"}},"(AuthServerConstant.LOGIN_USER);")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        "),c("span",{style:{color:"#D73A49"}},"if"),c("span",{style:{color:"#24292E"}}," (member "),c("span",{style:{color:"#D73A49"}},"!="),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#005CC5"}},"null"),c("span",{style:{color:"#24292E"}},"){")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"            "),c("span",{style:{color:"#6A737D"}},"//用户登录")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"            userInfoTo."),c("span",{style:{color:"#6F42C1"}},"setUserId"),c("span",{style:{color:"#24292E"}},"(member."),c("span",{style:{color:"#6F42C1"}},"getId"),c("span",{style:{color:"#24292E"}},"());")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        }")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        "),c("span",{style:{color:"#D73A49"}},"Cookie"),c("span",{style:{color:"#24292E"}},"[] cookies "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," request."),c("span",{style:{color:"#6F42C1"}},"getCookies"),c("span",{style:{color:"#24292E"}},"();")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        "),c("span",{style:{color:"#D73A49"}},"if"),c("span",{style:{color:"#24292E"}}," (cookies "),c("span",{style:{color:"#D73A49"}},"!="),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#005CC5"}},"null"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#D73A49"}},"&&"),c("span",{style:{color:"#24292E"}}," cookies.length "),c("span",{style:{color:"#D73A49"}},">"),c("span",{style:{color:"#005CC5"}},"0"),c("span",{style:{color:"#24292E"}},"){")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"            "),c("span",{style:{color:"#D73A49"}},"for"),c("span",{style:{color:"#24292E"}}," (Cookie cookie "),c("span",{style:{color:"#D73A49"}},":"),c("span",{style:{color:"#24292E"}}," cookies) {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"                "),c("span",{style:{color:"#6A737D"}},"//user-key")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"                String name "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," cookie."),c("span",{style:{color:"#6F42C1"}},"getName"),c("span",{style:{color:"#24292E"}},"();")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"                "),c("span",{style:{color:"#D73A49"}},"if"),c("span",{style:{color:"#24292E"}}," (name."),c("span",{style:{color:"#6F42C1"}},"equals"),c("span",{style:{color:"#24292E"}},"(CartConstant.TEMP_USER_COOKIE_NAME)){")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"                    "),c("span",{style:{color:"#6A737D"}},"//user-key:  afrwgrgrg3r")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"                    userInfoTo."),c("span",{style:{color:"#6F42C1"}},"setUserKey"),c("span",{style:{color:"#24292E"}},"(cookie."),c("span",{style:{color:"#6F42C1"}},"getValue"),c("span",{style:{color:"#24292E"}},"());")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"                    userInfoTo."),c("span",{style:{color:"#6F42C1"}},"setTempUser"),c("span",{style:{color:"#24292E"}},"("),c("span",{style:{color:"#005CC5"}},"true"),c("span",{style:{color:"#24292E"}},");")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"                }")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"            }")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        }")]),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        "),c("span",{style:{color:"#6A737D"}},"//如果没有临时用户一定分配一个临时用户")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        "),c("span",{style:{color:"#D73A49"}},"if"),c("span",{style:{color:"#24292E"}}," (StringUtils."),c("span",{style:{color:"#6F42C1"}},"isEmpty"),c("span",{style:{color:"#24292E"}},"(userInfoTo."),c("span",{style:{color:"#6F42C1"}},"getUserKey"),c("span",{style:{color:"#24292E"}},"())){")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"            String uuid "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," UUID."),c("span",{style:{color:"#6F42C1"}},"randomUUID"),c("span",{style:{color:"#24292E"}},"()."),c("span",{style:{color:"#6F42C1"}},"toString"),c("span",{style:{color:"#24292E"}},"();")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"            userInfoTo."),c("span",{style:{color:"#6F42C1"}},"setUserKey"),c("span",{style:{color:"#24292E"}},"(uuid);")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        }")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        "),c("span",{style:{color:"#6A737D"}},"//目标方法执行之前")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        threadLocal."),c("span",{style:{color:"#6F42C1"}},"set"),c("span",{style:{color:"#24292E"}},"(userInfoTo);")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        "),c("span",{style:{color:"#D73A49"}},"return"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#005CC5"}},"true"),c("span",{style:{color:"#24292E"}},";")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    }")]),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"    /**")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"     * 业务执行之后，分配临时用户，让浏览器保存")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"     * "),c("span",{style:{color:"#D73A49"}},"@param"),c("span",{style:{color:"#6A737D"}}," "),c("span",{style:{color:"#E36209"}},"request")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"     * "),c("span",{style:{color:"#D73A49"}},"@param"),c("span",{style:{color:"#6A737D"}}," "),c("span",{style:{color:"#E36209"}},"response")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"     * "),c("span",{style:{color:"#D73A49"}},"@param"),c("span",{style:{color:"#6A737D"}}," "),c("span",{style:{color:"#E36209"}},"handler")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"     * "),c("span",{style:{color:"#D73A49"}},"@param"),c("span",{style:{color:"#6A737D"}}," "),c("span",{style:{color:"#E36209"}},"modelAndView")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"     * "),c("span",{style:{color:"#D73A49"}},"@throws"),c("span",{style:{color:"#6A737D"}}," "),c("span",{style:{color:"#6F42C1"}},"Exception")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"     */")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    @"),c("span",{style:{color:"#D73A49"}},"Override")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#D73A49"}},"public"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#D73A49"}},"void"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#6F42C1"}},"postHandle"),c("span",{style:{color:"#24292E"}},"(HttpServletRequest "),c("span",{style:{color:"#E36209"}},"request"),c("span",{style:{color:"#24292E"}},", HttpServletResponse "),c("span",{style:{color:"#E36209"}},"response"),c("span",{style:{color:"#24292E"}},", Object "),c("span",{style:{color:"#E36209"}},"handler"),c("span",{style:{color:"#24292E"}},", ModelAndView "),c("span",{style:{color:"#E36209"}},"modelAndView"),c("span",{style:{color:"#24292E"}},") "),c("span",{style:{color:"#D73A49"}},"throws"),c("span",{style:{color:"#24292E"}}," Exception {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        UserInfoTo userInfoTo "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," threadLocal."),c("span",{style:{color:"#6F42C1"}},"get"),c("span",{style:{color:"#24292E"}},"();")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        "),c("span",{style:{color:"#6A737D"}},"//如果没有临时用户一定保存一个临时用户，默认不是")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        "),c("span",{style:{color:"#D73A49"}},"if"),c("span",{style:{color:"#24292E"}}," ("),c("span",{style:{color:"#D73A49"}},"!"),c("span",{style:{color:"#24292E"}},"userInfoTo."),c("span",{style:{color:"#6F42C1"}},"isTempUser"),c("span",{style:{color:"#24292E"}},"()){")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"            "),c("span",{style:{color:"#6A737D"}},"//是临时用户")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"            "),c("span",{style:{color:"#6A737D"}},"//将user-key放入cookie")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"            Cookie cookie "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#D73A49"}},"new"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#6F42C1"}},"Cookie"),c("span",{style:{color:"#24292E"}},"(CartConstant.TEMP_USER_COOKIE_NAME, userInfoTo."),c("span",{style:{color:"#6F42C1"}},"getUserKey"),c("span",{style:{color:"#24292E"}},"());")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"            "),c("span",{style:{color:"#6A737D"}},"//作用域")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"            cookie."),c("span",{style:{color:"#6F42C1"}},"setDomain"),c("span",{style:{color:"#24292E"}},"("),c("span",{style:{color:"#032F62"}},'"gulimall.com"'),c("span",{style:{color:"#24292E"}},");")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"            "),c("span",{style:{color:"#6A737D"}},"//持续延迟临时用户的过期时间")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"            cookie."),c("span",{style:{color:"#6F42C1"}},"setMaxAge"),c("span",{style:{color:"#24292E"}},"(CartConstant.TEMP_USER_COOKIE_TIMEOUT);")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"            "),c("span",{style:{color:"#6A737D"}},"//响应头里加入cookie")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"            response."),c("span",{style:{color:"#6F42C1"}},"addCookie"),c("span",{style:{color:"#24292E"}},"(cookie);")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        }")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    }")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"}")])])])],-1),K=c("ul",null,[c("li",null,[c("p",null,"DEBUG拦截器"),c("ul",null,[c("li",null,"首次访问首页（未登录状态），执行目标方法之前（添加商品到购物车），在页面没有异步请求没超时前完成以下步骤（超时直接404，操作失败）")]),c("figure",null,[c("img",{src:"https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230425004106238.png",alt:"image-20230425004106238",loading:"lazy",decoding:"async"})]),c("ul",null,[c("li",null,"在规定时间（30s左右）内完成以上操作，将user-key存入Cookie成功，返回preHandle方法")]),c("figure",null,[c("img",{src:"https://jsd.cdn.zzko.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230425005929883.png",alt:"image-20230425005929883",loading:"lazy",decoding:"async"})])]),c("li",null,[c("p",null,[p("添加购物车接口"),c("code",null,"org.klaus.zgg01mall.cart.controller.CartController#addToCart")])])],-1),q=c("div",{class:"language-java"},[c("button",{title:"Copy Code",class:"copy"}),c("span",{class:"lang"},"java"),c("pre",{class:"shiki github-dark vp-code-dark"},[c("code",null,[c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"/**")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"     * 添加商品到购物车")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"     *         redirectAttributes.addFlashAttribute():将数据放在session里面可以在页面取出，但是只能取一次")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},'     *         redirectAttributes.addAttribute("skuId", skuId);将数据放在url后面')]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"     * "),c("span",{style:{color:"#F97583"}},"@return")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"     */")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    @"),c("span",{style:{color:"#F97583"}},"GetMapping"),c("span",{style:{color:"#E1E4E8"}},"("),c("span",{style:{color:"#9ECBFF"}},'"/addToCart"'),c("span",{style:{color:"#E1E4E8"}},")")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#F97583"}},"public"),c("span",{style:{color:"#E1E4E8"}}," String "),c("span",{style:{color:"#B392F0"}},"addToCart"),c("span",{style:{color:"#E1E4E8"}},"(@"),c("span",{style:{color:"#F97583"}},"RequestParam"),c("span",{style:{color:"#E1E4E8"}},"("),c("span",{style:{color:"#9ECBFF"}},'"skuId"'),c("span",{style:{color:"#E1E4E8"}},") Long skuId,")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"                            @"),c("span",{style:{color:"#F97583"}},"RequestParam"),c("span",{style:{color:"#E1E4E8"}},"("),c("span",{style:{color:"#9ECBFF"}},'"num"'),c("span",{style:{color:"#E1E4E8"}},") Integer num,")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"                            RedirectAttributes redirectAttributes) throws ExecutionException, InterruptedException {")]),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        cartService."),c("span",{style:{color:"#B392F0"}},"addToCart"),c("span",{style:{color:"#E1E4E8"}},"(skuId, num);")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"//        model.addAttribute(\"skuId\", skuId); //Required Long parameter 'skuId' is not present")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        redirectAttributes."),c("span",{style:{color:"#B392F0"}},"addAttribute"),c("span",{style:{color:"#E1E4E8"}},"("),c("span",{style:{color:"#9ECBFF"}},'"skuId"'),c("span",{style:{color:"#E1E4E8"}},", skuId);")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        "),c("span",{style:{color:"#6A737D"}},"//添加商品到购物车，重定向到成功页面->刷新页面不会再增加购物车数量http://cart.gulimall.com/addToCart?skuId=35&num=1")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        "),c("span",{style:{color:"#F97583"}},"return"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#9ECBFF"}},'"redirect:http://cart.gulimall.com/addToCartSuccess.html"'),c("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    }")])])]),c("pre",{class:"shiki github-light vp-code-light"},[c("code",null,[c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"/**")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"     * 添加商品到购物车")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"     *         redirectAttributes.addFlashAttribute():将数据放在session里面可以在页面取出，但是只能取一次")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},'     *         redirectAttributes.addAttribute("skuId", skuId);将数据放在url后面')]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"     * "),c("span",{style:{color:"#D73A49"}},"@return")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"     */")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    @"),c("span",{style:{color:"#D73A49"}},"GetMapping"),c("span",{style:{color:"#24292E"}},"("),c("span",{style:{color:"#032F62"}},'"/addToCart"'),c("span",{style:{color:"#24292E"}},")")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#D73A49"}},"public"),c("span",{style:{color:"#24292E"}}," String "),c("span",{style:{color:"#6F42C1"}},"addToCart"),c("span",{style:{color:"#24292E"}},"(@"),c("span",{style:{color:"#D73A49"}},"RequestParam"),c("span",{style:{color:"#24292E"}},"("),c("span",{style:{color:"#032F62"}},'"skuId"'),c("span",{style:{color:"#24292E"}},") Long skuId,")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"                            @"),c("span",{style:{color:"#D73A49"}},"RequestParam"),c("span",{style:{color:"#24292E"}},"("),c("span",{style:{color:"#032F62"}},'"num"'),c("span",{style:{color:"#24292E"}},") Integer num,")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"                            RedirectAttributes redirectAttributes) throws ExecutionException, InterruptedException {")]),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        cartService."),c("span",{style:{color:"#6F42C1"}},"addToCart"),c("span",{style:{color:"#24292E"}},"(skuId, num);")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"//        model.addAttribute(\"skuId\", skuId); //Required Long parameter 'skuId' is not present")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        redirectAttributes."),c("span",{style:{color:"#6F42C1"}},"addAttribute"),c("span",{style:{color:"#24292E"}},"("),c("span",{style:{color:"#032F62"}},'"skuId"'),c("span",{style:{color:"#24292E"}},", skuId);")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        "),c("span",{style:{color:"#6A737D"}},"//添加商品到购物车，重定向到成功页面->刷新页面不会再增加购物车数量http://cart.gulimall.com/addToCart?skuId=35&num=1")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        "),c("span",{style:{color:"#D73A49"}},"return"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#032F62"}},'"redirect:http://cart.gulimall.com/addToCartSuccess.html"'),c("span",{style:{color:"#24292E"}},";")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    }")])])])],-1),N=c("ul",null,[c("li",null,[c("code",null,"org.klaus.zgg01mall.cart.vo.Cart")])],-1),W=c("div",{class:"language-java"},[c("button",{title:"Copy Code",class:"copy"}),c("span",{class:"lang"},"java"),c("pre",{class:"shiki github-dark vp-code-dark"},[c("code",null,[c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"/**")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}}," * 整个购物车的内容")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}}," *  需要计算的属性，必须重写他的get方法，保证每次获取属性都会进行计算")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}}," * "),c("span",{style:{color:"#F97583"}},"@author"),c("span",{style:{color:"#6A737D"}}," Klaus")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}}," * @date 2022/9/19")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}}," */")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#F97583"}},"public"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#F97583"}},"class"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#B392F0"}},"Cart"),c("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#F97583"}},"private"),c("span",{style:{color:"#E1E4E8"}}," List<"),c("span",{style:{color:"#F97583"}},"CartItem"),c("span",{style:{color:"#E1E4E8"}},"> items;")]),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#F97583"}},"private"),c("span",{style:{color:"#E1E4E8"}}," Integer countNum;"),c("span",{style:{color:"#6A737D"}},"//商品数量")]),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#F97583"}},"private"),c("span",{style:{color:"#E1E4E8"}}," Integer countType;"),c("span",{style:{color:"#6A737D"}},"//商品类型数量")]),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#F97583"}},"private"),c("span",{style:{color:"#E1E4E8"}}," BigDecimal totalAmount;"),c("span",{style:{color:"#6A737D"}},"//商品总价")]),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#F97583"}},"private"),c("span",{style:{color:"#E1E4E8"}}," BigDecimal reduce "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#F97583"}},"new"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#B392F0"}},"BigDecimal"),c("span",{style:{color:"#E1E4E8"}},"("),c("span",{style:{color:"#9ECBFF"}},'"0.00"'),c("span",{style:{color:"#E1E4E8"}},");"),c("span",{style:{color:"#6A737D"}},"//减免价格")]),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#F97583"}},"public"),c("span",{style:{color:"#E1E4E8"}}," List<"),c("span",{style:{color:"#F97583"}},"CartItem"),c("span",{style:{color:"#E1E4E8"}},"> "),c("span",{style:{color:"#B392F0"}},"getItems"),c("span",{style:{color:"#E1E4E8"}},"() {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        "),c("span",{style:{color:"#F97583"}},"return"),c("span",{style:{color:"#E1E4E8"}}," items;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#F97583"}},"public"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#F97583"}},"void"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#B392F0"}},"setItems"),c("span",{style:{color:"#E1E4E8"}},"(List<"),c("span",{style:{color:"#F97583"}},"CartItem"),c("span",{style:{color:"#E1E4E8"}},"> "),c("span",{style:{color:"#FFAB70"}},"items"),c("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        "),c("span",{style:{color:"#79B8FF"}},"this"),c("span",{style:{color:"#E1E4E8"}},".items "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," items;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"    /**")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"     * 统计每一行*数量 再相加")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"     * "),c("span",{style:{color:"#F97583"}},"@return")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"     */")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#F97583"}},"public"),c("span",{style:{color:"#E1E4E8"}}," Integer "),c("span",{style:{color:"#B392F0"}},"getCountNum"),c("span",{style:{color:"#E1E4E8"}},"() {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        "),c("span",{style:{color:"#F97583"}},"int"),c("span",{style:{color:"#E1E4E8"}}," count "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#79B8FF"}},"0"),c("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        "),c("span",{style:{color:"#F97583"}},"if"),c("span",{style:{color:"#E1E4E8"}}," (items "),c("span",{style:{color:"#F97583"}},"!="),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#79B8FF"}},"null"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#F97583"}},"&&"),c("span",{style:{color:"#E1E4E8"}}," items."),c("span",{style:{color:"#B392F0"}},"size"),c("span",{style:{color:"#E1E4E8"}},"() "),c("span",{style:{color:"#F97583"}},">"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#79B8FF"}},"0"),c("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"            "),c("span",{style:{color:"#F97583"}},"for"),c("span",{style:{color:"#E1E4E8"}}," (CartItem item "),c("span",{style:{color:"#F97583"}},":"),c("span",{style:{color:"#E1E4E8"}}," items) {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"                count "),c("span",{style:{color:"#F97583"}},"+="),c("span",{style:{color:"#E1E4E8"}}," item."),c("span",{style:{color:"#B392F0"}},"getCount"),c("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"            }")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        }")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        "),c("span",{style:{color:"#F97583"}},"return"),c("span",{style:{color:"#E1E4E8"}}," count;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"    /**")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"     * 统计每一行相加")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"     * "),c("span",{style:{color:"#F97583"}},"@return")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"     */")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#F97583"}},"public"),c("span",{style:{color:"#E1E4E8"}}," Integer "),c("span",{style:{color:"#B392F0"}},"getCountType"),c("span",{style:{color:"#E1E4E8"}},"() {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        "),c("span",{style:{color:"#F97583"}},"int"),c("span",{style:{color:"#E1E4E8"}}," count "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#79B8FF"}},"0"),c("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        "),c("span",{style:{color:"#F97583"}},"if"),c("span",{style:{color:"#E1E4E8"}}," (items "),c("span",{style:{color:"#F97583"}},"!="),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#79B8FF"}},"null"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#F97583"}},"&&"),c("span",{style:{color:"#E1E4E8"}}," items."),c("span",{style:{color:"#B392F0"}},"size"),c("span",{style:{color:"#E1E4E8"}},"() "),c("span",{style:{color:"#F97583"}},">"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#79B8FF"}},"0"),c("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"            "),c("span",{style:{color:"#F97583"}},"for"),c("span",{style:{color:"#E1E4E8"}}," (CartItem item "),c("span",{style:{color:"#F97583"}},":"),c("span",{style:{color:"#E1E4E8"}}," items) {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"                count "),c("span",{style:{color:"#F97583"}},"+="),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#79B8FF"}},"1"),c("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"            }")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        }")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        "),c("span",{style:{color:"#F97583"}},"return"),c("span",{style:{color:"#E1E4E8"}}," count;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#F97583"}},"public"),c("span",{style:{color:"#E1E4E8"}}," BigDecimal "),c("span",{style:{color:"#B392F0"}},"getTotalAmount"),c("span",{style:{color:"#E1E4E8"}},"() {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        BigDecimal amount "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#F97583"}},"new"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#B392F0"}},"BigDecimal"),c("span",{style:{color:"#E1E4E8"}},"("),c("span",{style:{color:"#9ECBFF"}},'"0"'),c("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        "),c("span",{style:{color:"#6A737D"}},"//1、计算购物项总价")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        "),c("span",{style:{color:"#F97583"}},"if"),c("span",{style:{color:"#E1E4E8"}}," (items "),c("span",{style:{color:"#F97583"}},"!="),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#79B8FF"}},"null"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#F97583"}},"&&"),c("span",{style:{color:"#E1E4E8"}}," items."),c("span",{style:{color:"#B392F0"}},"size"),c("span",{style:{color:"#E1E4E8"}},"() "),c("span",{style:{color:"#F97583"}},">"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#79B8FF"}},"0"),c("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"            "),c("span",{style:{color:"#F97583"}},"for"),c("span",{style:{color:"#E1E4E8"}}," (CartItem item "),c("span",{style:{color:"#F97583"}},":"),c("span",{style:{color:"#E1E4E8"}}," items) {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"                "),c("span",{style:{color:"#F97583"}},"if"),c("span",{style:{color:"#E1E4E8"}}," (item."),c("span",{style:{color:"#B392F0"}},"getCheck"),c("span",{style:{color:"#E1E4E8"}},"()){")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"                    "),c("span",{style:{color:"#6A737D"}},"//购物项被选中才进行计算")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"                    BigDecimal totalPrice "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," item."),c("span",{style:{color:"#B392F0"}},"getTotalPrice"),c("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"                    amount "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," amount."),c("span",{style:{color:"#B392F0"}},"add"),c("span",{style:{color:"#E1E4E8"}},"(totalPrice);")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"                }")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"            }")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        }")]),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        "),c("span",{style:{color:"#6A737D"}},"//2、减去优惠总价")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        BigDecimal subtract "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," amount."),c("span",{style:{color:"#B392F0"}},"subtract"),c("span",{style:{color:"#E1E4E8"}},"("),c("span",{style:{color:"#B392F0"}},"getReduce"),c("span",{style:{color:"#E1E4E8"}},"());")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        "),c("span",{style:{color:"#F97583"}},"return"),c("span",{style:{color:"#E1E4E8"}}," subtract;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#F97583"}},"public"),c("span",{style:{color:"#E1E4E8"}}," BigDecimal "),c("span",{style:{color:"#B392F0"}},"getReduce"),c("span",{style:{color:"#E1E4E8"}},"() {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        "),c("span",{style:{color:"#F97583"}},"return"),c("span",{style:{color:"#E1E4E8"}}," reduce;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#F97583"}},"public"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#F97583"}},"void"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#B392F0"}},"setReduce"),c("span",{style:{color:"#E1E4E8"}},"(BigDecimal "),c("span",{style:{color:"#FFAB70"}},"reduce"),c("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        "),c("span",{style:{color:"#79B8FF"}},"this"),c("span",{style:{color:"#E1E4E8"}},".reduce "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," reduce;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"}")])])]),c("pre",{class:"shiki github-light vp-code-light"},[c("code",null,[c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"/**")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}}," * 整个购物车的内容")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}}," *  需要计算的属性，必须重写他的get方法，保证每次获取属性都会进行计算")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}}," * "),c("span",{style:{color:"#D73A49"}},"@author"),c("span",{style:{color:"#6A737D"}}," Klaus")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}}," * @date 2022/9/19")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}}," */")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#D73A49"}},"public"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#D73A49"}},"class"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#6F42C1"}},"Cart"),c("span",{style:{color:"#24292E"}}," {")]),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#D73A49"}},"private"),c("span",{style:{color:"#24292E"}}," List<"),c("span",{style:{color:"#D73A49"}},"CartItem"),c("span",{style:{color:"#24292E"}},"> items;")]),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#D73A49"}},"private"),c("span",{style:{color:"#24292E"}}," Integer countNum;"),c("span",{style:{color:"#6A737D"}},"//商品数量")]),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#D73A49"}},"private"),c("span",{style:{color:"#24292E"}}," Integer countType;"),c("span",{style:{color:"#6A737D"}},"//商品类型数量")]),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#D73A49"}},"private"),c("span",{style:{color:"#24292E"}}," BigDecimal totalAmount;"),c("span",{style:{color:"#6A737D"}},"//商品总价")]),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#D73A49"}},"private"),c("span",{style:{color:"#24292E"}}," BigDecimal reduce "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#D73A49"}},"new"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#6F42C1"}},"BigDecimal"),c("span",{style:{color:"#24292E"}},"("),c("span",{style:{color:"#032F62"}},'"0.00"'),c("span",{style:{color:"#24292E"}},");"),c("span",{style:{color:"#6A737D"}},"//减免价格")]),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#D73A49"}},"public"),c("span",{style:{color:"#24292E"}}," List<"),c("span",{style:{color:"#D73A49"}},"CartItem"),c("span",{style:{color:"#24292E"}},"> "),c("span",{style:{color:"#6F42C1"}},"getItems"),c("span",{style:{color:"#24292E"}},"() {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        "),c("span",{style:{color:"#D73A49"}},"return"),c("span",{style:{color:"#24292E"}}," items;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    }")]),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#D73A49"}},"public"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#D73A49"}},"void"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#6F42C1"}},"setItems"),c("span",{style:{color:"#24292E"}},"(List<"),c("span",{style:{color:"#D73A49"}},"CartItem"),c("span",{style:{color:"#24292E"}},"> "),c("span",{style:{color:"#E36209"}},"items"),c("span",{style:{color:"#24292E"}},") {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        "),c("span",{style:{color:"#005CC5"}},"this"),c("span",{style:{color:"#24292E"}},".items "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," items;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    }")]),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"    /**")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"     * 统计每一行*数量 再相加")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"     * "),c("span",{style:{color:"#D73A49"}},"@return")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"     */")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#D73A49"}},"public"),c("span",{style:{color:"#24292E"}}," Integer "),c("span",{style:{color:"#6F42C1"}},"getCountNum"),c("span",{style:{color:"#24292E"}},"() {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        "),c("span",{style:{color:"#D73A49"}},"int"),c("span",{style:{color:"#24292E"}}," count "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#005CC5"}},"0"),c("span",{style:{color:"#24292E"}},";")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        "),c("span",{style:{color:"#D73A49"}},"if"),c("span",{style:{color:"#24292E"}}," (items "),c("span",{style:{color:"#D73A49"}},"!="),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#005CC5"}},"null"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#D73A49"}},"&&"),c("span",{style:{color:"#24292E"}}," items."),c("span",{style:{color:"#6F42C1"}},"size"),c("span",{style:{color:"#24292E"}},"() "),c("span",{style:{color:"#D73A49"}},">"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#005CC5"}},"0"),c("span",{style:{color:"#24292E"}},") {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"            "),c("span",{style:{color:"#D73A49"}},"for"),c("span",{style:{color:"#24292E"}}," (CartItem item "),c("span",{style:{color:"#D73A49"}},":"),c("span",{style:{color:"#24292E"}}," items) {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"                count "),c("span",{style:{color:"#D73A49"}},"+="),c("span",{style:{color:"#24292E"}}," item."),c("span",{style:{color:"#6F42C1"}},"getCount"),c("span",{style:{color:"#24292E"}},"();")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"            }")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        }")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        "),c("span",{style:{color:"#D73A49"}},"return"),c("span",{style:{color:"#24292E"}}," count;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    }")]),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"    /**")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"     * 统计每一行相加")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"     * "),c("span",{style:{color:"#D73A49"}},"@return")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"     */")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#D73A49"}},"public"),c("span",{style:{color:"#24292E"}}," Integer "),c("span",{style:{color:"#6F42C1"}},"getCountType"),c("span",{style:{color:"#24292E"}},"() {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        "),c("span",{style:{color:"#D73A49"}},"int"),c("span",{style:{color:"#24292E"}}," count "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#005CC5"}},"0"),c("span",{style:{color:"#24292E"}},";")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        "),c("span",{style:{color:"#D73A49"}},"if"),c("span",{style:{color:"#24292E"}}," (items "),c("span",{style:{color:"#D73A49"}},"!="),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#005CC5"}},"null"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#D73A49"}},"&&"),c("span",{style:{color:"#24292E"}}," items."),c("span",{style:{color:"#6F42C1"}},"size"),c("span",{style:{color:"#24292E"}},"() "),c("span",{style:{color:"#D73A49"}},">"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#005CC5"}},"0"),c("span",{style:{color:"#24292E"}},") {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"            "),c("span",{style:{color:"#D73A49"}},"for"),c("span",{style:{color:"#24292E"}}," (CartItem item "),c("span",{style:{color:"#D73A49"}},":"),c("span",{style:{color:"#24292E"}}," items) {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"                count "),c("span",{style:{color:"#D73A49"}},"+="),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#005CC5"}},"1"),c("span",{style:{color:"#24292E"}},";")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"            }")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        }")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        "),c("span",{style:{color:"#D73A49"}},"return"),c("span",{style:{color:"#24292E"}}," count;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    }")]),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#D73A49"}},"public"),c("span",{style:{color:"#24292E"}}," BigDecimal "),c("span",{style:{color:"#6F42C1"}},"getTotalAmount"),c("span",{style:{color:"#24292E"}},"() {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        BigDecimal amount "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#D73A49"}},"new"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#6F42C1"}},"BigDecimal"),c("span",{style:{color:"#24292E"}},"("),c("span",{style:{color:"#032F62"}},'"0"'),c("span",{style:{color:"#24292E"}},");")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        "),c("span",{style:{color:"#6A737D"}},"//1、计算购物项总价")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        "),c("span",{style:{color:"#D73A49"}},"if"),c("span",{style:{color:"#24292E"}}," (items "),c("span",{style:{color:"#D73A49"}},"!="),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#005CC5"}},"null"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#D73A49"}},"&&"),c("span",{style:{color:"#24292E"}}," items."),c("span",{style:{color:"#6F42C1"}},"size"),c("span",{style:{color:"#24292E"}},"() "),c("span",{style:{color:"#D73A49"}},">"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#005CC5"}},"0"),c("span",{style:{color:"#24292E"}},") {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"            "),c("span",{style:{color:"#D73A49"}},"for"),c("span",{style:{color:"#24292E"}}," (CartItem item "),c("span",{style:{color:"#D73A49"}},":"),c("span",{style:{color:"#24292E"}}," items) {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"                "),c("span",{style:{color:"#D73A49"}},"if"),c("span",{style:{color:"#24292E"}}," (item."),c("span",{style:{color:"#6F42C1"}},"getCheck"),c("span",{style:{color:"#24292E"}},"()){")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"                    "),c("span",{style:{color:"#6A737D"}},"//购物项被选中才进行计算")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"                    BigDecimal totalPrice "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," item."),c("span",{style:{color:"#6F42C1"}},"getTotalPrice"),c("span",{style:{color:"#24292E"}},"();")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"                    amount "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," amount."),c("span",{style:{color:"#6F42C1"}},"add"),c("span",{style:{color:"#24292E"}},"(totalPrice);")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"                }")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"            }")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        }")]),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        "),c("span",{style:{color:"#6A737D"}},"//2、减去优惠总价")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        BigDecimal subtract "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," amount."),c("span",{style:{color:"#6F42C1"}},"subtract"),c("span",{style:{color:"#24292E"}},"("),c("span",{style:{color:"#6F42C1"}},"getReduce"),c("span",{style:{color:"#24292E"}},"());")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        "),c("span",{style:{color:"#D73A49"}},"return"),c("span",{style:{color:"#24292E"}}," subtract;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    }")]),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#D73A49"}},"public"),c("span",{style:{color:"#24292E"}}," BigDecimal "),c("span",{style:{color:"#6F42C1"}},"getReduce"),c("span",{style:{color:"#24292E"}},"() {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        "),c("span",{style:{color:"#D73A49"}},"return"),c("span",{style:{color:"#24292E"}}," reduce;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    }")]),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#D73A49"}},"public"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#D73A49"}},"void"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#6F42C1"}},"setReduce"),c("span",{style:{color:"#24292E"}},"(BigDecimal "),c("span",{style:{color:"#E36209"}},"reduce"),c("span",{style:{color:"#24292E"}},") {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        "),c("span",{style:{color:"#005CC5"}},"this"),c("span",{style:{color:"#24292E"}},".reduce "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," reduce;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    }")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"}")])])])],-1),H=c("ul",null,[c("li",null,[c("code",null,"org.klaus.zgg01mall.cart.vo.CartItem")])],-1),G=c("div",{class:"language-java"},[c("button",{title:"Copy Code",class:"copy"}),c("span",{class:"lang"},"java"),c("pre",{class:"shiki github-dark vp-code-dark"},[c("code",null,[c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"/**")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"     * 购物项")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"     * 例如：")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"     * {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"     * skuId: 2131241,")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"     * check: true,")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},'     * title: "Apple iphone.....",')]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},'     * defaultImage: "...",')]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"     * price: 4999,")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"     * count: 1,")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"     * totalPrice: 4999,")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"     * skuSaleVO: {...}")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"     * }")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"     * "),c("span",{style:{color:"#F97583"}},"@author"),c("span",{style:{color:"#6A737D"}}," Klaus")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"     * @date 2022/9/19")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"     */")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    ")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#F97583"}},"public"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#F97583"}},"class"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#B392F0"}},"CartItem"),c("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    ")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        "),c("span",{style:{color:"#F97583"}},"private"),c("span",{style:{color:"#E1E4E8"}}," Long skuId;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        "),c("span",{style:{color:"#F97583"}},"private"),c("span",{style:{color:"#E1E4E8"}}," Boolean check "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#79B8FF"}},"true"),c("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        "),c("span",{style:{color:"#F97583"}},"private"),c("span",{style:{color:"#E1E4E8"}}," String title;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        "),c("span",{style:{color:"#F97583"}},"private"),c("span",{style:{color:"#E1E4E8"}}," String image;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        "),c("span",{style:{color:"#F97583"}},"private"),c("span",{style:{color:"#E1E4E8"}}," List<"),c("span",{style:{color:"#F97583"}},"String"),c("span",{style:{color:"#E1E4E8"}},"> skuAttrs;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        "),c("span",{style:{color:"#F97583"}},"private"),c("span",{style:{color:"#E1E4E8"}}," BigDecimal price;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        "),c("span",{style:{color:"#F97583"}},"private"),c("span",{style:{color:"#E1E4E8"}}," Integer count;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        "),c("span",{style:{color:"#F97583"}},"private"),c("span",{style:{color:"#E1E4E8"}}," BigDecimal totalPrice;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    ")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    \t....")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    ")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"        /**")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"         * 计算当前项总价")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"         * "),c("span",{style:{color:"#F97583"}},"@return")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"         */")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        "),c("span",{style:{color:"#F97583"}},"public"),c("span",{style:{color:"#E1E4E8"}}," BigDecimal "),c("span",{style:{color:"#B392F0"}},"getTotalPrice"),c("span",{style:{color:"#E1E4E8"}},"() {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"            "),c("span",{style:{color:"#F97583"}},"return"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#79B8FF"}},"this"),c("span",{style:{color:"#E1E4E8"}},".price."),c("span",{style:{color:"#B392F0"}},"multiply"),c("span",{style:{color:"#E1E4E8"}},"("),c("span",{style:{color:"#F97583"}},"new"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#B392F0"}},"BigDecimal"),c("span",{style:{color:"#E1E4E8"}},"("),c("span",{style:{color:"#9ECBFF"}},'""'),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#F97583"}},"+"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#79B8FF"}},"this"),c("span",{style:{color:"#E1E4E8"}},".count));")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        }")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    ")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        "),c("span",{style:{color:"#F97583"}},"public"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#F97583"}},"void"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#B392F0"}},"setTotalPrice"),c("span",{style:{color:"#E1E4E8"}},"(BigDecimal "),c("span",{style:{color:"#FFAB70"}},"totalPrice"),c("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"            "),c("span",{style:{color:"#79B8FF"}},"this"),c("span",{style:{color:"#E1E4E8"}},".totalPrice "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," totalPrice;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        }")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    }")])])]),c("pre",{class:"shiki github-light vp-code-light"},[c("code",null,[c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"/**")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"     * 购物项")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"     * 例如：")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"     * {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"     * skuId: 2131241,")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"     * check: true,")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},'     * title: "Apple iphone.....",')]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},'     * defaultImage: "...",')]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"     * price: 4999,")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"     * count: 1,")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"     * totalPrice: 4999,")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"     * skuSaleVO: {...}")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"     * }")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"     * "),c("span",{style:{color:"#D73A49"}},"@author"),c("span",{style:{color:"#6A737D"}}," Klaus")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"     * @date 2022/9/19")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"     */")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    ")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#D73A49"}},"public"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#D73A49"}},"class"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#6F42C1"}},"CartItem"),c("span",{style:{color:"#24292E"}}," {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    ")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        "),c("span",{style:{color:"#D73A49"}},"private"),c("span",{style:{color:"#24292E"}}," Long skuId;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        "),c("span",{style:{color:"#D73A49"}},"private"),c("span",{style:{color:"#24292E"}}," Boolean check "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#005CC5"}},"true"),c("span",{style:{color:"#24292E"}},";")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        "),c("span",{style:{color:"#D73A49"}},"private"),c("span",{style:{color:"#24292E"}}," String title;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        "),c("span",{style:{color:"#D73A49"}},"private"),c("span",{style:{color:"#24292E"}}," String image;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        "),c("span",{style:{color:"#D73A49"}},"private"),c("span",{style:{color:"#24292E"}}," List<"),c("span",{style:{color:"#D73A49"}},"String"),c("span",{style:{color:"#24292E"}},"> skuAttrs;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        "),c("span",{style:{color:"#D73A49"}},"private"),c("span",{style:{color:"#24292E"}}," BigDecimal price;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        "),c("span",{style:{color:"#D73A49"}},"private"),c("span",{style:{color:"#24292E"}}," Integer count;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        "),c("span",{style:{color:"#D73A49"}},"private"),c("span",{style:{color:"#24292E"}}," BigDecimal totalPrice;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    ")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    \t....")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    ")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"        /**")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"         * 计算当前项总价")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"         * "),c("span",{style:{color:"#D73A49"}},"@return")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"         */")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        "),c("span",{style:{color:"#D73A49"}},"public"),c("span",{style:{color:"#24292E"}}," BigDecimal "),c("span",{style:{color:"#6F42C1"}},"getTotalPrice"),c("span",{style:{color:"#24292E"}},"() {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"            "),c("span",{style:{color:"#D73A49"}},"return"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#005CC5"}},"this"),c("span",{style:{color:"#24292E"}},".price."),c("span",{style:{color:"#6F42C1"}},"multiply"),c("span",{style:{color:"#24292E"}},"("),c("span",{style:{color:"#D73A49"}},"new"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#6F42C1"}},"BigDecimal"),c("span",{style:{color:"#24292E"}},"("),c("span",{style:{color:"#032F62"}},'""'),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#D73A49"}},"+"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#005CC5"}},"this"),c("span",{style:{color:"#24292E"}},".count));")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        }")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    ")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        "),c("span",{style:{color:"#D73A49"}},"public"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#D73A49"}},"void"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#6F42C1"}},"setTotalPrice"),c("span",{style:{color:"#24292E"}},"(BigDecimal "),c("span",{style:{color:"#E36209"}},"totalPrice"),c("span",{style:{color:"#24292E"}},") {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"            "),c("span",{style:{color:"#005CC5"}},"this"),c("span",{style:{color:"#24292E"}},".totalPrice "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," totalPrice;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        }")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    }")])])])],-1),X=c("ul",null,[c("li",null,[p("添加购物车方法实现"),c("code",null,"org.klaus.zgg01mall.cart.service.impl.CartServiceImpl#addToCart"),c("ul",null,[c("li",null,[p("对购物车进行Redis的hash绑定操作"),c("code",null,"Map<String, List<String>>")])])])],-1),Q=c("table",null,[c("thead",null,[c("tr",null,[c("th",{style:{"text-align":"center"}},"key=String"),c("th",{style:{"text-align":"center"}},[p("value="),c("code",null,"List<String>")])])]),c("tbody",null,[c("tr",null,[c("td",{style:{"text-align":"center"}},"userId/userKey"),c("td",{style:{"text-align":"center"}},[p("cart="),c("code",null,"Map<skuId,cartItem>")])]),c("tr",null,[c("td",{style:{"text-align":"center"}},"userId/userKey"),c("td",{style:{"text-align":"center"}},[p("cart="),c("code",null,"Map<skuId,cartItem>")])]),c("tr",null,[c("td",{style:{"text-align":"center"}},"userId/userKey"),c("td",{style:{"text-align":"center"}},[p("cart="),c("code",null,"Map<skuId,cartItem>")])])])],-1),$=c("div",{class:"language-java"},[c("button",{title:"Copy Code",class:"copy"}),c("span",{class:"lang"},"java"),c("pre",{class:"shiki github-dark vp-code-dark"},[c("code",null,[c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"/**")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"  * 第一层 Map， Key 是用户 id")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"  * 第二层 Map， Key 是购物车中商品 id， 值是购物项数据")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"  * 将商品添加到购物车")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"  *")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"  * "),c("span",{style:{color:"#F97583"}},"@param"),c("span",{style:{color:"#6A737D"}}," "),c("span",{style:{color:"#FFAB70"}},"skuId")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"  * "),c("span",{style:{color:"#F97583"}},"@param"),c("span",{style:{color:"#6A737D"}}," "),c("span",{style:{color:"#FFAB70"}},"num")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"  * "),c("span",{style:{color:"#F97583"}},"@return")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"  */")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}}," @"),c("span",{style:{color:"#F97583"}},"Override")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#F97583"}},"public"),c("span",{style:{color:"#E1E4E8"}}," CartItem "),c("span",{style:{color:"#B392F0"}},"addToCart"),c("span",{style:{color:"#E1E4E8"}},"(Long skuId, Integer num) throws ExecutionException, InterruptedException {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"     "),c("span",{style:{color:"#6A737D"}},"//操作购物车")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"     BoundHashOperations<"),c("span",{style:{color:"#F97583"}},"String"),c("span",{style:{color:"#E1E4E8"}},", "),c("span",{style:{color:"#F97583"}},"Object"),c("span",{style:{color:"#E1E4E8"}},", "),c("span",{style:{color:"#F97583"}},"Object"),c("span",{style:{color:"#E1E4E8"}},"> cartOps "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#B392F0"}},"getCartOps"),c("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}}," ")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}}," ")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"     String res "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," (String) cartOps."),c("span",{style:{color:"#B392F0"}},"get"),c("span",{style:{color:"#E1E4E8"}},"(skuId."),c("span",{style:{color:"#B392F0"}},"toString"),c("span",{style:{color:"#E1E4E8"}},"());")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"     "),c("span",{style:{color:"#F97583"}},"if"),c("span",{style:{color:"#E1E4E8"}}," (StringUtils."),c("span",{style:{color:"#B392F0"}},"isEmpty"),c("span",{style:{color:"#E1E4E8"}},"(res)) {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"         "),c("span",{style:{color:"#6A737D"}},"//购物车没有这个商品执行以下代码")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"         "),c("span",{style:{color:"#6A737D"}},"//2、添加新商品到购物车")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"         CartItem cartItem "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#F97583"}},"new"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#B392F0"}},"CartItem"),c("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"         CompletableFuture<"),c("span",{style:{color:"#F97583"}},"Void"),c("span",{style:{color:"#E1E4E8"}},"> getSkuInfoTask "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," CompletableFuture."),c("span",{style:{color:"#B392F0"}},"runAsync"),c("span",{style:{color:"#E1E4E8"}},"(() "),c("span",{style:{color:"#F97583"}},"->"),c("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"             "),c("span",{style:{color:"#6A737D"}},"//1、远程查询当前要添加的商品的信息")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"             R r "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," productFeignService."),c("span",{style:{color:"#B392F0"}},"getSkuInfo"),c("span",{style:{color:"#E1E4E8"}},"(skuId);")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"             SkuInfoVo data "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," r."),c("span",{style:{color:"#B392F0"}},"getData"),c("span",{style:{color:"#E1E4E8"}},"("),c("span",{style:{color:"#9ECBFF"}},'"skuInfo"'),c("span",{style:{color:"#E1E4E8"}},", "),c("span",{style:{color:"#F97583"}},"new"),c("span",{style:{color:"#E1E4E8"}}," TypeReference<"),c("span",{style:{color:"#F97583"}},"SkuInfoVo"),c("span",{style:{color:"#E1E4E8"}},">() {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"             });")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}}," ")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"             cartItem."),c("span",{style:{color:"#B392F0"}},"setCheck"),c("span",{style:{color:"#E1E4E8"}},"("),c("span",{style:{color:"#79B8FF"}},"true"),c("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"             cartItem."),c("span",{style:{color:"#B392F0"}},"setCount"),c("span",{style:{color:"#E1E4E8"}},"(num);")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"             cartItem."),c("span",{style:{color:"#B392F0"}},"setImage"),c("span",{style:{color:"#E1E4E8"}},"(data."),c("span",{style:{color:"#B392F0"}},"getSkuDefaultImg"),c("span",{style:{color:"#E1E4E8"}},"());")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"             cartItem."),c("span",{style:{color:"#B392F0"}},"setTitle"),c("span",{style:{color:"#E1E4E8"}},"(data."),c("span",{style:{color:"#B392F0"}},"getSkuTitle"),c("span",{style:{color:"#E1E4E8"}},"());")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"             cartItem."),c("span",{style:{color:"#B392F0"}},"setSkuId"),c("span",{style:{color:"#E1E4E8"}},"(skuId);")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"             cartItem."),c("span",{style:{color:"#B392F0"}},"setPrice"),c("span",{style:{color:"#E1E4E8"}},"(data."),c("span",{style:{color:"#B392F0"}},"getPrice"),c("span",{style:{color:"#E1E4E8"}},"());")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"         }, executor);")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}}," ")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"         "),c("span",{style:{color:"#6A737D"}},"//3、远程查询sku的组合信息")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"         CompletableFuture<"),c("span",{style:{color:"#F97583"}},"Void"),c("span",{style:{color:"#E1E4E8"}},"> getSkuSaleAttrValues "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," CompletableFuture."),c("span",{style:{color:"#B392F0"}},"runAsync"),c("span",{style:{color:"#E1E4E8"}},"(() "),c("span",{style:{color:"#F97583"}},"->"),c("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"             List<"),c("span",{style:{color:"#F97583"}},"String"),c("span",{style:{color:"#E1E4E8"}},"> values "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," productFeignService."),c("span",{style:{color:"#B392F0"}},"getSkuSaleAttrValues"),c("span",{style:{color:"#E1E4E8"}},"(skuId);")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"             cartItem."),c("span",{style:{color:"#B392F0"}},"setSkuAttrs"),c("span",{style:{color:"#E1E4E8"}},"(values);")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"         }, executor);")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}}," ")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"         "),c("span",{style:{color:"#6A737D"}},"//异步全部完成才加入缓存")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"         CompletableFuture."),c("span",{style:{color:"#B392F0"}},"allOf"),c("span",{style:{color:"#E1E4E8"}},"(getSkuInfoTask, getSkuSaleAttrValues)."),c("span",{style:{color:"#B392F0"}},"get"),c("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"         String s "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," JSON."),c("span",{style:{color:"#B392F0"}},"toJSONString"),c("span",{style:{color:"#E1E4E8"}},"(cartItem);")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"         "),c("span",{style:{color:"#6A737D"}},"//加入缓存，skuId cartItem")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"         cartOps."),c("span",{style:{color:"#B392F0"}},"put"),c("span",{style:{color:"#E1E4E8"}},"(skuId."),c("span",{style:{color:"#B392F0"}},"toString"),c("span",{style:{color:"#E1E4E8"}},"(), s);")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"         "),c("span",{style:{color:"#F97583"}},"return"),c("span",{style:{color:"#E1E4E8"}}," cartItem;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"     } "),c("span",{style:{color:"#F97583"}},"else"),c("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"         "),c("span",{style:{color:"#6A737D"}},"//购物车有此商品，进行数量修改")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"         CartItem cartItem "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," JSON."),c("span",{style:{color:"#B392F0"}},"parseObject"),c("span",{style:{color:"#E1E4E8"}},"(res, CartItem.class);")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"         "),c("span",{style:{color:"#6A737D"}},"//当前操作仅修改了逆转回来的数据，还需要更新redis")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"         cartItem."),c("span",{style:{color:"#B392F0"}},"setCount"),c("span",{style:{color:"#E1E4E8"}},"(cartItem."),c("span",{style:{color:"#B392F0"}},"getCount"),c("span",{style:{color:"#E1E4E8"}},"() "),c("span",{style:{color:"#F97583"}},"+"),c("span",{style:{color:"#E1E4E8"}}," num);")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"         "),c("span",{style:{color:"#6A737D"}},"//再将修改后的数据转为json并存入redis")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"         cartOps."),c("span",{style:{color:"#B392F0"}},"put"),c("span",{style:{color:"#E1E4E8"}},"(skuId."),c("span",{style:{color:"#B392F0"}},"toString"),c("span",{style:{color:"#E1E4E8"}},"(), JSON."),c("span",{style:{color:"#B392F0"}},"toJSONString"),c("span",{style:{color:"#E1E4E8"}},"(cartItem));")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"         "),c("span",{style:{color:"#F97583"}},"return"),c("span",{style:{color:"#E1E4E8"}}," cartItem;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"     }")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}}," ")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}}," ")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}}," }")])])]),c("pre",{class:"shiki github-light vp-code-light"},[c("code",null,[c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"/**")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"  * 第一层 Map， Key 是用户 id")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"  * 第二层 Map， Key 是购物车中商品 id， 值是购物项数据")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"  * 将商品添加到购物车")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"  *")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"  * "),c("span",{style:{color:"#D73A49"}},"@param"),c("span",{style:{color:"#6A737D"}}," "),c("span",{style:{color:"#E36209"}},"skuId")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"  * "),c("span",{style:{color:"#D73A49"}},"@param"),c("span",{style:{color:"#6A737D"}}," "),c("span",{style:{color:"#E36209"}},"num")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"  * "),c("span",{style:{color:"#D73A49"}},"@return")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"  */")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}}," @"),c("span",{style:{color:"#D73A49"}},"Override")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#D73A49"}},"public"),c("span",{style:{color:"#24292E"}}," CartItem "),c("span",{style:{color:"#6F42C1"}},"addToCart"),c("span",{style:{color:"#24292E"}},"(Long skuId, Integer num) throws ExecutionException, InterruptedException {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"     "),c("span",{style:{color:"#6A737D"}},"//操作购物车")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"     BoundHashOperations<"),c("span",{style:{color:"#D73A49"}},"String"),c("span",{style:{color:"#24292E"}},", "),c("span",{style:{color:"#D73A49"}},"Object"),c("span",{style:{color:"#24292E"}},", "),c("span",{style:{color:"#D73A49"}},"Object"),c("span",{style:{color:"#24292E"}},"> cartOps "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#6F42C1"}},"getCartOps"),c("span",{style:{color:"#24292E"}},"();")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}}," ")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}}," ")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"     String res "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," (String) cartOps."),c("span",{style:{color:"#6F42C1"}},"get"),c("span",{style:{color:"#24292E"}},"(skuId."),c("span",{style:{color:"#6F42C1"}},"toString"),c("span",{style:{color:"#24292E"}},"());")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"     "),c("span",{style:{color:"#D73A49"}},"if"),c("span",{style:{color:"#24292E"}}," (StringUtils."),c("span",{style:{color:"#6F42C1"}},"isEmpty"),c("span",{style:{color:"#24292E"}},"(res)) {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"         "),c("span",{style:{color:"#6A737D"}},"//购物车没有这个商品执行以下代码")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"         "),c("span",{style:{color:"#6A737D"}},"//2、添加新商品到购物车")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"         CartItem cartItem "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#D73A49"}},"new"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#6F42C1"}},"CartItem"),c("span",{style:{color:"#24292E"}},"();")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"         CompletableFuture<"),c("span",{style:{color:"#D73A49"}},"Void"),c("span",{style:{color:"#24292E"}},"> getSkuInfoTask "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," CompletableFuture."),c("span",{style:{color:"#6F42C1"}},"runAsync"),c("span",{style:{color:"#24292E"}},"(() "),c("span",{style:{color:"#D73A49"}},"->"),c("span",{style:{color:"#24292E"}}," {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"             "),c("span",{style:{color:"#6A737D"}},"//1、远程查询当前要添加的商品的信息")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"             R r "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," productFeignService."),c("span",{style:{color:"#6F42C1"}},"getSkuInfo"),c("span",{style:{color:"#24292E"}},"(skuId);")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"             SkuInfoVo data "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," r."),c("span",{style:{color:"#6F42C1"}},"getData"),c("span",{style:{color:"#24292E"}},"("),c("span",{style:{color:"#032F62"}},'"skuInfo"'),c("span",{style:{color:"#24292E"}},", "),c("span",{style:{color:"#D73A49"}},"new"),c("span",{style:{color:"#24292E"}}," TypeReference<"),c("span",{style:{color:"#D73A49"}},"SkuInfoVo"),c("span",{style:{color:"#24292E"}},">() {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"             });")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}}," ")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"             cartItem."),c("span",{style:{color:"#6F42C1"}},"setCheck"),c("span",{style:{color:"#24292E"}},"("),c("span",{style:{color:"#005CC5"}},"true"),c("span",{style:{color:"#24292E"}},");")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"             cartItem."),c("span",{style:{color:"#6F42C1"}},"setCount"),c("span",{style:{color:"#24292E"}},"(num);")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"             cartItem."),c("span",{style:{color:"#6F42C1"}},"setImage"),c("span",{style:{color:"#24292E"}},"(data."),c("span",{style:{color:"#6F42C1"}},"getSkuDefaultImg"),c("span",{style:{color:"#24292E"}},"());")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"             cartItem."),c("span",{style:{color:"#6F42C1"}},"setTitle"),c("span",{style:{color:"#24292E"}},"(data."),c("span",{style:{color:"#6F42C1"}},"getSkuTitle"),c("span",{style:{color:"#24292E"}},"());")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"             cartItem."),c("span",{style:{color:"#6F42C1"}},"setSkuId"),c("span",{style:{color:"#24292E"}},"(skuId);")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"             cartItem."),c("span",{style:{color:"#6F42C1"}},"setPrice"),c("span",{style:{color:"#24292E"}},"(data."),c("span",{style:{color:"#6F42C1"}},"getPrice"),c("span",{style:{color:"#24292E"}},"());")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"         }, executor);")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}}," ")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"         "),c("span",{style:{color:"#6A737D"}},"//3、远程查询sku的组合信息")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"         CompletableFuture<"),c("span",{style:{color:"#D73A49"}},"Void"),c("span",{style:{color:"#24292E"}},"> getSkuSaleAttrValues "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," CompletableFuture."),c("span",{style:{color:"#6F42C1"}},"runAsync"),c("span",{style:{color:"#24292E"}},"(() "),c("span",{style:{color:"#D73A49"}},"->"),c("span",{style:{color:"#24292E"}}," {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"             List<"),c("span",{style:{color:"#D73A49"}},"String"),c("span",{style:{color:"#24292E"}},"> values "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," productFeignService."),c("span",{style:{color:"#6F42C1"}},"getSkuSaleAttrValues"),c("span",{style:{color:"#24292E"}},"(skuId);")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"             cartItem."),c("span",{style:{color:"#6F42C1"}},"setSkuAttrs"),c("span",{style:{color:"#24292E"}},"(values);")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"         }, executor);")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}}," ")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"         "),c("span",{style:{color:"#6A737D"}},"//异步全部完成才加入缓存")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"         CompletableFuture."),c("span",{style:{color:"#6F42C1"}},"allOf"),c("span",{style:{color:"#24292E"}},"(getSkuInfoTask, getSkuSaleAttrValues)."),c("span",{style:{color:"#6F42C1"}},"get"),c("span",{style:{color:"#24292E"}},"();")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"         String s "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," JSON."),c("span",{style:{color:"#6F42C1"}},"toJSONString"),c("span",{style:{color:"#24292E"}},"(cartItem);")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"         "),c("span",{style:{color:"#6A737D"}},"//加入缓存，skuId cartItem")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"         cartOps."),c("span",{style:{color:"#6F42C1"}},"put"),c("span",{style:{color:"#24292E"}},"(skuId."),c("span",{style:{color:"#6F42C1"}},"toString"),c("span",{style:{color:"#24292E"}},"(), s);")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"         "),c("span",{style:{color:"#D73A49"}},"return"),c("span",{style:{color:"#24292E"}}," cartItem;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"     } "),c("span",{style:{color:"#D73A49"}},"else"),c("span",{style:{color:"#24292E"}}," {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"         "),c("span",{style:{color:"#6A737D"}},"//购物车有此商品，进行数量修改")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"         CartItem cartItem "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," JSON."),c("span",{style:{color:"#6F42C1"}},"parseObject"),c("span",{style:{color:"#24292E"}},"(res, CartItem.class);")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"         "),c("span",{style:{color:"#6A737D"}},"//当前操作仅修改了逆转回来的数据，还需要更新redis")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"         cartItem."),c("span",{style:{color:"#6F42C1"}},"setCount"),c("span",{style:{color:"#24292E"}},"(cartItem."),c("span",{style:{color:"#6F42C1"}},"getCount"),c("span",{style:{color:"#24292E"}},"() "),c("span",{style:{color:"#D73A49"}},"+"),c("span",{style:{color:"#24292E"}}," num);")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"         "),c("span",{style:{color:"#6A737D"}},"//再将修改后的数据转为json并存入redis")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"         cartOps."),c("span",{style:{color:"#6F42C1"}},"put"),c("span",{style:{color:"#24292E"}},"(skuId."),c("span",{style:{color:"#6F42C1"}},"toString"),c("span",{style:{color:"#24292E"}},"(), JSON."),c("span",{style:{color:"#6F42C1"}},"toJSONString"),c("span",{style:{color:"#24292E"}},"(cartItem));")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"         "),c("span",{style:{color:"#D73A49"}},"return"),c("span",{style:{color:"#24292E"}}," cartItem;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"     }")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}}," ")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}}," ")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}}," }")])])])],-1),Y=c("ul",null,[c("li",null,"hash绑定方法，通过StringRedisTemplate将cartKey=gulimall:cart:userId/userKey与hash进行绑定操作")],-1),Z=c("div",{class:"language-java"},[c("button",{title:"Copy Code",class:"copy"}),c("span",{class:"lang"},"java"),c("pre",{class:"shiki github-dark vp-code-dark"},[c("code",null,[c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"/**")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"   * 获取到我们要操作的购物车")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"   *")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"   * "),c("span",{style:{color:"#F97583"}},"@return")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"   */")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"  "),c("span",{style:{color:"#F97583"}},"private"),c("span",{style:{color:"#E1E4E8"}}," BoundHashOperations"),c("span",{style:{color:"#F97583"}},"<"),c("span",{style:{color:"#E1E4E8"}},"String, Object, Object"),c("span",{style:{color:"#F97583"}},">"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#B392F0"}},"getCartOps"),c("span",{style:{color:"#E1E4E8"}},"() {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"      UserInfoTo userInfoTo "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," CartInterceptor.threadLocal."),c("span",{style:{color:"#B392F0"}},"get"),c("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"      "),c("span",{style:{color:"#6A737D"}},"//1、判断用户是否登录了")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"      String cartKey "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#9ECBFF"}},'""'),c("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"      "),c("span",{style:{color:"#F97583"}},"if"),c("span",{style:{color:"#E1E4E8"}}," (userInfoTo."),c("span",{style:{color:"#B392F0"}},"getUserId"),c("span",{style:{color:"#E1E4E8"}},"() "),c("span",{style:{color:"#F97583"}},"!="),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#79B8FF"}},"null"),c("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"          "),c("span",{style:{color:"#6A737D"}},"//用户登录了")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"          cartKey "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," CART_PREFIX "),c("span",{style:{color:"#F97583"}},"+"),c("span",{style:{color:"#E1E4E8"}}," userInfoTo."),c("span",{style:{color:"#B392F0"}},"getUserId"),c("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"      } "),c("span",{style:{color:"#F97583"}},"else"),c("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"          "),c("span",{style:{color:"#6A737D"}},"//用户没登录")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"          cartKey "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," CART_PREFIX "),c("span",{style:{color:"#F97583"}},"+"),c("span",{style:{color:"#E1E4E8"}}," userInfoTo."),c("span",{style:{color:"#B392F0"}},"getUserKey"),c("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"      }")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"  ")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"      "),c("span",{style:{color:"#6A737D"}},"//将购物车加入缓存绑定操作（hash）")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"      BoundHashOperations<"),c("span",{style:{color:"#F97583"}},"String"),c("span",{style:{color:"#E1E4E8"}},", "),c("span",{style:{color:"#F97583"}},"Object"),c("span",{style:{color:"#E1E4E8"}},", "),c("span",{style:{color:"#F97583"}},"Object"),c("span",{style:{color:"#E1E4E8"}},"> operations "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," redisTemplate."),c("span",{style:{color:"#B392F0"}},"boundHashOps"),c("span",{style:{color:"#E1E4E8"}},"(cartKey);")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"      "),c("span",{style:{color:"#F97583"}},"return"),c("span",{style:{color:"#E1E4E8"}}," operations;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"  }")])])]),c("pre",{class:"shiki github-light vp-code-light"},[c("code",null,[c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"/**")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"   * 获取到我们要操作的购物车")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"   *")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"   * "),c("span",{style:{color:"#D73A49"}},"@return")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"   */")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"  "),c("span",{style:{color:"#D73A49"}},"private"),c("span",{style:{color:"#24292E"}}," BoundHashOperations"),c("span",{style:{color:"#D73A49"}},"<"),c("span",{style:{color:"#24292E"}},"String, Object, Object"),c("span",{style:{color:"#D73A49"}},">"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#6F42C1"}},"getCartOps"),c("span",{style:{color:"#24292E"}},"() {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"      UserInfoTo userInfoTo "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," CartInterceptor.threadLocal."),c("span",{style:{color:"#6F42C1"}},"get"),c("span",{style:{color:"#24292E"}},"();")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"      "),c("span",{style:{color:"#6A737D"}},"//1、判断用户是否登录了")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"      String cartKey "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#032F62"}},'""'),c("span",{style:{color:"#24292E"}},";")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"      "),c("span",{style:{color:"#D73A49"}},"if"),c("span",{style:{color:"#24292E"}}," (userInfoTo."),c("span",{style:{color:"#6F42C1"}},"getUserId"),c("span",{style:{color:"#24292E"}},"() "),c("span",{style:{color:"#D73A49"}},"!="),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#005CC5"}},"null"),c("span",{style:{color:"#24292E"}},") {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"          "),c("span",{style:{color:"#6A737D"}},"//用户登录了")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"          cartKey "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," CART_PREFIX "),c("span",{style:{color:"#D73A49"}},"+"),c("span",{style:{color:"#24292E"}}," userInfoTo."),c("span",{style:{color:"#6F42C1"}},"getUserId"),c("span",{style:{color:"#24292E"}},"();")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"      } "),c("span",{style:{color:"#D73A49"}},"else"),c("span",{style:{color:"#24292E"}}," {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"          "),c("span",{style:{color:"#6A737D"}},"//用户没登录")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"          cartKey "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," CART_PREFIX "),c("span",{style:{color:"#D73A49"}},"+"),c("span",{style:{color:"#24292E"}}," userInfoTo."),c("span",{style:{color:"#6F42C1"}},"getUserKey"),c("span",{style:{color:"#24292E"}},"();")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"      }")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"  ")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"      "),c("span",{style:{color:"#6A737D"}},"//将购物车加入缓存绑定操作（hash）")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"      BoundHashOperations<"),c("span",{style:{color:"#D73A49"}},"String"),c("span",{style:{color:"#24292E"}},", "),c("span",{style:{color:"#D73A49"}},"Object"),c("span",{style:{color:"#24292E"}},", "),c("span",{style:{color:"#D73A49"}},"Object"),c("span",{style:{color:"#24292E"}},"> operations "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," redisTemplate."),c("span",{style:{color:"#6F42C1"}},"boundHashOps"),c("span",{style:{color:"#24292E"}},"(cartKey);")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"      "),c("span",{style:{color:"#D73A49"}},"return"),c("span",{style:{color:"#24292E"}}," operations;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"  }")])])])],-1),ss=c("blockquote",null,[c("p",null,"添加购物车时由String res = (String) cartOps.get(skuId.toString());判断指定商品是否加入了购物车，没有就进行添加购物车操作，异步全部完成封装购物项的信息后才加入缓存，将购物项转为Json形式存入hash中->String s = JSON.toJSONString(cartItem);cartOps.put(skuId.toString(), s); 购物车有此商品则进行添加操作，将缓存中的Json数据转为购物项对象进行添加操作，添加完再转回Json并存入hash中")],-1),ls={id:"_3、购物车列表",tabindex:"-1"},os=c("ul",null,[c("li",null,[p("购物车列表接口"),c("code",null,"org.klaus.zgg01mall.cart.controller.CartController#cartListPage")])],-1),ns=c("div",{class:"language-java"},[c("button",{title:"Copy Code",class:"copy"}),c("span",{class:"lang"},"java"),c("pre",{class:"shiki github-dark vp-code-dark"},[c("code",null,[c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"/**")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"     * 浏览器有一个cookie：user-key：标识用户身份，一个月后过期")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"     * 如果第一次使用jd的购物车功能，都会给一个临时的用户身份")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"     * 浏览器以后保存，每次访问都会带上这个cookie；")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"     *")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"     * 登录：session有")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"     * 没登录，按照cookie里面带来user-key来做")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"     * 第一次，如果没有临时用户，会帮忙创建一个临时用户。")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"     * "),c("span",{style:{color:"#F97583"}},"@return")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"     */")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    @"),c("span",{style:{color:"#F97583"}},"GetMapping"),c("span",{style:{color:"#E1E4E8"}},"("),c("span",{style:{color:"#9ECBFF"}},'"/cart.html"'),c("span",{style:{color:"#E1E4E8"}},")")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#F97583"}},"public"),c("span",{style:{color:"#E1E4E8"}}," String "),c("span",{style:{color:"#B392F0"}},"cartListPage"),c("span",{style:{color:"#E1E4E8"}},"(Model model) throws ExecutionException, InterruptedException {")]),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        "),c("span",{style:{color:"#6A737D"}},"//1、快速得到用户信息：id，user-key")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"//        UserInfoTo userInfoTo = CartInterceptor.threadLocal.get();")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"//        System.out.println(userInfoTo);")]),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        Cart cart "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," cartService."),c("span",{style:{color:"#B392F0"}},"getCart"),c("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        model."),c("span",{style:{color:"#B392F0"}},"addAttribute"),c("span",{style:{color:"#E1E4E8"}},"("),c("span",{style:{color:"#9ECBFF"}},'"cart"'),c("span",{style:{color:"#E1E4E8"}},", cart);")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        "),c("span",{style:{color:"#F97583"}},"return"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#9ECBFF"}},'"cartList"'),c("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    }")])])]),c("pre",{class:"shiki github-light vp-code-light"},[c("code",null,[c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"/**")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"     * 浏览器有一个cookie：user-key：标识用户身份，一个月后过期")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"     * 如果第一次使用jd的购物车功能，都会给一个临时的用户身份")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"     * 浏览器以后保存，每次访问都会带上这个cookie；")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"     *")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"     * 登录：session有")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"     * 没登录，按照cookie里面带来user-key来做")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"     * 第一次，如果没有临时用户，会帮忙创建一个临时用户。")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"     * "),c("span",{style:{color:"#D73A49"}},"@return")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"     */")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    @"),c("span",{style:{color:"#D73A49"}},"GetMapping"),c("span",{style:{color:"#24292E"}},"("),c("span",{style:{color:"#032F62"}},'"/cart.html"'),c("span",{style:{color:"#24292E"}},")")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#D73A49"}},"public"),c("span",{style:{color:"#24292E"}}," String "),c("span",{style:{color:"#6F42C1"}},"cartListPage"),c("span",{style:{color:"#24292E"}},"(Model model) throws ExecutionException, InterruptedException {")]),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        "),c("span",{style:{color:"#6A737D"}},"//1、快速得到用户信息：id，user-key")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"//        UserInfoTo userInfoTo = CartInterceptor.threadLocal.get();")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"//        System.out.println(userInfoTo);")]),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        Cart cart "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," cartService."),c("span",{style:{color:"#6F42C1"}},"getCart"),c("span",{style:{color:"#24292E"}},"();")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        model."),c("span",{style:{color:"#6F42C1"}},"addAttribute"),c("span",{style:{color:"#24292E"}},"("),c("span",{style:{color:"#032F62"}},'"cart"'),c("span",{style:{color:"#24292E"}},", cart);")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        "),c("span",{style:{color:"#D73A49"}},"return"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#032F62"}},'"cartList"'),c("span",{style:{color:"#24292E"}},";")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    }")])])])],-1),as=c("ul",null,[c("li",null,[p("获取整个购物车方法实现"),c("code",null,"org.klaus.zgg01mall.cart.service.impl.CartServiceImpl#getCart")])],-1),es=c("div",{class:"language-java"},[c("button",{title:"Copy Code",class:"copy"}),c("span",{class:"lang"},"java"),c("pre",{class:"shiki github-dark vp-code-dark"},[c("code",null,[c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"/**")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}}," * 获取整个购物车")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}}," *")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}}," * "),c("span",{style:{color:"#F97583"}},"@return")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}}," */")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"@"),c("span",{style:{color:"#F97583"}},"Override")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#F97583"}},"public"),c("span",{style:{color:"#E1E4E8"}}," Cart "),c("span",{style:{color:"#B392F0"}},"getCart"),c("span",{style:{color:"#E1E4E8"}},"() throws ExecutionException, InterruptedException {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    Cart cart "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#F97583"}},"new"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#B392F0"}},"Cart"),c("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    UserInfoTo userInfoTo "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," CartInterceptor.threadLocal."),c("span",{style:{color:"#B392F0"}},"get"),c("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#F97583"}},"if"),c("span",{style:{color:"#E1E4E8"}}," (userInfoTo."),c("span",{style:{color:"#B392F0"}},"getUserId"),c("span",{style:{color:"#E1E4E8"}},"() "),c("span",{style:{color:"#F97583"}},"!="),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#79B8FF"}},"null"),c("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        "),c("span",{style:{color:"#6A737D"}},"//1、登录")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        String cartKey "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," CART_PREFIX "),c("span",{style:{color:"#F97583"}},"+"),c("span",{style:{color:"#E1E4E8"}}," userInfoTo."),c("span",{style:{color:"#B392F0"}},"getUserId"),c("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        "),c("span",{style:{color:"#6A737D"}},"//1.1、如果临时购物车的数据还没有合并【合并购物车】")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        "),c("span",{style:{color:"#6A737D"}},"//临时购物车的所有购物项")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        String tempCartKey "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," CART_PREFIX "),c("span",{style:{color:"#F97583"}},"+"),c("span",{style:{color:"#E1E4E8"}}," userInfoTo."),c("span",{style:{color:"#B392F0"}},"getUserKey"),c("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        List<"),c("span",{style:{color:"#F97583"}},"CartItem"),c("span",{style:{color:"#E1E4E8"}},"> tempCartItems "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#B392F0"}},"getCartItems"),c("span",{style:{color:"#E1E4E8"}},"(tempCartKey);")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        "),c("span",{style:{color:"#F97583"}},"if"),c("span",{style:{color:"#E1E4E8"}}," (tempCartItems "),c("span",{style:{color:"#F97583"}},"!="),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#79B8FF"}},"null"),c("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"            "),c("span",{style:{color:"#6A737D"}},"//临时购物车有数据，需要合并")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"            "),c("span",{style:{color:"#F97583"}},"for"),c("span",{style:{color:"#E1E4E8"}}," (CartItem item "),c("span",{style:{color:"#F97583"}},":"),c("span",{style:{color:"#E1E4E8"}}," tempCartItems) {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"                "),c("span",{style:{color:"#B392F0"}},"addToCart"),c("span",{style:{color:"#E1E4E8"}},"(item."),c("span",{style:{color:"#B392F0"}},"getSkuId"),c("span",{style:{color:"#E1E4E8"}},"(), item."),c("span",{style:{color:"#B392F0"}},"getCount"),c("span",{style:{color:"#E1E4E8"}},"());")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"            }")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"            "),c("span",{style:{color:"#6A737D"}},"//合并完后清除临时购物车的数据")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"            "),c("span",{style:{color:"#B392F0"}},"clearCart"),c("span",{style:{color:"#E1E4E8"}},"(tempCartKey);")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        }")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        "),c("span",{style:{color:"#6A737D"}},"//3、获取登录后的购物车数据【包含合并过来的临时购物车的数据，和登录后的购物车数据】")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        List<"),c("span",{style:{color:"#F97583"}},"CartItem"),c("span",{style:{color:"#E1E4E8"}},"> cartItems "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#B392F0"}},"getCartItems"),c("span",{style:{color:"#E1E4E8"}},"(cartKey);")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        cart."),c("span",{style:{color:"#B392F0"}},"setItems"),c("span",{style:{color:"#E1E4E8"}},"(cartItems);")]),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    } "),c("span",{style:{color:"#F97583"}},"else"),c("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        "),c("span",{style:{color:"#6A737D"}},"//2、没登录")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        String cartKey "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," CART_PREFIX "),c("span",{style:{color:"#F97583"}},"+"),c("span",{style:{color:"#E1E4E8"}}," userInfoTo."),c("span",{style:{color:"#B392F0"}},"getUserKey"),c("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        "),c("span",{style:{color:"#6A737D"}},"//获取临时购物车的所有购物项")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        List<"),c("span",{style:{color:"#F97583"}},"CartItem"),c("span",{style:{color:"#E1E4E8"}},"> cartItems "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#B392F0"}},"getCartItems"),c("span",{style:{color:"#E1E4E8"}},"(cartKey);")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        cart."),c("span",{style:{color:"#B392F0"}},"setItems"),c("span",{style:{color:"#E1E4E8"}},"(cartItems);")]),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#F97583"}},"return"),c("span",{style:{color:"#E1E4E8"}}," cart;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"}")])])]),c("pre",{class:"shiki github-light vp-code-light"},[c("code",null,[c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"/**")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}}," * 获取整个购物车")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}}," *")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}}," * "),c("span",{style:{color:"#D73A49"}},"@return")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}}," */")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"@"),c("span",{style:{color:"#D73A49"}},"Override")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#D73A49"}},"public"),c("span",{style:{color:"#24292E"}}," Cart "),c("span",{style:{color:"#6F42C1"}},"getCart"),c("span",{style:{color:"#24292E"}},"() throws ExecutionException, InterruptedException {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    Cart cart "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#D73A49"}},"new"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#6F42C1"}},"Cart"),c("span",{style:{color:"#24292E"}},"();")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    UserInfoTo userInfoTo "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," CartInterceptor.threadLocal."),c("span",{style:{color:"#6F42C1"}},"get"),c("span",{style:{color:"#24292E"}},"();")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#D73A49"}},"if"),c("span",{style:{color:"#24292E"}}," (userInfoTo."),c("span",{style:{color:"#6F42C1"}},"getUserId"),c("span",{style:{color:"#24292E"}},"() "),c("span",{style:{color:"#D73A49"}},"!="),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#005CC5"}},"null"),c("span",{style:{color:"#24292E"}},") {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        "),c("span",{style:{color:"#6A737D"}},"//1、登录")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        String cartKey "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," CART_PREFIX "),c("span",{style:{color:"#D73A49"}},"+"),c("span",{style:{color:"#24292E"}}," userInfoTo."),c("span",{style:{color:"#6F42C1"}},"getUserId"),c("span",{style:{color:"#24292E"}},"();")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        "),c("span",{style:{color:"#6A737D"}},"//1.1、如果临时购物车的数据还没有合并【合并购物车】")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        "),c("span",{style:{color:"#6A737D"}},"//临时购物车的所有购物项")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        String tempCartKey "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," CART_PREFIX "),c("span",{style:{color:"#D73A49"}},"+"),c("span",{style:{color:"#24292E"}}," userInfoTo."),c("span",{style:{color:"#6F42C1"}},"getUserKey"),c("span",{style:{color:"#24292E"}},"();")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        List<"),c("span",{style:{color:"#D73A49"}},"CartItem"),c("span",{style:{color:"#24292E"}},"> tempCartItems "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#6F42C1"}},"getCartItems"),c("span",{style:{color:"#24292E"}},"(tempCartKey);")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        "),c("span",{style:{color:"#D73A49"}},"if"),c("span",{style:{color:"#24292E"}}," (tempCartItems "),c("span",{style:{color:"#D73A49"}},"!="),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#005CC5"}},"null"),c("span",{style:{color:"#24292E"}},") {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"            "),c("span",{style:{color:"#6A737D"}},"//临时购物车有数据，需要合并")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"            "),c("span",{style:{color:"#D73A49"}},"for"),c("span",{style:{color:"#24292E"}}," (CartItem item "),c("span",{style:{color:"#D73A49"}},":"),c("span",{style:{color:"#24292E"}}," tempCartItems) {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"                "),c("span",{style:{color:"#6F42C1"}},"addToCart"),c("span",{style:{color:"#24292E"}},"(item."),c("span",{style:{color:"#6F42C1"}},"getSkuId"),c("span",{style:{color:"#24292E"}},"(), item."),c("span",{style:{color:"#6F42C1"}},"getCount"),c("span",{style:{color:"#24292E"}},"());")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"            }")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"            "),c("span",{style:{color:"#6A737D"}},"//合并完后清除临时购物车的数据")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"            "),c("span",{style:{color:"#6F42C1"}},"clearCart"),c("span",{style:{color:"#24292E"}},"(tempCartKey);")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        }")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        "),c("span",{style:{color:"#6A737D"}},"//3、获取登录后的购物车数据【包含合并过来的临时购物车的数据，和登录后的购物车数据】")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        List<"),c("span",{style:{color:"#D73A49"}},"CartItem"),c("span",{style:{color:"#24292E"}},"> cartItems "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#6F42C1"}},"getCartItems"),c("span",{style:{color:"#24292E"}},"(cartKey);")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        cart."),c("span",{style:{color:"#6F42C1"}},"setItems"),c("span",{style:{color:"#24292E"}},"(cartItems);")]),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    } "),c("span",{style:{color:"#D73A49"}},"else"),c("span",{style:{color:"#24292E"}}," {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        "),c("span",{style:{color:"#6A737D"}},"//2、没登录")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        String cartKey "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," CART_PREFIX "),c("span",{style:{color:"#D73A49"}},"+"),c("span",{style:{color:"#24292E"}}," userInfoTo."),c("span",{style:{color:"#6F42C1"}},"getUserKey"),c("span",{style:{color:"#24292E"}},"();")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        "),c("span",{style:{color:"#6A737D"}},"//获取临时购物车的所有购物项")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        List<"),c("span",{style:{color:"#D73A49"}},"CartItem"),c("span",{style:{color:"#24292E"}},"> cartItems "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#6F42C1"}},"getCartItems"),c("span",{style:{color:"#24292E"}},"(cartKey);")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        cart."),c("span",{style:{color:"#6F42C1"}},"setItems"),c("span",{style:{color:"#24292E"}},"(cartItems);")]),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    }")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#D73A49"}},"return"),c("span",{style:{color:"#24292E"}}," cart;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"}")])])])],-1),ts=c("ul",null,[c("li",null,[p("获取所有购物项方法"),c("code",null,"org.klaus.zgg01mall.cart.service.impl.CartServiceImpl#getCartItems"),c("ul",null,[c("li",null,"获取购物项再次进行hash绑定操作，因为之前已经绑定过一次，如果添加过购物车，缓存中是有数据的，直接遍历缓存中的Json数据并转为购物项对象返回出去，若没有则返回null")])])],-1),cs=c("div",{class:"language-java"},[c("button",{title:"Copy Code",class:"copy"}),c("span",{class:"lang"},"java"),c("pre",{class:"shiki github-dark vp-code-dark"},[c("code",null,[c("span",{class:"line"},[c("span",{style:{color:"#F97583"}},"private"),c("span",{style:{color:"#E1E4E8"}}," List"),c("span",{style:{color:"#F97583"}},"<"),c("span",{style:{color:"#E1E4E8"}},"CartItem"),c("span",{style:{color:"#F97583"}},">"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#B392F0"}},"getCartItems"),c("span",{style:{color:"#E1E4E8"}},"(String cartKey) {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    BoundHashOperations<"),c("span",{style:{color:"#F97583"}},"String"),c("span",{style:{color:"#E1E4E8"}},", "),c("span",{style:{color:"#F97583"}},"Object"),c("span",{style:{color:"#E1E4E8"}},", "),c("span",{style:{color:"#F97583"}},"Object"),c("span",{style:{color:"#E1E4E8"}},"> hashOps "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," redisTemplate."),c("span",{style:{color:"#B392F0"}},"boundHashOps"),c("span",{style:{color:"#E1E4E8"}},"(cartKey);")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    List<"),c("span",{style:{color:"#F97583"}},"Object"),c("span",{style:{color:"#E1E4E8"}},"> values "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," hashOps."),c("span",{style:{color:"#B392F0"}},"values"),c("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#F97583"}},"if"),c("span",{style:{color:"#E1E4E8"}}," (values "),c("span",{style:{color:"#F97583"}},"!="),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#79B8FF"}},"null"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#F97583"}},"&&"),c("span",{style:{color:"#E1E4E8"}}," values."),c("span",{style:{color:"#B392F0"}},"size"),c("span",{style:{color:"#E1E4E8"}},"() "),c("span",{style:{color:"#F97583"}},">"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#79B8FF"}},"0"),c("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        List<"),c("span",{style:{color:"#F97583"}},"CartItem"),c("span",{style:{color:"#E1E4E8"}},"> collect "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," values."),c("span",{style:{color:"#B392F0"}},"stream"),c("span",{style:{color:"#E1E4E8"}},"()."),c("span",{style:{color:"#B392F0"}},"map"),c("span",{style:{color:"#E1E4E8"}},"((obj) "),c("span",{style:{color:"#F97583"}},"->"),c("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"            String str "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," (String) obj;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"            CartItem cartItem "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," JSON."),c("span",{style:{color:"#B392F0"}},"parseObject"),c("span",{style:{color:"#E1E4E8"}},"(str, CartItem.class);")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"            "),c("span",{style:{color:"#F97583"}},"return"),c("span",{style:{color:"#E1E4E8"}}," cartItem;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        })."),c("span",{style:{color:"#B392F0"}},"collect"),c("span",{style:{color:"#E1E4E8"}},"(Collectors."),c("span",{style:{color:"#B392F0"}},"toList"),c("span",{style:{color:"#E1E4E8"}},"());")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        "),c("span",{style:{color:"#F97583"}},"return"),c("span",{style:{color:"#E1E4E8"}}," collect;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#F97583"}},"return"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#79B8FF"}},"null"),c("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"}")])])]),c("pre",{class:"shiki github-light vp-code-light"},[c("code",null,[c("span",{class:"line"},[c("span",{style:{color:"#D73A49"}},"private"),c("span",{style:{color:"#24292E"}}," List"),c("span",{style:{color:"#D73A49"}},"<"),c("span",{style:{color:"#24292E"}},"CartItem"),c("span",{style:{color:"#D73A49"}},">"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#6F42C1"}},"getCartItems"),c("span",{style:{color:"#24292E"}},"(String cartKey) {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    BoundHashOperations<"),c("span",{style:{color:"#D73A49"}},"String"),c("span",{style:{color:"#24292E"}},", "),c("span",{style:{color:"#D73A49"}},"Object"),c("span",{style:{color:"#24292E"}},", "),c("span",{style:{color:"#D73A49"}},"Object"),c("span",{style:{color:"#24292E"}},"> hashOps "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," redisTemplate."),c("span",{style:{color:"#6F42C1"}},"boundHashOps"),c("span",{style:{color:"#24292E"}},"(cartKey);")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    List<"),c("span",{style:{color:"#D73A49"}},"Object"),c("span",{style:{color:"#24292E"}},"> values "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," hashOps."),c("span",{style:{color:"#6F42C1"}},"values"),c("span",{style:{color:"#24292E"}},"();")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#D73A49"}},"if"),c("span",{style:{color:"#24292E"}}," (values "),c("span",{style:{color:"#D73A49"}},"!="),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#005CC5"}},"null"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#D73A49"}},"&&"),c("span",{style:{color:"#24292E"}}," values."),c("span",{style:{color:"#6F42C1"}},"size"),c("span",{style:{color:"#24292E"}},"() "),c("span",{style:{color:"#D73A49"}},">"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#005CC5"}},"0"),c("span",{style:{color:"#24292E"}},") {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        List<"),c("span",{style:{color:"#D73A49"}},"CartItem"),c("span",{style:{color:"#24292E"}},"> collect "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," values."),c("span",{style:{color:"#6F42C1"}},"stream"),c("span",{style:{color:"#24292E"}},"()."),c("span",{style:{color:"#6F42C1"}},"map"),c("span",{style:{color:"#24292E"}},"((obj) "),c("span",{style:{color:"#D73A49"}},"->"),c("span",{style:{color:"#24292E"}}," {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"            String str "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," (String) obj;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"            CartItem cartItem "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," JSON."),c("span",{style:{color:"#6F42C1"}},"parseObject"),c("span",{style:{color:"#24292E"}},"(str, CartItem.class);")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"            "),c("span",{style:{color:"#D73A49"}},"return"),c("span",{style:{color:"#24292E"}}," cartItem;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        })."),c("span",{style:{color:"#6F42C1"}},"collect"),c("span",{style:{color:"#24292E"}},"(Collectors."),c("span",{style:{color:"#6F42C1"}},"toList"),c("span",{style:{color:"#24292E"}},"());")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        "),c("span",{style:{color:"#D73A49"}},"return"),c("span",{style:{color:"#24292E"}}," collect;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    }")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#D73A49"}},"return"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#005CC5"}},"null"),c("span",{style:{color:"#24292E"}},";")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"}")])])])],-1),ps={id:"_4、添加购物车成功页",tabindex:"-1"},rs=c("ul",null,[c("li",null,[p("添加购物车成功页接口"),c("code",null,"org.klaus.zgg01mall.cart.controller.CartController#addToCartSuccessPage")])],-1),Es=c("div",{class:"language-java"},[c("button",{title:"Copy Code",class:"copy"}),c("span",{class:"lang"},"java"),c("pre",{class:"shiki github-dark vp-code-dark"},[c("code",null,[c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"/**")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}}," * 跳转到成功页，增加购物车用到2个页面，防止在添加购物车之后再刷新页面时自动增加")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}}," * "),c("span",{style:{color:"#F97583"}},"@param"),c("span",{style:{color:"#6A737D"}}," "),c("span",{style:{color:"#FFAB70"}},"skuId")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}}," * "),c("span",{style:{color:"#F97583"}},"@param"),c("span",{style:{color:"#6A737D"}}," "),c("span",{style:{color:"#FFAB70"}},"model")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}}," * "),c("span",{style:{color:"#F97583"}},"@return")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}}," */")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"@"),c("span",{style:{color:"#F97583"}},"GetMapping"),c("span",{style:{color:"#E1E4E8"}},"("),c("span",{style:{color:"#9ECBFF"}},'"/addToCartSuccess.html"'),c("span",{style:{color:"#E1E4E8"}},")")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#F97583"}},"public"),c("span",{style:{color:"#E1E4E8"}}," String "),c("span",{style:{color:"#B392F0"}},"addToCartSuccessPage"),c("span",{style:{color:"#E1E4E8"}},"(@"),c("span",{style:{color:"#F97583"}},"RequestParam"),c("span",{style:{color:"#E1E4E8"}},"("),c("span",{style:{color:"#9ECBFF"}},'"skuId"'),c("span",{style:{color:"#E1E4E8"}},")Long skuId, Model model){")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#6A737D"}},"//重定向到成功页面，再次查询购物车数据即可")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    CartItem item "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," cartService."),c("span",{style:{color:"#B392F0"}},"getCartItem"),c("span",{style:{color:"#E1E4E8"}},"(skuId);")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    model."),c("span",{style:{color:"#B392F0"}},"addAttribute"),c("span",{style:{color:"#E1E4E8"}},"("),c("span",{style:{color:"#9ECBFF"}},'"item"'),c("span",{style:{color:"#E1E4E8"}},", item);")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#F97583"}},"return"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#9ECBFF"}},'"success"'),c("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"}")])])]),c("pre",{class:"shiki github-light vp-code-light"},[c("code",null,[c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"/**")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}}," * 跳转到成功页，增加购物车用到2个页面，防止在添加购物车之后再刷新页面时自动增加")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}}," * "),c("span",{style:{color:"#D73A49"}},"@param"),c("span",{style:{color:"#6A737D"}}," "),c("span",{style:{color:"#E36209"}},"skuId")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}}," * "),c("span",{style:{color:"#D73A49"}},"@param"),c("span",{style:{color:"#6A737D"}}," "),c("span",{style:{color:"#E36209"}},"model")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}}," * "),c("span",{style:{color:"#D73A49"}},"@return")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}}," */")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"@"),c("span",{style:{color:"#D73A49"}},"GetMapping"),c("span",{style:{color:"#24292E"}},"("),c("span",{style:{color:"#032F62"}},'"/addToCartSuccess.html"'),c("span",{style:{color:"#24292E"}},")")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#D73A49"}},"public"),c("span",{style:{color:"#24292E"}}," String "),c("span",{style:{color:"#6F42C1"}},"addToCartSuccessPage"),c("span",{style:{color:"#24292E"}},"(@"),c("span",{style:{color:"#D73A49"}},"RequestParam"),c("span",{style:{color:"#24292E"}},"("),c("span",{style:{color:"#032F62"}},'"skuId"'),c("span",{style:{color:"#24292E"}},")Long skuId, Model model){")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#6A737D"}},"//重定向到成功页面，再次查询购物车数据即可")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    CartItem item "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," cartService."),c("span",{style:{color:"#6F42C1"}},"getCartItem"),c("span",{style:{color:"#24292E"}},"(skuId);")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    model."),c("span",{style:{color:"#6F42C1"}},"addAttribute"),c("span",{style:{color:"#24292E"}},"("),c("span",{style:{color:"#032F62"}},'"item"'),c("span",{style:{color:"#24292E"}},", item);")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#D73A49"}},"return"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#032F62"}},'"success"'),c("span",{style:{color:"#24292E"}},";")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"}")])])])],-1),ys=c("ul",null,[c("li",null,[p("获取购物项方法实现"),c("code",null,"org.klaus.zgg01mall.cart.service.impl.CartServiceImpl#getCartItem"),c("ul",null,[c("li",null,"获取hash操作并拿到指定skuId的购物项Json，然后转为对象返回出去")])])],-1),is=c("div",{class:"language-java"},[c("button",{title:"Copy Code",class:"copy"}),c("span",{class:"lang"},"java"),c("pre",{class:"shiki github-dark vp-code-dark"},[c("code",null,[c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"/**")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}}," * 获取购物车中某个购物项")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}}," *")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}}," * "),c("span",{style:{color:"#F97583"}},"@param"),c("span",{style:{color:"#6A737D"}}," "),c("span",{style:{color:"#FFAB70"}},"skuId")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}}," * "),c("span",{style:{color:"#F97583"}},"@return")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}}," */")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"@"),c("span",{style:{color:"#F97583"}},"Override")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#F97583"}},"public"),c("span",{style:{color:"#E1E4E8"}}," CartItem "),c("span",{style:{color:"#B392F0"}},"getCartItem"),c("span",{style:{color:"#E1E4E8"}},"(Long skuId) {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    BoundHashOperations<"),c("span",{style:{color:"#F97583"}},"String"),c("span",{style:{color:"#E1E4E8"}},", "),c("span",{style:{color:"#F97583"}},"Object"),c("span",{style:{color:"#E1E4E8"}},", "),c("span",{style:{color:"#F97583"}},"Object"),c("span",{style:{color:"#E1E4E8"}},"> cartOps "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#B392F0"}},"getCartOps"),c("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    String str "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," (String) cartOps."),c("span",{style:{color:"#B392F0"}},"get"),c("span",{style:{color:"#E1E4E8"}},"(skuId."),c("span",{style:{color:"#B392F0"}},"toString"),c("span",{style:{color:"#E1E4E8"}},"());")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#6A737D"}},"//将缓存中的数据转为vo对象")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    CartItem cartItem "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," JSON."),c("span",{style:{color:"#B392F0"}},"parseObject"),c("span",{style:{color:"#E1E4E8"}},"(str, CartItem.class);")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#F97583"}},"return"),c("span",{style:{color:"#E1E4E8"}}," cartItem;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"}")])])]),c("pre",{class:"shiki github-light vp-code-light"},[c("code",null,[c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"/**")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}}," * 获取购物车中某个购物项")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}}," *")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}}," * "),c("span",{style:{color:"#D73A49"}},"@param"),c("span",{style:{color:"#6A737D"}}," "),c("span",{style:{color:"#E36209"}},"skuId")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}}," * "),c("span",{style:{color:"#D73A49"}},"@return")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}}," */")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"@"),c("span",{style:{color:"#D73A49"}},"Override")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#D73A49"}},"public"),c("span",{style:{color:"#24292E"}}," CartItem "),c("span",{style:{color:"#6F42C1"}},"getCartItem"),c("span",{style:{color:"#24292E"}},"(Long skuId) {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    BoundHashOperations<"),c("span",{style:{color:"#D73A49"}},"String"),c("span",{style:{color:"#24292E"}},", "),c("span",{style:{color:"#D73A49"}},"Object"),c("span",{style:{color:"#24292E"}},", "),c("span",{style:{color:"#D73A49"}},"Object"),c("span",{style:{color:"#24292E"}},"> cartOps "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#6F42C1"}},"getCartOps"),c("span",{style:{color:"#24292E"}},"();")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    String str "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," (String) cartOps."),c("span",{style:{color:"#6F42C1"}},"get"),c("span",{style:{color:"#24292E"}},"(skuId."),c("span",{style:{color:"#6F42C1"}},"toString"),c("span",{style:{color:"#24292E"}},"());")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#6A737D"}},"//将缓存中的数据转为vo对象")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    CartItem cartItem "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," JSON."),c("span",{style:{color:"#6F42C1"}},"parseObject"),c("span",{style:{color:"#24292E"}},"(str, CartItem.class);")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#D73A49"}},"return"),c("span",{style:{color:"#24292E"}}," cartItem;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"}")])])])],-1),us={id:"_5、删除购物项",tabindex:"-1"},ds=c("ul",null,[c("li",null,"删除购物项接口")],-1),gs=c("div",{class:"language-java"},[c("button",{title:"Copy Code",class:"copy"}),c("span",{class:"lang"},"java"),c("pre",{class:"shiki github-dark vp-code-dark"},[c("code",null,[c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"@"),c("span",{style:{color:"#F97583"}},"GetMapping"),c("span",{style:{color:"#E1E4E8"}},"("),c("span",{style:{color:"#9ECBFF"}},'"/deleteItem"'),c("span",{style:{color:"#E1E4E8"}},")")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#F97583"}},"public"),c("span",{style:{color:"#E1E4E8"}}," String "),c("span",{style:{color:"#B392F0"}},"deleteItem"),c("span",{style:{color:"#E1E4E8"}},"(@"),c("span",{style:{color:"#F97583"}},"RequestParam"),c("span",{style:{color:"#E1E4E8"}},"("),c("span",{style:{color:"#9ECBFF"}},'"skuId"'),c("span",{style:{color:"#E1E4E8"}},") Long skuId){")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    cartService."),c("span",{style:{color:"#B392F0"}},"deleteItem"),c("span",{style:{color:"#E1E4E8"}},"(skuId);")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#F97583"}},"return"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#9ECBFF"}},'"redirect:http://cart.gulimall.com/cart.html"'),c("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"}")])])]),c("pre",{class:"shiki github-light vp-code-light"},[c("code",null,[c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"@"),c("span",{style:{color:"#D73A49"}},"GetMapping"),c("span",{style:{color:"#24292E"}},"("),c("span",{style:{color:"#032F62"}},'"/deleteItem"'),c("span",{style:{color:"#24292E"}},")")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#D73A49"}},"public"),c("span",{style:{color:"#24292E"}}," String "),c("span",{style:{color:"#6F42C1"}},"deleteItem"),c("span",{style:{color:"#24292E"}},"(@"),c("span",{style:{color:"#D73A49"}},"RequestParam"),c("span",{style:{color:"#24292E"}},"("),c("span",{style:{color:"#032F62"}},'"skuId"'),c("span",{style:{color:"#24292E"}},") Long skuId){")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    cartService."),c("span",{style:{color:"#6F42C1"}},"deleteItem"),c("span",{style:{color:"#24292E"}},"(skuId);")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#D73A49"}},"return"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#032F62"}},'"redirect:http://cart.gulimall.com/cart.html"'),c("span",{style:{color:"#24292E"}},";")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"}")])])])],-1),Fs=c("ul",null,[c("li",null,[p("删除购物项方法实现 "),c("ul",null,[c("li",null,"通过hash操作删除指定skuId的购物项")])])],-1),Ds=c("div",{class:"language-java"},[c("button",{title:"Copy Code",class:"copy"}),c("span",{class:"lang"},"java"),c("pre",{class:"shiki github-dark vp-code-dark"},[c("code",null,[c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"/**")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}}," * 删除购物项")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}}," *")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}}," * "),c("span",{style:{color:"#F97583"}},"@param"),c("span",{style:{color:"#6A737D"}}," "),c("span",{style:{color:"#FFAB70"}},"skuId")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}}," */")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"@"),c("span",{style:{color:"#F97583"}},"Override")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#F97583"}},"public"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#F97583"}},"void"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#B392F0"}},"deleteItem"),c("span",{style:{color:"#E1E4E8"}},"(Long skuId) {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    BoundHashOperations<"),c("span",{style:{color:"#F97583"}},"String"),c("span",{style:{color:"#E1E4E8"}},", "),c("span",{style:{color:"#F97583"}},"Object"),c("span",{style:{color:"#E1E4E8"}},", "),c("span",{style:{color:"#F97583"}},"Object"),c("span",{style:{color:"#E1E4E8"}},"> cartOps "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#B392F0"}},"getCartOps"),c("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#6A737D"}},"//删除指定键")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    cartOps."),c("span",{style:{color:"#B392F0"}},"delete"),c("span",{style:{color:"#E1E4E8"}},"(skuId."),c("span",{style:{color:"#B392F0"}},"toString"),c("span",{style:{color:"#E1E4E8"}},"());")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"}")])])]),c("pre",{class:"shiki github-light vp-code-light"},[c("code",null,[c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"/**")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}}," * 删除购物项")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}}," *")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}}," * "),c("span",{style:{color:"#D73A49"}},"@param"),c("span",{style:{color:"#6A737D"}}," "),c("span",{style:{color:"#E36209"}},"skuId")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}}," */")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"@"),c("span",{style:{color:"#D73A49"}},"Override")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#D73A49"}},"public"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#D73A49"}},"void"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#6F42C1"}},"deleteItem"),c("span",{style:{color:"#24292E"}},"(Long skuId) {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    BoundHashOperations<"),c("span",{style:{color:"#D73A49"}},"String"),c("span",{style:{color:"#24292E"}},", "),c("span",{style:{color:"#D73A49"}},"Object"),c("span",{style:{color:"#24292E"}},", "),c("span",{style:{color:"#D73A49"}},"Object"),c("span",{style:{color:"#24292E"}},"> cartOps "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#6F42C1"}},"getCartOps"),c("span",{style:{color:"#24292E"}},"();")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#6A737D"}},"//删除指定键")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    cartOps."),c("span",{style:{color:"#6F42C1"}},"delete"),c("span",{style:{color:"#24292E"}},"(skuId."),c("span",{style:{color:"#6F42C1"}},"toString"),c("span",{style:{color:"#24292E"}},"());")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"}")])])])],-1),As={id:"_6、改变购物项数量",tabindex:"-1"},Cs=c("ul",null,[c("li",null,"改变购物项数量接口")],-1),hs=c("div",{class:"language-java"},[c("button",{title:"Copy Code",class:"copy"}),c("span",{class:"lang"},"java"),c("pre",{class:"shiki github-dark vp-code-dark"},[c("code",null,[c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"@"),c("span",{style:{color:"#F97583"}},"GetMapping"),c("span",{style:{color:"#E1E4E8"}},"("),c("span",{style:{color:"#9ECBFF"}},'"/countItem"'),c("span",{style:{color:"#E1E4E8"}},")")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#F97583"}},"public"),c("span",{style:{color:"#E1E4E8"}}," String "),c("span",{style:{color:"#B392F0"}},"countItem"),c("span",{style:{color:"#E1E4E8"}},"(@"),c("span",{style:{color:"#F97583"}},"RequestParam"),c("span",{style:{color:"#E1E4E8"}},"("),c("span",{style:{color:"#9ECBFF"}},'"skuId"'),c("span",{style:{color:"#E1E4E8"}},") Long skuId,")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"                        @"),c("span",{style:{color:"#F97583"}},"RequestParam"),c("span",{style:{color:"#E1E4E8"}},"("),c("span",{style:{color:"#9ECBFF"}},'"num"'),c("span",{style:{color:"#E1E4E8"}},") Integer num){")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    cartService."),c("span",{style:{color:"#B392F0"}},"changeItemCount"),c("span",{style:{color:"#E1E4E8"}},"(skuId, num);")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#F97583"}},"return"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#9ECBFF"}},'"redirect:http://cart.gulimall.com/cart.html"'),c("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"}")])])]),c("pre",{class:"shiki github-light vp-code-light"},[c("code",null,[c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"@"),c("span",{style:{color:"#D73A49"}},"GetMapping"),c("span",{style:{color:"#24292E"}},"("),c("span",{style:{color:"#032F62"}},'"/countItem"'),c("span",{style:{color:"#24292E"}},")")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#D73A49"}},"public"),c("span",{style:{color:"#24292E"}}," String "),c("span",{style:{color:"#6F42C1"}},"countItem"),c("span",{style:{color:"#24292E"}},"(@"),c("span",{style:{color:"#D73A49"}},"RequestParam"),c("span",{style:{color:"#24292E"}},"("),c("span",{style:{color:"#032F62"}},'"skuId"'),c("span",{style:{color:"#24292E"}},") Long skuId,")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"                        @"),c("span",{style:{color:"#D73A49"}},"RequestParam"),c("span",{style:{color:"#24292E"}},"("),c("span",{style:{color:"#032F62"}},'"num"'),c("span",{style:{color:"#24292E"}},") Integer num){")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    cartService."),c("span",{style:{color:"#6F42C1"}},"changeItemCount"),c("span",{style:{color:"#24292E"}},"(skuId, num);")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#D73A49"}},"return"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#032F62"}},'"redirect:http://cart.gulimall.com/cart.html"'),c("span",{style:{color:"#24292E"}},";")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"}")])])])],-1),ms=c("ul",null,[c("li",null,[p("改变购物项数量方法实现 "),c("ul",null,[c("li",null,"改变数量后通过hash操作将对象转为Json并存入hash")])])],-1),ks=c("div",{class:"language-java"},[c("button",{title:"Copy Code",class:"copy"}),c("span",{class:"lang"},"java"),c("pre",{class:"shiki github-dark vp-code-dark"},[c("code",null,[c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"/**")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}}," * 修改购物项数量")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}}," *")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}}," * "),c("span",{style:{color:"#F97583"}},"@param"),c("span",{style:{color:"#6A737D"}}," "),c("span",{style:{color:"#FFAB70"}},"skuId")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}}," * "),c("span",{style:{color:"#F97583"}},"@param"),c("span",{style:{color:"#6A737D"}}," "),c("span",{style:{color:"#FFAB70"}},"num")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}}," */")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"@"),c("span",{style:{color:"#F97583"}},"Override")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#F97583"}},"public"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#F97583"}},"void"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#B392F0"}},"changeItemCount"),c("span",{style:{color:"#E1E4E8"}},"(Long skuId, Integer num) {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    CartItem cartItem "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#B392F0"}},"getCartItem"),c("span",{style:{color:"#E1E4E8"}},"(skuId);")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    cartItem."),c("span",{style:{color:"#B392F0"}},"setCount"),c("span",{style:{color:"#E1E4E8"}},"(num);")]),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    BoundHashOperations<"),c("span",{style:{color:"#F97583"}},"String"),c("span",{style:{color:"#E1E4E8"}},", "),c("span",{style:{color:"#F97583"}},"Object"),c("span",{style:{color:"#E1E4E8"}},", "),c("span",{style:{color:"#F97583"}},"Object"),c("span",{style:{color:"#E1E4E8"}},"> cartOps "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#B392F0"}},"getCartOps"),c("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    cartOps."),c("span",{style:{color:"#B392F0"}},"put"),c("span",{style:{color:"#E1E4E8"}},"(skuId."),c("span",{style:{color:"#B392F0"}},"toString"),c("span",{style:{color:"#E1E4E8"}},"(), JSON."),c("span",{style:{color:"#B392F0"}},"toJSONString"),c("span",{style:{color:"#E1E4E8"}},"(cartItem));")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"}")])])]),c("pre",{class:"shiki github-light vp-code-light"},[c("code",null,[c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"/**")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}}," * 修改购物项数量")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}}," *")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}}," * "),c("span",{style:{color:"#D73A49"}},"@param"),c("span",{style:{color:"#6A737D"}}," "),c("span",{style:{color:"#E36209"}},"skuId")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}}," * "),c("span",{style:{color:"#D73A49"}},"@param"),c("span",{style:{color:"#6A737D"}}," "),c("span",{style:{color:"#E36209"}},"num")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}}," */")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"@"),c("span",{style:{color:"#D73A49"}},"Override")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#D73A49"}},"public"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#D73A49"}},"void"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#6F42C1"}},"changeItemCount"),c("span",{style:{color:"#24292E"}},"(Long skuId, Integer num) {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    CartItem cartItem "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#6F42C1"}},"getCartItem"),c("span",{style:{color:"#24292E"}},"(skuId);")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    cartItem."),c("span",{style:{color:"#6F42C1"}},"setCount"),c("span",{style:{color:"#24292E"}},"(num);")]),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    BoundHashOperations<"),c("span",{style:{color:"#D73A49"}},"String"),c("span",{style:{color:"#24292E"}},", "),c("span",{style:{color:"#D73A49"}},"Object"),c("span",{style:{color:"#24292E"}},", "),c("span",{style:{color:"#D73A49"}},"Object"),c("span",{style:{color:"#24292E"}},"> cartOps "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#6F42C1"}},"getCartOps"),c("span",{style:{color:"#24292E"}},"();")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    cartOps."),c("span",{style:{color:"#6F42C1"}},"put"),c("span",{style:{color:"#24292E"}},"(skuId."),c("span",{style:{color:"#6F42C1"}},"toString"),c("span",{style:{color:"#24292E"}},"(), JSON."),c("span",{style:{color:"#6F42C1"}},"toJSONString"),c("span",{style:{color:"#24292E"}},"(cartItem));")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"}")])])])],-1),bs={id:"_7、选中购物项",tabindex:"-1"},Bs=c("ul",null,[c("li",null,"选中购物项接口")],-1),Ss=c("div",{class:"language-java"},[c("button",{title:"Copy Code",class:"copy"}),c("span",{class:"lang"},"java"),c("pre",{class:"shiki github-dark vp-code-dark"},[c("code",null,[c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"@"),c("span",{style:{color:"#F97583"}},"GetMapping"),c("span",{style:{color:"#E1E4E8"}},"("),c("span",{style:{color:"#9ECBFF"}},'"/checkItem"'),c("span",{style:{color:"#E1E4E8"}},")")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#F97583"}},"public"),c("span",{style:{color:"#E1E4E8"}}," String "),c("span",{style:{color:"#B392F0"}},"checkItem"),c("span",{style:{color:"#E1E4E8"}},"(@"),c("span",{style:{color:"#F97583"}},"RequestParam"),c("span",{style:{color:"#E1E4E8"}},"("),c("span",{style:{color:"#9ECBFF"}},'"skuId"'),c("span",{style:{color:"#E1E4E8"}},") Long skuId,")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"                        @"),c("span",{style:{color:"#F97583"}},"RequestParam"),c("span",{style:{color:"#E1E4E8"}},"("),c("span",{style:{color:"#9ECBFF"}},'"check"'),c("span",{style:{color:"#E1E4E8"}},") Integer check){")]),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    cartService."),c("span",{style:{color:"#B392F0"}},"checkItem"),c("span",{style:{color:"#E1E4E8"}},"(skuId, check);")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#F97583"}},"return"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#9ECBFF"}},'"redirect:http://cart.gulimall.com/cart.html"'),c("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"}")])])]),c("pre",{class:"shiki github-light vp-code-light"},[c("code",null,[c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"@"),c("span",{style:{color:"#D73A49"}},"GetMapping"),c("span",{style:{color:"#24292E"}},"("),c("span",{style:{color:"#032F62"}},'"/checkItem"'),c("span",{style:{color:"#24292E"}},")")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#D73A49"}},"public"),c("span",{style:{color:"#24292E"}}," String "),c("span",{style:{color:"#6F42C1"}},"checkItem"),c("span",{style:{color:"#24292E"}},"(@"),c("span",{style:{color:"#D73A49"}},"RequestParam"),c("span",{style:{color:"#24292E"}},"("),c("span",{style:{color:"#032F62"}},'"skuId"'),c("span",{style:{color:"#24292E"}},") Long skuId,")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"                        @"),c("span",{style:{color:"#D73A49"}},"RequestParam"),c("span",{style:{color:"#24292E"}},"("),c("span",{style:{color:"#032F62"}},'"check"'),c("span",{style:{color:"#24292E"}},") Integer check){")]),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    cartService."),c("span",{style:{color:"#6F42C1"}},"checkItem"),c("span",{style:{color:"#24292E"}},"(skuId, check);")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#D73A49"}},"return"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#032F62"}},'"redirect:http://cart.gulimall.com/cart.html"'),c("span",{style:{color:"#24292E"}},";")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"}")])])])],-1),Is=c("ul",null,[c("li",null,[p("选中购物项方法实现 "),c("ul",null,[c("li",null,"改变购物项的选中状态后通过hash操作将对象转为Json并存入hash")])])],-1),fs=c("div",{class:"language-java"},[c("button",{title:"Copy Code",class:"copy"}),c("span",{class:"lang"},"java"),c("pre",{class:"shiki github-dark vp-code-dark"},[c("code",null,[c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"/**")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}}," * 勾选购物项")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}}," *")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}}," * "),c("span",{style:{color:"#F97583"}},"@param"),c("span",{style:{color:"#6A737D"}}," "),c("span",{style:{color:"#FFAB70"}},"skuId")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}}," * "),c("span",{style:{color:"#F97583"}},"@param"),c("span",{style:{color:"#6A737D"}}," "),c("span",{style:{color:"#FFAB70"}},"check")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}}," */")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"@"),c("span",{style:{color:"#F97583"}},"Override")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#F97583"}},"public"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#F97583"}},"void"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#B392F0"}},"checkItem"),c("span",{style:{color:"#E1E4E8"}},"(Long skuId, Integer check) {")]),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    BoundHashOperations<"),c("span",{style:{color:"#F97583"}},"String"),c("span",{style:{color:"#E1E4E8"}},", "),c("span",{style:{color:"#F97583"}},"Object"),c("span",{style:{color:"#E1E4E8"}},", "),c("span",{style:{color:"#F97583"}},"Object"),c("span",{style:{color:"#E1E4E8"}},"> cartOps "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#B392F0"}},"getCartOps"),c("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    CartItem cartItem "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#B392F0"}},"getCartItem"),c("span",{style:{color:"#E1E4E8"}},"(skuId);")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    cartItem."),c("span",{style:{color:"#B392F0"}},"setCheck"),c("span",{style:{color:"#E1E4E8"}},"(check "),c("span",{style:{color:"#F97583"}},"=="),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#79B8FF"}},"1"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#F97583"}},"?"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#79B8FF"}},"true"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#F97583"}},":"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#79B8FF"}},"false"),c("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#6A737D"}},"//将vo对象转为json序列化的文本")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    String s "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," JSON."),c("span",{style:{color:"#B392F0"}},"toJSONString"),c("span",{style:{color:"#E1E4E8"}},"(cartItem);")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    cartOps."),c("span",{style:{color:"#B392F0"}},"put"),c("span",{style:{color:"#E1E4E8"}},"(skuId."),c("span",{style:{color:"#B392F0"}},"toString"),c("span",{style:{color:"#E1E4E8"}},"(), s);")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"}")])])]),c("pre",{class:"shiki github-light vp-code-light"},[c("code",null,[c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"/**")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}}," * 勾选购物项")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}}," *")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}}," * "),c("span",{style:{color:"#D73A49"}},"@param"),c("span",{style:{color:"#6A737D"}}," "),c("span",{style:{color:"#E36209"}},"skuId")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}}," * "),c("span",{style:{color:"#D73A49"}},"@param"),c("span",{style:{color:"#6A737D"}}," "),c("span",{style:{color:"#E36209"}},"check")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}}," */")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"@"),c("span",{style:{color:"#D73A49"}},"Override")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#D73A49"}},"public"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#D73A49"}},"void"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#6F42C1"}},"checkItem"),c("span",{style:{color:"#24292E"}},"(Long skuId, Integer check) {")]),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    BoundHashOperations<"),c("span",{style:{color:"#D73A49"}},"String"),c("span",{style:{color:"#24292E"}},", "),c("span",{style:{color:"#D73A49"}},"Object"),c("span",{style:{color:"#24292E"}},", "),c("span",{style:{color:"#D73A49"}},"Object"),c("span",{style:{color:"#24292E"}},"> cartOps "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#6F42C1"}},"getCartOps"),c("span",{style:{color:"#24292E"}},"();")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    CartItem cartItem "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#6F42C1"}},"getCartItem"),c("span",{style:{color:"#24292E"}},"(skuId);")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    cartItem."),c("span",{style:{color:"#6F42C1"}},"setCheck"),c("span",{style:{color:"#24292E"}},"(check "),c("span",{style:{color:"#D73A49"}},"=="),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#005CC5"}},"1"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#D73A49"}},"?"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#005CC5"}},"true"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#D73A49"}},":"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#005CC5"}},"false"),c("span",{style:{color:"#24292E"}},");")]),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#6A737D"}},"//将vo对象转为json序列化的文本")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    String s "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," JSON."),c("span",{style:{color:"#6F42C1"}},"toJSONString"),c("span",{style:{color:"#24292E"}},"(cartItem);")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    cartOps."),c("span",{style:{color:"#6F42C1"}},"put"),c("span",{style:{color:"#24292E"}},"(skuId."),c("span",{style:{color:"#6F42C1"}},"toString"),c("span",{style:{color:"#24292E"}},"(), s);")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"}")])])])],-1),vs={id:"_8、获取当前登录用户的购物项列表",tabindex:"-1"},Ls=c("ul",null,[c("li",null,[p("获取当前登录用户的购物项列表接口（"),c("strong",null,"此接口是给订单服务远程调用的"),p("）")])],-1),_s=c("div",{class:"language-java"},[c("button",{title:"Copy Code",class:"copy"}),c("span",{class:"lang"},"java"),c("pre",{class:"shiki github-dark vp-code-dark"},[c("code",null,[c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"/**")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}}," * 不是页面跳转需加@ResponseBody")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}}," * "),c("span",{style:{color:"#F97583"}},"@return")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}}," */")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"@"),c("span",{style:{color:"#F97583"}},"GetMapping"),c("span",{style:{color:"#E1E4E8"}},"("),c("span",{style:{color:"#9ECBFF"}},'"/currentUserCartItems"'),c("span",{style:{color:"#E1E4E8"}},")")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"@"),c("span",{style:{color:"#F97583"}},"ResponseBody")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#F97583"}},"public"),c("span",{style:{color:"#E1E4E8"}}," List"),c("span",{style:{color:"#F97583"}},"<"),c("span",{style:{color:"#E1E4E8"}},"CartItem"),c("span",{style:{color:"#F97583"}},">"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#B392F0"}},"currentUserCartItems"),c("span",{style:{color:"#E1E4E8"}},"(){")]),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#F97583"}},"return"),c("span",{style:{color:"#E1E4E8"}}," cartService."),c("span",{style:{color:"#B392F0"}},"getUserCartItems"),c("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"}")])])]),c("pre",{class:"shiki github-light vp-code-light"},[c("code",null,[c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"/**")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}}," * 不是页面跳转需加@ResponseBody")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}}," * "),c("span",{style:{color:"#D73A49"}},"@return")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}}," */")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"@"),c("span",{style:{color:"#D73A49"}},"GetMapping"),c("span",{style:{color:"#24292E"}},"("),c("span",{style:{color:"#032F62"}},'"/currentUserCartItems"'),c("span",{style:{color:"#24292E"}},")")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"@"),c("span",{style:{color:"#D73A49"}},"ResponseBody")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#D73A49"}},"public"),c("span",{style:{color:"#24292E"}}," List"),c("span",{style:{color:"#D73A49"}},"<"),c("span",{style:{color:"#24292E"}},"CartItem"),c("span",{style:{color:"#D73A49"}},">"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#6F42C1"}},"currentUserCartItems"),c("span",{style:{color:"#24292E"}},"(){")]),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#D73A49"}},"return"),c("span",{style:{color:"#24292E"}}," cartService."),c("span",{style:{color:"#6F42C1"}},"getUserCartItems"),c("span",{style:{color:"#24292E"}},"();")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"}")])])])],-1),Rs=c("ul",null,[c("li",null,"获取当前登录用户的购物项列表方法实现")],-1),Ts=c("div",{class:"language-java"},[c("button",{title:"Copy Code",class:"copy"}),c("span",{class:"lang"},"java"),c("pre",{class:"shiki github-dark vp-code-dark"},[c("code",null,[c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"/**")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"     * 获取当前用户的所有购物项")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"     *")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"     * "),c("span",{style:{color:"#F97583"}},"@return")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"     */")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    @"),c("span",{style:{color:"#F97583"}},"Override")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#F97583"}},"public"),c("span",{style:{color:"#E1E4E8"}}," List"),c("span",{style:{color:"#F97583"}},"<"),c("span",{style:{color:"#E1E4E8"}},"CartItem"),c("span",{style:{color:"#F97583"}},">"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#B392F0"}},"getUserCartItems"),c("span",{style:{color:"#E1E4E8"}},"() {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        UserInfoTo userInfoTo "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," CartInterceptor.threadLocal."),c("span",{style:{color:"#B392F0"}},"get"),c("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        "),c("span",{style:{color:"#F97583"}},"if"),c("span",{style:{color:"#E1E4E8"}}," (userInfoTo."),c("span",{style:{color:"#B392F0"}},"getUserId"),c("span",{style:{color:"#E1E4E8"}},"() "),c("span",{style:{color:"#F97583"}},"=="),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#79B8FF"}},"null"),c("span",{style:{color:"#E1E4E8"}},"){")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"            "),c("span",{style:{color:"#6A737D"}},"//没登录")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"            "),c("span",{style:{color:"#F97583"}},"return"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#79B8FF"}},"null"),c("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        }"),c("span",{style:{color:"#F97583"}},"else"),c("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"            "),c("span",{style:{color:"#6A737D"}},"//登录了")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"            String cartKey "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," CART_PREFIX "),c("span",{style:{color:"#F97583"}},"+"),c("span",{style:{color:"#E1E4E8"}}," userInfoTo."),c("span",{style:{color:"#B392F0"}},"getUserId"),c("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"            List<"),c("span",{style:{color:"#F97583"}},"CartItem"),c("span",{style:{color:"#E1E4E8"}},"> cartItems "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#B392F0"}},"getCartItems"),c("span",{style:{color:"#E1E4E8"}},"(cartKey);")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"            "),c("span",{style:{color:"#6A737D"}},"//只要选中了的购物项")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"            List<"),c("span",{style:{color:"#F97583"}},"CartItem"),c("span",{style:{color:"#E1E4E8"}},"> collect "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," cartItems."),c("span",{style:{color:"#B392F0"}},"stream"),c("span",{style:{color:"#E1E4E8"}},"()."),c("span",{style:{color:"#B392F0"}},"filter"),c("span",{style:{color:"#E1E4E8"}},"(item "),c("span",{style:{color:"#F97583"}},"->")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"                item."),c("span",{style:{color:"#B392F0"}},"getCheck"),c("span",{style:{color:"#E1E4E8"}},"()"),c("span",{style:{color:"#6A737D"}},"//默认是true")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"            )."),c("span",{style:{color:"#B392F0"}},"map"),c("span",{style:{color:"#E1E4E8"}},"(item"),c("span",{style:{color:"#F97583"}},"->"),c("span",{style:{color:"#E1E4E8"}},"{")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"//                R price = productFeignService.getPrice(item.getSkuId());")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"                BigDecimal price "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," productFeignService."),c("span",{style:{color:"#B392F0"}},"getPrice"),c("span",{style:{color:"#E1E4E8"}},"(item."),c("span",{style:{color:"#B392F0"}},"getSkuId"),c("span",{style:{color:"#E1E4E8"}},"());")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"                "),c("span",{style:{color:"#6A737D"}},"//todo 更新为最新的价格")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},'//                String data = (String) price.get("data");')]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"//                item.setPrice(new BigDecimal(data));")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"                item."),c("span",{style:{color:"#B392F0"}},"setPrice"),c("span",{style:{color:"#E1E4E8"}},"(price);")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"                "),c("span",{style:{color:"#F97583"}},"return"),c("span",{style:{color:"#E1E4E8"}}," item;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"            })."),c("span",{style:{color:"#B392F0"}},"collect"),c("span",{style:{color:"#E1E4E8"}},"(Collectors."),c("span",{style:{color:"#B392F0"}},"toList"),c("span",{style:{color:"#E1E4E8"}},"());")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"            "),c("span",{style:{color:"#F97583"}},"return"),c("span",{style:{color:"#E1E4E8"}}," collect;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        }")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    }")])])]),c("pre",{class:"shiki github-light vp-code-light"},[c("code",null,[c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"/**")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"     * 获取当前用户的所有购物项")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"     *")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"     * "),c("span",{style:{color:"#D73A49"}},"@return")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"     */")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    @"),c("span",{style:{color:"#D73A49"}},"Override")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#D73A49"}},"public"),c("span",{style:{color:"#24292E"}}," List"),c("span",{style:{color:"#D73A49"}},"<"),c("span",{style:{color:"#24292E"}},"CartItem"),c("span",{style:{color:"#D73A49"}},">"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#6F42C1"}},"getUserCartItems"),c("span",{style:{color:"#24292E"}},"() {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        UserInfoTo userInfoTo "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," CartInterceptor.threadLocal."),c("span",{style:{color:"#6F42C1"}},"get"),c("span",{style:{color:"#24292E"}},"();")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        "),c("span",{style:{color:"#D73A49"}},"if"),c("span",{style:{color:"#24292E"}}," (userInfoTo."),c("span",{style:{color:"#6F42C1"}},"getUserId"),c("span",{style:{color:"#24292E"}},"() "),c("span",{style:{color:"#D73A49"}},"=="),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#005CC5"}},"null"),c("span",{style:{color:"#24292E"}},"){")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"            "),c("span",{style:{color:"#6A737D"}},"//没登录")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"            "),c("span",{style:{color:"#D73A49"}},"return"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#005CC5"}},"null"),c("span",{style:{color:"#24292E"}},";")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        }"),c("span",{style:{color:"#D73A49"}},"else"),c("span",{style:{color:"#24292E"}}," {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"            "),c("span",{style:{color:"#6A737D"}},"//登录了")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"            String cartKey "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," CART_PREFIX "),c("span",{style:{color:"#D73A49"}},"+"),c("span",{style:{color:"#24292E"}}," userInfoTo."),c("span",{style:{color:"#6F42C1"}},"getUserId"),c("span",{style:{color:"#24292E"}},"();")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"            List<"),c("span",{style:{color:"#D73A49"}},"CartItem"),c("span",{style:{color:"#24292E"}},"> cartItems "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#6F42C1"}},"getCartItems"),c("span",{style:{color:"#24292E"}},"(cartKey);")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"            "),c("span",{style:{color:"#6A737D"}},"//只要选中了的购物项")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"            List<"),c("span",{style:{color:"#D73A49"}},"CartItem"),c("span",{style:{color:"#24292E"}},"> collect "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," cartItems."),c("span",{style:{color:"#6F42C1"}},"stream"),c("span",{style:{color:"#24292E"}},"()."),c("span",{style:{color:"#6F42C1"}},"filter"),c("span",{style:{color:"#24292E"}},"(item "),c("span",{style:{color:"#D73A49"}},"->")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"                item."),c("span",{style:{color:"#6F42C1"}},"getCheck"),c("span",{style:{color:"#24292E"}},"()"),c("span",{style:{color:"#6A737D"}},"//默认是true")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"            )."),c("span",{style:{color:"#6F42C1"}},"map"),c("span",{style:{color:"#24292E"}},"(item"),c("span",{style:{color:"#D73A49"}},"->"),c("span",{style:{color:"#24292E"}},"{")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"//                R price = productFeignService.getPrice(item.getSkuId());")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"                BigDecimal price "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," productFeignService."),c("span",{style:{color:"#6F42C1"}},"getPrice"),c("span",{style:{color:"#24292E"}},"(item."),c("span",{style:{color:"#6F42C1"}},"getSkuId"),c("span",{style:{color:"#24292E"}},"());")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"                "),c("span",{style:{color:"#6A737D"}},"//todo 更新为最新的价格")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},'//                String data = (String) price.get("data");')]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"//                item.setPrice(new BigDecimal(data));")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"                item."),c("span",{style:{color:"#6F42C1"}},"setPrice"),c("span",{style:{color:"#24292E"}},"(price);")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"                "),c("span",{style:{color:"#D73A49"}},"return"),c("span",{style:{color:"#24292E"}}," item;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"            })."),c("span",{style:{color:"#6F42C1"}},"collect"),c("span",{style:{color:"#24292E"}},"(Collectors."),c("span",{style:{color:"#6F42C1"}},"toList"),c("span",{style:{color:"#24292E"}},"());")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"            "),c("span",{style:{color:"#D73A49"}},"return"),c("span",{style:{color:"#24292E"}}," collect;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        }")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    }")])])])],-1),js={id:"ii-解决分布式下session共享问题",tabindex:"-1"},Os={id:"_1、session原理",tabindex:"-1"},xs=c("figure",null,[c("img",{src:"https://jsd.cdn.zzko.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230410195022298.png",alt:"image-20230410195022298",loading:"lazy",decoding:"async"})],-1),Vs={id:"_2、分布式下session共享问题",tabindex:"-1"},zs=c("figure",null,[c("img",{src:"https://jsd.cdn.zzko.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230410195051946.png",alt:"image-20230410195051946",loading:"lazy",decoding:"async"})],-1),ws={id:"_3、解决-session复制",tabindex:"-1"},Ms=c("figure",null,[c("img",{src:"https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230410195126743.png",alt:"image-20230410195126743",loading:"lazy",decoding:"async"})],-1),Us=c("ul",null,[c("li",null,[p("优点 "),c("ul",null,[c("li",null,"web-server（Tomcat）原生支持，只需要修改配置文件")])]),c("li",null,[p("缺点 "),c("ul",null,[c("li",null,"session同步需要数据传输，占用大量网络带宽，降低了服务器群的业务处理能力"),c("li",null,"任意一台web-server保存的数据都是所有web-server的session总和，受到内存限制无法水平扩展更多的web-server"),c("li",null,"大型分布式集群情况下，由于所有web-server都全量保存数据，所以此方案不可取。")])])],-1),Js={id:"_4、解决-客户端存储",tabindex:"-1"},Ps=c("figure",null,[c("img",{src:"https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230410195314820.png",alt:"image-20230410195314820",loading:"lazy",decoding:"async"})],-1),Ks=c("ul",null,[c("li",null,[c("p",null,"优点"),c("ul",null,[c("li",null,"服务器不需存储session，用户保存自己的session信息到cookie中。节省服务端资源")])]),c("li",null,[c("p",null,"缺点"),c("ul",null,[c("li",null,"都是缺点，这只是一种思路。"),c("li",null,[p("具体如下： "),c("ul",null,[c("li",null,"每次http请求，携带用户在cookie中的完整信息，浪费网络带宽"),c("li",null,"session数据放在cookie中，cookie有长度限制4K，不能保存大量信息"),c("li",null,"session数据放在cookie中，存在泄漏、篡改、窃取等安全隐患")])])])]),c("li",null,[c("p",null,"这种方式不会使用。")])],-1),qs={id:"_5、解决-hash一致性",tabindex:"-1"},Ns=c("figure",null,[c("img",{src:"https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230410195638892.png",alt:"image-20230410195638892",loading:"lazy",decoding:"async"})],-1),Ws=c("ul",null,[c("li",null,[p("优点： "),c("ul",null,[c("li",null,"只需要改nginx配置，不需要修改应用代码"),c("li",null,"负载均衡，只要hash属性的值分布是均匀的，多台web-server的负载是均衡的"),c("li",null,"可以支持web-server水平扩展（session同步法是不行的，受内存限制）")])]),c("li",null,[p("缺点 "),c("ul",null,[c("li",null,"session还是存在web-server中的，所以web-server重启可能导致部分session丢失，影响业务，如部分用户需要重新登录"),c("li",null,"如果web-server水平扩展，rehash后session重新分布，也会有一部分用户路由不到正确的session")])]),c("li",null,"但是以上缺点问题也不是很大，因为session本来都是有有效期的。所以这两种反向代理的方式可以使用")],-1),Hs={id:"_6、解决-统一存储",tabindex:"-1"},Gs=c("figure",null,[c("img",{src:"https://jsd.cdn.zzko.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230410195856602.png",alt:"image-20230410195856602",loading:"lazy",decoding:"async"})],-1),Xs=c("ul",null,[c("li",null,[p("优点： "),c("ul",null,[c("li",null,"没有安全隐患"),c("li",null,"可以水平扩展，数据库/缓存水平切分即可"),c("li",null,"web-server重启或者扩容都不会有session丢失")])]),c("li",null,[p("不足 "),c("ul",null,[c("li",null,"增加了一次网络调用，并且需要修改应用代码；如将所有的getSession方法替换为从Redis查数据的方式。redis获取数据比内存慢很多"),c("li",null,"上面缺点可以用SpringSession完美解决")])])],-1),Qs={id:"_7、解决-不同服务-子域session共享",tabindex:"-1"},$s=c("blockquote",null,[c("p",null,"jsessionid这个cookie默认是当前系统域名的。当我们分拆服务，不同域名部署的时候，我们可以使用 如下解决方案；")],-1),Ys=c("figure",null,[c("img",{src:"https://jsd.cdn.zzko.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230410200123345.png",alt:"image-20230410200123345",loading:"lazy",decoding:"async"})],-1),Zs={id:"_8、springsession核心原理",tabindex:"-1"},sl=c("figure",null,[c("img",{src:"https://jsd.cdn.zzko.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230410200156413.png",alt:"image-20230410200156413",loading:"lazy",decoding:"async"})],-1),ll={id:"_9、应用",tabindex:"-1"},ol=c("div",{class:"language-java"},[c("button",{title:"Copy Code",class:"copy"}),c("span",{class:"lang"},"java"),c("pre",{class:"shiki github-dark vp-code-dark"},[c("code",null,[c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"/**")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}}," * 核心原理")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}}," * 1、@EnableRedisHttpSession导入RedisHttpSessionConfiguration配置")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}}," *      1）、给容器中添加了一个组件")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}}," *          传入SessionRepository==》【RedisOperationsSessionRepository】===》redis操作session，session的增删改查封装类")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}}," *      2）、SessionRepositoryFilter==》Filter(web)：session存储过滤器；每个请求过来都必须经过Filter")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}}," *         I）、创建的时候，就自动从容器中获取了SessionRepository")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}}," *         II）、原始的HttpServletRequest request, HttpServletResponse response都被分别包装成了SessionRepositoryRequestWrapper，SessionRepositoryResponseWrapper")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}}," *         III）、以后获取session-》request.getSession();（原始的）")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}}," *         //SessionRepositoryRequestWrapper重写getSession方法")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}}," *         IV）、wrapperRequest.getSession();==> SessionRepository中获取的到")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}}," *  装饰者模式；")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}}," *")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}}," *  自动延期；redis中的数据也是有过期时间的")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}}," */")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"@"),c("span",{style:{color:"#F97583"}},"EnableRedisHttpSession"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#6A737D"}},"//整合redis作为session存储")])])]),c("pre",{class:"shiki github-light vp-code-light"},[c("code",null,[c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"/**")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}}," * 核心原理")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}}," * 1、@EnableRedisHttpSession导入RedisHttpSessionConfiguration配置")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}}," *      1）、给容器中添加了一个组件")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}}," *          传入SessionRepository==》【RedisOperationsSessionRepository】===》redis操作session，session的增删改查封装类")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}}," *      2）、SessionRepositoryFilter==》Filter(web)：session存储过滤器；每个请求过来都必须经过Filter")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}}," *         I）、创建的时候，就自动从容器中获取了SessionRepository")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}}," *         II）、原始的HttpServletRequest request, HttpServletResponse response都被分别包装成了SessionRepositoryRequestWrapper，SessionRepositoryResponseWrapper")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}}," *         III）、以后获取session-》request.getSession();（原始的）")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}}," *         //SessionRepositoryRequestWrapper重写getSession方法")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}}," *         IV）、wrapperRequest.getSession();==> SessionRepository中获取的到")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}}," *  装饰者模式；")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}}," *")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}}," *  自动延期；redis中的数据也是有过期时间的")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}}," */")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"@"),c("span",{style:{color:"#D73A49"}},"EnableRedisHttpSession"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#6A737D"}},"//整合redis作为session存储")])])])],-1),nl=c("ul",null,[c("li",null,"导入相关依赖")],-1),al=c("div",{class:"language-xml"},[c("button",{title:"Copy Code",class:"copy"}),c("span",{class:"lang"},"xml"),c("pre",{class:"shiki github-dark vp-code-dark"},[c("code",null,[c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"<"),c("span",{style:{color:"#85E89D"}},"dependency"),c("span",{style:{color:"#E1E4E8"}},">")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"  <"),c("span",{style:{color:"#85E89D"}},"groupId"),c("span",{style:{color:"#E1E4E8"}},">org.springframework.boot</"),c("span",{style:{color:"#85E89D"}},"groupId"),c("span",{style:{color:"#E1E4E8"}},">")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"  <"),c("span",{style:{color:"#85E89D"}},"artifactId"),c("span",{style:{color:"#E1E4E8"}},">spring-boot-starter-data-redis</"),c("span",{style:{color:"#85E89D"}},"artifactId"),c("span",{style:{color:"#E1E4E8"}},">")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"</"),c("span",{style:{color:"#85E89D"}},"dependency"),c("span",{style:{color:"#E1E4E8"}},">")]),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"\x3c!--整合Springsession完成session共享问题--\x3e")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"<"),c("span",{style:{color:"#85E89D"}},"dependency"),c("span",{style:{color:"#E1E4E8"}},">")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"  <"),c("span",{style:{color:"#85E89D"}},"groupId"),c("span",{style:{color:"#E1E4E8"}},">org.springframework.session</"),c("span",{style:{color:"#85E89D"}},"groupId"),c("span",{style:{color:"#E1E4E8"}},">")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"  <"),c("span",{style:{color:"#85E89D"}},"artifactId"),c("span",{style:{color:"#E1E4E8"}},">spring-session-data-redis</"),c("span",{style:{color:"#85E89D"}},"artifactId"),c("span",{style:{color:"#E1E4E8"}},">")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"</"),c("span",{style:{color:"#85E89D"}},"dependency"),c("span",{style:{color:"#E1E4E8"}},">")])])]),c("pre",{class:"shiki github-light vp-code-light"},[c("code",null,[c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"<"),c("span",{style:{color:"#22863A"}},"dependency"),c("span",{style:{color:"#24292E"}},">")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"  <"),c("span",{style:{color:"#22863A"}},"groupId"),c("span",{style:{color:"#24292E"}},">org.springframework.boot</"),c("span",{style:{color:"#22863A"}},"groupId"),c("span",{style:{color:"#24292E"}},">")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"  <"),c("span",{style:{color:"#22863A"}},"artifactId"),c("span",{style:{color:"#24292E"}},">spring-boot-starter-data-redis</"),c("span",{style:{color:"#22863A"}},"artifactId"),c("span",{style:{color:"#24292E"}},">")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"</"),c("span",{style:{color:"#22863A"}},"dependency"),c("span",{style:{color:"#24292E"}},">")]),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"\x3c!--整合Springsession完成session共享问题--\x3e")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"<"),c("span",{style:{color:"#22863A"}},"dependency"),c("span",{style:{color:"#24292E"}},">")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"  <"),c("span",{style:{color:"#22863A"}},"groupId"),c("span",{style:{color:"#24292E"}},">org.springframework.session</"),c("span",{style:{color:"#22863A"}},"groupId"),c("span",{style:{color:"#24292E"}},">")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"  <"),c("span",{style:{color:"#22863A"}},"artifactId"),c("span",{style:{color:"#24292E"}},">spring-session-data-redis</"),c("span",{style:{color:"#22863A"}},"artifactId"),c("span",{style:{color:"#24292E"}},">")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"</"),c("span",{style:{color:"#22863A"}},"dependency"),c("span",{style:{color:"#24292E"}},">")])])])],-1),el=c("ul",null,[c("li",null,"SpringBootApplication类加上注解@EnableRedisHttpSession开启SpringSession"),c("li",null,"配置文件添加相关配置")],-1),tl=c("div",{class:"language-properties"},[c("button",{title:"Copy Code",class:"copy"}),c("span",{class:"lang"},"properties"),c("pre",{class:"shiki github-dark vp-code-dark"},[c("code",null,[c("span",{class:"line"},[c("span",{style:{color:"#F97583"}},"spring.redis.host"),c("span",{style:{color:"#E1E4E8"}},"=192.168.10.103")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#F97583"}},"spring.redis.port"),c("span",{style:{color:"#E1E4E8"}},"=6379")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#F97583"}},"spring.session.store-type"),c("span",{style:{color:"#E1E4E8"}},"=REDIS")])])]),c("pre",{class:"shiki github-light vp-code-light"},[c("code",null,[c("span",{class:"line"},[c("span",{style:{color:"#D73A49"}},"spring.redis.host"),c("span",{style:{color:"#24292E"}},"=192.168.10.103")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#D73A49"}},"spring.redis.port"),c("span",{style:{color:"#24292E"}},"=6379")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#D73A49"}},"spring.session.store-type"),c("span",{style:{color:"#24292E"}},"=REDIS")])])])],-1),cl=c("ul",null,[c("li",null,"添加配置类配置子域session共享")],-1),pl=c("div",{class:"language-java"},[c("button",{title:"Copy Code",class:"copy"}),c("span",{class:"lang"},"java"),c("pre",{class:"shiki github-dark vp-code-dark"},[c("code",null,[c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"/**")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}}," * "),c("span",{style:{color:"#F97583"}},"@author"),c("span",{style:{color:"#6A737D"}}," Klaus")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}}," * @date 2022/9/17")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}}," */")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"@"),c("span",{style:{color:"#F97583"}},"Configuration")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#F97583"}},"public"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#F97583"}},"class"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#B392F0"}},"GulimallSessionConfig"),c("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    @"),c("span",{style:{color:"#F97583"}},"Bean")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#F97583"}},"public"),c("span",{style:{color:"#E1E4E8"}}," CookieSerializer "),c("span",{style:{color:"#B392F0"}},"cookieSerializer"),c("span",{style:{color:"#E1E4E8"}},"(){")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        DefaultCookieSerializer cookieSerializer "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#F97583"}},"new"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#B392F0"}},"DefaultCookieSerializer"),c("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        cookieSerializer."),c("span",{style:{color:"#B392F0"}},"setDomainName"),c("span",{style:{color:"#E1E4E8"}},"("),c("span",{style:{color:"#9ECBFF"}},'"gulimall.com"'),c("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        cookieSerializer."),c("span",{style:{color:"#B392F0"}},"setCookieName"),c("span",{style:{color:"#E1E4E8"}},"("),c("span",{style:{color:"#9ECBFF"}},'"KLAUSSESSION"'),c("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        "),c("span",{style:{color:"#F97583"}},"return"),c("span",{style:{color:"#E1E4E8"}}," cookieSerializer;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    @"),c("span",{style:{color:"#F97583"}},"Bean")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#F97583"}},"public"),c("span",{style:{color:"#E1E4E8"}}," RedisSerializer<"),c("span",{style:{color:"#F97583"}},"Object"),c("span",{style:{color:"#E1E4E8"}},"> "),c("span",{style:{color:"#B392F0"}},"springSessionDefaultRedisSerializer"),c("span",{style:{color:"#E1E4E8"}},"() {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        "),c("span",{style:{color:"#F97583"}},"return"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#F97583"}},"new"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#B392F0"}},"GenericJackson2JsonRedisSerializer"),c("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"}")])])]),c("pre",{class:"shiki github-light vp-code-light"},[c("code",null,[c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"/**")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}}," * "),c("span",{style:{color:"#D73A49"}},"@author"),c("span",{style:{color:"#6A737D"}}," Klaus")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}}," * @date 2022/9/17")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}}," */")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"@"),c("span",{style:{color:"#D73A49"}},"Configuration")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#D73A49"}},"public"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#D73A49"}},"class"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#6F42C1"}},"GulimallSessionConfig"),c("span",{style:{color:"#24292E"}}," {")]),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    @"),c("span",{style:{color:"#D73A49"}},"Bean")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#D73A49"}},"public"),c("span",{style:{color:"#24292E"}}," CookieSerializer "),c("span",{style:{color:"#6F42C1"}},"cookieSerializer"),c("span",{style:{color:"#24292E"}},"(){")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        DefaultCookieSerializer cookieSerializer "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#D73A49"}},"new"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#6F42C1"}},"DefaultCookieSerializer"),c("span",{style:{color:"#24292E"}},"();")]),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        cookieSerializer."),c("span",{style:{color:"#6F42C1"}},"setDomainName"),c("span",{style:{color:"#24292E"}},"("),c("span",{style:{color:"#032F62"}},'"gulimall.com"'),c("span",{style:{color:"#24292E"}},");")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        cookieSerializer."),c("span",{style:{color:"#6F42C1"}},"setCookieName"),c("span",{style:{color:"#24292E"}},"("),c("span",{style:{color:"#032F62"}},'"KLAUSSESSION"'),c("span",{style:{color:"#24292E"}},");")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        "),c("span",{style:{color:"#D73A49"}},"return"),c("span",{style:{color:"#24292E"}}," cookieSerializer;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    }")]),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    @"),c("span",{style:{color:"#D73A49"}},"Bean")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#D73A49"}},"public"),c("span",{style:{color:"#24292E"}}," RedisSerializer<"),c("span",{style:{color:"#D73A49"}},"Object"),c("span",{style:{color:"#24292E"}},"> "),c("span",{style:{color:"#6F42C1"}},"springSessionDefaultRedisSerializer"),c("span",{style:{color:"#24292E"}},"() {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        "),c("span",{style:{color:"#D73A49"}},"return"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#D73A49"}},"new"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#6F42C1"}},"GenericJackson2JsonRedisSerializer"),c("span",{style:{color:"#24292E"}},"();")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    }")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"}")])])])],-1),rl=c("blockquote",null,[c("p",null,"使用session共享的目的是让需要用到登录session的页面都能共享到同一个session")],-1),El={id:"iii-商品系统缓存所有分类",tabindex:"-1"},yl={id:"一、缓存",tabindex:"-1"},il={id:"本地缓存",tabindex:"-1"},ul=c("figure",null,[c("img",{src:"https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230410191857648.png",alt:"image-20230410191857648",loading:"lazy",decoding:"async"})],-1),dl=c("div",{class:"language-java"},[c("button",{title:"Copy Code",class:"copy"}),c("span",{class:"lang"},"java"),c("pre",{class:"shiki github-dark vp-code-dark"},[c("code",null,[c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"//本地缓存可以使用map")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#F97583"}},"private"),c("span",{style:{color:"#E1E4E8"}}," Map<"),c("span",{style:{color:"#F97583"}},"String"),c("span",{style:{color:"#E1E4E8"}},", "),c("span",{style:{color:"#F97583"}},"Object"),c("span",{style:{color:"#E1E4E8"}},"> cache;")])])]),c("pre",{class:"shiki github-light vp-code-light"},[c("code",null,[c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"//本地缓存可以使用map")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#D73A49"}},"private"),c("span",{style:{color:"#24292E"}}," Map<"),c("span",{style:{color:"#D73A49"}},"String"),c("span",{style:{color:"#24292E"}},", "),c("span",{style:{color:"#D73A49"}},"Object"),c("span",{style:{color:"#24292E"}},"> cache;")])])])],-1),gl={id:"_1、缓存使用",tabindex:"-1"},Fl=c("ul",null,[c("li",null,[c("p",null,"为了系统性能的提升，我们一般都会将部分数据放入缓存中，加速访问。而 db 承担数据落盘工作。"),c("p",null,[c("strong",null,"哪些数据适合放入缓存？")]),c("ul",null,[c("li",null,"即时性、数据一致性要求不高的"),c("li",null,"访问量大且更新频率不高的数据（读多，写少）")])]),c("li",null,[c("p",null,"举例：电商类应用，商品分类，商品列表等适合缓存并加一个失效时间(根据数据更新频率来定)，后台如果发布一个商品，买家需要 5 分钟才能看到新的商品一般还是可以接受的。")])],-1),Dl=c("figure",null,[c("img",{src:"https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230425213252713.png",alt:"image-20230425213252713",loading:"lazy",decoding:"async"})],-1),Al=c("div",{class:"language-javascript"},[c("button",{title:"Copy Code",class:"copy"}),c("span",{class:"lang"},"javascript"),c("pre",{class:"shiki github-dark vp-code-dark"},[c("code",null,[c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"data "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," cache."),c("span",{style:{color:"#B392F0"}},"load"),c("span",{style:{color:"#E1E4E8"}},"(id);"),c("span",{style:{color:"#6A737D"}},"//从缓存加载数据")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#B392F0"}},"If"),c("span",{style:{color:"#E1E4E8"}},"(data "),c("span",{style:{color:"#F97583"}},"=="),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#79B8FF"}},"null"),c("span",{style:{color:"#E1E4E8"}},"){")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"data "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," db."),c("span",{style:{color:"#B392F0"}},"load"),c("span",{style:{color:"#E1E4E8"}},"(id);"),c("span",{style:{color:"#6A737D"}},"//从数据库加载数据")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"cache."),c("span",{style:{color:"#B392F0"}},"put"),c("span",{style:{color:"#E1E4E8"}},"(id,data);"),c("span",{style:{color:"#6A737D"}},"//保存到 cache 中")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"}")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#F97583"}},"return"),c("span",{style:{color:"#E1E4E8"}}," data;")])])]),c("pre",{class:"shiki github-light vp-code-light"},[c("code",null,[c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"data "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," cache."),c("span",{style:{color:"#6F42C1"}},"load"),c("span",{style:{color:"#24292E"}},"(id);"),c("span",{style:{color:"#6A737D"}},"//从缓存加载数据")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6F42C1"}},"If"),c("span",{style:{color:"#24292E"}},"(data "),c("span",{style:{color:"#D73A49"}},"=="),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#005CC5"}},"null"),c("span",{style:{color:"#24292E"}},"){")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"data "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," db."),c("span",{style:{color:"#6F42C1"}},"load"),c("span",{style:{color:"#24292E"}},"(id);"),c("span",{style:{color:"#6A737D"}},"//从数据库加载数据")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"cache."),c("span",{style:{color:"#6F42C1"}},"put"),c("span",{style:{color:"#24292E"}},"(id,data);"),c("span",{style:{color:"#6A737D"}},"//保存到 cache 中")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"}")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#D73A49"}},"return"),c("span",{style:{color:"#24292E"}}," data;")])])])],-1),Cl=c("blockquote",null,[c("p",null,"注意：在开发中，凡是放入缓存中的数据我们都应该指定过期时间，使其可以在系统即使没有主动更新数据也能自动触发数据加载进缓存的流程。避免业务崩溃导致的数据永久不一致问题。")],-1),hl={id:"_2、整合-redis-作为缓存",tabindex:"-1"},ml=c("ul",null,[c("li",null,"1、引入 redis-starter")],-1),kl=c("div",{class:"language-xml"},[c("button",{title:"Copy Code",class:"copy"}),c("span",{class:"lang"},"xml"),c("pre",{class:"shiki github-dark vp-code-dark"},[c("code",null,[c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"<"),c("span",{style:{color:"#85E89D"}},"dependency"),c("span",{style:{color:"#E1E4E8"}},">")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"<"),c("span",{style:{color:"#85E89D"}},"groupId"),c("span",{style:{color:"#E1E4E8"}},">org.springframework.boot</"),c("span",{style:{color:"#85E89D"}},"groupId"),c("span",{style:{color:"#E1E4E8"}},">")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"<"),c("span",{style:{color:"#85E89D"}},"artifactId"),c("span",{style:{color:"#E1E4E8"}},">spring-boot-starter-data-redis</"),c("span",{style:{color:"#85E89D"}},"artifactId"),c("span",{style:{color:"#E1E4E8"}},">")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"</"),c("span",{style:{color:"#85E89D"}},"dependency"),c("span",{style:{color:"#E1E4E8"}},">")])])]),c("pre",{class:"shiki github-light vp-code-light"},[c("code",null,[c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"<"),c("span",{style:{color:"#22863A"}},"dependency"),c("span",{style:{color:"#24292E"}},">")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"<"),c("span",{style:{color:"#22863A"}},"groupId"),c("span",{style:{color:"#24292E"}},">org.springframework.boot</"),c("span",{style:{color:"#22863A"}},"groupId"),c("span",{style:{color:"#24292E"}},">")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"<"),c("span",{style:{color:"#22863A"}},"artifactId"),c("span",{style:{color:"#24292E"}},">spring-boot-starter-data-redis</"),c("span",{style:{color:"#22863A"}},"artifactId"),c("span",{style:{color:"#24292E"}},">")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"</"),c("span",{style:{color:"#22863A"}},"dependency"),c("span",{style:{color:"#24292E"}},">")])])])],-1),bl=c("ul",null,[c("li",null,"2、配置 redis")],-1),Bl=c("div",{class:"language-properties"},[c("button",{title:"Copy Code",class:"copy"}),c("span",{class:"lang"},"properties"),c("pre",{class:"shiki github-dark vp-code-dark"},[c("code",null,[c("span",{class:"line"},[c("span",{style:{color:"#F97583"}},"spring.redis.host"),c("span",{style:{color:"#E1E4E8"}},"=192.168.10.103")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#F97583"}},"spring.redis.port"),c("span",{style:{color:"#E1E4E8"}},"=6379")])])]),c("pre",{class:"shiki github-light vp-code-light"},[c("code",null,[c("span",{class:"line"},[c("span",{style:{color:"#D73A49"}},"spring.redis.host"),c("span",{style:{color:"#24292E"}},"=192.168.10.103")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#D73A49"}},"spring.redis.port"),c("span",{style:{color:"#24292E"}},"=6379")])])])],-1),Sl=c("ul",null,[c("li",null,"3、使用 RedisTemplate 操作 redis")],-1),Il=c("div",{class:"language-java"},[c("button",{title:"Copy Code",class:"copy"}),c("span",{class:"lang"},"java"),c("pre",{class:"shiki github-dark vp-code-dark"},[c("code",null,[c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"@"),c("span",{style:{color:"#F97583"}},"Autowired")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"StringRedisTemplate stringRedisTemplate;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"@"),c("span",{style:{color:"#F97583"}},"Test")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#F97583"}},"public"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#F97583"}},"void"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#B392F0"}},"testStringRedisTemplate"),c("span",{style:{color:"#E1E4E8"}},"(){")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"ValueOperations<"),c("span",{style:{color:"#F97583"}},"String"),c("span",{style:{color:"#E1E4E8"}},", "),c("span",{style:{color:"#F97583"}},"String"),c("span",{style:{color:"#E1E4E8"}},"> ops "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," stringRedisTemplate."),c("span",{style:{color:"#B392F0"}},"opsForValue"),c("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"ops."),c("span",{style:{color:"#B392F0"}},"set"),c("span",{style:{color:"#E1E4E8"}},"("),c("span",{style:{color:"#9ECBFF"}},'"hello"'),c("span",{style:{color:"#E1E4E8"}},","),c("span",{style:{color:"#9ECBFF"}},'"world_"'),c("span",{style:{color:"#F97583"}},"+"),c("span",{style:{color:"#E1E4E8"}}," UUID."),c("span",{style:{color:"#B392F0"}},"randomUUID"),c("span",{style:{color:"#E1E4E8"}},"()."),c("span",{style:{color:"#B392F0"}},"toString"),c("span",{style:{color:"#E1E4E8"}},"());")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"String hello "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," ops."),c("span",{style:{color:"#B392F0"}},"get"),c("span",{style:{color:"#E1E4E8"}},"("),c("span",{style:{color:"#9ECBFF"}},'"hello"'),c("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"System.out."),c("span",{style:{color:"#B392F0"}},"println"),c("span",{style:{color:"#E1E4E8"}},"(hello);")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"}")])])]),c("pre",{class:"shiki github-light vp-code-light"},[c("code",null,[c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"@"),c("span",{style:{color:"#D73A49"}},"Autowired")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"StringRedisTemplate stringRedisTemplate;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"@"),c("span",{style:{color:"#D73A49"}},"Test")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#D73A49"}},"public"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#D73A49"}},"void"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#6F42C1"}},"testStringRedisTemplate"),c("span",{style:{color:"#24292E"}},"(){")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"ValueOperations<"),c("span",{style:{color:"#D73A49"}},"String"),c("span",{style:{color:"#24292E"}},", "),c("span",{style:{color:"#D73A49"}},"String"),c("span",{style:{color:"#24292E"}},"> ops "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," stringRedisTemplate."),c("span",{style:{color:"#6F42C1"}},"opsForValue"),c("span",{style:{color:"#24292E"}},"();")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"ops."),c("span",{style:{color:"#6F42C1"}},"set"),c("span",{style:{color:"#24292E"}},"("),c("span",{style:{color:"#032F62"}},'"hello"'),c("span",{style:{color:"#24292E"}},","),c("span",{style:{color:"#032F62"}},'"world_"'),c("span",{style:{color:"#D73A49"}},"+"),c("span",{style:{color:"#24292E"}}," UUID."),c("span",{style:{color:"#6F42C1"}},"randomUUID"),c("span",{style:{color:"#24292E"}},"()."),c("span",{style:{color:"#6F42C1"}},"toString"),c("span",{style:{color:"#24292E"}},"());")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"String hello "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," ops."),c("span",{style:{color:"#6F42C1"}},"get"),c("span",{style:{color:"#24292E"}},"("),c("span",{style:{color:"#032F62"}},'"hello"'),c("span",{style:{color:"#24292E"}},");")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"System.out."),c("span",{style:{color:"#6F42C1"}},"println"),c("span",{style:{color:"#24292E"}},"(hello);")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"}")])])])],-1),fl=c("ul",null,[c("li",null,"4、切换使用 jedis")],-1),vl=c("div",{class:"language-xml"},[c("button",{title:"Copy Code",class:"copy"}),c("span",{class:"lang"},"xml"),c("pre",{class:"shiki github-dark vp-code-dark"},[c("code",null,[c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"<"),c("span",{style:{color:"#85E89D"}},"dependency"),c("span",{style:{color:"#E1E4E8"}},">")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    <"),c("span",{style:{color:"#85E89D"}},"groupId"),c("span",{style:{color:"#E1E4E8"}},">org.springframework.boot</"),c("span",{style:{color:"#85E89D"}},"groupId"),c("span",{style:{color:"#E1E4E8"}},">")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    <"),c("span",{style:{color:"#85E89D"}},"artifactId"),c("span",{style:{color:"#E1E4E8"}},">spring-boot-starter-data-redis</"),c("span",{style:{color:"#85E89D"}},"artifactId"),c("span",{style:{color:"#E1E4E8"}},">")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    <"),c("span",{style:{color:"#85E89D"}},"exclusions"),c("span",{style:{color:"#E1E4E8"}},">")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        <"),c("span",{style:{color:"#85E89D"}},"exclusion"),c("span",{style:{color:"#E1E4E8"}},">")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"            <"),c("span",{style:{color:"#85E89D"}},"groupId"),c("span",{style:{color:"#E1E4E8"}},">io.lettuce</"),c("span",{style:{color:"#85E89D"}},"groupId"),c("span",{style:{color:"#E1E4E8"}},">")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"            <"),c("span",{style:{color:"#85E89D"}},"artifactId"),c("span",{style:{color:"#E1E4E8"}},">lettuce-core</"),c("span",{style:{color:"#85E89D"}},"artifactId"),c("span",{style:{color:"#E1E4E8"}},">")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        </"),c("span",{style:{color:"#85E89D"}},"exclusion"),c("span",{style:{color:"#E1E4E8"}},">")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    </"),c("span",{style:{color:"#85E89D"}},"exclusions"),c("span",{style:{color:"#E1E4E8"}},">")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"</"),c("span",{style:{color:"#85E89D"}},"dependency"),c("span",{style:{color:"#E1E4E8"}},">")]),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"<"),c("span",{style:{color:"#85E89D"}},"dependency"),c("span",{style:{color:"#E1E4E8"}},">")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    <"),c("span",{style:{color:"#85E89D"}},"groupId"),c("span",{style:{color:"#E1E4E8"}},">redis.clients</"),c("span",{style:{color:"#85E89D"}},"groupId"),c("span",{style:{color:"#E1E4E8"}},">")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    <"),c("span",{style:{color:"#85E89D"}},"artifactId"),c("span",{style:{color:"#E1E4E8"}},">jedis</"),c("span",{style:{color:"#85E89D"}},"artifactId"),c("span",{style:{color:"#E1E4E8"}},">")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"</"),c("span",{style:{color:"#85E89D"}},"dependency"),c("span",{style:{color:"#E1E4E8"}},">")])])]),c("pre",{class:"shiki github-light vp-code-light"},[c("code",null,[c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"<"),c("span",{style:{color:"#22863A"}},"dependency"),c("span",{style:{color:"#24292E"}},">")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    <"),c("span",{style:{color:"#22863A"}},"groupId"),c("span",{style:{color:"#24292E"}},">org.springframework.boot</"),c("span",{style:{color:"#22863A"}},"groupId"),c("span",{style:{color:"#24292E"}},">")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    <"),c("span",{style:{color:"#22863A"}},"artifactId"),c("span",{style:{color:"#24292E"}},">spring-boot-starter-data-redis</"),c("span",{style:{color:"#22863A"}},"artifactId"),c("span",{style:{color:"#24292E"}},">")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    <"),c("span",{style:{color:"#22863A"}},"exclusions"),c("span",{style:{color:"#24292E"}},">")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        <"),c("span",{style:{color:"#22863A"}},"exclusion"),c("span",{style:{color:"#24292E"}},">")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"            <"),c("span",{style:{color:"#22863A"}},"groupId"),c("span",{style:{color:"#24292E"}},">io.lettuce</"),c("span",{style:{color:"#22863A"}},"groupId"),c("span",{style:{color:"#24292E"}},">")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"            <"),c("span",{style:{color:"#22863A"}},"artifactId"),c("span",{style:{color:"#24292E"}},">lettuce-core</"),c("span",{style:{color:"#22863A"}},"artifactId"),c("span",{style:{color:"#24292E"}},">")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        </"),c("span",{style:{color:"#22863A"}},"exclusion"),c("span",{style:{color:"#24292E"}},">")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    </"),c("span",{style:{color:"#22863A"}},"exclusions"),c("span",{style:{color:"#24292E"}},">")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"</"),c("span",{style:{color:"#22863A"}},"dependency"),c("span",{style:{color:"#24292E"}},">")]),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"<"),c("span",{style:{color:"#22863A"}},"dependency"),c("span",{style:{color:"#24292E"}},">")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    <"),c("span",{style:{color:"#22863A"}},"groupId"),c("span",{style:{color:"#24292E"}},">redis.clients</"),c("span",{style:{color:"#22863A"}},"groupId"),c("span",{style:{color:"#24292E"}},">")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    <"),c("span",{style:{color:"#22863A"}},"artifactId"),c("span",{style:{color:"#24292E"}},">jedis</"),c("span",{style:{color:"#22863A"}},"artifactId"),c("span",{style:{color:"#24292E"}},">")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"</"),c("span",{style:{color:"#22863A"}},"dependency"),c("span",{style:{color:"#24292E"}},">")])])])],-1),Ll=c("blockquote",null,[c("ul",null,[c("li",null,[c("p",null,"产生堆外内存溢出：OutOfDirectMemoryError"),c("ol",null,[c("li",null,"SpringBoot2.0以后默认使用lettuce作为操作redis的客户端，它使用netty进行网络通信"),c("li",null,[p("lettuce的bug导致netty堆外内存溢出 -Xmx 100m；netty如果没有指定堆外内存，默认使用-Xmx 100m "),c("ul",null,[c("li",null,"可以通过-Di0.netty.maxDirectMemory进行设置")])])])]),c("li",null,[c("p",null,"解决方案：不能只使用-Di0.netty.maxDirectMemory去调大堆外内存"),c("ol",null,[c("li",null,"升级lettuce客户端"),c("li",null,"切换使用老版的jedis")])]),c("li",null,[c("p",null,"lettuce,jedis操作redis的底层客户端，Spring再次封装redisTemplate")])])],-1),_l={id:"二、缓存失效问题",tabindex:"-1"},Rl={id:"分布式缓存-本地模式在分布式下的问题",tabindex:"-1"},Tl=c("figure",null,[c("img",{src:"https://jsd.cdn.zzko.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230410191940056.png",alt:"image-20230410191940056",loading:"lazy",decoding:"async"})],-1),jl=c("p",null,"先来解决大并发读情况下的缓存失效问题；",-1),Ol={id:"_1、高并发下缓存失效问题-缓存穿透",tabindex:"-1"},xl=c("figure",null,[c("img",{src:"https://jsd.cdn.zzko.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230410192133778.png",alt:"image-20230410192133778",loading:"lazy",decoding:"async"})],-1),Vl=c("ul",null,[c("li",null,[c("p",null,"缓存穿透是指查询一个一定不存在的数据，由于缓存是不命中，将去查询数据库，但是数据库也无此记录，我们没有将这次查询的 null 写入缓存，这将导致这个不存在的数据每次请求都要到存储层去查询，失去了缓存的意义。")]),c("li",null,[c("p",null,"风险："),c("ul",null,[c("li",null,"在流量大时，可能 DB 就挂掉了，要是有人利用不存在的 key 频繁攻击我们的应用，数据库瞬时压力增大，最终导致崩溃，这就是漏洞。")])]),c("li",null,[c("p",null,"解决："),c("ul",null,[c("li",null,"缓存空结果、并且设置短的过期时间。")])])],-1),zl={id:"_2、高并发下缓存失效问题-缓存雪崩",tabindex:"-1"},wl=c("ul",null,[c("li",null,[c("p",null,"缓存雪崩是指在我们设置缓存时采用了相同的过期时间，导致缓存在某一时刻同时失效，请求全部转发到 DB，DB 瞬时压力过重雪崩。")]),c("li",null,[c("p",null,"解决："),c("ul",null,[c("li",null,"原有的失效时间基础上增加一个随机值，比如 1-5 分钟随机，这样每一个缓存的过期时间的重复率就会降低，就很难引发集体失效的事件。")])])],-1),Ml={id:"_3、高并发下缓存失效问题-缓存击穿",tabindex:"-1"},Ul=c("figure",null,[c("img",{src:"https://jsd.cdn.zzko.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230410192628947.png",alt:"image-20230410192628947",loading:"lazy",decoding:"async"})],-1),Jl=c("ul",null,[c("li",null,[p("对于一些设置了过期时间的 key，如果这些 key 可能会在某些时间点被超高并发地访问，是一种非常“"),c("strong",null,"热点"),p("”的数据。")]),c("li",null,"这个时候，需要考虑一个问题：如果这个 key 在大量请求同时进来前正好失效，那么所有对这个 key 的数据查询都落到 db，我们称为缓存击穿。"),c("li",null,[p("解决： "),c("ul",null,[c("li",null,[p("加锁 "),c("ul",null,[c("li",null,"大量并发只让一个去查，其他人等待，查到以后释放锁，其他人获取到锁，先查缓存，就会有数据，不用去db")])])])])],-1),Pl={id:"三、缓存数据一致性",tabindex:"-1"},Kl=c("strong",null,"缓存数据一致性",-1),ql={id:"_1、缓存数据一致性-双写模式",tabindex:"-1"},Nl=c("figure",null,[c("img",{src:"https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230410193831064.png",alt:"image-20230410193831064",loading:"lazy",decoding:"async"})],-1),Wl={id:"如何保证数据库和缓存双写一致性",tabindex:"-1"},Hl=c("strong",null,"如何保证数据库和缓存双写一致性？",-1),Gl=c("ul",null,[c("li",null,[c("p",null,"数据库和缓存（比如：redis）双写数据一致性问题，是一个跟开发语言无关的公共问题。尤其在高并发的场景下，这个问题变得更加严重。")]),c("li",null,[c("p",null,"我很负责的告诉你，该问题无论在面试，还是工作中遇到的概率非常大，所以非常有必要跟大家一起探讨一下。")]),c("li",null,[c("p",null,"今天这篇文章我会从浅入深，跟大家一起聊聊，数据库和缓存双写数据一致性问题常见的解决方案，这些方案中可能存在的坑，以及最优方案是什么。")])],-1),Xl={id:"_1-常见方案",tabindex:"-1"},Ql=c("ul",null,[c("li",null,"通常情况下，我们使用缓存的主要目的是为了提升查询的性能。"),c("li",null,"大多数情况下，我们是这样使用缓存的：")],-1),$l=c("figure",null,[c("img",{src:"https://jsd.cdn.zzko.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230429210507615.png",alt:"image-20230429210507615",loading:"lazy",decoding:"async"})],-1),Yl=c("ol",null,[c("li",null,"用户请求过来之后，先查缓存有没有数据，如果有则直接返回。"),c("li",null,"如果缓存没数据，再继续查数据库。"),c("li",null,"如果数据库有数据，则将查询出来的数据，放入缓存中，然后返回该数据。"),c("li",null,"如果数据库也没数据，则直接返回空。")],-1),Zl=c("ul",null,[c("li",null,"这是缓存非常常见的用法。一眼看上去，好像没有啥问题。"),c("li",null,"但你忽略了一个非常重要的细节：如果数据库中的某条数据，放入缓存之后，又立马被更新了，那么该如何更新缓存呢？"),c("li",null,[p("不更新缓存行不行？ "),c("ul",null,[c("li",null,"答：当然不行，如果不更新缓存，在很长的一段时间内（决定于缓存的过期时间），用户请求从缓存中获取到的都可能是旧值，而非数据库的最新值。这不是有数据不一致的问题？")])]),c("li",null,[p("那么，我们该如何更新缓存呢？ "),c("ul",null,[c("li",null,[p("目前有以下4种方案： "),c("ol",null,[c("li",null,"先写缓存，再写数据库"),c("li",null,"先写数据库，再写缓存"),c("li",null,"先删缓存，再写数据库"),c("li",null,"先写数据库，再删缓存")])])])])],-1),so=c("p",null,"接下来，我们详细说说这4种方案。",-1),lo={id:"_2-先写缓存-再写数据库",tabindex:"-1"},oo=c("ul",null,[c("li",null,[c("p",null,"对于更新缓存的方案，很多人第一个想到的可能是在写操作中直接更新缓存（写缓存），更直接明了。")]),c("li",null,[c("p",null,"那么，问题来了：在写操作中，到底是先写缓存，还是先写数据库呢？"),c("ul",null,[c("li",null,[c("p",null,"我们在这里先聊聊先写缓存，再写数据库的情况，因为它的问题最严重。"),c("figure",null,[c("img",{src:"https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230429211803146.png",alt:"image-20230429211803146",loading:"lazy",decoding:"async"})])]),c("li",null,[c("p",null,"某一个用户的每一次写操作，如果刚写完缓存，突然网络出现了异常，导致写数据库失败了。"),c("figure",null,[c("img",{src:"https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230429212103693.png",alt:"image-20230429212103693",loading:"lazy",decoding:"async"})])])])])],-1),no=c("blockquote",null,[c("ul",null,[c("li",null,"其结果是缓存更新成了最新数据，但数据库没有，这样缓存中的数据不就变成脏数据了？如果此时该用户的查询请求，正好读取到该数据，就会出现问题，因为该数据在数据库中根本不存在，这个问题非常严重。"),c("li",null,"我们都知道，缓存的主要目的是把数据库的数据临时保存在内存，便于后续的查询，提升查询速度。"),c("li",null,[p("但如果某条数据，在数据库中都不存在，你缓存这种“"),c("code",null,"假数据"),p("”又有啥意义呢？")]),c("li",null,"因此，先写缓存，再写数据库的方案是不可取的，在实际工作中用得不多。")])],-1),ao={id:"_3-先写数据库-再写缓存",tabindex:"-1"},eo=c("ul",null,[c("li",null,"既然上面的方案行不通，接下来，聊聊先写数据库，再写缓存的方案，该方案在低并发编程中有人在用（我猜的）。")],-1),to=c("figure",null,[c("img",{src:"https://jsd.cdn.zzko.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230429212403247.png",alt:"image-20230429212403247",loading:"lazy",decoding:"async"})],-1),co=c("ul",null,[c("li",null,[c("p",null,"用户的写操作，先写数据库，再写缓存，可以避免之前“假数据”的问题。但它却带来了新的问题。")]),c("li",null,[c("p",null,"什么问题呢？"),c("ul",null,[c("li",null,[c("p",null,"写缓存失败了")]),c("li",null,[c("p",null,"高并发下的问题")]),c("li",null,[c("p",null,"浪费系统资源")])])])],-1),po={id:"_3-1-写缓存失败了",tabindex:"-1"},ro=c("ul",null,[c("li",null,"如果把写数据库和写缓存操作，放在同一个事务当中，当写缓存失败了，我们可以把写入数据库的数据进行回滚。")],-1),Eo=c("figure",null,[c("img",{src:"https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230429213036514.png",alt:"image-20230429213036514",loading:"lazy",decoding:"async"})],-1),yo=c("blockquote",null,[c("ul",null,[c("li",null,"如果是并发量比较小，对接口性能要求不太高的系统，可以这么玩。"),c("li",null,"但如果在高并发的业务场景中，写数据库和写缓存，都属于远程操作。为了防止出现大事务，造成的死锁问题，通常建议写数据库和写缓存不要放在同一个事务中。"),c("li",null,"也就是说在该方案中，如果写数据库成功了，但写缓存失败了，数据库中已写入的数据不会回滚。"),c("li",null,[p("这就会出现：数据库是"),c("code",null,"新数据"),p("，而缓存是"),c("code",null,"旧数据"),p("，两边"),c("code",null,"数据不一致"),p("的情况。")])])],-1),io={id:"_3-2-高并发下的问题",tabindex:"-1"},uo=c("ul",null,[c("li",null,[c("p",null,"假设在高并发的场景中，针对同一个用户的同一条数据，有两个写数据请求：a和b，它们同时请求到业务系统。")]),c("li",null,[c("p",null,"其中请求a获取的是旧数据，而请求b获取的是新数据，如下图所示：")])],-1),go=c("figure",null,[c("img",{src:"https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230429214141109.png",alt:"image-20230429214141109",loading:"lazy",decoding:"async"})],-1),Fo=c("ol",null,[c("li",null,"请求a先过来，刚写完了数据库。但由于网络原因，卡顿了一下，还没来得及写缓存。"),c("li",null,"这时候请求b过来了，先写了数据库。"),c("li",null,"接下来，请求b顺利写了缓存。"),c("li",null,"此时，请求a卡顿结束，也写了缓存。")],-1),Do=c("blockquote",null,[c("ul",null,[c("li",null,[p("很显然，在这个过程当中，请求b在缓存中的"),c("code",null,"新数据"),p("，被请求a的"),c("code",null,"旧数据"),p("覆盖了。")]),c("li",null,"也就是说：在高并发场景中，如果多个线程同时执行先写数据库，再写缓存的操作，可能会出现数据库是新值，而缓存中是旧值，两边数据不一致的情况。")])],-1),Ao={id:"_3-3-浪费系统资源",tabindex:"-1"},Co=c("ul",null,[c("li",null,[c("p",null,"该方案还有一个比较大的问题就是：每个写操作，写完数据库，会马上写缓存，比较浪费系统资源。")]),c("li",null,[c("p",null,"为什么这么说呢？"),c("ul",null,[c("li",null,[c("p",null,"你可以试想一下，如果写的缓存，并不是简单的数据内容，而是要经过非常复杂的计算得出的最终结果。这样每写一次缓存，都需要经过一次非常复杂的计算，不是非常浪费系统资源吗？")]),c("li",null,[c("p",null,"尤其是cpu和内存资源。")])])])],-1),ho=c("blockquote",null,[c("ul",null,[c("li",null,[c("p",null,"还有些业务场景比较特殊：写多读少。")]),c("li",null,[c("p",null,"如果在这类业务场景中，每个用的写操作，都需要写一次缓存，有点得不偿失。")]),c("li",null,[c("p",null,"由此可见，在高并发的场景中，先写数据库，再写缓存，这套方案问题挺多的，也不太建议使用。")]),c("li",null,[c("p",null,"如果你已经用了，赶紧看看踩坑了没？")])])],-1),mo={id:"_4-先删缓存-再写数据库",tabindex:"-1"},ko=c("ul",null,[c("li",null,[c("p",null,"通过上面的内容我们得知，如果直接更新缓存的问题很多。")]),c("li",null,[c("p",null,"那么，为何我们不能换一种思路：不去直接更新缓存，而改为删除缓存呢？")]),c("li",null,[c("p",null,"删除缓存方案，同样有两种："),c("ol",null,[c("li",null,"先删缓存，再写数据库"),c("li",null,"先写数据库，再删缓存")])]),c("li",null,[c("p",null,"我们一起先看看：先删缓存，再写数据库的情况。")])],-1),bo=c("figure",null,[c("img",{src:"https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230429214804997.png",alt:"image-20230429214804997",loading:"lazy",decoding:"async"})],-1),Bo=c("blockquote",null,[c("p",null,"说白了，在用户的写操作中，先执行删除缓存操作，再去写数据库。这套方案，可以是可以，但也会有一样问题。")],-1),So={id:"_4-1-高并发下的问题",tabindex:"-1"},Io=c("ul",null,[c("li",null,"假设在高并发的场景中，同一个用户的同一条数据，有一个读数据请求c，还有另一个写数据请求d（一个更新操作），同时请求到业务系统。如下图所示：")],-1),fo=c("figure",null,[c("img",{src:"https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230429215027947.png",alt:"image-20230429215027947",loading:"lazy",decoding:"async"})],-1),vo=c("ol",null,[c("li",null,"请求d先过来，把缓存删除了。但由于网络原因，卡顿了一下，还没来得及写数据库。"),c("li",null,"这时请求c过来了，先查缓存发现没数据，再查数据库，有数据，但是旧值。"),c("li",null,"请求c将数据库中的旧值，更新到缓存中。"),c("li",null,"此时，请求d卡顿结束，把新值写入数据库。")],-1),Lo=c("ul",null,[c("li",null,"在这个过程当中，请求d的新值并没有被请求c写入缓存，同样会导致缓存和数据库的数据不一致的情况。"),c("li",null,[p("那么，这种场景的数据不一致问题，能否解决呢？ "),c("ul",null,[c("li",null,"缓存双删")])])],-1),_o={id:"_4-2-缓存双删",tabindex:"-1"},Ro=c("ul",null,[c("li",null,[c("p",null,"在上面的业务场景中，一个读数据请求，一个写数据请求。当写数据请求把缓存删了之后，读数据请求，可能把当时从数据库查询出来的旧值，写入缓存当中。")]),c("li",null,[c("p",null,"有人说还不好办，请求d在写完数据库之后，把缓存重新删一次不就行了？")])],-1),To=c("figure",null,[c("img",{src:"https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230429215248760.png",alt:"image-20230429215248760",loading:"lazy",decoding:"async"})],-1),jo=c("ul",null,[c("li",null,[c("p",null,"这就是我们所说的缓存双删，即在写数据库之前删除一次，写完数据库后，再删除一次。")]),c("li",null,[c("p",null,"该方案有个非常关键的地方是：第二次删除缓存，并非立马就删，而是要在一定的时间间隔之后。")]),c("li",null,[c("p",null,"我们再重新回顾一下，高并发下一个读数据请求，一个写数据请求导致数据不一致的产生过程："),c("ol",null,[c("li",null,"请求d先过来，把缓存删除了。但由于网络原因，卡顿了一下，还没来得及写数据库。"),c("li",null,"这时请求c过来了，先查缓存发现没数据，再查数据库，有数据，但是旧值。"),c("li",null,"请求c将数据库中的旧值，更新到缓存中。"),c("li",null,"此时，请求d卡顿结束，把新值写入数据库。"),c("li",null,"一段时间之后，比如：500ms，请求d将缓存删除。")])]),c("li",null,[c("p",null,"这样来看确实可以解决缓存不一致问题。")]),c("li",null,[c("p",null,"那么，为什么一定要间隔一段时间之后，才能删除缓存呢？")]),c("li",null,[c("p",null,"请求d卡顿结束，把新值写入数据库后，请求c将数据库中的旧值，更新到缓存中。")]),c("li",null,[c("p",null,"此时，如果请求d删除太快，在请求c将数据库中的旧值更新到缓存之前，就已经把缓存删除了，这次删除就没任何意义。必须要在请求c更新缓存之后，再删除缓存，才能把旧值及时删除了。")]),c("li",null,[c("p",null,"所以需要在请求d中加一个时间间隔，确保请求c，或者类似于请求c的其他请求，如果在缓存中设置了旧值，最终都能够被请求d删除掉。")]),c("li",null,[c("p",null,"接下来，还有一个问题：如果第二次删除缓存时，删除失败了该怎么办？")]),c("li",null,[c("p",null,"这里先留点悬念，后面会详细说。")])],-1),Oo={id:"_5-先写数据库-再删缓存",tabindex:"-1"},xo=c("ul",null,[c("li",null,"从前面得知，先删缓存，再写数据库，在并发的情况下，也可能会出现缓存和数据库的数据不一致的情况。"),c("li",null,"那么，我们只能寄希望于最后的方案了。"),c("li",null,"接下来，我们重点看看先写数据库，再删缓存的方案。")],-1),Vo=c("figure",null,[c("img",{src:"https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230429220057198.png",alt:"image-20230429220057198",loading:"lazy",decoding:"async"})],-1),zo=c("ul",null,[c("li",null,"在高并发的场景中，有一个读数据请求，有一个写数据请求，更新过程如下：")],-1),wo=c("ol",null,[c("li",null,"请求e先写数据库，由于网络原因卡顿了一下，没有来得及删除缓存。"),c("li",null,"请求f查询缓存，发现缓存中有数据，直接返回该数据。"),c("li",null,"请求e删除缓存。")],-1),Mo=c("ul",null,[c("li",null,"在这个过程中，只有请求f读了一次旧数据，后来旧数据被请求e及时删除了，看起来问题不大。"),c("li",null,"但如果是读数据请求先过来呢？")],-1),Uo=c("ol",null,[c("li",null,"请求f查询缓存，发现缓存中有数据，直接返回该数据。"),c("li",null,"请求e先写数据库。"),c("li",null,"请求e删除缓存。")],-1),Jo=c("ul",null,[c("li",null,[p("这种情况看起来也没问题呀？ "),c("ul",null,[c("li",null,"答：对的。")])]),c("li",null,"但就怕出现下面这种情况，即缓存自己失效了。如下图所示：")],-1),Po=c("figure",null,[c("img",{src:"https://jsd.cdn.zzko.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230429220431661.png",alt:"image-20230429220431661",loading:"lazy",decoding:"async"})],-1),Ko=c("ol",null,[c("li",null,"缓存过期时间到了，自动失效。"),c("li",null,"请求f查询缓存，发缓存中没有数据，查询数据库的旧值，但由于网络原因卡顿了，没有来得及更新缓存。"),c("li",null,"请求e先写数据库，接着删除了缓存。"),c("li",null,"请求f更新旧值到缓存中。")],-1),qo=c("ul",null,[c("li",null,[c("p",null,"这时，缓存和数据库的数据同样出现不一致的情况了。")]),c("li",null,[c("p",null,"但这种情况还是比较少的，需要同时满足以下条件才可以："),c("ol",null,[c("li",null,"缓存刚好自动失效。"),c("li",null,"请求f从数据库查出旧值，更新缓存的耗时，比请求e写数据库，并且删除缓存的还长。")])]),c("li",null,[c("p",null,"我们都知道查询数据库的速度，一般比写数据库要快，更何况写完数据库，还要删除缓存。所以绝大多数情况下，写数据请求比读数据情况耗时更长。")]),c("li",null,[c("p",null,"由此可见，系统同时满足上述两个条件的概率非常小。")])],-1),No=c("blockquote",null,[c("p",null,"推荐大家使用先写数据库，再删缓存的方案，虽说不能100%避免数据不一致问题，但出现该问题的概率，相对于其他方案来说是最小的。")],-1),Wo=c("ul",null,[c("li",null,"但在该方案中，如果删除缓存失败了该怎么办呢？")],-1),Ho={id:"_6-删缓存失败怎么办",tabindex:"-1"},Go=c("ul",null,[c("li",null,"其实先写数据库，再删缓存的方案，跟缓存双删的方案一样，有一个共同的风险点，即：如果缓存删除失败了，也会导致缓存和数据库的数据不一致。"),c("li",null,[p("那么，删除缓存失败怎么办呢？ "),c("ul",null,[c("li",null,[p("答：需要加"),c("code",null,"重试机制"),p("。")])])]),c("li",null,"在接口中如果更新了数据库成功了，但更新缓存失败了，可以立刻重试3次。如果其中有任何一次成功，则直接返回成功。如果3次都失败了，则写入数据库，准备后续再处理。"),c("li",null,[p("当然，如果你在接口中直接"),c("code",null,"同步重试"),p("，该接口并发量比较高的时候，可能有点影响接口性能。")]),c("li",null,[p("这时，就需要改成"),c("code",null,"异步重试"),p("了。")]),c("li",null,[p("异步重试方式有很多种，比如： "),c("ol",null,[c("li",null,"每次都单独起一个线程，该线程专门做重试的工作。但如果在高并发的场景下，可能会创建太多的线程，导致系统OOM问题，不太建议使用。"),c("li",null,"将重试的任务交给线程池处理，但如果服务器重启，部分数据可能会丢失。"),c("li",null,"将重试数据写表，然后使用elastic-job等定时任务进行重试。"),c("li",null,"将重试的请求写入mq等消息中间件中，在mq的consumer中处理。"),c("li",null,"订阅mysql的binlog，在订阅者中，如果发现了更新数据请求，则删除相应的缓存。")])])],-1),Xo={id:"_7-定时任务",tabindex:"-1"},Qo=c("ul",null,[c("li",null,"使用定时任务重试的具体方案如下：")],-1),$o=c("ol",null,[c("li",null,"当用户操作写完数据库，但删除缓存失败了，需要将用户数据写入重试表中。如下图所示：")],-1),Yo=c("figure",null,[c("img",{src:"https://jsd.cdn.zzko.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230429221037315.png",alt:"image-20230429221037315",loading:"lazy",decoding:"async"})],-1),Zo=c("ol",{start:"2"},[c("li",null,"在定时任务中，异步读取重试表中的用户数据。重试表需要记录一个重试次数字段，初始值为0。然后重试5次，不断删除缓存，每重试一次该字段值+1。如果其中有任意一次成功了，则返回成功。如果重试了5次，还是失败，则我们需要在重试表中记录一个失败的状态，等待后续进一步处理。")],-1),sn=c("figure",null,[c("img",{src:"https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230429221203146.png",alt:"image-20230429221203146",loading:"lazy",decoding:"async"})],-1),ln=c("ol",{start:"3"},[c("li",null,[p("在高并发场景中，定时任务推荐使用"),c("code",null,"elastic-job"),p("。相对于xxl-job等定时任务，它可以分片处理，提升处理速度。同时每片的间隔可以设置成：1,2,3,5,7秒等。")])],-1),on=c("li",null,"使用定时任务重试的话，有个缺点就是实时性没那么高，对于实时性要求特别高的业务场景，该方案不太适用。但是对于一般场景，还是可以用一用的。",-1),nn=c("li",null,"但它有一个很大的优点，即数据是落库的，不会丢数据。",-1),an={id:"_8-mq",tabindex:"-1"},en=c("li",null,"在高并发的业务场景中，mq（消息队列）是必不可少的技术之一。它不仅可以异步解耦，还能削峰填谷。对保证系统的稳定性是非常有意义的。",-1),tn=c("li",null,"mq的生产者，生产了消息之后，通过指定的topic发送到mq服务器。然后mq的消费者，订阅该topic的消息，读取消息数据之后，做业务逻辑处理。",-1),cn=c("li",null,"使用mq重试的具体方案如下：",-1),pn=c("figure",null,[c("img",{src:"https://jsd.cdn.zzko.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230429221455529.png",alt:"image-20230429221455529",loading:"lazy",decoding:"async"})],-1),rn=c("ol",null,[c("li",null,"当用户操作写完数据库，但删除缓存失败了，产生一条mq消息，发送给mq服务器。"),c("li",null,"mq消费者读取mq消息，重试5次删除缓存。如果其中有任意一次成功了，则返回成功。如果重试了5次，还是失败，则写入死信队列中。"),c("li",null,"推荐mq使用rocketmq，重试机制和死信队列默认是支持的。使用起来非常方便，而且还支持顺序消息，延迟消息和事务消息等多种业务场景。")],-1),En=c("blockquote",null,[c("ul",null,[c("li",null,"当然在该方案中，删除缓存可以完全走异步。即用户的写操作，在写完数据库之后，不用立刻删除一次缓存。而直接发送mq消息，到mq服务器，然后有mq消费者全权负责删除缓存的任务。"),c("li",null,"因为mq的实时性还是比较高的，因此改良后的方案也是一种不错的选择。")])],-1),yn={id:"_9-binlog",tabindex:"-1"},un=c("ul",null,[c("li",null,"前面我们聊过的，无论是定时任务，还是mq（消息队列），做重试机制，对业务都有一定的侵入性。"),c("li",null,"在使用定时任务的方案中，需要在业务代码中增加额外逻辑，如果删除缓存失败，需要将数据写入重试表。"),c("li",null,"而使用mq的方案中，如果删除缓存失败了，需要在业务代码中发送mq消息到mq服务器。"),c("li",null,"其实，还有一种更优雅的实现，即监听binlog，比如使用：canal等中间件。"),c("li",null,"具体方案如下：")],-1),dn=c("figure",null,[c("img",{src:"https://jsd.cdn.zzko.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230429221610975.png",alt:"image-20230429221610975",loading:"lazy",decoding:"async"})],-1),gn=c("ol",null,[c("li",null,"在业务接口中写数据库之后，就不管了，直接返回成功。"),c("li",null,"mysql服务器会自动把变更的数据写入binlog中。"),c("li",null,"binlog订阅者获取变更的数据，然后删除缓存。")],-1),Fn=c("ul",null,[c("li",null,"这套方案中业务接口确实简化了一些流程，只用关心数据库操作即可，而在binlog订阅者中做缓存删除工作。"),c("li",null,"但如果只是按照图中的方案进行删除缓存，只删除了一次，也可能会失败。"),c("li",null,[p("如何解决这个问题呢？ "),c("ul",null,[c("li",null,[p("答：这就需要加上前面聊过的"),c("code",null,"重试机制"),p("了。如果删除缓存失败，写入重试表，使用定时任务重试。或者写入mq，让mq自动重试。")])])]),c("li",null,[p("在这里推荐使用mq"),c("code",null,"自动重试机制"),p("。")])],-1),Dn=c("figure",null,[c("img",{src:"https://jsd.cdn.zzko.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230429221806980.png",alt:"image-20230429221806980",loading:"lazy",decoding:"async"})],-1),An=c("blockquote",null,[c("p",null,"在binlog订阅者中如果删除缓存失败，则发送一条mq消息到mq服务器，在mq消费者中自动重试5次。如果有任意一次成功，则直接返回成功。如果重试5次后还是失败，则该消息自动被放入死信队列，后面可能需要人工介入。")],-1),Cn={id:"_2、缓存数据一致性-失效模式",tabindex:"-1"},hn=c("figure",null,[c("img",{src:"https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230410193909090.png",alt:"image-20230410193909090",loading:"lazy",decoding:"async"})],-1),mn={id:"_3、缓存数据一致性-解决方案",tabindex:"-1"},kn=c("ul",null,[c("li",null,[p("无论是双写模式还是失效模式，都会导致缓存的不一致问题。即多个实例同时更新会出事。怎么办？ "),c("ul",null,[c("li",null,"1、如果是用户纬度数据（订单数据、用户数据），这种并发几率非常小，不用考虑这个问题，缓存数据加上过期时间，每隔一段时间触发读的主动更新即可"),c("li",null,"2、如果是菜单，商品介绍等基础数据，也可以去使用canal订阅binlog的方式。"),c("li",null,"3、缓存数据+过期时间也足够解决大部分业务对于缓存的要求。"),c("li",null,"4、通过加锁保证并发读写，写写的时候按顺序排好队。读读无所谓。所以适合使用读写锁。（业务不关心脏数据，允许临时脏数据可忽略）；")])]),c("li",null,[p("总结： "),c("ul",null,[c("li",null,"我们能放入缓存的数据本就不应该是实时性、一致性要求超高的。所以缓存数据的时候加上过期时间，保证每天拿到当前最新数据即可。"),c("li",null,"我们不应该过度设计，增加系统的复杂性"),c("li",null,"遇到实时性、一致性要求高的数据，就应该查数据库，即使慢点。")])])],-1),bn={id:"_4、缓存数据一致性-解决-canal",tabindex:"-1"},Bn=c("figure",null,[c("img",{src:"https://jsd.cdn.zzko.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230410194458435.png",alt:"image-20230410194458435",loading:"lazy",decoding:"async"})],-1),Sn={id:"四、分布式锁",tabindex:"-1"},In={id:"_1、分布式锁与本地锁",tabindex:"-1"},fn=c("figure",null,[c("img",{src:"https://jsd.cdn.zzko.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230425221131744.png",alt:"image-20230425221131744",loading:"lazy",decoding:"async"})],-1),vn=c("ul",null,[c("li",null,[c("code",null,"org.klaus.zgg01mall.product.service.impl.CategoryServiceImpl#getDataFromDb"),c("ul",null,[c("li",null,"抽取业务方法方便加锁")])])],-1),Ln=c("div",{class:"language-java"},[c("button",{title:"Copy Code",class:"copy"}),c("span",{class:"lang"},"java"),c("pre",{class:"shiki github-dark vp-code-dark"},[c("code",null,[c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"/**")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}}," * 抽取业务方法")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}}," *")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}}," * "),c("span",{style:{color:"#F97583"}},"@return")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}}," */")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#F97583"}},"private"),c("span",{style:{color:"#E1E4E8"}}," Map"),c("span",{style:{color:"#F97583"}},"<"),c("span",{style:{color:"#E1E4E8"}},"String, List"),c("span",{style:{color:"#F97583"}},"<"),c("span",{style:{color:"#E1E4E8"}},"Catalog2Vo"),c("span",{style:{color:"#F97583"}},">>"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#B392F0"}},"getDataFromDb"),c("span",{style:{color:"#E1E4E8"}},"() {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#6A737D"}},"//获取缓存")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    String catalogJson "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," stringRedisTemplate."),c("span",{style:{color:"#B392F0"}},"opsForValue"),c("span",{style:{color:"#E1E4E8"}},"()."),c("span",{style:{color:"#B392F0"}},"get"),c("span",{style:{color:"#E1E4E8"}},"("),c("span",{style:{color:"#9ECBFF"}},'"catalogJson"'),c("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#F97583"}},"if"),c("span",{style:{color:"#E1E4E8"}}," ("),c("span",{style:{color:"#F97583"}},"!"),c("span",{style:{color:"#E1E4E8"}},"StringUtils."),c("span",{style:{color:"#B392F0"}},"isEmpty"),c("span",{style:{color:"#E1E4E8"}},"(catalogJson)) {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        "),c("span",{style:{color:"#6A737D"}},"//缓存不为空直接返回")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        Map<"),c("span",{style:{color:"#F97583"}},"String"),c("span",{style:{color:"#E1E4E8"}},", List<"),c("span",{style:{color:"#F97583"}},"Catalog2Vo"),c("span",{style:{color:"#E1E4E8"}},">> result "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," JSON."),c("span",{style:{color:"#B392F0"}},"parseObject"),c("span",{style:{color:"#E1E4E8"}},"(catalogJson, "),c("span",{style:{color:"#F97583"}},"new"),c("span",{style:{color:"#E1E4E8"}}," TypeReference<Map<"),c("span",{style:{color:"#F97583"}},"String"),c("span",{style:{color:"#E1E4E8"}},", List<"),c("span",{style:{color:"#F97583"}},"Catalog2Vo"),c("span",{style:{color:"#E1E4E8"}},">>>() {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        });")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        "),c("span",{style:{color:"#F97583"}},"return"),c("span",{style:{color:"#E1E4E8"}}," result;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    System.out."),c("span",{style:{color:"#B392F0"}},"println"),c("span",{style:{color:"#E1E4E8"}},"("),c("span",{style:{color:"#9ECBFF"}},'"查询了数据库。。。"'),c("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#6A737D"}},"/**")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"     * 缓存为空，进行查询业务")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"     * 1、将数据库的多次查询变为一次，即方法抽取")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"     */")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#6A737D"}},"//查询所有")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    List<"),c("span",{style:{color:"#F97583"}},"CategoryEntity"),c("span",{style:{color:"#E1E4E8"}},"> selectList "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," baseMapper."),c("span",{style:{color:"#B392F0"}},"selectList"),c("span",{style:{color:"#E1E4E8"}},"("),c("span",{style:{color:"#79B8FF"}},"null"),c("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#6A737D"}},"//1、查出所有1级分类                                   父分类集合，一级分类父分类id为0")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    List<"),c("span",{style:{color:"#F97583"}},"CategoryEntity"),c("span",{style:{color:"#E1E4E8"}},"> level1Categorys "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#B392F0"}},"getParent_cid"),c("span",{style:{color:"#E1E4E8"}},"(selectList, "),c("span",{style:{color:"#79B8FF"}},"0L"),c("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#6A737D"}},"//2、封装数据")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    Map<"),c("span",{style:{color:"#F97583"}},"String"),c("span",{style:{color:"#E1E4E8"}},", List<"),c("span",{style:{color:"#F97583"}},"Catalog2Vo"),c("span",{style:{color:"#E1E4E8"}},">> map "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," level1Categorys."),c("span",{style:{color:"#B392F0"}},"stream"),c("span",{style:{color:"#E1E4E8"}},"()."),c("span",{style:{color:"#B392F0"}},"collect"),c("span",{style:{color:"#E1E4E8"}},"(Collectors."),c("span",{style:{color:"#B392F0"}},"toMap"),c("span",{style:{color:"#E1E4E8"}},"(")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"            "),c("span",{style:{color:"#6A737D"}},'//"pCId":"c2{}"')]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"            k "),c("span",{style:{color:"#F97583"}},"->"),c("span",{style:{color:"#E1E4E8"}}," k."),c("span",{style:{color:"#B392F0"}},"getCatId"),c("span",{style:{color:"#E1E4E8"}},"()."),c("span",{style:{color:"#B392F0"}},"toString"),c("span",{style:{color:"#E1E4E8"}},"(),")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"            v "),c("span",{style:{color:"#F97583"}},"->"),c("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"                "),c("span",{style:{color:"#6A737D"}},"//2.1、每一个的一级分类，查到这个一级分类的[二级分类]")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"                "),c("span",{style:{color:"#6A737D"}},'//得到二级分类实体集合 抽取查询方法-> baseMapper.selectList(new QueryWrapper<CategoryEntity>().eq("parent_cid", v.getCatId()));')]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"                "),c("span",{style:{color:"#6A737D"}},"//todo                                                 父分类集合， 当前分类id（v为当前遍历的一级分类）")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"                List<"),c("span",{style:{color:"#F97583"}},"CategoryEntity"),c("span",{style:{color:"#E1E4E8"}},"> catalog2Entities "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#B392F0"}},"getParent_cid"),c("span",{style:{color:"#E1E4E8"}},"(selectList, v."),c("span",{style:{color:"#B392F0"}},"getCatId"),c("span",{style:{color:"#E1E4E8"}},"());")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"                "),c("span",{style:{color:"#6A737D"}},"//2.2、封装上面的结果")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"                List<"),c("span",{style:{color:"#F97583"}},"Catalog2Vo"),c("span",{style:{color:"#E1E4E8"}},"> catalog2Vos "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#79B8FF"}},"null"),c("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"                "),c("span",{style:{color:"#6A737D"}},"//父分类不为空，即二级分类实体集合不为空")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"                "),c("span",{style:{color:"#F97583"}},"if"),c("span",{style:{color:"#E1E4E8"}}," (catalog2Entities "),c("span",{style:{color:"#F97583"}},"!="),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#79B8FF"}},"null"),c("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"                    "),c("span",{style:{color:"#6A737D"}},"//遍历拿到每个二级分类集合")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"                    catalog2Vos "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," catalog2Entities."),c("span",{style:{color:"#B392F0"}},"stream"),c("span",{style:{color:"#E1E4E8"}},"()."),c("span",{style:{color:"#B392F0"}},"map"),c("span",{style:{color:"#E1E4E8"}},"(l2 "),c("span",{style:{color:"#F97583"}},"->"),c("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"                        "),c("span",{style:{color:"#6A737D"}},"//封装二级分类vo数据")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"                        Catalog2Vo catalog2Vo "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#F97583"}},"new"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#B392F0"}},"Catalog2Vo"),c("span",{style:{color:"#E1E4E8"}},"(v."),c("span",{style:{color:"#B392F0"}},"getCatId"),c("span",{style:{color:"#E1E4E8"}},"()."),c("span",{style:{color:"#B392F0"}},"toString"),c("span",{style:{color:"#E1E4E8"}},"(), "),c("span",{style:{color:"#79B8FF"}},"null"),c("span",{style:{color:"#E1E4E8"}},", l2."),c("span",{style:{color:"#B392F0"}},"getCatId"),c("span",{style:{color:"#E1E4E8"}},"()."),c("span",{style:{color:"#B392F0"}},"toString"),c("span",{style:{color:"#E1E4E8"}},"(), l2."),c("span",{style:{color:"#B392F0"}},"getName"),c("span",{style:{color:"#E1E4E8"}},"());")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"                        "),c("span",{style:{color:"#6A737D"}},'//2.2.1、找当前二级分类的三级分类封装成vo baseMapper.selectList(new QueryWrapper<CategoryEntity>(). eq("parent_cid", l2.getCatId()));')]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"                        "),c("span",{style:{color:"#6A737D"}},"//                                       （三级分类父分类）父分类集合， 当前分类id（l2为当前遍历的二级分类）")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"                        List<"),c("span",{style:{color:"#F97583"}},"CategoryEntity"),c("span",{style:{color:"#E1E4E8"}},"> catalog3Entities "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#B392F0"}},"getParent_cid"),c("span",{style:{color:"#E1E4E8"}},"(selectList, l2."),c("span",{style:{color:"#B392F0"}},"getCatId"),c("span",{style:{color:"#E1E4E8"}},"());")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"                        List<"),c("span",{style:{color:"#F97583"}},"Catalog2Vo"),c("span",{style:{color:"#E1E4E8"}},"."),c("span",{style:{color:"#F97583"}},"Catalog3Vo"),c("span",{style:{color:"#E1E4E8"}},"> catalog3Vos "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#79B8FF"}},"null"),c("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"                        "),c("span",{style:{color:"#F97583"}},"if"),c("span",{style:{color:"#E1E4E8"}}," (catalog3Entities "),c("span",{style:{color:"#F97583"}},"!="),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#79B8FF"}},"null"),c("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"                            catalog3Vos "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," catalog3Entities."),c("span",{style:{color:"#B392F0"}},"stream"),c("span",{style:{color:"#E1E4E8"}},"()."),c("span",{style:{color:"#B392F0"}},"map"),c("span",{style:{color:"#E1E4E8"}},"(l3 "),c("span",{style:{color:"#F97583"}},"->"),c("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"                                "),c("span",{style:{color:"#6A737D"}},"//2.2.2、封装成指定格式")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"                                Catalog2Vo.Catalog3Vo catalog3Vo "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#F97583"}},"new"),c("span",{style:{color:"#E1E4E8"}}," Catalog2Vo."),c("span",{style:{color:"#B392F0"}},"Catalog3Vo"),c("span",{style:{color:"#E1E4E8"}},"(l2."),c("span",{style:{color:"#B392F0"}},"getCatId"),c("span",{style:{color:"#E1E4E8"}},"()."),c("span",{style:{color:"#B392F0"}},"toString"),c("span",{style:{color:"#E1E4E8"}},"(), l3."),c("span",{style:{color:"#B392F0"}},"getCatId"),c("span",{style:{color:"#E1E4E8"}},"()."),c("span",{style:{color:"#B392F0"}},"toString"),c("span",{style:{color:"#E1E4E8"}},"(), l3."),c("span",{style:{color:"#B392F0"}},"getName"),c("span",{style:{color:"#E1E4E8"}},"());")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"                                "),c("span",{style:{color:"#F97583"}},"return"),c("span",{style:{color:"#E1E4E8"}}," catalog3Vo;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"                            })."),c("span",{style:{color:"#B392F0"}},"collect"),c("span",{style:{color:"#E1E4E8"}},"(Collectors."),c("span",{style:{color:"#B392F0"}},"toList"),c("span",{style:{color:"#E1E4E8"}},"());")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"                            catalog2Vo."),c("span",{style:{color:"#B392F0"}},"setCatalog3List"),c("span",{style:{color:"#E1E4E8"}},"(catalog3Vos);")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"                        }")]),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"                        "),c("span",{style:{color:"#F97583"}},"return"),c("span",{style:{color:"#E1E4E8"}}," catalog2Vo;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"                    })."),c("span",{style:{color:"#B392F0"}},"collect"),c("span",{style:{color:"#E1E4E8"}},"(Collectors."),c("span",{style:{color:"#B392F0"}},"toList"),c("span",{style:{color:"#E1E4E8"}},"());")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"                }")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"                "),c("span",{style:{color:"#F97583"}},"return"),c("span",{style:{color:"#E1E4E8"}}," catalog2Vos;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"            }));")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#6A737D"}},"//todo 3、查到的数据再放入缓存，将对象转为json放入缓存中")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    String s "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," JSON."),c("span",{style:{color:"#B392F0"}},"toJSONString"),c("span",{style:{color:"#E1E4E8"}},"(map);")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#6A737D"}},"//将数据放入缓存")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    stringRedisTemplate."),c("span",{style:{color:"#B392F0"}},"opsForValue"),c("span",{style:{color:"#E1E4E8"}},"()."),c("span",{style:{color:"#B392F0"}},"set"),c("span",{style:{color:"#E1E4E8"}},"("),c("span",{style:{color:"#9ECBFF"}},'"catalogJson"'),c("span",{style:{color:"#E1E4E8"}},", s, "),c("span",{style:{color:"#79B8FF"}},"1"),c("span",{style:{color:"#E1E4E8"}},", TimeUnit.DAYS);")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#6A737D"}},"//将数据库查到的结果直接返回，即将数据库查到的结果放一份到缓存中并返回")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#F97583"}},"return"),c("span",{style:{color:"#E1E4E8"}}," map;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"}")]),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"/**")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"     * 抽取获取父分类id的查询方法，优化三级分类数据获取，使得在压力测试中吞吐量有明显的提高；")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"     * 查询数据库是影响吞吐量高低的重要因素之一，因此尽量减少数据库的查询")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"     *")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"     * "),c("span",{style:{color:"#F97583"}},"@param"),c("span",{style:{color:"#6A737D"}}," "),c("span",{style:{color:"#FFAB70"}},"selectList")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"     * "),c("span",{style:{color:"#F97583"}},"@param"),c("span",{style:{color:"#6A737D"}}," "),c("span",{style:{color:"#FFAB70"}},"parent_cid")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"     * "),c("span",{style:{color:"#F97583"}},"@return")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"     */")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#F97583"}},"private"),c("span",{style:{color:"#E1E4E8"}}," List"),c("span",{style:{color:"#F97583"}},"<"),c("span",{style:{color:"#E1E4E8"}},"CategoryEntity"),c("span",{style:{color:"#F97583"}},">"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#B392F0"}},"getParent_cid"),c("span",{style:{color:"#E1E4E8"}},"(List"),c("span",{style:{color:"#F97583"}},"<"),c("span",{style:{color:"#E1E4E8"}},"CategoryEntity"),c("span",{style:{color:"#F97583"}},">"),c("span",{style:{color:"#E1E4E8"}}," selectList, Long parent_cid) {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        "),c("span",{style:{color:"#6A737D"}},'//return baseMapper.selectList(new QueryWrapper<CategoryEntity>().eq("parent_cid", v.getCatId()));')]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        "),c("span",{style:{color:"#6A737D"}},"//直接进行过滤得到当前遍历的父分类id为传入的父分类id")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        List<"),c("span",{style:{color:"#F97583"}},"CategoryEntity"),c("span",{style:{color:"#E1E4E8"}},"> collect "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," selectList."),c("span",{style:{color:"#B392F0"}},"stream"),c("span",{style:{color:"#E1E4E8"}},"()."),c("span",{style:{color:"#B392F0"}},"filter"),c("span",{style:{color:"#E1E4E8"}},"(item "),c("span",{style:{color:"#F97583"}},"->"),c("span",{style:{color:"#E1E4E8"}}," item."),c("span",{style:{color:"#B392F0"}},"getParentCid"),c("span",{style:{color:"#E1E4E8"}},"()."),c("span",{style:{color:"#B392F0"}},"equals"),c("span",{style:{color:"#E1E4E8"}},"(parent_cid))."),c("span",{style:{color:"#B392F0"}},"collect"),c("span",{style:{color:"#E1E4E8"}},"(Collectors."),c("span",{style:{color:"#B392F0"}},"toList"),c("span",{style:{color:"#E1E4E8"}},"());")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        "),c("span",{style:{color:"#F97583"}},"return"),c("span",{style:{color:"#E1E4E8"}}," collect;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    }")])])]),c("pre",{class:"shiki github-light vp-code-light"},[c("code",null,[c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"/**")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}}," * 抽取业务方法")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}}," *")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}}," * "),c("span",{style:{color:"#D73A49"}},"@return")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}}," */")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#D73A49"}},"private"),c("span",{style:{color:"#24292E"}}," Map"),c("span",{style:{color:"#D73A49"}},"<"),c("span",{style:{color:"#24292E"}},"String, List"),c("span",{style:{color:"#D73A49"}},"<"),c("span",{style:{color:"#24292E"}},"Catalog2Vo"),c("span",{style:{color:"#D73A49"}},">>"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#6F42C1"}},"getDataFromDb"),c("span",{style:{color:"#24292E"}},"() {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#6A737D"}},"//获取缓存")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    String catalogJson "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," stringRedisTemplate."),c("span",{style:{color:"#6F42C1"}},"opsForValue"),c("span",{style:{color:"#24292E"}},"()."),c("span",{style:{color:"#6F42C1"}},"get"),c("span",{style:{color:"#24292E"}},"("),c("span",{style:{color:"#032F62"}},'"catalogJson"'),c("span",{style:{color:"#24292E"}},");")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#D73A49"}},"if"),c("span",{style:{color:"#24292E"}}," ("),c("span",{style:{color:"#D73A49"}},"!"),c("span",{style:{color:"#24292E"}},"StringUtils."),c("span",{style:{color:"#6F42C1"}},"isEmpty"),c("span",{style:{color:"#24292E"}},"(catalogJson)) {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        "),c("span",{style:{color:"#6A737D"}},"//缓存不为空直接返回")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        Map<"),c("span",{style:{color:"#D73A49"}},"String"),c("span",{style:{color:"#24292E"}},", List<"),c("span",{style:{color:"#D73A49"}},"Catalog2Vo"),c("span",{style:{color:"#24292E"}},">> result "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," JSON."),c("span",{style:{color:"#6F42C1"}},"parseObject"),c("span",{style:{color:"#24292E"}},"(catalogJson, "),c("span",{style:{color:"#D73A49"}},"new"),c("span",{style:{color:"#24292E"}}," TypeReference<Map<"),c("span",{style:{color:"#D73A49"}},"String"),c("span",{style:{color:"#24292E"}},", List<"),c("span",{style:{color:"#D73A49"}},"Catalog2Vo"),c("span",{style:{color:"#24292E"}},">>>() {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        });")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        "),c("span",{style:{color:"#D73A49"}},"return"),c("span",{style:{color:"#24292E"}}," result;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    }")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    System.out."),c("span",{style:{color:"#6F42C1"}},"println"),c("span",{style:{color:"#24292E"}},"("),c("span",{style:{color:"#032F62"}},'"查询了数据库。。。"'),c("span",{style:{color:"#24292E"}},");")]),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#6A737D"}},"/**")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"     * 缓存为空，进行查询业务")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"     * 1、将数据库的多次查询变为一次，即方法抽取")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"     */")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#6A737D"}},"//查询所有")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    List<"),c("span",{style:{color:"#D73A49"}},"CategoryEntity"),c("span",{style:{color:"#24292E"}},"> selectList "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," baseMapper."),c("span",{style:{color:"#6F42C1"}},"selectList"),c("span",{style:{color:"#24292E"}},"("),c("span",{style:{color:"#005CC5"}},"null"),c("span",{style:{color:"#24292E"}},");")]),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#6A737D"}},"//1、查出所有1级分类                                   父分类集合，一级分类父分类id为0")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    List<"),c("span",{style:{color:"#D73A49"}},"CategoryEntity"),c("span",{style:{color:"#24292E"}},"> level1Categorys "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#6F42C1"}},"getParent_cid"),c("span",{style:{color:"#24292E"}},"(selectList, "),c("span",{style:{color:"#005CC5"}},"0L"),c("span",{style:{color:"#24292E"}},");")]),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#6A737D"}},"//2、封装数据")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    Map<"),c("span",{style:{color:"#D73A49"}},"String"),c("span",{style:{color:"#24292E"}},", List<"),c("span",{style:{color:"#D73A49"}},"Catalog2Vo"),c("span",{style:{color:"#24292E"}},">> map "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," level1Categorys."),c("span",{style:{color:"#6F42C1"}},"stream"),c("span",{style:{color:"#24292E"}},"()."),c("span",{style:{color:"#6F42C1"}},"collect"),c("span",{style:{color:"#24292E"}},"(Collectors."),c("span",{style:{color:"#6F42C1"}},"toMap"),c("span",{style:{color:"#24292E"}},"(")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"            "),c("span",{style:{color:"#6A737D"}},'//"pCId":"c2{}"')]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"            k "),c("span",{style:{color:"#D73A49"}},"->"),c("span",{style:{color:"#24292E"}}," k."),c("span",{style:{color:"#6F42C1"}},"getCatId"),c("span",{style:{color:"#24292E"}},"()."),c("span",{style:{color:"#6F42C1"}},"toString"),c("span",{style:{color:"#24292E"}},"(),")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"            v "),c("span",{style:{color:"#D73A49"}},"->"),c("span",{style:{color:"#24292E"}}," {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"                "),c("span",{style:{color:"#6A737D"}},"//2.1、每一个的一级分类，查到这个一级分类的[二级分类]")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"                "),c("span",{style:{color:"#6A737D"}},'//得到二级分类实体集合 抽取查询方法-> baseMapper.selectList(new QueryWrapper<CategoryEntity>().eq("parent_cid", v.getCatId()));')]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"                "),c("span",{style:{color:"#6A737D"}},"//todo                                                 父分类集合， 当前分类id（v为当前遍历的一级分类）")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"                List<"),c("span",{style:{color:"#D73A49"}},"CategoryEntity"),c("span",{style:{color:"#24292E"}},"> catalog2Entities "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#6F42C1"}},"getParent_cid"),c("span",{style:{color:"#24292E"}},"(selectList, v."),c("span",{style:{color:"#6F42C1"}},"getCatId"),c("span",{style:{color:"#24292E"}},"());")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"                "),c("span",{style:{color:"#6A737D"}},"//2.2、封装上面的结果")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"                List<"),c("span",{style:{color:"#D73A49"}},"Catalog2Vo"),c("span",{style:{color:"#24292E"}},"> catalog2Vos "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#005CC5"}},"null"),c("span",{style:{color:"#24292E"}},";")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"                "),c("span",{style:{color:"#6A737D"}},"//父分类不为空，即二级分类实体集合不为空")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"                "),c("span",{style:{color:"#D73A49"}},"if"),c("span",{style:{color:"#24292E"}}," (catalog2Entities "),c("span",{style:{color:"#D73A49"}},"!="),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#005CC5"}},"null"),c("span",{style:{color:"#24292E"}},") {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"                    "),c("span",{style:{color:"#6A737D"}},"//遍历拿到每个二级分类集合")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"                    catalog2Vos "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," catalog2Entities."),c("span",{style:{color:"#6F42C1"}},"stream"),c("span",{style:{color:"#24292E"}},"()."),c("span",{style:{color:"#6F42C1"}},"map"),c("span",{style:{color:"#24292E"}},"(l2 "),c("span",{style:{color:"#D73A49"}},"->"),c("span",{style:{color:"#24292E"}}," {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"                        "),c("span",{style:{color:"#6A737D"}},"//封装二级分类vo数据")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"                        Catalog2Vo catalog2Vo "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#D73A49"}},"new"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#6F42C1"}},"Catalog2Vo"),c("span",{style:{color:"#24292E"}},"(v."),c("span",{style:{color:"#6F42C1"}},"getCatId"),c("span",{style:{color:"#24292E"}},"()."),c("span",{style:{color:"#6F42C1"}},"toString"),c("span",{style:{color:"#24292E"}},"(), "),c("span",{style:{color:"#005CC5"}},"null"),c("span",{style:{color:"#24292E"}},", l2."),c("span",{style:{color:"#6F42C1"}},"getCatId"),c("span",{style:{color:"#24292E"}},"()."),c("span",{style:{color:"#6F42C1"}},"toString"),c("span",{style:{color:"#24292E"}},"(), l2."),c("span",{style:{color:"#6F42C1"}},"getName"),c("span",{style:{color:"#24292E"}},"());")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"                        "),c("span",{style:{color:"#6A737D"}},'//2.2.1、找当前二级分类的三级分类封装成vo baseMapper.selectList(new QueryWrapper<CategoryEntity>(). eq("parent_cid", l2.getCatId()));')]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"                        "),c("span",{style:{color:"#6A737D"}},"//                                       （三级分类父分类）父分类集合， 当前分类id（l2为当前遍历的二级分类）")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"                        List<"),c("span",{style:{color:"#D73A49"}},"CategoryEntity"),c("span",{style:{color:"#24292E"}},"> catalog3Entities "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#6F42C1"}},"getParent_cid"),c("span",{style:{color:"#24292E"}},"(selectList, l2."),c("span",{style:{color:"#6F42C1"}},"getCatId"),c("span",{style:{color:"#24292E"}},"());")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"                        List<"),c("span",{style:{color:"#D73A49"}},"Catalog2Vo"),c("span",{style:{color:"#24292E"}},"."),c("span",{style:{color:"#D73A49"}},"Catalog3Vo"),c("span",{style:{color:"#24292E"}},"> catalog3Vos "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#005CC5"}},"null"),c("span",{style:{color:"#24292E"}},";")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"                        "),c("span",{style:{color:"#D73A49"}},"if"),c("span",{style:{color:"#24292E"}}," (catalog3Entities "),c("span",{style:{color:"#D73A49"}},"!="),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#005CC5"}},"null"),c("span",{style:{color:"#24292E"}},") {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"                            catalog3Vos "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," catalog3Entities."),c("span",{style:{color:"#6F42C1"}},"stream"),c("span",{style:{color:"#24292E"}},"()."),c("span",{style:{color:"#6F42C1"}},"map"),c("span",{style:{color:"#24292E"}},"(l3 "),c("span",{style:{color:"#D73A49"}},"->"),c("span",{style:{color:"#24292E"}}," {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"                                "),c("span",{style:{color:"#6A737D"}},"//2.2.2、封装成指定格式")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"                                Catalog2Vo.Catalog3Vo catalog3Vo "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#D73A49"}},"new"),c("span",{style:{color:"#24292E"}}," Catalog2Vo."),c("span",{style:{color:"#6F42C1"}},"Catalog3Vo"),c("span",{style:{color:"#24292E"}},"(l2."),c("span",{style:{color:"#6F42C1"}},"getCatId"),c("span",{style:{color:"#24292E"}},"()."),c("span",{style:{color:"#6F42C1"}},"toString"),c("span",{style:{color:"#24292E"}},"(), l3."),c("span",{style:{color:"#6F42C1"}},"getCatId"),c("span",{style:{color:"#24292E"}},"()."),c("span",{style:{color:"#6F42C1"}},"toString"),c("span",{style:{color:"#24292E"}},"(), l3."),c("span",{style:{color:"#6F42C1"}},"getName"),c("span",{style:{color:"#24292E"}},"());")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"                                "),c("span",{style:{color:"#D73A49"}},"return"),c("span",{style:{color:"#24292E"}}," catalog3Vo;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"                            })."),c("span",{style:{color:"#6F42C1"}},"collect"),c("span",{style:{color:"#24292E"}},"(Collectors."),c("span",{style:{color:"#6F42C1"}},"toList"),c("span",{style:{color:"#24292E"}},"());")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"                            catalog2Vo."),c("span",{style:{color:"#6F42C1"}},"setCatalog3List"),c("span",{style:{color:"#24292E"}},"(catalog3Vos);")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"                        }")]),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"                        "),c("span",{style:{color:"#D73A49"}},"return"),c("span",{style:{color:"#24292E"}}," catalog2Vo;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"                    })."),c("span",{style:{color:"#6F42C1"}},"collect"),c("span",{style:{color:"#24292E"}},"(Collectors."),c("span",{style:{color:"#6F42C1"}},"toList"),c("span",{style:{color:"#24292E"}},"());")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"                }")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"                "),c("span",{style:{color:"#D73A49"}},"return"),c("span",{style:{color:"#24292E"}}," catalog2Vos;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"            }));")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#6A737D"}},"//todo 3、查到的数据再放入缓存，将对象转为json放入缓存中")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    String s "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," JSON."),c("span",{style:{color:"#6F42C1"}},"toJSONString"),c("span",{style:{color:"#24292E"}},"(map);")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#6A737D"}},"//将数据放入缓存")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    stringRedisTemplate."),c("span",{style:{color:"#6F42C1"}},"opsForValue"),c("span",{style:{color:"#24292E"}},"()."),c("span",{style:{color:"#6F42C1"}},"set"),c("span",{style:{color:"#24292E"}},"("),c("span",{style:{color:"#032F62"}},'"catalogJson"'),c("span",{style:{color:"#24292E"}},", s, "),c("span",{style:{color:"#005CC5"}},"1"),c("span",{style:{color:"#24292E"}},", TimeUnit.DAYS);")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#6A737D"}},"//将数据库查到的结果直接返回，即将数据库查到的结果放一份到缓存中并返回")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#D73A49"}},"return"),c("span",{style:{color:"#24292E"}}," map;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"}")]),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"/**")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"     * 抽取获取父分类id的查询方法，优化三级分类数据获取，使得在压力测试中吞吐量有明显的提高；")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"     * 查询数据库是影响吞吐量高低的重要因素之一，因此尽量减少数据库的查询")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"     *")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"     * "),c("span",{style:{color:"#D73A49"}},"@param"),c("span",{style:{color:"#6A737D"}}," "),c("span",{style:{color:"#E36209"}},"selectList")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"     * "),c("span",{style:{color:"#D73A49"}},"@param"),c("span",{style:{color:"#6A737D"}}," "),c("span",{style:{color:"#E36209"}},"parent_cid")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"     * "),c("span",{style:{color:"#D73A49"}},"@return")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"     */")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#D73A49"}},"private"),c("span",{style:{color:"#24292E"}}," List"),c("span",{style:{color:"#D73A49"}},"<"),c("span",{style:{color:"#24292E"}},"CategoryEntity"),c("span",{style:{color:"#D73A49"}},">"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#6F42C1"}},"getParent_cid"),c("span",{style:{color:"#24292E"}},"(List"),c("span",{style:{color:"#D73A49"}},"<"),c("span",{style:{color:"#24292E"}},"CategoryEntity"),c("span",{style:{color:"#D73A49"}},">"),c("span",{style:{color:"#24292E"}}," selectList, Long parent_cid) {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        "),c("span",{style:{color:"#6A737D"}},'//return baseMapper.selectList(new QueryWrapper<CategoryEntity>().eq("parent_cid", v.getCatId()));')]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        "),c("span",{style:{color:"#6A737D"}},"//直接进行过滤得到当前遍历的父分类id为传入的父分类id")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        List<"),c("span",{style:{color:"#D73A49"}},"CategoryEntity"),c("span",{style:{color:"#24292E"}},"> collect "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," selectList."),c("span",{style:{color:"#6F42C1"}},"stream"),c("span",{style:{color:"#24292E"}},"()."),c("span",{style:{color:"#6F42C1"}},"filter"),c("span",{style:{color:"#24292E"}},"(item "),c("span",{style:{color:"#D73A49"}},"->"),c("span",{style:{color:"#24292E"}}," item."),c("span",{style:{color:"#6F42C1"}},"getParentCid"),c("span",{style:{color:"#24292E"}},"()."),c("span",{style:{color:"#6F42C1"}},"equals"),c("span",{style:{color:"#24292E"}},"(parent_cid))."),c("span",{style:{color:"#6F42C1"}},"collect"),c("span",{style:{color:"#24292E"}},"(Collectors."),c("span",{style:{color:"#6F42C1"}},"toList"),c("span",{style:{color:"#24292E"}},"());")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        "),c("span",{style:{color:"#D73A49"}},"return"),c("span",{style:{color:"#24292E"}}," collect;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    }")])])])],-1),_n=c("ul",null,[c("li",null,"使用本地锁")],-1),Rn=c("div",{class:"language-java"},[c("button",{title:"Copy Code",class:"copy"}),c("span",{class:"lang"},"java"),c("pre",{class:"shiki github-dark vp-code-dark"},[c("code",null,[c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"/**")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"     * 使用redis缓存的同时使用本地锁（同步锁）来执行业务")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"     *")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"     * "),c("span",{style:{color:"#F97583"}},"@return")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"     */")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#F97583"}},"public"),c("span",{style:{color:"#E1E4E8"}}," Map"),c("span",{style:{color:"#F97583"}},"<"),c("span",{style:{color:"#E1E4E8"}},"String, List"),c("span",{style:{color:"#F97583"}},"<"),c("span",{style:{color:"#E1E4E8"}},"Catalog2Vo"),c("span",{style:{color:"#F97583"}},">>"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#B392F0"}},"getCatalogJsonFromDbWithLocalLock"),c("span",{style:{color:"#E1E4E8"}},"() {")]),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        "),c("span",{style:{color:"#6A737D"}},"//如果缓存中有就用缓存的")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},'//        Map<String, List<Catalog2Vo>> catalogJson = (Map<String, List<Catalog2Vo>>) cache.get("catalogJson");')]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},'//        if (catalogJson.get("catalogJson") == null){')]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"//            //调用业务xxx")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"//            //返回数据又放入缓存")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},'//            cache.put("catalogJson", parent_cid);')]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"//        }")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"//        return catalogJson;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        "),c("span",{style:{color:"#6A737D"}},"//只要是同一把锁，就能锁住需要的这个锁的所有线程")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        "),c("span",{style:{color:"#6A737D"}},"//1、synchronized (this):SpringBoot所有的组件在容器中都是单例的")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        "),c("span",{style:{color:"#6A737D"}},"//todo 本地锁synchronized，JUC(Lock)，在分布式情况下，想要锁住所有，必须使用分布式锁")]),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        "),c("span",{style:{color:"#6A737D"}},"//单实例的加锁，即本地锁只能锁住当前进程")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        "),c("span",{style:{color:"#F97583"}},"synchronized"),c("span",{style:{color:"#E1E4E8"}}," ("),c("span",{style:{color:"#79B8FF"}},"this"),c("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"            "),c("span",{style:{color:"#6A737D"}},"//得到锁以后，我们应该再去缓存中确定一次，如果没有才需要继续查询")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"            "),c("span",{style:{color:"#F97583"}},"return"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#B392F0"}},"getDataFromDb"),c("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        }")]),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    }")])])]),c("pre",{class:"shiki github-light vp-code-light"},[c("code",null,[c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"/**")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"     * 使用redis缓存的同时使用本地锁（同步锁）来执行业务")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"     *")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"     * "),c("span",{style:{color:"#D73A49"}},"@return")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"     */")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#D73A49"}},"public"),c("span",{style:{color:"#24292E"}}," Map"),c("span",{style:{color:"#D73A49"}},"<"),c("span",{style:{color:"#24292E"}},"String, List"),c("span",{style:{color:"#D73A49"}},"<"),c("span",{style:{color:"#24292E"}},"Catalog2Vo"),c("span",{style:{color:"#D73A49"}},">>"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#6F42C1"}},"getCatalogJsonFromDbWithLocalLock"),c("span",{style:{color:"#24292E"}},"() {")]),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        "),c("span",{style:{color:"#6A737D"}},"//如果缓存中有就用缓存的")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},'//        Map<String, List<Catalog2Vo>> catalogJson = (Map<String, List<Catalog2Vo>>) cache.get("catalogJson");')]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},'//        if (catalogJson.get("catalogJson") == null){')]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"//            //调用业务xxx")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"//            //返回数据又放入缓存")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},'//            cache.put("catalogJson", parent_cid);')]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"//        }")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"//        return catalogJson;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        "),c("span",{style:{color:"#6A737D"}},"//只要是同一把锁，就能锁住需要的这个锁的所有线程")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        "),c("span",{style:{color:"#6A737D"}},"//1、synchronized (this):SpringBoot所有的组件在容器中都是单例的")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        "),c("span",{style:{color:"#6A737D"}},"//todo 本地锁synchronized，JUC(Lock)，在分布式情况下，想要锁住所有，必须使用分布式锁")]),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        "),c("span",{style:{color:"#6A737D"}},"//单实例的加锁，即本地锁只能锁住当前进程")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        "),c("span",{style:{color:"#D73A49"}},"synchronized"),c("span",{style:{color:"#24292E"}}," ("),c("span",{style:{color:"#005CC5"}},"this"),c("span",{style:{color:"#24292E"}},") {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"            "),c("span",{style:{color:"#6A737D"}},"//得到锁以后，我们应该再去缓存中确定一次，如果没有才需要继续查询")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"            "),c("span",{style:{color:"#D73A49"}},"return"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#6F42C1"}},"getDataFromDb"),c("span",{style:{color:"#24292E"}},"();")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        }")]),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    }")])])])],-1),Tn={id:"锁-时序问题",tabindex:"-1"},jn=c("figure",null,[c("img",{src:"https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230410193041285.png",alt:"image-20230410193041285",loading:"lazy",decoding:"async"})],-1),On={id:"_2、分布式锁演进",tabindex:"-1"},xn={id:"分布式锁演进-基本原理",tabindex:"-1"},Vn=c("figure",null,[c("img",{src:"https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230410193221079.png",alt:"image-20230410193221079",loading:"lazy",decoding:"async"})],-1),zn=c("blockquote",null,[c("p",null,"我们可以同时去一个地方“占坑”，如果占到，就执行逻辑。否则就必须等待，直到释放锁。 “占坑”可以去redis，可以去数据库，可以去任何大家都能访问的地方。 等待可以自旋的方式。")],-1),wn={id:"分布式锁演进-阶段一",tabindex:"-1"},Mn=c("figure",null,[c("img",{src:"https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230410193430589.png",alt:"image-20230410193430589",loading:"lazy",decoding:"async"})],-1),Un=c("div",{class:"language-java"},[c("button",{title:"Copy Code",class:"copy"}),c("span",{class:"lang"},"java"),c("pre",{class:"shiki github-dark vp-code-dark"},[c("code",null,[c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"Boolean lock "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," redisTemplate."),c("span",{style:{color:"#B392F0"}},"opsForValue"),c("span",{style:{color:"#E1E4E8"}},"()."),c("span",{style:{color:"#B392F0"}},"setIfAbsent"),c("span",{style:{color:"#E1E4E8"}},"("),c("span",{style:{color:"#9ECBFF"}},'"lock"'),c("span",{style:{color:"#E1E4E8"}},", "),c("span",{style:{color:"#9ECBFF"}},'"0"'),c("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        "),c("span",{style:{color:"#F97583"}},"if"),c("span",{style:{color:"#E1E4E8"}}," (lock) {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"            "),c("span",{style:{color:"#6A737D"}},"// 加锁成功..执行业务")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"            Map<"),c("span",{style:{color:"#F97583"}},"String"),c("span",{style:{color:"#E1E4E8"}},",List<"),c("span",{style:{color:"#F97583"}},"Catelog2Vo"),c("span",{style:{color:"#E1E4E8"}},">> dataFromDb "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#B392F0"}},"getDataFromDB"),c("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"            redisTemplate."),c("span",{style:{color:"#B392F0"}},"delete"),c("span",{style:{color:"#E1E4E8"}},"("),c("span",{style:{color:"#9ECBFF"}},'"lock"'),c("span",{style:{color:"#E1E4E8"}},"); "),c("span",{style:{color:"#6A737D"}},"// 删除锁")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"            "),c("span",{style:{color:"#F97583"}},"return"),c("span",{style:{color:"#E1E4E8"}}," dataFromDb;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        } "),c("span",{style:{color:"#F97583"}},"else"),c("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"            "),c("span",{style:{color:"#6A737D"}},"// 加锁失败，重试 synchronized()")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"            "),c("span",{style:{color:"#6A737D"}},"// 休眠100ms重试")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"            "),c("span",{style:{color:"#F97583"}},"return"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#B392F0"}},"getCatelogJsonFromDbWithRedisLock"),c("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        }")])])]),c("pre",{class:"shiki github-light vp-code-light"},[c("code",null,[c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"Boolean lock "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," redisTemplate."),c("span",{style:{color:"#6F42C1"}},"opsForValue"),c("span",{style:{color:"#24292E"}},"()."),c("span",{style:{color:"#6F42C1"}},"setIfAbsent"),c("span",{style:{color:"#24292E"}},"("),c("span",{style:{color:"#032F62"}},'"lock"'),c("span",{style:{color:"#24292E"}},", "),c("span",{style:{color:"#032F62"}},'"0"'),c("span",{style:{color:"#24292E"}},");")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        "),c("span",{style:{color:"#D73A49"}},"if"),c("span",{style:{color:"#24292E"}}," (lock) {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"            "),c("span",{style:{color:"#6A737D"}},"// 加锁成功..执行业务")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"            Map<"),c("span",{style:{color:"#D73A49"}},"String"),c("span",{style:{color:"#24292E"}},",List<"),c("span",{style:{color:"#D73A49"}},"Catelog2Vo"),c("span",{style:{color:"#24292E"}},">> dataFromDb "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#6F42C1"}},"getDataFromDB"),c("span",{style:{color:"#24292E"}},"();")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"            redisTemplate."),c("span",{style:{color:"#6F42C1"}},"delete"),c("span",{style:{color:"#24292E"}},"("),c("span",{style:{color:"#032F62"}},'"lock"'),c("span",{style:{color:"#24292E"}},"); "),c("span",{style:{color:"#6A737D"}},"// 删除锁")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"            "),c("span",{style:{color:"#D73A49"}},"return"),c("span",{style:{color:"#24292E"}}," dataFromDb;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        } "),c("span",{style:{color:"#D73A49"}},"else"),c("span",{style:{color:"#24292E"}}," {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"            "),c("span",{style:{color:"#6A737D"}},"// 加锁失败，重试 synchronized()")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"            "),c("span",{style:{color:"#6A737D"}},"// 休眠100ms重试")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"            "),c("span",{style:{color:"#D73A49"}},"return"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#6F42C1"}},"getCatelogJsonFromDbWithRedisLock"),c("span",{style:{color:"#24292E"}},"();")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        }")])])])],-1),Jn={id:"分布式锁演进-阶段二",tabindex:"-1"},Pn=c("figure",null,[c("img",{src:"https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230410193552631.png",alt:"image-20230410193552631",loading:"lazy",decoding:"async"})],-1),Kn=c("div",{class:"language-java"},[c("button",{title:"Copy Code",class:"copy"}),c("span",{class:"lang"},"java"),c("pre",{class:"shiki github-dark vp-code-dark"},[c("code",null,[c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"Boolean lock "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," redisTemplate."),c("span",{style:{color:"#B392F0"}},"opsForValue"),c("span",{style:{color:"#E1E4E8"}},"()."),c("span",{style:{color:"#B392F0"}},"setIfAbsent"),c("span",{style:{color:"#E1E4E8"}},"()")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        "),c("span",{style:{color:"#F97583"}},"if"),c("span",{style:{color:"#E1E4E8"}}," (lock) {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"            "),c("span",{style:{color:"#6A737D"}},"// 加锁成功..执行业务")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"            "),c("span",{style:{color:"#6A737D"}},"// 设置过期时间")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"            redisTemplate."),c("span",{style:{color:"#B392F0"}},"expire"),c("span",{style:{color:"#E1E4E8"}},"("),c("span",{style:{color:"#9ECBFF"}},'"lock"'),c("span",{style:{color:"#E1E4E8"}},","),c("span",{style:{color:"#79B8FF"}},"30"),c("span",{style:{color:"#E1E4E8"}},",TimeUnit.SECONDS);")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"            Map<"),c("span",{style:{color:"#F97583"}},"String"),c("span",{style:{color:"#E1E4E8"}},",List<"),c("span",{style:{color:"#F97583"}},"Catelog2Vo"),c("span",{style:{color:"#E1E4E8"}},">> dataFromDb "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#B392F0"}},"getDataFromDB"),c("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"            redisTemplate."),c("span",{style:{color:"#B392F0"}},"delete"),c("span",{style:{color:"#E1E4E8"}},"("),c("span",{style:{color:"#9ECBFF"}},'"lock"'),c("span",{style:{color:"#E1E4E8"}},"); "),c("span",{style:{color:"#6A737D"}},"// 删除锁")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"            "),c("span",{style:{color:"#F97583"}},"return"),c("span",{style:{color:"#E1E4E8"}}," dataFromDb;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        } "),c("span",{style:{color:"#F97583"}},"else"),c("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"            "),c("span",{style:{color:"#6A737D"}},"// 加锁失败，重试 synchronized()")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"            "),c("span",{style:{color:"#6A737D"}},"// 休眠100ms重试")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"            "),c("span",{style:{color:"#F97583"}},"return"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#B392F0"}},"getCatelogJsonFromDbWithRedisLock"),c("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        }")])])]),c("pre",{class:"shiki github-light vp-code-light"},[c("code",null,[c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"Boolean lock "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," redisTemplate."),c("span",{style:{color:"#6F42C1"}},"opsForValue"),c("span",{style:{color:"#24292E"}},"()."),c("span",{style:{color:"#6F42C1"}},"setIfAbsent"),c("span",{style:{color:"#24292E"}},"()")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        "),c("span",{style:{color:"#D73A49"}},"if"),c("span",{style:{color:"#24292E"}}," (lock) {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"            "),c("span",{style:{color:"#6A737D"}},"// 加锁成功..执行业务")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"            "),c("span",{style:{color:"#6A737D"}},"// 设置过期时间")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"            redisTemplate."),c("span",{style:{color:"#6F42C1"}},"expire"),c("span",{style:{color:"#24292E"}},"("),c("span",{style:{color:"#032F62"}},'"lock"'),c("span",{style:{color:"#24292E"}},","),c("span",{style:{color:"#005CC5"}},"30"),c("span",{style:{color:"#24292E"}},",TimeUnit.SECONDS);")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"            Map<"),c("span",{style:{color:"#D73A49"}},"String"),c("span",{style:{color:"#24292E"}},",List<"),c("span",{style:{color:"#D73A49"}},"Catelog2Vo"),c("span",{style:{color:"#24292E"}},">> dataFromDb "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#6F42C1"}},"getDataFromDB"),c("span",{style:{color:"#24292E"}},"();")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"            redisTemplate."),c("span",{style:{color:"#6F42C1"}},"delete"),c("span",{style:{color:"#24292E"}},"("),c("span",{style:{color:"#032F62"}},'"lock"'),c("span",{style:{color:"#24292E"}},"); "),c("span",{style:{color:"#6A737D"}},"// 删除锁")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"            "),c("span",{style:{color:"#D73A49"}},"return"),c("span",{style:{color:"#24292E"}}," dataFromDb;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        } "),c("span",{style:{color:"#D73A49"}},"else"),c("span",{style:{color:"#24292E"}}," {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"            "),c("span",{style:{color:"#6A737D"}},"// 加锁失败，重试 synchronized()")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"            "),c("span",{style:{color:"#6A737D"}},"// 休眠100ms重试")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"            "),c("span",{style:{color:"#D73A49"}},"return"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#6F42C1"}},"getCatelogJsonFromDbWithRedisLock"),c("span",{style:{color:"#24292E"}},"();")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        }")])])])],-1),qn={id:"分布式锁演进-阶段三",tabindex:"-1"},Nn=c("figure",null,[c("img",{src:"https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230410193625611.png",alt:"image-20230410193625611",loading:"lazy",decoding:"async"})],-1),Wn=c("div",{class:"language-java"},[c("button",{title:"Copy Code",class:"copy"}),c("span",{class:"lang"},"java"),c("pre",{class:"shiki github-dark vp-code-dark"},[c("code",null,[c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"// 设置值同时设置过期时间")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"Boolean lock "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," redisTemplate."),c("span",{style:{color:"#B392F0"}},"opsForValue"),c("span",{style:{color:"#E1E4E8"}},"()."),c("span",{style:{color:"#B392F0"}},"setIfAbsent"),c("span",{style:{color:"#E1E4E8"}},"("),c("span",{style:{color:"#9ECBFF"}},'"lock"'),c("span",{style:{color:"#E1E4E8"}},","),c("span",{style:{color:"#9ECBFF"}},'"111"'),c("span",{style:{color:"#E1E4E8"}},","),c("span",{style:{color:"#79B8FF"}},"300"),c("span",{style:{color:"#E1E4E8"}},",TimeUnit.SECONDS);")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#F97583"}},"if"),c("span",{style:{color:"#E1E4E8"}}," (lock) {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#6A737D"}},"// 加锁成功..执行业务")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#6A737D"}},"// 设置过期时间,必须和加锁是同步的，原子的")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    redisTemplate."),c("span",{style:{color:"#B392F0"}},"expire"),c("span",{style:{color:"#E1E4E8"}},"("),c("span",{style:{color:"#9ECBFF"}},'"lock"'),c("span",{style:{color:"#E1E4E8"}},","),c("span",{style:{color:"#79B8FF"}},"30"),c("span",{style:{color:"#E1E4E8"}},",TimeUnit.SECONDS);")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    Map<"),c("span",{style:{color:"#F97583"}},"String"),c("span",{style:{color:"#E1E4E8"}},",List<"),c("span",{style:{color:"#F97583"}},"Catelog2Vo"),c("span",{style:{color:"#E1E4E8"}},">> dataFromDb "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#B392F0"}},"getDataFromDB"),c("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    redisTemplate."),c("span",{style:{color:"#B392F0"}},"delete"),c("span",{style:{color:"#E1E4E8"}},"("),c("span",{style:{color:"#9ECBFF"}},'"lock"'),c("span",{style:{color:"#E1E4E8"}},"); "),c("span",{style:{color:"#6A737D"}},"// 删除锁")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#F97583"}},"return"),c("span",{style:{color:"#E1E4E8"}}," dataFromDb;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"} "),c("span",{style:{color:"#F97583"}},"else"),c("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#6A737D"}},"// 加锁失败，重试 synchronized()")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#6A737D"}},"// 休眠100ms重试")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#F97583"}},"return"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#B392F0"}},"getCatelogJsonFromDbWithRedisLock"),c("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"}")])])]),c("pre",{class:"shiki github-light vp-code-light"},[c("code",null,[c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"// 设置值同时设置过期时间")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"Boolean lock "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," redisTemplate."),c("span",{style:{color:"#6F42C1"}},"opsForValue"),c("span",{style:{color:"#24292E"}},"()."),c("span",{style:{color:"#6F42C1"}},"setIfAbsent"),c("span",{style:{color:"#24292E"}},"("),c("span",{style:{color:"#032F62"}},'"lock"'),c("span",{style:{color:"#24292E"}},","),c("span",{style:{color:"#032F62"}},'"111"'),c("span",{style:{color:"#24292E"}},","),c("span",{style:{color:"#005CC5"}},"300"),c("span",{style:{color:"#24292E"}},",TimeUnit.SECONDS);")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#D73A49"}},"if"),c("span",{style:{color:"#24292E"}}," (lock) {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#6A737D"}},"// 加锁成功..执行业务")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#6A737D"}},"// 设置过期时间,必须和加锁是同步的，原子的")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    redisTemplate."),c("span",{style:{color:"#6F42C1"}},"expire"),c("span",{style:{color:"#24292E"}},"("),c("span",{style:{color:"#032F62"}},'"lock"'),c("span",{style:{color:"#24292E"}},","),c("span",{style:{color:"#005CC5"}},"30"),c("span",{style:{color:"#24292E"}},",TimeUnit.SECONDS);")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    Map<"),c("span",{style:{color:"#D73A49"}},"String"),c("span",{style:{color:"#24292E"}},",List<"),c("span",{style:{color:"#D73A49"}},"Catelog2Vo"),c("span",{style:{color:"#24292E"}},">> dataFromDb "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#6F42C1"}},"getDataFromDB"),c("span",{style:{color:"#24292E"}},"();")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    redisTemplate."),c("span",{style:{color:"#6F42C1"}},"delete"),c("span",{style:{color:"#24292E"}},"("),c("span",{style:{color:"#032F62"}},'"lock"'),c("span",{style:{color:"#24292E"}},"); "),c("span",{style:{color:"#6A737D"}},"// 删除锁")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#D73A49"}},"return"),c("span",{style:{color:"#24292E"}}," dataFromDb;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"} "),c("span",{style:{color:"#D73A49"}},"else"),c("span",{style:{color:"#24292E"}}," {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#6A737D"}},"// 加锁失败，重试 synchronized()")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#6A737D"}},"// 休眠100ms重试")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#D73A49"}},"return"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#6F42C1"}},"getCatelogJsonFromDbWithRedisLock"),c("span",{style:{color:"#24292E"}},"();")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"}")])])])],-1),Hn={id:"分布式锁演进-阶段四",tabindex:"-1"},Gn=c("figure",null,[c("img",{src:"https://jsd.cdn.zzko.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230410193648301.png",alt:"image-20230410193648301",loading:"lazy",decoding:"async"})],-1),Xn=c("div",{class:"language-java"},[c("button",{title:"Copy Code",class:"copy"}),c("span",{class:"lang"},"java"),c("pre",{class:"shiki github-dark vp-code-dark"},[c("code",null,[c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"String uuid "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," UUID."),c("span",{style:{color:"#B392F0"}},"randomUUID"),c("span",{style:{color:"#E1E4E8"}},"()."),c("span",{style:{color:"#B392F0"}},"toString"),c("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        "),c("span",{style:{color:"#6A737D"}},"// 设置值同时设置过期时间")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        Boolean lock "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," redisTemplate."),c("span",{style:{color:"#B392F0"}},"opsForValue"),c("span",{style:{color:"#E1E4E8"}},"()."),c("span",{style:{color:"#B392F0"}},"setIfAbsent"),c("span",{style:{color:"#E1E4E8"}},"("),c("span",{style:{color:"#9ECBFF"}},'"lock"'),c("span",{style:{color:"#E1E4E8"}},",uuid,"),c("span",{style:{color:"#79B8FF"}},"300"),c("span",{style:{color:"#E1E4E8"}},",TimeUnit.SECONDS);")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        "),c("span",{style:{color:"#F97583"}},"if"),c("span",{style:{color:"#E1E4E8"}}," (lock) {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"            "),c("span",{style:{color:"#6A737D"}},"// 加锁成功..执行业务")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"            "),c("span",{style:{color:"#6A737D"}},"// 设置过期时间,必须和加锁是同步的，原子的")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},'//            redisTemplate.expire("lock",30,TimeUnit.SECONDS);')]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"            Map<"),c("span",{style:{color:"#F97583"}},"String"),c("span",{style:{color:"#E1E4E8"}},",List<"),c("span",{style:{color:"#F97583"}},"Catelog2Vo"),c("span",{style:{color:"#E1E4E8"}},">> dataFromDb "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#B392F0"}},"getDataFromDB"),c("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},'//            String lockValue = redisTemplate.opsForValue().get("lock");')]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"//            if (lockValue.equals(uuid)) {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"//                // 删除我自己的锁")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},'//                redisTemplate.delete("lock"); // 删除锁')]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"//            }")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"// 通过使用lua脚本进行原子性删除")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"            String script "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#9ECBFF"}},"\"if redis.call('get',KEYS[1]) == ARGV[1] then return redis.call('del',KEYS[1]) else return 0 end\""),c("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"                "),c("span",{style:{color:"#6A737D"}},"//删除锁")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"                Long lock1 "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," redisTemplate."),c("span",{style:{color:"#B392F0"}},"execute"),c("span",{style:{color:"#E1E4E8"}},"("),c("span",{style:{color:"#F97583"}},"new"),c("span",{style:{color:"#E1E4E8"}}," DefaultRedisScript<"),c("span",{style:{color:"#F97583"}},"Long"),c("span",{style:{color:"#E1E4E8"}},">(script, Long.class), Arrays."),c("span",{style:{color:"#B392F0"}},"asList"),c("span",{style:{color:"#E1E4E8"}},"("),c("span",{style:{color:"#9ECBFF"}},'"lock"'),c("span",{style:{color:"#E1E4E8"}},"), uuid);")]),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"            "),c("span",{style:{color:"#F97583"}},"return"),c("span",{style:{color:"#E1E4E8"}}," dataFromDb;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        } "),c("span",{style:{color:"#F97583"}},"else"),c("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"            "),c("span",{style:{color:"#6A737D"}},"// 加锁失败，重试 synchronized()")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"            "),c("span",{style:{color:"#6A737D"}},"// 休眠100ms重试")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"            "),c("span",{style:{color:"#F97583"}},"return"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#B392F0"}},"getCatelogJsonFromDbWithRedisLock"),c("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        }")])])]),c("pre",{class:"shiki github-light vp-code-light"},[c("code",null,[c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"String uuid "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," UUID."),c("span",{style:{color:"#6F42C1"}},"randomUUID"),c("span",{style:{color:"#24292E"}},"()."),c("span",{style:{color:"#6F42C1"}},"toString"),c("span",{style:{color:"#24292E"}},"();")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        "),c("span",{style:{color:"#6A737D"}},"// 设置值同时设置过期时间")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        Boolean lock "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," redisTemplate."),c("span",{style:{color:"#6F42C1"}},"opsForValue"),c("span",{style:{color:"#24292E"}},"()."),c("span",{style:{color:"#6F42C1"}},"setIfAbsent"),c("span",{style:{color:"#24292E"}},"("),c("span",{style:{color:"#032F62"}},'"lock"'),c("span",{style:{color:"#24292E"}},",uuid,"),c("span",{style:{color:"#005CC5"}},"300"),c("span",{style:{color:"#24292E"}},",TimeUnit.SECONDS);")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        "),c("span",{style:{color:"#D73A49"}},"if"),c("span",{style:{color:"#24292E"}}," (lock) {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"            "),c("span",{style:{color:"#6A737D"}},"// 加锁成功..执行业务")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"            "),c("span",{style:{color:"#6A737D"}},"// 设置过期时间,必须和加锁是同步的，原子的")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},'//            redisTemplate.expire("lock",30,TimeUnit.SECONDS);')]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"            Map<"),c("span",{style:{color:"#D73A49"}},"String"),c("span",{style:{color:"#24292E"}},",List<"),c("span",{style:{color:"#D73A49"}},"Catelog2Vo"),c("span",{style:{color:"#24292E"}},">> dataFromDb "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#6F42C1"}},"getDataFromDB"),c("span",{style:{color:"#24292E"}},"();")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},'//            String lockValue = redisTemplate.opsForValue().get("lock");')]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"//            if (lockValue.equals(uuid)) {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"//                // 删除我自己的锁")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},'//                redisTemplate.delete("lock"); // 删除锁')]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"//            }")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"// 通过使用lua脚本进行原子性删除")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"            String script "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#032F62"}},"\"if redis.call('get',KEYS[1]) == ARGV[1] then return redis.call('del',KEYS[1]) else return 0 end\""),c("span",{style:{color:"#24292E"}},";")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"                "),c("span",{style:{color:"#6A737D"}},"//删除锁")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"                Long lock1 "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," redisTemplate."),c("span",{style:{color:"#6F42C1"}},"execute"),c("span",{style:{color:"#24292E"}},"("),c("span",{style:{color:"#D73A49"}},"new"),c("span",{style:{color:"#24292E"}}," DefaultRedisScript<"),c("span",{style:{color:"#D73A49"}},"Long"),c("span",{style:{color:"#24292E"}},">(script, Long.class), Arrays."),c("span",{style:{color:"#6F42C1"}},"asList"),c("span",{style:{color:"#24292E"}},"("),c("span",{style:{color:"#032F62"}},'"lock"'),c("span",{style:{color:"#24292E"}},"), uuid);")]),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"            "),c("span",{style:{color:"#D73A49"}},"return"),c("span",{style:{color:"#24292E"}}," dataFromDb;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        } "),c("span",{style:{color:"#D73A49"}},"else"),c("span",{style:{color:"#24292E"}}," {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"            "),c("span",{style:{color:"#6A737D"}},"// 加锁失败，重试 synchronized()")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"            "),c("span",{style:{color:"#6A737D"}},"// 休眠100ms重试")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"            "),c("span",{style:{color:"#D73A49"}},"return"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#6F42C1"}},"getCatelogJsonFromDbWithRedisLock"),c("span",{style:{color:"#24292E"}},"();")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        }")])])])],-1),Qn={id:"分布式锁演进-阶段五-最终形态",tabindex:"-1"},$n=c("figure",null,[c("img",{src:"https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230410193719776.png",alt:"image-20230410193719776",loading:"lazy",decoding:"async"})],-1),Yn=c("ul",null,[c("li",null,[c("code",null,"org.klaus.zgg01mall.product.service.impl.CategoryServiceImpl#getCatalogJsonFromDbWithRedisLock")])],-1),Zn=c("div",{class:"language-java"},[c("button",{title:"Copy Code",class:"copy"}),c("span",{class:"lang"},"java"),c("pre",{class:"shiki github-dark vp-code-dark"},[c("code",null,[c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"/**")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"     * 使用redis分布式锁来执行业务（luo脚本解锁）")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"     *")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"     * "),c("span",{style:{color:"#F97583"}},"@return")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"     */")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#6A737D"}},"//@Override")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#F97583"}},"public"),c("span",{style:{color:"#E1E4E8"}}," Map"),c("span",{style:{color:"#F97583"}},"<"),c("span",{style:{color:"#E1E4E8"}},"String, List"),c("span",{style:{color:"#F97583"}},"<"),c("span",{style:{color:"#E1E4E8"}},"Catalog2Vo"),c("span",{style:{color:"#F97583"}},">>"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#B392F0"}},"getCatalogJsonFromDbWithRedisLock"),c("span",{style:{color:"#E1E4E8"}},"() {")]),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        "),c("span",{style:{color:"#6A737D"}},"//抢占锁前，每人都获取唯一id设置成lock的value值")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        String uuid "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," UUID."),c("span",{style:{color:"#B392F0"}},"randomUUID"),c("span",{style:{color:"#E1E4E8"}},"()."),c("span",{style:{color:"#B392F0"}},"toString"),c("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        "),c("span",{style:{color:"#6A737D"}},"//1、占分布式锁，去redis占坑(原子操作)  SET  lock(k)  1111(v)     NX                        EX(时间不能太短)")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        Boolean lock "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," stringRedisTemplate."),c("span",{style:{color:"#B392F0"}},"opsForValue"),c("span",{style:{color:"#E1E4E8"}},"()."),c("span",{style:{color:"#B392F0"}},"setIfAbsent"),c("span",{style:{color:"#E1E4E8"}},"("),c("span",{style:{color:"#9ECBFF"}},'"lock"'),c("span",{style:{color:"#E1E4E8"}},", uuid, "),c("span",{style:{color:"#79B8FF"}},"300"),c("span",{style:{color:"#E1E4E8"}},", TimeUnit.SECONDS);")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        "),c("span",{style:{color:"#F97583"}},"if"),c("span",{style:{color:"#E1E4E8"}}," (lock) {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"            System.out."),c("span",{style:{color:"#B392F0"}},"println"),c("span",{style:{color:"#E1E4E8"}},"("),c("span",{style:{color:"#9ECBFF"}},'"获取分布式锁成功......."'),c("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"            "),c("span",{style:{color:"#6A737D"}},"//2、设置过期时间，防止出现死锁情况(若突然断电而无法执行设置过期时间)")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"            "),c("span",{style:{color:"#6A737D"}},"//因此设置过期时间，必须和加锁是同步的，原子的")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"            "),c("span",{style:{color:"#6A737D"}},'//stringRedisTemplate.expire("lock", 30, TimeUnit.SECONDS);')]),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"            Map<"),c("span",{style:{color:"#F97583"}},"String"),c("span",{style:{color:"#E1E4E8"}},", List<"),c("span",{style:{color:"#F97583"}},"Catalog2Vo"),c("span",{style:{color:"#E1E4E8"}},">> dataFromDb;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"            "),c("span",{style:{color:"#F97583"}},"try"),c("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"                "),c("span",{style:{color:"#6A737D"}},"//加锁成功.... 执行业务")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"                dataFromDb "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#B392F0"}},"getDataFromDb"),c("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"            } "),c("span",{style:{color:"#F97583"}},"finally"),c("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"                "),c("span",{style:{color:"#6A737D"}},"//无论业务崩溃或异常等情况都执行删除锁，只要保证原子加锁和原子解锁没有问题即可")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"                "),c("span",{style:{color:"#6A737D"}},"//因此可以使用luo脚本解锁来实现原子操作")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"                "),c("span",{style:{color:"#6A737D"}},"//                              指定的lock(key) == 指定的uuid(value)                                        删除返回1，失败返回0")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"                String script "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#9ECBFF"}},"\"if redis.call('get', KEYS[1]) == ARGV[1] then return redis.call('del', KEYS[1]) else return 0 end\""),c("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"                "),c("span",{style:{color:"#6A737D"}},"//执行脚本，删除锁")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"                Long lock1 "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," stringRedisTemplate."),c("span",{style:{color:"#B392F0"}},"execute"),c("span",{style:{color:"#E1E4E8"}},"(")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"                        "),c("span",{style:{color:"#6A737D"}},"//删除key->成功返回1，失败返回0，返回值为Integer")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"                        "),c("span",{style:{color:"#F97583"}},"new"),c("span",{style:{color:"#E1E4E8"}}," DefaultRedisScript<"),c("span",{style:{color:"#F97583"}},"Long"),c("span",{style:{color:"#E1E4E8"}},">(script, Long.class),")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"                        "),c("span",{style:{color:"#6A737D"}},"//所有的key集合->得到lock集合")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"                        Arrays."),c("span",{style:{color:"#B392F0"}},"asList"),c("span",{style:{color:"#E1E4E8"}},"("),c("span",{style:{color:"#9ECBFF"}},'"lock"'),c("span",{style:{color:"#E1E4E8"}},"), uuid);")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"            }")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"            "),c("span",{style:{color:"#6A737D"}},"//获取值对比+对比成功删除=原子操作，否则，即使比对成功也可能删的是别人的锁")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},'//            String lockValue = stringRedisTemplate.opsForValue().get("lock");')]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"//            //根据占锁的唯一Id值判断是不是同一把锁")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"//            // 极端情况，10s过期时间，执行业务用了9.5s，但获取锁要发送请求到远程的redis来返回数据，所需时间为0.3s，判断需要1s，")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"//            // 即比对成功时锁已过期，删的是redis刚更新的抢占锁")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"//            if (uuid.equals(lockValue)){")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"//                //是同一把锁就把这把锁删掉")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"//                //业务执行完毕后解锁-> 删除锁(key)")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},'//                stringRedisTemplate.delete("lock");')]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"//            }")]),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"            "),c("span",{style:{color:"#F97583"}},"return"),c("span",{style:{color:"#E1E4E8"}}," dataFromDb;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        } "),c("span",{style:{color:"#F97583"}},"else"),c("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"            System.out."),c("span",{style:{color:"#B392F0"}},"println"),c("span",{style:{color:"#E1E4E8"}},"("),c("span",{style:{color:"#9ECBFF"}},'"获取分布式锁失败.......等待重试"'),c("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"            "),c("span",{style:{color:"#6A737D"}},"//加锁失败....重试。。synchronized ()")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"            "),c("span",{style:{color:"#6A737D"}},"//休眠200ms重试")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"            "),c("span",{style:{color:"#F97583"}},"try"),c("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"                Thread."),c("span",{style:{color:"#B392F0"}},"sleep"),c("span",{style:{color:"#E1E4E8"}},"("),c("span",{style:{color:"#79B8FF"}},"200"),c("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"            } "),c("span",{style:{color:"#F97583"}},"catch"),c("span",{style:{color:"#E1E4E8"}}," (InterruptedException "),c("span",{style:{color:"#FFAB70"}},"e"),c("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"            }")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"            "),c("span",{style:{color:"#6A737D"}},"//自旋的方式-> 重新获取锁")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"            "),c("span",{style:{color:"#F97583"}},"return"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#B392F0"}},"getCatalogJsonFromDbWithRedisLock"),c("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        }")]),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    }")])])]),c("pre",{class:"shiki github-light vp-code-light"},[c("code",null,[c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"/**")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"     * 使用redis分布式锁来执行业务（luo脚本解锁）")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"     *")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"     * "),c("span",{style:{color:"#D73A49"}},"@return")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"     */")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#6A737D"}},"//@Override")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#D73A49"}},"public"),c("span",{style:{color:"#24292E"}}," Map"),c("span",{style:{color:"#D73A49"}},"<"),c("span",{style:{color:"#24292E"}},"String, List"),c("span",{style:{color:"#D73A49"}},"<"),c("span",{style:{color:"#24292E"}},"Catalog2Vo"),c("span",{style:{color:"#D73A49"}},">>"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#6F42C1"}},"getCatalogJsonFromDbWithRedisLock"),c("span",{style:{color:"#24292E"}},"() {")]),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        "),c("span",{style:{color:"#6A737D"}},"//抢占锁前，每人都获取唯一id设置成lock的value值")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        String uuid "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," UUID."),c("span",{style:{color:"#6F42C1"}},"randomUUID"),c("span",{style:{color:"#24292E"}},"()."),c("span",{style:{color:"#6F42C1"}},"toString"),c("span",{style:{color:"#24292E"}},"();")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        "),c("span",{style:{color:"#6A737D"}},"//1、占分布式锁，去redis占坑(原子操作)  SET  lock(k)  1111(v)     NX                        EX(时间不能太短)")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        Boolean lock "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," stringRedisTemplate."),c("span",{style:{color:"#6F42C1"}},"opsForValue"),c("span",{style:{color:"#24292E"}},"()."),c("span",{style:{color:"#6F42C1"}},"setIfAbsent"),c("span",{style:{color:"#24292E"}},"("),c("span",{style:{color:"#032F62"}},'"lock"'),c("span",{style:{color:"#24292E"}},", uuid, "),c("span",{style:{color:"#005CC5"}},"300"),c("span",{style:{color:"#24292E"}},", TimeUnit.SECONDS);")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        "),c("span",{style:{color:"#D73A49"}},"if"),c("span",{style:{color:"#24292E"}}," (lock) {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"            System.out."),c("span",{style:{color:"#6F42C1"}},"println"),c("span",{style:{color:"#24292E"}},"("),c("span",{style:{color:"#032F62"}},'"获取分布式锁成功......."'),c("span",{style:{color:"#24292E"}},");")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"            "),c("span",{style:{color:"#6A737D"}},"//2、设置过期时间，防止出现死锁情况(若突然断电而无法执行设置过期时间)")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"            "),c("span",{style:{color:"#6A737D"}},"//因此设置过期时间，必须和加锁是同步的，原子的")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"            "),c("span",{style:{color:"#6A737D"}},'//stringRedisTemplate.expire("lock", 30, TimeUnit.SECONDS);')]),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"            Map<"),c("span",{style:{color:"#D73A49"}},"String"),c("span",{style:{color:"#24292E"}},", List<"),c("span",{style:{color:"#D73A49"}},"Catalog2Vo"),c("span",{style:{color:"#24292E"}},">> dataFromDb;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"            "),c("span",{style:{color:"#D73A49"}},"try"),c("span",{style:{color:"#24292E"}}," {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"                "),c("span",{style:{color:"#6A737D"}},"//加锁成功.... 执行业务")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"                dataFromDb "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#6F42C1"}},"getDataFromDb"),c("span",{style:{color:"#24292E"}},"();")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"            } "),c("span",{style:{color:"#D73A49"}},"finally"),c("span",{style:{color:"#24292E"}}," {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"                "),c("span",{style:{color:"#6A737D"}},"//无论业务崩溃或异常等情况都执行删除锁，只要保证原子加锁和原子解锁没有问题即可")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"                "),c("span",{style:{color:"#6A737D"}},"//因此可以使用luo脚本解锁来实现原子操作")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"                "),c("span",{style:{color:"#6A737D"}},"//                              指定的lock(key) == 指定的uuid(value)                                        删除返回1，失败返回0")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"                String script "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#032F62"}},"\"if redis.call('get', KEYS[1]) == ARGV[1] then return redis.call('del', KEYS[1]) else return 0 end\""),c("span",{style:{color:"#24292E"}},";")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"                "),c("span",{style:{color:"#6A737D"}},"//执行脚本，删除锁")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"                Long lock1 "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," stringRedisTemplate."),c("span",{style:{color:"#6F42C1"}},"execute"),c("span",{style:{color:"#24292E"}},"(")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"                        "),c("span",{style:{color:"#6A737D"}},"//删除key->成功返回1，失败返回0，返回值为Integer")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"                        "),c("span",{style:{color:"#D73A49"}},"new"),c("span",{style:{color:"#24292E"}}," DefaultRedisScript<"),c("span",{style:{color:"#D73A49"}},"Long"),c("span",{style:{color:"#24292E"}},">(script, Long.class),")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"                        "),c("span",{style:{color:"#6A737D"}},"//所有的key集合->得到lock集合")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"                        Arrays."),c("span",{style:{color:"#6F42C1"}},"asList"),c("span",{style:{color:"#24292E"}},"("),c("span",{style:{color:"#032F62"}},'"lock"'),c("span",{style:{color:"#24292E"}},"), uuid);")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"            }")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"            "),c("span",{style:{color:"#6A737D"}},"//获取值对比+对比成功删除=原子操作，否则，即使比对成功也可能删的是别人的锁")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},'//            String lockValue = stringRedisTemplate.opsForValue().get("lock");')]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"//            //根据占锁的唯一Id值判断是不是同一把锁")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"//            // 极端情况，10s过期时间，执行业务用了9.5s，但获取锁要发送请求到远程的redis来返回数据，所需时间为0.3s，判断需要1s，")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"//            // 即比对成功时锁已过期，删的是redis刚更新的抢占锁")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"//            if (uuid.equals(lockValue)){")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"//                //是同一把锁就把这把锁删掉")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"//                //业务执行完毕后解锁-> 删除锁(key)")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},'//                stringRedisTemplate.delete("lock");')]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"//            }")]),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"            "),c("span",{style:{color:"#D73A49"}},"return"),c("span",{style:{color:"#24292E"}}," dataFromDb;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        } "),c("span",{style:{color:"#D73A49"}},"else"),c("span",{style:{color:"#24292E"}}," {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"            System.out."),c("span",{style:{color:"#6F42C1"}},"println"),c("span",{style:{color:"#24292E"}},"("),c("span",{style:{color:"#032F62"}},'"获取分布式锁失败.......等待重试"'),c("span",{style:{color:"#24292E"}},");")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"            "),c("span",{style:{color:"#6A737D"}},"//加锁失败....重试。。synchronized ()")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"            "),c("span",{style:{color:"#6A737D"}},"//休眠200ms重试")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"            "),c("span",{style:{color:"#D73A49"}},"try"),c("span",{style:{color:"#24292E"}}," {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"                Thread."),c("span",{style:{color:"#6F42C1"}},"sleep"),c("span",{style:{color:"#24292E"}},"("),c("span",{style:{color:"#005CC5"}},"200"),c("span",{style:{color:"#24292E"}},");")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"            } "),c("span",{style:{color:"#D73A49"}},"catch"),c("span",{style:{color:"#24292E"}}," (InterruptedException "),c("span",{style:{color:"#E36209"}},"e"),c("span",{style:{color:"#24292E"}},") {")]),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"            }")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"            "),c("span",{style:{color:"#6A737D"}},"//自旋的方式-> 重新获取锁")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"            "),c("span",{style:{color:"#D73A49"}},"return"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#6F42C1"}},"getCatalogJsonFromDbWithRedisLock"),c("span",{style:{color:"#24292E"}},"();")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        }")]),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    }")])])])],-1),sa=c("ul",null,[c("li",null,[p("给页面返回所有分类的Json数据（加Redis锁）"),c("code",null,"org.klaus.zgg01mall.product.service.impl.CategoryServiceImpl#getCatalogJson2")])],-1),la=c("div",{class:"language-java"},[c("button",{title:"Copy Code",class:"copy"}),c("span",{class:"lang"},"java"),c("pre",{class:"shiki github-dark vp-code-dark"},[c("code",null,[c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"/**")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"     * 抽取缓存操作方法（使用了RedisLock）")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"     * 没加缓存注解前的缓存操作业务代码（获取分类的json数据）")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"     * "),c("span",{style:{color:"#F97583"}},"@return")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"     */")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#6A737D"}},"//@Override")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#F97583"}},"public"),c("span",{style:{color:"#E1E4E8"}}," Map"),c("span",{style:{color:"#F97583"}},"<"),c("span",{style:{color:"#E1E4E8"}},"String, List"),c("span",{style:{color:"#F97583"}},"<"),c("span",{style:{color:"#E1E4E8"}},"Catalog2Vo"),c("span",{style:{color:"#F97583"}},">>"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#B392F0"}},"getCatalogJson2"),c("span",{style:{color:"#E1E4E8"}},"() {")]),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        "),c("span",{style:{color:"#6A737D"}},"//给缓存中放json字符串，拿出的json字符串，还要逆转为能用的对象类型【序列化与反序列化】")]),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        "),c("span",{style:{color:"#6A737D"}},"/**")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"         * 1、空结果缓存，解决缓存穿透")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"         * 2、设置过期时间（加随机值）：解决缓存雪崩")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"         * 3、加锁：解决缓存击穿")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"         */")]),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        "),c("span",{style:{color:"#6A737D"}},"//1、加入缓存逻辑，缓存中存放的数据是json字符串")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        "),c("span",{style:{color:"#6A737D"}},"//json跨语言，跨平台兼容")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        String catalogJson "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," stringRedisTemplate."),c("span",{style:{color:"#B392F0"}},"opsForValue"),c("span",{style:{color:"#E1E4E8"}},"()."),c("span",{style:{color:"#B392F0"}},"get"),c("span",{style:{color:"#E1E4E8"}},"("),c("span",{style:{color:"#9ECBFF"}},'"catalogJson"'),c("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        "),c("span",{style:{color:"#F97583"}},"if"),c("span",{style:{color:"#E1E4E8"}}," (StringUtils."),c("span",{style:{color:"#B392F0"}},"isEmpty"),c("span",{style:{color:"#E1E4E8"}},"(catalogJson)) {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"            "),c("span",{style:{color:"#6A737D"}},"//2、缓存中没有，查询数据库")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"            "),c("span",{style:{color:"#6A737D"}},"//保证数据库查询完成以后，将数据放在redis中，这是一个原子操作")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"            System.out."),c("span",{style:{color:"#B392F0"}},"println"),c("span",{style:{color:"#E1E4E8"}},"("),c("span",{style:{color:"#9ECBFF"}},'"缓存不命中。。。。将要查询数据库。。。"'),c("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"            Map<"),c("span",{style:{color:"#F97583"}},"String"),c("span",{style:{color:"#E1E4E8"}},", List<"),c("span",{style:{color:"#F97583"}},"Catalog2Vo"),c("span",{style:{color:"#E1E4E8"}},">> catalogJsonFromDb "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#B392F0"}},"getCatalogJsonFromDbWithRedisLock"),c("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"//            //3、查到的数据再放入缓存，将对象转为json放入缓存中")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"//            String s = JSON.toJSONString(catalogJsonFromDb);")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"//            //将数据放入缓存")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},'//            stringRedisTemplate.opsForValue().set("catalogJson", s, 1, TimeUnit.DAYS);')]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"            "),c("span",{style:{color:"#6A737D"}},"//将数据库查到的结果直接返回，即将数据库查到的结果放一份到缓存中并返回")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"            "),c("span",{style:{color:"#F97583"}},"return"),c("span",{style:{color:"#E1E4E8"}}," catalogJsonFromDb;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        }")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        System.out."),c("span",{style:{color:"#B392F0"}},"println"),c("span",{style:{color:"#E1E4E8"}},"("),c("span",{style:{color:"#9ECBFF"}},'"缓存命中。。。。直接返回。。。"'),c("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        "),c("span",{style:{color:"#6A737D"}},"//将数据转为指定类型")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        Map<"),c("span",{style:{color:"#F97583"}},"String"),c("span",{style:{color:"#E1E4E8"}},", List<"),c("span",{style:{color:"#F97583"}},"Catalog2Vo"),c("span",{style:{color:"#E1E4E8"}},">> result "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," JSON."),c("span",{style:{color:"#B392F0"}},"parseObject"),c("span",{style:{color:"#E1E4E8"}},"(catalogJson, "),c("span",{style:{color:"#F97583"}},"new"),c("span",{style:{color:"#E1E4E8"}}," TypeReference<Map<"),c("span",{style:{color:"#F97583"}},"String"),c("span",{style:{color:"#E1E4E8"}},", List<"),c("span",{style:{color:"#F97583"}},"Catalog2Vo"),c("span",{style:{color:"#E1E4E8"}},">>>() {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        });")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        "),c("span",{style:{color:"#F97583"}},"return"),c("span",{style:{color:"#E1E4E8"}}," result;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    }")])])]),c("pre",{class:"shiki github-light vp-code-light"},[c("code",null,[c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"/**")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"     * 抽取缓存操作方法（使用了RedisLock）")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"     * 没加缓存注解前的缓存操作业务代码（获取分类的json数据）")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"     * "),c("span",{style:{color:"#D73A49"}},"@return")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"     */")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#6A737D"}},"//@Override")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#D73A49"}},"public"),c("span",{style:{color:"#24292E"}}," Map"),c("span",{style:{color:"#D73A49"}},"<"),c("span",{style:{color:"#24292E"}},"String, List"),c("span",{style:{color:"#D73A49"}},"<"),c("span",{style:{color:"#24292E"}},"Catalog2Vo"),c("span",{style:{color:"#D73A49"}},">>"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#6F42C1"}},"getCatalogJson2"),c("span",{style:{color:"#24292E"}},"() {")]),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        "),c("span",{style:{color:"#6A737D"}},"//给缓存中放json字符串，拿出的json字符串，还要逆转为能用的对象类型【序列化与反序列化】")]),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        "),c("span",{style:{color:"#6A737D"}},"/**")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"         * 1、空结果缓存，解决缓存穿透")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"         * 2、设置过期时间（加随机值）：解决缓存雪崩")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"         * 3、加锁：解决缓存击穿")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"         */")]),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        "),c("span",{style:{color:"#6A737D"}},"//1、加入缓存逻辑，缓存中存放的数据是json字符串")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        "),c("span",{style:{color:"#6A737D"}},"//json跨语言，跨平台兼容")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        String catalogJson "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," stringRedisTemplate."),c("span",{style:{color:"#6F42C1"}},"opsForValue"),c("span",{style:{color:"#24292E"}},"()."),c("span",{style:{color:"#6F42C1"}},"get"),c("span",{style:{color:"#24292E"}},"("),c("span",{style:{color:"#032F62"}},'"catalogJson"'),c("span",{style:{color:"#24292E"}},");")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        "),c("span",{style:{color:"#D73A49"}},"if"),c("span",{style:{color:"#24292E"}}," (StringUtils."),c("span",{style:{color:"#6F42C1"}},"isEmpty"),c("span",{style:{color:"#24292E"}},"(catalogJson)) {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"            "),c("span",{style:{color:"#6A737D"}},"//2、缓存中没有，查询数据库")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"            "),c("span",{style:{color:"#6A737D"}},"//保证数据库查询完成以后，将数据放在redis中，这是一个原子操作")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"            System.out."),c("span",{style:{color:"#6F42C1"}},"println"),c("span",{style:{color:"#24292E"}},"("),c("span",{style:{color:"#032F62"}},'"缓存不命中。。。。将要查询数据库。。。"'),c("span",{style:{color:"#24292E"}},");")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"            Map<"),c("span",{style:{color:"#D73A49"}},"String"),c("span",{style:{color:"#24292E"}},", List<"),c("span",{style:{color:"#D73A49"}},"Catalog2Vo"),c("span",{style:{color:"#24292E"}},">> catalogJsonFromDb "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#6F42C1"}},"getCatalogJsonFromDbWithRedisLock"),c("span",{style:{color:"#24292E"}},"();")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"//            //3、查到的数据再放入缓存，将对象转为json放入缓存中")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"//            String s = JSON.toJSONString(catalogJsonFromDb);")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"//            //将数据放入缓存")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},'//            stringRedisTemplate.opsForValue().set("catalogJson", s, 1, TimeUnit.DAYS);')]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"            "),c("span",{style:{color:"#6A737D"}},"//将数据库查到的结果直接返回，即将数据库查到的结果放一份到缓存中并返回")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"            "),c("span",{style:{color:"#D73A49"}},"return"),c("span",{style:{color:"#24292E"}}," catalogJsonFromDb;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        }")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        System.out."),c("span",{style:{color:"#6F42C1"}},"println"),c("span",{style:{color:"#24292E"}},"("),c("span",{style:{color:"#032F62"}},'"缓存命中。。。。直接返回。。。"'),c("span",{style:{color:"#24292E"}},");")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        "),c("span",{style:{color:"#6A737D"}},"//将数据转为指定类型")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        Map<"),c("span",{style:{color:"#D73A49"}},"String"),c("span",{style:{color:"#24292E"}},", List<"),c("span",{style:{color:"#D73A49"}},"Catalog2Vo"),c("span",{style:{color:"#24292E"}},">> result "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," JSON."),c("span",{style:{color:"#6F42C1"}},"parseObject"),c("span",{style:{color:"#24292E"}},"(catalogJson, "),c("span",{style:{color:"#D73A49"}},"new"),c("span",{style:{color:"#24292E"}}," TypeReference<Map<"),c("span",{style:{color:"#D73A49"}},"String"),c("span",{style:{color:"#24292E"}},", List<"),c("span",{style:{color:"#D73A49"}},"Catalog2Vo"),c("span",{style:{color:"#24292E"}},">>>() {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        });")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        "),c("span",{style:{color:"#D73A49"}},"return"),c("span",{style:{color:"#24292E"}}," result;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    }")])])])],-1),oa={id:"_3、redisson-完成分布式锁",tabindex:"-1"},na=c("p",null,[c("strong",null,"1、简介")],-1),aa=c("p",null,[c("strong",null,"2、引入依赖")],-1),ea=c("div",{class:"language-xml"},[c("button",{title:"Copy Code",class:"copy"}),c("span",{class:"lang"},"xml"),c("pre",{class:"shiki github-dark vp-code-dark"},[c("code",null,[c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"\x3c!--以后使用redisson作为所有分布式锁，分布式对象等功能框架 --\x3e")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"<"),c("span",{style:{color:"#85E89D"}},"dependency"),c("span",{style:{color:"#E1E4E8"}},">")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    <"),c("span",{style:{color:"#85E89D"}},"groupId"),c("span",{style:{color:"#E1E4E8"}},">org.redisson</"),c("span",{style:{color:"#85E89D"}},"groupId"),c("span",{style:{color:"#E1E4E8"}},">")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    <"),c("span",{style:{color:"#85E89D"}},"artifactId"),c("span",{style:{color:"#E1E4E8"}},">redisson</"),c("span",{style:{color:"#85E89D"}},"artifactId"),c("span",{style:{color:"#E1E4E8"}},">")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    <"),c("span",{style:{color:"#85E89D"}},"version"),c("span",{style:{color:"#E1E4E8"}},">3.12.0</"),c("span",{style:{color:"#85E89D"}},"version"),c("span",{style:{color:"#E1E4E8"}},">")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"</"),c("span",{style:{color:"#85E89D"}},"dependency"),c("span",{style:{color:"#E1E4E8"}},">")])])]),c("pre",{class:"shiki github-light vp-code-light"},[c("code",null,[c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"\x3c!--以后使用redisson作为所有分布式锁，分布式对象等功能框架 --\x3e")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"<"),c("span",{style:{color:"#22863A"}},"dependency"),c("span",{style:{color:"#24292E"}},">")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    <"),c("span",{style:{color:"#22863A"}},"groupId"),c("span",{style:{color:"#24292E"}},">org.redisson</"),c("span",{style:{color:"#22863A"}},"groupId"),c("span",{style:{color:"#24292E"}},">")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    <"),c("span",{style:{color:"#22863A"}},"artifactId"),c("span",{style:{color:"#24292E"}},">redisson</"),c("span",{style:{color:"#22863A"}},"artifactId"),c("span",{style:{color:"#24292E"}},">")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    <"),c("span",{style:{color:"#22863A"}},"version"),c("span",{style:{color:"#24292E"}},">3.12.0</"),c("span",{style:{color:"#22863A"}},"version"),c("span",{style:{color:"#24292E"}},">")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"</"),c("span",{style:{color:"#22863A"}},"dependency"),c("span",{style:{color:"#24292E"}},">")])])])],-1),ta=c("p",null,[c("strong",null,"3、配置类")],-1),ca=c("div",{class:"language-java"},[c("button",{title:"Copy Code",class:"copy"}),c("span",{class:"lang"},"java"),c("pre",{class:"shiki github-dark vp-code-dark"},[c("code",null,[c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"/**")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}}," * "),c("span",{style:{color:"#F97583"}},"@author"),c("span",{style:{color:"#6A737D"}}," Klaus")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}}," * @date 2022/9/7")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}}," */")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"@"),c("span",{style:{color:"#F97583"}},"Configuration")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#F97583"}},"public"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#F97583"}},"class"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#B392F0"}},"MyRedissonConfig"),c("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"    /**")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"     * 所有对Redisson的使用都是通过RedissonClient对象")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"     * "),c("span",{style:{color:"#F97583"}},"@return")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"     * "),c("span",{style:{color:"#F97583"}},"@throws"),c("span",{style:{color:"#6A737D"}}," "),c("span",{style:{color:"#B392F0"}},"IOException")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"     */")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    @"),c("span",{style:{color:"#F97583"}},"Bean"),c("span",{style:{color:"#E1E4E8"}},"("),c("span",{style:{color:"#79B8FF"}},"destroyMethod"),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#9ECBFF"}},'"shutdown"'),c("span",{style:{color:"#E1E4E8"}},")")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#F97583"}},"public"),c("span",{style:{color:"#E1E4E8"}}," RedissonClient "),c("span",{style:{color:"#B392F0"}},"redisson"),c("span",{style:{color:"#E1E4E8"}},"() "),c("span",{style:{color:"#F97583"}},"throws"),c("span",{style:{color:"#E1E4E8"}}," IOException {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        "),c("span",{style:{color:"#6A737D"}},"//1、创建配置")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        "),c("span",{style:{color:"#6A737D"}},"//Redis url should start with redis:// or rediss://")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        Config config "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#F97583"}},"new"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#B392F0"}},"Config"),c("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        "),c("span",{style:{color:"#6A737D"}},'//可以用"rediss://"来启用 SSL 连接')]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        config."),c("span",{style:{color:"#B392F0"}},"useSingleServer"),c("span",{style:{color:"#E1E4E8"}},"()."),c("span",{style:{color:"#B392F0"}},"setAddress"),c("span",{style:{color:"#E1E4E8"}},"("),c("span",{style:{color:"#9ECBFF"}},'"redis://192.168.10.103:6379"'),c("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        "),c("span",{style:{color:"#6A737D"}},"//2、根据config创建出Redisson实例")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        RedissonClient redissonClient "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," Redisson."),c("span",{style:{color:"#B392F0"}},"create"),c("span",{style:{color:"#E1E4E8"}},"(config);")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        "),c("span",{style:{color:"#F97583"}},"return"),c("span",{style:{color:"#E1E4E8"}}," redissonClient;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"}")])])]),c("pre",{class:"shiki github-light vp-code-light"},[c("code",null,[c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"/**")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}}," * "),c("span",{style:{color:"#D73A49"}},"@author"),c("span",{style:{color:"#6A737D"}}," Klaus")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}}," * @date 2022/9/7")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}}," */")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"@"),c("span",{style:{color:"#D73A49"}},"Configuration")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#D73A49"}},"public"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#D73A49"}},"class"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#6F42C1"}},"MyRedissonConfig"),c("span",{style:{color:"#24292E"}}," {")]),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"    /**")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"     * 所有对Redisson的使用都是通过RedissonClient对象")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"     * "),c("span",{style:{color:"#D73A49"}},"@return")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"     * "),c("span",{style:{color:"#D73A49"}},"@throws"),c("span",{style:{color:"#6A737D"}}," "),c("span",{style:{color:"#6F42C1"}},"IOException")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"     */")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    @"),c("span",{style:{color:"#D73A49"}},"Bean"),c("span",{style:{color:"#24292E"}},"("),c("span",{style:{color:"#005CC5"}},"destroyMethod"),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#032F62"}},'"shutdown"'),c("span",{style:{color:"#24292E"}},")")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#D73A49"}},"public"),c("span",{style:{color:"#24292E"}}," RedissonClient "),c("span",{style:{color:"#6F42C1"}},"redisson"),c("span",{style:{color:"#24292E"}},"() "),c("span",{style:{color:"#D73A49"}},"throws"),c("span",{style:{color:"#24292E"}}," IOException {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        "),c("span",{style:{color:"#6A737D"}},"//1、创建配置")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        "),c("span",{style:{color:"#6A737D"}},"//Redis url should start with redis:// or rediss://")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        Config config "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#D73A49"}},"new"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#6F42C1"}},"Config"),c("span",{style:{color:"#24292E"}},"();")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        "),c("span",{style:{color:"#6A737D"}},'//可以用"rediss://"来启用 SSL 连接')]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        config."),c("span",{style:{color:"#6F42C1"}},"useSingleServer"),c("span",{style:{color:"#24292E"}},"()."),c("span",{style:{color:"#6F42C1"}},"setAddress"),c("span",{style:{color:"#24292E"}},"("),c("span",{style:{color:"#032F62"}},'"redis://192.168.10.103:6379"'),c("span",{style:{color:"#24292E"}},");")]),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        "),c("span",{style:{color:"#6A737D"}},"//2、根据config创建出Redisson实例")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        RedissonClient redissonClient "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," Redisson."),c("span",{style:{color:"#6F42C1"}},"create"),c("span",{style:{color:"#24292E"}},"(config);")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        "),c("span",{style:{color:"#D73A49"}},"return"),c("span",{style:{color:"#24292E"}}," redissonClient;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    }")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"}")])])])],-1),pa=c("p",null,[c("strong",null,"4、使用分布式锁")],-1),ra=c("div",{class:"language-java"},[c("button",{title:"Copy Code",class:"copy"}),c("span",{class:"lang"},"java"),c("pre",{class:"shiki github-dark vp-code-dark"},[c("code",null,[c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"RLock lock "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," redisson."),c("span",{style:{color:"#B392F0"}},"getLock"),c("span",{style:{color:"#E1E4E8"}},"("),c("span",{style:{color:"#9ECBFF"}},'"anyLock"'),c("span",{style:{color:"#E1E4E8"}},");"),c("span",{style:{color:"#6A737D"}},"// 最常见的使用方法")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"lock."),c("span",{style:{color:"#B392F0"}},"lock"),c("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"// 加锁以后 10 秒钟自动解锁// 无需调用 unlock 方法手动解锁")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"lock."),c("span",{style:{color:"#B392F0"}},"lock"),c("span",{style:{color:"#E1E4E8"}},"("),c("span",{style:{color:"#79B8FF"}},"10"),c("span",{style:{color:"#E1E4E8"}},", TimeUnit.SECONDS);")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"// 尝试加锁，最多等待 100 秒，上锁以后 10 秒自动解锁 ")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#F97583"}},"boolean"),c("span",{style:{color:"#E1E4E8"}}," res "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," lock."),c("span",{style:{color:"#B392F0"}},"tryLock"),c("span",{style:{color:"#E1E4E8"}},"("),c("span",{style:{color:"#79B8FF"}},"100"),c("span",{style:{color:"#E1E4E8"}},","),c("span",{style:{color:"#79B8FF"}},"10"),c("span",{style:{color:"#E1E4E8"}},", TimeUnit.SECONDS);")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#F97583"}},"if"),c("span",{style:{color:"#E1E4E8"}}," (res) {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#F97583"}},"try"),c("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"\t...")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"} "),c("span",{style:{color:"#F97583"}},"finally"),c("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"\tlock."),c("span",{style:{color:"#B392F0"}},"unlock"),c("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"\t}")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"}")])])]),c("pre",{class:"shiki github-light vp-code-light"},[c("code",null,[c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"RLock lock "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," redisson."),c("span",{style:{color:"#6F42C1"}},"getLock"),c("span",{style:{color:"#24292E"}},"("),c("span",{style:{color:"#032F62"}},'"anyLock"'),c("span",{style:{color:"#24292E"}},");"),c("span",{style:{color:"#6A737D"}},"// 最常见的使用方法")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"lock."),c("span",{style:{color:"#6F42C1"}},"lock"),c("span",{style:{color:"#24292E"}},"();")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"// 加锁以后 10 秒钟自动解锁// 无需调用 unlock 方法手动解锁")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"lock."),c("span",{style:{color:"#6F42C1"}},"lock"),c("span",{style:{color:"#24292E"}},"("),c("span",{style:{color:"#005CC5"}},"10"),c("span",{style:{color:"#24292E"}},", TimeUnit.SECONDS);")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"// 尝试加锁，最多等待 100 秒，上锁以后 10 秒自动解锁 ")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#D73A49"}},"boolean"),c("span",{style:{color:"#24292E"}}," res "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," lock."),c("span",{style:{color:"#6F42C1"}},"tryLock"),c("span",{style:{color:"#24292E"}},"("),c("span",{style:{color:"#005CC5"}},"100"),c("span",{style:{color:"#24292E"}},","),c("span",{style:{color:"#005CC5"}},"10"),c("span",{style:{color:"#24292E"}},", TimeUnit.SECONDS);")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#D73A49"}},"if"),c("span",{style:{color:"#24292E"}}," (res) {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#D73A49"}},"try"),c("span",{style:{color:"#24292E"}}," {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"\t...")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"} "),c("span",{style:{color:"#D73A49"}},"finally"),c("span",{style:{color:"#24292E"}}," {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"\tlock."),c("span",{style:{color:"#6F42C1"}},"unlock"),c("span",{style:{color:"#24292E"}},"();")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"\t}")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"}")])])])],-1),Ea=c("ul",null,[c("li",null,[c("code",null,"org.klaus.zgg01mall.product.service.impl.CategoryServiceImpl#getCatalogJsonFromDbWithRedissonLock")])],-1),ya=c("div",{class:"language-java"},[c("button",{title:"Copy Code",class:"copy"}),c("span",{class:"lang"},"java"),c("pre",{class:"shiki github-dark vp-code-dark"},[c("code",null,[c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"/**")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}}," * 缓存里面的数据如何和数据库保持一致（使用了RedissonLock）")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}}," * 缓存数据一致性")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}}," * 1）、双写模式")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}}," * 2）、失效模式")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}}," *")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}}," * "),c("span",{style:{color:"#F97583"}},"@return")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}}," */")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"//@Override")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#F97583"}},"public"),c("span",{style:{color:"#E1E4E8"}}," Map"),c("span",{style:{color:"#F97583"}},"<"),c("span",{style:{color:"#E1E4E8"}},"String, List"),c("span",{style:{color:"#F97583"}},"<"),c("span",{style:{color:"#E1E4E8"}},"Catalog2Vo"),c("span",{style:{color:"#F97583"}},">>"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#B392F0"}},"getCatalogJsonFromDbWithRedissonLock"),c("span",{style:{color:"#E1E4E8"}},"() {")]),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#6A737D"}},"//抢占锁前，每人都获取唯一id设置成lock的value值")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#6A737D"}},"//1、占分布式锁，去redis占坑(原子操作)")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#6A737D"}},"//注意：传的锁名字一样，锁就一样，锁的粒度，越细越快")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#6A737D"}},"//锁的粒度：具体缓存的是某个数据，11号-商品；product-11-lock  product-12-lock product-lock")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    RLock lock "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," redisson."),c("span",{style:{color:"#B392F0"}},"getLock"),c("span",{style:{color:"#E1E4E8"}},"("),c("span",{style:{color:"#9ECBFF"}},'"catalogJson-lock"'),c("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    lock."),c("span",{style:{color:"#B392F0"}},"lock"),c("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    Map<"),c("span",{style:{color:"#F97583"}},"String"),c("span",{style:{color:"#E1E4E8"}},", List<"),c("span",{style:{color:"#F97583"}},"Catalog2Vo"),c("span",{style:{color:"#E1E4E8"}},">> dataFromDb;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#F97583"}},"try"),c("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        dataFromDb "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#B392F0"}},"getDataFromDb"),c("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    } "),c("span",{style:{color:"#F97583"}},"finally"),c("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        lock."),c("span",{style:{color:"#B392F0"}},"unlock"),c("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#F97583"}},"return"),c("span",{style:{color:"#E1E4E8"}}," dataFromDb;")]),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"}")])])]),c("pre",{class:"shiki github-light vp-code-light"},[c("code",null,[c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"/**")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}}," * 缓存里面的数据如何和数据库保持一致（使用了RedissonLock）")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}}," * 缓存数据一致性")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}}," * 1）、双写模式")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}}," * 2）、失效模式")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}}," *")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}}," * "),c("span",{style:{color:"#D73A49"}},"@return")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}}," */")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"//@Override")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#D73A49"}},"public"),c("span",{style:{color:"#24292E"}}," Map"),c("span",{style:{color:"#D73A49"}},"<"),c("span",{style:{color:"#24292E"}},"String, List"),c("span",{style:{color:"#D73A49"}},"<"),c("span",{style:{color:"#24292E"}},"Catalog2Vo"),c("span",{style:{color:"#D73A49"}},">>"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#6F42C1"}},"getCatalogJsonFromDbWithRedissonLock"),c("span",{style:{color:"#24292E"}},"() {")]),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#6A737D"}},"//抢占锁前，每人都获取唯一id设置成lock的value值")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#6A737D"}},"//1、占分布式锁，去redis占坑(原子操作)")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#6A737D"}},"//注意：传的锁名字一样，锁就一样，锁的粒度，越细越快")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#6A737D"}},"//锁的粒度：具体缓存的是某个数据，11号-商品；product-11-lock  product-12-lock product-lock")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    RLock lock "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," redisson."),c("span",{style:{color:"#6F42C1"}},"getLock"),c("span",{style:{color:"#24292E"}},"("),c("span",{style:{color:"#032F62"}},'"catalogJson-lock"'),c("span",{style:{color:"#24292E"}},");")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    lock."),c("span",{style:{color:"#6F42C1"}},"lock"),c("span",{style:{color:"#24292E"}},"();")]),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    Map<"),c("span",{style:{color:"#D73A49"}},"String"),c("span",{style:{color:"#24292E"}},", List<"),c("span",{style:{color:"#D73A49"}},"Catalog2Vo"),c("span",{style:{color:"#24292E"}},">> dataFromDb;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#D73A49"}},"try"),c("span",{style:{color:"#24292E"}}," {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        dataFromDb "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#6F42C1"}},"getDataFromDb"),c("span",{style:{color:"#24292E"}},"();")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    } "),c("span",{style:{color:"#D73A49"}},"finally"),c("span",{style:{color:"#24292E"}}," {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        lock."),c("span",{style:{color:"#6F42C1"}},"unlock"),c("span",{style:{color:"#24292E"}},"();")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    }")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#D73A49"}},"return"),c("span",{style:{color:"#24292E"}}," dataFromDb;")]),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"}")])])])],-1),ia=c("ul",null,[c("li",null,"替换Redis锁业务方法为Redisson锁并返回给页面Json数据")],-1),ua=c("p",null,[c("code",null,"Map<String, List<Catalog2Vo>> catalogJsonFromDb = getCatalogJsonFromDbWithRedissonLock();")],-1),da=c("p",null,[c("strong",null,"5、使用其他")],-1),ga=c("p",null,[c("strong",null,"补充")],-1),Fa=c("ul",null,[c("li",null,[c("p",null,"1、获取一把锁，只要锁的名字一样，就是同一把锁"),c("ul",null,[c("li",null,'RLock lock = redisson.getLock("my-lock");')])]),c("li",null,[c("p",null,"2、加锁 阻塞式等待，(默认加的锁都是30s时间)即如果加不到锁，就会在这一直等直到加到锁为止才继续执行下去"),c("ul",null,[c("li",null,"lock.lock();"),c("li",null,"1)、锁的自动续期，如果业务超长，运行期间自动给锁续上新的30s，即不用担心业务时间长而锁自动过期被删掉"),c("li",null,"2)、加锁的业务只要运行完成，就不会给当前锁续期，即使不手动解锁，锁默认在30s以后自动删除")])]),c("li",null,[c("p",null,"10秒自动解锁，自动解锁时间一定要大于业务的执行时间"),c("ul",null,[c("li",null,"问题：lock.lock(10, TimeUnit.SECONDS);在锁时间到了以后，不会自动续期")])]),c("li",null,[c("p",null,"1、如果我们传递了锁的超时时间，就发送给redis执行脚本，进行占锁，默认超时时间就是我们指定的时间")]),c("li",null,[c("p",null,"2、如果我们未指定锁的超时时间，就使用30*1000【LockWatchingTimeout看门狗的默认时间】；")]),c("li",null,[c("p",null,"只要占锁成功，就会启动一个定时任务【重新给锁设置过期时间，新的过期时间就是看门狗的默认时间】，每隔10s都会自动再次续期，续成30s")]),c("li",null,[c("p",null,"internalLockLeaseTime【看门狗时间】/ 3,10s")]),c("li",null,[c("p",null,"最佳实战")]),c("li",null,[c("p",null,"lock.lock(30, TimeUnit.SECONDS);省掉了整个续期操作，手动解锁")])],-1),Da=c("div",{class:"language-java"},[c("button",{title:"Copy Code",class:"copy"}),c("span",{class:"lang"},"java"),c("pre",{class:"shiki github-dark vp-code-dark"},[c("code",null,[c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"@"),c("span",{style:{color:"#F97583"}},"ResponseBody")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"@"),c("span",{style:{color:"#F97583"}},"GetMapping"),c("span",{style:{color:"#E1E4E8"}},"("),c("span",{style:{color:"#9ECBFF"}},'"/hello"'),c("span",{style:{color:"#E1E4E8"}},")")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#F97583"}},"public"),c("span",{style:{color:"#E1E4E8"}}," String "),c("span",{style:{color:"#B392F0"}},"hello"),c("span",{style:{color:"#E1E4E8"}},"() {")]),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#6A737D"}},"//1、获取一把锁，只要锁的名字一样，就是同一把锁")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    RLock lock "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," redisson."),c("span",{style:{color:"#B392F0"}},"getLock"),c("span",{style:{color:"#E1E4E8"}},"("),c("span",{style:{color:"#9ECBFF"}},'"my-lock"'),c("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#6A737D"}},"//2、加锁 阻塞式等待，(默认加的锁都是30s时间)即如果加不到锁，就会在这一直等直到加到锁为止才继续执行下去")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#6A737D"}},"//lock.lock();")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#6A737D"}},"//1)、锁的自动续期，如果业务超长，运行期间自动给锁续上新的30s，即不用担心业务时间长而锁自动过期被删掉")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#6A737D"}},"//2)、加锁的业务只要运行完成，就不会给当前锁续期，即使不手动解锁，锁默认在30s以后自动删除")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#6A737D"}},"//10秒自动解锁，自动解锁时间一定要大于业务的执行时间")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    lock."),c("span",{style:{color:"#B392F0"}},"lock"),c("span",{style:{color:"#E1E4E8"}},"("),c("span",{style:{color:"#79B8FF"}},"30"),c("span",{style:{color:"#E1E4E8"}},", TimeUnit.SECONDS);")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#6A737D"}},"//todo 问题：lock.lock(10, TimeUnit.SECONDS);在锁时间到了以后，不会自动续期")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#6A737D"}},"//1、如果我们传递了锁的超时时间，就发送给redis执行脚本，进行占锁，默认超时时间就是我们指定的时间")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#6A737D"}},"//2、如果我们未指定锁的超时时间，就使用30*1000【LockWatchingTimeout看门狗的默认时间】；")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#6A737D"}},"//     只要占锁成功，就会启动一个定时任务【重新给锁设置过期时间，新的过期时间就是看门狗的默认时间】，每隔10s都会自动再次续期，续成30s")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#6A737D"}},"//     internalLockLeaseTime【看门狗时间】/  3,10s")]),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#6A737D"}},"//最佳实战")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#6A737D"}},"//1）、lock.lock(30, TimeUnit.SECONDS);省掉了整个续期操作，手动解锁")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#F97583"}},"try"),c("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        System.out."),c("span",{style:{color:"#B392F0"}},"println"),c("span",{style:{color:"#E1E4E8"}},"("),c("span",{style:{color:"#9ECBFF"}},'"加锁成功，执行业务。。。"'),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#F97583"}},"+"),c("span",{style:{color:"#E1E4E8"}}," Thread."),c("span",{style:{color:"#B392F0"}},"currentThread"),c("span",{style:{color:"#E1E4E8"}},"()."),c("span",{style:{color:"#B392F0"}},"getId"),c("span",{style:{color:"#E1E4E8"}},"());")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        Thread."),c("span",{style:{color:"#B392F0"}},"sleep"),c("span",{style:{color:"#E1E4E8"}},"("),c("span",{style:{color:"#79B8FF"}},"30000"),c("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    } "),c("span",{style:{color:"#F97583"}},"catch"),c("span",{style:{color:"#E1E4E8"}}," (Exception "),c("span",{style:{color:"#FFAB70"}},"e"),c("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    } "),c("span",{style:{color:"#F97583"}},"finally"),c("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        "),c("span",{style:{color:"#6A737D"}},"//3、解锁  假设解锁代码没有运行，redisson会不会出现死锁")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        System.out."),c("span",{style:{color:"#B392F0"}},"println"),c("span",{style:{color:"#E1E4E8"}},"("),c("span",{style:{color:"#9ECBFF"}},'"释放锁。。。"'),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#F97583"}},"+"),c("span",{style:{color:"#E1E4E8"}}," Thread."),c("span",{style:{color:"#B392F0"}},"currentThread"),c("span",{style:{color:"#E1E4E8"}},"()."),c("span",{style:{color:"#B392F0"}},"getId"),c("span",{style:{color:"#E1E4E8"}},"());")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        lock."),c("span",{style:{color:"#B392F0"}},"unlock"),c("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#F97583"}},"return"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#9ECBFF"}},'"hello"'),c("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"}")])])]),c("pre",{class:"shiki github-light vp-code-light"},[c("code",null,[c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"@"),c("span",{style:{color:"#D73A49"}},"ResponseBody")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"@"),c("span",{style:{color:"#D73A49"}},"GetMapping"),c("span",{style:{color:"#24292E"}},"("),c("span",{style:{color:"#032F62"}},'"/hello"'),c("span",{style:{color:"#24292E"}},")")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#D73A49"}},"public"),c("span",{style:{color:"#24292E"}}," String "),c("span",{style:{color:"#6F42C1"}},"hello"),c("span",{style:{color:"#24292E"}},"() {")]),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#6A737D"}},"//1、获取一把锁，只要锁的名字一样，就是同一把锁")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    RLock lock "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," redisson."),c("span",{style:{color:"#6F42C1"}},"getLock"),c("span",{style:{color:"#24292E"}},"("),c("span",{style:{color:"#032F62"}},'"my-lock"'),c("span",{style:{color:"#24292E"}},");")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#6A737D"}},"//2、加锁 阻塞式等待，(默认加的锁都是30s时间)即如果加不到锁，就会在这一直等直到加到锁为止才继续执行下去")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#6A737D"}},"//lock.lock();")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#6A737D"}},"//1)、锁的自动续期，如果业务超长，运行期间自动给锁续上新的30s，即不用担心业务时间长而锁自动过期被删掉")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#6A737D"}},"//2)、加锁的业务只要运行完成，就不会给当前锁续期，即使不手动解锁，锁默认在30s以后自动删除")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#6A737D"}},"//10秒自动解锁，自动解锁时间一定要大于业务的执行时间")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    lock."),c("span",{style:{color:"#6F42C1"}},"lock"),c("span",{style:{color:"#24292E"}},"("),c("span",{style:{color:"#005CC5"}},"30"),c("span",{style:{color:"#24292E"}},", TimeUnit.SECONDS);")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#6A737D"}},"//todo 问题：lock.lock(10, TimeUnit.SECONDS);在锁时间到了以后，不会自动续期")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#6A737D"}},"//1、如果我们传递了锁的超时时间，就发送给redis执行脚本，进行占锁，默认超时时间就是我们指定的时间")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#6A737D"}},"//2、如果我们未指定锁的超时时间，就使用30*1000【LockWatchingTimeout看门狗的默认时间】；")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#6A737D"}},"//     只要占锁成功，就会启动一个定时任务【重新给锁设置过期时间，新的过期时间就是看门狗的默认时间】，每隔10s都会自动再次续期，续成30s")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#6A737D"}},"//     internalLockLeaseTime【看门狗时间】/  3,10s")]),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#6A737D"}},"//最佳实战")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#6A737D"}},"//1）、lock.lock(30, TimeUnit.SECONDS);省掉了整个续期操作，手动解锁")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#D73A49"}},"try"),c("span",{style:{color:"#24292E"}}," {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        System.out."),c("span",{style:{color:"#6F42C1"}},"println"),c("span",{style:{color:"#24292E"}},"("),c("span",{style:{color:"#032F62"}},'"加锁成功，执行业务。。。"'),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#D73A49"}},"+"),c("span",{style:{color:"#24292E"}}," Thread."),c("span",{style:{color:"#6F42C1"}},"currentThread"),c("span",{style:{color:"#24292E"}},"()."),c("span",{style:{color:"#6F42C1"}},"getId"),c("span",{style:{color:"#24292E"}},"());")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        Thread."),c("span",{style:{color:"#6F42C1"}},"sleep"),c("span",{style:{color:"#24292E"}},"("),c("span",{style:{color:"#005CC5"}},"30000"),c("span",{style:{color:"#24292E"}},");")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    } "),c("span",{style:{color:"#D73A49"}},"catch"),c("span",{style:{color:"#24292E"}}," (Exception "),c("span",{style:{color:"#E36209"}},"e"),c("span",{style:{color:"#24292E"}},") {")]),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    } "),c("span",{style:{color:"#D73A49"}},"finally"),c("span",{style:{color:"#24292E"}}," {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        "),c("span",{style:{color:"#6A737D"}},"//3、解锁  假设解锁代码没有运行，redisson会不会出现死锁")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        System.out."),c("span",{style:{color:"#6F42C1"}},"println"),c("span",{style:{color:"#24292E"}},"("),c("span",{style:{color:"#032F62"}},'"释放锁。。。"'),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#D73A49"}},"+"),c("span",{style:{color:"#24292E"}}," Thread."),c("span",{style:{color:"#6F42C1"}},"currentThread"),c("span",{style:{color:"#24292E"}},"()."),c("span",{style:{color:"#6F42C1"}},"getId"),c("span",{style:{color:"#24292E"}},"());")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        lock."),c("span",{style:{color:"#6F42C1"}},"unlock"),c("span",{style:{color:"#24292E"}},"();")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    }")]),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#D73A49"}},"return"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#032F62"}},'"hello"'),c("span",{style:{color:"#24292E"}},";")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"}")])])])],-1),Aa=c("p",null,[c("strong",null,"1、读+写锁")],-1),Ca=c("div",{class:"language-java"},[c("button",{title:"Copy Code",class:"copy"}),c("span",{class:"lang"},"java"),c("pre",{class:"shiki github-dark vp-code-dark"},[c("code",null,[c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"/**")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"     * 保证一定读到最新数据，修改期间，写锁是一个排它锁（互斥锁、独享锁），读锁是一个共享锁")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"     * 写锁没释放读就必须等待")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"     * 读 + 读： 相当于无锁，并发读，只会在redis中记录好，所有当前的读锁，它们都会同时加锁成功")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"     * 写 + 读： 等待写锁释放")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"     * 写 + 写： 阻塞状态")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"     * 读 + 写： 有读锁，写也需要等待")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"     * 只要有写的存在，都必须等待")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"     * "),c("span",{style:{color:"#F97583"}},"@return")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"     */")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    @"),c("span",{style:{color:"#F97583"}},"ResponseBody")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    @"),c("span",{style:{color:"#F97583"}},"GetMapping"),c("span",{style:{color:"#E1E4E8"}},"("),c("span",{style:{color:"#9ECBFF"}},'"/write"'),c("span",{style:{color:"#E1E4E8"}},")")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#F97583"}},"public"),c("span",{style:{color:"#E1E4E8"}}," String "),c("span",{style:{color:"#B392F0"}},"writeValue"),c("span",{style:{color:"#E1E4E8"}},"() {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        RReadWriteLock lock "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," redisson."),c("span",{style:{color:"#B392F0"}},"getReadWriteLock"),c("span",{style:{color:"#E1E4E8"}},"("),c("span",{style:{color:"#9ECBFF"}},'"rw-lock"'),c("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        String s "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#9ECBFF"}},'""'),c("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        RLock rLock "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," lock."),c("span",{style:{color:"#B392F0"}},"writeLock"),c("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        "),c("span",{style:{color:"#F97583"}},"try"),c("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"            "),c("span",{style:{color:"#6A737D"}},"//1、改数据加写锁，读数据加读锁")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"            rLock."),c("span",{style:{color:"#B392F0"}},"lock"),c("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"            System.out."),c("span",{style:{color:"#B392F0"}},"println"),c("span",{style:{color:"#E1E4E8"}},"("),c("span",{style:{color:"#9ECBFF"}},'"写锁加锁成功..."'),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#F97583"}},"+"),c("span",{style:{color:"#E1E4E8"}}," Thread."),c("span",{style:{color:"#B392F0"}},"currentThread"),c("span",{style:{color:"#E1E4E8"}},"()."),c("span",{style:{color:"#B392F0"}},"getId"),c("span",{style:{color:"#E1E4E8"}},"());")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"            "),c("span",{style:{color:"#6A737D"}},"//v")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"            s "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," UUID."),c("span",{style:{color:"#B392F0"}},"randomUUID"),c("span",{style:{color:"#E1E4E8"}},"()."),c("span",{style:{color:"#B392F0"}},"toString"),c("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"            Thread."),c("span",{style:{color:"#B392F0"}},"sleep"),c("span",{style:{color:"#E1E4E8"}},"("),c("span",{style:{color:"#79B8FF"}},"30000"),c("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"            "),c("span",{style:{color:"#6A737D"}},"//                                  k         v")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"            redisTemplate."),c("span",{style:{color:"#B392F0"}},"opsForValue"),c("span",{style:{color:"#E1E4E8"}},"()."),c("span",{style:{color:"#B392F0"}},"set"),c("span",{style:{color:"#E1E4E8"}},"("),c("span",{style:{color:"#9ECBFF"}},'"writeValue"'),c("span",{style:{color:"#E1E4E8"}},", s);")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        } "),c("span",{style:{color:"#F97583"}},"catch"),c("span",{style:{color:"#E1E4E8"}}," (Exception "),c("span",{style:{color:"#FFAB70"}},"e"),c("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        } "),c("span",{style:{color:"#F97583"}},"finally"),c("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"            rLock."),c("span",{style:{color:"#B392F0"}},"unlock"),c("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"            System.out."),c("span",{style:{color:"#B392F0"}},"println"),c("span",{style:{color:"#E1E4E8"}},"("),c("span",{style:{color:"#9ECBFF"}},'"写锁释放"'),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#F97583"}},"+"),c("span",{style:{color:"#E1E4E8"}}," Thread."),c("span",{style:{color:"#B392F0"}},"currentThread"),c("span",{style:{color:"#E1E4E8"}},"()."),c("span",{style:{color:"#B392F0"}},"getId"),c("span",{style:{color:"#E1E4E8"}},"());")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        }")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        "),c("span",{style:{color:"#F97583"}},"return"),c("span",{style:{color:"#E1E4E8"}}," s;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#6A737D"}},"//分布式里的锁跟JUC的API里的锁完全一样")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    @"),c("span",{style:{color:"#F97583"}},"ResponseBody")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    @"),c("span",{style:{color:"#F97583"}},"GetMapping"),c("span",{style:{color:"#E1E4E8"}},"("),c("span",{style:{color:"#9ECBFF"}},'"/read"'),c("span",{style:{color:"#E1E4E8"}},")")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#F97583"}},"public"),c("span",{style:{color:"#E1E4E8"}}," String "),c("span",{style:{color:"#B392F0"}},"readValue"),c("span",{style:{color:"#E1E4E8"}},"() {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        RReadWriteLock lock "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," redisson."),c("span",{style:{color:"#B392F0"}},"getReadWriteLock"),c("span",{style:{color:"#E1E4E8"}},"("),c("span",{style:{color:"#9ECBFF"}},'"rw-lock"'),c("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"//        ReentrantReadWriteLock reentrantReadWriteLock = new ReentrantReadWriteLock();")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        String s "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#9ECBFF"}},'""'),c("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        RLock rLock "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," lock."),c("span",{style:{color:"#B392F0"}},"readLock"),c("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        "),c("span",{style:{color:"#6A737D"}},"//1、读数据加读锁")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        rLock."),c("span",{style:{color:"#B392F0"}},"lock"),c("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        "),c("span",{style:{color:"#F97583"}},"try"),c("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"            System.out."),c("span",{style:{color:"#B392F0"}},"println"),c("span",{style:{color:"#E1E4E8"}},"("),c("span",{style:{color:"#9ECBFF"}},'"读锁加锁成功....."'),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#F97583"}},"+"),c("span",{style:{color:"#E1E4E8"}}," Thread."),c("span",{style:{color:"#B392F0"}},"currentThread"),c("span",{style:{color:"#E1E4E8"}},"()."),c("span",{style:{color:"#B392F0"}},"getId"),c("span",{style:{color:"#E1E4E8"}},"());")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"            s "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," redisTemplate."),c("span",{style:{color:"#B392F0"}},"opsForValue"),c("span",{style:{color:"#E1E4E8"}},"()."),c("span",{style:{color:"#B392F0"}},"get"),c("span",{style:{color:"#E1E4E8"}},"("),c("span",{style:{color:"#9ECBFF"}},'"writeValue"'),c("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"            Thread."),c("span",{style:{color:"#B392F0"}},"sleep"),c("span",{style:{color:"#E1E4E8"}},"("),c("span",{style:{color:"#79B8FF"}},"30000"),c("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        } "),c("span",{style:{color:"#F97583"}},"catch"),c("span",{style:{color:"#E1E4E8"}}," (Exception "),c("span",{style:{color:"#FFAB70"}},"e"),c("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        } "),c("span",{style:{color:"#F97583"}},"finally"),c("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"            rLock."),c("span",{style:{color:"#B392F0"}},"unlock"),c("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"            System.out."),c("span",{style:{color:"#B392F0"}},"println"),c("span",{style:{color:"#E1E4E8"}},"("),c("span",{style:{color:"#9ECBFF"}},'"读锁释放"'),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#F97583"}},"+"),c("span",{style:{color:"#E1E4E8"}}," Thread."),c("span",{style:{color:"#B392F0"}},"currentThread"),c("span",{style:{color:"#E1E4E8"}},"()."),c("span",{style:{color:"#B392F0"}},"getId"),c("span",{style:{color:"#E1E4E8"}},"());")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        }")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        "),c("span",{style:{color:"#F97583"}},"return"),c("span",{style:{color:"#E1E4E8"}}," s;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    }")])])]),c("pre",{class:"shiki github-light vp-code-light"},[c("code",null,[c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"/**")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"     * 保证一定读到最新数据，修改期间，写锁是一个排它锁（互斥锁、独享锁），读锁是一个共享锁")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"     * 写锁没释放读就必须等待")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"     * 读 + 读： 相当于无锁，并发读，只会在redis中记录好，所有当前的读锁，它们都会同时加锁成功")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"     * 写 + 读： 等待写锁释放")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"     * 写 + 写： 阻塞状态")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"     * 读 + 写： 有读锁，写也需要等待")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"     * 只要有写的存在，都必须等待")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"     * "),c("span",{style:{color:"#D73A49"}},"@return")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"     */")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    @"),c("span",{style:{color:"#D73A49"}},"ResponseBody")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    @"),c("span",{style:{color:"#D73A49"}},"GetMapping"),c("span",{style:{color:"#24292E"}},"("),c("span",{style:{color:"#032F62"}},'"/write"'),c("span",{style:{color:"#24292E"}},")")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#D73A49"}},"public"),c("span",{style:{color:"#24292E"}}," String "),c("span",{style:{color:"#6F42C1"}},"writeValue"),c("span",{style:{color:"#24292E"}},"() {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        RReadWriteLock lock "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," redisson."),c("span",{style:{color:"#6F42C1"}},"getReadWriteLock"),c("span",{style:{color:"#24292E"}},"("),c("span",{style:{color:"#032F62"}},'"rw-lock"'),c("span",{style:{color:"#24292E"}},");")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        String s "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#032F62"}},'""'),c("span",{style:{color:"#24292E"}},";")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        RLock rLock "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," lock."),c("span",{style:{color:"#6F42C1"}},"writeLock"),c("span",{style:{color:"#24292E"}},"();")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        "),c("span",{style:{color:"#D73A49"}},"try"),c("span",{style:{color:"#24292E"}}," {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"            "),c("span",{style:{color:"#6A737D"}},"//1、改数据加写锁，读数据加读锁")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"            rLock."),c("span",{style:{color:"#6F42C1"}},"lock"),c("span",{style:{color:"#24292E"}},"();")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"            System.out."),c("span",{style:{color:"#6F42C1"}},"println"),c("span",{style:{color:"#24292E"}},"("),c("span",{style:{color:"#032F62"}},'"写锁加锁成功..."'),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#D73A49"}},"+"),c("span",{style:{color:"#24292E"}}," Thread."),c("span",{style:{color:"#6F42C1"}},"currentThread"),c("span",{style:{color:"#24292E"}},"()."),c("span",{style:{color:"#6F42C1"}},"getId"),c("span",{style:{color:"#24292E"}},"());")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"            "),c("span",{style:{color:"#6A737D"}},"//v")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"            s "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," UUID."),c("span",{style:{color:"#6F42C1"}},"randomUUID"),c("span",{style:{color:"#24292E"}},"()."),c("span",{style:{color:"#6F42C1"}},"toString"),c("span",{style:{color:"#24292E"}},"();")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"            Thread."),c("span",{style:{color:"#6F42C1"}},"sleep"),c("span",{style:{color:"#24292E"}},"("),c("span",{style:{color:"#005CC5"}},"30000"),c("span",{style:{color:"#24292E"}},");")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"            "),c("span",{style:{color:"#6A737D"}},"//                                  k         v")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"            redisTemplate."),c("span",{style:{color:"#6F42C1"}},"opsForValue"),c("span",{style:{color:"#24292E"}},"()."),c("span",{style:{color:"#6F42C1"}},"set"),c("span",{style:{color:"#24292E"}},"("),c("span",{style:{color:"#032F62"}},'"writeValue"'),c("span",{style:{color:"#24292E"}},", s);")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        } "),c("span",{style:{color:"#D73A49"}},"catch"),c("span",{style:{color:"#24292E"}}," (Exception "),c("span",{style:{color:"#E36209"}},"e"),c("span",{style:{color:"#24292E"}},") {")]),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        } "),c("span",{style:{color:"#D73A49"}},"finally"),c("span",{style:{color:"#24292E"}}," {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"            rLock."),c("span",{style:{color:"#6F42C1"}},"unlock"),c("span",{style:{color:"#24292E"}},"();")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"            System.out."),c("span",{style:{color:"#6F42C1"}},"println"),c("span",{style:{color:"#24292E"}},"("),c("span",{style:{color:"#032F62"}},'"写锁释放"'),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#D73A49"}},"+"),c("span",{style:{color:"#24292E"}}," Thread."),c("span",{style:{color:"#6F42C1"}},"currentThread"),c("span",{style:{color:"#24292E"}},"()."),c("span",{style:{color:"#6F42C1"}},"getId"),c("span",{style:{color:"#24292E"}},"());")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        }")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        "),c("span",{style:{color:"#D73A49"}},"return"),c("span",{style:{color:"#24292E"}}," s;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    }")]),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#6A737D"}},"//分布式里的锁跟JUC的API里的锁完全一样")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    @"),c("span",{style:{color:"#D73A49"}},"ResponseBody")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    @"),c("span",{style:{color:"#D73A49"}},"GetMapping"),c("span",{style:{color:"#24292E"}},"("),c("span",{style:{color:"#032F62"}},'"/read"'),c("span",{style:{color:"#24292E"}},")")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#D73A49"}},"public"),c("span",{style:{color:"#24292E"}}," String "),c("span",{style:{color:"#6F42C1"}},"readValue"),c("span",{style:{color:"#24292E"}},"() {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        RReadWriteLock lock "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," redisson."),c("span",{style:{color:"#6F42C1"}},"getReadWriteLock"),c("span",{style:{color:"#24292E"}},"("),c("span",{style:{color:"#032F62"}},'"rw-lock"'),c("span",{style:{color:"#24292E"}},");")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"//        ReentrantReadWriteLock reentrantReadWriteLock = new ReentrantReadWriteLock();")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        String s "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#032F62"}},'""'),c("span",{style:{color:"#24292E"}},";")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        RLock rLock "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," lock."),c("span",{style:{color:"#6F42C1"}},"readLock"),c("span",{style:{color:"#24292E"}},"();")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        "),c("span",{style:{color:"#6A737D"}},"//1、读数据加读锁")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        rLock."),c("span",{style:{color:"#6F42C1"}},"lock"),c("span",{style:{color:"#24292E"}},"();")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        "),c("span",{style:{color:"#D73A49"}},"try"),c("span",{style:{color:"#24292E"}}," {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"            System.out."),c("span",{style:{color:"#6F42C1"}},"println"),c("span",{style:{color:"#24292E"}},"("),c("span",{style:{color:"#032F62"}},'"读锁加锁成功....."'),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#D73A49"}},"+"),c("span",{style:{color:"#24292E"}}," Thread."),c("span",{style:{color:"#6F42C1"}},"currentThread"),c("span",{style:{color:"#24292E"}},"()."),c("span",{style:{color:"#6F42C1"}},"getId"),c("span",{style:{color:"#24292E"}},"());")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"            s "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," redisTemplate."),c("span",{style:{color:"#6F42C1"}},"opsForValue"),c("span",{style:{color:"#24292E"}},"()."),c("span",{style:{color:"#6F42C1"}},"get"),c("span",{style:{color:"#24292E"}},"("),c("span",{style:{color:"#032F62"}},'"writeValue"'),c("span",{style:{color:"#24292E"}},");")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"            Thread."),c("span",{style:{color:"#6F42C1"}},"sleep"),c("span",{style:{color:"#24292E"}},"("),c("span",{style:{color:"#005CC5"}},"30000"),c("span",{style:{color:"#24292E"}},");")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        } "),c("span",{style:{color:"#D73A49"}},"catch"),c("span",{style:{color:"#24292E"}}," (Exception "),c("span",{style:{color:"#E36209"}},"e"),c("span",{style:{color:"#24292E"}},") {")]),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        } "),c("span",{style:{color:"#D73A49"}},"finally"),c("span",{style:{color:"#24292E"}}," {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"            rLock."),c("span",{style:{color:"#6F42C1"}},"unlock"),c("span",{style:{color:"#24292E"}},"();")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"            System.out."),c("span",{style:{color:"#6F42C1"}},"println"),c("span",{style:{color:"#24292E"}},"("),c("span",{style:{color:"#032F62"}},'"读锁释放"'),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#D73A49"}},"+"),c("span",{style:{color:"#24292E"}}," Thread."),c("span",{style:{color:"#6F42C1"}},"currentThread"),c("span",{style:{color:"#24292E"}},"()."),c("span",{style:{color:"#6F42C1"}},"getId"),c("span",{style:{color:"#24292E"}},"());")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        }")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        "),c("span",{style:{color:"#D73A49"}},"return"),c("span",{style:{color:"#24292E"}}," s;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    }")])])])],-1),ha=c("p",null,[c("strong",null,"2、信号量")],-1),ma=c("div",{class:"language-java"},[c("button",{title:"Copy Code",class:"copy"}),c("span",{class:"lang"},"java"),c("pre",{class:"shiki github-dark vp-code-dark"},[c("code",null,[c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"/**")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"     * 车库停车")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"     * 3车位")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"     * 信号量也可以用作分布式限流")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"     * "),c("span",{style:{color:"#F97583"}},"@return")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"     */")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    @"),c("span",{style:{color:"#F97583"}},"ResponseBody")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    @"),c("span",{style:{color:"#F97583"}},"GetMapping"),c("span",{style:{color:"#E1E4E8"}},"("),c("span",{style:{color:"#9ECBFF"}},'"/park"'),c("span",{style:{color:"#E1E4E8"}},")")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#F97583"}},"public"),c("span",{style:{color:"#E1E4E8"}}," String "),c("span",{style:{color:"#B392F0"}},"park"),c("span",{style:{color:"#E1E4E8"}},"() throws InterruptedException {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        RSemaphore park "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," redisson."),c("span",{style:{color:"#B392F0"}},"getSemaphore"),c("span",{style:{color:"#E1E4E8"}},"("),c("span",{style:{color:"#9ECBFF"}},'"park"'),c("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"//        park.acquire();//获取一个信号，获取一个值，占一个车位，阻塞式获取，即一定要获取到一个车位")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        "),c("span",{style:{color:"#F97583"}},"boolean"),c("span",{style:{color:"#E1E4E8"}}," b "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," park."),c("span",{style:{color:"#B392F0"}},"tryAcquire"),c("span",{style:{color:"#E1E4E8"}},"();"),c("span",{style:{color:"#6A737D"}},"//尝试获取车位，有就停，没有就算了")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        "),c("span",{style:{color:"#F97583"}},"if"),c("span",{style:{color:"#E1E4E8"}}," (b){")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"            "),c("span",{style:{color:"#6A737D"}},"//执行业务")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        }"),c("span",{style:{color:"#F97583"}},"else"),c("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"            "),c("span",{style:{color:"#F97583"}},"return"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#9ECBFF"}},'"error"'),c("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        }")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        "),c("span",{style:{color:"#F97583"}},"return"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#9ECBFF"}},'"ok=>"'),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#F97583"}},"+"),c("span",{style:{color:"#E1E4E8"}}," b;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"    /**")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"     * 把车开走，腾空车位")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"     * "),c("span",{style:{color:"#F97583"}},"@return")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"     */")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    @"),c("span",{style:{color:"#F97583"}},"ResponseBody")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    @"),c("span",{style:{color:"#F97583"}},"GetMapping"),c("span",{style:{color:"#E1E4E8"}},"("),c("span",{style:{color:"#9ECBFF"}},'"/go"'),c("span",{style:{color:"#E1E4E8"}},")")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#F97583"}},"public"),c("span",{style:{color:"#E1E4E8"}}," String "),c("span",{style:{color:"#B392F0"}},"go"),c("span",{style:{color:"#E1E4E8"}},"(){")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        RSemaphore park "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," redisson."),c("span",{style:{color:"#B392F0"}},"getSemaphore"),c("span",{style:{color:"#E1E4E8"}},"("),c("span",{style:{color:"#9ECBFF"}},'"park"'),c("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        park."),c("span",{style:{color:"#B392F0"}},"release"),c("span",{style:{color:"#E1E4E8"}},"();"),c("span",{style:{color:"#6A737D"}},"//释放一个信号(车位)")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        "),c("span",{style:{color:"#F97583"}},"return"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#9ECBFF"}},'"ok"'),c("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    }")])])]),c("pre",{class:"shiki github-light vp-code-light"},[c("code",null,[c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"/**")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"     * 车库停车")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"     * 3车位")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"     * 信号量也可以用作分布式限流")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"     * "),c("span",{style:{color:"#D73A49"}},"@return")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"     */")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    @"),c("span",{style:{color:"#D73A49"}},"ResponseBody")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    @"),c("span",{style:{color:"#D73A49"}},"GetMapping"),c("span",{style:{color:"#24292E"}},"("),c("span",{style:{color:"#032F62"}},'"/park"'),c("span",{style:{color:"#24292E"}},")")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#D73A49"}},"public"),c("span",{style:{color:"#24292E"}}," String "),c("span",{style:{color:"#6F42C1"}},"park"),c("span",{style:{color:"#24292E"}},"() throws InterruptedException {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        RSemaphore park "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," redisson."),c("span",{style:{color:"#6F42C1"}},"getSemaphore"),c("span",{style:{color:"#24292E"}},"("),c("span",{style:{color:"#032F62"}},'"park"'),c("span",{style:{color:"#24292E"}},");")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"//        park.acquire();//获取一个信号，获取一个值，占一个车位，阻塞式获取，即一定要获取到一个车位")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        "),c("span",{style:{color:"#D73A49"}},"boolean"),c("span",{style:{color:"#24292E"}}," b "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," park."),c("span",{style:{color:"#6F42C1"}},"tryAcquire"),c("span",{style:{color:"#24292E"}},"();"),c("span",{style:{color:"#6A737D"}},"//尝试获取车位，有就停，没有就算了")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        "),c("span",{style:{color:"#D73A49"}},"if"),c("span",{style:{color:"#24292E"}}," (b){")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"            "),c("span",{style:{color:"#6A737D"}},"//执行业务")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        }"),c("span",{style:{color:"#D73A49"}},"else"),c("span",{style:{color:"#24292E"}}," {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"            "),c("span",{style:{color:"#D73A49"}},"return"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#032F62"}},'"error"'),c("span",{style:{color:"#24292E"}},";")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        }")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        "),c("span",{style:{color:"#D73A49"}},"return"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#032F62"}},'"ok=>"'),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#D73A49"}},"+"),c("span",{style:{color:"#24292E"}}," b;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    }")]),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"    /**")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"     * 把车开走，腾空车位")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"     * "),c("span",{style:{color:"#D73A49"}},"@return")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"     */")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    @"),c("span",{style:{color:"#D73A49"}},"ResponseBody")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    @"),c("span",{style:{color:"#D73A49"}},"GetMapping"),c("span",{style:{color:"#24292E"}},"("),c("span",{style:{color:"#032F62"}},'"/go"'),c("span",{style:{color:"#24292E"}},")")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#D73A49"}},"public"),c("span",{style:{color:"#24292E"}}," String "),c("span",{style:{color:"#6F42C1"}},"go"),c("span",{style:{color:"#24292E"}},"(){")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        RSemaphore park "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," redisson."),c("span",{style:{color:"#6F42C1"}},"getSemaphore"),c("span",{style:{color:"#24292E"}},"("),c("span",{style:{color:"#032F62"}},'"park"'),c("span",{style:{color:"#24292E"}},");")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        park."),c("span",{style:{color:"#6F42C1"}},"release"),c("span",{style:{color:"#24292E"}},"();"),c("span",{style:{color:"#6A737D"}},"//释放一个信号(车位)")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        "),c("span",{style:{color:"#D73A49"}},"return"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#032F62"}},'"ok"'),c("span",{style:{color:"#24292E"}},";")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    }")])])])],-1),ka=c("p",null,"3、CountDownLatch闭锁",-1),ba=c("div",{class:"language-java"},[c("button",{title:"Copy Code",class:"copy"}),c("span",{class:"lang"},"java"),c("pre",{class:"shiki github-dark vp-code-dark"},[c("code",null,[c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"/**")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}}," * 放假 锁门")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}}," * 1班没人了，2")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}}," * 5个班全部都走完，我们可以锁大门")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}}," * "),c("span",{style:{color:"#F97583"}},"@return")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}}," */")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"@"),c("span",{style:{color:"#F97583"}},"ResponseBody")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"@"),c("span",{style:{color:"#F97583"}},"GetMapping"),c("span",{style:{color:"#E1E4E8"}},"("),c("span",{style:{color:"#9ECBFF"}},'"/lockDoor"'),c("span",{style:{color:"#E1E4E8"}},")")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#F97583"}},"public"),c("span",{style:{color:"#E1E4E8"}}," String "),c("span",{style:{color:"#B392F0"}},"lockDoor"),c("span",{style:{color:"#E1E4E8"}},"() throws InterruptedException {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    RCountDownLatch door "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," redisson."),c("span",{style:{color:"#B392F0"}},"getCountDownLatch"),c("span",{style:{color:"#E1E4E8"}},"("),c("span",{style:{color:"#9ECBFF"}},'"door"'),c("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    door."),c("span",{style:{color:"#B392F0"}},"trySetCount"),c("span",{style:{color:"#E1E4E8"}},"("),c("span",{style:{color:"#79B8FF"}},"5"),c("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    door."),c("span",{style:{color:"#B392F0"}},"await"),c("span",{style:{color:"#E1E4E8"}},"();"),c("span",{style:{color:"#6A737D"}},"//等待闭锁都完成")]),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#F97583"}},"return"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#9ECBFF"}},'"放假了..."'),c("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"}")]),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"@"),c("span",{style:{color:"#F97583"}},"ResponseBody")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"@"),c("span",{style:{color:"#F97583"}},"GetMapping"),c("span",{style:{color:"#E1E4E8"}},"("),c("span",{style:{color:"#9ECBFF"}},'"/gogogo/{id}"'),c("span",{style:{color:"#E1E4E8"}},")")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#F97583"}},"public"),c("span",{style:{color:"#E1E4E8"}}," String "),c("span",{style:{color:"#B392F0"}},"gogogo"),c("span",{style:{color:"#E1E4E8"}},"(@"),c("span",{style:{color:"#F97583"}},"PathVariable"),c("span",{style:{color:"#E1E4E8"}},"("),c("span",{style:{color:"#9ECBFF"}},'"id"'),c("span",{style:{color:"#E1E4E8"}},") Long id){")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    RCountDownLatch door "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," redisson."),c("span",{style:{color:"#B392F0"}},"getCountDownLatch"),c("span",{style:{color:"#E1E4E8"}},"("),c("span",{style:{color:"#9ECBFF"}},'"door"'),c("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    door."),c("span",{style:{color:"#B392F0"}},"countDown"),c("span",{style:{color:"#E1E4E8"}},"();"),c("span",{style:{color:"#6A737D"}},"//计数减一")]),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#F97583"}},"return"),c("span",{style:{color:"#E1E4E8"}}," id "),c("span",{style:{color:"#F97583"}},"+"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#9ECBFF"}},'"班的人都走了..."'),c("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"}")])])]),c("pre",{class:"shiki github-light vp-code-light"},[c("code",null,[c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"/**")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}}," * 放假 锁门")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}}," * 1班没人了，2")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}}," * 5个班全部都走完，我们可以锁大门")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}}," * "),c("span",{style:{color:"#D73A49"}},"@return")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}}," */")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"@"),c("span",{style:{color:"#D73A49"}},"ResponseBody")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"@"),c("span",{style:{color:"#D73A49"}},"GetMapping"),c("span",{style:{color:"#24292E"}},"("),c("span",{style:{color:"#032F62"}},'"/lockDoor"'),c("span",{style:{color:"#24292E"}},")")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#D73A49"}},"public"),c("span",{style:{color:"#24292E"}}," String "),c("span",{style:{color:"#6F42C1"}},"lockDoor"),c("span",{style:{color:"#24292E"}},"() throws InterruptedException {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    RCountDownLatch door "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," redisson."),c("span",{style:{color:"#6F42C1"}},"getCountDownLatch"),c("span",{style:{color:"#24292E"}},"("),c("span",{style:{color:"#032F62"}},'"door"'),c("span",{style:{color:"#24292E"}},");")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    door."),c("span",{style:{color:"#6F42C1"}},"trySetCount"),c("span",{style:{color:"#24292E"}},"("),c("span",{style:{color:"#005CC5"}},"5"),c("span",{style:{color:"#24292E"}},");")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    door."),c("span",{style:{color:"#6F42C1"}},"await"),c("span",{style:{color:"#24292E"}},"();"),c("span",{style:{color:"#6A737D"}},"//等待闭锁都完成")]),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#D73A49"}},"return"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#032F62"}},'"放假了..."'),c("span",{style:{color:"#24292E"}},";")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"}")]),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"@"),c("span",{style:{color:"#D73A49"}},"ResponseBody")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"@"),c("span",{style:{color:"#D73A49"}},"GetMapping"),c("span",{style:{color:"#24292E"}},"("),c("span",{style:{color:"#032F62"}},'"/gogogo/{id}"'),c("span",{style:{color:"#24292E"}},")")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#D73A49"}},"public"),c("span",{style:{color:"#24292E"}}," String "),c("span",{style:{color:"#6F42C1"}},"gogogo"),c("span",{style:{color:"#24292E"}},"(@"),c("span",{style:{color:"#D73A49"}},"PathVariable"),c("span",{style:{color:"#24292E"}},"("),c("span",{style:{color:"#032F62"}},'"id"'),c("span",{style:{color:"#24292E"}},") Long id){")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    RCountDownLatch door "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," redisson."),c("span",{style:{color:"#6F42C1"}},"getCountDownLatch"),c("span",{style:{color:"#24292E"}},"("),c("span",{style:{color:"#032F62"}},'"door"'),c("span",{style:{color:"#24292E"}},");")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    door."),c("span",{style:{color:"#6F42C1"}},"countDown"),c("span",{style:{color:"#24292E"}},"();"),c("span",{style:{color:"#6A737D"}},"//计数减一")]),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#D73A49"}},"return"),c("span",{style:{color:"#24292E"}}," id "),c("span",{style:{color:"#D73A49"}},"+"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#032F62"}},'"班的人都走了..."'),c("span",{style:{color:"#24292E"}},";")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"}")])])])],-1),Ba={id:"五、spring-cache",tabindex:"-1"},Sa={id:"_1、简介",tabindex:"-1"},Ia=c("ul",null,[c("li",null,[c("p",null,"Spring 从 3.1 开始定义了 org.springframework.cache.Cache和 org.springframework.cache.CacheManager 接口来统一不同的缓存技术；并支持使用 JCache（JSR-107）注解简化我们开发；")]),c("li",null,[c("p",null,"Cache 接口为缓存的组件规范定义，包含缓存的各种操作集合；Cache 接口下 Spring 提供了各种 xxxCache 的实现；如 RedisCache ，EhCacheCache， ConcurrentMapCache 等；")]),c("li",null,[c("p",null,"每次调用需要缓存功能的方法时，Spring 会检查检查指定参数的指定的目标方法是否已经被调用过；如果有就直接从缓存中获取方法调用后的结果，如果没有就调用方法并缓存结果后返回给用户。下次调用直接从缓存中获取。")]),c("li",null,[c("p",null,"使用 Spring 缓存抽象时我们需要关注以下两点；"),c("ul",null,[c("li",null,[c("p",null,"1、确定方法需要被缓存以及他们的缓存策略")]),c("li",null,[c("p",null,"2、从缓存中读取之前缓存存储的数据")])])])],-1),fa={id:"_2、基础概念",tabindex:"-1"},va=c("figure",null,[c("img",{src:"https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230425221542910.png",alt:"image-20230425221542910",loading:"lazy",decoding:"async"})],-1),La={id:"_3、注解",tabindex:"-1"},_a=c("figure",null,[c("img",{src:"https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230425221610523.png",alt:"image-20230425221610523",loading:"lazy",decoding:"async"})],-1),Ra=c("figure",null,[c("img",{src:"https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230425221629685.png",alt:"image-20230425221629685",loading:"lazy",decoding:"async"})],-1),Ta={id:"_4、表达式语法",tabindex:"-1"},ja=c("figure",null,[c("img",{src:"https://jsd.cdn.zzko.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230425221651923.png",alt:"image-20230425221651923",loading:"lazy",decoding:"async"})],-1),Oa={id:"_5、缓存穿透问题解决-允许-null-值缓存",tabindex:"-1"},xa=c("div",{class:"language-xml"},[c("button",{title:"Copy Code",class:"copy"}),c("span",{class:"lang"},"xml"),c("pre",{class:"shiki github-dark vp-code-dark"},[c("code",null,[c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"<"),c("span",{style:{color:"#85E89D"}},"dependency"),c("span",{style:{color:"#E1E4E8"}},">")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    <"),c("span",{style:{color:"#85E89D"}},"groupId"),c("span",{style:{color:"#E1E4E8"}},">org.springframework.boot</"),c("span",{style:{color:"#85E89D"}},"groupId"),c("span",{style:{color:"#E1E4E8"}},">")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    <"),c("span",{style:{color:"#85E89D"}},"artifactId"),c("span",{style:{color:"#E1E4E8"}},">spring-boot-starter-data-redis</"),c("span",{style:{color:"#85E89D"}},"artifactId"),c("span",{style:{color:"#E1E4E8"}},">")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"<"),c("span",{style:{color:"#85E89D"}},"dependency"),c("span",{style:{color:"#E1E4E8"}},">")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    <"),c("span",{style:{color:"#85E89D"}},"groupId"),c("span",{style:{color:"#E1E4E8"}},">org.springframework.boot</"),c("span",{style:{color:"#85E89D"}},"groupId"),c("span",{style:{color:"#E1E4E8"}},">")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    <"),c("span",{style:{color:"#85E89D"}},"artifactId"),c("span",{style:{color:"#E1E4E8"}},">spring-boot-starter-cache</"),c("span",{style:{color:"#85E89D"}},"artifactId"),c("span",{style:{color:"#E1E4E8"}},">")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"</"),c("span",{style:{color:"#85E89D"}},"dependency"),c("span",{style:{color:"#E1E4E8"}},">")])])]),c("pre",{class:"shiki github-light vp-code-light"},[c("code",null,[c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"<"),c("span",{style:{color:"#22863A"}},"dependency"),c("span",{style:{color:"#24292E"}},">")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    <"),c("span",{style:{color:"#22863A"}},"groupId"),c("span",{style:{color:"#24292E"}},">org.springframework.boot</"),c("span",{style:{color:"#22863A"}},"groupId"),c("span",{style:{color:"#24292E"}},">")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    <"),c("span",{style:{color:"#22863A"}},"artifactId"),c("span",{style:{color:"#24292E"}},">spring-boot-starter-data-redis</"),c("span",{style:{color:"#22863A"}},"artifactId"),c("span",{style:{color:"#24292E"}},">")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"<"),c("span",{style:{color:"#22863A"}},"dependency"),c("span",{style:{color:"#24292E"}},">")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    <"),c("span",{style:{color:"#22863A"}},"groupId"),c("span",{style:{color:"#24292E"}},">org.springframework.boot</"),c("span",{style:{color:"#22863A"}},"groupId"),c("span",{style:{color:"#24292E"}},">")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    <"),c("span",{style:{color:"#22863A"}},"artifactId"),c("span",{style:{color:"#24292E"}},">spring-boot-starter-cache</"),c("span",{style:{color:"#22863A"}},"artifactId"),c("span",{style:{color:"#24292E"}},">")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"</"),c("span",{style:{color:"#22863A"}},"dependency"),c("span",{style:{color:"#24292E"}},">")])])])],-1),Va={id:"_6、使用",tabindex:"-1"},za=c("ul",null,[c("li",null,"添加配置类将配置文件中的所有配置都生效")],-1),wa=c("div",{class:"language-java"},[c("button",{title:"Copy Code",class:"copy"}),c("span",{class:"lang"},"java"),c("pre",{class:"shiki github-dark vp-code-dark"},[c("code",null,[c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"/**")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}}," * "),c("span",{style:{color:"#F97583"}},"@author"),c("span",{style:{color:"#6A737D"}}," Klaus")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}}," * @date 2022/9/7")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}}," */")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"@"),c("span",{style:{color:"#F97583"}},"EnableConfigurationProperties"),c("span",{style:{color:"#E1E4E8"}},"(CacheProperties.class)")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"@"),c("span",{style:{color:"#F97583"}},"EnableCaching")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"@"),c("span",{style:{color:"#F97583"}},"Configuration")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#F97583"}},"public"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#F97583"}},"class"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#B392F0"}},"MyCacheConfig"),c("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"//    @Autowired")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"//    CacheProperties cacheProperties;")]),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"    /**")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"     * 配置文件中的东西没有用上")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"     *")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"     * 1、原来和配置文件绑定的配置类是这样子的")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},'     *      @ConfigurationProperties( prefix = "spring.cache")')]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"     *      public class CacheProperties {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"     * 2、要让它生效")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"     *      @EnableConfigurationProperties(CacheProperties.class)")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"     * "),c("span",{style:{color:"#F97583"}},"@return")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"     */")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    @"),c("span",{style:{color:"#F97583"}},"Bean")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    RedisCacheConfiguration "),c("span",{style:{color:"#B392F0"}},"redisCacheConfiguration"),c("span",{style:{color:"#E1E4E8"}},"(CacheProperties "),c("span",{style:{color:"#FFAB70"}},"cacheProperties"),c("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        RedisCacheConfiguration config "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," RedisCacheConfiguration."),c("span",{style:{color:"#B392F0"}},"defaultCacheConfig"),c("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        "),c("span",{style:{color:"#6A737D"}},"//config = config.entryTtl();")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        "),c("span",{style:{color:"#6A737D"}},"//覆盖默认配置")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        "),c("span",{style:{color:"#6A737D"}},"//将数据的key序列化为字符串")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        config "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," config."),c("span",{style:{color:"#B392F0"}},"serializeKeysWith"),c("span",{style:{color:"#E1E4E8"}},"(RedisSerializationContext.SerializationPair."),c("span",{style:{color:"#B392F0"}},"fromSerializer"),c("span",{style:{color:"#E1E4E8"}},"("),c("span",{style:{color:"#F97583"}},"new"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#B392F0"}},"StringRedisSerializer"),c("span",{style:{color:"#E1E4E8"}},"()));")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        "),c("span",{style:{color:"#6A737D"}},"//将数据的值序列化为json格式 new GenericFastJsonRedisSerializer()兼容各种泛型")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        config "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," config."),c("span",{style:{color:"#B392F0"}},"serializeValuesWith"),c("span",{style:{color:"#E1E4E8"}},"(RedisSerializationContext.SerializationPair."),c("span",{style:{color:"#B392F0"}},"fromSerializer"),c("span",{style:{color:"#E1E4E8"}},"("),c("span",{style:{color:"#F97583"}},"new"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#B392F0"}},"GenericJackson2JsonRedisSerializer"),c("span",{style:{color:"#E1E4E8"}},"()));")]),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        CacheProperties.Redis redisProperties "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," cacheProperties."),c("span",{style:{color:"#B392F0"}},"getRedis"),c("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        "),c("span",{style:{color:"#6A737D"}},"//将配置文件中的所有配置都生效")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        "),c("span",{style:{color:"#F97583"}},"if"),c("span",{style:{color:"#E1E4E8"}}," (redisProperties."),c("span",{style:{color:"#B392F0"}},"getTimeToLive"),c("span",{style:{color:"#E1E4E8"}},"() "),c("span",{style:{color:"#F97583"}},"!="),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#79B8FF"}},"null"),c("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"            config "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," config."),c("span",{style:{color:"#B392F0"}},"entryTtl"),c("span",{style:{color:"#E1E4E8"}},"(redisProperties."),c("span",{style:{color:"#B392F0"}},"getTimeToLive"),c("span",{style:{color:"#E1E4E8"}},"());")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        }")]),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        "),c("span",{style:{color:"#F97583"}},"if"),c("span",{style:{color:"#E1E4E8"}}," (redisProperties."),c("span",{style:{color:"#B392F0"}},"getKeyPrefix"),c("span",{style:{color:"#E1E4E8"}},"() "),c("span",{style:{color:"#F97583"}},"!="),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#79B8FF"}},"null"),c("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"            config "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," config."),c("span",{style:{color:"#B392F0"}},"prefixKeysWith"),c("span",{style:{color:"#E1E4E8"}},"(redisProperties."),c("span",{style:{color:"#B392F0"}},"getKeyPrefix"),c("span",{style:{color:"#E1E4E8"}},"());")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        }")]),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        "),c("span",{style:{color:"#F97583"}},"if"),c("span",{style:{color:"#E1E4E8"}}," ("),c("span",{style:{color:"#F97583"}},"!"),c("span",{style:{color:"#E1E4E8"}},"redisProperties."),c("span",{style:{color:"#B392F0"}},"isCacheNullValues"),c("span",{style:{color:"#E1E4E8"}},"()) {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"            config "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," config."),c("span",{style:{color:"#B392F0"}},"disableCachingNullValues"),c("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        }")]),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        "),c("span",{style:{color:"#F97583"}},"if"),c("span",{style:{color:"#E1E4E8"}}," ("),c("span",{style:{color:"#F97583"}},"!"),c("span",{style:{color:"#E1E4E8"}},"redisProperties."),c("span",{style:{color:"#B392F0"}},"isUseKeyPrefix"),c("span",{style:{color:"#E1E4E8"}},"()) {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"            config "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," config."),c("span",{style:{color:"#B392F0"}},"disableKeyPrefix"),c("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        }")]),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        "),c("span",{style:{color:"#F97583"}},"return"),c("span",{style:{color:"#E1E4E8"}}," config;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"}")])])]),c("pre",{class:"shiki github-light vp-code-light"},[c("code",null,[c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"/**")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}}," * "),c("span",{style:{color:"#D73A49"}},"@author"),c("span",{style:{color:"#6A737D"}}," Klaus")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}}," * @date 2022/9/7")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}}," */")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"@"),c("span",{style:{color:"#D73A49"}},"EnableConfigurationProperties"),c("span",{style:{color:"#24292E"}},"(CacheProperties.class)")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"@"),c("span",{style:{color:"#D73A49"}},"EnableCaching")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"@"),c("span",{style:{color:"#D73A49"}},"Configuration")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#D73A49"}},"public"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#D73A49"}},"class"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#6F42C1"}},"MyCacheConfig"),c("span",{style:{color:"#24292E"}}," {")]),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"//    @Autowired")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"//    CacheProperties cacheProperties;")]),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"    /**")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"     * 配置文件中的东西没有用上")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"     *")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"     * 1、原来和配置文件绑定的配置类是这样子的")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},'     *      @ConfigurationProperties( prefix = "spring.cache")')]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"     *      public class CacheProperties {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"     * 2、要让它生效")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"     *      @EnableConfigurationProperties(CacheProperties.class)")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"     * "),c("span",{style:{color:"#D73A49"}},"@return")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"     */")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    @"),c("span",{style:{color:"#D73A49"}},"Bean")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    RedisCacheConfiguration "),c("span",{style:{color:"#6F42C1"}},"redisCacheConfiguration"),c("span",{style:{color:"#24292E"}},"(CacheProperties "),c("span",{style:{color:"#E36209"}},"cacheProperties"),c("span",{style:{color:"#24292E"}},") {")]),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        RedisCacheConfiguration config "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," RedisCacheConfiguration."),c("span",{style:{color:"#6F42C1"}},"defaultCacheConfig"),c("span",{style:{color:"#24292E"}},"();")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        "),c("span",{style:{color:"#6A737D"}},"//config = config.entryTtl();")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        "),c("span",{style:{color:"#6A737D"}},"//覆盖默认配置")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        "),c("span",{style:{color:"#6A737D"}},"//将数据的key序列化为字符串")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        config "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," config."),c("span",{style:{color:"#6F42C1"}},"serializeKeysWith"),c("span",{style:{color:"#24292E"}},"(RedisSerializationContext.SerializationPair."),c("span",{style:{color:"#6F42C1"}},"fromSerializer"),c("span",{style:{color:"#24292E"}},"("),c("span",{style:{color:"#D73A49"}},"new"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#6F42C1"}},"StringRedisSerializer"),c("span",{style:{color:"#24292E"}},"()));")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        "),c("span",{style:{color:"#6A737D"}},"//将数据的值序列化为json格式 new GenericFastJsonRedisSerializer()兼容各种泛型")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        config "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," config."),c("span",{style:{color:"#6F42C1"}},"serializeValuesWith"),c("span",{style:{color:"#24292E"}},"(RedisSerializationContext.SerializationPair."),c("span",{style:{color:"#6F42C1"}},"fromSerializer"),c("span",{style:{color:"#24292E"}},"("),c("span",{style:{color:"#D73A49"}},"new"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#6F42C1"}},"GenericJackson2JsonRedisSerializer"),c("span",{style:{color:"#24292E"}},"()));")]),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        CacheProperties.Redis redisProperties "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," cacheProperties."),c("span",{style:{color:"#6F42C1"}},"getRedis"),c("span",{style:{color:"#24292E"}},"();")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        "),c("span",{style:{color:"#6A737D"}},"//将配置文件中的所有配置都生效")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        "),c("span",{style:{color:"#D73A49"}},"if"),c("span",{style:{color:"#24292E"}}," (redisProperties."),c("span",{style:{color:"#6F42C1"}},"getTimeToLive"),c("span",{style:{color:"#24292E"}},"() "),c("span",{style:{color:"#D73A49"}},"!="),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#005CC5"}},"null"),c("span",{style:{color:"#24292E"}},") {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"            config "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," config."),c("span",{style:{color:"#6F42C1"}},"entryTtl"),c("span",{style:{color:"#24292E"}},"(redisProperties."),c("span",{style:{color:"#6F42C1"}},"getTimeToLive"),c("span",{style:{color:"#24292E"}},"());")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        }")]),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        "),c("span",{style:{color:"#D73A49"}},"if"),c("span",{style:{color:"#24292E"}}," (redisProperties."),c("span",{style:{color:"#6F42C1"}},"getKeyPrefix"),c("span",{style:{color:"#24292E"}},"() "),c("span",{style:{color:"#D73A49"}},"!="),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#005CC5"}},"null"),c("span",{style:{color:"#24292E"}},") {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"            config "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," config."),c("span",{style:{color:"#6F42C1"}},"prefixKeysWith"),c("span",{style:{color:"#24292E"}},"(redisProperties."),c("span",{style:{color:"#6F42C1"}},"getKeyPrefix"),c("span",{style:{color:"#24292E"}},"());")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        }")]),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        "),c("span",{style:{color:"#D73A49"}},"if"),c("span",{style:{color:"#24292E"}}," ("),c("span",{style:{color:"#D73A49"}},"!"),c("span",{style:{color:"#24292E"}},"redisProperties."),c("span",{style:{color:"#6F42C1"}},"isCacheNullValues"),c("span",{style:{color:"#24292E"}},"()) {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"            config "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," config."),c("span",{style:{color:"#6F42C1"}},"disableCachingNullValues"),c("span",{style:{color:"#24292E"}},"();")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        }")]),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        "),c("span",{style:{color:"#D73A49"}},"if"),c("span",{style:{color:"#24292E"}}," ("),c("span",{style:{color:"#D73A49"}},"!"),c("span",{style:{color:"#24292E"}},"redisProperties."),c("span",{style:{color:"#6F42C1"}},"isUseKeyPrefix"),c("span",{style:{color:"#24292E"}},"()) {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"            config "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," config."),c("span",{style:{color:"#6F42C1"}},"disableKeyPrefix"),c("span",{style:{color:"#24292E"}},"();")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        }")]),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        "),c("span",{style:{color:"#D73A49"}},"return"),c("span",{style:{color:"#24292E"}}," config;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    }")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"}")])])])],-1),Ma=c("ul",null,[c("li",null,"配置文件添加相关配置")],-1),Ua=c("div",{class:"language-properties"},[c("button",{title:"Copy Code",class:"copy"}),c("span",{class:"lang"},"properties"),c("pre",{class:"shiki github-dark vp-code-dark"},[c("code",null,[c("span",{class:"line"},[c("span",{style:{color:"#F97583"}},"spring.cache.type"),c("span",{style:{color:"#E1E4E8"}},"=redis")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"#设置缓存的数据存活时间，即ttl时间（毫秒为单位）")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#F97583"}},"spring.cache.redis.time-to-live"),c("span",{style:{color:"#E1E4E8"}},"=3600000")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"#todo 设置前缀名配置后，缓存的分区不见了")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"#如果指定了前缀就用我们指定的前缀CACHE_getLevel1Categorys，没有就默认使用缓存的名字作为前缀")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"#spring.cache.redis.key-prefix=CACHE_")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},'#不使用前缀就使用自己指定的key值作为缓存名字key = "#root.method.name"，getLevel1Categorys')]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#F97583"}},"spring.cache.redis.use-key-prefix"),c("span",{style:{color:"#E1E4E8"}},"=true")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"#是否缓存空值，防止缓存穿透")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#F97583"}},"spring.cache.redis.cache-null-values"),c("span",{style:{color:"#E1E4E8"}},"=true")])])]),c("pre",{class:"shiki github-light vp-code-light"},[c("code",null,[c("span",{class:"line"},[c("span",{style:{color:"#D73A49"}},"spring.cache.type"),c("span",{style:{color:"#24292E"}},"=redis")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"#设置缓存的数据存活时间，即ttl时间（毫秒为单位）")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#D73A49"}},"spring.cache.redis.time-to-live"),c("span",{style:{color:"#24292E"}},"=3600000")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"#todo 设置前缀名配置后，缓存的分区不见了")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"#如果指定了前缀就用我们指定的前缀CACHE_getLevel1Categorys，没有就默认使用缓存的名字作为前缀")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"#spring.cache.redis.key-prefix=CACHE_")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},'#不使用前缀就使用自己指定的key值作为缓存名字key = "#root.method.name"，getLevel1Categorys')]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#D73A49"}},"spring.cache.redis.use-key-prefix"),c("span",{style:{color:"#24292E"}},"=true")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"#是否缓存空值，防止缓存穿透")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#D73A49"}},"spring.cache.redis.cache-null-values"),c("span",{style:{color:"#24292E"}},"=true")])])])],-1),Ja=c("ul",null,[c("li",null,[p("获取所有分类Json数据接口"),c("code",null,"org.klaus.zgg01mall.product.web.IndexController#getCatalogJson")])],-1),Pa=c("div",{class:"language-java"},[c("button",{title:"Copy Code",class:"copy"}),c("span",{class:"lang"},"java"),c("pre",{class:"shiki github-dark vp-code-dark"},[c("code",null,[c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"//index/catalog.json")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"@"),c("span",{style:{color:"#F97583"}},"ResponseBody")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"@"),c("span",{style:{color:"#F97583"}},"GetMapping"),c("span",{style:{color:"#E1E4E8"}},"("),c("span",{style:{color:"#9ECBFF"}},'"/index/catalog.json"'),c("span",{style:{color:"#E1E4E8"}},")")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#F97583"}},"public"),c("span",{style:{color:"#E1E4E8"}}," Map"),c("span",{style:{color:"#F97583"}},"<"),c("span",{style:{color:"#E1E4E8"}},"String, List"),c("span",{style:{color:"#F97583"}},"<"),c("span",{style:{color:"#E1E4E8"}},"Catalog2Vo"),c("span",{style:{color:"#F97583"}},">>"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#B392F0"}},"getCatalogJson"),c("span",{style:{color:"#E1E4E8"}},"() {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    Map<"),c("span",{style:{color:"#F97583"}},"String"),c("span",{style:{color:"#E1E4E8"}},", List<"),c("span",{style:{color:"#F97583"}},"Catalog2Vo"),c("span",{style:{color:"#E1E4E8"}},">> catalogJson "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," categoryService."),c("span",{style:{color:"#B392F0"}},"getCatalogJson"),c("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#F97583"}},"return"),c("span",{style:{color:"#E1E4E8"}}," catalogJson;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"}")])])]),c("pre",{class:"shiki github-light vp-code-light"},[c("code",null,[c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"//index/catalog.json")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"@"),c("span",{style:{color:"#D73A49"}},"ResponseBody")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"@"),c("span",{style:{color:"#D73A49"}},"GetMapping"),c("span",{style:{color:"#24292E"}},"("),c("span",{style:{color:"#032F62"}},'"/index/catalog.json"'),c("span",{style:{color:"#24292E"}},")")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#D73A49"}},"public"),c("span",{style:{color:"#24292E"}}," Map"),c("span",{style:{color:"#D73A49"}},"<"),c("span",{style:{color:"#24292E"}},"String, List"),c("span",{style:{color:"#D73A49"}},"<"),c("span",{style:{color:"#24292E"}},"Catalog2Vo"),c("span",{style:{color:"#D73A49"}},">>"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#6F42C1"}},"getCatalogJson"),c("span",{style:{color:"#24292E"}},"() {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    Map<"),c("span",{style:{color:"#D73A49"}},"String"),c("span",{style:{color:"#24292E"}},", List<"),c("span",{style:{color:"#D73A49"}},"Catalog2Vo"),c("span",{style:{color:"#24292E"}},">> catalogJson "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," categoryService."),c("span",{style:{color:"#6F42C1"}},"getCatalogJson"),c("span",{style:{color:"#24292E"}},"();")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#D73A49"}},"return"),c("span",{style:{color:"#24292E"}}," catalogJson;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"}")])])])],-1),Ka=c("ul",null,[c("li",null,[p("获取所有分类Json数据方法实现"),c("code",null,"org.klaus.zgg01mall.product.service.impl.CategoryServiceImpl#getCatalogJson")])],-1),qa=c("div",{class:"language-java"},[c("button",{title:"Copy Code",class:"copy"}),c("span",{class:"lang"},"java"),c("pre",{class:"shiki github-dark vp-code-dark"},[c("code",null,[c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"/**")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}}," * 加入缓存注解，再次简化缓存操作业务代码")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}}," * "),c("span",{style:{color:"#F97583"}},"@return")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}}," */")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"@"),c("span",{style:{color:"#F97583"}},"Cacheable"),c("span",{style:{color:"#E1E4E8"}},"("),c("span",{style:{color:"#79B8FF"}},"value"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#9ECBFF"}},'"category"'),c("span",{style:{color:"#E1E4E8"}},", "),c("span",{style:{color:"#79B8FF"}},"key"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#9ECBFF"}},'"#root.methodName"'),c("span",{style:{color:"#E1E4E8"}},")")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"@"),c("span",{style:{color:"#F97583"}},"Override")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#F97583"}},"public"),c("span",{style:{color:"#E1E4E8"}}," Map"),c("span",{style:{color:"#F97583"}},"<"),c("span",{style:{color:"#E1E4E8"}},"String, List"),c("span",{style:{color:"#F97583"}},"<"),c("span",{style:{color:"#E1E4E8"}},"Catalog2Vo"),c("span",{style:{color:"#F97583"}},">>"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#B392F0"}},"getCatalogJson"),c("span",{style:{color:"#E1E4E8"}},"() {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    System.out."),c("span",{style:{color:"#B392F0"}},"println"),c("span",{style:{color:"#E1E4E8"}},"("),c("span",{style:{color:"#9ECBFF"}},'"查询了数据库。。。"'),c("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#6A737D"}},"/**")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"     * 缓存为空，进行查询业务")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"     * 1、将数据库的多次查询变为一次，即方法抽取")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"     */")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#6A737D"}},"//查询所有")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    List<"),c("span",{style:{color:"#F97583"}},"CategoryEntity"),c("span",{style:{color:"#E1E4E8"}},"> selectList "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," baseMapper."),c("span",{style:{color:"#B392F0"}},"selectList"),c("span",{style:{color:"#E1E4E8"}},"("),c("span",{style:{color:"#79B8FF"}},"null"),c("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#6A737D"}},"//1、查出所有1级分类                                   一级分类集合，一级分类父分类id为0")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    List<"),c("span",{style:{color:"#F97583"}},"CategoryEntity"),c("span",{style:{color:"#E1E4E8"}},"> level1Categorys "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#B392F0"}},"getParent_cid"),c("span",{style:{color:"#E1E4E8"}},"(selectList, "),c("span",{style:{color:"#79B8FF"}},"0L"),c("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#6A737D"}},"//2、封装数据")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    Map<"),c("span",{style:{color:"#F97583"}},"String"),c("span",{style:{color:"#E1E4E8"}},", List<"),c("span",{style:{color:"#F97583"}},"Catalog2Vo"),c("span",{style:{color:"#E1E4E8"}},">> map "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," level1Categorys."),c("span",{style:{color:"#B392F0"}},"stream"),c("span",{style:{color:"#E1E4E8"}},"()."),c("span",{style:{color:"#B392F0"}},"collect"),c("span",{style:{color:"#E1E4E8"}},"(Collectors."),c("span",{style:{color:"#B392F0"}},"toMap"),c("span",{style:{color:"#E1E4E8"}},"(")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"            "),c("span",{style:{color:"#6A737D"}},'//"pCId":"c2{}"')]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"            k "),c("span",{style:{color:"#F97583"}},"->"),c("span",{style:{color:"#E1E4E8"}}," k."),c("span",{style:{color:"#B392F0"}},"getCatId"),c("span",{style:{color:"#E1E4E8"}},"()."),c("span",{style:{color:"#B392F0"}},"toString"),c("span",{style:{color:"#E1E4E8"}},"(),")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"            v "),c("span",{style:{color:"#F97583"}},"->"),c("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"                "),c("span",{style:{color:"#6A737D"}},"//2.1、每一个的一级分类，查到这个一级分类的[二级分类]")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"                "),c("span",{style:{color:"#6A737D"}},'//得到二级分类实体集合 抽取查询方法-> baseMapper.selectList(new QueryWrapper<CategoryEntity>().eq("parent_cid", v.getCatId()));')]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"                "),c("span",{style:{color:"#6A737D"}},"//todo                                                 父分类集合， 当前分类id（v为当前遍历的一级分类）")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"                List<"),c("span",{style:{color:"#F97583"}},"CategoryEntity"),c("span",{style:{color:"#E1E4E8"}},"> catalog2Entities "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#B392F0"}},"getParent_cid"),c("span",{style:{color:"#E1E4E8"}},"(selectList, v."),c("span",{style:{color:"#B392F0"}},"getCatId"),c("span",{style:{color:"#E1E4E8"}},"());")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"                "),c("span",{style:{color:"#6A737D"}},"//2.2、封装上面的结果")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"                List<"),c("span",{style:{color:"#F97583"}},"Catalog2Vo"),c("span",{style:{color:"#E1E4E8"}},"> catalog2Vos "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#79B8FF"}},"null"),c("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"                "),c("span",{style:{color:"#6A737D"}},"//父分类不为空，即二级分类实体集合不为空")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"                "),c("span",{style:{color:"#F97583"}},"if"),c("span",{style:{color:"#E1E4E8"}}," (catalog2Entities "),c("span",{style:{color:"#F97583"}},"!="),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#79B8FF"}},"null"),c("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"                    "),c("span",{style:{color:"#6A737D"}},"//遍历拿到每个二级分类集合")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"                    catalog2Vos "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," catalog2Entities."),c("span",{style:{color:"#B392F0"}},"stream"),c("span",{style:{color:"#E1E4E8"}},"()."),c("span",{style:{color:"#B392F0"}},"map"),c("span",{style:{color:"#E1E4E8"}},"(l2 "),c("span",{style:{color:"#F97583"}},"->"),c("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"                        "),c("span",{style:{color:"#6A737D"}},"//封装二级分类vo数据")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"                        Catalog2Vo catalog2Vo "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#F97583"}},"new"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#B392F0"}},"Catalog2Vo"),c("span",{style:{color:"#E1E4E8"}},"(v."),c("span",{style:{color:"#B392F0"}},"getCatId"),c("span",{style:{color:"#E1E4E8"}},"()."),c("span",{style:{color:"#B392F0"}},"toString"),c("span",{style:{color:"#E1E4E8"}},"(), "),c("span",{style:{color:"#79B8FF"}},"null"),c("span",{style:{color:"#E1E4E8"}},", l2."),c("span",{style:{color:"#B392F0"}},"getCatId"),c("span",{style:{color:"#E1E4E8"}},"()."),c("span",{style:{color:"#B392F0"}},"toString"),c("span",{style:{color:"#E1E4E8"}},"(), l2."),c("span",{style:{color:"#B392F0"}},"getName"),c("span",{style:{color:"#E1E4E8"}},"());")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"                        "),c("span",{style:{color:"#6A737D"}},'//2.2.1、找当前二级分类的三级分类封装成vo baseMapper.selectList(new QueryWrapper<CategoryEntity>(). eq("parent_cid", l2.getCatId()));')]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"                        "),c("span",{style:{color:"#6A737D"}},"//                                       （三级分类父分类）父分类集合， 当前分类id（l2为当前遍历的二级分类）")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"                        List<"),c("span",{style:{color:"#F97583"}},"CategoryEntity"),c("span",{style:{color:"#E1E4E8"}},"> catalog3Entities "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#B392F0"}},"getParent_cid"),c("span",{style:{color:"#E1E4E8"}},"(selectList, l2."),c("span",{style:{color:"#B392F0"}},"getCatId"),c("span",{style:{color:"#E1E4E8"}},"());")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"                        List<"),c("span",{style:{color:"#F97583"}},"Catalog2Vo"),c("span",{style:{color:"#E1E4E8"}},"."),c("span",{style:{color:"#F97583"}},"Catalog3Vo"),c("span",{style:{color:"#E1E4E8"}},"> catalog3Vos "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#79B8FF"}},"null"),c("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"                        "),c("span",{style:{color:"#F97583"}},"if"),c("span",{style:{color:"#E1E4E8"}}," (catalog3Entities "),c("span",{style:{color:"#F97583"}},"!="),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#79B8FF"}},"null"),c("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"                            catalog3Vos "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," catalog3Entities."),c("span",{style:{color:"#B392F0"}},"stream"),c("span",{style:{color:"#E1E4E8"}},"()."),c("span",{style:{color:"#B392F0"}},"map"),c("span",{style:{color:"#E1E4E8"}},"(l3 "),c("span",{style:{color:"#F97583"}},"->"),c("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"                                "),c("span",{style:{color:"#6A737D"}},"//2.2.2、封装成指定格式")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"                                Catalog2Vo.Catalog3Vo catalog3Vo "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#F97583"}},"new"),c("span",{style:{color:"#E1E4E8"}}," Catalog2Vo."),c("span",{style:{color:"#B392F0"}},"Catalog3Vo"),c("span",{style:{color:"#E1E4E8"}},"(l2."),c("span",{style:{color:"#B392F0"}},"getCatId"),c("span",{style:{color:"#E1E4E8"}},"()."),c("span",{style:{color:"#B392F0"}},"toString"),c("span",{style:{color:"#E1E4E8"}},"(), l3."),c("span",{style:{color:"#B392F0"}},"getCatId"),c("span",{style:{color:"#E1E4E8"}},"()."),c("span",{style:{color:"#B392F0"}},"toString"),c("span",{style:{color:"#E1E4E8"}},"(), l3."),c("span",{style:{color:"#B392F0"}},"getName"),c("span",{style:{color:"#E1E4E8"}},"());")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"                                "),c("span",{style:{color:"#F97583"}},"return"),c("span",{style:{color:"#E1E4E8"}}," catalog3Vo;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"                            })."),c("span",{style:{color:"#B392F0"}},"collect"),c("span",{style:{color:"#E1E4E8"}},"(Collectors."),c("span",{style:{color:"#B392F0"}},"toList"),c("span",{style:{color:"#E1E4E8"}},"());")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"                            catalog2Vo."),c("span",{style:{color:"#B392F0"}},"setCatalog3List"),c("span",{style:{color:"#E1E4E8"}},"(catalog3Vos);")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"                        }")]),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"                        "),c("span",{style:{color:"#F97583"}},"return"),c("span",{style:{color:"#E1E4E8"}}," catalog2Vo;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"                    })."),c("span",{style:{color:"#B392F0"}},"collect"),c("span",{style:{color:"#E1E4E8"}},"(Collectors."),c("span",{style:{color:"#B392F0"}},"toList"),c("span",{style:{color:"#E1E4E8"}},"());")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"                }")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"                "),c("span",{style:{color:"#F97583"}},"return"),c("span",{style:{color:"#E1E4E8"}}," catalog2Vos;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"            }));")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#F97583"}},"return"),c("span",{style:{color:"#E1E4E8"}}," map;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"}")])])]),c("pre",{class:"shiki github-light vp-code-light"},[c("code",null,[c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"/**")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}}," * 加入缓存注解，再次简化缓存操作业务代码")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}}," * "),c("span",{style:{color:"#D73A49"}},"@return")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}}," */")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"@"),c("span",{style:{color:"#D73A49"}},"Cacheable"),c("span",{style:{color:"#24292E"}},"("),c("span",{style:{color:"#005CC5"}},"value"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#032F62"}},'"category"'),c("span",{style:{color:"#24292E"}},", "),c("span",{style:{color:"#005CC5"}},"key"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#032F62"}},'"#root.methodName"'),c("span",{style:{color:"#24292E"}},")")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"@"),c("span",{style:{color:"#D73A49"}},"Override")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#D73A49"}},"public"),c("span",{style:{color:"#24292E"}}," Map"),c("span",{style:{color:"#D73A49"}},"<"),c("span",{style:{color:"#24292E"}},"String, List"),c("span",{style:{color:"#D73A49"}},"<"),c("span",{style:{color:"#24292E"}},"Catalog2Vo"),c("span",{style:{color:"#D73A49"}},">>"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#6F42C1"}},"getCatalogJson"),c("span",{style:{color:"#24292E"}},"() {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    System.out."),c("span",{style:{color:"#6F42C1"}},"println"),c("span",{style:{color:"#24292E"}},"("),c("span",{style:{color:"#032F62"}},'"查询了数据库。。。"'),c("span",{style:{color:"#24292E"}},");")]),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#6A737D"}},"/**")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"     * 缓存为空，进行查询业务")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"     * 1、将数据库的多次查询变为一次，即方法抽取")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"     */")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#6A737D"}},"//查询所有")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    List<"),c("span",{style:{color:"#D73A49"}},"CategoryEntity"),c("span",{style:{color:"#24292E"}},"> selectList "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," baseMapper."),c("span",{style:{color:"#6F42C1"}},"selectList"),c("span",{style:{color:"#24292E"}},"("),c("span",{style:{color:"#005CC5"}},"null"),c("span",{style:{color:"#24292E"}},");")]),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#6A737D"}},"//1、查出所有1级分类                                   一级分类集合，一级分类父分类id为0")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    List<"),c("span",{style:{color:"#D73A49"}},"CategoryEntity"),c("span",{style:{color:"#24292E"}},"> level1Categorys "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#6F42C1"}},"getParent_cid"),c("span",{style:{color:"#24292E"}},"(selectList, "),c("span",{style:{color:"#005CC5"}},"0L"),c("span",{style:{color:"#24292E"}},");")]),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#6A737D"}},"//2、封装数据")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    Map<"),c("span",{style:{color:"#D73A49"}},"String"),c("span",{style:{color:"#24292E"}},", List<"),c("span",{style:{color:"#D73A49"}},"Catalog2Vo"),c("span",{style:{color:"#24292E"}},">> map "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," level1Categorys."),c("span",{style:{color:"#6F42C1"}},"stream"),c("span",{style:{color:"#24292E"}},"()."),c("span",{style:{color:"#6F42C1"}},"collect"),c("span",{style:{color:"#24292E"}},"(Collectors."),c("span",{style:{color:"#6F42C1"}},"toMap"),c("span",{style:{color:"#24292E"}},"(")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"            "),c("span",{style:{color:"#6A737D"}},'//"pCId":"c2{}"')]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"            k "),c("span",{style:{color:"#D73A49"}},"->"),c("span",{style:{color:"#24292E"}}," k."),c("span",{style:{color:"#6F42C1"}},"getCatId"),c("span",{style:{color:"#24292E"}},"()."),c("span",{style:{color:"#6F42C1"}},"toString"),c("span",{style:{color:"#24292E"}},"(),")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"            v "),c("span",{style:{color:"#D73A49"}},"->"),c("span",{style:{color:"#24292E"}}," {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"                "),c("span",{style:{color:"#6A737D"}},"//2.1、每一个的一级分类，查到这个一级分类的[二级分类]")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"                "),c("span",{style:{color:"#6A737D"}},'//得到二级分类实体集合 抽取查询方法-> baseMapper.selectList(new QueryWrapper<CategoryEntity>().eq("parent_cid", v.getCatId()));')]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"                "),c("span",{style:{color:"#6A737D"}},"//todo                                                 父分类集合， 当前分类id（v为当前遍历的一级分类）")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"                List<"),c("span",{style:{color:"#D73A49"}},"CategoryEntity"),c("span",{style:{color:"#24292E"}},"> catalog2Entities "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#6F42C1"}},"getParent_cid"),c("span",{style:{color:"#24292E"}},"(selectList, v."),c("span",{style:{color:"#6F42C1"}},"getCatId"),c("span",{style:{color:"#24292E"}},"());")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"                "),c("span",{style:{color:"#6A737D"}},"//2.2、封装上面的结果")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"                List<"),c("span",{style:{color:"#D73A49"}},"Catalog2Vo"),c("span",{style:{color:"#24292E"}},"> catalog2Vos "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#005CC5"}},"null"),c("span",{style:{color:"#24292E"}},";")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"                "),c("span",{style:{color:"#6A737D"}},"//父分类不为空，即二级分类实体集合不为空")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"                "),c("span",{style:{color:"#D73A49"}},"if"),c("span",{style:{color:"#24292E"}}," (catalog2Entities "),c("span",{style:{color:"#D73A49"}},"!="),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#005CC5"}},"null"),c("span",{style:{color:"#24292E"}},") {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"                    "),c("span",{style:{color:"#6A737D"}},"//遍历拿到每个二级分类集合")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"                    catalog2Vos "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," catalog2Entities."),c("span",{style:{color:"#6F42C1"}},"stream"),c("span",{style:{color:"#24292E"}},"()."),c("span",{style:{color:"#6F42C1"}},"map"),c("span",{style:{color:"#24292E"}},"(l2 "),c("span",{style:{color:"#D73A49"}},"->"),c("span",{style:{color:"#24292E"}}," {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"                        "),c("span",{style:{color:"#6A737D"}},"//封装二级分类vo数据")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"                        Catalog2Vo catalog2Vo "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#D73A49"}},"new"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#6F42C1"}},"Catalog2Vo"),c("span",{style:{color:"#24292E"}},"(v."),c("span",{style:{color:"#6F42C1"}},"getCatId"),c("span",{style:{color:"#24292E"}},"()."),c("span",{style:{color:"#6F42C1"}},"toString"),c("span",{style:{color:"#24292E"}},"(), "),c("span",{style:{color:"#005CC5"}},"null"),c("span",{style:{color:"#24292E"}},", l2."),c("span",{style:{color:"#6F42C1"}},"getCatId"),c("span",{style:{color:"#24292E"}},"()."),c("span",{style:{color:"#6F42C1"}},"toString"),c("span",{style:{color:"#24292E"}},"(), l2."),c("span",{style:{color:"#6F42C1"}},"getName"),c("span",{style:{color:"#24292E"}},"());")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"                        "),c("span",{style:{color:"#6A737D"}},'//2.2.1、找当前二级分类的三级分类封装成vo baseMapper.selectList(new QueryWrapper<CategoryEntity>(). eq("parent_cid", l2.getCatId()));')]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"                        "),c("span",{style:{color:"#6A737D"}},"//                                       （三级分类父分类）父分类集合， 当前分类id（l2为当前遍历的二级分类）")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"                        List<"),c("span",{style:{color:"#D73A49"}},"CategoryEntity"),c("span",{style:{color:"#24292E"}},"> catalog3Entities "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#6F42C1"}},"getParent_cid"),c("span",{style:{color:"#24292E"}},"(selectList, l2."),c("span",{style:{color:"#6F42C1"}},"getCatId"),c("span",{style:{color:"#24292E"}},"());")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"                        List<"),c("span",{style:{color:"#D73A49"}},"Catalog2Vo"),c("span",{style:{color:"#24292E"}},"."),c("span",{style:{color:"#D73A49"}},"Catalog3Vo"),c("span",{style:{color:"#24292E"}},"> catalog3Vos "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#005CC5"}},"null"),c("span",{style:{color:"#24292E"}},";")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"                        "),c("span",{style:{color:"#D73A49"}},"if"),c("span",{style:{color:"#24292E"}}," (catalog3Entities "),c("span",{style:{color:"#D73A49"}},"!="),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#005CC5"}},"null"),c("span",{style:{color:"#24292E"}},") {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"                            catalog3Vos "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," catalog3Entities."),c("span",{style:{color:"#6F42C1"}},"stream"),c("span",{style:{color:"#24292E"}},"()."),c("span",{style:{color:"#6F42C1"}},"map"),c("span",{style:{color:"#24292E"}},"(l3 "),c("span",{style:{color:"#D73A49"}},"->"),c("span",{style:{color:"#24292E"}}," {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"                                "),c("span",{style:{color:"#6A737D"}},"//2.2.2、封装成指定格式")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"                                Catalog2Vo.Catalog3Vo catalog3Vo "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#D73A49"}},"new"),c("span",{style:{color:"#24292E"}}," Catalog2Vo."),c("span",{style:{color:"#6F42C1"}},"Catalog3Vo"),c("span",{style:{color:"#24292E"}},"(l2."),c("span",{style:{color:"#6F42C1"}},"getCatId"),c("span",{style:{color:"#24292E"}},"()."),c("span",{style:{color:"#6F42C1"}},"toString"),c("span",{style:{color:"#24292E"}},"(), l3."),c("span",{style:{color:"#6F42C1"}},"getCatId"),c("span",{style:{color:"#24292E"}},"()."),c("span",{style:{color:"#6F42C1"}},"toString"),c("span",{style:{color:"#24292E"}},"(), l3."),c("span",{style:{color:"#6F42C1"}},"getName"),c("span",{style:{color:"#24292E"}},"());")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"                                "),c("span",{style:{color:"#D73A49"}},"return"),c("span",{style:{color:"#24292E"}}," catalog3Vo;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"                            })."),c("span",{style:{color:"#6F42C1"}},"collect"),c("span",{style:{color:"#24292E"}},"(Collectors."),c("span",{style:{color:"#6F42C1"}},"toList"),c("span",{style:{color:"#24292E"}},"());")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"                            catalog2Vo."),c("span",{style:{color:"#6F42C1"}},"setCatalog3List"),c("span",{style:{color:"#24292E"}},"(catalog3Vos);")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"                        }")]),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"                        "),c("span",{style:{color:"#D73A49"}},"return"),c("span",{style:{color:"#24292E"}}," catalog2Vo;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"                    })."),c("span",{style:{color:"#6F42C1"}},"collect"),c("span",{style:{color:"#24292E"}},"(Collectors."),c("span",{style:{color:"#6F42C1"}},"toList"),c("span",{style:{color:"#24292E"}},"());")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"                }")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"                "),c("span",{style:{color:"#D73A49"}},"return"),c("span",{style:{color:"#24292E"}}," catalog2Vos;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"            }));")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#D73A49"}},"return"),c("span",{style:{color:"#24292E"}}," map;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"}")])])])],-1),Na=c("ul",null,[c("li",null,[p("首页获取一级分类响应视图渲染接口"),c("code",null,"org.klaus.zgg01mall.product.web.IndexController#indexPage")])],-1),Wa=c("div",{class:"language-java"},[c("button",{title:"Copy Code",class:"copy"}),c("span",{class:"lang"},"java"),c("pre",{class:"shiki github-dark vp-code-dark"},[c("code",null,[c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"@"),c("span",{style:{color:"#F97583"}},"GetMapping"),c("span",{style:{color:"#E1E4E8"}},"({"),c("span",{style:{color:"#9ECBFF"}},'"/"'),c("span",{style:{color:"#E1E4E8"}},", "),c("span",{style:{color:"#9ECBFF"}},'"index.html"'),c("span",{style:{color:"#E1E4E8"}},"})")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#F97583"}},"public"),c("span",{style:{color:"#E1E4E8"}}," String "),c("span",{style:{color:"#B392F0"}},"indexPage"),c("span",{style:{color:"#E1E4E8"}},"(Model model) {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},'//        System.out.println("" + Thread.currentThread().getId());')]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        "),c("span",{style:{color:"#6A737D"}},"//todo 1、查出所有的1级分类")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        List<"),c("span",{style:{color:"#F97583"}},"CategoryEntity"),c("span",{style:{color:"#E1E4E8"}},"> categoryEntityList "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," categoryService."),c("span",{style:{color:"#B392F0"}},"getLevel1Categorys"),c("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        "),c("span",{style:{color:"#6A737D"}},"//视图解析器进行拼接")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        "),c("span",{style:{color:"#6A737D"}},"//classpath:/templates/ + 返回值 +  .html")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        model."),c("span",{style:{color:"#B392F0"}},"addAttribute"),c("span",{style:{color:"#E1E4E8"}},"("),c("span",{style:{color:"#9ECBFF"}},'"categorys"'),c("span",{style:{color:"#E1E4E8"}},", categoryEntityList);")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        "),c("span",{style:{color:"#F97583"}},"return"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#9ECBFF"}},'"index"'),c("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    }")])])]),c("pre",{class:"shiki github-light vp-code-light"},[c("code",null,[c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"@"),c("span",{style:{color:"#D73A49"}},"GetMapping"),c("span",{style:{color:"#24292E"}},"({"),c("span",{style:{color:"#032F62"}},'"/"'),c("span",{style:{color:"#24292E"}},", "),c("span",{style:{color:"#032F62"}},'"index.html"'),c("span",{style:{color:"#24292E"}},"})")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#D73A49"}},"public"),c("span",{style:{color:"#24292E"}}," String "),c("span",{style:{color:"#6F42C1"}},"indexPage"),c("span",{style:{color:"#24292E"}},"(Model model) {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},'//        System.out.println("" + Thread.currentThread().getId());')]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        "),c("span",{style:{color:"#6A737D"}},"//todo 1、查出所有的1级分类")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        List<"),c("span",{style:{color:"#D73A49"}},"CategoryEntity"),c("span",{style:{color:"#24292E"}},"> categoryEntityList "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," categoryService."),c("span",{style:{color:"#6F42C1"}},"getLevel1Categorys"),c("span",{style:{color:"#24292E"}},"();")]),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        "),c("span",{style:{color:"#6A737D"}},"//视图解析器进行拼接")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        "),c("span",{style:{color:"#6A737D"}},"//classpath:/templates/ + 返回值 +  .html")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        model."),c("span",{style:{color:"#6F42C1"}},"addAttribute"),c("span",{style:{color:"#24292E"}},"("),c("span",{style:{color:"#032F62"}},'"categorys"'),c("span",{style:{color:"#24292E"}},", categoryEntityList);")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        "),c("span",{style:{color:"#D73A49"}},"return"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#032F62"}},'"index"'),c("span",{style:{color:"#24292E"}},";")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    }")])])])],-1),Ha=c("ul",null,[c("li",null,[p("首页获取一级分类方法实现"),c("code",null,"org.klaus.zgg01mall.product.service.impl.CategoryServiceImpl#getLevel1Categorys")])],-1),Ga=c("div",{class:"language-java"},[c("button",{title:"Copy Code",class:"copy"}),c("span",{class:"lang"},"java"),c("pre",{class:"shiki github-dark vp-code-dark"},[c("code",null,[c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"@"),c("span",{style:{color:"#F97583"}},"Cacheable"),c("span",{style:{color:"#E1E4E8"}},"("),c("span",{style:{color:"#79B8FF"}},"value"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," {"),c("span",{style:{color:"#9ECBFF"}},'"category"'),c("span",{style:{color:"#E1E4E8"}},"}, "),c("span",{style:{color:"#79B8FF"}},"key"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#9ECBFF"}},'"#root.method.name"'),c("span",{style:{color:"#E1E4E8"}},", "),c("span",{style:{color:"#79B8FF"}},"sync"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#79B8FF"}},"true"),c("span",{style:{color:"#E1E4E8"}},")")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"@"),c("span",{style:{color:"#F97583"}},"Override")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#F97583"}},"public"),c("span",{style:{color:"#E1E4E8"}}," List"),c("span",{style:{color:"#F97583"}},"<"),c("span",{style:{color:"#E1E4E8"}},"CategoryEntity"),c("span",{style:{color:"#F97583"}},">"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#B392F0"}},"getLevel1Categorys"),c("span",{style:{color:"#E1E4E8"}},"() {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    System.out."),c("span",{style:{color:"#B392F0"}},"println"),c("span",{style:{color:"#E1E4E8"}},"("),c("span",{style:{color:"#9ECBFF"}},'"getLevel1Categorys....."'),c("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#F97583"}},"long"),c("span",{style:{color:"#E1E4E8"}}," l "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," System."),c("span",{style:{color:"#B392F0"}},"currentTimeMillis"),c("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#6A737D"}},"//查出一级分类，即父分类为0")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    List<"),c("span",{style:{color:"#F97583"}},"CategoryEntity"),c("span",{style:{color:"#E1E4E8"}},"> categoryEntities "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," baseMapper."),c("span",{style:{color:"#B392F0"}},"selectList"),c("span",{style:{color:"#E1E4E8"}},"("),c("span",{style:{color:"#F97583"}},"new"),c("span",{style:{color:"#E1E4E8"}}," QueryWrapper<"),c("span",{style:{color:"#F97583"}},"CategoryEntity"),c("span",{style:{color:"#E1E4E8"}},">().")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"            "),c("span",{style:{color:"#B392F0"}},"eq"),c("span",{style:{color:"#E1E4E8"}},"("),c("span",{style:{color:"#9ECBFF"}},'"parent_cid"'),c("span",{style:{color:"#E1E4E8"}},", "),c("span",{style:{color:"#79B8FF"}},"0"),c("span",{style:{color:"#E1E4E8"}},"));")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#6A737D"}},'//System.out.println("消耗时间：" + (System.currentTimeMillis() - l));')]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#F97583"}},"return"),c("span",{style:{color:"#E1E4E8"}}," categoryEntities;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"}")])])]),c("pre",{class:"shiki github-light vp-code-light"},[c("code",null,[c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"@"),c("span",{style:{color:"#D73A49"}},"Cacheable"),c("span",{style:{color:"#24292E"}},"("),c("span",{style:{color:"#005CC5"}},"value"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," {"),c("span",{style:{color:"#032F62"}},'"category"'),c("span",{style:{color:"#24292E"}},"}, "),c("span",{style:{color:"#005CC5"}},"key"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#032F62"}},'"#root.method.name"'),c("span",{style:{color:"#24292E"}},", "),c("span",{style:{color:"#005CC5"}},"sync"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#005CC5"}},"true"),c("span",{style:{color:"#24292E"}},")")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"@"),c("span",{style:{color:"#D73A49"}},"Override")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#D73A49"}},"public"),c("span",{style:{color:"#24292E"}}," List"),c("span",{style:{color:"#D73A49"}},"<"),c("span",{style:{color:"#24292E"}},"CategoryEntity"),c("span",{style:{color:"#D73A49"}},">"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#6F42C1"}},"getLevel1Categorys"),c("span",{style:{color:"#24292E"}},"() {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    System.out."),c("span",{style:{color:"#6F42C1"}},"println"),c("span",{style:{color:"#24292E"}},"("),c("span",{style:{color:"#032F62"}},'"getLevel1Categorys....."'),c("span",{style:{color:"#24292E"}},");")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#D73A49"}},"long"),c("span",{style:{color:"#24292E"}}," l "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," System."),c("span",{style:{color:"#6F42C1"}},"currentTimeMillis"),c("span",{style:{color:"#24292E"}},"();")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#6A737D"}},"//查出一级分类，即父分类为0")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    List<"),c("span",{style:{color:"#D73A49"}},"CategoryEntity"),c("span",{style:{color:"#24292E"}},"> categoryEntities "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," baseMapper."),c("span",{style:{color:"#6F42C1"}},"selectList"),c("span",{style:{color:"#24292E"}},"("),c("span",{style:{color:"#D73A49"}},"new"),c("span",{style:{color:"#24292E"}}," QueryWrapper<"),c("span",{style:{color:"#D73A49"}},"CategoryEntity"),c("span",{style:{color:"#24292E"}},">().")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"            "),c("span",{style:{color:"#6F42C1"}},"eq"),c("span",{style:{color:"#24292E"}},"("),c("span",{style:{color:"#032F62"}},'"parent_cid"'),c("span",{style:{color:"#24292E"}},", "),c("span",{style:{color:"#005CC5"}},"0"),c("span",{style:{color:"#24292E"}},"));")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#6A737D"}},'//System.out.println("消耗时间：" + (System.currentTimeMillis() - l));')]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#D73A49"}},"return"),c("span",{style:{color:"#24292E"}}," categoryEntities;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"}")])])])],-1),Xa=c("ul",null,[c("li",null,[p("级联更新所有关联的数据方法实现"),c("code",null,"org.klaus.zgg01mall.product.service.impl.CategoryServiceImpl#updateCascade")])],-1),Qa=c("blockquote",null,[c("p",null,'@CacheEvict:失效模式 1、同时进行多种缓存操作@Caching 2、指定删除某个分区下的所有数据@CacheEvict(value = "category", allEntries = true) 3、存储同一类型的数据，都可以指定成同一个分区，分区名默认就是缓存的前缀')],-1),$a=c("div",{class:"language-java"},[c("button",{title:"Copy Code",class:"copy"}),c("span",{class:"lang"},"java"),c("pre",{class:"shiki github-dark vp-code-dark"},[c("code",null,[c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"//    @Caching(evict = {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},'//            @CacheEvict(value = "category", key = "\'getLevel1Categorys\'"),')]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},'//            @CacheEvict(value = "category", key = "\'getCatalogJson\'")')]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"//    })")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#6A737D"}},"//category::key 失效模式")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    @"),c("span",{style:{color:"#F97583"}},"CacheEvict"),c("span",{style:{color:"#E1E4E8"}},"("),c("span",{style:{color:"#79B8FF"}},"value"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#9ECBFF"}},'"category"'),c("span",{style:{color:"#E1E4E8"}},", "),c("span",{style:{color:"#79B8FF"}},"allEntries"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#79B8FF"}},"true"),c("span",{style:{color:"#E1E4E8"}},")")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"//    @CachePut//双写模式")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    @"),c("span",{style:{color:"#F97583"}},"Transactional")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    @"),c("span",{style:{color:"#F97583"}},"Override")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#F97583"}},"public"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#F97583"}},"void"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#B392F0"}},"updateCascade"),c("span",{style:{color:"#E1E4E8"}},"(CategoryEntity category) {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        "),c("span",{style:{color:"#6A737D"}},"//先更新自己")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        "),c("span",{style:{color:"#79B8FF"}},"this"),c("span",{style:{color:"#E1E4E8"}},"."),c("span",{style:{color:"#B392F0"}},"updateById"),c("span",{style:{color:"#E1E4E8"}},"(category);")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        categoryBrandRelationService."),c("span",{style:{color:"#B392F0"}},"updateCategory"),c("span",{style:{color:"#E1E4E8"}},"(category."),c("span",{style:{color:"#B392F0"}},"getCatId"),c("span",{style:{color:"#E1E4E8"}},"(), category."),c("span",{style:{color:"#B392F0"}},"getName"),c("span",{style:{color:"#E1E4E8"}},"());")]),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        "),c("span",{style:{color:"#6A737D"}},"//同时修改缓存中的数据")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        "),c("span",{style:{color:"#6A737D"}},'//redis.del("catalogJSON");等待下次主动查询进行更新')]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    }")])])]),c("pre",{class:"shiki github-light vp-code-light"},[c("code",null,[c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"//    @Caching(evict = {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},'//            @CacheEvict(value = "category", key = "\'getLevel1Categorys\'"),')]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},'//            @CacheEvict(value = "category", key = "\'getCatalogJson\'")')]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"//    })")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#6A737D"}},"//category::key 失效模式")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    @"),c("span",{style:{color:"#D73A49"}},"CacheEvict"),c("span",{style:{color:"#24292E"}},"("),c("span",{style:{color:"#005CC5"}},"value"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#032F62"}},'"category"'),c("span",{style:{color:"#24292E"}},", "),c("span",{style:{color:"#005CC5"}},"allEntries"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#005CC5"}},"true"),c("span",{style:{color:"#24292E"}},")")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"//    @CachePut//双写模式")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    @"),c("span",{style:{color:"#D73A49"}},"Transactional")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    @"),c("span",{style:{color:"#D73A49"}},"Override")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#D73A49"}},"public"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#D73A49"}},"void"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#6F42C1"}},"updateCascade"),c("span",{style:{color:"#24292E"}},"(CategoryEntity category) {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        "),c("span",{style:{color:"#6A737D"}},"//先更新自己")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        "),c("span",{style:{color:"#005CC5"}},"this"),c("span",{style:{color:"#24292E"}},"."),c("span",{style:{color:"#6F42C1"}},"updateById"),c("span",{style:{color:"#24292E"}},"(category);")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        categoryBrandRelationService."),c("span",{style:{color:"#6F42C1"}},"updateCategory"),c("span",{style:{color:"#24292E"}},"(category."),c("span",{style:{color:"#6F42C1"}},"getCatId"),c("span",{style:{color:"#24292E"}},"(), category."),c("span",{style:{color:"#6F42C1"}},"getName"),c("span",{style:{color:"#24292E"}},"());")]),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        "),c("span",{style:{color:"#6A737D"}},"//同时修改缓存中的数据")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        "),c("span",{style:{color:"#6A737D"}},'//redis.del("catalogJSON");等待下次主动查询进行更新')]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    }")])])])],-1),Ya={id:"_7、总结",tabindex:"-1"},Za=c("p",null,[c("strong",null,"@Cacheable")],-1),se=c("li",null,[c("p",null,"1、每一个需要缓存的数据我们都来指定要放到哪个名字的缓存【缓存的分区（按照业务类型分）】")],-1),le=c("li",null,[c("p",null,'2、 @Cacheable({"category"})')],-1),oe=c("li",null,[c("p",null,"代表当前方法的结果需要缓存，")],-1),ne=c("li",null,[c("p",null,"如果缓存中有，方法就不用调用；若缓存中没有，会调用方法，最后将方法的结果放入缓存")],-1),ae=c("p",null,"3、默认行为",-1),ee=c("li",null,[c("p",null,"1）、如果缓存中有，方法就不用调用")],-1),te=c("li",null,[c("p",null,[p("2）、key默认自动生成："),c("code",null,"缓存的名字 ::SimpleKey [](自主生成的key值)")])],-1),ce=c("li",null,[c("p",null,"3）、缓存的value值，默认使用jdk序列化机制，将序列化后的数据存到redis")],-1),pe=c("li",null,[c("p",null,"4）、默认ttl时间：-1")],-1),re=c("li",null,"1）、指定生成的缓存使用的key： key属性指定，接受一个SpEl",-1),Ee=c("li",null,"2）、指定缓存的数据的存活时间： 配置文件中修改ttl",-1),ye=c("li",null,"3）、将数据保存为json格式",-1),ie=c("li",null,[c("p",null,"4、Spring-Cache的不足："),c("ul",null,[c("li",null,[p("1）、读模式: "),c("ul",null,[c("li",null,"缓存穿透：查询一个null数据，解决：缓存空数据：cache-null-values=true"),c("li",null,"缓存击穿：大量并发进来同时查询一个正好过期的数据，解决L加锁：？通过调试源码是默认为无加锁的;sync = true（加锁，解决击穿）"),c("li",null,"缓存雪崩：大量的key同时过期，解决：加随机时间，加上过期时间：spring.cache.redis.time-to-live=3600000")])]),c("li",null,[p("2）、写模式: (缓存与数据库一致) "),c("ul",null,[c("li",null,"i）、读写加锁（适用于读多写少的系统，但读多了一直加锁等待也不合适）"),c("li",null,"ii）、引入Canal，感知到MySql的更新去更新数据库"),c("li",null,"iii）、读多写多，直接去数据库查询就行")])])])],-1),ue=c("li",null,[c("p",null,"总结："),c("ul",null,[c("li",null,"常规数据（读多写少，即时性，一致性要求不高的数据）：完全可以使用Spring-Cache；写模式（只要缓存的数据有过期时间就足够了）")])],-1),de=c("li",null,[c("p",null,"特殊数据：特殊设计")],-1),ge=c("li",null,[c("p",null,"原理："),c("ul",null,[c("li",null,"CacheManager(RedisCacheManager)->Cache(RedisCache)->Cache负责缓存的读写")])],-1),Fe=c("p",null,[c("strong",null,"整合SpringCache简化缓存开发")],-1),De=c("ul",null,[c("li",null,[p("1)、引入依赖 "),c("ul",null,[c("li",null,"spring-boot-starter-cache、spring-boot-starter-data-redis")])]),c("li",null,[p("2）、写配置 "),c("ul",null,[c("li",null,[p("i)、自动配置了哪些 "),c("ul",null,[c("li",null,"CacheAutoConfiguration会导入RedisCacheConfiguration"),c("li",null,"自动配好了缓存管理器RedisCacheManager")])]),c("li",null,[p("ii)、配置使用redis作为缓存 "),c("ul",null,[c("li",null,"spring.cache.type=redis")])])])]),c("li",null,[p("3）、测试使用缓存 "),c("ul",null,[c("li",null,"@Cacheable: Triggers cache population. ：触发将数据保存到缓存的操作"),c("li",null,"@CacheEvict: Triggers cache eviction. ： 触发将数据从缓存中删除的操作"),c("li",null,"@CachePut: Updates the cache without interfering with the method execution.：不影响方法执行更新缓存"),c("li",null,"@Caching: Regroups multiple cache operations to be applied on a method.：组合以上多个操作"),c("li",null,"@CacheConfig: Shares some common cache-related settings at class-level.：在类级别共享缓存的相同配置"),c("li",null,"i)、开启缓存功能 @EnableCaching"),c("li",null,"ii)、只需要使用注解就能完成缓存操作")])]),c("li",null,[p("4)、原理： "),c("ul",null,[c("li",null,"CacheAutoConfiguration —> RedisCacheConfiguration ->自动配置了RedisCacheManager -> 初始化所有的缓存->每个缓存决定使用什么配置->如果redisCacheConfiguration有就用已有的，没有就用默认->想改缓存的配置，只需要给容器中放一个RedisCacheConfiguration即可->就会应用到当前RedisCacheManager管理的所有缓存分区中")])])],-1);const Ae=s(d,[["render",function(s,l,o,i,u,d){const Ae=y,Ce=e;return t(),n(Ce,{frontmatter:u.frontmatter,data:u.data},{"main-content-md":a((()=>[g,c("h2",F,[p("Ⅰ.仿京东购物车系统 "),r(Ae,{class:"header-anchor",href:"#i-仿京东购物车系统","aria-hidden":"true"},{default:a((()=>[p("#")])),_:1})]),D,c("h3",A,[p("1、购物车需求 "),r(Ae,{class:"header-anchor",href:"#_1、购物车需求","aria-hidden":"true"},{default:a((()=>[p("#")])),_:1})]),c("h4",C,[p("1）、需求描述： "),r(Ae,{class:"header-anchor",href:"#_1-、需求描述","aria-hidden":"true"},{default:a((()=>[p("#")])),_:1})]),h,c("h4",m,[p("2）、数据结构 "),r(Ae,{class:"header-anchor",href:"#_2-、数据结构","aria-hidden":"true"},{default:a((()=>[p("#")])),_:1})]),k,b,B,S,I,f,v,L,c("h4",_,[p("3）、流程 "),r(Ae,{class:"header-anchor",href:"#_3-、流程","aria-hidden":"true"},{default:a((()=>[p("#")])),_:1})]),R,T,j,O,x,c("h4",V,[p("4）、引入依赖 "),r(Ae,{class:"header-anchor",href:"#_4-、引入依赖","aria-hidden":"true"},{default:a((()=>[p("#")])),_:1})]),z,c("h3",w,[p("2、添加购物车 "),r(Ae,{class:"header-anchor",href:"#_2、添加购物车","aria-hidden":"true"},{default:a((()=>[p("#")])),_:1})]),M,U,J,P,K,q,N,W,H,G,X,Q,$,Y,Z,ss,c("h3",ls,[p("3、购物车列表 "),r(Ae,{class:"header-anchor",href:"#_3、购物车列表","aria-hidden":"true"},{default:a((()=>[p("#")])),_:1})]),os,ns,as,es,ts,cs,c("h3",ps,[p("4、添加购物车成功页 "),r(Ae,{class:"header-anchor",href:"#_4、添加购物车成功页","aria-hidden":"true"},{default:a((()=>[p("#")])),_:1})]),rs,Es,ys,is,c("h3",us,[p("5、删除购物项 "),r(Ae,{class:"header-anchor",href:"#_5、删除购物项","aria-hidden":"true"},{default:a((()=>[p("#")])),_:1})]),ds,gs,Fs,Ds,c("h3",As,[p("6、改变购物项数量 "),r(Ae,{class:"header-anchor",href:"#_6、改变购物项数量","aria-hidden":"true"},{default:a((()=>[p("#")])),_:1})]),Cs,hs,ms,ks,c("h3",bs,[p("7、选中购物项 "),r(Ae,{class:"header-anchor",href:"#_7、选中购物项","aria-hidden":"true"},{default:a((()=>[p("#")])),_:1})]),Bs,Ss,Is,fs,c("h3",vs,[p("8、获取当前登录用户的购物项列表 "),r(Ae,{class:"header-anchor",href:"#_8、获取当前登录用户的购物项列表","aria-hidden":"true"},{default:a((()=>[p("#")])),_:1})]),Ls,_s,Rs,Ts,c("h2",js,[p("Ⅱ.解决分布式下session共享问题 "),r(Ae,{class:"header-anchor",href:"#ii-解决分布式下session共享问题","aria-hidden":"true"},{default:a((()=>[p("#")])),_:1})]),c("h3",Os,[p("1、session原理 "),r(Ae,{class:"header-anchor",href:"#_1、session原理","aria-hidden":"true"},{default:a((()=>[p("#")])),_:1})]),xs,c("h3",Vs,[p("2、分布式下session共享问题 "),r(Ae,{class:"header-anchor",href:"#_2、分布式下session共享问题","aria-hidden":"true"},{default:a((()=>[p("#")])),_:1})]),zs,c("h3",ws,[p("3、解决 - session复制 "),r(Ae,{class:"header-anchor",href:"#_3、解决-session复制","aria-hidden":"true"},{default:a((()=>[p("#")])),_:1})]),Ms,Us,c("h3",Js,[p("4、解决 - 客户端存储 "),r(Ae,{class:"header-anchor",href:"#_4、解决-客户端存储","aria-hidden":"true"},{default:a((()=>[p("#")])),_:1})]),Ps,Ks,c("h3",qs,[p("5、解决 - hash一致性 "),r(Ae,{class:"header-anchor",href:"#_5、解决-hash一致性","aria-hidden":"true"},{default:a((()=>[p("#")])),_:1})]),Ns,Ws,c("h3",Hs,[p("6、解决 - 统一存储 "),r(Ae,{class:"header-anchor",href:"#_6、解决-统一存储","aria-hidden":"true"},{default:a((()=>[p("#")])),_:1})]),Gs,Xs,c("h3",Qs,[p("7、解决 - 不同服务，子域session共享 "),r(Ae,{class:"header-anchor",href:"#_7、解决-不同服务-子域session共享","aria-hidden":"true"},{default:a((()=>[p("#")])),_:1})]),$s,Ys,c("h3",Zs,[p("8、SpringSession核心原理 "),r(Ae,{class:"header-anchor",href:"#_8、springsession核心原理","aria-hidden":"true"},{default:a((()=>[p("#")])),_:1})]),sl,c("h3",ll,[p("9、应用 "),r(Ae,{class:"header-anchor",href:"#_9、应用","aria-hidden":"true"},{default:a((()=>[p("#")])),_:1})]),ol,nl,al,el,tl,cl,pl,rl,c("h2",El,[p("Ⅲ.商品系统缓存所有分类 "),r(Ae,{class:"header-anchor",href:"#iii-商品系统缓存所有分类","aria-hidden":"true"},{default:a((()=>[p("#")])),_:1})]),c("h3",yl,[p("一、缓存 "),r(Ae,{class:"header-anchor",href:"#一、缓存","aria-hidden":"true"},{default:a((()=>[p("#")])),_:1})]),c("h4",il,[p("本地缓存 "),r(Ae,{class:"header-anchor",href:"#本地缓存","aria-hidden":"true"},{default:a((()=>[p("#")])),_:1})]),ul,dl,c("h4",gl,[p("1、缓存使用 "),r(Ae,{class:"header-anchor",href:"#_1、缓存使用","aria-hidden":"true"},{default:a((()=>[p("#")])),_:1})]),Fl,Dl,Al,Cl,c("h4",hl,[p("2、整合 redis 作为缓存 "),r(Ae,{class:"header-anchor",href:"#_2、整合-redis-作为缓存","aria-hidden":"true"},{default:a((()=>[p("#")])),_:1})]),ml,kl,bl,Bl,Sl,Il,fl,vl,Ll,c("h3",_l,[p("二、缓存失效问题 "),r(Ae,{class:"header-anchor",href:"#二、缓存失效问题","aria-hidden":"true"},{default:a((()=>[p("#")])),_:1})]),c("h4",Rl,[p("分布式缓存-本地模式在分布式下的问题 "),r(Ae,{class:"header-anchor",href:"#分布式缓存-本地模式在分布式下的问题","aria-hidden":"true"},{default:a((()=>[p("#")])),_:1})]),Tl,jl,c("h5",Ol,[p("1、高并发下缓存失效问题-缓存穿透 "),r(Ae,{class:"header-anchor",href:"#_1、高并发下缓存失效问题-缓存穿透","aria-hidden":"true"},{default:a((()=>[p("#")])),_:1})]),xl,Vl,c("h5",zl,[p("2、高并发下缓存失效问题-缓存雪崩 "),r(Ae,{class:"header-anchor",href:"#_2、高并发下缓存失效问题-缓存雪崩","aria-hidden":"true"},{default:a((()=>[p("#")])),_:1})]),wl,c("h5",Ml,[p("3、高并发下缓存失效问题-缓存击穿 "),r(Ae,{class:"header-anchor",href:"#_3、高并发下缓存失效问题-缓存击穿","aria-hidden":"true"},{default:a((()=>[p("#")])),_:1})]),Ul,Jl,c("h3",Pl,[p("三、"),Kl,p(),r(Ae,{class:"header-anchor",href:"#三、缓存数据一致性","aria-hidden":"true"},{default:a((()=>[p("#")])),_:1})]),c("h4",ql,[p("1、缓存数据一致性 - 双写模式 "),r(Ae,{class:"header-anchor",href:"#_1、缓存数据一致性-双写模式","aria-hidden":"true"},{default:a((()=>[p("#")])),_:1})]),Nl,c("h4",Wl,[Hl,p(),r(Ae,{class:"header-anchor",href:"#如何保证数据库和缓存双写一致性","aria-hidden":"true"},{default:a((()=>[p("#")])),_:1})]),Gl,c("h5",Xl,[p("1.常见方案 "),r(Ae,{class:"header-anchor",href:"#_1-常见方案","aria-hidden":"true"},{default:a((()=>[p("#")])),_:1})]),Ql,$l,Yl,Zl,so,c("h5",lo,[p("2.先写缓存，再写数据库 "),r(Ae,{class:"header-anchor",href:"#_2-先写缓存-再写数据库","aria-hidden":"true"},{default:a((()=>[p("#")])),_:1})]),oo,no,c("h5",ao,[p("3.先写数据库，再写缓存 "),r(Ae,{class:"header-anchor",href:"#_3-先写数据库-再写缓存","aria-hidden":"true"},{default:a((()=>[p("#")])),_:1})]),eo,to,co,c("h6",po,[p("3.1 写缓存失败了 "),r(Ae,{class:"header-anchor",href:"#_3-1-写缓存失败了","aria-hidden":"true"},{default:a((()=>[p("#")])),_:1})]),ro,Eo,yo,c("h6",io,[p("3.2 高并发下的问题 "),r(Ae,{class:"header-anchor",href:"#_3-2-高并发下的问题","aria-hidden":"true"},{default:a((()=>[p("#")])),_:1})]),uo,go,Fo,Do,c("h6",Ao,[p("3.3 浪费系统资源 "),r(Ae,{class:"header-anchor",href:"#_3-3-浪费系统资源","aria-hidden":"true"},{default:a((()=>[p("#")])),_:1})]),Co,ho,c("h5",mo,[p("4.先删缓存，再写数据库 "),r(Ae,{class:"header-anchor",href:"#_4-先删缓存-再写数据库","aria-hidden":"true"},{default:a((()=>[p("#")])),_:1})]),ko,bo,Bo,c("h6",So,[p("4.1 高并发下的问题 "),r(Ae,{class:"header-anchor",href:"#_4-1-高并发下的问题","aria-hidden":"true"},{default:a((()=>[p("#")])),_:1})]),Io,fo,vo,Lo,c("h6",_o,[p("4.2 缓存双删 "),r(Ae,{class:"header-anchor",href:"#_4-2-缓存双删","aria-hidden":"true"},{default:a((()=>[p("#")])),_:1})]),Ro,To,jo,c("h5",Oo,[p("5.先写数据库，再删缓存 "),r(Ae,{class:"header-anchor",href:"#_5-先写数据库-再删缓存","aria-hidden":"true"},{default:a((()=>[p("#")])),_:1})]),xo,Vo,zo,wo,Mo,Uo,Jo,Po,Ko,qo,No,Wo,c("h5",Ho,[p("6.删缓存失败怎么办？ "),r(Ae,{class:"header-anchor",href:"#_6-删缓存失败怎么办","aria-hidden":"true"},{default:a((()=>[p("#")])),_:1})]),Go,c("h5",Xo,[p("7.定时任务 "),r(Ae,{class:"header-anchor",href:"#_7-定时任务","aria-hidden":"true"},{default:a((()=>[p("#")])),_:1})]),Qo,$o,Yo,Zo,sn,ln,c("ul",null,[c("li",null,[p("如果大家对定时任务比较感兴趣的话，可以看看我的另一篇文章《"),r(Ae,{href:"https://mp.weixin.qq.com/s?__biz=MzkwNjMwMTgzMQ==&mid=2247490314&idx=1&sn=29ddf0c1e99675b86cdfc082556a69a9&chksm=c0ebc3e2f79c4af43cf8582d41b0bc3ede57986cc6c115b103b586a2c7bddb4475555e919b20&token=751314179&lang=zh_CN&scene=21#wechat_redirect",target:"_blank",rel:"noreferrer"},{default:a((()=>[p("学会这10种定时任务，我有点飘了")])),_:1}),p("》，里面列出了目前最主流的定时任务。")]),on,nn]),c("h5",an,[r(Ae,{href:"http://8.mq",target:"_blank",rel:"noreferrer"},{default:a((()=>[p("8.mq")])),_:1}),p(),r(Ae,{class:"header-anchor",href:"#_8-mq","aria-hidden":"true"},{default:a((()=>[p("#")])),_:1})]),c("ul",null,[en,c("li",null,[p("对mq有兴趣的朋友可以看看我的另一篇文章《"),r(Ae,{href:"https://mp.weixin.qq.com/s/j5Jedf7OSPkyNs11610v8Q",target:"_blank",rel:"noreferrer"},{default:a((()=>[p("mq的那些破事儿")])),_:1}),p("》。")]),tn,cn]),pn,rn,En,c("h5",yn,[p("9.binlog "),r(Ae,{class:"header-anchor",href:"#_9-binlog","aria-hidden":"true"},{default:a((()=>[p("#")])),_:1})]),un,dn,gn,Fn,Dn,An,c("h4",Cn,[p("2、缓存数据一致性 - 失效模式 "),r(Ae,{class:"header-anchor",href:"#_2、缓存数据一致性-失效模式","aria-hidden":"true"},{default:a((()=>[p("#")])),_:1})]),hn,c("h4",mn,[p("3、缓存数据一致性 - 解决方案 "),r(Ae,{class:"header-anchor",href:"#_3、缓存数据一致性-解决方案","aria-hidden":"true"},{default:a((()=>[p("#")])),_:1})]),kn,c("h4",bn,[p("4、缓存数据一致性 - 解决-Canal "),r(Ae,{class:"header-anchor",href:"#_4、缓存数据一致性-解决-canal","aria-hidden":"true"},{default:a((()=>[p("#")])),_:1})]),Bn,c("h3",Sn,[p("四、分布式锁 "),r(Ae,{class:"header-anchor",href:"#四、分布式锁","aria-hidden":"true"},{default:a((()=>[p("#")])),_:1})]),c("h4",In,[p("1、分布式锁与本地锁 "),r(Ae,{class:"header-anchor",href:"#_1、分布式锁与本地锁","aria-hidden":"true"},{default:a((()=>[p("#")])),_:1})]),fn,vn,Ln,_n,Rn,c("h5",Tn,[p("锁-时序问题 "),r(Ae,{class:"header-anchor",href:"#锁-时序问题","aria-hidden":"true"},{default:a((()=>[p("#")])),_:1})]),jn,c("h4",On,[p("2、分布式锁演进 "),r(Ae,{class:"header-anchor",href:"#_2、分布式锁演进","aria-hidden":"true"},{default:a((()=>[p("#")])),_:1})]),c("h5",xn,[p("分布式锁演进-基本原理 "),r(Ae,{class:"header-anchor",href:"#分布式锁演进-基本原理","aria-hidden":"true"},{default:a((()=>[p("#")])),_:1})]),Vn,zn,c("h5",wn,[p("分布式锁演进-阶段一 "),r(Ae,{class:"header-anchor",href:"#分布式锁演进-阶段一","aria-hidden":"true"},{default:a((()=>[p("#")])),_:1})]),Mn,Un,c("h5",Jn,[p("分布式锁演进-阶段二 "),r(Ae,{class:"header-anchor",href:"#分布式锁演进-阶段二","aria-hidden":"true"},{default:a((()=>[p("#")])),_:1})]),Pn,Kn,c("h5",qn,[p("分布式锁演进-阶段三 "),r(Ae,{class:"header-anchor",href:"#分布式锁演进-阶段三","aria-hidden":"true"},{default:a((()=>[p("#")])),_:1})]),Nn,Wn,c("h5",Hn,[p("分布式锁演进-阶段四 "),r(Ae,{class:"header-anchor",href:"#分布式锁演进-阶段四","aria-hidden":"true"},{default:a((()=>[p("#")])),_:1})]),Gn,Xn,c("h5",Qn,[p("分布式锁演进-阶段五-最终形态 "),r(Ae,{class:"header-anchor",href:"#分布式锁演进-阶段五-最终形态","aria-hidden":"true"},{default:a((()=>[p("#")])),_:1})]),$n,Yn,Zn,sa,la,c("h4",oa,[p("3、Redisson 完成分布式锁 "),r(Ae,{class:"header-anchor",href:"#_3、redisson-完成分布式锁","aria-hidden":"true"},{default:a((()=>[p("#")])),_:1})]),na,c("p",null,[p("Redisson 是架设在 Redis 基础上的一个 Java 驻内存数据网格（In-Memory Data Grid）。充分 的利用了 Redis 键值数据库提供的一系列优势，基于 Java 实用工具包中常用接口，为使用者 提供了一系列具有分布式特性的常用工具类。使得原本作为协调单机多线程并发程序的工 具包获得了协调分布式多机多线程并发系统的能力，大大降低了设计和研发大规模分布式 系统的难度。同时结合各富特色的分布式服务，更进一步简化了分布式环境中程序相互之间 的协作。 官方文档："),r(Ae,{href:"https://github.com/redisson/redisson/wiki/%E7%9B%AE%E5%BD%95",target:"_blank",rel:"noreferrer"},{default:a((()=>[p("https://github.com/redisson/redisson/wiki/目录")])),_:1})]),aa,ea,ta,ca,pa,ra,Ea,ya,ia,ua,da,ga,Fa,Da,Aa,Ca,ha,ma,ka,ba,c("h3",Ba,[p("五、Spring Cache "),r(Ae,{class:"header-anchor",href:"#五、spring-cache","aria-hidden":"true"},{default:a((()=>[p("#")])),_:1})]),c("h4",Sa,[p("1、简介 "),r(Ae,{class:"header-anchor",href:"#_1、简介","aria-hidden":"true"},{default:a((()=>[p("#")])),_:1})]),Ia,c("h4",fa,[p("2、基础概念 "),r(Ae,{class:"header-anchor",href:"#_2、基础概念","aria-hidden":"true"},{default:a((()=>[p("#")])),_:1})]),va,c("h4",La,[p("3、注解 "),r(Ae,{class:"header-anchor",href:"#_3、注解","aria-hidden":"true"},{default:a((()=>[p("#")])),_:1})]),_a,Ra,c("h4",Ta,[p("4、表达式语法 "),r(Ae,{class:"header-anchor",href:"#_4、表达式语法","aria-hidden":"true"},{default:a((()=>[p("#")])),_:1})]),ja,c("h4",Oa,[p("5、缓存穿透问题解决（允许 null 值缓存） "),r(Ae,{class:"header-anchor",href:"#_5、缓存穿透问题解决-允许-null-值缓存","aria-hidden":"true"},{default:a((()=>[p("#")])),_:1})]),xa,c("h4",Va,[p("6、使用 "),r(Ae,{class:"header-anchor",href:"#_6、使用","aria-hidden":"true"},{default:a((()=>[p("#")])),_:1})]),za,wa,Ma,Ua,Ja,Pa,Ka,qa,Na,Wa,Ha,Ga,Xa,Qa,$a,c("h4",Ya,[p("7、总结 "),r(Ae,{class:"header-anchor",href:"#_7、总结","aria-hidden":"true"},{default:a((()=>[p("#")])),_:1})]),Za,c("ul",null,[se,le,oe,ne,c("li",null,[ae,c("ul",null,[ee,te,ce,pe,c("li",null,[c("p",null,[p('自定义：缓存分区：value = {"category"} :: 缓存名字：key = "\'level1Categorys\'"/"#'),r(Ae,{href:"http://root.method.name",target:"_blank",rel:"noreferrer"},{default:a((()=>[p("root.method.name")])),_:1}),p('"')]),c("ul",null,[re,c("li",null,[p("SpEl详情："),r(Ae,{href:"https://docs.spring.io/spring-framework/docs/current/reference/html/integration.html#cache-spel-cont",target:"_blank",rel:"noreferrer"},{default:a((()=>[p("https://docs.spring.io/spring-framework/docs/current/reference/html/integration.html#cache-spel-cont")])),_:1})]),Ee,ye])])])]),ie,ue,de,ge]),Fe,De])),"main-header":a((()=>[E(s.$slots,"main-header")])),"main-header-after":a((()=>[E(s.$slots,"main-header-after")])),"main-nav":a((()=>[E(s.$slots,"main-nav")])),"main-content":a((()=>[E(s.$slots,"main-content")])),"main-content-after":a((()=>[E(s.$slots,"main-content-after")])),"main-nav-before":a((()=>[E(s.$slots,"main-nav-before")])),"main-nav-after":a((()=>[E(s.$slots,"main-nav-after")])),comment:a((()=>[E(s.$slots,"comment")])),footer:a((()=>[E(s.$slots,"footer")])),aside:a((()=>[E(s.$slots,"aside")])),"aside-custom":a((()=>[E(s.$slots,"aside-custom")])),default:a((()=>[E(s.$slots,"default")])),_:3},8,["frontmatter","data"])}]]);export{i as __pageData,Ae as default};
