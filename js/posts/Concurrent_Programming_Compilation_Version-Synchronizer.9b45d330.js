import{_ as s,u as l,p as o,c as n,w as a,a as e,o as c,b as t,d as p,e as r,r as E,f as y}from"../../assets/app-c31cbd14.js";const i=JSON.parse('{"title":"并发编程整理版-同步器","description":"","frontmatter":{"cover":"https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/wallhaven-8o1owj_1920x1080.png","title":"并发编程整理版-同步器","top":303,"author":"imklaus","tags":["AQS","ReentrantLock","ReentrantReadWriteLock","CountDownLatch","CyclicBarrier","Semaphore","Exchanger"],"categories":"Java","date":"2023-08-24T19:11:16.000Z","outline":"deep"},"headers":[{"level":2,"title":"同步器","slug":"同步器","link":"#同步器","children":[{"level":3,"title":"AQS","slug":"aqs","link":"#aqs","children":[]},{"level":3,"title":"Re-Lock","slug":"re-lock","link":"#re-lock","children":[]},{"level":3,"title":"ReadWrite","slug":"readwrite","link":"#readwrite","children":[]},{"level":3,"title":"CountDown","slug":"countdown","link":"#countdown","children":[]},{"level":3,"title":"CyclicBarrier","slug":"cyclicbarrier","link":"#cyclicbarrier","children":[]},{"level":3,"title":"Semaphore","slug":"semaphore","link":"#semaphore","children":[]},{"level":3,"title":"Exchanger","slug":"exchanger","link":"#exchanger","children":[]}]}],"relativePath":"pages/posts/Concurrent_Programming_Compilation_Version-Synchronizer.md","path":"D:\\\\Learning\\\\myblog\\\\valaxy-lastest\\\\imklaus-valaxy-blog\\\\pages\\\\posts\\\\Concurrent_Programming_Compilation_Version-Synchronizer.md","lastUpdated":null}'),F=JSON.parse('{"title":"并发编程整理版-同步器","description":"","frontmatter":{"cover":"https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/wallhaven-8o1owj_1920x1080.png","title":"并发编程整理版-同步器","top":303,"author":"imklaus","tags":["AQS","ReentrantLock","ReentrantReadWriteLock","CountDownLatch","CyclicBarrier","Semaphore","Exchanger"],"categories":"Java","date":"2023-08-24T19:11:16.000Z","outline":"deep"},"headers":[{"level":2,"title":"同步器","slug":"同步器","link":"#同步器","children":[{"level":3,"title":"AQS","slug":"aqs","link":"#aqs","children":[]},{"level":3,"title":"Re-Lock","slug":"re-lock","link":"#re-lock","children":[]},{"level":3,"title":"ReadWrite","slug":"readwrite","link":"#readwrite","children":[]},{"level":3,"title":"CountDown","slug":"countdown","link":"#countdown","children":[]},{"level":3,"title":"CyclicBarrier","slug":"cyclicbarrier","link":"#cyclicbarrier","children":[]},{"level":3,"title":"Semaphore","slug":"semaphore","link":"#semaphore","children":[]},{"level":3,"title":"Exchanger","slug":"exchanger","link":"#exchanger","children":[]}]}],"relativePath":"pages/posts/Concurrent_Programming_Compilation_Version-Synchronizer.md","path":"D:\\\\Learning\\\\myblog\\\\valaxy-lastest\\\\imklaus-valaxy-blog\\\\pages\\\\posts\\\\Concurrent_Programming_Compilation_Version-Synchronizer.md","lastUpdated":null}'),d={name:"pages/posts/Concurrent_Programming_Compilation_Version-Synchronizer.md",data:()=>({data:F,frontmatter:F.frontmatter,$frontmatter:F.frontmatter}),setup(){const s=l();s.meta.frontmatter=Object.assign(s.meta.frontmatter,F.frontmatter),o("pageData",F)}},u={id:"并发编程整理版",tabindex:"-1"},A=t("p",null,"笔记的整体结构依据视频编写，并随着学习的深入补充了很多知识",-1),D={id:"同步器",tabindex:"-1"},h={id:"aqs",tabindex:"-1"},C={id:"核心思想",tabindex:"-1"},g=t("p",null,"AQS：AbstractQueuedSynchronizer，是阻塞式锁和相关的同步器工具的框架，许多同步类实现都依赖于该同步器",-1),k=t("p",null,[p("AQS 用状态属性来表示资源的状态（分"),t("strong",null,"独占模式和共享模式"),p("），子类需要定义如何维护这个状态，控制如何获取锁和释放锁")],-1),B=t("ul",null,[t("li",null,"独占模式是只有一个线程能够访问资源，如 ReentrantLock"),t("li",null,"共享模式允许多个线程访问资源，如 Semaphore，ReentrantReadWriteLock 是组合式")],-1),f=t("p",null,"AQS 核心思想：",-1),b=t("ul",null,[t("li",null,[t("p",null,"如果被请求的共享资源空闲，则将当前请求资源的线程设置为有效的工作线程，并将共享资源设置锁定状态")]),t("li",null,[t("p",null,"请求的共享资源被占用，AQS 用队列实现线程阻塞等待以及被唤醒时锁分配的机制，将暂时获取不到锁的线程加入到队列中"),t("p",null,[p("CLH 是一种基于单向链表的"),t("strong",null,"高性能、公平的自旋锁"),p("，AQS 是将每条请求共享资源的线程封装成一个 CLH 锁队列的一个结点（Node）来实现锁的分配")]),t("img",{src:"https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230824173012586.png",alt:"image-20230824173012586",style:{zoom:"80%"}})])],-1),v=t("hr",null,null,-1),S={id:"设计原理",tabindex:"-1"},m=t("p",null,"设计原理：",-1),x=t("ul",null,[t("li",null,[t("p",null,"获取锁："),t("div",{style:{"max-height":"300px"},class:"language-java"},[t("button",{title:"Copy Code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki github-dark vp-code-dark"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"while"),t("span",{style:{color:"#E1E4E8"}},"(state 状态不允许获取) {\t"),t("span",{style:{color:"#6A737D"}},"// tryAcquire(arg)")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}},"(队列中还没有此线程) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        入队并阻塞 park")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"}")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"当前线程出队")])])]),t("pre",{class:"shiki github-light vp-code-light"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"while"),t("span",{style:{color:"#24292E"}},"(state 状态不允许获取) {\t"),t("span",{style:{color:"#6A737D"}},"// tryAcquire(arg)")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}},"(队列中还没有此线程) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        入队并阻塞 park")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"}")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"当前线程出队")])])]),t("button",{class:"collapse"})])]),t("li",null,[t("p",null,"释放锁："),t("div",{style:{"max-height":"300px"},class:"language-java"},[t("button",{title:"Copy Code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki github-dark vp-code-dark"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}},"(state 状态允许了) {\t"),t("span",{style:{color:"#6A737D"}},"// tryRelease(arg)")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"\t恢复阻塞的线程(s) unpark")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"}")])])]),t("pre",{class:"shiki github-light vp-code-light"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}},"(state 状态允许了) {\t"),t("span",{style:{color:"#6A737D"}},"// tryRelease(arg)")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"\t恢复阻塞的线程(s) unpark")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"}")])])]),t("button",{class:"collapse"})])])],-1),w=t("p",null,"AbstractQueuedSynchronizer 中 state 设计：",-1),T=t("ul",null,[t("li",null,[t("p",null,"state 使用了 32bit int 来维护同步状态，独占模式 0 表示未加锁状态，大于 0 表示已经加锁状态"),t("div",{style:{"max-height":"300px"},class:"language-java"},[t("button",{title:"Copy Code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki github-dark vp-code-dark"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"private"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"volatile"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," state;")])])]),t("pre",{class:"shiki github-light vp-code-light"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"private"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"volatile"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," state;")])])]),t("button",{class:"collapse"})])]),t("li",null,[t("p",null,[p("state "),t("strong",null,"使用 volatile 修饰配合 CAS"),p(" 保证其修改时的"),t("strong",null,"可见性")])]),t("li",null,[t("p",null,[p("state 表示"),t("strong",null,"线程重入的次数（独占模式）或者剩余许可数（共享模式）")])]),t("li",null,[t("p",null,"state API："),t("ul",null,[t("li",null,[t("code",null,"protected final int getState()"),p("：获取 state 状态")]),t("li",null,[t("code",null,"protected final void setState(int newState)"),p("：设置 state 状态")]),t("li",null,[t("code",null,"protected final boolean compareAndSetState(int expect,int update)"),p("："),t("strong",null,"CAS"),p(" 安全设置 state")])])])],-1),N=t("p",null,"封装线程的 Node 节点中 waitstate 设计：",-1),I=t("ul",null,[t("li",null,[t("p",null,[p("使用 "),t("strong",null,"volatile 修饰配合 CAS"),p(" 保证其修改时的"),t("strong",null,"可见性")])]),t("li",null,[t("p",null,"表示 Node 节点的状态，有以下几种状态："),t("div",{style:{"max-height":"300px"},class:"language-java"},[t("button",{title:"Copy Code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki github-dark vp-code-dark"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// 默认为 0")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"volatile"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," waitStatus;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// 由于超时或中断，此节点被取消，不会再改变状态")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"static"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"final"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," CANCELLED "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}},"  "),t("span",{style:{color:"#79B8FF"}},"1"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// 此节点后面的节点已（或即将）被阻止（通过park），【当前节点在释放或取消时必须唤醒后面的节点】")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"static"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"final"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," SIGNAL    "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"-"),t("span",{style:{color:"#79B8FF"}},"1"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// 此节点当前在条件队列中")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"static"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"final"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," CONDITION "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"-"),t("span",{style:{color:"#79B8FF"}},"2"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// 将releaseShared传播到其他节点")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"static"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"final"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," PROPAGATE "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"-"),t("span",{style:{color:"#79B8FF"}},"3"),t("span",{style:{color:"#E1E4E8"}},";")])])]),t("pre",{class:"shiki github-light vp-code-light"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// 默认为 0")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"volatile"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," waitStatus;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// 由于超时或中断，此节点被取消，不会再改变状态")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"static"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"final"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," CANCELLED "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}},"  "),t("span",{style:{color:"#005CC5"}},"1"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// 此节点后面的节点已（或即将）被阻止（通过park），【当前节点在释放或取消时必须唤醒后面的节点】")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"static"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"final"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," SIGNAL    "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"-"),t("span",{style:{color:"#005CC5"}},"1"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// 此节点当前在条件队列中")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"static"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"final"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," CONDITION "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"-"),t("span",{style:{color:"#005CC5"}},"2"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// 将releaseShared传播到其他节点")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"static"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"final"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," PROPAGATE "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"-"),t("span",{style:{color:"#005CC5"}},"3"),t("span",{style:{color:"#24292E"}},";")])])]),t("button",{class:"collapse"})])])],-1),R=t("p",null,"阻塞恢复设计：",-1),L=t("ul",null,[t("li",null,[p("使用 "),t("code",null,"park & unpark"),p(" 来实现线程的暂停和恢复，因为命令的先后顺序不影响结果")]),t("li",null,[t("code",null,"park & unpark"),p(" 是针对线程的，而不是针对同步器的，因此控制粒度更为精细")]),t("li",null,"park 线程可以通过 interrupt 打断")],-1),q=t("p",null,"队列设计：",-1),j=t("ul",null,[t("li",null,[t("p",null,[p("使用了 "),t("code",null,"FIFO"),p(" 先入先出队列，并不支持优先级队列，"),t("strong",null,"同步队列是双向链表，便于出队入队")]),t("div",{style:{"max-height":"300px"},class:"language-java"},[t("button",{title:"Copy Code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki github-dark vp-code-dark"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// 头结点，指向哑元节点")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"private"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"transient"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"volatile"),t("span",{style:{color:"#E1E4E8"}}," Node head;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// 阻塞队列的尾节点，阻塞队列不包含头结点，从 head.next → tail 认为是阻塞队列")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"private"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"transient"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"volatile"),t("span",{style:{color:"#E1E4E8"}}," Node tail;")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"static"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"final"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"class"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"Node"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// 枚举：共享模式")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"static"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"final"),t("span",{style:{color:"#E1E4E8"}}," Node SHARED "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"new"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"Node"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// 枚举：独占模式")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"static"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"final"),t("span",{style:{color:"#E1E4E8"}}," Node EXCLUSIVE "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"null"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// node 需要构建成 FIFO 队列，prev 指向前继节点")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"volatile"),t("span",{style:{color:"#E1E4E8"}}," Node prev;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// next 指向后继节点")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"volatile"),t("span",{style:{color:"#E1E4E8"}}," Node next;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// 当前 node 封装的线程")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"volatile"),t("span",{style:{color:"#E1E4E8"}}," Thread thread;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// 条件队列是单向链表，只有后继指针，条件队列使用该属性")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    Node nextWaiter;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"}")])])]),t("pre",{class:"shiki github-light vp-code-light"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// 头结点，指向哑元节点")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"private"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"transient"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"volatile"),t("span",{style:{color:"#24292E"}}," Node head;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// 阻塞队列的尾节点，阻塞队列不包含头结点，从 head.next → tail 认为是阻塞队列")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"private"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"transient"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"volatile"),t("span",{style:{color:"#24292E"}}," Node tail;")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"static"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"final"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"class"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"Node"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// 枚举：共享模式")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"static"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"final"),t("span",{style:{color:"#24292E"}}," Node SHARED "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"new"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"Node"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// 枚举：独占模式")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"static"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"final"),t("span",{style:{color:"#24292E"}}," Node EXCLUSIVE "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"null"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// node 需要构建成 FIFO 队列，prev 指向前继节点")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"volatile"),t("span",{style:{color:"#24292E"}}," Node prev;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// next 指向后继节点")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"volatile"),t("span",{style:{color:"#24292E"}}," Node next;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// 当前 node 封装的线程")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"volatile"),t("span",{style:{color:"#24292E"}}," Thread thread;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// 条件队列是单向链表，只有后继指针，条件队列使用该属性")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    Node nextWaiter;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"}")])])]),t("button",{class:"collapse"})]),t("img",{src:"https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230824173120652.png",alt:"image-20230824173120652",style:{zoom:"80%"}})]),t("li",null,[t("p",null,[p("条件变量来实现等待、唤醒机制，支持多个条件变量，类似于 Monitor 的 WaitSet，"),t("strong",null,"条件队列是单向链表")]),t("div",{style:{"max-height":"300px"},class:"language-java"},[t("button",{title:"Copy Code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki github-dark vp-code-dark"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"public"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"class"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"ConditionObject"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"implements"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"Condition"),t("span",{style:{color:"#E1E4E8"}},", java.io."),t("span",{style:{color:"#B392F0"}},"Serializable"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"     "),t("span",{style:{color:"#6A737D"}},"// 指向条件队列的第一个 node 节点")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"     "),t("span",{style:{color:"#F97583"}},"private"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"transient"),t("span",{style:{color:"#E1E4E8"}}," Node firstWaiter;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"     "),t("span",{style:{color:"#6A737D"}},"// 指向条件队列的最后一个 node 节点")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"     "),t("span",{style:{color:"#F97583"}},"private"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"transient"),t("span",{style:{color:"#E1E4E8"}}," Node lastWaiter;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}}," }")])])]),t("pre",{class:"shiki github-light vp-code-light"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"public"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"class"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"ConditionObject"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"implements"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"Condition"),t("span",{style:{color:"#24292E"}},", java.io."),t("span",{style:{color:"#6F42C1"}},"Serializable"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"     "),t("span",{style:{color:"#6A737D"}},"// 指向条件队列的第一个 node 节点")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"     "),t("span",{style:{color:"#D73A49"}},"private"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"transient"),t("span",{style:{color:"#24292E"}}," Node firstWaiter;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"     "),t("span",{style:{color:"#6A737D"}},"// 指向条件队列的最后一个 node 节点")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"     "),t("span",{style:{color:"#D73A49"}},"private"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"transient"),t("span",{style:{color:"#24292E"}}," Node lastWaiter;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}}," }")])])]),t("button",{class:"collapse"})])])],-1),O=t("hr",null,null,-1),P={id:"模板对象",tabindex:"-1"},W=t("p",null,"同步器的设计是基于模板方法模式，该模式是基于继承的，主要是为了在不改变模板结构的前提下在子类中重新定义模板中的内容以实现复用代码",-1),H=t("ul",null,[t("li",null,[p("使用者继承 "),t("code",null,"AbstractQueuedSynchronizer"),p(" 并重写指定的方法")]),t("li",null,"将 AQS 组合在自定义同步组件的实现中，并调用其模板方法，这些模板方法会调用使用者重写的方法")],-1),_=t("p",null,"AQS 使用了模板方法模式，自定义同步器时需要重写下面几个 AQS 提供的模板方法：",-1),Q=t("div",{style:{"max-height":"300px"},class:"language-java"},[t("button",{title:"Copy Code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki github-dark vp-code-dark"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#B392F0"}},"isHeldExclusively"),t("span",{style:{color:"#E1E4E8"}},"()\t\t"),t("span",{style:{color:"#6A737D"}},"//该线程是否正在独占资源。只有用到condition才需要去实现它")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#B392F0"}},"tryAcquire"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}},")\t\t\t"),t("span",{style:{color:"#6A737D"}},"//独占方式。尝试获取资源，成功则返回true，失败则返回false")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#B392F0"}},"tryRelease"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}},")\t\t\t"),t("span",{style:{color:"#6A737D"}},"//独占方式。尝试释放资源，成功则返回true，失败则返回false")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#B392F0"}},"tryAcquireShared"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}},")\t"),t("span",{style:{color:"#6A737D"}},"//共享方式。尝试获取资源。负数表示失败；0表示成功但没有剩余可用资源；正数表示成功且有剩余资源")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#B392F0"}},"tryReleaseShared"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}},")\t"),t("span",{style:{color:"#6A737D"}},"//共享方式。尝试释放资源，成功则返回true，失败则返回false")])])]),t("pre",{class:"shiki github-light vp-code-light"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#6F42C1"}},"isHeldExclusively"),t("span",{style:{color:"#24292E"}},"()\t\t"),t("span",{style:{color:"#6A737D"}},"//该线程是否正在独占资源。只有用到condition才需要去实现它")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#6F42C1"}},"tryAcquire"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}},")\t\t\t"),t("span",{style:{color:"#6A737D"}},"//独占方式。尝试获取资源，成功则返回true，失败则返回false")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#6F42C1"}},"tryRelease"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}},")\t\t\t"),t("span",{style:{color:"#6A737D"}},"//独占方式。尝试释放资源，成功则返回true，失败则返回false")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#6F42C1"}},"tryAcquireShared"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}},")\t"),t("span",{style:{color:"#6A737D"}},"//共享方式。尝试获取资源。负数表示失败；0表示成功但没有剩余可用资源；正数表示成功且有剩余资源")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#6F42C1"}},"tryReleaseShared"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}},")\t"),t("span",{style:{color:"#6A737D"}},"//共享方式。尝试释放资源，成功则返回true，失败则返回false")])])]),t("button",{class:"collapse"})],-1),G=t("ul",null,[t("li",null,[p("默认情况下，每个方法都抛出 "),t("code",null,"UnsupportedOperationException")]),t("li",null,"这些方法的实现必须是内部线程安全的"),t("li",null,"AQS 类中的其他方法都是 final ，所以无法被其他类使用，只有这几个方法可以被其他类使用")],-1),z=t("hr",null,null,-1),U={id:"自定义",tabindex:"-1"},M=t("p",null,"自定义一个不可重入锁：",-1),V=t("div",{style:{"max-height":"300px"},class:"language-java"},[t("button",{title:"Copy Code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki github-dark vp-code-dark"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"class"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"MyLock"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"implements"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"Lock"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"//独占锁 不可重入")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"class"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"MySync"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"extends"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"AbstractQueuedSynchronizer"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        @"),t("span",{style:{color:"#F97583"}},"Override")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"protected"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"boolean"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"tryAcquire"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#FFAB70"}},"arg"),t("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," ("),t("span",{style:{color:"#B392F0"}},"compareAndSetState"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#79B8FF"}},"0"),t("span",{style:{color:"#E1E4E8"}},", "),t("span",{style:{color:"#79B8FF"}},"1"),t("span",{style:{color:"#E1E4E8"}},")) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#6A737D"}},"// 加上锁 设置 owner 为当前线程")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#B392F0"}},"setExclusiveOwnerThread"),t("span",{style:{color:"#E1E4E8"}},"(Thread."),t("span",{style:{color:"#B392F0"}},"currentThread"),t("span",{style:{color:"#E1E4E8"}},"());")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#F97583"}},"return"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"true"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"return"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"false"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        @"),t("span",{style:{color:"#F97583"}},"Override"),t("span",{style:{color:"#E1E4E8"}},"   "),t("span",{style:{color:"#6A737D"}},"//解锁")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"protected"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"boolean"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"tryRelease"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#FFAB70"}},"arg"),t("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#B392F0"}},"setExclusiveOwnerThread"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#79B8FF"}},"null"),t("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#B392F0"}},"setState"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#79B8FF"}},"0"),t("span",{style:{color:"#E1E4E8"}},");"),t("span",{style:{color:"#6A737D"}},"//volatile 修饰的变量放在后面，防止指令重排")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"return"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"true"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        @"),t("span",{style:{color:"#F97583"}},"Override"),t("span",{style:{color:"#E1E4E8"}},"   "),t("span",{style:{color:"#6A737D"}},"//是否持有独占锁")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"protected"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"boolean"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"isHeldExclusively"),t("span",{style:{color:"#E1E4E8"}},"() {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"return"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"getState"),t("span",{style:{color:"#E1E4E8"}},"() "),t("span",{style:{color:"#F97583"}},"=="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"1"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"public"),t("span",{style:{color:"#E1E4E8"}}," Condition "),t("span",{style:{color:"#B392F0"}},"newCondition"),t("span",{style:{color:"#E1E4E8"}},"() {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"return"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"new"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"ConditionObject"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"private"),t("span",{style:{color:"#E1E4E8"}}," MySync sync "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"new"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"MySync"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    @"),t("span",{style:{color:"#F97583"}},"Override"),t("span",{style:{color:"#E1E4E8"}},"   "),t("span",{style:{color:"#6A737D"}},"//加锁（不成功进入等待队列等待）")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"public"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"void"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"lock"),t("span",{style:{color:"#E1E4E8"}},"() {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        sync."),t("span",{style:{color:"#B392F0"}},"acquire"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#79B8FF"}},"1"),t("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    @"),t("span",{style:{color:"#F97583"}},"Override"),t("span",{style:{color:"#E1E4E8"}},"   "),t("span",{style:{color:"#6A737D"}},"//加锁 可打断")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"public"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"void"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"lockInterruptibly"),t("span",{style:{color:"#E1E4E8"}},"() "),t("span",{style:{color:"#F97583"}},"throws"),t("span",{style:{color:"#E1E4E8"}}," InterruptedException {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        sync."),t("span",{style:{color:"#B392F0"}},"acquireInterruptibly"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#79B8FF"}},"1"),t("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    @"),t("span",{style:{color:"#F97583"}},"Override"),t("span",{style:{color:"#E1E4E8"}},"   "),t("span",{style:{color:"#6A737D"}},"//尝试加锁，尝试一次")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"public"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"boolean"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"tryLock"),t("span",{style:{color:"#E1E4E8"}},"() {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"return"),t("span",{style:{color:"#E1E4E8"}}," sync."),t("span",{style:{color:"#B392F0"}},"tryAcquire"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#79B8FF"}},"1"),t("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    @"),t("span",{style:{color:"#F97583"}},"Override"),t("span",{style:{color:"#E1E4E8"}},"   "),t("span",{style:{color:"#6A737D"}},"//尝试加锁，带超时")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"public"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"boolean"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"tryLock"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#F97583"}},"long"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#FFAB70"}},"time"),t("span",{style:{color:"#E1E4E8"}},", TimeUnit "),t("span",{style:{color:"#FFAB70"}},"unit"),t("span",{style:{color:"#E1E4E8"}},") "),t("span",{style:{color:"#F97583"}},"throws"),t("span",{style:{color:"#E1E4E8"}}," InterruptedException {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"return"),t("span",{style:{color:"#E1E4E8"}}," sync."),t("span",{style:{color:"#B392F0"}},"tryAcquireNanos"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#79B8FF"}},"1"),t("span",{style:{color:"#E1E4E8"}},", unit."),t("span",{style:{color:"#B392F0"}},"toNanos"),t("span",{style:{color:"#E1E4E8"}},"(time));")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    @"),t("span",{style:{color:"#F97583"}},"Override"),t("span",{style:{color:"#E1E4E8"}},"   "),t("span",{style:{color:"#6A737D"}},"//解锁")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"public"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"void"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"unlock"),t("span",{style:{color:"#E1E4E8"}},"() {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        sync."),t("span",{style:{color:"#B392F0"}},"release"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#79B8FF"}},"1"),t("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    @"),t("span",{style:{color:"#F97583"}},"Override"),t("span",{style:{color:"#E1E4E8"}},"   "),t("span",{style:{color:"#6A737D"}},"//条件变量")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"public"),t("span",{style:{color:"#E1E4E8"}}," Condition "),t("span",{style:{color:"#B392F0"}},"newCondition"),t("span",{style:{color:"#E1E4E8"}},"() {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"return"),t("span",{style:{color:"#E1E4E8"}}," sync."),t("span",{style:{color:"#B392F0"}},"newCondition"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"}")])])]),t("pre",{class:"shiki github-light vp-code-light"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"class"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"MyLock"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"implements"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"Lock"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"//独占锁 不可重入")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"class"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"MySync"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"extends"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"AbstractQueuedSynchronizer"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        @"),t("span",{style:{color:"#D73A49"}},"Override")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"protected"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"boolean"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"tryAcquire"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#E36209"}},"arg"),t("span",{style:{color:"#24292E"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," ("),t("span",{style:{color:"#6F42C1"}},"compareAndSetState"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#005CC5"}},"0"),t("span",{style:{color:"#24292E"}},", "),t("span",{style:{color:"#005CC5"}},"1"),t("span",{style:{color:"#24292E"}},")) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#6A737D"}},"// 加上锁 设置 owner 为当前线程")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#6F42C1"}},"setExclusiveOwnerThread"),t("span",{style:{color:"#24292E"}},"(Thread."),t("span",{style:{color:"#6F42C1"}},"currentThread"),t("span",{style:{color:"#24292E"}},"());")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#D73A49"}},"return"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"true"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"return"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"false"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        @"),t("span",{style:{color:"#D73A49"}},"Override"),t("span",{style:{color:"#24292E"}},"   "),t("span",{style:{color:"#6A737D"}},"//解锁")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"protected"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"boolean"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"tryRelease"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#E36209"}},"arg"),t("span",{style:{color:"#24292E"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#6F42C1"}},"setExclusiveOwnerThread"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#005CC5"}},"null"),t("span",{style:{color:"#24292E"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#6F42C1"}},"setState"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#005CC5"}},"0"),t("span",{style:{color:"#24292E"}},");"),t("span",{style:{color:"#6A737D"}},"//volatile 修饰的变量放在后面，防止指令重排")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"return"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"true"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        @"),t("span",{style:{color:"#D73A49"}},"Override"),t("span",{style:{color:"#24292E"}},"   "),t("span",{style:{color:"#6A737D"}},"//是否持有独占锁")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"protected"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"boolean"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"isHeldExclusively"),t("span",{style:{color:"#24292E"}},"() {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"return"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"getState"),t("span",{style:{color:"#24292E"}},"() "),t("span",{style:{color:"#D73A49"}},"=="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"1"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"public"),t("span",{style:{color:"#24292E"}}," Condition "),t("span",{style:{color:"#6F42C1"}},"newCondition"),t("span",{style:{color:"#24292E"}},"() {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"return"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"new"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"ConditionObject"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    }")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"private"),t("span",{style:{color:"#24292E"}}," MySync sync "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"new"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"MySync"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    @"),t("span",{style:{color:"#D73A49"}},"Override"),t("span",{style:{color:"#24292E"}},"   "),t("span",{style:{color:"#6A737D"}},"//加锁（不成功进入等待队列等待）")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"public"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"void"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"lock"),t("span",{style:{color:"#24292E"}},"() {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        sync."),t("span",{style:{color:"#6F42C1"}},"acquire"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#005CC5"}},"1"),t("span",{style:{color:"#24292E"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    }")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    @"),t("span",{style:{color:"#D73A49"}},"Override"),t("span",{style:{color:"#24292E"}},"   "),t("span",{style:{color:"#6A737D"}},"//加锁 可打断")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"public"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"void"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"lockInterruptibly"),t("span",{style:{color:"#24292E"}},"() "),t("span",{style:{color:"#D73A49"}},"throws"),t("span",{style:{color:"#24292E"}}," InterruptedException {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        sync."),t("span",{style:{color:"#6F42C1"}},"acquireInterruptibly"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#005CC5"}},"1"),t("span",{style:{color:"#24292E"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    }")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    @"),t("span",{style:{color:"#D73A49"}},"Override"),t("span",{style:{color:"#24292E"}},"   "),t("span",{style:{color:"#6A737D"}},"//尝试加锁，尝试一次")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"public"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"boolean"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"tryLock"),t("span",{style:{color:"#24292E"}},"() {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"return"),t("span",{style:{color:"#24292E"}}," sync."),t("span",{style:{color:"#6F42C1"}},"tryAcquire"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#005CC5"}},"1"),t("span",{style:{color:"#24292E"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    }")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    @"),t("span",{style:{color:"#D73A49"}},"Override"),t("span",{style:{color:"#24292E"}},"   "),t("span",{style:{color:"#6A737D"}},"//尝试加锁，带超时")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"public"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"boolean"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"tryLock"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#D73A49"}},"long"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#E36209"}},"time"),t("span",{style:{color:"#24292E"}},", TimeUnit "),t("span",{style:{color:"#E36209"}},"unit"),t("span",{style:{color:"#24292E"}},") "),t("span",{style:{color:"#D73A49"}},"throws"),t("span",{style:{color:"#24292E"}}," InterruptedException {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"return"),t("span",{style:{color:"#24292E"}}," sync."),t("span",{style:{color:"#6F42C1"}},"tryAcquireNanos"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#005CC5"}},"1"),t("span",{style:{color:"#24292E"}},", unit."),t("span",{style:{color:"#6F42C1"}},"toNanos"),t("span",{style:{color:"#24292E"}},"(time));")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    @"),t("span",{style:{color:"#D73A49"}},"Override"),t("span",{style:{color:"#24292E"}},"   "),t("span",{style:{color:"#6A737D"}},"//解锁")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"public"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"void"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"unlock"),t("span",{style:{color:"#24292E"}},"() {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        sync."),t("span",{style:{color:"#6F42C1"}},"release"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#005CC5"}},"1"),t("span",{style:{color:"#24292E"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    @"),t("span",{style:{color:"#D73A49"}},"Override"),t("span",{style:{color:"#24292E"}},"   "),t("span",{style:{color:"#6A737D"}},"//条件变量")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"public"),t("span",{style:{color:"#24292E"}}," Condition "),t("span",{style:{color:"#6F42C1"}},"newCondition"),t("span",{style:{color:"#24292E"}},"() {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"return"),t("span",{style:{color:"#24292E"}}," sync."),t("span",{style:{color:"#6F42C1"}},"newCondition"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"}")])])]),t("button",{class:"collapse"})],-1),K=t("hr",null,null,-1),X={id:"re-lock",tabindex:"-1"},J={id:"锁对比",tabindex:"-1"},$=t("p",null,"ReentrantLock 相对于 synchronized 具备如下特点：",-1),Z=t("ol",null,[t("li",null,"锁的实现：synchronized 是 JVM 实现的，而 ReentrantLock 是 JDK 实现的"),t("li",null,"性能：新版本 Java 对 synchronized 进行了很多优化，synchronized 与 ReentrantLock 大致相同"),t("li",null,"使用：ReentrantLock 需要手动解锁，synchronized 执行完代码块自动解锁"),t("li",null,[t("strong",null,"可中断"),p("：ReentrantLock 可中断，而 synchronized 不行")]),t("li",null,[t("strong",null,"公平锁"),p("：公平锁是指多个线程在等待同一个锁时，必须按照申请锁的时间顺序来依次获得锁 "),t("ul",null,[t("li",null,"ReentrantLock 可以设置公平锁，synchronized 中的锁是非公平的"),t("li",null,"不公平锁的含义是阻塞队列内公平，队列外非公平")])]),t("li",null,[p("锁超时：尝试获取锁，超时获取不到直接放弃，不进入阻塞队列 "),t("ul",null,[t("li",null,"ReentrantLock 可以设置超时时间，synchronized 会一直等待")])]),t("li",null,"锁绑定多个条件：一个 ReentrantLock 可以同时绑定多个 Condition 对象，更细粒度的唤醒线程"),t("li",null,"两者都是可重入锁")],-1),Y=t("hr",null,null,-1),ss={id:"使用锁",tabindex:"-1"},ls=t("p",null,[p("构造方法："),t("code",null,"ReentrantLock lock = new ReentrantLock();")],-1),os=t("p",null,"ReentrantLock 类 API：",-1),ns=t("ul",null,[t("li",null,[t("p",null,[t("code",null,"public void lock()"),p("：获得锁")]),t("ul",null,[t("li",null,[t("p",null,"如果锁没有被另一个线程占用，则将锁定计数设置为 1")]),t("li",null,[t("p",null,"如果当前线程已经保持锁定，则保持计数增加 1")]),t("li",null,[t("p",null,"如果锁被另一个线程保持，则当前线程被禁用线程调度，并且在锁定已被获取之前处于休眠状态")])])]),t("li",null,[t("p",null,[t("code",null,"public void unlock()"),p("：尝试释放锁")]),t("ul",null,[t("li",null,"如果当前线程是该锁的持有者，则保持计数递减"),t("li",null,"如果保持计数现在为零，则锁定被释放"),t("li",null,"如果当前线程不是该锁的持有者，则抛出异常")])])],-1),as=t("p",null,"基本语法：",-1),es=t("div",{style:{"max-height":"300px"},class:"language-java"},[t("button",{title:"Copy Code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki github-dark vp-code-dark"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// 获取锁")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"reentrantLock."),t("span",{style:{color:"#B392F0"}},"lock"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"try"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// 临界区")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"} "),t("span",{style:{color:"#F97583"}},"finally"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"\t"),t("span",{style:{color:"#6A737D"}},"// 释放锁")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"\treentrantLock."),t("span",{style:{color:"#B392F0"}},"unlock"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"}")])])]),t("pre",{class:"shiki github-light vp-code-light"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// 获取锁")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"reentrantLock."),t("span",{style:{color:"#6F42C1"}},"lock"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"try"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// 临界区")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"} "),t("span",{style:{color:"#D73A49"}},"finally"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"\t"),t("span",{style:{color:"#6A737D"}},"// 释放锁")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"\treentrantLock."),t("span",{style:{color:"#6F42C1"}},"unlock"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"}")])])]),t("button",{class:"collapse"})],-1),cs=t("hr",null,null,-1),ts={id:"公平锁",tabindex:"-1"},ps={id:"基本使用",tabindex:"-1"},rs=t("p",null,[p("构造方法："),t("code",null,"ReentrantLock lock = new ReentrantLock(true)")],-1),Es=t("div",{style:{"max-height":"300px"},class:"language-java"},[t("button",{title:"Copy Code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki github-dark vp-code-dark"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"public"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"ReentrantLock"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#F97583"}},"boolean"),t("span",{style:{color:"#E1E4E8"}}," fair) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    sync "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," fair "),t("span",{style:{color:"#F97583"}},"?"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"new"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"FairSync"),t("span",{style:{color:"#E1E4E8"}},"() "),t("span",{style:{color:"#F97583"}},":"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"new"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"NonfairSync"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"}")])])]),t("pre",{class:"shiki github-light vp-code-light"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"public"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"ReentrantLock"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#D73A49"}},"boolean"),t("span",{style:{color:"#24292E"}}," fair) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    sync "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," fair "),t("span",{style:{color:"#D73A49"}},"?"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"new"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"FairSync"),t("span",{style:{color:"#24292E"}},"() "),t("span",{style:{color:"#D73A49"}},":"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"new"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"NonfairSync"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"}")])])]),t("button",{class:"collapse"})],-1),ys=t("p",null,"ReentrantLock 默认是不公平的：",-1),is=t("div",{style:{"max-height":"300px"},class:"language-java"},[t("button",{title:"Copy Code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki github-dark vp-code-dark"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"public"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"ReentrantLock"),t("span",{style:{color:"#E1E4E8"}},"() {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    sync "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"new"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"NonfairSync"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"}")])])]),t("pre",{class:"shiki github-light vp-code-light"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"public"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"ReentrantLock"),t("span",{style:{color:"#24292E"}},"() {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    sync "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"new"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"NonfairSync"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"}")])])]),t("button",{class:"collapse"})],-1),Fs=t("p",null,"说明：公平锁一般没有必要，会降低并发度",-1),ds=t("hr",null,null,-1),us={id:"非公原理",tabindex:"-1"},As={id:"加锁",tabindex:"-1"},Ds=t("p",null,"NonfairSync 继承自 AQS",-1),hs=t("div",{style:{"max-height":"300px"},class:"language-java"},[t("button",{title:"Copy Code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki github-dark vp-code-dark"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"public"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"void"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"lock"),t("span",{style:{color:"#E1E4E8"}},"() {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    sync."),t("span",{style:{color:"#B392F0"}},"lock"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"}")])])]),t("pre",{class:"shiki github-light vp-code-light"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"public"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"void"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"lock"),t("span",{style:{color:"#24292E"}},"() {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    sync."),t("span",{style:{color:"#6F42C1"}},"lock"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"}")])])]),t("button",{class:"collapse"})],-1),Cs=t("ul",null,[t("li",null,[t("p",null,"没有竞争：ExclusiveOwnerThread 属于 Thread-0，state 设置为 1"),t("div",{style:{"max-height":"300px"},class:"language-java"},[t("button",{title:"Copy Code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki github-dark vp-code-dark"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// ReentrantLock.NonfairSync#lock")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"final"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"void"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"lock"),t("span",{style:{color:"#E1E4E8"}},"() {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// 用 cas 尝试（仅尝试一次）将 state 从 0 改为 1, 如果成功表示【获得了独占锁】")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," ("),t("span",{style:{color:"#B392F0"}},"compareAndSetState"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#79B8FF"}},"0"),t("span",{style:{color:"#E1E4E8"}},", "),t("span",{style:{color:"#79B8FF"}},"1"),t("span",{style:{color:"#E1E4E8"}},"))")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#6A737D"}},"// 设置当前线程为独占线程")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#B392F0"}},"setExclusiveOwnerThread"),t("span",{style:{color:"#E1E4E8"}},"(Thread."),t("span",{style:{color:"#B392F0"}},"currentThread"),t("span",{style:{color:"#E1E4E8"}},"());")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"else")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#B392F0"}},"acquire"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#79B8FF"}},"1"),t("span",{style:{color:"#E1E4E8"}},");"),t("span",{style:{color:"#6A737D"}},"//失败进入")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"}")])])]),t("pre",{class:"shiki github-light vp-code-light"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// ReentrantLock.NonfairSync#lock")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"final"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"void"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"lock"),t("span",{style:{color:"#24292E"}},"() {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// 用 cas 尝试（仅尝试一次）将 state 从 0 改为 1, 如果成功表示【获得了独占锁】")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," ("),t("span",{style:{color:"#6F42C1"}},"compareAndSetState"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#005CC5"}},"0"),t("span",{style:{color:"#24292E"}},", "),t("span",{style:{color:"#005CC5"}},"1"),t("span",{style:{color:"#24292E"}},"))")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6A737D"}},"// 设置当前线程为独占线程")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6F42C1"}},"setExclusiveOwnerThread"),t("span",{style:{color:"#24292E"}},"(Thread."),t("span",{style:{color:"#6F42C1"}},"currentThread"),t("span",{style:{color:"#24292E"}},"());")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"else")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6F42C1"}},"acquire"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#005CC5"}},"1"),t("span",{style:{color:"#24292E"}},");"),t("span",{style:{color:"#6A737D"}},"//失败进入")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"}")])])]),t("button",{class:"collapse"})])])],-1),gs=t("img",{src:"https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230719155415862.png",alt:"image-20230719155415862",style:{zoom:"50%"}},null,-1),ks=t("ul",null,[t("li",null,[t("p",null,"第一个竞争出现：Thread-1 执行，CAS 尝试将 state 由 0 改为 1，结果失败（第一次），进入 acquire 逻辑"),t("div",{style:{"max-height":"300px"},class:"language-java"},[t("button",{title:"Copy Code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki github-dark vp-code-dark"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// AbstractQueuedSynchronizer#acquire")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"public"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"final"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"void"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"acquire"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," arg) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// tryAcquire 尝试获取锁失败时, 会调用 addWaiter 将当前线程封装成node入队，acquireQueued 阻塞当前线程，")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// acquireQueued 返回 true 表示挂起过程中线程被中断唤醒过，false 表示未被中断过")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," ("),t("span",{style:{color:"#F97583"}},"!"),t("span",{style:{color:"#B392F0"}},"tryAcquire"),t("span",{style:{color:"#E1E4E8"}},"(arg) "),t("span",{style:{color:"#F97583"}},"&&"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"acquireQueued"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#B392F0"}},"addWaiter"),t("span",{style:{color:"#E1E4E8"}},"(Node.EXCLUSIVE), arg))")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#6A737D"}},"// 如果线程被中断了逻辑来到这，完成一次真正的打断效果")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#B392F0"}},"selfInterrupt"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"}")])])]),t("pre",{class:"shiki github-light vp-code-light"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// AbstractQueuedSynchronizer#acquire")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"public"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"final"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"void"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"acquire"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," arg) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// tryAcquire 尝试获取锁失败时, 会调用 addWaiter 将当前线程封装成node入队，acquireQueued 阻塞当前线程，")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// acquireQueued 返回 true 表示挂起过程中线程被中断唤醒过，false 表示未被中断过")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," ("),t("span",{style:{color:"#D73A49"}},"!"),t("span",{style:{color:"#6F42C1"}},"tryAcquire"),t("span",{style:{color:"#24292E"}},"(arg) "),t("span",{style:{color:"#D73A49"}},"&&"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"acquireQueued"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#6F42C1"}},"addWaiter"),t("span",{style:{color:"#24292E"}},"(Node.EXCLUSIVE), arg))")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6A737D"}},"// 如果线程被中断了逻辑来到这，完成一次真正的打断效果")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6F42C1"}},"selfInterrupt"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"}")])])]),t("button",{class:"collapse"})]),t("img",{src:"https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230719155428092.png",alt:"image-20230719155428092",style:{zoom:"50%"}})]),t("li",null,[t("p",null,"进入 tryAcquire 尝试获取锁逻辑，这时 state 已经是1，结果仍然失败（第二次），加锁成功有两种情况："),t("ul",null,[t("li",null,"当前 AQS 处于无锁状态"),t("li",null,"加锁线程就是当前线程，说明发生了锁重入")]),t("div",{style:{"max-height":"300px"},class:"language-java"},[t("button",{title:"Copy Code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki github-dark vp-code-dark"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// ReentrantLock.NonfairSync#tryAcquire")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"protected"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"final"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"boolean"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"tryAcquire"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," acquires) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"return"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"nonfairTryAcquire"),t("span",{style:{color:"#E1E4E8"}},"(acquires);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"}")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// 抢占成功返回 true，抢占失败返回 false")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"final"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"boolean"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"nonfairTryAcquire"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," acquires) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"final"),t("span",{style:{color:"#E1E4E8"}}," Thread current "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," Thread."),t("span",{style:{color:"#B392F0"}},"currentThread"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// state 值")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," c "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"getState"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// 条件成立说明当前处于【无锁状态】")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (c "),t("span",{style:{color:"#F97583"}},"=="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"0"),t("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#6A737D"}},"//如果还没有获得锁，尝试用cas获得，这里体现非公平性: 不去检查 AQS 队列是否有阻塞线程直接获取锁        ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    \t"),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," ("),t("span",{style:{color:"#B392F0"}},"compareAndSetState"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#79B8FF"}},"0"),t("span",{style:{color:"#E1E4E8"}},", acquires)) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#6A737D"}},"// 获取锁成功设置当前线程为独占锁线程。")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#B392F0"}},"setExclusiveOwnerThread"),t("span",{style:{color:"#E1E4E8"}},"(current);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"return"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"true"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"         }    ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"\t}    ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"   \t"),t("span",{style:{color:"#6A737D"}},"// 如果已经有线程获得了锁, 独占锁线程还是当前线程, 表示【发生了锁重入】")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"\t"),t("span",{style:{color:"#F97583"}},"else"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (current "),t("span",{style:{color:"#F97583"}},"=="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"getExclusiveOwnerThread"),t("span",{style:{color:"#E1E4E8"}},"()) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#6A737D"}},"// 更新锁重入的值")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," nextc "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," c "),t("span",{style:{color:"#F97583"}},"+"),t("span",{style:{color:"#E1E4E8"}}," acquires;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#6A737D"}},"// 越界判断，当重入的深度很深时，会导致 nextc < 0，int值达到最大之后再 + 1 变负数")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (nextc "),t("span",{style:{color:"#F97583"}},"<"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"0"),t("span",{style:{color:"#E1E4E8"}},") "),t("span",{style:{color:"#6A737D"}},"// overflow")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"throw"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"new"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"Error"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#9ECBFF"}},'"Maximum lock count exceeded"'),t("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#6A737D"}},"// 更新 state 的值，这里不使用 cas 是因为当前线程正在持有锁，所以这里的操作相当于在一个管程内")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#B392F0"}},"setState"),t("span",{style:{color:"#E1E4E8"}},"(nextc);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"return"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"true"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// 获取失败")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"return"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"false"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"}")])])]),t("pre",{class:"shiki github-light vp-code-light"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// ReentrantLock.NonfairSync#tryAcquire")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"protected"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"final"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"boolean"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"tryAcquire"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," acquires) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"return"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"nonfairTryAcquire"),t("span",{style:{color:"#24292E"}},"(acquires);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"}")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// 抢占成功返回 true，抢占失败返回 false")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"final"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"boolean"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"nonfairTryAcquire"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," acquires) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"final"),t("span",{style:{color:"#24292E"}}," Thread current "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," Thread."),t("span",{style:{color:"#6F42C1"}},"currentThread"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// state 值")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," c "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"getState"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// 条件成立说明当前处于【无锁状态】")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (c "),t("span",{style:{color:"#D73A49"}},"=="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"0"),t("span",{style:{color:"#24292E"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6A737D"}},"//如果还没有获得锁，尝试用cas获得，这里体现非公平性: 不去检查 AQS 队列是否有阻塞线程直接获取锁        ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    \t"),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," ("),t("span",{style:{color:"#6F42C1"}},"compareAndSetState"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#005CC5"}},"0"),t("span",{style:{color:"#24292E"}},", acquires)) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#6A737D"}},"// 获取锁成功设置当前线程为独占锁线程。")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#6F42C1"}},"setExclusiveOwnerThread"),t("span",{style:{color:"#24292E"}},"(current);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"return"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"true"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"         }    ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"\t}    ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"   \t"),t("span",{style:{color:"#6A737D"}},"// 如果已经有线程获得了锁, 独占锁线程还是当前线程, 表示【发生了锁重入】")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"\t"),t("span",{style:{color:"#D73A49"}},"else"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (current "),t("span",{style:{color:"#D73A49"}},"=="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"getExclusiveOwnerThread"),t("span",{style:{color:"#24292E"}},"()) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6A737D"}},"// 更新锁重入的值")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," nextc "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," c "),t("span",{style:{color:"#D73A49"}},"+"),t("span",{style:{color:"#24292E"}}," acquires;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6A737D"}},"// 越界判断，当重入的深度很深时，会导致 nextc < 0，int值达到最大之后再 + 1 变负数")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (nextc "),t("span",{style:{color:"#D73A49"}},"<"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"0"),t("span",{style:{color:"#24292E"}},") "),t("span",{style:{color:"#6A737D"}},"// overflow")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"throw"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"new"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"Error"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#032F62"}},'"Maximum lock count exceeded"'),t("span",{style:{color:"#24292E"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6A737D"}},"// 更新 state 的值，这里不使用 cas 是因为当前线程正在持有锁，所以这里的操作相当于在一个管程内")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6F42C1"}},"setState"),t("span",{style:{color:"#24292E"}},"(nextc);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"return"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"true"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// 获取失败")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"return"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"false"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"}")])])]),t("button",{class:"collapse"})])]),t("li",null,[t("p",null,"接下来进入 addWaiter 逻辑，构造 Node 队列（不是阻塞队列），前置条件是当前线程获取锁失败，说明有线程占用了锁"),t("ul",null,[t("li",null,[p("图中黄色三角表示该 Node 的 waitStatus 状态，其中 0 为默认"),t("strong",null,"正常状态")]),t("li",null,[p("Node 的创建是懒惰的，其中第一个 Node 称为 "),t("strong",null,"Dummy（哑元）或哨兵"),p("，用来占位，并不关联线程")])]),t("div",{style:{"max-height":"300px"},class:"language-java"},[t("button",{title:"Copy Code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki github-dark vp-code-dark"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// AbstractQueuedSynchronizer#addWaiter，返回当前线程的 node 节点")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"private"),t("span",{style:{color:"#E1E4E8"}}," Node "),t("span",{style:{color:"#B392F0"}},"addWaiter"),t("span",{style:{color:"#E1E4E8"}},"(Node mode) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// 将当前线程关联到一个 Node 对象上, 模式为独占模式   ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    Node node "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"new"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"Node"),t("span",{style:{color:"#E1E4E8"}},"(Thread."),t("span",{style:{color:"#B392F0"}},"currentThread"),t("span",{style:{color:"#E1E4E8"}},"(), mode);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    Node pred "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," tail;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// 快速入队，如果 tail 不为 null，说明存在队列")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (pred "),t("span",{style:{color:"#F97583"}},"!="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"null"),t("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#6A737D"}},"// 将当前节点的前驱节点指向 尾节点")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        node.prev "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," pred;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#6A737D"}},"// 通过 cas 将 Node 对象加入 AQS 队列，成为尾节点，【尾插法】")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," ("),t("span",{style:{color:"#B392F0"}},"compareAndSetTail"),t("span",{style:{color:"#E1E4E8"}},"(pred, node)) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            pred.next "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," node;"),t("span",{style:{color:"#6A737D"}},"// 双向链表")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"return"),t("span",{style:{color:"#E1E4E8"}}," node;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// 初始时队列为空，或者 CAS 失败进入这里")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#B392F0"}},"enq"),t("span",{style:{color:"#E1E4E8"}},"(node);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"return"),t("span",{style:{color:"#E1E4E8"}}," node;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"}")])])]),t("pre",{class:"shiki github-light vp-code-light"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// AbstractQueuedSynchronizer#addWaiter，返回当前线程的 node 节点")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"private"),t("span",{style:{color:"#24292E"}}," Node "),t("span",{style:{color:"#6F42C1"}},"addWaiter"),t("span",{style:{color:"#24292E"}},"(Node mode) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// 将当前线程关联到一个 Node 对象上, 模式为独占模式   ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    Node node "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"new"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"Node"),t("span",{style:{color:"#24292E"}},"(Thread."),t("span",{style:{color:"#6F42C1"}},"currentThread"),t("span",{style:{color:"#24292E"}},"(), mode);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    Node pred "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," tail;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// 快速入队，如果 tail 不为 null，说明存在队列")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (pred "),t("span",{style:{color:"#D73A49"}},"!="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"null"),t("span",{style:{color:"#24292E"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6A737D"}},"// 将当前节点的前驱节点指向 尾节点")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        node.prev "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," pred;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6A737D"}},"// 通过 cas 将 Node 对象加入 AQS 队列，成为尾节点，【尾插法】")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," ("),t("span",{style:{color:"#6F42C1"}},"compareAndSetTail"),t("span",{style:{color:"#24292E"}},"(pred, node)) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            pred.next "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," node;"),t("span",{style:{color:"#6A737D"}},"// 双向链表")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"return"),t("span",{style:{color:"#24292E"}}," node;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// 初始时队列为空，或者 CAS 失败进入这里")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6F42C1"}},"enq"),t("span",{style:{color:"#24292E"}},"(node);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"return"),t("span",{style:{color:"#24292E"}}," node;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"}")])])]),t("button",{class:"collapse"})]),t("div",{style:{"max-height":"300px"},class:"language-java"},[t("button",{title:"Copy Code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki github-dark vp-code-dark"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// AbstractQueuedSynchronizer#enq")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"private"),t("span",{style:{color:"#E1E4E8"}}," Node "),t("span",{style:{color:"#B392F0"}},"enq"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#F97583"}},"final"),t("span",{style:{color:"#E1E4E8"}}," Node node) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// 自旋入队，必须入队成功才结束循环")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"for"),t("span",{style:{color:"#E1E4E8"}}," (;;) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        Node t "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," tail;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#6A737D"}},"// 说明当前锁被占用，且当前线程可能是【第一个获取锁失败】的线程，【还没有建立队列】")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (t "),t("span",{style:{color:"#F97583"}},"=="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"null"),t("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#6A737D"}},"// 设置一个【哑元节点】，头尾指针都指向该节点")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," ("),t("span",{style:{color:"#B392F0"}},"compareAndSetHead"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#F97583"}},"new"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"Node"),t("span",{style:{color:"#E1E4E8"}},"()))")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                tail "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," head;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        } "),t("span",{style:{color:"#F97583"}},"else"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#6A737D"}},"// 自旋到这，普通入队方式，首先赋值尾节点的前驱节点【尾插法】")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            node.prev "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," t;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#6A737D"}},"// 【在设置完尾节点后，才更新的原始尾节点的后继节点，所以此时从前往后遍历会丢失尾节点】")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," ("),t("span",{style:{color:"#B392F0"}},"compareAndSetTail"),t("span",{style:{color:"#E1E4E8"}},"(t, node)) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#6A737D"}},"//【此时 t.next  = null，并且这里已经 CAS 结束，线程并不是安全的】")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                t.next "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," node;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#F97583"}},"return"),t("span",{style:{color:"#E1E4E8"}}," t;\t"),t("span",{style:{color:"#6A737D"}},"// 返回当前 node 的前驱节点")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"}")])])]),t("pre",{class:"shiki github-light vp-code-light"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// AbstractQueuedSynchronizer#enq")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"private"),t("span",{style:{color:"#24292E"}}," Node "),t("span",{style:{color:"#6F42C1"}},"enq"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#D73A49"}},"final"),t("span",{style:{color:"#24292E"}}," Node node) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// 自旋入队，必须入队成功才结束循环")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"for"),t("span",{style:{color:"#24292E"}}," (;;) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        Node t "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," tail;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6A737D"}},"// 说明当前锁被占用，且当前线程可能是【第一个获取锁失败】的线程，【还没有建立队列】")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (t "),t("span",{style:{color:"#D73A49"}},"=="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"null"),t("span",{style:{color:"#24292E"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#6A737D"}},"// 设置一个【哑元节点】，头尾指针都指向该节点")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," ("),t("span",{style:{color:"#6F42C1"}},"compareAndSetHead"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#D73A49"}},"new"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"Node"),t("span",{style:{color:"#24292E"}},"()))")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                tail "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," head;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        } "),t("span",{style:{color:"#D73A49"}},"else"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#6A737D"}},"// 自旋到这，普通入队方式，首先赋值尾节点的前驱节点【尾插法】")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            node.prev "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," t;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#6A737D"}},"// 【在设置完尾节点后，才更新的原始尾节点的后继节点，所以此时从前往后遍历会丢失尾节点】")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," ("),t("span",{style:{color:"#6F42C1"}},"compareAndSetTail"),t("span",{style:{color:"#24292E"}},"(t, node)) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#6A737D"}},"//【此时 t.next  = null，并且这里已经 CAS 结束，线程并不是安全的】")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                t.next "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," node;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#D73A49"}},"return"),t("span",{style:{color:"#24292E"}}," t;\t"),t("span",{style:{color:"#6A737D"}},"// 返回当前 node 的前驱节点")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"}")])])]),t("button",{class:"collapse"})]),t("img",{src:"https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230719155452096.png",alt:"image-20230719155452096",style:{zoom:"50%"}})]),t("li",null,[t("p",null,[p("线程节点加入队列成功，进入 "),t("code",null,"AbstractQueuedSynchronizer#acquireQueued"),p(" 逻辑阻塞线程")]),t("ol",null,[t("li",null,"acquireQueued 会在一个自旋中不断尝试获得锁，失败后进入 park 阻塞"),t("li",null,"如果当前线程是在 head 节点后，会再次 tryAcquire 尝试获取锁，state 仍为 1 则失败（第三次）")]),t("div",{style:{"max-height":"300px"},class:"language-java"},[t("button",{title:"Copy Code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki github-dark vp-code-dark"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"final"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"boolean"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"acquireQueued"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#F97583"}},"final"),t("span",{style:{color:"#E1E4E8"}}," Node node, "),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," arg) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// true 表示当前线程抢占锁失败，false 表示成功")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"boolean"),t("span",{style:{color:"#E1E4E8"}}," failed "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"true"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"try"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#6A737D"}},"// 中断标记，表示当前线程是否被中断")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"boolean"),t("span",{style:{color:"#E1E4E8"}}," interrupted "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"false"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"for"),t("span",{style:{color:"#E1E4E8"}}," (;;) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#6A737D"}},"// 获得当前线程节点的前驱节点")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"final"),t("span",{style:{color:"#E1E4E8"}}," Node p "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," node."),t("span",{style:{color:"#B392F0"}},"predecessor"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#6A737D"}},"// 前驱节点是 head, FIFO 队列的特性表示轮到当前线程可以去获取锁")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (p "),t("span",{style:{color:"#F97583"}},"=="),t("span",{style:{color:"#E1E4E8"}}," head "),t("span",{style:{color:"#F97583"}},"&&"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"tryAcquire"),t("span",{style:{color:"#E1E4E8"}},"(arg)) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#6A737D"}},"// 获取成功, 设置当前线程自己的 node 为 head")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#B392F0"}},"setHead"),t("span",{style:{color:"#E1E4E8"}},"(node);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                p.next "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"null"),t("span",{style:{color:"#E1E4E8"}},"; "),t("span",{style:{color:"#6A737D"}},"// help GC")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#6A737D"}},"// 表示抢占锁成功")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                failed "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"false"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#6A737D"}},"// 返回当前线程是否被中断")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#F97583"}},"return"),t("span",{style:{color:"#E1E4E8"}}," interrupted;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#6A737D"}},"// 判断是否应当 park，返回 false 后需要新一轮的循环，返回 true 进入条件二阻塞线程")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," ("),t("span",{style:{color:"#B392F0"}},"shouldParkAfterFailedAcquire"),t("span",{style:{color:"#E1E4E8"}},"(p, node) "),t("span",{style:{color:"#F97583"}},"&&"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"parkAndCheckInterrupt"),t("span",{style:{color:"#E1E4E8"}},"())")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#6A737D"}},"// 条件二返回结果是当前线程是否被打断，没有被打断返回 false 不进入这里的逻辑")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#6A737D"}},"// 【就算被打断了，也会继续循环，并不会返回】")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                interrupted "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"true"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    } "),t("span",{style:{color:"#F97583"}},"finally"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#6A737D"}},"// 【可打断模式下才会进入该逻辑】")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (failed)")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#B392F0"}},"cancelAcquire"),t("span",{style:{color:"#E1E4E8"}},"(node);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"}")])])]),t("pre",{class:"shiki github-light vp-code-light"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"final"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"boolean"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"acquireQueued"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#D73A49"}},"final"),t("span",{style:{color:"#24292E"}}," Node node, "),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," arg) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// true 表示当前线程抢占锁失败，false 表示成功")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"boolean"),t("span",{style:{color:"#24292E"}}," failed "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"true"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"try"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6A737D"}},"// 中断标记，表示当前线程是否被中断")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"boolean"),t("span",{style:{color:"#24292E"}}," interrupted "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"false"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"for"),t("span",{style:{color:"#24292E"}}," (;;) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#6A737D"}},"// 获得当前线程节点的前驱节点")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"final"),t("span",{style:{color:"#24292E"}}," Node p "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," node."),t("span",{style:{color:"#6F42C1"}},"predecessor"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#6A737D"}},"// 前驱节点是 head, FIFO 队列的特性表示轮到当前线程可以去获取锁")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (p "),t("span",{style:{color:"#D73A49"}},"=="),t("span",{style:{color:"#24292E"}}," head "),t("span",{style:{color:"#D73A49"}},"&&"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"tryAcquire"),t("span",{style:{color:"#24292E"}},"(arg)) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#6A737D"}},"// 获取成功, 设置当前线程自己的 node 为 head")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#6F42C1"}},"setHead"),t("span",{style:{color:"#24292E"}},"(node);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                p.next "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"null"),t("span",{style:{color:"#24292E"}},"; "),t("span",{style:{color:"#6A737D"}},"// help GC")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#6A737D"}},"// 表示抢占锁成功")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                failed "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"false"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#6A737D"}},"// 返回当前线程是否被中断")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#D73A49"}},"return"),t("span",{style:{color:"#24292E"}}," interrupted;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#6A737D"}},"// 判断是否应当 park，返回 false 后需要新一轮的循环，返回 true 进入条件二阻塞线程")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," ("),t("span",{style:{color:"#6F42C1"}},"shouldParkAfterFailedAcquire"),t("span",{style:{color:"#24292E"}},"(p, node) "),t("span",{style:{color:"#D73A49"}},"&&"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"parkAndCheckInterrupt"),t("span",{style:{color:"#24292E"}},"())")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#6A737D"}},"// 条件二返回结果是当前线程是否被打断，没有被打断返回 false 不进入这里的逻辑")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#6A737D"}},"// 【就算被打断了，也会继续循环，并不会返回】")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                interrupted "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"true"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    } "),t("span",{style:{color:"#D73A49"}},"finally"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6A737D"}},"// 【可打断模式下才会进入该逻辑】")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (failed)")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#6F42C1"}},"cancelAcquire"),t("span",{style:{color:"#24292E"}},"(node);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"}")])])]),t("button",{class:"collapse"})]),t("ol",{start:"3"},[t("li",null,[p("进入 shouldParkAfterFailedAcquire 逻辑，"),t("strong",null,"将前驱 node 的 waitStatus 改为 -1"),p("，返回 false；waitStatus 为 -1 的节点用来唤醒下一个节点")])]),t("div",{style:{"max-height":"300px"},class:"language-java"},[t("button",{title:"Copy Code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki github-dark vp-code-dark"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"private"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"static"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"boolean"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"shouldParkAfterFailedAcquire"),t("span",{style:{color:"#E1E4E8"}},"(Node pred, Node node) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," ws "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," pred.waitStatus;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// 表示前置节点是个可以唤醒当前节点的节点，返回 true")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (ws "),t("span",{style:{color:"#F97583"}},"=="),t("span",{style:{color:"#E1E4E8"}}," Node.SIGNAL)")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"return"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"true"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// 前置节点的状态处于取消状态，需要【删除前面所有取消的节点】, 返回到外层循环重试")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (ws "),t("span",{style:{color:"#F97583"}},">"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"0"),t("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"do"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            node.prev "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," pred "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," pred.prev;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        } "),t("span",{style:{color:"#F97583"}},"while"),t("span",{style:{color:"#E1E4E8"}}," (pred.waitStatus "),t("span",{style:{color:"#F97583"}},">"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"0"),t("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#6A737D"}},"// 获取到非取消的节点，连接上当前节点")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        pred.next "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," node;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// 默认情况下 node 的 waitStatus 是 0，进入这里的逻辑")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    } "),t("span",{style:{color:"#F97583"}},"else"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#6A737D"}},"// 【设置上一个节点状态为 Node.SIGNAL】，返回外层循环重试")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#B392F0"}},"compareAndSetWaitStatus"),t("span",{style:{color:"#E1E4E8"}},"(pred, ws, Node.SIGNAL);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// 返回不应该 park，再次尝试一次")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"return"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"false"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"}")])])]),t("pre",{class:"shiki github-light vp-code-light"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"private"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"static"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"boolean"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"shouldParkAfterFailedAcquire"),t("span",{style:{color:"#24292E"}},"(Node pred, Node node) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," ws "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," pred.waitStatus;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// 表示前置节点是个可以唤醒当前节点的节点，返回 true")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (ws "),t("span",{style:{color:"#D73A49"}},"=="),t("span",{style:{color:"#24292E"}}," Node.SIGNAL)")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"return"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"true"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// 前置节点的状态处于取消状态，需要【删除前面所有取消的节点】, 返回到外层循环重试")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (ws "),t("span",{style:{color:"#D73A49"}},">"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"0"),t("span",{style:{color:"#24292E"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"do"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            node.prev "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," pred "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," pred.prev;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        } "),t("span",{style:{color:"#D73A49"}},"while"),t("span",{style:{color:"#24292E"}}," (pred.waitStatus "),t("span",{style:{color:"#D73A49"}},">"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"0"),t("span",{style:{color:"#24292E"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6A737D"}},"// 获取到非取消的节点，连接上当前节点")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        pred.next "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," node;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// 默认情况下 node 的 waitStatus 是 0，进入这里的逻辑")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    } "),t("span",{style:{color:"#D73A49"}},"else"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6A737D"}},"// 【设置上一个节点状态为 Node.SIGNAL】，返回外层循环重试")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6F42C1"}},"compareAndSetWaitStatus"),t("span",{style:{color:"#24292E"}},"(pred, ws, Node.SIGNAL);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// 返回不应该 park，再次尝试一次")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"return"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"false"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"}")])])]),t("button",{class:"collapse"})]),t("img",{src:"https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230719155516878.png",alt:"image-20230719155516878",style:{zoom:"50%"}}),t("ol",{start:"4"},[t("li",null,"shouldParkAfterFailedAcquire 执行完毕回到 acquireQueued ，再次 tryAcquire 尝试获取锁，这时 state 仍为 1 获取失败（第四次）"),t("li",null,"当再次进入 shouldParkAfterFailedAcquire 时，这时其前驱 node 的 waitStatus 已经是 -1 了，返回 true"),t("li",null,"进入 parkAndCheckInterrupt， Thread-1 park（灰色表示）")]),t("div",{style:{"max-height":"300px"},class:"language-java"},[t("button",{title:"Copy Code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki github-dark vp-code-dark"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"private"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"final"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"boolean"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"parkAndCheckInterrupt"),t("span",{style:{color:"#E1E4E8"}},"() {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// 阻塞当前线程，如果打断标记已经是 true, 则 park 会失效")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    LockSupport."),t("span",{style:{color:"#B392F0"}},"park"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#79B8FF"}},"this"),t("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// 判断当前线程是否被打断，清除打断标记")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"return"),t("span",{style:{color:"#E1E4E8"}}," Thread."),t("span",{style:{color:"#B392F0"}},"interrupted"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"}")])])]),t("pre",{class:"shiki github-light vp-code-light"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"private"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"final"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"boolean"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"parkAndCheckInterrupt"),t("span",{style:{color:"#24292E"}},"() {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// 阻塞当前线程，如果打断标记已经是 true, 则 park 会失效")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    LockSupport."),t("span",{style:{color:"#6F42C1"}},"park"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#005CC5"}},"this"),t("span",{style:{color:"#24292E"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// 判断当前线程是否被打断，清除打断标记")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"return"),t("span",{style:{color:"#24292E"}}," Thread."),t("span",{style:{color:"#6F42C1"}},"interrupted"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"}")])])]),t("button",{class:"collapse"})]),t("img",{src:"https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230719155528402.png",alt:"image-20230719155528402",style:{zoom:"50%"}})]),t("li",null,[t("p",null,"再有多个线程经历竞争失败后："),t("figure",null,[t("img",{alt:"image-20230719155542494",class:"lazy","data-src":"https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230719155542494.png"})])])],-1),Bs=t("hr",null,null,-1),fs={id:"解锁",tabindex:"-1"},bs=t("p",null,[t("code",null,"ReentrantLock#unlock"),p("：释放锁")],-1),vs=t("div",{style:{"max-height":"300px"},class:"language-java"},[t("button",{title:"Copy Code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki github-dark vp-code-dark"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"public"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"void"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"unlock"),t("span",{style:{color:"#E1E4E8"}},"() {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    sync."),t("span",{style:{color:"#B392F0"}},"release"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#79B8FF"}},"1"),t("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"}")])])]),t("pre",{class:"shiki github-light vp-code-light"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"public"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"void"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"unlock"),t("span",{style:{color:"#24292E"}},"() {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    sync."),t("span",{style:{color:"#6F42C1"}},"release"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#005CC5"}},"1"),t("span",{style:{color:"#24292E"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"}")])])]),t("button",{class:"collapse"})],-1),Ss=t("p",null,"Thread-0 释放锁，进入 release 流程",-1),ms=t("ul",null,[t("li",null,[p("进入 tryRelease，设置 exclusiveOwnerThread 为 null，"),t("code",null,"state = 0")])],-1),xs=t("img",{src:"https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230719155652604.png",alt:"image-20230719155652604",style:{zoom:"67%"}},null,-1),ws=t("ul",null,[t("li",null,[t("p",null,[p("当前队列不为 null，并且 head 的 "),t("code",null,"waitStatus = -1"),p("，进入 unparkSuccessor")]),t("div",{style:{"max-height":"300px"},class:"language-java"},[t("button",{title:"Copy Code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki github-dark vp-code-dark"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// AbstractQueuedSynchronizer#release")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"public"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"final"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"boolean"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"release"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," arg) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// 尝试释放锁，tryRelease 返回 true 表示当前线程已经【完全释放锁，重入的释放了】")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," ("),t("span",{style:{color:"#B392F0"}},"tryRelease"),t("span",{style:{color:"#E1E4E8"}},"(arg)) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#6A737D"}},"// 队列头节点")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        Node h "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," head;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#6A737D"}},"// 头节点什么时候是空？没有发生锁竞争，没有竞争线程创建哑元节点")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#6A737D"}},"// 条件成立说明阻塞队列有等待线程，需要唤醒 head 节点后面的线程")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (h "),t("span",{style:{color:"#F97583"}},"!="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"null"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"&&"),t("span",{style:{color:"#E1E4E8"}}," h.waitStatus "),t("span",{style:{color:"#F97583"}},"!="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"0"),t("span",{style:{color:"#E1E4E8"}},")")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#B392F0"}},"unparkSuccessor"),t("span",{style:{color:"#E1E4E8"}},"(h);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"return"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"true"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    }    ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"return"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"false"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"}")])])]),t("pre",{class:"shiki github-light vp-code-light"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// AbstractQueuedSynchronizer#release")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"public"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"final"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"boolean"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"release"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," arg) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// 尝试释放锁，tryRelease 返回 true 表示当前线程已经【完全释放锁，重入的释放了】")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," ("),t("span",{style:{color:"#6F42C1"}},"tryRelease"),t("span",{style:{color:"#24292E"}},"(arg)) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6A737D"}},"// 队列头节点")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        Node h "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," head;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6A737D"}},"// 头节点什么时候是空？没有发生锁竞争，没有竞争线程创建哑元节点")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6A737D"}},"// 条件成立说明阻塞队列有等待线程，需要唤醒 head 节点后面的线程")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (h "),t("span",{style:{color:"#D73A49"}},"!="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"null"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"&&"),t("span",{style:{color:"#24292E"}}," h.waitStatus "),t("span",{style:{color:"#D73A49"}},"!="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"0"),t("span",{style:{color:"#24292E"}},")")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#6F42C1"}},"unparkSuccessor"),t("span",{style:{color:"#24292E"}},"(h);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"return"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"true"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    }    ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"return"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"false"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"}")])])]),t("button",{class:"collapse"})]),t("div",{style:{"max-height":"300px"},class:"language-java"},[t("button",{title:"Copy Code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki github-dark vp-code-dark"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// ReentrantLock.Sync#tryRelease")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"protected"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"final"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"boolean"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"tryRelease"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," releases) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// 减去释放的值，可能重入")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," c "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"getState"),t("span",{style:{color:"#E1E4E8"}},"() "),t("span",{style:{color:"#F97583"}},"-"),t("span",{style:{color:"#E1E4E8"}}," releases;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// 如果当前线程不是持有锁的线程直接报错")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (Thread."),t("span",{style:{color:"#B392F0"}},"currentThread"),t("span",{style:{color:"#E1E4E8"}},"() "),t("span",{style:{color:"#F97583"}},"!="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"getExclusiveOwnerThread"),t("span",{style:{color:"#E1E4E8"}},"())")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"throw"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"new"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"IllegalMonitorStateException"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// 是否已经完全释放锁")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"boolean"),t("span",{style:{color:"#E1E4E8"}}," free "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"false"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// 支持锁重入, 只有 state 减为 0, 才完全释放锁成功")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (c "),t("span",{style:{color:"#F97583"}},"=="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"0"),t("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        free "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"true"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#B392F0"}},"setExclusiveOwnerThread"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#79B8FF"}},"null"),t("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// 当前线程就是持有锁线程，所以可以直接更新锁，不需要使用 CAS")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#B392F0"}},"setState"),t("span",{style:{color:"#E1E4E8"}},"(c);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"return"),t("span",{style:{color:"#E1E4E8"}}," free;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"}")])])]),t("pre",{class:"shiki github-light vp-code-light"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// ReentrantLock.Sync#tryRelease")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"protected"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"final"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"boolean"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"tryRelease"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," releases) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// 减去释放的值，可能重入")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," c "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"getState"),t("span",{style:{color:"#24292E"}},"() "),t("span",{style:{color:"#D73A49"}},"-"),t("span",{style:{color:"#24292E"}}," releases;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// 如果当前线程不是持有锁的线程直接报错")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (Thread."),t("span",{style:{color:"#6F42C1"}},"currentThread"),t("span",{style:{color:"#24292E"}},"() "),t("span",{style:{color:"#D73A49"}},"!="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"getExclusiveOwnerThread"),t("span",{style:{color:"#24292E"}},"())")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"throw"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"new"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"IllegalMonitorStateException"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// 是否已经完全释放锁")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"boolean"),t("span",{style:{color:"#24292E"}}," free "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"false"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// 支持锁重入, 只有 state 减为 0, 才完全释放锁成功")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (c "),t("span",{style:{color:"#D73A49"}},"=="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"0"),t("span",{style:{color:"#24292E"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        free "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"true"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6F42C1"}},"setExclusiveOwnerThread"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#005CC5"}},"null"),t("span",{style:{color:"#24292E"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// 当前线程就是持有锁线程，所以可以直接更新锁，不需要使用 CAS")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6F42C1"}},"setState"),t("span",{style:{color:"#24292E"}},"(c);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"return"),t("span",{style:{color:"#24292E"}}," free;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"}")])])]),t("button",{class:"collapse"})])]),t("li",null,[t("p",null,[p("进入 "),t("code",null,"AbstractQueuedSynchronizer#unparkSuccessor"),p(" 方法，唤醒当前节点的后继节点")]),t("ul",null,[t("li",null,"找到队列中距离 head 最近的一个没取消的 Node，unpark 恢复其运行，本例中即为 Thread-1"),t("li",null,"回到 Thread-1 的 acquireQueued 流程")]),t("div",{style:{"max-height":"300px"},class:"language-java"},[t("button",{title:"Copy Code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki github-dark vp-code-dark"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"private"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"void"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"unparkSuccessor"),t("span",{style:{color:"#E1E4E8"}},"(Node node) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// 当前节点的状态")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," ws "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," node.waitStatus;    ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (ws "),t("span",{style:{color:"#F97583"}},"<"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"0"),t("span",{style:{color:"#E1E4E8"}},")        ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#6A737D"}},"// 【尝试重置状态为 0】，因为当前节点要完成对后续节点的唤醒任务了，不需要 -1 了")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#B392F0"}},"compareAndSetWaitStatus"),t("span",{style:{color:"#E1E4E8"}},"(node, ws, "),t("span",{style:{color:"#79B8FF"}},"0"),t("span",{style:{color:"#E1E4E8"}},");    ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// 找到需要 unpark 的节点，当前节点的下一个    ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    Node s "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," node.next;    ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// 已取消的节点不能唤醒，需要找到距离头节点最近的非取消的节点")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (s "),t("span",{style:{color:"#F97583"}},"=="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"null"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"||"),t("span",{style:{color:"#E1E4E8"}}," s.waitStatus "),t("span",{style:{color:"#F97583"}},">"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"0"),t("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        s "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"null"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#6A737D"}},"// AQS 队列【从后至前】找需要 unpark 的节点，直到 t == 当前的 node 为止，找不到就不唤醒了")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"for"),t("span",{style:{color:"#E1E4E8"}}," (Node t "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," tail; t "),t("span",{style:{color:"#F97583"}},"!="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"null"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"&&"),t("span",{style:{color:"#E1E4E8"}}," t "),t("span",{style:{color:"#F97583"}},"!="),t("span",{style:{color:"#E1E4E8"}}," node; t "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," t.prev)")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#6A737D"}},"// 说明当前线程状态需要被唤醒")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (t.waitStatus "),t("span",{style:{color:"#F97583"}},"<="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"0"),t("span",{style:{color:"#E1E4E8"}},")")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#6A737D"}},"// 置换引用")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                s "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," t;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// 【找到合适的可以被唤醒的 node，则唤醒线程】")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (s "),t("span",{style:{color:"#F97583"}},"!="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"null"),t("span",{style:{color:"#E1E4E8"}},")")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        LockSupport."),t("span",{style:{color:"#B392F0"}},"unpark"),t("span",{style:{color:"#E1E4E8"}},"(s.thread);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"}")])])]),t("pre",{class:"shiki github-light vp-code-light"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"private"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"void"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"unparkSuccessor"),t("span",{style:{color:"#24292E"}},"(Node node) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// 当前节点的状态")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," ws "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," node.waitStatus;    ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (ws "),t("span",{style:{color:"#D73A49"}},"<"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"0"),t("span",{style:{color:"#24292E"}},")        ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6A737D"}},"// 【尝试重置状态为 0】，因为当前节点要完成对后续节点的唤醒任务了，不需要 -1 了")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6F42C1"}},"compareAndSetWaitStatus"),t("span",{style:{color:"#24292E"}},"(node, ws, "),t("span",{style:{color:"#005CC5"}},"0"),t("span",{style:{color:"#24292E"}},");    ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// 找到需要 unpark 的节点，当前节点的下一个    ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    Node s "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," node.next;    ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// 已取消的节点不能唤醒，需要找到距离头节点最近的非取消的节点")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (s "),t("span",{style:{color:"#D73A49"}},"=="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"null"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"||"),t("span",{style:{color:"#24292E"}}," s.waitStatus "),t("span",{style:{color:"#D73A49"}},">"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"0"),t("span",{style:{color:"#24292E"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        s "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"null"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6A737D"}},"// AQS 队列【从后至前】找需要 unpark 的节点，直到 t == 当前的 node 为止，找不到就不唤醒了")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"for"),t("span",{style:{color:"#24292E"}}," (Node t "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," tail; t "),t("span",{style:{color:"#D73A49"}},"!="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"null"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"&&"),t("span",{style:{color:"#24292E"}}," t "),t("span",{style:{color:"#D73A49"}},"!="),t("span",{style:{color:"#24292E"}}," node; t "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," t.prev)")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#6A737D"}},"// 说明当前线程状态需要被唤醒")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (t.waitStatus "),t("span",{style:{color:"#D73A49"}},"<="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"0"),t("span",{style:{color:"#24292E"}},")")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#6A737D"}},"// 置换引用")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                s "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," t;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// 【找到合适的可以被唤醒的 node，则唤醒线程】")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (s "),t("span",{style:{color:"#D73A49"}},"!="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"null"),t("span",{style:{color:"#24292E"}},")")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        LockSupport."),t("span",{style:{color:"#6F42C1"}},"unpark"),t("span",{style:{color:"#24292E"}},"(s.thread);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"}")])])]),t("button",{class:"collapse"})]),t("p",null,[t("strong",null,"从后向前的唤醒的原因"),p("：enq 方法中，节点是尾插法，首先赋值的是尾节点的前驱节点，此时前驱节点的 next 并没有指向尾节点，从前遍历会丢失尾节点")])]),t("li",null,[t("p",null,"唤醒的线程会从 park 位置开始执行，如果加锁成功（没有竞争），会设置"),t("ul",null,[t("li",null,[p("exclusiveOwnerThread 为 Thread-1，"),t("code",null,"state = 1")]),t("li",null,"head 指向刚刚 Thread-1 所在的 Node，该 Node 会清空 Thread"),t("li",null,"原本的 head 因为从链表断开，而可被垃圾回收（图中有错误，原来的头节点的 waitStatus 被改为 0 了）")]),t("img",{src:"https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230719155754206.png",alt:"image-20230719155754206",style:{zoom:"67%"}})]),t("li",null,[t("p",null,"如果这时有其它线程来竞争**（非公平）**，例如这时有 Thread-4 来了并抢占了锁"),t("ul",null,[t("li",null,"Thread-4 被设置为 exclusiveOwnerThread，state = 1"),t("li",null,"Thread-1 再次进入 acquireQueued 流程，获取锁失败，重新进入 park 阻塞")]),t("figure",null,[t("img",{alt:"image-20230719155831915",class:"lazy","data-src":"https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230719155831915.png"})])])],-1),Ts=t("hr",null,null,-1),Ns={id:"公平原理",tabindex:"-1"},Is=t("p",null,"与非公平锁主要区别在于 tryAcquire 方法：先检查 AQS 队列中是否有前驱节点，没有才去 CAS 竞争",-1),Rs=t("div",{style:{"max-height":"300px"},class:"language-java"},[t("button",{title:"Copy Code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki github-dark vp-code-dark"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"static"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"final"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"class"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"FairSync"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"extends"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"Sync"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"private"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"static"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"final"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"long"),t("span",{style:{color:"#E1E4E8"}}," serialVersionUID "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"-"),t("span",{style:{color:"#79B8FF"}},"3000897897090466540L"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"final"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"void"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"lock"),t("span",{style:{color:"#E1E4E8"}},"() {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#B392F0"}},"acquire"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#79B8FF"}},"1"),t("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"protected"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"final"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"boolean"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"tryAcquire"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#FFAB70"}},"acquires"),t("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"final"),t("span",{style:{color:"#E1E4E8"}}," Thread current "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," Thread."),t("span",{style:{color:"#B392F0"}},"currentThread"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," c "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"getState"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (c "),t("span",{style:{color:"#F97583"}},"=="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"0"),t("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#6A737D"}},"// 先检查 AQS 队列中是否有前驱节点, 没有(false)才去竞争")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," ("),t("span",{style:{color:"#F97583"}},"!"),t("span",{style:{color:"#B392F0"}},"hasQueuedPredecessors"),t("span",{style:{color:"#E1E4E8"}},"() "),t("span",{style:{color:"#F97583"}},"&&")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#B392F0"}},"compareAndSetState"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#79B8FF"}},"0"),t("span",{style:{color:"#E1E4E8"}},", acquires)) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#B392F0"}},"setExclusiveOwnerThread"),t("span",{style:{color:"#E1E4E8"}},"(current);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#F97583"}},"return"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"true"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#6A737D"}},"// 锁重入")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"return"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"false"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"}")])])]),t("pre",{class:"shiki github-light vp-code-light"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"static"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"final"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"class"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"FairSync"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"extends"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"Sync"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"private"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"static"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"final"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"long"),t("span",{style:{color:"#24292E"}}," serialVersionUID "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"-"),t("span",{style:{color:"#005CC5"}},"3000897897090466540L"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"final"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"void"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"lock"),t("span",{style:{color:"#24292E"}},"() {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6F42C1"}},"acquire"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#005CC5"}},"1"),t("span",{style:{color:"#24292E"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    }")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"protected"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"final"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"boolean"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"tryAcquire"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#E36209"}},"acquires"),t("span",{style:{color:"#24292E"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"final"),t("span",{style:{color:"#24292E"}}," Thread current "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," Thread."),t("span",{style:{color:"#6F42C1"}},"currentThread"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," c "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"getState"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (c "),t("span",{style:{color:"#D73A49"}},"=="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"0"),t("span",{style:{color:"#24292E"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#6A737D"}},"// 先检查 AQS 队列中是否有前驱节点, 没有(false)才去竞争")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," ("),t("span",{style:{color:"#D73A49"}},"!"),t("span",{style:{color:"#6F42C1"}},"hasQueuedPredecessors"),t("span",{style:{color:"#24292E"}},"() "),t("span",{style:{color:"#D73A49"}},"&&")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#6F42C1"}},"compareAndSetState"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#005CC5"}},"0"),t("span",{style:{color:"#24292E"}},", acquires)) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#6F42C1"}},"setExclusiveOwnerThread"),t("span",{style:{color:"#24292E"}},"(current);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#D73A49"}},"return"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"true"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6A737D"}},"// 锁重入")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"return"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"false"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"}")])])]),t("button",{class:"collapse"})],-1),Ls=t("div",{style:{"max-height":"300px"},class:"language-java"},[t("button",{title:"Copy Code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki github-dark vp-code-dark"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"public"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"final"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"boolean"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"hasQueuedPredecessors"),t("span",{style:{color:"#E1E4E8"}},"() {    ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    Node t "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," tail;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    Node h "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," head;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    Node s;    ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// 头尾指向一个节点，链表为空，返回false")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"return"),t("span",{style:{color:"#E1E4E8"}}," h "),t("span",{style:{color:"#F97583"}},"!="),t("span",{style:{color:"#E1E4E8"}}," t "),t("span",{style:{color:"#F97583"}},"&&")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#6A737D"}},"// 头尾之间有节点，判断头节点的下一个是不是空")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#6A737D"}},"// 不是空进入最后的判断，第二个节点的线程是否是本线程，不是返回 true，表示当前节点有前驱节点")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        ((s "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," h.next) "),t("span",{style:{color:"#F97583"}},"=="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"null"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"||"),t("span",{style:{color:"#E1E4E8"}}," s.thread "),t("span",{style:{color:"#F97583"}},"!="),t("span",{style:{color:"#E1E4E8"}}," Thread."),t("span",{style:{color:"#B392F0"}},"currentThread"),t("span",{style:{color:"#E1E4E8"}},"());")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"}")])])]),t("pre",{class:"shiki github-light vp-code-light"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"public"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"final"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"boolean"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"hasQueuedPredecessors"),t("span",{style:{color:"#24292E"}},"() {    ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    Node t "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," tail;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    Node h "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," head;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    Node s;    ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// 头尾指向一个节点，链表为空，返回false")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"return"),t("span",{style:{color:"#24292E"}}," h "),t("span",{style:{color:"#D73A49"}},"!="),t("span",{style:{color:"#24292E"}}," t "),t("span",{style:{color:"#D73A49"}},"&&")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6A737D"}},"// 头尾之间有节点，判断头节点的下一个是不是空")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6A737D"}},"// 不是空进入最后的判断，第二个节点的线程是否是本线程，不是返回 true，表示当前节点有前驱节点")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        ((s "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," h.next) "),t("span",{style:{color:"#D73A49"}},"=="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"null"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"||"),t("span",{style:{color:"#24292E"}}," s.thread "),t("span",{style:{color:"#D73A49"}},"!="),t("span",{style:{color:"#24292E"}}," Thread."),t("span",{style:{color:"#6F42C1"}},"currentThread"),t("span",{style:{color:"#24292E"}},"());")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"}")])])]),t("button",{class:"collapse"})],-1),qs=t("hr",null,null,-1),js={id:"可重入",tabindex:"-1"},Os=t("p",null,"可重入是指同一个线程如果首次获得了这把锁，那么它是这把锁的拥有者，因此有权利再次获取这把锁，如果不可重入锁，那么第二次获得锁时，自己也会被锁挡住，直接造成死锁",-1),Ps=t("p",null,[p("源码解析参考："),t("code",null,"nonfairTryAcquire(int acquires)) "),p(" 和 "),t("code",null,"tryRelease(int releases)")],-1),Ws=t("div",{style:{"max-height":"300px"},class:"language-java"},[t("button",{title:"Copy Code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki github-dark vp-code-dark"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"static"),t("span",{style:{color:"#E1E4E8"}}," ReentrantLock lock "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"new"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"ReentrantLock"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"public"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"static"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"void"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"main"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#F97583"}},"String"),t("span",{style:{color:"#E1E4E8"}},"[] args) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#B392F0"}},"method1"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"}")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"public"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"static"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"void"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"method1"),t("span",{style:{color:"#E1E4E8"}},"() {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    lock."),t("span",{style:{color:"#B392F0"}},"lock"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"try"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        System.out."),t("span",{style:{color:"#B392F0"}},"println"),t("span",{style:{color:"#E1E4E8"}},"(Thread."),t("span",{style:{color:"#B392F0"}},"currentThread"),t("span",{style:{color:"#E1E4E8"}},"()."),t("span",{style:{color:"#B392F0"}},"getName"),t("span",{style:{color:"#E1E4E8"}},"() "),t("span",{style:{color:"#F97583"}},"+"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#9ECBFF"}},'" execute method1"'),t("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#B392F0"}},"method2"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    } "),t("span",{style:{color:"#F97583"}},"finally"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        lock."),t("span",{style:{color:"#B392F0"}},"unlock"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"}")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"public"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"static"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"void"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"method2"),t("span",{style:{color:"#E1E4E8"}},"() {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    lock."),t("span",{style:{color:"#B392F0"}},"lock"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"try"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        System.out."),t("span",{style:{color:"#B392F0"}},"println"),t("span",{style:{color:"#E1E4E8"}},"(Thread."),t("span",{style:{color:"#B392F0"}},"currentThread"),t("span",{style:{color:"#E1E4E8"}},"()."),t("span",{style:{color:"#B392F0"}},"getName"),t("span",{style:{color:"#E1E4E8"}},"() "),t("span",{style:{color:"#F97583"}},"+"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#9ECBFF"}},'" execute method2"'),t("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    } "),t("span",{style:{color:"#F97583"}},"finally"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        lock."),t("span",{style:{color:"#B392F0"}},"unlock"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"}")])])]),t("pre",{class:"shiki github-light vp-code-light"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"static"),t("span",{style:{color:"#24292E"}}," ReentrantLock lock "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"new"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"ReentrantLock"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"public"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"static"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"void"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"main"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#D73A49"}},"String"),t("span",{style:{color:"#24292E"}},"[] args) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6F42C1"}},"method1"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"}")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"public"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"static"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"void"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"method1"),t("span",{style:{color:"#24292E"}},"() {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    lock."),t("span",{style:{color:"#6F42C1"}},"lock"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"try"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        System.out."),t("span",{style:{color:"#6F42C1"}},"println"),t("span",{style:{color:"#24292E"}},"(Thread."),t("span",{style:{color:"#6F42C1"}},"currentThread"),t("span",{style:{color:"#24292E"}},"()."),t("span",{style:{color:"#6F42C1"}},"getName"),t("span",{style:{color:"#24292E"}},"() "),t("span",{style:{color:"#D73A49"}},"+"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#032F62"}},'" execute method1"'),t("span",{style:{color:"#24292E"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6F42C1"}},"method2"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    } "),t("span",{style:{color:"#D73A49"}},"finally"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        lock."),t("span",{style:{color:"#6F42C1"}},"unlock"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"}")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"public"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"static"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"void"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"method2"),t("span",{style:{color:"#24292E"}},"() {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    lock."),t("span",{style:{color:"#6F42C1"}},"lock"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"try"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        System.out."),t("span",{style:{color:"#6F42C1"}},"println"),t("span",{style:{color:"#24292E"}},"(Thread."),t("span",{style:{color:"#6F42C1"}},"currentThread"),t("span",{style:{color:"#24292E"}},"()."),t("span",{style:{color:"#6F42C1"}},"getName"),t("span",{style:{color:"#24292E"}},"() "),t("span",{style:{color:"#D73A49"}},"+"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#032F62"}},'" execute method2"'),t("span",{style:{color:"#24292E"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    } "),t("span",{style:{color:"#D73A49"}},"finally"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        lock."),t("span",{style:{color:"#6F42C1"}},"unlock"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"}")])])]),t("button",{class:"collapse"})],-1),Hs=t("p",null,"在 Lock 方法加两把锁会是什么情况呢？",-1),_s=t("ul",null,[t("li",null,"加锁两次解锁两次：正常执行"),t("li",null,[p("加锁两次解锁一次：程序直接卡死，线程不能出来，也就说明"),t("strong",null,"申请几把锁，最后需要解除几把锁")]),t("li",null,"加锁一次解锁两次：运行程序会直接报错")],-1),Qs=t("div",{style:{"max-height":"300px"},class:"language-java"},[t("button",{title:"Copy Code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki github-dark vp-code-dark"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"public"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"void"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"getLock"),t("span",{style:{color:"#E1E4E8"}},"() {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    lock."),t("span",{style:{color:"#B392F0"}},"lock"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    lock."),t("span",{style:{color:"#B392F0"}},"lock"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"try"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        System.out."),t("span",{style:{color:"#B392F0"}},"println"),t("span",{style:{color:"#E1E4E8"}},"(Thread."),t("span",{style:{color:"#B392F0"}},"currentThread"),t("span",{style:{color:"#E1E4E8"}},"()."),t("span",{style:{color:"#B392F0"}},"getName"),t("span",{style:{color:"#E1E4E8"}},"() "),t("span",{style:{color:"#F97583"}},"+"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#9ECBFF"}},'"'),t("span",{style:{color:"#79B8FF"}},"\\t"),t("span",{style:{color:"#9ECBFF"}},' get Lock"'),t("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    } "),t("span",{style:{color:"#F97583"}},"finally"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        lock."),t("span",{style:{color:"#B392F0"}},"unlock"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#6A737D"}},"//lock.unlock();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"}")])])]),t("pre",{class:"shiki github-light vp-code-light"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"public"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"void"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"getLock"),t("span",{style:{color:"#24292E"}},"() {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    lock."),t("span",{style:{color:"#6F42C1"}},"lock"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    lock."),t("span",{style:{color:"#6F42C1"}},"lock"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"try"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        System.out."),t("span",{style:{color:"#6F42C1"}},"println"),t("span",{style:{color:"#24292E"}},"(Thread."),t("span",{style:{color:"#6F42C1"}},"currentThread"),t("span",{style:{color:"#24292E"}},"()."),t("span",{style:{color:"#6F42C1"}},"getName"),t("span",{style:{color:"#24292E"}},"() "),t("span",{style:{color:"#D73A49"}},"+"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#032F62"}},'"'),t("span",{style:{color:"#005CC5"}},"\\t"),t("span",{style:{color:"#032F62"}},' get Lock"'),t("span",{style:{color:"#24292E"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    } "),t("span",{style:{color:"#D73A49"}},"finally"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        lock."),t("span",{style:{color:"#6F42C1"}},"unlock"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6A737D"}},"//lock.unlock();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"}")])])]),t("button",{class:"collapse"})],-1),Gs=t("hr",null,null,-1),zs={id:"可打断",tabindex:"-1"},Us={id:"基本使用-1",tabindex:"-1"},Ms=t("p",null,[t("code",null,"public void lockInterruptibly()"),p("：获得可打断的锁")],-1),Vs=t("ul",null,[t("li",null,"如果没有竞争此方法就会获取 lock 对象锁"),t("li",null,"如果有竞争就进入阻塞队列，可以被其他线程用 interrupt 打断")],-1),Ks=t("p",null,"注意：如果是不可中断模式，那么即使使用了 interrupt 也不会让等待状态中的线程中断",-1),Xs=t("div",{style:{"max-height":"300px"},class:"language-java"},[t("button",{title:"Copy Code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki github-dark vp-code-dark"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"public"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"static"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"void"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"main"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#F97583"}},"String"),t("span",{style:{color:"#E1E4E8"}},"[] args) throws InterruptedException {    ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    ReentrantLock lock "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"new"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"ReentrantLock"),t("span",{style:{color:"#E1E4E8"}},"();    ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    Thread t1 "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"new"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"Thread"),t("span",{style:{color:"#E1E4E8"}},"(() "),t("span",{style:{color:"#F97583"}},"->"),t("span",{style:{color:"#E1E4E8"}}," {        ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"try"),t("span",{style:{color:"#E1E4E8"}}," {            ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            System.out."),t("span",{style:{color:"#B392F0"}},"println"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#9ECBFF"}},'"尝试获取锁"'),t("span",{style:{color:"#E1E4E8"}},");            ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            lock."),t("span",{style:{color:"#B392F0"}},"lockInterruptibly"),t("span",{style:{color:"#E1E4E8"}},"();        ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        } "),t("span",{style:{color:"#F97583"}},"catch"),t("span",{style:{color:"#E1E4E8"}}," (InterruptedException "),t("span",{style:{color:"#FFAB70"}},"e"),t("span",{style:{color:"#E1E4E8"}},") {            ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            System.out."),t("span",{style:{color:"#B392F0"}},"println"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#9ECBFF"}},'"没有获取到锁，被打断，直接返回"'),t("span",{style:{color:"#E1E4E8"}},");            ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"return"),t("span",{style:{color:"#E1E4E8"}},";        ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        }        ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"try"),t("span",{style:{color:"#E1E4E8"}}," {            ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            System.out."),t("span",{style:{color:"#B392F0"}},"println"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#9ECBFF"}},'"获取到锁"'),t("span",{style:{color:"#E1E4E8"}},");        ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        } "),t("span",{style:{color:"#F97583"}},"finally"),t("span",{style:{color:"#E1E4E8"}}," {            ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            lock."),t("span",{style:{color:"#B392F0"}},"unlock"),t("span",{style:{color:"#E1E4E8"}},"();        ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        }    ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    }, "),t("span",{style:{color:"#9ECBFF"}},'"t1"'),t("span",{style:{color:"#E1E4E8"}},");    ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    lock."),t("span",{style:{color:"#B392F0"}},"lock"),t("span",{style:{color:"#E1E4E8"}},"();    ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    t1."),t("span",{style:{color:"#B392F0"}},"start"),t("span",{style:{color:"#E1E4E8"}},"();    ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    Thread."),t("span",{style:{color:"#B392F0"}},"sleep"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#79B8FF"}},"2000"),t("span",{style:{color:"#E1E4E8"}},");    ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    System.out."),t("span",{style:{color:"#B392F0"}},"println"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#9ECBFF"}},'"主线程进行打断锁"'),t("span",{style:{color:"#E1E4E8"}},");    ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    t1."),t("span",{style:{color:"#B392F0"}},"interrupt"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"}")])])]),t("pre",{class:"shiki github-light vp-code-light"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"public"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"static"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"void"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"main"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#D73A49"}},"String"),t("span",{style:{color:"#24292E"}},"[] args) throws InterruptedException {    ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    ReentrantLock lock "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"new"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"ReentrantLock"),t("span",{style:{color:"#24292E"}},"();    ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    Thread t1 "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"new"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"Thread"),t("span",{style:{color:"#24292E"}},"(() "),t("span",{style:{color:"#D73A49"}},"->"),t("span",{style:{color:"#24292E"}}," {        ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"try"),t("span",{style:{color:"#24292E"}}," {            ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            System.out."),t("span",{style:{color:"#6F42C1"}},"println"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#032F62"}},'"尝试获取锁"'),t("span",{style:{color:"#24292E"}},");            ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            lock."),t("span",{style:{color:"#6F42C1"}},"lockInterruptibly"),t("span",{style:{color:"#24292E"}},"();        ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        } "),t("span",{style:{color:"#D73A49"}},"catch"),t("span",{style:{color:"#24292E"}}," (InterruptedException "),t("span",{style:{color:"#E36209"}},"e"),t("span",{style:{color:"#24292E"}},") {            ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            System.out."),t("span",{style:{color:"#6F42C1"}},"println"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#032F62"}},'"没有获取到锁，被打断，直接返回"'),t("span",{style:{color:"#24292E"}},");            ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"return"),t("span",{style:{color:"#24292E"}},";        ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        }        ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"try"),t("span",{style:{color:"#24292E"}}," {            ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            System.out."),t("span",{style:{color:"#6F42C1"}},"println"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#032F62"}},'"获取到锁"'),t("span",{style:{color:"#24292E"}},");        ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        } "),t("span",{style:{color:"#D73A49"}},"finally"),t("span",{style:{color:"#24292E"}}," {            ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            lock."),t("span",{style:{color:"#6F42C1"}},"unlock"),t("span",{style:{color:"#24292E"}},"();        ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        }    ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    }, "),t("span",{style:{color:"#032F62"}},'"t1"'),t("span",{style:{color:"#24292E"}},");    ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    lock."),t("span",{style:{color:"#6F42C1"}},"lock"),t("span",{style:{color:"#24292E"}},"();    ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    t1."),t("span",{style:{color:"#6F42C1"}},"start"),t("span",{style:{color:"#24292E"}},"();    ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    Thread."),t("span",{style:{color:"#6F42C1"}},"sleep"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#005CC5"}},"2000"),t("span",{style:{color:"#24292E"}},");    ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    System.out."),t("span",{style:{color:"#6F42C1"}},"println"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#032F62"}},'"主线程进行打断锁"'),t("span",{style:{color:"#24292E"}},");    ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    t1."),t("span",{style:{color:"#6F42C1"}},"interrupt"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"}")])])]),t("button",{class:"collapse"})],-1),Js=t("hr",null,null,-1),$s={id:"实现原理",tabindex:"-1"},Zs=t("ul",null,[t("li",null,[t("p",null,[p("不可打断模式：即使它被打断，仍会驻留在 AQS 阻塞队列中，一直要"),t("strong",null,"等到获得锁后才能得知自己被打断"),p("了")]),t("div",{style:{"max-height":"300px"},class:"language-java"},[t("button",{title:"Copy Code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki github-dark vp-code-dark"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"public"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"final"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"void"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"acquire"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," arg) {    ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," ("),t("span",{style:{color:"#F97583"}},"!"),t("span",{style:{color:"#B392F0"}},"tryAcquire"),t("span",{style:{color:"#E1E4E8"}},"(arg) "),t("span",{style:{color:"#F97583"}},"&&"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"acquireQueued"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#B392F0"}},"addWaiter"),t("span",{style:{color:"#E1E4E8"}},"(Node.EXCLUSIVE), arg))"),t("span",{style:{color:"#6A737D"}},"//阻塞等待        ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#6A737D"}},"// 如果acquireQueued返回true，打断状态 interrupted = true        ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#B392F0"}},"selfInterrupt"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"}")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"static"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"void"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"selfInterrupt"),t("span",{style:{color:"#E1E4E8"}},"() {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// 知道自己被打断了，需要重新产生一次中断完成中断效果")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    Thread."),t("span",{style:{color:"#B392F0"}},"currentThread"),t("span",{style:{color:"#E1E4E8"}},"()."),t("span",{style:{color:"#B392F0"}},"interrupt"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"}")])])]),t("pre",{class:"shiki github-light vp-code-light"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"public"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"final"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"void"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"acquire"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," arg) {    ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," ("),t("span",{style:{color:"#D73A49"}},"!"),t("span",{style:{color:"#6F42C1"}},"tryAcquire"),t("span",{style:{color:"#24292E"}},"(arg) "),t("span",{style:{color:"#D73A49"}},"&&"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"acquireQueued"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#6F42C1"}},"addWaiter"),t("span",{style:{color:"#24292E"}},"(Node.EXCLUSIVE), arg))"),t("span",{style:{color:"#6A737D"}},"//阻塞等待        ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6A737D"}},"// 如果acquireQueued返回true，打断状态 interrupted = true        ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6F42C1"}},"selfInterrupt"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"}")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"static"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"void"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"selfInterrupt"),t("span",{style:{color:"#24292E"}},"() {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// 知道自己被打断了，需要重新产生一次中断完成中断效果")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    Thread."),t("span",{style:{color:"#6F42C1"}},"currentThread"),t("span",{style:{color:"#24292E"}},"()."),t("span",{style:{color:"#6F42C1"}},"interrupt"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"}")])])]),t("button",{class:"collapse"})]),t("div",{style:{"max-height":"300px"},class:"language-java"},[t("button",{title:"Copy Code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki github-dark vp-code-dark"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"final"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"boolean"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"acquireQueued"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#F97583"}},"final"),t("span",{style:{color:"#E1E4E8"}}," Node node, "),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," arg) {    ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"try"),t("span",{style:{color:"#E1E4E8"}}," {        ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"boolean"),t("span",{style:{color:"#E1E4E8"}}," interrupted "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"false"),t("span",{style:{color:"#E1E4E8"}},";        ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"for"),t("span",{style:{color:"#E1E4E8"}}," (;;) {            ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"final"),t("span",{style:{color:"#E1E4E8"}}," Node p "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," node."),t("span",{style:{color:"#B392F0"}},"predecessor"),t("span",{style:{color:"#E1E4E8"}},"();            ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (p "),t("span",{style:{color:"#F97583"}},"=="),t("span",{style:{color:"#E1E4E8"}}," head "),t("span",{style:{color:"#F97583"}},"&&"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"tryAcquire"),t("span",{style:{color:"#E1E4E8"}},"(arg)) {                ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#B392F0"}},"setHead"),t("span",{style:{color:"#E1E4E8"}},"(node);                ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                p.next "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"null"),t("span",{style:{color:"#E1E4E8"}},"; "),t("span",{style:{color:"#6A737D"}},"// help GC                ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                failed "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"false"),t("span",{style:{color:"#E1E4E8"}},";                ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#6A737D"}},"// 还是需要获得锁后, 才能返回打断状态")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#F97583"}},"return"),t("span",{style:{color:"#E1E4E8"}}," interrupted;            ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            }            ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," ("),t("span",{style:{color:"#B392F0"}},"shouldParkAfterFailedAcquire"),t("span",{style:{color:"#E1E4E8"}},"(p, node) "),t("span",{style:{color:"#F97583"}},"&&"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"parkAndCheckInterrupt"),t("span",{style:{color:"#E1E4E8"}},"()){")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#6A737D"}},"// 条件二中判断当前线程是否被打断，被打断返回true，设置中断标记为 true，【获取锁后返回】")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                interrupted "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"true"),t("span",{style:{color:"#E1E4E8"}},";  ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            }                  ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        } ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    } "),t("span",{style:{color:"#F97583"}},"finally"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (failed)")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#B392F0"}},"cancelAcquire"),t("span",{style:{color:"#E1E4E8"}},"(node);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"}")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"private"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"final"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"boolean"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"parkAndCheckInterrupt"),t("span",{style:{color:"#E1E4E8"}},"() {    ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"     "),t("span",{style:{color:"#6A737D"}},"// 阻塞当前线程，如果打断标记已经是 true, 则 park 会失效")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"     LockSupport."),t("span",{style:{color:"#B392F0"}},"park"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#79B8FF"}},"this"),t("span",{style:{color:"#E1E4E8"}},");    ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"     "),t("span",{style:{color:"#6A737D"}},"// 判断当前线程是否被打断，清除打断标记，被打断返回true")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"     "),t("span",{style:{color:"#F97583"}},"return"),t("span",{style:{color:"#E1E4E8"}}," Thread."),t("span",{style:{color:"#B392F0"}},"interrupted"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}}," }")])])]),t("pre",{class:"shiki github-light vp-code-light"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"final"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"boolean"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"acquireQueued"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#D73A49"}},"final"),t("span",{style:{color:"#24292E"}}," Node node, "),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," arg) {    ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"try"),t("span",{style:{color:"#24292E"}}," {        ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"boolean"),t("span",{style:{color:"#24292E"}}," interrupted "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"false"),t("span",{style:{color:"#24292E"}},";        ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"for"),t("span",{style:{color:"#24292E"}}," (;;) {            ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"final"),t("span",{style:{color:"#24292E"}}," Node p "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," node."),t("span",{style:{color:"#6F42C1"}},"predecessor"),t("span",{style:{color:"#24292E"}},"();            ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (p "),t("span",{style:{color:"#D73A49"}},"=="),t("span",{style:{color:"#24292E"}}," head "),t("span",{style:{color:"#D73A49"}},"&&"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"tryAcquire"),t("span",{style:{color:"#24292E"}},"(arg)) {                ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#6F42C1"}},"setHead"),t("span",{style:{color:"#24292E"}},"(node);                ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                p.next "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"null"),t("span",{style:{color:"#24292E"}},"; "),t("span",{style:{color:"#6A737D"}},"// help GC                ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                failed "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"false"),t("span",{style:{color:"#24292E"}},";                ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#6A737D"}},"// 还是需要获得锁后, 才能返回打断状态")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#D73A49"}},"return"),t("span",{style:{color:"#24292E"}}," interrupted;            ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            }            ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," ("),t("span",{style:{color:"#6F42C1"}},"shouldParkAfterFailedAcquire"),t("span",{style:{color:"#24292E"}},"(p, node) "),t("span",{style:{color:"#D73A49"}},"&&"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"parkAndCheckInterrupt"),t("span",{style:{color:"#24292E"}},"()){")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#6A737D"}},"// 条件二中判断当前线程是否被打断，被打断返回true，设置中断标记为 true，【获取锁后返回】")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                interrupted "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"true"),t("span",{style:{color:"#24292E"}},";  ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            }                  ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        } ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    } "),t("span",{style:{color:"#D73A49"}},"finally"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (failed)")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#6F42C1"}},"cancelAcquire"),t("span",{style:{color:"#24292E"}},"(node);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"}")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"private"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"final"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"boolean"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"parkAndCheckInterrupt"),t("span",{style:{color:"#24292E"}},"() {    ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"     "),t("span",{style:{color:"#6A737D"}},"// 阻塞当前线程，如果打断标记已经是 true, 则 park 会失效")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"     LockSupport."),t("span",{style:{color:"#6F42C1"}},"park"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#005CC5"}},"this"),t("span",{style:{color:"#24292E"}},");    ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"     "),t("span",{style:{color:"#6A737D"}},"// 判断当前线程是否被打断，清除打断标记，被打断返回true")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"     "),t("span",{style:{color:"#D73A49"}},"return"),t("span",{style:{color:"#24292E"}}," Thread."),t("span",{style:{color:"#6F42C1"}},"interrupted"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}}," }")])])]),t("button",{class:"collapse"})])]),t("li",null,[t("p",null,[p("可打断模式："),t("code",null,"AbstractQueuedSynchronizer#acquireInterruptibly"),p("，"),t("strong",null,"被打断后会直接抛出异常")]),t("div",{style:{"max-height":"300px"},class:"language-java"},[t("button",{title:"Copy Code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki github-dark vp-code-dark"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"public"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"void"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"lockInterruptibly"),t("span",{style:{color:"#E1E4E8"}},"() throws InterruptedException {    ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    sync."),t("span",{style:{color:"#B392F0"}},"acquireInterruptibly"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#79B8FF"}},"1"),t("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"}")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"public"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"final"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"void"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"acquireInterruptibly"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," arg) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// 被其他线程打断了直接返回 false")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (Thread."),t("span",{style:{color:"#B392F0"}},"interrupted"),t("span",{style:{color:"#E1E4E8"}},"())")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"\t\t"),t("span",{style:{color:"#F97583"}},"throw"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"new"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"InterruptedException"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," ("),t("span",{style:{color:"#F97583"}},"!"),t("span",{style:{color:"#B392F0"}},"tryAcquire"),t("span",{style:{color:"#E1E4E8"}},"(arg))")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#6A737D"}},"// 没获取到锁，进入这里")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#B392F0"}},"doAcquireInterruptibly"),t("span",{style:{color:"#E1E4E8"}},"(arg);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"}")])])]),t("pre",{class:"shiki github-light vp-code-light"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"public"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"void"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"lockInterruptibly"),t("span",{style:{color:"#24292E"}},"() throws InterruptedException {    ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    sync."),t("span",{style:{color:"#6F42C1"}},"acquireInterruptibly"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#005CC5"}},"1"),t("span",{style:{color:"#24292E"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"}")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"public"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"final"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"void"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"acquireInterruptibly"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," arg) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// 被其他线程打断了直接返回 false")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (Thread."),t("span",{style:{color:"#6F42C1"}},"interrupted"),t("span",{style:{color:"#24292E"}},"())")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"\t\t"),t("span",{style:{color:"#D73A49"}},"throw"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"new"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"InterruptedException"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," ("),t("span",{style:{color:"#D73A49"}},"!"),t("span",{style:{color:"#6F42C1"}},"tryAcquire"),t("span",{style:{color:"#24292E"}},"(arg))")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6A737D"}},"// 没获取到锁，进入这里")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6F42C1"}},"doAcquireInterruptibly"),t("span",{style:{color:"#24292E"}},"(arg);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"}")])])]),t("button",{class:"collapse"})]),t("div",{style:{"max-height":"300px"},class:"language-java"},[t("button",{title:"Copy Code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki github-dark vp-code-dark"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"private"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"void"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"doAcquireInterruptibly"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," arg) throws InterruptedException {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// 返回封装当前线程的节点")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"final"),t("span",{style:{color:"#E1E4E8"}}," Node node "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"addWaiter"),t("span",{style:{color:"#E1E4E8"}},"(Node.EXCLUSIVE);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"boolean"),t("span",{style:{color:"#E1E4E8"}}," failed "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"true"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"try"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"for"),t("span",{style:{color:"#E1E4E8"}}," (;;) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#6A737D"}},"//...")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," ("),t("span",{style:{color:"#B392F0"}},"shouldParkAfterFailedAcquire"),t("span",{style:{color:"#E1E4E8"}},"(p, node) "),t("span",{style:{color:"#F97583"}},"&&"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"parkAndCheckInterrupt"),t("span",{style:{color:"#E1E4E8"}},"())")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#6A737D"}},"// 【在 park 过程中如果被 interrupt 会抛出异常】, 而不会再次进入循环获取锁后才完成打断效果")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#F97583"}},"throw"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"new"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"InterruptedException"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        }    ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    } "),t("span",{style:{color:"#F97583"}},"finally"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#6A737D"}},"// 抛出异常前会进入这里")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (failed)")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#6A737D"}},"// 取消当前线程的节点")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#B392F0"}},"cancelAcquire"),t("span",{style:{color:"#E1E4E8"}},"(node);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"}")])])]),t("pre",{class:"shiki github-light vp-code-light"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"private"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"void"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"doAcquireInterruptibly"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," arg) throws InterruptedException {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// 返回封装当前线程的节点")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"final"),t("span",{style:{color:"#24292E"}}," Node node "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"addWaiter"),t("span",{style:{color:"#24292E"}},"(Node.EXCLUSIVE);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"boolean"),t("span",{style:{color:"#24292E"}}," failed "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"true"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"try"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"for"),t("span",{style:{color:"#24292E"}}," (;;) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#6A737D"}},"//...")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," ("),t("span",{style:{color:"#6F42C1"}},"shouldParkAfterFailedAcquire"),t("span",{style:{color:"#24292E"}},"(p, node) "),t("span",{style:{color:"#D73A49"}},"&&"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"parkAndCheckInterrupt"),t("span",{style:{color:"#24292E"}},"())")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#6A737D"}},"// 【在 park 过程中如果被 interrupt 会抛出异常】, 而不会再次进入循环获取锁后才完成打断效果")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#D73A49"}},"throw"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"new"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"InterruptedException"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        }    ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    } "),t("span",{style:{color:"#D73A49"}},"finally"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6A737D"}},"// 抛出异常前会进入这里")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (failed)")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#6A737D"}},"// 取消当前线程的节点")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#6F42C1"}},"cancelAcquire"),t("span",{style:{color:"#24292E"}},"(node);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"}")])])]),t("button",{class:"collapse"})]),t("div",{style:{"max-height":"300px"},class:"language-java"},[t("button",{title:"Copy Code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki github-dark vp-code-dark"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// 取消节点出队的逻辑")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"private"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"void"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"cancelAcquire"),t("span",{style:{color:"#E1E4E8"}},"(Node node) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// 判空")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (node "),t("span",{style:{color:"#F97583"}},"=="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"null"),t("span",{style:{color:"#E1E4E8"}},")")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"return"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"\t"),t("span",{style:{color:"#6A737D"}},"// 把当前节点封装的 Thread 置为空")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    node.thread "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"null"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"\t"),t("span",{style:{color:"#6A737D"}},"// 获取当前取消的 node 的前驱节点")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    Node pred "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," node.prev;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// 前驱节点也被取消了，循环找到前面最近的没被取消的节点")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"while"),t("span",{style:{color:"#E1E4E8"}}," (pred.waitStatus "),t("span",{style:{color:"#F97583"}},">"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"0"),t("span",{style:{color:"#E1E4E8"}},")")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        node.prev "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," pred "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," pred.prev;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"\t"),t("span",{style:{color:"#6A737D"}},"// 获取前驱节点的后继节点，可能是当前 node，也可能是 waitStatus > 0 的节点")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    Node predNext "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," pred.next;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"\t"),t("span",{style:{color:"#6A737D"}},"// 把当前节点的状态设置为 【取消状态 1】")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    node.waitStatus "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," Node.CANCELLED;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"\t"),t("span",{style:{color:"#6A737D"}},"// 条件成立说明当前节点是尾节点，把当前节点的前驱节点设置为尾节点")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (node "),t("span",{style:{color:"#F97583"}},"=="),t("span",{style:{color:"#E1E4E8"}}," tail "),t("span",{style:{color:"#F97583"}},"&&"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"compareAndSetTail"),t("span",{style:{color:"#E1E4E8"}},"(node, pred)) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#6A737D"}},"// 把前驱节点的后继节点置空，这里直接把所有的取消节点出队")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#B392F0"}},"compareAndSetNext"),t("span",{style:{color:"#E1E4E8"}},"(pred, predNext, "),t("span",{style:{color:"#79B8FF"}},"null"),t("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    } "),t("span",{style:{color:"#F97583"}},"else"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#6A737D"}},"// 说明当前节点不是 tail 节点")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," ws;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#6A737D"}},"// 条件一成立说明当前节点不是 head.next 节点")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (pred "),t("span",{style:{color:"#F97583"}},"!="),t("span",{style:{color:"#E1E4E8"}}," head "),t("span",{style:{color:"#F97583"}},"&&")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#6A737D"}},"// 判断前驱节点的状态是不是 -1，不成立说明前驱状态可能是 0 或者刚被其他线程取消排队了")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            ((ws "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," pred.waitStatus) "),t("span",{style:{color:"#F97583"}},"=="),t("span",{style:{color:"#E1E4E8"}}," Node.SIGNAL "),t("span",{style:{color:"#F97583"}},"||")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"             "),t("span",{style:{color:"#6A737D"}},"// 如果状态不是 -1，设置前驱节点的状态为 -1")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"             (ws "),t("span",{style:{color:"#F97583"}},"<="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"0"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"&&"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"compareAndSetWaitStatus"),t("span",{style:{color:"#E1E4E8"}},"(pred, ws, Node.SIGNAL))) "),t("span",{style:{color:"#F97583"}},"&&")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#6A737D"}},"// 前驱节点的线程不为null")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            pred.thread "),t("span",{style:{color:"#F97583"}},"!="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"null"),t("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            Node next "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," node.next;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#6A737D"}},"// 当前节点的后继节点是正常节点")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (next "),t("span",{style:{color:"#F97583"}},"!="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"null"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"&&"),t("span",{style:{color:"#E1E4E8"}}," next.waitStatus "),t("span",{style:{color:"#F97583"}},"<="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"0"),t("span",{style:{color:"#E1E4E8"}},")")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#6A737D"}},"// 把 前驱节点的后继节点 设置为 当前节点的后继节点，【从队列中删除了当前节点】")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#B392F0"}},"compareAndSetNext"),t("span",{style:{color:"#E1E4E8"}},"(pred, predNext, next);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        } "),t("span",{style:{color:"#F97583"}},"else"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#6A737D"}},"// 当前节点是 head.next 节点，唤醒当前节点的后继节点")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#B392F0"}},"unparkSuccessor"),t("span",{style:{color:"#E1E4E8"}},"(node);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        node.next "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," node; "),t("span",{style:{color:"#6A737D"}},"// help GC")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"}")])])]),t("pre",{class:"shiki github-light vp-code-light"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// 取消节点出队的逻辑")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"private"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"void"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"cancelAcquire"),t("span",{style:{color:"#24292E"}},"(Node node) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// 判空")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (node "),t("span",{style:{color:"#D73A49"}},"=="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"null"),t("span",{style:{color:"#24292E"}},")")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"return"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"\t"),t("span",{style:{color:"#6A737D"}},"// 把当前节点封装的 Thread 置为空")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    node.thread "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"null"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"\t"),t("span",{style:{color:"#6A737D"}},"// 获取当前取消的 node 的前驱节点")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    Node pred "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," node.prev;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// 前驱节点也被取消了，循环找到前面最近的没被取消的节点")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"while"),t("span",{style:{color:"#24292E"}}," (pred.waitStatus "),t("span",{style:{color:"#D73A49"}},">"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"0"),t("span",{style:{color:"#24292E"}},")")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        node.prev "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," pred "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," pred.prev;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"\t"),t("span",{style:{color:"#6A737D"}},"// 获取前驱节点的后继节点，可能是当前 node，也可能是 waitStatus > 0 的节点")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    Node predNext "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," pred.next;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"\t"),t("span",{style:{color:"#6A737D"}},"// 把当前节点的状态设置为 【取消状态 1】")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    node.waitStatus "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," Node.CANCELLED;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"\t"),t("span",{style:{color:"#6A737D"}},"// 条件成立说明当前节点是尾节点，把当前节点的前驱节点设置为尾节点")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (node "),t("span",{style:{color:"#D73A49"}},"=="),t("span",{style:{color:"#24292E"}}," tail "),t("span",{style:{color:"#D73A49"}},"&&"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"compareAndSetTail"),t("span",{style:{color:"#24292E"}},"(node, pred)) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6A737D"}},"// 把前驱节点的后继节点置空，这里直接把所有的取消节点出队")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6F42C1"}},"compareAndSetNext"),t("span",{style:{color:"#24292E"}},"(pred, predNext, "),t("span",{style:{color:"#005CC5"}},"null"),t("span",{style:{color:"#24292E"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    } "),t("span",{style:{color:"#D73A49"}},"else"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6A737D"}},"// 说明当前节点不是 tail 节点")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," ws;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6A737D"}},"// 条件一成立说明当前节点不是 head.next 节点")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (pred "),t("span",{style:{color:"#D73A49"}},"!="),t("span",{style:{color:"#24292E"}}," head "),t("span",{style:{color:"#D73A49"}},"&&")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#6A737D"}},"// 判断前驱节点的状态是不是 -1，不成立说明前驱状态可能是 0 或者刚被其他线程取消排队了")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            ((ws "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," pred.waitStatus) "),t("span",{style:{color:"#D73A49"}},"=="),t("span",{style:{color:"#24292E"}}," Node.SIGNAL "),t("span",{style:{color:"#D73A49"}},"||")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"             "),t("span",{style:{color:"#6A737D"}},"// 如果状态不是 -1，设置前驱节点的状态为 -1")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"             (ws "),t("span",{style:{color:"#D73A49"}},"<="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"0"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"&&"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"compareAndSetWaitStatus"),t("span",{style:{color:"#24292E"}},"(pred, ws, Node.SIGNAL))) "),t("span",{style:{color:"#D73A49"}},"&&")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#6A737D"}},"// 前驱节点的线程不为null")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            pred.thread "),t("span",{style:{color:"#D73A49"}},"!="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"null"),t("span",{style:{color:"#24292E"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            Node next "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," node.next;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#6A737D"}},"// 当前节点的后继节点是正常节点")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (next "),t("span",{style:{color:"#D73A49"}},"!="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"null"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"&&"),t("span",{style:{color:"#24292E"}}," next.waitStatus "),t("span",{style:{color:"#D73A49"}},"<="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"0"),t("span",{style:{color:"#24292E"}},")")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#6A737D"}},"// 把 前驱节点的后继节点 设置为 当前节点的后继节点，【从队列中删除了当前节点】")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#6F42C1"}},"compareAndSetNext"),t("span",{style:{color:"#24292E"}},"(pred, predNext, next);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        } "),t("span",{style:{color:"#D73A49"}},"else"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#6A737D"}},"// 当前节点是 head.next 节点，唤醒当前节点的后继节点")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#6F42C1"}},"unparkSuccessor"),t("span",{style:{color:"#24292E"}},"(node);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        node.next "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," node; "),t("span",{style:{color:"#6A737D"}},"// help GC")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"}")])])]),t("button",{class:"collapse"})])])],-1),Ys=t("hr",null,null,-1),sl={id:"锁超时",tabindex:"-1"},ll={id:"基本使用-2",tabindex:"-1"},ol=t("p",null,[t("code",null,"public boolean tryLock()"),p("：尝试获取锁，获取到返回 true，获取不到直接放弃，不进入阻塞队列")],-1),nl=t("p",null,[t("code",null,"public boolean tryLock(long timeout, TimeUnit unit)"),p("：在给定时间内获取锁，获取不到就退出")],-1),al=t("p",null,"注意：tryLock 期间也可以被打断",-1),el=t("div",{style:{"max-height":"300px"},class:"language-java"},[t("button",{title:"Copy Code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki github-dark vp-code-dark"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"public"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"static"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"void"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"main"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#F97583"}},"String"),t("span",{style:{color:"#E1E4E8"}},"[] args) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    ReentrantLock lock "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"new"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"ReentrantLock"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    Thread t1 "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"new"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"Thread"),t("span",{style:{color:"#E1E4E8"}},"(() "),t("span",{style:{color:"#F97583"}},"->"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"try"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," ("),t("span",{style:{color:"#F97583"}},"!"),t("span",{style:{color:"#E1E4E8"}},"lock."),t("span",{style:{color:"#B392F0"}},"tryLock"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#79B8FF"}},"2"),t("span",{style:{color:"#E1E4E8"}},", TimeUnit.SECONDS)) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                System.out."),t("span",{style:{color:"#B392F0"}},"println"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#9ECBFF"}},'"获取不到锁"'),t("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#F97583"}},"return"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        } "),t("span",{style:{color:"#F97583"}},"catch"),t("span",{style:{color:"#E1E4E8"}}," (InterruptedException "),t("span",{style:{color:"#FFAB70"}},"e"),t("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            System.out."),t("span",{style:{color:"#B392F0"}},"println"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#9ECBFF"}},'"被打断，获取不到锁"'),t("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"return"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"try"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            log."),t("span",{style:{color:"#B392F0"}},"debug"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#9ECBFF"}},'"获取到锁"'),t("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        } "),t("span",{style:{color:"#F97583"}},"finally"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            lock."),t("span",{style:{color:"#B392F0"}},"unlock"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    }, "),t("span",{style:{color:"#9ECBFF"}},'"t1"'),t("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    lock."),t("span",{style:{color:"#B392F0"}},"lock"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    System.out."),t("span",{style:{color:"#B392F0"}},"println"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#9ECBFF"}},'"主线程获取到锁"'),t("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    t1."),t("span",{style:{color:"#B392F0"}},"start"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    Thread."),t("span",{style:{color:"#B392F0"}},"sleep"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#79B8FF"}},"1000"),t("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"try"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        System.out."),t("span",{style:{color:"#B392F0"}},"println"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#9ECBFF"}},'"主线程释放了锁"'),t("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    } "),t("span",{style:{color:"#F97583"}},"finally"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        lock."),t("span",{style:{color:"#B392F0"}},"unlock"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"}")])])]),t("pre",{class:"shiki github-light vp-code-light"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"public"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"static"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"void"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"main"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#D73A49"}},"String"),t("span",{style:{color:"#24292E"}},"[] args) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    ReentrantLock lock "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"new"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"ReentrantLock"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    Thread t1 "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"new"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"Thread"),t("span",{style:{color:"#24292E"}},"(() "),t("span",{style:{color:"#D73A49"}},"->"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"try"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," ("),t("span",{style:{color:"#D73A49"}},"!"),t("span",{style:{color:"#24292E"}},"lock."),t("span",{style:{color:"#6F42C1"}},"tryLock"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#005CC5"}},"2"),t("span",{style:{color:"#24292E"}},", TimeUnit.SECONDS)) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                System.out."),t("span",{style:{color:"#6F42C1"}},"println"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#032F62"}},'"获取不到锁"'),t("span",{style:{color:"#24292E"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#D73A49"}},"return"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        } "),t("span",{style:{color:"#D73A49"}},"catch"),t("span",{style:{color:"#24292E"}}," (InterruptedException "),t("span",{style:{color:"#E36209"}},"e"),t("span",{style:{color:"#24292E"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            System.out."),t("span",{style:{color:"#6F42C1"}},"println"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#032F62"}},'"被打断，获取不到锁"'),t("span",{style:{color:"#24292E"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"return"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"try"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            log."),t("span",{style:{color:"#6F42C1"}},"debug"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#032F62"}},'"获取到锁"'),t("span",{style:{color:"#24292E"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        } "),t("span",{style:{color:"#D73A49"}},"finally"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            lock."),t("span",{style:{color:"#6F42C1"}},"unlock"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    }, "),t("span",{style:{color:"#032F62"}},'"t1"'),t("span",{style:{color:"#24292E"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    lock."),t("span",{style:{color:"#6F42C1"}},"lock"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    System.out."),t("span",{style:{color:"#6F42C1"}},"println"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#032F62"}},'"主线程获取到锁"'),t("span",{style:{color:"#24292E"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    t1."),t("span",{style:{color:"#6F42C1"}},"start"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    Thread."),t("span",{style:{color:"#6F42C1"}},"sleep"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#005CC5"}},"1000"),t("span",{style:{color:"#24292E"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"try"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        System.out."),t("span",{style:{color:"#6F42C1"}},"println"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#032F62"}},'"主线程释放了锁"'),t("span",{style:{color:"#24292E"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    } "),t("span",{style:{color:"#D73A49"}},"finally"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        lock."),t("span",{style:{color:"#6F42C1"}},"unlock"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"}")])])]),t("button",{class:"collapse"})],-1),cl=t("hr",null,null,-1),tl={id:"实现原理-1",tabindex:"-1"},pl=t("ul",null,[t("li",null,[t("p",null,"成员变量：指定超时限制的阈值，小于该值的线程不会被挂起"),t("div",{style:{"max-height":"300px"},class:"language-java"},[t("button",{title:"Copy Code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki github-dark vp-code-dark"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"static"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"final"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"long"),t("span",{style:{color:"#E1E4E8"}}," spinForTimeoutThreshold "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"1000L"),t("span",{style:{color:"#E1E4E8"}},";")])])]),t("pre",{class:"shiki github-light vp-code-light"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"static"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"final"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"long"),t("span",{style:{color:"#24292E"}}," spinForTimeoutThreshold "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"1000L"),t("span",{style:{color:"#24292E"}},";")])])]),t("button",{class:"collapse"})]),t("p",null,"超时时间设置的小于该值，就会被禁止挂起，因为阻塞在唤醒的成本太高，不如选择自旋空转")]),t("li",null,[t("p",null,"tryLock()"),t("div",{style:{"max-height":"300px"},class:"language-java"},[t("button",{title:"Copy Code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki github-dark vp-code-dark"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"public"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"boolean"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"tryLock"),t("span",{style:{color:"#E1E4E8"}},"() {   ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// 只尝试一次")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"return"),t("span",{style:{color:"#E1E4E8"}}," sync."),t("span",{style:{color:"#B392F0"}},"nonfairTryAcquire"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#79B8FF"}},"1"),t("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"}")])])]),t("pre",{class:"shiki github-light vp-code-light"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"public"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"boolean"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"tryLock"),t("span",{style:{color:"#24292E"}},"() {   ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// 只尝试一次")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"return"),t("span",{style:{color:"#24292E"}}," sync."),t("span",{style:{color:"#6F42C1"}},"nonfairTryAcquire"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#005CC5"}},"1"),t("span",{style:{color:"#24292E"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"}")])])]),t("button",{class:"collapse"})])]),t("li",null,[t("p",null,"tryLock(long timeout, TimeUnit unit)"),t("div",{style:{"max-height":"300px"},class:"language-java"},[t("button",{title:"Copy Code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki github-dark vp-code-dark"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"public"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"final"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"boolean"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"tryAcquireNanos"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," arg, "),t("span",{style:{color:"#F97583"}},"long"),t("span",{style:{color:"#E1E4E8"}}," nanosTimeout) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (Thread."),t("span",{style:{color:"#B392F0"}},"interrupted"),t("span",{style:{color:"#E1E4E8"}},"())        ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"throw"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"new"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"InterruptedException"),t("span",{style:{color:"#E1E4E8"}},"();    ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// tryAcquire 尝试一次")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"return"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"tryAcquire"),t("span",{style:{color:"#E1E4E8"}},"(arg) "),t("span",{style:{color:"#F97583"}},"||"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"doAcquireNanos"),t("span",{style:{color:"#E1E4E8"}},"(arg, nanosTimeout);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"}")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"protected"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"final"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"boolean"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"tryAcquire"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," acquires) {    ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"return"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"nonfairTryAcquire"),t("span",{style:{color:"#E1E4E8"}},"(acquires);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"}")])])]),t("pre",{class:"shiki github-light vp-code-light"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"public"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"final"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"boolean"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"tryAcquireNanos"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," arg, "),t("span",{style:{color:"#D73A49"}},"long"),t("span",{style:{color:"#24292E"}}," nanosTimeout) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (Thread."),t("span",{style:{color:"#6F42C1"}},"interrupted"),t("span",{style:{color:"#24292E"}},"())        ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"throw"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"new"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"InterruptedException"),t("span",{style:{color:"#24292E"}},"();    ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// tryAcquire 尝试一次")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"return"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"tryAcquire"),t("span",{style:{color:"#24292E"}},"(arg) "),t("span",{style:{color:"#D73A49"}},"||"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"doAcquireNanos"),t("span",{style:{color:"#24292E"}},"(arg, nanosTimeout);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"}")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"protected"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"final"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"boolean"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"tryAcquire"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," acquires) {    ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"return"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"nonfairTryAcquire"),t("span",{style:{color:"#24292E"}},"(acquires);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"}")])])]),t("button",{class:"collapse"})]),t("div",{style:{"max-height":"300px"},class:"language-java"},[t("button",{title:"Copy Code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki github-dark vp-code-dark"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"private"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"boolean"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"doAcquireNanos"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," arg, "),t("span",{style:{color:"#F97583"}},"long"),t("span",{style:{color:"#E1E4E8"}}," nanosTimeout) {    ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (nanosTimeout "),t("span",{style:{color:"#F97583"}},"<="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"0L"),t("span",{style:{color:"#E1E4E8"}},")")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"return"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"false"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// 获取最后期限的时间戳")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"final"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"long"),t("span",{style:{color:"#E1E4E8"}}," deadline "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," System."),t("span",{style:{color:"#B392F0"}},"nanoTime"),t("span",{style:{color:"#E1E4E8"}},"() "),t("span",{style:{color:"#F97583"}},"+"),t("span",{style:{color:"#E1E4E8"}}," nanosTimeout;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"//...")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"try"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"for"),t("span",{style:{color:"#E1E4E8"}}," (;;) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#6A737D"}},"//...")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#6A737D"}},"// 计算还需等待的时间")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            nanosTimeout "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," deadline "),t("span",{style:{color:"#F97583"}},"-"),t("span",{style:{color:"#E1E4E8"}}," System."),t("span",{style:{color:"#B392F0"}},"nanoTime"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (nanosTimeout "),t("span",{style:{color:"#F97583"}},"<="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"0L"),t("span",{style:{color:"#E1E4E8"}},")\t"),t("span",{style:{color:"#6A737D"}},"//时间已到     ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#F97583"}},"return"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"false"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," ("),t("span",{style:{color:"#B392F0"}},"shouldParkAfterFailedAcquire"),t("span",{style:{color:"#E1E4E8"}},"(p, node) "),t("span",{style:{color:"#F97583"}},"&&")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#6A737D"}},"// 如果 nanosTimeout 大于该值，才有阻塞的意义，否则直接自旋会好点")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                nanosTimeout "),t("span",{style:{color:"#F97583"}},">"),t("span",{style:{color:"#E1E4E8"}}," spinForTimeoutThreshold)")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                LockSupport."),t("span",{style:{color:"#B392F0"}},"parkNanos"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#79B8FF"}},"this"),t("span",{style:{color:"#E1E4E8"}},", nanosTimeout);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#6A737D"}},"// 【被打断会报异常】")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (Thread."),t("span",{style:{color:"#B392F0"}},"interrupted"),t("span",{style:{color:"#E1E4E8"}},"())")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#F97583"}},"throw"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"new"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"InterruptedException"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        }    ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"}")])])]),t("pre",{class:"shiki github-light vp-code-light"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"private"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"boolean"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"doAcquireNanos"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," arg, "),t("span",{style:{color:"#D73A49"}},"long"),t("span",{style:{color:"#24292E"}}," nanosTimeout) {    ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (nanosTimeout "),t("span",{style:{color:"#D73A49"}},"<="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"0L"),t("span",{style:{color:"#24292E"}},")")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"return"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"false"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// 获取最后期限的时间戳")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"final"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"long"),t("span",{style:{color:"#24292E"}}," deadline "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," System."),t("span",{style:{color:"#6F42C1"}},"nanoTime"),t("span",{style:{color:"#24292E"}},"() "),t("span",{style:{color:"#D73A49"}},"+"),t("span",{style:{color:"#24292E"}}," nanosTimeout;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"//...")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"try"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"for"),t("span",{style:{color:"#24292E"}}," (;;) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#6A737D"}},"//...")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#6A737D"}},"// 计算还需等待的时间")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            nanosTimeout "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," deadline "),t("span",{style:{color:"#D73A49"}},"-"),t("span",{style:{color:"#24292E"}}," System."),t("span",{style:{color:"#6F42C1"}},"nanoTime"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (nanosTimeout "),t("span",{style:{color:"#D73A49"}},"<="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"0L"),t("span",{style:{color:"#24292E"}},")\t"),t("span",{style:{color:"#6A737D"}},"//时间已到     ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#D73A49"}},"return"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"false"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," ("),t("span",{style:{color:"#6F42C1"}},"shouldParkAfterFailedAcquire"),t("span",{style:{color:"#24292E"}},"(p, node) "),t("span",{style:{color:"#D73A49"}},"&&")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#6A737D"}},"// 如果 nanosTimeout 大于该值，才有阻塞的意义，否则直接自旋会好点")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                nanosTimeout "),t("span",{style:{color:"#D73A49"}},">"),t("span",{style:{color:"#24292E"}}," spinForTimeoutThreshold)")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                LockSupport."),t("span",{style:{color:"#6F42C1"}},"parkNanos"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#005CC5"}},"this"),t("span",{style:{color:"#24292E"}},", nanosTimeout);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#6A737D"}},"// 【被打断会报异常】")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (Thread."),t("span",{style:{color:"#6F42C1"}},"interrupted"),t("span",{style:{color:"#24292E"}},"())")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#D73A49"}},"throw"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"new"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"InterruptedException"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        }    ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"}")])])]),t("button",{class:"collapse"})])])],-1),rl=t("hr",null,null,-1),El={id:"哲学家就餐",tabindex:"-1"},yl=t("div",{style:{"max-height":"300px"},class:"language-java"},[t("button",{title:"Copy Code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki github-dark vp-code-dark"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"public"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"static"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"void"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"main"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#F97583"}},"String"),t("span",{style:{color:"#E1E4E8"}},"[] args) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    Chopstick c1 "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"new"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"Chopstick"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#9ECBFF"}},'"1"'),t("span",{style:{color:"#E1E4E8"}},");"),t("span",{style:{color:"#6A737D"}},"//...")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    Chopstick c5 "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"new"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"Chopstick"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#9ECBFF"}},'"5"'),t("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"new"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"Philosopher"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#9ECBFF"}},'"苏格拉底"'),t("span",{style:{color:"#E1E4E8"}},", c1, c2)."),t("span",{style:{color:"#B392F0"}},"start"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"new"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"Philosopher"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#9ECBFF"}},'"柏拉图"'),t("span",{style:{color:"#E1E4E8"}},", c2, c3)."),t("span",{style:{color:"#B392F0"}},"start"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"new"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"Philosopher"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#9ECBFF"}},'"亚里士多德"'),t("span",{style:{color:"#E1E4E8"}},", c3, c4)."),t("span",{style:{color:"#B392F0"}},"start"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"new"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"Philosopher"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#9ECBFF"}},'"赫拉克利特"'),t("span",{style:{color:"#E1E4E8"}},", c4, c5)."),t("span",{style:{color:"#B392F0"}},"start"),t("span",{style:{color:"#E1E4E8"}},"();    ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"new"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"Philosopher"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#9ECBFF"}},'"阿基米德"'),t("span",{style:{color:"#E1E4E8"}},", c5, c1)."),t("span",{style:{color:"#B392F0"}},"start"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"}")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"class"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"Philosopher"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"extends"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"Thread"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    Chopstick left;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    Chopstick right;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"public"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"void"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"run"),t("span",{style:{color:"#E1E4E8"}},"() {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"while"),t("span",{style:{color:"#E1E4E8"}}," ("),t("span",{style:{color:"#79B8FF"}},"true"),t("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#6A737D"}},"// 尝试获得左手筷子")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (left."),t("span",{style:{color:"#B392F0"}},"tryLock"),t("span",{style:{color:"#E1E4E8"}},"()) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#F97583"}},"try"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                    "),t("span",{style:{color:"#6A737D"}},"// 尝试获得右手筷子")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                    "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (right."),t("span",{style:{color:"#B392F0"}},"tryLock"),t("span",{style:{color:"#E1E4E8"}},"()) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                        "),t("span",{style:{color:"#F97583"}},"try"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                            System.out."),t("span",{style:{color:"#B392F0"}},"println"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#9ECBFF"}},'"eating..."'),t("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                            Thread."),t("span",{style:{color:"#B392F0"}},"sleep"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#79B8FF"}},"1000"),t("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                        } "),t("span",{style:{color:"#F97583"}},"finally"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                            right."),t("span",{style:{color:"#B392F0"}},"unlock"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                } "),t("span",{style:{color:"#F97583"}},"finally"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                    left."),t("span",{style:{color:"#B392F0"}},"unlock"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"}")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"class"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"Chopstick"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"extends"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"ReentrantLock"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    String name;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"public"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"Chopstick"),t("span",{style:{color:"#E1E4E8"}},"(String "),t("span",{style:{color:"#FFAB70"}},"name"),t("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#79B8FF"}},"this"),t("span",{style:{color:"#E1E4E8"}},".name "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," name;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    @"),t("span",{style:{color:"#F97583"}},"Override")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"public"),t("span",{style:{color:"#E1E4E8"}}," String "),t("span",{style:{color:"#B392F0"}},"toString"),t("span",{style:{color:"#E1E4E8"}},"() {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"return"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#9ECBFF"}},'"筷子{"'),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"+"),t("span",{style:{color:"#E1E4E8"}}," name "),t("span",{style:{color:"#F97583"}},"+"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#9ECBFF"}},"'}'"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"}")])])]),t("pre",{class:"shiki github-light vp-code-light"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"public"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"static"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"void"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"main"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#D73A49"}},"String"),t("span",{style:{color:"#24292E"}},"[] args) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    Chopstick c1 "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"new"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"Chopstick"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#032F62"}},'"1"'),t("span",{style:{color:"#24292E"}},");"),t("span",{style:{color:"#6A737D"}},"//...")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    Chopstick c5 "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"new"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"Chopstick"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#032F62"}},'"5"'),t("span",{style:{color:"#24292E"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"new"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"Philosopher"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#032F62"}},'"苏格拉底"'),t("span",{style:{color:"#24292E"}},", c1, c2)."),t("span",{style:{color:"#6F42C1"}},"start"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"new"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"Philosopher"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#032F62"}},'"柏拉图"'),t("span",{style:{color:"#24292E"}},", c2, c3)."),t("span",{style:{color:"#6F42C1"}},"start"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"new"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"Philosopher"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#032F62"}},'"亚里士多德"'),t("span",{style:{color:"#24292E"}},", c3, c4)."),t("span",{style:{color:"#6F42C1"}},"start"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"new"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"Philosopher"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#032F62"}},'"赫拉克利特"'),t("span",{style:{color:"#24292E"}},", c4, c5)."),t("span",{style:{color:"#6F42C1"}},"start"),t("span",{style:{color:"#24292E"}},"();    ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"new"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"Philosopher"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#032F62"}},'"阿基米德"'),t("span",{style:{color:"#24292E"}},", c5, c1)."),t("span",{style:{color:"#6F42C1"}},"start"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"}")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"class"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"Philosopher"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"extends"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"Thread"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    Chopstick left;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    Chopstick right;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"public"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"void"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"run"),t("span",{style:{color:"#24292E"}},"() {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"while"),t("span",{style:{color:"#24292E"}}," ("),t("span",{style:{color:"#005CC5"}},"true"),t("span",{style:{color:"#24292E"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#6A737D"}},"// 尝试获得左手筷子")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (left."),t("span",{style:{color:"#6F42C1"}},"tryLock"),t("span",{style:{color:"#24292E"}},"()) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#D73A49"}},"try"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                    "),t("span",{style:{color:"#6A737D"}},"// 尝试获得右手筷子")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                    "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (right."),t("span",{style:{color:"#6F42C1"}},"tryLock"),t("span",{style:{color:"#24292E"}},"()) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                        "),t("span",{style:{color:"#D73A49"}},"try"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                            System.out."),t("span",{style:{color:"#6F42C1"}},"println"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#032F62"}},'"eating..."'),t("span",{style:{color:"#24292E"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                            Thread."),t("span",{style:{color:"#6F42C1"}},"sleep"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#005CC5"}},"1000"),t("span",{style:{color:"#24292E"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                        } "),t("span",{style:{color:"#D73A49"}},"finally"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                            right."),t("span",{style:{color:"#6F42C1"}},"unlock"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                } "),t("span",{style:{color:"#D73A49"}},"finally"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                    left."),t("span",{style:{color:"#6F42C1"}},"unlock"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"}")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"class"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"Chopstick"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"extends"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"ReentrantLock"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    String name;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"public"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"Chopstick"),t("span",{style:{color:"#24292E"}},"(String "),t("span",{style:{color:"#E36209"}},"name"),t("span",{style:{color:"#24292E"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#005CC5"}},"this"),t("span",{style:{color:"#24292E"}},".name "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," name;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    @"),t("span",{style:{color:"#D73A49"}},"Override")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"public"),t("span",{style:{color:"#24292E"}}," String "),t("span",{style:{color:"#6F42C1"}},"toString"),t("span",{style:{color:"#24292E"}},"() {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"return"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#032F62"}},'"筷子{"'),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"+"),t("span",{style:{color:"#24292E"}}," name "),t("span",{style:{color:"#D73A49"}},"+"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#032F62"}},"'}'"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"}")])])]),t("button",{class:"collapse"})],-1),il=t("hr",null,null,-1),Fl={id:"条件变量",tabindex:"-1"},dl={id:"基本使用-3",tabindex:"-1"},ul=t("p",null,"synchronized 的条件变量，是当条件不满足时进入 WaitSet 等待；ReentrantLock 的条件变量比 synchronized 强大之处在于支持多个条件变量",-1),Al=t("p",null,[p("ReentrantLock 类获取 Condition 对象："),t("code",null,"public Condition newCondition()")],-1),Dl=t("p",null,"Condition 类 API：",-1),hl=t("ul",null,[t("li",null,[t("code",null,"void await()"),p("：当前线程从运行状态进入等待状态，释放锁")]),t("li",null,[t("code",null,"void signal()"),p("：唤醒一个在 Condition 上等待的线程，但是必须获得与该 Condition 相关的锁")])],-1),Cl=t("p",null,"使用流程：",-1),gl=t("ul",null,[t("li",null,[t("p",null,[t("strong",null,"await / signal 前需要获得锁")])]),t("li",null,[t("p",null,"await 执行后，会释放锁进入 ConditionObject 等待")]),t("li",null,[t("p",null,"await 的线程被唤醒去重新竞争 lock 锁")]),t("li",null,[t("p",null,[t("strong",null,"线程在条件队列被打断会抛出中断异常")])]),t("li",null,[t("p",null,"竞争 lock 锁成功后，从 await 后继续执行")])],-1),kl=t("div",{style:{"max-height":"300px"},class:"language-java"},[t("button",{title:"Copy Code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki github-dark vp-code-dark"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"public"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"static"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"void"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"main"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#F97583"}},"String"),t("span",{style:{color:"#E1E4E8"}},"[] args) throws InterruptedException {    ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    ReentrantLock lock "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"new"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"ReentrantLock"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"//创建一个新的条件变量")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    Condition condition1 "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," lock."),t("span",{style:{color:"#B392F0"}},"newCondition"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    Condition condition2 "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," lock."),t("span",{style:{color:"#B392F0"}},"newCondition"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"new"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"Thread"),t("span",{style:{color:"#E1E4E8"}},"(() "),t("span",{style:{color:"#F97583"}},"->"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"try"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            lock."),t("span",{style:{color:"#B392F0"}},"lock"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            System.out."),t("span",{style:{color:"#B392F0"}},"println"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#9ECBFF"}},'"进入等待"'),t("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#6A737D"}},"//进入休息室等待")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            condition1."),t("span",{style:{color:"#B392F0"}},"await"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            System.out."),t("span",{style:{color:"#B392F0"}},"println"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#9ECBFF"}},'"被唤醒了"'),t("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        } "),t("span",{style:{color:"#F97583"}},"catch"),t("span",{style:{color:"#E1E4E8"}}," (InterruptedException "),t("span",{style:{color:"#FFAB70"}},"e"),t("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            e."),t("span",{style:{color:"#B392F0"}},"printStackTrace"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        } "),t("span",{style:{color:"#F97583"}},"finally"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            lock."),t("span",{style:{color:"#B392F0"}},"unlock"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        }    ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    })."),t("span",{style:{color:"#B392F0"}},"start"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    Thread."),t("span",{style:{color:"#B392F0"}},"sleep"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#79B8FF"}},"1000"),t("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"//叫醒")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"new"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"Thread"),t("span",{style:{color:"#E1E4E8"}},"(() "),t("span",{style:{color:"#F97583"}},"->"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"try"),t("span",{style:{color:"#E1E4E8"}}," {            ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            lock."),t("span",{style:{color:"#B392F0"}},"lock"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#6A737D"}},"//唤醒")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            condition2."),t("span",{style:{color:"#B392F0"}},"signal"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        } "),t("span",{style:{color:"#F97583"}},"finally"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            lock."),t("span",{style:{color:"#B392F0"}},"unlock"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    })."),t("span",{style:{color:"#B392F0"}},"start"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"}")])])]),t("pre",{class:"shiki github-light vp-code-light"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"public"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"static"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"void"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"main"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#D73A49"}},"String"),t("span",{style:{color:"#24292E"}},"[] args) throws InterruptedException {    ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    ReentrantLock lock "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"new"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"ReentrantLock"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"//创建一个新的条件变量")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    Condition condition1 "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," lock."),t("span",{style:{color:"#6F42C1"}},"newCondition"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    Condition condition2 "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," lock."),t("span",{style:{color:"#6F42C1"}},"newCondition"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"new"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"Thread"),t("span",{style:{color:"#24292E"}},"(() "),t("span",{style:{color:"#D73A49"}},"->"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"try"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            lock."),t("span",{style:{color:"#6F42C1"}},"lock"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            System.out."),t("span",{style:{color:"#6F42C1"}},"println"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#032F62"}},'"进入等待"'),t("span",{style:{color:"#24292E"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#6A737D"}},"//进入休息室等待")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            condition1."),t("span",{style:{color:"#6F42C1"}},"await"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            System.out."),t("span",{style:{color:"#6F42C1"}},"println"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#032F62"}},'"被唤醒了"'),t("span",{style:{color:"#24292E"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        } "),t("span",{style:{color:"#D73A49"}},"catch"),t("span",{style:{color:"#24292E"}}," (InterruptedException "),t("span",{style:{color:"#E36209"}},"e"),t("span",{style:{color:"#24292E"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            e."),t("span",{style:{color:"#6F42C1"}},"printStackTrace"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        } "),t("span",{style:{color:"#D73A49"}},"finally"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            lock."),t("span",{style:{color:"#6F42C1"}},"unlock"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        }    ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    })."),t("span",{style:{color:"#6F42C1"}},"start"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    Thread."),t("span",{style:{color:"#6F42C1"}},"sleep"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#005CC5"}},"1000"),t("span",{style:{color:"#24292E"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"//叫醒")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"new"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"Thread"),t("span",{style:{color:"#24292E"}},"(() "),t("span",{style:{color:"#D73A49"}},"->"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"try"),t("span",{style:{color:"#24292E"}}," {            ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            lock."),t("span",{style:{color:"#6F42C1"}},"lock"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#6A737D"}},"//唤醒")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            condition2."),t("span",{style:{color:"#6F42C1"}},"signal"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        } "),t("span",{style:{color:"#D73A49"}},"finally"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            lock."),t("span",{style:{color:"#6F42C1"}},"unlock"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    })."),t("span",{style:{color:"#6F42C1"}},"start"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"}")])])]),t("button",{class:"collapse"})],-1),Bl=t("hr",null,null,-1),fl={id:"实现原理-2",tabindex:"-1"},bl={id:"await",tabindex:"-1"},vl=t("p",null,[p("总体流程是将 await 线程包装成 node 节点放入 ConditionObject 的条件队列，如果被唤醒就将 node 转移到 AQS 的执行阻塞队列，等待获取锁，"),t("strong",null,"每个 Condition 对象都包含一个等待队列")],-1),Sl=t("ul",null,[t("li",null,[t("p",null,[p("开始 Thread-0 持有锁，调用 await，线程进入 ConditionObject 等待，直到被唤醒或打断，调用 await 方法的线程都是持锁状态的，所以说逻辑里"),t("strong",null,"不存在并发")]),t("div",{style:{"max-height":"300px"},class:"language-java"},[t("button",{title:"Copy Code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki github-dark vp-code-dark"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"public"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"final"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"void"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"await"),t("span",{style:{color:"#E1E4E8"}},"() throws InterruptedException {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"     "),t("span",{style:{color:"#6A737D"}},"// 判断当前线程是否是中断状态，是就直接给个中断异常")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (Thread."),t("span",{style:{color:"#B392F0"}},"interrupted"),t("span",{style:{color:"#E1E4E8"}},"())")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"throw"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"new"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"InterruptedException"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// 将调用 await 的线程包装成 Node，添加到条件队列并返回")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    Node node "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"addConditionWaiter"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// 完全释放节点持有的锁，因为其他线程唤醒当前线程的前提是【持有锁】")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," savedState "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"fullyRelease"),t("span",{style:{color:"#E1E4E8"}},"(node);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// 设置打断模式为没有被打断，状态码为 0")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," interruptMode "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"0"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// 如果该节点还没有转移至 AQS 阻塞队列, park 阻塞，等待进入阻塞队列")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"while"),t("span",{style:{color:"#E1E4E8"}}," ("),t("span",{style:{color:"#F97583"}},"!"),t("span",{style:{color:"#B392F0"}},"isOnSyncQueue"),t("span",{style:{color:"#E1E4E8"}},"(node)) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        LockSupport."),t("span",{style:{color:"#B392F0"}},"park"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#79B8FF"}},"this"),t("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#6A737D"}},"// 如果被打断，退出等待队列，对应的 node 【也会被迁移到阻塞队列】尾部，状态设置为 0")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," ((interruptMode "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"checkInterruptWhileWaiting"),t("span",{style:{color:"#E1E4E8"}},"(node)) "),t("span",{style:{color:"#F97583"}},"!="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"0"),t("span",{style:{color:"#E1E4E8"}},")")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"break"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// 逻辑到这说明当前线程退出等待队列，进入【阻塞队列】")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// 尝试枪锁，释放了多少锁就【重新获取多少锁】，获取锁成功判断打断模式")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," ("),t("span",{style:{color:"#B392F0"}},"acquireQueued"),t("span",{style:{color:"#E1E4E8"}},"(node, savedState) "),t("span",{style:{color:"#F97583"}},"&&"),t("span",{style:{color:"#E1E4E8"}}," interruptMode "),t("span",{style:{color:"#F97583"}},"!="),t("span",{style:{color:"#E1E4E8"}}," THROW_IE)")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        interruptMode "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," REINTERRUPT;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// node 在条件队列时 如果被外部线程中断唤醒，会加入到阻塞队列，但是并未设 nextWaiter = null")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (node.nextWaiter "),t("span",{style:{color:"#F97583"}},"!="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"null"),t("span",{style:{color:"#E1E4E8"}},")")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#6A737D"}},"// 清理条件队列内所有已取消的 Node")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#B392F0"}},"unlinkCancelledWaiters"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// 条件成立说明挂起期间发生过中断")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (interruptMode "),t("span",{style:{color:"#F97583"}},"!="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"0"),t("span",{style:{color:"#E1E4E8"}},")")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#6A737D"}},"// 应用打断模式")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#B392F0"}},"reportInterruptAfterWait"),t("span",{style:{color:"#E1E4E8"}},"(interruptMode);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"}")])])]),t("pre",{class:"shiki github-light vp-code-light"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"public"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"final"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"void"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"await"),t("span",{style:{color:"#24292E"}},"() throws InterruptedException {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"     "),t("span",{style:{color:"#6A737D"}},"// 判断当前线程是否是中断状态，是就直接给个中断异常")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (Thread."),t("span",{style:{color:"#6F42C1"}},"interrupted"),t("span",{style:{color:"#24292E"}},"())")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"throw"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"new"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"InterruptedException"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// 将调用 await 的线程包装成 Node，添加到条件队列并返回")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    Node node "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"addConditionWaiter"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// 完全释放节点持有的锁，因为其他线程唤醒当前线程的前提是【持有锁】")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," savedState "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"fullyRelease"),t("span",{style:{color:"#24292E"}},"(node);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// 设置打断模式为没有被打断，状态码为 0")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," interruptMode "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"0"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// 如果该节点还没有转移至 AQS 阻塞队列, park 阻塞，等待进入阻塞队列")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"while"),t("span",{style:{color:"#24292E"}}," ("),t("span",{style:{color:"#D73A49"}},"!"),t("span",{style:{color:"#6F42C1"}},"isOnSyncQueue"),t("span",{style:{color:"#24292E"}},"(node)) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        LockSupport."),t("span",{style:{color:"#6F42C1"}},"park"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#005CC5"}},"this"),t("span",{style:{color:"#24292E"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6A737D"}},"// 如果被打断，退出等待队列，对应的 node 【也会被迁移到阻塞队列】尾部，状态设置为 0")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," ((interruptMode "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"checkInterruptWhileWaiting"),t("span",{style:{color:"#24292E"}},"(node)) "),t("span",{style:{color:"#D73A49"}},"!="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"0"),t("span",{style:{color:"#24292E"}},")")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"break"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// 逻辑到这说明当前线程退出等待队列，进入【阻塞队列】")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// 尝试枪锁，释放了多少锁就【重新获取多少锁】，获取锁成功判断打断模式")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," ("),t("span",{style:{color:"#6F42C1"}},"acquireQueued"),t("span",{style:{color:"#24292E"}},"(node, savedState) "),t("span",{style:{color:"#D73A49"}},"&&"),t("span",{style:{color:"#24292E"}}," interruptMode "),t("span",{style:{color:"#D73A49"}},"!="),t("span",{style:{color:"#24292E"}}," THROW_IE)")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        interruptMode "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," REINTERRUPT;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// node 在条件队列时 如果被外部线程中断唤醒，会加入到阻塞队列，但是并未设 nextWaiter = null")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (node.nextWaiter "),t("span",{style:{color:"#D73A49"}},"!="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"null"),t("span",{style:{color:"#24292E"}},")")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6A737D"}},"// 清理条件队列内所有已取消的 Node")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6F42C1"}},"unlinkCancelledWaiters"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// 条件成立说明挂起期间发生过中断")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (interruptMode "),t("span",{style:{color:"#D73A49"}},"!="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"0"),t("span",{style:{color:"#24292E"}},")")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6A737D"}},"// 应用打断模式")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6F42C1"}},"reportInterruptAfterWait"),t("span",{style:{color:"#24292E"}},"(interruptMode);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"}")])])]),t("button",{class:"collapse"})]),t("div",{style:{"max-height":"300px"},class:"language-java"},[t("button",{title:"Copy Code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki github-dark vp-code-dark"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// 打断模式 - 在退出等待时重新设置打断状态")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"private"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"static"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"final"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," REINTERRUPT "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"1"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// 打断模式 - 在退出等待时抛出异常")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"private"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"static"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"final"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," THROW_IE "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"-"),t("span",{style:{color:"#79B8FF"}},"1"),t("span",{style:{color:"#E1E4E8"}},";")])])]),t("pre",{class:"shiki github-light vp-code-light"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// 打断模式 - 在退出等待时重新设置打断状态")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"private"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"static"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"final"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," REINTERRUPT "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"1"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// 打断模式 - 在退出等待时抛出异常")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"private"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"static"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"final"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," THROW_IE "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"-"),t("span",{style:{color:"#005CC5"}},"1"),t("span",{style:{color:"#24292E"}},";")])])]),t("button",{class:"collapse"})]),t("img",{src:"https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230719164232726.png",alt:"image-20230719164232726",style:{zoom:"80%"}})]),t("li",null,[t("p",null,[t("strong",null,"创建新的 Node 状态为 -2（Node.CONDITION）"),p("，关联 Thread-0，加入等待队列尾部")]),t("div",{style:{"max-height":"300px"},class:"language-java"},[t("button",{title:"Copy Code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki github-dark vp-code-dark"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"private"),t("span",{style:{color:"#E1E4E8"}}," Node "),t("span",{style:{color:"#B392F0"}},"addConditionWaiter"),t("span",{style:{color:"#E1E4E8"}},"() {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// 获取当前条件队列的尾节点的引用，保存到局部变量 t 中")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    Node t "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," lastWaiter;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// 当前队列中不是空，并且节点的状态不是 CONDITION（-2），说明当前节点发生了中断")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (t "),t("span",{style:{color:"#F97583"}},"!="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"null"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"&&"),t("span",{style:{color:"#E1E4E8"}}," t.waitStatus "),t("span",{style:{color:"#F97583"}},"!="),t("span",{style:{color:"#E1E4E8"}}," Node.CONDITION) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#6A737D"}},"// 清理条件队列内所有已取消的 Node")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#B392F0"}},"unlinkCancelledWaiters"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#6A737D"}},"// 清理完成重新获取 尾节点 的引用")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        t "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," lastWaiter;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// 创建一个关联当前线程的新 node, 设置状态为 CONDITION(-2)，添加至队列尾部")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    Node node "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"new"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"Node"),t("span",{style:{color:"#E1E4E8"}},"(Thread."),t("span",{style:{color:"#B392F0"}},"currentThread"),t("span",{style:{color:"#E1E4E8"}},"(), Node.CONDITION);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (t "),t("span",{style:{color:"#F97583"}},"=="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"null"),t("span",{style:{color:"#E1E4E8"}},")")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        firstWaiter "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," node;\t\t"),t("span",{style:{color:"#6A737D"}},"// 空队列直接放在队首【不用CAS因为执行线程是持锁线程，并发安全】")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"else")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        t.nextWaiter "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," node;\t"),t("span",{style:{color:"#6A737D"}},"// 非空队列队尾追加")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    lastWaiter "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," node;\t\t\t"),t("span",{style:{color:"#6A737D"}},"// 更新队尾的引用")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"return"),t("span",{style:{color:"#E1E4E8"}}," node;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"}")])])]),t("pre",{class:"shiki github-light vp-code-light"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"private"),t("span",{style:{color:"#24292E"}}," Node "),t("span",{style:{color:"#6F42C1"}},"addConditionWaiter"),t("span",{style:{color:"#24292E"}},"() {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// 获取当前条件队列的尾节点的引用，保存到局部变量 t 中")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    Node t "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," lastWaiter;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// 当前队列中不是空，并且节点的状态不是 CONDITION（-2），说明当前节点发生了中断")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (t "),t("span",{style:{color:"#D73A49"}},"!="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"null"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"&&"),t("span",{style:{color:"#24292E"}}," t.waitStatus "),t("span",{style:{color:"#D73A49"}},"!="),t("span",{style:{color:"#24292E"}}," Node.CONDITION) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6A737D"}},"// 清理条件队列内所有已取消的 Node")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6F42C1"}},"unlinkCancelledWaiters"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6A737D"}},"// 清理完成重新获取 尾节点 的引用")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        t "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," lastWaiter;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// 创建一个关联当前线程的新 node, 设置状态为 CONDITION(-2)，添加至队列尾部")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    Node node "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"new"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"Node"),t("span",{style:{color:"#24292E"}},"(Thread."),t("span",{style:{color:"#6F42C1"}},"currentThread"),t("span",{style:{color:"#24292E"}},"(), Node.CONDITION);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (t "),t("span",{style:{color:"#D73A49"}},"=="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"null"),t("span",{style:{color:"#24292E"}},")")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        firstWaiter "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," node;\t\t"),t("span",{style:{color:"#6A737D"}},"// 空队列直接放在队首【不用CAS因为执行线程是持锁线程，并发安全】")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"else")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        t.nextWaiter "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," node;\t"),t("span",{style:{color:"#6A737D"}},"// 非空队列队尾追加")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    lastWaiter "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," node;\t\t\t"),t("span",{style:{color:"#6A737D"}},"// 更新队尾的引用")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"return"),t("span",{style:{color:"#24292E"}}," node;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"}")])])]),t("button",{class:"collapse"})]),t("div",{style:{"max-height":"300px"},class:"language-java"},[t("button",{title:"Copy Code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki github-dark vp-code-dark"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// 清理条件队列内所有已取消（不是CONDITION）的 node，【链表删除的逻辑】")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"private"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"void"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"unlinkCancelledWaiters"),t("span",{style:{color:"#E1E4E8"}},"() {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// 从头节点开始遍历【FIFO】")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    Node t "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," firstWaiter;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// 指向正常的 CONDITION 节点")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    Node trail "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"null"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// 等待队列不空")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"while"),t("span",{style:{color:"#E1E4E8"}}," (t "),t("span",{style:{color:"#F97583"}},"!="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"null"),t("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#6A737D"}},"// 获取当前节点的后继节点")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        Node next "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," t.nextWaiter;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#6A737D"}},"// 判断 t 节点是不是 CONDITION 节点，条件队列内不是 CONDITION 就不是正常的")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (t.waitStatus "),t("span",{style:{color:"#F97583"}},"!="),t("span",{style:{color:"#E1E4E8"}}," Node.CONDITION) { ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#6A737D"}},"// 不是正常节点，需要 t 与下一个节点断开")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            t.nextWaiter "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"null"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#6A737D"}},"// 条件成立说明遍历到的节点还未碰到过正常节点")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (trail "),t("span",{style:{color:"#F97583"}},"=="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"null"),t("span",{style:{color:"#E1E4E8"}},")")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#6A737D"}},"// 更新 firstWaiter 指针为下个节点")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                firstWaiter "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," next;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"else")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#6A737D"}},"// 让上一个正常节点指向 当前取消节点的 下一个节点，【删除非正常的节点】")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                trail.nextWaiter "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," next;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#6A737D"}},"// t 是尾节点了，更新 lastWaiter 指向最后一个正常节点")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (next "),t("span",{style:{color:"#F97583"}},"=="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"null"),t("span",{style:{color:"#E1E4E8"}},")")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                lastWaiter "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," trail;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        } "),t("span",{style:{color:"#F97583"}},"else"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#6A737D"}},"// trail 指向的是正常节点 ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            trail "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," t;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#6A737D"}},"// 把 t.next 赋值给 t，循环遍历")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        t "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," next; ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"}")])])]),t("pre",{class:"shiki github-light vp-code-light"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// 清理条件队列内所有已取消（不是CONDITION）的 node，【链表删除的逻辑】")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"private"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"void"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"unlinkCancelledWaiters"),t("span",{style:{color:"#24292E"}},"() {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// 从头节点开始遍历【FIFO】")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    Node t "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," firstWaiter;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// 指向正常的 CONDITION 节点")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    Node trail "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"null"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// 等待队列不空")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"while"),t("span",{style:{color:"#24292E"}}," (t "),t("span",{style:{color:"#D73A49"}},"!="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"null"),t("span",{style:{color:"#24292E"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6A737D"}},"// 获取当前节点的后继节点")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        Node next "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," t.nextWaiter;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6A737D"}},"// 判断 t 节点是不是 CONDITION 节点，条件队列内不是 CONDITION 就不是正常的")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (t.waitStatus "),t("span",{style:{color:"#D73A49"}},"!="),t("span",{style:{color:"#24292E"}}," Node.CONDITION) { ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#6A737D"}},"// 不是正常节点，需要 t 与下一个节点断开")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            t.nextWaiter "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"null"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#6A737D"}},"// 条件成立说明遍历到的节点还未碰到过正常节点")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (trail "),t("span",{style:{color:"#D73A49"}},"=="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"null"),t("span",{style:{color:"#24292E"}},")")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#6A737D"}},"// 更新 firstWaiter 指针为下个节点")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                firstWaiter "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," next;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"else")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#6A737D"}},"// 让上一个正常节点指向 当前取消节点的 下一个节点，【删除非正常的节点】")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                trail.nextWaiter "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," next;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#6A737D"}},"// t 是尾节点了，更新 lastWaiter 指向最后一个正常节点")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (next "),t("span",{style:{color:"#D73A49"}},"=="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"null"),t("span",{style:{color:"#24292E"}},")")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                lastWaiter "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," trail;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        } "),t("span",{style:{color:"#D73A49"}},"else"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#6A737D"}},"// trail 指向的是正常节点 ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            trail "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," t;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6A737D"}},"// 把 t.next 赋值给 t，循环遍历")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        t "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," next; ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"}")])])]),t("button",{class:"collapse"})])]),t("li",null,[t("p",null,"接下来 Thread-0 进入 AQS 的 fullyRelease 流程，释放同步器上的锁"),t("div",{style:{"max-height":"300px"},class:"language-java"},[t("button",{title:"Copy Code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki github-dark vp-code-dark"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// 线程可能重入，需要将 state 全部释放")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"final"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"fullyRelease"),t("span",{style:{color:"#E1E4E8"}},"(Node node) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// 完全释放锁是否成功，false 代表成功")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"boolean"),t("span",{style:{color:"#E1E4E8"}}," failed "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"true"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"try"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#6A737D"}},"// 获取当前线程所持有的 state 值总数")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," savedState "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"getState"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#6A737D"}},"// release -> tryRelease 解锁重入锁")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," ("),t("span",{style:{color:"#B392F0"}},"release"),t("span",{style:{color:"#E1E4E8"}},"(savedState)) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#6A737D"}},"// 释放成功")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            failed "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"false"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#6A737D"}},"// 返回解锁的深度")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"return"),t("span",{style:{color:"#E1E4E8"}}," savedState;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        } "),t("span",{style:{color:"#F97583"}},"else"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#6A737D"}},"// 解锁失败抛出异常")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"throw"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"new"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"IllegalMonitorStateException"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    } "),t("span",{style:{color:"#F97583"}},"finally"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#6A737D"}},"// 没有释放成功，将当前 node 设置为取消状态")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (failed)")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            node.waitStatus "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," Node.CANCELLED;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"}")])])]),t("pre",{class:"shiki github-light vp-code-light"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// 线程可能重入，需要将 state 全部释放")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"final"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"fullyRelease"),t("span",{style:{color:"#24292E"}},"(Node node) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// 完全释放锁是否成功，false 代表成功")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"boolean"),t("span",{style:{color:"#24292E"}}," failed "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"true"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"try"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6A737D"}},"// 获取当前线程所持有的 state 值总数")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," savedState "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"getState"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6A737D"}},"// release -> tryRelease 解锁重入锁")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," ("),t("span",{style:{color:"#6F42C1"}},"release"),t("span",{style:{color:"#24292E"}},"(savedState)) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#6A737D"}},"// 释放成功")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            failed "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"false"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#6A737D"}},"// 返回解锁的深度")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"return"),t("span",{style:{color:"#24292E"}}," savedState;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        } "),t("span",{style:{color:"#D73A49"}},"else"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#6A737D"}},"// 解锁失败抛出异常")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"throw"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"new"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"IllegalMonitorStateException"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    } "),t("span",{style:{color:"#D73A49"}},"finally"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6A737D"}},"// 没有释放成功，将当前 node 设置为取消状态")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (failed)")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            node.waitStatus "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," Node.CANCELLED;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"}")])])]),t("button",{class:"collapse"})])]),t("li",null,[t("p",null,"fullyRelease 中会 unpark AQS 队列中的下一个节点竞争锁，假设 Thread-1 竞争成功"),t("img",{src:"https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230719164258904.png",alt:"image-20230719164258904",style:{zoom:"80%"}})]),t("li",null,[t("p",null,[p("Thread-0 进入 isOnSyncQueue 逻辑判断节点"),t("strong",null,"是否移动到阻塞队列"),p("，没有就 park 阻塞 Thread-0")]),t("div",{style:{"max-height":"300px"},class:"language-java"},[t("button",{title:"Copy Code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki github-dark vp-code-dark"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"final"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"boolean"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"isOnSyncQueue"),t("span",{style:{color:"#E1E4E8"}},"(Node node) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// node 的状态是 CONDITION，signal 方法是先修改状态再迁移，所以前驱节点为空证明还【没有完成迁移】")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (node.waitStatus "),t("span",{style:{color:"#F97583"}},"=="),t("span",{style:{color:"#E1E4E8"}}," Node.CONDITION "),t("span",{style:{color:"#F97583"}},"||"),t("span",{style:{color:"#E1E4E8"}}," node.prev "),t("span",{style:{color:"#F97583"}},"=="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"null"),t("span",{style:{color:"#E1E4E8"}},")")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"return"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"false"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// 说明当前节点已经成功入队到阻塞队列，且当前节点后面已经有其它 node，因为条件队列的 next 指针为 null")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (node.next "),t("span",{style:{color:"#F97583"}},"!="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"null"),t("span",{style:{color:"#E1E4E8"}},")")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"return"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"true"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"\t"),t("span",{style:{color:"#6A737D"}},"// 说明【可能在阻塞队列，但是是尾节点】")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// 从阻塞队列的尾节点开始向前【遍历查找 node】，如果查找到返回 true，查找不到返回 false")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"return"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"findNodeFromTail"),t("span",{style:{color:"#E1E4E8"}},"(node);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"}")])])]),t("pre",{class:"shiki github-light vp-code-light"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"final"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"boolean"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"isOnSyncQueue"),t("span",{style:{color:"#24292E"}},"(Node node) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// node 的状态是 CONDITION，signal 方法是先修改状态再迁移，所以前驱节点为空证明还【没有完成迁移】")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (node.waitStatus "),t("span",{style:{color:"#D73A49"}},"=="),t("span",{style:{color:"#24292E"}}," Node.CONDITION "),t("span",{style:{color:"#D73A49"}},"||"),t("span",{style:{color:"#24292E"}}," node.prev "),t("span",{style:{color:"#D73A49"}},"=="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"null"),t("span",{style:{color:"#24292E"}},")")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"return"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"false"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// 说明当前节点已经成功入队到阻塞队列，且当前节点后面已经有其它 node，因为条件队列的 next 指针为 null")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (node.next "),t("span",{style:{color:"#D73A49"}},"!="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"null"),t("span",{style:{color:"#24292E"}},")")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"return"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"true"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"\t"),t("span",{style:{color:"#6A737D"}},"// 说明【可能在阻塞队列，但是是尾节点】")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// 从阻塞队列的尾节点开始向前【遍历查找 node】，如果查找到返回 true，查找不到返回 false")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"return"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"findNodeFromTail"),t("span",{style:{color:"#24292E"}},"(node);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"}")])])]),t("button",{class:"collapse"})])]),t("li",null,[t("p",null,[p("await 线程 park 后如果被 unpark 或者被打断，都会进入 checkInterruptWhileWaiting 判断线程是否被打断："),t("strong",null,"在条件队列被打断的线程需要抛出异常")]),t("div",{style:{"max-height":"300px"},class:"language-java"},[t("button",{title:"Copy Code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki github-dark vp-code-dark"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"private"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"checkInterruptWhileWaiting"),t("span",{style:{color:"#E1E4E8"}},"(Node node) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// Thread.interrupted() 返回当前线程中断标记位，并且重置当前标记位 为 false")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// 如果被中断了，根据是否在条件队列被中断的，设置中断状态码")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"return"),t("span",{style:{color:"#E1E4E8"}}," Thread."),t("span",{style:{color:"#B392F0"}},"interrupted"),t("span",{style:{color:"#E1E4E8"}},"() "),t("span",{style:{color:"#F97583"}},"?"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#B392F0"}},"transferAfterCancelledWait"),t("span",{style:{color:"#E1E4E8"}},"(node) "),t("span",{style:{color:"#F97583"}},"?"),t("span",{style:{color:"#E1E4E8"}}," THROW_IE "),t("span",{style:{color:"#F97583"}},":"),t("span",{style:{color:"#E1E4E8"}}," REINTERRUPT) "),t("span",{style:{color:"#F97583"}},":"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"0"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"}")])])]),t("pre",{class:"shiki github-light vp-code-light"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"private"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"checkInterruptWhileWaiting"),t("span",{style:{color:"#24292E"}},"(Node node) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// Thread.interrupted() 返回当前线程中断标记位，并且重置当前标记位 为 false")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// 如果被中断了，根据是否在条件队列被中断的，设置中断状态码")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"return"),t("span",{style:{color:"#24292E"}}," Thread."),t("span",{style:{color:"#6F42C1"}},"interrupted"),t("span",{style:{color:"#24292E"}},"() "),t("span",{style:{color:"#D73A49"}},"?"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#6F42C1"}},"transferAfterCancelledWait"),t("span",{style:{color:"#24292E"}},"(node) "),t("span",{style:{color:"#D73A49"}},"?"),t("span",{style:{color:"#24292E"}}," THROW_IE "),t("span",{style:{color:"#D73A49"}},":"),t("span",{style:{color:"#24292E"}}," REINTERRUPT) "),t("span",{style:{color:"#D73A49"}},":"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"0"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"}")])])]),t("button",{class:"collapse"})]),t("div",{style:{"max-height":"300px"},class:"language-java"},[t("button",{title:"Copy Code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki github-dark vp-code-dark"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// 这个方法只有在线程是被打断唤醒时才会调用")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"final"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"boolean"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"transferAfterCancelledWait"),t("span",{style:{color:"#E1E4E8"}},"(Node node) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// 条件成立说明当前node一定是在条件队列内，因为 signal 迁移节点到阻塞队列时，会将节点的状态修改为 0")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," ("),t("span",{style:{color:"#B392F0"}},"compareAndSetWaitStatus"),t("span",{style:{color:"#E1E4E8"}},"(node, Node.CONDITION, "),t("span",{style:{color:"#79B8FF"}},"0"),t("span",{style:{color:"#E1E4E8"}},")) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#6A737D"}},"// 把【中断唤醒的 node 加入到阻塞队列中】")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#B392F0"}},"enq"),t("span",{style:{color:"#E1E4E8"}},"(node);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#6A737D"}},"// 表示是在条件队列内被中断了，设置为 THROW_IE 为 -1")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"return"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"true"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"//执行到这里的情况：")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"//1.当前node已经被外部线程调用 signal 方法将其迁移到 阻塞队列 内了")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"//2.当前node正在被外部线程调用 signal 方法将其迁移至 阻塞队列 进行中状态")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// 如果当前线程还没到阻塞队列，一直释放 CPU")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"while"),t("span",{style:{color:"#E1E4E8"}}," ("),t("span",{style:{color:"#F97583"}},"!"),t("span",{style:{color:"#B392F0"}},"isOnSyncQueue"),t("span",{style:{color:"#E1E4E8"}},"(node))")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        Thread."),t("span",{style:{color:"#B392F0"}},"yield"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// 表示当前节点被中断唤醒时不在条件队列了，设置为 REINTERRUPT 为 1")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"return"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"false"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"}")])])]),t("pre",{class:"shiki github-light vp-code-light"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// 这个方法只有在线程是被打断唤醒时才会调用")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"final"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"boolean"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"transferAfterCancelledWait"),t("span",{style:{color:"#24292E"}},"(Node node) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// 条件成立说明当前node一定是在条件队列内，因为 signal 迁移节点到阻塞队列时，会将节点的状态修改为 0")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," ("),t("span",{style:{color:"#6F42C1"}},"compareAndSetWaitStatus"),t("span",{style:{color:"#24292E"}},"(node, Node.CONDITION, "),t("span",{style:{color:"#005CC5"}},"0"),t("span",{style:{color:"#24292E"}},")) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6A737D"}},"// 把【中断唤醒的 node 加入到阻塞队列中】")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6F42C1"}},"enq"),t("span",{style:{color:"#24292E"}},"(node);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6A737D"}},"// 表示是在条件队列内被中断了，设置为 THROW_IE 为 -1")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"return"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"true"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    }")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"//执行到这里的情况：")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"//1.当前node已经被外部线程调用 signal 方法将其迁移到 阻塞队列 内了")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"//2.当前node正在被外部线程调用 signal 方法将其迁移至 阻塞队列 进行中状态")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// 如果当前线程还没到阻塞队列，一直释放 CPU")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"while"),t("span",{style:{color:"#24292E"}}," ("),t("span",{style:{color:"#D73A49"}},"!"),t("span",{style:{color:"#6F42C1"}},"isOnSyncQueue"),t("span",{style:{color:"#24292E"}},"(node))")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        Thread."),t("span",{style:{color:"#6F42C1"}},"yield"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// 表示当前节点被中断唤醒时不在条件队列了，设置为 REINTERRUPT 为 1")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"return"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"false"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"}")])])]),t("button",{class:"collapse"})])]),t("li",null,[t("p",null,"最后开始处理中断状态："),t("div",{style:{"max-height":"300px"},class:"language-java"},[t("button",{title:"Copy Code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki github-dark vp-code-dark"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"private"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"void"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"reportInterruptAfterWait"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," interruptMode) throws InterruptedException {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// 条件成立说明【在条件队列内发生过中断，此时 await 方法抛出中断异常】")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (interruptMode "),t("span",{style:{color:"#F97583"}},"=="),t("span",{style:{color:"#E1E4E8"}}," THROW_IE)")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"throw"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"new"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"InterruptedException"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// 条件成立说明【在条件队列外发生的中断，此时设置当前线程的中断标记位为 true】")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"else"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (interruptMode "),t("span",{style:{color:"#F97583"}},"=="),t("span",{style:{color:"#E1E4E8"}}," REINTERRUPT)")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#6A737D"}},"// 进行一次自己打断，产生中断的效果")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#B392F0"}},"selfInterrupt"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"}")])])]),t("pre",{class:"shiki github-light vp-code-light"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"private"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"void"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"reportInterruptAfterWait"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," interruptMode) throws InterruptedException {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// 条件成立说明【在条件队列内发生过中断，此时 await 方法抛出中断异常】")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (interruptMode "),t("span",{style:{color:"#D73A49"}},"=="),t("span",{style:{color:"#24292E"}}," THROW_IE)")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"throw"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"new"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"InterruptedException"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// 条件成立说明【在条件队列外发生的中断，此时设置当前线程的中断标记位为 true】")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"else"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (interruptMode "),t("span",{style:{color:"#D73A49"}},"=="),t("span",{style:{color:"#24292E"}}," REINTERRUPT)")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6A737D"}},"// 进行一次自己打断，产生中断的效果")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6F42C1"}},"selfInterrupt"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"}")])])]),t("button",{class:"collapse"})])])],-1),ml=t("hr",null,null,-1),xl={id:"signal",tabindex:"-1"},wl=t("ul",null,[t("li",null,[t("p",null,[p("假设 Thread-1 要来唤醒 Thread-0，进入 ConditionObject 的 doSignal 流程，"),t("strong",null,"取得等待队列中第一个 Node"),p("，即 Thread-0 所在 Node，必须持有锁才能唤醒, 因此 doSignal 内线程安全")]),t("div",{style:{"max-height":"300px"},class:"language-java"},[t("button",{title:"Copy Code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki github-dark vp-code-dark"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"public"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"final"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"void"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"signal"),t("span",{style:{color:"#E1E4E8"}},"() {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// 判断调用 signal 方法的线程是否是独占锁持有线程")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," ("),t("span",{style:{color:"#F97583"}},"!"),t("span",{style:{color:"#B392F0"}},"isHeldExclusively"),t("span",{style:{color:"#E1E4E8"}},"())")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"throw"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"new"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"IllegalMonitorStateException"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// 获取条件队列中第一个 Node")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    Node first "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," firstWaiter;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// 不为空就将第该节点【迁移到阻塞队列】")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (first "),t("span",{style:{color:"#F97583"}},"!="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"null"),t("span",{style:{color:"#E1E4E8"}},")")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#B392F0"}},"doSignal"),t("span",{style:{color:"#E1E4E8"}},"(first);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"}")])])]),t("pre",{class:"shiki github-light vp-code-light"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"public"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"final"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"void"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"signal"),t("span",{style:{color:"#24292E"}},"() {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// 判断调用 signal 方法的线程是否是独占锁持有线程")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," ("),t("span",{style:{color:"#D73A49"}},"!"),t("span",{style:{color:"#6F42C1"}},"isHeldExclusively"),t("span",{style:{color:"#24292E"}},"())")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"throw"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"new"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"IllegalMonitorStateException"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// 获取条件队列中第一个 Node")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    Node first "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," firstWaiter;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// 不为空就将第该节点【迁移到阻塞队列】")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (first "),t("span",{style:{color:"#D73A49"}},"!="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"null"),t("span",{style:{color:"#24292E"}},")")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6F42C1"}},"doSignal"),t("span",{style:{color:"#24292E"}},"(first);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"}")])])]),t("button",{class:"collapse"})]),t("div",{style:{"max-height":"300px"},class:"language-java"},[t("button",{title:"Copy Code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki github-dark vp-code-dark"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// 唤醒 - 【将没取消的第一个节点转移至 AQS 队列尾部】")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"private"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"void"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"doSignal"),t("span",{style:{color:"#E1E4E8"}},"(Node first) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"do"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#6A737D"}},"// 成立说明当前节点的下一个节点是 null，当前节点是尾节点了，队列中只有当前一个节点了")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," ((firstWaiter "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," first.nextWaiter) "),t("span",{style:{color:"#F97583"}},"=="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"null"),t("span",{style:{color:"#E1E4E8"}},")")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            lastWaiter "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"null"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        first.nextWaiter "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"null"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// 将等待队列中的 Node 转移至 AQS 队列，不成功且还有节点则继续循环")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    } "),t("span",{style:{color:"#F97583"}},"while"),t("span",{style:{color:"#E1E4E8"}}," ("),t("span",{style:{color:"#F97583"}},"!"),t("span",{style:{color:"#B392F0"}},"transferForSignal"),t("span",{style:{color:"#E1E4E8"}},"(first) "),t("span",{style:{color:"#F97583"}},"&&"),t("span",{style:{color:"#E1E4E8"}}," (first "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," firstWaiter) "),t("span",{style:{color:"#F97583"}},"!="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"null"),t("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"}")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// signalAll() 会调用这个函数，唤醒所有的节点")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"private"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"void"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"doSignalAll"),t("span",{style:{color:"#E1E4E8"}},"(Node first) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    lastWaiter "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," firstWaiter "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"null"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"do"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        Node next "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," first.nextWaiter;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        first.nextWaiter "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"null"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#B392F0"}},"transferForSignal"),t("span",{style:{color:"#E1E4E8"}},"(first);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        first "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," next;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// 唤醒所有的节点，都放到阻塞队列中")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    } "),t("span",{style:{color:"#F97583"}},"while"),t("span",{style:{color:"#E1E4E8"}}," (first "),t("span",{style:{color:"#F97583"}},"!="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"null"),t("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"}")])])]),t("pre",{class:"shiki github-light vp-code-light"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// 唤醒 - 【将没取消的第一个节点转移至 AQS 队列尾部】")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"private"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"void"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"doSignal"),t("span",{style:{color:"#24292E"}},"(Node first) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"do"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6A737D"}},"// 成立说明当前节点的下一个节点是 null，当前节点是尾节点了，队列中只有当前一个节点了")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," ((firstWaiter "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," first.nextWaiter) "),t("span",{style:{color:"#D73A49"}},"=="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"null"),t("span",{style:{color:"#24292E"}},")")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            lastWaiter "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"null"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        first.nextWaiter "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"null"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// 将等待队列中的 Node 转移至 AQS 队列，不成功且还有节点则继续循环")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    } "),t("span",{style:{color:"#D73A49"}},"while"),t("span",{style:{color:"#24292E"}}," ("),t("span",{style:{color:"#D73A49"}},"!"),t("span",{style:{color:"#6F42C1"}},"transferForSignal"),t("span",{style:{color:"#24292E"}},"(first) "),t("span",{style:{color:"#D73A49"}},"&&"),t("span",{style:{color:"#24292E"}}," (first "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," firstWaiter) "),t("span",{style:{color:"#D73A49"}},"!="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"null"),t("span",{style:{color:"#24292E"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"}")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// signalAll() 会调用这个函数，唤醒所有的节点")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"private"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"void"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"doSignalAll"),t("span",{style:{color:"#24292E"}},"(Node first) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    lastWaiter "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," firstWaiter "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"null"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"do"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        Node next "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," first.nextWaiter;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        first.nextWaiter "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"null"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6F42C1"}},"transferForSignal"),t("span",{style:{color:"#24292E"}},"(first);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        first "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," next;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// 唤醒所有的节点，都放到阻塞队列中")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    } "),t("span",{style:{color:"#D73A49"}},"while"),t("span",{style:{color:"#24292E"}}," (first "),t("span",{style:{color:"#D73A49"}},"!="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"null"),t("span",{style:{color:"#24292E"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"}")])])]),t("button",{class:"collapse"})])]),t("li",null,[t("p",null,[p("执行 transferForSignal，"),t("strong",null,"先将节点的 waitStatus 改为 0，然后加入 AQS 阻塞队列尾部"),p("，将 Thread-3 的 waitStatus 改为 -1")]),t("div",{style:{"max-height":"300px"},class:"language-java"},[t("button",{title:"Copy Code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki github-dark vp-code-dark"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// 如果节点状态是取消, 返回 false 表示转移失败, 否则转移成功")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"final"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"boolean"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"transferForSignal"),t("span",{style:{color:"#E1E4E8"}},"(Node node) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// CAS 修改当前节点的状态，修改为 0，因为当前节点马上要迁移到阻塞队列了")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// 如果状态已经不是 CONDITION, 说明线程被取消（await 释放全部锁失败）或者被中断（可打断 cancelAcquire）")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," ("),t("span",{style:{color:"#F97583"}},"!"),t("span",{style:{color:"#B392F0"}},"compareAndSetWaitStatus"),t("span",{style:{color:"#E1E4E8"}},"(node, Node.CONDITION, "),t("span",{style:{color:"#79B8FF"}},"0"),t("span",{style:{color:"#E1E4E8"}},"))")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#6A737D"}},"// 返回函数调用处继续寻找下一个节点")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"return"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"false"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// 【先改状态，再进行迁移】")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// 将当前 node 入阻塞队列，p 是当前节点在阻塞队列的【前驱节点】")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    Node p "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"enq"),t("span",{style:{color:"#E1E4E8"}},"(node);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," ws "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," p.waitStatus;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// 如果前驱节点被取消或者不能设置状态为 Node.SIGNAL，就 unpark 取消当前节点线程的阻塞状态, ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// 让 thread-0 线程竞争锁，重新同步状态")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (ws "),t("span",{style:{color:"#F97583"}},">"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"0"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"||"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"!"),t("span",{style:{color:"#B392F0"}},"compareAndSetWaitStatus"),t("span",{style:{color:"#E1E4E8"}},"(p, ws, Node.SIGNAL))")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        LockSupport."),t("span",{style:{color:"#B392F0"}},"unpark"),t("span",{style:{color:"#E1E4E8"}},"(node.thread);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"return"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"true"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"}")])])]),t("pre",{class:"shiki github-light vp-code-light"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// 如果节点状态是取消, 返回 false 表示转移失败, 否则转移成功")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"final"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"boolean"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"transferForSignal"),t("span",{style:{color:"#24292E"}},"(Node node) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// CAS 修改当前节点的状态，修改为 0，因为当前节点马上要迁移到阻塞队列了")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// 如果状态已经不是 CONDITION, 说明线程被取消（await 释放全部锁失败）或者被中断（可打断 cancelAcquire）")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," ("),t("span",{style:{color:"#D73A49"}},"!"),t("span",{style:{color:"#6F42C1"}},"compareAndSetWaitStatus"),t("span",{style:{color:"#24292E"}},"(node, Node.CONDITION, "),t("span",{style:{color:"#005CC5"}},"0"),t("span",{style:{color:"#24292E"}},"))")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6A737D"}},"// 返回函数调用处继续寻找下一个节点")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"return"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"false"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// 【先改状态，再进行迁移】")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// 将当前 node 入阻塞队列，p 是当前节点在阻塞队列的【前驱节点】")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    Node p "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"enq"),t("span",{style:{color:"#24292E"}},"(node);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," ws "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," p.waitStatus;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// 如果前驱节点被取消或者不能设置状态为 Node.SIGNAL，就 unpark 取消当前节点线程的阻塞状态, ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// 让 thread-0 线程竞争锁，重新同步状态")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (ws "),t("span",{style:{color:"#D73A49"}},">"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"0"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"||"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"!"),t("span",{style:{color:"#6F42C1"}},"compareAndSetWaitStatus"),t("span",{style:{color:"#24292E"}},"(p, ws, Node.SIGNAL))")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        LockSupport."),t("span",{style:{color:"#6F42C1"}},"unpark"),t("span",{style:{color:"#24292E"}},"(node.thread);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"return"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"true"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"}")])])]),t("button",{class:"collapse"})]),t("img",{src:"https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230719164353059.png",alt:"image-20230719164353059",style:{zoom:"80%"}})]),t("li",null,[t("p",null,"Thread-1 释放锁，进入 unlock 流程")])],-1),Tl=t("hr",null,null,-1),Nl={id:"readwrite",tabindex:"-1"},Il={id:"读写锁",tabindex:"-1"},Rl=t("p",null,"独占锁：指该锁一次只能被一个线程所持有，对 ReentrantLock 和 Synchronized 而言都是独占锁",-1),Ll=t("p",null,"共享锁：指该锁可以被多个线程所持有",-1),ql=t("p",null,[p("ReentrantReadWriteLock 其"),t("strong",null,"读锁是共享锁，写锁是独占锁")],-1),jl=t("p",null,"作用：多个线程同时读一个资源类没有任何问题，为了满足并发量，读取共享资源应该同时进行，但是如果一个线程想去写共享资源，就不应该再有其它线程可以对该资源进行读或写",-1),Ol=t("p",null,"使用规则：",-1),Pl=t("ul",null,[t("li",null,[t("p",null,"加锁解锁格式："),t("div",{style:{"max-height":"300px"},class:"language-java"},[t("button",{title:"Copy Code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki github-dark vp-code-dark"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"r."),t("span",{style:{color:"#B392F0"}},"lock"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"try"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// 临界区")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"} "),t("span",{style:{color:"#F97583"}},"finally"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"\tr."),t("span",{style:{color:"#B392F0"}},"unlock"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"}")])])]),t("pre",{class:"shiki github-light vp-code-light"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"r."),t("span",{style:{color:"#6F42C1"}},"lock"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"try"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// 临界区")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"} "),t("span",{style:{color:"#D73A49"}},"finally"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"\tr."),t("span",{style:{color:"#6F42C1"}},"unlock"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"}")])])]),t("button",{class:"collapse"})])]),t("li",null,[t("p",null,"读-读能共存、读-写不能共存、写-写不能共存")]),t("li",null,[t("p",null,"读锁不支持条件变量")]),t("li",null,[t("p",null,[t("strong",null,"重入时升级不支持"),p("：持有读锁的情况下去获取写锁会导致获取写锁永久等待，需要先释放读，再去获得写")])]),t("li",null,[t("p",null,[t("strong",null,"重入时降级支持"),p("：持有写锁的情况下去获取读锁，造成只有当前线程会持有读锁，因为写锁会互斥其他的锁")]),t("div",{style:{"max-height":"300px"},class:"language-java"},[t("button",{title:"Copy Code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki github-dark vp-code-dark"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"w."),t("span",{style:{color:"#B392F0"}},"lock"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"try"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    r."),t("span",{style:{color:"#B392F0"}},"lock"),t("span",{style:{color:"#E1E4E8"}},"();"),t("span",{style:{color:"#6A737D"}},"// 降级为读锁, 释放写锁, 这样能够让其它线程读取缓存")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"try"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#6A737D"}},"// ...")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    } "),t("span",{style:{color:"#F97583"}},"finally"),t("span",{style:{color:"#E1E4E8"}},"{")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    \tw."),t("span",{style:{color:"#B392F0"}},"unlock"),t("span",{style:{color:"#E1E4E8"}},"();"),t("span",{style:{color:"#6A737D"}},"// 要在写锁释放之前获取读锁")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"} "),t("span",{style:{color:"#F97583"}},"finally"),t("span",{style:{color:"#E1E4E8"}},"{")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"\tr."),t("span",{style:{color:"#B392F0"}},"unlock"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"}")])])]),t("pre",{class:"shiki github-light vp-code-light"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"w."),t("span",{style:{color:"#6F42C1"}},"lock"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"try"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    r."),t("span",{style:{color:"#6F42C1"}},"lock"),t("span",{style:{color:"#24292E"}},"();"),t("span",{style:{color:"#6A737D"}},"// 降级为读锁, 释放写锁, 这样能够让其它线程读取缓存")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"try"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6A737D"}},"// ...")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    } "),t("span",{style:{color:"#D73A49"}},"finally"),t("span",{style:{color:"#24292E"}},"{")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    \tw."),t("span",{style:{color:"#6F42C1"}},"unlock"),t("span",{style:{color:"#24292E"}},"();"),t("span",{style:{color:"#6A737D"}},"// 要在写锁释放之前获取读锁")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"} "),t("span",{style:{color:"#D73A49"}},"finally"),t("span",{style:{color:"#24292E"}},"{")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"\tr."),t("span",{style:{color:"#6F42C1"}},"unlock"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"}")])])]),t("button",{class:"collapse"})])])],-1),Wl=t("p",null,"构造方法：",-1),Hl=t("ul",null,[t("li",null,[t("code",null,"public ReentrantReadWriteLock()"),p("：默认构造方法，非公平锁")]),t("li",null,[t("code",null,"public ReentrantReadWriteLock(boolean fair)"),p("：true 为公平锁")])],-1),_l=t("p",null,"常用API：",-1),Ql=t("ul",null,[t("li",null,[t("code",null,"public ReentrantReadWriteLock.ReadLock readLock()"),p("：返回读锁")]),t("li",null,[t("code",null,"public ReentrantReadWriteLock.WriteLock writeLock()"),p("：返回写锁")]),t("li",null,[t("code",null,"public void lock()"),p("：加锁")]),t("li",null,[t("code",null,"public void unlock()"),p("：解锁")]),t("li",null,[t("code",null,"public boolean tryLock()"),p("：尝试获取锁")])],-1),Gl=t("p",null,"读读并发：",-1),zl=t("div",{style:{"max-height":"300px"},class:"language-java"},[t("button",{title:"Copy Code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki github-dark vp-code-dark"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"public"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"static"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"void"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"main"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#F97583"}},"String"),t("span",{style:{color:"#E1E4E8"}},"[] args) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    ReentrantReadWriteLock rw "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"new"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"ReentrantReadWriteLock"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    ReentrantReadWriteLock.ReadLock r "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," rw."),t("span",{style:{color:"#B392F0"}},"readLock"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    ReentrantReadWriteLock.WriteLock w "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," rw."),t("span",{style:{color:"#B392F0"}},"writeLock"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"new"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"Thread"),t("span",{style:{color:"#E1E4E8"}},"(() "),t("span",{style:{color:"#F97583"}},"->"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        r."),t("span",{style:{color:"#B392F0"}},"lock"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"try"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            Thread."),t("span",{style:{color:"#B392F0"}},"sleep"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#79B8FF"}},"2000"),t("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            System.out."),t("span",{style:{color:"#B392F0"}},"println"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#9ECBFF"}},'"Thread 1 running "'),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"+"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"new"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"Date"),t("span",{style:{color:"#E1E4E8"}},"());")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        } "),t("span",{style:{color:"#F97583"}},"finally"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            r."),t("span",{style:{color:"#B392F0"}},"unlock"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    },"),t("span",{style:{color:"#9ECBFF"}},'"t1"'),t("span",{style:{color:"#E1E4E8"}},")."),t("span",{style:{color:"#B392F0"}},"start"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"new"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"Thread"),t("span",{style:{color:"#E1E4E8"}},"(() "),t("span",{style:{color:"#F97583"}},"->"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        r."),t("span",{style:{color:"#B392F0"}},"lock"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"try"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            Thread."),t("span",{style:{color:"#B392F0"}},"sleep"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#79B8FF"}},"2000"),t("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            System.out."),t("span",{style:{color:"#B392F0"}},"println"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#9ECBFF"}},'"Thread 2 running "'),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"+"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"new"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"Date"),t("span",{style:{color:"#E1E4E8"}},"());")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        } "),t("span",{style:{color:"#F97583"}},"finally"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            r."),t("span",{style:{color:"#B392F0"}},"unlock"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    },"),t("span",{style:{color:"#9ECBFF"}},'"t2"'),t("span",{style:{color:"#E1E4E8"}},")."),t("span",{style:{color:"#B392F0"}},"start"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"}")])])]),t("pre",{class:"shiki github-light vp-code-light"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"public"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"static"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"void"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"main"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#D73A49"}},"String"),t("span",{style:{color:"#24292E"}},"[] args) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    ReentrantReadWriteLock rw "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"new"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"ReentrantReadWriteLock"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    ReentrantReadWriteLock.ReadLock r "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," rw."),t("span",{style:{color:"#6F42C1"}},"readLock"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    ReentrantReadWriteLock.WriteLock w "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," rw."),t("span",{style:{color:"#6F42C1"}},"writeLock"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"new"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"Thread"),t("span",{style:{color:"#24292E"}},"(() "),t("span",{style:{color:"#D73A49"}},"->"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        r."),t("span",{style:{color:"#6F42C1"}},"lock"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"try"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            Thread."),t("span",{style:{color:"#6F42C1"}},"sleep"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#005CC5"}},"2000"),t("span",{style:{color:"#24292E"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            System.out."),t("span",{style:{color:"#6F42C1"}},"println"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#032F62"}},'"Thread 1 running "'),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"+"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"new"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"Date"),t("span",{style:{color:"#24292E"}},"());")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        } "),t("span",{style:{color:"#D73A49"}},"finally"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            r."),t("span",{style:{color:"#6F42C1"}},"unlock"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    },"),t("span",{style:{color:"#032F62"}},'"t1"'),t("span",{style:{color:"#24292E"}},")."),t("span",{style:{color:"#6F42C1"}},"start"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"new"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"Thread"),t("span",{style:{color:"#24292E"}},"(() "),t("span",{style:{color:"#D73A49"}},"->"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        r."),t("span",{style:{color:"#6F42C1"}},"lock"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"try"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            Thread."),t("span",{style:{color:"#6F42C1"}},"sleep"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#005CC5"}},"2000"),t("span",{style:{color:"#24292E"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            System.out."),t("span",{style:{color:"#6F42C1"}},"println"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#032F62"}},'"Thread 2 running "'),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"+"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"new"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"Date"),t("span",{style:{color:"#24292E"}},"());")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        } "),t("span",{style:{color:"#D73A49"}},"finally"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            r."),t("span",{style:{color:"#6F42C1"}},"unlock"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    },"),t("span",{style:{color:"#032F62"}},'"t2"'),t("span",{style:{color:"#24292E"}},")."),t("span",{style:{color:"#6F42C1"}},"start"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"}")])])]),t("button",{class:"collapse"})],-1),Ul=t("hr",null,null,-1),Ml={id:"缓存应用",tabindex:"-1"},Vl=t("p",null,"缓存更新时，是先清缓存还是先更新数据库",-1),Kl=t("ul",null,[t("li",null,[t("p",null,"先清缓存：可能造成刚清理缓存还没有更新数据库，线程直接查询了数据库更新过期数据到缓存")]),t("li",null,[t("p",null,"先更新据库：可能造成刚更新数据库，还没清空缓存就有线程从缓存拿到了旧数据")]),t("li",null,[t("p",null,"补充情况：查询线程 A 查询数据时恰好缓存数据由于时间到期失效，或是第一次查询"),t("img",{src:"https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230719180125357.png",alt:"image-20230719180125357",style:{zoom:"50%"}})])],-1),Xl=t("p",null,"可以使用读写锁进行操作",-1),Jl=t("hr",null,null,-1),$l={id:"实现原理-3",tabindex:"-1"},Zl={id:"成员属性",tabindex:"-1"},Yl=t("p",null,[p("读写锁用的是同一个 Sycn 同步器，因此等待队列、state 等也是同一个，原理与 ReentrantLock 加锁相比没有特殊之处，不同是"),t("strong",null,"写锁状态占了 state 的低 16 位，而读锁使用的是 state 的高 16 位")],-1),so=t("ul",null,[t("li",null,[t("p",null,"读写锁："),t("div",{style:{"max-height":"300px"},class:"language-java"},[t("button",{title:"Copy Code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki github-dark vp-code-dark"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"private"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"final"),t("span",{style:{color:"#E1E4E8"}}," ReentrantReadWriteLock.ReadLock readerLock;\t\t")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"private"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"final"),t("span",{style:{color:"#E1E4E8"}}," ReentrantReadWriteLock.WriteLock writerLock;")])])]),t("pre",{class:"shiki github-light vp-code-light"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"private"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"final"),t("span",{style:{color:"#24292E"}}," ReentrantReadWriteLock.ReadLock readerLock;\t\t")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"private"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"final"),t("span",{style:{color:"#24292E"}}," ReentrantReadWriteLock.WriteLock writerLock;")])])]),t("button",{class:"collapse"})])]),t("li",null,[t("p",null,"构造方法：默认是非公平锁，可以指定参数创建公平锁"),t("div",{style:{"max-height":"300px"},class:"language-java"},[t("button",{title:"Copy Code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki github-dark vp-code-dark"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"public"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"ReentrantReadWriteLock"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#F97583"}},"boolean"),t("span",{style:{color:"#E1E4E8"}}," fair) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// true 为公平锁")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    sync "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," fair "),t("span",{style:{color:"#F97583"}},"?"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"new"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"FairSync"),t("span",{style:{color:"#E1E4E8"}},"() "),t("span",{style:{color:"#F97583"}},":"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"new"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"NonfairSync"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// 这两个 lock 共享同一个 sync 实例，都是由 ReentrantReadWriteLock 的 sync 提供同步实现")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    readerLock "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"new"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"ReadLock"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#79B8FF"}},"this"),t("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    writerLock "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"new"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"WriteLock"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#79B8FF"}},"this"),t("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"}")])])]),t("pre",{class:"shiki github-light vp-code-light"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"public"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"ReentrantReadWriteLock"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#D73A49"}},"boolean"),t("span",{style:{color:"#24292E"}}," fair) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// true 为公平锁")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    sync "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," fair "),t("span",{style:{color:"#D73A49"}},"?"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"new"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"FairSync"),t("span",{style:{color:"#24292E"}},"() "),t("span",{style:{color:"#D73A49"}},":"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"new"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"NonfairSync"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// 这两个 lock 共享同一个 sync 实例，都是由 ReentrantReadWriteLock 的 sync 提供同步实现")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    readerLock "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"new"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"ReadLock"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#005CC5"}},"this"),t("span",{style:{color:"#24292E"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    writerLock "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"new"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"WriteLock"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#005CC5"}},"this"),t("span",{style:{color:"#24292E"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"}")])])]),t("button",{class:"collapse"})])])],-1),lo=t("p",null,"Sync 类的属性：",-1),oo=t("ul",null,[t("li",null,[t("p",null,"统计变量："),t("div",{style:{"max-height":"300px"},class:"language-java"},[t("button",{title:"Copy Code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki github-dark vp-code-dark"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// 用来移位")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"static"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"final"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," SHARED_SHIFT   "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"16"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// 高16位的1")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"static"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"final"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," SHARED_UNIT    "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," ("),t("span",{style:{color:"#79B8FF"}},"1"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"<<"),t("span",{style:{color:"#E1E4E8"}}," SHARED_SHIFT);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// 65535，16个1，代表写锁的最大重入次数")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"static"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"final"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," MAX_COUNT      "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," ("),t("span",{style:{color:"#79B8FF"}},"1"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"<<"),t("span",{style:{color:"#E1E4E8"}}," SHARED_SHIFT) "),t("span",{style:{color:"#F97583"}},"-"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"1"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// 低16位掩码：0b 1111 1111 1111 1111，用来获取写锁重入的次数")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"static"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"final"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," EXCLUSIVE_MASK "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," ("),t("span",{style:{color:"#79B8FF"}},"1"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"<<"),t("span",{style:{color:"#E1E4E8"}}," SHARED_SHIFT) "),t("span",{style:{color:"#F97583"}},"-"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"1"),t("span",{style:{color:"#E1E4E8"}},";")])])]),t("pre",{class:"shiki github-light vp-code-light"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// 用来移位")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"static"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"final"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," SHARED_SHIFT   "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"16"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// 高16位的1")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"static"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"final"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," SHARED_UNIT    "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," ("),t("span",{style:{color:"#005CC5"}},"1"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"<<"),t("span",{style:{color:"#24292E"}}," SHARED_SHIFT);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// 65535，16个1，代表写锁的最大重入次数")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"static"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"final"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," MAX_COUNT      "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," ("),t("span",{style:{color:"#005CC5"}},"1"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"<<"),t("span",{style:{color:"#24292E"}}," SHARED_SHIFT) "),t("span",{style:{color:"#D73A49"}},"-"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"1"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// 低16位掩码：0b 1111 1111 1111 1111，用来获取写锁重入的次数")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"static"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"final"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," EXCLUSIVE_MASK "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," ("),t("span",{style:{color:"#005CC5"}},"1"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"<<"),t("span",{style:{color:"#24292E"}}," SHARED_SHIFT) "),t("span",{style:{color:"#D73A49"}},"-"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"1"),t("span",{style:{color:"#24292E"}},";")])])]),t("button",{class:"collapse"})])]),t("li",null,[t("p",null,"获取读写锁的次数："),t("div",{style:{"max-height":"300px"},class:"language-java"},[t("button",{title:"Copy Code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki github-dark vp-code-dark"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// 获取读写锁的读锁分配的总次数")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"static"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"sharedCount"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," c)    { "),t("span",{style:{color:"#F97583"}},"return"),t("span",{style:{color:"#E1E4E8"}}," c "),t("span",{style:{color:"#F97583"}},">>>"),t("span",{style:{color:"#E1E4E8"}}," SHARED_SHIFT; }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// 写锁（独占）锁的重入次数")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"static"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"exclusiveCount"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," c) { "),t("span",{style:{color:"#F97583"}},"return"),t("span",{style:{color:"#E1E4E8"}}," c "),t("span",{style:{color:"#F97583"}},"&"),t("span",{style:{color:"#E1E4E8"}}," EXCLUSIVE_MASK; }")])])]),t("pre",{class:"shiki github-light vp-code-light"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// 获取读写锁的读锁分配的总次数")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"static"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"sharedCount"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," c)    { "),t("span",{style:{color:"#D73A49"}},"return"),t("span",{style:{color:"#24292E"}}," c "),t("span",{style:{color:"#D73A49"}},">>>"),t("span",{style:{color:"#24292E"}}," SHARED_SHIFT; }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// 写锁（独占）锁的重入次数")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"static"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"exclusiveCount"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," c) { "),t("span",{style:{color:"#D73A49"}},"return"),t("span",{style:{color:"#24292E"}}," c "),t("span",{style:{color:"#D73A49"}},"&"),t("span",{style:{color:"#24292E"}}," EXCLUSIVE_MASK; }")])])]),t("button",{class:"collapse"})])]),t("li",null,[t("p",null,"内部类："),t("div",{style:{"max-height":"300px"},class:"language-java"},[t("button",{title:"Copy Code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki github-dark vp-code-dark"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// 记录读锁线程自己的持有读锁的数量（重入次数），因为 state 高16位记录的是全局范围内所有的读线程获取读锁的总量")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"static"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"final"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"class"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"HoldCounter"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," count "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"0"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// Use id, not reference, to avoid garbage retention")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"final"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"long"),t("span",{style:{color:"#E1E4E8"}}," tid "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"getThreadId"),t("span",{style:{color:"#E1E4E8"}},"(Thread."),t("span",{style:{color:"#B392F0"}},"currentThread"),t("span",{style:{color:"#E1E4E8"}},"());")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"}")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// 线程安全的存放线程各自的 HoldCounter 对象")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"static"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"final"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"class"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"ThreadLocalHoldCounter"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"extends"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"ThreadLocal"),t("span",{style:{color:"#E1E4E8"}},"<"),t("span",{style:{color:"#F97583"}},"HoldCounter"),t("span",{style:{color:"#E1E4E8"}},"> {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"public"),t("span",{style:{color:"#E1E4E8"}}," HoldCounter "),t("span",{style:{color:"#B392F0"}},"initialValue"),t("span",{style:{color:"#E1E4E8"}},"() {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"return"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"new"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"HoldCounter"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"}")])])]),t("pre",{class:"shiki github-light vp-code-light"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// 记录读锁线程自己的持有读锁的数量（重入次数），因为 state 高16位记录的是全局范围内所有的读线程获取读锁的总量")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"static"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"final"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"class"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"HoldCounter"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," count "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"0"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// Use id, not reference, to avoid garbage retention")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"final"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"long"),t("span",{style:{color:"#24292E"}}," tid "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"getThreadId"),t("span",{style:{color:"#24292E"}},"(Thread."),t("span",{style:{color:"#6F42C1"}},"currentThread"),t("span",{style:{color:"#24292E"}},"());")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"}")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// 线程安全的存放线程各自的 HoldCounter 对象")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"static"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"final"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"class"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"ThreadLocalHoldCounter"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"extends"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"ThreadLocal"),t("span",{style:{color:"#24292E"}},"<"),t("span",{style:{color:"#D73A49"}},"HoldCounter"),t("span",{style:{color:"#24292E"}},"> {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"public"),t("span",{style:{color:"#24292E"}}," HoldCounter "),t("span",{style:{color:"#6F42C1"}},"initialValue"),t("span",{style:{color:"#24292E"}},"() {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"return"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"new"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"HoldCounter"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"}")])])]),t("button",{class:"collapse"})])]),t("li",null,[t("p",null,"内部类实例："),t("div",{style:{"max-height":"300px"},class:"language-java"},[t("button",{title:"Copy Code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki github-dark vp-code-dark"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// 当前线程持有的可重入读锁的数量，计数为 0 时删除")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"private"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"transient"),t("span",{style:{color:"#E1E4E8"}}," ThreadLocalHoldCounter readHolds;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// 记录最后一个获取【读锁】线程的 HoldCounter 对象")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"private"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"transient"),t("span",{style:{color:"#E1E4E8"}}," HoldCounter cachedHoldCounter;")])])]),t("pre",{class:"shiki github-light vp-code-light"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// 当前线程持有的可重入读锁的数量，计数为 0 时删除")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"private"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"transient"),t("span",{style:{color:"#24292E"}}," ThreadLocalHoldCounter readHolds;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// 记录最后一个获取【读锁】线程的 HoldCounter 对象")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"private"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"transient"),t("span",{style:{color:"#24292E"}}," HoldCounter cachedHoldCounter;")])])]),t("button",{class:"collapse"})])]),t("li",null,[t("p",null,"首次获取锁："),t("div",{style:{"max-height":"300px"},class:"language-java"},[t("button",{title:"Copy Code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki github-dark vp-code-dark"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// 第一个获取读锁的线程")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"private"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"transient"),t("span",{style:{color:"#E1E4E8"}}," Thread firstReader "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"null"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// 记录该线程持有的读锁次数（读锁重入次数）")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"private"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"transient"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," firstReaderHoldCount;")])])]),t("pre",{class:"shiki github-light vp-code-light"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// 第一个获取读锁的线程")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"private"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"transient"),t("span",{style:{color:"#24292E"}}," Thread firstReader "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"null"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// 记录该线程持有的读锁次数（读锁重入次数）")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"private"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"transient"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," firstReaderHoldCount;")])])]),t("button",{class:"collapse"})])]),t("li",null,[t("p",null,"Sync 构造方法："),t("div",{style:{"max-height":"300px"},class:"language-java"},[t("button",{title:"Copy Code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki github-dark vp-code-dark"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#B392F0"}},"Sync"),t("span",{style:{color:"#E1E4E8"}},"() {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    readHolds "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"new"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"ThreadLocalHoldCounter"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// 确保其他线程的数据可见性，state 是 volatile 修饰的变量，重写该值会将线程本地缓存数据【同步至主存】")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#B392F0"}},"setState"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#B392F0"}},"getState"),t("span",{style:{color:"#E1E4E8"}},"()); ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"}")])])]),t("pre",{class:"shiki github-light vp-code-light"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#6F42C1"}},"Sync"),t("span",{style:{color:"#24292E"}},"() {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    readHolds "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"new"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"ThreadLocalHoldCounter"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// 确保其他线程的数据可见性，state 是 volatile 修饰的变量，重写该值会将线程本地缓存数据【同步至主存】")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6F42C1"}},"setState"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#6F42C1"}},"getState"),t("span",{style:{color:"#24292E"}},"()); ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"}")])])]),t("button",{class:"collapse"})])])],-1),no=t("hr",null,null,-1),ao={id:"加锁原理",tabindex:"-1"},eo=t("ul",null,[t("li",null,[t("p",null,[p("t1 线程：w.lock（"),t("strong",null,"写锁"),p("），成功上锁 state = 0_1")]),t("div",{style:{"max-height":"300px"},class:"language-java"},[t("button",{title:"Copy Code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki github-dark vp-code-dark"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// lock()  -> sync.acquire(1);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"public"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"void"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"lock"),t("span",{style:{color:"#E1E4E8"}},"() {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    sync."),t("span",{style:{color:"#B392F0"}},"acquire"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#79B8FF"}},"1"),t("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"}")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"public"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"final"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"void"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"acquire"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," arg) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// 尝试获得写锁，获得写锁失败，将当前线程关联到一个 Node 对象上, 模式为独占模式 ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," ("),t("span",{style:{color:"#F97583"}},"!"),t("span",{style:{color:"#B392F0"}},"tryAcquire"),t("span",{style:{color:"#E1E4E8"}},"(arg) "),t("span",{style:{color:"#F97583"}},"&&"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"acquireQueued"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#B392F0"}},"addWaiter"),t("span",{style:{color:"#E1E4E8"}},"(Node.EXCLUSIVE), arg))")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#B392F0"}},"selfInterrupt"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"}")])])]),t("pre",{class:"shiki github-light vp-code-light"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// lock()  -> sync.acquire(1);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"public"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"void"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"lock"),t("span",{style:{color:"#24292E"}},"() {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    sync."),t("span",{style:{color:"#6F42C1"}},"acquire"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#005CC5"}},"1"),t("span",{style:{color:"#24292E"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"}")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"public"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"final"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"void"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"acquire"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," arg) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// 尝试获得写锁，获得写锁失败，将当前线程关联到一个 Node 对象上, 模式为独占模式 ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," ("),t("span",{style:{color:"#D73A49"}},"!"),t("span",{style:{color:"#6F42C1"}},"tryAcquire"),t("span",{style:{color:"#24292E"}},"(arg) "),t("span",{style:{color:"#D73A49"}},"&&"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"acquireQueued"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#6F42C1"}},"addWaiter"),t("span",{style:{color:"#24292E"}},"(Node.EXCLUSIVE), arg))")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6F42C1"}},"selfInterrupt"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"}")])])]),t("button",{class:"collapse"})]),t("div",{style:{"max-height":"300px"},class:"language-java"},[t("button",{title:"Copy Code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki github-dark vp-code-dark"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"protected"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"final"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"boolean"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"tryAcquire"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," acquires) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    Thread current "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," Thread."),t("span",{style:{color:"#B392F0"}},"currentThread"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," c "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"getState"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// 获得低 16 位, 代表写锁的 state 计数")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," w "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"exclusiveCount"),t("span",{style:{color:"#E1E4E8"}},"(c);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// 说明有读锁或者写锁")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (c "),t("span",{style:{color:"#F97583"}},"!="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"0"),t("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#6A737D"}},"// c != 0 and w == 0 表示有读锁，【读锁不能升级】，直接返回 false")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#6A737D"}},"// w != 0 说明有写锁，写锁的拥有者不是自己，获取失败")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (w "),t("span",{style:{color:"#F97583"}},"=="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"0"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"||"),t("span",{style:{color:"#E1E4E8"}}," current "),t("span",{style:{color:"#F97583"}},"!="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"getExclusiveOwnerThread"),t("span",{style:{color:"#E1E4E8"}},"())")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"return"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"false"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#6A737D"}},"// 执行到这里只有一种情况：【写锁重入】，所以下面几行代码不存在并发")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (w "),t("span",{style:{color:"#F97583"}},"+"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"exclusiveCount"),t("span",{style:{color:"#E1E4E8"}},"(acquires) "),t("span",{style:{color:"#F97583"}},">"),t("span",{style:{color:"#E1E4E8"}}," MAX_COUNT)")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"throw"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"new"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"Error"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#9ECBFF"}},'"Maximum lock count exceeded"'),t("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#6A737D"}},"// 写锁重入, 获得锁成功，没有并发，所以不使用 CAS")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#B392F0"}},"setState"),t("span",{style:{color:"#E1E4E8"}},"(c "),t("span",{style:{color:"#F97583"}},"+"),t("span",{style:{color:"#E1E4E8"}}," acquires);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"return"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"true"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// c == 0，说明没有任何锁，判断写锁是否该阻塞，是 false 就尝试获取锁，失败返回 false")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," ("),t("span",{style:{color:"#B392F0"}},"writerShouldBlock"),t("span",{style:{color:"#E1E4E8"}},"() "),t("span",{style:{color:"#F97583"}},"||"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"!"),t("span",{style:{color:"#B392F0"}},"compareAndSetState"),t("span",{style:{color:"#E1E4E8"}},"(c, c "),t("span",{style:{color:"#F97583"}},"+"),t("span",{style:{color:"#E1E4E8"}}," acquires))")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"return"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"false"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// 获得锁成功，设置锁的持有线程为当前线程")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#B392F0"}},"setExclusiveOwnerThread"),t("span",{style:{color:"#E1E4E8"}},"(current);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"return"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"true"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"}")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// 非公平锁 writerShouldBlock 总是返回 false, 无需阻塞")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"final"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"boolean"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"writerShouldBlock"),t("span",{style:{color:"#E1E4E8"}},"() {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"return"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"false"),t("span",{style:{color:"#E1E4E8"}},"; ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"}")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// 公平锁会检查 AQS 队列中是否有前驱节点, 没有(false)才去竞争")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"final"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"boolean"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"writerShouldBlock"),t("span",{style:{color:"#E1E4E8"}},"() {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"return"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"hasQueuedPredecessors"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"}")])])]),t("pre",{class:"shiki github-light vp-code-light"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"protected"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"final"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"boolean"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"tryAcquire"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," acquires) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    Thread current "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," Thread."),t("span",{style:{color:"#6F42C1"}},"currentThread"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," c "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"getState"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// 获得低 16 位, 代表写锁的 state 计数")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," w "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"exclusiveCount"),t("span",{style:{color:"#24292E"}},"(c);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// 说明有读锁或者写锁")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (c "),t("span",{style:{color:"#D73A49"}},"!="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"0"),t("span",{style:{color:"#24292E"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6A737D"}},"// c != 0 and w == 0 表示有读锁，【读锁不能升级】，直接返回 false")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6A737D"}},"// w != 0 说明有写锁，写锁的拥有者不是自己，获取失败")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (w "),t("span",{style:{color:"#D73A49"}},"=="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"0"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"||"),t("span",{style:{color:"#24292E"}}," current "),t("span",{style:{color:"#D73A49"}},"!="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"getExclusiveOwnerThread"),t("span",{style:{color:"#24292E"}},"())")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"return"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"false"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6A737D"}},"// 执行到这里只有一种情况：【写锁重入】，所以下面几行代码不存在并发")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (w "),t("span",{style:{color:"#D73A49"}},"+"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"exclusiveCount"),t("span",{style:{color:"#24292E"}},"(acquires) "),t("span",{style:{color:"#D73A49"}},">"),t("span",{style:{color:"#24292E"}}," MAX_COUNT)")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"throw"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"new"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"Error"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#032F62"}},'"Maximum lock count exceeded"'),t("span",{style:{color:"#24292E"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6A737D"}},"// 写锁重入, 获得锁成功，没有并发，所以不使用 CAS")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6F42C1"}},"setState"),t("span",{style:{color:"#24292E"}},"(c "),t("span",{style:{color:"#D73A49"}},"+"),t("span",{style:{color:"#24292E"}}," acquires);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"return"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"true"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// c == 0，说明没有任何锁，判断写锁是否该阻塞，是 false 就尝试获取锁，失败返回 false")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," ("),t("span",{style:{color:"#6F42C1"}},"writerShouldBlock"),t("span",{style:{color:"#24292E"}},"() "),t("span",{style:{color:"#D73A49"}},"||"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"!"),t("span",{style:{color:"#6F42C1"}},"compareAndSetState"),t("span",{style:{color:"#24292E"}},"(c, c "),t("span",{style:{color:"#D73A49"}},"+"),t("span",{style:{color:"#24292E"}}," acquires))")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"return"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"false"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// 获得锁成功，设置锁的持有线程为当前线程")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6F42C1"}},"setExclusiveOwnerThread"),t("span",{style:{color:"#24292E"}},"(current);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"return"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"true"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"}")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// 非公平锁 writerShouldBlock 总是返回 false, 无需阻塞")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"final"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"boolean"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"writerShouldBlock"),t("span",{style:{color:"#24292E"}},"() {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"return"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"false"),t("span",{style:{color:"#24292E"}},"; ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"}")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// 公平锁会检查 AQS 队列中是否有前驱节点, 没有(false)才去竞争")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"final"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"boolean"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"writerShouldBlock"),t("span",{style:{color:"#24292E"}},"() {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"return"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"hasQueuedPredecessors"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"}")])])]),t("button",{class:"collapse"})])]),t("li",null,[t("p",null,[p("t2 r.lock（"),t("strong",null,"读锁"),p("），进入 tryAcquireShared 流程：")]),t("ul",null,[t("li",null,"返回 -1 表示失败"),t("li",null,"如果返回 0 表示成功"),t("li",null,"返回正数表示还有多少后继节点支持共享模式，读写锁返回 1")]),t("div",{style:{"max-height":"300px"},class:"language-java"},[t("button",{title:"Copy Code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki github-dark vp-code-dark"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"public"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"void"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"lock"),t("span",{style:{color:"#E1E4E8"}},"() {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    sync."),t("span",{style:{color:"#B392F0"}},"acquireShared"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#79B8FF"}},"1"),t("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"}")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"public"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"final"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"void"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"acquireShared"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," arg) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// tryAcquireShared 返回负数, 表示获取读锁失败")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," ("),t("span",{style:{color:"#B392F0"}},"tryAcquireShared"),t("span",{style:{color:"#E1E4E8"}},"(arg) "),t("span",{style:{color:"#F97583"}},"<"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"0"),t("span",{style:{color:"#E1E4E8"}},")")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#B392F0"}},"doAcquireShared"),t("span",{style:{color:"#E1E4E8"}},"(arg);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"}")])])]),t("pre",{class:"shiki github-light vp-code-light"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"public"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"void"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"lock"),t("span",{style:{color:"#24292E"}},"() {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    sync."),t("span",{style:{color:"#6F42C1"}},"acquireShared"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#005CC5"}},"1"),t("span",{style:{color:"#24292E"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"}")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"public"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"final"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"void"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"acquireShared"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," arg) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// tryAcquireShared 返回负数, 表示获取读锁失败")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," ("),t("span",{style:{color:"#6F42C1"}},"tryAcquireShared"),t("span",{style:{color:"#24292E"}},"(arg) "),t("span",{style:{color:"#D73A49"}},"<"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"0"),t("span",{style:{color:"#24292E"}},")")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6F42C1"}},"doAcquireShared"),t("span",{style:{color:"#24292E"}},"(arg);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"}")])])]),t("button",{class:"collapse"})]),t("div",{style:{"max-height":"300px"},class:"language-java"},[t("button",{title:"Copy Code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki github-dark vp-code-dark"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// 尝试以共享模式获取")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"protected"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"final"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"tryAcquireShared"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," unused) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    Thread current "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," Thread."),t("span",{style:{color:"#B392F0"}},"currentThread"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," c "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"getState"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// exclusiveCount(c) 代表低 16 位, 写锁的 state，成立说明有线程持有写锁")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// 写锁的持有者不是当前线程，则获取读锁失败，【写锁允许降级】")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," ("),t("span",{style:{color:"#B392F0"}},"exclusiveCount"),t("span",{style:{color:"#E1E4E8"}},"(c) "),t("span",{style:{color:"#F97583"}},"!="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"0"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"&&"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"getExclusiveOwnerThread"),t("span",{style:{color:"#E1E4E8"}},"() "),t("span",{style:{color:"#F97583"}},"!="),t("span",{style:{color:"#E1E4E8"}}," current)")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"return"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"-"),t("span",{style:{color:"#79B8FF"}},"1"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// 高 16 位，代表读锁的 state，共享锁分配出去的总次数")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," r "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"sharedCount"),t("span",{style:{color:"#E1E4E8"}},"(c);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// 读锁是否应该阻塞")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," ("),t("span",{style:{color:"#F97583"}},"!"),t("span",{style:{color:"#B392F0"}},"readerShouldBlock"),t("span",{style:{color:"#E1E4E8"}},"() "),t("span",{style:{color:"#F97583"}},"&&"),t("span",{style:{color:"#E1E4E8"}},"\tr "),t("span",{style:{color:"#F97583"}},"<"),t("span",{style:{color:"#E1E4E8"}}," MAX_COUNT "),t("span",{style:{color:"#F97583"}},"&&")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#B392F0"}},"compareAndSetState"),t("span",{style:{color:"#E1E4E8"}},"(c, c "),t("span",{style:{color:"#F97583"}},"+"),t("span",{style:{color:"#E1E4E8"}}," SHARED_UNIT)) {\t"),t("span",{style:{color:"#6A737D"}},"// 尝试增加读锁计数")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#6A737D"}},"// 加锁成功")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#6A737D"}},"// 加锁之前读锁为 0，说明当前线程是第一个读锁线程")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (r "),t("span",{style:{color:"#F97583"}},"=="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"0"),t("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            firstReader "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," current;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            firstReaderHoldCount "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"1"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#6A737D"}},"// 第一个读锁线程是自己就发生了读锁重入")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        } "),t("span",{style:{color:"#F97583"}},"else"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (firstReader "),t("span",{style:{color:"#F97583"}},"=="),t("span",{style:{color:"#E1E4E8"}}," current) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            firstReaderHoldCount"),t("span",{style:{color:"#F97583"}},"++"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        } "),t("span",{style:{color:"#F97583"}},"else"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#6A737D"}},"// cachedHoldCounter 设置为当前线程的 holdCounter 对象，即最后一个获取读锁的线程")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            HoldCounter rh "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," cachedHoldCounter;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#6A737D"}},"// 说明还没设置 rh")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (rh "),t("span",{style:{color:"#F97583"}},"=="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"null"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"||"),t("span",{style:{color:"#E1E4E8"}}," rh.tid "),t("span",{style:{color:"#F97583"}},"!="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"getThreadId"),t("span",{style:{color:"#E1E4E8"}},"(current))")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#6A737D"}},"// 获取当前线程的锁重入的对象，赋值给 cachedHoldCounter")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                cachedHoldCounter "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," rh "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," readHolds."),t("span",{style:{color:"#B392F0"}},"get"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#6A737D"}},"// 还没重入")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"else"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (rh.count "),t("span",{style:{color:"#F97583"}},"=="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"0"),t("span",{style:{color:"#E1E4E8"}},")")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                readHolds."),t("span",{style:{color:"#B392F0"}},"set"),t("span",{style:{color:"#E1E4E8"}},"(rh);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#6A737D"}},"// 重入 + 1")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            rh.count"),t("span",{style:{color:"#F97583"}},"++"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#6A737D"}},"// 读锁加锁成功")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"return"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"1"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// 逻辑到这 应该阻塞，或者 cas 加锁失败")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// 会不断尝试 for (;;) 获取读锁, 执行过程中无阻塞")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"return"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"fullTryAcquireShared"),t("span",{style:{color:"#E1E4E8"}},"(current);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"}")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// 非公平锁 readerShouldBlock 偏向写锁一些，看 AQS 阻塞队列中第一个节点是否是写锁，是则阻塞，反之不阻塞")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// 防止一直有读锁线程，导致写锁线程饥饿")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// true 则该阻塞, false 则不阻塞")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"final"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"boolean"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"readerShouldBlock"),t("span",{style:{color:"#E1E4E8"}},"() {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"return"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"apparentlyFirstQueuedIsExclusive"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"}")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"final"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"boolean"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"readerShouldBlock"),t("span",{style:{color:"#E1E4E8"}},"() {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"return"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"hasQueuedPredecessors"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"}")])])]),t("pre",{class:"shiki github-light vp-code-light"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// 尝试以共享模式获取")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"protected"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"final"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"tryAcquireShared"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," unused) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    Thread current "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," Thread."),t("span",{style:{color:"#6F42C1"}},"currentThread"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," c "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"getState"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// exclusiveCount(c) 代表低 16 位, 写锁的 state，成立说明有线程持有写锁")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// 写锁的持有者不是当前线程，则获取读锁失败，【写锁允许降级】")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," ("),t("span",{style:{color:"#6F42C1"}},"exclusiveCount"),t("span",{style:{color:"#24292E"}},"(c) "),t("span",{style:{color:"#D73A49"}},"!="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"0"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"&&"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"getExclusiveOwnerThread"),t("span",{style:{color:"#24292E"}},"() "),t("span",{style:{color:"#D73A49"}},"!="),t("span",{style:{color:"#24292E"}}," current)")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"return"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"-"),t("span",{style:{color:"#005CC5"}},"1"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// 高 16 位，代表读锁的 state，共享锁分配出去的总次数")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," r "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"sharedCount"),t("span",{style:{color:"#24292E"}},"(c);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// 读锁是否应该阻塞")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," ("),t("span",{style:{color:"#D73A49"}},"!"),t("span",{style:{color:"#6F42C1"}},"readerShouldBlock"),t("span",{style:{color:"#24292E"}},"() "),t("span",{style:{color:"#D73A49"}},"&&"),t("span",{style:{color:"#24292E"}},"\tr "),t("span",{style:{color:"#D73A49"}},"<"),t("span",{style:{color:"#24292E"}}," MAX_COUNT "),t("span",{style:{color:"#D73A49"}},"&&")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6F42C1"}},"compareAndSetState"),t("span",{style:{color:"#24292E"}},"(c, c "),t("span",{style:{color:"#D73A49"}},"+"),t("span",{style:{color:"#24292E"}}," SHARED_UNIT)) {\t"),t("span",{style:{color:"#6A737D"}},"// 尝试增加读锁计数")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6A737D"}},"// 加锁成功")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6A737D"}},"// 加锁之前读锁为 0，说明当前线程是第一个读锁线程")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (r "),t("span",{style:{color:"#D73A49"}},"=="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"0"),t("span",{style:{color:"#24292E"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            firstReader "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," current;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            firstReaderHoldCount "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"1"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6A737D"}},"// 第一个读锁线程是自己就发生了读锁重入")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        } "),t("span",{style:{color:"#D73A49"}},"else"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (firstReader "),t("span",{style:{color:"#D73A49"}},"=="),t("span",{style:{color:"#24292E"}}," current) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            firstReaderHoldCount"),t("span",{style:{color:"#D73A49"}},"++"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        } "),t("span",{style:{color:"#D73A49"}},"else"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#6A737D"}},"// cachedHoldCounter 设置为当前线程的 holdCounter 对象，即最后一个获取读锁的线程")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            HoldCounter rh "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," cachedHoldCounter;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#6A737D"}},"// 说明还没设置 rh")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (rh "),t("span",{style:{color:"#D73A49"}},"=="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"null"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"||"),t("span",{style:{color:"#24292E"}}," rh.tid "),t("span",{style:{color:"#D73A49"}},"!="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"getThreadId"),t("span",{style:{color:"#24292E"}},"(current))")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#6A737D"}},"// 获取当前线程的锁重入的对象，赋值给 cachedHoldCounter")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                cachedHoldCounter "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," rh "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," readHolds."),t("span",{style:{color:"#6F42C1"}},"get"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#6A737D"}},"// 还没重入")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"else"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (rh.count "),t("span",{style:{color:"#D73A49"}},"=="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"0"),t("span",{style:{color:"#24292E"}},")")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                readHolds."),t("span",{style:{color:"#6F42C1"}},"set"),t("span",{style:{color:"#24292E"}},"(rh);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#6A737D"}},"// 重入 + 1")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            rh.count"),t("span",{style:{color:"#D73A49"}},"++"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6A737D"}},"// 读锁加锁成功")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"return"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"1"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// 逻辑到这 应该阻塞，或者 cas 加锁失败")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// 会不断尝试 for (;;) 获取读锁, 执行过程中无阻塞")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"return"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"fullTryAcquireShared"),t("span",{style:{color:"#24292E"}},"(current);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"}")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// 非公平锁 readerShouldBlock 偏向写锁一些，看 AQS 阻塞队列中第一个节点是否是写锁，是则阻塞，反之不阻塞")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// 防止一直有读锁线程，导致写锁线程饥饿")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// true 则该阻塞, false 则不阻塞")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"final"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"boolean"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"readerShouldBlock"),t("span",{style:{color:"#24292E"}},"() {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"return"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"apparentlyFirstQueuedIsExclusive"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"}")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"final"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"boolean"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"readerShouldBlock"),t("span",{style:{color:"#24292E"}},"() {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"return"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"hasQueuedPredecessors"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"}")])])]),t("button",{class:"collapse"})]),t("div",{style:{"max-height":"300px"},class:"language-java"},[t("button",{title:"Copy Code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki github-dark vp-code-dark"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"final"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"fullTryAcquireShared"),t("span",{style:{color:"#E1E4E8"}},"(Thread current) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// 当前读锁线程持有的读锁次数对象")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    HoldCounter rh "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"null"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"for"),t("span",{style:{color:"#E1E4E8"}}," (;;) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," c "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"getState"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#6A737D"}},"// 说明有线程持有写锁")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," ("),t("span",{style:{color:"#B392F0"}},"exclusiveCount"),t("span",{style:{color:"#E1E4E8"}},"(c) "),t("span",{style:{color:"#F97583"}},"!="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"0"),t("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#6A737D"}},"// 写锁不是自己则获取锁失败")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," ("),t("span",{style:{color:"#B392F0"}},"getExclusiveOwnerThread"),t("span",{style:{color:"#E1E4E8"}},"() "),t("span",{style:{color:"#F97583"}},"!="),t("span",{style:{color:"#E1E4E8"}}," current)")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#F97583"}},"return"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"-"),t("span",{style:{color:"#79B8FF"}},"1"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        } "),t("span",{style:{color:"#F97583"}},"else"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," ("),t("span",{style:{color:"#B392F0"}},"readerShouldBlock"),t("span",{style:{color:"#E1E4E8"}},"()) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#6A737D"}},"// 条件成立说明当前线程是 firstReader，当前锁是读忙碌状态，而且当前线程也是读锁重入")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (firstReader "),t("span",{style:{color:"#F97583"}},"=="),t("span",{style:{color:"#E1E4E8"}}," current) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#6A737D"}},"// assert firstReaderHoldCount > 0;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            } "),t("span",{style:{color:"#F97583"}},"else"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (rh "),t("span",{style:{color:"#F97583"}},"=="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"null"),t("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                    "),t("span",{style:{color:"#6A737D"}},"// 最后一个读锁的 HoldCounter")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                    rh "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," cachedHoldCounter;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                    "),t("span",{style:{color:"#6A737D"}},"// 说明当前线程也不是最后一个读锁")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                    "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (rh "),t("span",{style:{color:"#F97583"}},"=="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"null"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"||"),t("span",{style:{color:"#E1E4E8"}}," rh.tid "),t("span",{style:{color:"#F97583"}},"!="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"getThreadId"),t("span",{style:{color:"#E1E4E8"}},"(current)) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                        "),t("span",{style:{color:"#6A737D"}},"// 获取当前线程的 HoldCounter")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                        rh "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," readHolds."),t("span",{style:{color:"#B392F0"}},"get"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                        "),t("span",{style:{color:"#6A737D"}},"// 条件成立说明 HoldCounter 对象是上一步代码新建的")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                        "),t("span",{style:{color:"#6A737D"}},"// 当前线程不是锁重入，在 readerShouldBlock() 返回 true 时需要去排队")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                        "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (rh.count "),t("span",{style:{color:"#F97583"}},"=="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"0"),t("span",{style:{color:"#E1E4E8"}},")")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                            "),t("span",{style:{color:"#6A737D"}},"// 防止内存泄漏")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                            readHolds."),t("span",{style:{color:"#B392F0"}},"remove"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (rh.count "),t("span",{style:{color:"#F97583"}},"=="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"0"),t("span",{style:{color:"#E1E4E8"}},")")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                    "),t("span",{style:{color:"#F97583"}},"return"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"-"),t("span",{style:{color:"#79B8FF"}},"1"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#6A737D"}},"// 越界判断")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," ("),t("span",{style:{color:"#B392F0"}},"sharedCount"),t("span",{style:{color:"#E1E4E8"}},"(c) "),t("span",{style:{color:"#F97583"}},"=="),t("span",{style:{color:"#E1E4E8"}}," MAX_COUNT)")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"throw"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"new"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"Error"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#9ECBFF"}},'"Maximum lock count exceeded"'),t("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#6A737D"}},"// 读锁加锁，条件内的逻辑与 tryAcquireShared 相同")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," ("),t("span",{style:{color:"#B392F0"}},"compareAndSetState"),t("span",{style:{color:"#E1E4E8"}},"(c, c "),t("span",{style:{color:"#F97583"}},"+"),t("span",{style:{color:"#E1E4E8"}}," SHARED_UNIT)) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," ("),t("span",{style:{color:"#B392F0"}},"sharedCount"),t("span",{style:{color:"#E1E4E8"}},"(c) "),t("span",{style:{color:"#F97583"}},"=="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"0"),t("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                firstReader "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," current;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                firstReaderHoldCount "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"1"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            } "),t("span",{style:{color:"#F97583"}},"else"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (firstReader "),t("span",{style:{color:"#F97583"}},"=="),t("span",{style:{color:"#E1E4E8"}}," current) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                firstReaderHoldCount"),t("span",{style:{color:"#F97583"}},"++"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            } "),t("span",{style:{color:"#F97583"}},"else"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (rh "),t("span",{style:{color:"#F97583"}},"=="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"null"),t("span",{style:{color:"#E1E4E8"}},")")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                    rh "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," cachedHoldCounter;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (rh "),t("span",{style:{color:"#F97583"}},"=="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"null"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"||"),t("span",{style:{color:"#E1E4E8"}}," rh.tid "),t("span",{style:{color:"#F97583"}},"!="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"getThreadId"),t("span",{style:{color:"#E1E4E8"}},"(current))")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                    rh "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," readHolds."),t("span",{style:{color:"#B392F0"}},"get"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#F97583"}},"else"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (rh.count "),t("span",{style:{color:"#F97583"}},"=="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"0"),t("span",{style:{color:"#E1E4E8"}},")")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                    readHolds."),t("span",{style:{color:"#B392F0"}},"set"),t("span",{style:{color:"#E1E4E8"}},"(rh);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                rh.count"),t("span",{style:{color:"#F97583"}},"++"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                cachedHoldCounter "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," rh; "),t("span",{style:{color:"#6A737D"}},"// cache for release")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"return"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"1"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"}")])])]),t("pre",{class:"shiki github-light vp-code-light"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"final"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"fullTryAcquireShared"),t("span",{style:{color:"#24292E"}},"(Thread current) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// 当前读锁线程持有的读锁次数对象")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    HoldCounter rh "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"null"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"for"),t("span",{style:{color:"#24292E"}}," (;;) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," c "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"getState"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6A737D"}},"// 说明有线程持有写锁")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," ("),t("span",{style:{color:"#6F42C1"}},"exclusiveCount"),t("span",{style:{color:"#24292E"}},"(c) "),t("span",{style:{color:"#D73A49"}},"!="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"0"),t("span",{style:{color:"#24292E"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#6A737D"}},"// 写锁不是自己则获取锁失败")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," ("),t("span",{style:{color:"#6F42C1"}},"getExclusiveOwnerThread"),t("span",{style:{color:"#24292E"}},"() "),t("span",{style:{color:"#D73A49"}},"!="),t("span",{style:{color:"#24292E"}}," current)")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#D73A49"}},"return"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"-"),t("span",{style:{color:"#005CC5"}},"1"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        } "),t("span",{style:{color:"#D73A49"}},"else"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," ("),t("span",{style:{color:"#6F42C1"}},"readerShouldBlock"),t("span",{style:{color:"#24292E"}},"()) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#6A737D"}},"// 条件成立说明当前线程是 firstReader，当前锁是读忙碌状态，而且当前线程也是读锁重入")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (firstReader "),t("span",{style:{color:"#D73A49"}},"=="),t("span",{style:{color:"#24292E"}}," current) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#6A737D"}},"// assert firstReaderHoldCount > 0;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            } "),t("span",{style:{color:"#D73A49"}},"else"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (rh "),t("span",{style:{color:"#D73A49"}},"=="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"null"),t("span",{style:{color:"#24292E"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                    "),t("span",{style:{color:"#6A737D"}},"// 最后一个读锁的 HoldCounter")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                    rh "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," cachedHoldCounter;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                    "),t("span",{style:{color:"#6A737D"}},"// 说明当前线程也不是最后一个读锁")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                    "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (rh "),t("span",{style:{color:"#D73A49"}},"=="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"null"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"||"),t("span",{style:{color:"#24292E"}}," rh.tid "),t("span",{style:{color:"#D73A49"}},"!="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"getThreadId"),t("span",{style:{color:"#24292E"}},"(current)) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                        "),t("span",{style:{color:"#6A737D"}},"// 获取当前线程的 HoldCounter")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                        rh "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," readHolds."),t("span",{style:{color:"#6F42C1"}},"get"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                        "),t("span",{style:{color:"#6A737D"}},"// 条件成立说明 HoldCounter 对象是上一步代码新建的")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                        "),t("span",{style:{color:"#6A737D"}},"// 当前线程不是锁重入，在 readerShouldBlock() 返回 true 时需要去排队")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                        "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (rh.count "),t("span",{style:{color:"#D73A49"}},"=="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"0"),t("span",{style:{color:"#24292E"}},")")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                            "),t("span",{style:{color:"#6A737D"}},"// 防止内存泄漏")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                            readHolds."),t("span",{style:{color:"#6F42C1"}},"remove"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (rh.count "),t("span",{style:{color:"#D73A49"}},"=="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"0"),t("span",{style:{color:"#24292E"}},")")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                    "),t("span",{style:{color:"#D73A49"}},"return"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"-"),t("span",{style:{color:"#005CC5"}},"1"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6A737D"}},"// 越界判断")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," ("),t("span",{style:{color:"#6F42C1"}},"sharedCount"),t("span",{style:{color:"#24292E"}},"(c) "),t("span",{style:{color:"#D73A49"}},"=="),t("span",{style:{color:"#24292E"}}," MAX_COUNT)")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"throw"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"new"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"Error"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#032F62"}},'"Maximum lock count exceeded"'),t("span",{style:{color:"#24292E"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6A737D"}},"// 读锁加锁，条件内的逻辑与 tryAcquireShared 相同")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," ("),t("span",{style:{color:"#6F42C1"}},"compareAndSetState"),t("span",{style:{color:"#24292E"}},"(c, c "),t("span",{style:{color:"#D73A49"}},"+"),t("span",{style:{color:"#24292E"}}," SHARED_UNIT)) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," ("),t("span",{style:{color:"#6F42C1"}},"sharedCount"),t("span",{style:{color:"#24292E"}},"(c) "),t("span",{style:{color:"#D73A49"}},"=="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"0"),t("span",{style:{color:"#24292E"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                firstReader "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," current;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                firstReaderHoldCount "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"1"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            } "),t("span",{style:{color:"#D73A49"}},"else"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (firstReader "),t("span",{style:{color:"#D73A49"}},"=="),t("span",{style:{color:"#24292E"}}," current) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                firstReaderHoldCount"),t("span",{style:{color:"#D73A49"}},"++"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            } "),t("span",{style:{color:"#D73A49"}},"else"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (rh "),t("span",{style:{color:"#D73A49"}},"=="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"null"),t("span",{style:{color:"#24292E"}},")")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                    rh "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," cachedHoldCounter;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (rh "),t("span",{style:{color:"#D73A49"}},"=="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"null"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"||"),t("span",{style:{color:"#24292E"}}," rh.tid "),t("span",{style:{color:"#D73A49"}},"!="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"getThreadId"),t("span",{style:{color:"#24292E"}},"(current))")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                    rh "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," readHolds."),t("span",{style:{color:"#6F42C1"}},"get"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#D73A49"}},"else"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (rh.count "),t("span",{style:{color:"#D73A49"}},"=="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"0"),t("span",{style:{color:"#24292E"}},")")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                    readHolds."),t("span",{style:{color:"#6F42C1"}},"set"),t("span",{style:{color:"#24292E"}},"(rh);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                rh.count"),t("span",{style:{color:"#D73A49"}},"++"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                cachedHoldCounter "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," rh; "),t("span",{style:{color:"#6A737D"}},"// cache for release")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"return"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"1"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"}")])])]),t("button",{class:"collapse"})])]),t("li",null,[t("p",null,[p("获取读锁失败，进入 "),t("code",null,"sync.doAcquireShared(1)"),p(" 流程开始阻塞，首先也是调用 addWaiter 添加节点，不同之处在于节点被设置为 "),t("code",null,"Node.SHARED"),p(" 模式而非 "),t("code",null,"Node.EXCLUSIVE"),p(" 模式，注意此时 t2 仍处于活跃状态")]),t("div",{style:{"max-height":"300px"},class:"language-java"},[t("button",{title:"Copy Code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki github-dark vp-code-dark"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"private"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"void"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"doAcquireShared"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," arg) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// 将当前线程关联到一个 Node 对象上, 模式为共享模式")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"final"),t("span",{style:{color:"#E1E4E8"}}," Node node "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"addWaiter"),t("span",{style:{color:"#E1E4E8"}},"(Node.SHARED);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"boolean"),t("span",{style:{color:"#E1E4E8"}}," failed "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"true"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"try"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"boolean"),t("span",{style:{color:"#E1E4E8"}}," interrupted "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"false"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"for"),t("span",{style:{color:"#E1E4E8"}}," (;;) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#6A737D"}},"// 获取前驱节点")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"final"),t("span",{style:{color:"#E1E4E8"}}," Node p "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," node."),t("span",{style:{color:"#B392F0"}},"predecessor"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#6A737D"}},"// 如果前驱节点就头节点就去尝试获取锁")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (p "),t("span",{style:{color:"#F97583"}},"=="),t("span",{style:{color:"#E1E4E8"}}," head) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#6A737D"}},"// 再一次尝试获取读锁")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," r "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"tryAcquireShared"),t("span",{style:{color:"#E1E4E8"}},"(arg);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#6A737D"}},"// r >= 0 表示获取成功")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (r "),t("span",{style:{color:"#F97583"}},">="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"0"),t("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                    "),t("span",{style:{color:"#6A737D"}},"//【这里会设置自己为头节点，唤醒相连的后序的共享节点】")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                    "),t("span",{style:{color:"#B392F0"}},"setHeadAndPropagate"),t("span",{style:{color:"#E1E4E8"}},"(node, r);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                    p.next "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"null"),t("span",{style:{color:"#E1E4E8"}},"; "),t("span",{style:{color:"#6A737D"}},"// help GC")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                    "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (interrupted)")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                        "),t("span",{style:{color:"#B392F0"}},"selfInterrupt"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                    failed "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"false"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                    "),t("span",{style:{color:"#F97583"}},"return"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#6A737D"}},"// 是否在获取读锁失败时阻塞      \t\t\t\t\t park 当前线程")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," ("),t("span",{style:{color:"#B392F0"}},"shouldParkAfterFailedAcquire"),t("span",{style:{color:"#E1E4E8"}},"(p, node) "),t("span",{style:{color:"#F97583"}},"&&"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"parkAndCheckInterrupt"),t("span",{style:{color:"#E1E4E8"}},"())")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                interrupted "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"true"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    } "),t("span",{style:{color:"#F97583"}},"finally"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (failed)")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#B392F0"}},"cancelAcquire"),t("span",{style:{color:"#E1E4E8"}},"(node);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"}")])])]),t("pre",{class:"shiki github-light vp-code-light"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"private"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"void"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"doAcquireShared"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," arg) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// 将当前线程关联到一个 Node 对象上, 模式为共享模式")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"final"),t("span",{style:{color:"#24292E"}}," Node node "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"addWaiter"),t("span",{style:{color:"#24292E"}},"(Node.SHARED);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"boolean"),t("span",{style:{color:"#24292E"}}," failed "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"true"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"try"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"boolean"),t("span",{style:{color:"#24292E"}}," interrupted "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"false"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"for"),t("span",{style:{color:"#24292E"}}," (;;) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#6A737D"}},"// 获取前驱节点")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"final"),t("span",{style:{color:"#24292E"}}," Node p "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," node."),t("span",{style:{color:"#6F42C1"}},"predecessor"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#6A737D"}},"// 如果前驱节点就头节点就去尝试获取锁")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (p "),t("span",{style:{color:"#D73A49"}},"=="),t("span",{style:{color:"#24292E"}}," head) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#6A737D"}},"// 再一次尝试获取读锁")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," r "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"tryAcquireShared"),t("span",{style:{color:"#24292E"}},"(arg);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#6A737D"}},"// r >= 0 表示获取成功")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (r "),t("span",{style:{color:"#D73A49"}},">="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"0"),t("span",{style:{color:"#24292E"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                    "),t("span",{style:{color:"#6A737D"}},"//【这里会设置自己为头节点，唤醒相连的后序的共享节点】")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                    "),t("span",{style:{color:"#6F42C1"}},"setHeadAndPropagate"),t("span",{style:{color:"#24292E"}},"(node, r);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                    p.next "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"null"),t("span",{style:{color:"#24292E"}},"; "),t("span",{style:{color:"#6A737D"}},"// help GC")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                    "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (interrupted)")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                        "),t("span",{style:{color:"#6F42C1"}},"selfInterrupt"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                    failed "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"false"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                    "),t("span",{style:{color:"#D73A49"}},"return"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#6A737D"}},"// 是否在获取读锁失败时阻塞      \t\t\t\t\t park 当前线程")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," ("),t("span",{style:{color:"#6F42C1"}},"shouldParkAfterFailedAcquire"),t("span",{style:{color:"#24292E"}},"(p, node) "),t("span",{style:{color:"#D73A49"}},"&&"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"parkAndCheckInterrupt"),t("span",{style:{color:"#24292E"}},"())")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                interrupted "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"true"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    } "),t("span",{style:{color:"#D73A49"}},"finally"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (failed)")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#6F42C1"}},"cancelAcquire"),t("span",{style:{color:"#24292E"}},"(node);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"}")])])]),t("button",{class:"collapse"})]),t("p",null,[p("如果没有成功，在 doAcquireShared 内 "),t("code",null,"for (;;)"),p(" 循环一次，shouldParkAfterFailedAcquire 内把前驱节点的 waitStatus 改为 -1，再 for (;😉 循环一次尝试 tryAcquireShared，不成功在 parkAndCheckInterrupt() 处 park")]),t("img",{src:"https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230719190714986.png",alt:"image-20230719190714986",style:{zoom:"50%"}})]),t("li",null,[t("p",null,[p("这种状态下，假设又有 "),t("code",null,"t3 r.lock"),p("，"),t("code",null,"t4 w.lock"),p("，这期间 t1 仍然持有锁，就变成了下面的样子")]),t("img",{src:"https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230719192612370.png",alt:"image-20230719192612370",style:{zoom:"80%"}})])],-1),co=t("hr",null,null,-1),to={id:"解锁原理",tabindex:"-1"},po=t("ul",null,[t("li",null,[t("p",null,[p("t1 "),t("code",null,"w.unlock"),p("， 写锁解锁")]),t("div",{style:{"max-height":"300px"},class:"language-java"},[t("button",{title:"Copy Code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki github-dark vp-code-dark"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"public"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"void"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"unlock"),t("span",{style:{color:"#E1E4E8"}},"() {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// 释放锁")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    sync."),t("span",{style:{color:"#B392F0"}},"release"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#79B8FF"}},"1"),t("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"}")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"public"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"final"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"boolean"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"release"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," arg) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// 尝试释放锁")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," ("),t("span",{style:{color:"#B392F0"}},"tryRelease"),t("span",{style:{color:"#E1E4E8"}},"(arg)) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        Node h "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," head;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#6A737D"}},"// 头节点不为空并且不是等待状态不是 0，唤醒后继的非取消节点")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (h "),t("span",{style:{color:"#F97583"}},"!="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"null"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"&&"),t("span",{style:{color:"#E1E4E8"}}," h.waitStatus "),t("span",{style:{color:"#F97583"}},"!="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"0"),t("span",{style:{color:"#E1E4E8"}},")")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#B392F0"}},"unparkSuccessor"),t("span",{style:{color:"#E1E4E8"}},"(h);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"return"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"true"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"return"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"false"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"}")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"protected"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"final"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"boolean"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"tryRelease"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," releases) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," ("),t("span",{style:{color:"#F97583"}},"!"),t("span",{style:{color:"#B392F0"}},"isHeldExclusively"),t("span",{style:{color:"#E1E4E8"}},"())")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"throw"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"new"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"IllegalMonitorStateException"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," nextc "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"getState"),t("span",{style:{color:"#E1E4E8"}},"() "),t("span",{style:{color:"#F97583"}},"-"),t("span",{style:{color:"#E1E4E8"}}," releases;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// 因为可重入的原因, 写锁计数为 0, 才算释放成功")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"boolean"),t("span",{style:{color:"#E1E4E8"}}," free "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"exclusiveCount"),t("span",{style:{color:"#E1E4E8"}},"(nextc) "),t("span",{style:{color:"#F97583"}},"=="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"0"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (free)")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#B392F0"}},"setExclusiveOwnerThread"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#79B8FF"}},"null"),t("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#B392F0"}},"setState"),t("span",{style:{color:"#E1E4E8"}},"(nextc);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"return"),t("span",{style:{color:"#E1E4E8"}}," free;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"}")])])]),t("pre",{class:"shiki github-light vp-code-light"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"public"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"void"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"unlock"),t("span",{style:{color:"#24292E"}},"() {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// 释放锁")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    sync."),t("span",{style:{color:"#6F42C1"}},"release"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#005CC5"}},"1"),t("span",{style:{color:"#24292E"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"}")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"public"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"final"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"boolean"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"release"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," arg) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// 尝试释放锁")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," ("),t("span",{style:{color:"#6F42C1"}},"tryRelease"),t("span",{style:{color:"#24292E"}},"(arg)) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        Node h "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," head;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6A737D"}},"// 头节点不为空并且不是等待状态不是 0，唤醒后继的非取消节点")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (h "),t("span",{style:{color:"#D73A49"}},"!="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"null"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"&&"),t("span",{style:{color:"#24292E"}}," h.waitStatus "),t("span",{style:{color:"#D73A49"}},"!="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"0"),t("span",{style:{color:"#24292E"}},")")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#6F42C1"}},"unparkSuccessor"),t("span",{style:{color:"#24292E"}},"(h);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"return"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"true"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"return"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"false"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"}")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"protected"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"final"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"boolean"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"tryRelease"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," releases) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," ("),t("span",{style:{color:"#D73A49"}},"!"),t("span",{style:{color:"#6F42C1"}},"isHeldExclusively"),t("span",{style:{color:"#24292E"}},"())")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"throw"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"new"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"IllegalMonitorStateException"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," nextc "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"getState"),t("span",{style:{color:"#24292E"}},"() "),t("span",{style:{color:"#D73A49"}},"-"),t("span",{style:{color:"#24292E"}}," releases;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// 因为可重入的原因, 写锁计数为 0, 才算释放成功")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"boolean"),t("span",{style:{color:"#24292E"}}," free "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"exclusiveCount"),t("span",{style:{color:"#24292E"}},"(nextc) "),t("span",{style:{color:"#D73A49"}},"=="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"0"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (free)")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6F42C1"}},"setExclusiveOwnerThread"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#005CC5"}},"null"),t("span",{style:{color:"#24292E"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6F42C1"}},"setState"),t("span",{style:{color:"#24292E"}},"(nextc);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"return"),t("span",{style:{color:"#24292E"}}," free;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"}")])])]),t("button",{class:"collapse"})])]),t("li",null,[t("p",null,[p("唤醒流程 "),t("code",null,"sync.unparkSuccessor"),p("，这时 t2 在 doAcquireShared 的 parkAndCheckInterrupt() 处恢复运行，继续循环，执行 tryAcquireShared 成功则让读锁计数加一")])]),t("li",null,[t("p",null,[p("接下来 t2 调用 "),t("code",null,"setHeadAndPropagate(node, 1)"),p("，它原本所在节点被置为头节点；还会检查下一个节点是否是 shared，如果是则调用 "),t("code",null,"doReleaseShared()"),p(" 将 head 的状态从 -1 改为 0 并唤醒下一个节点，这时 t3 在 doAcquireShared 内 "),t("code",null,"parkAndCheckInterrupt()"),p(" 处恢复运行，"),t("strong",null,"唤醒连续的所有的共享节点")]),t("div",{style:{"max-height":"300px"},class:"language-java"},[t("button",{title:"Copy Code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki github-dark vp-code-dark"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"private"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"void"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"setHeadAndPropagate"),t("span",{style:{color:"#E1E4E8"}},"(Node node, "),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," propagate) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    Node h "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," head; ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// 设置自己为 head 节点")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#B392F0"}},"setHead"),t("span",{style:{color:"#E1E4E8"}},"(node);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// propagate 表示有共享资源（例如共享读锁或信号量），为 0 就没有资源")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (propagate "),t("span",{style:{color:"#F97583"}},">"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"0"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"||"),t("span",{style:{color:"#E1E4E8"}}," h "),t("span",{style:{color:"#F97583"}},"=="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"null"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"||"),t("span",{style:{color:"#E1E4E8"}}," h.waitStatus "),t("span",{style:{color:"#F97583"}},"<"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"0"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"||")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        (h "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," head) "),t("span",{style:{color:"#F97583"}},"=="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"null"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"||"),t("span",{style:{color:"#E1E4E8"}}," h.waitStatus "),t("span",{style:{color:"#F97583"}},"<"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"0"),t("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#6A737D"}},"// 获取下一个节点")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        Node s "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," node.next;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#6A737D"}},"// 如果当前是最后一个节点，或者下一个节点是【等待共享读锁的节点】")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (s "),t("span",{style:{color:"#F97583"}},"=="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"null"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"||"),t("span",{style:{color:"#E1E4E8"}}," s."),t("span",{style:{color:"#B392F0"}},"isShared"),t("span",{style:{color:"#E1E4E8"}},"())")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#6A737D"}},"// 唤醒后继节点")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#B392F0"}},"doReleaseShared"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"}")])])]),t("pre",{class:"shiki github-light vp-code-light"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"private"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"void"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"setHeadAndPropagate"),t("span",{style:{color:"#24292E"}},"(Node node, "),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," propagate) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    Node h "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," head; ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// 设置自己为 head 节点")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6F42C1"}},"setHead"),t("span",{style:{color:"#24292E"}},"(node);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// propagate 表示有共享资源（例如共享读锁或信号量），为 0 就没有资源")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (propagate "),t("span",{style:{color:"#D73A49"}},">"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"0"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"||"),t("span",{style:{color:"#24292E"}}," h "),t("span",{style:{color:"#D73A49"}},"=="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"null"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"||"),t("span",{style:{color:"#24292E"}}," h.waitStatus "),t("span",{style:{color:"#D73A49"}},"<"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"0"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"||")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        (h "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," head) "),t("span",{style:{color:"#D73A49"}},"=="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"null"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"||"),t("span",{style:{color:"#24292E"}}," h.waitStatus "),t("span",{style:{color:"#D73A49"}},"<"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"0"),t("span",{style:{color:"#24292E"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6A737D"}},"// 获取下一个节点")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        Node s "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," node.next;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6A737D"}},"// 如果当前是最后一个节点，或者下一个节点是【等待共享读锁的节点】")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (s "),t("span",{style:{color:"#D73A49"}},"=="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"null"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"||"),t("span",{style:{color:"#24292E"}}," s."),t("span",{style:{color:"#6F42C1"}},"isShared"),t("span",{style:{color:"#24292E"}},"())")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#6A737D"}},"// 唤醒后继节点")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#6F42C1"}},"doReleaseShared"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"}")])])]),t("button",{class:"collapse"})]),t("div",{style:{"max-height":"300px"},class:"language-java"},[t("button",{title:"Copy Code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki github-dark vp-code-dark"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"private"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"void"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"doReleaseShared"),t("span",{style:{color:"#E1E4E8"}},"() {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// 如果 head.waitStatus == Node.SIGNAL ==> 0 成功, 下一个节点 unpark")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"\t"),t("span",{style:{color:"#6A737D"}},"// 如果 head.waitStatus == 0 ==> Node.PROPAGATE")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"for"),t("span",{style:{color:"#E1E4E8"}}," (;;) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        Node h "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," head;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (h "),t("span",{style:{color:"#F97583"}},"!="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"null"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"&&"),t("span",{style:{color:"#E1E4E8"}}," h "),t("span",{style:{color:"#F97583"}},"!="),t("span",{style:{color:"#E1E4E8"}}," tail) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," ws "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," h.waitStatus;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#6A737D"}},"// SIGNAL 唤醒后继")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (ws "),t("span",{style:{color:"#F97583"}},"=="),t("span",{style:{color:"#E1E4E8"}}," Node.SIGNAL) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#6A737D"}},"// 因为读锁共享，如果其它线程也在释放读锁，那么需要将 waitStatus 先改为 0")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            \t"),t("span",{style:{color:"#6A737D"}},"// 防止 unparkSuccessor 被多次执行")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," ("),t("span",{style:{color:"#F97583"}},"!"),t("span",{style:{color:"#B392F0"}},"compareAndSetWaitStatus"),t("span",{style:{color:"#E1E4E8"}},"(h, Node.SIGNAL, "),t("span",{style:{color:"#79B8FF"}},"0"),t("span",{style:{color:"#E1E4E8"}},"))")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                    "),t("span",{style:{color:"#F97583"}},"continue"),t("span",{style:{color:"#E1E4E8"}},";  ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#6A737D"}},"// 唤醒后继节点")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#B392F0"}},"unparkSuccessor"),t("span",{style:{color:"#E1E4E8"}},"(h);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#6A737D"}},"// 如果已经是 0 了，改为 -3，用来解决传播性")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"else"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (ws "),t("span",{style:{color:"#F97583"}},"=="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"0"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"&&"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"!"),t("span",{style:{color:"#B392F0"}},"compareAndSetWaitStatus"),t("span",{style:{color:"#E1E4E8"}},"(h, "),t("span",{style:{color:"#79B8FF"}},"0"),t("span",{style:{color:"#E1E4E8"}},", Node.PROPAGATE))")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#F97583"}},"continue"),t("span",{style:{color:"#E1E4E8"}},";                ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#6A737D"}},"// 条件不成立说明被唤醒的节点非常积极，直接将自己设置为了新的 head，")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#6A737D"}},"// 此时唤醒它的节点（前驱）执行 h == head 不成立，所以不会跳出循环，会继续唤醒新的 head 节点的后继节点")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (h "),t("span",{style:{color:"#F97583"}},"=="),t("span",{style:{color:"#E1E4E8"}}," head)                   ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"break"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"}")])])]),t("pre",{class:"shiki github-light vp-code-light"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"private"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"void"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"doReleaseShared"),t("span",{style:{color:"#24292E"}},"() {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// 如果 head.waitStatus == Node.SIGNAL ==> 0 成功, 下一个节点 unpark")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"\t"),t("span",{style:{color:"#6A737D"}},"// 如果 head.waitStatus == 0 ==> Node.PROPAGATE")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"for"),t("span",{style:{color:"#24292E"}}," (;;) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        Node h "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," head;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (h "),t("span",{style:{color:"#D73A49"}},"!="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"null"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"&&"),t("span",{style:{color:"#24292E"}}," h "),t("span",{style:{color:"#D73A49"}},"!="),t("span",{style:{color:"#24292E"}}," tail) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," ws "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," h.waitStatus;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#6A737D"}},"// SIGNAL 唤醒后继")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (ws "),t("span",{style:{color:"#D73A49"}},"=="),t("span",{style:{color:"#24292E"}}," Node.SIGNAL) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#6A737D"}},"// 因为读锁共享，如果其它线程也在释放读锁，那么需要将 waitStatus 先改为 0")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            \t"),t("span",{style:{color:"#6A737D"}},"// 防止 unparkSuccessor 被多次执行")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," ("),t("span",{style:{color:"#D73A49"}},"!"),t("span",{style:{color:"#6F42C1"}},"compareAndSetWaitStatus"),t("span",{style:{color:"#24292E"}},"(h, Node.SIGNAL, "),t("span",{style:{color:"#005CC5"}},"0"),t("span",{style:{color:"#24292E"}},"))")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                    "),t("span",{style:{color:"#D73A49"}},"continue"),t("span",{style:{color:"#24292E"}},";  ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#6A737D"}},"// 唤醒后继节点")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#6F42C1"}},"unparkSuccessor"),t("span",{style:{color:"#24292E"}},"(h);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#6A737D"}},"// 如果已经是 0 了，改为 -3，用来解决传播性")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"else"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (ws "),t("span",{style:{color:"#D73A49"}},"=="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"0"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"&&"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"!"),t("span",{style:{color:"#6F42C1"}},"compareAndSetWaitStatus"),t("span",{style:{color:"#24292E"}},"(h, "),t("span",{style:{color:"#005CC5"}},"0"),t("span",{style:{color:"#24292E"}},", Node.PROPAGATE))")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#D73A49"}},"continue"),t("span",{style:{color:"#24292E"}},";                ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6A737D"}},"// 条件不成立说明被唤醒的节点非常积极，直接将自己设置为了新的 head，")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6A737D"}},"// 此时唤醒它的节点（前驱）执行 h == head 不成立，所以不会跳出循环，会继续唤醒新的 head 节点的后继节点")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (h "),t("span",{style:{color:"#D73A49"}},"=="),t("span",{style:{color:"#24292E"}}," head)                   ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"break"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"}")])])]),t("button",{class:"collapse"})]),t("img",{src:"https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230719192838777.png",alt:"image-20230719192838777",style:{zoom:"50%"}})]),t("li",null,[t("p",null,"下一个节点不是 shared 了，因此不会继续唤醒 t4 所在节点")]),t("li",null,[t("p",null,[p("t2 读锁解锁，进入 "),t("code",null,"sync.releaseShared(1)"),p(" 中，调用 "),t("code",null,"tryReleaseShared(1)"),p(" 让计数减一，但计数还不为零，t3 同样让计数减一，计数为零，进入"),t("code",null,"doReleaseShared()"),p(" 将头节点从 -1 改为 0 并唤醒下一个节点")]),t("div",{style:{"max-height":"300px"},class:"language-java"},[t("button",{title:"Copy Code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki github-dark vp-code-dark"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"public"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"void"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"unlock"),t("span",{style:{color:"#E1E4E8"}},"() {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    sync."),t("span",{style:{color:"#B392F0"}},"releaseShared"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#79B8FF"}},"1"),t("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"}")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"public"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"final"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"boolean"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"releaseShared"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," arg) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," ("),t("span",{style:{color:"#B392F0"}},"tryReleaseShared"),t("span",{style:{color:"#E1E4E8"}},"(arg)) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#B392F0"}},"doReleaseShared"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"return"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"true"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"return"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"false"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"}")])])]),t("pre",{class:"shiki github-light vp-code-light"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"public"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"void"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"unlock"),t("span",{style:{color:"#24292E"}},"() {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    sync."),t("span",{style:{color:"#6F42C1"}},"releaseShared"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#005CC5"}},"1"),t("span",{style:{color:"#24292E"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"}")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"public"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"final"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"boolean"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"releaseShared"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," arg) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," ("),t("span",{style:{color:"#6F42C1"}},"tryReleaseShared"),t("span",{style:{color:"#24292E"}},"(arg)) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6F42C1"}},"doReleaseShared"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"return"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"true"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"return"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"false"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"}")])])]),t("button",{class:"collapse"})]),t("div",{style:{"max-height":"300px"},class:"language-java"},[t("button",{title:"Copy Code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki github-dark vp-code-dark"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"protected"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"final"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"boolean"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"tryReleaseShared"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," unused) {")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"for"),t("span",{style:{color:"#E1E4E8"}}," (;;) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," c "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"getState"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," nextc "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," c "),t("span",{style:{color:"#F97583"}},"-"),t("span",{style:{color:"#E1E4E8"}}," SHARED_UNIT;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#6A737D"}},"// 读锁的计数不会影响其它获取读锁线程, 但会影响其它获取写锁线程，计数为 0 才是真正释放")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," ("),t("span",{style:{color:"#B392F0"}},"compareAndSetState"),t("span",{style:{color:"#E1E4E8"}},"(c, nextc))")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#6A737D"}},"// 返回是否已经完全释放了 ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"return"),t("span",{style:{color:"#E1E4E8"}}," nextc "),t("span",{style:{color:"#F97583"}},"=="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"0"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"}")])])]),t("pre",{class:"shiki github-light vp-code-light"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"protected"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"final"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"boolean"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"tryReleaseShared"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," unused) {")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"for"),t("span",{style:{color:"#24292E"}}," (;;) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," c "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"getState"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," nextc "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," c "),t("span",{style:{color:"#D73A49"}},"-"),t("span",{style:{color:"#24292E"}}," SHARED_UNIT;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6A737D"}},"// 读锁的计数不会影响其它获取读锁线程, 但会影响其它获取写锁线程，计数为 0 才是真正释放")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," ("),t("span",{style:{color:"#6F42C1"}},"compareAndSetState"),t("span",{style:{color:"#24292E"}},"(c, nextc))")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#6A737D"}},"// 返回是否已经完全释放了 ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"return"),t("span",{style:{color:"#24292E"}}," nextc "),t("span",{style:{color:"#D73A49"}},"=="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"0"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"}")])])]),t("button",{class:"collapse"})])]),t("li",null,[t("p",null,[p("t4 在 acquireQueued 中 parkAndCheckInterrupt 处恢复运行，再次 "),t("code",null,"for (;;)"),p(" 这次自己是头节点的临节点，并且没有其他节点竞争，"),t("code",null,"tryAcquire(1)"),p(" 成功，修改头结点，流程结束")]),t("img",{src:"https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230719192920793.png",alt:"image-20230719192920793",style:{zoom:"50%"}})])],-1),ro=t("hr",null,null,-1),Eo={id:"stamped",tabindex:"-1"},yo=t("p",null,"StampedLock：读写锁，该类自 JDK 8 加入，是为了进一步优化读性能",-1),io=t("p",null,"特点：",-1),Fo=t("ul",null,[t("li",null,[t("p",null,"在使用读锁、写锁时都必须配合戳使用")]),t("li",null,[t("p",null,"StampedLock 不支持条件变量")]),t("li",null,[t("p",null,[p("StampedLock "),t("strong",null,"不支持重入")])])],-1),uo=t("p",null,"基本用法",-1),Ao=t("ul",null,[t("li",null,[t("p",null,"加解读锁："),t("div",{style:{"max-height":"300px"},class:"language-java"},[t("button",{title:"Copy Code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki github-dark vp-code-dark"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"long"),t("span",{style:{color:"#E1E4E8"}}," stamp "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," lock."),t("span",{style:{color:"#B392F0"}},"readLock"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"lock."),t("span",{style:{color:"#B392F0"}},"unlockRead"),t("span",{style:{color:"#E1E4E8"}},"(stamp);\t\t\t"),t("span",{style:{color:"#6A737D"}},"// 类似于 unpark，解指定的锁")])])]),t("pre",{class:"shiki github-light vp-code-light"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"long"),t("span",{style:{color:"#24292E"}}," stamp "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," lock."),t("span",{style:{color:"#6F42C1"}},"readLock"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"lock."),t("span",{style:{color:"#6F42C1"}},"unlockRead"),t("span",{style:{color:"#24292E"}},"(stamp);\t\t\t"),t("span",{style:{color:"#6A737D"}},"// 类似于 unpark，解指定的锁")])])]),t("button",{class:"collapse"})])]),t("li",null,[t("p",null,"加解写锁："),t("div",{style:{"max-height":"300px"},class:"language-java"},[t("button",{title:"Copy Code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki github-dark vp-code-dark"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"long"),t("span",{style:{color:"#E1E4E8"}}," stamp "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," lock."),t("span",{style:{color:"#B392F0"}},"writeLock"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"lock."),t("span",{style:{color:"#B392F0"}},"unlockWrite"),t("span",{style:{color:"#E1E4E8"}},"(stamp);")])])]),t("pre",{class:"shiki github-light vp-code-light"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"long"),t("span",{style:{color:"#24292E"}}," stamp "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," lock."),t("span",{style:{color:"#6F42C1"}},"writeLock"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"lock."),t("span",{style:{color:"#6F42C1"}},"unlockWrite"),t("span",{style:{color:"#24292E"}},"(stamp);")])])]),t("button",{class:"collapse"})])]),t("li",null,[t("p",null,[p("乐观读，StampedLock 支持 "),t("code",null,"tryOptimisticRead()"),p(" 方法，读取完毕后做一次"),t("strong",null,"戳校验"),p("，如果校验通过，表示这期间没有其他线程的写操作，数据可以安全使用，如果校验没通过，需要重新获取读锁，保证数据一致性")]),t("div",{style:{"max-height":"300px"},class:"language-java"},[t("button",{title:"Copy Code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki github-dark vp-code-dark"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"long"),t("span",{style:{color:"#E1E4E8"}}," stamp "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," lock."),t("span",{style:{color:"#B392F0"}},"tryOptimisticRead"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// 验戳")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#F97583"}},"!"),t("span",{style:{color:"#E1E4E8"}},"lock."),t("span",{style:{color:"#B392F0"}},"validate"),t("span",{style:{color:"#E1E4E8"}},"(stamp)){")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"\t"),t("span",{style:{color:"#6A737D"}},"// 锁升级")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"}")])])]),t("pre",{class:"shiki github-light vp-code-light"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"long"),t("span",{style:{color:"#24292E"}}," stamp "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," lock."),t("span",{style:{color:"#6F42C1"}},"tryOptimisticRead"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// 验戳")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#D73A49"}},"!"),t("span",{style:{color:"#24292E"}},"lock."),t("span",{style:{color:"#6F42C1"}},"validate"),t("span",{style:{color:"#24292E"}},"(stamp)){")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"\t"),t("span",{style:{color:"#6A737D"}},"// 锁升级")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"}")])])]),t("button",{class:"collapse"})])])],-1),Do=t("p",null,"提供一个数据容器类内部分别使用读锁保护数据的 read() 方法，写锁保护数据的 write() 方法：",-1),ho=t("ul",null,[t("li",null,"读-读可以优化"),t("li",null,"读-写优化读，补加读锁")],-1),Co=t("div",{style:{"max-height":"300px"},class:"language-java"},[t("button",{title:"Copy Code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki github-dark vp-code-dark"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"public"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"static"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"void"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"main"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#F97583"}},"String"),t("span",{style:{color:"#E1E4E8"}},"[] args) throws InterruptedException {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    DataContainerStamped dataContainer "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"new"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"DataContainerStamped"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#79B8FF"}},"1"),t("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"new"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"Thread"),t("span",{style:{color:"#E1E4E8"}},"(() "),t("span",{style:{color:"#F97583"}},"->"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    \tdataContainer."),t("span",{style:{color:"#B392F0"}},"read"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#79B8FF"}},"1000"),t("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    },"),t("span",{style:{color:"#9ECBFF"}},'"t1"'),t("span",{style:{color:"#E1E4E8"}},")."),t("span",{style:{color:"#B392F0"}},"start"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    Thread."),t("span",{style:{color:"#B392F0"}},"sleep"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#79B8FF"}},"500"),t("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"new"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"Thread"),t("span",{style:{color:"#E1E4E8"}},"(() "),t("span",{style:{color:"#F97583"}},"->"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        dataContainer."),t("span",{style:{color:"#B392F0"}},"write"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#79B8FF"}},"1000"),t("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    },"),t("span",{style:{color:"#9ECBFF"}},'"t2"'),t("span",{style:{color:"#E1E4E8"}},")."),t("span",{style:{color:"#B392F0"}},"start"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"}")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"class"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"DataContainerStamped"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"private"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," data;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"private"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"final"),t("span",{style:{color:"#E1E4E8"}}," StampedLock lock "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"new"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"StampedLock"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"public"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"read"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#FFAB70"}},"readTime"),t("span",{style:{color:"#E1E4E8"}},") "),t("span",{style:{color:"#F97583"}},"throws"),t("span",{style:{color:"#E1E4E8"}}," InterruptedException {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"long"),t("span",{style:{color:"#E1E4E8"}}," stamp "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," lock."),t("span",{style:{color:"#B392F0"}},"tryOptimisticRead"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        System.out."),t("span",{style:{color:"#B392F0"}},"println"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#F97583"}},"new"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"Date"),t("span",{style:{color:"#E1E4E8"}},"() "),t("span",{style:{color:"#F97583"}},"+"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#9ECBFF"}},'" optimistic read locking"'),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"+"),t("span",{style:{color:"#E1E4E8"}}," stamp);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        Thread."),t("span",{style:{color:"#B392F0"}},"sleep"),t("span",{style:{color:"#E1E4E8"}},"(readTime);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#6A737D"}},"// 戳有效，直接返回数据")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (lock."),t("span",{style:{color:"#B392F0"}},"validate"),t("span",{style:{color:"#E1E4E8"}},"(stamp)) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#B392F0"}},"Sout"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#F97583"}},"new"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"Date"),t("span",{style:{color:"#E1E4E8"}},"() "),t("span",{style:{color:"#F97583"}},"+"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#9ECBFF"}},'" optimistic read finish..."'),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"+"),t("span",{style:{color:"#E1E4E8"}}," stamp);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"return"),t("span",{style:{color:"#E1E4E8"}}," data;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        }")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#6A737D"}},"// 说明其他线程更改了戳，需要锁升级了，从乐观读升级到读锁")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        System.out."),t("span",{style:{color:"#B392F0"}},"println"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#F97583"}},"new"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"Date"),t("span",{style:{color:"#E1E4E8"}},"() "),t("span",{style:{color:"#F97583"}},"+"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#9ECBFF"}},'" updating to read lock"'),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"+"),t("span",{style:{color:"#E1E4E8"}}," stamp);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"try"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            stamp "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," lock."),t("span",{style:{color:"#B392F0"}},"readLock"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            System.out."),t("span",{style:{color:"#B392F0"}},"println"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#F97583"}},"new"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"Date"),t("span",{style:{color:"#E1E4E8"}},"() "),t("span",{style:{color:"#F97583"}},"+"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#9ECBFF"}},'" read lock"'),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"+"),t("span",{style:{color:"#E1E4E8"}}," stamp);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            Thread."),t("span",{style:{color:"#B392F0"}},"sleep"),t("span",{style:{color:"#E1E4E8"}},"(readTime);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            System.out."),t("span",{style:{color:"#B392F0"}},"println"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#F97583"}},"new"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"Date"),t("span",{style:{color:"#E1E4E8"}},"() "),t("span",{style:{color:"#F97583"}},"+"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#9ECBFF"}},'" read finish..."'),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"+"),t("span",{style:{color:"#E1E4E8"}}," stamp);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"return"),t("span",{style:{color:"#E1E4E8"}}," data;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        } "),t("span",{style:{color:"#F97583"}},"finally"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            System.out."),t("span",{style:{color:"#B392F0"}},"println"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#F97583"}},"new"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"Date"),t("span",{style:{color:"#E1E4E8"}},"() "),t("span",{style:{color:"#F97583"}},"+"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#9ECBFF"}},'" read unlock "'),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"+"),t("span",{style:{color:"#E1E4E8"}},"  stamp);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            lock."),t("span",{style:{color:"#B392F0"}},"unlockRead"),t("span",{style:{color:"#E1E4E8"}},"(stamp);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"public"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"void"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"write"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#FFAB70"}},"newData"),t("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"long"),t("span",{style:{color:"#E1E4E8"}}," stamp "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," lock."),t("span",{style:{color:"#B392F0"}},"writeLock"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        System.out."),t("span",{style:{color:"#B392F0"}},"println"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#F97583"}},"new"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"Date"),t("span",{style:{color:"#E1E4E8"}},"() "),t("span",{style:{color:"#F97583"}},"+"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#9ECBFF"}},'" write lock "'),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"+"),t("span",{style:{color:"#E1E4E8"}}," stamp);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"try"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            Thread."),t("span",{style:{color:"#B392F0"}},"sleep"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#79B8FF"}},"2000"),t("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#79B8FF"}},"this"),t("span",{style:{color:"#E1E4E8"}},".data "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," newData;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        } "),t("span",{style:{color:"#F97583"}},"catch"),t("span",{style:{color:"#E1E4E8"}}," (InterruptedException "),t("span",{style:{color:"#FFAB70"}},"e"),t("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            e."),t("span",{style:{color:"#B392F0"}},"printStackTrace"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        } "),t("span",{style:{color:"#F97583"}},"finally"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            System.out."),t("span",{style:{color:"#B392F0"}},"println"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#F97583"}},"new"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"Date"),t("span",{style:{color:"#E1E4E8"}},"() "),t("span",{style:{color:"#F97583"}},"+"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#9ECBFF"}},'" write unlock "'),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"+"),t("span",{style:{color:"#E1E4E8"}}," stamp);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            lock."),t("span",{style:{color:"#B392F0"}},"unlockWrite"),t("span",{style:{color:"#E1E4E8"}},"(stamp);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"}")])])]),t("pre",{class:"shiki github-light vp-code-light"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"public"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"static"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"void"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"main"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#D73A49"}},"String"),t("span",{style:{color:"#24292E"}},"[] args) throws InterruptedException {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    DataContainerStamped dataContainer "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"new"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"DataContainerStamped"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#005CC5"}},"1"),t("span",{style:{color:"#24292E"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"new"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"Thread"),t("span",{style:{color:"#24292E"}},"(() "),t("span",{style:{color:"#D73A49"}},"->"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    \tdataContainer."),t("span",{style:{color:"#6F42C1"}},"read"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#005CC5"}},"1000"),t("span",{style:{color:"#24292E"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    },"),t("span",{style:{color:"#032F62"}},'"t1"'),t("span",{style:{color:"#24292E"}},")."),t("span",{style:{color:"#6F42C1"}},"start"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    Thread."),t("span",{style:{color:"#6F42C1"}},"sleep"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#005CC5"}},"500"),t("span",{style:{color:"#24292E"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"new"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"Thread"),t("span",{style:{color:"#24292E"}},"(() "),t("span",{style:{color:"#D73A49"}},"->"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        dataContainer."),t("span",{style:{color:"#6F42C1"}},"write"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#005CC5"}},"1000"),t("span",{style:{color:"#24292E"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    },"),t("span",{style:{color:"#032F62"}},'"t2"'),t("span",{style:{color:"#24292E"}},")."),t("span",{style:{color:"#6F42C1"}},"start"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"}")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"class"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"DataContainerStamped"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"private"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," data;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"private"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"final"),t("span",{style:{color:"#24292E"}}," StampedLock lock "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"new"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"StampedLock"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"public"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"read"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#E36209"}},"readTime"),t("span",{style:{color:"#24292E"}},") "),t("span",{style:{color:"#D73A49"}},"throws"),t("span",{style:{color:"#24292E"}}," InterruptedException {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"long"),t("span",{style:{color:"#24292E"}}," stamp "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," lock."),t("span",{style:{color:"#6F42C1"}},"tryOptimisticRead"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        System.out."),t("span",{style:{color:"#6F42C1"}},"println"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#D73A49"}},"new"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"Date"),t("span",{style:{color:"#24292E"}},"() "),t("span",{style:{color:"#D73A49"}},"+"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#032F62"}},'" optimistic read locking"'),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"+"),t("span",{style:{color:"#24292E"}}," stamp);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        Thread."),t("span",{style:{color:"#6F42C1"}},"sleep"),t("span",{style:{color:"#24292E"}},"(readTime);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6A737D"}},"// 戳有效，直接返回数据")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (lock."),t("span",{style:{color:"#6F42C1"}},"validate"),t("span",{style:{color:"#24292E"}},"(stamp)) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#6F42C1"}},"Sout"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#D73A49"}},"new"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"Date"),t("span",{style:{color:"#24292E"}},"() "),t("span",{style:{color:"#D73A49"}},"+"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#032F62"}},'" optimistic read finish..."'),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"+"),t("span",{style:{color:"#24292E"}}," stamp);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"return"),t("span",{style:{color:"#24292E"}}," data;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        }")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6A737D"}},"// 说明其他线程更改了戳，需要锁升级了，从乐观读升级到读锁")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        System.out."),t("span",{style:{color:"#6F42C1"}},"println"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#D73A49"}},"new"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"Date"),t("span",{style:{color:"#24292E"}},"() "),t("span",{style:{color:"#D73A49"}},"+"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#032F62"}},'" updating to read lock"'),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"+"),t("span",{style:{color:"#24292E"}}," stamp);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"try"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            stamp "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," lock."),t("span",{style:{color:"#6F42C1"}},"readLock"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            System.out."),t("span",{style:{color:"#6F42C1"}},"println"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#D73A49"}},"new"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"Date"),t("span",{style:{color:"#24292E"}},"() "),t("span",{style:{color:"#D73A49"}},"+"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#032F62"}},'" read lock"'),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"+"),t("span",{style:{color:"#24292E"}}," stamp);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            Thread."),t("span",{style:{color:"#6F42C1"}},"sleep"),t("span",{style:{color:"#24292E"}},"(readTime);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            System.out."),t("span",{style:{color:"#6F42C1"}},"println"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#D73A49"}},"new"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"Date"),t("span",{style:{color:"#24292E"}},"() "),t("span",{style:{color:"#D73A49"}},"+"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#032F62"}},'" read finish..."'),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"+"),t("span",{style:{color:"#24292E"}}," stamp);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"return"),t("span",{style:{color:"#24292E"}}," data;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        } "),t("span",{style:{color:"#D73A49"}},"finally"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            System.out."),t("span",{style:{color:"#6F42C1"}},"println"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#D73A49"}},"new"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"Date"),t("span",{style:{color:"#24292E"}},"() "),t("span",{style:{color:"#D73A49"}},"+"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#032F62"}},'" read unlock "'),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"+"),t("span",{style:{color:"#24292E"}},"  stamp);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            lock."),t("span",{style:{color:"#6F42C1"}},"unlockRead"),t("span",{style:{color:"#24292E"}},"(stamp);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    }")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"public"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"void"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"write"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#E36209"}},"newData"),t("span",{style:{color:"#24292E"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"long"),t("span",{style:{color:"#24292E"}}," stamp "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," lock."),t("span",{style:{color:"#6F42C1"}},"writeLock"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        System.out."),t("span",{style:{color:"#6F42C1"}},"println"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#D73A49"}},"new"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"Date"),t("span",{style:{color:"#24292E"}},"() "),t("span",{style:{color:"#D73A49"}},"+"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#032F62"}},'" write lock "'),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"+"),t("span",{style:{color:"#24292E"}}," stamp);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"try"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            Thread."),t("span",{style:{color:"#6F42C1"}},"sleep"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#005CC5"}},"2000"),t("span",{style:{color:"#24292E"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#005CC5"}},"this"),t("span",{style:{color:"#24292E"}},".data "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," newData;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        } "),t("span",{style:{color:"#D73A49"}},"catch"),t("span",{style:{color:"#24292E"}}," (InterruptedException "),t("span",{style:{color:"#E36209"}},"e"),t("span",{style:{color:"#24292E"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            e."),t("span",{style:{color:"#6F42C1"}},"printStackTrace"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        } "),t("span",{style:{color:"#D73A49"}},"finally"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            System.out."),t("span",{style:{color:"#6F42C1"}},"println"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#D73A49"}},"new"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"Date"),t("span",{style:{color:"#24292E"}},"() "),t("span",{style:{color:"#D73A49"}},"+"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#032F62"}},'" write unlock "'),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"+"),t("span",{style:{color:"#24292E"}}," stamp);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            lock."),t("span",{style:{color:"#6F42C1"}},"unlockWrite"),t("span",{style:{color:"#24292E"}},"(stamp);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"}")])])]),t("button",{class:"collapse"})],-1),go=t("hr",null,null,-1),ko={id:"countdown",tabindex:"-1"},Bo={id:"基本使用-4",tabindex:"-1"},fo=t("p",null,[p("CountDownLatch：计数器，用来进行线程同步协作，"),t("strong",null,"等待所有线程完成")],-1),bo=t("p",null,"构造器：",-1),vo=t("ul",null,[t("li",null,[t("code",null,"public CountDownLatch(int count)"),p("：初始化唤醒需要的 down 几步")])],-1),So=t("p",null,"常用API：",-1),mo=t("ul",null,[t("li",null,[t("code",null,"public void await() "),p("：让当前线程等待，必须 down 完初始化的数字才可以被唤醒，否则进入无限等待")]),t("li",null,[t("code",null,"public void countDown()"),p("：计数器进行减 1（down 1）")])],-1),xo=t("p",null,"应用：同步等待多个 Rest 远程调用结束",-1),wo=t("div",{style:{"max-height":"300px"},class:"language-java"},[t("button",{title:"Copy Code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki github-dark vp-code-dark"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// LOL 10人进入游戏倒计时")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"public"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"static"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"void"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"main"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#F97583"}},"String"),t("span",{style:{color:"#E1E4E8"}},"[] args) throws InterruptedException {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    CountDownLatch latch "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"new"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"CountDownLatch"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#79B8FF"}},"10"),t("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    ExecutorService service "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," Executors."),t("span",{style:{color:"#B392F0"}},"newFixedThreadPool"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#79B8FF"}},"10"),t("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"String"),t("span",{style:{color:"#E1E4E8"}},"[] all "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"new"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"String"),t("span",{style:{color:"#E1E4E8"}},"["),t("span",{style:{color:"#79B8FF"}},"10"),t("span",{style:{color:"#E1E4E8"}},"];")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    Random random "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"new"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"Random"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"for"),t("span",{style:{color:"#E1E4E8"}}," ("),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," j "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"0"),t("span",{style:{color:"#E1E4E8"}},"; j "),t("span",{style:{color:"#F97583"}},"<"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"10"),t("span",{style:{color:"#E1E4E8"}},"; j"),t("span",{style:{color:"#F97583"}},"++"),t("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," finalJ "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," j;"),t("span",{style:{color:"#6A737D"}},"//常量")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        service."),t("span",{style:{color:"#B392F0"}},"submit"),t("span",{style:{color:"#E1E4E8"}},"(() "),t("span",{style:{color:"#F97583"}},"->"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"for"),t("span",{style:{color:"#E1E4E8"}}," ("),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," i "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"0"),t("span",{style:{color:"#E1E4E8"}},"; i "),t("span",{style:{color:"#F97583"}},"<="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"100"),t("span",{style:{color:"#E1E4E8"}},"; i"),t("span",{style:{color:"#F97583"}},"++"),t("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                Thread."),t("span",{style:{color:"#B392F0"}},"sleep"),t("span",{style:{color:"#E1E4E8"}},"(random."),t("span",{style:{color:"#B392F0"}},"nextInt"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#79B8FF"}},"100"),t("span",{style:{color:"#E1E4E8"}},"));\t"),t("span",{style:{color:"#6A737D"}},"//随机休眠")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                all[finalJ] "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," i "),t("span",{style:{color:"#F97583"}},"+"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#9ECBFF"}},'"%"'),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                System.out."),t("span",{style:{color:"#B392F0"}},"print"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#9ECBFF"}},'"'),t("span",{style:{color:"#79B8FF"}},"\\r"),t("span",{style:{color:"#9ECBFF"}},'"'),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"+"),t("span",{style:{color:"#E1E4E8"}}," Arrays."),t("span",{style:{color:"#B392F0"}},"toString"),t("span",{style:{color:"#E1E4E8"}},"(all));\t"),t("span",{style:{color:"#6A737D"}},"// \\r代表覆盖")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            latch."),t("span",{style:{color:"#B392F0"}},"countDown"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        });")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    latch."),t("span",{style:{color:"#B392F0"}},"await"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    System.out."),t("span",{style:{color:"#B392F0"}},"println"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#9ECBFF"}},'"'),t("span",{style:{color:"#79B8FF"}},"\\n"),t("span",{style:{color:"#9ECBFF"}},'游戏开始"'),t("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    service."),t("span",{style:{color:"#B392F0"}},"shutdown"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"}")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"/*")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"[100%, 100%, 100%, 100%, 100%, 100%, 100%, 100%, 100%, 100%]")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"游戏开始")])])]),t("pre",{class:"shiki github-light vp-code-light"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// LOL 10人进入游戏倒计时")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"public"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"static"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"void"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"main"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#D73A49"}},"String"),t("span",{style:{color:"#24292E"}},"[] args) throws InterruptedException {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    CountDownLatch latch "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"new"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"CountDownLatch"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#005CC5"}},"10"),t("span",{style:{color:"#24292E"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    ExecutorService service "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," Executors."),t("span",{style:{color:"#6F42C1"}},"newFixedThreadPool"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#005CC5"}},"10"),t("span",{style:{color:"#24292E"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"String"),t("span",{style:{color:"#24292E"}},"[] all "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"new"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"String"),t("span",{style:{color:"#24292E"}},"["),t("span",{style:{color:"#005CC5"}},"10"),t("span",{style:{color:"#24292E"}},"];")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    Random random "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"new"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"Random"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"for"),t("span",{style:{color:"#24292E"}}," ("),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," j "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"0"),t("span",{style:{color:"#24292E"}},"; j "),t("span",{style:{color:"#D73A49"}},"<"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"10"),t("span",{style:{color:"#24292E"}},"; j"),t("span",{style:{color:"#D73A49"}},"++"),t("span",{style:{color:"#24292E"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," finalJ "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," j;"),t("span",{style:{color:"#6A737D"}},"//常量")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        service."),t("span",{style:{color:"#6F42C1"}},"submit"),t("span",{style:{color:"#24292E"}},"(() "),t("span",{style:{color:"#D73A49"}},"->"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"for"),t("span",{style:{color:"#24292E"}}," ("),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," i "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"0"),t("span",{style:{color:"#24292E"}},"; i "),t("span",{style:{color:"#D73A49"}},"<="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"100"),t("span",{style:{color:"#24292E"}},"; i"),t("span",{style:{color:"#D73A49"}},"++"),t("span",{style:{color:"#24292E"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                Thread."),t("span",{style:{color:"#6F42C1"}},"sleep"),t("span",{style:{color:"#24292E"}},"(random."),t("span",{style:{color:"#6F42C1"}},"nextInt"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#005CC5"}},"100"),t("span",{style:{color:"#24292E"}},"));\t"),t("span",{style:{color:"#6A737D"}},"//随机休眠")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                all[finalJ] "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," i "),t("span",{style:{color:"#D73A49"}},"+"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#032F62"}},'"%"'),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                System.out."),t("span",{style:{color:"#6F42C1"}},"print"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#032F62"}},'"'),t("span",{style:{color:"#005CC5"}},"\\r"),t("span",{style:{color:"#032F62"}},'"'),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"+"),t("span",{style:{color:"#24292E"}}," Arrays."),t("span",{style:{color:"#6F42C1"}},"toString"),t("span",{style:{color:"#24292E"}},"(all));\t"),t("span",{style:{color:"#6A737D"}},"// \\r代表覆盖")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            latch."),t("span",{style:{color:"#6F42C1"}},"countDown"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        });")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    latch."),t("span",{style:{color:"#6F42C1"}},"await"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    System.out."),t("span",{style:{color:"#6F42C1"}},"println"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#032F62"}},'"'),t("span",{style:{color:"#005CC5"}},"\\n"),t("span",{style:{color:"#032F62"}},'游戏开始"'),t("span",{style:{color:"#24292E"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    service."),t("span",{style:{color:"#6F42C1"}},"shutdown"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"}")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"/*")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"[100%, 100%, 100%, 100%, 100%, 100%, 100%, 100%, 100%, 100%]")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"游戏开始")])])]),t("button",{class:"collapse"})],-1),To=t("hr",null,null,-1),No={id:"实现原理-4",tabindex:"-1"},Io=t("p",null,"阻塞等待：",-1),Ro=t("ul",null,[t("li",null,[t("p",null,"线程调用 await() 等待其他线程完成任务：支持打断"),t("div",{style:{"max-height":"300px"},class:"language-java"},[t("button",{title:"Copy Code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki github-dark vp-code-dark"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"public"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"void"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"await"),t("span",{style:{color:"#E1E4E8"}},"() throws InterruptedException {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    sync."),t("span",{style:{color:"#B392F0"}},"acquireSharedInterruptibly"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#79B8FF"}},"1"),t("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"}")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// AbstractQueuedSynchronizer#acquireSharedInterruptibly")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"public"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"final"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"void"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"acquireSharedInterruptibly"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," arg) throws InterruptedException {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// 判断线程是否被打断，抛出打断异常")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (Thread."),t("span",{style:{color:"#B392F0"}},"interrupted"),t("span",{style:{color:"#E1E4E8"}},"())")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"throw"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"new"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"InterruptedException"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// 尝试获取共享锁，条件成立说明 state > 0，此时线程入队阻塞等待，等待其他线程获取共享资源")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// 条件不成立说明 state = 0，此时不需要阻塞线程，直接结束函数调用")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," ("),t("span",{style:{color:"#B392F0"}},"tryAcquireShared"),t("span",{style:{color:"#E1E4E8"}},"(arg) "),t("span",{style:{color:"#F97583"}},"<"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"0"),t("span",{style:{color:"#E1E4E8"}},")")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#B392F0"}},"doAcquireSharedInterruptibly"),t("span",{style:{color:"#E1E4E8"}},"(arg);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"}")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// CountDownLatch.Sync#tryAcquireShared")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"protected"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"tryAcquireShared"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," acquires) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"return"),t("span",{style:{color:"#E1E4E8"}}," ("),t("span",{style:{color:"#B392F0"}},"getState"),t("span",{style:{color:"#E1E4E8"}},"() "),t("span",{style:{color:"#F97583"}},"=="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"0"),t("span",{style:{color:"#E1E4E8"}},") "),t("span",{style:{color:"#F97583"}},"?"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"1"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},":"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"-"),t("span",{style:{color:"#79B8FF"}},"1"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"}")])])]),t("pre",{class:"shiki github-light vp-code-light"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"public"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"void"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"await"),t("span",{style:{color:"#24292E"}},"() throws InterruptedException {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    sync."),t("span",{style:{color:"#6F42C1"}},"acquireSharedInterruptibly"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#005CC5"}},"1"),t("span",{style:{color:"#24292E"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"}")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// AbstractQueuedSynchronizer#acquireSharedInterruptibly")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"public"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"final"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"void"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"acquireSharedInterruptibly"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," arg) throws InterruptedException {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// 判断线程是否被打断，抛出打断异常")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (Thread."),t("span",{style:{color:"#6F42C1"}},"interrupted"),t("span",{style:{color:"#24292E"}},"())")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"throw"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"new"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"InterruptedException"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// 尝试获取共享锁，条件成立说明 state > 0，此时线程入队阻塞等待，等待其他线程获取共享资源")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// 条件不成立说明 state = 0，此时不需要阻塞线程，直接结束函数调用")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," ("),t("span",{style:{color:"#6F42C1"}},"tryAcquireShared"),t("span",{style:{color:"#24292E"}},"(arg) "),t("span",{style:{color:"#D73A49"}},"<"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"0"),t("span",{style:{color:"#24292E"}},")")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6F42C1"}},"doAcquireSharedInterruptibly"),t("span",{style:{color:"#24292E"}},"(arg);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"}")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// CountDownLatch.Sync#tryAcquireShared")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"protected"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"tryAcquireShared"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," acquires) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"return"),t("span",{style:{color:"#24292E"}}," ("),t("span",{style:{color:"#6F42C1"}},"getState"),t("span",{style:{color:"#24292E"}},"() "),t("span",{style:{color:"#D73A49"}},"=="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"0"),t("span",{style:{color:"#24292E"}},") "),t("span",{style:{color:"#D73A49"}},"?"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"1"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},":"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"-"),t("span",{style:{color:"#005CC5"}},"1"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"}")])])]),t("button",{class:"collapse"})])]),t("li",null,[t("p",null,"线程进入 AbstractQueuedSynchronizer#doAcquireSharedInterruptibly 函数阻塞挂起，等待 latch 变为 0："),t("div",{style:{"max-height":"300px"},class:"language-java"},[t("button",{title:"Copy Code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki github-dark vp-code-dark"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"private"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"void"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"doAcquireSharedInterruptibly"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," arg) throws InterruptedException {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// 将调用latch.await()方法的线程 包装成 SHARED 类型的 node 加入到 AQS 的阻塞队列中")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"final"),t("span",{style:{color:"#E1E4E8"}}," Node node "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"addWaiter"),t("span",{style:{color:"#E1E4E8"}},"(Node.SHARED);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"boolean"),t("span",{style:{color:"#E1E4E8"}}," failed "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"true"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"try"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"for"),t("span",{style:{color:"#E1E4E8"}}," (;;) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#6A737D"}},"// 获取当前节点的前驱节点")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"final"),t("span",{style:{color:"#E1E4E8"}}," Node p "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," node."),t("span",{style:{color:"#B392F0"}},"predecessor"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#6A737D"}},"// 前驱节点时头节点就可以尝试获取锁")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (p "),t("span",{style:{color:"#F97583"}},"=="),t("span",{style:{color:"#E1E4E8"}}," head) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#6A737D"}},"// 再次尝试获取锁，获取成功返回 1")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," r "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"tryAcquireShared"),t("span",{style:{color:"#E1E4E8"}},"(arg);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (r "),t("span",{style:{color:"#F97583"}},">="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"0"),t("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                    "),t("span",{style:{color:"#6A737D"}},"// 获取锁成功，设置当前节点为 head 节点，并且向后传播")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                    "),t("span",{style:{color:"#B392F0"}},"setHeadAndPropagate"),t("span",{style:{color:"#E1E4E8"}},"(node, r);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                    p.next "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"null"),t("span",{style:{color:"#E1E4E8"}},"; "),t("span",{style:{color:"#6A737D"}},"// help GC")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                    failed "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"false"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                    "),t("span",{style:{color:"#F97583"}},"return"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#6A737D"}},"// 阻塞在这里")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," ("),t("span",{style:{color:"#B392F0"}},"shouldParkAfterFailedAcquire"),t("span",{style:{color:"#E1E4E8"}},"(p, node) "),t("span",{style:{color:"#F97583"}},"&&"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"parkAndCheckInterrupt"),t("span",{style:{color:"#E1E4E8"}},"())")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#F97583"}},"throw"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"new"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"InterruptedException"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    } "),t("span",{style:{color:"#F97583"}},"finally"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#6A737D"}},"// 阻塞线程被中断后抛出异常，进入取消节点的逻辑")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (failed)")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#B392F0"}},"cancelAcquire"),t("span",{style:{color:"#E1E4E8"}},"(node);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"}")])])]),t("pre",{class:"shiki github-light vp-code-light"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"private"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"void"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"doAcquireSharedInterruptibly"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," arg) throws InterruptedException {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// 将调用latch.await()方法的线程 包装成 SHARED 类型的 node 加入到 AQS 的阻塞队列中")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"final"),t("span",{style:{color:"#24292E"}}," Node node "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"addWaiter"),t("span",{style:{color:"#24292E"}},"(Node.SHARED);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"boolean"),t("span",{style:{color:"#24292E"}}," failed "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"true"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"try"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"for"),t("span",{style:{color:"#24292E"}}," (;;) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#6A737D"}},"// 获取当前节点的前驱节点")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"final"),t("span",{style:{color:"#24292E"}}," Node p "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," node."),t("span",{style:{color:"#6F42C1"}},"predecessor"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#6A737D"}},"// 前驱节点时头节点就可以尝试获取锁")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (p "),t("span",{style:{color:"#D73A49"}},"=="),t("span",{style:{color:"#24292E"}}," head) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#6A737D"}},"// 再次尝试获取锁，获取成功返回 1")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," r "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"tryAcquireShared"),t("span",{style:{color:"#24292E"}},"(arg);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (r "),t("span",{style:{color:"#D73A49"}},">="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"0"),t("span",{style:{color:"#24292E"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                    "),t("span",{style:{color:"#6A737D"}},"// 获取锁成功，设置当前节点为 head 节点，并且向后传播")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                    "),t("span",{style:{color:"#6F42C1"}},"setHeadAndPropagate"),t("span",{style:{color:"#24292E"}},"(node, r);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                    p.next "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"null"),t("span",{style:{color:"#24292E"}},"; "),t("span",{style:{color:"#6A737D"}},"// help GC")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                    failed "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"false"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                    "),t("span",{style:{color:"#D73A49"}},"return"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#6A737D"}},"// 阻塞在这里")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," ("),t("span",{style:{color:"#6F42C1"}},"shouldParkAfterFailedAcquire"),t("span",{style:{color:"#24292E"}},"(p, node) "),t("span",{style:{color:"#D73A49"}},"&&"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"parkAndCheckInterrupt"),t("span",{style:{color:"#24292E"}},"())")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#D73A49"}},"throw"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"new"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"InterruptedException"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    } "),t("span",{style:{color:"#D73A49"}},"finally"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6A737D"}},"// 阻塞线程被中断后抛出异常，进入取消节点的逻辑")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (failed)")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#6F42C1"}},"cancelAcquire"),t("span",{style:{color:"#24292E"}},"(node);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"}")])])]),t("button",{class:"collapse"})])]),t("li",null,[t("p",null,"获取共享锁成功，进入唤醒阻塞队列中与头节点相连的 SHARED 模式的节点："),t("div",{style:{"max-height":"300px"},class:"language-java"},[t("button",{title:"Copy Code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki github-dark vp-code-dark"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"private"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"void"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"setHeadAndPropagate"),t("span",{style:{color:"#E1E4E8"}},"(Node node, "),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," propagate) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    Node h "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," head;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// 将当前节点设置为新的 head 节点，前驱节点和持有线程置为 null")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#B392F0"}},"setHead"),t("span",{style:{color:"#E1E4E8"}},"(node);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"\t"),t("span",{style:{color:"#6A737D"}},"// propagate = 1，条件一成立")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (propagate "),t("span",{style:{color:"#F97583"}},">"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"0"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"||"),t("span",{style:{color:"#E1E4E8"}}," h "),t("span",{style:{color:"#F97583"}},"=="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"null"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"||"),t("span",{style:{color:"#E1E4E8"}}," h.waitStatus "),t("span",{style:{color:"#F97583"}},"<"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"0"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"||"),t("span",{style:{color:"#E1E4E8"}}," (h "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," head) "),t("span",{style:{color:"#F97583"}},"=="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"null"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"||"),t("span",{style:{color:"#E1E4E8"}}," h.waitStatus "),t("span",{style:{color:"#F97583"}},"<"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"0"),t("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#6A737D"}},"// 获取当前节点的后继节点")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        Node s "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," node.next;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#6A737D"}},"// 当前节点是尾节点时 next 为 null，或者后继节点是 SHARED 共享模式")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (s "),t("span",{style:{color:"#F97583"}},"=="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"null"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"||"),t("span",{style:{color:"#E1E4E8"}}," s."),t("span",{style:{color:"#B392F0"}},"isShared"),t("span",{style:{color:"#E1E4E8"}},"())")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#6A737D"}},"// 唤醒所有的等待共享锁的节点")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#B392F0"}},"doReleaseShared"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"}")])])]),t("pre",{class:"shiki github-light vp-code-light"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"private"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"void"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"setHeadAndPropagate"),t("span",{style:{color:"#24292E"}},"(Node node, "),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," propagate) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    Node h "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," head;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// 将当前节点设置为新的 head 节点，前驱节点和持有线程置为 null")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6F42C1"}},"setHead"),t("span",{style:{color:"#24292E"}},"(node);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"\t"),t("span",{style:{color:"#6A737D"}},"// propagate = 1，条件一成立")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (propagate "),t("span",{style:{color:"#D73A49"}},">"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"0"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"||"),t("span",{style:{color:"#24292E"}}," h "),t("span",{style:{color:"#D73A49"}},"=="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"null"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"||"),t("span",{style:{color:"#24292E"}}," h.waitStatus "),t("span",{style:{color:"#D73A49"}},"<"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"0"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"||"),t("span",{style:{color:"#24292E"}}," (h "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," head) "),t("span",{style:{color:"#D73A49"}},"=="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"null"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"||"),t("span",{style:{color:"#24292E"}}," h.waitStatus "),t("span",{style:{color:"#D73A49"}},"<"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"0"),t("span",{style:{color:"#24292E"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6A737D"}},"// 获取当前节点的后继节点")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        Node s "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," node.next;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6A737D"}},"// 当前节点是尾节点时 next 为 null，或者后继节点是 SHARED 共享模式")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (s "),t("span",{style:{color:"#D73A49"}},"=="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"null"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"||"),t("span",{style:{color:"#24292E"}}," s."),t("span",{style:{color:"#6F42C1"}},"isShared"),t("span",{style:{color:"#24292E"}},"())")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#6A737D"}},"// 唤醒所有的等待共享锁的节点")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#6F42C1"}},"doReleaseShared"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"}")])])]),t("button",{class:"collapse"})])])],-1),Lo=t("p",null,"计数减一：",-1),qo=t("ul",null,[t("li",null,[t("p",null,"线程进入 countDown() 完成计数器减一（释放锁）的操作"),t("div",{style:{"max-height":"300px"},class:"language-java"},[t("button",{title:"Copy Code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki github-dark vp-code-dark"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"public"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"void"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"countDown"),t("span",{style:{color:"#E1E4E8"}},"() {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    sync."),t("span",{style:{color:"#B392F0"}},"releaseShared"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#79B8FF"}},"1"),t("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"}")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"public"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"final"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"boolean"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"releaseShared"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," arg) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// 尝试释放共享锁")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," ("),t("span",{style:{color:"#B392F0"}},"tryReleaseShared"),t("span",{style:{color:"#E1E4E8"}},"(arg)) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#6A737D"}},"// 释放锁成功开始唤醒阻塞节点")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#B392F0"}},"doReleaseShared"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"return"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"true"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"return"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"false"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"}")])])]),t("pre",{class:"shiki github-light vp-code-light"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"public"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"void"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"countDown"),t("span",{style:{color:"#24292E"}},"() {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    sync."),t("span",{style:{color:"#6F42C1"}},"releaseShared"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#005CC5"}},"1"),t("span",{style:{color:"#24292E"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"}")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"public"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"final"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"boolean"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"releaseShared"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," arg) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// 尝试释放共享锁")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," ("),t("span",{style:{color:"#6F42C1"}},"tryReleaseShared"),t("span",{style:{color:"#24292E"}},"(arg)) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6A737D"}},"// 释放锁成功开始唤醒阻塞节点")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6F42C1"}},"doReleaseShared"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"return"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"true"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"return"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"false"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"}")])])]),t("button",{class:"collapse"})])]),t("li",null,[t("p",null,"更新 state 值，每调用一次，state 值减一，当 state -1 正好为 0 时，返回 true"),t("div",{style:{"max-height":"300px"},class:"language-java"},[t("button",{title:"Copy Code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki github-dark vp-code-dark"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"protected"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"boolean"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"tryReleaseShared"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," releases) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"for"),t("span",{style:{color:"#E1E4E8"}}," (;;) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," c "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"getState"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#6A737D"}},"// 条件成立说明前面【已经有线程触发唤醒操作】了，这里返回 false")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (c "),t("span",{style:{color:"#F97583"}},"=="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"0"),t("span",{style:{color:"#E1E4E8"}},")")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"return"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"false"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#6A737D"}},"// 计数器减一")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," nextc "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," c"),t("span",{style:{color:"#F97583"}},"-"),t("span",{style:{color:"#79B8FF"}},"1"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," ("),t("span",{style:{color:"#B392F0"}},"compareAndSetState"),t("span",{style:{color:"#E1E4E8"}},"(c, nextc))")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#6A737D"}},"// 计数器为 0 时返回 true")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"return"),t("span",{style:{color:"#E1E4E8"}}," nextc "),t("span",{style:{color:"#F97583"}},"=="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"0"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"}")])])]),t("pre",{class:"shiki github-light vp-code-light"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"protected"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"boolean"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"tryReleaseShared"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," releases) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"for"),t("span",{style:{color:"#24292E"}}," (;;) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," c "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"getState"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6A737D"}},"// 条件成立说明前面【已经有线程触发唤醒操作】了，这里返回 false")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (c "),t("span",{style:{color:"#D73A49"}},"=="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"0"),t("span",{style:{color:"#24292E"}},")")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"return"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"false"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6A737D"}},"// 计数器减一")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," nextc "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," c"),t("span",{style:{color:"#D73A49"}},"-"),t("span",{style:{color:"#005CC5"}},"1"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," ("),t("span",{style:{color:"#6F42C1"}},"compareAndSetState"),t("span",{style:{color:"#24292E"}},"(c, nextc))")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#6A737D"}},"// 计数器为 0 时返回 true")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"return"),t("span",{style:{color:"#24292E"}}," nextc "),t("span",{style:{color:"#D73A49"}},"=="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"0"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"}")])])]),t("button",{class:"collapse"})])]),t("li",null,[t("p",null,[p("state = 0 时，当前线程需要执行"),t("strong",null,"唤醒阻塞节点的任务")]),t("div",{style:{"max-height":"300px"},class:"language-java"},[t("button",{title:"Copy Code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki github-dark vp-code-dark"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"private"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"void"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"doReleaseShared"),t("span",{style:{color:"#E1E4E8"}},"() {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"for"),t("span",{style:{color:"#E1E4E8"}}," (;;) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        Node h "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," head;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#6A737D"}},"// 判断队列是否是空队列")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (h "),t("span",{style:{color:"#F97583"}},"!="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"null"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"&&"),t("span",{style:{color:"#E1E4E8"}}," h "),t("span",{style:{color:"#F97583"}},"!="),t("span",{style:{color:"#E1E4E8"}}," tail) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," ws "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," h.waitStatus;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#6A737D"}},"// 头节点的状态为 signal，说明后继节点没有被唤醒过")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (ws "),t("span",{style:{color:"#F97583"}},"=="),t("span",{style:{color:"#E1E4E8"}}," Node.SIGNAL) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#6A737D"}},"// cas 设置头节点的状态为 0，设置失败继续自旋")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," ("),t("span",{style:{color:"#F97583"}},"!"),t("span",{style:{color:"#B392F0"}},"compareAndSetWaitStatus"),t("span",{style:{color:"#E1E4E8"}},"(h, Node.SIGNAL, "),t("span",{style:{color:"#79B8FF"}},"0"),t("span",{style:{color:"#E1E4E8"}},"))")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                    "),t("span",{style:{color:"#F97583"}},"continue"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#6A737D"}},"// 唤醒后继节点")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#B392F0"}},"unparkSuccessor"),t("span",{style:{color:"#E1E4E8"}},"(h);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#6A737D"}},"// 如果有其他线程已经设置了头节点的状态，重新设置为 PROPAGATE 传播属性")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"else"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (ws "),t("span",{style:{color:"#F97583"}},"=="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"0"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"&&"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"!"),t("span",{style:{color:"#B392F0"}},"compareAndSetWaitStatus"),t("span",{style:{color:"#E1E4E8"}},"(h, "),t("span",{style:{color:"#79B8FF"}},"0"),t("span",{style:{color:"#E1E4E8"}},", Node.PROPAGATE))")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#F97583"}},"continue"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#6A737D"}},"// 条件不成立说明被唤醒的节点非常积极，直接将自己设置为了新的head，")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#6A737D"}},"// 此时唤醒它的节点（前驱）执行 h == head 不成立，所以不会跳出循环，会继续唤醒新的 head 节点的后继节点")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (h "),t("span",{style:{color:"#F97583"}},"=="),t("span",{style:{color:"#E1E4E8"}}," head)")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"break"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"}")])])]),t("pre",{class:"shiki github-light vp-code-light"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"private"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"void"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"doReleaseShared"),t("span",{style:{color:"#24292E"}},"() {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"for"),t("span",{style:{color:"#24292E"}}," (;;) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        Node h "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," head;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6A737D"}},"// 判断队列是否是空队列")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (h "),t("span",{style:{color:"#D73A49"}},"!="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"null"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"&&"),t("span",{style:{color:"#24292E"}}," h "),t("span",{style:{color:"#D73A49"}},"!="),t("span",{style:{color:"#24292E"}}," tail) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," ws "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," h.waitStatus;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#6A737D"}},"// 头节点的状态为 signal，说明后继节点没有被唤醒过")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (ws "),t("span",{style:{color:"#D73A49"}},"=="),t("span",{style:{color:"#24292E"}}," Node.SIGNAL) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#6A737D"}},"// cas 设置头节点的状态为 0，设置失败继续自旋")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," ("),t("span",{style:{color:"#D73A49"}},"!"),t("span",{style:{color:"#6F42C1"}},"compareAndSetWaitStatus"),t("span",{style:{color:"#24292E"}},"(h, Node.SIGNAL, "),t("span",{style:{color:"#005CC5"}},"0"),t("span",{style:{color:"#24292E"}},"))")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                    "),t("span",{style:{color:"#D73A49"}},"continue"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#6A737D"}},"// 唤醒后继节点")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#6F42C1"}},"unparkSuccessor"),t("span",{style:{color:"#24292E"}},"(h);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#6A737D"}},"// 如果有其他线程已经设置了头节点的状态，重新设置为 PROPAGATE 传播属性")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"else"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (ws "),t("span",{style:{color:"#D73A49"}},"=="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"0"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"&&"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"!"),t("span",{style:{color:"#6F42C1"}},"compareAndSetWaitStatus"),t("span",{style:{color:"#24292E"}},"(h, "),t("span",{style:{color:"#005CC5"}},"0"),t("span",{style:{color:"#24292E"}},", Node.PROPAGATE))")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#D73A49"}},"continue"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6A737D"}},"// 条件不成立说明被唤醒的节点非常积极，直接将自己设置为了新的head，")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6A737D"}},"// 此时唤醒它的节点（前驱）执行 h == head 不成立，所以不会跳出循环，会继续唤醒新的 head 节点的后继节点")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (h "),t("span",{style:{color:"#D73A49"}},"=="),t("span",{style:{color:"#24292E"}}," head)")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"break"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"}")])])]),t("button",{class:"collapse"})])])],-1),jo=t("hr",null,null,-1),Oo={id:"cyclicbarrier",tabindex:"-1"},Po={id:"基本使用-5",tabindex:"-1"},Wo=t("p",null,"CyclicBarrier：循环屏障，用来进行线程协作，等待线程满足某个计数，才能触发自己执行",-1),Ho=t("p",null,"常用方法：",-1),_o=t("ul",null,[t("li",null,[t("code",null,"public CyclicBarrier(int parties, Runnable barrierAction)"),p("：用于在线程到达屏障 parties 时，执行 barrierAction "),t("ul",null,[t("li",null,"parties：代表多少个线程到达屏障开始触发线程任务"),t("li",null,"barrierAction：线程任务")])]),t("li",null,[t("code",null,"public int await()"),p("：线程调用 await 方法通知 CyclicBarrier 本线程已经到达屏障")])],-1),Qo=t("p",null,"与 CountDownLatch 的区别：CyclicBarrier 是可以重用的",-1),Go=t("p",null,"应用：可以实现多线程中，某个任务在等待其他线程执行完毕以后触发",-1),zo=t("div",{style:{"max-height":"300px"},class:"language-java"},[t("button",{title:"Copy Code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki github-dark vp-code-dark"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"public"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"static"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"void"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"main"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#F97583"}},"String"),t("span",{style:{color:"#E1E4E8"}},"[] args) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    ExecutorService service "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," Executors."),t("span",{style:{color:"#B392F0"}},"newFixedThreadPool"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#79B8FF"}},"2"),t("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    CyclicBarrier barrier "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"new"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"CyclicBarrier"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#79B8FF"}},"2"),t("span",{style:{color:"#E1E4E8"}},", () "),t("span",{style:{color:"#F97583"}},"->"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        System.out."),t("span",{style:{color:"#B392F0"}},"println"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#9ECBFF"}},'"task1 task2 finish..."'),t("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    });")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"for"),t("span",{style:{color:"#E1E4E8"}}," ("),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," i "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"0"),t("span",{style:{color:"#E1E4E8"}},"; i "),t("span",{style:{color:"#F97583"}},"<"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"3"),t("span",{style:{color:"#E1E4E8"}},"; i"),t("span",{style:{color:"#F97583"}},"++"),t("span",{style:{color:"#E1E4E8"}},") { "),t("span",{style:{color:"#6A737D"}},"// 循环重用")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        service."),t("span",{style:{color:"#B392F0"}},"submit"),t("span",{style:{color:"#E1E4E8"}},"(() "),t("span",{style:{color:"#F97583"}},"->"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            System.out."),t("span",{style:{color:"#B392F0"}},"println"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#9ECBFF"}},'"task1 begin..."'),t("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"try"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                Thread."),t("span",{style:{color:"#B392F0"}},"sleep"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#79B8FF"}},"1000"),t("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                barrier."),t("span",{style:{color:"#B392F0"}},"await"),t("span",{style:{color:"#E1E4E8"}},"();    "),t("span",{style:{color:"#6A737D"}},"// 2 - 1 = 1")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            } "),t("span",{style:{color:"#F97583"}},"catch"),t("span",{style:{color:"#E1E4E8"}}," (InterruptedException | BrokenBarrierException "),t("span",{style:{color:"#FFAB70"}},"e"),t("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                e."),t("span",{style:{color:"#B392F0"}},"printStackTrace"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        });")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        service."),t("span",{style:{color:"#B392F0"}},"submit"),t("span",{style:{color:"#E1E4E8"}},"(() "),t("span",{style:{color:"#F97583"}},"->"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            System.out."),t("span",{style:{color:"#B392F0"}},"println"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#9ECBFF"}},'"task2 begin..."'),t("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"try"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                Thread."),t("span",{style:{color:"#B392F0"}},"sleep"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#79B8FF"}},"2000"),t("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                barrier."),t("span",{style:{color:"#B392F0"}},"await"),t("span",{style:{color:"#E1E4E8"}},"();    "),t("span",{style:{color:"#6A737D"}},"// 1 - 1 = 0")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            } "),t("span",{style:{color:"#F97583"}},"catch"),t("span",{style:{color:"#E1E4E8"}}," (InterruptedException | BrokenBarrierException "),t("span",{style:{color:"#FFAB70"}},"e"),t("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                e."),t("span",{style:{color:"#B392F0"}},"printStackTrace"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        });")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    service."),t("span",{style:{color:"#B392F0"}},"shutdown"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"}")])])]),t("pre",{class:"shiki github-light vp-code-light"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"public"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"static"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"void"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"main"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#D73A49"}},"String"),t("span",{style:{color:"#24292E"}},"[] args) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    ExecutorService service "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," Executors."),t("span",{style:{color:"#6F42C1"}},"newFixedThreadPool"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#005CC5"}},"2"),t("span",{style:{color:"#24292E"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    CyclicBarrier barrier "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"new"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"CyclicBarrier"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#005CC5"}},"2"),t("span",{style:{color:"#24292E"}},", () "),t("span",{style:{color:"#D73A49"}},"->"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        System.out."),t("span",{style:{color:"#6F42C1"}},"println"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#032F62"}},'"task1 task2 finish..."'),t("span",{style:{color:"#24292E"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    });")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"for"),t("span",{style:{color:"#24292E"}}," ("),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," i "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"0"),t("span",{style:{color:"#24292E"}},"; i "),t("span",{style:{color:"#D73A49"}},"<"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"3"),t("span",{style:{color:"#24292E"}},"; i"),t("span",{style:{color:"#D73A49"}},"++"),t("span",{style:{color:"#24292E"}},") { "),t("span",{style:{color:"#6A737D"}},"// 循环重用")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        service."),t("span",{style:{color:"#6F42C1"}},"submit"),t("span",{style:{color:"#24292E"}},"(() "),t("span",{style:{color:"#D73A49"}},"->"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            System.out."),t("span",{style:{color:"#6F42C1"}},"println"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#032F62"}},'"task1 begin..."'),t("span",{style:{color:"#24292E"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"try"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                Thread."),t("span",{style:{color:"#6F42C1"}},"sleep"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#005CC5"}},"1000"),t("span",{style:{color:"#24292E"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                barrier."),t("span",{style:{color:"#6F42C1"}},"await"),t("span",{style:{color:"#24292E"}},"();    "),t("span",{style:{color:"#6A737D"}},"// 2 - 1 = 1")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            } "),t("span",{style:{color:"#D73A49"}},"catch"),t("span",{style:{color:"#24292E"}}," (InterruptedException | BrokenBarrierException "),t("span",{style:{color:"#E36209"}},"e"),t("span",{style:{color:"#24292E"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                e."),t("span",{style:{color:"#6F42C1"}},"printStackTrace"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        });")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        service."),t("span",{style:{color:"#6F42C1"}},"submit"),t("span",{style:{color:"#24292E"}},"(() "),t("span",{style:{color:"#D73A49"}},"->"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            System.out."),t("span",{style:{color:"#6F42C1"}},"println"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#032F62"}},'"task2 begin..."'),t("span",{style:{color:"#24292E"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"try"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                Thread."),t("span",{style:{color:"#6F42C1"}},"sleep"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#005CC5"}},"2000"),t("span",{style:{color:"#24292E"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                barrier."),t("span",{style:{color:"#6F42C1"}},"await"),t("span",{style:{color:"#24292E"}},"();    "),t("span",{style:{color:"#6A737D"}},"// 1 - 1 = 0")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            } "),t("span",{style:{color:"#D73A49"}},"catch"),t("span",{style:{color:"#24292E"}}," (InterruptedException | BrokenBarrierException "),t("span",{style:{color:"#E36209"}},"e"),t("span",{style:{color:"#24292E"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                e."),t("span",{style:{color:"#6F42C1"}},"printStackTrace"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        });")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    service."),t("span",{style:{color:"#6F42C1"}},"shutdown"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"}")])])]),t("button",{class:"collapse"})],-1),Uo=t("hr",null,null,-1),Mo={id:"实现原理-5",tabindex:"-1"},Vo={id:"成员属性-1",tabindex:"-1"},Ko=t("ul",null,[t("li",null,[t("p",null,"全局锁：利用可重入锁实现的工具类"),t("div",{style:{"max-height":"300px"},class:"language-java"},[t("button",{title:"Copy Code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki github-dark vp-code-dark"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// barrier 实现是依赖于Condition条件队列，condition 条件队列必须依赖lock才能使用")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"private"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"final"),t("span",{style:{color:"#E1E4E8"}}," ReentrantLock lock "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"new"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"ReentrantLock"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// 线程挂起实现使用的 condition 队列，当前代所有线程到位，这个条件队列内的线程才会被唤醒")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"private"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"final"),t("span",{style:{color:"#E1E4E8"}}," Condition trip "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," lock."),t("span",{style:{color:"#B392F0"}},"newCondition"),t("span",{style:{color:"#E1E4E8"}},"();")])])]),t("pre",{class:"shiki github-light vp-code-light"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// barrier 实现是依赖于Condition条件队列，condition 条件队列必须依赖lock才能使用")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"private"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"final"),t("span",{style:{color:"#24292E"}}," ReentrantLock lock "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"new"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"ReentrantLock"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// 线程挂起实现使用的 condition 队列，当前代所有线程到位，这个条件队列内的线程才会被唤醒")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"private"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"final"),t("span",{style:{color:"#24292E"}}," Condition trip "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," lock."),t("span",{style:{color:"#6F42C1"}},"newCondition"),t("span",{style:{color:"#24292E"}},"();")])])]),t("button",{class:"collapse"})])]),t("li",null,[t("p",null,"线程数量："),t("div",{style:{"max-height":"300px"},class:"language-java"},[t("button",{title:"Copy Code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki github-dark vp-code-dark"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"private"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"final"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," parties;\t"),t("span",{style:{color:"#6A737D"}},"// 代表多少个线程到达屏障开始触发线程任务")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"private"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," count;\t\t\t"),t("span",{style:{color:"#6A737D"}},"// 表示当前“代”还有多少个线程未到位，初始值为 parties")])])]),t("pre",{class:"shiki github-light vp-code-light"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"private"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"final"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," parties;\t"),t("span",{style:{color:"#6A737D"}},"// 代表多少个线程到达屏障开始触发线程任务")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"private"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," count;\t\t\t"),t("span",{style:{color:"#6A737D"}},"// 表示当前“代”还有多少个线程未到位，初始值为 parties")])])]),t("button",{class:"collapse"})])]),t("li",null,[t("p",null,"当前代中最后一个线程到位后要执行的事件："),t("div",{style:{"max-height":"300px"},class:"language-java"},[t("button",{title:"Copy Code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki github-dark vp-code-dark"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"private"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"final"),t("span",{style:{color:"#E1E4E8"}}," Runnable barrierCommand;")])])]),t("pre",{class:"shiki github-light vp-code-light"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"private"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"final"),t("span",{style:{color:"#24292E"}}," Runnable barrierCommand;")])])]),t("button",{class:"collapse"})])]),t("li",null,[t("p",null,"代："),t("div",{style:{"max-height":"300px"},class:"language-java"},[t("button",{title:"Copy Code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki github-dark vp-code-dark"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// 表示 barrier 对象当前 代")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"private"),t("span",{style:{color:"#E1E4E8"}}," Generation generation "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"new"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"Generation"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"private"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"static"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"class"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"Generation"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// 表示当前“代”是否被打破，如果被打破再来到这一代的线程 就会直接抛出 BrokenException 异常")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// 且在这一代挂起的线程都会被唤醒，然后抛出 BrokerException 异常。")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"boolean"),t("span",{style:{color:"#E1E4E8"}}," broken "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"false"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"}")])])]),t("pre",{class:"shiki github-light vp-code-light"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// 表示 barrier 对象当前 代")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"private"),t("span",{style:{color:"#24292E"}}," Generation generation "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"new"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"Generation"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"private"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"static"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"class"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"Generation"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// 表示当前“代”是否被打破，如果被打破再来到这一代的线程 就会直接抛出 BrokenException 异常")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// 且在这一代挂起的线程都会被唤醒，然后抛出 BrokerException 异常。")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"boolean"),t("span",{style:{color:"#24292E"}}," broken "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"false"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"}")])])]),t("button",{class:"collapse"})])]),t("li",null,[t("p",null,"构造方法："),t("div",{style:{"max-height":"300px"},class:"language-java"},[t("button",{title:"Copy Code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki github-dark vp-code-dark"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"public"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"CyclicBarrie"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," parties, Runnable barrierAction) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// 因为小于等于 0 的 barrier 没有任何意义")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (parties "),t("span",{style:{color:"#F97583"}},"<="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"0"),t("span",{style:{color:"#E1E4E8"}},") "),t("span",{style:{color:"#F97583"}},"throw"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"new"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"IllegalArgumentException"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#79B8FF"}},"this"),t("span",{style:{color:"#E1E4E8"}},".parties "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," parties;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#79B8FF"}},"this"),t("span",{style:{color:"#E1E4E8"}},".count "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," parties;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// 可以为 null")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#79B8FF"}},"this"),t("span",{style:{color:"#E1E4E8"}},".barrierCommand "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," barrierAction;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"}")])])]),t("pre",{class:"shiki github-light vp-code-light"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"public"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"CyclicBarrie"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," parties, Runnable barrierAction) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// 因为小于等于 0 的 barrier 没有任何意义")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (parties "),t("span",{style:{color:"#D73A49"}},"<="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"0"),t("span",{style:{color:"#24292E"}},") "),t("span",{style:{color:"#D73A49"}},"throw"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"new"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"IllegalArgumentException"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#005CC5"}},"this"),t("span",{style:{color:"#24292E"}},".parties "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," parties;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#005CC5"}},"this"),t("span",{style:{color:"#24292E"}},".count "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," parties;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// 可以为 null")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#005CC5"}},"this"),t("span",{style:{color:"#24292E"}},".barrierCommand "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," barrierAction;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"}")])])]),t("button",{class:"collapse"})])])],-1),Xo=t("img",{src:"https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230824174620257.png",alt:"image-20230824174620257",style:{zoom:"80%"}},null,-1),Jo=t("hr",null,null,-1),$o={id:"成员方法",tabindex:"-1"},Zo=t("ul",null,[t("li",null,[t("p",null,"await()：阻塞等待所有线程到位"),t("div",{style:{"max-height":"300px"},class:"language-java"},[t("button",{title:"Copy Code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki github-dark vp-code-dark"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"public"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"await"),t("span",{style:{color:"#E1E4E8"}},"() throws InterruptedException, BrokenBarrierException {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"try"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"return"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"dowait"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#79B8FF"}},"false"),t("span",{style:{color:"#E1E4E8"}},", "),t("span",{style:{color:"#79B8FF"}},"0L"),t("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    } "),t("span",{style:{color:"#F97583"}},"catch"),t("span",{style:{color:"#E1E4E8"}}," (TimeoutException "),t("span",{style:{color:"#FFAB70"}},"toe"),t("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"throw"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"new"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"Error"),t("span",{style:{color:"#E1E4E8"}},"(toe); "),t("span",{style:{color:"#6A737D"}},"// cannot happen")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"}")])])]),t("pre",{class:"shiki github-light vp-code-light"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"public"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"await"),t("span",{style:{color:"#24292E"}},"() throws InterruptedException, BrokenBarrierException {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"try"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"return"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"dowait"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#005CC5"}},"false"),t("span",{style:{color:"#24292E"}},", "),t("span",{style:{color:"#005CC5"}},"0L"),t("span",{style:{color:"#24292E"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    } "),t("span",{style:{color:"#D73A49"}},"catch"),t("span",{style:{color:"#24292E"}}," (TimeoutException "),t("span",{style:{color:"#E36209"}},"toe"),t("span",{style:{color:"#24292E"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"throw"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"new"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"Error"),t("span",{style:{color:"#24292E"}},"(toe); "),t("span",{style:{color:"#6A737D"}},"// cannot happen")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"}")])])]),t("button",{class:"collapse"})]),t("div",{style:{"max-height":"300px"},class:"language-java"},[t("button",{title:"Copy Code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki github-dark vp-code-dark"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// timed：表示当前调用await方法的线程是否指定了超时时长，如果 true 表示线程是响应超时的")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// nanos：线程等待超时时长，单位是纳秒")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"private"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"dowait"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#F97583"}},"boolean"),t("span",{style:{color:"#E1E4E8"}}," timed, "),t("span",{style:{color:"#F97583"}},"long"),t("span",{style:{color:"#E1E4E8"}}," nanos) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"final"),t("span",{style:{color:"#E1E4E8"}}," ReentrantLock lock "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"this"),t("span",{style:{color:"#E1E4E8"}},".lock;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// 加锁")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    lock."),t("span",{style:{color:"#B392F0"}},"lock"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"try"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#6A737D"}},"// 获取当前代")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"final"),t("span",{style:{color:"#E1E4E8"}}," Generation g "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," generation;")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#6A737D"}},"// 【如果当前代是已经被打破状态，则当前调用await方法的线程，直接抛出Broken异常】")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (g.broken)")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"throw"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"new"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"BrokenBarrierException"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"\t\t"),t("span",{style:{color:"#6A737D"}},"// 如果当前线程被中断了，则打破当前代，然后当前线程抛出中断异常")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (Thread."),t("span",{style:{color:"#B392F0"}},"interrupted"),t("span",{style:{color:"#E1E4E8"}},"()) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#6A737D"}},"// 设置当前代的状态为 broken 状态，唤醒在 trip 条件队列内的线程")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#B392F0"}},"breakBarrier"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"throw"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"new"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"InterruptedException"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        }")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#6A737D"}},"// 逻辑到这说明，当前线程中断状态是 false， 当前代的 broken 为 false（未打破状态）")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#6A737D"}},"// 假设 parties 给的是 5，那么index对应的值为 4,3,2,1,0")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," index "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"--"),t("span",{style:{color:"#E1E4E8"}},"count;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#6A737D"}},"// 条件成立说明当前线程是最后一个到达 barrier 的线程，【需要开启新代，唤醒阻塞线程】")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (index "),t("span",{style:{color:"#F97583"}},"=="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"0"),t("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#6A737D"}},"// 栅栏任务启动标记")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"boolean"),t("span",{style:{color:"#E1E4E8"}}," ranAction "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"false"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"try"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#F97583"}},"final"),t("span",{style:{color:"#E1E4E8"}}," Runnable command "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," barrierCommand;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (command "),t("span",{style:{color:"#F97583"}},"!="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"null"),t("span",{style:{color:"#E1E4E8"}},")")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                    "),t("span",{style:{color:"#6A737D"}},"// 启动触发的任务")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                    command."),t("span",{style:{color:"#B392F0"}},"run"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#6A737D"}},"// run()未抛出异常的话，启动标记设置为 true")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                ranAction "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"true"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#6A737D"}},"// 开启新的一代，这里会【唤醒所有的阻塞队列】")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#B392F0"}},"nextGeneration"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#6A737D"}},"// 返回 0 因为当前线程是此代最后一个到达的线程，index == 0")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#F97583"}},"return"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"0"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            } "),t("span",{style:{color:"#F97583"}},"finally"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#6A737D"}},"// 如果 command.run() 执行抛出异常的话，会进入到这里")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," ("),t("span",{style:{color:"#F97583"}},"!"),t("span",{style:{color:"#E1E4E8"}},"ranAction)")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                    "),t("span",{style:{color:"#B392F0"}},"breakBarrier"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        }")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#6A737D"}},"// 自旋，一直到条件满足、当前代被打破、线程被中断，等待超时")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"for"),t("span",{style:{color:"#E1E4E8"}}," (;;) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"try"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#6A737D"}},"// 根据是否需要超时等待选择阻塞方法")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," ("),t("span",{style:{color:"#F97583"}},"!"),t("span",{style:{color:"#E1E4E8"}},"timed)")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                    "),t("span",{style:{color:"#6A737D"}},"// 当前线程释放掉 lock，【进入到 trip 条件队列的尾部挂起自己】，等待被唤醒")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                    trip."),t("span",{style:{color:"#B392F0"}},"await"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#F97583"}},"else"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (nanos "),t("span",{style:{color:"#F97583"}},">"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"0L"),t("span",{style:{color:"#E1E4E8"}},")")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                    nanos "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," trip."),t("span",{style:{color:"#B392F0"}},"awaitNanos"),t("span",{style:{color:"#E1E4E8"}},"(nanos);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            } "),t("span",{style:{color:"#F97583"}},"catch"),t("span",{style:{color:"#E1E4E8"}}," (InterruptedException "),t("span",{style:{color:"#FFAB70"}},"ie"),t("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#6A737D"}},"// 被中断后来到这里的逻辑")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#6A737D"}},"// 当前代没有变化并且没有被打破")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (g "),t("span",{style:{color:"#F97583"}},"=="),t("span",{style:{color:"#E1E4E8"}}," generation "),t("span",{style:{color:"#F97583"}},"&&"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"!"),t("span",{style:{color:"#E1E4E8"}},"g.broken) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                    "),t("span",{style:{color:"#6A737D"}},"// 打破屏障")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                    "),t("span",{style:{color:"#B392F0"}},"breakBarrier"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                    "),t("span",{style:{color:"#6A737D"}},"// node 节点在【条件队列】内收到中断信号时 会抛出中断异常")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                    "),t("span",{style:{color:"#F97583"}},"throw"),t("span",{style:{color:"#E1E4E8"}}," ie;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                } "),t("span",{style:{color:"#F97583"}},"else"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                    "),t("span",{style:{color:"#6A737D"}},"// 等待过程中代变化了，完成一次自我打断")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                    Thread."),t("span",{style:{color:"#B392F0"}},"currentThread"),t("span",{style:{color:"#E1E4E8"}},"()."),t("span",{style:{color:"#B392F0"}},"interrupt"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"\t\t\t"),t("span",{style:{color:"#6A737D"}},"// 唤醒后的线程，【判断当前代已经被打破，线程唤醒后依次抛出 BrokenBarrier 异常】")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (g.broken)")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#F97583"}},"throw"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"new"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"BrokenBarrierException"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#6A737D"}},"// 当前线程挂起期间，最后一个线程到位了，然后触发了开启新的一代的逻辑")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (g "),t("span",{style:{color:"#F97583"}},"!="),t("span",{style:{color:"#E1E4E8"}}," generation)")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#F97583"}},"return"),t("span",{style:{color:"#E1E4E8"}}," index;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"\t\t\t"),t("span",{style:{color:"#6A737D"}},"// 当前线程 trip 中等待超时，然后主动转移到阻塞队列")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (timed "),t("span",{style:{color:"#F97583"}},"&&"),t("span",{style:{color:"#E1E4E8"}}," nanos "),t("span",{style:{color:"#F97583"}},"<="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"0L"),t("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#B392F0"}},"breakBarrier"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#6A737D"}},"// 抛出超时异常")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#F97583"}},"throw"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"new"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"TimeoutException"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    } "),t("span",{style:{color:"#F97583"}},"finally"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#6A737D"}},"// 解锁")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        lock."),t("span",{style:{color:"#B392F0"}},"unlock"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"}")])])]),t("pre",{class:"shiki github-light vp-code-light"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// timed：表示当前调用await方法的线程是否指定了超时时长，如果 true 表示线程是响应超时的")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// nanos：线程等待超时时长，单位是纳秒")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"private"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"dowait"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#D73A49"}},"boolean"),t("span",{style:{color:"#24292E"}}," timed, "),t("span",{style:{color:"#D73A49"}},"long"),t("span",{style:{color:"#24292E"}}," nanos) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"final"),t("span",{style:{color:"#24292E"}}," ReentrantLock lock "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"this"),t("span",{style:{color:"#24292E"}},".lock;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// 加锁")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    lock."),t("span",{style:{color:"#6F42C1"}},"lock"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"try"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6A737D"}},"// 获取当前代")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"final"),t("span",{style:{color:"#24292E"}}," Generation g "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," generation;")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6A737D"}},"// 【如果当前代是已经被打破状态，则当前调用await方法的线程，直接抛出Broken异常】")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (g.broken)")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"throw"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"new"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"BrokenBarrierException"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"\t\t"),t("span",{style:{color:"#6A737D"}},"// 如果当前线程被中断了，则打破当前代，然后当前线程抛出中断异常")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (Thread."),t("span",{style:{color:"#6F42C1"}},"interrupted"),t("span",{style:{color:"#24292E"}},"()) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#6A737D"}},"// 设置当前代的状态为 broken 状态，唤醒在 trip 条件队列内的线程")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#6F42C1"}},"breakBarrier"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"throw"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"new"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"InterruptedException"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        }")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6A737D"}},"// 逻辑到这说明，当前线程中断状态是 false， 当前代的 broken 为 false（未打破状态）")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6A737D"}},"// 假设 parties 给的是 5，那么index对应的值为 4,3,2,1,0")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," index "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"--"),t("span",{style:{color:"#24292E"}},"count;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6A737D"}},"// 条件成立说明当前线程是最后一个到达 barrier 的线程，【需要开启新代，唤醒阻塞线程】")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (index "),t("span",{style:{color:"#D73A49"}},"=="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"0"),t("span",{style:{color:"#24292E"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#6A737D"}},"// 栅栏任务启动标记")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"boolean"),t("span",{style:{color:"#24292E"}}," ranAction "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"false"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"try"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#D73A49"}},"final"),t("span",{style:{color:"#24292E"}}," Runnable command "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," barrierCommand;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (command "),t("span",{style:{color:"#D73A49"}},"!="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"null"),t("span",{style:{color:"#24292E"}},")")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                    "),t("span",{style:{color:"#6A737D"}},"// 启动触发的任务")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                    command."),t("span",{style:{color:"#6F42C1"}},"run"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#6A737D"}},"// run()未抛出异常的话，启动标记设置为 true")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                ranAction "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"true"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#6A737D"}},"// 开启新的一代，这里会【唤醒所有的阻塞队列】")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#6F42C1"}},"nextGeneration"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#6A737D"}},"// 返回 0 因为当前线程是此代最后一个到达的线程，index == 0")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#D73A49"}},"return"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"0"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            } "),t("span",{style:{color:"#D73A49"}},"finally"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#6A737D"}},"// 如果 command.run() 执行抛出异常的话，会进入到这里")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," ("),t("span",{style:{color:"#D73A49"}},"!"),t("span",{style:{color:"#24292E"}},"ranAction)")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                    "),t("span",{style:{color:"#6F42C1"}},"breakBarrier"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        }")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6A737D"}},"// 自旋，一直到条件满足、当前代被打破、线程被中断，等待超时")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"for"),t("span",{style:{color:"#24292E"}}," (;;) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"try"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#6A737D"}},"// 根据是否需要超时等待选择阻塞方法")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," ("),t("span",{style:{color:"#D73A49"}},"!"),t("span",{style:{color:"#24292E"}},"timed)")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                    "),t("span",{style:{color:"#6A737D"}},"// 当前线程释放掉 lock，【进入到 trip 条件队列的尾部挂起自己】，等待被唤醒")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                    trip."),t("span",{style:{color:"#6F42C1"}},"await"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#D73A49"}},"else"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (nanos "),t("span",{style:{color:"#D73A49"}},">"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"0L"),t("span",{style:{color:"#24292E"}},")")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                    nanos "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," trip."),t("span",{style:{color:"#6F42C1"}},"awaitNanos"),t("span",{style:{color:"#24292E"}},"(nanos);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            } "),t("span",{style:{color:"#D73A49"}},"catch"),t("span",{style:{color:"#24292E"}}," (InterruptedException "),t("span",{style:{color:"#E36209"}},"ie"),t("span",{style:{color:"#24292E"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#6A737D"}},"// 被中断后来到这里的逻辑")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#6A737D"}},"// 当前代没有变化并且没有被打破")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (g "),t("span",{style:{color:"#D73A49"}},"=="),t("span",{style:{color:"#24292E"}}," generation "),t("span",{style:{color:"#D73A49"}},"&&"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"!"),t("span",{style:{color:"#24292E"}},"g.broken) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                    "),t("span",{style:{color:"#6A737D"}},"// 打破屏障")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                    "),t("span",{style:{color:"#6F42C1"}},"breakBarrier"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                    "),t("span",{style:{color:"#6A737D"}},"// node 节点在【条件队列】内收到中断信号时 会抛出中断异常")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                    "),t("span",{style:{color:"#D73A49"}},"throw"),t("span",{style:{color:"#24292E"}}," ie;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                } "),t("span",{style:{color:"#D73A49"}},"else"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                    "),t("span",{style:{color:"#6A737D"}},"// 等待过程中代变化了，完成一次自我打断")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                    Thread."),t("span",{style:{color:"#6F42C1"}},"currentThread"),t("span",{style:{color:"#24292E"}},"()."),t("span",{style:{color:"#6F42C1"}},"interrupt"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"\t\t\t"),t("span",{style:{color:"#6A737D"}},"// 唤醒后的线程，【判断当前代已经被打破，线程唤醒后依次抛出 BrokenBarrier 异常】")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (g.broken)")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#D73A49"}},"throw"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"new"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"BrokenBarrierException"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#6A737D"}},"// 当前线程挂起期间，最后一个线程到位了，然后触发了开启新的一代的逻辑")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (g "),t("span",{style:{color:"#D73A49"}},"!="),t("span",{style:{color:"#24292E"}}," generation)")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#D73A49"}},"return"),t("span",{style:{color:"#24292E"}}," index;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"\t\t\t"),t("span",{style:{color:"#6A737D"}},"// 当前线程 trip 中等待超时，然后主动转移到阻塞队列")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (timed "),t("span",{style:{color:"#D73A49"}},"&&"),t("span",{style:{color:"#24292E"}}," nanos "),t("span",{style:{color:"#D73A49"}},"<="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"0L"),t("span",{style:{color:"#24292E"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#6F42C1"}},"breakBarrier"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#6A737D"}},"// 抛出超时异常")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#D73A49"}},"throw"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"new"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"TimeoutException"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    } "),t("span",{style:{color:"#D73A49"}},"finally"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6A737D"}},"// 解锁")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        lock."),t("span",{style:{color:"#6F42C1"}},"unlock"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"}")])])]),t("button",{class:"collapse"})])]),t("li",null,[t("p",null,"breakBarrier()：打破 Barrier 屏障"),t("div",{style:{"max-height":"300px"},class:"language-java"},[t("button",{title:"Copy Code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki github-dark vp-code-dark"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"private"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"void"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"breakBarrier"),t("span",{style:{color:"#E1E4E8"}},"() {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// 将代中的 broken 设置为 true，表示这一代是被打破了，再来到这一代的线程，直接抛出异常")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    generation.broken "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"true"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// 重置 count 为 parties")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    count "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," parties;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// 将在trip条件队列内挂起的线程全部唤醒，唤醒后的线程会检查当前是否是打破的，然后抛出异常")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    trip."),t("span",{style:{color:"#B392F0"}},"signalAll"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"}")])])]),t("pre",{class:"shiki github-light vp-code-light"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"private"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"void"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"breakBarrier"),t("span",{style:{color:"#24292E"}},"() {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// 将代中的 broken 设置为 true，表示这一代是被打破了，再来到这一代的线程，直接抛出异常")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    generation.broken "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"true"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// 重置 count 为 parties")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    count "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," parties;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// 将在trip条件队列内挂起的线程全部唤醒，唤醒后的线程会检查当前是否是打破的，然后抛出异常")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    trip."),t("span",{style:{color:"#6F42C1"}},"signalAll"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"}")])])]),t("button",{class:"collapse"})])]),t("li",null,[t("p",null,"nextGeneration()：开启新的下一代"),t("div",{style:{"max-height":"300px"},class:"language-java"},[t("button",{title:"Copy Code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki github-dark vp-code-dark"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"private"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"void"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"nextGeneration"),t("span",{style:{color:"#E1E4E8"}},"() {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// 将在 trip 条件队列内挂起的线程全部唤醒")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    trip."),t("span",{style:{color:"#B392F0"}},"signalAll"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// 重置 count 为 parties")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    count "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," parties;")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// 开启新的一代，使用一个新的generation对象，表示新的一代，新的一代和上一代【没有任何关系】")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    generation "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"new"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"Generation"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"}")])])]),t("pre",{class:"shiki github-light vp-code-light"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"private"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"void"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"nextGeneration"),t("span",{style:{color:"#24292E"}},"() {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// 将在 trip 条件队列内挂起的线程全部唤醒")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    trip."),t("span",{style:{color:"#6F42C1"}},"signalAll"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// 重置 count 为 parties")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    count "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," parties;")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// 开启新的一代，使用一个新的generation对象，表示新的一代，新的一代和上一代【没有任何关系】")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    generation "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"new"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"Generation"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"}")])])]),t("button",{class:"collapse"})])])],-1),Yo=t("hr",null,null,-1),sn={id:"semaphore",tabindex:"-1"},ln={id:"基本使用-6",tabindex:"-1"},on=t("p",null,"synchronized 可以起到锁的作用，但某个时间段内，只能有一个线程允许执行",-1),nn=t("p",null,"Semaphore（信号量）用来限制能同时访问共享资源的线程上限，非重入锁",-1),an=t("p",null,"构造方法：",-1),en=t("ul",null,[t("li",null,[t("code",null,"public Semaphore(int permits)"),p("：permits 表示许可线程的数量（state）")]),t("li",null,[t("code",null,"public Semaphore(int permits, boolean fair)"),p("：fair 表示公平性，如果设为 true，下次执行的线程会是等待最久的线程")])],-1),cn=t("p",null,"常用API：",-1),tn=t("ul",null,[t("li",null,[t("code",null,"public void acquire()"),p("：表示获取许可")]),t("li",null,[t("code",null,"public void release()"),p("：表示释放许可，acquire() 和 release() 方法之间的代码为同步代码")])],-1),pn=t("div",{style:{"max-height":"300px"},class:"language-java"},[t("button",{title:"Copy Code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki github-dark vp-code-dark"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"public"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"static"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"void"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"main"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#F97583"}},"String"),t("span",{style:{color:"#E1E4E8"}},"[] args) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// 1.创建Semaphore对象")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    Semaphore semaphore "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"new"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"Semaphore"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#79B8FF"}},"3"),t("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// 2. 10个线程同时运行")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"for"),t("span",{style:{color:"#E1E4E8"}}," ("),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," i "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"0"),t("span",{style:{color:"#E1E4E8"}},"; i "),t("span",{style:{color:"#F97583"}},"<"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"10"),t("span",{style:{color:"#E1E4E8"}},"; i"),t("span",{style:{color:"#F97583"}},"++"),t("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"new"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"Thread"),t("span",{style:{color:"#E1E4E8"}},"(() "),t("span",{style:{color:"#F97583"}},"->"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"try"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#6A737D"}},"// 3. 获取许可")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                semaphore."),t("span",{style:{color:"#B392F0"}},"acquire"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#B392F0"}},"sout"),t("span",{style:{color:"#E1E4E8"}},"(Thread."),t("span",{style:{color:"#B392F0"}},"currentThread"),t("span",{style:{color:"#E1E4E8"}},"()."),t("span",{style:{color:"#B392F0"}},"getName"),t("span",{style:{color:"#E1E4E8"}},"() "),t("span",{style:{color:"#F97583"}},"+"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#9ECBFF"}},'" running..."'),t("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                Thread."),t("span",{style:{color:"#B392F0"}},"sleep"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#79B8FF"}},"1000"),t("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#B392F0"}},"sout"),t("span",{style:{color:"#E1E4E8"}},"(Thread."),t("span",{style:{color:"#B392F0"}},"currentThread"),t("span",{style:{color:"#E1E4E8"}},"()."),t("span",{style:{color:"#B392F0"}},"getName"),t("span",{style:{color:"#E1E4E8"}},"() "),t("span",{style:{color:"#F97583"}},"+"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#9ECBFF"}},'" end..."'),t("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            } "),t("span",{style:{color:"#F97583"}},"catch"),t("span",{style:{color:"#E1E4E8"}}," (InterruptedException "),t("span",{style:{color:"#FFAB70"}},"e"),t("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                e."),t("span",{style:{color:"#B392F0"}},"printStackTrace"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            } "),t("span",{style:{color:"#F97583"}},"finally"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#6A737D"}},"// 4. 释放许可")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                semaphore."),t("span",{style:{color:"#B392F0"}},"release"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        })."),t("span",{style:{color:"#B392F0"}},"start"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"}")])])]),t("pre",{class:"shiki github-light vp-code-light"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"public"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"static"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"void"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"main"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#D73A49"}},"String"),t("span",{style:{color:"#24292E"}},"[] args) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// 1.创建Semaphore对象")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    Semaphore semaphore "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"new"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"Semaphore"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#005CC5"}},"3"),t("span",{style:{color:"#24292E"}},");")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// 2. 10个线程同时运行")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"for"),t("span",{style:{color:"#24292E"}}," ("),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," i "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"0"),t("span",{style:{color:"#24292E"}},"; i "),t("span",{style:{color:"#D73A49"}},"<"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"10"),t("span",{style:{color:"#24292E"}},"; i"),t("span",{style:{color:"#D73A49"}},"++"),t("span",{style:{color:"#24292E"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"new"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"Thread"),t("span",{style:{color:"#24292E"}},"(() "),t("span",{style:{color:"#D73A49"}},"->"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"try"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#6A737D"}},"// 3. 获取许可")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                semaphore."),t("span",{style:{color:"#6F42C1"}},"acquire"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#6F42C1"}},"sout"),t("span",{style:{color:"#24292E"}},"(Thread."),t("span",{style:{color:"#6F42C1"}},"currentThread"),t("span",{style:{color:"#24292E"}},"()."),t("span",{style:{color:"#6F42C1"}},"getName"),t("span",{style:{color:"#24292E"}},"() "),t("span",{style:{color:"#D73A49"}},"+"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#032F62"}},'" running..."'),t("span",{style:{color:"#24292E"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                Thread."),t("span",{style:{color:"#6F42C1"}},"sleep"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#005CC5"}},"1000"),t("span",{style:{color:"#24292E"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#6F42C1"}},"sout"),t("span",{style:{color:"#24292E"}},"(Thread."),t("span",{style:{color:"#6F42C1"}},"currentThread"),t("span",{style:{color:"#24292E"}},"()."),t("span",{style:{color:"#6F42C1"}},"getName"),t("span",{style:{color:"#24292E"}},"() "),t("span",{style:{color:"#D73A49"}},"+"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#032F62"}},'" end..."'),t("span",{style:{color:"#24292E"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            } "),t("span",{style:{color:"#D73A49"}},"catch"),t("span",{style:{color:"#24292E"}}," (InterruptedException "),t("span",{style:{color:"#E36209"}},"e"),t("span",{style:{color:"#24292E"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                e."),t("span",{style:{color:"#6F42C1"}},"printStackTrace"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            } "),t("span",{style:{color:"#D73A49"}},"finally"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#6A737D"}},"// 4. 释放许可")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                semaphore."),t("span",{style:{color:"#6F42C1"}},"release"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        })."),t("span",{style:{color:"#6F42C1"}},"start"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"}")])])]),t("button",{class:"collapse"})],-1),rn=t("hr",null,null,-1),En={id:"实现原理-6",tabindex:"-1"},yn=t("p",null,"加锁流程：",-1),Fn=t("ul",null,[t("li",null,[t("p",null,"Semaphore 的 permits（state）为 3，这时 5 个线程来获取资源"),t("div",{style:{"max-height":"300px"},class:"language-java"},[t("button",{title:"Copy Code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki github-dark vp-code-dark"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#B392F0"}},"Sync"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," permits) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#B392F0"}},"setState"),t("span",{style:{color:"#E1E4E8"}},"(permits);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"}")])])]),t("pre",{class:"shiki github-light vp-code-light"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#6F42C1"}},"Sync"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," permits) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6F42C1"}},"setState"),t("span",{style:{color:"#24292E"}},"(permits);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"}")])])]),t("button",{class:"collapse"})]),t("p",null,"假设其中 Thread-1，Thread-2，Thread-4 CAS 竞争成功，permits 变为 0，而 Thread-0 和 Thread-3 竞争失败，进入 AQS 队列park 阻塞"),t("div",{style:{"max-height":"300px"},class:"language-java"},[t("button",{title:"Copy Code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki github-dark vp-code-dark"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// acquire() -> sync.acquireSharedInterruptibly(1)，可中断")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"public"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"final"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"void"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"acquireSharedInterruptibly"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," arg) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (Thread."),t("span",{style:{color:"#B392F0"}},"interrupted"),t("span",{style:{color:"#E1E4E8"}},"())")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"throw"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"new"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"InterruptedException"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// 尝试获取通行证，获取成功返回 >= 0的值")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," ("),t("span",{style:{color:"#B392F0"}},"tryAcquireShared"),t("span",{style:{color:"#E1E4E8"}},"(arg) "),t("span",{style:{color:"#F97583"}},"<"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"0"),t("span",{style:{color:"#E1E4E8"}},")")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#6A737D"}},"// 获取许可证失败，进入阻塞")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#B392F0"}},"doAcquireSharedInterruptibly"),t("span",{style:{color:"#E1E4E8"}},"(arg);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"}")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// tryAcquireShared() -> nonfairTryAcquireShared()")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// 非公平，公平锁会在循环内 hasQueuedPredecessors()方法判断阻塞队列是否有临头节点(第二个节点)")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"final"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"nonfairTryAcquireShared"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," acquires) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"for"),t("span",{style:{color:"#E1E4E8"}}," (;;) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#6A737D"}},"// 获取 state ，state 这里【表示通行证】")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," available "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"getState"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#6A737D"}},"// 计算当前线程获取通行证完成之后，通行证还剩余数量")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," remaining "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," available "),t("span",{style:{color:"#F97583"}},"-"),t("span",{style:{color:"#E1E4E8"}}," acquires;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#6A737D"}},"// 如果许可已经用完, 返回负数, 表示获取失败,")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (remaining "),t("span",{style:{color:"#F97583"}},"<"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"0"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"||")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#6A737D"}},"// 许可证足够分配的，如果 cas 重试成功, 返回正数, 表示获取成功")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#B392F0"}},"compareAndSetState"),t("span",{style:{color:"#E1E4E8"}},"(available, remaining))")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"return"),t("span",{style:{color:"#E1E4E8"}}," remaining;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"}")])])]),t("pre",{class:"shiki github-light vp-code-light"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// acquire() -> sync.acquireSharedInterruptibly(1)，可中断")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"public"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"final"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"void"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"acquireSharedInterruptibly"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," arg) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (Thread."),t("span",{style:{color:"#6F42C1"}},"interrupted"),t("span",{style:{color:"#24292E"}},"())")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"throw"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"new"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"InterruptedException"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// 尝试获取通行证，获取成功返回 >= 0的值")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," ("),t("span",{style:{color:"#6F42C1"}},"tryAcquireShared"),t("span",{style:{color:"#24292E"}},"(arg) "),t("span",{style:{color:"#D73A49"}},"<"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"0"),t("span",{style:{color:"#24292E"}},")")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6A737D"}},"// 获取许可证失败，进入阻塞")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6F42C1"}},"doAcquireSharedInterruptibly"),t("span",{style:{color:"#24292E"}},"(arg);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"}")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// tryAcquireShared() -> nonfairTryAcquireShared()")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// 非公平，公平锁会在循环内 hasQueuedPredecessors()方法判断阻塞队列是否有临头节点(第二个节点)")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"final"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"nonfairTryAcquireShared"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," acquires) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"for"),t("span",{style:{color:"#24292E"}}," (;;) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6A737D"}},"// 获取 state ，state 这里【表示通行证】")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," available "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"getState"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6A737D"}},"// 计算当前线程获取通行证完成之后，通行证还剩余数量")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," remaining "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," available "),t("span",{style:{color:"#D73A49"}},"-"),t("span",{style:{color:"#24292E"}}," acquires;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6A737D"}},"// 如果许可已经用完, 返回负数, 表示获取失败,")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (remaining "),t("span",{style:{color:"#D73A49"}},"<"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"0"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"||")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#6A737D"}},"// 许可证足够分配的，如果 cas 重试成功, 返回正数, 表示获取成功")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#6F42C1"}},"compareAndSetState"),t("span",{style:{color:"#24292E"}},"(available, remaining))")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"return"),t("span",{style:{color:"#24292E"}}," remaining;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"}")])])]),t("button",{class:"collapse"})]),t("div",{style:{"max-height":"300px"},class:"language-java"},[t("button",{title:"Copy Code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki github-dark vp-code-dark"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"private"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"void"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"doAcquireSharedInterruptibly"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," arg) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// 将调用 Semaphore.aquire 方法的线程，包装成 node 加入到 AQS 的阻塞队列中")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"final"),t("span",{style:{color:"#E1E4E8"}}," Node node "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"addWaiter"),t("span",{style:{color:"#E1E4E8"}},"(Node.SHARED);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// 获取标记")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"boolean"),t("span",{style:{color:"#E1E4E8"}}," failed "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"true"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"try"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"for"),t("span",{style:{color:"#E1E4E8"}}," (;;) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"final"),t("span",{style:{color:"#E1E4E8"}}," Node p "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," node."),t("span",{style:{color:"#B392F0"}},"predecessor"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#6A737D"}},"// 前驱节点是头节点可以再次获取许可")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (p "),t("span",{style:{color:"#F97583"}},"=="),t("span",{style:{color:"#E1E4E8"}}," head) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#6A737D"}},"// 再次尝试获取许可，【返回剩余的许可证数量】")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," r "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"tryAcquireShared"),t("span",{style:{color:"#E1E4E8"}},"(arg);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (r "),t("span",{style:{color:"#F97583"}},">="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"0"),t("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                    "),t("span",{style:{color:"#6A737D"}},"// 成功后本线程出队（AQS）, 所在 Node设置为 head")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                    "),t("span",{style:{color:"#6A737D"}},"// r 表示【可用资源数】, 为 0 则不会继续传播")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                    "),t("span",{style:{color:"#B392F0"}},"setHeadAndPropagate"),t("span",{style:{color:"#E1E4E8"}},"(node, r); ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                    p.next "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"null"),t("span",{style:{color:"#E1E4E8"}},"; "),t("span",{style:{color:"#6A737D"}},"// help GC")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                    failed "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"false"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                    "),t("span",{style:{color:"#F97583"}},"return"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#6A737D"}},"// 不成功, 设置上一个节点 waitStatus = Node.SIGNAL, 下轮进入 park 阻塞")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," ("),t("span",{style:{color:"#B392F0"}},"shouldParkAfterFailedAcquire"),t("span",{style:{color:"#E1E4E8"}},"(p, node) "),t("span",{style:{color:"#F97583"}},"&&"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"parkAndCheckInterrupt"),t("span",{style:{color:"#E1E4E8"}},"())")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#F97583"}},"throw"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"new"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"InterruptedException"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    } "),t("span",{style:{color:"#F97583"}},"finally"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#6A737D"}},"// 被打断后进入该逻辑")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (failed)")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#B392F0"}},"cancelAcquire"),t("span",{style:{color:"#E1E4E8"}},"(node);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"}")])])]),t("pre",{class:"shiki github-light vp-code-light"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"private"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"void"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"doAcquireSharedInterruptibly"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," arg) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// 将调用 Semaphore.aquire 方法的线程，包装成 node 加入到 AQS 的阻塞队列中")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"final"),t("span",{style:{color:"#24292E"}}," Node node "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"addWaiter"),t("span",{style:{color:"#24292E"}},"(Node.SHARED);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// 获取标记")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"boolean"),t("span",{style:{color:"#24292E"}}," failed "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"true"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"try"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"for"),t("span",{style:{color:"#24292E"}}," (;;) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"final"),t("span",{style:{color:"#24292E"}}," Node p "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," node."),t("span",{style:{color:"#6F42C1"}},"predecessor"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#6A737D"}},"// 前驱节点是头节点可以再次获取许可")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (p "),t("span",{style:{color:"#D73A49"}},"=="),t("span",{style:{color:"#24292E"}}," head) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#6A737D"}},"// 再次尝试获取许可，【返回剩余的许可证数量】")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," r "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"tryAcquireShared"),t("span",{style:{color:"#24292E"}},"(arg);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (r "),t("span",{style:{color:"#D73A49"}},">="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"0"),t("span",{style:{color:"#24292E"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                    "),t("span",{style:{color:"#6A737D"}},"// 成功后本线程出队（AQS）, 所在 Node设置为 head")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                    "),t("span",{style:{color:"#6A737D"}},"// r 表示【可用资源数】, 为 0 则不会继续传播")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                    "),t("span",{style:{color:"#6F42C1"}},"setHeadAndPropagate"),t("span",{style:{color:"#24292E"}},"(node, r); ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                    p.next "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"null"),t("span",{style:{color:"#24292E"}},"; "),t("span",{style:{color:"#6A737D"}},"// help GC")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                    failed "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"false"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                    "),t("span",{style:{color:"#D73A49"}},"return"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#6A737D"}},"// 不成功, 设置上一个节点 waitStatus = Node.SIGNAL, 下轮进入 park 阻塞")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," ("),t("span",{style:{color:"#6F42C1"}},"shouldParkAfterFailedAcquire"),t("span",{style:{color:"#24292E"}},"(p, node) "),t("span",{style:{color:"#D73A49"}},"&&"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"parkAndCheckInterrupt"),t("span",{style:{color:"#24292E"}},"())")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#D73A49"}},"throw"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"new"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"InterruptedException"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    } "),t("span",{style:{color:"#D73A49"}},"finally"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6A737D"}},"// 被打断后进入该逻辑")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (failed)")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#6F42C1"}},"cancelAcquire"),t("span",{style:{color:"#24292E"}},"(node);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"}")])])]),t("button",{class:"collapse"})]),t("div",{style:{"max-height":"300px"},class:"language-java"},[t("button",{title:"Copy Code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki github-dark vp-code-dark"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"private"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"void"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"setHeadAndPropagate"),t("span",{style:{color:"#E1E4E8"}},"(Node node, "),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," propagate) {    ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    Node h "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," head;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// 设置自己为 head 节点")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#B392F0"}},"setHead"),t("span",{style:{color:"#E1E4E8"}},"(node);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// propagate 表示有【共享资源】（例如共享读锁或信号量）")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// head waitStatus == Node.SIGNAL 或 Node.PROPAGATE，doReleaseShared 函数中设置的")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (propagate "),t("span",{style:{color:"#F97583"}},">"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"0"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"||"),t("span",{style:{color:"#E1E4E8"}}," h "),t("span",{style:{color:"#F97583"}},"=="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"null"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"||"),t("span",{style:{color:"#E1E4E8"}}," h.waitStatus "),t("span",{style:{color:"#F97583"}},"<"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"0"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"||")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        (h "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," head) "),t("span",{style:{color:"#F97583"}},"=="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"null"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"||"),t("span",{style:{color:"#E1E4E8"}}," h.waitStatus "),t("span",{style:{color:"#F97583"}},"<"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"0"),t("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        Node s "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," node.next;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#6A737D"}},"// 如果是最后一个节点或者是等待共享读锁的节点，做一次唤醒")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (s "),t("span",{style:{color:"#F97583"}},"=="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"null"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"||"),t("span",{style:{color:"#E1E4E8"}}," s."),t("span",{style:{color:"#B392F0"}},"isShared"),t("span",{style:{color:"#E1E4E8"}},"())")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#B392F0"}},"doReleaseShared"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"}")])])]),t("pre",{class:"shiki github-light vp-code-light"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"private"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"void"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"setHeadAndPropagate"),t("span",{style:{color:"#24292E"}},"(Node node, "),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," propagate) {    ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    Node h "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," head;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// 设置自己为 head 节点")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6F42C1"}},"setHead"),t("span",{style:{color:"#24292E"}},"(node);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// propagate 表示有【共享资源】（例如共享读锁或信号量）")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// head waitStatus == Node.SIGNAL 或 Node.PROPAGATE，doReleaseShared 函数中设置的")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (propagate "),t("span",{style:{color:"#D73A49"}},">"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"0"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"||"),t("span",{style:{color:"#24292E"}}," h "),t("span",{style:{color:"#D73A49"}},"=="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"null"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"||"),t("span",{style:{color:"#24292E"}}," h.waitStatus "),t("span",{style:{color:"#D73A49"}},"<"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"0"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"||")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        (h "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," head) "),t("span",{style:{color:"#D73A49"}},"=="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"null"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"||"),t("span",{style:{color:"#24292E"}}," h.waitStatus "),t("span",{style:{color:"#D73A49"}},"<"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"0"),t("span",{style:{color:"#24292E"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        Node s "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," node.next;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6A737D"}},"// 如果是最后一个节点或者是等待共享读锁的节点，做一次唤醒")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (s "),t("span",{style:{color:"#D73A49"}},"=="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"null"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"||"),t("span",{style:{color:"#24292E"}}," s."),t("span",{style:{color:"#6F42C1"}},"isShared"),t("span",{style:{color:"#24292E"}},"())")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#6F42C1"}},"doReleaseShared"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"}")])])]),t("button",{class:"collapse"})]),t("img",{src:"https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230719211343768.png",alt:"image-20230719211343768",style:{zoom:"80%"}})]),t("li",null,[t("p",null,"这时 Thread-4 释放了 permits，状态如下"),t("div",{style:{"max-height":"300px"},class:"language-java"},[t("button",{title:"Copy Code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki github-dark vp-code-dark"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// release() -> releaseShared()")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"public"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"final"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"boolean"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"releaseShared"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," arg) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// 尝试释放锁")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," ("),t("span",{style:{color:"#B392F0"}},"tryReleaseShared"),t("span",{style:{color:"#E1E4E8"}},"(arg)) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#B392F0"}},"doReleaseShared"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"return"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"true"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    }    ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"return"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"false"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"}")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"protected"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"final"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"boolean"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"tryReleaseShared"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," releases) {    ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"for"),t("span",{style:{color:"#E1E4E8"}}," (;;) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#6A737D"}},"// 获取当前锁资源的可用许可证数量")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," current "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"getState"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," next "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," current "),t("span",{style:{color:"#F97583"}},"+"),t("span",{style:{color:"#E1E4E8"}}," releases;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#6A737D"}},"// 索引越界判断")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (next "),t("span",{style:{color:"#F97583"}},"<"),t("span",{style:{color:"#E1E4E8"}}," current)            ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"throw"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"new"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"Error"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#9ECBFF"}},'"Maximum permit count exceeded"'),t("span",{style:{color:"#E1E4E8"}},");        ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#6A737D"}},"// 释放锁")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," ("),t("span",{style:{color:"#B392F0"}},"compareAndSetState"),t("span",{style:{color:"#E1E4E8"}},"(current, next))            ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"return"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"true"),t("span",{style:{color:"#E1E4E8"}},";    ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"}")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"private"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"void"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"doReleaseShared"),t("span",{style:{color:"#E1E4E8"}},"() {    ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// PROPAGATE 详解    ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// 如果 head.waitStatus == Node.SIGNAL ==> 0 成功, 下一个节点 unpark\t")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// 如果 head.waitStatus == 0 ==> Node.PROPAGATE")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"}")])])]),t("pre",{class:"shiki github-light vp-code-light"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// release() -> releaseShared()")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"public"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"final"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"boolean"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"releaseShared"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," arg) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// 尝试释放锁")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," ("),t("span",{style:{color:"#6F42C1"}},"tryReleaseShared"),t("span",{style:{color:"#24292E"}},"(arg)) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6F42C1"}},"doReleaseShared"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"return"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"true"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    }    ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"return"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"false"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"}")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"protected"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"final"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"boolean"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"tryReleaseShared"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," releases) {    ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"for"),t("span",{style:{color:"#24292E"}}," (;;) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6A737D"}},"// 获取当前锁资源的可用许可证数量")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," current "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"getState"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," next "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," current "),t("span",{style:{color:"#D73A49"}},"+"),t("span",{style:{color:"#24292E"}}," releases;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6A737D"}},"// 索引越界判断")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (next "),t("span",{style:{color:"#D73A49"}},"<"),t("span",{style:{color:"#24292E"}}," current)            ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"throw"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"new"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"Error"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#032F62"}},'"Maximum permit count exceeded"'),t("span",{style:{color:"#24292E"}},");        ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6A737D"}},"// 释放锁")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," ("),t("span",{style:{color:"#6F42C1"}},"compareAndSetState"),t("span",{style:{color:"#24292E"}},"(current, next))            ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"return"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"true"),t("span",{style:{color:"#24292E"}},";    ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"}")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"private"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"void"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"doReleaseShared"),t("span",{style:{color:"#24292E"}},"() {    ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// PROPAGATE 详解    ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// 如果 head.waitStatus == Node.SIGNAL ==> 0 成功, 下一个节点 unpark\t")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// 如果 head.waitStatus == 0 ==> Node.PROPAGATE")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"}")])])]),t("button",{class:"collapse"})]),t("figure",null,[t("img",{alt:"image-20230719211353401",class:"lazy","data-src":"https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230719211353401.png"})])]),t("li",null,[t("p",null,"接下来 Thread-0 竞争成功，permits 再次设置为 0，设置自己为 head 节点，并且 unpark 接下来的共享状态的 Thread-3 节点，但由于 permits 是 0，因此 Thread-3 在尝试不成功后再次进入 park 状态")])],-1),dn=t("hr",null,null,-1),un={id:"propagate",tabindex:"-1"},An=t("p",null,[p("假设存在某次循环中队列里排队的结点情况为 "),t("code",null,"head(-1) → t1(-1) → t2(0)"),p("，存在将要释放信号量的 T3 和 T4，释放顺序为先 T3 后 T4")],-1),Dn=t("div",{style:{"max-height":"300px"},class:"language-java"},[t("button",{title:"Copy Code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki github-dark vp-code-dark"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// 老版本代码")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"private"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"void"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"setHeadAndPropagate"),t("span",{style:{color:"#E1E4E8"}},"(Node node, "),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," propagate) {    ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#B392F0"}},"setHead"),t("span",{style:{color:"#E1E4E8"}},"(node);    ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// 有空闲资源    ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (propagate "),t("span",{style:{color:"#F97583"}},">"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"0"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"&&"),t("span",{style:{color:"#E1E4E8"}}," node.waitStatus "),t("span",{style:{color:"#F97583"}},"!="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"0"),t("span",{style:{color:"#E1E4E8"}},") {    \t")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        Node s "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," node.next;        ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#6A737D"}},"// 下一个        ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (s "),t("span",{style:{color:"#F97583"}},"=="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"null"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"||"),t("span",{style:{color:"#E1E4E8"}}," s."),t("span",{style:{color:"#B392F0"}},"isShared"),t("span",{style:{color:"#E1E4E8"}},"())            ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#B392F0"}},"unparkSuccessor"),t("span",{style:{color:"#E1E4E8"}},"(node);        ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"}")])])]),t("pre",{class:"shiki github-light vp-code-light"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// 老版本代码")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"private"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"void"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"setHeadAndPropagate"),t("span",{style:{color:"#24292E"}},"(Node node, "),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," propagate) {    ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6F42C1"}},"setHead"),t("span",{style:{color:"#24292E"}},"(node);    ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// 有空闲资源    ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (propagate "),t("span",{style:{color:"#D73A49"}},">"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"0"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"&&"),t("span",{style:{color:"#24292E"}}," node.waitStatus "),t("span",{style:{color:"#D73A49"}},"!="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"0"),t("span",{style:{color:"#24292E"}},") {    \t")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        Node s "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," node.next;        ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6A737D"}},"// 下一个        ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (s "),t("span",{style:{color:"#D73A49"}},"=="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"null"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"||"),t("span",{style:{color:"#24292E"}}," s."),t("span",{style:{color:"#6F42C1"}},"isShared"),t("span",{style:{color:"#24292E"}},"())            ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#6F42C1"}},"unparkSuccessor"),t("span",{style:{color:"#24292E"}},"(node);        ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"}")])])]),t("button",{class:"collapse"})],-1),hn=t("p",null,"正常流程：",-1),Cn=t("ul",null,[t("li",null,"T3 调用 releaseShared(1)，直接调用了 unparkSuccessor(head)，head.waitStatus 从 -1 变为 0"),t("li",null,"T1 由于 T3 释放信号量被唤醒，然后 T4 释放，唤醒 T2")],-1),gn=t("p",null,"BUG 流程：",-1),kn=t("ul",null,[t("li",null,"T3 调用 releaseShared(1)，直接调用了 unparkSuccessor(head)，head.waitStatus 从 -1 变为 0"),t("li",null,"T1 由于 T3 释放信号量被唤醒，调用 tryAcquireShared，返回值为 0（获取锁成功，但没有剩余资源量）"),t("li",null,"T1 还没调用 setHeadAndPropagate 方法，T4 调用 releaseShared(1)，此时 head.waitStatus 为 0（此时读到的 head 和 1 中为同一个 head），不满足条件，因此不调用 unparkSuccessor(head)"),t("li",null,[p("T1 获取信号量成功，调用 setHeadAndPropagate(t1.node, 0) 时，因为不满足 propagate > 0（剩余资源量 == 0），从而不会唤醒后继结点， "),t("strong",null,"T2 线程得不到唤醒")])],-1),Bn=t("p",null,"更新后流程：",-1),fn=t("ul",null,[t("li",null,[t("p",null,"T3 调用 releaseShared(1)，直接调用了 unparkSuccessor(head)，head.waitStatus 从 -1 变为 0")]),t("li",null,[t("p",null,"T1 由于 T3 释放信号量被唤醒，调用 tryAcquireShared，返回值为 0（获取锁成功，但没有剩余资源量）")]),t("li",null,[t("p",null,[p("T1 还没调用 setHeadAndPropagate 方法，T4 调用 releaseShared()，此时 head.waitStatus 为 0（此时读到的 head 和 1 中为同一个 head），调用 doReleaseShared() 将等待状态置为 "),t("strong",null,"PROPAGATE（-3）")])]),t("li",null,[t("p",null,"T1 获取信号量成功，调用 setHeadAndPropagate 时，读到 h.waitStatus < 0，从而调用 doReleaseShared() 唤醒 T2")])],-1),bn=t("div",{style:{"max-height":"300px"},class:"language-java"},[t("button",{title:"Copy Code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki github-dark vp-code-dark"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"private"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"void"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"setHeadAndPropagate"),t("span",{style:{color:"#E1E4E8"}},"(Node node, "),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," propagate) {    ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    Node h "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," head;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// 设置自己为 head 节点")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#B392F0"}},"setHead"),t("span",{style:{color:"#E1E4E8"}},"(node);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// propagate 表示有共享资源（例如共享读锁或信号量）")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// head waitStatus == Node.SIGNAL 或 Node.PROPAGATE")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (propagate "),t("span",{style:{color:"#F97583"}},">"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"0"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"||"),t("span",{style:{color:"#E1E4E8"}}," h "),t("span",{style:{color:"#F97583"}},"=="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"null"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"||"),t("span",{style:{color:"#E1E4E8"}}," h.waitStatus "),t("span",{style:{color:"#F97583"}},"<"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"0"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"||")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        (h "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," head) "),t("span",{style:{color:"#F97583"}},"=="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"null"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"||"),t("span",{style:{color:"#E1E4E8"}}," h.waitStatus "),t("span",{style:{color:"#F97583"}},"<"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"0"),t("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        Node s "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," node.next;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#6A737D"}},"// 如果是最后一个节点或者是等待共享读锁的节点，做一次唤醒")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (s "),t("span",{style:{color:"#F97583"}},"=="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"null"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"||"),t("span",{style:{color:"#E1E4E8"}}," s."),t("span",{style:{color:"#B392F0"}},"isShared"),t("span",{style:{color:"#E1E4E8"}},"())")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#B392F0"}},"doReleaseShared"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"}")])])]),t("pre",{class:"shiki github-light vp-code-light"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"private"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"void"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"setHeadAndPropagate"),t("span",{style:{color:"#24292E"}},"(Node node, "),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," propagate) {    ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    Node h "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," head;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// 设置自己为 head 节点")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6F42C1"}},"setHead"),t("span",{style:{color:"#24292E"}},"(node);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// propagate 表示有共享资源（例如共享读锁或信号量）")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// head waitStatus == Node.SIGNAL 或 Node.PROPAGATE")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (propagate "),t("span",{style:{color:"#D73A49"}},">"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"0"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"||"),t("span",{style:{color:"#24292E"}}," h "),t("span",{style:{color:"#D73A49"}},"=="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"null"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"||"),t("span",{style:{color:"#24292E"}}," h.waitStatus "),t("span",{style:{color:"#D73A49"}},"<"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"0"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"||")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        (h "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," head) "),t("span",{style:{color:"#D73A49"}},"=="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"null"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"||"),t("span",{style:{color:"#24292E"}}," h.waitStatus "),t("span",{style:{color:"#D73A49"}},"<"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"0"),t("span",{style:{color:"#24292E"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        Node s "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," node.next;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6A737D"}},"// 如果是最后一个节点或者是等待共享读锁的节点，做一次唤醒")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (s "),t("span",{style:{color:"#D73A49"}},"=="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"null"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"||"),t("span",{style:{color:"#24292E"}}," s."),t("span",{style:{color:"#6F42C1"}},"isShared"),t("span",{style:{color:"#24292E"}},"())")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#6F42C1"}},"doReleaseShared"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"}")])])]),t("button",{class:"collapse"})],-1),vn=t("div",{style:{"max-height":"300px"},class:"language-java"},[t("button",{title:"Copy Code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki github-dark vp-code-dark"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// 唤醒")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"private"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"void"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"doReleaseShared"),t("span",{style:{color:"#E1E4E8"}},"() {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// 如果 head.waitStatus == Node.SIGNAL ==> 0 成功, 下一个节点 unpark\t")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// 如果 head.waitStatus == 0 ==> Node.PROPAGATE    ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"for"),t("span",{style:{color:"#E1E4E8"}}," (;;) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        Node h "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," head;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (h "),t("span",{style:{color:"#F97583"}},"!="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"null"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"&&"),t("span",{style:{color:"#E1E4E8"}}," h "),t("span",{style:{color:"#F97583"}},"!="),t("span",{style:{color:"#E1E4E8"}}," tail) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," ws "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," h.waitStatus;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (ws "),t("span",{style:{color:"#F97583"}},"=="),t("span",{style:{color:"#E1E4E8"}}," Node.SIGNAL) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#6A737D"}},"// 防止 unparkSuccessor 被多次执行")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," ("),t("span",{style:{color:"#F97583"}},"!"),t("span",{style:{color:"#B392F0"}},"compareAndSetWaitStatus"),t("span",{style:{color:"#E1E4E8"}},"(h, Node.SIGNAL, "),t("span",{style:{color:"#79B8FF"}},"0"),t("span",{style:{color:"#E1E4E8"}},"))")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                    "),t("span",{style:{color:"#F97583"}},"continue"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#6A737D"}},"// 唤醒后继节点")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#B392F0"}},"unparkSuccessor"),t("span",{style:{color:"#E1E4E8"}},"(h);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#6A737D"}},"// 如果已经是 0 了，改为 -3，用来解决传播性")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"else"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (ws "),t("span",{style:{color:"#F97583"}},"=="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"0"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"&&"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"!"),t("span",{style:{color:"#B392F0"}},"compareAndSetWaitStatus"),t("span",{style:{color:"#E1E4E8"}},"(h, "),t("span",{style:{color:"#79B8FF"}},"0"),t("span",{style:{color:"#E1E4E8"}},", Node.PROPAGATE))")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#F97583"}},"continue"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (h "),t("span",{style:{color:"#F97583"}},"=="),t("span",{style:{color:"#E1E4E8"}}," head)")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"break"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"}")])])]),t("pre",{class:"shiki github-light vp-code-light"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// 唤醒")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"private"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"void"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"doReleaseShared"),t("span",{style:{color:"#24292E"}},"() {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// 如果 head.waitStatus == Node.SIGNAL ==> 0 成功, 下一个节点 unpark\t")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// 如果 head.waitStatus == 0 ==> Node.PROPAGATE    ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"for"),t("span",{style:{color:"#24292E"}}," (;;) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        Node h "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," head;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (h "),t("span",{style:{color:"#D73A49"}},"!="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"null"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"&&"),t("span",{style:{color:"#24292E"}}," h "),t("span",{style:{color:"#D73A49"}},"!="),t("span",{style:{color:"#24292E"}}," tail) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," ws "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," h.waitStatus;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (ws "),t("span",{style:{color:"#D73A49"}},"=="),t("span",{style:{color:"#24292E"}}," Node.SIGNAL) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#6A737D"}},"// 防止 unparkSuccessor 被多次执行")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," ("),t("span",{style:{color:"#D73A49"}},"!"),t("span",{style:{color:"#6F42C1"}},"compareAndSetWaitStatus"),t("span",{style:{color:"#24292E"}},"(h, Node.SIGNAL, "),t("span",{style:{color:"#005CC5"}},"0"),t("span",{style:{color:"#24292E"}},"))")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                    "),t("span",{style:{color:"#D73A49"}},"continue"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#6A737D"}},"// 唤醒后继节点")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#6F42C1"}},"unparkSuccessor"),t("span",{style:{color:"#24292E"}},"(h);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#6A737D"}},"// 如果已经是 0 了，改为 -3，用来解决传播性")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"else"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (ws "),t("span",{style:{color:"#D73A49"}},"=="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"0"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"&&"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"!"),t("span",{style:{color:"#6F42C1"}},"compareAndSetWaitStatus"),t("span",{style:{color:"#24292E"}},"(h, "),t("span",{style:{color:"#005CC5"}},"0"),t("span",{style:{color:"#24292E"}},", Node.PROPAGATE))")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#D73A49"}},"continue"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (h "),t("span",{style:{color:"#D73A49"}},"=="),t("span",{style:{color:"#24292E"}}," head)")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"break"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"}")])])]),t("button",{class:"collapse"})],-1),Sn=t("hr",null,null,-1),mn={id:"exchanger",tabindex:"-1"},xn=t("p",null,"Exchanger：交换器，是一个用于线程间协作的工具类，用于进行线程间的数据交换",-1),wn=t("p",null,"工作流程：两个线程通过 exchange 方法交换数据，如果第一个线程先执行 exchange() 方法，它会一直等待第二个线程也执行 exchange 方法，当两个线程都到达同步点时，这两个线程就可以交换数据",-1),Tn=t("p",null,"常用方法：",-1),Nn=t("ul",null,[t("li",null,[t("code",null,"public Exchanger()"),p("：创建一个新的交换器")]),t("li",null,[t("code",null,"public V exchange(V x)"),p("：等待另一个线程到达此交换点")]),t("li",null,[t("code",null,"public V exchange(V x, long timeout, TimeUnit unit)"),p("：等待一定的时间")])],-1),In=t("div",{style:{"max-height":"300px"},class:"language-java"},[t("button",{title:"Copy Code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki github-dark vp-code-dark"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"public"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"class"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"ExchangerDemo"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"public"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"static"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"void"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"main"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#F97583"}},"String"),t("span",{style:{color:"#E1E4E8"}},"[] "),t("span",{style:{color:"#FFAB70"}},"args"),t("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#6A737D"}},"// 创建交换对象（信使）")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        Exchanger<"),t("span",{style:{color:"#F97583"}},"String"),t("span",{style:{color:"#E1E4E8"}},"> exchanger "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"new"),t("span",{style:{color:"#E1E4E8"}}," Exchanger<>();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"new"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"ThreadA"),t("span",{style:{color:"#E1E4E8"}},"(exchanger)."),t("span",{style:{color:"#B392F0"}},"start"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"new"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"ThreadB"),t("span",{style:{color:"#E1E4E8"}},"(exchanger)."),t("span",{style:{color:"#B392F0"}},"start"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    } ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"}")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"class"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"ThreadA"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"extends"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"Thread"),t("span",{style:{color:"#E1E4E8"}},"{")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"private"),t("span",{style:{color:"#E1E4E8"}}," Exchanger<"),t("span",{style:{color:"#F97583"}},"String"),t("span",{style:{color:"#E1E4E8"}},"> "),t("span",{style:{color:"#B392F0"}},"exchanger"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"public"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"ThreadA"),t("span",{style:{color:"#E1E4E8"}},"(Exchanger<"),t("span",{style:{color:"#F97583"}},"String"),t("span",{style:{color:"#E1E4E8"}},"> "),t("span",{style:{color:"#FFAB70"}},"exchanger"),t("span",{style:{color:"#E1E4E8"}},"){")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#79B8FF"}},"this"),t("span",{style:{color:"#E1E4E8"}},".exchanger "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," exchanger;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    @"),t("span",{style:{color:"#F97583"}},"Override")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"public"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"void"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"run"),t("span",{style:{color:"#E1E4E8"}},"() {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"try"),t("span",{style:{color:"#E1E4E8"}},"{")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#B392F0"}},"sout"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#9ECBFF"}},'"线程A，做好了礼物A，等待线程B送来的礼物B"'),t("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#6A737D"}},"//如果等待了5s还没有交换就死亡（抛出异常）！")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            String s "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," exchanger."),t("span",{style:{color:"#B392F0"}},"exchange"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#9ECBFF"}},'"礼物A"'),t("span",{style:{color:"#E1E4E8"}},","),t("span",{style:{color:"#79B8FF"}},"5"),t("span",{style:{color:"#E1E4E8"}},",TimeUnit.SECONDS);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#B392F0"}},"sout"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#9ECBFF"}},'"线程A收到线程B的礼物："'),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"+"),t("span",{style:{color:"#E1E4E8"}}," s);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        } "),t("span",{style:{color:"#F97583"}},"catch"),t("span",{style:{color:"#E1E4E8"}}," (Exception "),t("span",{style:{color:"#FFAB70"}},"e"),t("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            System.out."),t("span",{style:{color:"#B392F0"}},"println"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#9ECBFF"}},'"线程A等待了5s，没有收到礼物,最终就执行结束了!"'),t("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"}")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"class"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"ThreadB"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"extends"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"Thread"),t("span",{style:{color:"#E1E4E8"}},"{")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"private"),t("span",{style:{color:"#E1E4E8"}}," Exchanger<"),t("span",{style:{color:"#F97583"}},"String"),t("span",{style:{color:"#E1E4E8"}},"> exchanger;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"public"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"ThreadB"),t("span",{style:{color:"#E1E4E8"}},"(Exchanger<"),t("span",{style:{color:"#F97583"}},"String"),t("span",{style:{color:"#E1E4E8"}},"> "),t("span",{style:{color:"#FFAB70"}},"exchanger"),t("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#79B8FF"}},"this"),t("span",{style:{color:"#E1E4E8"}},".exchanger "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," exchanger;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    @"),t("span",{style:{color:"#F97583"}},"Override")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"public"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"void"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"run"),t("span",{style:{color:"#E1E4E8"}},"() {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"try"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#B392F0"}},"sout"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#9ECBFF"}},'"线程B,做好了礼物B,等待线程A送来的礼物A....."'),t("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#6A737D"}},"// 开始交换礼物。参数是送给其他线程的礼物!")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#B392F0"}},"sout"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#9ECBFF"}},'"线程B收到线程A的礼物："'),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"+"),t("span",{style:{color:"#E1E4E8"}}," exchanger."),t("span",{style:{color:"#B392F0"}},"exchange"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#9ECBFF"}},'"礼物B"'),t("span",{style:{color:"#E1E4E8"}},"));")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        } "),t("span",{style:{color:"#F97583"}},"catch"),t("span",{style:{color:"#E1E4E8"}}," (Exception "),t("span",{style:{color:"#FFAB70"}},"e"),t("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            e."),t("span",{style:{color:"#B392F0"}},"printStackTrace"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"}")])])]),t("pre",{class:"shiki github-light vp-code-light"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"public"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"class"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"ExchangerDemo"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"public"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"static"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"void"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"main"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#D73A49"}},"String"),t("span",{style:{color:"#24292E"}},"[] "),t("span",{style:{color:"#E36209"}},"args"),t("span",{style:{color:"#24292E"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6A737D"}},"// 创建交换对象（信使）")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        Exchanger<"),t("span",{style:{color:"#D73A49"}},"String"),t("span",{style:{color:"#24292E"}},"> exchanger "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"new"),t("span",{style:{color:"#24292E"}}," Exchanger<>();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"new"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"ThreadA"),t("span",{style:{color:"#24292E"}},"(exchanger)."),t("span",{style:{color:"#6F42C1"}},"start"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"new"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"ThreadB"),t("span",{style:{color:"#24292E"}},"(exchanger)."),t("span",{style:{color:"#6F42C1"}},"start"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    } ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"}")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"class"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"ThreadA"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"extends"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"Thread"),t("span",{style:{color:"#24292E"}},"{")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"private"),t("span",{style:{color:"#24292E"}}," Exchanger<"),t("span",{style:{color:"#D73A49"}},"String"),t("span",{style:{color:"#24292E"}},"> "),t("span",{style:{color:"#6F42C1"}},"exchanger"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"public"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"ThreadA"),t("span",{style:{color:"#24292E"}},"(Exchanger<"),t("span",{style:{color:"#D73A49"}},"String"),t("span",{style:{color:"#24292E"}},"> "),t("span",{style:{color:"#E36209"}},"exchanger"),t("span",{style:{color:"#24292E"}},"){")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#005CC5"}},"this"),t("span",{style:{color:"#24292E"}},".exchanger "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," exchanger;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    @"),t("span",{style:{color:"#D73A49"}},"Override")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"public"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"void"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"run"),t("span",{style:{color:"#24292E"}},"() {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"try"),t("span",{style:{color:"#24292E"}},"{")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#6F42C1"}},"sout"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#032F62"}},'"线程A，做好了礼物A，等待线程B送来的礼物B"'),t("span",{style:{color:"#24292E"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#6A737D"}},"//如果等待了5s还没有交换就死亡（抛出异常）！")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            String s "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," exchanger."),t("span",{style:{color:"#6F42C1"}},"exchange"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#032F62"}},'"礼物A"'),t("span",{style:{color:"#24292E"}},","),t("span",{style:{color:"#005CC5"}},"5"),t("span",{style:{color:"#24292E"}},",TimeUnit.SECONDS);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#6F42C1"}},"sout"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#032F62"}},'"线程A收到线程B的礼物："'),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"+"),t("span",{style:{color:"#24292E"}}," s);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        } "),t("span",{style:{color:"#D73A49"}},"catch"),t("span",{style:{color:"#24292E"}}," (Exception "),t("span",{style:{color:"#E36209"}},"e"),t("span",{style:{color:"#24292E"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            System.out."),t("span",{style:{color:"#6F42C1"}},"println"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#032F62"}},'"线程A等待了5s，没有收到礼物,最终就执行结束了!"'),t("span",{style:{color:"#24292E"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"}")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"class"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"ThreadB"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"extends"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"Thread"),t("span",{style:{color:"#24292E"}},"{")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"private"),t("span",{style:{color:"#24292E"}}," Exchanger<"),t("span",{style:{color:"#D73A49"}},"String"),t("span",{style:{color:"#24292E"}},"> exchanger;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"public"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"ThreadB"),t("span",{style:{color:"#24292E"}},"(Exchanger<"),t("span",{style:{color:"#D73A49"}},"String"),t("span",{style:{color:"#24292E"}},"> "),t("span",{style:{color:"#E36209"}},"exchanger"),t("span",{style:{color:"#24292E"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#005CC5"}},"this"),t("span",{style:{color:"#24292E"}},".exchanger "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," exchanger;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    @"),t("span",{style:{color:"#D73A49"}},"Override")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"public"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"void"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"run"),t("span",{style:{color:"#24292E"}},"() {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"try"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#6F42C1"}},"sout"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#032F62"}},'"线程B,做好了礼物B,等待线程A送来的礼物A....."'),t("span",{style:{color:"#24292E"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#6A737D"}},"// 开始交换礼物。参数是送给其他线程的礼物!")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#6F42C1"}},"sout"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#032F62"}},'"线程B收到线程A的礼物："'),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"+"),t("span",{style:{color:"#24292E"}}," exchanger."),t("span",{style:{color:"#6F42C1"}},"exchange"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#032F62"}},'"礼物B"'),t("span",{style:{color:"#24292E"}},"));")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        } "),t("span",{style:{color:"#D73A49"}},"catch"),t("span",{style:{color:"#24292E"}}," (Exception "),t("span",{style:{color:"#E36209"}},"e"),t("span",{style:{color:"#24292E"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            e."),t("span",{style:{color:"#6F42C1"}},"printStackTrace"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"}")])])]),t("button",{class:"collapse"})],-1),Rn=t("hr",null,null,-1);const Ln=s(d,[["render",function(s,l,o,i,F,d){const Ln=y,qn=e;return c(),n(qn,{frontmatter:F.frontmatter,data:F.data},{"main-content-md":a((()=>[t("h1",u,[p("并发编程整理版 "),r(Ln,{class:"header-anchor",href:"#并发编程整理版","aria-label":'Permalink to "并发编程整理版"'},{default:a((()=>[p("​")])),_:1})]),t("p",null,[p("参考视频："),r(Ln,{href:"https://www.bilibili.com/video/BV16J411h7Rd",target:"_blank",rel:"noreferrer"},{default:a((()=>[p("https://www.bilibili.com/video/BV16J411h7Rd")])),_:1})]),A,t("h2",D,[p("同步器 "),r(Ln,{class:"header-anchor",href:"#同步器","aria-label":'Permalink to "同步器"'},{default:a((()=>[p("​")])),_:1})]),t("h3",h,[p("AQS "),r(Ln,{class:"header-anchor",href:"#aqs","aria-label":'Permalink to "AQS"'},{default:a((()=>[p("​")])),_:1})]),t("h4",C,[p("核心思想 "),r(Ln,{class:"header-anchor",href:"#核心思想","aria-label":'Permalink to "核心思想"'},{default:a((()=>[p("​")])),_:1})]),g,k,B,f,b,v,t("h4",S,[p("设计原理 "),r(Ln,{class:"header-anchor",href:"#设计原理","aria-label":'Permalink to "设计原理"'},{default:a((()=>[p("​")])),_:1})]),m,x,w,T,N,I,R,L,q,j,O,t("h4",P,[p("模板对象 "),r(Ln,{class:"header-anchor",href:"#模板对象","aria-label":'Permalink to "模板对象"'},{default:a((()=>[p("​")])),_:1})]),W,H,_,Q,G,z,t("h4",U,[p("自定义 "),r(Ln,{class:"header-anchor",href:"#自定义","aria-label":'Permalink to "自定义"'},{default:a((()=>[p("​")])),_:1})]),M,V,K,t("h3",X,[p("Re-Lock "),r(Ln,{class:"header-anchor",href:"#re-lock","aria-label":'Permalink to "Re-Lock"'},{default:a((()=>[p("​")])),_:1})]),t("h4",J,[p("锁对比 "),r(Ln,{class:"header-anchor",href:"#锁对比","aria-label":'Permalink to "锁对比"'},{default:a((()=>[p("​")])),_:1})]),$,Z,Y,t("h4",ss,[p("使用锁 "),r(Ln,{class:"header-anchor",href:"#使用锁","aria-label":'Permalink to "使用锁"'},{default:a((()=>[p("​")])),_:1})]),ls,os,ns,as,es,cs,t("h4",ts,[p("公平锁 "),r(Ln,{class:"header-anchor",href:"#公平锁","aria-label":'Permalink to "公平锁"'},{default:a((()=>[p("​")])),_:1})]),t("h5",ps,[p("基本使用 "),r(Ln,{class:"header-anchor",href:"#基本使用","aria-label":'Permalink to "基本使用"'},{default:a((()=>[p("​")])),_:1})]),rs,Es,ys,is,Fs,ds,t("h5",us,[p("非公原理 "),r(Ln,{class:"header-anchor",href:"#非公原理","aria-label":'Permalink to "非公原理"'},{default:a((()=>[p("​")])),_:1})]),t("h6",As,[p("加锁 "),r(Ln,{class:"header-anchor",href:"#加锁","aria-label":'Permalink to "加锁"'},{default:a((()=>[p("​")])),_:1})]),Ds,hs,Cs,gs,ks,Bs,t("h6",fs,[p("解锁 "),r(Ln,{class:"header-anchor",href:"#解锁","aria-label":'Permalink to "解锁"'},{default:a((()=>[p("​")])),_:1})]),bs,vs,Ss,ms,xs,ws,Ts,t("h5",Ns,[p("公平原理 "),r(Ln,{class:"header-anchor",href:"#公平原理","aria-label":'Permalink to "公平原理"'},{default:a((()=>[p("​")])),_:1})]),Is,Rs,Ls,qs,t("h4",js,[p("可重入 "),r(Ln,{class:"header-anchor",href:"#可重入","aria-label":'Permalink to "可重入"'},{default:a((()=>[p("​")])),_:1})]),Os,Ps,Ws,Hs,_s,Qs,Gs,t("h4",zs,[p("可打断 "),r(Ln,{class:"header-anchor",href:"#可打断","aria-label":'Permalink to "可打断"'},{default:a((()=>[p("​")])),_:1})]),t("h5",Us,[p("基本使用 "),r(Ln,{class:"header-anchor",href:"#基本使用-1","aria-label":'Permalink to "基本使用"'},{default:a((()=>[p("​")])),_:1})]),Ms,Vs,Ks,Xs,Js,t("h5",$s,[p("实现原理 "),r(Ln,{class:"header-anchor",href:"#实现原理","aria-label":'Permalink to "实现原理"'},{default:a((()=>[p("​")])),_:1})]),Zs,Ys,t("h4",sl,[p("锁超时 "),r(Ln,{class:"header-anchor",href:"#锁超时","aria-label":'Permalink to "锁超时"'},{default:a((()=>[p("​")])),_:1})]),t("h5",ll,[p("基本使用 "),r(Ln,{class:"header-anchor",href:"#基本使用-2","aria-label":'Permalink to "基本使用"'},{default:a((()=>[p("​")])),_:1})]),ol,nl,al,el,cl,t("h5",tl,[p("实现原理 "),r(Ln,{class:"header-anchor",href:"#实现原理-1","aria-label":'Permalink to "实现原理"'},{default:a((()=>[p("​")])),_:1})]),pl,rl,t("h5",El,[p("哲学家就餐 "),r(Ln,{class:"header-anchor",href:"#哲学家就餐","aria-label":'Permalink to "哲学家就餐"'},{default:a((()=>[p("​")])),_:1})]),yl,il,t("h4",Fl,[p("条件变量 "),r(Ln,{class:"header-anchor",href:"#条件变量","aria-label":'Permalink to "条件变量"'},{default:a((()=>[p("​")])),_:1})]),t("h5",dl,[p("基本使用 "),r(Ln,{class:"header-anchor",href:"#基本使用-3","aria-label":'Permalink to "基本使用"'},{default:a((()=>[p("​")])),_:1})]),ul,Al,Dl,hl,Cl,gl,kl,Bl,t("h5",fl,[p("实现原理 "),r(Ln,{class:"header-anchor",href:"#实现原理-2","aria-label":'Permalink to "实现原理"'},{default:a((()=>[p("​")])),_:1})]),t("h6",bl,[p("await "),r(Ln,{class:"header-anchor",href:"#await","aria-label":'Permalink to "await"'},{default:a((()=>[p("​")])),_:1})]),vl,Sl,ml,t("h6",xl,[p("signal "),r(Ln,{class:"header-anchor",href:"#signal","aria-label":'Permalink to "signal"'},{default:a((()=>[p("​")])),_:1})]),wl,Tl,t("h3",Nl,[p("ReadWrite "),r(Ln,{class:"header-anchor",href:"#readwrite","aria-label":'Permalink to "ReadWrite"'},{default:a((()=>[p("​")])),_:1})]),t("h4",Il,[p("读写锁 "),r(Ln,{class:"header-anchor",href:"#读写锁","aria-label":'Permalink to "读写锁"'},{default:a((()=>[p("​")])),_:1})]),Rl,Ll,ql,jl,Ol,Pl,Wl,Hl,_l,Ql,Gl,zl,Ul,t("h4",Ml,[p("缓存应用 "),r(Ln,{class:"header-anchor",href:"#缓存应用","aria-label":'Permalink to "缓存应用"'},{default:a((()=>[p("​")])),_:1})]),Vl,Kl,Xl,Jl,t("h4",$l,[p("实现原理 "),r(Ln,{class:"header-anchor",href:"#实现原理-3","aria-label":'Permalink to "实现原理"'},{default:a((()=>[p("​")])),_:1})]),t("h5",Zl,[p("成员属性 "),r(Ln,{class:"header-anchor",href:"#成员属性","aria-label":'Permalink to "成员属性"'},{default:a((()=>[p("​")])),_:1})]),Yl,so,lo,oo,no,t("h5",ao,[p("加锁原理 "),r(Ln,{class:"header-anchor",href:"#加锁原理","aria-label":'Permalink to "加锁原理"'},{default:a((()=>[p("​")])),_:1})]),eo,co,t("h5",to,[p("解锁原理 "),r(Ln,{class:"header-anchor",href:"#解锁原理","aria-label":'Permalink to "解锁原理"'},{default:a((()=>[p("​")])),_:1})]),po,ro,t("h4",Eo,[p("Stamped "),r(Ln,{class:"header-anchor",href:"#stamped","aria-label":'Permalink to "Stamped"'},{default:a((()=>[p("​")])),_:1})]),yo,io,Fo,uo,Ao,Do,ho,Co,go,t("h3",ko,[p("CountDown "),r(Ln,{class:"header-anchor",href:"#countdown","aria-label":'Permalink to "CountDown"'},{default:a((()=>[p("​")])),_:1})]),t("h4",Bo,[p("基本使用 "),r(Ln,{class:"header-anchor",href:"#基本使用-4","aria-label":'Permalink to "基本使用"'},{default:a((()=>[p("​")])),_:1})]),fo,bo,vo,So,mo,xo,wo,To,t("h4",No,[p("实现原理 "),r(Ln,{class:"header-anchor",href:"#实现原理-4","aria-label":'Permalink to "实现原理"'},{default:a((()=>[p("​")])),_:1})]),Io,Ro,Lo,qo,jo,t("h3",Oo,[p("CyclicBarrier "),r(Ln,{class:"header-anchor",href:"#cyclicbarrier","aria-label":'Permalink to "CyclicBarrier"'},{default:a((()=>[p("​")])),_:1})]),t("h4",Po,[p("基本使用 "),r(Ln,{class:"header-anchor",href:"#基本使用-5","aria-label":'Permalink to "基本使用"'},{default:a((()=>[p("​")])),_:1})]),Wo,Ho,_o,Qo,Go,zo,Uo,t("h4",Mo,[p("实现原理 "),r(Ln,{class:"header-anchor",href:"#实现原理-5","aria-label":'Permalink to "实现原理"'},{default:a((()=>[p("​")])),_:1})]),t("h5",Vo,[p("成员属性 "),r(Ln,{class:"header-anchor",href:"#成员属性-1","aria-label":'Permalink to "成员属性"'},{default:a((()=>[p("​")])),_:1})]),Ko,Xo,Jo,t("h5",$o,[p("成员方法 "),r(Ln,{class:"header-anchor",href:"#成员方法","aria-label":'Permalink to "成员方法"'},{default:a((()=>[p("​")])),_:1})]),Zo,t("p",null,[p("参考视频："),r(Ln,{href:"https://space.bilibili.com/457326371/",target:"_blank",rel:"noreferrer"},{default:a((()=>[p("https://space.bilibili.com/457326371/")])),_:1})]),Yo,t("h3",sn,[p("Semaphore "),r(Ln,{class:"header-anchor",href:"#semaphore","aria-label":'Permalink to "Semaphore"'},{default:a((()=>[p("​")])),_:1})]),t("h4",ln,[p("基本使用 "),r(Ln,{class:"header-anchor",href:"#基本使用-6","aria-label":'Permalink to "基本使用"'},{default:a((()=>[p("​")])),_:1})]),on,nn,an,en,cn,tn,pn,rn,t("h4",En,[p("实现原理 "),r(Ln,{class:"header-anchor",href:"#实现原理-6","aria-label":'Permalink to "实现原理"'},{default:a((()=>[p("​")])),_:1})]),yn,Fn,dn,t("h4",un,[p("PROPAGATE "),r(Ln,{class:"header-anchor",href:"#propagate","aria-label":'Permalink to "PROPAGATE"'},{default:a((()=>[p("​")])),_:1})]),An,Dn,hn,Cn,gn,kn,Bn,fn,bn,vn,Sn,t("h3",mn,[p("Exchanger "),r(Ln,{class:"header-anchor",href:"#exchanger","aria-label":'Permalink to "Exchanger"'},{default:a((()=>[p("​")])),_:1})]),xn,wn,Tn,Nn,In,Rn])),"main-header":a((()=>[E(s.$slots,"main-header")])),"main-header-after":a((()=>[E(s.$slots,"main-header-after")])),"main-nav":a((()=>[E(s.$slots,"main-nav")])),"main-content":a((()=>[E(s.$slots,"main-content")])),"main-content-after":a((()=>[E(s.$slots,"main-content-after")])),"main-nav-before":a((()=>[E(s.$slots,"main-nav-before")])),"main-nav-after":a((()=>[E(s.$slots,"main-nav-after")])),comment:a((()=>[E(s.$slots,"comment")])),footer:a((()=>[E(s.$slots,"footer")])),aside:a((()=>[E(s.$slots,"aside")])),"aside-custom":a((()=>[E(s.$slots,"aside-custom")])),default:a((()=>[E(s.$slots,"default")])),_:3},8,["frontmatter","data"])}]]);export{i as __pageData,Ln as default};
