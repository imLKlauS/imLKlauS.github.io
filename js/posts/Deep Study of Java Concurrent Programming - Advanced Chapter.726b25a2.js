import{_ as s,h as l,p as o,j as n,k as a,l as e,m as c,s as t,t as p,v as r,q as E,x as y}from"../../assets/app-56b13812.js";import"../@vueuse/@vueuse.2d040ebb.js";import"../animejs/animejs.7aacf446.js";const i=JSON.parse('{"title":"深入学习Java并发编程-高级篇","description":"","frontmatter":{"cover":"https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/wallhaven-j52r8w_1920x1080.png","title":"深入学习Java并发编程-高级篇","top":270,"author":"imklaus","tags":["线程池","JUC","AQS","ReentrantLock","volatile","Semaphore","ConcurrentHashMap"],"categories":"Java","date":"2023-07-07T22:52:11.000Z","outline":"deep"},"headers":[{"level":2,"title":"七、线程池","slug":"七、线程池","link":"#七、线程池","children":[{"level":3,"title":"1、自定义线程池","slug":"_1、自定义线程池","link":"#_1、自定义线程池","children":[]},{"level":3,"title":"2、ThreadPoolExecutor","slug":"_2、threadpoolexecutor","link":"#_2、threadpoolexecutor","children":[]},{"level":3,"title":"3、Fork/Join","slug":"_3、fork-join","link":"#_3、fork-join","children":[]}]},{"level":2,"title":"八、JUC","slug":"八、juc","link":"#八、juc","children":[{"level":3,"title":"1、AQS 原理","slug":"_1、aqs-原理","link":"#_1、aqs-原理","children":[]},{"level":3,"title":"2、ReentrantLock 原理","slug":"_2、reentrantlock-原理","link":"#_2、reentrantlock-原理","children":[]},{"level":3,"title":"3、读写锁","slug":"_3、读写锁","link":"#_3、读写锁","children":[]},{"level":3,"title":"4、Semaphore","slug":"_4、semaphore","link":"#_4、semaphore","children":[]},{"level":3,"title":"5、CountdownLatch","slug":"_5、countdownlatch","link":"#_5、countdownlatch","children":[]},{"level":3,"title":"6、CyclicBarrier","slug":"_6、cyclicbarrier","link":"#_6、cyclicbarrier","children":[]},{"level":3,"title":"7、线程安全集合类概述","slug":"_7、线程安全集合类概述","link":"#_7、线程安全集合类概述","children":[]},{"level":3,"title":"8、ConcurrentHashMap","slug":"_8、concurrenthashmap","link":"#_8、concurrenthashmap","children":[]},{"level":3,"title":"9、LinkedBlockingQueue 原理","slug":"_9、linkedblockingqueue-原理","link":"#_9、linkedblockingqueue-原理","children":[]},{"level":3,"title":"10、ConcurrentLinkedQueue","slug":"_10、concurrentlinkedqueue","link":"#_10、concurrentlinkedqueue","children":[]},{"level":3,"title":"11、CopyOnWriteArrayList","slug":"_11、copyonwritearraylist","link":"#_11、copyonwritearraylist","children":[]}]}],"relativePath":"pages/posts/Deep Study of Java Concurrent Programming - Advanced Chapter.md","path":"D:\\\\Learning\\\\myblog\\\\valaxy-blog\\\\imklaus.github.io-main\\\\pages\\\\posts\\\\Deep Study of Java Concurrent Programming - Advanced Chapter.md","lastUpdated":null}'),F=JSON.parse('{"title":"深入学习Java并发编程-高级篇","description":"","frontmatter":{"cover":"https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/wallhaven-j52r8w_1920x1080.png","title":"深入学习Java并发编程-高级篇","top":270,"author":"imklaus","tags":["线程池","JUC","AQS","ReentrantLock","volatile","Semaphore","ConcurrentHashMap"],"categories":"Java","date":"2023-07-07T22:52:11.000Z","outline":"deep"},"headers":[{"level":2,"title":"七、线程池","slug":"七、线程池","link":"#七、线程池","children":[{"level":3,"title":"1、自定义线程池","slug":"_1、自定义线程池","link":"#_1、自定义线程池","children":[]},{"level":3,"title":"2、ThreadPoolExecutor","slug":"_2、threadpoolexecutor","link":"#_2、threadpoolexecutor","children":[]},{"level":3,"title":"3、Fork/Join","slug":"_3、fork-join","link":"#_3、fork-join","children":[]}]},{"level":2,"title":"八、JUC","slug":"八、juc","link":"#八、juc","children":[{"level":3,"title":"1、AQS 原理","slug":"_1、aqs-原理","link":"#_1、aqs-原理","children":[]},{"level":3,"title":"2、ReentrantLock 原理","slug":"_2、reentrantlock-原理","link":"#_2、reentrantlock-原理","children":[]},{"level":3,"title":"3、读写锁","slug":"_3、读写锁","link":"#_3、读写锁","children":[]},{"level":3,"title":"4、Semaphore","slug":"_4、semaphore","link":"#_4、semaphore","children":[]},{"level":3,"title":"5、CountdownLatch","slug":"_5、countdownlatch","link":"#_5、countdownlatch","children":[]},{"level":3,"title":"6、CyclicBarrier","slug":"_6、cyclicbarrier","link":"#_6、cyclicbarrier","children":[]},{"level":3,"title":"7、线程安全集合类概述","slug":"_7、线程安全集合类概述","link":"#_7、线程安全集合类概述","children":[]},{"level":3,"title":"8、ConcurrentHashMap","slug":"_8、concurrenthashmap","link":"#_8、concurrenthashmap","children":[]},{"level":3,"title":"9、LinkedBlockingQueue 原理","slug":"_9、linkedblockingqueue-原理","link":"#_9、linkedblockingqueue-原理","children":[]},{"level":3,"title":"10、ConcurrentLinkedQueue","slug":"_10、concurrentlinkedqueue","link":"#_10、concurrentlinkedqueue","children":[]},{"level":3,"title":"11、CopyOnWriteArrayList","slug":"_11、copyonwritearraylist","link":"#_11、copyonwritearraylist","children":[]}]}],"relativePath":"pages/posts/Deep Study of Java Concurrent Programming - Advanced Chapter.md","path":"D:\\\\Learning\\\\myblog\\\\valaxy-blog\\\\imklaus.github.io-main\\\\pages\\\\posts\\\\Deep Study of Java Concurrent Programming - Advanced Chapter.md","lastUpdated":null}'),u={name:"pages/posts/Deep Study of Java Concurrent Programming - Advanced Chapter.md",data:()=>({data:F,frontmatter:F.frontmatter,$frontmatter:F.frontmatter}),setup(){const s=l();s.meta.frontmatter=Object.assign(s.meta.frontmatter,F.frontmatter),o("pageData",F)}},A={id:"并发编程笔记",tabindex:"-1"},d=t("strong",null,"黑马java并发编程教程",-1),D={id:"七、线程池",tabindex:"-1"},C={id:"_1、自定义线程池",tabindex:"-1"},h={id:"背景",tabindex:"-1"},g=t("p",null,"我们都知道线程是一种系统资源，每创建一个新的线程它都要占用一定的内存（分配栈内存），如果在高并发的情况下，一下子来了很多的任务，如果要为每个任务创建新的线程，可以想象到占用的内存是相当大的，有可能会出现outOfMemory，而且线程并不是创建得越多越好，还要考虑CPU核心数，当线程抢不到CPU使用权时（时间片）就会陷入阻塞状态，就会引起线程的上下文切换问题，把当前线程的运行状态保存下来，等下次轮到它运行时，还要恢复它之前的那些状态，如果线程的上下文切换得越来越频繁就会对你的系统性能影响越大，尤其是在高并发的情况下，因此处于这两个原因，每次任务来了不会先去创建新的线程，而是应该充分利用已有线程，尽量发挥它们的潜力去处理这个任务，而不是每次都创建新的线程去处理任务，这也体现了前面说的享元模式",-1),B={id:"图解",tabindex:"-1"},f=t("figure",null,[t("img",{src:"https://jsd.cdn.zzko.cn/gh/imLKlauS/blog-picture@main/blogs/20201021154837.png",alt:"img",loading:"lazy",decoding:"async"})],-1),k=t("ul",null,[t("li",null,"阻塞队列中维护了由主线程（或者其他线程）所产生的的任务"),t("li",null,[p("主线程类似于"),t("strong",null,"生产者"),p("，产生任务并放入阻塞队列中")]),t("li",null,[p("线程池类似于"),t("strong",null,"消费者"),p("，得到阻塞队列中已有的任务并执行")])],-1),b={id:"代码",tabindex:"-1"},m=t("div",{class:"language-java"},[t("button",{title:"Copy Code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki github-dark vp-code-dark"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"@"),t("span",{style:{color:"#F97583"}},"Slf4j"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#79B8FF"}},"topic"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#9ECBFF"}},'"c.TestPool"'),t("span",{style:{color:"#E1E4E8"}},")")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"public"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"class"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"TestPool"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"public"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"static"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"void"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"main"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#F97583"}},"String"),t("span",{style:{color:"#E1E4E8"}},"[] "),t("span",{style:{color:"#FFAB70"}},"args"),t("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        ThreadPool threadPool "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"new"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"ThreadPool"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#79B8FF"}},"1"),t("span",{style:{color:"#E1E4E8"}},",")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#79B8FF"}},"1000"),t("span",{style:{color:"#E1E4E8"}},", TimeUnit.MILLISECONDS, "),t("span",{style:{color:"#79B8FF"}},"1"),t("span",{style:{color:"#E1E4E8"}},", (queue, task)"),t("span",{style:{color:"#F97583"}},"->"),t("span",{style:{color:"#E1E4E8"}},"{")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#6A737D"}},"// 1. 死等")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"//            queue.put(task);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#6A737D"}},"// 2) 带超时等待")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"//            queue.offer(task, 1500, TimeUnit.MILLISECONDS);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#6A737D"}},"// 3) 让调用者放弃任务执行")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},'//            log.debug("放弃{}", task);')]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#6A737D"}},"// 4) 让调用者抛出异常")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},'//            throw new RuntimeException("任务执行失败 " + task);')]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#6A737D"}},"// 5) 让调用者自己执行任务")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            task."),t("span",{style:{color:"#B392F0"}},"run"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        });")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"for"),t("span",{style:{color:"#E1E4E8"}}," ("),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," i "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"0"),t("span",{style:{color:"#E1E4E8"}},"; i "),t("span",{style:{color:"#F97583"}},"<"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"4"),t("span",{style:{color:"#E1E4E8"}},"; i"),t("span",{style:{color:"#F97583"}},"++"),t("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," j "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," i;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            threadPool."),t("span",{style:{color:"#B392F0"}},"execute"),t("span",{style:{color:"#E1E4E8"}},"(() "),t("span",{style:{color:"#F97583"}},"->"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#F97583"}},"try"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                    Thread."),t("span",{style:{color:"#B392F0"}},"sleep"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#79B8FF"}},"1000L"),t("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                } "),t("span",{style:{color:"#F97583"}},"catch"),t("span",{style:{color:"#E1E4E8"}}," (InterruptedException "),t("span",{style:{color:"#FFAB70"}},"e"),t("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                    e."),t("span",{style:{color:"#B392F0"}},"printStackTrace"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                log."),t("span",{style:{color:"#B392F0"}},"debug"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#9ECBFF"}},'"{}"'),t("span",{style:{color:"#E1E4E8"}},", j);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            });")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"}")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"@"),t("span",{style:{color:"#F97583"}},"FunctionalInterface"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#6A737D"}},"// 拒绝策略")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"interface"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"RejectPolicy"),t("span",{style:{color:"#E1E4E8"}},"<"),t("span",{style:{color:"#F97583"}},"T"),t("span",{style:{color:"#E1E4E8"}},"> {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"void"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"reject"),t("span",{style:{color:"#E1E4E8"}},"(BlockingQueue<"),t("span",{style:{color:"#F97583"}},"T"),t("span",{style:{color:"#E1E4E8"}},"> "),t("span",{style:{color:"#FFAB70"}},"queue"),t("span",{style:{color:"#E1E4E8"}},", T "),t("span",{style:{color:"#FFAB70"}},"task"),t("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"}")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"@"),t("span",{style:{color:"#F97583"}},"Slf4j"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#79B8FF"}},"topic"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#9ECBFF"}},'"c.ThreadPool"'),t("span",{style:{color:"#E1E4E8"}},")")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"class"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"ThreadPool"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// 任务队列")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"private"),t("span",{style:{color:"#E1E4E8"}}," BlockingQueue<"),t("span",{style:{color:"#F97583"}},"Runnable"),t("span",{style:{color:"#E1E4E8"}},"> taskQueue;")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// 线程集合")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"private"),t("span",{style:{color:"#E1E4E8"}}," HashSet<"),t("span",{style:{color:"#F97583"}},"Worker"),t("span",{style:{color:"#E1E4E8"}},"> workers "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"new"),t("span",{style:{color:"#E1E4E8"}}," HashSet<>();")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// 核心线程数")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"private"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," coreSize;")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// 获取任务时的超时时间")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"private"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"long"),t("span",{style:{color:"#E1E4E8"}}," timeout;")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"private"),t("span",{style:{color:"#E1E4E8"}}," TimeUnit timeUnit;")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"private"),t("span",{style:{color:"#E1E4E8"}}," RejectPolicy<"),t("span",{style:{color:"#F97583"}},"Runnable"),t("span",{style:{color:"#E1E4E8"}},"> rejectPolicy;")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// 执行任务")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"public"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"void"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"execute"),t("span",{style:{color:"#E1E4E8"}},"(Runnable "),t("span",{style:{color:"#FFAB70"}},"task"),t("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#6A737D"}},"// 当任务数没有超过 coreSize 时，直接交给 worker 对象执行")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#6A737D"}},"// 如果任务数超过 coreSize 时，加入任务队列暂存")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"synchronized"),t("span",{style:{color:"#E1E4E8"}}," (workers) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}},"(workers."),t("span",{style:{color:"#B392F0"}},"size"),t("span",{style:{color:"#E1E4E8"}},"() "),t("span",{style:{color:"#F97583"}},"<"),t("span",{style:{color:"#E1E4E8"}}," coreSize) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                Worker worker "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"new"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"Worker"),t("span",{style:{color:"#E1E4E8"}},"(task);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                log."),t("span",{style:{color:"#B392F0"}},"debug"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#9ECBFF"}},'"新增 worker{}, {}"'),t("span",{style:{color:"#E1E4E8"}},", worker, task);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                workers."),t("span",{style:{color:"#B392F0"}},"add"),t("span",{style:{color:"#E1E4E8"}},"(worker);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                worker."),t("span",{style:{color:"#B392F0"}},"start"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            } "),t("span",{style:{color:"#F97583"}},"else"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"//                taskQueue.put(task);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#6A737D"}},"// 1) 死等")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#6A737D"}},"// 2) 带超时等待")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#6A737D"}},"// 3) 让调用者放弃任务执行")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#6A737D"}},"// 4) 让调用者抛出异常")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#6A737D"}},"// 5) 让调用者自己执行任务")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                taskQueue."),t("span",{style:{color:"#B392F0"}},"tryPut"),t("span",{style:{color:"#E1E4E8"}},"(rejectPolicy, task);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"public"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"ThreadPool"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#FFAB70"}},"coreSize"),t("span",{style:{color:"#E1E4E8"}},", "),t("span",{style:{color:"#F97583"}},"long"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#FFAB70"}},"timeout"),t("span",{style:{color:"#E1E4E8"}},", TimeUnit "),t("span",{style:{color:"#FFAB70"}},"timeUnit"),t("span",{style:{color:"#E1E4E8"}},", "),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#FFAB70"}},"queueCapcity"),t("span",{style:{color:"#E1E4E8"}},", RejectPolicy<"),t("span",{style:{color:"#F97583"}},"Runnable"),t("span",{style:{color:"#E1E4E8"}},"> "),t("span",{style:{color:"#FFAB70"}},"rejectPolicy"),t("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#79B8FF"}},"this"),t("span",{style:{color:"#E1E4E8"}},".coreSize "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," coreSize;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#79B8FF"}},"this"),t("span",{style:{color:"#E1E4E8"}},".timeout "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," timeout;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#79B8FF"}},"this"),t("span",{style:{color:"#E1E4E8"}},".timeUnit "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," timeUnit;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#79B8FF"}},"this"),t("span",{style:{color:"#E1E4E8"}},".taskQueue "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"new"),t("span",{style:{color:"#E1E4E8"}}," BlockingQueue<>(queueCapcity);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#79B8FF"}},"this"),t("span",{style:{color:"#E1E4E8"}},".rejectPolicy "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," rejectPolicy;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"class"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"Worker"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"extends"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"Thread"),t("span",{style:{color:"#E1E4E8"}},"{")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"private"),t("span",{style:{color:"#E1E4E8"}}," Runnable task;")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"public"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"Worker"),t("span",{style:{color:"#E1E4E8"}},"(Runnable "),t("span",{style:{color:"#FFAB70"}},"task"),t("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#79B8FF"}},"this"),t("span",{style:{color:"#E1E4E8"}},".task "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," task;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        }")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        @"),t("span",{style:{color:"#F97583"}},"Override")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"public"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"void"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"run"),t("span",{style:{color:"#E1E4E8"}},"() {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#6A737D"}},"// 执行任务")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#6A737D"}},"// 1) 当 task 不为空，执行任务")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#6A737D"}},"// 2) 当 task 执行完毕，再接着从任务队列获取任务并执行")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"//            while(task != null || (task = taskQueue.take()) != null) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"while"),t("span",{style:{color:"#E1E4E8"}},"(task "),t("span",{style:{color:"#F97583"}},"!="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"null"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"||"),t("span",{style:{color:"#E1E4E8"}}," (task "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," taskQueue."),t("span",{style:{color:"#B392F0"}},"poll"),t("span",{style:{color:"#E1E4E8"}},"(timeout, timeUnit)) "),t("span",{style:{color:"#F97583"}},"!="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"null"),t("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#F97583"}},"try"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                    log."),t("span",{style:{color:"#B392F0"}},"debug"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#9ECBFF"}},'"正在执行...{}"'),t("span",{style:{color:"#E1E4E8"}},", task);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                    task."),t("span",{style:{color:"#B392F0"}},"run"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                } "),t("span",{style:{color:"#F97583"}},"catch"),t("span",{style:{color:"#E1E4E8"}}," (Exception "),t("span",{style:{color:"#FFAB70"}},"e"),t("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                    e."),t("span",{style:{color:"#B392F0"}},"printStackTrace"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                } "),t("span",{style:{color:"#F97583"}},"finally"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                    task "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"null"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"synchronized"),t("span",{style:{color:"#E1E4E8"}}," (workers) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                log."),t("span",{style:{color:"#B392F0"}},"debug"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#9ECBFF"}},'"worker 被移除{}"'),t("span",{style:{color:"#E1E4E8"}},", "),t("span",{style:{color:"#79B8FF"}},"this"),t("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                workers."),t("span",{style:{color:"#B392F0"}},"remove"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#79B8FF"}},"this"),t("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"}")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"@"),t("span",{style:{color:"#F97583"}},"Slf4j"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#79B8FF"}},"topic"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#9ECBFF"}},'"c.BlockingQueue"'),t("span",{style:{color:"#E1E4E8"}},")")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"class"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"BlockingQueue"),t("span",{style:{color:"#E1E4E8"}},"<"),t("span",{style:{color:"#F97583"}},"T"),t("span",{style:{color:"#E1E4E8"}},"> {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// 1. 任务队列")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"private"),t("span",{style:{color:"#E1E4E8"}}," Deque<"),t("span",{style:{color:"#F97583"}},"T"),t("span",{style:{color:"#E1E4E8"}},"> queue "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"new"),t("span",{style:{color:"#E1E4E8"}}," ArrayDeque<>();")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// 2. 锁")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"private"),t("span",{style:{color:"#E1E4E8"}}," ReentrantLock lock "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"new"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"ReentrantLock"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// 3. 生产者条件变量")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"private"),t("span",{style:{color:"#E1E4E8"}}," Condition fullWaitSet "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," lock."),t("span",{style:{color:"#B392F0"}},"newCondition"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// 4. 消费者条件变量")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"private"),t("span",{style:{color:"#E1E4E8"}}," Condition emptyWaitSet "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," lock."),t("span",{style:{color:"#B392F0"}},"newCondition"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// 5. 容量")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"private"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," capcity;")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"public"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"BlockingQueue"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#FFAB70"}},"capcity"),t("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#79B8FF"}},"this"),t("span",{style:{color:"#E1E4E8"}},".capcity "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," capcity;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// 带超时阻塞获取")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"public"),t("span",{style:{color:"#E1E4E8"}}," T "),t("span",{style:{color:"#B392F0"}},"poll"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#F97583"}},"long"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#FFAB70"}},"timeout"),t("span",{style:{color:"#E1E4E8"}},", TimeUnit "),t("span",{style:{color:"#FFAB70"}},"unit"),t("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        lock."),t("span",{style:{color:"#B392F0"}},"lock"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"try"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#6A737D"}},"// 将 timeout 统一转换为 纳秒")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"long"),t("span",{style:{color:"#E1E4E8"}}," nanos "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," unit."),t("span",{style:{color:"#B392F0"}},"toNanos"),t("span",{style:{color:"#E1E4E8"}},"(timeout);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"while"),t("span",{style:{color:"#E1E4E8"}}," (queue."),t("span",{style:{color:"#B392F0"}},"isEmpty"),t("span",{style:{color:"#E1E4E8"}},"()) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#F97583"}},"try"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                    "),t("span",{style:{color:"#6A737D"}},"// 返回值是剩余时间")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                    "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (nanos "),t("span",{style:{color:"#F97583"}},"<="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"0"),t("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                        "),t("span",{style:{color:"#F97583"}},"return"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"null"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                    nanos "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," emptyWaitSet."),t("span",{style:{color:"#B392F0"}},"awaitNanos"),t("span",{style:{color:"#E1E4E8"}},"(nanos);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                } "),t("span",{style:{color:"#F97583"}},"catch"),t("span",{style:{color:"#E1E4E8"}}," (InterruptedException "),t("span",{style:{color:"#FFAB70"}},"e"),t("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                    e."),t("span",{style:{color:"#B392F0"}},"printStackTrace"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            T t "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," queue."),t("span",{style:{color:"#B392F0"}},"removeFirst"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            fullWaitSet."),t("span",{style:{color:"#B392F0"}},"signal"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"return"),t("span",{style:{color:"#E1E4E8"}}," t;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        } "),t("span",{style:{color:"#F97583"}},"finally"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            lock."),t("span",{style:{color:"#B392F0"}},"unlock"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// 阻塞获取")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"public"),t("span",{style:{color:"#E1E4E8"}}," T "),t("span",{style:{color:"#B392F0"}},"take"),t("span",{style:{color:"#E1E4E8"}},"() {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        lock."),t("span",{style:{color:"#B392F0"}},"lock"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"try"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"while"),t("span",{style:{color:"#E1E4E8"}}," (queue."),t("span",{style:{color:"#B392F0"}},"isEmpty"),t("span",{style:{color:"#E1E4E8"}},"()) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#F97583"}},"try"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                    emptyWaitSet."),t("span",{style:{color:"#B392F0"}},"await"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                } "),t("span",{style:{color:"#F97583"}},"catch"),t("span",{style:{color:"#E1E4E8"}}," (InterruptedException "),t("span",{style:{color:"#FFAB70"}},"e"),t("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                    e."),t("span",{style:{color:"#B392F0"}},"printStackTrace"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            T t "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," queue."),t("span",{style:{color:"#B392F0"}},"removeFirst"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            fullWaitSet."),t("span",{style:{color:"#B392F0"}},"signal"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"return"),t("span",{style:{color:"#E1E4E8"}}," t;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        } "),t("span",{style:{color:"#F97583"}},"finally"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            lock."),t("span",{style:{color:"#B392F0"}},"unlock"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// 阻塞添加")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"public"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"void"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"put"),t("span",{style:{color:"#E1E4E8"}},"(T "),t("span",{style:{color:"#FFAB70"}},"task"),t("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        lock."),t("span",{style:{color:"#B392F0"}},"lock"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"try"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"while"),t("span",{style:{color:"#E1E4E8"}}," (queue."),t("span",{style:{color:"#B392F0"}},"size"),t("span",{style:{color:"#E1E4E8"}},"() "),t("span",{style:{color:"#F97583"}},"=="),t("span",{style:{color:"#E1E4E8"}}," capcity) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#F97583"}},"try"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                    log."),t("span",{style:{color:"#B392F0"}},"debug"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#9ECBFF"}},'"等待加入任务队列 {} ..."'),t("span",{style:{color:"#E1E4E8"}},", task);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                    fullWaitSet."),t("span",{style:{color:"#B392F0"}},"await"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                } "),t("span",{style:{color:"#F97583"}},"catch"),t("span",{style:{color:"#E1E4E8"}}," (InterruptedException "),t("span",{style:{color:"#FFAB70"}},"e"),t("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                    e."),t("span",{style:{color:"#B392F0"}},"printStackTrace"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            log."),t("span",{style:{color:"#B392F0"}},"debug"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#9ECBFF"}},'"加入任务队列 {}"'),t("span",{style:{color:"#E1E4E8"}},", task);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            queue."),t("span",{style:{color:"#B392F0"}},"addLast"),t("span",{style:{color:"#E1E4E8"}},"(task);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            emptyWaitSet."),t("span",{style:{color:"#B392F0"}},"signal"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        } "),t("span",{style:{color:"#F97583"}},"finally"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            lock."),t("span",{style:{color:"#B392F0"}},"unlock"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// 带超时时间阻塞添加")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"public"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"boolean"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"offer"),t("span",{style:{color:"#E1E4E8"}},"(T "),t("span",{style:{color:"#FFAB70"}},"task"),t("span",{style:{color:"#E1E4E8"}},", "),t("span",{style:{color:"#F97583"}},"long"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#FFAB70"}},"timeout"),t("span",{style:{color:"#E1E4E8"}},", TimeUnit "),t("span",{style:{color:"#FFAB70"}},"timeUnit"),t("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        lock."),t("span",{style:{color:"#B392F0"}},"lock"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"try"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"long"),t("span",{style:{color:"#E1E4E8"}}," nanos "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," timeUnit."),t("span",{style:{color:"#B392F0"}},"toNanos"),t("span",{style:{color:"#E1E4E8"}},"(timeout);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"while"),t("span",{style:{color:"#E1E4E8"}}," (queue."),t("span",{style:{color:"#B392F0"}},"size"),t("span",{style:{color:"#E1E4E8"}},"() "),t("span",{style:{color:"#F97583"}},"=="),t("span",{style:{color:"#E1E4E8"}}," capcity) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#F97583"}},"try"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                    "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}},"(nanos "),t("span",{style:{color:"#F97583"}},"<="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"0"),t("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                        "),t("span",{style:{color:"#F97583"}},"return"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"false"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                    log."),t("span",{style:{color:"#B392F0"}},"debug"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#9ECBFF"}},'"等待加入任务队列 {} ..."'),t("span",{style:{color:"#E1E4E8"}},", task);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                    nanos "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," fullWaitSet."),t("span",{style:{color:"#B392F0"}},"awaitNanos"),t("span",{style:{color:"#E1E4E8"}},"(nanos);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                } "),t("span",{style:{color:"#F97583"}},"catch"),t("span",{style:{color:"#E1E4E8"}}," (InterruptedException "),t("span",{style:{color:"#FFAB70"}},"e"),t("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                    e."),t("span",{style:{color:"#B392F0"}},"printStackTrace"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            log."),t("span",{style:{color:"#B392F0"}},"debug"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#9ECBFF"}},'"加入任务队列 {}"'),t("span",{style:{color:"#E1E4E8"}},", task);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            queue."),t("span",{style:{color:"#B392F0"}},"addLast"),t("span",{style:{color:"#E1E4E8"}},"(task);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            emptyWaitSet."),t("span",{style:{color:"#B392F0"}},"signal"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"return"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"true"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        } "),t("span",{style:{color:"#F97583"}},"finally"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            lock."),t("span",{style:{color:"#B392F0"}},"unlock"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"public"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"size"),t("span",{style:{color:"#E1E4E8"}},"() {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        lock."),t("span",{style:{color:"#B392F0"}},"lock"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"try"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"return"),t("span",{style:{color:"#E1E4E8"}}," queue."),t("span",{style:{color:"#B392F0"}},"size"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        } "),t("span",{style:{color:"#F97583"}},"finally"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            lock."),t("span",{style:{color:"#B392F0"}},"unlock"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"public"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"void"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"tryPut"),t("span",{style:{color:"#E1E4E8"}},"(RejectPolicy<"),t("span",{style:{color:"#F97583"}},"T"),t("span",{style:{color:"#E1E4E8"}},"> "),t("span",{style:{color:"#FFAB70"}},"rejectPolicy"),t("span",{style:{color:"#E1E4E8"}},", T "),t("span",{style:{color:"#FFAB70"}},"task"),t("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        lock."),t("span",{style:{color:"#B392F0"}},"lock"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"try"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#6A737D"}},"// 判断队列是否满")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}},"(queue."),t("span",{style:{color:"#B392F0"}},"size"),t("span",{style:{color:"#E1E4E8"}},"() "),t("span",{style:{color:"#F97583"}},"=="),t("span",{style:{color:"#E1E4E8"}}," capcity) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                rejectPolicy."),t("span",{style:{color:"#B392F0"}},"reject"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#79B8FF"}},"this"),t("span",{style:{color:"#E1E4E8"}},", task);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            } "),t("span",{style:{color:"#F97583"}},"else"),t("span",{style:{color:"#E1E4E8"}}," {  "),t("span",{style:{color:"#6A737D"}},"// 有空闲")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                log."),t("span",{style:{color:"#B392F0"}},"debug"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#9ECBFF"}},'"加入任务队列 {}"'),t("span",{style:{color:"#E1E4E8"}},", task);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                queue."),t("span",{style:{color:"#B392F0"}},"addLast"),t("span",{style:{color:"#E1E4E8"}},"(task);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                emptyWaitSet."),t("span",{style:{color:"#B392F0"}},"signal"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        } "),t("span",{style:{color:"#F97583"}},"finally"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            lock."),t("span",{style:{color:"#B392F0"}},"unlock"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"}")])])]),t("pre",{class:"shiki github-light vp-code-light"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"@"),t("span",{style:{color:"#D73A49"}},"Slf4j"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#005CC5"}},"topic"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#032F62"}},'"c.TestPool"'),t("span",{style:{color:"#24292E"}},")")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"public"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"class"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"TestPool"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"public"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"static"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"void"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"main"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#D73A49"}},"String"),t("span",{style:{color:"#24292E"}},"[] "),t("span",{style:{color:"#E36209"}},"args"),t("span",{style:{color:"#24292E"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        ThreadPool threadPool "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"new"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"ThreadPool"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#005CC5"}},"1"),t("span",{style:{color:"#24292E"}},",")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#005CC5"}},"1000"),t("span",{style:{color:"#24292E"}},", TimeUnit.MILLISECONDS, "),t("span",{style:{color:"#005CC5"}},"1"),t("span",{style:{color:"#24292E"}},", (queue, task)"),t("span",{style:{color:"#D73A49"}},"->"),t("span",{style:{color:"#24292E"}},"{")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#6A737D"}},"// 1. 死等")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"//            queue.put(task);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#6A737D"}},"// 2) 带超时等待")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"//            queue.offer(task, 1500, TimeUnit.MILLISECONDS);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#6A737D"}},"// 3) 让调用者放弃任务执行")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},'//            log.debug("放弃{}", task);')]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#6A737D"}},"// 4) 让调用者抛出异常")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},'//            throw new RuntimeException("任务执行失败 " + task);')]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#6A737D"}},"// 5) 让调用者自己执行任务")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            task."),t("span",{style:{color:"#6F42C1"}},"run"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        });")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"for"),t("span",{style:{color:"#24292E"}}," ("),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," i "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"0"),t("span",{style:{color:"#24292E"}},"; i "),t("span",{style:{color:"#D73A49"}},"<"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"4"),t("span",{style:{color:"#24292E"}},"; i"),t("span",{style:{color:"#D73A49"}},"++"),t("span",{style:{color:"#24292E"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," j "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," i;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            threadPool."),t("span",{style:{color:"#6F42C1"}},"execute"),t("span",{style:{color:"#24292E"}},"(() "),t("span",{style:{color:"#D73A49"}},"->"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#D73A49"}},"try"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                    Thread."),t("span",{style:{color:"#6F42C1"}},"sleep"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#005CC5"}},"1000L"),t("span",{style:{color:"#24292E"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                } "),t("span",{style:{color:"#D73A49"}},"catch"),t("span",{style:{color:"#24292E"}}," (InterruptedException "),t("span",{style:{color:"#E36209"}},"e"),t("span",{style:{color:"#24292E"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                    e."),t("span",{style:{color:"#6F42C1"}},"printStackTrace"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                log."),t("span",{style:{color:"#6F42C1"}},"debug"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#032F62"}},'"{}"'),t("span",{style:{color:"#24292E"}},", j);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            });")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"}")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"@"),t("span",{style:{color:"#D73A49"}},"FunctionalInterface"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6A737D"}},"// 拒绝策略")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"interface"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"RejectPolicy"),t("span",{style:{color:"#24292E"}},"<"),t("span",{style:{color:"#D73A49"}},"T"),t("span",{style:{color:"#24292E"}},"> {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"void"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"reject"),t("span",{style:{color:"#24292E"}},"(BlockingQueue<"),t("span",{style:{color:"#D73A49"}},"T"),t("span",{style:{color:"#24292E"}},"> "),t("span",{style:{color:"#E36209"}},"queue"),t("span",{style:{color:"#24292E"}},", T "),t("span",{style:{color:"#E36209"}},"task"),t("span",{style:{color:"#24292E"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"}")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"@"),t("span",{style:{color:"#D73A49"}},"Slf4j"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#005CC5"}},"topic"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#032F62"}},'"c.ThreadPool"'),t("span",{style:{color:"#24292E"}},")")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"class"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"ThreadPool"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// 任务队列")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"private"),t("span",{style:{color:"#24292E"}}," BlockingQueue<"),t("span",{style:{color:"#D73A49"}},"Runnable"),t("span",{style:{color:"#24292E"}},"> taskQueue;")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// 线程集合")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"private"),t("span",{style:{color:"#24292E"}}," HashSet<"),t("span",{style:{color:"#D73A49"}},"Worker"),t("span",{style:{color:"#24292E"}},"> workers "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"new"),t("span",{style:{color:"#24292E"}}," HashSet<>();")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// 核心线程数")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"private"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," coreSize;")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// 获取任务时的超时时间")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"private"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"long"),t("span",{style:{color:"#24292E"}}," timeout;")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"private"),t("span",{style:{color:"#24292E"}}," TimeUnit timeUnit;")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"private"),t("span",{style:{color:"#24292E"}}," RejectPolicy<"),t("span",{style:{color:"#D73A49"}},"Runnable"),t("span",{style:{color:"#24292E"}},"> rejectPolicy;")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// 执行任务")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"public"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"void"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"execute"),t("span",{style:{color:"#24292E"}},"(Runnable "),t("span",{style:{color:"#E36209"}},"task"),t("span",{style:{color:"#24292E"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6A737D"}},"// 当任务数没有超过 coreSize 时，直接交给 worker 对象执行")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6A737D"}},"// 如果任务数超过 coreSize 时，加入任务队列暂存")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"synchronized"),t("span",{style:{color:"#24292E"}}," (workers) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}},"(workers."),t("span",{style:{color:"#6F42C1"}},"size"),t("span",{style:{color:"#24292E"}},"() "),t("span",{style:{color:"#D73A49"}},"<"),t("span",{style:{color:"#24292E"}}," coreSize) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                Worker worker "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"new"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"Worker"),t("span",{style:{color:"#24292E"}},"(task);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                log."),t("span",{style:{color:"#6F42C1"}},"debug"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#032F62"}},'"新增 worker{}, {}"'),t("span",{style:{color:"#24292E"}},", worker, task);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                workers."),t("span",{style:{color:"#6F42C1"}},"add"),t("span",{style:{color:"#24292E"}},"(worker);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                worker."),t("span",{style:{color:"#6F42C1"}},"start"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            } "),t("span",{style:{color:"#D73A49"}},"else"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"//                taskQueue.put(task);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#6A737D"}},"// 1) 死等")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#6A737D"}},"// 2) 带超时等待")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#6A737D"}},"// 3) 让调用者放弃任务执行")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#6A737D"}},"// 4) 让调用者抛出异常")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#6A737D"}},"// 5) 让调用者自己执行任务")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                taskQueue."),t("span",{style:{color:"#6F42C1"}},"tryPut"),t("span",{style:{color:"#24292E"}},"(rejectPolicy, task);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    }")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"public"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"ThreadPool"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#E36209"}},"coreSize"),t("span",{style:{color:"#24292E"}},", "),t("span",{style:{color:"#D73A49"}},"long"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#E36209"}},"timeout"),t("span",{style:{color:"#24292E"}},", TimeUnit "),t("span",{style:{color:"#E36209"}},"timeUnit"),t("span",{style:{color:"#24292E"}},", "),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#E36209"}},"queueCapcity"),t("span",{style:{color:"#24292E"}},", RejectPolicy<"),t("span",{style:{color:"#D73A49"}},"Runnable"),t("span",{style:{color:"#24292E"}},"> "),t("span",{style:{color:"#E36209"}},"rejectPolicy"),t("span",{style:{color:"#24292E"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#005CC5"}},"this"),t("span",{style:{color:"#24292E"}},".coreSize "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," coreSize;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#005CC5"}},"this"),t("span",{style:{color:"#24292E"}},".timeout "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," timeout;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#005CC5"}},"this"),t("span",{style:{color:"#24292E"}},".timeUnit "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," timeUnit;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#005CC5"}},"this"),t("span",{style:{color:"#24292E"}},".taskQueue "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"new"),t("span",{style:{color:"#24292E"}}," BlockingQueue<>(queueCapcity);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#005CC5"}},"this"),t("span",{style:{color:"#24292E"}},".rejectPolicy "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," rejectPolicy;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    }")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"class"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"Worker"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"extends"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"Thread"),t("span",{style:{color:"#24292E"}},"{")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"private"),t("span",{style:{color:"#24292E"}}," Runnable task;")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"public"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"Worker"),t("span",{style:{color:"#24292E"}},"(Runnable "),t("span",{style:{color:"#E36209"}},"task"),t("span",{style:{color:"#24292E"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#005CC5"}},"this"),t("span",{style:{color:"#24292E"}},".task "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," task;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        }")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        @"),t("span",{style:{color:"#D73A49"}},"Override")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"public"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"void"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"run"),t("span",{style:{color:"#24292E"}},"() {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#6A737D"}},"// 执行任务")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#6A737D"}},"// 1) 当 task 不为空，执行任务")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#6A737D"}},"// 2) 当 task 执行完毕，再接着从任务队列获取任务并执行")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"//            while(task != null || (task = taskQueue.take()) != null) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"while"),t("span",{style:{color:"#24292E"}},"(task "),t("span",{style:{color:"#D73A49"}},"!="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"null"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"||"),t("span",{style:{color:"#24292E"}}," (task "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," taskQueue."),t("span",{style:{color:"#6F42C1"}},"poll"),t("span",{style:{color:"#24292E"}},"(timeout, timeUnit)) "),t("span",{style:{color:"#D73A49"}},"!="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"null"),t("span",{style:{color:"#24292E"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#D73A49"}},"try"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                    log."),t("span",{style:{color:"#6F42C1"}},"debug"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#032F62"}},'"正在执行...{}"'),t("span",{style:{color:"#24292E"}},", task);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                    task."),t("span",{style:{color:"#6F42C1"}},"run"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                } "),t("span",{style:{color:"#D73A49"}},"catch"),t("span",{style:{color:"#24292E"}}," (Exception "),t("span",{style:{color:"#E36209"}},"e"),t("span",{style:{color:"#24292E"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                    e."),t("span",{style:{color:"#6F42C1"}},"printStackTrace"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                } "),t("span",{style:{color:"#D73A49"}},"finally"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                    task "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"null"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"synchronized"),t("span",{style:{color:"#24292E"}}," (workers) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                log."),t("span",{style:{color:"#6F42C1"}},"debug"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#032F62"}},'"worker 被移除{}"'),t("span",{style:{color:"#24292E"}},", "),t("span",{style:{color:"#005CC5"}},"this"),t("span",{style:{color:"#24292E"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                workers."),t("span",{style:{color:"#6F42C1"}},"remove"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#005CC5"}},"this"),t("span",{style:{color:"#24292E"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"}")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"@"),t("span",{style:{color:"#D73A49"}},"Slf4j"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#005CC5"}},"topic"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#032F62"}},'"c.BlockingQueue"'),t("span",{style:{color:"#24292E"}},")")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"class"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"BlockingQueue"),t("span",{style:{color:"#24292E"}},"<"),t("span",{style:{color:"#D73A49"}},"T"),t("span",{style:{color:"#24292E"}},"> {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// 1. 任务队列")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"private"),t("span",{style:{color:"#24292E"}}," Deque<"),t("span",{style:{color:"#D73A49"}},"T"),t("span",{style:{color:"#24292E"}},"> queue "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"new"),t("span",{style:{color:"#24292E"}}," ArrayDeque<>();")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// 2. 锁")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"private"),t("span",{style:{color:"#24292E"}}," ReentrantLock lock "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"new"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"ReentrantLock"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// 3. 生产者条件变量")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"private"),t("span",{style:{color:"#24292E"}}," Condition fullWaitSet "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," lock."),t("span",{style:{color:"#6F42C1"}},"newCondition"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// 4. 消费者条件变量")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"private"),t("span",{style:{color:"#24292E"}}," Condition emptyWaitSet "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," lock."),t("span",{style:{color:"#6F42C1"}},"newCondition"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// 5. 容量")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"private"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," capcity;")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"public"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"BlockingQueue"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#E36209"}},"capcity"),t("span",{style:{color:"#24292E"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#005CC5"}},"this"),t("span",{style:{color:"#24292E"}},".capcity "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," capcity;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    }")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// 带超时阻塞获取")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"public"),t("span",{style:{color:"#24292E"}}," T "),t("span",{style:{color:"#6F42C1"}},"poll"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#D73A49"}},"long"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#E36209"}},"timeout"),t("span",{style:{color:"#24292E"}},", TimeUnit "),t("span",{style:{color:"#E36209"}},"unit"),t("span",{style:{color:"#24292E"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        lock."),t("span",{style:{color:"#6F42C1"}},"lock"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"try"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#6A737D"}},"// 将 timeout 统一转换为 纳秒")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"long"),t("span",{style:{color:"#24292E"}}," nanos "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," unit."),t("span",{style:{color:"#6F42C1"}},"toNanos"),t("span",{style:{color:"#24292E"}},"(timeout);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"while"),t("span",{style:{color:"#24292E"}}," (queue."),t("span",{style:{color:"#6F42C1"}},"isEmpty"),t("span",{style:{color:"#24292E"}},"()) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#D73A49"}},"try"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                    "),t("span",{style:{color:"#6A737D"}},"// 返回值是剩余时间")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                    "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (nanos "),t("span",{style:{color:"#D73A49"}},"<="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"0"),t("span",{style:{color:"#24292E"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                        "),t("span",{style:{color:"#D73A49"}},"return"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"null"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                    nanos "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," emptyWaitSet."),t("span",{style:{color:"#6F42C1"}},"awaitNanos"),t("span",{style:{color:"#24292E"}},"(nanos);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                } "),t("span",{style:{color:"#D73A49"}},"catch"),t("span",{style:{color:"#24292E"}}," (InterruptedException "),t("span",{style:{color:"#E36209"}},"e"),t("span",{style:{color:"#24292E"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                    e."),t("span",{style:{color:"#6F42C1"}},"printStackTrace"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            T t "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," queue."),t("span",{style:{color:"#6F42C1"}},"removeFirst"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            fullWaitSet."),t("span",{style:{color:"#6F42C1"}},"signal"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"return"),t("span",{style:{color:"#24292E"}}," t;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        } "),t("span",{style:{color:"#D73A49"}},"finally"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            lock."),t("span",{style:{color:"#6F42C1"}},"unlock"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    }")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// 阻塞获取")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"public"),t("span",{style:{color:"#24292E"}}," T "),t("span",{style:{color:"#6F42C1"}},"take"),t("span",{style:{color:"#24292E"}},"() {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        lock."),t("span",{style:{color:"#6F42C1"}},"lock"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"try"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"while"),t("span",{style:{color:"#24292E"}}," (queue."),t("span",{style:{color:"#6F42C1"}},"isEmpty"),t("span",{style:{color:"#24292E"}},"()) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#D73A49"}},"try"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                    emptyWaitSet."),t("span",{style:{color:"#6F42C1"}},"await"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                } "),t("span",{style:{color:"#D73A49"}},"catch"),t("span",{style:{color:"#24292E"}}," (InterruptedException "),t("span",{style:{color:"#E36209"}},"e"),t("span",{style:{color:"#24292E"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                    e."),t("span",{style:{color:"#6F42C1"}},"printStackTrace"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            T t "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," queue."),t("span",{style:{color:"#6F42C1"}},"removeFirst"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            fullWaitSet."),t("span",{style:{color:"#6F42C1"}},"signal"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"return"),t("span",{style:{color:"#24292E"}}," t;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        } "),t("span",{style:{color:"#D73A49"}},"finally"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            lock."),t("span",{style:{color:"#6F42C1"}},"unlock"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    }")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// 阻塞添加")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"public"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"void"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"put"),t("span",{style:{color:"#24292E"}},"(T "),t("span",{style:{color:"#E36209"}},"task"),t("span",{style:{color:"#24292E"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        lock."),t("span",{style:{color:"#6F42C1"}},"lock"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"try"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"while"),t("span",{style:{color:"#24292E"}}," (queue."),t("span",{style:{color:"#6F42C1"}},"size"),t("span",{style:{color:"#24292E"}},"() "),t("span",{style:{color:"#D73A49"}},"=="),t("span",{style:{color:"#24292E"}}," capcity) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#D73A49"}},"try"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                    log."),t("span",{style:{color:"#6F42C1"}},"debug"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#032F62"}},'"等待加入任务队列 {} ..."'),t("span",{style:{color:"#24292E"}},", task);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                    fullWaitSet."),t("span",{style:{color:"#6F42C1"}},"await"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                } "),t("span",{style:{color:"#D73A49"}},"catch"),t("span",{style:{color:"#24292E"}}," (InterruptedException "),t("span",{style:{color:"#E36209"}},"e"),t("span",{style:{color:"#24292E"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                    e."),t("span",{style:{color:"#6F42C1"}},"printStackTrace"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            log."),t("span",{style:{color:"#6F42C1"}},"debug"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#032F62"}},'"加入任务队列 {}"'),t("span",{style:{color:"#24292E"}},", task);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            queue."),t("span",{style:{color:"#6F42C1"}},"addLast"),t("span",{style:{color:"#24292E"}},"(task);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            emptyWaitSet."),t("span",{style:{color:"#6F42C1"}},"signal"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        } "),t("span",{style:{color:"#D73A49"}},"finally"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            lock."),t("span",{style:{color:"#6F42C1"}},"unlock"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    }")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// 带超时时间阻塞添加")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"public"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"boolean"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"offer"),t("span",{style:{color:"#24292E"}},"(T "),t("span",{style:{color:"#E36209"}},"task"),t("span",{style:{color:"#24292E"}},", "),t("span",{style:{color:"#D73A49"}},"long"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#E36209"}},"timeout"),t("span",{style:{color:"#24292E"}},", TimeUnit "),t("span",{style:{color:"#E36209"}},"timeUnit"),t("span",{style:{color:"#24292E"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        lock."),t("span",{style:{color:"#6F42C1"}},"lock"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"try"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"long"),t("span",{style:{color:"#24292E"}}," nanos "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," timeUnit."),t("span",{style:{color:"#6F42C1"}},"toNanos"),t("span",{style:{color:"#24292E"}},"(timeout);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"while"),t("span",{style:{color:"#24292E"}}," (queue."),t("span",{style:{color:"#6F42C1"}},"size"),t("span",{style:{color:"#24292E"}},"() "),t("span",{style:{color:"#D73A49"}},"=="),t("span",{style:{color:"#24292E"}}," capcity) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#D73A49"}},"try"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                    "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}},"(nanos "),t("span",{style:{color:"#D73A49"}},"<="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"0"),t("span",{style:{color:"#24292E"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                        "),t("span",{style:{color:"#D73A49"}},"return"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"false"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                    log."),t("span",{style:{color:"#6F42C1"}},"debug"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#032F62"}},'"等待加入任务队列 {} ..."'),t("span",{style:{color:"#24292E"}},", task);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                    nanos "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," fullWaitSet."),t("span",{style:{color:"#6F42C1"}},"awaitNanos"),t("span",{style:{color:"#24292E"}},"(nanos);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                } "),t("span",{style:{color:"#D73A49"}},"catch"),t("span",{style:{color:"#24292E"}}," (InterruptedException "),t("span",{style:{color:"#E36209"}},"e"),t("span",{style:{color:"#24292E"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                    e."),t("span",{style:{color:"#6F42C1"}},"printStackTrace"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            log."),t("span",{style:{color:"#6F42C1"}},"debug"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#032F62"}},'"加入任务队列 {}"'),t("span",{style:{color:"#24292E"}},", task);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            queue."),t("span",{style:{color:"#6F42C1"}},"addLast"),t("span",{style:{color:"#24292E"}},"(task);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            emptyWaitSet."),t("span",{style:{color:"#6F42C1"}},"signal"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"return"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"true"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        } "),t("span",{style:{color:"#D73A49"}},"finally"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            lock."),t("span",{style:{color:"#6F42C1"}},"unlock"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    }")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"public"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"size"),t("span",{style:{color:"#24292E"}},"() {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        lock."),t("span",{style:{color:"#6F42C1"}},"lock"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"try"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"return"),t("span",{style:{color:"#24292E"}}," queue."),t("span",{style:{color:"#6F42C1"}},"size"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        } "),t("span",{style:{color:"#D73A49"}},"finally"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            lock."),t("span",{style:{color:"#6F42C1"}},"unlock"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    }")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"public"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"void"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"tryPut"),t("span",{style:{color:"#24292E"}},"(RejectPolicy<"),t("span",{style:{color:"#D73A49"}},"T"),t("span",{style:{color:"#24292E"}},"> "),t("span",{style:{color:"#E36209"}},"rejectPolicy"),t("span",{style:{color:"#24292E"}},", T "),t("span",{style:{color:"#E36209"}},"task"),t("span",{style:{color:"#24292E"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        lock."),t("span",{style:{color:"#6F42C1"}},"lock"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"try"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#6A737D"}},"// 判断队列是否满")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}},"(queue."),t("span",{style:{color:"#6F42C1"}},"size"),t("span",{style:{color:"#24292E"}},"() "),t("span",{style:{color:"#D73A49"}},"=="),t("span",{style:{color:"#24292E"}}," capcity) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                rejectPolicy."),t("span",{style:{color:"#6F42C1"}},"reject"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#005CC5"}},"this"),t("span",{style:{color:"#24292E"}},", task);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            } "),t("span",{style:{color:"#D73A49"}},"else"),t("span",{style:{color:"#24292E"}}," {  "),t("span",{style:{color:"#6A737D"}},"// 有空闲")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                log."),t("span",{style:{color:"#6F42C1"}},"debug"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#032F62"}},'"加入任务队列 {}"'),t("span",{style:{color:"#24292E"}},", task);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                queue."),t("span",{style:{color:"#6F42C1"}},"addLast"),t("span",{style:{color:"#24292E"}},"(task);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                emptyWaitSet."),t("span",{style:{color:"#6F42C1"}},"signal"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        } "),t("span",{style:{color:"#D73A49"}},"finally"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            lock."),t("span",{style:{color:"#6F42C1"}},"unlock"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"}")])])])],-1),S=t("p",null,"实现了一个简单的线程池",-1),v=t("ul",null,[t("li",null,[p("阻塞队列BlockingQueue用于暂存来不及被线程执行的任务 "),t("ul",null,[t("li",null,"也可以说是平衡生产者和消费者执行速度上的差异"),t("li",null,[p("里面的获取任务和放入任务用到了"),t("strong",null,"生产者消费者模式")])])]),t("li",null,[p("线程池中对线程Thread进行了再次的封装，封装为了Worker "),t("ul",null,[t("li",null,[p("在调用任务的run方法时，线程会去执行该任务，执行完毕后还会"),t("strong",null,"到阻塞队列中获取新任务来执行")])])]),t("li",null,[p("线程池中执行任务的主要方法为execute方法 "),t("ul",null,[t("li",null,"执行时要判断正在执行的线程数是否大于了线程池容量")])]),t("li",null,"当超过总线程数（核心线程未执行完+工作队列已满）执行自定义拒绝策略（函数式接口）")],-1),w={id:"_2、threadpoolexecutor",tabindex:"-1"},T={id:"继承关系",tabindex:"-1"},x=t("figure",null,[t("img",{src:"https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/20201022212832.png",alt:"img",loading:"lazy",decoding:"async"})],-1),N={id:"线程池状态",tabindex:"-1"},I=t("div",{class:"language-java"},[t("button",{title:"Copy Code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki github-dark vp-code-dark"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// 线程池状态")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// runState is stored in the high-order bits")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// RUNNING 高3位为111")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"private"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"static"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"final"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," RUNNING    "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"-"),t("span",{style:{color:"#79B8FF"}},"1"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"<<"),t("span",{style:{color:"#E1E4E8"}}," COUNT_BITS;")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// SHUTDOWN 高3位为000")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"private"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"static"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"final"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," SHUTDOWN   "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}},"  "),t("span",{style:{color:"#79B8FF"}},"0"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"<<"),t("span",{style:{color:"#E1E4E8"}}," COUNT_BITS;")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// 高3位 001")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"private"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"static"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"final"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," STOP       "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}},"  "),t("span",{style:{color:"#79B8FF"}},"1"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"<<"),t("span",{style:{color:"#E1E4E8"}}," COUNT_BITS;")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// 高3位 010")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"private"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"static"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"final"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," TIDYING    "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}},"  "),t("span",{style:{color:"#79B8FF"}},"2"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"<<"),t("span",{style:{color:"#E1E4E8"}}," COUNT_BITS;")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// 高3位 011")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"private"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"static"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"final"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," TERMINATED "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}},"  "),t("span",{style:{color:"#79B8FF"}},"3"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"<<"),t("span",{style:{color:"#E1E4E8"}}," COUNT_BITS;")])])]),t("pre",{class:"shiki github-light vp-code-light"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// 线程池状态")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// runState is stored in the high-order bits")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// RUNNING 高3位为111")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"private"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"static"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"final"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," RUNNING    "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"-"),t("span",{style:{color:"#005CC5"}},"1"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"<<"),t("span",{style:{color:"#24292E"}}," COUNT_BITS;")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// SHUTDOWN 高3位为000")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"private"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"static"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"final"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," SHUTDOWN   "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}},"  "),t("span",{style:{color:"#005CC5"}},"0"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"<<"),t("span",{style:{color:"#24292E"}}," COUNT_BITS;")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// 高3位 001")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"private"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"static"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"final"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," STOP       "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}},"  "),t("span",{style:{color:"#005CC5"}},"1"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"<<"),t("span",{style:{color:"#24292E"}}," COUNT_BITS;")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// 高3位 010")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"private"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"static"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"final"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," TIDYING    "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}},"  "),t("span",{style:{color:"#005CC5"}},"2"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"<<"),t("span",{style:{color:"#24292E"}}," COUNT_BITS;")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// 高3位 011")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"private"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"static"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"final"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," TERMINATED "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}},"  "),t("span",{style:{color:"#005CC5"}},"3"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"<<"),t("span",{style:{color:"#24292E"}}," COUNT_BITS;")])])])],-1),L=t("table",null,[t("thead",null,[t("tr",null,[t("th",null,"状态名称"),t("th",null,"高3位的值"),t("th",null,"描述")])]),t("tbody",null,[t("tr",null,[t("td",null,"RUNNING"),t("td",null,"111"),t("td",null,"接收新任务，同时处理任务队列中的任务")]),t("tr",null,[t("td",null,"SHUTDOWN"),t("td",null,"000"),t("td",null,"不接受新任务，但是处理任务队列中的任务")]),t("tr",null,[t("td",null,"STOP"),t("td",null,"001"),t("td",null,"中断正在执行的任务，同时抛弃阻塞队列中的任务")]),t("tr",null,[t("td",null,"TIDYING"),t("td",null,"010"),t("td",null,"任务执行完毕，活动线程为0时，即将进入终结阶段")]),t("tr",null,[t("td",null,"TERMINATED"),t("td",null,"011"),t("td",null,"终结状态")])])],-1),j=t("p",null,[p("线程池状态和线程池中线程的数量"),t("strong",null,"由一个原子整型ctl来共同表示")],-1),R=t("ul",null,[t("li",null,[p("使用一个数来表示两个值的主要原因是："),t("strong",null,"可以通过一次CAS同时更改两个属性的值")])],-1),O=t("div",{class:"language-java"},[t("button",{title:"Copy Code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki github-dark vp-code-dark"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// c 为旧值， ctlOf 返回结果为新值")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"ctl."),t("span",{style:{color:"#B392F0"}},"compareAndSet"),t("span",{style:{color:"#E1E4E8"}},"(c, "),t("span",{style:{color:"#B392F0"}},"ctlOf"),t("span",{style:{color:"#E1E4E8"}},"(targetState, "),t("span",{style:{color:"#B392F0"}},"workerCountOf"),t("span",{style:{color:"#E1E4E8"}},"(c))));")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// rs(runningState) 为高 3 位代表线程池状态， wc 为低 29 位代表线程个数，ctl 是合并它们")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"private"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"static"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"ctlOf"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," rs, "),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," wc) { "),t("span",{style:{color:"#F97583"}},"return"),t("span",{style:{color:"#E1E4E8"}}," rs "),t("span",{style:{color:"#F97583"}},"|"),t("span",{style:{color:"#E1E4E8"}}," wc; }")])])]),t("pre",{class:"shiki github-light vp-code-light"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// c 为旧值， ctlOf 返回结果为新值")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"ctl."),t("span",{style:{color:"#6F42C1"}},"compareAndSet"),t("span",{style:{color:"#24292E"}},"(c, "),t("span",{style:{color:"#6F42C1"}},"ctlOf"),t("span",{style:{color:"#24292E"}},"(targetState, "),t("span",{style:{color:"#6F42C1"}},"workerCountOf"),t("span",{style:{color:"#24292E"}},"(c))));")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// rs(runningState) 为高 3 位代表线程池状态， wc 为低 29 位代表线程个数，ctl 是合并它们")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"private"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"static"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"ctlOf"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," rs, "),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," wc) { "),t("span",{style:{color:"#D73A49"}},"return"),t("span",{style:{color:"#24292E"}}," rs "),t("span",{style:{color:"#D73A49"}},"|"),t("span",{style:{color:"#24292E"}}," wc; }")])])])],-1),q=t("div",{class:"language-java"},[t("button",{title:"Copy Code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki github-dark vp-code-dark"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// 原子整数，前3位保存了线程池的状态，剩余位保存的是线程数量")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"private"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"final"),t("span",{style:{color:"#E1E4E8"}}," AtomicInteger ctl "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"new"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"AtomicInteger"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#B392F0"}},"ctlOf"),t("span",{style:{color:"#E1E4E8"}},"(RUNNING, "),t("span",{style:{color:"#79B8FF"}},"0"),t("span",{style:{color:"#E1E4E8"}},"));")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// 并不是所有平台的int都是32位。")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// 去掉前三位保存线程状态的位数，剩下的用于保存线程数量")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// 高3位为0，剩余位数全为1")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"private"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"static"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"final"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," COUNT_BITS "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," Integer.SIZE "),t("span",{style:{color:"#F97583"}},"-"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"3"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// 2^COUNT_BITS次方，表示可以保存的最大线程数")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// CAPACITY 的高3位为 0")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"private"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"static"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"final"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," CAPACITY   "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," ("),t("span",{style:{color:"#79B8FF"}},"1"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"<<"),t("span",{style:{color:"#E1E4E8"}}," COUNT_BITS) "),t("span",{style:{color:"#F97583"}},"-"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"1"),t("span",{style:{color:"#E1E4E8"}},";")])])]),t("pre",{class:"shiki github-light vp-code-light"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// 原子整数，前3位保存了线程池的状态，剩余位保存的是线程数量")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"private"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"final"),t("span",{style:{color:"#24292E"}}," AtomicInteger ctl "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"new"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"AtomicInteger"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#6F42C1"}},"ctlOf"),t("span",{style:{color:"#24292E"}},"(RUNNING, "),t("span",{style:{color:"#005CC5"}},"0"),t("span",{style:{color:"#24292E"}},"));")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// 并不是所有平台的int都是32位。")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// 去掉前三位保存线程状态的位数，剩下的用于保存线程数量")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// 高3位为0，剩余位数全为1")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"private"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"static"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"final"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," COUNT_BITS "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," Integer.SIZE "),t("span",{style:{color:"#D73A49"}},"-"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"3"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// 2^COUNT_BITS次方，表示可以保存的最大线程数")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// CAPACITY 的高3位为 0")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"private"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"static"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"final"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," CAPACITY   "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," ("),t("span",{style:{color:"#005CC5"}},"1"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"<<"),t("span",{style:{color:"#24292E"}}," COUNT_BITS) "),t("span",{style:{color:"#D73A49"}},"-"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"1"),t("span",{style:{color:"#24292E"}},";")])])])],-1),P=t("p",null,"获取线程池状态、线程数量以及合并两个值的操作",-1),z=t("div",{class:"language-java"},[t("button",{title:"Copy Code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki github-dark vp-code-dark"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// Packing and unpacking ctl")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// 获取运行状态")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// 该操作会让除高3位以外的数全部变为0")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"private"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"static"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"runStateOf"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," c)     { "),t("span",{style:{color:"#F97583"}},"return"),t("span",{style:{color:"#E1E4E8"}}," c "),t("span",{style:{color:"#F97583"}},"&"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"~"),t("span",{style:{color:"#E1E4E8"}},"CAPACITY; }")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// 获取运行线程数")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// 该操作会让高3位为0")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"private"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"static"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"workerCountOf"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," c)  { "),t("span",{style:{color:"#F97583"}},"return"),t("span",{style:{color:"#E1E4E8"}}," c "),t("span",{style:{color:"#F97583"}},"&"),t("span",{style:{color:"#E1E4E8"}}," CAPACITY; }")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// 计算ctl新值")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"private"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"static"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"ctlOf"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," rs, "),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," wc) { "),t("span",{style:{color:"#F97583"}},"return"),t("span",{style:{color:"#E1E4E8"}}," rs "),t("span",{style:{color:"#F97583"}},"|"),t("span",{style:{color:"#E1E4E8"}}," wc; }")])])]),t("pre",{class:"shiki github-light vp-code-light"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// Packing and unpacking ctl")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// 获取运行状态")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// 该操作会让除高3位以外的数全部变为0")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"private"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"static"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"runStateOf"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," c)     { "),t("span",{style:{color:"#D73A49"}},"return"),t("span",{style:{color:"#24292E"}}," c "),t("span",{style:{color:"#D73A49"}},"&"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"~"),t("span",{style:{color:"#24292E"}},"CAPACITY; }")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// 获取运行线程数")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// 该操作会让高3位为0")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"private"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"static"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"workerCountOf"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," c)  { "),t("span",{style:{color:"#D73A49"}},"return"),t("span",{style:{color:"#24292E"}}," c "),t("span",{style:{color:"#D73A49"}},"&"),t("span",{style:{color:"#24292E"}}," CAPACITY; }")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// 计算ctl新值")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"private"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"static"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"ctlOf"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," rs, "),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," wc) { "),t("span",{style:{color:"#D73A49"}},"return"),t("span",{style:{color:"#24292E"}}," rs "),t("span",{style:{color:"#D73A49"}},"|"),t("span",{style:{color:"#24292E"}}," wc; }")])])])],-1),_={id:"线程池属性",tabindex:"-1"},K=t("div",{class:"language-java"},[t("button",{title:"Copy Code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki github-dark vp-code-dark"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// 工作线程，内部封装了Thread")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"private"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"final"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"class"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"Worker")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"extends"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"AbstractQueuedSynchronizer")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"implements"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"Runnable"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    ...")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"}")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// 阻塞队列，用于存放来不及被核心线程执行的任务")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"private"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"final"),t("span",{style:{color:"#E1E4E8"}}," BlockingQueue<"),t("span",{style:{color:"#F97583"}},"Runnable"),t("span",{style:{color:"#E1E4E8"}},"> workQueue;")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// 锁")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"private"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"final"),t("span",{style:{color:"#E1E4E8"}}," ReentrantLock mainLock "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"new"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"ReentrantLock"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"//  用于存放核心线程的容器，只有当持有锁时才能够获取其中的元素（核心线程）")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"private"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"final"),t("span",{style:{color:"#E1E4E8"}}," HashSet<"),t("span",{style:{color:"#F97583"}},"Worker"),t("span",{style:{color:"#E1E4E8"}},"> workers "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"new"),t("span",{style:{color:"#E1E4E8"}}," HashSet<"),t("span",{style:{color:"#F97583"}},"Worker"),t("span",{style:{color:"#E1E4E8"}},">();")])])]),t("pre",{class:"shiki github-light vp-code-light"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// 工作线程，内部封装了Thread")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"private"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"final"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"class"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"Worker")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"extends"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"AbstractQueuedSynchronizer")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"implements"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"Runnable"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    ...")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"}")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// 阻塞队列，用于存放来不及被核心线程执行的任务")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"private"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"final"),t("span",{style:{color:"#24292E"}}," BlockingQueue<"),t("span",{style:{color:"#D73A49"}},"Runnable"),t("span",{style:{color:"#24292E"}},"> workQueue;")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// 锁")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"private"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"final"),t("span",{style:{color:"#24292E"}}," ReentrantLock mainLock "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"new"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"ReentrantLock"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"//  用于存放核心线程的容器，只有当持有锁时才能够获取其中的元素（核心线程）")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"private"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"final"),t("span",{style:{color:"#24292E"}}," HashSet<"),t("span",{style:{color:"#D73A49"}},"Worker"),t("span",{style:{color:"#24292E"}},"> workers "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"new"),t("span",{style:{color:"#24292E"}}," HashSet<"),t("span",{style:{color:"#D73A49"}},"Worker"),t("span",{style:{color:"#24292E"}},">();")])])])],-1),V={id:"构造方法极其参数",tabindex:"-1"},M=t("p",null,[t("strong",null,"ThreadPoolExecutor最全面的构造方法")],-1),W=t("p",null,"也是构造自定义线程池的方法",-1),U=t("div",{class:"language-java"},[t("button",{title:"Copy Code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki github-dark vp-code-dark"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"public"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"ThreadPoolExecutor"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," corePoolSize,")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                          "),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," maximumPoolSize,")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                          "),t("span",{style:{color:"#F97583"}},"long"),t("span",{style:{color:"#E1E4E8"}}," keepAliveTime,")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                          TimeUnit unit,")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                          BlockingQueue"),t("span",{style:{color:"#F97583"}},"<"),t("span",{style:{color:"#E1E4E8"}},"Runnable"),t("span",{style:{color:"#F97583"}},">"),t("span",{style:{color:"#E1E4E8"}}," workQueue,")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                          ThreadFactory threadFactory,")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                          RejectedExecutionHandler handler)")])])]),t("pre",{class:"shiki github-light vp-code-light"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"public"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"ThreadPoolExecutor"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," corePoolSize,")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                          "),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," maximumPoolSize,")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                          "),t("span",{style:{color:"#D73A49"}},"long"),t("span",{style:{color:"#24292E"}}," keepAliveTime,")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                          TimeUnit unit,")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                          BlockingQueue"),t("span",{style:{color:"#D73A49"}},"<"),t("span",{style:{color:"#24292E"}},"Runnable"),t("span",{style:{color:"#D73A49"}},">"),t("span",{style:{color:"#24292E"}}," workQueue,")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                          ThreadFactory threadFactory,")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                          RejectedExecutionHandler handler)")])])])],-1),Q={id:"参数解释",tabindex:"-1"},H=t("strong",null,"参数解释",-1),G=t("ul",null,[t("li",null,"corePoolSize：核心线程数"),t("li",null,[p("maximumPoolSize：最大线程数 "),t("ul",null,[t("li",null,"maximumPoolSize - corePoolSize = 救急线程数")])]),t("li",null,"keepAliveTime：救急线程空闲时的最大生存时间"),t("li",null,"unit：时间单位"),t("li",null,[p("workQueue：阻塞队列（存放任务） "),t("ul",null,[t("li",null,"有界阻塞队列 ArrayBlockingQueue"),t("li",null,"无界阻塞队列 LinkedBlockingQueue"),t("li",null,"最多只有一个同步元素的 SynchronousQueue"),t("li",null,"优先队列 PriorityBlockingQueue")])]),t("li",null,"threadFactory：线程工厂（给线程取名字）"),t("li",null,"handler：拒绝策略")],-1),J={id:"工作方式",tabindex:"-1"},Y=t("figure",null,[t("img",{src:"https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230718205840140.png",alt:"image-20230718205840140",loading:"lazy",decoding:"async"})],-1),X=t("ul",null,[t("li",null,[p("当一个任务传给线程池以后，可能有以下几种可能 "),t("ul",null,[t("li",null,"将任务分配给一个核心线程来执行"),t("li",null,"核心线程都在执行任务，将任务放到阻塞队列workQueue中等待被执行"),t("li",null,[p("阻塞队列满了，使用救急线程来执行任务 "),t("ul",null,[t("li",null,"救急线程用完以后，超过生存时间（keepAliveTime）后会被释放")])]),t("li",null,"任务总数大于了 最大线程数（maximumPoolSize）与阻塞队列容量的最大值（workQueue.capacity），使用拒接策略")])])],-1),Z=t("blockquote",null,[t("ul",null,[t("li",null,[t("p",null,"线程池中刚开始没有线程，当一个任务提交给线程池后，线程池会创建一个新线程来执行任务。")]),t("li",null,[t("p",null,"当线程数达到 corePoolSize 并没有线程空闲，这时再加入任务，新加的任务会被加入workQueue 队列排"),t("p",null,"队，直到有空闲的线程。")]),t("li",null,[t("p",null,[p("如果队列选择了有界队列，那么任务超过了队列大小时，会创建 maximumPoolSize - corePoolSize 数目的线程来救急。("),t("strong",null,"救急线程的前提是配合有界队列来使用"),p(")")])]),t("li",null,[t("p",null,"如果线程到达 maximumPoolSize 仍然有新任务这时会执行拒绝策略。拒绝策略 jdk 提供了 4 种实现，其它著名框架也提供了实现"),t("ul",null,[t("li",null,"AbortPolicy 让调用者抛出 RejectedExecutionException 异常，这是默认策略"),t("li",null,"CallerRunsPolicy 让调用者运行任务"),t("li",null,"DiscardPolicy 放弃本次任务"),t("li",null,"DiscardOldestPolicy 放弃队列中最早的任务，本任务取而代之Dubbo 的实现，在抛出 RejectedExecutionException 异常之前会记录日志，并 dump 线程栈信息，方便定位问题"),t("li",null,"Netty 的实现，是创建一个新线程来执行任务"),t("li",null,"ActiveMQ 的实现，带超时等待（60s）尝试放入队列，类似我们之前自定义的拒绝策略"),t("li",null,"PinPoint 的实现，它使用了一个拒绝策略链，会逐一尝试策略链中每种拒绝策略")])]),t("li",null,[t("p",null,"当高峰过去后，超过corePoolSize 的救急线程如果一段时间没有任务做，需要结束节省资源，这个时间由keepAliveTime 和 unit 来控制。")])])],-1),$={id:"拒绝策略",tabindex:"-1"},ss=t("p",null,[p("如果线程到达 maximumPoolSize 仍然有新任务这时会执行"),t("strong",null,"拒绝策略"),p("。拒绝策略 jdk 提供了 4 种实现")],-1),ls=t("figure",null,[t("img",{src:"https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/20201022194718.png",alt:"img",loading:"lazy",decoding:"async"})],-1),os=t("ul",null,[t("li",null,[p("AbortPolicy：让调用者抛出 RejectedExecutionException 异常，"),t("strong",null,"这是默认策略")]),t("li",null,"CallerRunsPolicy：让调用者运行任务"),t("li",null,"DiscardPolicy：放弃本次任务"),t("li",null,"DiscardOldestPolicy：放弃队列中最早的任务，本任务取而代之")],-1),ns={id:"使用",tabindex:"-1"},as=t("div",{class:"language-java"},[t("button",{title:"Copy Code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki github-dark vp-code-dark"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"public"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"class"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"Demo1"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"   "),t("span",{style:{color:"#F97583"}},"static"),t("span",{style:{color:"#E1E4E8"}}," AtomicInteger threadId "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"new"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"AtomicInteger"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#79B8FF"}},"0"),t("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"   "),t("span",{style:{color:"#F97583"}},"public"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"static"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"void"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"main"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#F97583"}},"String"),t("span",{style:{color:"#E1E4E8"}},"[] "),t("span",{style:{color:"#FFAB70"}},"args"),t("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"      "),t("span",{style:{color:"#6A737D"}},"// 手动创建线程池")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"      "),t("span",{style:{color:"#6A737D"}},"// 创建有界阻塞队列")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"      ArrayBlockingQueue<"),t("span",{style:{color:"#F97583"}},"Runnable"),t("span",{style:{color:"#E1E4E8"}},"> runnable "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"new"),t("span",{style:{color:"#E1E4E8"}}," ArrayBlockingQueue<"),t("span",{style:{color:"#F97583"}},"Runnable"),t("span",{style:{color:"#E1E4E8"}},">("),t("span",{style:{color:"#79B8FF"}},"10"),t("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"      "),t("span",{style:{color:"#6A737D"}},"// 创建线程工厂")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"      ThreadFactory threadFactory "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"new"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"ThreadFactory"),t("span",{style:{color:"#E1E4E8"}},"() {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"         @"),t("span",{style:{color:"#F97583"}},"Override")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"         "),t("span",{style:{color:"#F97583"}},"public"),t("span",{style:{color:"#E1E4E8"}}," Thread "),t("span",{style:{color:"#B392F0"}},"newThread"),t("span",{style:{color:"#E1E4E8"}},"(Runnable "),t("span",{style:{color:"#FFAB70"}},"r"),t("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            Thread thread "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"new"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"Thread"),t("span",{style:{color:"#E1E4E8"}},"(r, "),t("span",{style:{color:"#9ECBFF"}},'"working_thread_"'),t("span",{style:{color:"#F97583"}},"+"),t("span",{style:{color:"#E1E4E8"}},"threadId."),t("span",{style:{color:"#B392F0"}},"getAndIncrement"),t("span",{style:{color:"#E1E4E8"}},"());")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"return"),t("span",{style:{color:"#E1E4E8"}}," thread;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"         }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"      };")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"      "),t("span",{style:{color:"#6A737D"}},"// 手动创建线程池")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"      "),t("span",{style:{color:"#6A737D"}},"// 拒绝策略采用默认策略")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"      ThreadPoolExecutor executor "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"new"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"ThreadPoolExecutor"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#79B8FF"}},"5"),t("span",{style:{color:"#E1E4E8"}},", "),t("span",{style:{color:"#79B8FF"}},"7"),t("span",{style:{color:"#E1E4E8"}},", "),t("span",{style:{color:"#79B8FF"}},"10"),t("span",{style:{color:"#E1E4E8"}},", TimeUnit.SECONDS, runnable, threadFactory);")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"      "),t("span",{style:{color:"#F97583"}},"for"),t("span",{style:{color:"#E1E4E8"}}," ("),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," i "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"0"),t("span",{style:{color:"#E1E4E8"}},"; i "),t("span",{style:{color:"#F97583"}},"<"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"20"),t("span",{style:{color:"#E1E4E8"}},"; i"),t("span",{style:{color:"#F97583"}},"++"),t("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"         executor."),t("span",{style:{color:"#B392F0"}},"execute"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#F97583"}},"new"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"Runnable"),t("span",{style:{color:"#E1E4E8"}},"() {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            @"),t("span",{style:{color:"#F97583"}},"Override")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"public"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"void"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"run"),t("span",{style:{color:"#E1E4E8"}},"() {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"               System.out."),t("span",{style:{color:"#B392F0"}},"println"),t("span",{style:{color:"#E1E4E8"}},"(Thread."),t("span",{style:{color:"#B392F0"}},"currentThread"),t("span",{style:{color:"#E1E4E8"}},"());")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"               "),t("span",{style:{color:"#F97583"}},"try"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                  Thread."),t("span",{style:{color:"#B392F0"}},"sleep"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#79B8FF"}},"100000"),t("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"               } "),t("span",{style:{color:"#F97583"}},"catch"),t("span",{style:{color:"#E1E4E8"}}," (InterruptedException "),t("span",{style:{color:"#FFAB70"}},"e"),t("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                  e."),t("span",{style:{color:"#B392F0"}},"printStackTrace"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"               }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"         });")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"      }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"   }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"}")])])]),t("pre",{class:"shiki github-light vp-code-light"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"public"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"class"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"Demo1"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"   "),t("span",{style:{color:"#D73A49"}},"static"),t("span",{style:{color:"#24292E"}}," AtomicInteger threadId "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"new"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"AtomicInteger"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#005CC5"}},"0"),t("span",{style:{color:"#24292E"}},");")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"   "),t("span",{style:{color:"#D73A49"}},"public"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"static"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"void"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"main"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#D73A49"}},"String"),t("span",{style:{color:"#24292E"}},"[] "),t("span",{style:{color:"#E36209"}},"args"),t("span",{style:{color:"#24292E"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"      "),t("span",{style:{color:"#6A737D"}},"// 手动创建线程池")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"      "),t("span",{style:{color:"#6A737D"}},"// 创建有界阻塞队列")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"      ArrayBlockingQueue<"),t("span",{style:{color:"#D73A49"}},"Runnable"),t("span",{style:{color:"#24292E"}},"> runnable "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"new"),t("span",{style:{color:"#24292E"}}," ArrayBlockingQueue<"),t("span",{style:{color:"#D73A49"}},"Runnable"),t("span",{style:{color:"#24292E"}},">("),t("span",{style:{color:"#005CC5"}},"10"),t("span",{style:{color:"#24292E"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"      "),t("span",{style:{color:"#6A737D"}},"// 创建线程工厂")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"      ThreadFactory threadFactory "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"new"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"ThreadFactory"),t("span",{style:{color:"#24292E"}},"() {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"         @"),t("span",{style:{color:"#D73A49"}},"Override")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"         "),t("span",{style:{color:"#D73A49"}},"public"),t("span",{style:{color:"#24292E"}}," Thread "),t("span",{style:{color:"#6F42C1"}},"newThread"),t("span",{style:{color:"#24292E"}},"(Runnable "),t("span",{style:{color:"#E36209"}},"r"),t("span",{style:{color:"#24292E"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            Thread thread "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"new"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"Thread"),t("span",{style:{color:"#24292E"}},"(r, "),t("span",{style:{color:"#032F62"}},'"working_thread_"'),t("span",{style:{color:"#D73A49"}},"+"),t("span",{style:{color:"#24292E"}},"threadId."),t("span",{style:{color:"#6F42C1"}},"getAndIncrement"),t("span",{style:{color:"#24292E"}},"());")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"return"),t("span",{style:{color:"#24292E"}}," thread;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"         }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"      };")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"      "),t("span",{style:{color:"#6A737D"}},"// 手动创建线程池")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"      "),t("span",{style:{color:"#6A737D"}},"// 拒绝策略采用默认策略")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"      ThreadPoolExecutor executor "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"new"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"ThreadPoolExecutor"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#005CC5"}},"5"),t("span",{style:{color:"#24292E"}},", "),t("span",{style:{color:"#005CC5"}},"7"),t("span",{style:{color:"#24292E"}},", "),t("span",{style:{color:"#005CC5"}},"10"),t("span",{style:{color:"#24292E"}},", TimeUnit.SECONDS, runnable, threadFactory);")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"      "),t("span",{style:{color:"#D73A49"}},"for"),t("span",{style:{color:"#24292E"}}," ("),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," i "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"0"),t("span",{style:{color:"#24292E"}},"; i "),t("span",{style:{color:"#D73A49"}},"<"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"20"),t("span",{style:{color:"#24292E"}},"; i"),t("span",{style:{color:"#D73A49"}},"++"),t("span",{style:{color:"#24292E"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"         executor."),t("span",{style:{color:"#6F42C1"}},"execute"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#D73A49"}},"new"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"Runnable"),t("span",{style:{color:"#24292E"}},"() {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            @"),t("span",{style:{color:"#D73A49"}},"Override")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"public"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"void"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"run"),t("span",{style:{color:"#24292E"}},"() {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"               System.out."),t("span",{style:{color:"#6F42C1"}},"println"),t("span",{style:{color:"#24292E"}},"(Thread."),t("span",{style:{color:"#6F42C1"}},"currentThread"),t("span",{style:{color:"#24292E"}},"());")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"               "),t("span",{style:{color:"#D73A49"}},"try"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                  Thread."),t("span",{style:{color:"#6F42C1"}},"sleep"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#005CC5"}},"100000"),t("span",{style:{color:"#24292E"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"               } "),t("span",{style:{color:"#D73A49"}},"catch"),t("span",{style:{color:"#24292E"}}," (InterruptedException "),t("span",{style:{color:"#E36209"}},"e"),t("span",{style:{color:"#24292E"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                  e."),t("span",{style:{color:"#6F42C1"}},"printStackTrace"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"               }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"         });")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"      }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"   }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"}")])])])],-1),es={id:"fixedthreadpool",tabindex:"-1"},cs=t("div",{class:"language-java"},[t("button",{title:"Copy Code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki github-dark vp-code-dark"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"public"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"class"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"TestFixedThreadPool"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"   "),t("span",{style:{color:"#F97583"}},"public"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"static"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"void"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"main"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#F97583"}},"String"),t("span",{style:{color:"#E1E4E8"}},"[] "),t("span",{style:{color:"#FFAB70"}},"args"),t("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"      "),t("span",{style:{color:"#6A737D"}},"// 自定义线程工厂")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"      ThreadFactory factory "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"new"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"ThreadFactory"),t("span",{style:{color:"#E1E4E8"}},"() {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"         AtomicInteger atomicInteger "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"new"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"AtomicInteger"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#79B8FF"}},"1"),t("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"         @"),t("span",{style:{color:"#F97583"}},"Override")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"         "),t("span",{style:{color:"#F97583"}},"public"),t("span",{style:{color:"#E1E4E8"}}," Thread "),t("span",{style:{color:"#B392F0"}},"newThread"),t("span",{style:{color:"#E1E4E8"}},"(Runnable "),t("span",{style:{color:"#FFAB70"}},"r"),t("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"return"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"new"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"Thread"),t("span",{style:{color:"#E1E4E8"}},"(r, "),t("span",{style:{color:"#9ECBFF"}},'"myThread_"'),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"+"),t("span",{style:{color:"#E1E4E8"}}," atomicInteger."),t("span",{style:{color:"#B392F0"}},"getAndIncrement"),t("span",{style:{color:"#E1E4E8"}},"());")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"         }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"      };")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"      "),t("span",{style:{color:"#6A737D"}},"// 创建核心线程数量为2的线程池")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"      "),t("span",{style:{color:"#6A737D"}},"// 通过 ThreadFactory可以给线程添加名字")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"      ExecutorService executorService "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," Executors."),t("span",{style:{color:"#B392F0"}},"newFixedThreadPool"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#79B8FF"}},"2"),t("span",{style:{color:"#E1E4E8"}},", factory);")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"      "),t("span",{style:{color:"#6A737D"}},"// 任务")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"      Runnable runnable "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"new"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"Runnable"),t("span",{style:{color:"#E1E4E8"}},"() {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"         @"),t("span",{style:{color:"#F97583"}},"Override")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"         "),t("span",{style:{color:"#F97583"}},"public"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"void"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"run"),t("span",{style:{color:"#E1E4E8"}},"() {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            System.out."),t("span",{style:{color:"#B392F0"}},"println"),t("span",{style:{color:"#E1E4E8"}},"(Thread."),t("span",{style:{color:"#B392F0"}},"currentThread"),t("span",{style:{color:"#E1E4E8"}},"()."),t("span",{style:{color:"#B392F0"}},"getName"),t("span",{style:{color:"#E1E4E8"}},"());")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            System.out."),t("span",{style:{color:"#B392F0"}},"println"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#9ECBFF"}},'"this is fixedThreadPool"'),t("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"         }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"      };")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"      ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"      executorService."),t("span",{style:{color:"#B392F0"}},"execute"),t("span",{style:{color:"#E1E4E8"}},"(runnable);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"   }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"}")])])]),t("pre",{class:"shiki github-light vp-code-light"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"public"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"class"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"TestFixedThreadPool"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"   "),t("span",{style:{color:"#D73A49"}},"public"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"static"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"void"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"main"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#D73A49"}},"String"),t("span",{style:{color:"#24292E"}},"[] "),t("span",{style:{color:"#E36209"}},"args"),t("span",{style:{color:"#24292E"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"      "),t("span",{style:{color:"#6A737D"}},"// 自定义线程工厂")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"      ThreadFactory factory "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"new"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"ThreadFactory"),t("span",{style:{color:"#24292E"}},"() {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"         AtomicInteger atomicInteger "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"new"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"AtomicInteger"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#005CC5"}},"1"),t("span",{style:{color:"#24292E"}},");")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"         @"),t("span",{style:{color:"#D73A49"}},"Override")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"         "),t("span",{style:{color:"#D73A49"}},"public"),t("span",{style:{color:"#24292E"}}," Thread "),t("span",{style:{color:"#6F42C1"}},"newThread"),t("span",{style:{color:"#24292E"}},"(Runnable "),t("span",{style:{color:"#E36209"}},"r"),t("span",{style:{color:"#24292E"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"return"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"new"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"Thread"),t("span",{style:{color:"#24292E"}},"(r, "),t("span",{style:{color:"#032F62"}},'"myThread_"'),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"+"),t("span",{style:{color:"#24292E"}}," atomicInteger."),t("span",{style:{color:"#6F42C1"}},"getAndIncrement"),t("span",{style:{color:"#24292E"}},"());")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"         }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"      };")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"      "),t("span",{style:{color:"#6A737D"}},"// 创建核心线程数量为2的线程池")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"      "),t("span",{style:{color:"#6A737D"}},"// 通过 ThreadFactory可以给线程添加名字")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"      ExecutorService executorService "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," Executors."),t("span",{style:{color:"#6F42C1"}},"newFixedThreadPool"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#005CC5"}},"2"),t("span",{style:{color:"#24292E"}},", factory);")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"      "),t("span",{style:{color:"#6A737D"}},"// 任务")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"      Runnable runnable "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"new"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"Runnable"),t("span",{style:{color:"#24292E"}},"() {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"         @"),t("span",{style:{color:"#D73A49"}},"Override")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"         "),t("span",{style:{color:"#D73A49"}},"public"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"void"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"run"),t("span",{style:{color:"#24292E"}},"() {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            System.out."),t("span",{style:{color:"#6F42C1"}},"println"),t("span",{style:{color:"#24292E"}},"(Thread."),t("span",{style:{color:"#6F42C1"}},"currentThread"),t("span",{style:{color:"#24292E"}},"()."),t("span",{style:{color:"#6F42C1"}},"getName"),t("span",{style:{color:"#24292E"}},"());")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            System.out."),t("span",{style:{color:"#6F42C1"}},"println"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#032F62"}},'"this is fixedThreadPool"'),t("span",{style:{color:"#24292E"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"         }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"      };")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"      ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"      executorService."),t("span",{style:{color:"#6F42C1"}},"execute"),t("span",{style:{color:"#24292E"}},"(runnable);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"   }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"}")])])])],-1),ts=t("p",null,"固定大小的线程池可以传入两个参数",-1),ps=t("ul",null,[t("li",null,"核心线程数：nThreads"),t("li",null,"线程工厂：threadFactory")],-1),rs=t("p",null,"内部调用的构造方法",-1),Es=t("div",{class:"language-java"},[t("button",{title:"Copy Code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki github-dark vp-code-dark"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#B392F0"}},"ThreadPoolExecutor"),t("span",{style:{color:"#E1E4E8"}},"(nThreads, nThreads,")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                              "),t("span",{style:{color:"#79B8FF"}},"0L"),t("span",{style:{color:"#E1E4E8"}},", TimeUnit.MILLISECONDS,")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                              "),t("span",{style:{color:"#F97583"}},"new"),t("span",{style:{color:"#E1E4E8"}}," LinkedBlockingQueue<"),t("span",{style:{color:"#F97583"}},"Runnable"),t("span",{style:{color:"#E1E4E8"}},">(),")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                              threadFactory);")])])]),t("pre",{class:"shiki github-light vp-code-light"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#6F42C1"}},"ThreadPoolExecutor"),t("span",{style:{color:"#24292E"}},"(nThreads, nThreads,")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                              "),t("span",{style:{color:"#005CC5"}},"0L"),t("span",{style:{color:"#24292E"}},", TimeUnit.MILLISECONDS,")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                              "),t("span",{style:{color:"#D73A49"}},"new"),t("span",{style:{color:"#24292E"}}," LinkedBlockingQueue<"),t("span",{style:{color:"#D73A49"}},"Runnable"),t("span",{style:{color:"#24292E"}},">(),")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                              threadFactory);")])])])],-1),ys=t("p",null,"特点",-1),is=t("ul",null,[t("li",null,"核心线程数 == 最大线程数（没有救急线程被创建），因此也无需超时时间"),t("li",null,"阻塞队列是无界的，可以放任意数量的任务")],-1),Fs=t("blockquote",null,[t("p",null,[t("strong",null,"评价"),p(" 适用于任务量已知，相对耗时的任务")])],-1),us={id:"cachedthreadpool",tabindex:"-1"},As=t("div",{class:"language-"},[t("button",{title:"Copy Code",class:"copy"}),t("span",{class:"lang"}),t("pre",{class:"shiki github-dark vp-code-dark"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#e1e4e8"}},"ExecutorService executorService = Executors.newCachedThreadPool();")])])]),t("pre",{class:"shiki github-light vp-code-light"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#24292e"}},"ExecutorService executorService = Executors.newCachedThreadPool();")])])])],-1),ds=t("p",null,[t("strong",null,"内部构造方法")],-1),Ds=t("div",{class:"language-"},[t("button",{title:"Copy Code",class:"copy"}),t("span",{class:"lang"}),t("pre",{class:"shiki github-dark vp-code-dark"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#e1e4e8"}},"ThreadPoolExecutor(0, Integer.MAX_VALUE,")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#e1e4e8"}},"                              60L, TimeUnit.SECONDS,")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#e1e4e8"}},"                              new SynchronousQueue<Runnable>());")])])]),t("pre",{class:"shiki github-light vp-code-light"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#24292e"}},"ThreadPoolExecutor(0, Integer.MAX_VALUE,")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292e"}},"                              60L, TimeUnit.SECONDS,")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292e"}},"                              new SynchronousQueue<Runnable>());")])])])],-1),Cs=t("ul",null,[t("li",null,[t("p",null,[p("没有核心线程，最大线程数为Integer.MAX_VALUE，"),t("strong",null,"所有创建的线程都是救急线程"),p("，空闲时生存时间为60秒")]),t("ul",null,[t("li",null,[t("p",null,"全部都是救急线程（60s 后可以回收）")]),t("li",null,[t("p",null,"救急线程可以无限创建")])])]),t("li",null,[t("p",null,"阻塞队列使用的是SynchronousQueue"),t("ul",null,[t("li",null,[t("p",null,"SynchronousQueue是一种特殊的队列"),t("ul",null,[t("li",null,[t("strong",null,"没有容量"),p("，没有线程来取是放不进去的")])])]),t("li",null,[t("p",null,"只有当线程取任务时，才会将任务放入该阻塞队列中")])])])],-1),hs=t("blockquote",null,[t("p",null,[t("strong",null,"评价"),p(" 整个线程池表现为线程数会根据任务量不断增长，没有上限，当任务执行完毕，空闲 1分钟后释放线 程。 适合任务数比较密集，但每个任务执行时间较短的情况")])],-1),gs={id:"singlethread",tabindex:"-1"},Bs=t("div",{class:"language-java"},[t("button",{title:"Copy Code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki github-dark vp-code-dark"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"ExecutorService service "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," Executors."),t("span",{style:{color:"#B392F0"}},"newSingleThreadExecutor"),t("span",{style:{color:"#E1E4E8"}},"();")])])]),t("pre",{class:"shiki github-light vp-code-light"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"ExecutorService service "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," Executors."),t("span",{style:{color:"#6F42C1"}},"newSingleThreadExecutor"),t("span",{style:{color:"#24292E"}},"();")])])])],-1),fs=t("p",null,[t("strong",null,"内部构造方法")],-1),ks=t("div",{class:"language-java"},[t("button",{title:"Copy Code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki github-dark vp-code-dark"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"new"),t("span",{style:{color:"#E1E4E8"}}," FinalizableDelegatedExecutorService")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    ("),t("span",{style:{color:"#F97583"}},"new"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"ThreadPoolExecutor"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#79B8FF"}},"1"),t("span",{style:{color:"#E1E4E8"}},", "),t("span",{style:{color:"#79B8FF"}},"1"),t("span",{style:{color:"#E1E4E8"}},",")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                            "),t("span",{style:{color:"#79B8FF"}},"0L"),t("span",{style:{color:"#E1E4E8"}},", TimeUnit.MILLISECONDS,")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                            "),t("span",{style:{color:"#F97583"}},"new"),t("span",{style:{color:"#E1E4E8"}}," LinkedBlockingQueue<"),t("span",{style:{color:"#F97583"}},"Runnable"),t("span",{style:{color:"#E1E4E8"}},">()));")])])]),t("pre",{class:"shiki github-light vp-code-light"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"new"),t("span",{style:{color:"#24292E"}}," FinalizableDelegatedExecutorService")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    ("),t("span",{style:{color:"#D73A49"}},"new"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"ThreadPoolExecutor"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#005CC5"}},"1"),t("span",{style:{color:"#24292E"}},", "),t("span",{style:{color:"#005CC5"}},"1"),t("span",{style:{color:"#24292E"}},",")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                            "),t("span",{style:{color:"#005CC5"}},"0L"),t("span",{style:{color:"#24292E"}},", TimeUnit.MILLISECONDS,")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                            "),t("span",{style:{color:"#D73A49"}},"new"),t("span",{style:{color:"#24292E"}}," LinkedBlockingQueue<"),t("span",{style:{color:"#D73A49"}},"Runnable"),t("span",{style:{color:"#24292E"}},">()));")])])])],-1),bs=t("p",null,"使用场景：",-1),ms=t("p",null,"希望多个任务排队执行。线程数固定为 1，任务数多于 1 时，会放入无界队列排队。任务执行完毕，这唯一的线程",-1),Ss=t("p",null,"也不会被释放。",-1),vs=t("p",null,"区别：",-1),ws=t("ul",null,[t("li",null,[t("p",null,"自己创建一个单线程串行执行任务，如果任务执行失败而终止那么没有任何补救措施，而线程池还会新建一"),t("p",null,"个线程，保证池的正常工作")]),t("li",null,[t("p",null,"Executors.newSingleThreadExecutor() 线程个数始终为1，不能修改"),t("ul",null,[t("li",null,"FinalizableDelegatedExecutorService 应用的是装饰器模式，只对外暴露了 ExecutorService 接口，因此不能调用 ThreadPoolExecutor 中特有的方法")])]),t("li",null,[t("p",null,"Executors.newFixedThreadPool(1) 初始时为1，以后还可以修改"),t("ul",null,[t("li",null,"对外暴露的是 ThreadPoolExecutor 对象，可以强转后调用 setCorePoolSize 等方法进行修改")])])],-1),Ts={id:"几个注意",tabindex:"-1"},xs=t("ul",null,[t("li",null,[t("p",null,"SingleThread和自己创建一个线程来运行多个任务的区别"),t("ul",null,[t("li",null,"当线程正在执行的任务发生错误时，如果是自己创建的线程，该任务和剩余的任务就无法再继续运行下去。而SingleThread会创建一个新线程，继续执行任务队列中剩余的任务。")])]),t("li",null,[t("p",null,"SingleThread和newFixedThreadPool(1)的区别"),t("ul",null,[t("li",null,"newFixedThreadPool(1)传值为1，可以将FixedThreadPool强转为ThreadPoolExecutor，然后通过setCorePoolSize改变核心线程数")]),t("div",{class:"language-java"},[t("button",{title:"Copy Code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki github-dark vp-code-dark"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// 强转为ThreadPoolExecutor")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"ThreadPoolExecutor threadPool "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," (ThreadPoolExecutor) Executors."),t("span",{style:{color:"#B392F0"}},"newFixedThreadPool"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#79B8FF"}},"1"),t("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// 改变核心线程数")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"threadPool."),t("span",{style:{color:"#B392F0"}},"setCorePoolSize"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#79B8FF"}},"2"),t("span",{style:{color:"#E1E4E8"}},");")])])]),t("pre",{class:"shiki github-light vp-code-light"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// 强转为ThreadPoolExecutor")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"ThreadPoolExecutor threadPool "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," (ThreadPoolExecutor) Executors."),t("span",{style:{color:"#6F42C1"}},"newFixedThreadPool"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#005CC5"}},"1"),t("span",{style:{color:"#24292E"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// 改变核心线程数")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"threadPool."),t("span",{style:{color:"#6F42C1"}},"setCorePoolSize"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#005CC5"}},"2"),t("span",{style:{color:"#24292E"}},");")])])])]),t("ul",null,[t("li",null,"而SingleThread无法修改核心线程数")])])],-1),Ns={id:"执行任务",tabindex:"-1"},Is={id:"execute-方法",tabindex:"-1"},Ls=t("div",{class:"language-java"},[t("button",{title:"Copy Code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki github-dark vp-code-dark"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#B392F0"}},"execute"),t("span",{style:{color:"#E1E4E8"}},"(Runnable command)")])])]),t("pre",{class:"shiki github-light vp-code-light"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#6F42C1"}},"execute"),t("span",{style:{color:"#24292E"}},"(Runnable command)")])])])],-1),js=t("p",null,"传入一个Runnable对象，执行其中的run方法",-1),Rs=t("p",null,[t("strong",null,"源码解析")],-1),Os=t("div",{class:"language-java"},[t("button",{title:"Copy Code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki github-dark vp-code-dark"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"public"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"void"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"execute"),t("span",{style:{color:"#E1E4E8"}},"(Runnable command) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (command "),t("span",{style:{color:"#F97583"}},"=="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"null"),t("span",{style:{color:"#E1E4E8"}},")")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"throw"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"new"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"NullPointerException"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// 获取ctl")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," c "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," ctl."),t("span",{style:{color:"#B392F0"}},"get"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// 判断当前启用的线程数是否小于核心线程数")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," ("),t("span",{style:{color:"#B392F0"}},"workerCountOf"),t("span",{style:{color:"#E1E4E8"}},"(c) "),t("span",{style:{color:"#F97583"}},"<"),t("span",{style:{color:"#E1E4E8"}}," corePoolSize) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#6A737D"}},"// 为该任务分配线程")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," ("),t("span",{style:{color:"#B392F0"}},"addWorker"),t("span",{style:{color:"#E1E4E8"}},"(command, "),t("span",{style:{color:"#79B8FF"}},"true"),t("span",{style:{color:"#E1E4E8"}},"))")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#6A737D"}},"// 分配成功就返回")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"return"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#6A737D"}},"// 分配失败再次获取ctl")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        c "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," ctl."),t("span",{style:{color:"#B392F0"}},"get"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// 分配和信息线程失败以后")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// 如果池状态为RUNNING并且插入到任务队列成功")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," ("),t("span",{style:{color:"#B392F0"}},"isRunning"),t("span",{style:{color:"#E1E4E8"}},"(c) "),t("span",{style:{color:"#F97583"}},"&&"),t("span",{style:{color:"#E1E4E8"}}," workQueue."),t("span",{style:{color:"#B392F0"}},"offer"),t("span",{style:{color:"#E1E4E8"}},"(command)) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#6A737D"}},"// 双重检测，可能在添加后线程池状态变为了非RUNNING")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," recheck "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," ctl."),t("span",{style:{color:"#B392F0"}},"get"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#6A737D"}},"// 如果池状态为非RUNNING，则不会执行新来的任务")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#6A737D"}},"// 将该任务从阻塞队列中移除")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," ("),t("span",{style:{color:"#F97583"}},"!"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"isRunning"),t("span",{style:{color:"#E1E4E8"}},"(recheck) "),t("span",{style:{color:"#F97583"}},"&&"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"remove"),t("span",{style:{color:"#E1E4E8"}},"(command))")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#6A737D"}},"// 调用拒绝策略，拒绝该任务的执行")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#B392F0"}},"reject"),t("span",{style:{color:"#E1E4E8"}},"(command);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#6A737D"}},"// 如果没有正在运行的线程")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"else"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," ("),t("span",{style:{color:"#B392F0"}},"workerCountOf"),t("span",{style:{color:"#E1E4E8"}},"(recheck) "),t("span",{style:{color:"#F97583"}},"=="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"0"),t("span",{style:{color:"#E1E4E8"}},")")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#6A737D"}},"// 就创建新线程来执行该任务")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#B392F0"}},"addWorker"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#79B8FF"}},"null"),t("span",{style:{color:"#E1E4E8"}},", "),t("span",{style:{color:"#79B8FF"}},"false"),t("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// 如果添加失败了（任务队列已满），就调用拒绝策略")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"else"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," ("),t("span",{style:{color:"#F97583"}},"!"),t("span",{style:{color:"#B392F0"}},"addWorker"),t("span",{style:{color:"#E1E4E8"}},"(command, "),t("span",{style:{color:"#79B8FF"}},"false"),t("span",{style:{color:"#E1E4E8"}},"))")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#B392F0"}},"reject"),t("span",{style:{color:"#E1E4E8"}},"(command);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"}")])])]),t("pre",{class:"shiki github-light vp-code-light"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"public"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"void"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"execute"),t("span",{style:{color:"#24292E"}},"(Runnable command) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (command "),t("span",{style:{color:"#D73A49"}},"=="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"null"),t("span",{style:{color:"#24292E"}},")")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"throw"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"new"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"NullPointerException"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// 获取ctl")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," c "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," ctl."),t("span",{style:{color:"#6F42C1"}},"get"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// 判断当前启用的线程数是否小于核心线程数")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," ("),t("span",{style:{color:"#6F42C1"}},"workerCountOf"),t("span",{style:{color:"#24292E"}},"(c) "),t("span",{style:{color:"#D73A49"}},"<"),t("span",{style:{color:"#24292E"}}," corePoolSize) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6A737D"}},"// 为该任务分配线程")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," ("),t("span",{style:{color:"#6F42C1"}},"addWorker"),t("span",{style:{color:"#24292E"}},"(command, "),t("span",{style:{color:"#005CC5"}},"true"),t("span",{style:{color:"#24292E"}},"))")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#6A737D"}},"// 分配成功就返回")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"return"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6A737D"}},"// 分配失败再次获取ctl")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        c "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," ctl."),t("span",{style:{color:"#6F42C1"}},"get"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// 分配和信息线程失败以后")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// 如果池状态为RUNNING并且插入到任务队列成功")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," ("),t("span",{style:{color:"#6F42C1"}},"isRunning"),t("span",{style:{color:"#24292E"}},"(c) "),t("span",{style:{color:"#D73A49"}},"&&"),t("span",{style:{color:"#24292E"}}," workQueue."),t("span",{style:{color:"#6F42C1"}},"offer"),t("span",{style:{color:"#24292E"}},"(command)) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6A737D"}},"// 双重检测，可能在添加后线程池状态变为了非RUNNING")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," recheck "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," ctl."),t("span",{style:{color:"#6F42C1"}},"get"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6A737D"}},"// 如果池状态为非RUNNING，则不会执行新来的任务")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6A737D"}},"// 将该任务从阻塞队列中移除")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," ("),t("span",{style:{color:"#D73A49"}},"!"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"isRunning"),t("span",{style:{color:"#24292E"}},"(recheck) "),t("span",{style:{color:"#D73A49"}},"&&"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"remove"),t("span",{style:{color:"#24292E"}},"(command))")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#6A737D"}},"// 调用拒绝策略，拒绝该任务的执行")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#6F42C1"}},"reject"),t("span",{style:{color:"#24292E"}},"(command);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6A737D"}},"// 如果没有正在运行的线程")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"else"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," ("),t("span",{style:{color:"#6F42C1"}},"workerCountOf"),t("span",{style:{color:"#24292E"}},"(recheck) "),t("span",{style:{color:"#D73A49"}},"=="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"0"),t("span",{style:{color:"#24292E"}},")")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#6A737D"}},"// 就创建新线程来执行该任务")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#6F42C1"}},"addWorker"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#005CC5"}},"null"),t("span",{style:{color:"#24292E"}},", "),t("span",{style:{color:"#005CC5"}},"false"),t("span",{style:{color:"#24292E"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// 如果添加失败了（任务队列已满），就调用拒绝策略")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"else"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," ("),t("span",{style:{color:"#D73A49"}},"!"),t("span",{style:{color:"#6F42C1"}},"addWorker"),t("span",{style:{color:"#24292E"}},"(command, "),t("span",{style:{color:"#005CC5"}},"false"),t("span",{style:{color:"#24292E"}},"))")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6F42C1"}},"reject"),t("span",{style:{color:"#24292E"}},"(command);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"}")])])])],-1),qs=t("p",null,"其中调用了**addWoker()**方法，再看看看这个方法",-1),Ps=t("div",{class:"language-java"},[t("button",{title:"Copy Code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki github-dark vp-code-dark"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"private"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"boolean"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"addWorker"),t("span",{style:{color:"#E1E4E8"}},"(Runnable firstTask, "),t("span",{style:{color:"#F97583"}},"boolean"),t("span",{style:{color:"#E1E4E8"}}," core) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    retry"),t("span",{style:{color:"#F97583"}},":")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"for"),t("span",{style:{color:"#E1E4E8"}}," (;;) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," c "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," ctl."),t("span",{style:{color:"#B392F0"}},"get"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," rs "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"runStateOf"),t("span",{style:{color:"#E1E4E8"}},"(c);")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#6A737D"}},"// Check if queue empty only if necessary.")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#6A737D"}},"// 如果池状态为非RUNNING状态、线程池为SHUTDOWN且该任务为空 或者阻塞队列中已经有任务")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (rs "),t("span",{style:{color:"#F97583"}},">="),t("span",{style:{color:"#E1E4E8"}}," SHUTDOWN "),t("span",{style:{color:"#F97583"}},"&&")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"!"),t("span",{style:{color:"#E1E4E8"}}," (rs "),t("span",{style:{color:"#F97583"}},"=="),t("span",{style:{color:"#E1E4E8"}}," SHUTDOWN "),t("span",{style:{color:"#F97583"}},"&&")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"               firstTask "),t("span",{style:{color:"#F97583"}},"=="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"null"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"&&")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"               "),t("span",{style:{color:"#F97583"}},"!"),t("span",{style:{color:"#E1E4E8"}}," workQueue."),t("span",{style:{color:"#B392F0"}},"isEmpty"),t("span",{style:{color:"#E1E4E8"}},"()))")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#6A737D"}},"// 创建新线程失败")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"return"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"false"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"for"),t("span",{style:{color:"#E1E4E8"}}," (;;) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#6A737D"}},"// 获得当前工作线程数")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," wc "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"workerCountOf"),t("span",{style:{color:"#E1E4E8"}},"(c);")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#6A737D"}},"// 参数中 core 为true")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#6A737D"}},"// CAPACITY 为 1 << COUNT_BITS-1，一般不会超过")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#6A737D"}},"// 如果工作线程数大于了核心线程数，则创建失败")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (wc "),t("span",{style:{color:"#F97583"}},">="),t("span",{style:{color:"#E1E4E8"}}," CAPACITY "),t("span",{style:{color:"#F97583"}},"||")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                wc "),t("span",{style:{color:"#F97583"}},">="),t("span",{style:{color:"#E1E4E8"}}," (core "),t("span",{style:{color:"#F97583"}},"?"),t("span",{style:{color:"#E1E4E8"}}," corePoolSize "),t("span",{style:{color:"#F97583"}},":"),t("span",{style:{color:"#E1E4E8"}}," maximumPoolSize))")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#F97583"}},"return"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"false"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#6A737D"}},"// 通过CAS操作改变c的值")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," ("),t("span",{style:{color:"#B392F0"}},"compareAndIncrementWorkerCount"),t("span",{style:{color:"#E1E4E8"}},"(c))")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#6A737D"}},"// 更改成功就跳出多重循环，且不再运行循环")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#F97583"}},"break"),t("span",{style:{color:"#E1E4E8"}}," retry;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#6A737D"}},"// 更改失败，重新获取ctl的值")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            c "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," ctl."),t("span",{style:{color:"#B392F0"}},"get"),t("span",{style:{color:"#E1E4E8"}},"();  "),t("span",{style:{color:"#6A737D"}},"// Re-read ctl")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," ("),t("span",{style:{color:"#B392F0"}},"runStateOf"),t("span",{style:{color:"#E1E4E8"}},"(c) "),t("span",{style:{color:"#F97583"}},"!="),t("span",{style:{color:"#E1E4E8"}}," rs)")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#6A737D"}},"// 跳出多重循环，且重新进入循环")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#F97583"}},"continue"),t("span",{style:{color:"#E1E4E8"}}," retry;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#6A737D"}},"// else CAS failed due to workerCount change; retry inner loop")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// 用于标记work中的任务是否成功执行")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"boolean"),t("span",{style:{color:"#E1E4E8"}}," workerStarted "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"false"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// 用于标记worker是否成功加入了线程池中")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"boolean"),t("span",{style:{color:"#E1E4E8"}}," workerAdded "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"false"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    Worker w "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"null"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"try"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#6A737D"}},"// 创建新线程来执行任务")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        w "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"new"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"Worker"),t("span",{style:{color:"#E1E4E8"}},"(firstTask);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"final"),t("span",{style:{color:"#E1E4E8"}}," Thread t "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," w.thread;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (t "),t("span",{style:{color:"#F97583"}},"!="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"null"),t("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"final"),t("span",{style:{color:"#E1E4E8"}}," ReentrantLock mainLock "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"this"),t("span",{style:{color:"#E1E4E8"}},".mainLock;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#6A737D"}},"// 加锁")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            mainLock."),t("span",{style:{color:"#B392F0"}},"lock"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"try"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#6A737D"}},"// Recheck while holding lock.")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#6A737D"}},"// Back out on ThreadFactory failure or if")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#6A737D"}},"// shut down before lock acquired.")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#6A737D"}},"// 加锁的同时再次检测")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#6A737D"}},"// 避免在释放锁之前调用了shut down")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," rs "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"runStateOf"),t("span",{style:{color:"#E1E4E8"}},"(ctl."),t("span",{style:{color:"#B392F0"}},"get"),t("span",{style:{color:"#E1E4E8"}},"());")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (rs "),t("span",{style:{color:"#F97583"}},"<"),t("span",{style:{color:"#E1E4E8"}}," SHUTDOWN "),t("span",{style:{color:"#F97583"}},"||")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                    (rs "),t("span",{style:{color:"#F97583"}},"=="),t("span",{style:{color:"#E1E4E8"}}," SHUTDOWN "),t("span",{style:{color:"#F97583"}},"&&"),t("span",{style:{color:"#E1E4E8"}}," firstTask "),t("span",{style:{color:"#F97583"}},"=="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"null"),t("span",{style:{color:"#E1E4E8"}},")) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                    "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (t."),t("span",{style:{color:"#B392F0"}},"isAlive"),t("span",{style:{color:"#E1E4E8"}},"()) "),t("span",{style:{color:"#6A737D"}},"// precheck that t is startable")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                        "),t("span",{style:{color:"#F97583"}},"throw"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"new"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"IllegalThreadStateException"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                    "),t("span",{style:{color:"#6A737D"}},"// 将线程添加到线程池中")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                    workers."),t("span",{style:{color:"#B392F0"}},"add"),t("span",{style:{color:"#E1E4E8"}},"(w);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                    "),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," s "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," workers."),t("span",{style:{color:"#B392F0"}},"size"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                    "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (s "),t("span",{style:{color:"#F97583"}},">"),t("span",{style:{color:"#E1E4E8"}}," largestPoolSize)")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                        largestPoolSize "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," s;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                    "),t("span",{style:{color:"#6A737D"}},"// 添加成功标志位变为true")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                    workerAdded "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"true"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            } "),t("span",{style:{color:"#F97583"}},"finally"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                mainLock."),t("span",{style:{color:"#B392F0"}},"unlock"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#6A737D"}},"// 如果worker成功加入了线程池，就执行其中的任务")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (workerAdded) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                t."),t("span",{style:{color:"#B392F0"}},"start"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#6A737D"}},"// 启动成功")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                workerStarted "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"true"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    } "),t("span",{style:{color:"#F97583"}},"finally"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#6A737D"}},"// 如果执行失败")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," ("),t("span",{style:{color:"#F97583"}},"!"),t("span",{style:{color:"#E1E4E8"}}," workerStarted)")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#6A737D"}},"// 调用添加失败的函数")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#B392F0"}},"addWorkerFailed"),t("span",{style:{color:"#E1E4E8"}},"(w);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"return"),t("span",{style:{color:"#E1E4E8"}}," workerStarted;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"}")])])]),t("pre",{class:"shiki github-light vp-code-light"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"private"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"boolean"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"addWorker"),t("span",{style:{color:"#24292E"}},"(Runnable firstTask, "),t("span",{style:{color:"#D73A49"}},"boolean"),t("span",{style:{color:"#24292E"}}," core) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    retry"),t("span",{style:{color:"#D73A49"}},":")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"for"),t("span",{style:{color:"#24292E"}}," (;;) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," c "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," ctl."),t("span",{style:{color:"#6F42C1"}},"get"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," rs "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"runStateOf"),t("span",{style:{color:"#24292E"}},"(c);")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6A737D"}},"// Check if queue empty only if necessary.")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6A737D"}},"// 如果池状态为非RUNNING状态、线程池为SHUTDOWN且该任务为空 或者阻塞队列中已经有任务")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (rs "),t("span",{style:{color:"#D73A49"}},">="),t("span",{style:{color:"#24292E"}}," SHUTDOWN "),t("span",{style:{color:"#D73A49"}},"&&")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"!"),t("span",{style:{color:"#24292E"}}," (rs "),t("span",{style:{color:"#D73A49"}},"=="),t("span",{style:{color:"#24292E"}}," SHUTDOWN "),t("span",{style:{color:"#D73A49"}},"&&")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"               firstTask "),t("span",{style:{color:"#D73A49"}},"=="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"null"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"&&")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"               "),t("span",{style:{color:"#D73A49"}},"!"),t("span",{style:{color:"#24292E"}}," workQueue."),t("span",{style:{color:"#6F42C1"}},"isEmpty"),t("span",{style:{color:"#24292E"}},"()))")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#6A737D"}},"// 创建新线程失败")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"return"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"false"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"for"),t("span",{style:{color:"#24292E"}}," (;;) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#6A737D"}},"// 获得当前工作线程数")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," wc "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"workerCountOf"),t("span",{style:{color:"#24292E"}},"(c);")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#6A737D"}},"// 参数中 core 为true")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#6A737D"}},"// CAPACITY 为 1 << COUNT_BITS-1，一般不会超过")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#6A737D"}},"// 如果工作线程数大于了核心线程数，则创建失败")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (wc "),t("span",{style:{color:"#D73A49"}},">="),t("span",{style:{color:"#24292E"}}," CAPACITY "),t("span",{style:{color:"#D73A49"}},"||")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                wc "),t("span",{style:{color:"#D73A49"}},">="),t("span",{style:{color:"#24292E"}}," (core "),t("span",{style:{color:"#D73A49"}},"?"),t("span",{style:{color:"#24292E"}}," corePoolSize "),t("span",{style:{color:"#D73A49"}},":"),t("span",{style:{color:"#24292E"}}," maximumPoolSize))")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#D73A49"}},"return"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"false"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#6A737D"}},"// 通过CAS操作改变c的值")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," ("),t("span",{style:{color:"#6F42C1"}},"compareAndIncrementWorkerCount"),t("span",{style:{color:"#24292E"}},"(c))")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#6A737D"}},"// 更改成功就跳出多重循环，且不再运行循环")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#D73A49"}},"break"),t("span",{style:{color:"#24292E"}}," retry;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#6A737D"}},"// 更改失败，重新获取ctl的值")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            c "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," ctl."),t("span",{style:{color:"#6F42C1"}},"get"),t("span",{style:{color:"#24292E"}},"();  "),t("span",{style:{color:"#6A737D"}},"// Re-read ctl")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," ("),t("span",{style:{color:"#6F42C1"}},"runStateOf"),t("span",{style:{color:"#24292E"}},"(c) "),t("span",{style:{color:"#D73A49"}},"!="),t("span",{style:{color:"#24292E"}}," rs)")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#6A737D"}},"// 跳出多重循环，且重新进入循环")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#D73A49"}},"continue"),t("span",{style:{color:"#24292E"}}," retry;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#6A737D"}},"// else CAS failed due to workerCount change; retry inner loop")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    }")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// 用于标记work中的任务是否成功执行")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"boolean"),t("span",{style:{color:"#24292E"}}," workerStarted "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"false"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// 用于标记worker是否成功加入了线程池中")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"boolean"),t("span",{style:{color:"#24292E"}}," workerAdded "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"false"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    Worker w "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"null"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"try"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6A737D"}},"// 创建新线程来执行任务")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        w "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"new"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"Worker"),t("span",{style:{color:"#24292E"}},"(firstTask);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"final"),t("span",{style:{color:"#24292E"}}," Thread t "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," w.thread;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (t "),t("span",{style:{color:"#D73A49"}},"!="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"null"),t("span",{style:{color:"#24292E"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"final"),t("span",{style:{color:"#24292E"}}," ReentrantLock mainLock "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"this"),t("span",{style:{color:"#24292E"}},".mainLock;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#6A737D"}},"// 加锁")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            mainLock."),t("span",{style:{color:"#6F42C1"}},"lock"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"try"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#6A737D"}},"// Recheck while holding lock.")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#6A737D"}},"// Back out on ThreadFactory failure or if")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#6A737D"}},"// shut down before lock acquired.")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#6A737D"}},"// 加锁的同时再次检测")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#6A737D"}},"// 避免在释放锁之前调用了shut down")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," rs "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"runStateOf"),t("span",{style:{color:"#24292E"}},"(ctl."),t("span",{style:{color:"#6F42C1"}},"get"),t("span",{style:{color:"#24292E"}},"());")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (rs "),t("span",{style:{color:"#D73A49"}},"<"),t("span",{style:{color:"#24292E"}}," SHUTDOWN "),t("span",{style:{color:"#D73A49"}},"||")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                    (rs "),t("span",{style:{color:"#D73A49"}},"=="),t("span",{style:{color:"#24292E"}}," SHUTDOWN "),t("span",{style:{color:"#D73A49"}},"&&"),t("span",{style:{color:"#24292E"}}," firstTask "),t("span",{style:{color:"#D73A49"}},"=="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"null"),t("span",{style:{color:"#24292E"}},")) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                    "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (t."),t("span",{style:{color:"#6F42C1"}},"isAlive"),t("span",{style:{color:"#24292E"}},"()) "),t("span",{style:{color:"#6A737D"}},"// precheck that t is startable")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                        "),t("span",{style:{color:"#D73A49"}},"throw"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"new"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"IllegalThreadStateException"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                    "),t("span",{style:{color:"#6A737D"}},"// 将线程添加到线程池中")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                    workers."),t("span",{style:{color:"#6F42C1"}},"add"),t("span",{style:{color:"#24292E"}},"(w);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                    "),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," s "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," workers."),t("span",{style:{color:"#6F42C1"}},"size"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                    "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (s "),t("span",{style:{color:"#D73A49"}},">"),t("span",{style:{color:"#24292E"}}," largestPoolSize)")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                        largestPoolSize "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," s;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                    "),t("span",{style:{color:"#6A737D"}},"// 添加成功标志位变为true")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                    workerAdded "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"true"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            } "),t("span",{style:{color:"#D73A49"}},"finally"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                mainLock."),t("span",{style:{color:"#6F42C1"}},"unlock"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#6A737D"}},"// 如果worker成功加入了线程池，就执行其中的任务")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (workerAdded) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                t."),t("span",{style:{color:"#6F42C1"}},"start"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#6A737D"}},"// 启动成功")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                workerStarted "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"true"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    } "),t("span",{style:{color:"#D73A49"}},"finally"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6A737D"}},"// 如果执行失败")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," ("),t("span",{style:{color:"#D73A49"}},"!"),t("span",{style:{color:"#24292E"}}," workerStarted)")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#6A737D"}},"// 调用添加失败的函数")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#6F42C1"}},"addWorkerFailed"),t("span",{style:{color:"#24292E"}},"(w);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"return"),t("span",{style:{color:"#24292E"}}," workerStarted;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"}")])])])],-1),zs={id:"提交任务",tabindex:"-1"},_s=t("div",{class:"language-java"},[t("button",{title:"Copy Code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki github-dark vp-code-dark"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// 执行任务")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"void"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"execute"),t("span",{style:{color:"#E1E4E8"}},"(Runnable command);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// 提交任务 task，用返回值 Future 获得任务执行结果")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"<"),t("span",{style:{color:"#E1E4E8"}},"T"),t("span",{style:{color:"#F97583"}},">"),t("span",{style:{color:"#E1E4E8"}}," Future"),t("span",{style:{color:"#F97583"}},"<"),t("span",{style:{color:"#E1E4E8"}},"T"),t("span",{style:{color:"#F97583"}},">"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"submit"),t("span",{style:{color:"#E1E4E8"}},"(Callable"),t("span",{style:{color:"#F97583"}},"<"),t("span",{style:{color:"#E1E4E8"}},"T"),t("span",{style:{color:"#F97583"}},">"),t("span",{style:{color:"#E1E4E8"}}," task);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// 提交 tasks 中所有任务")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"<"),t("span",{style:{color:"#E1E4E8"}},"T"),t("span",{style:{color:"#F97583"}},">"),t("span",{style:{color:"#E1E4E8"}}," List"),t("span",{style:{color:"#F97583"}},"<"),t("span",{style:{color:"#E1E4E8"}},"Future"),t("span",{style:{color:"#F97583"}},"<"),t("span",{style:{color:"#E1E4E8"}},"T"),t("span",{style:{color:"#F97583"}},">>"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"invokeAll"),t("span",{style:{color:"#E1E4E8"}},"(Collection"),t("span",{style:{color:"#F97583"}},"<?"),t("span",{style:{color:"#E1E4E8"}}," extends Callable"),t("span",{style:{color:"#F97583"}},"<"),t("span",{style:{color:"#E1E4E8"}},"T"),t("span",{style:{color:"#F97583"}},">>"),t("span",{style:{color:"#E1E4E8"}}," tasks)")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"throws InterruptedException;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// 提交 tasks 中所有任务，带超时时间")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"<"),t("span",{style:{color:"#E1E4E8"}},"T"),t("span",{style:{color:"#F97583"}},">"),t("span",{style:{color:"#E1E4E8"}}," List"),t("span",{style:{color:"#F97583"}},"<"),t("span",{style:{color:"#E1E4E8"}},"Future"),t("span",{style:{color:"#F97583"}},"<"),t("span",{style:{color:"#E1E4E8"}},"T"),t("span",{style:{color:"#F97583"}},">>"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"invokeAll"),t("span",{style:{color:"#E1E4E8"}},"(Collection"),t("span",{style:{color:"#F97583"}},"<?"),t("span",{style:{color:"#E1E4E8"}}," extends Callable"),t("span",{style:{color:"#F97583"}},"<"),t("span",{style:{color:"#E1E4E8"}},"T"),t("span",{style:{color:"#F97583"}},">>"),t("span",{style:{color:"#E1E4E8"}}," tasks,")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"long"),t("span",{style:{color:"#E1E4E8"}}," timeout, TimeUnit unit)")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"throws InterruptedException;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// 提交 tasks 中所有任务，哪个任务先成功执行完毕，返回此任务执行结果，其它任务取消")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"<"),t("span",{style:{color:"#E1E4E8"}},"T"),t("span",{style:{color:"#F97583"}},">"),t("span",{style:{color:"#E1E4E8"}}," T "),t("span",{style:{color:"#B392F0"}},"invokeAny"),t("span",{style:{color:"#E1E4E8"}},"(Collection"),t("span",{style:{color:"#F97583"}},"<?"),t("span",{style:{color:"#E1E4E8"}}," extends Callable"),t("span",{style:{color:"#F97583"}},"<"),t("span",{style:{color:"#E1E4E8"}},"T"),t("span",{style:{color:"#F97583"}},">>"),t("span",{style:{color:"#E1E4E8"}}," tasks)")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"throws InterruptedException, ExecutionException;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// 提交 tasks 中所有任务，哪个任务先成功执行完毕，返回此任务执行结果，其它任务取消，带超时时间")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"<"),t("span",{style:{color:"#E1E4E8"}},"T"),t("span",{style:{color:"#F97583"}},">"),t("span",{style:{color:"#E1E4E8"}}," T "),t("span",{style:{color:"#B392F0"}},"invokeAny"),t("span",{style:{color:"#E1E4E8"}},"(Collection"),t("span",{style:{color:"#F97583"}},"<?"),t("span",{style:{color:"#E1E4E8"}}," extends Callable"),t("span",{style:{color:"#F97583"}},"<"),t("span",{style:{color:"#E1E4E8"}},"T"),t("span",{style:{color:"#F97583"}},">>"),t("span",{style:{color:"#E1E4E8"}}," tasks,")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"long"),t("span",{style:{color:"#E1E4E8"}}," timeout, TimeUnit unit)")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"throws InterruptedException, ExecutionException, TimeoutException;")])])]),t("pre",{class:"shiki github-light vp-code-light"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// 执行任务")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"void"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"execute"),t("span",{style:{color:"#24292E"}},"(Runnable command);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// 提交任务 task，用返回值 Future 获得任务执行结果")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"<"),t("span",{style:{color:"#24292E"}},"T"),t("span",{style:{color:"#D73A49"}},">"),t("span",{style:{color:"#24292E"}}," Future"),t("span",{style:{color:"#D73A49"}},"<"),t("span",{style:{color:"#24292E"}},"T"),t("span",{style:{color:"#D73A49"}},">"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"submit"),t("span",{style:{color:"#24292E"}},"(Callable"),t("span",{style:{color:"#D73A49"}},"<"),t("span",{style:{color:"#24292E"}},"T"),t("span",{style:{color:"#D73A49"}},">"),t("span",{style:{color:"#24292E"}}," task);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// 提交 tasks 中所有任务")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"<"),t("span",{style:{color:"#24292E"}},"T"),t("span",{style:{color:"#D73A49"}},">"),t("span",{style:{color:"#24292E"}}," List"),t("span",{style:{color:"#D73A49"}},"<"),t("span",{style:{color:"#24292E"}},"Future"),t("span",{style:{color:"#D73A49"}},"<"),t("span",{style:{color:"#24292E"}},"T"),t("span",{style:{color:"#D73A49"}},">>"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"invokeAll"),t("span",{style:{color:"#24292E"}},"(Collection"),t("span",{style:{color:"#D73A49"}},"<?"),t("span",{style:{color:"#24292E"}}," extends Callable"),t("span",{style:{color:"#D73A49"}},"<"),t("span",{style:{color:"#24292E"}},"T"),t("span",{style:{color:"#D73A49"}},">>"),t("span",{style:{color:"#24292E"}}," tasks)")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"throws InterruptedException;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// 提交 tasks 中所有任务，带超时时间")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"<"),t("span",{style:{color:"#24292E"}},"T"),t("span",{style:{color:"#D73A49"}},">"),t("span",{style:{color:"#24292E"}}," List"),t("span",{style:{color:"#D73A49"}},"<"),t("span",{style:{color:"#24292E"}},"Future"),t("span",{style:{color:"#D73A49"}},"<"),t("span",{style:{color:"#24292E"}},"T"),t("span",{style:{color:"#D73A49"}},">>"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"invokeAll"),t("span",{style:{color:"#24292E"}},"(Collection"),t("span",{style:{color:"#D73A49"}},"<?"),t("span",{style:{color:"#24292E"}}," extends Callable"),t("span",{style:{color:"#D73A49"}},"<"),t("span",{style:{color:"#24292E"}},"T"),t("span",{style:{color:"#D73A49"}},">>"),t("span",{style:{color:"#24292E"}}," tasks,")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"long"),t("span",{style:{color:"#24292E"}}," timeout, TimeUnit unit)")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"throws InterruptedException;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// 提交 tasks 中所有任务，哪个任务先成功执行完毕，返回此任务执行结果，其它任务取消")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"<"),t("span",{style:{color:"#24292E"}},"T"),t("span",{style:{color:"#D73A49"}},">"),t("span",{style:{color:"#24292E"}}," T "),t("span",{style:{color:"#6F42C1"}},"invokeAny"),t("span",{style:{color:"#24292E"}},"(Collection"),t("span",{style:{color:"#D73A49"}},"<?"),t("span",{style:{color:"#24292E"}}," extends Callable"),t("span",{style:{color:"#D73A49"}},"<"),t("span",{style:{color:"#24292E"}},"T"),t("span",{style:{color:"#D73A49"}},">>"),t("span",{style:{color:"#24292E"}}," tasks)")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"throws InterruptedException, ExecutionException;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// 提交 tasks 中所有任务，哪个任务先成功执行完毕，返回此任务执行结果，其它任务取消，带超时时间")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"<"),t("span",{style:{color:"#24292E"}},"T"),t("span",{style:{color:"#D73A49"}},">"),t("span",{style:{color:"#24292E"}}," T "),t("span",{style:{color:"#6F42C1"}},"invokeAny"),t("span",{style:{color:"#24292E"}},"(Collection"),t("span",{style:{color:"#D73A49"}},"<?"),t("span",{style:{color:"#24292E"}}," extends Callable"),t("span",{style:{color:"#D73A49"}},"<"),t("span",{style:{color:"#24292E"}},"T"),t("span",{style:{color:"#D73A49"}},">>"),t("span",{style:{color:"#24292E"}}," tasks,")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"long"),t("span",{style:{color:"#24292E"}}," timeout, TimeUnit unit)")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"throws InterruptedException, ExecutionException, TimeoutException;")])])])],-1),Ks={id:"submit-方法",tabindex:"-1"},Vs=t("div",{class:"language-java"},[t("button",{title:"Copy Code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki github-dark vp-code-dark"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"Future"),t("span",{style:{color:"#F97583"}},"<"),t("span",{style:{color:"#E1E4E8"}},"T"),t("span",{style:{color:"#F97583"}},">"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"submit"),t("span",{style:{color:"#E1E4E8"}},"(Callable"),t("span",{style:{color:"#F97583"}},"<"),t("span",{style:{color:"#E1E4E8"}},"T"),t("span",{style:{color:"#F97583"}},">"),t("span",{style:{color:"#E1E4E8"}}," task)")])])]),t("pre",{class:"shiki github-light vp-code-light"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"Future"),t("span",{style:{color:"#D73A49"}},"<"),t("span",{style:{color:"#24292E"}},"T"),t("span",{style:{color:"#D73A49"}},">"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"submit"),t("span",{style:{color:"#24292E"}},"(Callable"),t("span",{style:{color:"#D73A49"}},"<"),t("span",{style:{color:"#24292E"}},"T"),t("span",{style:{color:"#D73A49"}},">"),t("span",{style:{color:"#24292E"}}," task)")])])])],-1),Ms=t("p",null,[p("传入一个Callable对象，用Future来"),t("strong",null,"捕获返回值")],-1),Ws=t("p",null,[t("strong",null,"使用")],-1),Us=t("div",{class:"language-java"},[t("button",{title:"Copy Code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki github-dark vp-code-dark"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// 通过submit执行Callable中的call方法")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// 通过Future来捕获返回值")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"Future<"),t("span",{style:{color:"#F97583"}},"String"),t("span",{style:{color:"#E1E4E8"}},"> future "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," threadPool."),t("span",{style:{color:"#B392F0"}},"submit"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#F97583"}},"new"),t("span",{style:{color:"#E1E4E8"}}," Callable<"),t("span",{style:{color:"#F97583"}},"String"),t("span",{style:{color:"#E1E4E8"}},">() {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"   @"),t("span",{style:{color:"#F97583"}},"Override")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"   "),t("span",{style:{color:"#F97583"}},"public"),t("span",{style:{color:"#E1E4E8"}}," String "),t("span",{style:{color:"#B392F0"}},"call"),t("span",{style:{color:"#E1E4E8"}},"() "),t("span",{style:{color:"#F97583"}},"throws"),t("span",{style:{color:"#E1E4E8"}}," Exception {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"      "),t("span",{style:{color:"#F97583"}},"return"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#9ECBFF"}},'"hello submit"'),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"   }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"});")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// 查看捕获的返回值")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"System.out."),t("span",{style:{color:"#B392F0"}},"println"),t("span",{style:{color:"#E1E4E8"}},"(future."),t("span",{style:{color:"#B392F0"}},"get"),t("span",{style:{color:"#E1E4E8"}},"());")])])]),t("pre",{class:"shiki github-light vp-code-light"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// 通过submit执行Callable中的call方法")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// 通过Future来捕获返回值")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"Future<"),t("span",{style:{color:"#D73A49"}},"String"),t("span",{style:{color:"#24292E"}},"> future "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," threadPool."),t("span",{style:{color:"#6F42C1"}},"submit"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#D73A49"}},"new"),t("span",{style:{color:"#24292E"}}," Callable<"),t("span",{style:{color:"#D73A49"}},"String"),t("span",{style:{color:"#24292E"}},">() {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"   @"),t("span",{style:{color:"#D73A49"}},"Override")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"   "),t("span",{style:{color:"#D73A49"}},"public"),t("span",{style:{color:"#24292E"}}," String "),t("span",{style:{color:"#6F42C1"}},"call"),t("span",{style:{color:"#24292E"}},"() "),t("span",{style:{color:"#D73A49"}},"throws"),t("span",{style:{color:"#24292E"}}," Exception {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"      "),t("span",{style:{color:"#D73A49"}},"return"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#032F62"}},'"hello submit"'),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"   }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"});")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// 查看捕获的返回值")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"System.out."),t("span",{style:{color:"#6F42C1"}},"println"),t("span",{style:{color:"#24292E"}},"(future."),t("span",{style:{color:"#6F42C1"}},"get"),t("span",{style:{color:"#24292E"}},"());")])])])],-1),Qs={id:"invokeall方法",tabindex:"-1"},Hs=t("div",{class:"language-java"},[t("button",{title:"Copy Code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki github-dark vp-code-dark"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"ExecutorService pool "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," Executors."),t("span",{style:{color:"#B392F0"}},"newFixedThreadPool"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#79B8FF"}},"3"),t("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"List<Future<"),t("span",{style:{color:"#F97583"}},"String"),t("span",{style:{color:"#E1E4E8"}},">> futures "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," pool."),t("span",{style:{color:"#B392F0"}},"invokeAll"),t("span",{style:{color:"#E1E4E8"}},"(Arrays."),t("span",{style:{color:"#B392F0"}},"asList"),t("span",{style:{color:"#E1E4E8"}},"(")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                () "),t("span",{style:{color:"#F97583"}},"->"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                    log."),t("span",{style:{color:"#B392F0"}},"debug"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#9ECBFF"}},'"begin"'),t("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                    Thread."),t("span",{style:{color:"#B392F0"}},"sleep"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#79B8FF"}},"1000"),t("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                    "),t("span",{style:{color:"#F97583"}},"return"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#9ECBFF"}},'"1"'),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                },")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                () "),t("span",{style:{color:"#F97583"}},"->"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                    log."),t("span",{style:{color:"#B392F0"}},"debug"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#9ECBFF"}},'"begin"'),t("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                    Thread."),t("span",{style:{color:"#B392F0"}},"sleep"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#79B8FF"}},"500"),t("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                    "),t("span",{style:{color:"#F97583"}},"return"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#9ECBFF"}},'"2"'),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                },")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                () "),t("span",{style:{color:"#F97583"}},"->"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                    log."),t("span",{style:{color:"#B392F0"}},"debug"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#9ECBFF"}},'"begin"'),t("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                    Thread."),t("span",{style:{color:"#B392F0"}},"sleep"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#79B8FF"}},"2000"),t("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                    "),t("span",{style:{color:"#F97583"}},"return"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#9ECBFF"}},'"3"'),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        ));")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        futures."),t("span",{style:{color:"#B392F0"}},"forEach"),t("span",{style:{color:"#E1E4E8"}},"( f "),t("span",{style:{color:"#F97583"}},"->"),t("span",{style:{color:"#E1E4E8"}},"  {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"try"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                log."),t("span",{style:{color:"#B392F0"}},"debug"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#9ECBFF"}},'"{}"'),t("span",{style:{color:"#E1E4E8"}},", f."),t("span",{style:{color:"#B392F0"}},"get"),t("span",{style:{color:"#E1E4E8"}},"());")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            } "),t("span",{style:{color:"#F97583"}},"catch"),t("span",{style:{color:"#E1E4E8"}}," (InterruptedException | ExecutionException "),t("span",{style:{color:"#FFAB70"}},"e"),t("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                e."),t("span",{style:{color:"#B392F0"}},"printStackTrace"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        });")])])]),t("pre",{class:"shiki github-light vp-code-light"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"ExecutorService pool "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," Executors."),t("span",{style:{color:"#6F42C1"}},"newFixedThreadPool"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#005CC5"}},"3"),t("span",{style:{color:"#24292E"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"List<Future<"),t("span",{style:{color:"#D73A49"}},"String"),t("span",{style:{color:"#24292E"}},">> futures "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," pool."),t("span",{style:{color:"#6F42C1"}},"invokeAll"),t("span",{style:{color:"#24292E"}},"(Arrays."),t("span",{style:{color:"#6F42C1"}},"asList"),t("span",{style:{color:"#24292E"}},"(")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                () "),t("span",{style:{color:"#D73A49"}},"->"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                    log."),t("span",{style:{color:"#6F42C1"}},"debug"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#032F62"}},'"begin"'),t("span",{style:{color:"#24292E"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                    Thread."),t("span",{style:{color:"#6F42C1"}},"sleep"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#005CC5"}},"1000"),t("span",{style:{color:"#24292E"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                    "),t("span",{style:{color:"#D73A49"}},"return"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#032F62"}},'"1"'),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                },")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                () "),t("span",{style:{color:"#D73A49"}},"->"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                    log."),t("span",{style:{color:"#6F42C1"}},"debug"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#032F62"}},'"begin"'),t("span",{style:{color:"#24292E"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                    Thread."),t("span",{style:{color:"#6F42C1"}},"sleep"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#005CC5"}},"500"),t("span",{style:{color:"#24292E"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                    "),t("span",{style:{color:"#D73A49"}},"return"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#032F62"}},'"2"'),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                },")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                () "),t("span",{style:{color:"#D73A49"}},"->"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                    log."),t("span",{style:{color:"#6F42C1"}},"debug"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#032F62"}},'"begin"'),t("span",{style:{color:"#24292E"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                    Thread."),t("span",{style:{color:"#6F42C1"}},"sleep"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#005CC5"}},"2000"),t("span",{style:{color:"#24292E"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                    "),t("span",{style:{color:"#D73A49"}},"return"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#032F62"}},'"3"'),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        ));")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        futures."),t("span",{style:{color:"#6F42C1"}},"forEach"),t("span",{style:{color:"#24292E"}},"( f "),t("span",{style:{color:"#D73A49"}},"->"),t("span",{style:{color:"#24292E"}},"  {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"try"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                log."),t("span",{style:{color:"#6F42C1"}},"debug"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#032F62"}},'"{}"'),t("span",{style:{color:"#24292E"}},", f."),t("span",{style:{color:"#6F42C1"}},"get"),t("span",{style:{color:"#24292E"}},"());")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            } "),t("span",{style:{color:"#D73A49"}},"catch"),t("span",{style:{color:"#24292E"}}," (InterruptedException | ExecutionException "),t("span",{style:{color:"#E36209"}},"e"),t("span",{style:{color:"#24292E"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                e."),t("span",{style:{color:"#6F42C1"}},"printStackTrace"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        });")])])])],-1),Gs={id:"停止",tabindex:"-1"},Js={id:"shutdown",tabindex:"-1"},Ys=t("div",{class:"language-java"},[t("button",{title:"Copy Code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki github-dark vp-code-dark"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"/**")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"* 将线程池的状态改为 SHUTDOWN")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"* 不再接受新任务，但是会将阻塞队列中的任务执行完")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"*/")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"public"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"void"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"shutdown"),t("span",{style:{color:"#E1E4E8"}},"() {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"final"),t("span",{style:{color:"#E1E4E8"}}," ReentrantLock mainLock "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"this"),t("span",{style:{color:"#E1E4E8"}},".mainLock;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    mainLock."),t("span",{style:{color:"#B392F0"}},"lock"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"try"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#B392F0"}},"checkShutdownAccess"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#6A737D"}},"// 修改线程池状态为 SHUTDOWN")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#B392F0"}},"advanceRunState"),t("span",{style:{color:"#E1E4E8"}},"(SHUTDOWN);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"  \t\t"),t("span",{style:{color:"#6A737D"}},"// 中断空闲线程（没有执行任务的线程）")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#6A737D"}},"// Idle：空闲的")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#B392F0"}},"interruptIdleWorkers"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#B392F0"}},"onShutdown"),t("span",{style:{color:"#E1E4E8"}},"(); "),t("span",{style:{color:"#6A737D"}},"// hook for ScheduledThreadPoolExecutor")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    } "),t("span",{style:{color:"#F97583"}},"finally"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        mainLock."),t("span",{style:{color:"#B392F0"}},"unlock"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// 尝试终结，不一定成功")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#B392F0"}},"tryTerminate"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"}")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"final"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"void"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"tryTerminate"),t("span",{style:{color:"#E1E4E8"}},"() {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"for"),t("span",{style:{color:"#E1E4E8"}}," (;;) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," c "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," ctl."),t("span",{style:{color:"#B392F0"}},"get"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#6A737D"}},"// 终结失败的条件")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#6A737D"}},"// 线程池状态为RUNNING")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#6A737D"}},"// 线程池状态为 RUNNING SHUTDOWN STOP （状态值大于TIDYING）")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#6A737D"}},"// 线程池状态为SHUTDOWN，但阻塞队列中还有任务等待执行")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," ("),t("span",{style:{color:"#B392F0"}},"isRunning"),t("span",{style:{color:"#E1E4E8"}},"(c) "),t("span",{style:{color:"#F97583"}},"||")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#B392F0"}},"runStateAtLeast"),t("span",{style:{color:"#E1E4E8"}},"(c, TIDYING) "),t("span",{style:{color:"#F97583"}},"||")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            ("),t("span",{style:{color:"#B392F0"}},"runStateOf"),t("span",{style:{color:"#E1E4E8"}},"(c) "),t("span",{style:{color:"#F97583"}},"=="),t("span",{style:{color:"#E1E4E8"}}," SHUTDOWN "),t("span",{style:{color:"#F97583"}},"&&"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"!"),t("span",{style:{color:"#E1E4E8"}}," workQueue."),t("span",{style:{color:"#B392F0"}},"isEmpty"),t("span",{style:{color:"#E1E4E8"}},"()))")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"return"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#6A737D"}},"// 如果活跃线程数不为0")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," ("),t("span",{style:{color:"#B392F0"}},"workerCountOf"),t("span",{style:{color:"#E1E4E8"}},"(c) "),t("span",{style:{color:"#F97583"}},"!="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"0"),t("span",{style:{color:"#E1E4E8"}},") { "),t("span",{style:{color:"#6A737D"}},"// Eligible to terminate")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#6A737D"}},"// 中断空闲线程")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#B392F0"}},"interruptIdleWorkers"),t("span",{style:{color:"#E1E4E8"}},"(ONLY_ONE);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"return"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        }")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"final"),t("span",{style:{color:"#E1E4E8"}}," ReentrantLock mainLock "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"this"),t("span",{style:{color:"#E1E4E8"}},".mainLock;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        mainLock."),t("span",{style:{color:"#B392F0"}},"lock"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"try"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#6A737D"}},"// 处于可以终结的状态")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#6A737D"}},"// 通过CAS将线程池状态改为TIDYING")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (ctl."),t("span",{style:{color:"#B392F0"}},"compareAndSet"),t("span",{style:{color:"#E1E4E8"}},"(c, "),t("span",{style:{color:"#B392F0"}},"ctlOf"),t("span",{style:{color:"#E1E4E8"}},"(TIDYING, "),t("span",{style:{color:"#79B8FF"}},"0"),t("span",{style:{color:"#E1E4E8"}},"))) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#F97583"}},"try"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                    "),t("span",{style:{color:"#B392F0"}},"terminated"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                } "),t("span",{style:{color:"#F97583"}},"finally"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                    "),t("span",{style:{color:"#6A737D"}},"// 通过CAS将线程池状态改为TERMINATED")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                    ctl."),t("span",{style:{color:"#B392F0"}},"set"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#B392F0"}},"ctlOf"),t("span",{style:{color:"#E1E4E8"}},"(TERMINATED, "),t("span",{style:{color:"#79B8FF"}},"0"),t("span",{style:{color:"#E1E4E8"}},"));")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                    termination."),t("span",{style:{color:"#B392F0"}},"signalAll"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#F97583"}},"return"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        } "),t("span",{style:{color:"#F97583"}},"finally"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            mainLock."),t("span",{style:{color:"#B392F0"}},"unlock"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#6A737D"}},"// else retry on failed CAS")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"}")])])]),t("pre",{class:"shiki github-light vp-code-light"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"/**")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"* 将线程池的状态改为 SHUTDOWN")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"* 不再接受新任务，但是会将阻塞队列中的任务执行完")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"*/")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"public"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"void"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"shutdown"),t("span",{style:{color:"#24292E"}},"() {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"final"),t("span",{style:{color:"#24292E"}}," ReentrantLock mainLock "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"this"),t("span",{style:{color:"#24292E"}},".mainLock;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    mainLock."),t("span",{style:{color:"#6F42C1"}},"lock"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"try"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6F42C1"}},"checkShutdownAccess"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6A737D"}},"// 修改线程池状态为 SHUTDOWN")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6F42C1"}},"advanceRunState"),t("span",{style:{color:"#24292E"}},"(SHUTDOWN);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"  \t\t"),t("span",{style:{color:"#6A737D"}},"// 中断空闲线程（没有执行任务的线程）")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6A737D"}},"// Idle：空闲的")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6F42C1"}},"interruptIdleWorkers"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6F42C1"}},"onShutdown"),t("span",{style:{color:"#24292E"}},"(); "),t("span",{style:{color:"#6A737D"}},"// hook for ScheduledThreadPoolExecutor")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    } "),t("span",{style:{color:"#D73A49"}},"finally"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        mainLock."),t("span",{style:{color:"#6F42C1"}},"unlock"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// 尝试终结，不一定成功")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6F42C1"}},"tryTerminate"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"}")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"final"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"void"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"tryTerminate"),t("span",{style:{color:"#24292E"}},"() {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"for"),t("span",{style:{color:"#24292E"}}," (;;) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," c "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," ctl."),t("span",{style:{color:"#6F42C1"}},"get"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6A737D"}},"// 终结失败的条件")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6A737D"}},"// 线程池状态为RUNNING")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6A737D"}},"// 线程池状态为 RUNNING SHUTDOWN STOP （状态值大于TIDYING）")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6A737D"}},"// 线程池状态为SHUTDOWN，但阻塞队列中还有任务等待执行")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," ("),t("span",{style:{color:"#6F42C1"}},"isRunning"),t("span",{style:{color:"#24292E"}},"(c) "),t("span",{style:{color:"#D73A49"}},"||")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#6F42C1"}},"runStateAtLeast"),t("span",{style:{color:"#24292E"}},"(c, TIDYING) "),t("span",{style:{color:"#D73A49"}},"||")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            ("),t("span",{style:{color:"#6F42C1"}},"runStateOf"),t("span",{style:{color:"#24292E"}},"(c) "),t("span",{style:{color:"#D73A49"}},"=="),t("span",{style:{color:"#24292E"}}," SHUTDOWN "),t("span",{style:{color:"#D73A49"}},"&&"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"!"),t("span",{style:{color:"#24292E"}}," workQueue."),t("span",{style:{color:"#6F42C1"}},"isEmpty"),t("span",{style:{color:"#24292E"}},"()))")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"return"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6A737D"}},"// 如果活跃线程数不为0")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," ("),t("span",{style:{color:"#6F42C1"}},"workerCountOf"),t("span",{style:{color:"#24292E"}},"(c) "),t("span",{style:{color:"#D73A49"}},"!="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"0"),t("span",{style:{color:"#24292E"}},") { "),t("span",{style:{color:"#6A737D"}},"// Eligible to terminate")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#6A737D"}},"// 中断空闲线程")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#6F42C1"}},"interruptIdleWorkers"),t("span",{style:{color:"#24292E"}},"(ONLY_ONE);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"return"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        }")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"final"),t("span",{style:{color:"#24292E"}}," ReentrantLock mainLock "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"this"),t("span",{style:{color:"#24292E"}},".mainLock;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        mainLock."),t("span",{style:{color:"#6F42C1"}},"lock"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"try"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#6A737D"}},"// 处于可以终结的状态")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#6A737D"}},"// 通过CAS将线程池状态改为TIDYING")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (ctl."),t("span",{style:{color:"#6F42C1"}},"compareAndSet"),t("span",{style:{color:"#24292E"}},"(c, "),t("span",{style:{color:"#6F42C1"}},"ctlOf"),t("span",{style:{color:"#24292E"}},"(TIDYING, "),t("span",{style:{color:"#005CC5"}},"0"),t("span",{style:{color:"#24292E"}},"))) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#D73A49"}},"try"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                    "),t("span",{style:{color:"#6F42C1"}},"terminated"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                } "),t("span",{style:{color:"#D73A49"}},"finally"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                    "),t("span",{style:{color:"#6A737D"}},"// 通过CAS将线程池状态改为TERMINATED")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                    ctl."),t("span",{style:{color:"#6F42C1"}},"set"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#6F42C1"}},"ctlOf"),t("span",{style:{color:"#24292E"}},"(TERMINATED, "),t("span",{style:{color:"#005CC5"}},"0"),t("span",{style:{color:"#24292E"}},"));")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                    termination."),t("span",{style:{color:"#6F42C1"}},"signalAll"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#D73A49"}},"return"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        } "),t("span",{style:{color:"#D73A49"}},"finally"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            mainLock."),t("span",{style:{color:"#6F42C1"}},"unlock"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6A737D"}},"// else retry on failed CAS")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"}")])])])],-1),Xs={id:"shutdownnow",tabindex:"-1"},Zs=t("div",{class:"language-java"},[t("button",{title:"Copy Code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki github-dark vp-code-dark"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"/**")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"* 将线程池的状态改为 STOP")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"* 不再接受新任务，也不会在执行阻塞队列中的任务")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"* 会将阻塞队列中未执行的任务返回给调用者")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"*/")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"public"),t("span",{style:{color:"#E1E4E8"}}," List"),t("span",{style:{color:"#F97583"}},"<"),t("span",{style:{color:"#E1E4E8"}},"Runnable"),t("span",{style:{color:"#F97583"}},">"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"shutdownNow"),t("span",{style:{color:"#E1E4E8"}},"() {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    List<"),t("span",{style:{color:"#F97583"}},"Runnable"),t("span",{style:{color:"#E1E4E8"}},"> tasks;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"final"),t("span",{style:{color:"#E1E4E8"}}," ReentrantLock mainLock "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"this"),t("span",{style:{color:"#E1E4E8"}},".mainLock;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    mainLock."),t("span",{style:{color:"#B392F0"}},"lock"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"try"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#B392F0"}},"checkShutdownAccess"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#6A737D"}},"// 修改状态为STOP，不执行任何任务")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#B392F0"}},"advanceRunState"),t("span",{style:{color:"#E1E4E8"}},"(STOP);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#6A737D"}},"// 中断所有线程")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#B392F0"}},"interruptWorkers"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#6A737D"}},"// 将未执行的任务从队列中移除，然后返回给调用者")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        tasks "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"drainQueue"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    } "),t("span",{style:{color:"#F97583"}},"finally"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        mainLock."),t("span",{style:{color:"#B392F0"}},"unlock"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// 尝试终结，一定会成功，因为阻塞队列为空了")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#B392F0"}},"tryTerminate"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"return"),t("span",{style:{color:"#E1E4E8"}}," tasks;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"}")])])]),t("pre",{class:"shiki github-light vp-code-light"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"/**")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"* 将线程池的状态改为 STOP")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"* 不再接受新任务，也不会在执行阻塞队列中的任务")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"* 会将阻塞队列中未执行的任务返回给调用者")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"*/")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"public"),t("span",{style:{color:"#24292E"}}," List"),t("span",{style:{color:"#D73A49"}},"<"),t("span",{style:{color:"#24292E"}},"Runnable"),t("span",{style:{color:"#D73A49"}},">"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"shutdownNow"),t("span",{style:{color:"#24292E"}},"() {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    List<"),t("span",{style:{color:"#D73A49"}},"Runnable"),t("span",{style:{color:"#24292E"}},"> tasks;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"final"),t("span",{style:{color:"#24292E"}}," ReentrantLock mainLock "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"this"),t("span",{style:{color:"#24292E"}},".mainLock;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    mainLock."),t("span",{style:{color:"#6F42C1"}},"lock"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"try"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6F42C1"}},"checkShutdownAccess"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6A737D"}},"// 修改状态为STOP，不执行任何任务")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6F42C1"}},"advanceRunState"),t("span",{style:{color:"#24292E"}},"(STOP);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6A737D"}},"// 中断所有线程")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6F42C1"}},"interruptWorkers"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6A737D"}},"// 将未执行的任务从队列中移除，然后返回给调用者")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        tasks "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"drainQueue"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    } "),t("span",{style:{color:"#D73A49"}},"finally"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        mainLock."),t("span",{style:{color:"#6F42C1"}},"unlock"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// 尝试终结，一定会成功，因为阻塞队列为空了")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6F42C1"}},"tryTerminate"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"return"),t("span",{style:{color:"#24292E"}}," tasks;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"}")])])])],-1),$s={id:"其它方法",tabindex:"-1"},sl=t("div",{class:"language-java"},[t("button",{title:"Copy Code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki github-dark vp-code-dark"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// 不在 RUNNING 状态的线程池，此方法就返回 true")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"boolean"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"isShutdown"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// 线程池状态是否是 TERMINATED")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"boolean"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"isTerminated"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// 调用 shutdown 后，由于调用线程并不会等待所有任务运行结束，因此如果它想在线程池 TERMINATED 后做些事")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"情，可以利用此方法等待")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"boolean"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"awaitTermination"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#F97583"}},"long"),t("span",{style:{color:"#E1E4E8"}}," timeout, TimeUnit unit) throws InterruptedException;")])])]),t("pre",{class:"shiki github-light vp-code-light"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// 不在 RUNNING 状态的线程池，此方法就返回 true")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"boolean"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"isShutdown"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// 线程池状态是否是 TERMINATED")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"boolean"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"isTerminated"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// 调用 shutdown 后，由于调用线程并不会等待所有任务运行结束，因此如果它想在线程池 TERMINATED 后做些事")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"情，可以利用此方法等待")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"boolean"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"awaitTermination"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#D73A49"}},"long"),t("span",{style:{color:"#24292E"}}," timeout, TimeUnit unit) throws InterruptedException;")])])])],-1),ll={id:"异步模式之工作线程",tabindex:"-1"},ol={id:"定义",tabindex:"-1"},nl=t("p",null,"让有限的工作线程（Worker Thread）来轮流异步处理无限多的任务。也可以将其归类为分工模式，它的典型实现 就是线程池，也体现了经典设计模式中的享元模式。",-1),al=t("p",null,"例如，海底捞的服务员（线程），轮流处理每位客人的点餐（任务），如果为每位客人都配一名专属的服务员，那 么成本就太高了（对比另一种多线程设计模式：Thread-Per-Message） 注意，不同任务类型应该使用不同的线程池，这样能够避免饥饿，并能提升效率 例如，如果一个餐馆的工人既要招呼客人（任务类型A），又要到后厨做菜（任务类型B）显然效率不咋地，分成 服务员（线程池A）与厨师（线程池B）更为合理，当然你能想到更细致的分工",-1),el={id:"饥饿",tabindex:"-1"},cl=t("p",null,"固定大小线程池会有饥饿现象",-1),tl=t("ul",null,[t("li",null,"两个工人是同一个线程池中的两个线程"),t("li",null,[p("他们要做的事情是：为客人点餐和到后厨做菜，这是两个阶段的工作 "),t("ul",null,[t("li",null,"客人点餐：必须先点完餐，等菜做好，上菜，在此期间处理点餐的工人必须等待"),t("li",null,"后厨做菜：没啥说的，做就是了")])]),t("li",null,"比如工人A 处理了点餐任务，接下来它要等着 工人B 把菜做好，然后上菜，他俩也配合的蛮好"),t("li",null,"但现在同时来了两个客人，这个时候工人A 和工人B 都去处理点餐了，这时没人做饭了，饥饿")],-1),pl={id:"任务调度线程池",tabindex:"-1"},rl=t("p",null,"在『任务调度线程池』功能加入之前，可以使用 java.util.Timer 来实现定时功能，Timer 的优点在于简单易用，但 由于所有任务都是由同一个线程来调度，因此所有任务都是串行执行的，同一时间只能有一个任务在执行，前一个 任务的延迟或异常都将会影响到之后的任务。",-1),El=t("div",{class:"language-java"},[t("button",{title:"Copy Code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki github-dark vp-code-dark"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"public"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"static"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"void"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"main"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#F97583"}},"String"),t("span",{style:{color:"#E1E4E8"}},"[] args) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    Timer timer "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"new"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"Timer"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    TimerTask task1 "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"new"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"TimerTask"),t("span",{style:{color:"#E1E4E8"}},"() {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        @"),t("span",{style:{color:"#F97583"}},"Override")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"public"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"void"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"run"),t("span",{style:{color:"#E1E4E8"}},"() {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            log."),t("span",{style:{color:"#B392F0"}},"debug"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#9ECBFF"}},'"task 1"'),t("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#B392F0"}},"sleep"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#79B8FF"}},"2"),t("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    };")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    TimerTask task2 "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"new"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"TimerTask"),t("span",{style:{color:"#E1E4E8"}},"() {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        @"),t("span",{style:{color:"#F97583"}},"Override")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"public"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"void"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"run"),t("span",{style:{color:"#E1E4E8"}},"() {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        \tlog."),t("span",{style:{color:"#B392F0"}},"debug"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#9ECBFF"}},'"task 2"'),t("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    };")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// 使用 timer 添加两个任务，希望它们都在 1s 后执行")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// 但由于 timer 内只有一个线程来顺序执行队列中的任务，因此『任务1』的延时，影响了『任务2』的执行")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    timer."),t("span",{style:{color:"#B392F0"}},"schedule"),t("span",{style:{color:"#E1E4E8"}},"(task1, "),t("span",{style:{color:"#79B8FF"}},"1000"),t("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    timer."),t("span",{style:{color:"#B392F0"}},"schedule"),t("span",{style:{color:"#E1E4E8"}},"(task2, "),t("span",{style:{color:"#79B8FF"}},"1000"),t("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"}")])])]),t("pre",{class:"shiki github-light vp-code-light"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"public"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"static"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"void"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"main"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#D73A49"}},"String"),t("span",{style:{color:"#24292E"}},"[] args) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    Timer timer "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"new"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"Timer"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    TimerTask task1 "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"new"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"TimerTask"),t("span",{style:{color:"#24292E"}},"() {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        @"),t("span",{style:{color:"#D73A49"}},"Override")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"public"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"void"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"run"),t("span",{style:{color:"#24292E"}},"() {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            log."),t("span",{style:{color:"#6F42C1"}},"debug"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#032F62"}},'"task 1"'),t("span",{style:{color:"#24292E"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#6F42C1"}},"sleep"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#005CC5"}},"2"),t("span",{style:{color:"#24292E"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    };")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    TimerTask task2 "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"new"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"TimerTask"),t("span",{style:{color:"#24292E"}},"() {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        @"),t("span",{style:{color:"#D73A49"}},"Override")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"public"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"void"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"run"),t("span",{style:{color:"#24292E"}},"() {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        \tlog."),t("span",{style:{color:"#6F42C1"}},"debug"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#032F62"}},'"task 2"'),t("span",{style:{color:"#24292E"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    };")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// 使用 timer 添加两个任务，希望它们都在 1s 后执行")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// 但由于 timer 内只有一个线程来顺序执行队列中的任务，因此『任务1』的延时，影响了『任务2』的执行")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    timer."),t("span",{style:{color:"#6F42C1"}},"schedule"),t("span",{style:{color:"#24292E"}},"(task1, "),t("span",{style:{color:"#005CC5"}},"1000"),t("span",{style:{color:"#24292E"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    timer."),t("span",{style:{color:"#6F42C1"}},"schedule"),t("span",{style:{color:"#24292E"}},"(task2, "),t("span",{style:{color:"#005CC5"}},"1000"),t("span",{style:{color:"#24292E"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"}")])])])],-1),yl=t("figure",null,[t("img",{src:"https://jsd.cdn.zzko.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230719143233884.png",alt:"image-20230719143233884",loading:"lazy",decoding:"async"})],-1),il=t("p",null,"使用 ScheduledExecutorService 改写：",-1),Fl=t("div",{class:"language-java"},[t("button",{title:"Copy Code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki github-dark vp-code-dark"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"ScheduledExecutorService executor "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," Executors."),t("span",{style:{color:"#B392F0"}},"newScheduledThreadPool"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#79B8FF"}},"2"),t("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// 添加两个任务，希望它们都在 1s 后执行")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"executor."),t("span",{style:{color:"#B392F0"}},"schedule"),t("span",{style:{color:"#E1E4E8"}},"(() "),t("span",{style:{color:"#F97583"}},"->"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"System.out."),t("span",{style:{color:"#B392F0"}},"println"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#9ECBFF"}},'"任务1，执行时间："'),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"+"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"new"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"Date"),t("span",{style:{color:"#E1E4E8"}},"());")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"try"),t("span",{style:{color:"#E1E4E8"}}," { Thread."),t("span",{style:{color:"#B392F0"}},"sleep"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#79B8FF"}},"2000"),t("span",{style:{color:"#E1E4E8"}},"); } "),t("span",{style:{color:"#F97583"}},"catch"),t("span",{style:{color:"#E1E4E8"}}," (InterruptedException "),t("span",{style:{color:"#FFAB70"}},"e"),t("span",{style:{color:"#E1E4E8"}},") { }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"}, "),t("span",{style:{color:"#79B8FF"}},"1000"),t("span",{style:{color:"#E1E4E8"}},", TimeUnit.MILLISECONDS);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"executor."),t("span",{style:{color:"#B392F0"}},"schedule"),t("span",{style:{color:"#E1E4E8"}},"(() "),t("span",{style:{color:"#F97583"}},"->"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"System.out."),t("span",{style:{color:"#B392F0"}},"println"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#9ECBFF"}},'"任务2，执行时间："'),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"+"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"new"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"Date"),t("span",{style:{color:"#E1E4E8"}},"());")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"}, "),t("span",{style:{color:"#79B8FF"}},"1000"),t("span",{style:{color:"#E1E4E8"}},", TimeUnit.MILLISECONDS);")])])]),t("pre",{class:"shiki github-light vp-code-light"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"ScheduledExecutorService executor "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," Executors."),t("span",{style:{color:"#6F42C1"}},"newScheduledThreadPool"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#005CC5"}},"2"),t("span",{style:{color:"#24292E"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// 添加两个任务，希望它们都在 1s 后执行")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"executor."),t("span",{style:{color:"#6F42C1"}},"schedule"),t("span",{style:{color:"#24292E"}},"(() "),t("span",{style:{color:"#D73A49"}},"->"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"System.out."),t("span",{style:{color:"#6F42C1"}},"println"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#032F62"}},'"任务1，执行时间："'),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"+"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"new"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"Date"),t("span",{style:{color:"#24292E"}},"());")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"try"),t("span",{style:{color:"#24292E"}}," { Thread."),t("span",{style:{color:"#6F42C1"}},"sleep"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#005CC5"}},"2000"),t("span",{style:{color:"#24292E"}},"); } "),t("span",{style:{color:"#D73A49"}},"catch"),t("span",{style:{color:"#24292E"}}," (InterruptedException "),t("span",{style:{color:"#E36209"}},"e"),t("span",{style:{color:"#24292E"}},") { }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"}, "),t("span",{style:{color:"#005CC5"}},"1000"),t("span",{style:{color:"#24292E"}},", TimeUnit.MILLISECONDS);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"executor."),t("span",{style:{color:"#6F42C1"}},"schedule"),t("span",{style:{color:"#24292E"}},"(() "),t("span",{style:{color:"#D73A49"}},"->"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"System.out."),t("span",{style:{color:"#6F42C1"}},"println"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#032F62"}},'"任务2，执行时间："'),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"+"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"new"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"Date"),t("span",{style:{color:"#24292E"}},"());")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"}, "),t("span",{style:{color:"#005CC5"}},"1000"),t("span",{style:{color:"#24292E"}},", TimeUnit.MILLISECONDS);")])])])],-1),ul=t("figure",null,[t("img",{src:"https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230719142957233.png",alt:"image-20230719142957233",loading:"lazy",decoding:"async"})],-1),Al=t("p",null,"scheduleAtFixedRate 例子：",-1),dl=t("div",{class:"language-java"},[t("button",{title:"Copy Code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki github-dark vp-code-dark"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"ScheduledExecutorService pool "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," Executors."),t("span",{style:{color:"#B392F0"}},"newScheduledThreadPool"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#79B8FF"}},"1"),t("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"log."),t("span",{style:{color:"#B392F0"}},"debug"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#9ECBFF"}},'"start..."'),t("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"pool."),t("span",{style:{color:"#B392F0"}},"scheduleAtFixedRate"),t("span",{style:{color:"#E1E4E8"}},"(() "),t("span",{style:{color:"#F97583"}},"->"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"log."),t("span",{style:{color:"#B392F0"}},"debug"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#9ECBFF"}},'"running..."'),t("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"}, "),t("span",{style:{color:"#79B8FF"}},"1"),t("span",{style:{color:"#E1E4E8"}},", "),t("span",{style:{color:"#79B8FF"}},"1"),t("span",{style:{color:"#E1E4E8"}},", TimeUnit.SECONDS);")])])]),t("pre",{class:"shiki github-light vp-code-light"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"ScheduledExecutorService pool "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," Executors."),t("span",{style:{color:"#6F42C1"}},"newScheduledThreadPool"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#005CC5"}},"1"),t("span",{style:{color:"#24292E"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"log."),t("span",{style:{color:"#6F42C1"}},"debug"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#032F62"}},'"start..."'),t("span",{style:{color:"#24292E"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"pool."),t("span",{style:{color:"#6F42C1"}},"scheduleAtFixedRate"),t("span",{style:{color:"#24292E"}},"(() "),t("span",{style:{color:"#D73A49"}},"->"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"log."),t("span",{style:{color:"#6F42C1"}},"debug"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#032F62"}},'"running..."'),t("span",{style:{color:"#24292E"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"}, "),t("span",{style:{color:"#005CC5"}},"1"),t("span",{style:{color:"#24292E"}},", "),t("span",{style:{color:"#005CC5"}},"1"),t("span",{style:{color:"#24292E"}},", TimeUnit.SECONDS);")])])])],-1),Dl=t("figure",null,[t("img",{src:"https://jsd.cdn.zzko.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230719143007433.png",alt:"image-20230719143007433",loading:"lazy",decoding:"async"})],-1),Cl=t("p",null,"scheduleAtFixedRate 例子（任务执行时间超过了间隔时间）：",-1),hl=t("div",{class:"language-java"},[t("button",{title:"Copy Code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki github-dark vp-code-dark"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"ScheduledExecutorService pool "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," Executors."),t("span",{style:{color:"#B392F0"}},"newScheduledThreadPool"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#79B8FF"}},"1"),t("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"log."),t("span",{style:{color:"#B392F0"}},"debug"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#9ECBFF"}},'"start..."'),t("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"pool."),t("span",{style:{color:"#B392F0"}},"scheduleAtFixedRate"),t("span",{style:{color:"#E1E4E8"}},"(() "),t("span",{style:{color:"#F97583"}},"->"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"log."),t("span",{style:{color:"#B392F0"}},"debug"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#9ECBFF"}},'"running..."'),t("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#B392F0"}},"sleep"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#79B8FF"}},"2"),t("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"}, "),t("span",{style:{color:"#79B8FF"}},"1"),t("span",{style:{color:"#E1E4E8"}},", "),t("span",{style:{color:"#79B8FF"}},"1"),t("span",{style:{color:"#E1E4E8"}},", TimeUnit.SECONDS);")])])]),t("pre",{class:"shiki github-light vp-code-light"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"ScheduledExecutorService pool "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," Executors."),t("span",{style:{color:"#6F42C1"}},"newScheduledThreadPool"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#005CC5"}},"1"),t("span",{style:{color:"#24292E"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"log."),t("span",{style:{color:"#6F42C1"}},"debug"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#032F62"}},'"start..."'),t("span",{style:{color:"#24292E"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"pool."),t("span",{style:{color:"#6F42C1"}},"scheduleAtFixedRate"),t("span",{style:{color:"#24292E"}},"(() "),t("span",{style:{color:"#D73A49"}},"->"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"log."),t("span",{style:{color:"#6F42C1"}},"debug"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#032F62"}},'"running..."'),t("span",{style:{color:"#24292E"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#6F42C1"}},"sleep"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#005CC5"}},"2"),t("span",{style:{color:"#24292E"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"}, "),t("span",{style:{color:"#005CC5"}},"1"),t("span",{style:{color:"#24292E"}},", "),t("span",{style:{color:"#005CC5"}},"1"),t("span",{style:{color:"#24292E"}},", TimeUnit.SECONDS);")])])])],-1),gl=t("figure",null,[t("img",{src:"https://jsd.cdn.zzko.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230719143045966.png",alt:"image-20230719143045966",loading:"lazy",decoding:"async"})],-1),Bl=t("p",null,"scheduleWithFixedDelay 例子：",-1),fl=t("div",{class:"language-java"},[t("button",{title:"Copy Code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki github-dark vp-code-dark"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"ScheduledExecutorService pool "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," Executors."),t("span",{style:{color:"#B392F0"}},"newScheduledThreadPool"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#79B8FF"}},"1"),t("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"log."),t("span",{style:{color:"#B392F0"}},"debug"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#9ECBFF"}},'"start..."'),t("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"pool."),t("span",{style:{color:"#B392F0"}},"scheduleWithFixedDelay"),t("span",{style:{color:"#E1E4E8"}},"(()"),t("span",{style:{color:"#F97583"}},"->"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"log."),t("span",{style:{color:"#B392F0"}},"debug"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#9ECBFF"}},'"running..."'),t("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#B392F0"}},"sleep"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#79B8FF"}},"2"),t("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"}, "),t("span",{style:{color:"#79B8FF"}},"1"),t("span",{style:{color:"#E1E4E8"}},", "),t("span",{style:{color:"#79B8FF"}},"1"),t("span",{style:{color:"#E1E4E8"}},", TimeUnit.SECONDS);")])])]),t("pre",{class:"shiki github-light vp-code-light"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"ScheduledExecutorService pool "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," Executors."),t("span",{style:{color:"#6F42C1"}},"newScheduledThreadPool"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#005CC5"}},"1"),t("span",{style:{color:"#24292E"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"log."),t("span",{style:{color:"#6F42C1"}},"debug"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#032F62"}},'"start..."'),t("span",{style:{color:"#24292E"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"pool."),t("span",{style:{color:"#6F42C1"}},"scheduleWithFixedDelay"),t("span",{style:{color:"#24292E"}},"(()"),t("span",{style:{color:"#D73A49"}},"->"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"log."),t("span",{style:{color:"#6F42C1"}},"debug"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#032F62"}},'"running..."'),t("span",{style:{color:"#24292E"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#6F42C1"}},"sleep"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#005CC5"}},"2"),t("span",{style:{color:"#24292E"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"}, "),t("span",{style:{color:"#005CC5"}},"1"),t("span",{style:{color:"#24292E"}},", "),t("span",{style:{color:"#005CC5"}},"1"),t("span",{style:{color:"#24292E"}},", TimeUnit.SECONDS);")])])])],-1),kl=t("figure",null,[t("img",{src:"https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230719143116176.png",alt:"image-20230719143116176",loading:"lazy",decoding:"async"})],-1),bl=t("blockquote",null,[t("p",null,[t("strong",null,"评价"),p(" 整个线程池表现为：线程数固定，任务数多于线程数时，会放入无界队列排队。任务执行完毕，这些线 程也不会被释放。用来执行延迟或反复执行的任务")])],-1),ml={id:"正确处理执行任务异常",tabindex:"-1"},Sl=t("p",null,"可以发现，如果线程池中的线程执行任务时，如果任务抛出了异常，默认是中断执行该任务而不是抛出异常或者打印异常信息。",-1),vl=t("p",null,"方法1：主动捉异常",-1),wl=t("div",{class:"language-java"},[t("button",{title:"Copy Code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki github-dark vp-code-dark"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"ExecutorService pool "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," Executors."),t("span",{style:{color:"#B392F0"}},"newFixedThreadPool"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#79B8FF"}},"1"),t("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"pool."),t("span",{style:{color:"#B392F0"}},"submit"),t("span",{style:{color:"#E1E4E8"}},"(() "),t("span",{style:{color:"#F97583"}},"->"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"try"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}}," log."),t("span",{style:{color:"#B392F0"}},"debug"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#9ECBFF"}},'"task1"'),t("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," i "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"1"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"/"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"0"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}}," } "),t("span",{style:{color:"#F97583"}},"catch"),t("span",{style:{color:"#E1E4E8"}}," (Exception "),t("span",{style:{color:"#FFAB70"}},"e"),t("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}}," log."),t("span",{style:{color:"#B392F0"}},"error"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#9ECBFF"}},'"error:"'),t("span",{style:{color:"#E1E4E8"}},", e);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}}," }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"});")])])]),t("pre",{class:"shiki github-light vp-code-light"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"ExecutorService pool "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," Executors."),t("span",{style:{color:"#6F42C1"}},"newFixedThreadPool"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#005CC5"}},"1"),t("span",{style:{color:"#24292E"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"pool."),t("span",{style:{color:"#6F42C1"}},"submit"),t("span",{style:{color:"#24292E"}},"(() "),t("span",{style:{color:"#D73A49"}},"->"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"try"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}}," log."),t("span",{style:{color:"#6F42C1"}},"debug"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#032F62"}},'"task1"'),t("span",{style:{color:"#24292E"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," i "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"1"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"/"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"0"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}}," } "),t("span",{style:{color:"#D73A49"}},"catch"),t("span",{style:{color:"#24292E"}}," (Exception "),t("span",{style:{color:"#E36209"}},"e"),t("span",{style:{color:"#24292E"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}}," log."),t("span",{style:{color:"#6F42C1"}},"error"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#032F62"}},'"error:"'),t("span",{style:{color:"#24292E"}},", e);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}}," }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"});")])])])],-1),Tl=t("p",null,"方法2：使用 Future，错误信息都被封装进submit方法的返回方法中！",-1),xl=t("div",{class:"language-java"},[t("button",{title:"Copy Code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki github-dark vp-code-dark"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"ExecutorService pool "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," Executors."),t("span",{style:{color:"#B392F0"}},"newFixedThreadPool"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#79B8FF"}},"1"),t("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"Future<"),t("span",{style:{color:"#F97583"}},"Boolean"),t("span",{style:{color:"#E1E4E8"}},"> f "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," pool."),t("span",{style:{color:"#B392F0"}},"submit"),t("span",{style:{color:"#E1E4E8"}},"(() "),t("span",{style:{color:"#F97583"}},"->"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}}," log."),t("span",{style:{color:"#B392F0"}},"debug"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#9ECBFF"}},'"task1"'),t("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," i "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"1"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"/"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"0"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"return"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"true"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"});")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"log."),t("span",{style:{color:"#B392F0"}},"debug"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#9ECBFF"}},'"result:{}"'),t("span",{style:{color:"#E1E4E8"}},", f."),t("span",{style:{color:"#B392F0"}},"get"),t("span",{style:{color:"#E1E4E8"}},"());")])])]),t("pre",{class:"shiki github-light vp-code-light"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"ExecutorService pool "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," Executors."),t("span",{style:{color:"#6F42C1"}},"newFixedThreadPool"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#005CC5"}},"1"),t("span",{style:{color:"#24292E"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"Future<"),t("span",{style:{color:"#D73A49"}},"Boolean"),t("span",{style:{color:"#24292E"}},"> f "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," pool."),t("span",{style:{color:"#6F42C1"}},"submit"),t("span",{style:{color:"#24292E"}},"(() "),t("span",{style:{color:"#D73A49"}},"->"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}}," log."),t("span",{style:{color:"#6F42C1"}},"debug"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#032F62"}},'"task1"'),t("span",{style:{color:"#24292E"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," i "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"1"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"/"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"0"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"return"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"true"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"});")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"log."),t("span",{style:{color:"#6F42C1"}},"debug"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#032F62"}},'"result:{}"'),t("span",{style:{color:"#24292E"}},", f."),t("span",{style:{color:"#6F42C1"}},"get"),t("span",{style:{color:"#24292E"}},"());")])])])],-1),Nl={id:"定时",tabindex:"-1"},Il={id:"定期执行",tabindex:"-1"},Ll=t("p",null,"如何让每周四 18:00:00 定时执行任务？",-1),jl=t("div",{class:"language-java"},[t("button",{title:"Copy Code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki github-dark vp-code-dark"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// 获得当前时间")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"LocalDateTime now "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," LocalDateTime."),t("span",{style:{color:"#B392F0"}},"now"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// 获取本周四 18:00:00.000")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"LocalDateTime thursday "),t("span",{style:{color:"#F97583"}},"=")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"now."),t("span",{style:{color:"#B392F0"}},"with"),t("span",{style:{color:"#E1E4E8"}},"(DayOfWeek.THURSDAY)."),t("span",{style:{color:"#B392F0"}},"withHour"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#79B8FF"}},"18"),t("span",{style:{color:"#E1E4E8"}},")."),t("span",{style:{color:"#B392F0"}},"withMinute"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#79B8FF"}},"0"),t("span",{style:{color:"#E1E4E8"}},")."),t("span",{style:{color:"#B392F0"}},"withSecond"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#79B8FF"}},"0"),t("span",{style:{color:"#E1E4E8"}},")."),t("span",{style:{color:"#B392F0"}},"withNano"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#79B8FF"}},"0"),t("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// 如果当前时间已经超过 本周四 18:00:00.000， 那么找下周四 18:00:00.000")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}},"(now."),t("span",{style:{color:"#B392F0"}},"compareTo"),t("span",{style:{color:"#E1E4E8"}},"(thursday) "),t("span",{style:{color:"#F97583"}},">="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"0"),t("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"thursday "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," thursday."),t("span",{style:{color:"#B392F0"}},"plusWeeks"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#79B8FF"}},"1"),t("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"}")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// 计算时间差，即延时执行时间")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"long"),t("span",{style:{color:"#E1E4E8"}}," initialDelay "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," Duration."),t("span",{style:{color:"#B392F0"}},"between"),t("span",{style:{color:"#E1E4E8"}},"(now, thursday)."),t("span",{style:{color:"#B392F0"}},"toMillis"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// 计算间隔时间，即 1 周的毫秒值")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"long"),t("span",{style:{color:"#E1E4E8"}}," oneWeek "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"7"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"*"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"24"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"*"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"3600"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"*"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"1000"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"ScheduledExecutorService executor "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," Executors."),t("span",{style:{color:"#B392F0"}},"newScheduledThreadPool"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#79B8FF"}},"2"),t("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"System.out."),t("span",{style:{color:"#B392F0"}},"println"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#9ECBFF"}},'"开始时间："'),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"+"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"new"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"Date"),t("span",{style:{color:"#E1E4E8"}},"());")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"executor."),t("span",{style:{color:"#B392F0"}},"scheduleAtFixedRate"),t("span",{style:{color:"#E1E4E8"}},"(() "),t("span",{style:{color:"#F97583"}},"->"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"System.out."),t("span",{style:{color:"#B392F0"}},"println"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#9ECBFF"}},'"执行时间："'),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"+"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"new"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"Date"),t("span",{style:{color:"#E1E4E8"}},"());")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"}, initialDelay, oneWeek, TimeUnit.MILLISECONDS);")])])]),t("pre",{class:"shiki github-light vp-code-light"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// 获得当前时间")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"LocalDateTime now "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," LocalDateTime."),t("span",{style:{color:"#6F42C1"}},"now"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// 获取本周四 18:00:00.000")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"LocalDateTime thursday "),t("span",{style:{color:"#D73A49"}},"=")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"now."),t("span",{style:{color:"#6F42C1"}},"with"),t("span",{style:{color:"#24292E"}},"(DayOfWeek.THURSDAY)."),t("span",{style:{color:"#6F42C1"}},"withHour"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#005CC5"}},"18"),t("span",{style:{color:"#24292E"}},")."),t("span",{style:{color:"#6F42C1"}},"withMinute"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#005CC5"}},"0"),t("span",{style:{color:"#24292E"}},")."),t("span",{style:{color:"#6F42C1"}},"withSecond"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#005CC5"}},"0"),t("span",{style:{color:"#24292E"}},")."),t("span",{style:{color:"#6F42C1"}},"withNano"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#005CC5"}},"0"),t("span",{style:{color:"#24292E"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// 如果当前时间已经超过 本周四 18:00:00.000， 那么找下周四 18:00:00.000")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}},"(now."),t("span",{style:{color:"#6F42C1"}},"compareTo"),t("span",{style:{color:"#24292E"}},"(thursday) "),t("span",{style:{color:"#D73A49"}},">="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"0"),t("span",{style:{color:"#24292E"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"thursday "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," thursday."),t("span",{style:{color:"#6F42C1"}},"plusWeeks"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#005CC5"}},"1"),t("span",{style:{color:"#24292E"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"}")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// 计算时间差，即延时执行时间")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"long"),t("span",{style:{color:"#24292E"}}," initialDelay "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," Duration."),t("span",{style:{color:"#6F42C1"}},"between"),t("span",{style:{color:"#24292E"}},"(now, thursday)."),t("span",{style:{color:"#6F42C1"}},"toMillis"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// 计算间隔时间，即 1 周的毫秒值")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"long"),t("span",{style:{color:"#24292E"}}," oneWeek "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"7"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"*"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"24"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"*"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"3600"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"*"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"1000"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"ScheduledExecutorService executor "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," Executors."),t("span",{style:{color:"#6F42C1"}},"newScheduledThreadPool"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#005CC5"}},"2"),t("span",{style:{color:"#24292E"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"System.out."),t("span",{style:{color:"#6F42C1"}},"println"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#032F62"}},'"开始时间："'),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"+"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"new"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"Date"),t("span",{style:{color:"#24292E"}},"());")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"executor."),t("span",{style:{color:"#6F42C1"}},"scheduleAtFixedRate"),t("span",{style:{color:"#24292E"}},"(() "),t("span",{style:{color:"#D73A49"}},"->"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"System.out."),t("span",{style:{color:"#6F42C1"}},"println"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#032F62"}},'"执行时间："'),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"+"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"new"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"Date"),t("span",{style:{color:"#24292E"}},"());")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"}, initialDelay, oneWeek, TimeUnit.MILLISECONDS);")])])])],-1),Rl={id:"tomcat-线程池",tabindex:"-1"},Ol=t("p",null,"Tomcat 在哪里用到了线程池呢",-1),ql=t("figure",null,[t("img",{src:"https://jsd.cdn.zzko.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230719150054370.png",alt:"image-20230719150054370",loading:"lazy",decoding:"async"})],-1),Pl=t("ol",null,[t("li",null,"LimitLatch 用来限流，可以控制最大连接个数，类似 J.U.C 中的 Semaphore 后面再讲"),t("li",null,"Acceptor 只负责【接收新的 socket 连接】"),t("li",null,"Poller 只负责监听 socket channel 是否有【可读的 I/O 事件】"),t("li",null,"一旦可读，封装一个任务对象（socketProcessor），提交给 Executor 线程池处理"),t("li",null,"Executor 线程池中的工作线程最终负责【处理请求】")],-1),zl=t("p",null,"Tomcat 线程池扩展了 ThreadPoolExecutor，行为稍有不同",-1),_l=t("ol",null,[t("li",null,"如果总线程数达到 maximumPoolSize，这时不会立刻抛 RejectedExecutionException 异常，而是再次尝试将任务放入队列，如果还失败，才抛出 RejectedExecutionException 异常")],-1),Kl=t("p",null,"源码 tomcat-7.0.42",-1),Vl=t("div",{class:"language-java"},[t("button",{title:"Copy Code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki github-dark vp-code-dark"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"public"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"void"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"execute"),t("span",{style:{color:"#E1E4E8"}},"(Runnable command, "),t("span",{style:{color:"#F97583"}},"long"),t("span",{style:{color:"#E1E4E8"}}," timeout, TimeUnit unit) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        submittedCount."),t("span",{style:{color:"#B392F0"}},"incrementAndGet"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"try"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#79B8FF"}},"super"),t("span",{style:{color:"#E1E4E8"}},"."),t("span",{style:{color:"#B392F0"}},"execute"),t("span",{style:{color:"#E1E4E8"}},"(command);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        } "),t("span",{style:{color:"#F97583"}},"catch"),t("span",{style:{color:"#E1E4E8"}}," (RejectedExecutionException "),t("span",{style:{color:"#FFAB70"}},"rx"),t("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," ("),t("span",{style:{color:"#79B8FF"}},"super"),t("span",{style:{color:"#E1E4E8"}},"."),t("span",{style:{color:"#B392F0"}},"getQueue"),t("span",{style:{color:"#E1E4E8"}},"() "),t("span",{style:{color:"#F97583"}},"instanceof"),t("span",{style:{color:"#E1E4E8"}}," TaskQueue) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#F97583"}},"final"),t("span",{style:{color:"#E1E4E8"}}," TaskQueue queue "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," (TaskQueue)"),t("span",{style:{color:"#79B8FF"}},"super"),t("span",{style:{color:"#E1E4E8"}},"."),t("span",{style:{color:"#B392F0"}},"getQueue"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#F97583"}},"try"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                    "),t("span",{style:{color:"#6A737D"}},"// 使任务从新进入阻塞队列")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                    "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," ("),t("span",{style:{color:"#F97583"}},"!"),t("span",{style:{color:"#E1E4E8"}},"queue."),t("span",{style:{color:"#B392F0"}},"force"),t("span",{style:{color:"#E1E4E8"}},"(command, timeout, unit)) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                        submittedCount."),t("span",{style:{color:"#B392F0"}},"decrementAndGet"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                        "),t("span",{style:{color:"#F97583"}},"throw"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"new"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"RejectedExecutionException"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#9ECBFF"}},'"Queue capacity is full."'),t("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                } "),t("span",{style:{color:"#F97583"}},"catch"),t("span",{style:{color:"#E1E4E8"}}," (InterruptedException "),t("span",{style:{color:"#FFAB70"}},"x"),t("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                    submittedCount."),t("span",{style:{color:"#B392F0"}},"decrementAndGet"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                    Thread."),t("span",{style:{color:"#B392F0"}},"interrupted"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                    "),t("span",{style:{color:"#F97583"}},"throw"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"new"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"RejectedExecutionException"),t("span",{style:{color:"#E1E4E8"}},"(x);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            } "),t("span",{style:{color:"#F97583"}},"else"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                submittedCount."),t("span",{style:{color:"#B392F0"}},"decrementAndGet"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#F97583"}},"throw"),t("span",{style:{color:"#E1E4E8"}}," rx;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    }")])])]),t("pre",{class:"shiki github-light vp-code-light"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"public"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"void"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"execute"),t("span",{style:{color:"#24292E"}},"(Runnable command, "),t("span",{style:{color:"#D73A49"}},"long"),t("span",{style:{color:"#24292E"}}," timeout, TimeUnit unit) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        submittedCount."),t("span",{style:{color:"#6F42C1"}},"incrementAndGet"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"try"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#005CC5"}},"super"),t("span",{style:{color:"#24292E"}},"."),t("span",{style:{color:"#6F42C1"}},"execute"),t("span",{style:{color:"#24292E"}},"(command);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        } "),t("span",{style:{color:"#D73A49"}},"catch"),t("span",{style:{color:"#24292E"}}," (RejectedExecutionException "),t("span",{style:{color:"#E36209"}},"rx"),t("span",{style:{color:"#24292E"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," ("),t("span",{style:{color:"#005CC5"}},"super"),t("span",{style:{color:"#24292E"}},"."),t("span",{style:{color:"#6F42C1"}},"getQueue"),t("span",{style:{color:"#24292E"}},"() "),t("span",{style:{color:"#D73A49"}},"instanceof"),t("span",{style:{color:"#24292E"}}," TaskQueue) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#D73A49"}},"final"),t("span",{style:{color:"#24292E"}}," TaskQueue queue "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," (TaskQueue)"),t("span",{style:{color:"#005CC5"}},"super"),t("span",{style:{color:"#24292E"}},"."),t("span",{style:{color:"#6F42C1"}},"getQueue"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#D73A49"}},"try"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                    "),t("span",{style:{color:"#6A737D"}},"// 使任务从新进入阻塞队列")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                    "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," ("),t("span",{style:{color:"#D73A49"}},"!"),t("span",{style:{color:"#24292E"}},"queue."),t("span",{style:{color:"#6F42C1"}},"force"),t("span",{style:{color:"#24292E"}},"(command, timeout, unit)) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                        submittedCount."),t("span",{style:{color:"#6F42C1"}},"decrementAndGet"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                        "),t("span",{style:{color:"#D73A49"}},"throw"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"new"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"RejectedExecutionException"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#032F62"}},'"Queue capacity is full."'),t("span",{style:{color:"#24292E"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                } "),t("span",{style:{color:"#D73A49"}},"catch"),t("span",{style:{color:"#24292E"}}," (InterruptedException "),t("span",{style:{color:"#E36209"}},"x"),t("span",{style:{color:"#24292E"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                    submittedCount."),t("span",{style:{color:"#6F42C1"}},"decrementAndGet"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                    Thread."),t("span",{style:{color:"#6F42C1"}},"interrupted"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                    "),t("span",{style:{color:"#D73A49"}},"throw"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"new"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"RejectedExecutionException"),t("span",{style:{color:"#24292E"}},"(x);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            } "),t("span",{style:{color:"#D73A49"}},"else"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                submittedCount."),t("span",{style:{color:"#6F42C1"}},"decrementAndGet"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#D73A49"}},"throw"),t("span",{style:{color:"#24292E"}}," rx;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    }")])])])],-1),Ml=t("p",null,"TaskQueue.java",-1),Wl=t("div",{class:"language-java"},[t("button",{title:"Copy Code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki github-dark vp-code-dark"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"public"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"boolean"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"force"),t("span",{style:{color:"#E1E4E8"}},"(Runnable o, "),t("span",{style:{color:"#F97583"}},"long"),t("span",{style:{color:"#E1E4E8"}}," timeout, TimeUnit unit) throws InterruptedException {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," ( parent."),t("span",{style:{color:"#B392F0"}},"isShutdown"),t("span",{style:{color:"#E1E4E8"}},"() )")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"throw"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"new"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"RejectedExecutionException"),t("span",{style:{color:"#E1E4E8"}},"(")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                    "),t("span",{style:{color:"#9ECBFF"}},'"Executor not running, can\'t force a command into the queue"')]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            );")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"return"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"super"),t("span",{style:{color:"#E1E4E8"}},"."),t("span",{style:{color:"#B392F0"}},"offer"),t("span",{style:{color:"#E1E4E8"}},"(o,timeout,unit); "),t("span",{style:{color:"#6A737D"}},"//forces the item onto the queue, to be used if the task")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        is rejected")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    }")])])]),t("pre",{class:"shiki github-light vp-code-light"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"public"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"boolean"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"force"),t("span",{style:{color:"#24292E"}},"(Runnable o, "),t("span",{style:{color:"#D73A49"}},"long"),t("span",{style:{color:"#24292E"}}," timeout, TimeUnit unit) throws InterruptedException {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," ( parent."),t("span",{style:{color:"#6F42C1"}},"isShutdown"),t("span",{style:{color:"#24292E"}},"() )")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"throw"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"new"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"RejectedExecutionException"),t("span",{style:{color:"#24292E"}},"(")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                    "),t("span",{style:{color:"#032F62"}},'"Executor not running, can\'t force a command into the queue"')]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            );")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"return"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"super"),t("span",{style:{color:"#24292E"}},"."),t("span",{style:{color:"#6F42C1"}},"offer"),t("span",{style:{color:"#24292E"}},"(o,timeout,unit); "),t("span",{style:{color:"#6A737D"}},"//forces the item onto the queue, to be used if the task")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        is rejected")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    }")])])])],-1),Ul=t("p",null,"Connector 配置",-1),Ql=t("figure",null,[t("img",{src:"https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230719145956151.png",alt:"image-20230719145956151",loading:"lazy",decoding:"async"})],-1),Hl=t("p",null,"Executor 线程配置",-1),Gl=t("figure",null,[t("img",{src:"https://jsd.cdn.zzko.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230719150013951.png",alt:"image-20230719150013951",loading:"lazy",decoding:"async"})],-1),Jl=t("figure",null,[t("img",{src:"https://jsd.cdn.zzko.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230719150021940.png",alt:"image-20230719150021940",loading:"lazy",decoding:"async"})],-1),Yl={id:"_3、fork-join",tabindex:"-1"},Xl={id:"概念",tabindex:"-1"},Zl=t("ol",null,[t("li",null,"Fork/Join 是 JDK 1.7 加入的新的线程池实现，它体现的是一种分治思想，适用于能够进行任务拆分的 cpu 密集型运算"),t("li",null,"所谓的任务拆分，是将一个大任务拆分为算法上相同的小任务，直至不能拆分可以直接求解。跟递归相关的一些计算，如归并排序、斐波那契数列、都可以用分治思想进行求解"),t("li",null,"Fork/Join 在分治的基础上加入了多线程，可以把每个任务的分解和合并交给不同的线程来完成，进一步提升了运算效率"),t("li",null,"Fork/Join 默认会创建与 cpu 核心数大小相同的线程池")],-1),$l={id:"使用-1",tabindex:"-1"},so=t("p",null,"提交给 Fork/Join 线程池的任务需要继承 RecursiveTask（有返回值）或 RecursiveAction（没有返回值），例如下 面定义了一个对 1~n 之间的整数求和的任务",-1),lo=t("div",{class:"language-java"},[t("button",{title:"Copy Code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki github-dark vp-code-dark"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"public"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"class"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"TestForkJoin"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"public"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"static"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"void"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"main"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#F97583"}},"String"),t("span",{style:{color:"#E1E4E8"}},"[] "),t("span",{style:{color:"#FFAB70"}},"args"),t("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        ForkJoinPool pool "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"new"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"ForkJoinPool"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#79B8FF"}},"4"),t("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        System.out."),t("span",{style:{color:"#B392F0"}},"println"),t("span",{style:{color:"#E1E4E8"}},"(pool."),t("span",{style:{color:"#B392F0"}},"invoke"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#F97583"}},"new"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"AddTask1"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#79B8FF"}},"5"),t("span",{style:{color:"#E1E4E8"}},")));")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"}")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"@"),t("span",{style:{color:"#F97583"}},"Slf4j"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#79B8FF"}},"topic"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#9ECBFF"}},'"c.AddTask"'),t("span",{style:{color:"#E1E4E8"}},")")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"class"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"AddTask1"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"extends"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"RecursiveTask"),t("span",{style:{color:"#E1E4E8"}},"<"),t("span",{style:{color:"#F97583"}},"Integer"),t("span",{style:{color:"#E1E4E8"}},"> {")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," n;")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"public"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"AddTask1"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#FFAB70"}},"n"),t("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#79B8FF"}},"this"),t("span",{style:{color:"#E1E4E8"}},".n "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," n;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    @"),t("span",{style:{color:"#F97583"}},"Override")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"public"),t("span",{style:{color:"#E1E4E8"}}," String "),t("span",{style:{color:"#B392F0"}},"toString"),t("span",{style:{color:"#E1E4E8"}},"() {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"return"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#9ECBFF"}},'"{"'),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"+"),t("span",{style:{color:"#E1E4E8"}}," n "),t("span",{style:{color:"#F97583"}},"+"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#9ECBFF"}},"'}'"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    @"),t("span",{style:{color:"#F97583"}},"Override")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"protected"),t("span",{style:{color:"#E1E4E8"}}," Integer "),t("span",{style:{color:"#B392F0"}},"compute"),t("span",{style:{color:"#E1E4E8"}},"() {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (n "),t("span",{style:{color:"#F97583"}},"=="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"1"),t("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            log."),t("span",{style:{color:"#B392F0"}},"debug"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#9ECBFF"}},'"join() {}"'),t("span",{style:{color:"#E1E4E8"}},", n);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"return"),t("span",{style:{color:"#E1E4E8"}}," n;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        AddTask1 t1 "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"new"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"AddTask1"),t("span",{style:{color:"#E1E4E8"}},"(n "),t("span",{style:{color:"#F97583"}},"-"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"1"),t("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        t1."),t("span",{style:{color:"#B392F0"}},"fork"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        log."),t("span",{style:{color:"#B392F0"}},"debug"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#9ECBFF"}},'"fork() {} + {}"'),t("span",{style:{color:"#E1E4E8"}},", n, t1);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," result "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," n "),t("span",{style:{color:"#F97583"}},"+"),t("span",{style:{color:"#E1E4E8"}}," t1."),t("span",{style:{color:"#B392F0"}},"join"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        log."),t("span",{style:{color:"#B392F0"}},"debug"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#9ECBFF"}},'"join() {} + {} = {}"'),t("span",{style:{color:"#E1E4E8"}},", n, t1, result);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"return"),t("span",{style:{color:"#E1E4E8"}}," result;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"}")])])]),t("pre",{class:"shiki github-light vp-code-light"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"public"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"class"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"TestForkJoin"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"public"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"static"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"void"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"main"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#D73A49"}},"String"),t("span",{style:{color:"#24292E"}},"[] "),t("span",{style:{color:"#E36209"}},"args"),t("span",{style:{color:"#24292E"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        ForkJoinPool pool "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"new"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"ForkJoinPool"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#005CC5"}},"4"),t("span",{style:{color:"#24292E"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        System.out."),t("span",{style:{color:"#6F42C1"}},"println"),t("span",{style:{color:"#24292E"}},"(pool."),t("span",{style:{color:"#6F42C1"}},"invoke"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#D73A49"}},"new"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"AddTask1"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#005CC5"}},"5"),t("span",{style:{color:"#24292E"}},")));")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"}")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"@"),t("span",{style:{color:"#D73A49"}},"Slf4j"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#005CC5"}},"topic"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#032F62"}},'"c.AddTask"'),t("span",{style:{color:"#24292E"}},")")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"class"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"AddTask1"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"extends"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"RecursiveTask"),t("span",{style:{color:"#24292E"}},"<"),t("span",{style:{color:"#D73A49"}},"Integer"),t("span",{style:{color:"#24292E"}},"> {")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," n;")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"public"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"AddTask1"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#E36209"}},"n"),t("span",{style:{color:"#24292E"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#005CC5"}},"this"),t("span",{style:{color:"#24292E"}},".n "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," n;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    }")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    @"),t("span",{style:{color:"#D73A49"}},"Override")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"public"),t("span",{style:{color:"#24292E"}}," String "),t("span",{style:{color:"#6F42C1"}},"toString"),t("span",{style:{color:"#24292E"}},"() {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"return"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#032F62"}},'"{"'),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"+"),t("span",{style:{color:"#24292E"}}," n "),t("span",{style:{color:"#D73A49"}},"+"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#032F62"}},"'}'"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    }")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    @"),t("span",{style:{color:"#D73A49"}},"Override")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"protected"),t("span",{style:{color:"#24292E"}}," Integer "),t("span",{style:{color:"#6F42C1"}},"compute"),t("span",{style:{color:"#24292E"}},"() {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (n "),t("span",{style:{color:"#D73A49"}},"=="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"1"),t("span",{style:{color:"#24292E"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            log."),t("span",{style:{color:"#6F42C1"}},"debug"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#032F62"}},'"join() {}"'),t("span",{style:{color:"#24292E"}},", n);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"return"),t("span",{style:{color:"#24292E"}}," n;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        AddTask1 t1 "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"new"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"AddTask1"),t("span",{style:{color:"#24292E"}},"(n "),t("span",{style:{color:"#D73A49"}},"-"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"1"),t("span",{style:{color:"#24292E"}},");")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        t1."),t("span",{style:{color:"#6F42C1"}},"fork"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        log."),t("span",{style:{color:"#6F42C1"}},"debug"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#032F62"}},'"fork() {} + {}"'),t("span",{style:{color:"#24292E"}},", n, t1);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," result "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," n "),t("span",{style:{color:"#D73A49"}},"+"),t("span",{style:{color:"#24292E"}}," t1."),t("span",{style:{color:"#6F42C1"}},"join"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        log."),t("span",{style:{color:"#6F42C1"}},"debug"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#032F62"}},'"join() {} + {} = {}"'),t("span",{style:{color:"#24292E"}},", n, t1, result);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"return"),t("span",{style:{color:"#24292E"}}," result;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"}")])])])],-1),oo=t("figure",null,[t("img",{src:"https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230719151428743.png",alt:"image-20230719151428743",loading:"lazy",decoding:"async"})],-1),no=t("figure",null,[t("img",{src:"https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230719151443095.png",alt:"image-20230719151443095",loading:"lazy",decoding:"async"})],-1),ao=t("p",null,"改进",-1),eo=t("div",{class:"language-java"},[t("button",{title:"Copy Code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki github-dark vp-code-dark"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"class"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"AddTask3"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"extends"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"RecursiveTask"),t("span",{style:{color:"#E1E4E8"}},"<"),t("span",{style:{color:"#F97583"}},"Integer"),t("span",{style:{color:"#E1E4E8"}},"> {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," begin;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," end;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"public"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"AddTask3"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#FFAB70"}},"begin"),t("span",{style:{color:"#E1E4E8"}},", "),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#FFAB70"}},"end"),t("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#79B8FF"}},"this"),t("span",{style:{color:"#E1E4E8"}},".begin "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," begin;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#79B8FF"}},"this"),t("span",{style:{color:"#E1E4E8"}},".end "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," end;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    @"),t("span",{style:{color:"#F97583"}},"Override")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"public"),t("span",{style:{color:"#E1E4E8"}}," String "),t("span",{style:{color:"#B392F0"}},"toString"),t("span",{style:{color:"#E1E4E8"}},"() {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    \t"),t("span",{style:{color:"#F97583"}},"return"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#9ECBFF"}},'"{"'),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"+"),t("span",{style:{color:"#E1E4E8"}}," begin "),t("span",{style:{color:"#F97583"}},"+"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#9ECBFF"}},'","'),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"+"),t("span",{style:{color:"#E1E4E8"}}," end "),t("span",{style:{color:"#F97583"}},"+"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#9ECBFF"}},"'}'"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    @"),t("span",{style:{color:"#F97583"}},"Override")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"protected"),t("span",{style:{color:"#E1E4E8"}}," Integer "),t("span",{style:{color:"#B392F0"}},"compute"),t("span",{style:{color:"#E1E4E8"}},"() {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#6A737D"}},"// 5, 5")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (begin "),t("span",{style:{color:"#F97583"}},"=="),t("span",{style:{color:"#E1E4E8"}}," end) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            log."),t("span",{style:{color:"#B392F0"}},"debug"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#9ECBFF"}},'"join() {}"'),t("span",{style:{color:"#E1E4E8"}},", begin);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"return"),t("span",{style:{color:"#E1E4E8"}}," begin;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#6A737D"}},"// 4, 5")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (end "),t("span",{style:{color:"#F97583"}},"-"),t("span",{style:{color:"#E1E4E8"}}," begin "),t("span",{style:{color:"#F97583"}},"=="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"1"),t("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            log."),t("span",{style:{color:"#B392F0"}},"debug"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#9ECBFF"}},'"join() {} + {} = {}"'),t("span",{style:{color:"#E1E4E8"}},", begin, end, end "),t("span",{style:{color:"#F97583"}},"+"),t("span",{style:{color:"#E1E4E8"}}," begin);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"return"),t("span",{style:{color:"#E1E4E8"}}," end "),t("span",{style:{color:"#F97583"}},"+"),t("span",{style:{color:"#E1E4E8"}}," begin;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#6A737D"}},"// 1 5")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," mid "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," (end "),t("span",{style:{color:"#F97583"}},"+"),t("span",{style:{color:"#E1E4E8"}}," begin) "),t("span",{style:{color:"#F97583"}},"/"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"2"),t("span",{style:{color:"#E1E4E8"}},"; "),t("span",{style:{color:"#6A737D"}},"// 3")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        AddTask3 t1 "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"new"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"AddTask3"),t("span",{style:{color:"#E1E4E8"}},"(begin, mid); "),t("span",{style:{color:"#6A737D"}},"// 1,3")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        t1."),t("span",{style:{color:"#B392F0"}},"fork"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        AddTask3 t2 "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"new"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"AddTask3"),t("span",{style:{color:"#E1E4E8"}},"(mid "),t("span",{style:{color:"#F97583"}},"+"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"1"),t("span",{style:{color:"#E1E4E8"}},", end); "),t("span",{style:{color:"#6A737D"}},"// 4,5")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        t2."),t("span",{style:{color:"#B392F0"}},"fork"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        log."),t("span",{style:{color:"#B392F0"}},"debug"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#9ECBFF"}},'"fork() {} + {} = ?"'),t("span",{style:{color:"#E1E4E8"}},", t1, t2);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," result "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," t1."),t("span",{style:{color:"#B392F0"}},"join"),t("span",{style:{color:"#E1E4E8"}},"() "),t("span",{style:{color:"#F97583"}},"+"),t("span",{style:{color:"#E1E4E8"}}," t2."),t("span",{style:{color:"#B392F0"}},"join"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        log."),t("span",{style:{color:"#B392F0"}},"debug"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#9ECBFF"}},'"join() {} + {} = {}"'),t("span",{style:{color:"#E1E4E8"}},", t1, t2, result);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"return"),t("span",{style:{color:"#E1E4E8"}}," result;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"}")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"public"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"static"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"void"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"main"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#F97583"}},"String"),t("span",{style:{color:"#E1E4E8"}},"[] args) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"//然后提交给 ForkJoinPool 来执行")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    ForkJoinPool pool "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"new"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"ForkJoinPool"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#79B8FF"}},"4"),t("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    System.out."),t("span",{style:{color:"#B392F0"}},"println"),t("span",{style:{color:"#E1E4E8"}},"(pool."),t("span",{style:{color:"#B392F0"}},"invoke"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#F97583"}},"new"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"AddTask3"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#79B8FF"}},"1"),t("span",{style:{color:"#E1E4E8"}},", "),t("span",{style:{color:"#79B8FF"}},"10"),t("span",{style:{color:"#E1E4E8"}},")));")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"}")])])]),t("pre",{class:"shiki github-light vp-code-light"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"class"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"AddTask3"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"extends"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"RecursiveTask"),t("span",{style:{color:"#24292E"}},"<"),t("span",{style:{color:"#D73A49"}},"Integer"),t("span",{style:{color:"#24292E"}},"> {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," begin;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," end;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"public"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"AddTask3"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#E36209"}},"begin"),t("span",{style:{color:"#24292E"}},", "),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#E36209"}},"end"),t("span",{style:{color:"#24292E"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#005CC5"}},"this"),t("span",{style:{color:"#24292E"}},".begin "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," begin;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#005CC5"}},"this"),t("span",{style:{color:"#24292E"}},".end "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," end;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    @"),t("span",{style:{color:"#D73A49"}},"Override")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"public"),t("span",{style:{color:"#24292E"}}," String "),t("span",{style:{color:"#6F42C1"}},"toString"),t("span",{style:{color:"#24292E"}},"() {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    \t"),t("span",{style:{color:"#D73A49"}},"return"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#032F62"}},'"{"'),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"+"),t("span",{style:{color:"#24292E"}}," begin "),t("span",{style:{color:"#D73A49"}},"+"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#032F62"}},'","'),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"+"),t("span",{style:{color:"#24292E"}}," end "),t("span",{style:{color:"#D73A49"}},"+"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#032F62"}},"'}'"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    @"),t("span",{style:{color:"#D73A49"}},"Override")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"protected"),t("span",{style:{color:"#24292E"}}," Integer "),t("span",{style:{color:"#6F42C1"}},"compute"),t("span",{style:{color:"#24292E"}},"() {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6A737D"}},"// 5, 5")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (begin "),t("span",{style:{color:"#D73A49"}},"=="),t("span",{style:{color:"#24292E"}}," end) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            log."),t("span",{style:{color:"#6F42C1"}},"debug"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#032F62"}},'"join() {}"'),t("span",{style:{color:"#24292E"}},", begin);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"return"),t("span",{style:{color:"#24292E"}}," begin;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6A737D"}},"// 4, 5")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (end "),t("span",{style:{color:"#D73A49"}},"-"),t("span",{style:{color:"#24292E"}}," begin "),t("span",{style:{color:"#D73A49"}},"=="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"1"),t("span",{style:{color:"#24292E"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            log."),t("span",{style:{color:"#6F42C1"}},"debug"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#032F62"}},'"join() {} + {} = {}"'),t("span",{style:{color:"#24292E"}},", begin, end, end "),t("span",{style:{color:"#D73A49"}},"+"),t("span",{style:{color:"#24292E"}}," begin);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"return"),t("span",{style:{color:"#24292E"}}," end "),t("span",{style:{color:"#D73A49"}},"+"),t("span",{style:{color:"#24292E"}}," begin;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6A737D"}},"// 1 5")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," mid "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," (end "),t("span",{style:{color:"#D73A49"}},"+"),t("span",{style:{color:"#24292E"}}," begin) "),t("span",{style:{color:"#D73A49"}},"/"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"2"),t("span",{style:{color:"#24292E"}},"; "),t("span",{style:{color:"#6A737D"}},"// 3")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        AddTask3 t1 "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"new"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"AddTask3"),t("span",{style:{color:"#24292E"}},"(begin, mid); "),t("span",{style:{color:"#6A737D"}},"// 1,3")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        t1."),t("span",{style:{color:"#6F42C1"}},"fork"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        AddTask3 t2 "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"new"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"AddTask3"),t("span",{style:{color:"#24292E"}},"(mid "),t("span",{style:{color:"#D73A49"}},"+"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"1"),t("span",{style:{color:"#24292E"}},", end); "),t("span",{style:{color:"#6A737D"}},"// 4,5")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        t2."),t("span",{style:{color:"#6F42C1"}},"fork"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        log."),t("span",{style:{color:"#6F42C1"}},"debug"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#032F62"}},'"fork() {} + {} = ?"'),t("span",{style:{color:"#24292E"}},", t1, t2);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," result "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," t1."),t("span",{style:{color:"#6F42C1"}},"join"),t("span",{style:{color:"#24292E"}},"() "),t("span",{style:{color:"#D73A49"}},"+"),t("span",{style:{color:"#24292E"}}," t2."),t("span",{style:{color:"#6F42C1"}},"join"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        log."),t("span",{style:{color:"#6F42C1"}},"debug"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#032F62"}},'"join() {} + {} = {}"'),t("span",{style:{color:"#24292E"}},", t1, t2, result);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"return"),t("span",{style:{color:"#24292E"}}," result;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"}")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"public"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"static"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"void"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"main"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#D73A49"}},"String"),t("span",{style:{color:"#24292E"}},"[] args) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"//然后提交给 ForkJoinPool 来执行")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    ForkJoinPool pool "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"new"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"ForkJoinPool"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#005CC5"}},"4"),t("span",{style:{color:"#24292E"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    System.out."),t("span",{style:{color:"#6F42C1"}},"println"),t("span",{style:{color:"#24292E"}},"(pool."),t("span",{style:{color:"#6F42C1"}},"invoke"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#D73A49"}},"new"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"AddTask3"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#005CC5"}},"1"),t("span",{style:{color:"#24292E"}},", "),t("span",{style:{color:"#005CC5"}},"10"),t("span",{style:{color:"#24292E"}},")));")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"}")])])])],-1),co=t("figure",null,[t("img",{src:"https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230719152118555.png",alt:"image-20230719152118555",loading:"lazy",decoding:"async"})],-1),to=t("figure",null,[t("img",{src:"https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230719152127214.png",alt:"image-20230719152127214",loading:"lazy",decoding:"async"})],-1),po={id:"八、juc",tabindex:"-1"},ro={id:"_1、aqs-原理",tabindex:"-1"},Eo=t("ul",null,[t("li",null,[t("p",null,"概述：全称是 AbstractQueuedSynchronizer，是阻塞式锁和相关的同步器工具的框架")]),t("li",null,[t("p",null,"特点："),t("ul",null,[t("li",null,[p("用 state 属性来表示资源的状态（分独占模式和共享模式），子类需要定义如何维护这个状态，控制如何获取锁和释放锁 "),t("ul",null,[t("li",null,"getState - 获取 state 状态"),t("li",null,"setState - 设置 state 状态"),t("li",null,"compareAndSetState - cas 机制设置 state 状态"),t("li",null,"独占模式是只有一个线程能够访问资源，而共享模式可以允许多个线程访问资源")])]),t("li",null,"提供了基于 FIFO 的等待队列，类似于 Monitor 的 EntryList"),t("li",null,"条件变量来实现等待、唤醒机制，支持多个条件变量，类似于 Monitor 的 WaitSet")])])],-1),yo=t("p",null,"子类主要实现这样一些方法（默认抛出 UnsupportedOperationException）",-1),io=t("ul",null,[t("li",null,"tryAcquire"),t("li",null,"tryRelease"),t("li",null,"tryAcquireShared"),t("li",null,"tryReleaseShared"),t("li",null,"isHeldExclusively")],-1),Fo=t("div",{class:"language-java"},[t("button",{title:"Copy Code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki github-dark vp-code-dark"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"//获取锁的姿势")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// 如果获取锁失败")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," ("),t("span",{style:{color:"#F97583"}},"!"),t("span",{style:{color:"#B392F0"}},"tryAcquire"),t("span",{style:{color:"#E1E4E8"}},"(arg)) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#6A737D"}},"// 入队, 可以选择阻塞当前线程 park unpark")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"}")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"//释放锁的姿势")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// 如果释放锁成功")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," ("),t("span",{style:{color:"#B392F0"}},"tryRelease"),t("span",{style:{color:"#E1E4E8"}},"(arg)) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#6A737D"}},"// 让阻塞线程恢复运行")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"}")])])]),t("pre",{class:"shiki github-light vp-code-light"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"//获取锁的姿势")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// 如果获取锁失败")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," ("),t("span",{style:{color:"#D73A49"}},"!"),t("span",{style:{color:"#6F42C1"}},"tryAcquire"),t("span",{style:{color:"#24292E"}},"(arg)) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6A737D"}},"// 入队, 可以选择阻塞当前线程 park unpark")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"}")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"//释放锁的姿势")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// 如果释放锁成功")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," ("),t("span",{style:{color:"#6F42C1"}},"tryRelease"),t("span",{style:{color:"#24292E"}},"(arg)) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6A737D"}},"// 让阻塞线程恢复运行")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"}")])])])],-1),uo={id:"实现不可重入锁",tabindex:"-1"},Ao=t("p",null,"自定义同步器+自定义锁",-1),Do=t("div",{class:"language-java"},[t("button",{title:"Copy Code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki github-dark vp-code-dark"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"import"),t("span",{style:{color:"#E1E4E8"}}," java.util.concurrent.TimeUnit;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"import"),t("span",{style:{color:"#E1E4E8"}}," java.util.concurrent.locks.AbstractQueuedSynchronizer;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"import"),t("span",{style:{color:"#E1E4E8"}}," java.util.concurrent.locks.Condition;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"import"),t("span",{style:{color:"#E1E4E8"}}," java.util.concurrent.locks.Lock;")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"@"),t("span",{style:{color:"#F97583"}},"Slf4j"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#79B8FF"}},"topic"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#9ECBFF"}},'"c.TestAqs"'),t("span",{style:{color:"#E1E4E8"}},")")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"public"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"class"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"TestAqs"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"public"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"static"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"void"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"main"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#F97583"}},"String"),t("span",{style:{color:"#E1E4E8"}},"[] "),t("span",{style:{color:"#FFAB70"}},"args"),t("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        MyLock lock "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"new"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"MyLock"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"new"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"Thread"),t("span",{style:{color:"#E1E4E8"}},"(() "),t("span",{style:{color:"#F97583"}},"->"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            lock."),t("span",{style:{color:"#B392F0"}},"lock"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"try"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                log."),t("span",{style:{color:"#B392F0"}},"debug"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#9ECBFF"}},'"locking..."'),t("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#B392F0"}},"sleep"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#79B8FF"}},"1"),t("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            } "),t("span",{style:{color:"#F97583"}},"finally"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                log."),t("span",{style:{color:"#B392F0"}},"debug"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#9ECBFF"}},'"unlocking..."'),t("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                lock."),t("span",{style:{color:"#B392F0"}},"unlock"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        },"),t("span",{style:{color:"#9ECBFF"}},'"t1"'),t("span",{style:{color:"#E1E4E8"}},")."),t("span",{style:{color:"#B392F0"}},"start"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"new"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"Thread"),t("span",{style:{color:"#E1E4E8"}},"(() "),t("span",{style:{color:"#F97583"}},"->"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            lock."),t("span",{style:{color:"#B392F0"}},"lock"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"try"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                log."),t("span",{style:{color:"#B392F0"}},"debug"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#9ECBFF"}},'"locking..."'),t("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            } "),t("span",{style:{color:"#F97583"}},"finally"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                log."),t("span",{style:{color:"#B392F0"}},"debug"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#9ECBFF"}},'"unlocking..."'),t("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                lock."),t("span",{style:{color:"#B392F0"}},"unlock"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        },"),t("span",{style:{color:"#9ECBFF"}},'"t2"'),t("span",{style:{color:"#E1E4E8"}},")."),t("span",{style:{color:"#B392F0"}},"start"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"}")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// 自定义锁（不可重入锁）")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"class"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"MyLock"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"implements"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"Lock"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// 独占锁  同步器类")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"class"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"MySync"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"extends"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"AbstractQueuedSynchronizer"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        @"),t("span",{style:{color:"#F97583"}},"Override")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"protected"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"boolean"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"tryAcquire"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#FFAB70"}},"arg"),t("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#B392F0"}},"compareAndSetState"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#79B8FF"}},"0"),t("span",{style:{color:"#E1E4E8"}},", "),t("span",{style:{color:"#79B8FF"}},"1"),t("span",{style:{color:"#E1E4E8"}},")) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#6A737D"}},"// 加上了锁，并设置 owner 为当前线程")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#B392F0"}},"setExclusiveOwnerThread"),t("span",{style:{color:"#E1E4E8"}},"(Thread."),t("span",{style:{color:"#B392F0"}},"currentThread"),t("span",{style:{color:"#E1E4E8"}},"());")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#F97583"}},"return"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"true"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"return"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"false"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        }")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        @"),t("span",{style:{color:"#F97583"}},"Override")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"protected"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"boolean"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"tryRelease"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#FFAB70"}},"arg"),t("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#B392F0"}},"setExclusiveOwnerThread"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#79B8FF"}},"null"),t("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#6A737D"}},"//volatile写放到最后，写屏障才有效")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#B392F0"}},"setState"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#79B8FF"}},"0"),t("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"return"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"true"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        }")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        @"),t("span",{style:{color:"#F97583"}},"Override"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#6A737D"}},"// 是否持有独占锁")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"protected"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"boolean"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"isHeldExclusively"),t("span",{style:{color:"#E1E4E8"}},"() {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"return"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"getState"),t("span",{style:{color:"#E1E4E8"}},"() "),t("span",{style:{color:"#F97583"}},"=="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"1"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        }")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"public"),t("span",{style:{color:"#E1E4E8"}}," Condition "),t("span",{style:{color:"#B392F0"}},"newCondition"),t("span",{style:{color:"#E1E4E8"}},"() {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"return"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"new"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"ConditionObject"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"private"),t("span",{style:{color:"#E1E4E8"}}," MySync sync "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"new"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"MySync"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    @"),t("span",{style:{color:"#F97583"}},"Override"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#6A737D"}},"// 加锁（不成功会进入等待队列）")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"public"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"void"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"lock"),t("span",{style:{color:"#E1E4E8"}},"() {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        sync."),t("span",{style:{color:"#B392F0"}},"acquire"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#79B8FF"}},"1"),t("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    @"),t("span",{style:{color:"#F97583"}},"Override"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#6A737D"}},"// 加锁，可打断")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"public"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"void"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"lockInterruptibly"),t("span",{style:{color:"#E1E4E8"}},"() "),t("span",{style:{color:"#F97583"}},"throws"),t("span",{style:{color:"#E1E4E8"}}," InterruptedException {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        sync."),t("span",{style:{color:"#B392F0"}},"acquireInterruptibly"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#79B8FF"}},"1"),t("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    @"),t("span",{style:{color:"#F97583"}},"Override"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#6A737D"}},"// 尝试加锁（一次）")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"public"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"boolean"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"tryLock"),t("span",{style:{color:"#E1E4E8"}},"() {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"return"),t("span",{style:{color:"#E1E4E8"}}," sync."),t("span",{style:{color:"#B392F0"}},"tryAcquire"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#79B8FF"}},"1"),t("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    @"),t("span",{style:{color:"#F97583"}},"Override"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#6A737D"}},"// 尝试加锁，带超时")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"public"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"boolean"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"tryLock"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#F97583"}},"long"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#FFAB70"}},"time"),t("span",{style:{color:"#E1E4E8"}},", TimeUnit "),t("span",{style:{color:"#FFAB70"}},"unit"),t("span",{style:{color:"#E1E4E8"}},") "),t("span",{style:{color:"#F97583"}},"throws"),t("span",{style:{color:"#E1E4E8"}}," InterruptedException {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"return"),t("span",{style:{color:"#E1E4E8"}}," sync."),t("span",{style:{color:"#B392F0"}},"tryAcquireNanos"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#79B8FF"}},"1"),t("span",{style:{color:"#E1E4E8"}},", unit."),t("span",{style:{color:"#B392F0"}},"toNanos"),t("span",{style:{color:"#E1E4E8"}},"(time));")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    @"),t("span",{style:{color:"#F97583"}},"Override"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#6A737D"}},"// 解锁")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"public"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"void"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"unlock"),t("span",{style:{color:"#E1E4E8"}},"() {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        sync."),t("span",{style:{color:"#B392F0"}},"release"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#79B8FF"}},"1"),t("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    @"),t("span",{style:{color:"#F97583"}},"Override"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#6A737D"}},"// 创建条件变量")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"public"),t("span",{style:{color:"#E1E4E8"}}," Condition "),t("span",{style:{color:"#B392F0"}},"newCondition"),t("span",{style:{color:"#E1E4E8"}},"() {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"return"),t("span",{style:{color:"#E1E4E8"}}," sync."),t("span",{style:{color:"#B392F0"}},"newCondition"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"}")])])]),t("pre",{class:"shiki github-light vp-code-light"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"import"),t("span",{style:{color:"#24292E"}}," java.util.concurrent.TimeUnit;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"import"),t("span",{style:{color:"#24292E"}}," java.util.concurrent.locks.AbstractQueuedSynchronizer;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"import"),t("span",{style:{color:"#24292E"}}," java.util.concurrent.locks.Condition;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"import"),t("span",{style:{color:"#24292E"}}," java.util.concurrent.locks.Lock;")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"@"),t("span",{style:{color:"#D73A49"}},"Slf4j"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#005CC5"}},"topic"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#032F62"}},'"c.TestAqs"'),t("span",{style:{color:"#24292E"}},")")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"public"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"class"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"TestAqs"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"public"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"static"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"void"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"main"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#D73A49"}},"String"),t("span",{style:{color:"#24292E"}},"[] "),t("span",{style:{color:"#E36209"}},"args"),t("span",{style:{color:"#24292E"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        MyLock lock "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"new"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"MyLock"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"new"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"Thread"),t("span",{style:{color:"#24292E"}},"(() "),t("span",{style:{color:"#D73A49"}},"->"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            lock."),t("span",{style:{color:"#6F42C1"}},"lock"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"try"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                log."),t("span",{style:{color:"#6F42C1"}},"debug"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#032F62"}},'"locking..."'),t("span",{style:{color:"#24292E"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#6F42C1"}},"sleep"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#005CC5"}},"1"),t("span",{style:{color:"#24292E"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            } "),t("span",{style:{color:"#D73A49"}},"finally"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                log."),t("span",{style:{color:"#6F42C1"}},"debug"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#032F62"}},'"unlocking..."'),t("span",{style:{color:"#24292E"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                lock."),t("span",{style:{color:"#6F42C1"}},"unlock"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        },"),t("span",{style:{color:"#032F62"}},'"t1"'),t("span",{style:{color:"#24292E"}},")."),t("span",{style:{color:"#6F42C1"}},"start"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"new"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"Thread"),t("span",{style:{color:"#24292E"}},"(() "),t("span",{style:{color:"#D73A49"}},"->"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            lock."),t("span",{style:{color:"#6F42C1"}},"lock"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"try"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                log."),t("span",{style:{color:"#6F42C1"}},"debug"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#032F62"}},'"locking..."'),t("span",{style:{color:"#24292E"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            } "),t("span",{style:{color:"#D73A49"}},"finally"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                log."),t("span",{style:{color:"#6F42C1"}},"debug"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#032F62"}},'"unlocking..."'),t("span",{style:{color:"#24292E"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                lock."),t("span",{style:{color:"#6F42C1"}},"unlock"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        },"),t("span",{style:{color:"#032F62"}},'"t2"'),t("span",{style:{color:"#24292E"}},")."),t("span",{style:{color:"#6F42C1"}},"start"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"}")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// 自定义锁（不可重入锁）")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"class"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"MyLock"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"implements"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"Lock"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// 独占锁  同步器类")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"class"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"MySync"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"extends"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"AbstractQueuedSynchronizer"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        @"),t("span",{style:{color:"#D73A49"}},"Override")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"protected"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"boolean"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"tryAcquire"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#E36209"}},"arg"),t("span",{style:{color:"#24292E"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#6F42C1"}},"compareAndSetState"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#005CC5"}},"0"),t("span",{style:{color:"#24292E"}},", "),t("span",{style:{color:"#005CC5"}},"1"),t("span",{style:{color:"#24292E"}},")) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#6A737D"}},"// 加上了锁，并设置 owner 为当前线程")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#6F42C1"}},"setExclusiveOwnerThread"),t("span",{style:{color:"#24292E"}},"(Thread."),t("span",{style:{color:"#6F42C1"}},"currentThread"),t("span",{style:{color:"#24292E"}},"());")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#D73A49"}},"return"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"true"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"return"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"false"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        }")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        @"),t("span",{style:{color:"#D73A49"}},"Override")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"protected"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"boolean"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"tryRelease"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#E36209"}},"arg"),t("span",{style:{color:"#24292E"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#6F42C1"}},"setExclusiveOwnerThread"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#005CC5"}},"null"),t("span",{style:{color:"#24292E"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#6A737D"}},"//volatile写放到最后，写屏障才有效")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#6F42C1"}},"setState"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#005CC5"}},"0"),t("span",{style:{color:"#24292E"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"return"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"true"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        }")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        @"),t("span",{style:{color:"#D73A49"}},"Override"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6A737D"}},"// 是否持有独占锁")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"protected"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"boolean"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"isHeldExclusively"),t("span",{style:{color:"#24292E"}},"() {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"return"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"getState"),t("span",{style:{color:"#24292E"}},"() "),t("span",{style:{color:"#D73A49"}},"=="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"1"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        }")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"public"),t("span",{style:{color:"#24292E"}}," Condition "),t("span",{style:{color:"#6F42C1"}},"newCondition"),t("span",{style:{color:"#24292E"}},"() {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"return"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"new"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"ConditionObject"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    }")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"private"),t("span",{style:{color:"#24292E"}}," MySync sync "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"new"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"MySync"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    @"),t("span",{style:{color:"#D73A49"}},"Override"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6A737D"}},"// 加锁（不成功会进入等待队列）")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"public"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"void"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"lock"),t("span",{style:{color:"#24292E"}},"() {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        sync."),t("span",{style:{color:"#6F42C1"}},"acquire"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#005CC5"}},"1"),t("span",{style:{color:"#24292E"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    }")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    @"),t("span",{style:{color:"#D73A49"}},"Override"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6A737D"}},"// 加锁，可打断")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"public"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"void"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"lockInterruptibly"),t("span",{style:{color:"#24292E"}},"() "),t("span",{style:{color:"#D73A49"}},"throws"),t("span",{style:{color:"#24292E"}}," InterruptedException {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        sync."),t("span",{style:{color:"#6F42C1"}},"acquireInterruptibly"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#005CC5"}},"1"),t("span",{style:{color:"#24292E"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    }")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    @"),t("span",{style:{color:"#D73A49"}},"Override"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6A737D"}},"// 尝试加锁（一次）")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"public"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"boolean"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"tryLock"),t("span",{style:{color:"#24292E"}},"() {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"return"),t("span",{style:{color:"#24292E"}}," sync."),t("span",{style:{color:"#6F42C1"}},"tryAcquire"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#005CC5"}},"1"),t("span",{style:{color:"#24292E"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    }")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    @"),t("span",{style:{color:"#D73A49"}},"Override"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6A737D"}},"// 尝试加锁，带超时")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"public"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"boolean"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"tryLock"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#D73A49"}},"long"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#E36209"}},"time"),t("span",{style:{color:"#24292E"}},", TimeUnit "),t("span",{style:{color:"#E36209"}},"unit"),t("span",{style:{color:"#24292E"}},") "),t("span",{style:{color:"#D73A49"}},"throws"),t("span",{style:{color:"#24292E"}}," InterruptedException {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"return"),t("span",{style:{color:"#24292E"}}," sync."),t("span",{style:{color:"#6F42C1"}},"tryAcquireNanos"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#005CC5"}},"1"),t("span",{style:{color:"#24292E"}},", unit."),t("span",{style:{color:"#6F42C1"}},"toNanos"),t("span",{style:{color:"#24292E"}},"(time));")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    }")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    @"),t("span",{style:{color:"#D73A49"}},"Override"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6A737D"}},"// 解锁")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"public"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"void"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"unlock"),t("span",{style:{color:"#24292E"}},"() {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        sync."),t("span",{style:{color:"#6F42C1"}},"release"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#005CC5"}},"1"),t("span",{style:{color:"#24292E"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    }")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    @"),t("span",{style:{color:"#D73A49"}},"Override"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6A737D"}},"// 创建条件变量")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"public"),t("span",{style:{color:"#24292E"}}," Condition "),t("span",{style:{color:"#6F42C1"}},"newCondition"),t("span",{style:{color:"#24292E"}},"() {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"return"),t("span",{style:{color:"#24292E"}}," sync."),t("span",{style:{color:"#6F42C1"}},"newCondition"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"}")])])])],-1),Co=t("figure",null,[t("img",{src:"https://jsd.cdn.zzko.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230719154757320.png",alt:"image-20230719154757320",loading:"lazy",decoding:"async"})],-1),ho={id:"aqs-的并发工具类",tabindex:"-1"},go=t("figure",null,[t("img",{src:"https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230719155113602.png",alt:"image-20230719155113602",loading:"lazy",decoding:"async"})],-1),Bo={id:"_2、reentrantlock-原理",tabindex:"-1"},fo=t("p",null,"可以看到ReentrantLock提供了两个同步器，实现公平锁和非公平锁，默认是非公平锁！",-1),ko=t("figure",null,[t("img",{src:"https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230719155304730.png",alt:"image-20230719155304730",loading:"lazy",decoding:"async"})],-1),bo={id:"非公平锁实现原理",tabindex:"-1"},mo={id:"加锁解锁流程",tabindex:"-1"},So=t("p",null,"先从构造器开始看，默认为非公平锁实现",-1),vo=t("div",{class:"language-java"},[t("button",{title:"Copy Code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki github-dark vp-code-dark"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"public"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"ReentrantLock"),t("span",{style:{color:"#E1E4E8"}},"() {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}}," sync "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"new"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"NonfairSync"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"}")])])]),t("pre",{class:"shiki github-light vp-code-light"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"public"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"ReentrantLock"),t("span",{style:{color:"#24292E"}},"() {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}}," sync "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"new"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"NonfairSync"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"}")])])])],-1),wo=t("p",null,"NonfairSync 继承自 AQS",-1),To=t("p",null,"没有竞争时",-1),xo=t("figure",null,[t("img",{src:"https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230719155415862.png",alt:"image-20230719155415862",loading:"lazy",decoding:"async"})],-1),No=t("p",null,"第一个竞争出现时",-1),Io=t("figure",null,[t("img",{src:"https://jsd.cdn.zzko.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230719155428092.png",alt:"image-20230719155428092",loading:"lazy",decoding:"async"})],-1),Lo=t("p",null,"Thread-1 执行了",-1),jo=t("ol",null,[t("li",null,"lock方法中CAS 尝试将 state 由 0 改为 1，结果失败"),t("li",null,"lock方法中进一步调用acquire方法，进入 tryAcquire 逻辑，这里我们认为这时 state 已经是1，结果仍然失败"),t("li",null,[p("接下来进入 acquire方法的addWaiter 逻辑，构造 Node 队列 "),t("ul",null,[t("li",null,"图中黄色三角表示该 Node 的 waitStatus 状态，其中 0 为默认正常状态"),t("li",null,"Node 的创建是懒惰的"),t("li",null,"其中第一个 Node 称为 Dummy（哑元）或哨兵，用来占位，并不关联线程")])])],-1),Ro=t("figure",null,[t("img",{src:"https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230719155452096.png",alt:"image-20230719155452096",loading:"lazy",decoding:"async"})],-1),Oo=t("p",null,"当前线程进入 acquire方法的 acquireQueued 逻辑",-1),qo=t("ol",null,[t("li",null,"acquireQueued 会在一个死循环中不断尝试获得锁，失败后进入 park 阻塞"),t("li",null,"如果自己是紧邻着 head（排第二位），那么再次 tryAcquire 尝试获取锁，当然这时 state 仍为 1，失败"),t("li",null,"进入 shouldParkAfterFailedAcquire 逻辑，将前驱 node，即 head 的 waitStatus 改为 -1，这次返回 false")],-1),Po=t("figure",null,[t("img",{src:"https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230719155516878.png",alt:"image-20230719155516878",loading:"lazy",decoding:"async"})],-1),zo=t("ol",null,[t("li",null,"shouldParkAfterFailedAcquire 执行完毕回到 acquireQueued ，再次 tryAcquire 尝试获取锁，当然这时 state 仍为 1，失败"),t("li",null,"当再次进入 shouldParkAfterFailedAcquire 时，这时因为其前驱 node 的 waitStatus 已经是 -1，这次返回 true"),t("li",null,"进入 parkAndCheckInterrupt， Thread-1 park（灰色表示已经阻塞）")],-1),_o=t("figure",null,[t("img",{src:"https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230719155528402.png",alt:"image-20230719155528402",loading:"lazy",decoding:"async"})],-1),Ko=t("p",null,"再次有多个线程经历上述过程竞争失败，变成这个样子",-1),Vo=t("figure",null,[t("img",{src:"https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230719155542494.png",alt:"image-20230719155542494",loading:"lazy",decoding:"async"})],-1),Mo=t("p",null,[p("Thread-0 调用unlock方法里的release方法释放锁，进入tryRelease(使用ctrl+alt+b查看tryRelease方法的具体"),t("code",null,"ReentrantLock"),p("实现) 流程，如果成功，设置 exclusiveOwnerThread 为 null，state = 0")],-1),Wo=t("figure",null,[t("img",{src:"https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230719155652604.png",alt:"image-20230719155652604",loading:"lazy",decoding:"async"})],-1),Uo=t("p",null,"unlock方法里的release方法方法中，如果当前队列不为 null，并且 head 的 waitStatus = -1，进入 unparkSuccessor 流程： unparkSuccessor中会找到队列中离 head 最近的一个 Node（没取消的），unpark 恢复其运行，本例中即为 Thread-1 回到 Thread-1 的 acquireQueued 流程",-1),Qo=t("figure",null,[t("img",{src:"https://jsd.cdn.zzko.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230719155754206.png",alt:"image-20230719155754206",loading:"lazy",decoding:"async"})],-1),Ho=t("p",null,"如果加锁成功（没有竞争），会设置 （acquireQueued 方法中）",-1),Go=t("ol",null,[t("li",null,"exclusiveOwnerThread 为 Thread-1，state = 1"),t("li",null,"head 指向刚刚 Thread-1 所在的 Node，该 Node 清空 Thread"),t("li",null,"原本的 head 因为从链表断开，而可被垃圾回收")],-1),Jo=t("p",null,"如果这时候有其它线程来竞争（非公平的体现），例如这时有 Thread-4 来了",-1),Yo=t("figure",null,[t("img",{src:"https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230719155831915.png",alt:"image-20230719155831915",loading:"lazy",decoding:"async"})],-1),Xo=t("p",null,"如果不巧又被 Thread-4 占了先",-1),Zo=t("ol",null,[t("li",null,"Thread-4 被设置为 exclusiveOwnerThread，state = 1"),t("li",null,"Thread-1 再次进入 acquireQueued 流程，获取锁失败，重新进入 park 阻塞")],-1),$o={id:"加锁源码",tabindex:"-1"},sn=t("div",{class:"language-java"},[t("button",{title:"Copy Code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki github-dark vp-code-dark"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// Sync 继承自 AQS")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"static"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"final"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"class"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"NonfairSync"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"extends"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"Sync"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"private"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"static"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"final"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"long"),t("span",{style:{color:"#E1E4E8"}}," serialVersionUID "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"7316153563782823691L"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"     "),t("span",{style:{color:"#6A737D"}},"// 加锁实现")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"final"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"void"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"lock"),t("span",{style:{color:"#E1E4E8"}},"() {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#6A737D"}},"// 首先用 cas 尝试（仅尝试一次）将 state 从 0 改为 1, 如果成功表示获得了独占锁")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," ("),t("span",{style:{color:"#B392F0"}},"compareAndSetState"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#79B8FF"}},"0"),t("span",{style:{color:"#E1E4E8"}},", "),t("span",{style:{color:"#79B8FF"}},"1"),t("span",{style:{color:"#E1E4E8"}},"))")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#B392F0"}},"setExclusiveOwnerThread"),t("span",{style:{color:"#E1E4E8"}},"(Thread."),t("span",{style:{color:"#B392F0"}},"currentThread"),t("span",{style:{color:"#E1E4E8"}},"());")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"else")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#6A737D"}},"// 如果尝试失败，进入 ㈠")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#B392F0"}},"acquire"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#79B8FF"}},"1"),t("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// ㈠ AQS 继承过来的方法, 方便阅读, 放在此处")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"public"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"final"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"void"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"acquire"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#FFAB70"}},"arg"),t("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#6A737D"}},"// ㈡ tryAcquire")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#F97583"}},"!"),t("span",{style:{color:"#B392F0"}},"tryAcquire"),t("span",{style:{color:"#E1E4E8"}},"(arg) "),t("span",{style:{color:"#F97583"}},"&&")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            \t"),t("span",{style:{color:"#6A737D"}},"// 当 tryAcquire 返回为 false 时, 先调用 addWaiter ㈣, 接着 acquireQueued ㈤")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                 "),t("span",{style:{color:"#B392F0"}},"acquireQueued"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#B392F0"}},"addWaiter"),t("span",{style:{color:"#E1E4E8"}},"(Node.EXCLUSIVE), arg)")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        ) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#B392F0"}},"selfInterrupt"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// ㈡ 进入 ㈢")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"protected"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"final"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"boolean"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"tryAcquire"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#FFAB70"}},"acquires"),t("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"return"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"nonfairTryAcquire"),t("span",{style:{color:"#E1E4E8"}},"(acquires);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// ㈢ Sync 继承过来的方法, 方便阅读, 放在此处")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"final"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"boolean"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"nonfairTryAcquire"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#FFAB70"}},"acquires"),t("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"final"),t("span",{style:{color:"#E1E4E8"}}," Thread current "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," Thread."),t("span",{style:{color:"#B392F0"}},"currentThread"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," c "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"getState"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#6A737D"}},"// 如果还没有获得锁")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (c "),t("span",{style:{color:"#F97583"}},"=="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"0"),t("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#6A737D"}},"// 尝试用 cas 获得, 这里体现了非公平性: 不去检查 AQS 队列")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," ("),t("span",{style:{color:"#B392F0"}},"compareAndSetState"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#79B8FF"}},"0"),t("span",{style:{color:"#E1E4E8"}},", acquires)) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#B392F0"}},"setExclusiveOwnerThread"),t("span",{style:{color:"#E1E4E8"}},"(current);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#F97583"}},"return"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"true"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#6A737D"}},"// 如果已经获得了锁, 线程还是当前线程, 表示发生了锁重入")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"else"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (current "),t("span",{style:{color:"#F97583"}},"=="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"getExclusiveOwnerThread"),t("span",{style:{color:"#E1E4E8"}},"()) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#6A737D"}},"// state++")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," nextc "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," c "),t("span",{style:{color:"#F97583"}},"+"),t("span",{style:{color:"#E1E4E8"}}," acquires;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (nextc "),t("span",{style:{color:"#F97583"}},"<"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"0"),t("span",{style:{color:"#E1E4E8"}},") "),t("span",{style:{color:"#6A737D"}},"// overflow")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#F97583"}},"throw"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"new"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"Error"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#9ECBFF"}},'"Maximum lock count exceeded"'),t("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#B392F0"}},"setState"),t("span",{style:{color:"#E1E4E8"}},"(nextc);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"return"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"true"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#6A737D"}},"// 获取失败, 回到调用处")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"return"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"false"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// ㈣ AQS 继承过来的方法, 方便阅读, 放在此处")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"private"),t("span",{style:{color:"#E1E4E8"}}," Node "),t("span",{style:{color:"#B392F0"}},"addWaiter"),t("span",{style:{color:"#E1E4E8"}},"(Node "),t("span",{style:{color:"#FFAB70"}},"mode"),t("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// 将当前线程关联到一个 Node 对象上, 模式为独占模式，新建的Node的waitstatus默认为0，因为waitstatus是成员变量，默认被初始化为0")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        Node node "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"new"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"Node"),t("span",{style:{color:"#E1E4E8"}},"(Thread."),t("span",{style:{color:"#B392F0"}},"currentThread"),t("span",{style:{color:"#E1E4E8"}},"(), mode);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#6A737D"}},"// 如果 tail 不为 null, cas 尝试将 Node 对象加入 AQS 队列尾部")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        Node pred "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," tail;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (pred "),t("span",{style:{color:"#F97583"}},"!="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"null"),t("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            node.prev "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," pred;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," ("),t("span",{style:{color:"#B392F0"}},"compareAndSetTail"),t("span",{style:{color:"#E1E4E8"}},"(pred, node)) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#6A737D"}},"// 双向链表")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                pred.next "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," node;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#F97583"}},"return"),t("span",{style:{color:"#E1E4E8"}}," node;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#6A737D"}},"//如果tail为null，尝试将 Node 加入 AQS, 进入 ㈥")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#B392F0"}},"enq"),t("span",{style:{color:"#E1E4E8"}},"(node);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"return"),t("span",{style:{color:"#E1E4E8"}}," node;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// ㈥ AQS 继承过来的方法, 方便阅读, 放在此处")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"private"),t("span",{style:{color:"#E1E4E8"}}," Node "),t("span",{style:{color:"#B392F0"}},"enq"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#F97583"}},"final"),t("span",{style:{color:"#E1E4E8"}}," Node "),t("span",{style:{color:"#FFAB70"}},"node"),t("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"for"),t("span",{style:{color:"#E1E4E8"}}," (;;) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            Node t "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," tail;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (t "),t("span",{style:{color:"#F97583"}},"=="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"null"),t("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#6A737D"}},"// 还没有, 设置 head 为哨兵节点（不对应线程，状态为 0）")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," ("),t("span",{style:{color:"#B392F0"}},"compareAndSetHead"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#F97583"}},"new"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"Node"),t("span",{style:{color:"#E1E4E8"}},"())) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                    tail "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," head;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            } "),t("span",{style:{color:"#F97583"}},"else"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#6A737D"}},"// cas 尝试将 Node 对象加入 AQS 队列尾部")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                node.prev "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," t;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," ("),t("span",{style:{color:"#B392F0"}},"compareAndSetTail"),t("span",{style:{color:"#E1E4E8"}},"(t, node)) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                    t.next "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," node;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                    "),t("span",{style:{color:"#F97583"}},"return"),t("span",{style:{color:"#E1E4E8"}}," t;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// ㈤ AQS 继承过来的方法, 方便阅读, 放在此处")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"final"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"boolean"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"acquireQueued"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#F97583"}},"final"),t("span",{style:{color:"#E1E4E8"}}," Node "),t("span",{style:{color:"#FFAB70"}},"node"),t("span",{style:{color:"#E1E4E8"}},", "),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#FFAB70"}},"arg"),t("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"boolean"),t("span",{style:{color:"#E1E4E8"}}," failed "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"true"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"try"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"boolean"),t("span",{style:{color:"#E1E4E8"}}," interrupted "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"false"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"for"),t("span",{style:{color:"#E1E4E8"}}," (;;) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#F97583"}},"final"),t("span",{style:{color:"#E1E4E8"}}," Node p "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," node."),t("span",{style:{color:"#B392F0"}},"predecessor"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#6A737D"}},"// 上一个节点是 head, 表示轮到自己（当前线程对应的 node）了, 尝试获取")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (p "),t("span",{style:{color:"#F97583"}},"=="),t("span",{style:{color:"#E1E4E8"}}," head "),t("span",{style:{color:"#F97583"}},"&&"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"tryAcquire"),t("span",{style:{color:"#E1E4E8"}},"(arg)) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                    "),t("span",{style:{color:"#6A737D"}},"// 获取成功, 设置自己（当前线程对应的 node）为 head")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                    "),t("span",{style:{color:"#B392F0"}},"setHead"),t("span",{style:{color:"#E1E4E8"}},"(node);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                    "),t("span",{style:{color:"#6A737D"}},"// 上一个节点 help GC")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                    p.next "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"null"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                    failed "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"false"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                    "),t("span",{style:{color:"#6A737D"}},"// 返回中断标记 false")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                    "),t("span",{style:{color:"#F97583"}},"return"),t("span",{style:{color:"#E1E4E8"}}," interrupted;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                    "),t("span",{style:{color:"#6A737D"}},"// 判断是否应当 park, 进入 ㈦")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                    "),t("span",{style:{color:"#B392F0"}},"shouldParkAfterFailedAcquire"),t("span",{style:{color:"#E1E4E8"}},"(p, node) "),t("span",{style:{color:"#F97583"}},"&&")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                    "),t("span",{style:{color:"#6A737D"}},"// park 等待, 此时 Node 的状态被置为 Node.SIGNAL ㈧")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                    "),t("span",{style:{color:"#B392F0"}},"parkAndCheckInterrupt"),t("span",{style:{color:"#E1E4E8"}},"()")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                ) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                    interrupted "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"true"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        } "),t("span",{style:{color:"#F97583"}},"finally"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (failed)")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#B392F0"}},"cancelAcquire"),t("span",{style:{color:"#E1E4E8"}},"(node);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// ㈦ AQS 继承过来的方法, 方便阅读, 放在此处")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"private"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"static"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"boolean"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"shouldParkAfterFailedAcquire"),t("span",{style:{color:"#E1E4E8"}},"(Node "),t("span",{style:{color:"#FFAB70"}},"pred"),t("span",{style:{color:"#E1E4E8"}},", Node "),t("span",{style:{color:"#FFAB70"}},"node"),t("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#6A737D"}},"// 获取上一个节点的状态")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," ws "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," pred.waitStatus;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (ws "),t("span",{style:{color:"#F97583"}},"=="),t("span",{style:{color:"#E1E4E8"}}," Node.SIGNAL) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#6A737D"}},"// 上一个节点都在阻塞, 那么自己也阻塞好了")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"return"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"true"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#6A737D"}},"// > 0 表示取消状态")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (ws "),t("span",{style:{color:"#F97583"}},">"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"0"),t("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#6A737D"}},"// 上一个节点取消, 那么重构删除前面所有取消的节点, 返回到外层循环重试")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"do"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                node.prev "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," pred "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," pred.prev;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            } "),t("span",{style:{color:"#F97583"}},"while"),t("span",{style:{color:"#E1E4E8"}}," (pred.waitStatus "),t("span",{style:{color:"#F97583"}},">"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"0"),t("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            pred.next "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," node;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        } "),t("span",{style:{color:"#F97583"}},"else"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#6A737D"}},"// 这次还没有阻塞")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#6A737D"}},"// 但下次如果重试不成功, 则需要阻塞，这时需要设置上一个节点状态为 Node.SIGNAL")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#B392F0"}},"compareAndSetWaitStatus"),t("span",{style:{color:"#E1E4E8"}},"(pred, ws, Node.SIGNAL);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"return"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"false"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// ㈧ 阻塞当前线程")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"private"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"final"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"boolean"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"parkAndCheckInterrupt"),t("span",{style:{color:"#E1E4E8"}},"() {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        LockSupport."),t("span",{style:{color:"#B392F0"}},"park"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#79B8FF"}},"this"),t("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"return"),t("span",{style:{color:"#E1E4E8"}}," Thread."),t("span",{style:{color:"#B392F0"}},"interrupted"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"}")])])]),t("pre",{class:"shiki github-light vp-code-light"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// Sync 继承自 AQS")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"static"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"final"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"class"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"NonfairSync"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"extends"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"Sync"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"private"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"static"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"final"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"long"),t("span",{style:{color:"#24292E"}}," serialVersionUID "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"7316153563782823691L"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"     "),t("span",{style:{color:"#6A737D"}},"// 加锁实现")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"final"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"void"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"lock"),t("span",{style:{color:"#24292E"}},"() {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6A737D"}},"// 首先用 cas 尝试（仅尝试一次）将 state 从 0 改为 1, 如果成功表示获得了独占锁")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," ("),t("span",{style:{color:"#6F42C1"}},"compareAndSetState"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#005CC5"}},"0"),t("span",{style:{color:"#24292E"}},", "),t("span",{style:{color:"#005CC5"}},"1"),t("span",{style:{color:"#24292E"}},"))")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#6F42C1"}},"setExclusiveOwnerThread"),t("span",{style:{color:"#24292E"}},"(Thread."),t("span",{style:{color:"#6F42C1"}},"currentThread"),t("span",{style:{color:"#24292E"}},"());")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"else")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#6A737D"}},"// 如果尝试失败，进入 ㈠")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#6F42C1"}},"acquire"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#005CC5"}},"1"),t("span",{style:{color:"#24292E"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    }")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// ㈠ AQS 继承过来的方法, 方便阅读, 放在此处")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"public"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"final"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"void"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"acquire"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#E36209"}},"arg"),t("span",{style:{color:"#24292E"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6A737D"}},"// ㈡ tryAcquire")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#D73A49"}},"!"),t("span",{style:{color:"#6F42C1"}},"tryAcquire"),t("span",{style:{color:"#24292E"}},"(arg) "),t("span",{style:{color:"#D73A49"}},"&&")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            \t"),t("span",{style:{color:"#6A737D"}},"// 当 tryAcquire 返回为 false 时, 先调用 addWaiter ㈣, 接着 acquireQueued ㈤")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                 "),t("span",{style:{color:"#6F42C1"}},"acquireQueued"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#6F42C1"}},"addWaiter"),t("span",{style:{color:"#24292E"}},"(Node.EXCLUSIVE), arg)")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        ) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#6F42C1"}},"selfInterrupt"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    }")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// ㈡ 进入 ㈢")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"protected"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"final"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"boolean"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"tryAcquire"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#E36209"}},"acquires"),t("span",{style:{color:"#24292E"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"return"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"nonfairTryAcquire"),t("span",{style:{color:"#24292E"}},"(acquires);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    }")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// ㈢ Sync 继承过来的方法, 方便阅读, 放在此处")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"final"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"boolean"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"nonfairTryAcquire"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#E36209"}},"acquires"),t("span",{style:{color:"#24292E"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"final"),t("span",{style:{color:"#24292E"}}," Thread current "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," Thread."),t("span",{style:{color:"#6F42C1"}},"currentThread"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," c "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"getState"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6A737D"}},"// 如果还没有获得锁")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (c "),t("span",{style:{color:"#D73A49"}},"=="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"0"),t("span",{style:{color:"#24292E"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#6A737D"}},"// 尝试用 cas 获得, 这里体现了非公平性: 不去检查 AQS 队列")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," ("),t("span",{style:{color:"#6F42C1"}},"compareAndSetState"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#005CC5"}},"0"),t("span",{style:{color:"#24292E"}},", acquires)) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#6F42C1"}},"setExclusiveOwnerThread"),t("span",{style:{color:"#24292E"}},"(current);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#D73A49"}},"return"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"true"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6A737D"}},"// 如果已经获得了锁, 线程还是当前线程, 表示发生了锁重入")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"else"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (current "),t("span",{style:{color:"#D73A49"}},"=="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"getExclusiveOwnerThread"),t("span",{style:{color:"#24292E"}},"()) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#6A737D"}},"// state++")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," nextc "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," c "),t("span",{style:{color:"#D73A49"}},"+"),t("span",{style:{color:"#24292E"}}," acquires;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (nextc "),t("span",{style:{color:"#D73A49"}},"<"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"0"),t("span",{style:{color:"#24292E"}},") "),t("span",{style:{color:"#6A737D"}},"// overflow")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#D73A49"}},"throw"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"new"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"Error"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#032F62"}},'"Maximum lock count exceeded"'),t("span",{style:{color:"#24292E"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#6F42C1"}},"setState"),t("span",{style:{color:"#24292E"}},"(nextc);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"return"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"true"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6A737D"}},"// 获取失败, 回到调用处")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"return"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"false"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    }")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// ㈣ AQS 继承过来的方法, 方便阅读, 放在此处")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"private"),t("span",{style:{color:"#24292E"}}," Node "),t("span",{style:{color:"#6F42C1"}},"addWaiter"),t("span",{style:{color:"#24292E"}},"(Node "),t("span",{style:{color:"#E36209"}},"mode"),t("span",{style:{color:"#24292E"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// 将当前线程关联到一个 Node 对象上, 模式为独占模式，新建的Node的waitstatus默认为0，因为waitstatus是成员变量，默认被初始化为0")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        Node node "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"new"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"Node"),t("span",{style:{color:"#24292E"}},"(Thread."),t("span",{style:{color:"#6F42C1"}},"currentThread"),t("span",{style:{color:"#24292E"}},"(), mode);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6A737D"}},"// 如果 tail 不为 null, cas 尝试将 Node 对象加入 AQS 队列尾部")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        Node pred "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," tail;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (pred "),t("span",{style:{color:"#D73A49"}},"!="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"null"),t("span",{style:{color:"#24292E"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            node.prev "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," pred;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," ("),t("span",{style:{color:"#6F42C1"}},"compareAndSetTail"),t("span",{style:{color:"#24292E"}},"(pred, node)) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#6A737D"}},"// 双向链表")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                pred.next "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," node;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#D73A49"}},"return"),t("span",{style:{color:"#24292E"}}," node;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6A737D"}},"//如果tail为null，尝试将 Node 加入 AQS, 进入 ㈥")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6F42C1"}},"enq"),t("span",{style:{color:"#24292E"}},"(node);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"return"),t("span",{style:{color:"#24292E"}}," node;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    }")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// ㈥ AQS 继承过来的方法, 方便阅读, 放在此处")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"private"),t("span",{style:{color:"#24292E"}}," Node "),t("span",{style:{color:"#6F42C1"}},"enq"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#D73A49"}},"final"),t("span",{style:{color:"#24292E"}}," Node "),t("span",{style:{color:"#E36209"}},"node"),t("span",{style:{color:"#24292E"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"for"),t("span",{style:{color:"#24292E"}}," (;;) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            Node t "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," tail;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (t "),t("span",{style:{color:"#D73A49"}},"=="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"null"),t("span",{style:{color:"#24292E"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#6A737D"}},"// 还没有, 设置 head 为哨兵节点（不对应线程，状态为 0）")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," ("),t("span",{style:{color:"#6F42C1"}},"compareAndSetHead"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#D73A49"}},"new"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"Node"),t("span",{style:{color:"#24292E"}},"())) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                    tail "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," head;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            } "),t("span",{style:{color:"#D73A49"}},"else"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#6A737D"}},"// cas 尝试将 Node 对象加入 AQS 队列尾部")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                node.prev "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," t;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," ("),t("span",{style:{color:"#6F42C1"}},"compareAndSetTail"),t("span",{style:{color:"#24292E"}},"(t, node)) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                    t.next "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," node;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                    "),t("span",{style:{color:"#D73A49"}},"return"),t("span",{style:{color:"#24292E"}}," t;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    }")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// ㈤ AQS 继承过来的方法, 方便阅读, 放在此处")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"final"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"boolean"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"acquireQueued"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#D73A49"}},"final"),t("span",{style:{color:"#24292E"}}," Node "),t("span",{style:{color:"#E36209"}},"node"),t("span",{style:{color:"#24292E"}},", "),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#E36209"}},"arg"),t("span",{style:{color:"#24292E"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"boolean"),t("span",{style:{color:"#24292E"}}," failed "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"true"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"try"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"boolean"),t("span",{style:{color:"#24292E"}}," interrupted "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"false"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"for"),t("span",{style:{color:"#24292E"}}," (;;) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#D73A49"}},"final"),t("span",{style:{color:"#24292E"}}," Node p "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," node."),t("span",{style:{color:"#6F42C1"}},"predecessor"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#6A737D"}},"// 上一个节点是 head, 表示轮到自己（当前线程对应的 node）了, 尝试获取")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (p "),t("span",{style:{color:"#D73A49"}},"=="),t("span",{style:{color:"#24292E"}}," head "),t("span",{style:{color:"#D73A49"}},"&&"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"tryAcquire"),t("span",{style:{color:"#24292E"}},"(arg)) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                    "),t("span",{style:{color:"#6A737D"}},"// 获取成功, 设置自己（当前线程对应的 node）为 head")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                    "),t("span",{style:{color:"#6F42C1"}},"setHead"),t("span",{style:{color:"#24292E"}},"(node);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                    "),t("span",{style:{color:"#6A737D"}},"// 上一个节点 help GC")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                    p.next "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"null"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                    failed "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"false"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                    "),t("span",{style:{color:"#6A737D"}},"// 返回中断标记 false")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                    "),t("span",{style:{color:"#D73A49"}},"return"),t("span",{style:{color:"#24292E"}}," interrupted;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                    "),t("span",{style:{color:"#6A737D"}},"// 判断是否应当 park, 进入 ㈦")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                    "),t("span",{style:{color:"#6F42C1"}},"shouldParkAfterFailedAcquire"),t("span",{style:{color:"#24292E"}},"(p, node) "),t("span",{style:{color:"#D73A49"}},"&&")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                    "),t("span",{style:{color:"#6A737D"}},"// park 等待, 此时 Node 的状态被置为 Node.SIGNAL ㈧")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                    "),t("span",{style:{color:"#6F42C1"}},"parkAndCheckInterrupt"),t("span",{style:{color:"#24292E"}},"()")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                ) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                    interrupted "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"true"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        } "),t("span",{style:{color:"#D73A49"}},"finally"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (failed)")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#6F42C1"}},"cancelAcquire"),t("span",{style:{color:"#24292E"}},"(node);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    }")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// ㈦ AQS 继承过来的方法, 方便阅读, 放在此处")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"private"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"static"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"boolean"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"shouldParkAfterFailedAcquire"),t("span",{style:{color:"#24292E"}},"(Node "),t("span",{style:{color:"#E36209"}},"pred"),t("span",{style:{color:"#24292E"}},", Node "),t("span",{style:{color:"#E36209"}},"node"),t("span",{style:{color:"#24292E"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6A737D"}},"// 获取上一个节点的状态")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," ws "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," pred.waitStatus;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (ws "),t("span",{style:{color:"#D73A49"}},"=="),t("span",{style:{color:"#24292E"}}," Node.SIGNAL) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#6A737D"}},"// 上一个节点都在阻塞, 那么自己也阻塞好了")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"return"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"true"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6A737D"}},"// > 0 表示取消状态")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (ws "),t("span",{style:{color:"#D73A49"}},">"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"0"),t("span",{style:{color:"#24292E"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#6A737D"}},"// 上一个节点取消, 那么重构删除前面所有取消的节点, 返回到外层循环重试")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"do"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                node.prev "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," pred "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," pred.prev;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            } "),t("span",{style:{color:"#D73A49"}},"while"),t("span",{style:{color:"#24292E"}}," (pred.waitStatus "),t("span",{style:{color:"#D73A49"}},">"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"0"),t("span",{style:{color:"#24292E"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            pred.next "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," node;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        } "),t("span",{style:{color:"#D73A49"}},"else"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#6A737D"}},"// 这次还没有阻塞")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#6A737D"}},"// 但下次如果重试不成功, 则需要阻塞，这时需要设置上一个节点状态为 Node.SIGNAL")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#6F42C1"}},"compareAndSetWaitStatus"),t("span",{style:{color:"#24292E"}},"(pred, ws, Node.SIGNAL);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"return"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"false"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    }")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// ㈧ 阻塞当前线程")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"private"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"final"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"boolean"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"parkAndCheckInterrupt"),t("span",{style:{color:"#24292E"}},"() {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        LockSupport."),t("span",{style:{color:"#6F42C1"}},"park"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#005CC5"}},"this"),t("span",{style:{color:"#24292E"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"return"),t("span",{style:{color:"#24292E"}}," Thread."),t("span",{style:{color:"#6F42C1"}},"interrupted"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"}")])])])],-1),ln=t("blockquote",null,[t("p",null,[t("strong",null,"注意"),p(" 是否需要 unpark 是由当前节点的前驱节点的 "),t("code",null,"waitStatus == Node.SIGNAL"),p(" 来决定，而不是本节点的waitStatus 决定")])],-1),on={id:"解锁源码",tabindex:"-1"},nn=t("div",{class:"language-java"},[t("button",{title:"Copy Code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki github-dark vp-code-dark"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// Sync 继承自 AQS")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"static"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"final"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"class"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"NonfairSync"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"extends"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"Sync"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// 解锁实现")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"public"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"void"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"unlock"),t("span",{style:{color:"#E1E4E8"}},"() {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        sync."),t("span",{style:{color:"#B392F0"}},"release"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#79B8FF"}},"1"),t("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// AQS 继承过来的方法, 方便阅读, 放在此处")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"public"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"final"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"boolean"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"release"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#FFAB70"}},"arg"),t("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#6A737D"}},"// 尝试释放锁, 进入 ㈠")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," ("),t("span",{style:{color:"#B392F0"}},"tryRelease"),t("span",{style:{color:"#E1E4E8"}},"(arg)) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#6A737D"}},"// 队列头节点 unpark")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            Node h "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," head;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#6A737D"}},"// 队列不为 null")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                h "),t("span",{style:{color:"#F97583"}},"!="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"null"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"&&")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#6A737D"}},"// waitStatus == Node.SIGNAL 才需要 unpark")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                h.waitStatus "),t("span",{style:{color:"#F97583"}},"!="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"0")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            ) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#6A737D"}},"// unpark AQS 中等待的线程, 进入 ㈡")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#B392F0"}},"unparkSuccessor"),t("span",{style:{color:"#E1E4E8"}},"(h);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"return"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"true"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"return"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"false"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// ㈠ Sync 继承过来的方法, 方便阅读, 放在此处")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"protected"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"final"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"boolean"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"tryRelease"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#FFAB70"}},"releases"),t("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#6A737D"}},"// state--")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," c "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"getState"),t("span",{style:{color:"#E1E4E8"}},"() "),t("span",{style:{color:"#F97583"}},"-"),t("span",{style:{color:"#E1E4E8"}}," releases;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (Thread."),t("span",{style:{color:"#B392F0"}},"currentThread"),t("span",{style:{color:"#E1E4E8"}},"() "),t("span",{style:{color:"#F97583"}},"!="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"getExclusiveOwnerThread"),t("span",{style:{color:"#E1E4E8"}},"())")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"throw"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"new"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"IllegalMonitorStateException"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"boolean"),t("span",{style:{color:"#E1E4E8"}}," free "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"false"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#6A737D"}},"// 支持锁重入, 只有 state 减为 0, 才释放成功")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (c "),t("span",{style:{color:"#F97583"}},"=="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"0"),t("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            free "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"true"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#B392F0"}},"setExclusiveOwnerThread"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#79B8FF"}},"null"),t("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#B392F0"}},"setState"),t("span",{style:{color:"#E1E4E8"}},"(c);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"return"),t("span",{style:{color:"#E1E4E8"}}," free;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// ㈡ AQS 继承过来的方法, 方便阅读, 放在此处")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"private"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"void"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"unparkSuccessor"),t("span",{style:{color:"#E1E4E8"}},"(Node "),t("span",{style:{color:"#FFAB70"}},"node"),t("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#6A737D"}},"// 如果状态为 Node.SIGNAL 尝试重置状态为 0, 如果线程获取到了锁那么后来头结点会被抛弃掉")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#6A737D"}},"// 不成功也可以")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," ws "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," node.waitStatus;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (ws "),t("span",{style:{color:"#F97583"}},"<"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"0"),t("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#B392F0"}},"compareAndSetWaitStatus"),t("span",{style:{color:"#E1E4E8"}},"(node, ws, "),t("span",{style:{color:"#79B8FF"}},"0"),t("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#6A737D"}},"// 找到需要 unpark 的节点, 但本节点从 AQS 队列中脱离, 是由唤醒节点完成的")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        Node s "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," node.next;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#6A737D"}},"// 不考虑已取消的节点, 从 AQS 队列从后至前找到队列最前面需要 unpark 的节点")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (s "),t("span",{style:{color:"#F97583"}},"=="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"null"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"||"),t("span",{style:{color:"#E1E4E8"}}," s.waitStatus "),t("span",{style:{color:"#F97583"}},">"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"0"),t("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            s "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"null"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"for"),t("span",{style:{color:"#E1E4E8"}}," (Node t "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," tail; t "),t("span",{style:{color:"#F97583"}},"!="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"null"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"&&"),t("span",{style:{color:"#E1E4E8"}}," t "),t("span",{style:{color:"#F97583"}},"!="),t("span",{style:{color:"#E1E4E8"}}," node; t "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," t.prev)")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (t.waitStatus "),t("span",{style:{color:"#F97583"}},"<="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"0"),t("span",{style:{color:"#E1E4E8"}},")")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                    s "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," t;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (s "),t("span",{style:{color:"#F97583"}},"!="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"null"),t("span",{style:{color:"#E1E4E8"}},")")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            LockSupport."),t("span",{style:{color:"#B392F0"}},"unpark"),t("span",{style:{color:"#E1E4E8"}},"(s.thread);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"}")])])]),t("pre",{class:"shiki github-light vp-code-light"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// Sync 继承自 AQS")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"static"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"final"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"class"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"NonfairSync"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"extends"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"Sync"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// 解锁实现")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"public"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"void"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"unlock"),t("span",{style:{color:"#24292E"}},"() {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        sync."),t("span",{style:{color:"#6F42C1"}},"release"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#005CC5"}},"1"),t("span",{style:{color:"#24292E"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    }")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// AQS 继承过来的方法, 方便阅读, 放在此处")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"public"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"final"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"boolean"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"release"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#E36209"}},"arg"),t("span",{style:{color:"#24292E"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6A737D"}},"// 尝试释放锁, 进入 ㈠")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," ("),t("span",{style:{color:"#6F42C1"}},"tryRelease"),t("span",{style:{color:"#24292E"}},"(arg)) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#6A737D"}},"// 队列头节点 unpark")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            Node h "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," head;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#6A737D"}},"// 队列不为 null")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                h "),t("span",{style:{color:"#D73A49"}},"!="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"null"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"&&")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#6A737D"}},"// waitStatus == Node.SIGNAL 才需要 unpark")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                h.waitStatus "),t("span",{style:{color:"#D73A49"}},"!="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"0")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            ) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#6A737D"}},"// unpark AQS 中等待的线程, 进入 ㈡")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#6F42C1"}},"unparkSuccessor"),t("span",{style:{color:"#24292E"}},"(h);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"return"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"true"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"return"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"false"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    }")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// ㈠ Sync 继承过来的方法, 方便阅读, 放在此处")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"protected"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"final"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"boolean"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"tryRelease"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#E36209"}},"releases"),t("span",{style:{color:"#24292E"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6A737D"}},"// state--")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," c "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"getState"),t("span",{style:{color:"#24292E"}},"() "),t("span",{style:{color:"#D73A49"}},"-"),t("span",{style:{color:"#24292E"}}," releases;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (Thread."),t("span",{style:{color:"#6F42C1"}},"currentThread"),t("span",{style:{color:"#24292E"}},"() "),t("span",{style:{color:"#D73A49"}},"!="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"getExclusiveOwnerThread"),t("span",{style:{color:"#24292E"}},"())")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"throw"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"new"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"IllegalMonitorStateException"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"boolean"),t("span",{style:{color:"#24292E"}}," free "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"false"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6A737D"}},"// 支持锁重入, 只有 state 减为 0, 才释放成功")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (c "),t("span",{style:{color:"#D73A49"}},"=="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"0"),t("span",{style:{color:"#24292E"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            free "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"true"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#6F42C1"}},"setExclusiveOwnerThread"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#005CC5"}},"null"),t("span",{style:{color:"#24292E"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6F42C1"}},"setState"),t("span",{style:{color:"#24292E"}},"(c);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"return"),t("span",{style:{color:"#24292E"}}," free;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    }")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// ㈡ AQS 继承过来的方法, 方便阅读, 放在此处")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"private"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"void"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"unparkSuccessor"),t("span",{style:{color:"#24292E"}},"(Node "),t("span",{style:{color:"#E36209"}},"node"),t("span",{style:{color:"#24292E"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6A737D"}},"// 如果状态为 Node.SIGNAL 尝试重置状态为 0, 如果线程获取到了锁那么后来头结点会被抛弃掉")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6A737D"}},"// 不成功也可以")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," ws "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," node.waitStatus;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (ws "),t("span",{style:{color:"#D73A49"}},"<"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"0"),t("span",{style:{color:"#24292E"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#6F42C1"}},"compareAndSetWaitStatus"),t("span",{style:{color:"#24292E"}},"(node, ws, "),t("span",{style:{color:"#005CC5"}},"0"),t("span",{style:{color:"#24292E"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6A737D"}},"// 找到需要 unpark 的节点, 但本节点从 AQS 队列中脱离, 是由唤醒节点完成的")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        Node s "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," node.next;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6A737D"}},"// 不考虑已取消的节点, 从 AQS 队列从后至前找到队列最前面需要 unpark 的节点")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (s "),t("span",{style:{color:"#D73A49"}},"=="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"null"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"||"),t("span",{style:{color:"#24292E"}}," s.waitStatus "),t("span",{style:{color:"#D73A49"}},">"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"0"),t("span",{style:{color:"#24292E"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            s "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"null"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"for"),t("span",{style:{color:"#24292E"}}," (Node t "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," tail; t "),t("span",{style:{color:"#D73A49"}},"!="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"null"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"&&"),t("span",{style:{color:"#24292E"}}," t "),t("span",{style:{color:"#D73A49"}},"!="),t("span",{style:{color:"#24292E"}}," node; t "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," t.prev)")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (t.waitStatus "),t("span",{style:{color:"#D73A49"}},"<="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"0"),t("span",{style:{color:"#24292E"}},")")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                    s "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," t;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (s "),t("span",{style:{color:"#D73A49"}},"!="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"null"),t("span",{style:{color:"#24292E"}},")")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            LockSupport."),t("span",{style:{color:"#6F42C1"}},"unpark"),t("span",{style:{color:"#24292E"}},"(s.thread);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"}")])])])],-1),an={id:"可重入原理",tabindex:"-1"},en=t("div",{class:"language-java"},[t("button",{title:"Copy Code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki github-dark vp-code-dark"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"static"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"final"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"class"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"NonfairSync"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"extends"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"Sync"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// ...")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// Sync 继承过来的方法, 方便阅读, 放在此处")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"final"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"boolean"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"nonfairTryAcquire"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#FFAB70"}},"acquires"),t("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"final"),t("span",{style:{color:"#E1E4E8"}}," Thread current "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," Thread."),t("span",{style:{color:"#B392F0"}},"currentThread"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," c "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"getState"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (c "),t("span",{style:{color:"#F97583"}},"=="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"0"),t("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," ("),t("span",{style:{color:"#B392F0"}},"compareAndSetState"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#79B8FF"}},"0"),t("span",{style:{color:"#E1E4E8"}},", acquires)) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#B392F0"}},"setExclusiveOwnerThread"),t("span",{style:{color:"#E1E4E8"}},"(current);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#F97583"}},"return"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"true"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#6A737D"}},"// 如果已经获得了锁, 线程还是当前线程, 表示发生了锁重入")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"else"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (current "),t("span",{style:{color:"#F97583"}},"=="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"getExclusiveOwnerThread"),t("span",{style:{color:"#E1E4E8"}},"()) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#6A737D"}},"// state++")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," nextc "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," c "),t("span",{style:{color:"#F97583"}},"+"),t("span",{style:{color:"#E1E4E8"}}," acquires;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (nextc "),t("span",{style:{color:"#F97583"}},"<"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"0"),t("span",{style:{color:"#E1E4E8"}},") "),t("span",{style:{color:"#6A737D"}},"// overflow")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#F97583"}},"throw"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"new"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"Error"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#9ECBFF"}},'"Maximum lock count exceeded"'),t("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#B392F0"}},"setState"),t("span",{style:{color:"#E1E4E8"}},"(nextc);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"return"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"true"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"return"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"false"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// Sync 继承过来的方法, 方便阅读, 放在此处")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"protected"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"final"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"boolean"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"tryRelease"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#FFAB70"}},"releases"),t("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#6A737D"}},"// state--")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," c "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"getState"),t("span",{style:{color:"#E1E4E8"}},"() "),t("span",{style:{color:"#F97583"}},"-"),t("span",{style:{color:"#E1E4E8"}}," releases;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (Thread."),t("span",{style:{color:"#B392F0"}},"currentThread"),t("span",{style:{color:"#E1E4E8"}},"() "),t("span",{style:{color:"#F97583"}},"!="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"getExclusiveOwnerThread"),t("span",{style:{color:"#E1E4E8"}},"())")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"throw"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"new"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"IllegalMonitorStateException"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"boolean"),t("span",{style:{color:"#E1E4E8"}}," free "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"false"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#6A737D"}},"// 支持锁重入, 只有 state 减为 0, 才释放成功")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (c "),t("span",{style:{color:"#F97583"}},"=="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"0"),t("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            free "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"true"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#B392F0"}},"setExclusiveOwnerThread"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#79B8FF"}},"null"),t("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#B392F0"}},"setState"),t("span",{style:{color:"#E1E4E8"}},"(c);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"return"),t("span",{style:{color:"#E1E4E8"}}," free;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"}")])])]),t("pre",{class:"shiki github-light vp-code-light"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"static"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"final"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"class"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"NonfairSync"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"extends"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"Sync"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// ...")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// Sync 继承过来的方法, 方便阅读, 放在此处")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"final"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"boolean"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"nonfairTryAcquire"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#E36209"}},"acquires"),t("span",{style:{color:"#24292E"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"final"),t("span",{style:{color:"#24292E"}}," Thread current "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," Thread."),t("span",{style:{color:"#6F42C1"}},"currentThread"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," c "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"getState"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (c "),t("span",{style:{color:"#D73A49"}},"=="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"0"),t("span",{style:{color:"#24292E"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," ("),t("span",{style:{color:"#6F42C1"}},"compareAndSetState"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#005CC5"}},"0"),t("span",{style:{color:"#24292E"}},", acquires)) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#6F42C1"}},"setExclusiveOwnerThread"),t("span",{style:{color:"#24292E"}},"(current);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#D73A49"}},"return"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"true"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6A737D"}},"// 如果已经获得了锁, 线程还是当前线程, 表示发生了锁重入")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"else"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (current "),t("span",{style:{color:"#D73A49"}},"=="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"getExclusiveOwnerThread"),t("span",{style:{color:"#24292E"}},"()) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#6A737D"}},"// state++")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," nextc "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," c "),t("span",{style:{color:"#D73A49"}},"+"),t("span",{style:{color:"#24292E"}}," acquires;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (nextc "),t("span",{style:{color:"#D73A49"}},"<"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"0"),t("span",{style:{color:"#24292E"}},") "),t("span",{style:{color:"#6A737D"}},"// overflow")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#D73A49"}},"throw"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"new"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"Error"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#032F62"}},'"Maximum lock count exceeded"'),t("span",{style:{color:"#24292E"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#6F42C1"}},"setState"),t("span",{style:{color:"#24292E"}},"(nextc);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"return"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"true"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"return"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"false"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    }")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// Sync 继承过来的方法, 方便阅读, 放在此处")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"protected"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"final"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"boolean"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"tryRelease"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#E36209"}},"releases"),t("span",{style:{color:"#24292E"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6A737D"}},"// state--")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," c "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"getState"),t("span",{style:{color:"#24292E"}},"() "),t("span",{style:{color:"#D73A49"}},"-"),t("span",{style:{color:"#24292E"}}," releases;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (Thread."),t("span",{style:{color:"#6F42C1"}},"currentThread"),t("span",{style:{color:"#24292E"}},"() "),t("span",{style:{color:"#D73A49"}},"!="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"getExclusiveOwnerThread"),t("span",{style:{color:"#24292E"}},"())")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"throw"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"new"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"IllegalMonitorStateException"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"boolean"),t("span",{style:{color:"#24292E"}}," free "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"false"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6A737D"}},"// 支持锁重入, 只有 state 减为 0, 才释放成功")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (c "),t("span",{style:{color:"#D73A49"}},"=="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"0"),t("span",{style:{color:"#24292E"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            free "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"true"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#6F42C1"}},"setExclusiveOwnerThread"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#005CC5"}},"null"),t("span",{style:{color:"#24292E"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6F42C1"}},"setState"),t("span",{style:{color:"#24292E"}},"(c);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"return"),t("span",{style:{color:"#24292E"}}," free;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"}")])])])],-1),cn={id:"可打断原理",tabindex:"-1"},tn=t("p",null,"不可打断模式：在此模式下，即使它被打断，仍会驻留在 AQS 队列中，等获得锁后方能继续运行（是继续运行！只是打断标记被设置为true）",-1),pn=t("div",{class:"language-java"},[t("button",{title:"Copy Code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki github-dark vp-code-dark"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// Sync 继承自 AQS")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"static"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"final"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"class"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"NonfairSync"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"extends"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"Sync"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// ...")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"private"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"final"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"boolean"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"parkAndCheckInterrupt"),t("span",{style:{color:"#E1E4E8"}},"() {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#6A737D"}},"// 如果打断标记已经是 true, 则 park 会失效")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        LockSupport."),t("span",{style:{color:"#B392F0"}},"park"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#79B8FF"}},"this"),t("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#6A737D"}},"// interrupted 会清除打断标记")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"return"),t("span",{style:{color:"#E1E4E8"}}," Thread."),t("span",{style:{color:"#B392F0"}},"interrupted"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"final"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"boolean"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"acquireQueued"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#F97583"}},"final"),t("span",{style:{color:"#E1E4E8"}}," Node "),t("span",{style:{color:"#FFAB70"}},"node"),t("span",{style:{color:"#E1E4E8"}},", "),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#FFAB70"}},"arg"),t("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"boolean"),t("span",{style:{color:"#E1E4E8"}}," failed "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"true"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"try"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"boolean"),t("span",{style:{color:"#E1E4E8"}}," interrupted "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"false"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"for"),t("span",{style:{color:"#E1E4E8"}}," (;;) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#F97583"}},"final"),t("span",{style:{color:"#E1E4E8"}}," Node p "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," node."),t("span",{style:{color:"#B392F0"}},"predecessor"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (p "),t("span",{style:{color:"#F97583"}},"=="),t("span",{style:{color:"#E1E4E8"}}," head "),t("span",{style:{color:"#F97583"}},"&&"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"tryAcquire"),t("span",{style:{color:"#E1E4E8"}},"(arg)) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                    "),t("span",{style:{color:"#B392F0"}},"setHead"),t("span",{style:{color:"#E1E4E8"}},"(node);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                    p.next "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"null"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                    failed "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"false"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                    "),t("span",{style:{color:"#6A737D"}},"// 还是需要获得锁后, 才能返回打断状态")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                    "),t("span",{style:{color:"#F97583"}},"return"),t("span",{style:{color:"#E1E4E8"}}," interrupted;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                        "),t("span",{style:{color:"#B392F0"}},"shouldParkAfterFailedAcquire"),t("span",{style:{color:"#E1E4E8"}},"(p, node) "),t("span",{style:{color:"#F97583"}},"&&")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                                "),t("span",{style:{color:"#B392F0"}},"parkAndCheckInterrupt"),t("span",{style:{color:"#E1E4E8"}},"()")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                ) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                    "),t("span",{style:{color:"#6A737D"}},"// 如果是因为 interrupt 被唤醒, 返回打断状态为 true")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                    interrupted "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"true"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        } "),t("span",{style:{color:"#F97583"}},"finally"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (failed)")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#B392F0"}},"cancelAcquire"),t("span",{style:{color:"#E1E4E8"}},"(node);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"public"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"final"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"void"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"acquire"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#FFAB70"}},"arg"),t("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#F97583"}},"!"),t("span",{style:{color:"#B392F0"}},"tryAcquire"),t("span",{style:{color:"#E1E4E8"}},"(arg) "),t("span",{style:{color:"#F97583"}},"&&")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                        "),t("span",{style:{color:"#B392F0"}},"acquireQueued"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#B392F0"}},"addWaiter"),t("span",{style:{color:"#E1E4E8"}},"(Node.EXCLUSIVE), arg)")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        ) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#6A737D"}},"// 如果打断状态为 true")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#B392F0"}},"selfInterrupt"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"static"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"void"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"selfInterrupt"),t("span",{style:{color:"#E1E4E8"}},"() {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#6A737D"}},"// 重新产生一次中断，这时候线程是如果正常运行的状态，那么不是出于sleep等状态，interrupt方法就不会报错")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        Thread."),t("span",{style:{color:"#B392F0"}},"currentThread"),t("span",{style:{color:"#E1E4E8"}},"()."),t("span",{style:{color:"#B392F0"}},"interrupt"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"}")])])]),t("pre",{class:"shiki github-light vp-code-light"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// Sync 继承自 AQS")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"static"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"final"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"class"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"NonfairSync"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"extends"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"Sync"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// ...")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"private"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"final"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"boolean"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"parkAndCheckInterrupt"),t("span",{style:{color:"#24292E"}},"() {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6A737D"}},"// 如果打断标记已经是 true, 则 park 会失效")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        LockSupport."),t("span",{style:{color:"#6F42C1"}},"park"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#005CC5"}},"this"),t("span",{style:{color:"#24292E"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6A737D"}},"// interrupted 会清除打断标记")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"return"),t("span",{style:{color:"#24292E"}}," Thread."),t("span",{style:{color:"#6F42C1"}},"interrupted"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    }")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"final"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"boolean"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"acquireQueued"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#D73A49"}},"final"),t("span",{style:{color:"#24292E"}}," Node "),t("span",{style:{color:"#E36209"}},"node"),t("span",{style:{color:"#24292E"}},", "),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#E36209"}},"arg"),t("span",{style:{color:"#24292E"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"boolean"),t("span",{style:{color:"#24292E"}}," failed "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"true"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"try"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"boolean"),t("span",{style:{color:"#24292E"}}," interrupted "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"false"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"for"),t("span",{style:{color:"#24292E"}}," (;;) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#D73A49"}},"final"),t("span",{style:{color:"#24292E"}}," Node p "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," node."),t("span",{style:{color:"#6F42C1"}},"predecessor"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (p "),t("span",{style:{color:"#D73A49"}},"=="),t("span",{style:{color:"#24292E"}}," head "),t("span",{style:{color:"#D73A49"}},"&&"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"tryAcquire"),t("span",{style:{color:"#24292E"}},"(arg)) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                    "),t("span",{style:{color:"#6F42C1"}},"setHead"),t("span",{style:{color:"#24292E"}},"(node);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                    p.next "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"null"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                    failed "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"false"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                    "),t("span",{style:{color:"#6A737D"}},"// 还是需要获得锁后, 才能返回打断状态")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                    "),t("span",{style:{color:"#D73A49"}},"return"),t("span",{style:{color:"#24292E"}}," interrupted;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                        "),t("span",{style:{color:"#6F42C1"}},"shouldParkAfterFailedAcquire"),t("span",{style:{color:"#24292E"}},"(p, node) "),t("span",{style:{color:"#D73A49"}},"&&")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                                "),t("span",{style:{color:"#6F42C1"}},"parkAndCheckInterrupt"),t("span",{style:{color:"#24292E"}},"()")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                ) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                    "),t("span",{style:{color:"#6A737D"}},"// 如果是因为 interrupt 被唤醒, 返回打断状态为 true")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                    interrupted "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"true"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        } "),t("span",{style:{color:"#D73A49"}},"finally"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (failed)")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#6F42C1"}},"cancelAcquire"),t("span",{style:{color:"#24292E"}},"(node);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    }")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"public"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"final"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"void"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"acquire"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#E36209"}},"arg"),t("span",{style:{color:"#24292E"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#D73A49"}},"!"),t("span",{style:{color:"#6F42C1"}},"tryAcquire"),t("span",{style:{color:"#24292E"}},"(arg) "),t("span",{style:{color:"#D73A49"}},"&&")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                        "),t("span",{style:{color:"#6F42C1"}},"acquireQueued"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#6F42C1"}},"addWaiter"),t("span",{style:{color:"#24292E"}},"(Node.EXCLUSIVE), arg)")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        ) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#6A737D"}},"// 如果打断状态为 true")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#6F42C1"}},"selfInterrupt"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    }")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"static"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"void"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"selfInterrupt"),t("span",{style:{color:"#24292E"}},"() {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6A737D"}},"// 重新产生一次中断，这时候线程是如果正常运行的状态，那么不是出于sleep等状态，interrupt方法就不会报错")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        Thread."),t("span",{style:{color:"#6F42C1"}},"currentThread"),t("span",{style:{color:"#24292E"}},"()."),t("span",{style:{color:"#6F42C1"}},"interrupt"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"}")])])])],-1),rn=t("p",null,"可打断模式",-1),En=t("div",{class:"language-java"},[t("button",{title:"Copy Code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki github-dark vp-code-dark"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"static"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"final"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"class"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"NonfairSync"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"extends"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"Sync"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"public"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"final"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"void"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"acquireInterruptibly"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#FFAB70"}},"arg"),t("span",{style:{color:"#E1E4E8"}},") "),t("span",{style:{color:"#F97583"}},"throws"),t("span",{style:{color:"#E1E4E8"}}," InterruptedException {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (Thread."),t("span",{style:{color:"#B392F0"}},"interrupted"),t("span",{style:{color:"#E1E4E8"}},"())")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"throw"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"new"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"InterruptedException"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#6A737D"}},"// 如果没有获得到锁, 进入 ㈠")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," ("),t("span",{style:{color:"#F97583"}},"!"),t("span",{style:{color:"#B392F0"}},"tryAcquire"),t("span",{style:{color:"#E1E4E8"}},"(arg))")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#B392F0"}},"doAcquireInterruptibly"),t("span",{style:{color:"#E1E4E8"}},"(arg);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// ㈠ 可打断的获取锁流程")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"private"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"void"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"doAcquireInterruptibly"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#FFAB70"}},"arg"),t("span",{style:{color:"#E1E4E8"}},") "),t("span",{style:{color:"#F97583"}},"throws"),t("span",{style:{color:"#E1E4E8"}}," InterruptedException {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"final"),t("span",{style:{color:"#E1E4E8"}}," Node node "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"addWaiter"),t("span",{style:{color:"#E1E4E8"}},"(Node.EXCLUSIVE);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"boolean"),t("span",{style:{color:"#E1E4E8"}}," failed "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"true"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"try"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"for"),t("span",{style:{color:"#E1E4E8"}}," (;;) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#F97583"}},"final"),t("span",{style:{color:"#E1E4E8"}}," Node p "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," node."),t("span",{style:{color:"#B392F0"}},"predecessor"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (p "),t("span",{style:{color:"#F97583"}},"=="),t("span",{style:{color:"#E1E4E8"}}," head "),t("span",{style:{color:"#F97583"}},"&&"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"tryAcquire"),t("span",{style:{color:"#E1E4E8"}},"(arg)) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                    "),t("span",{style:{color:"#B392F0"}},"setHead"),t("span",{style:{color:"#E1E4E8"}},"(node);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                    p.next "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"null"),t("span",{style:{color:"#E1E4E8"}},"; "),t("span",{style:{color:"#6A737D"}},"// help GC")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                    failed "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"false"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                    "),t("span",{style:{color:"#F97583"}},"return"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," ("),t("span",{style:{color:"#B392F0"}},"shouldParkAfterFailedAcquire"),t("span",{style:{color:"#E1E4E8"}},"(p, node) "),t("span",{style:{color:"#F97583"}},"&&")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                        "),t("span",{style:{color:"#B392F0"}},"parkAndCheckInterrupt"),t("span",{style:{color:"#E1E4E8"}},"()) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                    "),t("span",{style:{color:"#6A737D"}},"// 在 park 过程中如果被 interrupt 会进入此")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                    "),t("span",{style:{color:"#6A737D"}},"// 这时候抛出异常, 而不会再次进入 for (;;)")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                    "),t("span",{style:{color:"#F97583"}},"throw"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"new"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"InterruptedException"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        } "),t("span",{style:{color:"#F97583"}},"finally"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (failed)")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#B392F0"}},"cancelAcquire"),t("span",{style:{color:"#E1E4E8"}},"(node);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"}")])])]),t("pre",{class:"shiki github-light vp-code-light"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"static"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"final"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"class"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"NonfairSync"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"extends"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"Sync"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"public"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"final"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"void"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"acquireInterruptibly"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#E36209"}},"arg"),t("span",{style:{color:"#24292E"}},") "),t("span",{style:{color:"#D73A49"}},"throws"),t("span",{style:{color:"#24292E"}}," InterruptedException {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (Thread."),t("span",{style:{color:"#6F42C1"}},"interrupted"),t("span",{style:{color:"#24292E"}},"())")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"throw"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"new"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"InterruptedException"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6A737D"}},"// 如果没有获得到锁, 进入 ㈠")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," ("),t("span",{style:{color:"#D73A49"}},"!"),t("span",{style:{color:"#6F42C1"}},"tryAcquire"),t("span",{style:{color:"#24292E"}},"(arg))")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#6F42C1"}},"doAcquireInterruptibly"),t("span",{style:{color:"#24292E"}},"(arg);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    }")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// ㈠ 可打断的获取锁流程")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"private"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"void"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"doAcquireInterruptibly"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#E36209"}},"arg"),t("span",{style:{color:"#24292E"}},") "),t("span",{style:{color:"#D73A49"}},"throws"),t("span",{style:{color:"#24292E"}}," InterruptedException {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"final"),t("span",{style:{color:"#24292E"}}," Node node "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"addWaiter"),t("span",{style:{color:"#24292E"}},"(Node.EXCLUSIVE);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"boolean"),t("span",{style:{color:"#24292E"}}," failed "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"true"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"try"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"for"),t("span",{style:{color:"#24292E"}}," (;;) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#D73A49"}},"final"),t("span",{style:{color:"#24292E"}}," Node p "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," node."),t("span",{style:{color:"#6F42C1"}},"predecessor"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (p "),t("span",{style:{color:"#D73A49"}},"=="),t("span",{style:{color:"#24292E"}}," head "),t("span",{style:{color:"#D73A49"}},"&&"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"tryAcquire"),t("span",{style:{color:"#24292E"}},"(arg)) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                    "),t("span",{style:{color:"#6F42C1"}},"setHead"),t("span",{style:{color:"#24292E"}},"(node);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                    p.next "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"null"),t("span",{style:{color:"#24292E"}},"; "),t("span",{style:{color:"#6A737D"}},"// help GC")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                    failed "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"false"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                    "),t("span",{style:{color:"#D73A49"}},"return"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," ("),t("span",{style:{color:"#6F42C1"}},"shouldParkAfterFailedAcquire"),t("span",{style:{color:"#24292E"}},"(p, node) "),t("span",{style:{color:"#D73A49"}},"&&")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                        "),t("span",{style:{color:"#6F42C1"}},"parkAndCheckInterrupt"),t("span",{style:{color:"#24292E"}},"()) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                    "),t("span",{style:{color:"#6A737D"}},"// 在 park 过程中如果被 interrupt 会进入此")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                    "),t("span",{style:{color:"#6A737D"}},"// 这时候抛出异常, 而不会再次进入 for (;;)")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                    "),t("span",{style:{color:"#D73A49"}},"throw"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"new"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"InterruptedException"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        } "),t("span",{style:{color:"#D73A49"}},"finally"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (failed)")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#6F42C1"}},"cancelAcquire"),t("span",{style:{color:"#24292E"}},"(node);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"}")])])])],-1),yn={id:"公平锁实现原理",tabindex:"-1"},Fn=t("div",{class:"language-java"},[t("button",{title:"Copy Code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki github-dark vp-code-dark"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"static"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"final"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"class"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"FairSync"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"extends"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"Sync"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"private"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"static"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"final"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"long"),t("span",{style:{color:"#E1E4E8"}}," serialVersionUID "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"-"),t("span",{style:{color:"#79B8FF"}},"3000897897090466540L"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"final"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"void"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"lock"),t("span",{style:{color:"#E1E4E8"}},"() {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#B392F0"}},"acquire"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#79B8FF"}},"1"),t("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// AQS 继承过来的方法, 方便阅读, 放在此处")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"public"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"final"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"void"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"acquire"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#FFAB70"}},"arg"),t("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#F97583"}},"!"),t("span",{style:{color:"#B392F0"}},"tryAcquire"),t("span",{style:{color:"#E1E4E8"}},"(arg) "),t("span",{style:{color:"#F97583"}},"&&")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                        "),t("span",{style:{color:"#B392F0"}},"acquireQueued"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#B392F0"}},"addWaiter"),t("span",{style:{color:"#E1E4E8"}},"(Node.EXCLUSIVE), arg)")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        ) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#B392F0"}},"selfInterrupt"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// 与非公平锁主要区别在于 tryAcquire 方法的实现")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"protected"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"final"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"boolean"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"tryAcquire"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#FFAB70"}},"acquires"),t("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"final"),t("span",{style:{color:"#E1E4E8"}}," Thread current "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," Thread."),t("span",{style:{color:"#B392F0"}},"currentThread"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," c "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"getState"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (c "),t("span",{style:{color:"#F97583"}},"=="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"0"),t("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#6A737D"}},"// 先检查 AQS 队列中是否有前驱节点, 没有才去竞争")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," ("),t("span",{style:{color:"#F97583"}},"!"),t("span",{style:{color:"#B392F0"}},"hasQueuedPredecessors"),t("span",{style:{color:"#E1E4E8"}},"() "),t("span",{style:{color:"#F97583"}},"&&")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                    "),t("span",{style:{color:"#B392F0"}},"compareAndSetState"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#79B8FF"}},"0"),t("span",{style:{color:"#E1E4E8"}},", acquires)) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#B392F0"}},"setExclusiveOwnerThread"),t("span",{style:{color:"#E1E4E8"}},"(current);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#F97583"}},"return"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"true"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"else"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (current "),t("span",{style:{color:"#F97583"}},"=="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"getExclusiveOwnerThread"),t("span",{style:{color:"#E1E4E8"}},"()) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," nextc "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," c "),t("span",{style:{color:"#F97583"}},"+"),t("span",{style:{color:"#E1E4E8"}}," acquires;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (nextc "),t("span",{style:{color:"#F97583"}},"<"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"0"),t("span",{style:{color:"#E1E4E8"}},")")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#F97583"}},"throw"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"new"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"Error"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#9ECBFF"}},'"Maximum lock count exceeded"'),t("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#B392F0"}},"setState"),t("span",{style:{color:"#E1E4E8"}},"(nextc);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"return"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"true"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"return"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"false"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// ㈠ AQS 继承过来的方法, 方便阅读, 放在此处")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"public"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"final"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"boolean"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"hasQueuedPredecessors"),t("span",{style:{color:"#E1E4E8"}},"() {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        Node t "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," tail;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        Node h "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," head;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        Node s;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#6A737D"}},"// h != t 时表示队列中有 Node")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"return"),t("span",{style:{color:"#E1E4E8"}}," h "),t("span",{style:{color:"#F97583"}},"!="),t("span",{style:{color:"#E1E4E8"}}," t "),t("span",{style:{color:"#F97583"}},"&&")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                (")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                        "),t("span",{style:{color:"#6A737D"}},"// (s = h.next) == null 表示队列中还有没有老二")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                        (s "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," h.next) "),t("span",{style:{color:"#F97583"}},"=="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"null"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"||"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#6A737D"}},"// 或者队列中老二线程不是此线程")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                                s.thread "),t("span",{style:{color:"#F97583"}},"!="),t("span",{style:{color:"#E1E4E8"}}," Thread."),t("span",{style:{color:"#B392F0"}},"currentThread"),t("span",{style:{color:"#E1E4E8"}},"()")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                );")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"}")])])]),t("pre",{class:"shiki github-light vp-code-light"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"static"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"final"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"class"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"FairSync"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"extends"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"Sync"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"private"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"static"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"final"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"long"),t("span",{style:{color:"#24292E"}}," serialVersionUID "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"-"),t("span",{style:{color:"#005CC5"}},"3000897897090466540L"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"final"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"void"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"lock"),t("span",{style:{color:"#24292E"}},"() {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6F42C1"}},"acquire"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#005CC5"}},"1"),t("span",{style:{color:"#24292E"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    }")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// AQS 继承过来的方法, 方便阅读, 放在此处")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"public"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"final"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"void"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"acquire"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#E36209"}},"arg"),t("span",{style:{color:"#24292E"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#D73A49"}},"!"),t("span",{style:{color:"#6F42C1"}},"tryAcquire"),t("span",{style:{color:"#24292E"}},"(arg) "),t("span",{style:{color:"#D73A49"}},"&&")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                        "),t("span",{style:{color:"#6F42C1"}},"acquireQueued"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#6F42C1"}},"addWaiter"),t("span",{style:{color:"#24292E"}},"(Node.EXCLUSIVE), arg)")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        ) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#6F42C1"}},"selfInterrupt"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// 与非公平锁主要区别在于 tryAcquire 方法的实现")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"protected"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"final"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"boolean"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"tryAcquire"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#E36209"}},"acquires"),t("span",{style:{color:"#24292E"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"final"),t("span",{style:{color:"#24292E"}}," Thread current "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," Thread."),t("span",{style:{color:"#6F42C1"}},"currentThread"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," c "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"getState"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (c "),t("span",{style:{color:"#D73A49"}},"=="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"0"),t("span",{style:{color:"#24292E"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#6A737D"}},"// 先检查 AQS 队列中是否有前驱节点, 没有才去竞争")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," ("),t("span",{style:{color:"#D73A49"}},"!"),t("span",{style:{color:"#6F42C1"}},"hasQueuedPredecessors"),t("span",{style:{color:"#24292E"}},"() "),t("span",{style:{color:"#D73A49"}},"&&")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                    "),t("span",{style:{color:"#6F42C1"}},"compareAndSetState"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#005CC5"}},"0"),t("span",{style:{color:"#24292E"}},", acquires)) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#6F42C1"}},"setExclusiveOwnerThread"),t("span",{style:{color:"#24292E"}},"(current);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#D73A49"}},"return"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"true"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"else"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (current "),t("span",{style:{color:"#D73A49"}},"=="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"getExclusiveOwnerThread"),t("span",{style:{color:"#24292E"}},"()) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," nextc "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," c "),t("span",{style:{color:"#D73A49"}},"+"),t("span",{style:{color:"#24292E"}}," acquires;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (nextc "),t("span",{style:{color:"#D73A49"}},"<"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"0"),t("span",{style:{color:"#24292E"}},")")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#D73A49"}},"throw"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"new"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"Error"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#032F62"}},'"Maximum lock count exceeded"'),t("span",{style:{color:"#24292E"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#6F42C1"}},"setState"),t("span",{style:{color:"#24292E"}},"(nextc);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"return"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"true"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"return"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"false"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    }")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// ㈠ AQS 继承过来的方法, 方便阅读, 放在此处")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"public"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"final"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"boolean"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"hasQueuedPredecessors"),t("span",{style:{color:"#24292E"}},"() {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        Node t "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," tail;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        Node h "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," head;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        Node s;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6A737D"}},"// h != t 时表示队列中有 Node")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"return"),t("span",{style:{color:"#24292E"}}," h "),t("span",{style:{color:"#D73A49"}},"!="),t("span",{style:{color:"#24292E"}}," t "),t("span",{style:{color:"#D73A49"}},"&&")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                (")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                        "),t("span",{style:{color:"#6A737D"}},"// (s = h.next) == null 表示队列中还有没有老二")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                        (s "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," h.next) "),t("span",{style:{color:"#D73A49"}},"=="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"null"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"||"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6A737D"}},"// 或者队列中老二线程不是此线程")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                                s.thread "),t("span",{style:{color:"#D73A49"}},"!="),t("span",{style:{color:"#24292E"}}," Thread."),t("span",{style:{color:"#6F42C1"}},"currentThread"),t("span",{style:{color:"#24292E"}},"()")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                );")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"}")])])])],-1),un={id:"条件变量实现原理",tabindex:"-1"},An=t("p",null,"每个条件变量其实就对应着一个等待队列，其实现类是 ConditionObject",-1),dn={id:"await-流程",tabindex:"-1"},Dn=t("p",null,"开始 Thread-0 持有锁，调用 await，进入 ConditionObject 的 addConditionWaiter 流程 创建新的 Node 状态为 -2（Node.CONDITION），关联 Thread-0，加入等待队列尾部",-1),Cn=t("figure",null,[t("img",{src:"https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230719164220226.png",alt:"image-20230719164220226",loading:"lazy",decoding:"async"})],-1),hn=t("p",null,"接下来进入 AQS 的 fullyRelease 流程，释放同步器上的锁",-1),gn=t("figure",null,[t("img",{src:"https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230719164232726.png",alt:"image-20230719164232726",loading:"lazy",decoding:"async"})],-1),Bn=t("p",null,"unpark AQS 队列中的下一个节点，竞争锁，假设没有其他竞争线程，那么 Thread-1 竞争成功",-1),fn=t("figure",null,[t("img",{src:"https://jsd.cdn.zzko.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230719164247506.png",alt:"image-20230719164247506",loading:"lazy",decoding:"async"})],-1),kn=t("p",null,"park 阻塞 Thread-0",-1),bn=t("figure",null,[t("img",{src:"https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230719164258904.png",alt:"image-20230719164258904",loading:"lazy",decoding:"async"})],-1),mn={id:"signal-流程",tabindex:"-1"},Sn=t("p",null,"假设 Thread-1 要来唤醒 Thread-0",-1),vn=t("figure",null,[t("img",{src:"https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230719164323626.png",alt:"image-20230719164323626",loading:"lazy",decoding:"async"})],-1),wn=t("p",null,"进入 ConditionObject 的 doSignal 流程，取得等待队列中第一个 Node，即 Thread-0 所在 Node",-1),Tn=t("figure",null,[t("img",{src:"https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230719164337750.png",alt:"image-20230719164337750",loading:"lazy",decoding:"async"})],-1),xn=t("p",null,"执行 transferForSignal 流程，将该 Node 加入 AQS 队列尾部，将 Thread-0 的 waitStatus 改为 0，Thread-3 的 waitStatus 改为 -1",-1),Nn=t("figure",null,[t("img",{src:"https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230719164353059.png",alt:"image-20230719164353059",loading:"lazy",decoding:"async"})],-1),In=t("p",null,"Thread-1 释放锁，进入 unlock 流程，略",-1),Ln={id:"源码分析",tabindex:"-1"},jn=t("div",{class:"language-java"},[t("button",{title:"Copy Code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki github-dark vp-code-dark"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"public"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"class"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"ConditionObject"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"implements"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"Condition"),t("span",{style:{color:"#E1E4E8"}},", java.io."),t("span",{style:{color:"#B392F0"}},"Serializable"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"private"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"static"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"final"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"long"),t("span",{style:{color:"#E1E4E8"}}," serialVersionUID "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"1173984872572414699L"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// 第一个等待节点")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"private"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"transient"),t("span",{style:{color:"#E1E4E8"}}," Node firstWaiter;")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// 最后一个等待节点")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"private"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"transient"),t("span",{style:{color:"#E1E4E8"}}," Node lastWaiter;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"public"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"ConditionObject"),t("span",{style:{color:"#E1E4E8"}},"() { }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// ㈠ 添加一个 Node 至等待队列")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"private"),t("span",{style:{color:"#E1E4E8"}}," Node "),t("span",{style:{color:"#B392F0"}},"addConditionWaiter"),t("span",{style:{color:"#E1E4E8"}},"() {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        Node t "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," lastWaiter;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#6A737D"}},"// 所有已取消的 Node 从队列链表删除, 见 ㈡")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (t "),t("span",{style:{color:"#F97583"}},"!="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"null"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"&&"),t("span",{style:{color:"#E1E4E8"}}," t.waitStatus "),t("span",{style:{color:"#F97583"}},"!="),t("span",{style:{color:"#E1E4E8"}}," Node.CONDITION) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#B392F0"}},"unlinkCancelledWaiters"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            t "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," lastWaiter;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#6A737D"}},"// 创建一个关联当前线程的新 Node, 添加至队列尾部")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        Node node "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"new"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"Node"),t("span",{style:{color:"#E1E4E8"}},"(Thread."),t("span",{style:{color:"#B392F0"}},"currentThread"),t("span",{style:{color:"#E1E4E8"}},"(), Node.CONDITION);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (t "),t("span",{style:{color:"#F97583"}},"=="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"null"),t("span",{style:{color:"#E1E4E8"}},")")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            firstWaiter "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," node;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"else")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            t.nextWaiter "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," node;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        lastWaiter "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," node;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"return"),t("span",{style:{color:"#E1E4E8"}}," node;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// 唤醒 - 将没取消的第一个节点转移至 AQS 队列")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"private"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"void"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"doSignal"),t("span",{style:{color:"#E1E4E8"}},"(Node "),t("span",{style:{color:"#FFAB70"}},"first"),t("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"do"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#6A737D"}},"// 已经是尾节点了")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," ( (firstWaiter "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," first.nextWaiter) "),t("span",{style:{color:"#F97583"}},"=="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"null"),t("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                lastWaiter "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"null"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            first.nextWaiter "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"null"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        } "),t("span",{style:{color:"#F97583"}},"while"),t("span",{style:{color:"#E1E4E8"}}," (")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#6A737D"}},"// 将等待队列中的 Node 转移至 AQS 队列, 不成功且还有节点则继续循环 ㈢")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#F97583"}},"!"),t("span",{style:{color:"#B392F0"}},"transferForSignal"),t("span",{style:{color:"#E1E4E8"}},"(first) "),t("span",{style:{color:"#F97583"}},"&&")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                        "),t("span",{style:{color:"#6A737D"}},"// 队列还有节点")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                        (first "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," firstWaiter) "),t("span",{style:{color:"#F97583"}},"!="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"null")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        );")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// 外部类方法, 方便阅读, 放在此处")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// ㈢ 如果节点状态是取消, 返回 false 表示转移失败, 否则转移成功")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"final"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"boolean"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"transferForSignal"),t("span",{style:{color:"#E1E4E8"}},"(Node "),t("span",{style:{color:"#FFAB70"}},"node"),t("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#6A737D"}},"// 设置当前node状态为0（因为处在队列末尾），如果状态已经不是 Node.CONDITION, 说明被取消了")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," ("),t("span",{style:{color:"#F97583"}},"!"),t("span",{style:{color:"#B392F0"}},"compareAndSetWaitStatus"),t("span",{style:{color:"#E1E4E8"}},"(node, Node.CONDITION, "),t("span",{style:{color:"#79B8FF"}},"0"),t("span",{style:{color:"#E1E4E8"}},"))")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"return"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"false"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#6A737D"}},"// 加入 AQS 队列尾部")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        Node p "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"enq"),t("span",{style:{color:"#E1E4E8"}},"(node);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," ws "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," p.waitStatus;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#6A737D"}},"// 插入节点的上一个节点被取消")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                ws "),t("span",{style:{color:"#F97583"}},">"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"0"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"||")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                        "),t("span",{style:{color:"#6A737D"}},"// 插入节点的上一个节点不能设置状态为 Node.SIGNAL")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                        "),t("span",{style:{color:"#F97583"}},"!"),t("span",{style:{color:"#B392F0"}},"compareAndSetWaitStatus"),t("span",{style:{color:"#E1E4E8"}},"(p, ws, Node.SIGNAL)")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        ) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#6A737D"}},"// unpark 取消阻塞, 让线程重新同步状态")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            LockSupport."),t("span",{style:{color:"#B392F0"}},"unpark"),t("span",{style:{color:"#E1E4E8"}},"(node.thread);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"return"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"true"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// 全部唤醒 - 等待队列的所有节点转移至 AQS 队列")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"private"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"void"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"doSignalAll"),t("span",{style:{color:"#E1E4E8"}},"(Node "),t("span",{style:{color:"#FFAB70"}},"first"),t("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    lastWaiter "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," firstWaiter "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"null"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"do"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        Node next "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," first.nextWaiter;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        first.nextWaiter "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"null"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#B392F0"}},"transferForSignal"),t("span",{style:{color:"#E1E4E8"}},"(first);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        first "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," next;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    } "),t("span",{style:{color:"#F97583"}},"while"),t("span",{style:{color:"#E1E4E8"}}," (first "),t("span",{style:{color:"#F97583"}},"!="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"null"),t("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"}")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// ㈡")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"private"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"void"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"unlinkCancelledWaiters"),t("span",{style:{color:"#E1E4E8"}},"() {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#6A737D"}},"// ...")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// 唤醒 - 必须持有锁才能唤醒, 因此 doSignal 内无需考虑加锁")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"public"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"final"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"void"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"signal"),t("span",{style:{color:"#E1E4E8"}},"() {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#6A737D"}},"// 如果没有持有锁，会抛出异常")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," ("),t("span",{style:{color:"#F97583"}},"!"),t("span",{style:{color:"#B392F0"}},"isHeldExclusively"),t("span",{style:{color:"#E1E4E8"}},"())")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"throw"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"new"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"IllegalMonitorStateException"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        Node first "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," firstWaiter;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (first "),t("span",{style:{color:"#F97583"}},"!="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"null"),t("span",{style:{color:"#E1E4E8"}},")")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#B392F0"}},"doSignal"),t("span",{style:{color:"#E1E4E8"}},"(first);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// 全部唤醒 - 必须持有锁才能唤醒, 因此 doSignalAll 内无需考虑加锁")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"public"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"final"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"void"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"signalAll"),t("span",{style:{color:"#E1E4E8"}},"() {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," ("),t("span",{style:{color:"#F97583"}},"!"),t("span",{style:{color:"#B392F0"}},"isHeldExclusively"),t("span",{style:{color:"#E1E4E8"}},"())")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"throw"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"new"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"IllegalMonitorStateException"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        Node first "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," firstWaiter;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (first "),t("span",{style:{color:"#F97583"}},"!="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"null"),t("span",{style:{color:"#E1E4E8"}},")")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#B392F0"}},"doSignalAll"),t("span",{style:{color:"#E1E4E8"}},"(first);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// 不可打断等待 - 直到被唤醒")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"public"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"final"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"void"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"awaitUninterruptibly"),t("span",{style:{color:"#E1E4E8"}},"() {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#6A737D"}},"// 添加一个 Node 至等待队列, 见 ㈠")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        Node node "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"addConditionWaiter"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#6A737D"}},"// 释放节点持有的锁, 见 ㈣")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," savedState "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"fullyRelease"),t("span",{style:{color:"#E1E4E8"}},"(node);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"boolean"),t("span",{style:{color:"#E1E4E8"}}," interrupted "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"false"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#6A737D"}},"// 如果该节点还没有转移至 AQS 队列, 阻塞")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"while"),t("span",{style:{color:"#E1E4E8"}}," ("),t("span",{style:{color:"#F97583"}},"!"),t("span",{style:{color:"#B392F0"}},"isOnSyncQueue"),t("span",{style:{color:"#E1E4E8"}},"(node)) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#6A737D"}},"// park 阻塞")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            LockSupport."),t("span",{style:{color:"#B392F0"}},"park"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#79B8FF"}},"this"),t("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#6A737D"}},"// 如果被打断, 仅设置打断状态")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (Thread."),t("span",{style:{color:"#B392F0"}},"interrupted"),t("span",{style:{color:"#E1E4E8"}},"())")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                interrupted "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"true"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#6A737D"}},"// 唤醒后, 尝试竞争锁, 如果失败进入 AQS 队列")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," ("),t("span",{style:{color:"#B392F0"}},"acquireQueued"),t("span",{style:{color:"#E1E4E8"}},"(node, savedState) "),t("span",{style:{color:"#F97583"}},"||"),t("span",{style:{color:"#E1E4E8"}}," interrupted)")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#B392F0"}},"selfInterrupt"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// 外部类方法, 方便阅读, 放在此处")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// ㈣ 因为某线程可能重入，需要将 state 全部释放，获取state，然后把它全部减掉，以全部释放")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"final"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"fullyRelease"),t("span",{style:{color:"#E1E4E8"}},"(Node "),t("span",{style:{color:"#FFAB70"}},"node"),t("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"boolean"),t("span",{style:{color:"#E1E4E8"}}," failed "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"true"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"try"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," savedState "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"getState"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#6A737D"}},"// 唤醒等待队列队列中的下一个节点")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," ("),t("span",{style:{color:"#B392F0"}},"release"),t("span",{style:{color:"#E1E4E8"}},"(savedState)) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                failed "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"false"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#F97583"}},"return"),t("span",{style:{color:"#E1E4E8"}}," savedState;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            } "),t("span",{style:{color:"#F97583"}},"else"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#F97583"}},"throw"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"new"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"IllegalMonitorStateException"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        } "),t("span",{style:{color:"#F97583"}},"finally"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (failed)")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                node.waitStatus "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," Node.CANCELLED;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// 打断模式 - 在退出等待时重新设置打断状态")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"private"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"static"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"final"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," REINTERRUPT "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"1"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// 打断模式 - 在退出等待时抛出异常")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"private"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"static"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"final"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," THROW_IE "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"-"),t("span",{style:{color:"#79B8FF"}},"1"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// 判断打断模式")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"private"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"checkInterruptWhileWaiting"),t("span",{style:{color:"#E1E4E8"}},"(Node "),t("span",{style:{color:"#FFAB70"}},"node"),t("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"return"),t("span",{style:{color:"#E1E4E8"}}," Thread."),t("span",{style:{color:"#B392F0"}},"interrupted"),t("span",{style:{color:"#E1E4E8"}},"() "),t("span",{style:{color:"#F97583"}},"?")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                ("),t("span",{style:{color:"#B392F0"}},"transferAfterCancelledWait"),t("span",{style:{color:"#E1E4E8"}},"(node) "),t("span",{style:{color:"#F97583"}},"?"),t("span",{style:{color:"#E1E4E8"}}," THROW_IE "),t("span",{style:{color:"#F97583"}},":"),t("span",{style:{color:"#E1E4E8"}}," REINTERRUPT) "),t("span",{style:{color:"#F97583"}},":")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#79B8FF"}},"0"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// ㈤ 应用打断模式")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"private"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"void"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"reportInterruptAfterWait"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#FFAB70"}},"interruptMode"),t("span",{style:{color:"#E1E4E8"}},")")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"throws"),t("span",{style:{color:"#E1E4E8"}}," InterruptedException {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (interruptMode "),t("span",{style:{color:"#F97583"}},"=="),t("span",{style:{color:"#E1E4E8"}}," THROW_IE)")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"throw"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"new"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"InterruptedException"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"else"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (interruptMode "),t("span",{style:{color:"#F97583"}},"=="),t("span",{style:{color:"#E1E4E8"}}," REINTERRUPT)")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#B392F0"}},"selfInterrupt"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// 等待 - 直到被唤醒或打断")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"public"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"final"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"void"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"await"),t("span",{style:{color:"#E1E4E8"}},"() "),t("span",{style:{color:"#F97583"}},"throws"),t("span",{style:{color:"#E1E4E8"}}," InterruptedException {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (Thread."),t("span",{style:{color:"#B392F0"}},"interrupted"),t("span",{style:{color:"#E1E4E8"}},"()) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"throw"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"new"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"InterruptedException"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#6A737D"}},"// 添加一个 Node 至等待队列, 见 ㈠")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        Node node "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"addConditionWaiter"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#6A737D"}},"// 释放节点持有的锁")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," savedState "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"fullyRelease"),t("span",{style:{color:"#E1E4E8"}},"(node);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," interruptMode "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"0"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#6A737D"}},"// 如果该节点还没有转移至 AQS 队列, 阻塞")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"while"),t("span",{style:{color:"#E1E4E8"}}," ("),t("span",{style:{color:"#F97583"}},"!"),t("span",{style:{color:"#B392F0"}},"isOnSyncQueue"),t("span",{style:{color:"#E1E4E8"}},"(node)) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#6A737D"}},"// park 阻塞              ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            LockSupport."),t("span",{style:{color:"#B392F0"}},"park"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#79B8FF"}},"this"),t("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#6A737D"}},"// 如果被打断, 退出等待队列")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," ((interruptMode "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"checkInterruptWhileWaiting"),t("span",{style:{color:"#E1E4E8"}},"(node)) "),t("span",{style:{color:"#F97583"}},"!="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"0"),t("span",{style:{color:"#E1E4E8"}},")")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#F97583"}},"break"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#6A737D"}},"// 退出等待队列后, 还需要获得 AQS 队列的锁")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," ("),t("span",{style:{color:"#B392F0"}},"acquireQueued"),t("span",{style:{color:"#E1E4E8"}},"(node, savedState) "),t("span",{style:{color:"#F97583"}},"&&"),t("span",{style:{color:"#E1E4E8"}}," interruptMode "),t("span",{style:{color:"#F97583"}},"!="),t("span",{style:{color:"#E1E4E8"}}," THROW_IE)")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            interruptMode "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," REINTERRUPT;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#6A737D"}},"// 所有已取消的 Node 从队列链表删除, 见 ㈡")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (node.nextWaiter "),t("span",{style:{color:"#F97583"}},"!="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"null"),t("span",{style:{color:"#E1E4E8"}},")")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#B392F0"}},"unlinkCancelledWaiters"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#6A737D"}},"// 应用打断模式, 见 ㈤")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (interruptMode "),t("span",{style:{color:"#F97583"}},"!="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"0"),t("span",{style:{color:"#E1E4E8"}},")")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#B392F0"}},"reportInterruptAfterWait"),t("span",{style:{color:"#E1E4E8"}},"(interruptMode);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// 等待 - 直到被唤醒或打断或超时")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"public"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"final"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"long"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"awaitNanos"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#F97583"}},"long"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#FFAB70"}},"nanosTimeout"),t("span",{style:{color:"#E1E4E8"}},") "),t("span",{style:{color:"#F97583"}},"throws"),t("span",{style:{color:"#E1E4E8"}}," InterruptedException {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (Thread."),t("span",{style:{color:"#B392F0"}},"interrupted"),t("span",{style:{color:"#E1E4E8"}},"()) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"throw"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"new"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"InterruptedException"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#6A737D"}},"// 添加一个 Node 至等待队列, 见 ㈠")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        Node node "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"addConditionWaiter"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#6A737D"}},"// 释放节点持有的锁")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," savedState "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"fullyRelease"),t("span",{style:{color:"#E1E4E8"}},"(node);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#6A737D"}},"// 获得最后期限")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"final"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"long"),t("span",{style:{color:"#E1E4E8"}}," deadline "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," System."),t("span",{style:{color:"#B392F0"}},"nanoTime"),t("span",{style:{color:"#E1E4E8"}},"() "),t("span",{style:{color:"#F97583"}},"+"),t("span",{style:{color:"#E1E4E8"}}," nanosTimeout;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," interruptMode "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"0"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#6A737D"}},"// 如果该节点还没有转移至 AQS 队列, 阻塞")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"while"),t("span",{style:{color:"#E1E4E8"}}," ("),t("span",{style:{color:"#F97583"}},"!"),t("span",{style:{color:"#B392F0"}},"isOnSyncQueue"),t("span",{style:{color:"#E1E4E8"}},"(node)) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#6A737D"}},"// 已超时, 退出等待队列")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (nanosTimeout "),t("span",{style:{color:"#F97583"}},"<="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"0L"),t("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#B392F0"}},"transferAfterCancelledWait"),t("span",{style:{color:"#E1E4E8"}},"(node);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#F97583"}},"break"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#6A737D"}},"// park 阻塞一定时间, spinForTimeoutThreshold 为 1000 ns")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (nanosTimeout "),t("span",{style:{color:"#F97583"}},">="),t("span",{style:{color:"#E1E4E8"}}," spinForTimeoutThreshold)")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                LockSupport."),t("span",{style:{color:"#B392F0"}},"parkNanos"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#79B8FF"}},"this"),t("span",{style:{color:"#E1E4E8"}},", nanosTimeout);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#6A737D"}},"// 如果被打断, 退出等待队列")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," ((interruptMode "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"checkInterruptWhileWaiting"),t("span",{style:{color:"#E1E4E8"}},"(node)) "),t("span",{style:{color:"#F97583"}},"!="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"0"),t("span",{style:{color:"#E1E4E8"}},")")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#F97583"}},"break"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            nanosTimeout "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," deadline "),t("span",{style:{color:"#F97583"}},"-"),t("span",{style:{color:"#E1E4E8"}}," System."),t("span",{style:{color:"#B392F0"}},"nanoTime"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#6A737D"}},"// 退出等待队列后, 还需要获得 AQS 队列的锁")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," ("),t("span",{style:{color:"#B392F0"}},"acquireQueued"),t("span",{style:{color:"#E1E4E8"}},"(node, savedState) "),t("span",{style:{color:"#F97583"}},"&&"),t("span",{style:{color:"#E1E4E8"}}," interruptMode "),t("span",{style:{color:"#F97583"}},"!="),t("span",{style:{color:"#E1E4E8"}}," THROW_IE)")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            interruptMode "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," REINTERRUPT;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#6A737D"}},"// 所有已取消的 Node 从队列链表删除, 见 ㈡")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (node.nextWaiter "),t("span",{style:{color:"#F97583"}},"!="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"null"),t("span",{style:{color:"#E1E4E8"}},")")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#B392F0"}},"unlinkCancelledWaiters"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#6A737D"}},"// 应用打断模式, 见 ㈤")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (interruptMode "),t("span",{style:{color:"#F97583"}},"!="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"0"),t("span",{style:{color:"#E1E4E8"}},")")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#B392F0"}},"reportInterruptAfterWait"),t("span",{style:{color:"#E1E4E8"}},"(interruptMode);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"return"),t("span",{style:{color:"#E1E4E8"}}," deadline "),t("span",{style:{color:"#F97583"}},"-"),t("span",{style:{color:"#E1E4E8"}}," System."),t("span",{style:{color:"#B392F0"}},"nanoTime"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// 等待 - 直到被唤醒或打断或超时, 逻辑类似于 awaitNanos")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"public"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"final"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"boolean"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"awaitUntil"),t("span",{style:{color:"#E1E4E8"}},"(Date "),t("span",{style:{color:"#FFAB70"}},"deadline"),t("span",{style:{color:"#E1E4E8"}},") "),t("span",{style:{color:"#F97583"}},"throws"),t("span",{style:{color:"#E1E4E8"}}," InterruptedException {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#6A737D"}},"// ...")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// 等待 - 直到被唤醒或打断或超时, 逻辑类似于 awaitNanos")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"public"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"final"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"boolean"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"await"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#F97583"}},"long"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#FFAB70"}},"time"),t("span",{style:{color:"#E1E4E8"}},", TimeUnit "),t("span",{style:{color:"#FFAB70"}},"unit"),t("span",{style:{color:"#E1E4E8"}},") "),t("span",{style:{color:"#F97583"}},"throws"),t("span",{style:{color:"#E1E4E8"}}," InterruptedException {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#6A737D"}},"// ...")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// 工具方法 省略 ...")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"}")])])]),t("pre",{class:"shiki github-light vp-code-light"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"public"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"class"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"ConditionObject"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"implements"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"Condition"),t("span",{style:{color:"#24292E"}},", java.io."),t("span",{style:{color:"#6F42C1"}},"Serializable"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"private"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"static"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"final"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"long"),t("span",{style:{color:"#24292E"}}," serialVersionUID "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"1173984872572414699L"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// 第一个等待节点")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"private"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"transient"),t("span",{style:{color:"#24292E"}}," Node firstWaiter;")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// 最后一个等待节点")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"private"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"transient"),t("span",{style:{color:"#24292E"}}," Node lastWaiter;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"public"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"ConditionObject"),t("span",{style:{color:"#24292E"}},"() { }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// ㈠ 添加一个 Node 至等待队列")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"private"),t("span",{style:{color:"#24292E"}}," Node "),t("span",{style:{color:"#6F42C1"}},"addConditionWaiter"),t("span",{style:{color:"#24292E"}},"() {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        Node t "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," lastWaiter;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6A737D"}},"// 所有已取消的 Node 从队列链表删除, 见 ㈡")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (t "),t("span",{style:{color:"#D73A49"}},"!="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"null"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"&&"),t("span",{style:{color:"#24292E"}}," t.waitStatus "),t("span",{style:{color:"#D73A49"}},"!="),t("span",{style:{color:"#24292E"}}," Node.CONDITION) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#6F42C1"}},"unlinkCancelledWaiters"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            t "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," lastWaiter;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6A737D"}},"// 创建一个关联当前线程的新 Node, 添加至队列尾部")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        Node node "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"new"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"Node"),t("span",{style:{color:"#24292E"}},"(Thread."),t("span",{style:{color:"#6F42C1"}},"currentThread"),t("span",{style:{color:"#24292E"}},"(), Node.CONDITION);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (t "),t("span",{style:{color:"#D73A49"}},"=="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"null"),t("span",{style:{color:"#24292E"}},")")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            firstWaiter "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," node;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"else")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            t.nextWaiter "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," node;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        lastWaiter "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," node;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"return"),t("span",{style:{color:"#24292E"}}," node;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// 唤醒 - 将没取消的第一个节点转移至 AQS 队列")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"private"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"void"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"doSignal"),t("span",{style:{color:"#24292E"}},"(Node "),t("span",{style:{color:"#E36209"}},"first"),t("span",{style:{color:"#24292E"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"do"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#6A737D"}},"// 已经是尾节点了")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," ( (firstWaiter "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," first.nextWaiter) "),t("span",{style:{color:"#D73A49"}},"=="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"null"),t("span",{style:{color:"#24292E"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                lastWaiter "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"null"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            first.nextWaiter "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"null"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        } "),t("span",{style:{color:"#D73A49"}},"while"),t("span",{style:{color:"#24292E"}}," (")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#6A737D"}},"// 将等待队列中的 Node 转移至 AQS 队列, 不成功且还有节点则继续循环 ㈢")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#D73A49"}},"!"),t("span",{style:{color:"#6F42C1"}},"transferForSignal"),t("span",{style:{color:"#24292E"}},"(first) "),t("span",{style:{color:"#D73A49"}},"&&")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                        "),t("span",{style:{color:"#6A737D"}},"// 队列还有节点")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                        (first "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," firstWaiter) "),t("span",{style:{color:"#D73A49"}},"!="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"null")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        );")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    }")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// 外部类方法, 方便阅读, 放在此处")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// ㈢ 如果节点状态是取消, 返回 false 表示转移失败, 否则转移成功")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"final"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"boolean"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"transferForSignal"),t("span",{style:{color:"#24292E"}},"(Node "),t("span",{style:{color:"#E36209"}},"node"),t("span",{style:{color:"#24292E"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6A737D"}},"// 设置当前node状态为0（因为处在队列末尾），如果状态已经不是 Node.CONDITION, 说明被取消了")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," ("),t("span",{style:{color:"#D73A49"}},"!"),t("span",{style:{color:"#6F42C1"}},"compareAndSetWaitStatus"),t("span",{style:{color:"#24292E"}},"(node, Node.CONDITION, "),t("span",{style:{color:"#005CC5"}},"0"),t("span",{style:{color:"#24292E"}},"))")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"return"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"false"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6A737D"}},"// 加入 AQS 队列尾部")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        Node p "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"enq"),t("span",{style:{color:"#24292E"}},"(node);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," ws "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," p.waitStatus;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#6A737D"}},"// 插入节点的上一个节点被取消")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                ws "),t("span",{style:{color:"#D73A49"}},">"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"0"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"||")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                        "),t("span",{style:{color:"#6A737D"}},"// 插入节点的上一个节点不能设置状态为 Node.SIGNAL")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                        "),t("span",{style:{color:"#D73A49"}},"!"),t("span",{style:{color:"#6F42C1"}},"compareAndSetWaitStatus"),t("span",{style:{color:"#24292E"}},"(p, ws, Node.SIGNAL)")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        ) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#6A737D"}},"// unpark 取消阻塞, 让线程重新同步状态")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            LockSupport."),t("span",{style:{color:"#6F42C1"}},"unpark"),t("span",{style:{color:"#24292E"}},"(node.thread);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"return"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"true"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// 全部唤醒 - 等待队列的所有节点转移至 AQS 队列")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"private"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"void"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"doSignalAll"),t("span",{style:{color:"#24292E"}},"(Node "),t("span",{style:{color:"#E36209"}},"first"),t("span",{style:{color:"#24292E"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    lastWaiter "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," firstWaiter "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"null"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"do"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        Node next "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," first.nextWaiter;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        first.nextWaiter "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"null"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6F42C1"}},"transferForSignal"),t("span",{style:{color:"#24292E"}},"(first);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        first "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," next;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    } "),t("span",{style:{color:"#D73A49"}},"while"),t("span",{style:{color:"#24292E"}}," (first "),t("span",{style:{color:"#D73A49"}},"!="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"null"),t("span",{style:{color:"#24292E"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"}")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// ㈡")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"private"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"void"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"unlinkCancelledWaiters"),t("span",{style:{color:"#24292E"}},"() {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6A737D"}},"// ...")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// 唤醒 - 必须持有锁才能唤醒, 因此 doSignal 内无需考虑加锁")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"public"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"final"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"void"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"signal"),t("span",{style:{color:"#24292E"}},"() {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6A737D"}},"// 如果没有持有锁，会抛出异常")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," ("),t("span",{style:{color:"#D73A49"}},"!"),t("span",{style:{color:"#6F42C1"}},"isHeldExclusively"),t("span",{style:{color:"#24292E"}},"())")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"throw"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"new"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"IllegalMonitorStateException"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        Node first "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," firstWaiter;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (first "),t("span",{style:{color:"#D73A49"}},"!="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"null"),t("span",{style:{color:"#24292E"}},")")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#6F42C1"}},"doSignal"),t("span",{style:{color:"#24292E"}},"(first);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// 全部唤醒 - 必须持有锁才能唤醒, 因此 doSignalAll 内无需考虑加锁")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"public"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"final"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"void"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"signalAll"),t("span",{style:{color:"#24292E"}},"() {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," ("),t("span",{style:{color:"#D73A49"}},"!"),t("span",{style:{color:"#6F42C1"}},"isHeldExclusively"),t("span",{style:{color:"#24292E"}},"())")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"throw"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"new"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"IllegalMonitorStateException"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        Node first "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," firstWaiter;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (first "),t("span",{style:{color:"#D73A49"}},"!="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"null"),t("span",{style:{color:"#24292E"}},")")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#6F42C1"}},"doSignalAll"),t("span",{style:{color:"#24292E"}},"(first);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// 不可打断等待 - 直到被唤醒")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"public"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"final"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"void"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"awaitUninterruptibly"),t("span",{style:{color:"#24292E"}},"() {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6A737D"}},"// 添加一个 Node 至等待队列, 见 ㈠")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        Node node "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"addConditionWaiter"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6A737D"}},"// 释放节点持有的锁, 见 ㈣")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," savedState "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"fullyRelease"),t("span",{style:{color:"#24292E"}},"(node);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"boolean"),t("span",{style:{color:"#24292E"}}," interrupted "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"false"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6A737D"}},"// 如果该节点还没有转移至 AQS 队列, 阻塞")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"while"),t("span",{style:{color:"#24292E"}}," ("),t("span",{style:{color:"#D73A49"}},"!"),t("span",{style:{color:"#6F42C1"}},"isOnSyncQueue"),t("span",{style:{color:"#24292E"}},"(node)) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#6A737D"}},"// park 阻塞")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            LockSupport."),t("span",{style:{color:"#6F42C1"}},"park"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#005CC5"}},"this"),t("span",{style:{color:"#24292E"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#6A737D"}},"// 如果被打断, 仅设置打断状态")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (Thread."),t("span",{style:{color:"#6F42C1"}},"interrupted"),t("span",{style:{color:"#24292E"}},"())")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                interrupted "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"true"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6A737D"}},"// 唤醒后, 尝试竞争锁, 如果失败进入 AQS 队列")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," ("),t("span",{style:{color:"#6F42C1"}},"acquireQueued"),t("span",{style:{color:"#24292E"}},"(node, savedState) "),t("span",{style:{color:"#D73A49"}},"||"),t("span",{style:{color:"#24292E"}}," interrupted)")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#6F42C1"}},"selfInterrupt"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// 外部类方法, 方便阅读, 放在此处")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// ㈣ 因为某线程可能重入，需要将 state 全部释放，获取state，然后把它全部减掉，以全部释放")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"final"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"fullyRelease"),t("span",{style:{color:"#24292E"}},"(Node "),t("span",{style:{color:"#E36209"}},"node"),t("span",{style:{color:"#24292E"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"boolean"),t("span",{style:{color:"#24292E"}}," failed "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"true"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"try"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," savedState "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"getState"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#6A737D"}},"// 唤醒等待队列队列中的下一个节点")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," ("),t("span",{style:{color:"#6F42C1"}},"release"),t("span",{style:{color:"#24292E"}},"(savedState)) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                failed "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"false"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#D73A49"}},"return"),t("span",{style:{color:"#24292E"}}," savedState;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            } "),t("span",{style:{color:"#D73A49"}},"else"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#D73A49"}},"throw"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"new"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"IllegalMonitorStateException"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        } "),t("span",{style:{color:"#D73A49"}},"finally"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (failed)")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                node.waitStatus "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," Node.CANCELLED;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// 打断模式 - 在退出等待时重新设置打断状态")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"private"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"static"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"final"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," REINTERRUPT "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"1"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// 打断模式 - 在退出等待时抛出异常")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"private"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"static"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"final"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," THROW_IE "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"-"),t("span",{style:{color:"#005CC5"}},"1"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// 判断打断模式")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"private"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"checkInterruptWhileWaiting"),t("span",{style:{color:"#24292E"}},"(Node "),t("span",{style:{color:"#E36209"}},"node"),t("span",{style:{color:"#24292E"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"return"),t("span",{style:{color:"#24292E"}}," Thread."),t("span",{style:{color:"#6F42C1"}},"interrupted"),t("span",{style:{color:"#24292E"}},"() "),t("span",{style:{color:"#D73A49"}},"?")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                ("),t("span",{style:{color:"#6F42C1"}},"transferAfterCancelledWait"),t("span",{style:{color:"#24292E"}},"(node) "),t("span",{style:{color:"#D73A49"}},"?"),t("span",{style:{color:"#24292E"}}," THROW_IE "),t("span",{style:{color:"#D73A49"}},":"),t("span",{style:{color:"#24292E"}}," REINTERRUPT) "),t("span",{style:{color:"#D73A49"}},":")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#005CC5"}},"0"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// ㈤ 应用打断模式")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"private"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"void"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"reportInterruptAfterWait"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#E36209"}},"interruptMode"),t("span",{style:{color:"#24292E"}},")")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"throws"),t("span",{style:{color:"#24292E"}}," InterruptedException {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (interruptMode "),t("span",{style:{color:"#D73A49"}},"=="),t("span",{style:{color:"#24292E"}}," THROW_IE)")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"throw"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"new"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"InterruptedException"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"else"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (interruptMode "),t("span",{style:{color:"#D73A49"}},"=="),t("span",{style:{color:"#24292E"}}," REINTERRUPT)")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#6F42C1"}},"selfInterrupt"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// 等待 - 直到被唤醒或打断")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"public"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"final"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"void"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"await"),t("span",{style:{color:"#24292E"}},"() "),t("span",{style:{color:"#D73A49"}},"throws"),t("span",{style:{color:"#24292E"}}," InterruptedException {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (Thread."),t("span",{style:{color:"#6F42C1"}},"interrupted"),t("span",{style:{color:"#24292E"}},"()) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"throw"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"new"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"InterruptedException"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6A737D"}},"// 添加一个 Node 至等待队列, 见 ㈠")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        Node node "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"addConditionWaiter"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6A737D"}},"// 释放节点持有的锁")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," savedState "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"fullyRelease"),t("span",{style:{color:"#24292E"}},"(node);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," interruptMode "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"0"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6A737D"}},"// 如果该节点还没有转移至 AQS 队列, 阻塞")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"while"),t("span",{style:{color:"#24292E"}}," ("),t("span",{style:{color:"#D73A49"}},"!"),t("span",{style:{color:"#6F42C1"}},"isOnSyncQueue"),t("span",{style:{color:"#24292E"}},"(node)) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#6A737D"}},"// park 阻塞              ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            LockSupport."),t("span",{style:{color:"#6F42C1"}},"park"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#005CC5"}},"this"),t("span",{style:{color:"#24292E"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#6A737D"}},"// 如果被打断, 退出等待队列")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," ((interruptMode "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"checkInterruptWhileWaiting"),t("span",{style:{color:"#24292E"}},"(node)) "),t("span",{style:{color:"#D73A49"}},"!="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"0"),t("span",{style:{color:"#24292E"}},")")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#D73A49"}},"break"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6A737D"}},"// 退出等待队列后, 还需要获得 AQS 队列的锁")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," ("),t("span",{style:{color:"#6F42C1"}},"acquireQueued"),t("span",{style:{color:"#24292E"}},"(node, savedState) "),t("span",{style:{color:"#D73A49"}},"&&"),t("span",{style:{color:"#24292E"}}," interruptMode "),t("span",{style:{color:"#D73A49"}},"!="),t("span",{style:{color:"#24292E"}}," THROW_IE)")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            interruptMode "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," REINTERRUPT;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6A737D"}},"// 所有已取消的 Node 从队列链表删除, 见 ㈡")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (node.nextWaiter "),t("span",{style:{color:"#D73A49"}},"!="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"null"),t("span",{style:{color:"#24292E"}},")")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#6F42C1"}},"unlinkCancelledWaiters"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6A737D"}},"// 应用打断模式, 见 ㈤")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (interruptMode "),t("span",{style:{color:"#D73A49"}},"!="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"0"),t("span",{style:{color:"#24292E"}},")")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#6F42C1"}},"reportInterruptAfterWait"),t("span",{style:{color:"#24292E"}},"(interruptMode);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// 等待 - 直到被唤醒或打断或超时")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"public"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"final"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"long"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"awaitNanos"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#D73A49"}},"long"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#E36209"}},"nanosTimeout"),t("span",{style:{color:"#24292E"}},") "),t("span",{style:{color:"#D73A49"}},"throws"),t("span",{style:{color:"#24292E"}}," InterruptedException {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (Thread."),t("span",{style:{color:"#6F42C1"}},"interrupted"),t("span",{style:{color:"#24292E"}},"()) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"throw"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"new"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"InterruptedException"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6A737D"}},"// 添加一个 Node 至等待队列, 见 ㈠")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        Node node "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"addConditionWaiter"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6A737D"}},"// 释放节点持有的锁")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," savedState "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"fullyRelease"),t("span",{style:{color:"#24292E"}},"(node);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6A737D"}},"// 获得最后期限")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"final"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"long"),t("span",{style:{color:"#24292E"}}," deadline "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," System."),t("span",{style:{color:"#6F42C1"}},"nanoTime"),t("span",{style:{color:"#24292E"}},"() "),t("span",{style:{color:"#D73A49"}},"+"),t("span",{style:{color:"#24292E"}}," nanosTimeout;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," interruptMode "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"0"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6A737D"}},"// 如果该节点还没有转移至 AQS 队列, 阻塞")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"while"),t("span",{style:{color:"#24292E"}}," ("),t("span",{style:{color:"#D73A49"}},"!"),t("span",{style:{color:"#6F42C1"}},"isOnSyncQueue"),t("span",{style:{color:"#24292E"}},"(node)) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#6A737D"}},"// 已超时, 退出等待队列")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (nanosTimeout "),t("span",{style:{color:"#D73A49"}},"<="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"0L"),t("span",{style:{color:"#24292E"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#6F42C1"}},"transferAfterCancelledWait"),t("span",{style:{color:"#24292E"}},"(node);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#D73A49"}},"break"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#6A737D"}},"// park 阻塞一定时间, spinForTimeoutThreshold 为 1000 ns")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (nanosTimeout "),t("span",{style:{color:"#D73A49"}},">="),t("span",{style:{color:"#24292E"}}," spinForTimeoutThreshold)")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                LockSupport."),t("span",{style:{color:"#6F42C1"}},"parkNanos"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#005CC5"}},"this"),t("span",{style:{color:"#24292E"}},", nanosTimeout);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#6A737D"}},"// 如果被打断, 退出等待队列")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," ((interruptMode "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"checkInterruptWhileWaiting"),t("span",{style:{color:"#24292E"}},"(node)) "),t("span",{style:{color:"#D73A49"}},"!="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"0"),t("span",{style:{color:"#24292E"}},")")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#D73A49"}},"break"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            nanosTimeout "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," deadline "),t("span",{style:{color:"#D73A49"}},"-"),t("span",{style:{color:"#24292E"}}," System."),t("span",{style:{color:"#6F42C1"}},"nanoTime"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6A737D"}},"// 退出等待队列后, 还需要获得 AQS 队列的锁")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," ("),t("span",{style:{color:"#6F42C1"}},"acquireQueued"),t("span",{style:{color:"#24292E"}},"(node, savedState) "),t("span",{style:{color:"#D73A49"}},"&&"),t("span",{style:{color:"#24292E"}}," interruptMode "),t("span",{style:{color:"#D73A49"}},"!="),t("span",{style:{color:"#24292E"}}," THROW_IE)")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            interruptMode "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," REINTERRUPT;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6A737D"}},"// 所有已取消的 Node 从队列链表删除, 见 ㈡")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (node.nextWaiter "),t("span",{style:{color:"#D73A49"}},"!="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"null"),t("span",{style:{color:"#24292E"}},")")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#6F42C1"}},"unlinkCancelledWaiters"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6A737D"}},"// 应用打断模式, 见 ㈤")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (interruptMode "),t("span",{style:{color:"#D73A49"}},"!="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"0"),t("span",{style:{color:"#24292E"}},")")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#6F42C1"}},"reportInterruptAfterWait"),t("span",{style:{color:"#24292E"}},"(interruptMode);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"return"),t("span",{style:{color:"#24292E"}}," deadline "),t("span",{style:{color:"#D73A49"}},"-"),t("span",{style:{color:"#24292E"}}," System."),t("span",{style:{color:"#6F42C1"}},"nanoTime"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// 等待 - 直到被唤醒或打断或超时, 逻辑类似于 awaitNanos")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"public"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"final"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"boolean"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"awaitUntil"),t("span",{style:{color:"#24292E"}},"(Date "),t("span",{style:{color:"#E36209"}},"deadline"),t("span",{style:{color:"#24292E"}},") "),t("span",{style:{color:"#D73A49"}},"throws"),t("span",{style:{color:"#24292E"}}," InterruptedException {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6A737D"}},"// ...")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// 等待 - 直到被唤醒或打断或超时, 逻辑类似于 awaitNanos")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"public"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"final"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"boolean"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"await"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#D73A49"}},"long"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#E36209"}},"time"),t("span",{style:{color:"#24292E"}},", TimeUnit "),t("span",{style:{color:"#E36209"}},"unit"),t("span",{style:{color:"#24292E"}},") "),t("span",{style:{color:"#D73A49"}},"throws"),t("span",{style:{color:"#24292E"}}," InterruptedException {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6A737D"}},"// ...")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// 工具方法 省略 ...")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"}")])])])],-1),Rn={id:"_3、读写锁",tabindex:"-1"},On={id:"reentrantreadwritelock",tabindex:"-1"},qn=t("p",null,[p("当读操作远远高于写操作时，这时候使用 读写锁 让 读-读 可以并发，提高性能。 类似于数据库中的 "),t("code",null,"select ... from ... lock in share mode"),p(" 提供一个 数据容器类 内部分别使用读锁保护数据的 read() 方法，写锁保护数据的 write() 方法")],-1),Pn=t("div",{class:"language-java"},[t("button",{title:"Copy Code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki github-dark vp-code-dark"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"@"),t("span",{style:{color:"#F97583"}},"Slf4j"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#79B8FF"}},"topic"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#9ECBFF"}},'"c.DataContainer"'),t("span",{style:{color:"#E1E4E8"}},")")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"class"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"DataContainer"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"private"),t("span",{style:{color:"#E1E4E8"}}," Object data;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"private"),t("span",{style:{color:"#E1E4E8"}}," ReentrantReadWriteLock rw "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"new"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"ReentrantReadWriteLock"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"private"),t("span",{style:{color:"#E1E4E8"}}," ReentrantReadWriteLock.ReadLock r "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," rw."),t("span",{style:{color:"#B392F0"}},"readLock"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"private"),t("span",{style:{color:"#E1E4E8"}}," ReentrantReadWriteLock.WriteLock w "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," rw."),t("span",{style:{color:"#B392F0"}},"writeLock"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"public"),t("span",{style:{color:"#E1E4E8"}}," Object "),t("span",{style:{color:"#B392F0"}},"read"),t("span",{style:{color:"#E1E4E8"}},"() {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        log."),t("span",{style:{color:"#B392F0"}},"debug"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#9ECBFF"}},'"获取读锁..."'),t("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        r."),t("span",{style:{color:"#B392F0"}},"lock"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"try"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            log."),t("span",{style:{color:"#B392F0"}},"debug"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#9ECBFF"}},'"读取"'),t("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#B392F0"}},"sleep"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#79B8FF"}},"1"),t("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"return"),t("span",{style:{color:"#E1E4E8"}}," data;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        } "),t("span",{style:{color:"#F97583"}},"finally"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            log."),t("span",{style:{color:"#B392F0"}},"debug"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#9ECBFF"}},'"释放读锁..."'),t("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            r."),t("span",{style:{color:"#B392F0"}},"unlock"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"public"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"void"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"write"),t("span",{style:{color:"#E1E4E8"}},"() {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        log."),t("span",{style:{color:"#B392F0"}},"debug"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#9ECBFF"}},'"获取写锁..."'),t("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        w."),t("span",{style:{color:"#B392F0"}},"lock"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"try"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            log."),t("span",{style:{color:"#B392F0"}},"debug"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#9ECBFF"}},'"写入"'),t("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#B392F0"}},"sleep"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#79B8FF"}},"1"),t("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        } "),t("span",{style:{color:"#F97583"}},"finally"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            log."),t("span",{style:{color:"#B392F0"}},"debug"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#9ECBFF"}},'"释放写锁..."'),t("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            w."),t("span",{style:{color:"#B392F0"}},"unlock"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"}")])])]),t("pre",{class:"shiki github-light vp-code-light"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"@"),t("span",{style:{color:"#D73A49"}},"Slf4j"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#005CC5"}},"topic"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#032F62"}},'"c.DataContainer"'),t("span",{style:{color:"#24292E"}},")")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"class"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"DataContainer"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"private"),t("span",{style:{color:"#24292E"}}," Object data;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"private"),t("span",{style:{color:"#24292E"}}," ReentrantReadWriteLock rw "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"new"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"ReentrantReadWriteLock"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"private"),t("span",{style:{color:"#24292E"}}," ReentrantReadWriteLock.ReadLock r "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," rw."),t("span",{style:{color:"#6F42C1"}},"readLock"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"private"),t("span",{style:{color:"#24292E"}}," ReentrantReadWriteLock.WriteLock w "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," rw."),t("span",{style:{color:"#6F42C1"}},"writeLock"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"public"),t("span",{style:{color:"#24292E"}}," Object "),t("span",{style:{color:"#6F42C1"}},"read"),t("span",{style:{color:"#24292E"}},"() {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        log."),t("span",{style:{color:"#6F42C1"}},"debug"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#032F62"}},'"获取读锁..."'),t("span",{style:{color:"#24292E"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        r."),t("span",{style:{color:"#6F42C1"}},"lock"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"try"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            log."),t("span",{style:{color:"#6F42C1"}},"debug"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#032F62"}},'"读取"'),t("span",{style:{color:"#24292E"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#6F42C1"}},"sleep"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#005CC5"}},"1"),t("span",{style:{color:"#24292E"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"return"),t("span",{style:{color:"#24292E"}}," data;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        } "),t("span",{style:{color:"#D73A49"}},"finally"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            log."),t("span",{style:{color:"#6F42C1"}},"debug"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#032F62"}},'"释放读锁..."'),t("span",{style:{color:"#24292E"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            r."),t("span",{style:{color:"#6F42C1"}},"unlock"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    }")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"public"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"void"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"write"),t("span",{style:{color:"#24292E"}},"() {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        log."),t("span",{style:{color:"#6F42C1"}},"debug"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#032F62"}},'"获取写锁..."'),t("span",{style:{color:"#24292E"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        w."),t("span",{style:{color:"#6F42C1"}},"lock"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"try"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            log."),t("span",{style:{color:"#6F42C1"}},"debug"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#032F62"}},'"写入"'),t("span",{style:{color:"#24292E"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#6F42C1"}},"sleep"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#005CC5"}},"1"),t("span",{style:{color:"#24292E"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        } "),t("span",{style:{color:"#D73A49"}},"finally"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            log."),t("span",{style:{color:"#6F42C1"}},"debug"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#032F62"}},'"释放写锁..."'),t("span",{style:{color:"#24292E"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            w."),t("span",{style:{color:"#6F42C1"}},"unlock"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"}")])])])],-1),zn=t("p",null,"测试 读锁-读锁 可以并发",-1),_n=t("div",{class:"language-java"},[t("button",{title:"Copy Code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki github-dark vp-code-dark"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"DataContainer dataContainer "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"new"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"DataContainer"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"new"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"Thread"),t("span",{style:{color:"#E1E4E8"}},"(() "),t("span",{style:{color:"#F97583"}},"->"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"dataContainer."),t("span",{style:{color:"#B392F0"}},"read"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"}, "),t("span",{style:{color:"#9ECBFF"}},'"t1"'),t("span",{style:{color:"#E1E4E8"}},")."),t("span",{style:{color:"#B392F0"}},"start"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"new"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"Thread"),t("span",{style:{color:"#E1E4E8"}},"(() "),t("span",{style:{color:"#F97583"}},"->"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"dataContainer."),t("span",{style:{color:"#B392F0"}},"read"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"}, "),t("span",{style:{color:"#9ECBFF"}},'"t2"'),t("span",{style:{color:"#E1E4E8"}},")."),t("span",{style:{color:"#B392F0"}},"start"),t("span",{style:{color:"#E1E4E8"}},"();")])])]),t("pre",{class:"shiki github-light vp-code-light"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"DataContainer dataContainer "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"new"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"DataContainer"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"new"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"Thread"),t("span",{style:{color:"#24292E"}},"(() "),t("span",{style:{color:"#D73A49"}},"->"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"dataContainer."),t("span",{style:{color:"#6F42C1"}},"read"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"}, "),t("span",{style:{color:"#032F62"}},'"t1"'),t("span",{style:{color:"#24292E"}},")."),t("span",{style:{color:"#6F42C1"}},"start"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"new"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"Thread"),t("span",{style:{color:"#24292E"}},"(() "),t("span",{style:{color:"#D73A49"}},"->"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"dataContainer."),t("span",{style:{color:"#6F42C1"}},"read"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"}, "),t("span",{style:{color:"#032F62"}},'"t2"'),t("span",{style:{color:"#24292E"}},")."),t("span",{style:{color:"#6F42C1"}},"start"),t("span",{style:{color:"#24292E"}},"();")])])])],-1),Kn=t("figure",null,[t("img",{src:"https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230719173420253.png",alt:"image-20230719173420253",loading:"lazy",decoding:"async"})],-1),Vn=t("p",null,"测试 读锁-写锁 相互阻塞",-1),Mn=t("div",{class:"language-java"},[t("button",{title:"Copy Code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki github-dark vp-code-dark"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"DataContainer dataContainer "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"new"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"DataContainer"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"new"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"Thread"),t("span",{style:{color:"#E1E4E8"}},"(() "),t("span",{style:{color:"#F97583"}},"->"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"dataContainer."),t("span",{style:{color:"#B392F0"}},"read"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"}, "),t("span",{style:{color:"#9ECBFF"}},'"t1"'),t("span",{style:{color:"#E1E4E8"}},")."),t("span",{style:{color:"#B392F0"}},"start"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"Thread."),t("span",{style:{color:"#B392F0"}},"sleep"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#79B8FF"}},"100"),t("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"new"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"Thread"),t("span",{style:{color:"#E1E4E8"}},"(() "),t("span",{style:{color:"#F97583"}},"->"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"dataContainer."),t("span",{style:{color:"#B392F0"}},"write"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"}, "),t("span",{style:{color:"#9ECBFF"}},'"t2"'),t("span",{style:{color:"#E1E4E8"}},")."),t("span",{style:{color:"#B392F0"}},"start"),t("span",{style:{color:"#E1E4E8"}},"();")])])]),t("pre",{class:"shiki github-light vp-code-light"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"DataContainer dataContainer "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"new"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"DataContainer"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"new"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"Thread"),t("span",{style:{color:"#24292E"}},"(() "),t("span",{style:{color:"#D73A49"}},"->"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"dataContainer."),t("span",{style:{color:"#6F42C1"}},"read"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"}, "),t("span",{style:{color:"#032F62"}},'"t1"'),t("span",{style:{color:"#24292E"}},")."),t("span",{style:{color:"#6F42C1"}},"start"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"Thread."),t("span",{style:{color:"#6F42C1"}},"sleep"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#005CC5"}},"100"),t("span",{style:{color:"#24292E"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"new"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"Thread"),t("span",{style:{color:"#24292E"}},"(() "),t("span",{style:{color:"#D73A49"}},"->"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"dataContainer."),t("span",{style:{color:"#6F42C1"}},"write"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"}, "),t("span",{style:{color:"#032F62"}},'"t2"'),t("span",{style:{color:"#24292E"}},")."),t("span",{style:{color:"#6F42C1"}},"start"),t("span",{style:{color:"#24292E"}},"();")])])])],-1),Wn=t("figure",null,[t("img",{src:"https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230719173452532.png",alt:"image-20230719173452532",loading:"lazy",decoding:"async"})],-1),Un=t("p",null,"写锁-写锁 也是相互阻塞的",-1),Qn=t("p",null,[t("strong",null,"注意事项")],-1),Hn=t("ul",null,[t("li",null,"读锁不支持条件变量"),t("li",null,"重入时升级不支持：即持有读锁的情况下去获取写锁，会导致获取写锁永久等待")],-1),Gn=t("div",{class:"language-java"},[t("button",{title:"Copy Code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki github-dark vp-code-dark"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"r."),t("span",{style:{color:"#B392F0"}},"lock"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"try"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#6A737D"}},"// ...")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            w."),t("span",{style:{color:"#B392F0"}},"lock"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"try"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#6A737D"}},"// ...")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            } "),t("span",{style:{color:"#F97583"}},"finally"),t("span",{style:{color:"#E1E4E8"}},"{")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                w."),t("span",{style:{color:"#B392F0"}},"unlock"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        } "),t("span",{style:{color:"#F97583"}},"finally"),t("span",{style:{color:"#E1E4E8"}},"{")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            r."),t("span",{style:{color:"#B392F0"}},"unlock"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        }")])])]),t("pre",{class:"shiki github-light vp-code-light"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"r."),t("span",{style:{color:"#6F42C1"}},"lock"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"try"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#6A737D"}},"// ...")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            w."),t("span",{style:{color:"#6F42C1"}},"lock"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"try"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#6A737D"}},"// ...")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            } "),t("span",{style:{color:"#D73A49"}},"finally"),t("span",{style:{color:"#24292E"}},"{")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                w."),t("span",{style:{color:"#6F42C1"}},"unlock"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        } "),t("span",{style:{color:"#D73A49"}},"finally"),t("span",{style:{color:"#24292E"}},"{")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            r."),t("span",{style:{color:"#6F42C1"}},"unlock"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        }")])])])],-1),Jn=t("ul",null,[t("li",null,"重入时降级支持：即持有写锁的情况下去获取读锁")],-1),Yn=t("div",{class:"language-java"},[t("button",{title:"Copy Code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki github-dark vp-code-dark"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"class"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"CachedData"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    Object data;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// 是否有效，如果失效，需要重新计算 data")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"volatile"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"boolean"),t("span",{style:{color:"#E1E4E8"}}," cacheValid;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"final"),t("span",{style:{color:"#E1E4E8"}}," ReentrantReadWriteLock rwl "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"new"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"ReentrantReadWriteLock"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"void"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"processCachedData"),t("span",{style:{color:"#E1E4E8"}},"() {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        rwl."),t("span",{style:{color:"#B392F0"}},"readLock"),t("span",{style:{color:"#E1E4E8"}},"()."),t("span",{style:{color:"#B392F0"}},"lock"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," ("),t("span",{style:{color:"#F97583"}},"!"),t("span",{style:{color:"#E1E4E8"}},"cacheValid) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#6A737D"}},"// 获取写锁前必须释放读锁")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            rwl."),t("span",{style:{color:"#B392F0"}},"readLock"),t("span",{style:{color:"#E1E4E8"}},"()."),t("span",{style:{color:"#B392F0"}},"unlock"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            rwl."),t("span",{style:{color:"#B392F0"}},"writeLock"),t("span",{style:{color:"#E1E4E8"}},"()."),t("span",{style:{color:"#B392F0"}},"lock"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"try"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#6A737D"}},"// 判断是否有其它线程已经获取了写锁、更新了缓存, 避免重复更新")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," ("),t("span",{style:{color:"#F97583"}},"!"),t("span",{style:{color:"#E1E4E8"}},"cacheValid) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                    data "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," ...")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                    cacheValid "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"true"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#6A737D"}},"// 降级为读锁, 释放写锁, 这样能够让其它线程读取缓存")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                rwl."),t("span",{style:{color:"#B392F0"}},"readLock"),t("span",{style:{color:"#E1E4E8"}},"()."),t("span",{style:{color:"#B392F0"}},"lock"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            } "),t("span",{style:{color:"#F97583"}},"finally"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                rwl."),t("span",{style:{color:"#B392F0"}},"writeLock"),t("span",{style:{color:"#E1E4E8"}},"()."),t("span",{style:{color:"#B392F0"}},"unlock"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#6A737D"}},"// 自己用完数据, 释放读锁")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"try"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#B392F0"}},"use"),t("span",{style:{color:"#E1E4E8"}},"(data);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        } "),t("span",{style:{color:"#F97583"}},"finally"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            rwl."),t("span",{style:{color:"#B392F0"}},"readLock"),t("span",{style:{color:"#E1E4E8"}},"()."),t("span",{style:{color:"#B392F0"}},"unlock"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"}")])])]),t("pre",{class:"shiki github-light vp-code-light"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"class"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"CachedData"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    Object data;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// 是否有效，如果失效，需要重新计算 data")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"volatile"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"boolean"),t("span",{style:{color:"#24292E"}}," cacheValid;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"final"),t("span",{style:{color:"#24292E"}}," ReentrantReadWriteLock rwl "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"new"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"ReentrantReadWriteLock"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"void"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"processCachedData"),t("span",{style:{color:"#24292E"}},"() {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        rwl."),t("span",{style:{color:"#6F42C1"}},"readLock"),t("span",{style:{color:"#24292E"}},"()."),t("span",{style:{color:"#6F42C1"}},"lock"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," ("),t("span",{style:{color:"#D73A49"}},"!"),t("span",{style:{color:"#24292E"}},"cacheValid) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#6A737D"}},"// 获取写锁前必须释放读锁")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            rwl."),t("span",{style:{color:"#6F42C1"}},"readLock"),t("span",{style:{color:"#24292E"}},"()."),t("span",{style:{color:"#6F42C1"}},"unlock"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            rwl."),t("span",{style:{color:"#6F42C1"}},"writeLock"),t("span",{style:{color:"#24292E"}},"()."),t("span",{style:{color:"#6F42C1"}},"lock"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"try"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#6A737D"}},"// 判断是否有其它线程已经获取了写锁、更新了缓存, 避免重复更新")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," ("),t("span",{style:{color:"#D73A49"}},"!"),t("span",{style:{color:"#24292E"}},"cacheValid) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                    data "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," ...")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                    cacheValid "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"true"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#6A737D"}},"// 降级为读锁, 释放写锁, 这样能够让其它线程读取缓存")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                rwl."),t("span",{style:{color:"#6F42C1"}},"readLock"),t("span",{style:{color:"#24292E"}},"()."),t("span",{style:{color:"#6F42C1"}},"lock"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            } "),t("span",{style:{color:"#D73A49"}},"finally"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                rwl."),t("span",{style:{color:"#6F42C1"}},"writeLock"),t("span",{style:{color:"#24292E"}},"()."),t("span",{style:{color:"#6F42C1"}},"unlock"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6A737D"}},"// 自己用完数据, 释放读锁")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"try"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#6F42C1"}},"use"),t("span",{style:{color:"#24292E"}},"(data);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        } "),t("span",{style:{color:"#D73A49"}},"finally"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            rwl."),t("span",{style:{color:"#6F42C1"}},"readLock"),t("span",{style:{color:"#24292E"}},"()."),t("span",{style:{color:"#6F42C1"}},"unlock"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"}")])])])],-1),Xn={id:"应用之缓存",tabindex:"-1"},Zn={id:"缓存更新策略",tabindex:"-1"},$n=t("p",null,"更新时，是先清缓存还是先更新数据库？",-1),sa=t("p",null,"先清缓存",-1),la=t("figure",null,[t("img",{src:"https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230719180038159.png",alt:"image-20230719180038159",loading:"lazy",decoding:"async"})],-1),oa=t("p",null,"先更新数据库",-1),na=t("figure",null,[t("img",{src:"https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230719180054603.png",alt:"image-20230719180054603",loading:"lazy",decoding:"async"})],-1),aa=t("p",null,"补充一种情况，假设查询线程 A 查询数据时恰好缓存数据由于时间到期失效，或是第一次查询",-1),ea=t("figure",null,[t("img",{src:"https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230719180125357.png",alt:"image-20230719180125357",loading:"lazy",decoding:"async"})],-1),ca=t("p",null,"这种情况的出现几率非常小，见 facebook 论文",-1),ta={id:"读写锁实现一致性缓存",tabindex:"-1"},pa=t("p",null,"使用读写锁实现一个简单的按需加载缓存",-1),ra=t("div",{class:"language-java"},[t("button",{title:"Copy Code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki github-dark vp-code-dark"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"class"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"GenericDaoCached"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"extends"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"GenericDao"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"private"),t("span",{style:{color:"#E1E4E8"}}," GenericDao dao "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"new"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"GenericDao"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"private"),t("span",{style:{color:"#E1E4E8"}}," Map<"),t("span",{style:{color:"#F97583"}},"SqlPair"),t("span",{style:{color:"#E1E4E8"}},", "),t("span",{style:{color:"#F97583"}},"Object"),t("span",{style:{color:"#E1E4E8"}},"> map "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"new"),t("span",{style:{color:"#E1E4E8"}}," HashMap<>();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"private"),t("span",{style:{color:"#E1E4E8"}}," ReentrantReadWriteLock rw "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"new"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"ReentrantReadWriteLock"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    @"),t("span",{style:{color:"#F97583"}},"Override")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"public"),t("span",{style:{color:"#E1E4E8"}}," <"),t("span",{style:{color:"#F97583"}},"T"),t("span",{style:{color:"#E1E4E8"}},"> List<"),t("span",{style:{color:"#F97583"}},"T"),t("span",{style:{color:"#E1E4E8"}},"> "),t("span",{style:{color:"#B392F0"}},"queryList"),t("span",{style:{color:"#E1E4E8"}},"(Class<"),t("span",{style:{color:"#F97583"}},"T"),t("span",{style:{color:"#E1E4E8"}},"> "),t("span",{style:{color:"#FFAB70"}},"beanClass"),t("span",{style:{color:"#E1E4E8"}},", String "),t("span",{style:{color:"#FFAB70"}},"sql"),t("span",{style:{color:"#E1E4E8"}},", Object... "),t("span",{style:{color:"#FFAB70"}},"args"),t("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"return"),t("span",{style:{color:"#E1E4E8"}}," dao."),t("span",{style:{color:"#B392F0"}},"queryList"),t("span",{style:{color:"#E1E4E8"}},"(beanClass, sql, args);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    @"),t("span",{style:{color:"#F97583"}},"Override")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"public"),t("span",{style:{color:"#E1E4E8"}}," <"),t("span",{style:{color:"#F97583"}},"T"),t("span",{style:{color:"#E1E4E8"}},"> T "),t("span",{style:{color:"#B392F0"}},"queryOne"),t("span",{style:{color:"#E1E4E8"}},"(Class<"),t("span",{style:{color:"#F97583"}},"T"),t("span",{style:{color:"#E1E4E8"}},"> "),t("span",{style:{color:"#FFAB70"}},"beanClass"),t("span",{style:{color:"#E1E4E8"}},", String "),t("span",{style:{color:"#FFAB70"}},"sql"),t("span",{style:{color:"#E1E4E8"}},", Object... "),t("span",{style:{color:"#FFAB70"}},"args"),t("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#6A737D"}},"// 先从缓存中找，找到直接返回")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        SqlPair key "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"new"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"SqlPair"),t("span",{style:{color:"#E1E4E8"}},"(sql, args);;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        rw."),t("span",{style:{color:"#B392F0"}},"readLock"),t("span",{style:{color:"#E1E4E8"}},"()."),t("span",{style:{color:"#B392F0"}},"lock"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"try"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            T value "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," (T) map."),t("span",{style:{color:"#B392F0"}},"get"),t("span",{style:{color:"#E1E4E8"}},"(key);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}},"(value "),t("span",{style:{color:"#F97583"}},"!="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"null"),t("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#F97583"}},"return"),t("span",{style:{color:"#E1E4E8"}}," value;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        } "),t("span",{style:{color:"#F97583"}},"finally"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            rw."),t("span",{style:{color:"#B392F0"}},"readLock"),t("span",{style:{color:"#E1E4E8"}},"()."),t("span",{style:{color:"#B392F0"}},"unlock"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        rw."),t("span",{style:{color:"#B392F0"}},"writeLock"),t("span",{style:{color:"#E1E4E8"}},"()."),t("span",{style:{color:"#B392F0"}},"lock"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"try"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#6A737D"}},"// 多个线程")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            T value "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," (T) map."),t("span",{style:{color:"#B392F0"}},"get"),t("span",{style:{color:"#E1E4E8"}},"(key);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}},"(value "),t("span",{style:{color:"#F97583"}},"=="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"null"),t("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#6A737D"}},"// 缓存中没有，查询数据库")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                value "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," dao."),t("span",{style:{color:"#B392F0"}},"queryOne"),t("span",{style:{color:"#E1E4E8"}},"(beanClass, sql, args);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                map."),t("span",{style:{color:"#B392F0"}},"put"),t("span",{style:{color:"#E1E4E8"}},"(key, value);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"return"),t("span",{style:{color:"#E1E4E8"}}," value;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        } "),t("span",{style:{color:"#F97583"}},"finally"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            rw."),t("span",{style:{color:"#B392F0"}},"writeLock"),t("span",{style:{color:"#E1E4E8"}},"()."),t("span",{style:{color:"#B392F0"}},"unlock"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    @"),t("span",{style:{color:"#F97583"}},"Override")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"public"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"update"),t("span",{style:{color:"#E1E4E8"}},"(String "),t("span",{style:{color:"#FFAB70"}},"sql"),t("span",{style:{color:"#E1E4E8"}},", Object... "),t("span",{style:{color:"#FFAB70"}},"args"),t("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        rw."),t("span",{style:{color:"#B392F0"}},"writeLock"),t("span",{style:{color:"#E1E4E8"}},"()."),t("span",{style:{color:"#B392F0"}},"lock"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"try"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#6A737D"}},"// 先更新库")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," update "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," dao."),t("span",{style:{color:"#B392F0"}},"update"),t("span",{style:{color:"#E1E4E8"}},"(sql, args);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#6A737D"}},"// 清空缓存")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            map."),t("span",{style:{color:"#B392F0"}},"clear"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"return"),t("span",{style:{color:"#E1E4E8"}}," update;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        } "),t("span",{style:{color:"#F97583"}},"finally"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            rw."),t("span",{style:{color:"#B392F0"}},"writeLock"),t("span",{style:{color:"#E1E4E8"}},"()."),t("span",{style:{color:"#B392F0"}},"unlock"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"class"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"SqlPair"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"private"),t("span",{style:{color:"#E1E4E8"}}," String sql;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"private"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"Object"),t("span",{style:{color:"#E1E4E8"}},"[] args;")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"public"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"SqlPair"),t("span",{style:{color:"#E1E4E8"}},"(String "),t("span",{style:{color:"#FFAB70"}},"sql"),t("span",{style:{color:"#E1E4E8"}},", "),t("span",{style:{color:"#F97583"}},"Object"),t("span",{style:{color:"#E1E4E8"}},"[] "),t("span",{style:{color:"#FFAB70"}},"args"),t("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#79B8FF"}},"this"),t("span",{style:{color:"#E1E4E8"}},".sql "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," sql;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#79B8FF"}},"this"),t("span",{style:{color:"#E1E4E8"}},".args "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," args;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        }")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        @"),t("span",{style:{color:"#F97583"}},"Override")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"public"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"boolean"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"equals"),t("span",{style:{color:"#E1E4E8"}},"(Object "),t("span",{style:{color:"#FFAB70"}},"o"),t("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," ("),t("span",{style:{color:"#79B8FF"}},"this"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"=="),t("span",{style:{color:"#E1E4E8"}}," o) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#F97583"}},"return"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"true"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (o "),t("span",{style:{color:"#F97583"}},"=="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"null"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"||"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"getClass"),t("span",{style:{color:"#E1E4E8"}},"() "),t("span",{style:{color:"#F97583"}},"!="),t("span",{style:{color:"#E1E4E8"}}," o."),t("span",{style:{color:"#B392F0"}},"getClass"),t("span",{style:{color:"#E1E4E8"}},"()) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#F97583"}},"return"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"false"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            SqlPair sqlPair "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," (SqlPair) o;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"return"),t("span",{style:{color:"#E1E4E8"}}," Objects."),t("span",{style:{color:"#B392F0"}},"equals"),t("span",{style:{color:"#E1E4E8"}},"(sql, sqlPair.sql) "),t("span",{style:{color:"#F97583"}},"&&")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                    Arrays."),t("span",{style:{color:"#B392F0"}},"equals"),t("span",{style:{color:"#E1E4E8"}},"(args, sqlPair.args);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        }")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        @"),t("span",{style:{color:"#F97583"}},"Override")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"public"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"hashCode"),t("span",{style:{color:"#E1E4E8"}},"() {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," result "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," Objects."),t("span",{style:{color:"#B392F0"}},"hash"),t("span",{style:{color:"#E1E4E8"}},"(sql);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            result "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"31"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"*"),t("span",{style:{color:"#E1E4E8"}}," result "),t("span",{style:{color:"#F97583"}},"+"),t("span",{style:{color:"#E1E4E8"}}," Arrays."),t("span",{style:{color:"#B392F0"}},"hashCode"),t("span",{style:{color:"#E1E4E8"}},"(args);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"return"),t("span",{style:{color:"#E1E4E8"}}," result;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"}")])])]),t("pre",{class:"shiki github-light vp-code-light"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"class"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"GenericDaoCached"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"extends"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"GenericDao"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"private"),t("span",{style:{color:"#24292E"}}," GenericDao dao "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"new"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"GenericDao"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"private"),t("span",{style:{color:"#24292E"}}," Map<"),t("span",{style:{color:"#D73A49"}},"SqlPair"),t("span",{style:{color:"#24292E"}},", "),t("span",{style:{color:"#D73A49"}},"Object"),t("span",{style:{color:"#24292E"}},"> map "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"new"),t("span",{style:{color:"#24292E"}}," HashMap<>();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"private"),t("span",{style:{color:"#24292E"}}," ReentrantReadWriteLock rw "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"new"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"ReentrantReadWriteLock"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    @"),t("span",{style:{color:"#D73A49"}},"Override")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"public"),t("span",{style:{color:"#24292E"}}," <"),t("span",{style:{color:"#D73A49"}},"T"),t("span",{style:{color:"#24292E"}},"> List<"),t("span",{style:{color:"#D73A49"}},"T"),t("span",{style:{color:"#24292E"}},"> "),t("span",{style:{color:"#6F42C1"}},"queryList"),t("span",{style:{color:"#24292E"}},"(Class<"),t("span",{style:{color:"#D73A49"}},"T"),t("span",{style:{color:"#24292E"}},"> "),t("span",{style:{color:"#E36209"}},"beanClass"),t("span",{style:{color:"#24292E"}},", String "),t("span",{style:{color:"#E36209"}},"sql"),t("span",{style:{color:"#24292E"}},", Object... "),t("span",{style:{color:"#E36209"}},"args"),t("span",{style:{color:"#24292E"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"return"),t("span",{style:{color:"#24292E"}}," dao."),t("span",{style:{color:"#6F42C1"}},"queryList"),t("span",{style:{color:"#24292E"}},"(beanClass, sql, args);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    }")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    @"),t("span",{style:{color:"#D73A49"}},"Override")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"public"),t("span",{style:{color:"#24292E"}}," <"),t("span",{style:{color:"#D73A49"}},"T"),t("span",{style:{color:"#24292E"}},"> T "),t("span",{style:{color:"#6F42C1"}},"queryOne"),t("span",{style:{color:"#24292E"}},"(Class<"),t("span",{style:{color:"#D73A49"}},"T"),t("span",{style:{color:"#24292E"}},"> "),t("span",{style:{color:"#E36209"}},"beanClass"),t("span",{style:{color:"#24292E"}},", String "),t("span",{style:{color:"#E36209"}},"sql"),t("span",{style:{color:"#24292E"}},", Object... "),t("span",{style:{color:"#E36209"}},"args"),t("span",{style:{color:"#24292E"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6A737D"}},"// 先从缓存中找，找到直接返回")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        SqlPair key "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"new"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"SqlPair"),t("span",{style:{color:"#24292E"}},"(sql, args);;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        rw."),t("span",{style:{color:"#6F42C1"}},"readLock"),t("span",{style:{color:"#24292E"}},"()."),t("span",{style:{color:"#6F42C1"}},"lock"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"try"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            T value "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," (T) map."),t("span",{style:{color:"#6F42C1"}},"get"),t("span",{style:{color:"#24292E"}},"(key);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}},"(value "),t("span",{style:{color:"#D73A49"}},"!="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"null"),t("span",{style:{color:"#24292E"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#D73A49"}},"return"),t("span",{style:{color:"#24292E"}}," value;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        } "),t("span",{style:{color:"#D73A49"}},"finally"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            rw."),t("span",{style:{color:"#6F42C1"}},"readLock"),t("span",{style:{color:"#24292E"}},"()."),t("span",{style:{color:"#6F42C1"}},"unlock"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        rw."),t("span",{style:{color:"#6F42C1"}},"writeLock"),t("span",{style:{color:"#24292E"}},"()."),t("span",{style:{color:"#6F42C1"}},"lock"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"try"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#6A737D"}},"// 多个线程")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            T value "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," (T) map."),t("span",{style:{color:"#6F42C1"}},"get"),t("span",{style:{color:"#24292E"}},"(key);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}},"(value "),t("span",{style:{color:"#D73A49"}},"=="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"null"),t("span",{style:{color:"#24292E"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#6A737D"}},"// 缓存中没有，查询数据库")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                value "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," dao."),t("span",{style:{color:"#6F42C1"}},"queryOne"),t("span",{style:{color:"#24292E"}},"(beanClass, sql, args);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                map."),t("span",{style:{color:"#6F42C1"}},"put"),t("span",{style:{color:"#24292E"}},"(key, value);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"return"),t("span",{style:{color:"#24292E"}}," value;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        } "),t("span",{style:{color:"#D73A49"}},"finally"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            rw."),t("span",{style:{color:"#6F42C1"}},"writeLock"),t("span",{style:{color:"#24292E"}},"()."),t("span",{style:{color:"#6F42C1"}},"unlock"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    }")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    @"),t("span",{style:{color:"#D73A49"}},"Override")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"public"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"update"),t("span",{style:{color:"#24292E"}},"(String "),t("span",{style:{color:"#E36209"}},"sql"),t("span",{style:{color:"#24292E"}},", Object... "),t("span",{style:{color:"#E36209"}},"args"),t("span",{style:{color:"#24292E"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        rw."),t("span",{style:{color:"#6F42C1"}},"writeLock"),t("span",{style:{color:"#24292E"}},"()."),t("span",{style:{color:"#6F42C1"}},"lock"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"try"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#6A737D"}},"// 先更新库")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," update "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," dao."),t("span",{style:{color:"#6F42C1"}},"update"),t("span",{style:{color:"#24292E"}},"(sql, args);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#6A737D"}},"// 清空缓存")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            map."),t("span",{style:{color:"#6F42C1"}},"clear"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"return"),t("span",{style:{color:"#24292E"}}," update;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        } "),t("span",{style:{color:"#D73A49"}},"finally"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            rw."),t("span",{style:{color:"#6F42C1"}},"writeLock"),t("span",{style:{color:"#24292E"}},"()."),t("span",{style:{color:"#6F42C1"}},"unlock"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    }")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"class"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"SqlPair"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"private"),t("span",{style:{color:"#24292E"}}," String sql;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"private"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"Object"),t("span",{style:{color:"#24292E"}},"[] args;")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"public"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"SqlPair"),t("span",{style:{color:"#24292E"}},"(String "),t("span",{style:{color:"#E36209"}},"sql"),t("span",{style:{color:"#24292E"}},", "),t("span",{style:{color:"#D73A49"}},"Object"),t("span",{style:{color:"#24292E"}},"[] "),t("span",{style:{color:"#E36209"}},"args"),t("span",{style:{color:"#24292E"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#005CC5"}},"this"),t("span",{style:{color:"#24292E"}},".sql "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," sql;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#005CC5"}},"this"),t("span",{style:{color:"#24292E"}},".args "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," args;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        }")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        @"),t("span",{style:{color:"#D73A49"}},"Override")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"public"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"boolean"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"equals"),t("span",{style:{color:"#24292E"}},"(Object "),t("span",{style:{color:"#E36209"}},"o"),t("span",{style:{color:"#24292E"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," ("),t("span",{style:{color:"#005CC5"}},"this"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"=="),t("span",{style:{color:"#24292E"}}," o) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#D73A49"}},"return"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"true"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (o "),t("span",{style:{color:"#D73A49"}},"=="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"null"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"||"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"getClass"),t("span",{style:{color:"#24292E"}},"() "),t("span",{style:{color:"#D73A49"}},"!="),t("span",{style:{color:"#24292E"}}," o."),t("span",{style:{color:"#6F42C1"}},"getClass"),t("span",{style:{color:"#24292E"}},"()) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#D73A49"}},"return"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"false"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            SqlPair sqlPair "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," (SqlPair) o;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"return"),t("span",{style:{color:"#24292E"}}," Objects."),t("span",{style:{color:"#6F42C1"}},"equals"),t("span",{style:{color:"#24292E"}},"(sql, sqlPair.sql) "),t("span",{style:{color:"#D73A49"}},"&&")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                    Arrays."),t("span",{style:{color:"#6F42C1"}},"equals"),t("span",{style:{color:"#24292E"}},"(args, sqlPair.args);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        }")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        @"),t("span",{style:{color:"#D73A49"}},"Override")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"public"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"hashCode"),t("span",{style:{color:"#24292E"}},"() {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," result "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," Objects."),t("span",{style:{color:"#6F42C1"}},"hash"),t("span",{style:{color:"#24292E"}},"(sql);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            result "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"31"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"*"),t("span",{style:{color:"#24292E"}}," result "),t("span",{style:{color:"#D73A49"}},"+"),t("span",{style:{color:"#24292E"}}," Arrays."),t("span",{style:{color:"#6F42C1"}},"hashCode"),t("span",{style:{color:"#24292E"}},"(args);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"return"),t("span",{style:{color:"#24292E"}}," result;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    }")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"}")])])])],-1),Ea=t("blockquote",null,[t("p",null,"注意"),t("ul",null,[t("li",null,[p("以上实现体现的是读写锁的应用，保证缓存和数据库的一致性，但有下面的问题没有考虑 "),t("ul",null,[t("li",null,"适合读多写少，如果写操作比较频繁，以上实现性能低"),t("li",null,"没有考虑缓存容量"),t("li",null,"没有考虑缓存过期"),t("li",null,"只适合单机"),t("li",null,"并发性还是低，目前只会用一把锁"),t("li",null,"更新方法太过简单粗暴，清空了所有 key（考虑按类型分区或重新设计 key）"),t("li",null,"乐观锁实现：用 CAS 去更新")])])])],-1),ya={id:"读写锁原理",tabindex:"-1"},ia={id:"图解流程",tabindex:"-1"},Fa=t("p",null,"读写锁用的是同一个 Sycn 同步器，因此等待队列、state 等也是同一个",-1),ua={id:"t1-w-lock-t2-r-lock",tabindex:"-1"},Aa=t("p",null,"1） t1 成功上锁，流程与 ReentrantLock 加锁相比没有特殊之处，不同是写锁状态占了 state 的低 16 位，而读锁 使用的是 state 的高 16 位",-1),da=t("figure",null,[t("img",{src:"https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230719182530369.png",alt:"image-20230719182530369",loading:"lazy",decoding:"async"})],-1),Da=t("p",null,"2）t2 执行 r.lock，这时进入读锁的 sync.acquireShared(1) 流程，首先会进入 tryAcquireShared 流程。如果有写 锁占据，那么 tryAcquireShared 返回 -1 表示失败",-1),Ca=t("blockquote",null,[t("p",null,"tryAcquireShared 返回值表示"),t("ol",null,[t("li",null,"-1 表示失败"),t("li",null,"0 表示成功，但后继节点不会继续唤醒"),t("li",null,"正数表示成功，而且数值是还有几个后继节点需要唤醒，我们这里的读写锁返回 1")])],-1),ha=t("figure",null,[t("img",{src:"https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230719190455870.png",alt:"image-20230719190455870",loading:"lazy",decoding:"async"})],-1),ga=t("p",null,[p("3）这时会进入 "),t("code",null,"sync.doAcquireShared(1)"),p(" 流程，首先也是调用 addWaiter 添加节点，不同之处在于节点被设置为"),t("code",null,"Node.SHARED"),p(" 模式而非 "),t("code",null,"Node.EXCLUSIVE"),p(" 模式，注意此时 t2 仍处于活跃状态")],-1),Ba=t("figure",null,[t("img",{src:"https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230719190601118.png",alt:"image-20230719190601118",loading:"lazy",decoding:"async"})],-1),fa=t("p",null,"4）t2 会看看自己的节点是不是老二，如果是，还会再次调用 tryAcquireShared(1) 来尝试获取锁",-1),ka=t("p",null,[p("5）如果没有成功，在 doAcquireShared 内 "),t("code",null,"for (;;)"),p(" 循环一次，把前驱节点的 waitStatus 改为 -1，再 "),t("code",null,"for (;;)"),p(" 循环一 次尝试 tryAcquireShared(1) 如果还不成功，那么在 parkAndCheckInterrupt() 处 park")],-1),ba=t("figure",null,[t("img",{src:"https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230719190714986.png",alt:"image-20230719190714986",loading:"lazy",decoding:"async"})],-1),ma={id:"t3-r-lock-t4-w-lock",tabindex:"-1"},Sa=t("p",null,"这种状态下，假设又有 t3 加读锁和 t4 加写锁，这期间 t1 仍然持有锁，就变成了下面的样子",-1),va=t("figure",null,[t("img",{src:"https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230719192612370.png",alt:"image-20230719192612370",loading:"lazy",decoding:"async"})],-1),wa={id:"t1-w-unlock",tabindex:"-1"},Ta=t("p",null,"这时会走到写锁的 sync.release(1) 流程，调用 sync.tryRelease(1) 成功，state变为0，变成下面的样子",-1),xa=t("figure",null,[t("img",{src:"https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230719192633075.png",alt:"image-20230719192633075",loading:"lazy",decoding:"async"})],-1),Na=t("p",null,"接下来执行唤醒流程 sync.unparkSuccessor，即让老二恢复运行，这时 t2 在 doAcquireShared 内 parkAndCheckInterrupt() 处恢复运行",-1),Ia=t("p",null,[p("这回再来一次 "),t("code",null,"for (;;)"),p(" 执行 tryAcquireShared 成功则让读锁计数加一，state变为1")],-1),La=t("figure",null,[t("img",{src:"https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230719192723097.png",alt:"image-20230719192723097",loading:"lazy",decoding:"async"})],-1),ja=t("p",null,"这时 t2 已经恢复运行，接下来 t2 调用 setHeadAndPropagate(node, 1)，它原本所在节点被置为头节点",-1),Ra=t("figure",null,[t("img",{src:"https://jsd.cdn.zzko.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230719192739754.png",alt:"image-20230719192739754",loading:"lazy",decoding:"async"})],-1),Oa=t("p",null,"事情还没完，在 setHeadAndPropagate 方法内还会检查下一个节点是否是 shared，如果是则调用doReleaseShared() 将 head 的状态从 -1 改为 0 （CAS）并唤醒老二，这时 t3 在 doAcquireShared 内parkAndCheckInterrupt() 处恢复运行",-1),qa=t("figure",null,[t("img",{src:"https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230719192804690.png",alt:"image-20230719192804690",loading:"lazy",decoding:"async"})],-1),Pa=t("p",null,[p("这回再来一次 "),t("code",null,"for (;;)"),p(" 执行 tryAcquireShared 成功则让读锁计数加一，state变为2（共享读锁：多个线程都可以修改state）")],-1),za=t("figure",null,[t("img",{src:"https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230719192823603.png",alt:"image-20230719192823603",loading:"lazy",decoding:"async"})],-1),_a=t("p",null,"这时 t3 已经恢复运行，接下来 t3 调用 setHeadAndPropagate(node, 1)，它原本所在节点被置为头节点",-1),Ka=t("figure",null,[t("img",{src:"https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230719192838777.png",alt:"image-20230719192838777",loading:"lazy",decoding:"async"})],-1),Va=t("p",null,"下一个节点不是 shared 了，因此不会继续唤醒 t4 所在节点（读-读可以并发，直到遇到独占节点才停止）",-1),Ma={id:"t2-r-unlock-t3-r-unlock",tabindex:"-1"},Wa=t("p",null,"t2 进入 sync.releaseShared(1) 中，调用 tryReleaseShared(1) 让计数减一，但由于计数还不为零",-1),Ua=t("figure",null,[t("img",{src:"https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230719192903709.png",alt:"image-20230719192903709",loading:"lazy",decoding:"async"})],-1),Qa=t("p",null,"t3 进入 sync.releaseShared(1) 中，调用 tryReleaseShared(1) 让计数减一，这回计数为零了，进入 doReleaseShared() 将头节点从 -1 改为 0 并唤醒老二，即",-1),Ha=t("figure",null,[t("img",{src:"https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230719192920793.png",alt:"image-20230719192920793",loading:"lazy",decoding:"async"})],-1),Ga=t("p",null,[p("之后 t4 在 acquireQueued 中 parkAndCheckInterrupt 处恢复运行，再次 "),t("code",null,"for (;;)"),p(" 这次自己是老二，并且没有其他 竞争，tryAcquire(1) 成功，修改头结点，流程结束")],-1),Ja=t("figure",null,[t("img",{src:"https://jsd.cdn.zzko.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230719192934634.png",alt:"image-20230719192934634",loading:"lazy",decoding:"async"})],-1),Ya={id:"源码分析-1",tabindex:"-1"},Xa={id:"写锁上锁流程",tabindex:"-1"},Za=t("div",{class:"language-java"},[t("button",{title:"Copy Code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki github-dark vp-code-dark"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"static"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"final"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"class"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"NonfairSync"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"extends"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"Sync"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// ... 省略无关代码")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// 外部类 WriteLock 方法, 方便阅读, 放在此处")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"public"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"void"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"lock"),t("span",{style:{color:"#E1E4E8"}},"() {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        sync."),t("span",{style:{color:"#B392F0"}},"acquire"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#79B8FF"}},"1"),t("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// AQS 继承过来的方法, 方便阅读, 放在此处")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"public"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"final"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"void"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"acquire"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#FFAB70"}},"arg"),t("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#6A737D"}},"// 尝试获得写锁失败")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#F97583"}},"!"),t("span",{style:{color:"#B392F0"}},"tryAcquire"),t("span",{style:{color:"#E1E4E8"}},"(arg) "),t("span",{style:{color:"#F97583"}},"&&")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                        "),t("span",{style:{color:"#6A737D"}},"// 将当前线程关联到一个 Node 对象上, 模式为独占模式")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                        "),t("span",{style:{color:"#6A737D"}},"// 进入 AQS 队列阻塞")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                        "),t("span",{style:{color:"#B392F0"}},"acquireQueued"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#B392F0"}},"addWaiter"),t("span",{style:{color:"#E1E4E8"}},"(Node.EXCLUSIVE), arg)")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        ) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#B392F0"}},"selfInterrupt"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// Sync 继承过来的方法, 方便阅读, 放在此处")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"protected"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"final"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"boolean"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"tryAcquire"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#FFAB70"}},"acquires"),t("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#6A737D"}},"// 获得低 16 位, 代表写锁的 state 计数")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        Thread current "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," Thread."),t("span",{style:{color:"#B392F0"}},"currentThread"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," c "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"getState"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," w "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"exclusiveCount"),t("span",{style:{color:"#E1E4E8"}},"(c);")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (c "),t("span",{style:{color:"#F97583"}},"!="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"0"),t("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#6A737D"}},"// c != 0 and w == 0 表示有读锁返回错误，读锁不支持锁升级, 或者")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                    w "),t("span",{style:{color:"#F97583"}},"=="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"0"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"||")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                            "),t("span",{style:{color:"#6A737D"}},"// c != 0 and w == 0 表示有写，如果 exclusiveOwnerThread 不是自己")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                            current "),t("span",{style:{color:"#F97583"}},"!="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"getExclusiveOwnerThread"),t("span",{style:{color:"#E1E4E8"}},"()")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            ) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#6A737D"}},"// 获得锁失败")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#F97583"}},"return"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"false"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#6A737D"}},"// 写锁计数超过低 16 位, 报异常")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (w "),t("span",{style:{color:"#F97583"}},"+"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"exclusiveCount"),t("span",{style:{color:"#E1E4E8"}},"(acquires) "),t("span",{style:{color:"#F97583"}},">"),t("span",{style:{color:"#E1E4E8"}}," MAX_COUNT)")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#F97583"}},"throw"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"new"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"Error"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#9ECBFF"}},'"Maximum lock count exceeded"'),t("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#6A737D"}},"// 写锁重入, 获得锁成功")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#B392F0"}},"setState"),t("span",{style:{color:"#E1E4E8"}},"(c "),t("span",{style:{color:"#F97583"}},"+"),t("span",{style:{color:"#E1E4E8"}}," acquires);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"return"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"true"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#6A737D"}},"// 判断写锁是否该阻塞这里返回false, 或者")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#B392F0"}},"writerShouldBlock"),t("span",{style:{color:"#E1E4E8"}},"() "),t("span",{style:{color:"#F97583"}},"||")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                        "),t("span",{style:{color:"#6A737D"}},"// 尝试更改计数失败")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                        "),t("span",{style:{color:"#F97583"}},"!"),t("span",{style:{color:"#B392F0"}},"compareAndSetState"),t("span",{style:{color:"#E1E4E8"}},"(c, c "),t("span",{style:{color:"#F97583"}},"+"),t("span",{style:{color:"#E1E4E8"}}," acquires)")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        ) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#6A737D"}},"// 获得锁失败")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"return"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"false"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#6A737D"}},"// 获得锁成功")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#B392F0"}},"setExclusiveOwnerThread"),t("span",{style:{color:"#E1E4E8"}},"(current);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"return"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"true"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// 非公平锁 writerShouldBlock 总是返回 false, 无需阻塞")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"final"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"boolean"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"writerShouldBlock"),t("span",{style:{color:"#E1E4E8"}},"() {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"return"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"false"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"}")])])]),t("pre",{class:"shiki github-light vp-code-light"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"static"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"final"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"class"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"NonfairSync"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"extends"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"Sync"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// ... 省略无关代码")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// 外部类 WriteLock 方法, 方便阅读, 放在此处")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"public"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"void"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"lock"),t("span",{style:{color:"#24292E"}},"() {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        sync."),t("span",{style:{color:"#6F42C1"}},"acquire"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#005CC5"}},"1"),t("span",{style:{color:"#24292E"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    }")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// AQS 继承过来的方法, 方便阅读, 放在此处")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"public"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"final"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"void"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"acquire"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#E36209"}},"arg"),t("span",{style:{color:"#24292E"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#6A737D"}},"// 尝试获得写锁失败")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#D73A49"}},"!"),t("span",{style:{color:"#6F42C1"}},"tryAcquire"),t("span",{style:{color:"#24292E"}},"(arg) "),t("span",{style:{color:"#D73A49"}},"&&")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                        "),t("span",{style:{color:"#6A737D"}},"// 将当前线程关联到一个 Node 对象上, 模式为独占模式")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                        "),t("span",{style:{color:"#6A737D"}},"// 进入 AQS 队列阻塞")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                        "),t("span",{style:{color:"#6F42C1"}},"acquireQueued"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#6F42C1"}},"addWaiter"),t("span",{style:{color:"#24292E"}},"(Node.EXCLUSIVE), arg)")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        ) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#6F42C1"}},"selfInterrupt"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    }")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// Sync 继承过来的方法, 方便阅读, 放在此处")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"protected"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"final"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"boolean"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"tryAcquire"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#E36209"}},"acquires"),t("span",{style:{color:"#24292E"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6A737D"}},"// 获得低 16 位, 代表写锁的 state 计数")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        Thread current "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," Thread."),t("span",{style:{color:"#6F42C1"}},"currentThread"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," c "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"getState"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," w "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"exclusiveCount"),t("span",{style:{color:"#24292E"}},"(c);")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (c "),t("span",{style:{color:"#D73A49"}},"!="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"0"),t("span",{style:{color:"#24292E"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#6A737D"}},"// c != 0 and w == 0 表示有读锁返回错误，读锁不支持锁升级, 或者")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                    w "),t("span",{style:{color:"#D73A49"}},"=="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"0"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"||")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                            "),t("span",{style:{color:"#6A737D"}},"// c != 0 and w == 0 表示有写，如果 exclusiveOwnerThread 不是自己")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                            current "),t("span",{style:{color:"#D73A49"}},"!="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"getExclusiveOwnerThread"),t("span",{style:{color:"#24292E"}},"()")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            ) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#6A737D"}},"// 获得锁失败")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#D73A49"}},"return"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"false"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#6A737D"}},"// 写锁计数超过低 16 位, 报异常")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (w "),t("span",{style:{color:"#D73A49"}},"+"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"exclusiveCount"),t("span",{style:{color:"#24292E"}},"(acquires) "),t("span",{style:{color:"#D73A49"}},">"),t("span",{style:{color:"#24292E"}}," MAX_COUNT)")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#D73A49"}},"throw"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"new"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"Error"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#032F62"}},'"Maximum lock count exceeded"'),t("span",{style:{color:"#24292E"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#6A737D"}},"// 写锁重入, 获得锁成功")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#6F42C1"}},"setState"),t("span",{style:{color:"#24292E"}},"(c "),t("span",{style:{color:"#D73A49"}},"+"),t("span",{style:{color:"#24292E"}}," acquires);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"return"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"true"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#6A737D"}},"// 判断写锁是否该阻塞这里返回false, 或者")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#6F42C1"}},"writerShouldBlock"),t("span",{style:{color:"#24292E"}},"() "),t("span",{style:{color:"#D73A49"}},"||")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                        "),t("span",{style:{color:"#6A737D"}},"// 尝试更改计数失败")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                        "),t("span",{style:{color:"#D73A49"}},"!"),t("span",{style:{color:"#6F42C1"}},"compareAndSetState"),t("span",{style:{color:"#24292E"}},"(c, c "),t("span",{style:{color:"#D73A49"}},"+"),t("span",{style:{color:"#24292E"}}," acquires)")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        ) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#6A737D"}},"// 获得锁失败")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"return"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"false"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6A737D"}},"// 获得锁成功")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6F42C1"}},"setExclusiveOwnerThread"),t("span",{style:{color:"#24292E"}},"(current);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"return"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"true"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    }")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// 非公平锁 writerShouldBlock 总是返回 false, 无需阻塞")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"final"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"boolean"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"writerShouldBlock"),t("span",{style:{color:"#24292E"}},"() {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"return"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"false"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"}")])])])],-1),$a={id:"写锁释放流程",tabindex:"-1"},se=t("div",{class:"language-java"},[t("button",{title:"Copy Code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki github-dark vp-code-dark"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"static"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"final"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"class"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"NonfairSync"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"extends"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"Sync"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// ... 省略无关代码")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// WriteLock 方法, 方便阅读, 放在此处")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"public"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"void"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"unlock"),t("span",{style:{color:"#E1E4E8"}},"() {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        sync."),t("span",{style:{color:"#B392F0"}},"release"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#79B8FF"}},"1"),t("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// AQS 继承过来的方法, 方便阅读, 放在此处")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"public"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"final"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"boolean"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"release"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#FFAB70"}},"arg"),t("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#6A737D"}},"// 尝试释放写锁成功")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," ("),t("span",{style:{color:"#B392F0"}},"tryRelease"),t("span",{style:{color:"#E1E4E8"}},"(arg)) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#6A737D"}},"// unpark AQS 中等待的线程")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            Node h "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," head;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (h "),t("span",{style:{color:"#F97583"}},"!="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"null"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"&&"),t("span",{style:{color:"#E1E4E8"}}," h.waitStatus "),t("span",{style:{color:"#F97583"}},"!="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"0"),t("span",{style:{color:"#E1E4E8"}},")")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#B392F0"}},"unparkSuccessor"),t("span",{style:{color:"#E1E4E8"}},"(h);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"return"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"true"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"return"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"false"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// Sync 继承过来的方法, 方便阅读, 放在此处")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"protected"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"final"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"boolean"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"tryRelease"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#FFAB70"}},"releases"),t("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," ("),t("span",{style:{color:"#F97583"}},"!"),t("span",{style:{color:"#B392F0"}},"isHeldExclusively"),t("span",{style:{color:"#E1E4E8"}},"())")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"throw"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"new"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"IllegalMonitorStateException"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," nextc "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"getState"),t("span",{style:{color:"#E1E4E8"}},"() "),t("span",{style:{color:"#F97583"}},"-"),t("span",{style:{color:"#E1E4E8"}}," releases;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#6A737D"}},"// 因为可重入的原因, 写锁计数为 0, 才算释放成功")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"boolean"),t("span",{style:{color:"#E1E4E8"}}," free "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"exclusiveCount"),t("span",{style:{color:"#E1E4E8"}},"(nextc) "),t("span",{style:{color:"#F97583"}},"=="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"0"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (free) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#B392F0"}},"setExclusiveOwnerThread"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#79B8FF"}},"null"),t("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#B392F0"}},"setState"),t("span",{style:{color:"#E1E4E8"}},"(nextc);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"return"),t("span",{style:{color:"#E1E4E8"}}," free;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"}")])])]),t("pre",{class:"shiki github-light vp-code-light"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"static"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"final"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"class"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"NonfairSync"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"extends"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"Sync"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// ... 省略无关代码")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// WriteLock 方法, 方便阅读, 放在此处")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"public"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"void"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"unlock"),t("span",{style:{color:"#24292E"}},"() {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        sync."),t("span",{style:{color:"#6F42C1"}},"release"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#005CC5"}},"1"),t("span",{style:{color:"#24292E"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    }")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// AQS 继承过来的方法, 方便阅读, 放在此处")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"public"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"final"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"boolean"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"release"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#E36209"}},"arg"),t("span",{style:{color:"#24292E"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6A737D"}},"// 尝试释放写锁成功")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," ("),t("span",{style:{color:"#6F42C1"}},"tryRelease"),t("span",{style:{color:"#24292E"}},"(arg)) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#6A737D"}},"// unpark AQS 中等待的线程")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            Node h "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," head;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (h "),t("span",{style:{color:"#D73A49"}},"!="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"null"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"&&"),t("span",{style:{color:"#24292E"}}," h.waitStatus "),t("span",{style:{color:"#D73A49"}},"!="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"0"),t("span",{style:{color:"#24292E"}},")")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#6F42C1"}},"unparkSuccessor"),t("span",{style:{color:"#24292E"}},"(h);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"return"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"true"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"return"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"false"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    }")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// Sync 继承过来的方法, 方便阅读, 放在此处")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"protected"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"final"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"boolean"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"tryRelease"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#E36209"}},"releases"),t("span",{style:{color:"#24292E"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," ("),t("span",{style:{color:"#D73A49"}},"!"),t("span",{style:{color:"#6F42C1"}},"isHeldExclusively"),t("span",{style:{color:"#24292E"}},"())")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"throw"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"new"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"IllegalMonitorStateException"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," nextc "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"getState"),t("span",{style:{color:"#24292E"}},"() "),t("span",{style:{color:"#D73A49"}},"-"),t("span",{style:{color:"#24292E"}}," releases;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6A737D"}},"// 因为可重入的原因, 写锁计数为 0, 才算释放成功")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"boolean"),t("span",{style:{color:"#24292E"}}," free "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"exclusiveCount"),t("span",{style:{color:"#24292E"}},"(nextc) "),t("span",{style:{color:"#D73A49"}},"=="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"0"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (free) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#6F42C1"}},"setExclusiveOwnerThread"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#005CC5"}},"null"),t("span",{style:{color:"#24292E"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6F42C1"}},"setState"),t("span",{style:{color:"#24292E"}},"(nextc);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"return"),t("span",{style:{color:"#24292E"}}," free;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"}")])])])],-1),le={id:"读锁上锁流程",tabindex:"-1"},oe=t("div",{class:"language-java"},[t("button",{title:"Copy Code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki github-dark vp-code-dark"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"static"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"final"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"class"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"NonfairSync"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"extends"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"Sync"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// ReadLock 方法, 方便阅读, 放在此处")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"public"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"void"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"lock"),t("span",{style:{color:"#E1E4E8"}},"() {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        sync."),t("span",{style:{color:"#B392F0"}},"acquireShared"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#79B8FF"}},"1"),t("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// AQS 继承过来的方法, 方便阅读, 放在此处")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"public"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"final"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"void"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"acquireShared"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#FFAB70"}},"arg"),t("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#6A737D"}},"// tryAcquireShared 返回负数, 表示获取读锁失败")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," ("),t("span",{style:{color:"#B392F0"}},"tryAcquireShared"),t("span",{style:{color:"#E1E4E8"}},"(arg) "),t("span",{style:{color:"#F97583"}},"<"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"0"),t("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#B392F0"}},"doAcquireShared"),t("span",{style:{color:"#E1E4E8"}},"(arg);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// Sync 继承过来的方法, 方便阅读, 放在此处")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"protected"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"final"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"tryAcquireShared"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#FFAB70"}},"unused"),t("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        Thread current "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," Thread."),t("span",{style:{color:"#B392F0"}},"currentThread"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," c "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"getState"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#6A737D"}},"// 如果是其它线程持有写锁, 获取读锁失败")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#B392F0"}},"exclusiveCount"),t("span",{style:{color:"#E1E4E8"}},"(c) "),t("span",{style:{color:"#F97583"}},"!="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"0"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"&&")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                        "),t("span",{style:{color:"#B392F0"}},"getExclusiveOwnerThread"),t("span",{style:{color:"#E1E4E8"}},"() "),t("span",{style:{color:"#F97583"}},"!="),t("span",{style:{color:"#E1E4E8"}}," current")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        ) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"return"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"-"),t("span",{style:{color:"#79B8FF"}},"1"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," r "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"sharedCount"),t("span",{style:{color:"#E1E4E8"}},"(c);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#6A737D"}},"// 读锁不该阻塞(如果老二是写锁，读锁该阻塞), 并且")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#F97583"}},"!"),t("span",{style:{color:"#B392F0"}},"readerShouldBlock"),t("span",{style:{color:"#E1E4E8"}},"() "),t("span",{style:{color:"#F97583"}},"&&")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                        "),t("span",{style:{color:"#6A737D"}},"// 小于读锁计数, 并且")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                        r "),t("span",{style:{color:"#F97583"}},"<"),t("span",{style:{color:"#E1E4E8"}}," MAX_COUNT "),t("span",{style:{color:"#F97583"}},"&&")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                        "),t("span",{style:{color:"#6A737D"}},"// 尝试增加计数成功")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                        "),t("span",{style:{color:"#B392F0"}},"compareAndSetState"),t("span",{style:{color:"#E1E4E8"}},"(c, c "),t("span",{style:{color:"#F97583"}},"+"),t("span",{style:{color:"#E1E4E8"}}," SHARED_UNIT)")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        ) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#6A737D"}},"// ... 省略不重要的代码")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"return"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"1"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"return"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"fullTryAcquireShared"),t("span",{style:{color:"#E1E4E8"}},"(current);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// 非公平锁 readerShouldBlock 看 AQS 队列中第一个节点是否是写锁")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// true 则该阻塞, false 则不阻塞")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"final"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"boolean"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"readerShouldBlock"),t("span",{style:{color:"#E1E4E8"}},"() {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"return"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"apparentlyFirstQueuedIsExclusive"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// AQS 继承过来的方法, 方便阅读, 放在此处")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// 与 tryAcquireShared 功能类似, 但会不断尝试 for (;;) 获取读锁, 执行过程中无阻塞")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"final"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"fullTryAcquireShared"),t("span",{style:{color:"#E1E4E8"}},"(Thread "),t("span",{style:{color:"#FFAB70"}},"current"),t("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        HoldCounter rh "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"null"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"for"),t("span",{style:{color:"#E1E4E8"}}," (;;) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," c "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"getState"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," ("),t("span",{style:{color:"#B392F0"}},"exclusiveCount"),t("span",{style:{color:"#E1E4E8"}},"(c) "),t("span",{style:{color:"#F97583"}},"!="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"0"),t("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," ("),t("span",{style:{color:"#B392F0"}},"getExclusiveOwnerThread"),t("span",{style:{color:"#E1E4E8"}},"() "),t("span",{style:{color:"#F97583"}},"!="),t("span",{style:{color:"#E1E4E8"}}," current)")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                    "),t("span",{style:{color:"#F97583"}},"return"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"-"),t("span",{style:{color:"#79B8FF"}},"1"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            } "),t("span",{style:{color:"#F97583"}},"else"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," ("),t("span",{style:{color:"#B392F0"}},"readerShouldBlock"),t("span",{style:{color:"#E1E4E8"}},"()) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#6A737D"}},"// ... 省略不重要的代码")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," ("),t("span",{style:{color:"#B392F0"}},"sharedCount"),t("span",{style:{color:"#E1E4E8"}},"(c) "),t("span",{style:{color:"#F97583"}},"=="),t("span",{style:{color:"#E1E4E8"}}," MAX_COUNT)")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#F97583"}},"throw"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"new"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"Error"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#9ECBFF"}},'"Maximum lock count exceeded"'),t("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," ("),t("span",{style:{color:"#B392F0"}},"compareAndSetState"),t("span",{style:{color:"#E1E4E8"}},"(c, c "),t("span",{style:{color:"#F97583"}},"+"),t("span",{style:{color:"#E1E4E8"}}," SHARED_UNIT)) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#6A737D"}},"// ... 省略不重要的代码")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#F97583"}},"return"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"1"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// AQS 继承过来的方法, 方便阅读, 放在此处")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"private"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"void"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"doAcquireShared"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#FFAB70"}},"arg"),t("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#6A737D"}},"// 将当前线程关联到一个 Node 对象上, 模式为共享模式")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"final"),t("span",{style:{color:"#E1E4E8"}}," Node node "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"addWaiter"),t("span",{style:{color:"#E1E4E8"}},"(Node.SHARED);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"boolean"),t("span",{style:{color:"#E1E4E8"}}," failed "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"true"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"try"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"boolean"),t("span",{style:{color:"#E1E4E8"}}," interrupted "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"false"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"for"),t("span",{style:{color:"#E1E4E8"}}," (;;) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#F97583"}},"final"),t("span",{style:{color:"#E1E4E8"}}," Node p "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," node."),t("span",{style:{color:"#B392F0"}},"predecessor"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (p "),t("span",{style:{color:"#F97583"}},"=="),t("span",{style:{color:"#E1E4E8"}}," head) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                    "),t("span",{style:{color:"#6A737D"}},"// 再一次尝试获取读锁")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                    "),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," r "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"tryAcquireShared"),t("span",{style:{color:"#E1E4E8"}},"(arg);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                    "),t("span",{style:{color:"#6A737D"}},"// 成功")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                    "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (r "),t("span",{style:{color:"#F97583"}},">="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"0"),t("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                        "),t("span",{style:{color:"#6A737D"}},"// ㈠")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"\t\t\t\t\t\t"),t("span",{style:{color:"#6A737D"}},"// r 表示可用资源数, 在这里总是 1 允许传播")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                        "),t("span",{style:{color:"#6A737D"}},"//（唤醒 AQS 中下一个 Share 节点）")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                        "),t("span",{style:{color:"#B392F0"}},"setHeadAndPropagate"),t("span",{style:{color:"#E1E4E8"}},"(node, r);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                        p.next "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"null"),t("span",{style:{color:"#E1E4E8"}},"; "),t("span",{style:{color:"#6A737D"}},"// help GC")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                        "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (interrupted)")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                            "),t("span",{style:{color:"#B392F0"}},"selfInterrupt"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                        failed "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"false"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                        "),t("span",{style:{color:"#F97583"}},"return"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                    "),t("span",{style:{color:"#6A737D"}},"// 是否在获取读锁失败时阻塞（前一个阶段 waitStatus == Node.SIGNAL）")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                        "),t("span",{style:{color:"#B392F0"}},"shouldParkAfterFailedAcquire"),t("span",{style:{color:"#E1E4E8"}},"(p, node) "),t("span",{style:{color:"#F97583"}},"&&")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                                "),t("span",{style:{color:"#6A737D"}},"// park 当前线程")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                                "),t("span",{style:{color:"#B392F0"}},"parkAndCheckInterrupt"),t("span",{style:{color:"#E1E4E8"}},"()")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                ) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                    interrupted "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"true"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        } "),t("span",{style:{color:"#F97583"}},"finally"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (failed)")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#B392F0"}},"cancelAcquire"),t("span",{style:{color:"#E1E4E8"}},"(node);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// ㈠ AQS 继承过来的方法, 方便阅读, 放在此处")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"private"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"void"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"setHeadAndPropagate"),t("span",{style:{color:"#E1E4E8"}},"(Node "),t("span",{style:{color:"#FFAB70"}},"node"),t("span",{style:{color:"#E1E4E8"}},", "),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#FFAB70"}},"propagate"),t("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        Node h "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," head; "),t("span",{style:{color:"#6A737D"}},"// Record old head for check below")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#6A737D"}},"// 设置自己为 head")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#B392F0"}},"setHead"),t("span",{style:{color:"#E1E4E8"}},"(node);")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#6A737D"}},"// propagate 表示有共享资源（例如共享读锁或信号量）")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#6A737D"}},"// 原 head waitStatus == Node.SIGNAL 或 Node.PROPAGATE")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#6A737D"}},"// 现在 head waitStatus == Node.SIGNAL 或 Node.PROPAGATE")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (propagate "),t("span",{style:{color:"#F97583"}},">"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"0"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"||"),t("span",{style:{color:"#E1E4E8"}}," h "),t("span",{style:{color:"#F97583"}},"=="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"null"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"||"),t("span",{style:{color:"#E1E4E8"}}," h.waitStatus "),t("span",{style:{color:"#F97583"}},"<"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"0"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"||")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                (h "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," head) "),t("span",{style:{color:"#F97583"}},"=="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"null"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"||"),t("span",{style:{color:"#E1E4E8"}}," h.waitStatus "),t("span",{style:{color:"#F97583"}},"<"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"0"),t("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            Node s "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," node.next;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#6A737D"}},"// 如果是最后一个节点或者是等待共享读锁的节点")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (s "),t("span",{style:{color:"#F97583"}},"=="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"null"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"||"),t("span",{style:{color:"#E1E4E8"}}," s."),t("span",{style:{color:"#B392F0"}},"isShared"),t("span",{style:{color:"#E1E4E8"}},"()) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#6A737D"}},"// 进入 ㈡")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#B392F0"}},"doReleaseShared"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// ㈡ AQS 继承过来的方法, 方便阅读, 放在此处")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"private"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"void"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"doReleaseShared"),t("span",{style:{color:"#E1E4E8"}},"() {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#6A737D"}},"// 如果 head.waitStatus == Node.SIGNAL ==> 0 成功, 下一个节点 unpark")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#6A737D"}},"// 如果 head.waitStatus == 0 ==> Node.PROPAGATE, 为了解决 bug, 见后面分析，参考这里：http://www.tianxiaobo.com/2018/05/01/AbstractQueuedSynchronizer-%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90-%E7%8B%AC%E5%8D%A0-%E5%85%B1%E4%BA%AB%E6%A8%A1%E5%BC%8F/#5propagate-%E7%8A%B6%E6%80%81%E5%AD%98%E5%9C%A8%E7%9A%84%E6%84%8F%E4%B9%89")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"for"),t("span",{style:{color:"#E1E4E8"}}," (;;) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            Node h "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," head;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#6A737D"}},"// 队列还有节点")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (h "),t("span",{style:{color:"#F97583"}},"!="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"null"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"&&"),t("span",{style:{color:"#E1E4E8"}}," h "),t("span",{style:{color:"#F97583"}},"!="),t("span",{style:{color:"#E1E4E8"}}," tail) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," ws "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," h.waitStatus;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (ws "),t("span",{style:{color:"#F97583"}},"=="),t("span",{style:{color:"#E1E4E8"}}," Node.SIGNAL) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                    "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," ("),t("span",{style:{color:"#F97583"}},"!"),t("span",{style:{color:"#B392F0"}},"compareAndSetWaitStatus"),t("span",{style:{color:"#E1E4E8"}},"(h, Node.SIGNAL, "),t("span",{style:{color:"#79B8FF"}},"0"),t("span",{style:{color:"#E1E4E8"}},"))")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                        "),t("span",{style:{color:"#F97583"}},"continue"),t("span",{style:{color:"#E1E4E8"}},"; "),t("span",{style:{color:"#6A737D"}},"// loop to recheck cases")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                    "),t("span",{style:{color:"#6A737D"}},"// 下一个节点 unpark 如果成功获取读锁")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                    "),t("span",{style:{color:"#6A737D"}},"// 并且下下个节点还是 shared, 继续 doReleaseShared")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                    "),t("span",{style:{color:"#B392F0"}},"unparkSuccessor"),t("span",{style:{color:"#E1E4E8"}},"(h);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#F97583"}},"else"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (ws "),t("span",{style:{color:"#F97583"}},"=="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"0"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"&&")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                        "),t("span",{style:{color:"#F97583"}},"!"),t("span",{style:{color:"#B392F0"}},"compareAndSetWaitStatus"),t("span",{style:{color:"#E1E4E8"}},"(h, "),t("span",{style:{color:"#79B8FF"}},"0"),t("span",{style:{color:"#E1E4E8"}},", Node.PROPAGATE))")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                    "),t("span",{style:{color:"#F97583"}},"continue"),t("span",{style:{color:"#E1E4E8"}},"; "),t("span",{style:{color:"#6A737D"}},"// loop on failed CAS")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (h "),t("span",{style:{color:"#F97583"}},"=="),t("span",{style:{color:"#E1E4E8"}}," head) "),t("span",{style:{color:"#6A737D"}},"// loop if head changed")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#F97583"}},"break"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"}")])])]),t("pre",{class:"shiki github-light vp-code-light"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"static"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"final"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"class"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"NonfairSync"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"extends"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"Sync"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// ReadLock 方法, 方便阅读, 放在此处")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"public"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"void"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"lock"),t("span",{style:{color:"#24292E"}},"() {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        sync."),t("span",{style:{color:"#6F42C1"}},"acquireShared"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#005CC5"}},"1"),t("span",{style:{color:"#24292E"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    }")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// AQS 继承过来的方法, 方便阅读, 放在此处")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"public"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"final"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"void"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"acquireShared"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#E36209"}},"arg"),t("span",{style:{color:"#24292E"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6A737D"}},"// tryAcquireShared 返回负数, 表示获取读锁失败")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," ("),t("span",{style:{color:"#6F42C1"}},"tryAcquireShared"),t("span",{style:{color:"#24292E"}},"(arg) "),t("span",{style:{color:"#D73A49"}},"<"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"0"),t("span",{style:{color:"#24292E"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#6F42C1"}},"doAcquireShared"),t("span",{style:{color:"#24292E"}},"(arg);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    }")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// Sync 继承过来的方法, 方便阅读, 放在此处")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"protected"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"final"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"tryAcquireShared"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#E36209"}},"unused"),t("span",{style:{color:"#24292E"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        Thread current "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," Thread."),t("span",{style:{color:"#6F42C1"}},"currentThread"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," c "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"getState"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6A737D"}},"// 如果是其它线程持有写锁, 获取读锁失败")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#6F42C1"}},"exclusiveCount"),t("span",{style:{color:"#24292E"}},"(c) "),t("span",{style:{color:"#D73A49"}},"!="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"0"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"&&")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                        "),t("span",{style:{color:"#6F42C1"}},"getExclusiveOwnerThread"),t("span",{style:{color:"#24292E"}},"() "),t("span",{style:{color:"#D73A49"}},"!="),t("span",{style:{color:"#24292E"}}," current")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        ) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"return"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"-"),t("span",{style:{color:"#005CC5"}},"1"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," r "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"sharedCount"),t("span",{style:{color:"#24292E"}},"(c);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#6A737D"}},"// 读锁不该阻塞(如果老二是写锁，读锁该阻塞), 并且")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#D73A49"}},"!"),t("span",{style:{color:"#6F42C1"}},"readerShouldBlock"),t("span",{style:{color:"#24292E"}},"() "),t("span",{style:{color:"#D73A49"}},"&&")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                        "),t("span",{style:{color:"#6A737D"}},"// 小于读锁计数, 并且")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                        r "),t("span",{style:{color:"#D73A49"}},"<"),t("span",{style:{color:"#24292E"}}," MAX_COUNT "),t("span",{style:{color:"#D73A49"}},"&&")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                        "),t("span",{style:{color:"#6A737D"}},"// 尝试增加计数成功")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                        "),t("span",{style:{color:"#6F42C1"}},"compareAndSetState"),t("span",{style:{color:"#24292E"}},"(c, c "),t("span",{style:{color:"#D73A49"}},"+"),t("span",{style:{color:"#24292E"}}," SHARED_UNIT)")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        ) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#6A737D"}},"// ... 省略不重要的代码")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"return"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"1"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"return"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"fullTryAcquireShared"),t("span",{style:{color:"#24292E"}},"(current);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    }")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// 非公平锁 readerShouldBlock 看 AQS 队列中第一个节点是否是写锁")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// true 则该阻塞, false 则不阻塞")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"final"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"boolean"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"readerShouldBlock"),t("span",{style:{color:"#24292E"}},"() {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"return"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"apparentlyFirstQueuedIsExclusive"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    }")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// AQS 继承过来的方法, 方便阅读, 放在此处")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// 与 tryAcquireShared 功能类似, 但会不断尝试 for (;;) 获取读锁, 执行过程中无阻塞")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"final"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"fullTryAcquireShared"),t("span",{style:{color:"#24292E"}},"(Thread "),t("span",{style:{color:"#E36209"}},"current"),t("span",{style:{color:"#24292E"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        HoldCounter rh "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"null"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"for"),t("span",{style:{color:"#24292E"}}," (;;) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," c "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"getState"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," ("),t("span",{style:{color:"#6F42C1"}},"exclusiveCount"),t("span",{style:{color:"#24292E"}},"(c) "),t("span",{style:{color:"#D73A49"}},"!="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"0"),t("span",{style:{color:"#24292E"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," ("),t("span",{style:{color:"#6F42C1"}},"getExclusiveOwnerThread"),t("span",{style:{color:"#24292E"}},"() "),t("span",{style:{color:"#D73A49"}},"!="),t("span",{style:{color:"#24292E"}}," current)")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                    "),t("span",{style:{color:"#D73A49"}},"return"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"-"),t("span",{style:{color:"#005CC5"}},"1"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            } "),t("span",{style:{color:"#D73A49"}},"else"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," ("),t("span",{style:{color:"#6F42C1"}},"readerShouldBlock"),t("span",{style:{color:"#24292E"}},"()) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#6A737D"}},"// ... 省略不重要的代码")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," ("),t("span",{style:{color:"#6F42C1"}},"sharedCount"),t("span",{style:{color:"#24292E"}},"(c) "),t("span",{style:{color:"#D73A49"}},"=="),t("span",{style:{color:"#24292E"}}," MAX_COUNT)")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#D73A49"}},"throw"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"new"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"Error"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#032F62"}},'"Maximum lock count exceeded"'),t("span",{style:{color:"#24292E"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," ("),t("span",{style:{color:"#6F42C1"}},"compareAndSetState"),t("span",{style:{color:"#24292E"}},"(c, c "),t("span",{style:{color:"#D73A49"}},"+"),t("span",{style:{color:"#24292E"}}," SHARED_UNIT)) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#6A737D"}},"// ... 省略不重要的代码")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#D73A49"}},"return"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"1"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    }")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// AQS 继承过来的方法, 方便阅读, 放在此处")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"private"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"void"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"doAcquireShared"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#E36209"}},"arg"),t("span",{style:{color:"#24292E"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6A737D"}},"// 将当前线程关联到一个 Node 对象上, 模式为共享模式")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"final"),t("span",{style:{color:"#24292E"}}," Node node "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"addWaiter"),t("span",{style:{color:"#24292E"}},"(Node.SHARED);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"boolean"),t("span",{style:{color:"#24292E"}}," failed "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"true"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"try"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"boolean"),t("span",{style:{color:"#24292E"}}," interrupted "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"false"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"for"),t("span",{style:{color:"#24292E"}}," (;;) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#D73A49"}},"final"),t("span",{style:{color:"#24292E"}}," Node p "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," node."),t("span",{style:{color:"#6F42C1"}},"predecessor"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (p "),t("span",{style:{color:"#D73A49"}},"=="),t("span",{style:{color:"#24292E"}}," head) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                    "),t("span",{style:{color:"#6A737D"}},"// 再一次尝试获取读锁")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                    "),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," r "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"tryAcquireShared"),t("span",{style:{color:"#24292E"}},"(arg);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                    "),t("span",{style:{color:"#6A737D"}},"// 成功")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                    "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (r "),t("span",{style:{color:"#D73A49"}},">="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"0"),t("span",{style:{color:"#24292E"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                        "),t("span",{style:{color:"#6A737D"}},"// ㈠")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"\t\t\t\t\t\t"),t("span",{style:{color:"#6A737D"}},"// r 表示可用资源数, 在这里总是 1 允许传播")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                        "),t("span",{style:{color:"#6A737D"}},"//（唤醒 AQS 中下一个 Share 节点）")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                        "),t("span",{style:{color:"#6F42C1"}},"setHeadAndPropagate"),t("span",{style:{color:"#24292E"}},"(node, r);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                        p.next "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"null"),t("span",{style:{color:"#24292E"}},"; "),t("span",{style:{color:"#6A737D"}},"// help GC")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                        "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (interrupted)")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                            "),t("span",{style:{color:"#6F42C1"}},"selfInterrupt"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                        failed "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"false"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                        "),t("span",{style:{color:"#D73A49"}},"return"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                    "),t("span",{style:{color:"#6A737D"}},"// 是否在获取读锁失败时阻塞（前一个阶段 waitStatus == Node.SIGNAL）")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                        "),t("span",{style:{color:"#6F42C1"}},"shouldParkAfterFailedAcquire"),t("span",{style:{color:"#24292E"}},"(p, node) "),t("span",{style:{color:"#D73A49"}},"&&")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                                "),t("span",{style:{color:"#6A737D"}},"// park 当前线程")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                                "),t("span",{style:{color:"#6F42C1"}},"parkAndCheckInterrupt"),t("span",{style:{color:"#24292E"}},"()")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                ) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                    interrupted "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"true"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        } "),t("span",{style:{color:"#D73A49"}},"finally"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (failed)")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#6F42C1"}},"cancelAcquire"),t("span",{style:{color:"#24292E"}},"(node);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    }")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// ㈠ AQS 继承过来的方法, 方便阅读, 放在此处")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"private"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"void"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"setHeadAndPropagate"),t("span",{style:{color:"#24292E"}},"(Node "),t("span",{style:{color:"#E36209"}},"node"),t("span",{style:{color:"#24292E"}},", "),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#E36209"}},"propagate"),t("span",{style:{color:"#24292E"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        Node h "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," head; "),t("span",{style:{color:"#6A737D"}},"// Record old head for check below")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6A737D"}},"// 设置自己为 head")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6F42C1"}},"setHead"),t("span",{style:{color:"#24292E"}},"(node);")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6A737D"}},"// propagate 表示有共享资源（例如共享读锁或信号量）")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6A737D"}},"// 原 head waitStatus == Node.SIGNAL 或 Node.PROPAGATE")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6A737D"}},"// 现在 head waitStatus == Node.SIGNAL 或 Node.PROPAGATE")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (propagate "),t("span",{style:{color:"#D73A49"}},">"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"0"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"||"),t("span",{style:{color:"#24292E"}}," h "),t("span",{style:{color:"#D73A49"}},"=="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"null"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"||"),t("span",{style:{color:"#24292E"}}," h.waitStatus "),t("span",{style:{color:"#D73A49"}},"<"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"0"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"||")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                (h "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," head) "),t("span",{style:{color:"#D73A49"}},"=="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"null"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"||"),t("span",{style:{color:"#24292E"}}," h.waitStatus "),t("span",{style:{color:"#D73A49"}},"<"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"0"),t("span",{style:{color:"#24292E"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            Node s "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," node.next;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#6A737D"}},"// 如果是最后一个节点或者是等待共享读锁的节点")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (s "),t("span",{style:{color:"#D73A49"}},"=="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"null"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"||"),t("span",{style:{color:"#24292E"}}," s."),t("span",{style:{color:"#6F42C1"}},"isShared"),t("span",{style:{color:"#24292E"}},"()) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#6A737D"}},"// 进入 ㈡")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#6F42C1"}},"doReleaseShared"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    }")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// ㈡ AQS 继承过来的方法, 方便阅读, 放在此处")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"private"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"void"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"doReleaseShared"),t("span",{style:{color:"#24292E"}},"() {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6A737D"}},"// 如果 head.waitStatus == Node.SIGNAL ==> 0 成功, 下一个节点 unpark")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6A737D"}},"// 如果 head.waitStatus == 0 ==> Node.PROPAGATE, 为了解决 bug, 见后面分析，参考这里：http://www.tianxiaobo.com/2018/05/01/AbstractQueuedSynchronizer-%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90-%E7%8B%AC%E5%8D%A0-%E5%85%B1%E4%BA%AB%E6%A8%A1%E5%BC%8F/#5propagate-%E7%8A%B6%E6%80%81%E5%AD%98%E5%9C%A8%E7%9A%84%E6%84%8F%E4%B9%89")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"for"),t("span",{style:{color:"#24292E"}}," (;;) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            Node h "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," head;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#6A737D"}},"// 队列还有节点")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (h "),t("span",{style:{color:"#D73A49"}},"!="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"null"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"&&"),t("span",{style:{color:"#24292E"}}," h "),t("span",{style:{color:"#D73A49"}},"!="),t("span",{style:{color:"#24292E"}}," tail) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," ws "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," h.waitStatus;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (ws "),t("span",{style:{color:"#D73A49"}},"=="),t("span",{style:{color:"#24292E"}}," Node.SIGNAL) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                    "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," ("),t("span",{style:{color:"#D73A49"}},"!"),t("span",{style:{color:"#6F42C1"}},"compareAndSetWaitStatus"),t("span",{style:{color:"#24292E"}},"(h, Node.SIGNAL, "),t("span",{style:{color:"#005CC5"}},"0"),t("span",{style:{color:"#24292E"}},"))")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                        "),t("span",{style:{color:"#D73A49"}},"continue"),t("span",{style:{color:"#24292E"}},"; "),t("span",{style:{color:"#6A737D"}},"// loop to recheck cases")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                    "),t("span",{style:{color:"#6A737D"}},"// 下一个节点 unpark 如果成功获取读锁")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                    "),t("span",{style:{color:"#6A737D"}},"// 并且下下个节点还是 shared, 继续 doReleaseShared")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                    "),t("span",{style:{color:"#6F42C1"}},"unparkSuccessor"),t("span",{style:{color:"#24292E"}},"(h);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#D73A49"}},"else"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (ws "),t("span",{style:{color:"#D73A49"}},"=="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"0"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"&&")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                        "),t("span",{style:{color:"#D73A49"}},"!"),t("span",{style:{color:"#6F42C1"}},"compareAndSetWaitStatus"),t("span",{style:{color:"#24292E"}},"(h, "),t("span",{style:{color:"#005CC5"}},"0"),t("span",{style:{color:"#24292E"}},", Node.PROPAGATE))")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                    "),t("span",{style:{color:"#D73A49"}},"continue"),t("span",{style:{color:"#24292E"}},"; "),t("span",{style:{color:"#6A737D"}},"// loop on failed CAS")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (h "),t("span",{style:{color:"#D73A49"}},"=="),t("span",{style:{color:"#24292E"}}," head) "),t("span",{style:{color:"#6A737D"}},"// loop if head changed")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#D73A49"}},"break"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"}")])])])],-1),ne={id:"读锁释放流程",tabindex:"-1"},ae=t("div",{class:"language-java"},[t("button",{title:"Copy Code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki github-dark vp-code-dark"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"static"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"final"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"class"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"NonfairSync"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"extends"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"Sync"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// ReadLock 方法, 方便阅读, 放在此处")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"public"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"void"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"unlock"),t("span",{style:{color:"#E1E4E8"}},"() {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        sync."),t("span",{style:{color:"#B392F0"}},"releaseShared"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#79B8FF"}},"1"),t("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// AQS 继承过来的方法, 方便阅读, 放在此处")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"public"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"final"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"boolean"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"releaseShared"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#FFAB70"}},"arg"),t("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," ("),t("span",{style:{color:"#B392F0"}},"tryReleaseShared"),t("span",{style:{color:"#E1E4E8"}},"(arg)) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#B392F0"}},"doReleaseShared"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"return"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"true"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"return"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"false"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// Sync 继承过来的方法, 方便阅读, 放在此处")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"protected"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"final"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"boolean"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"tryReleaseShared"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#FFAB70"}},"unused"),t("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#6A737D"}},"// ... 省略不重要的代码")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"for"),t("span",{style:{color:"#E1E4E8"}}," (;;) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," c "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"getState"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," nextc "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," c "),t("span",{style:{color:"#F97583"}},"-"),t("span",{style:{color:"#E1E4E8"}}," SHARED_UNIT;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," ("),t("span",{style:{color:"#B392F0"}},"compareAndSetState"),t("span",{style:{color:"#E1E4E8"}},"(c, nextc)) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#6A737D"}},"// 读锁的计数不会影响其它获取读锁线程, 但会影响其它获取写锁线程")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#6A737D"}},"// 计数为 0 才是真正释放")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#F97583"}},"return"),t("span",{style:{color:"#E1E4E8"}}," nextc "),t("span",{style:{color:"#F97583"}},"=="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"0"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// AQS 继承过来的方法, 方便阅读, 放在此处")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"private"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"void"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"doReleaseShared"),t("span",{style:{color:"#E1E4E8"}},"() {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#6A737D"}},"// 如果 head.waitStatus == Node.SIGNAL ==> 0 成功, 下一个节点 unpark")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#6A737D"}},"// 如果 head.waitStatus == 0 ==> Node.PROPAGATE")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"for"),t("span",{style:{color:"#E1E4E8"}}," (;;) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            Node h "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," head;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (h "),t("span",{style:{color:"#F97583"}},"!="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"null"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"&&"),t("span",{style:{color:"#E1E4E8"}}," h "),t("span",{style:{color:"#F97583"}},"!="),t("span",{style:{color:"#E1E4E8"}}," tail) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," ws "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," h.waitStatus;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#6A737D"}},"// 如果有其它线程也在释放读锁，那么需要将 waitStatus 先改为 0")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#6A737D"}},"// 防止 unparkSuccessor 被多次执行")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (ws "),t("span",{style:{color:"#F97583"}},"=="),t("span",{style:{color:"#E1E4E8"}}," Node.SIGNAL) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                    "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," ("),t("span",{style:{color:"#F97583"}},"!"),t("span",{style:{color:"#B392F0"}},"compareAndSetWaitStatus"),t("span",{style:{color:"#E1E4E8"}},"(h, Node.SIGNAL, "),t("span",{style:{color:"#79B8FF"}},"0"),t("span",{style:{color:"#E1E4E8"}},"))")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                        "),t("span",{style:{color:"#F97583"}},"continue"),t("span",{style:{color:"#E1E4E8"}},"; "),t("span",{style:{color:"#6A737D"}},"// loop to recheck cases")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                    "),t("span",{style:{color:"#B392F0"}},"unparkSuccessor"),t("span",{style:{color:"#E1E4E8"}},"(h);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#6A737D"}},"// 如果已经是 0 了，改为 -3，用来解决传播性，见后文信号量 bug 分析")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#F97583"}},"else"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (ws "),t("span",{style:{color:"#F97583"}},"=="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"0"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"&&")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                        "),t("span",{style:{color:"#F97583"}},"!"),t("span",{style:{color:"#B392F0"}},"compareAndSetWaitStatus"),t("span",{style:{color:"#E1E4E8"}},"(h, "),t("span",{style:{color:"#79B8FF"}},"0"),t("span",{style:{color:"#E1E4E8"}},", Node.PROPAGATE))")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                    "),t("span",{style:{color:"#F97583"}},"continue"),t("span",{style:{color:"#E1E4E8"}},"; "),t("span",{style:{color:"#6A737D"}},"// loop on failed CAS")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (h "),t("span",{style:{color:"#F97583"}},"=="),t("span",{style:{color:"#E1E4E8"}}," head) "),t("span",{style:{color:"#6A737D"}},"// loop if head changed")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#F97583"}},"break"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"}")])])]),t("pre",{class:"shiki github-light vp-code-light"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"static"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"final"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"class"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"NonfairSync"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"extends"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"Sync"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// ReadLock 方法, 方便阅读, 放在此处")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"public"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"void"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"unlock"),t("span",{style:{color:"#24292E"}},"() {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        sync."),t("span",{style:{color:"#6F42C1"}},"releaseShared"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#005CC5"}},"1"),t("span",{style:{color:"#24292E"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    }")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// AQS 继承过来的方法, 方便阅读, 放在此处")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"public"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"final"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"boolean"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"releaseShared"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#E36209"}},"arg"),t("span",{style:{color:"#24292E"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," ("),t("span",{style:{color:"#6F42C1"}},"tryReleaseShared"),t("span",{style:{color:"#24292E"}},"(arg)) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#6F42C1"}},"doReleaseShared"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"return"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"true"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"return"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"false"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    }")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// Sync 继承过来的方法, 方便阅读, 放在此处")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"protected"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"final"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"boolean"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"tryReleaseShared"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#E36209"}},"unused"),t("span",{style:{color:"#24292E"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6A737D"}},"// ... 省略不重要的代码")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"for"),t("span",{style:{color:"#24292E"}}," (;;) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," c "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"getState"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," nextc "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," c "),t("span",{style:{color:"#D73A49"}},"-"),t("span",{style:{color:"#24292E"}}," SHARED_UNIT;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," ("),t("span",{style:{color:"#6F42C1"}},"compareAndSetState"),t("span",{style:{color:"#24292E"}},"(c, nextc)) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#6A737D"}},"// 读锁的计数不会影响其它获取读锁线程, 但会影响其它获取写锁线程")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#6A737D"}},"// 计数为 0 才是真正释放")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#D73A49"}},"return"),t("span",{style:{color:"#24292E"}}," nextc "),t("span",{style:{color:"#D73A49"}},"=="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"0"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    }")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// AQS 继承过来的方法, 方便阅读, 放在此处")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"private"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"void"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"doReleaseShared"),t("span",{style:{color:"#24292E"}},"() {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6A737D"}},"// 如果 head.waitStatus == Node.SIGNAL ==> 0 成功, 下一个节点 unpark")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6A737D"}},"// 如果 head.waitStatus == 0 ==> Node.PROPAGATE")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"for"),t("span",{style:{color:"#24292E"}}," (;;) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            Node h "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," head;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (h "),t("span",{style:{color:"#D73A49"}},"!="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"null"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"&&"),t("span",{style:{color:"#24292E"}}," h "),t("span",{style:{color:"#D73A49"}},"!="),t("span",{style:{color:"#24292E"}}," tail) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," ws "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," h.waitStatus;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#6A737D"}},"// 如果有其它线程也在释放读锁，那么需要将 waitStatus 先改为 0")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#6A737D"}},"// 防止 unparkSuccessor 被多次执行")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (ws "),t("span",{style:{color:"#D73A49"}},"=="),t("span",{style:{color:"#24292E"}}," Node.SIGNAL) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                    "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," ("),t("span",{style:{color:"#D73A49"}},"!"),t("span",{style:{color:"#6F42C1"}},"compareAndSetWaitStatus"),t("span",{style:{color:"#24292E"}},"(h, Node.SIGNAL, "),t("span",{style:{color:"#005CC5"}},"0"),t("span",{style:{color:"#24292E"}},"))")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                        "),t("span",{style:{color:"#D73A49"}},"continue"),t("span",{style:{color:"#24292E"}},"; "),t("span",{style:{color:"#6A737D"}},"// loop to recheck cases")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                    "),t("span",{style:{color:"#6F42C1"}},"unparkSuccessor"),t("span",{style:{color:"#24292E"}},"(h);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#6A737D"}},"// 如果已经是 0 了，改为 -3，用来解决传播性，见后文信号量 bug 分析")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#D73A49"}},"else"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (ws "),t("span",{style:{color:"#D73A49"}},"=="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"0"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"&&")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                        "),t("span",{style:{color:"#D73A49"}},"!"),t("span",{style:{color:"#6F42C1"}},"compareAndSetWaitStatus"),t("span",{style:{color:"#24292E"}},"(h, "),t("span",{style:{color:"#005CC5"}},"0"),t("span",{style:{color:"#24292E"}},", Node.PROPAGATE))")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                    "),t("span",{style:{color:"#D73A49"}},"continue"),t("span",{style:{color:"#24292E"}},"; "),t("span",{style:{color:"#6A737D"}},"// loop on failed CAS")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (h "),t("span",{style:{color:"#D73A49"}},"=="),t("span",{style:{color:"#24292E"}}," head) "),t("span",{style:{color:"#6A737D"}},"// loop if head changed")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#D73A49"}},"break"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"}")])])])],-1),ee={id:"stampedlock",tabindex:"-1"},ce=t("p",null,"该类自 JDK 8 加入，是为了进一步优化读性能，它的特点是在使用读锁、写锁时都必须配合【戳】使用",-1),te=t("p",null,"加解读锁",-1),pe=t("div",{class:"language-java"},[t("button",{title:"Copy Code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki github-dark vp-code-dark"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"long"),t("span",{style:{color:"#E1E4E8"}}," stamp "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," lock."),t("span",{style:{color:"#B392F0"}},"readLock"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"lock."),t("span",{style:{color:"#B392F0"}},"unlockRead"),t("span",{style:{color:"#E1E4E8"}},"(stamp);")])])]),t("pre",{class:"shiki github-light vp-code-light"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"long"),t("span",{style:{color:"#24292E"}}," stamp "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," lock."),t("span",{style:{color:"#6F42C1"}},"readLock"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"lock."),t("span",{style:{color:"#6F42C1"}},"unlockRead"),t("span",{style:{color:"#24292E"}},"(stamp);")])])])],-1),re=t("p",null,"加解写锁",-1),Ee=t("div",{class:"language-java"},[t("button",{title:"Copy Code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki github-dark vp-code-dark"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"long"),t("span",{style:{color:"#E1E4E8"}}," stamp "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," lock."),t("span",{style:{color:"#B392F0"}},"writeLock"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"lock."),t("span",{style:{color:"#B392F0"}},"unlockWrite"),t("span",{style:{color:"#E1E4E8"}},"(stamp);")])])]),t("pre",{class:"shiki github-light vp-code-light"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"long"),t("span",{style:{color:"#24292E"}}," stamp "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," lock."),t("span",{style:{color:"#6F42C1"}},"writeLock"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"lock."),t("span",{style:{color:"#6F42C1"}},"unlockWrite"),t("span",{style:{color:"#24292E"}},"(stamp);")])])])],-1),ye=t("p",null,"乐观读，StampedLock 支持 tryOptimisticRead() 方法（乐观读），读取完毕后需要做一次 戳校验 如果校验通 过，表示这期间确实没有写操作，数据可以安全使用，如果校验没通过，需要重新获取读锁，保证数据安全。",-1),ie=t("div",{class:"language-java"},[t("button",{title:"Copy Code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki github-dark vp-code-dark"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"long"),t("span",{style:{color:"#E1E4E8"}}," stamp "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," lock."),t("span",{style:{color:"#B392F0"}},"tryOptimisticRead"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// 验戳")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#F97583"}},"!"),t("span",{style:{color:"#E1E4E8"}},"lock."),t("span",{style:{color:"#B392F0"}},"validate"),t("span",{style:{color:"#E1E4E8"}},"(stamp)){")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#6A737D"}},"// 锁升级")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"}")])])]),t("pre",{class:"shiki github-light vp-code-light"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"long"),t("span",{style:{color:"#24292E"}}," stamp "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," lock."),t("span",{style:{color:"#6F42C1"}},"tryOptimisticRead"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// 验戳")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#D73A49"}},"!"),t("span",{style:{color:"#24292E"}},"lock."),t("span",{style:{color:"#6F42C1"}},"validate"),t("span",{style:{color:"#24292E"}},"(stamp)){")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6A737D"}},"// 锁升级")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"}")])])])],-1),Fe=t("p",null,"提供一个 数据容器类 内部分别使用读锁保护数据的 read() 方法，写锁保护数据的 write() 方法",-1),ue=t("div",{class:"language-java"},[t("button",{title:"Copy Code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki github-dark vp-code-dark"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"@"),t("span",{style:{color:"#F97583"}},"Slf4j"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#79B8FF"}},"topic"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#9ECBFF"}},'"c.DataContainerStamped"'),t("span",{style:{color:"#E1E4E8"}},")")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"class"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"DataContainerStamped"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"private"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," data;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"private"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"final"),t("span",{style:{color:"#E1E4E8"}}," StampedLock lock "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"new"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"StampedLock"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"public"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"DataContainerStamped"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#FFAB70"}},"data"),t("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#79B8FF"}},"this"),t("span",{style:{color:"#E1E4E8"}},".data "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," data;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"public"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"read"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#FFAB70"}},"readTime"),t("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"long"),t("span",{style:{color:"#E1E4E8"}}," stamp "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," lock."),t("span",{style:{color:"#B392F0"}},"tryOptimisticRead"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        log."),t("span",{style:{color:"#B392F0"}},"debug"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#9ECBFF"}},'"optimistic read locking...{}"'),t("span",{style:{color:"#E1E4E8"}},", stamp);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#B392F0"}},"sleep"),t("span",{style:{color:"#E1E4E8"}},"(readTime);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (lock."),t("span",{style:{color:"#B392F0"}},"validate"),t("span",{style:{color:"#E1E4E8"}},"(stamp)) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            log."),t("span",{style:{color:"#B392F0"}},"debug"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#9ECBFF"}},'"read finish...{}, data:{}"'),t("span",{style:{color:"#E1E4E8"}},", stamp, data);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"return"),t("span",{style:{color:"#E1E4E8"}}," data;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#6A737D"}},"// 锁升级 - 读锁")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        log."),t("span",{style:{color:"#B392F0"}},"debug"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#9ECBFF"}},'"updating to read lock... {}"'),t("span",{style:{color:"#E1E4E8"}},", stamp);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"try"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            stamp "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," lock."),t("span",{style:{color:"#B392F0"}},"readLock"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            log."),t("span",{style:{color:"#B392F0"}},"debug"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#9ECBFF"}},'"read lock {}"'),t("span",{style:{color:"#E1E4E8"}},", stamp);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#B392F0"}},"sleep"),t("span",{style:{color:"#E1E4E8"}},"(readTime);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            log."),t("span",{style:{color:"#B392F0"}},"debug"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#9ECBFF"}},'"read finish...{}, data:{}"'),t("span",{style:{color:"#E1E4E8"}},", stamp, data);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"return"),t("span",{style:{color:"#E1E4E8"}}," data;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        } "),t("span",{style:{color:"#F97583"}},"finally"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            log."),t("span",{style:{color:"#B392F0"}},"debug"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#9ECBFF"}},'"read unlock {}"'),t("span",{style:{color:"#E1E4E8"}},", stamp);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            lock."),t("span",{style:{color:"#B392F0"}},"unlockRead"),t("span",{style:{color:"#E1E4E8"}},"(stamp);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"public"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"void"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"write"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#FFAB70"}},"newData"),t("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"long"),t("span",{style:{color:"#E1E4E8"}}," stamp "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," lock."),t("span",{style:{color:"#B392F0"}},"writeLock"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        log."),t("span",{style:{color:"#B392F0"}},"debug"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#9ECBFF"}},'"write lock {}"'),t("span",{style:{color:"#E1E4E8"}},", stamp);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"try"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#B392F0"}},"sleep"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#79B8FF"}},"2"),t("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#79B8FF"}},"this"),t("span",{style:{color:"#E1E4E8"}},".data "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," newData;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        } "),t("span",{style:{color:"#F97583"}},"finally"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            log."),t("span",{style:{color:"#B392F0"}},"debug"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#9ECBFF"}},'"write unlock {}"'),t("span",{style:{color:"#E1E4E8"}},", stamp);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            lock."),t("span",{style:{color:"#B392F0"}},"unlockWrite"),t("span",{style:{color:"#E1E4E8"}},"(stamp);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"}")])])]),t("pre",{class:"shiki github-light vp-code-light"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"@"),t("span",{style:{color:"#D73A49"}},"Slf4j"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#005CC5"}},"topic"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#032F62"}},'"c.DataContainerStamped"'),t("span",{style:{color:"#24292E"}},")")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"class"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"DataContainerStamped"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"private"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," data;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"private"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"final"),t("span",{style:{color:"#24292E"}}," StampedLock lock "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"new"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"StampedLock"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"public"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"DataContainerStamped"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#E36209"}},"data"),t("span",{style:{color:"#24292E"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#005CC5"}},"this"),t("span",{style:{color:"#24292E"}},".data "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," data;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    }")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"public"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"read"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#E36209"}},"readTime"),t("span",{style:{color:"#24292E"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"long"),t("span",{style:{color:"#24292E"}}," stamp "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," lock."),t("span",{style:{color:"#6F42C1"}},"tryOptimisticRead"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        log."),t("span",{style:{color:"#6F42C1"}},"debug"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#032F62"}},'"optimistic read locking...{}"'),t("span",{style:{color:"#24292E"}},", stamp);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6F42C1"}},"sleep"),t("span",{style:{color:"#24292E"}},"(readTime);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (lock."),t("span",{style:{color:"#6F42C1"}},"validate"),t("span",{style:{color:"#24292E"}},"(stamp)) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            log."),t("span",{style:{color:"#6F42C1"}},"debug"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#032F62"}},'"read finish...{}, data:{}"'),t("span",{style:{color:"#24292E"}},", stamp, data);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"return"),t("span",{style:{color:"#24292E"}}," data;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6A737D"}},"// 锁升级 - 读锁")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        log."),t("span",{style:{color:"#6F42C1"}},"debug"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#032F62"}},'"updating to read lock... {}"'),t("span",{style:{color:"#24292E"}},", stamp);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"try"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            stamp "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," lock."),t("span",{style:{color:"#6F42C1"}},"readLock"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            log."),t("span",{style:{color:"#6F42C1"}},"debug"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#032F62"}},'"read lock {}"'),t("span",{style:{color:"#24292E"}},", stamp);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#6F42C1"}},"sleep"),t("span",{style:{color:"#24292E"}},"(readTime);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            log."),t("span",{style:{color:"#6F42C1"}},"debug"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#032F62"}},'"read finish...{}, data:{}"'),t("span",{style:{color:"#24292E"}},", stamp, data);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"return"),t("span",{style:{color:"#24292E"}}," data;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        } "),t("span",{style:{color:"#D73A49"}},"finally"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            log."),t("span",{style:{color:"#6F42C1"}},"debug"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#032F62"}},'"read unlock {}"'),t("span",{style:{color:"#24292E"}},", stamp);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            lock."),t("span",{style:{color:"#6F42C1"}},"unlockRead"),t("span",{style:{color:"#24292E"}},"(stamp);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    }")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"public"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"void"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"write"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#E36209"}},"newData"),t("span",{style:{color:"#24292E"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"long"),t("span",{style:{color:"#24292E"}}," stamp "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," lock."),t("span",{style:{color:"#6F42C1"}},"writeLock"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        log."),t("span",{style:{color:"#6F42C1"}},"debug"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#032F62"}},'"write lock {}"'),t("span",{style:{color:"#24292E"}},", stamp);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"try"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#6F42C1"}},"sleep"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#005CC5"}},"2"),t("span",{style:{color:"#24292E"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#005CC5"}},"this"),t("span",{style:{color:"#24292E"}},".data "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," newData;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        } "),t("span",{style:{color:"#D73A49"}},"finally"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            log."),t("span",{style:{color:"#6F42C1"}},"debug"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#032F62"}},'"write unlock {}"'),t("span",{style:{color:"#24292E"}},", stamp);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            lock."),t("span",{style:{color:"#6F42C1"}},"unlockWrite"),t("span",{style:{color:"#24292E"}},"(stamp);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"}")])])])],-1),Ae=t("p",null,"测试 读-读 可以优化",-1),de=t("div",{class:"language-java"},[t("button",{title:"Copy Code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki github-dark vp-code-dark"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"DataContainerStamped dataContainer "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"new"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"DataContainerStamped"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#79B8FF"}},"1"),t("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"new"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"Thread"),t("span",{style:{color:"#E1E4E8"}},"(() "),t("span",{style:{color:"#F97583"}},"->"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            dataContainer."),t("span",{style:{color:"#B392F0"}},"read"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#79B8FF"}},"1"),t("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        }, "),t("span",{style:{color:"#9ECBFF"}},'"t1"'),t("span",{style:{color:"#E1E4E8"}},")."),t("span",{style:{color:"#B392F0"}},"start"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#B392F0"}},"sleep"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#79B8FF"}},"0.5"),t("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"new"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"Thread"),t("span",{style:{color:"#E1E4E8"}},"(() "),t("span",{style:{color:"#F97583"}},"->"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            dataContainer."),t("span",{style:{color:"#B392F0"}},"read"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#79B8FF"}},"0"),t("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        }, "),t("span",{style:{color:"#9ECBFF"}},'"t2"'),t("span",{style:{color:"#E1E4E8"}},")."),t("span",{style:{color:"#B392F0"}},"start"),t("span",{style:{color:"#E1E4E8"}},"();")])])]),t("pre",{class:"shiki github-light vp-code-light"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"DataContainerStamped dataContainer "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"new"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"DataContainerStamped"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#005CC5"}},"1"),t("span",{style:{color:"#24292E"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"new"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"Thread"),t("span",{style:{color:"#24292E"}},"(() "),t("span",{style:{color:"#D73A49"}},"->"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            dataContainer."),t("span",{style:{color:"#6F42C1"}},"read"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#005CC5"}},"1"),t("span",{style:{color:"#24292E"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        }, "),t("span",{style:{color:"#032F62"}},'"t1"'),t("span",{style:{color:"#24292E"}},")."),t("span",{style:{color:"#6F42C1"}},"start"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6F42C1"}},"sleep"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#005CC5"}},"0.5"),t("span",{style:{color:"#24292E"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"new"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"Thread"),t("span",{style:{color:"#24292E"}},"(() "),t("span",{style:{color:"#D73A49"}},"->"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            dataContainer."),t("span",{style:{color:"#6F42C1"}},"read"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#005CC5"}},"0"),t("span",{style:{color:"#24292E"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        }, "),t("span",{style:{color:"#032F62"}},'"t2"'),t("span",{style:{color:"#24292E"}},")."),t("span",{style:{color:"#6F42C1"}},"start"),t("span",{style:{color:"#24292E"}},"();")])])])],-1),De=t("figure",null,[t("img",{src:"https://jsd.cdn.zzko.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230719203658874.png",alt:"image-20230719203658874",loading:"lazy",decoding:"async"})],-1),Ce=t("p",null,"测试 读-写 时优化读补加读锁",-1),he=t("div",{class:"language-java"},[t("button",{title:"Copy Code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki github-dark vp-code-dark"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"public"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"static"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"void"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"main"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#F97583"}},"String"),t("span",{style:{color:"#E1E4E8"}},"[] args) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"DataContainerStamped dataContainer "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"new"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"DataContainerStamped"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#79B8FF"}},"1"),t("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"new"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"Thread"),t("span",{style:{color:"#E1E4E8"}},"(() "),t("span",{style:{color:"#F97583"}},"->"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"dataContainer."),t("span",{style:{color:"#B392F0"}},"read"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#79B8FF"}},"1"),t("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"}, "),t("span",{style:{color:"#9ECBFF"}},'"t1"'),t("span",{style:{color:"#E1E4E8"}},")."),t("span",{style:{color:"#B392F0"}},"start"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#B392F0"}},"sleep"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#79B8FF"}},"0.5"),t("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"new"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"Thread"),t("span",{style:{color:"#E1E4E8"}},"(() "),t("span",{style:{color:"#F97583"}},"->"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"dataContainer."),t("span",{style:{color:"#B392F0"}},"write"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#79B8FF"}},"100"),t("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"}, "),t("span",{style:{color:"#9ECBFF"}},'"t2"'),t("span",{style:{color:"#E1E4E8"}},")."),t("span",{style:{color:"#B392F0"}},"start"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"}")])])]),t("pre",{class:"shiki github-light vp-code-light"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"public"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"static"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"void"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"main"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#D73A49"}},"String"),t("span",{style:{color:"#24292E"}},"[] args) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"DataContainerStamped dataContainer "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"new"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"DataContainerStamped"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#005CC5"}},"1"),t("span",{style:{color:"#24292E"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"new"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"Thread"),t("span",{style:{color:"#24292E"}},"(() "),t("span",{style:{color:"#D73A49"}},"->"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"dataContainer."),t("span",{style:{color:"#6F42C1"}},"read"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#005CC5"}},"1"),t("span",{style:{color:"#24292E"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"}, "),t("span",{style:{color:"#032F62"}},'"t1"'),t("span",{style:{color:"#24292E"}},")."),t("span",{style:{color:"#6F42C1"}},"start"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#6F42C1"}},"sleep"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#005CC5"}},"0.5"),t("span",{style:{color:"#24292E"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"new"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"Thread"),t("span",{style:{color:"#24292E"}},"(() "),t("span",{style:{color:"#D73A49"}},"->"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"dataContainer."),t("span",{style:{color:"#6F42C1"}},"write"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#005CC5"}},"100"),t("span",{style:{color:"#24292E"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"}, "),t("span",{style:{color:"#032F62"}},'"t2"'),t("span",{style:{color:"#24292E"}},")."),t("span",{style:{color:"#6F42C1"}},"start"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"}")])])])],-1),ge=t("figure",null,[t("img",{src:"https://jsd.cdn.zzko.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230719203736562.png",alt:"image-20230719203736562",loading:"lazy",decoding:"async"})],-1),Be=t("blockquote",null,[t("p",null,[t("strong",null,"注意")]),t("ul",null,[t("li",null,"StampedLock 不支持条件变量"),t("li",null,"StampedLock 不支持可重入")])],-1),fe={id:"_4、semaphore",tabindex:"-1"},ke={id:"基本使用",tabindex:"-1"},be=t("p",null,[t("code",null,"[ˈsɛməˌfɔr]"),p("信号量，用来限制能同时访问共享资源的线程上限。")],-1),me=t("div",{class:"language-java"},[t("button",{title:"Copy Code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki github-dark vp-code-dark"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"public"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"static"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"void"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"main"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#F97583"}},"String"),t("span",{style:{color:"#E1E4E8"}},"[] args) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#6A737D"}},"// 1. 创建 semaphore 对象")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        Semaphore semaphore "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"new"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"Semaphore"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#79B8FF"}},"3"),t("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#6A737D"}},"// 2. 10个线程同时运行")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"for"),t("span",{style:{color:"#E1E4E8"}}," ("),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," i "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"0"),t("span",{style:{color:"#E1E4E8"}},"; i "),t("span",{style:{color:"#F97583"}},"<"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"10"),t("span",{style:{color:"#E1E4E8"}},"; i"),t("span",{style:{color:"#F97583"}},"++"),t("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"new"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"Thread"),t("span",{style:{color:"#E1E4E8"}},"(() "),t("span",{style:{color:"#F97583"}},"->"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#6A737D"}},"// 3. 获取许可")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#F97583"}},"try"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                    semaphore."),t("span",{style:{color:"#B392F0"}},"acquire"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                } "),t("span",{style:{color:"#F97583"}},"catch"),t("span",{style:{color:"#E1E4E8"}}," (InterruptedException "),t("span",{style:{color:"#FFAB70"}},"e"),t("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                    e."),t("span",{style:{color:"#B392F0"}},"printStackTrace"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#F97583"}},"try"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                    log."),t("span",{style:{color:"#B392F0"}},"debug"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#9ECBFF"}},'"running..."'),t("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                    "),t("span",{style:{color:"#B392F0"}},"sleep"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#79B8FF"}},"1"),t("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                    log."),t("span",{style:{color:"#B392F0"}},"debug"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#9ECBFF"}},'"end..."'),t("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                } "),t("span",{style:{color:"#F97583"}},"finally"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                    "),t("span",{style:{color:"#6A737D"}},"// 4. 释放许可")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                    semaphore."),t("span",{style:{color:"#B392F0"}},"release"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            })."),t("span",{style:{color:"#B392F0"}},"start"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    }")])])]),t("pre",{class:"shiki github-light vp-code-light"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"public"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"static"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"void"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"main"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#D73A49"}},"String"),t("span",{style:{color:"#24292E"}},"[] args) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6A737D"}},"// 1. 创建 semaphore 对象")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        Semaphore semaphore "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"new"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"Semaphore"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#005CC5"}},"3"),t("span",{style:{color:"#24292E"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6A737D"}},"// 2. 10个线程同时运行")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"for"),t("span",{style:{color:"#24292E"}}," ("),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," i "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"0"),t("span",{style:{color:"#24292E"}},"; i "),t("span",{style:{color:"#D73A49"}},"<"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"10"),t("span",{style:{color:"#24292E"}},"; i"),t("span",{style:{color:"#D73A49"}},"++"),t("span",{style:{color:"#24292E"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"new"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"Thread"),t("span",{style:{color:"#24292E"}},"(() "),t("span",{style:{color:"#D73A49"}},"->"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#6A737D"}},"// 3. 获取许可")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#D73A49"}},"try"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                    semaphore."),t("span",{style:{color:"#6F42C1"}},"acquire"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                } "),t("span",{style:{color:"#D73A49"}},"catch"),t("span",{style:{color:"#24292E"}}," (InterruptedException "),t("span",{style:{color:"#E36209"}},"e"),t("span",{style:{color:"#24292E"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                    e."),t("span",{style:{color:"#6F42C1"}},"printStackTrace"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#D73A49"}},"try"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                    log."),t("span",{style:{color:"#6F42C1"}},"debug"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#032F62"}},'"running..."'),t("span",{style:{color:"#24292E"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                    "),t("span",{style:{color:"#6F42C1"}},"sleep"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#005CC5"}},"1"),t("span",{style:{color:"#24292E"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                    log."),t("span",{style:{color:"#6F42C1"}},"debug"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#032F62"}},'"end..."'),t("span",{style:{color:"#24292E"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                } "),t("span",{style:{color:"#D73A49"}},"finally"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                    "),t("span",{style:{color:"#6A737D"}},"// 4. 释放许可")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                    semaphore."),t("span",{style:{color:"#6F42C1"}},"release"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            })."),t("span",{style:{color:"#6F42C1"}},"start"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    }")])])])],-1),Se=t("figure",null,[t("img",{src:"https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230719204835660.png",alt:"image-20230719204835660",loading:"lazy",decoding:"async"})],-1),ve={id:"semaphore-应用",tabindex:"-1"},we=t("ul",null,[t("li",null,"使用 Semaphore 限流，在访问高峰期时，让请求线程阻塞，高峰期过去再释放许可，当然它只适合限制单机线程数量，并且仅是限制线程数，而不是限制资源数（例如连接数，请对比 Tomcat LimitLatch 的实现）"),t("li",null,"用 Semaphore 实现简单连接池，对比『享元模式』下的实现（用wait notify），性能和可读性显然更好，注意下面的实现中线程数和数据库连接数是相等的")],-1),Te=t("p",null,"修改之前第七章的连接池代码",-1),xe=t("div",{class:"language-java"},[t("button",{title:"Copy Code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki github-dark vp-code-dark"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"@"),t("span",{style:{color:"#F97583"}},"Slf4j"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#79B8FF"}},"topic"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#9ECBFF"}},'"c.Pool"'),t("span",{style:{color:"#E1E4E8"}},")")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"class"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"Pool"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// 1. 连接池大小")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"private"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"final"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," poolSize;")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// 2. 连接对象数组")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"private"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"Connection"),t("span",{style:{color:"#E1E4E8"}},"[] connections;")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// 3. 连接状态数组 0 表示空闲， 1 表示繁忙")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"private"),t("span",{style:{color:"#E1E4E8"}}," AtomicIntegerArray states;")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"private"),t("span",{style:{color:"#E1E4E8"}}," Semaphore semaphore;")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// 4. 构造方法初始化")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"public"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"Pool"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#FFAB70"}},"poolSize"),t("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#79B8FF"}},"this"),t("span",{style:{color:"#E1E4E8"}},".poolSize "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," poolSize;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#6A737D"}},"// 让许可数与资源数一致")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#79B8FF"}},"this"),t("span",{style:{color:"#E1E4E8"}},".semaphore "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"new"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"Semaphore"),t("span",{style:{color:"#E1E4E8"}},"(poolSize);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#79B8FF"}},"this"),t("span",{style:{color:"#E1E4E8"}},".connections "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"new"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"Connection"),t("span",{style:{color:"#E1E4E8"}},"[poolSize];")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#79B8FF"}},"this"),t("span",{style:{color:"#E1E4E8"}},".states "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"new"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"AtomicIntegerArray"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#F97583"}},"new"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}},"[poolSize]);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"for"),t("span",{style:{color:"#E1E4E8"}}," ("),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," i "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"0"),t("span",{style:{color:"#E1E4E8"}},"; i "),t("span",{style:{color:"#F97583"}},"<"),t("span",{style:{color:"#E1E4E8"}}," poolSize; i"),t("span",{style:{color:"#F97583"}},"++"),t("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            connections[i] "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"new"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"MockConnection"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#9ECBFF"}},'"连接"'),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"+"),t("span",{style:{color:"#E1E4E8"}}," (i"),t("span",{style:{color:"#F97583"}},"+"),t("span",{style:{color:"#79B8FF"}},"1"),t("span",{style:{color:"#E1E4E8"}},"));")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// 5. 借连接")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"public"),t("span",{style:{color:"#E1E4E8"}}," Connection "),t("span",{style:{color:"#B392F0"}},"borrow"),t("span",{style:{color:"#E1E4E8"}},"() {"),t("span",{style:{color:"#6A737D"}},"// t1, t2, t3")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#6A737D"}},"// 获取许可")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"try"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            semaphore."),t("span",{style:{color:"#B392F0"}},"acquire"),t("span",{style:{color:"#E1E4E8"}},"(); "),t("span",{style:{color:"#6A737D"}},"// 没有许可的线程，在此等待")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        } "),t("span",{style:{color:"#F97583"}},"catch"),t("span",{style:{color:"#E1E4E8"}}," (InterruptedException "),t("span",{style:{color:"#FFAB70"}},"e"),t("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            e."),t("span",{style:{color:"#B392F0"}},"printStackTrace"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"for"),t("span",{style:{color:"#E1E4E8"}}," ("),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," i "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"0"),t("span",{style:{color:"#E1E4E8"}},"; i "),t("span",{style:{color:"#F97583"}},"<"),t("span",{style:{color:"#E1E4E8"}}," poolSize; i"),t("span",{style:{color:"#F97583"}},"++"),t("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#6A737D"}},"// 获取空闲连接")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}},"(states."),t("span",{style:{color:"#B392F0"}},"get"),t("span",{style:{color:"#E1E4E8"}},"(i) "),t("span",{style:{color:"#F97583"}},"=="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"0"),t("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (states."),t("span",{style:{color:"#B392F0"}},"compareAndSet"),t("span",{style:{color:"#E1E4E8"}},"(i, "),t("span",{style:{color:"#79B8FF"}},"0"),t("span",{style:{color:"#E1E4E8"}},", "),t("span",{style:{color:"#79B8FF"}},"1"),t("span",{style:{color:"#E1E4E8"}},")) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                    log."),t("span",{style:{color:"#B392F0"}},"debug"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#9ECBFF"}},'"borrow {}"'),t("span",{style:{color:"#E1E4E8"}},", connections[i]);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                    "),t("span",{style:{color:"#F97583"}},"return"),t("span",{style:{color:"#E1E4E8"}}," connections[i];")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#6A737D"}},"// 不会执行到这里")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"return"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"null"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// 6. 归还连接")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"public"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"void"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"free"),t("span",{style:{color:"#E1E4E8"}},"(Connection "),t("span",{style:{color:"#FFAB70"}},"conn"),t("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"for"),t("span",{style:{color:"#E1E4E8"}}," ("),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," i "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"0"),t("span",{style:{color:"#E1E4E8"}},"; i "),t("span",{style:{color:"#F97583"}},"<"),t("span",{style:{color:"#E1E4E8"}}," poolSize; i"),t("span",{style:{color:"#F97583"}},"++"),t("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (connections[i] "),t("span",{style:{color:"#F97583"}},"=="),t("span",{style:{color:"#E1E4E8"}}," conn) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                states."),t("span",{style:{color:"#B392F0"}},"set"),t("span",{style:{color:"#E1E4E8"}},"(i, "),t("span",{style:{color:"#79B8FF"}},"0"),t("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                log."),t("span",{style:{color:"#B392F0"}},"debug"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#9ECBFF"}},'"free {}"'),t("span",{style:{color:"#E1E4E8"}},", conn);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                semaphore."),t("span",{style:{color:"#B392F0"}},"release"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#F97583"}},"break"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"}")])])]),t("pre",{class:"shiki github-light vp-code-light"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"@"),t("span",{style:{color:"#D73A49"}},"Slf4j"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#005CC5"}},"topic"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#032F62"}},'"c.Pool"'),t("span",{style:{color:"#24292E"}},")")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"class"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"Pool"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// 1. 连接池大小")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"private"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"final"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," poolSize;")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// 2. 连接对象数组")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"private"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"Connection"),t("span",{style:{color:"#24292E"}},"[] connections;")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// 3. 连接状态数组 0 表示空闲， 1 表示繁忙")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"private"),t("span",{style:{color:"#24292E"}}," AtomicIntegerArray states;")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"private"),t("span",{style:{color:"#24292E"}}," Semaphore semaphore;")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// 4. 构造方法初始化")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"public"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"Pool"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#E36209"}},"poolSize"),t("span",{style:{color:"#24292E"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#005CC5"}},"this"),t("span",{style:{color:"#24292E"}},".poolSize "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," poolSize;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6A737D"}},"// 让许可数与资源数一致")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#005CC5"}},"this"),t("span",{style:{color:"#24292E"}},".semaphore "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"new"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"Semaphore"),t("span",{style:{color:"#24292E"}},"(poolSize);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#005CC5"}},"this"),t("span",{style:{color:"#24292E"}},".connections "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"new"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"Connection"),t("span",{style:{color:"#24292E"}},"[poolSize];")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#005CC5"}},"this"),t("span",{style:{color:"#24292E"}},".states "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"new"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"AtomicIntegerArray"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#D73A49"}},"new"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}},"[poolSize]);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"for"),t("span",{style:{color:"#24292E"}}," ("),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," i "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"0"),t("span",{style:{color:"#24292E"}},"; i "),t("span",{style:{color:"#D73A49"}},"<"),t("span",{style:{color:"#24292E"}}," poolSize; i"),t("span",{style:{color:"#D73A49"}},"++"),t("span",{style:{color:"#24292E"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            connections[i] "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"new"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"MockConnection"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#032F62"}},'"连接"'),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"+"),t("span",{style:{color:"#24292E"}}," (i"),t("span",{style:{color:"#D73A49"}},"+"),t("span",{style:{color:"#005CC5"}},"1"),t("span",{style:{color:"#24292E"}},"));")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    }")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// 5. 借连接")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"public"),t("span",{style:{color:"#24292E"}}," Connection "),t("span",{style:{color:"#6F42C1"}},"borrow"),t("span",{style:{color:"#24292E"}},"() {"),t("span",{style:{color:"#6A737D"}},"// t1, t2, t3")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6A737D"}},"// 获取许可")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"try"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            semaphore."),t("span",{style:{color:"#6F42C1"}},"acquire"),t("span",{style:{color:"#24292E"}},"(); "),t("span",{style:{color:"#6A737D"}},"// 没有许可的线程，在此等待")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        } "),t("span",{style:{color:"#D73A49"}},"catch"),t("span",{style:{color:"#24292E"}}," (InterruptedException "),t("span",{style:{color:"#E36209"}},"e"),t("span",{style:{color:"#24292E"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            e."),t("span",{style:{color:"#6F42C1"}},"printStackTrace"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"for"),t("span",{style:{color:"#24292E"}}," ("),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," i "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"0"),t("span",{style:{color:"#24292E"}},"; i "),t("span",{style:{color:"#D73A49"}},"<"),t("span",{style:{color:"#24292E"}}," poolSize; i"),t("span",{style:{color:"#D73A49"}},"++"),t("span",{style:{color:"#24292E"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#6A737D"}},"// 获取空闲连接")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}},"(states."),t("span",{style:{color:"#6F42C1"}},"get"),t("span",{style:{color:"#24292E"}},"(i) "),t("span",{style:{color:"#D73A49"}},"=="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"0"),t("span",{style:{color:"#24292E"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (states."),t("span",{style:{color:"#6F42C1"}},"compareAndSet"),t("span",{style:{color:"#24292E"}},"(i, "),t("span",{style:{color:"#005CC5"}},"0"),t("span",{style:{color:"#24292E"}},", "),t("span",{style:{color:"#005CC5"}},"1"),t("span",{style:{color:"#24292E"}},")) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                    log."),t("span",{style:{color:"#6F42C1"}},"debug"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#032F62"}},'"borrow {}"'),t("span",{style:{color:"#24292E"}},", connections[i]);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                    "),t("span",{style:{color:"#D73A49"}},"return"),t("span",{style:{color:"#24292E"}}," connections[i];")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6A737D"}},"// 不会执行到这里")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"return"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"null"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// 6. 归还连接")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"public"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"void"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"free"),t("span",{style:{color:"#24292E"}},"(Connection "),t("span",{style:{color:"#E36209"}},"conn"),t("span",{style:{color:"#24292E"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"for"),t("span",{style:{color:"#24292E"}}," ("),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," i "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"0"),t("span",{style:{color:"#24292E"}},"; i "),t("span",{style:{color:"#D73A49"}},"<"),t("span",{style:{color:"#24292E"}}," poolSize; i"),t("span",{style:{color:"#D73A49"}},"++"),t("span",{style:{color:"#24292E"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (connections[i] "),t("span",{style:{color:"#D73A49"}},"=="),t("span",{style:{color:"#24292E"}}," conn) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                states."),t("span",{style:{color:"#6F42C1"}},"set"),t("span",{style:{color:"#24292E"}},"(i, "),t("span",{style:{color:"#005CC5"}},"0"),t("span",{style:{color:"#24292E"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                log."),t("span",{style:{color:"#6F42C1"}},"debug"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#032F62"}},'"free {}"'),t("span",{style:{color:"#24292E"}},", conn);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                semaphore."),t("span",{style:{color:"#6F42C1"}},"release"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#D73A49"}},"break"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"}")])])])],-1),Ne={id:"semaphore-原理",tabindex:"-1"},Ie={id:"加锁解锁流程-1",tabindex:"-1"},Le=t("p",null,"Semaphore 有点像一个停车场，permits 就好像停车位数量，当线程获得了 permits 就像是获得了停车位，然后 停车场显示空余车位减一 刚开始，permits（state）为 3，这时 5 个线程来获取资源",-1),je=t("figure",null,[t("img",{src:"https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230719211330596.png",alt:"image-20230719211330596",loading:"lazy",decoding:"async"})],-1),Re=t("p",null,"假设其中 Thread-1，Thread-2，Thread-4 cas 竞争成功，而 Thread-0 和 Thread-3 竞争失败，进入 AQS 队列 park 阻塞",-1),Oe=t("figure",null,[t("img",{src:"https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230719211343768.png",alt:"image-20230719211343768",loading:"lazy",decoding:"async"})],-1),qe=t("p",null,"这时 Thread-4 释放了 permits，状态如下",-1),Pe=t("figure",null,[t("img",{src:"https://jsd.cdn.zzko.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230719211353401.png",alt:"image-20230719211353401",loading:"lazy",decoding:"async"})],-1),ze=t("p",null,"接下来 Thread-0 竞争成功，permits 再次设置为 0，设置自己为 head 节点，断开原来的 head 节点，unpark 接 下来的 Thread-3 节点，但由于 permits 是 0，因此 Thread-3 在尝试不成功后再次进入 park 状态",-1),_e=t("figure",null,[t("img",{src:"https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230719211405162.png",alt:"image-20230719211405162",loading:"lazy",decoding:"async"})],-1),Ke={id:"源码分析-2",tabindex:"-1"},Ve=t("div",{class:"language-java"},[t("button",{title:"Copy Code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki github-dark vp-code-dark"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"static"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"final"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"class"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"NonfairSync"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"extends"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"Sync"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"private"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"static"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"final"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"long"),t("span",{style:{color:"#E1E4E8"}}," serialVersionUID "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"-"),t("span",{style:{color:"#79B8FF"}},"2694183684443567898L"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#B392F0"}},"NonfairSync"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#FFAB70"}},"permits"),t("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#6A737D"}},"// permits 即 state")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#79B8FF"}},"super"),t("span",{style:{color:"#E1E4E8"}},"(permits);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// Semaphore 方法, 方便阅读, 放在此处")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"public"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"void"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"acquire"),t("span",{style:{color:"#E1E4E8"}},"() "),t("span",{style:{color:"#F97583"}},"throws"),t("span",{style:{color:"#E1E4E8"}}," InterruptedException {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        sync."),t("span",{style:{color:"#B392F0"}},"acquireSharedInterruptibly"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#79B8FF"}},"1"),t("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// AQS 继承过来的方法, 方便阅读, 放在此处")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"public"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"final"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"void"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"acquireSharedInterruptibly"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#FFAB70"}},"arg"),t("span",{style:{color:"#E1E4E8"}},")")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"throws"),t("span",{style:{color:"#E1E4E8"}}," InterruptedException {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (Thread."),t("span",{style:{color:"#B392F0"}},"interrupted"),t("span",{style:{color:"#E1E4E8"}},"())")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"throw"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"new"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"InterruptedException"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," ("),t("span",{style:{color:"#B392F0"}},"tryAcquireShared"),t("span",{style:{color:"#E1E4E8"}},"(arg) "),t("span",{style:{color:"#F97583"}},"<"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"0"),t("span",{style:{color:"#E1E4E8"}},")")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#B392F0"}},"doAcquireSharedInterruptibly"),t("span",{style:{color:"#E1E4E8"}},"(arg);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// 尝试获得共享锁")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"protected"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"tryAcquireShared"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#FFAB70"}},"acquires"),t("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"return"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"nonfairTryAcquireShared"),t("span",{style:{color:"#E1E4E8"}},"(acquires);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// Sync 继承过来的方法, 方便阅读, 放在此处")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"final"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"nonfairTryAcquireShared"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#FFAB70"}},"acquires"),t("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"for"),t("span",{style:{color:"#E1E4E8"}}," (;;) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," available "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"getState"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," remaining "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," available "),t("span",{style:{color:"#F97583"}},"-"),t("span",{style:{color:"#E1E4E8"}}," acquires;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#6A737D"}},"// 如果许可已经用完, 返回负数, 表示获取失败, 进入 doAcquireSharedInterruptibly")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                    remaining "),t("span",{style:{color:"#F97583"}},"<"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"0"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"||")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                            "),t("span",{style:{color:"#6A737D"}},"// 如果 cas 重试成功, 返回正数, 表示获取成功")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                            "),t("span",{style:{color:"#B392F0"}},"compareAndSetState"),t("span",{style:{color:"#E1E4E8"}},"(available, remaining)")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            ) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#F97583"}},"return"),t("span",{style:{color:"#E1E4E8"}}," remaining;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// AQS 继承过来的方法, 方便阅读, 放在此处")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"private"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"void"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"doAcquireSharedInterruptibly"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#FFAB70"}},"arg"),t("span",{style:{color:"#E1E4E8"}},") "),t("span",{style:{color:"#F97583"}},"throws"),t("span",{style:{color:"#E1E4E8"}}," InterruptedException {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"final"),t("span",{style:{color:"#E1E4E8"}}," Node node "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"addWaiter"),t("span",{style:{color:"#E1E4E8"}},"(Node.SHARED);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"boolean"),t("span",{style:{color:"#E1E4E8"}}," failed "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"true"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"try"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"for"),t("span",{style:{color:"#E1E4E8"}}," (;;) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#F97583"}},"final"),t("span",{style:{color:"#E1E4E8"}}," Node p "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," node."),t("span",{style:{color:"#B392F0"}},"predecessor"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (p "),t("span",{style:{color:"#F97583"}},"=="),t("span",{style:{color:"#E1E4E8"}}," head) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                    "),t("span",{style:{color:"#6A737D"}},"// 再次尝试获取许可")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                    "),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," r "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"tryAcquireShared"),t("span",{style:{color:"#E1E4E8"}},"(arg);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                    "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (r "),t("span",{style:{color:"#F97583"}},">="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"0"),t("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                        "),t("span",{style:{color:"#6A737D"}},"// 成功后本线程出队（AQS）, 所在 Node设置为 head")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                        "),t("span",{style:{color:"#6A737D"}},"// 如果 head.waitStatus == Node.SIGNAL ==> 0 成功, 下一个节点 unpark")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                        "),t("span",{style:{color:"#6A737D"}},"// 如果 head.waitStatus == 0 ==> Node.PROPAGATE")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"\t\t\t\t\t  "),t("span",{style:{color:"#6A737D"}},"// r 表示可用资源数, 为 0 则不会继续传播")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                        "),t("span",{style:{color:"#B392F0"}},"setHeadAndPropagate"),t("span",{style:{color:"#E1E4E8"}},"(node, r);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                        p.next "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"null"),t("span",{style:{color:"#E1E4E8"}},"; "),t("span",{style:{color:"#6A737D"}},"// help GC")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                        failed "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"false"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                        "),t("span",{style:{color:"#F97583"}},"return"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#6A737D"}},"// 不成功, 设置上一个节点 waitStatus = Node.SIGNAL, 下轮进入 park 阻塞")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," ("),t("span",{style:{color:"#B392F0"}},"shouldParkAfterFailedAcquire"),t("span",{style:{color:"#E1E4E8"}},"(p, node) "),t("span",{style:{color:"#F97583"}},"&&")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                        "),t("span",{style:{color:"#B392F0"}},"parkAndCheckInterrupt"),t("span",{style:{color:"#E1E4E8"}},"())")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                    "),t("span",{style:{color:"#F97583"}},"throw"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"new"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"InterruptedException"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        } "),t("span",{style:{color:"#F97583"}},"finally"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (failed)")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#B392F0"}},"cancelAcquire"),t("span",{style:{color:"#E1E4E8"}},"(node);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// Semaphore 方法, 方便阅读, 放在此处")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"public"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"void"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"release"),t("span",{style:{color:"#E1E4E8"}},"() {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        sync."),t("span",{style:{color:"#B392F0"}},"releaseShared"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#79B8FF"}},"1"),t("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// AQS 继承过来的方法, 方便阅读, 放在此处")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"public"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"final"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"boolean"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"releaseShared"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#FFAB70"}},"arg"),t("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," ("),t("span",{style:{color:"#B392F0"}},"tryReleaseShared"),t("span",{style:{color:"#E1E4E8"}},"(arg)) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#B392F0"}},"doReleaseShared"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"return"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"true"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"return"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"false"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// Sync 继承过来的方法, 方便阅读, 放在此处")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"protected"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"final"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"boolean"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"tryReleaseShared"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#FFAB70"}},"releases"),t("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"for"),t("span",{style:{color:"#E1E4E8"}}," (;;) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," current "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"getState"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," next "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," current "),t("span",{style:{color:"#F97583"}},"+"),t("span",{style:{color:"#E1E4E8"}}," releases;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (next "),t("span",{style:{color:"#F97583"}},"<"),t("span",{style:{color:"#E1E4E8"}}," current) "),t("span",{style:{color:"#6A737D"}},"// overflow")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#F97583"}},"throw"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"new"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"Error"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#9ECBFF"}},'"Maximum permit count exceeded"'),t("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," ("),t("span",{style:{color:"#B392F0"}},"compareAndSetState"),t("span",{style:{color:"#E1E4E8"}},"(current, next))")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#F97583"}},"return"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"true"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"}")])])]),t("pre",{class:"shiki github-light vp-code-light"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"static"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"final"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"class"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"NonfairSync"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"extends"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"Sync"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"private"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"static"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"final"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"long"),t("span",{style:{color:"#24292E"}}," serialVersionUID "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"-"),t("span",{style:{color:"#005CC5"}},"2694183684443567898L"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6F42C1"}},"NonfairSync"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#E36209"}},"permits"),t("span",{style:{color:"#24292E"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6A737D"}},"// permits 即 state")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#005CC5"}},"super"),t("span",{style:{color:"#24292E"}},"(permits);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    }")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// Semaphore 方法, 方便阅读, 放在此处")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"public"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"void"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"acquire"),t("span",{style:{color:"#24292E"}},"() "),t("span",{style:{color:"#D73A49"}},"throws"),t("span",{style:{color:"#24292E"}}," InterruptedException {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        sync."),t("span",{style:{color:"#6F42C1"}},"acquireSharedInterruptibly"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#005CC5"}},"1"),t("span",{style:{color:"#24292E"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// AQS 继承过来的方法, 方便阅读, 放在此处")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"public"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"final"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"void"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"acquireSharedInterruptibly"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#E36209"}},"arg"),t("span",{style:{color:"#24292E"}},")")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"throws"),t("span",{style:{color:"#24292E"}}," InterruptedException {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (Thread."),t("span",{style:{color:"#6F42C1"}},"interrupted"),t("span",{style:{color:"#24292E"}},"())")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"throw"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"new"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"InterruptedException"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," ("),t("span",{style:{color:"#6F42C1"}},"tryAcquireShared"),t("span",{style:{color:"#24292E"}},"(arg) "),t("span",{style:{color:"#D73A49"}},"<"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"0"),t("span",{style:{color:"#24292E"}},")")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#6F42C1"}},"doAcquireSharedInterruptibly"),t("span",{style:{color:"#24292E"}},"(arg);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    }")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// 尝试获得共享锁")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"protected"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"tryAcquireShared"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#E36209"}},"acquires"),t("span",{style:{color:"#24292E"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"return"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"nonfairTryAcquireShared"),t("span",{style:{color:"#24292E"}},"(acquires);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    }")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// Sync 继承过来的方法, 方便阅读, 放在此处")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"final"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"nonfairTryAcquireShared"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#E36209"}},"acquires"),t("span",{style:{color:"#24292E"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"for"),t("span",{style:{color:"#24292E"}}," (;;) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," available "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"getState"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," remaining "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," available "),t("span",{style:{color:"#D73A49"}},"-"),t("span",{style:{color:"#24292E"}}," acquires;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#6A737D"}},"// 如果许可已经用完, 返回负数, 表示获取失败, 进入 doAcquireSharedInterruptibly")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                    remaining "),t("span",{style:{color:"#D73A49"}},"<"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"0"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"||")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                            "),t("span",{style:{color:"#6A737D"}},"// 如果 cas 重试成功, 返回正数, 表示获取成功")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                            "),t("span",{style:{color:"#6F42C1"}},"compareAndSetState"),t("span",{style:{color:"#24292E"}},"(available, remaining)")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            ) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#D73A49"}},"return"),t("span",{style:{color:"#24292E"}}," remaining;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    }")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// AQS 继承过来的方法, 方便阅读, 放在此处")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"private"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"void"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"doAcquireSharedInterruptibly"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#E36209"}},"arg"),t("span",{style:{color:"#24292E"}},") "),t("span",{style:{color:"#D73A49"}},"throws"),t("span",{style:{color:"#24292E"}}," InterruptedException {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"final"),t("span",{style:{color:"#24292E"}}," Node node "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"addWaiter"),t("span",{style:{color:"#24292E"}},"(Node.SHARED);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"boolean"),t("span",{style:{color:"#24292E"}}," failed "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"true"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"try"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"for"),t("span",{style:{color:"#24292E"}}," (;;) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#D73A49"}},"final"),t("span",{style:{color:"#24292E"}}," Node p "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," node."),t("span",{style:{color:"#6F42C1"}},"predecessor"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (p "),t("span",{style:{color:"#D73A49"}},"=="),t("span",{style:{color:"#24292E"}}," head) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                    "),t("span",{style:{color:"#6A737D"}},"// 再次尝试获取许可")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                    "),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," r "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"tryAcquireShared"),t("span",{style:{color:"#24292E"}},"(arg);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                    "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (r "),t("span",{style:{color:"#D73A49"}},">="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"0"),t("span",{style:{color:"#24292E"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                        "),t("span",{style:{color:"#6A737D"}},"// 成功后本线程出队（AQS）, 所在 Node设置为 head")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                        "),t("span",{style:{color:"#6A737D"}},"// 如果 head.waitStatus == Node.SIGNAL ==> 0 成功, 下一个节点 unpark")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                        "),t("span",{style:{color:"#6A737D"}},"// 如果 head.waitStatus == 0 ==> Node.PROPAGATE")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"\t\t\t\t\t  "),t("span",{style:{color:"#6A737D"}},"// r 表示可用资源数, 为 0 则不会继续传播")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                        "),t("span",{style:{color:"#6F42C1"}},"setHeadAndPropagate"),t("span",{style:{color:"#24292E"}},"(node, r);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                        p.next "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"null"),t("span",{style:{color:"#24292E"}},"; "),t("span",{style:{color:"#6A737D"}},"// help GC")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                        failed "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"false"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                        "),t("span",{style:{color:"#D73A49"}},"return"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#6A737D"}},"// 不成功, 设置上一个节点 waitStatus = Node.SIGNAL, 下轮进入 park 阻塞")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," ("),t("span",{style:{color:"#6F42C1"}},"shouldParkAfterFailedAcquire"),t("span",{style:{color:"#24292E"}},"(p, node) "),t("span",{style:{color:"#D73A49"}},"&&")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                        "),t("span",{style:{color:"#6F42C1"}},"parkAndCheckInterrupt"),t("span",{style:{color:"#24292E"}},"())")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                    "),t("span",{style:{color:"#D73A49"}},"throw"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"new"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"InterruptedException"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        } "),t("span",{style:{color:"#D73A49"}},"finally"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (failed)")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#6F42C1"}},"cancelAcquire"),t("span",{style:{color:"#24292E"}},"(node);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    }")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// Semaphore 方法, 方便阅读, 放在此处")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"public"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"void"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"release"),t("span",{style:{color:"#24292E"}},"() {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        sync."),t("span",{style:{color:"#6F42C1"}},"releaseShared"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#005CC5"}},"1"),t("span",{style:{color:"#24292E"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    }")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// AQS 继承过来的方法, 方便阅读, 放在此处")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"public"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"final"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"boolean"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"releaseShared"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#E36209"}},"arg"),t("span",{style:{color:"#24292E"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," ("),t("span",{style:{color:"#6F42C1"}},"tryReleaseShared"),t("span",{style:{color:"#24292E"}},"(arg)) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#6F42C1"}},"doReleaseShared"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"return"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"true"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"return"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"false"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    }")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// Sync 继承过来的方法, 方便阅读, 放在此处")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"protected"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"final"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"boolean"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"tryReleaseShared"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#E36209"}},"releases"),t("span",{style:{color:"#24292E"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"for"),t("span",{style:{color:"#24292E"}}," (;;) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," current "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"getState"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," next "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," current "),t("span",{style:{color:"#D73A49"}},"+"),t("span",{style:{color:"#24292E"}}," releases;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (next "),t("span",{style:{color:"#D73A49"}},"<"),t("span",{style:{color:"#24292E"}}," current) "),t("span",{style:{color:"#6A737D"}},"// overflow")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#D73A49"}},"throw"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"new"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"Error"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#032F62"}},'"Maximum permit count exceeded"'),t("span",{style:{color:"#24292E"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," ("),t("span",{style:{color:"#6F42C1"}},"compareAndSetState"),t("span",{style:{color:"#24292E"}},"(current, next))")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#D73A49"}},"return"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"true"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"}")])])])],-1),Me={id:"为什么要有-propagate",tabindex:"-1"},We=t("p",null,[t("strong",null,"早期有 bug")],-1),Ue=t("ul",null,[t("li",null,"releaseShared 方法")],-1),Qe=t("div",{class:"language-java"},[t("button",{title:"Copy Code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki github-dark vp-code-dark"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"public"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"final"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"boolean"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"releaseShared"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," arg) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," ("),t("span",{style:{color:"#B392F0"}},"tryReleaseShared"),t("span",{style:{color:"#E1E4E8"}},"(arg)) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    \tNode h "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," head;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (h "),t("span",{style:{color:"#F97583"}},"!="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"null"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"&&"),t("span",{style:{color:"#E1E4E8"}}," h.waitStatus "),t("span",{style:{color:"#F97583"}},"!="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"0"),t("span",{style:{color:"#E1E4E8"}},")")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#B392F0"}},"unparkSuccessor"),t("span",{style:{color:"#E1E4E8"}},"(h);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    \t"),t("span",{style:{color:"#F97583"}},"return"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"true"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"return"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"false"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"}")])])]),t("pre",{class:"shiki github-light vp-code-light"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"public"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"final"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"boolean"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"releaseShared"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," arg) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," ("),t("span",{style:{color:"#6F42C1"}},"tryReleaseShared"),t("span",{style:{color:"#24292E"}},"(arg)) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    \tNode h "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," head;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (h "),t("span",{style:{color:"#D73A49"}},"!="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"null"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"&&"),t("span",{style:{color:"#24292E"}}," h.waitStatus "),t("span",{style:{color:"#D73A49"}},"!="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"0"),t("span",{style:{color:"#24292E"}},")")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#6F42C1"}},"unparkSuccessor"),t("span",{style:{color:"#24292E"}},"(h);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    \t"),t("span",{style:{color:"#D73A49"}},"return"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"true"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"return"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"false"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"}")])])])],-1),He=t("ul",null,[t("li",null,"doAcquireShared 方法")],-1),Ge=t("div",{class:"language-java"},[t("button",{title:"Copy Code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki github-dark vp-code-dark"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"private"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"void"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"doAcquireShared"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," arg) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"final"),t("span",{style:{color:"#E1E4E8"}}," Node node "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"addWaiter"),t("span",{style:{color:"#E1E4E8"}},"(Node.SHARED);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"boolean"),t("span",{style:{color:"#E1E4E8"}}," failed "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"true"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"try"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"boolean"),t("span",{style:{color:"#E1E4E8"}}," interrupted "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"false"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"for"),t("span",{style:{color:"#E1E4E8"}}," (;;) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"final"),t("span",{style:{color:"#E1E4E8"}}," Node p "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," node."),t("span",{style:{color:"#B392F0"}},"predecessor"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (p "),t("span",{style:{color:"#F97583"}},"=="),t("span",{style:{color:"#E1E4E8"}}," head) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," r "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"tryAcquireShared"),t("span",{style:{color:"#E1E4E8"}},"(arg);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (r "),t("span",{style:{color:"#F97583"}},">="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"0"),t("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                    "),t("span",{style:{color:"#6A737D"}},"// 这里会有空档")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                    "),t("span",{style:{color:"#B392F0"}},"setHeadAndPropagate"),t("span",{style:{color:"#E1E4E8"}},"(node, r);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                    p.next "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"null"),t("span",{style:{color:"#E1E4E8"}},"; "),t("span",{style:{color:"#6A737D"}},"// help GC")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                    "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (interrupted)")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                    \t"),t("span",{style:{color:"#B392F0"}},"selfInterrupt"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                    failed "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"false"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                    "),t("span",{style:{color:"#F97583"}},"return"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," ("),t("span",{style:{color:"#B392F0"}},"shouldParkAfterFailedAcquire"),t("span",{style:{color:"#E1E4E8"}},"(p, node) "),t("span",{style:{color:"#F97583"}},"&&")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            \t"),t("span",{style:{color:"#B392F0"}},"parkAndCheckInterrupt"),t("span",{style:{color:"#E1E4E8"}},"())")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                interrupted "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"true"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    } "),t("span",{style:{color:"#F97583"}},"finally"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (failed)")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        \t"),t("span",{style:{color:"#B392F0"}},"cancelAcquire"),t("span",{style:{color:"#E1E4E8"}},"(node);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"}")])])]),t("pre",{class:"shiki github-light vp-code-light"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"private"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"void"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"doAcquireShared"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," arg) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"final"),t("span",{style:{color:"#24292E"}}," Node node "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"addWaiter"),t("span",{style:{color:"#24292E"}},"(Node.SHARED);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"boolean"),t("span",{style:{color:"#24292E"}}," failed "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"true"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"try"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"boolean"),t("span",{style:{color:"#24292E"}}," interrupted "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"false"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"for"),t("span",{style:{color:"#24292E"}}," (;;) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"final"),t("span",{style:{color:"#24292E"}}," Node p "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," node."),t("span",{style:{color:"#6F42C1"}},"predecessor"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (p "),t("span",{style:{color:"#D73A49"}},"=="),t("span",{style:{color:"#24292E"}}," head) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," r "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"tryAcquireShared"),t("span",{style:{color:"#24292E"}},"(arg);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (r "),t("span",{style:{color:"#D73A49"}},">="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"0"),t("span",{style:{color:"#24292E"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                    "),t("span",{style:{color:"#6A737D"}},"// 这里会有空档")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                    "),t("span",{style:{color:"#6F42C1"}},"setHeadAndPropagate"),t("span",{style:{color:"#24292E"}},"(node, r);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                    p.next "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"null"),t("span",{style:{color:"#24292E"}},"; "),t("span",{style:{color:"#6A737D"}},"// help GC")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                    "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (interrupted)")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                    \t"),t("span",{style:{color:"#6F42C1"}},"selfInterrupt"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                    failed "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"false"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                    "),t("span",{style:{color:"#D73A49"}},"return"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," ("),t("span",{style:{color:"#6F42C1"}},"shouldParkAfterFailedAcquire"),t("span",{style:{color:"#24292E"}},"(p, node) "),t("span",{style:{color:"#D73A49"}},"&&")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            \t"),t("span",{style:{color:"#6F42C1"}},"parkAndCheckInterrupt"),t("span",{style:{color:"#24292E"}},"())")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                interrupted "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"true"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    } "),t("span",{style:{color:"#D73A49"}},"finally"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (failed)")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        \t"),t("span",{style:{color:"#6F42C1"}},"cancelAcquire"),t("span",{style:{color:"#24292E"}},"(node);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"}")])])])],-1),Je=t("ul",null,[t("li",null,"setHeadAndPropagate 方法")],-1),Ye=t("div",{class:"language-java"},[t("button",{title:"Copy Code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki github-dark vp-code-dark"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"private"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"void"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"setHeadAndPropagate"),t("span",{style:{color:"#E1E4E8"}},"(Node node, "),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," propagate) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#B392F0"}},"setHead"),t("span",{style:{color:"#E1E4E8"}},"(node);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// 有空闲资源")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (propagate "),t("span",{style:{color:"#F97583"}},">"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"0"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"&&"),t("span",{style:{color:"#E1E4E8"}}," node.waitStatus "),t("span",{style:{color:"#F97583"}},"!="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"0"),t("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        Node s "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," node.next;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#6A737D"}},"// 下一个")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (s "),t("span",{style:{color:"#F97583"}},"=="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"null"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"||"),t("span",{style:{color:"#E1E4E8"}}," s."),t("span",{style:{color:"#B392F0"}},"isShared"),t("span",{style:{color:"#E1E4E8"}},"())")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        \t"),t("span",{style:{color:"#B392F0"}},"unparkSuccessor"),t("span",{style:{color:"#E1E4E8"}},"(node);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"}")])])]),t("pre",{class:"shiki github-light vp-code-light"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"private"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"void"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"setHeadAndPropagate"),t("span",{style:{color:"#24292E"}},"(Node node, "),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," propagate) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6F42C1"}},"setHead"),t("span",{style:{color:"#24292E"}},"(node);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// 有空闲资源")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (propagate "),t("span",{style:{color:"#D73A49"}},">"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"0"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"&&"),t("span",{style:{color:"#24292E"}}," node.waitStatus "),t("span",{style:{color:"#D73A49"}},"!="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"0"),t("span",{style:{color:"#24292E"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        Node s "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," node.next;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6A737D"}},"// 下一个")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (s "),t("span",{style:{color:"#D73A49"}},"=="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"null"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"||"),t("span",{style:{color:"#24292E"}}," s."),t("span",{style:{color:"#6F42C1"}},"isShared"),t("span",{style:{color:"#24292E"}},"())")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        \t"),t("span",{style:{color:"#6F42C1"}},"unparkSuccessor"),t("span",{style:{color:"#24292E"}},"(node);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"}")])])])],-1),Xe=t("ul",null,[t("li",null,[p("假设存在某次循环中队列里排队的结点情况为 "),t("code",null,"head(-1)->t1(-1)->t2(-1)")]),t("li",null,"假设存在将要信号量释放的 T3 和 T4，释放顺序为先 T3 后 T4")],-1),Ze=t("p",null,[t("strong",null,"正常流程")],-1),$e=t("figure",null,[t("img",{src:"https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230719212512897.png",alt:"image-20230719212512897",loading:"lazy",decoding:"async"})],-1),sc=t("p",null,[t("strong",null,"产生 bug 的情况")],-1),lc=t("figure",null,[t("img",{src:"https://jsd.cdn.zzko.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230719212604635.png",alt:"image-20230719212604635",loading:"lazy",decoding:"async"})],-1),oc=t("p",null,"修复前版本执行流程",-1),nc=t("ol",null,[t("li",null,"T3 调用 releaseShared(1)，直接调用了 unparkSuccessor(head)，head 的等待状态从 -1 变为 0"),t("li",null,"T1 由于 T3 释放信号量被唤醒，调用 tryAcquireShared，假设返回值为 0（获取锁成功，但没有剩余资源量）"),t("li",null,"T4 调用 releaseShared(1)，此时 head.waitStatus 为 0（此时读到的 head 和 1 中为同一个head），不满足 条件，因此不调用 unparkSuccessor(head)"),t("li",null,"T1 获取信号量成功，调用 setHeadAndPropagate 时，因为不满足 propagate > 0（2 的返回值也就是 propagate（剩余资源量） == 0），从而不会唤醒后继结点， T2 线程得不到唤醒")],-1),ac=t("p",null,[t("strong",null,"bug 修复后")],-1),ec=t("div",{class:"language-java"},[t("button",{title:"Copy Code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki github-dark vp-code-dark"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"private"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"void"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"setHeadAndPropagate"),t("span",{style:{color:"#E1E4E8"}},"(Node node, "),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," propagate) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        Node h "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," head; "),t("span",{style:{color:"#6A737D"}},"// Record old head for check below")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#6A737D"}},"// 设置自己为 head")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#B392F0"}},"setHead"),t("span",{style:{color:"#E1E4E8"}},"(node);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#6A737D"}},"// propagate 表示有共享资源（例如共享读锁或信号量）")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#6A737D"}},"// 原 head waitStatus == Node.SIGNAL 或 Node.PROPAGATE")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#6A737D"}},"// 现在 head waitStatus == Node.SIGNAL 或 Node.PROPAGATE")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (propagate "),t("span",{style:{color:"#F97583"}},">"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"0"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"||"),t("span",{style:{color:"#E1E4E8"}}," h "),t("span",{style:{color:"#F97583"}},"=="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"null"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"||"),t("span",{style:{color:"#E1E4E8"}}," h.waitStatus "),t("span",{style:{color:"#F97583"}},"<"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"0"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"||")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            (h "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," head) "),t("span",{style:{color:"#F97583"}},"=="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"null"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"||"),t("span",{style:{color:"#E1E4E8"}}," h.waitStatus "),t("span",{style:{color:"#F97583"}},"<"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"0"),t("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            Node s "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," node.next;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#6A737D"}},"// 如果是最后一个节点或者是等待共享读锁的节点")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (s "),t("span",{style:{color:"#F97583"}},"=="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"null"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"||"),t("span",{style:{color:"#E1E4E8"}}," s."),t("span",{style:{color:"#B392F0"}},"isShared"),t("span",{style:{color:"#E1E4E8"}},"()) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            \t"),t("span",{style:{color:"#B392F0"}},"doReleaseShared"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"private"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"void"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"doReleaseShared"),t("span",{style:{color:"#E1E4E8"}},"() {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#6A737D"}},"// 如果 head.waitStatus == Node.SIGNAL ==> 0 成功, 下一个节点 unpark")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#6A737D"}},"// 如果 head.waitStatus == 0 ==> Node.PROPAGATE")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"for"),t("span",{style:{color:"#E1E4E8"}}," (;;) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            Node h "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," head;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (h "),t("span",{style:{color:"#F97583"}},"!="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"null"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"&&"),t("span",{style:{color:"#E1E4E8"}}," h "),t("span",{style:{color:"#F97583"}},"!="),t("span",{style:{color:"#E1E4E8"}}," tail) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            \t"),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," ws "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," h.waitStatus;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (ws "),t("span",{style:{color:"#F97583"}},"=="),t("span",{style:{color:"#E1E4E8"}}," Node.SIGNAL) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                    "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," ("),t("span",{style:{color:"#F97583"}},"!"),t("span",{style:{color:"#B392F0"}},"compareAndSetWaitStatus"),t("span",{style:{color:"#E1E4E8"}},"(h, Node.SIGNAL, "),t("span",{style:{color:"#79B8FF"}},"0"),t("span",{style:{color:"#E1E4E8"}},"))")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                    \t"),t("span",{style:{color:"#F97583"}},"continue"),t("span",{style:{color:"#E1E4E8"}},"; "),t("span",{style:{color:"#6A737D"}},"// loop to recheck cases")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                    "),t("span",{style:{color:"#B392F0"}},"unparkSuccessor"),t("span",{style:{color:"#E1E4E8"}},"(h);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#F97583"}},"else"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (ws "),t("span",{style:{color:"#F97583"}},"=="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"0"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"&&")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                \t\t"),t("span",{style:{color:"#F97583"}},"!"),t("span",{style:{color:"#B392F0"}},"compareAndSetWaitStatus"),t("span",{style:{color:"#E1E4E8"}},"(h, "),t("span",{style:{color:"#79B8FF"}},"0"),t("span",{style:{color:"#E1E4E8"}},", Node.PROPAGATE))")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                \t"),t("span",{style:{color:"#F97583"}},"continue"),t("span",{style:{color:"#E1E4E8"}},"; "),t("span",{style:{color:"#6A737D"}},"// loop on failed CAS")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (h "),t("span",{style:{color:"#F97583"}},"=="),t("span",{style:{color:"#E1E4E8"}}," head) "),t("span",{style:{color:"#6A737D"}},"// loop if head changed")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            \t"),t("span",{style:{color:"#F97583"}},"break"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    }")])])]),t("pre",{class:"shiki github-light vp-code-light"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"private"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"void"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"setHeadAndPropagate"),t("span",{style:{color:"#24292E"}},"(Node node, "),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," propagate) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        Node h "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," head; "),t("span",{style:{color:"#6A737D"}},"// Record old head for check below")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6A737D"}},"// 设置自己为 head")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6F42C1"}},"setHead"),t("span",{style:{color:"#24292E"}},"(node);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6A737D"}},"// propagate 表示有共享资源（例如共享读锁或信号量）")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6A737D"}},"// 原 head waitStatus == Node.SIGNAL 或 Node.PROPAGATE")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6A737D"}},"// 现在 head waitStatus == Node.SIGNAL 或 Node.PROPAGATE")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (propagate "),t("span",{style:{color:"#D73A49"}},">"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"0"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"||"),t("span",{style:{color:"#24292E"}}," h "),t("span",{style:{color:"#D73A49"}},"=="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"null"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"||"),t("span",{style:{color:"#24292E"}}," h.waitStatus "),t("span",{style:{color:"#D73A49"}},"<"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"0"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"||")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            (h "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," head) "),t("span",{style:{color:"#D73A49"}},"=="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"null"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"||"),t("span",{style:{color:"#24292E"}}," h.waitStatus "),t("span",{style:{color:"#D73A49"}},"<"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"0"),t("span",{style:{color:"#24292E"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            Node s "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," node.next;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#6A737D"}},"// 如果是最后一个节点或者是等待共享读锁的节点")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (s "),t("span",{style:{color:"#D73A49"}},"=="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"null"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"||"),t("span",{style:{color:"#24292E"}}," s."),t("span",{style:{color:"#6F42C1"}},"isShared"),t("span",{style:{color:"#24292E"}},"()) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            \t"),t("span",{style:{color:"#6F42C1"}},"doReleaseShared"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"private"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"void"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"doReleaseShared"),t("span",{style:{color:"#24292E"}},"() {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6A737D"}},"// 如果 head.waitStatus == Node.SIGNAL ==> 0 成功, 下一个节点 unpark")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6A737D"}},"// 如果 head.waitStatus == 0 ==> Node.PROPAGATE")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"for"),t("span",{style:{color:"#24292E"}}," (;;) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            Node h "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," head;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (h "),t("span",{style:{color:"#D73A49"}},"!="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"null"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"&&"),t("span",{style:{color:"#24292E"}}," h "),t("span",{style:{color:"#D73A49"}},"!="),t("span",{style:{color:"#24292E"}}," tail) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            \t"),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," ws "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," h.waitStatus;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (ws "),t("span",{style:{color:"#D73A49"}},"=="),t("span",{style:{color:"#24292E"}}," Node.SIGNAL) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                    "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," ("),t("span",{style:{color:"#D73A49"}},"!"),t("span",{style:{color:"#6F42C1"}},"compareAndSetWaitStatus"),t("span",{style:{color:"#24292E"}},"(h, Node.SIGNAL, "),t("span",{style:{color:"#005CC5"}},"0"),t("span",{style:{color:"#24292E"}},"))")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                    \t"),t("span",{style:{color:"#D73A49"}},"continue"),t("span",{style:{color:"#24292E"}},"; "),t("span",{style:{color:"#6A737D"}},"// loop to recheck cases")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                    "),t("span",{style:{color:"#6F42C1"}},"unparkSuccessor"),t("span",{style:{color:"#24292E"}},"(h);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#D73A49"}},"else"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (ws "),t("span",{style:{color:"#D73A49"}},"=="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"0"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"&&")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                \t\t"),t("span",{style:{color:"#D73A49"}},"!"),t("span",{style:{color:"#6F42C1"}},"compareAndSetWaitStatus"),t("span",{style:{color:"#24292E"}},"(h, "),t("span",{style:{color:"#005CC5"}},"0"),t("span",{style:{color:"#24292E"}},", Node.PROPAGATE))")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                \t"),t("span",{style:{color:"#D73A49"}},"continue"),t("span",{style:{color:"#24292E"}},"; "),t("span",{style:{color:"#6A737D"}},"// loop on failed CAS")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (h "),t("span",{style:{color:"#D73A49"}},"=="),t("span",{style:{color:"#24292E"}}," head) "),t("span",{style:{color:"#6A737D"}},"// loop if head changed")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            \t"),t("span",{style:{color:"#D73A49"}},"break"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    }")])])])],-1),cc=t("figure",null,[t("img",{src:"https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230719213104877.png",alt:"image-20230719213104877",loading:"lazy",decoding:"async"})],-1),tc=t("ol",null,[t("li",null,"T3 调用 releaseShared()，直接调用了 unparkSuccessor(head)，head 的等待状态从 -1 变为 0"),t("li",null,"T1 由于 T3 释放信号量被唤醒，调用 tryAcquireShared，假设返回值为 0（获取锁成功，但没有剩余资源量）"),t("li",null,"T4 调用 releaseShared()，此时 head.waitStatus 为 0（此时读到的 head 和 1 中为同一个 head），调用 doReleaseShared() 将等待状态置为 PROPAGATE（-3）"),t("li",null,"T1 获取信号量成功，调用 setHeadAndPropagate 时，读到 h.waitStatus < 0，从而调用 doReleaseShared() 唤醒 T2")],-1),pc={id:"_5、countdownlatch",tabindex:"-1"},rc=t("p",null,"用来进行线程同步协作，等待所有线程完成倒计时。 其中构造参数用来初始化等待计数值，await() 用来等待计数归零，countDown() 用来让计数减一",-1),Ec=t("div",{class:"language-java"},[t("button",{title:"Copy Code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki github-dark vp-code-dark"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"CountDownLatch latch "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"new"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"CountDownLatch"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#79B8FF"}},"3"),t("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"new"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"Thread"),t("span",{style:{color:"#E1E4E8"}},"(() "),t("span",{style:{color:"#F97583"}},"->"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            log."),t("span",{style:{color:"#B392F0"}},"debug"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#9ECBFF"}},'"begin..."'),t("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#B392F0"}},"sleep"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#79B8FF"}},"1"),t("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            latch."),t("span",{style:{color:"#B392F0"}},"countDown"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            log."),t("span",{style:{color:"#B392F0"}},"debug"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#9ECBFF"}},'"end...{}"'),t("span",{style:{color:"#E1E4E8"}},", latch."),t("span",{style:{color:"#B392F0"}},"getCount"),t("span",{style:{color:"#E1E4E8"}},"());")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        })."),t("span",{style:{color:"#B392F0"}},"start"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"new"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"Thread"),t("span",{style:{color:"#E1E4E8"}},"(() "),t("span",{style:{color:"#F97583"}},"->"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            log."),t("span",{style:{color:"#B392F0"}},"debug"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#9ECBFF"}},'"begin..."'),t("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#B392F0"}},"sleep"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#79B8FF"}},"2"),t("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            latch."),t("span",{style:{color:"#B392F0"}},"countDown"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            log."),t("span",{style:{color:"#B392F0"}},"debug"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#9ECBFF"}},'"end...{}"'),t("span",{style:{color:"#E1E4E8"}},", latch."),t("span",{style:{color:"#B392F0"}},"getCount"),t("span",{style:{color:"#E1E4E8"}},"());")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        })."),t("span",{style:{color:"#B392F0"}},"start"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"new"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"Thread"),t("span",{style:{color:"#E1E4E8"}},"(() "),t("span",{style:{color:"#F97583"}},"->"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            log."),t("span",{style:{color:"#B392F0"}},"debug"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#9ECBFF"}},'"begin..."'),t("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#B392F0"}},"sleep"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#79B8FF"}},"1.5"),t("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            latch."),t("span",{style:{color:"#B392F0"}},"countDown"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            log."),t("span",{style:{color:"#B392F0"}},"debug"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#9ECBFF"}},'"end...{}"'),t("span",{style:{color:"#E1E4E8"}},", latch."),t("span",{style:{color:"#B392F0"}},"getCount"),t("span",{style:{color:"#E1E4E8"}},"());")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        })."),t("span",{style:{color:"#B392F0"}},"start"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        log."),t("span",{style:{color:"#B392F0"}},"debug"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#9ECBFF"}},'"waiting..."'),t("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        latch."),t("span",{style:{color:"#B392F0"}},"await"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        log."),t("span",{style:{color:"#B392F0"}},"debug"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#9ECBFF"}},'"wait end..."'),t("span",{style:{color:"#E1E4E8"}},");")])])]),t("pre",{class:"shiki github-light vp-code-light"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"CountDownLatch latch "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"new"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"CountDownLatch"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#005CC5"}},"3"),t("span",{style:{color:"#24292E"}},");")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"new"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"Thread"),t("span",{style:{color:"#24292E"}},"(() "),t("span",{style:{color:"#D73A49"}},"->"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            log."),t("span",{style:{color:"#6F42C1"}},"debug"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#032F62"}},'"begin..."'),t("span",{style:{color:"#24292E"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#6F42C1"}},"sleep"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#005CC5"}},"1"),t("span",{style:{color:"#24292E"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            latch."),t("span",{style:{color:"#6F42C1"}},"countDown"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            log."),t("span",{style:{color:"#6F42C1"}},"debug"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#032F62"}},'"end...{}"'),t("span",{style:{color:"#24292E"}},", latch."),t("span",{style:{color:"#6F42C1"}},"getCount"),t("span",{style:{color:"#24292E"}},"());")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        })."),t("span",{style:{color:"#6F42C1"}},"start"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"new"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"Thread"),t("span",{style:{color:"#24292E"}},"(() "),t("span",{style:{color:"#D73A49"}},"->"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            log."),t("span",{style:{color:"#6F42C1"}},"debug"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#032F62"}},'"begin..."'),t("span",{style:{color:"#24292E"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#6F42C1"}},"sleep"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#005CC5"}},"2"),t("span",{style:{color:"#24292E"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            latch."),t("span",{style:{color:"#6F42C1"}},"countDown"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            log."),t("span",{style:{color:"#6F42C1"}},"debug"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#032F62"}},'"end...{}"'),t("span",{style:{color:"#24292E"}},", latch."),t("span",{style:{color:"#6F42C1"}},"getCount"),t("span",{style:{color:"#24292E"}},"());")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        })."),t("span",{style:{color:"#6F42C1"}},"start"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"new"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"Thread"),t("span",{style:{color:"#24292E"}},"(() "),t("span",{style:{color:"#D73A49"}},"->"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            log."),t("span",{style:{color:"#6F42C1"}},"debug"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#032F62"}},'"begin..."'),t("span",{style:{color:"#24292E"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#6F42C1"}},"sleep"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#005CC5"}},"1.5"),t("span",{style:{color:"#24292E"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            latch."),t("span",{style:{color:"#6F42C1"}},"countDown"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            log."),t("span",{style:{color:"#6F42C1"}},"debug"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#032F62"}},'"end...{}"'),t("span",{style:{color:"#24292E"}},", latch."),t("span",{style:{color:"#6F42C1"}},"getCount"),t("span",{style:{color:"#24292E"}},"());")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        })."),t("span",{style:{color:"#6F42C1"}},"start"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        log."),t("span",{style:{color:"#6F42C1"}},"debug"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#032F62"}},'"waiting..."'),t("span",{style:{color:"#24292E"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        latch."),t("span",{style:{color:"#6F42C1"}},"await"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        log."),t("span",{style:{color:"#6F42C1"}},"debug"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#032F62"}},'"wait end..."'),t("span",{style:{color:"#24292E"}},");")])])])],-1),yc=t("figure",null,[t("img",{src:"https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230719213903076.png",alt:"image-20230719213903076",loading:"lazy",decoding:"async"})],-1),ic=t("p",null,"可以配合线程池使用，改进如下",-1),Fc=t("div",{class:"language-java"},[t("button",{title:"Copy Code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki github-dark vp-code-dark"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"CountDownLatch latch "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"new"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"CountDownLatch"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#79B8FF"}},"3"),t("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        ExecutorService service "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," Executors."),t("span",{style:{color:"#B392F0"}},"newFixedThreadPool"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#79B8FF"}},"4"),t("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        service."),t("span",{style:{color:"#B392F0"}},"submit"),t("span",{style:{color:"#E1E4E8"}},"(() "),t("span",{style:{color:"#F97583"}},"->"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            log."),t("span",{style:{color:"#B392F0"}},"debug"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#9ECBFF"}},'"begin..."'),t("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#B392F0"}},"sleep"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#79B8FF"}},"1"),t("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            latch."),t("span",{style:{color:"#B392F0"}},"countDown"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            log."),t("span",{style:{color:"#B392F0"}},"debug"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#9ECBFF"}},'"end...{}"'),t("span",{style:{color:"#E1E4E8"}},", latch."),t("span",{style:{color:"#B392F0"}},"getCount"),t("span",{style:{color:"#E1E4E8"}},"());")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        });")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        service."),t("span",{style:{color:"#B392F0"}},"submit"),t("span",{style:{color:"#E1E4E8"}},"(() "),t("span",{style:{color:"#F97583"}},"->"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            log."),t("span",{style:{color:"#B392F0"}},"debug"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#9ECBFF"}},'"begin..."'),t("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#B392F0"}},"sleep"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#79B8FF"}},"1.5"),t("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            latch."),t("span",{style:{color:"#B392F0"}},"countDown"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            log."),t("span",{style:{color:"#B392F0"}},"debug"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#9ECBFF"}},'"end...{}"'),t("span",{style:{color:"#E1E4E8"}},", latch."),t("span",{style:{color:"#B392F0"}},"getCount"),t("span",{style:{color:"#E1E4E8"}},"());")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        });")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        service."),t("span",{style:{color:"#B392F0"}},"submit"),t("span",{style:{color:"#E1E4E8"}},"(() "),t("span",{style:{color:"#F97583"}},"->"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            log."),t("span",{style:{color:"#B392F0"}},"debug"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#9ECBFF"}},'"begin..."'),t("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#B392F0"}},"sleep"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#79B8FF"}},"2"),t("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            latch."),t("span",{style:{color:"#B392F0"}},"countDown"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            log."),t("span",{style:{color:"#B392F0"}},"debug"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#9ECBFF"}},'"end...{}"'),t("span",{style:{color:"#E1E4E8"}},", latch."),t("span",{style:{color:"#B392F0"}},"getCount"),t("span",{style:{color:"#E1E4E8"}},"());")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        });")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        service."),t("span",{style:{color:"#B392F0"}},"submit"),t("span",{style:{color:"#E1E4E8"}},"(()"),t("span",{style:{color:"#F97583"}},"->"),t("span",{style:{color:"#E1E4E8"}},"{")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"try"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                log."),t("span",{style:{color:"#B392F0"}},"debug"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#9ECBFF"}},'"waiting..."'),t("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                latch."),t("span",{style:{color:"#B392F0"}},"await"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                log."),t("span",{style:{color:"#B392F0"}},"debug"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#9ECBFF"}},'"wait end..."'),t("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            } "),t("span",{style:{color:"#F97583"}},"catch"),t("span",{style:{color:"#E1E4E8"}}," (InterruptedException "),t("span",{style:{color:"#FFAB70"}},"e"),t("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                e."),t("span",{style:{color:"#B392F0"}},"printStackTrace"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        });")])])]),t("pre",{class:"shiki github-light vp-code-light"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"CountDownLatch latch "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"new"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"CountDownLatch"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#005CC5"}},"3"),t("span",{style:{color:"#24292E"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        ExecutorService service "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," Executors."),t("span",{style:{color:"#6F42C1"}},"newFixedThreadPool"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#005CC5"}},"4"),t("span",{style:{color:"#24292E"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        service."),t("span",{style:{color:"#6F42C1"}},"submit"),t("span",{style:{color:"#24292E"}},"(() "),t("span",{style:{color:"#D73A49"}},"->"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            log."),t("span",{style:{color:"#6F42C1"}},"debug"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#032F62"}},'"begin..."'),t("span",{style:{color:"#24292E"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#6F42C1"}},"sleep"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#005CC5"}},"1"),t("span",{style:{color:"#24292E"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            latch."),t("span",{style:{color:"#6F42C1"}},"countDown"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            log."),t("span",{style:{color:"#6F42C1"}},"debug"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#032F62"}},'"end...{}"'),t("span",{style:{color:"#24292E"}},", latch."),t("span",{style:{color:"#6F42C1"}},"getCount"),t("span",{style:{color:"#24292E"}},"());")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        });")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        service."),t("span",{style:{color:"#6F42C1"}},"submit"),t("span",{style:{color:"#24292E"}},"(() "),t("span",{style:{color:"#D73A49"}},"->"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            log."),t("span",{style:{color:"#6F42C1"}},"debug"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#032F62"}},'"begin..."'),t("span",{style:{color:"#24292E"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#6F42C1"}},"sleep"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#005CC5"}},"1.5"),t("span",{style:{color:"#24292E"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            latch."),t("span",{style:{color:"#6F42C1"}},"countDown"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            log."),t("span",{style:{color:"#6F42C1"}},"debug"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#032F62"}},'"end...{}"'),t("span",{style:{color:"#24292E"}},", latch."),t("span",{style:{color:"#6F42C1"}},"getCount"),t("span",{style:{color:"#24292E"}},"());")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        });")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        service."),t("span",{style:{color:"#6F42C1"}},"submit"),t("span",{style:{color:"#24292E"}},"(() "),t("span",{style:{color:"#D73A49"}},"->"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            log."),t("span",{style:{color:"#6F42C1"}},"debug"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#032F62"}},'"begin..."'),t("span",{style:{color:"#24292E"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#6F42C1"}},"sleep"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#005CC5"}},"2"),t("span",{style:{color:"#24292E"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            latch."),t("span",{style:{color:"#6F42C1"}},"countDown"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            log."),t("span",{style:{color:"#6F42C1"}},"debug"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#032F62"}},'"end...{}"'),t("span",{style:{color:"#24292E"}},", latch."),t("span",{style:{color:"#6F42C1"}},"getCount"),t("span",{style:{color:"#24292E"}},"());")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        });")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        service."),t("span",{style:{color:"#6F42C1"}},"submit"),t("span",{style:{color:"#24292E"}},"(()"),t("span",{style:{color:"#D73A49"}},"->"),t("span",{style:{color:"#24292E"}},"{")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"try"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                log."),t("span",{style:{color:"#6F42C1"}},"debug"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#032F62"}},'"waiting..."'),t("span",{style:{color:"#24292E"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                latch."),t("span",{style:{color:"#6F42C1"}},"await"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                log."),t("span",{style:{color:"#6F42C1"}},"debug"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#032F62"}},'"wait end..."'),t("span",{style:{color:"#24292E"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            } "),t("span",{style:{color:"#D73A49"}},"catch"),t("span",{style:{color:"#24292E"}}," (InterruptedException "),t("span",{style:{color:"#E36209"}},"e"),t("span",{style:{color:"#24292E"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                e."),t("span",{style:{color:"#6F42C1"}},"printStackTrace"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        });")])])])],-1),uc=t("figure",null,[t("img",{src:"https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230719214200332.png",alt:"image-20230719214200332",loading:"lazy",decoding:"async"})],-1),Ac={id:"应用之同步等待多线程准备完毕",tabindex:"-1"},dc=t("div",{class:"language-java"},[t("button",{title:"Copy Code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki github-dark vp-code-dark"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"AtomicInteger num "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"new"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"AtomicInteger"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#79B8FF"}},"0"),t("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        ExecutorService service "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," Executors."),t("span",{style:{color:"#B392F0"}},"newFixedThreadPool"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#79B8FF"}},"10"),t("span",{style:{color:"#E1E4E8"}},", (r) "),t("span",{style:{color:"#F97583"}},"->"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"return"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"new"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"Thread"),t("span",{style:{color:"#E1E4E8"}},"(r, "),t("span",{style:{color:"#9ECBFF"}},'"t"'),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"+"),t("span",{style:{color:"#E1E4E8"}}," num."),t("span",{style:{color:"#B392F0"}},"getAndIncrement"),t("span",{style:{color:"#E1E4E8"}},"());")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        });")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        CountDownLatch latch "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"new"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"CountDownLatch"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#79B8FF"}},"10"),t("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"String"),t("span",{style:{color:"#E1E4E8"}},"[] all "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"new"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"String"),t("span",{style:{color:"#E1E4E8"}},"["),t("span",{style:{color:"#79B8FF"}},"10"),t("span",{style:{color:"#E1E4E8"}},"];")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        Random r "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"new"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"Random"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"for"),t("span",{style:{color:"#E1E4E8"}}," ("),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," j "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"0"),t("span",{style:{color:"#E1E4E8"}},"; j "),t("span",{style:{color:"#F97583"}},"<"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"10"),t("span",{style:{color:"#E1E4E8"}},"; j"),t("span",{style:{color:"#F97583"}},"++"),t("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," x "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," j;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            service."),t("span",{style:{color:"#B392F0"}},"submit"),t("span",{style:{color:"#E1E4E8"}},"(() "),t("span",{style:{color:"#F97583"}},"->"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#F97583"}},"for"),t("span",{style:{color:"#E1E4E8"}}," ("),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," i "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"0"),t("span",{style:{color:"#E1E4E8"}},"; i "),t("span",{style:{color:"#F97583"}},"<="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"100"),t("span",{style:{color:"#E1E4E8"}},"; i"),t("span",{style:{color:"#F97583"}},"++"),t("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                    "),t("span",{style:{color:"#F97583"}},"try"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                        Thread."),t("span",{style:{color:"#B392F0"}},"sleep"),t("span",{style:{color:"#E1E4E8"}},"(r."),t("span",{style:{color:"#B392F0"}},"nextInt"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#79B8FF"}},"100"),t("span",{style:{color:"#E1E4E8"}},"));")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                    } "),t("span",{style:{color:"#F97583"}},"catch"),t("span",{style:{color:"#E1E4E8"}}," (InterruptedException "),t("span",{style:{color:"#FFAB70"}},"e"),t("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                    all[x] "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," Thread."),t("span",{style:{color:"#B392F0"}},"currentThread"),t("span",{style:{color:"#E1E4E8"}},"()."),t("span",{style:{color:"#B392F0"}},"getName"),t("span",{style:{color:"#E1E4E8"}},"() "),t("span",{style:{color:"#F97583"}},"+"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#9ECBFF"}},'"("'),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"+"),t("span",{style:{color:"#E1E4E8"}}," (i "),t("span",{style:{color:"#F97583"}},"+"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#9ECBFF"}},'"%"'),t("span",{style:{color:"#E1E4E8"}},") "),t("span",{style:{color:"#F97583"}},"+"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#9ECBFF"}},'")"'),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                    System.out."),t("span",{style:{color:"#B392F0"}},"print"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#9ECBFF"}},'"'),t("span",{style:{color:"#79B8FF"}},"\\r"),t("span",{style:{color:"#9ECBFF"}},'"'),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"+"),t("span",{style:{color:"#E1E4E8"}}," Arrays."),t("span",{style:{color:"#B392F0"}},"toString"),t("span",{style:{color:"#E1E4E8"}},"(all));")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                latch."),t("span",{style:{color:"#B392F0"}},"countDown"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            });")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        latch."),t("span",{style:{color:"#B392F0"}},"await"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#6A737D"}},"// \\n回车")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        System.out."),t("span",{style:{color:"#B392F0"}},"println"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#9ECBFF"}},'"'),t("span",{style:{color:"#79B8FF"}},"\\n"),t("span",{style:{color:"#9ECBFF"}},'游戏开始..."'),t("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        service."),t("span",{style:{color:"#B392F0"}},"shutdown"),t("span",{style:{color:"#E1E4E8"}},"();")])])]),t("pre",{class:"shiki github-light vp-code-light"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"AtomicInteger num "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"new"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"AtomicInteger"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#005CC5"}},"0"),t("span",{style:{color:"#24292E"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        ExecutorService service "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," Executors."),t("span",{style:{color:"#6F42C1"}},"newFixedThreadPool"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#005CC5"}},"10"),t("span",{style:{color:"#24292E"}},", (r) "),t("span",{style:{color:"#D73A49"}},"->"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"return"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"new"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"Thread"),t("span",{style:{color:"#24292E"}},"(r, "),t("span",{style:{color:"#032F62"}},'"t"'),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"+"),t("span",{style:{color:"#24292E"}}," num."),t("span",{style:{color:"#6F42C1"}},"getAndIncrement"),t("span",{style:{color:"#24292E"}},"());")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        });")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        CountDownLatch latch "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"new"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"CountDownLatch"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#005CC5"}},"10"),t("span",{style:{color:"#24292E"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"String"),t("span",{style:{color:"#24292E"}},"[] all "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"new"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"String"),t("span",{style:{color:"#24292E"}},"["),t("span",{style:{color:"#005CC5"}},"10"),t("span",{style:{color:"#24292E"}},"];")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        Random r "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"new"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"Random"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"for"),t("span",{style:{color:"#24292E"}}," ("),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," j "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"0"),t("span",{style:{color:"#24292E"}},"; j "),t("span",{style:{color:"#D73A49"}},"<"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"10"),t("span",{style:{color:"#24292E"}},"; j"),t("span",{style:{color:"#D73A49"}},"++"),t("span",{style:{color:"#24292E"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," x "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," j;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            service."),t("span",{style:{color:"#6F42C1"}},"submit"),t("span",{style:{color:"#24292E"}},"(() "),t("span",{style:{color:"#D73A49"}},"->"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#D73A49"}},"for"),t("span",{style:{color:"#24292E"}}," ("),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," i "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"0"),t("span",{style:{color:"#24292E"}},"; i "),t("span",{style:{color:"#D73A49"}},"<="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"100"),t("span",{style:{color:"#24292E"}},"; i"),t("span",{style:{color:"#D73A49"}},"++"),t("span",{style:{color:"#24292E"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                    "),t("span",{style:{color:"#D73A49"}},"try"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                        Thread."),t("span",{style:{color:"#6F42C1"}},"sleep"),t("span",{style:{color:"#24292E"}},"(r."),t("span",{style:{color:"#6F42C1"}},"nextInt"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#005CC5"}},"100"),t("span",{style:{color:"#24292E"}},"));")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                    } "),t("span",{style:{color:"#D73A49"}},"catch"),t("span",{style:{color:"#24292E"}}," (InterruptedException "),t("span",{style:{color:"#E36209"}},"e"),t("span",{style:{color:"#24292E"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                    all[x] "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," Thread."),t("span",{style:{color:"#6F42C1"}},"currentThread"),t("span",{style:{color:"#24292E"}},"()."),t("span",{style:{color:"#6F42C1"}},"getName"),t("span",{style:{color:"#24292E"}},"() "),t("span",{style:{color:"#D73A49"}},"+"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#032F62"}},'"("'),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"+"),t("span",{style:{color:"#24292E"}}," (i "),t("span",{style:{color:"#D73A49"}},"+"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#032F62"}},'"%"'),t("span",{style:{color:"#24292E"}},") "),t("span",{style:{color:"#D73A49"}},"+"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#032F62"}},'")"'),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                    System.out."),t("span",{style:{color:"#6F42C1"}},"print"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#032F62"}},'"'),t("span",{style:{color:"#005CC5"}},"\\r"),t("span",{style:{color:"#032F62"}},'"'),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"+"),t("span",{style:{color:"#24292E"}}," Arrays."),t("span",{style:{color:"#6F42C1"}},"toString"),t("span",{style:{color:"#24292E"}},"(all));")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                latch."),t("span",{style:{color:"#6F42C1"}},"countDown"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            });")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        latch."),t("span",{style:{color:"#6F42C1"}},"await"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6A737D"}},"// \\n回车")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        System.out."),t("span",{style:{color:"#6F42C1"}},"println"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#032F62"}},'"'),t("span",{style:{color:"#005CC5"}},"\\n"),t("span",{style:{color:"#032F62"}},'游戏开始..."'),t("span",{style:{color:"#24292E"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        service."),t("span",{style:{color:"#6F42C1"}},"shutdown"),t("span",{style:{color:"#24292E"}},"();")])])])],-1),Dc=t("figure",null,[t("img",{src:"https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230719215611206.png",alt:"image-20230719215611206",loading:"lazy",decoding:"async"})],-1),Cc={id:"应用之同步等待多个远程调用结束",tabindex:"-1"},hc=t("div",{class:"language-java"},[t("button",{title:"Copy Code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki github-dark vp-code-dark"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"@"),t("span",{style:{color:"#F97583"}},"RestController")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"public"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"class"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"TestCountDownlatchController"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    @"),t("span",{style:{color:"#F97583"}},"GetMapping"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#9ECBFF"}},'"/order/{id}"'),t("span",{style:{color:"#E1E4E8"}},")")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"public"),t("span",{style:{color:"#E1E4E8"}}," Map<"),t("span",{style:{color:"#F97583"}},"String"),t("span",{style:{color:"#E1E4E8"}},", "),t("span",{style:{color:"#F97583"}},"Object"),t("span",{style:{color:"#E1E4E8"}},"> "),t("span",{style:{color:"#B392F0"}},"order"),t("span",{style:{color:"#E1E4E8"}},"(@"),t("span",{style:{color:"#F97583"}},"PathVariable"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#FFAB70"}},"id"),t("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        HashMap<"),t("span",{style:{color:"#F97583"}},"String"),t("span",{style:{color:"#E1E4E8"}},", "),t("span",{style:{color:"#F97583"}},"Object"),t("span",{style:{color:"#E1E4E8"}},"> map "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"new"),t("span",{style:{color:"#E1E4E8"}}," HashMap<>();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        map."),t("span",{style:{color:"#B392F0"}},"put"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#9ECBFF"}},'"id"'),t("span",{style:{color:"#E1E4E8"}},", id);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        map."),t("span",{style:{color:"#B392F0"}},"put"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#9ECBFF"}},'"total"'),t("span",{style:{color:"#E1E4E8"}},", "),t("span",{style:{color:"#9ECBFF"}},'"2300.00"'),t("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#B392F0"}},"sleep"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#79B8FF"}},"2000"),t("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"return"),t("span",{style:{color:"#E1E4E8"}}," map;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    @"),t("span",{style:{color:"#F97583"}},"GetMapping"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#9ECBFF"}},'"/product/{id}"'),t("span",{style:{color:"#E1E4E8"}},")")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"public"),t("span",{style:{color:"#E1E4E8"}}," Map<"),t("span",{style:{color:"#F97583"}},"String"),t("span",{style:{color:"#E1E4E8"}},", "),t("span",{style:{color:"#F97583"}},"Object"),t("span",{style:{color:"#E1E4E8"}},"> "),t("span",{style:{color:"#B392F0"}},"product"),t("span",{style:{color:"#E1E4E8"}},"(@"),t("span",{style:{color:"#F97583"}},"PathVariable"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#FFAB70"}},"id"),t("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        HashMap<"),t("span",{style:{color:"#F97583"}},"String"),t("span",{style:{color:"#E1E4E8"}},", "),t("span",{style:{color:"#F97583"}},"Object"),t("span",{style:{color:"#E1E4E8"}},"> map "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"new"),t("span",{style:{color:"#E1E4E8"}}," HashMap<>();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (id "),t("span",{style:{color:"#F97583"}},"=="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"1"),t("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            map."),t("span",{style:{color:"#B392F0"}},"put"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#9ECBFF"}},'"name"'),t("span",{style:{color:"#E1E4E8"}},", "),t("span",{style:{color:"#9ECBFF"}},'"小爱音箱"'),t("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            map."),t("span",{style:{color:"#B392F0"}},"put"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#9ECBFF"}},'"price"'),t("span",{style:{color:"#E1E4E8"}},", "),t("span",{style:{color:"#79B8FF"}},"300"),t("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        } "),t("span",{style:{color:"#F97583"}},"else"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (id "),t("span",{style:{color:"#F97583"}},"=="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"2"),t("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            map."),t("span",{style:{color:"#B392F0"}},"put"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#9ECBFF"}},'"name"'),t("span",{style:{color:"#E1E4E8"}},", "),t("span",{style:{color:"#9ECBFF"}},'"小米手机"'),t("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            map."),t("span",{style:{color:"#B392F0"}},"put"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#9ECBFF"}},'"price"'),t("span",{style:{color:"#E1E4E8"}},", "),t("span",{style:{color:"#79B8FF"}},"2000"),t("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        map."),t("span",{style:{color:"#B392F0"}},"put"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#9ECBFF"}},'"id"'),t("span",{style:{color:"#E1E4E8"}},", id);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#B392F0"}},"sleep"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#79B8FF"}},"1000"),t("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"return"),t("span",{style:{color:"#E1E4E8"}}," map;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    @"),t("span",{style:{color:"#F97583"}},"GetMapping"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#9ECBFF"}},'"/logistics/{id}"'),t("span",{style:{color:"#E1E4E8"}},")")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"public"),t("span",{style:{color:"#E1E4E8"}}," Map<"),t("span",{style:{color:"#F97583"}},"String"),t("span",{style:{color:"#E1E4E8"}},", "),t("span",{style:{color:"#F97583"}},"Object"),t("span",{style:{color:"#E1E4E8"}},"> "),t("span",{style:{color:"#B392F0"}},"logistics"),t("span",{style:{color:"#E1E4E8"}},"(@"),t("span",{style:{color:"#F97583"}},"PathVariable"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#FFAB70"}},"id"),t("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        HashMap<"),t("span",{style:{color:"#F97583"}},"String"),t("span",{style:{color:"#E1E4E8"}},", "),t("span",{style:{color:"#F97583"}},"Object"),t("span",{style:{color:"#E1E4E8"}},"> map "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"new"),t("span",{style:{color:"#E1E4E8"}}," HashMap<>();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        map."),t("span",{style:{color:"#B392F0"}},"put"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#9ECBFF"}},'"id"'),t("span",{style:{color:"#E1E4E8"}},", id);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        map."),t("span",{style:{color:"#B392F0"}},"put"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#9ECBFF"}},'"name"'),t("span",{style:{color:"#E1E4E8"}},", "),t("span",{style:{color:"#9ECBFF"}},'"中通快递"'),t("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#B392F0"}},"sleep"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#79B8FF"}},"2500"),t("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"return"),t("span",{style:{color:"#E1E4E8"}}," map;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"private"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"void"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"sleep"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#FFAB70"}},"millis"),t("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"try"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            Thread."),t("span",{style:{color:"#B392F0"}},"sleep"),t("span",{style:{color:"#E1E4E8"}},"(millis);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        } "),t("span",{style:{color:"#F97583"}},"catch"),t("span",{style:{color:"#E1E4E8"}}," (InterruptedException "),t("span",{style:{color:"#FFAB70"}},"e"),t("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            e."),t("span",{style:{color:"#B392F0"}},"printStackTrace"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"}")])])]),t("pre",{class:"shiki github-light vp-code-light"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"@"),t("span",{style:{color:"#D73A49"}},"RestController")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"public"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"class"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"TestCountDownlatchController"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    @"),t("span",{style:{color:"#D73A49"}},"GetMapping"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#032F62"}},'"/order/{id}"'),t("span",{style:{color:"#24292E"}},")")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"public"),t("span",{style:{color:"#24292E"}}," Map<"),t("span",{style:{color:"#D73A49"}},"String"),t("span",{style:{color:"#24292E"}},", "),t("span",{style:{color:"#D73A49"}},"Object"),t("span",{style:{color:"#24292E"}},"> "),t("span",{style:{color:"#6F42C1"}},"order"),t("span",{style:{color:"#24292E"}},"(@"),t("span",{style:{color:"#D73A49"}},"PathVariable"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#E36209"}},"id"),t("span",{style:{color:"#24292E"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        HashMap<"),t("span",{style:{color:"#D73A49"}},"String"),t("span",{style:{color:"#24292E"}},", "),t("span",{style:{color:"#D73A49"}},"Object"),t("span",{style:{color:"#24292E"}},"> map "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"new"),t("span",{style:{color:"#24292E"}}," HashMap<>();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        map."),t("span",{style:{color:"#6F42C1"}},"put"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#032F62"}},'"id"'),t("span",{style:{color:"#24292E"}},", id);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        map."),t("span",{style:{color:"#6F42C1"}},"put"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#032F62"}},'"total"'),t("span",{style:{color:"#24292E"}},", "),t("span",{style:{color:"#032F62"}},'"2300.00"'),t("span",{style:{color:"#24292E"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6F42C1"}},"sleep"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#005CC5"}},"2000"),t("span",{style:{color:"#24292E"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"return"),t("span",{style:{color:"#24292E"}}," map;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    }")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    @"),t("span",{style:{color:"#D73A49"}},"GetMapping"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#032F62"}},'"/product/{id}"'),t("span",{style:{color:"#24292E"}},")")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"public"),t("span",{style:{color:"#24292E"}}," Map<"),t("span",{style:{color:"#D73A49"}},"String"),t("span",{style:{color:"#24292E"}},", "),t("span",{style:{color:"#D73A49"}},"Object"),t("span",{style:{color:"#24292E"}},"> "),t("span",{style:{color:"#6F42C1"}},"product"),t("span",{style:{color:"#24292E"}},"(@"),t("span",{style:{color:"#D73A49"}},"PathVariable"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#E36209"}},"id"),t("span",{style:{color:"#24292E"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        HashMap<"),t("span",{style:{color:"#D73A49"}},"String"),t("span",{style:{color:"#24292E"}},", "),t("span",{style:{color:"#D73A49"}},"Object"),t("span",{style:{color:"#24292E"}},"> map "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"new"),t("span",{style:{color:"#24292E"}}," HashMap<>();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (id "),t("span",{style:{color:"#D73A49"}},"=="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"1"),t("span",{style:{color:"#24292E"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            map."),t("span",{style:{color:"#6F42C1"}},"put"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#032F62"}},'"name"'),t("span",{style:{color:"#24292E"}},", "),t("span",{style:{color:"#032F62"}},'"小爱音箱"'),t("span",{style:{color:"#24292E"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            map."),t("span",{style:{color:"#6F42C1"}},"put"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#032F62"}},'"price"'),t("span",{style:{color:"#24292E"}},", "),t("span",{style:{color:"#005CC5"}},"300"),t("span",{style:{color:"#24292E"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        } "),t("span",{style:{color:"#D73A49"}},"else"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (id "),t("span",{style:{color:"#D73A49"}},"=="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"2"),t("span",{style:{color:"#24292E"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            map."),t("span",{style:{color:"#6F42C1"}},"put"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#032F62"}},'"name"'),t("span",{style:{color:"#24292E"}},", "),t("span",{style:{color:"#032F62"}},'"小米手机"'),t("span",{style:{color:"#24292E"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            map."),t("span",{style:{color:"#6F42C1"}},"put"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#032F62"}},'"price"'),t("span",{style:{color:"#24292E"}},", "),t("span",{style:{color:"#005CC5"}},"2000"),t("span",{style:{color:"#24292E"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        map."),t("span",{style:{color:"#6F42C1"}},"put"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#032F62"}},'"id"'),t("span",{style:{color:"#24292E"}},", id);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6F42C1"}},"sleep"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#005CC5"}},"1000"),t("span",{style:{color:"#24292E"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"return"),t("span",{style:{color:"#24292E"}}," map;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    }")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    @"),t("span",{style:{color:"#D73A49"}},"GetMapping"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#032F62"}},'"/logistics/{id}"'),t("span",{style:{color:"#24292E"}},")")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"public"),t("span",{style:{color:"#24292E"}}," Map<"),t("span",{style:{color:"#D73A49"}},"String"),t("span",{style:{color:"#24292E"}},", "),t("span",{style:{color:"#D73A49"}},"Object"),t("span",{style:{color:"#24292E"}},"> "),t("span",{style:{color:"#6F42C1"}},"logistics"),t("span",{style:{color:"#24292E"}},"(@"),t("span",{style:{color:"#D73A49"}},"PathVariable"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#E36209"}},"id"),t("span",{style:{color:"#24292E"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        HashMap<"),t("span",{style:{color:"#D73A49"}},"String"),t("span",{style:{color:"#24292E"}},", "),t("span",{style:{color:"#D73A49"}},"Object"),t("span",{style:{color:"#24292E"}},"> map "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"new"),t("span",{style:{color:"#24292E"}}," HashMap<>();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        map."),t("span",{style:{color:"#6F42C1"}},"put"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#032F62"}},'"id"'),t("span",{style:{color:"#24292E"}},", id);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        map."),t("span",{style:{color:"#6F42C1"}},"put"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#032F62"}},'"name"'),t("span",{style:{color:"#24292E"}},", "),t("span",{style:{color:"#032F62"}},'"中通快递"'),t("span",{style:{color:"#24292E"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6F42C1"}},"sleep"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#005CC5"}},"2500"),t("span",{style:{color:"#24292E"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"return"),t("span",{style:{color:"#24292E"}}," map;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    }")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"private"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"void"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"sleep"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#E36209"}},"millis"),t("span",{style:{color:"#24292E"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"try"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            Thread."),t("span",{style:{color:"#6F42C1"}},"sleep"),t("span",{style:{color:"#24292E"}},"(millis);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        } "),t("span",{style:{color:"#D73A49"}},"catch"),t("span",{style:{color:"#24292E"}}," (InterruptedException "),t("span",{style:{color:"#E36209"}},"e"),t("span",{style:{color:"#24292E"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            e."),t("span",{style:{color:"#6F42C1"}},"printStackTrace"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"}")])])])],-1),gc=t("p",null,"rest 远程调用",-1),Bc=t("div",{class:"language-java"},[t("button",{title:"Copy Code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki github-dark vp-code-dark"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"RestTemplate restTemplate "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"new"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"RestTemplate"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        log."),t("span",{style:{color:"#B392F0"}},"debug"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#9ECBFF"}},'"begin"'),t("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        ExecutorService service "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," Executors."),t("span",{style:{color:"#B392F0"}},"newCachedThreadPool"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        CountDownLatch latch "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"new"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"CountDownLatch"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#79B8FF"}},"4"),t("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        Future<Map<"),t("span",{style:{color:"#F97583"}},"String"),t("span",{style:{color:"#E1E4E8"}},","),t("span",{style:{color:"#F97583"}},"Object"),t("span",{style:{color:"#E1E4E8"}},">> f1 "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," service."),t("span",{style:{color:"#B392F0"}},"submit"),t("span",{style:{color:"#E1E4E8"}},"(() "),t("span",{style:{color:"#F97583"}},"->"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            Map<"),t("span",{style:{color:"#F97583"}},"String"),t("span",{style:{color:"#E1E4E8"}},", "),t("span",{style:{color:"#F97583"}},"Object"),t("span",{style:{color:"#E1E4E8"}},"> response "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," restTemplate."),t("span",{style:{color:"#B392F0"}},"getForObject"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#9ECBFF"}},'"http://localhost:8080/order/{1}"'),t("span",{style:{color:"#E1E4E8"}},", Map.class, "),t("span",{style:{color:"#79B8FF"}},"1"),t("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"return"),t("span",{style:{color:"#E1E4E8"}}," response;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        });")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        Future<Map<"),t("span",{style:{color:"#F97583"}},"String"),t("span",{style:{color:"#E1E4E8"}},", "),t("span",{style:{color:"#F97583"}},"Object"),t("span",{style:{color:"#E1E4E8"}},">> f2 "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," service."),t("span",{style:{color:"#B392F0"}},"submit"),t("span",{style:{color:"#E1E4E8"}},"(() "),t("span",{style:{color:"#F97583"}},"->"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            Map<"),t("span",{style:{color:"#F97583"}},"String"),t("span",{style:{color:"#E1E4E8"}},", "),t("span",{style:{color:"#F97583"}},"Object"),t("span",{style:{color:"#E1E4E8"}},"> response1 "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," restTemplate."),t("span",{style:{color:"#B392F0"}},"getForObject"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#9ECBFF"}},'"http://localhost:8080/product/{1}"'),t("span",{style:{color:"#E1E4E8"}},", Map.class, "),t("span",{style:{color:"#79B8FF"}},"1"),t("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"return"),t("span",{style:{color:"#E1E4E8"}}," response1;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        });")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        Future<Map<"),t("span",{style:{color:"#F97583"}},"String"),t("span",{style:{color:"#E1E4E8"}},", "),t("span",{style:{color:"#F97583"}},"Object"),t("span",{style:{color:"#E1E4E8"}},">> f3 "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," service."),t("span",{style:{color:"#B392F0"}},"submit"),t("span",{style:{color:"#E1E4E8"}},"(() "),t("span",{style:{color:"#F97583"}},"->"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            Map<"),t("span",{style:{color:"#F97583"}},"String"),t("span",{style:{color:"#E1E4E8"}},", "),t("span",{style:{color:"#F97583"}},"Object"),t("span",{style:{color:"#E1E4E8"}},"> response1 "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," restTemplate."),t("span",{style:{color:"#B392F0"}},"getForObject"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#9ECBFF"}},'"http://localhost:8080/product/{1}"'),t("span",{style:{color:"#E1E4E8"}},", Map.class, "),t("span",{style:{color:"#79B8FF"}},"2"),t("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"return"),t("span",{style:{color:"#E1E4E8"}}," response1;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        });")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        Future<Map<"),t("span",{style:{color:"#F97583"}},"String"),t("span",{style:{color:"#E1E4E8"}},", "),t("span",{style:{color:"#F97583"}},"Object"),t("span",{style:{color:"#E1E4E8"}},">> f4 "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," service."),t("span",{style:{color:"#B392F0"}},"submit"),t("span",{style:{color:"#E1E4E8"}},"(() "),t("span",{style:{color:"#F97583"}},"->"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            Map<"),t("span",{style:{color:"#F97583"}},"String"),t("span",{style:{color:"#E1E4E8"}},", "),t("span",{style:{color:"#F97583"}},"Object"),t("span",{style:{color:"#E1E4E8"}},"> response3 "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," restTemplate."),t("span",{style:{color:"#B392F0"}},"getForObject"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#9ECBFF"}},'"http://localhost:8080/logistics/{1}"'),t("span",{style:{color:"#E1E4E8"}},", Map.class, "),t("span",{style:{color:"#79B8FF"}},"1"),t("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"return"),t("span",{style:{color:"#E1E4E8"}}," response3;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        });")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        System.out."),t("span",{style:{color:"#B392F0"}},"println"),t("span",{style:{color:"#E1E4E8"}},"(f1."),t("span",{style:{color:"#B392F0"}},"get"),t("span",{style:{color:"#E1E4E8"}},"());")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        System.out."),t("span",{style:{color:"#B392F0"}},"println"),t("span",{style:{color:"#E1E4E8"}},"(f2."),t("span",{style:{color:"#B392F0"}},"get"),t("span",{style:{color:"#E1E4E8"}},"());")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        System.out."),t("span",{style:{color:"#B392F0"}},"println"),t("span",{style:{color:"#E1E4E8"}},"(f3."),t("span",{style:{color:"#B392F0"}},"get"),t("span",{style:{color:"#E1E4E8"}},"());")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        System.out."),t("span",{style:{color:"#B392F0"}},"println"),t("span",{style:{color:"#E1E4E8"}},"(f4."),t("span",{style:{color:"#B392F0"}},"get"),t("span",{style:{color:"#E1E4E8"}},"());")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        log."),t("span",{style:{color:"#B392F0"}},"debug"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#9ECBFF"}},'"执行完毕"'),t("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        service."),t("span",{style:{color:"#B392F0"}},"shutdown"),t("span",{style:{color:"#E1E4E8"}},"();")])])]),t("pre",{class:"shiki github-light vp-code-light"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"RestTemplate restTemplate "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"new"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"RestTemplate"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        log."),t("span",{style:{color:"#6F42C1"}},"debug"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#032F62"}},'"begin"'),t("span",{style:{color:"#24292E"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        ExecutorService service "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," Executors."),t("span",{style:{color:"#6F42C1"}},"newCachedThreadPool"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        CountDownLatch latch "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"new"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"CountDownLatch"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#005CC5"}},"4"),t("span",{style:{color:"#24292E"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        Future<Map<"),t("span",{style:{color:"#D73A49"}},"String"),t("span",{style:{color:"#24292E"}},","),t("span",{style:{color:"#D73A49"}},"Object"),t("span",{style:{color:"#24292E"}},">> f1 "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," service."),t("span",{style:{color:"#6F42C1"}},"submit"),t("span",{style:{color:"#24292E"}},"(() "),t("span",{style:{color:"#D73A49"}},"->"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            Map<"),t("span",{style:{color:"#D73A49"}},"String"),t("span",{style:{color:"#24292E"}},", "),t("span",{style:{color:"#D73A49"}},"Object"),t("span",{style:{color:"#24292E"}},"> response "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," restTemplate."),t("span",{style:{color:"#6F42C1"}},"getForObject"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#032F62"}},'"http://localhost:8080/order/{1}"'),t("span",{style:{color:"#24292E"}},", Map.class, "),t("span",{style:{color:"#005CC5"}},"1"),t("span",{style:{color:"#24292E"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"return"),t("span",{style:{color:"#24292E"}}," response;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        });")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        Future<Map<"),t("span",{style:{color:"#D73A49"}},"String"),t("span",{style:{color:"#24292E"}},", "),t("span",{style:{color:"#D73A49"}},"Object"),t("span",{style:{color:"#24292E"}},">> f2 "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," service."),t("span",{style:{color:"#6F42C1"}},"submit"),t("span",{style:{color:"#24292E"}},"(() "),t("span",{style:{color:"#D73A49"}},"->"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            Map<"),t("span",{style:{color:"#D73A49"}},"String"),t("span",{style:{color:"#24292E"}},", "),t("span",{style:{color:"#D73A49"}},"Object"),t("span",{style:{color:"#24292E"}},"> response1 "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," restTemplate."),t("span",{style:{color:"#6F42C1"}},"getForObject"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#032F62"}},'"http://localhost:8080/product/{1}"'),t("span",{style:{color:"#24292E"}},", Map.class, "),t("span",{style:{color:"#005CC5"}},"1"),t("span",{style:{color:"#24292E"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"return"),t("span",{style:{color:"#24292E"}}," response1;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        });")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        Future<Map<"),t("span",{style:{color:"#D73A49"}},"String"),t("span",{style:{color:"#24292E"}},", "),t("span",{style:{color:"#D73A49"}},"Object"),t("span",{style:{color:"#24292E"}},">> f3 "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," service."),t("span",{style:{color:"#6F42C1"}},"submit"),t("span",{style:{color:"#24292E"}},"(() "),t("span",{style:{color:"#D73A49"}},"->"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            Map<"),t("span",{style:{color:"#D73A49"}},"String"),t("span",{style:{color:"#24292E"}},", "),t("span",{style:{color:"#D73A49"}},"Object"),t("span",{style:{color:"#24292E"}},"> response1 "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," restTemplate."),t("span",{style:{color:"#6F42C1"}},"getForObject"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#032F62"}},'"http://localhost:8080/product/{1}"'),t("span",{style:{color:"#24292E"}},", Map.class, "),t("span",{style:{color:"#005CC5"}},"2"),t("span",{style:{color:"#24292E"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"return"),t("span",{style:{color:"#24292E"}}," response1;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        });")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        Future<Map<"),t("span",{style:{color:"#D73A49"}},"String"),t("span",{style:{color:"#24292E"}},", "),t("span",{style:{color:"#D73A49"}},"Object"),t("span",{style:{color:"#24292E"}},">> f4 "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," service."),t("span",{style:{color:"#6F42C1"}},"submit"),t("span",{style:{color:"#24292E"}},"(() "),t("span",{style:{color:"#D73A49"}},"->"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            Map<"),t("span",{style:{color:"#D73A49"}},"String"),t("span",{style:{color:"#24292E"}},", "),t("span",{style:{color:"#D73A49"}},"Object"),t("span",{style:{color:"#24292E"}},"> response3 "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," restTemplate."),t("span",{style:{color:"#6F42C1"}},"getForObject"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#032F62"}},'"http://localhost:8080/logistics/{1}"'),t("span",{style:{color:"#24292E"}},", Map.class, "),t("span",{style:{color:"#005CC5"}},"1"),t("span",{style:{color:"#24292E"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"return"),t("span",{style:{color:"#24292E"}}," response3;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        });")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        System.out."),t("span",{style:{color:"#6F42C1"}},"println"),t("span",{style:{color:"#24292E"}},"(f1."),t("span",{style:{color:"#6F42C1"}},"get"),t("span",{style:{color:"#24292E"}},"());")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        System.out."),t("span",{style:{color:"#6F42C1"}},"println"),t("span",{style:{color:"#24292E"}},"(f2."),t("span",{style:{color:"#6F42C1"}},"get"),t("span",{style:{color:"#24292E"}},"());")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        System.out."),t("span",{style:{color:"#6F42C1"}},"println"),t("span",{style:{color:"#24292E"}},"(f3."),t("span",{style:{color:"#6F42C1"}},"get"),t("span",{style:{color:"#24292E"}},"());")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        System.out."),t("span",{style:{color:"#6F42C1"}},"println"),t("span",{style:{color:"#24292E"}},"(f4."),t("span",{style:{color:"#6F42C1"}},"get"),t("span",{style:{color:"#24292E"}},"());")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        log."),t("span",{style:{color:"#6F42C1"}},"debug"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#032F62"}},'"执行完毕"'),t("span",{style:{color:"#24292E"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        service."),t("span",{style:{color:"#6F42C1"}},"shutdown"),t("span",{style:{color:"#24292E"}},"();")])])])],-1),fc=t("blockquote",null,[t("p",null,"CountDownLatch允许 count 个线程阻塞在一个地方，直至所有线程的任务都执行完毕。在 Java 并发中，countdownlatch 的概念是一个常见的面试题，所以一定要确保你很好的理解了它。"),t("p",null,[p("CountDownLatch是共享锁的一种实现,它默认构造 AQS 的 state 值为 count。当线程使用countDown方法时,其实使用了"),t("code",null,"tryReleaseShared"),p("方法以CAS的操作来减少state,直至state为0就代表所有的线程都调用了countDown方法。当调用await方法的时候，如果state不为0，就代表仍然有线程没有调用countDown方法，那么就把已经调用过countDown的线程都放入阻塞队列Park,并自旋CAS判断state == 0，直至最后一个线程调用了countDown，使得state == 0，于是阻塞的线程便判断成功，全部往下执行。")]),t("p",null,"用来进行线程同步协作，等待所有线程完成倒计时。 其中构造参数用来初始化等待计数值，await() 用来等待计数归零，countDown() 用来让计数减一")],-1),kc={id:"_6、cyclicbarrier",tabindex:"-1"},bc=t("p",null,[p("CyclicBarri"),t("code",null,"[ˈsaɪklɪk ˈbæriɚ]"),p(" 循环栅栏，用来进行线程协作，等待线程满足某个计数。构造时设置『计数个数』，每个线程执行到某个需要“同步”的时刻调用 await() 方法进行等待，当等待的线程数满足『计数个数』时，继续执行。跟CountdownLatch一样，但这个可以重用")],-1),mc=t("div",{class:"language-java"},[t("button",{title:"Copy Code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki github-dark vp-code-dark"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"CyclicBarrier cb "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"new"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"CyclicBarrier"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#79B8FF"}},"2"),t("span",{style:{color:"#E1E4E8"}},"); "),t("span",{style:{color:"#6A737D"}},"// 个数为2时才会继续执行")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"for"),t("span",{style:{color:"#E1E4E8"}}," ("),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," i"),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#79B8FF"}},"0"),t("span",{style:{color:"#E1E4E8"}},";i"),t("span",{style:{color:"#F97583"}},"<"),t("span",{style:{color:"#79B8FF"}},"3"),t("span",{style:{color:"#E1E4E8"}},";i"),t("span",{style:{color:"#F97583"}},"++"),t("span",{style:{color:"#E1E4E8"}},"){")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"new"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"Thread"),t("span",{style:{color:"#E1E4E8"}},"(()"),t("span",{style:{color:"#F97583"}},"->"),t("span",{style:{color:"#E1E4E8"}},"{")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                System.out."),t("span",{style:{color:"#B392F0"}},"println"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#9ECBFF"}},'"线程1开始.."'),t("span",{style:{color:"#F97583"}},"+new"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"Date"),t("span",{style:{color:"#E1E4E8"}},"());")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#F97583"}},"try"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                    cb."),t("span",{style:{color:"#B392F0"}},"await"),t("span",{style:{color:"#E1E4E8"}},"(); "),t("span",{style:{color:"#6A737D"}},"// 当个数不足时，等待")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                } "),t("span",{style:{color:"#F97583"}},"catch"),t("span",{style:{color:"#E1E4E8"}}," (InterruptedException | BrokenBarrierException "),t("span",{style:{color:"#FFAB70"}},"e"),t("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                    e."),t("span",{style:{color:"#B392F0"}},"printStackTrace"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                System.out."),t("span",{style:{color:"#B392F0"}},"println"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#9ECBFF"}},'"线程1继续向下运行..."'),t("span",{style:{color:"#F97583"}},"+new"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"Date"),t("span",{style:{color:"#E1E4E8"}},"());")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            })."),t("span",{style:{color:"#B392F0"}},"start"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"new"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"Thread"),t("span",{style:{color:"#E1E4E8"}},"(()"),t("span",{style:{color:"#F97583"}},"->"),t("span",{style:{color:"#E1E4E8"}},"{")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                System.out."),t("span",{style:{color:"#B392F0"}},"println"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#9ECBFF"}},'"线程2开始.."'),t("span",{style:{color:"#F97583"}},"+new"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"Date"),t("span",{style:{color:"#E1E4E8"}},"());")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#F97583"}},"try"),t("span",{style:{color:"#E1E4E8"}}," { Thread."),t("span",{style:{color:"#B392F0"}},"sleep"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#79B8FF"}},"2000"),t("span",{style:{color:"#E1E4E8"}},"); } "),t("span",{style:{color:"#F97583"}},"catch"),t("span",{style:{color:"#E1E4E8"}}," (InterruptedException "),t("span",{style:{color:"#FFAB70"}},"e"),t("span",{style:{color:"#E1E4E8"}},") { }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#F97583"}},"try"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                    cb."),t("span",{style:{color:"#B392F0"}},"await"),t("span",{style:{color:"#E1E4E8"}},"(); "),t("span",{style:{color:"#6A737D"}},"// 2 秒后，线程个数够2，继续运行")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                } "),t("span",{style:{color:"#F97583"}},"catch"),t("span",{style:{color:"#E1E4E8"}}," (InterruptedException | BrokenBarrierException "),t("span",{style:{color:"#FFAB70"}},"e"),t("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                    e."),t("span",{style:{color:"#B392F0"}},"printStackTrace"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                System.out."),t("span",{style:{color:"#B392F0"}},"println"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#9ECBFF"}},'"线程2继续向下运行..."'),t("span",{style:{color:"#F97583"}},"+new"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"Date"),t("span",{style:{color:"#E1E4E8"}},"());")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            })."),t("span",{style:{color:"#B392F0"}},"start"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        }")])])]),t("pre",{class:"shiki github-light vp-code-light"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"CyclicBarrier cb "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"new"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"CyclicBarrier"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#005CC5"}},"2"),t("span",{style:{color:"#24292E"}},"); "),t("span",{style:{color:"#6A737D"}},"// 个数为2时才会继续执行")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"for"),t("span",{style:{color:"#24292E"}}," ("),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," i"),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#005CC5"}},"0"),t("span",{style:{color:"#24292E"}},";i"),t("span",{style:{color:"#D73A49"}},"<"),t("span",{style:{color:"#005CC5"}},"3"),t("span",{style:{color:"#24292E"}},";i"),t("span",{style:{color:"#D73A49"}},"++"),t("span",{style:{color:"#24292E"}},"){")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"new"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"Thread"),t("span",{style:{color:"#24292E"}},"(()"),t("span",{style:{color:"#D73A49"}},"->"),t("span",{style:{color:"#24292E"}},"{")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                System.out."),t("span",{style:{color:"#6F42C1"}},"println"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#032F62"}},'"线程1开始.."'),t("span",{style:{color:"#D73A49"}},"+new"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"Date"),t("span",{style:{color:"#24292E"}},"());")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#D73A49"}},"try"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                    cb."),t("span",{style:{color:"#6F42C1"}},"await"),t("span",{style:{color:"#24292E"}},"(); "),t("span",{style:{color:"#6A737D"}},"// 当个数不足时，等待")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                } "),t("span",{style:{color:"#D73A49"}},"catch"),t("span",{style:{color:"#24292E"}}," (InterruptedException | BrokenBarrierException "),t("span",{style:{color:"#E36209"}},"e"),t("span",{style:{color:"#24292E"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                    e."),t("span",{style:{color:"#6F42C1"}},"printStackTrace"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                System.out."),t("span",{style:{color:"#6F42C1"}},"println"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#032F62"}},'"线程1继续向下运行..."'),t("span",{style:{color:"#D73A49"}},"+new"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"Date"),t("span",{style:{color:"#24292E"}},"());")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            })."),t("span",{style:{color:"#6F42C1"}},"start"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"new"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"Thread"),t("span",{style:{color:"#24292E"}},"(()"),t("span",{style:{color:"#D73A49"}},"->"),t("span",{style:{color:"#24292E"}},"{")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                System.out."),t("span",{style:{color:"#6F42C1"}},"println"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#032F62"}},'"线程2开始.."'),t("span",{style:{color:"#D73A49"}},"+new"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"Date"),t("span",{style:{color:"#24292E"}},"());")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#D73A49"}},"try"),t("span",{style:{color:"#24292E"}}," { Thread."),t("span",{style:{color:"#6F42C1"}},"sleep"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#005CC5"}},"2000"),t("span",{style:{color:"#24292E"}},"); } "),t("span",{style:{color:"#D73A49"}},"catch"),t("span",{style:{color:"#24292E"}}," (InterruptedException "),t("span",{style:{color:"#E36209"}},"e"),t("span",{style:{color:"#24292E"}},") { }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#D73A49"}},"try"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                    cb."),t("span",{style:{color:"#6F42C1"}},"await"),t("span",{style:{color:"#24292E"}},"(); "),t("span",{style:{color:"#6A737D"}},"// 2 秒后，线程个数够2，继续运行")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                } "),t("span",{style:{color:"#D73A49"}},"catch"),t("span",{style:{color:"#24292E"}}," (InterruptedException | BrokenBarrierException "),t("span",{style:{color:"#E36209"}},"e"),t("span",{style:{color:"#24292E"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                    e."),t("span",{style:{color:"#6F42C1"}},"printStackTrace"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                System.out."),t("span",{style:{color:"#6F42C1"}},"println"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#032F62"}},'"线程2继续向下运行..."'),t("span",{style:{color:"#D73A49"}},"+new"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"Date"),t("span",{style:{color:"#24292E"}},"());")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            })."),t("span",{style:{color:"#6F42C1"}},"start"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        }")])])])],-1),Sc=t("p",null,[t("strong",null,"使用"),p("（线程数需与计数一样，否则结果会有偏差）")],-1),vc=t("div",{class:"language-java"},[t("button",{title:"Copy Code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki github-dark vp-code-dark"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"ExecutorService service "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," Executors."),t("span",{style:{color:"#B392F0"}},"newFixedThreadPool"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#79B8FF"}},"3"),t("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        CyclicBarrier barrier "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"new"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"CyclicBarrier"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#79B8FF"}},"2"),t("span",{style:{color:"#E1E4E8"}},", ()"),t("span",{style:{color:"#F97583"}},"->"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#6A737D"}},"//\t\t\t3个线程其实是2个任务1完成的计数减0，并不是任务1和任务2")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            log."),t("span",{style:{color:"#B392F0"}},"debug"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#9ECBFF"}},'"task1, task2 finish..."'),t("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        });")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"for"),t("span",{style:{color:"#E1E4E8"}}," ("),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," i "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"0"),t("span",{style:{color:"#E1E4E8"}},"; i "),t("span",{style:{color:"#F97583"}},"<"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"3"),t("span",{style:{color:"#E1E4E8"}},"; i"),t("span",{style:{color:"#F97583"}},"++"),t("span",{style:{color:"#E1E4E8"}},") { "),t("span",{style:{color:"#6A737D"}},"// task1(1s)  task2(2s)  task1(1s)")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            service."),t("span",{style:{color:"#B392F0"}},"submit"),t("span",{style:{color:"#E1E4E8"}},"(() "),t("span",{style:{color:"#F97583"}},"->"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                log."),t("span",{style:{color:"#B392F0"}},"debug"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#9ECBFF"}},'"task1 begin..."'),t("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#B392F0"}},"sleep"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#79B8FF"}},"1"),t("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#F97583"}},"try"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                    barrier."),t("span",{style:{color:"#B392F0"}},"await"),t("span",{style:{color:"#E1E4E8"}},"(); "),t("span",{style:{color:"#6A737D"}},"// 2-1=1")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                } "),t("span",{style:{color:"#F97583"}},"catch"),t("span",{style:{color:"#E1E4E8"}}," (InterruptedException | BrokenBarrierException "),t("span",{style:{color:"#FFAB70"}},"e"),t("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                    e."),t("span",{style:{color:"#B392F0"}},"printStackTrace"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            });")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            service."),t("span",{style:{color:"#B392F0"}},"submit"),t("span",{style:{color:"#E1E4E8"}},"(() "),t("span",{style:{color:"#F97583"}},"->"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                log."),t("span",{style:{color:"#B392F0"}},"debug"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#9ECBFF"}},'"task2 begin..."'),t("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#B392F0"}},"sleep"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#79B8FF"}},"2"),t("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#F97583"}},"try"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                    barrier."),t("span",{style:{color:"#B392F0"}},"await"),t("span",{style:{color:"#E1E4E8"}},"(); "),t("span",{style:{color:"#6A737D"}},"// 1-1=0")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                } "),t("span",{style:{color:"#F97583"}},"catch"),t("span",{style:{color:"#E1E4E8"}}," (InterruptedException | BrokenBarrierException "),t("span",{style:{color:"#FFAB70"}},"e"),t("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                    e."),t("span",{style:{color:"#B392F0"}},"printStackTrace"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            });")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        service."),t("span",{style:{color:"#B392F0"}},"shutdown"),t("span",{style:{color:"#E1E4E8"}},"();")])])]),t("pre",{class:"shiki github-light vp-code-light"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"ExecutorService service "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," Executors."),t("span",{style:{color:"#6F42C1"}},"newFixedThreadPool"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#005CC5"}},"3"),t("span",{style:{color:"#24292E"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        CyclicBarrier barrier "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"new"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"CyclicBarrier"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#005CC5"}},"2"),t("span",{style:{color:"#24292E"}},", ()"),t("span",{style:{color:"#D73A49"}},"->"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#6A737D"}},"//\t\t\t3个线程其实是2个任务1完成的计数减0，并不是任务1和任务2")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            log."),t("span",{style:{color:"#6F42C1"}},"debug"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#032F62"}},'"task1, task2 finish..."'),t("span",{style:{color:"#24292E"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        });")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"for"),t("span",{style:{color:"#24292E"}}," ("),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," i "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"0"),t("span",{style:{color:"#24292E"}},"; i "),t("span",{style:{color:"#D73A49"}},"<"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"3"),t("span",{style:{color:"#24292E"}},"; i"),t("span",{style:{color:"#D73A49"}},"++"),t("span",{style:{color:"#24292E"}},") { "),t("span",{style:{color:"#6A737D"}},"// task1(1s)  task2(2s)  task1(1s)")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            service."),t("span",{style:{color:"#6F42C1"}},"submit"),t("span",{style:{color:"#24292E"}},"(() "),t("span",{style:{color:"#D73A49"}},"->"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                log."),t("span",{style:{color:"#6F42C1"}},"debug"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#032F62"}},'"task1 begin..."'),t("span",{style:{color:"#24292E"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#6F42C1"}},"sleep"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#005CC5"}},"1"),t("span",{style:{color:"#24292E"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#D73A49"}},"try"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                    barrier."),t("span",{style:{color:"#6F42C1"}},"await"),t("span",{style:{color:"#24292E"}},"(); "),t("span",{style:{color:"#6A737D"}},"// 2-1=1")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                } "),t("span",{style:{color:"#D73A49"}},"catch"),t("span",{style:{color:"#24292E"}}," (InterruptedException | BrokenBarrierException "),t("span",{style:{color:"#E36209"}},"e"),t("span",{style:{color:"#24292E"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                    e."),t("span",{style:{color:"#6F42C1"}},"printStackTrace"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            });")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            service."),t("span",{style:{color:"#6F42C1"}},"submit"),t("span",{style:{color:"#24292E"}},"(() "),t("span",{style:{color:"#D73A49"}},"->"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                log."),t("span",{style:{color:"#6F42C1"}},"debug"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#032F62"}},'"task2 begin..."'),t("span",{style:{color:"#24292E"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#6F42C1"}},"sleep"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#005CC5"}},"2"),t("span",{style:{color:"#24292E"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#D73A49"}},"try"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                    barrier."),t("span",{style:{color:"#6F42C1"}},"await"),t("span",{style:{color:"#24292E"}},"(); "),t("span",{style:{color:"#6A737D"}},"// 1-1=0")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                } "),t("span",{style:{color:"#D73A49"}},"catch"),t("span",{style:{color:"#24292E"}}," (InterruptedException | BrokenBarrierException "),t("span",{style:{color:"#E36209"}},"e"),t("span",{style:{color:"#24292E"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                    e."),t("span",{style:{color:"#6F42C1"}},"printStackTrace"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            });")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        service."),t("span",{style:{color:"#6F42C1"}},"shutdown"),t("span",{style:{color:"#24292E"}},"();")])])])],-1),wc=t("figure",null,[t("img",{src:"https://jsd.cdn.zzko.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230719223801911.png",alt:"image-20230719223801911",loading:"lazy",decoding:"async"})],-1),Tc=t("blockquote",null,[t("p",null,[t("strong",null,"注意"),p(" CyclicBarrier 与 CountDownLatch 的主要区别在于 CyclicBarrier 是可以重用的 CyclicBarrier 可以被比 喻为『人满发车』")])],-1),xc={id:"_7、线程安全集合类概述",tabindex:"-1"},Nc=t("figure",null,[t("img",{src:"https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230720102336819.png",alt:"image-20230720102336819",loading:"lazy",decoding:"async"})],-1),Ic=t("p",null,"线程安全集合类可以分为三大类：",-1),Lc=t("ul",null,[t("li",null,"遗留的线程安全集合如 Hashtable ， Vector"),t("li",null,[p("使用 Collections 装饰的线程安全集合，如： "),t("ul",null,[t("li",null,"Collections.synchronizedCollection"),t("li",null,"Collections.synchronizedList"),t("li",null,"Collections.synchronizedMap"),t("li",null,"Collections.synchronizedSet"),t("li",null,"Collections.synchronizedNavigableMap"),t("li",null,"Collections.synchronizedNavigableSet"),t("li",null,"Collections.synchronizedSortedMap"),t("li",null,"Collections.synchronizedSortedSet")])]),t("li",null,"java.util.concurrent.*")],-1),jc=t("p",null,"重点介绍 java.util.concurrent.* 下的线程安全集合类，可以发现它们有规律，里面包含三类关键词：Blocking、CopyOnWrite、Concurrent",-1),Rc=t("ul",null,[t("li",null,"Blocking 大部分实现基于锁，并提供用来阻塞的方法"),t("li",null,"CopyOnWrite 之类容器修改开销相对较重"),t("li",null,[p("Concurrent 类型的容器 "),t("ul",null,[t("li",null,"内部很多操作使用 cas 优化，一般可以提供较高吞吐量"),t("li",null,[p("弱一致性 "),t("ul",null,[t("li",null,"遍历时弱一致性，例如，当利用迭代器遍历时，如果容器发生修改，迭代器仍然可以继续进行遍历，这时内容是旧的"),t("li",null,"求大小弱一致性，size 操作未必是 100% 准确"),t("li",null,"读取弱一致性")])])])])],-1),Oc=t("blockquote",null,[t("p",null,"遍历时如果发生了修改，对于非安全容器来讲，使用 fail-fast 机制也就是让遍历立刻失败，抛出ConcurrentModificationException，不再继续遍历")],-1),qc={id:"_8、concurrenthashmap",tabindex:"-1"},Pc={id:"练习-单词计数",tabindex:"-1"},zc=t("p",null,"生成测试数据",-1),_c=t("div",{class:"language-java"},[t("button",{title:"Copy Code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki github-dark vp-code-dark"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"static"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"final"),t("span",{style:{color:"#E1E4E8"}}," String ALPHA "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#9ECBFF"}},'"abcedfghijklmnopqrstuvwxyz"'),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"public"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"static"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"void"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"main"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#F97583"}},"String"),t("span",{style:{color:"#E1E4E8"}},"[] args) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," length "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," ALPHA."),t("span",{style:{color:"#B392F0"}},"length"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," count "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"200"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    List<"),t("span",{style:{color:"#F97583"}},"String"),t("span",{style:{color:"#E1E4E8"}},"> list "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"new"),t("span",{style:{color:"#E1E4E8"}}," ArrayList<>(length "),t("span",{style:{color:"#F97583"}},"*"),t("span",{style:{color:"#E1E4E8"}}," count);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"for"),t("span",{style:{color:"#E1E4E8"}}," ("),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," i "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"0"),t("span",{style:{color:"#E1E4E8"}},"; i "),t("span",{style:{color:"#F97583"}},"<"),t("span",{style:{color:"#E1E4E8"}}," length; i"),t("span",{style:{color:"#F97583"}},"++"),t("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"char"),t("span",{style:{color:"#E1E4E8"}}," ch "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," ALPHA."),t("span",{style:{color:"#B392F0"}},"charAt"),t("span",{style:{color:"#E1E4E8"}},"(i);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"for"),t("span",{style:{color:"#E1E4E8"}}," ("),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," j "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"0"),t("span",{style:{color:"#E1E4E8"}},"; j "),t("span",{style:{color:"#F97583"}},"<"),t("span",{style:{color:"#E1E4E8"}}," count; j"),t("span",{style:{color:"#F97583"}},"++"),t("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        list."),t("span",{style:{color:"#B392F0"}},"add"),t("span",{style:{color:"#E1E4E8"}},"(String."),t("span",{style:{color:"#B392F0"}},"valueOf"),t("span",{style:{color:"#E1E4E8"}},"(ch));")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    Collections."),t("span",{style:{color:"#B392F0"}},"shuffle"),t("span",{style:{color:"#E1E4E8"}},"(list);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"for"),t("span",{style:{color:"#E1E4E8"}}," ("),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," i "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"0"),t("span",{style:{color:"#E1E4E8"}},"; i "),t("span",{style:{color:"#F97583"}},"<"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"26"),t("span",{style:{color:"#E1E4E8"}},"; i"),t("span",{style:{color:"#F97583"}},"++"),t("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    \t"),t("span",{style:{color:"#F97583"}},"try"),t("span",{style:{color:"#E1E4E8"}}," (PrintWriter out "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"new"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"PrintWriter"),t("span",{style:{color:"#E1E4E8"}},"(")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"new"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"OutputStreamWriter"),t("span",{style:{color:"#E1E4E8"}},"(")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"new"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"FileOutputStream"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#9ECBFF"}},'"tmp/"'),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"+"),t("span",{style:{color:"#E1E4E8"}}," (i"),t("span",{style:{color:"#F97583"}},"+"),t("span",{style:{color:"#79B8FF"}},"1"),t("span",{style:{color:"#E1E4E8"}},") "),t("span",{style:{color:"#F97583"}},"+"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#9ECBFF"}},'".txt"'),t("span",{style:{color:"#E1E4E8"}},")))) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        String collect "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," list."),t("span",{style:{color:"#B392F0"}},"subList"),t("span",{style:{color:"#E1E4E8"}},"(i "),t("span",{style:{color:"#F97583"}},"*"),t("span",{style:{color:"#E1E4E8"}}," count, (i "),t("span",{style:{color:"#F97583"}},"+"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"1"),t("span",{style:{color:"#E1E4E8"}},") "),t("span",{style:{color:"#F97583"}},"*"),t("span",{style:{color:"#E1E4E8"}}," count)."),t("span",{style:{color:"#B392F0"}},"stream"),t("span",{style:{color:"#E1E4E8"}},"()")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        ."),t("span",{style:{color:"#B392F0"}},"collect"),t("span",{style:{color:"#E1E4E8"}},"(Collectors."),t("span",{style:{color:"#B392F0"}},"joining"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#9ECBFF"}},'"'),t("span",{style:{color:"#79B8FF"}},"\\n"),t("span",{style:{color:"#9ECBFF"}},'"'),t("span",{style:{color:"#E1E4E8"}},"));")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        out."),t("span",{style:{color:"#B392F0"}},"print"),t("span",{style:{color:"#E1E4E8"}},"(collect);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        } "),t("span",{style:{color:"#F97583"}},"catch"),t("span",{style:{color:"#E1E4E8"}}," (IOException "),t("span",{style:{color:"#FFAB70"}},"e"),t("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"}")])])]),t("pre",{class:"shiki github-light vp-code-light"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"static"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"final"),t("span",{style:{color:"#24292E"}}," String ALPHA "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#032F62"}},'"abcedfghijklmnopqrstuvwxyz"'),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"public"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"static"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"void"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"main"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#D73A49"}},"String"),t("span",{style:{color:"#24292E"}},"[] args) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," length "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," ALPHA."),t("span",{style:{color:"#6F42C1"}},"length"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," count "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"200"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    List<"),t("span",{style:{color:"#D73A49"}},"String"),t("span",{style:{color:"#24292E"}},"> list "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"new"),t("span",{style:{color:"#24292E"}}," ArrayList<>(length "),t("span",{style:{color:"#D73A49"}},"*"),t("span",{style:{color:"#24292E"}}," count);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"for"),t("span",{style:{color:"#24292E"}}," ("),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," i "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"0"),t("span",{style:{color:"#24292E"}},"; i "),t("span",{style:{color:"#D73A49"}},"<"),t("span",{style:{color:"#24292E"}}," length; i"),t("span",{style:{color:"#D73A49"}},"++"),t("span",{style:{color:"#24292E"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"char"),t("span",{style:{color:"#24292E"}}," ch "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," ALPHA."),t("span",{style:{color:"#6F42C1"}},"charAt"),t("span",{style:{color:"#24292E"}},"(i);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"for"),t("span",{style:{color:"#24292E"}}," ("),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," j "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"0"),t("span",{style:{color:"#24292E"}},"; j "),t("span",{style:{color:"#D73A49"}},"<"),t("span",{style:{color:"#24292E"}}," count; j"),t("span",{style:{color:"#D73A49"}},"++"),t("span",{style:{color:"#24292E"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        list."),t("span",{style:{color:"#6F42C1"}},"add"),t("span",{style:{color:"#24292E"}},"(String."),t("span",{style:{color:"#6F42C1"}},"valueOf"),t("span",{style:{color:"#24292E"}},"(ch));")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    Collections."),t("span",{style:{color:"#6F42C1"}},"shuffle"),t("span",{style:{color:"#24292E"}},"(list);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"for"),t("span",{style:{color:"#24292E"}}," ("),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," i "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"0"),t("span",{style:{color:"#24292E"}},"; i "),t("span",{style:{color:"#D73A49"}},"<"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"26"),t("span",{style:{color:"#24292E"}},"; i"),t("span",{style:{color:"#D73A49"}},"++"),t("span",{style:{color:"#24292E"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    \t"),t("span",{style:{color:"#D73A49"}},"try"),t("span",{style:{color:"#24292E"}}," (PrintWriter out "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"new"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"PrintWriter"),t("span",{style:{color:"#24292E"}},"(")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"new"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"OutputStreamWriter"),t("span",{style:{color:"#24292E"}},"(")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"new"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"FileOutputStream"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#032F62"}},'"tmp/"'),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"+"),t("span",{style:{color:"#24292E"}}," (i"),t("span",{style:{color:"#D73A49"}},"+"),t("span",{style:{color:"#005CC5"}},"1"),t("span",{style:{color:"#24292E"}},") "),t("span",{style:{color:"#D73A49"}},"+"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#032F62"}},'".txt"'),t("span",{style:{color:"#24292E"}},")))) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        String collect "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," list."),t("span",{style:{color:"#6F42C1"}},"subList"),t("span",{style:{color:"#24292E"}},"(i "),t("span",{style:{color:"#D73A49"}},"*"),t("span",{style:{color:"#24292E"}}," count, (i "),t("span",{style:{color:"#D73A49"}},"+"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"1"),t("span",{style:{color:"#24292E"}},") "),t("span",{style:{color:"#D73A49"}},"*"),t("span",{style:{color:"#24292E"}}," count)."),t("span",{style:{color:"#6F42C1"}},"stream"),t("span",{style:{color:"#24292E"}},"()")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        ."),t("span",{style:{color:"#6F42C1"}},"collect"),t("span",{style:{color:"#24292E"}},"(Collectors."),t("span",{style:{color:"#6F42C1"}},"joining"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#032F62"}},'"'),t("span",{style:{color:"#005CC5"}},"\\n"),t("span",{style:{color:"#032F62"}},'"'),t("span",{style:{color:"#24292E"}},"));")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        out."),t("span",{style:{color:"#6F42C1"}},"print"),t("span",{style:{color:"#24292E"}},"(collect);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        } "),t("span",{style:{color:"#D73A49"}},"catch"),t("span",{style:{color:"#24292E"}}," (IOException "),t("span",{style:{color:"#E36209"}},"e"),t("span",{style:{color:"#24292E"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"}")])])])],-1),Kc=t("p",null,"模版代码，模版代码中封装了多线程读取文件的代码",-1),Vc=t("div",{class:"language-java"},[t("button",{title:"Copy Code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki github-dark vp-code-dark"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"private"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"static"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"<"),t("span",{style:{color:"#E1E4E8"}},"V"),t("span",{style:{color:"#F97583"}},">"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"void"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"demo"),t("span",{style:{color:"#E1E4E8"}},"(Supplier"),t("span",{style:{color:"#F97583"}},"<"),t("span",{style:{color:"#E1E4E8"}},"Map"),t("span",{style:{color:"#F97583"}},"<"),t("span",{style:{color:"#E1E4E8"}},"String, V"),t("span",{style:{color:"#F97583"}},">>"),t("span",{style:{color:"#E1E4E8"}}," supplier, BiConsumer"),t("span",{style:{color:"#F97583"}},"<"),t("span",{style:{color:"#E1E4E8"}},"Map"),t("span",{style:{color:"#F97583"}},"<"),t("span",{style:{color:"#E1E4E8"}},"String, V"),t("span",{style:{color:"#F97583"}},">"),t("span",{style:{color:"#E1E4E8"}},", List"),t("span",{style:{color:"#F97583"}},"<"),t("span",{style:{color:"#E1E4E8"}},"String"),t("span",{style:{color:"#F97583"}},">>"),t("span",{style:{color:"#E1E4E8"}}," consumer) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    Map<"),t("span",{style:{color:"#F97583"}},"String"),t("span",{style:{color:"#E1E4E8"}},", "),t("span",{style:{color:"#F97583"}},"V"),t("span",{style:{color:"#E1E4E8"}},"> counterMap "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," supplier."),t("span",{style:{color:"#B392F0"}},"get"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// key value")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// a   200")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// b   200")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    List<"),t("span",{style:{color:"#F97583"}},"Thread"),t("span",{style:{color:"#E1E4E8"}},"> ts "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"new"),t("span",{style:{color:"#E1E4E8"}}," ArrayList<>();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"for"),t("span",{style:{color:"#E1E4E8"}}," ("),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," i "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"1"),t("span",{style:{color:"#E1E4E8"}},"; i "),t("span",{style:{color:"#F97583"}},"<="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"26"),t("span",{style:{color:"#E1E4E8"}},"; i"),t("span",{style:{color:"#F97583"}},"++"),t("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," idx "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," i;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        Thread thread "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"new"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"Thread"),t("span",{style:{color:"#E1E4E8"}},"(() "),t("span",{style:{color:"#F97583"}},"->"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            List<"),t("span",{style:{color:"#F97583"}},"String"),t("span",{style:{color:"#E1E4E8"}},"> words "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"readFromFile"),t("span",{style:{color:"#E1E4E8"}},"(idx);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            consumer."),t("span",{style:{color:"#B392F0"}},"accept"),t("span",{style:{color:"#E1E4E8"}},"(counterMap, words);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        });")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        ts."),t("span",{style:{color:"#B392F0"}},"add"),t("span",{style:{color:"#E1E4E8"}},"(thread);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    ts."),t("span",{style:{color:"#B392F0"}},"forEach"),t("span",{style:{color:"#E1E4E8"}},"(t "),t("span",{style:{color:"#F97583"}},"->"),t("span",{style:{color:"#E1E4E8"}}," t."),t("span",{style:{color:"#B392F0"}},"start"),t("span",{style:{color:"#E1E4E8"}},"());")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    ts."),t("span",{style:{color:"#B392F0"}},"forEach"),t("span",{style:{color:"#E1E4E8"}},"(t "),t("span",{style:{color:"#F97583"}},"->"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"try"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            t."),t("span",{style:{color:"#B392F0"}},"join"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        } "),t("span",{style:{color:"#F97583"}},"catch"),t("span",{style:{color:"#E1E4E8"}}," (InterruptedException "),t("span",{style:{color:"#FFAB70"}},"e"),t("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            e."),t("span",{style:{color:"#B392F0"}},"printStackTrace"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    });")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    System.out."),t("span",{style:{color:"#B392F0"}},"println"),t("span",{style:{color:"#E1E4E8"}},"(counterMap);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"}")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"public"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"static"),t("span",{style:{color:"#E1E4E8"}}," List"),t("span",{style:{color:"#F97583"}},"<"),t("span",{style:{color:"#E1E4E8"}},"String"),t("span",{style:{color:"#F97583"}},">"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"readFromFile"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," i) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        ArrayList<"),t("span",{style:{color:"#F97583"}},"String"),t("span",{style:{color:"#E1E4E8"}},"> words "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"new"),t("span",{style:{color:"#E1E4E8"}}," ArrayList<>();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"try"),t("span",{style:{color:"#E1E4E8"}}," (BufferedReader in "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"new"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"BufferedReader"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#F97583"}},"new"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"InputStreamReader"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#F97583"}},"new"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"FileInputStream"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#9ECBFF"}},'"tmp/"'),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"+"),t("span",{style:{color:"#E1E4E8"}}," i "),t("span",{style:{color:"#F97583"}},"+"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#9ECBFF"}},'".txt"'),t("span",{style:{color:"#E1E4E8"}},")))) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"while"),t("span",{style:{color:"#E1E4E8"}}," ("),t("span",{style:{color:"#79B8FF"}},"true"),t("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                String word "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," in."),t("span",{style:{color:"#B392F0"}},"readLine"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (word "),t("span",{style:{color:"#F97583"}},"=="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"null"),t("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                    "),t("span",{style:{color:"#F97583"}},"break"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                words."),t("span",{style:{color:"#B392F0"}},"add"),t("span",{style:{color:"#E1E4E8"}},"(word);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"return"),t("span",{style:{color:"#E1E4E8"}}," words;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        } "),t("span",{style:{color:"#F97583"}},"catch"),t("span",{style:{color:"#E1E4E8"}}," (IOException "),t("span",{style:{color:"#FFAB70"}},"e"),t("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"throw"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"new"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"RuntimeException"),t("span",{style:{color:"#E1E4E8"}},"(e);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    }")])])]),t("pre",{class:"shiki github-light vp-code-light"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"private"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"static"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"<"),t("span",{style:{color:"#24292E"}},"V"),t("span",{style:{color:"#D73A49"}},">"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"void"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"demo"),t("span",{style:{color:"#24292E"}},"(Supplier"),t("span",{style:{color:"#D73A49"}},"<"),t("span",{style:{color:"#24292E"}},"Map"),t("span",{style:{color:"#D73A49"}},"<"),t("span",{style:{color:"#24292E"}},"String, V"),t("span",{style:{color:"#D73A49"}},">>"),t("span",{style:{color:"#24292E"}}," supplier, BiConsumer"),t("span",{style:{color:"#D73A49"}},"<"),t("span",{style:{color:"#24292E"}},"Map"),t("span",{style:{color:"#D73A49"}},"<"),t("span",{style:{color:"#24292E"}},"String, V"),t("span",{style:{color:"#D73A49"}},">"),t("span",{style:{color:"#24292E"}},", List"),t("span",{style:{color:"#D73A49"}},"<"),t("span",{style:{color:"#24292E"}},"String"),t("span",{style:{color:"#D73A49"}},">>"),t("span",{style:{color:"#24292E"}}," consumer) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    Map<"),t("span",{style:{color:"#D73A49"}},"String"),t("span",{style:{color:"#24292E"}},", "),t("span",{style:{color:"#D73A49"}},"V"),t("span",{style:{color:"#24292E"}},"> counterMap "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," supplier."),t("span",{style:{color:"#6F42C1"}},"get"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// key value")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// a   200")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// b   200")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    List<"),t("span",{style:{color:"#D73A49"}},"Thread"),t("span",{style:{color:"#24292E"}},"> ts "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"new"),t("span",{style:{color:"#24292E"}}," ArrayList<>();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"for"),t("span",{style:{color:"#24292E"}}," ("),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," i "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"1"),t("span",{style:{color:"#24292E"}},"; i "),t("span",{style:{color:"#D73A49"}},"<="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"26"),t("span",{style:{color:"#24292E"}},"; i"),t("span",{style:{color:"#D73A49"}},"++"),t("span",{style:{color:"#24292E"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," idx "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," i;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        Thread thread "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"new"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"Thread"),t("span",{style:{color:"#24292E"}},"(() "),t("span",{style:{color:"#D73A49"}},"->"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            List<"),t("span",{style:{color:"#D73A49"}},"String"),t("span",{style:{color:"#24292E"}},"> words "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"readFromFile"),t("span",{style:{color:"#24292E"}},"(idx);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            consumer."),t("span",{style:{color:"#6F42C1"}},"accept"),t("span",{style:{color:"#24292E"}},"(counterMap, words);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        });")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        ts."),t("span",{style:{color:"#6F42C1"}},"add"),t("span",{style:{color:"#24292E"}},"(thread);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    }")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    ts."),t("span",{style:{color:"#6F42C1"}},"forEach"),t("span",{style:{color:"#24292E"}},"(t "),t("span",{style:{color:"#D73A49"}},"->"),t("span",{style:{color:"#24292E"}}," t."),t("span",{style:{color:"#6F42C1"}},"start"),t("span",{style:{color:"#24292E"}},"());")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    ts."),t("span",{style:{color:"#6F42C1"}},"forEach"),t("span",{style:{color:"#24292E"}},"(t "),t("span",{style:{color:"#D73A49"}},"->"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"try"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            t."),t("span",{style:{color:"#6F42C1"}},"join"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        } "),t("span",{style:{color:"#D73A49"}},"catch"),t("span",{style:{color:"#24292E"}}," (InterruptedException "),t("span",{style:{color:"#E36209"}},"e"),t("span",{style:{color:"#24292E"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            e."),t("span",{style:{color:"#6F42C1"}},"printStackTrace"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    });")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    System.out."),t("span",{style:{color:"#6F42C1"}},"println"),t("span",{style:{color:"#24292E"}},"(counterMap);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"}")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"public"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"static"),t("span",{style:{color:"#24292E"}}," List"),t("span",{style:{color:"#D73A49"}},"<"),t("span",{style:{color:"#24292E"}},"String"),t("span",{style:{color:"#D73A49"}},">"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"readFromFile"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," i) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        ArrayList<"),t("span",{style:{color:"#D73A49"}},"String"),t("span",{style:{color:"#24292E"}},"> words "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"new"),t("span",{style:{color:"#24292E"}}," ArrayList<>();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"try"),t("span",{style:{color:"#24292E"}}," (BufferedReader in "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"new"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"BufferedReader"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#D73A49"}},"new"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"InputStreamReader"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#D73A49"}},"new"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"FileInputStream"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#032F62"}},'"tmp/"'),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"+"),t("span",{style:{color:"#24292E"}}," i "),t("span",{style:{color:"#D73A49"}},"+"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#032F62"}},'".txt"'),t("span",{style:{color:"#24292E"}},")))) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"while"),t("span",{style:{color:"#24292E"}}," ("),t("span",{style:{color:"#005CC5"}},"true"),t("span",{style:{color:"#24292E"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                String word "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," in."),t("span",{style:{color:"#6F42C1"}},"readLine"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (word "),t("span",{style:{color:"#D73A49"}},"=="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"null"),t("span",{style:{color:"#24292E"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                    "),t("span",{style:{color:"#D73A49"}},"break"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                words."),t("span",{style:{color:"#6F42C1"}},"add"),t("span",{style:{color:"#24292E"}},"(word);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"return"),t("span",{style:{color:"#24292E"}}," words;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        } "),t("span",{style:{color:"#D73A49"}},"catch"),t("span",{style:{color:"#24292E"}}," (IOException "),t("span",{style:{color:"#E36209"}},"e"),t("span",{style:{color:"#24292E"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"throw"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"new"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"RuntimeException"),t("span",{style:{color:"#24292E"}},"(e);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    }")])])])],-1),Mc=t("p",null,"你要做的是实现两个参数",-1),Wc=t("ul",null,[t("li",null,"一是提供一个 map 集合，用来存放每个单词的计数结果，key 为单词，value 为计数"),t("li",null,"二是提供一组操作，保证计数的安全性，会传递 map 集合以及 单词 List")],-1),Uc=t("p",null,"正确结果输出应该是每个单词出现 200 次",-1),Qc=t("figure",null,[t("img",{src:"https://jsd.cdn.zzko.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230720104641336.png",alt:"image-20230720104641336",loading:"lazy",decoding:"async"})],-1),Hc=t("p",null,"错误实现",-1),Gc=t("figure",null,[t("img",{src:"https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230720104829263.png",alt:"image-20230720104829263",loading:"lazy",decoding:"async"})],-1),Jc=t("p",null,"换成ConcurrentHashMap结果也一样，因为对数据的获取、计算、设置等组合操作不是原子操作",-1),Yc=t("figure",null,[t("img",{src:"https://jsd.cdn.zzko.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230720104953284.png",alt:"image-20230720104953284",loading:"lazy",decoding:"async"})],-1),Xc=t("p",null,"正确实现",-1),Zc=t("ul",null,[t("li",null,[t("p",null,"简单粗暴就是加synchronized锁")]),t("li",null,[t("p",null,"computeIfAbsent+LongAdder")])],-1),$c=t("div",{class:"language-java"},[t("button",{title:"Copy Code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki github-dark vp-code-dark"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"public"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"static"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"void"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"main"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#F97583"}},"String"),t("span",{style:{color:"#E1E4E8"}},"[] args) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#B392F0"}},"demo"),t("span",{style:{color:"#E1E4E8"}},"(")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#6A737D"}},"// 创建 map 集合")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#6A737D"}},"// 创建 ConcurrentHashMap 对不对？")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            () "),t("span",{style:{color:"#F97583"}},"->"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"new"),t("span",{style:{color:"#E1E4E8"}}," ConcurrentHashMap<"),t("span",{style:{color:"#F97583"}},"String"),t("span",{style:{color:"#E1E4E8"}},", "),t("span",{style:{color:"#F97583"}},"LongAdder"),t("span",{style:{color:"#E1E4E8"}},">("),t("span",{style:{color:"#79B8FF"}},"8"),t("span",{style:{color:"#E1E4E8"}},","),t("span",{style:{color:"#79B8FF"}},"0.75f"),t("span",{style:{color:"#E1E4E8"}},","),t("span",{style:{color:"#79B8FF"}},"8"),t("span",{style:{color:"#E1E4E8"}},"),")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            (map, words) "),t("span",{style:{color:"#F97583"}},"->"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#F97583"}},"for"),t("span",{style:{color:"#E1E4E8"}}," (String word "),t("span",{style:{color:"#F97583"}},":"),t("span",{style:{color:"#E1E4E8"}}," words) {")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                    "),t("span",{style:{color:"#6A737D"}},"// 如果缺少一个 key，则计算生成一个 value , 然后将  key value 放入 map")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                    "),t("span",{style:{color:"#6A737D"}},"//                  a      0")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                    LongAdder value "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," map."),t("span",{style:{color:"#B392F0"}},"computeIfAbsent"),t("span",{style:{color:"#E1E4E8"}},"(word, (key) "),t("span",{style:{color:"#F97583"}},"->"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"new"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"LongAdder"),t("span",{style:{color:"#E1E4E8"}},"());")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                    "),t("span",{style:{color:"#6A737D"}},"// 执行累加")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                    value."),t("span",{style:{color:"#B392F0"}},"increment"),t("span",{style:{color:"#E1E4E8"}},"(); "),t("span",{style:{color:"#6A737D"}},"// 2")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                    "),t("span",{style:{color:"#6A737D"}},"/*// 检查 key 有没有")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"                    Integer counter = map.get(word);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"                    int newValue = counter == null ? 1 : counter + 1;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"                    // 没有 则 put")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"                    map.put(word, newValue);*/")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    );")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"}")])])]),t("pre",{class:"shiki github-light vp-code-light"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"public"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"static"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"void"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"main"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#D73A49"}},"String"),t("span",{style:{color:"#24292E"}},"[] args) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6F42C1"}},"demo"),t("span",{style:{color:"#24292E"}},"(")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#6A737D"}},"// 创建 map 集合")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#6A737D"}},"// 创建 ConcurrentHashMap 对不对？")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            () "),t("span",{style:{color:"#D73A49"}},"->"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"new"),t("span",{style:{color:"#24292E"}}," ConcurrentHashMap<"),t("span",{style:{color:"#D73A49"}},"String"),t("span",{style:{color:"#24292E"}},", "),t("span",{style:{color:"#D73A49"}},"LongAdder"),t("span",{style:{color:"#24292E"}},">("),t("span",{style:{color:"#005CC5"}},"8"),t("span",{style:{color:"#24292E"}},","),t("span",{style:{color:"#005CC5"}},"0.75f"),t("span",{style:{color:"#24292E"}},","),t("span",{style:{color:"#005CC5"}},"8"),t("span",{style:{color:"#24292E"}},"),")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            (map, words) "),t("span",{style:{color:"#D73A49"}},"->"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#D73A49"}},"for"),t("span",{style:{color:"#24292E"}}," (String word "),t("span",{style:{color:"#D73A49"}},":"),t("span",{style:{color:"#24292E"}}," words) {")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                    "),t("span",{style:{color:"#6A737D"}},"// 如果缺少一个 key，则计算生成一个 value , 然后将  key value 放入 map")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                    "),t("span",{style:{color:"#6A737D"}},"//                  a      0")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                    LongAdder value "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," map."),t("span",{style:{color:"#6F42C1"}},"computeIfAbsent"),t("span",{style:{color:"#24292E"}},"(word, (key) "),t("span",{style:{color:"#D73A49"}},"->"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"new"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"LongAdder"),t("span",{style:{color:"#24292E"}},"());")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                    "),t("span",{style:{color:"#6A737D"}},"// 执行累加")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                    value."),t("span",{style:{color:"#6F42C1"}},"increment"),t("span",{style:{color:"#24292E"}},"(); "),t("span",{style:{color:"#6A737D"}},"// 2")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                    "),t("span",{style:{color:"#6A737D"}},"/*// 检查 key 有没有")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"                    Integer counter = map.get(word);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"                    int newValue = counter == null ? 1 : counter + 1;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"                    // 没有 则 put")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"                    map.put(word, newValue);*/")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    );")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"}")])])])],-1),st=t("ul",null,[t("li",null,"merge+sum")],-1),lt=t("div",{class:"language-java"},[t("button",{title:"Copy Code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki github-dark vp-code-dark"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#B392F0"}},"demo"),t("span",{style:{color:"#E1E4E8"}},"(")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    \t() "),t("span",{style:{color:"#F97583"}},"->"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"new"),t("span",{style:{color:"#E1E4E8"}}," ConcurrentHashMap<"),t("span",{style:{color:"#F97583"}},"String"),t("span",{style:{color:"#E1E4E8"}},", "),t("span",{style:{color:"#F97583"}},"Integer"),t("span",{style:{color:"#E1E4E8"}},">(),")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            (map, words) "),t("span",{style:{color:"#F97583"}},"->"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#F97583"}},"for"),t("span",{style:{color:"#E1E4E8"}}," (String word "),t("span",{style:{color:"#F97583"}},":"),t("span",{style:{color:"#E1E4E8"}}," words) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                    "),t("span",{style:{color:"#6A737D"}},"// 函数式编程，无需原子变量")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                    map."),t("span",{style:{color:"#B392F0"}},"merge"),t("span",{style:{color:"#E1E4E8"}},"(word, "),t("span",{style:{color:"#79B8FF"}},"1"),t("span",{style:{color:"#E1E4E8"}},", Integer"),t("span",{style:{color:"#F97583"}},"::"),t("span",{style:{color:"#E1E4E8"}},"sum);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},");")])])]),t("pre",{class:"shiki github-light vp-code-light"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#6F42C1"}},"demo"),t("span",{style:{color:"#24292E"}},"(")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    \t() "),t("span",{style:{color:"#D73A49"}},"->"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"new"),t("span",{style:{color:"#24292E"}}," ConcurrentHashMap<"),t("span",{style:{color:"#D73A49"}},"String"),t("span",{style:{color:"#24292E"}},", "),t("span",{style:{color:"#D73A49"}},"Integer"),t("span",{style:{color:"#24292E"}},">(),")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            (map, words) "),t("span",{style:{color:"#D73A49"}},"->"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#D73A49"}},"for"),t("span",{style:{color:"#24292E"}}," (String word "),t("span",{style:{color:"#D73A49"}},":"),t("span",{style:{color:"#24292E"}}," words) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                    "),t("span",{style:{color:"#6A737D"}},"// 函数式编程，无需原子变量")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                    map."),t("span",{style:{color:"#6F42C1"}},"merge"),t("span",{style:{color:"#24292E"}},"(word, "),t("span",{style:{color:"#005CC5"}},"1"),t("span",{style:{color:"#24292E"}},", Integer"),t("span",{style:{color:"#D73A49"}},"::"),t("span",{style:{color:"#24292E"}},"sum);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},");")])])])],-1),ot={id:"concurrenthashmap-原理",tabindex:"-1"},nt={id:"jdk-7-hashmap-并发死链",tabindex:"-1"},at={id:"测试代码",tabindex:"-1"},et=t("p",null,"注意",-1),ct=t("ul",null,[t("li",null,"要在 JDK 7 下运行，否则扩容机制和 hash 的计算方法都变了"),t("li",null,"以下测试代码是精心准备的，不要随便改动")],-1),tt=t("div",{class:"language-java"},[t("button",{title:"Copy Code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki github-dark vp-code-dark"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"public"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"static"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"void"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"main"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#F97583"}},"String"),t("span",{style:{color:"#E1E4E8"}},"[] args) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// 测试 java 7 中哪些数字的 hash 结果相等")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    System.out."),t("span",{style:{color:"#B392F0"}},"println"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#9ECBFF"}},'"长度为16时，桶下标为1的key"'),t("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"for"),t("span",{style:{color:"#E1E4E8"}}," ("),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," i "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"0"),t("span",{style:{color:"#E1E4E8"}},"; i "),t("span",{style:{color:"#F97583"}},"<"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"64"),t("span",{style:{color:"#E1E4E8"}},"; i"),t("span",{style:{color:"#F97583"}},"++"),t("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," ("),t("span",{style:{color:"#B392F0"}},"hash"),t("span",{style:{color:"#E1E4E8"}},"(i) "),t("span",{style:{color:"#F97583"}},"%"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"16"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"=="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"1"),t("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            System.out."),t("span",{style:{color:"#B392F0"}},"println"),t("span",{style:{color:"#E1E4E8"}},"(i);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    System.out."),t("span",{style:{color:"#B392F0"}},"println"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#9ECBFF"}},'"长度为32时，桶下标为1的key"'),t("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"for"),t("span",{style:{color:"#E1E4E8"}}," ("),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," i "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"0"),t("span",{style:{color:"#E1E4E8"}},"; i "),t("span",{style:{color:"#F97583"}},"<"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"64"),t("span",{style:{color:"#E1E4E8"}},"; i"),t("span",{style:{color:"#F97583"}},"++"),t("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," ("),t("span",{style:{color:"#B392F0"}},"hash"),t("span",{style:{color:"#E1E4E8"}},"(i) "),t("span",{style:{color:"#F97583"}},"%"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"32"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"=="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"1"),t("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            System.out."),t("span",{style:{color:"#B392F0"}},"println"),t("span",{style:{color:"#E1E4E8"}},"(i);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// 1, 35, 16, 50 当大小为16时，它们在一个桶内")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"final"),t("span",{style:{color:"#E1E4E8"}}," HashMap<"),t("span",{style:{color:"#F97583"}},"Integer"),t("span",{style:{color:"#E1E4E8"}},", "),t("span",{style:{color:"#F97583"}},"Integer"),t("span",{style:{color:"#E1E4E8"}},"> map "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"new"),t("span",{style:{color:"#E1E4E8"}}," HashMap<"),t("span",{style:{color:"#F97583"}},"Integer"),t("span",{style:{color:"#E1E4E8"}},", "),t("span",{style:{color:"#F97583"}},"Integer"),t("span",{style:{color:"#E1E4E8"}},">();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// 放 12 个元素")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    map."),t("span",{style:{color:"#B392F0"}},"put"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#79B8FF"}},"2"),t("span",{style:{color:"#E1E4E8"}},", "),t("span",{style:{color:"#79B8FF"}},"null"),t("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    map."),t("span",{style:{color:"#B392F0"}},"put"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#79B8FF"}},"3"),t("span",{style:{color:"#E1E4E8"}},", "),t("span",{style:{color:"#79B8FF"}},"null"),t("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    map."),t("span",{style:{color:"#B392F0"}},"put"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#79B8FF"}},"4"),t("span",{style:{color:"#E1E4E8"}},", "),t("span",{style:{color:"#79B8FF"}},"null"),t("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    map."),t("span",{style:{color:"#B392F0"}},"put"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#79B8FF"}},"5"),t("span",{style:{color:"#E1E4E8"}},", "),t("span",{style:{color:"#79B8FF"}},"null"),t("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    map."),t("span",{style:{color:"#B392F0"}},"put"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#79B8FF"}},"6"),t("span",{style:{color:"#E1E4E8"}},", "),t("span",{style:{color:"#79B8FF"}},"null"),t("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    map."),t("span",{style:{color:"#B392F0"}},"put"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#79B8FF"}},"7"),t("span",{style:{color:"#E1E4E8"}},", "),t("span",{style:{color:"#79B8FF"}},"null"),t("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    map."),t("span",{style:{color:"#B392F0"}},"put"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#79B8FF"}},"8"),t("span",{style:{color:"#E1E4E8"}},", "),t("span",{style:{color:"#79B8FF"}},"null"),t("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    map."),t("span",{style:{color:"#B392F0"}},"put"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#79B8FF"}},"9"),t("span",{style:{color:"#E1E4E8"}},", "),t("span",{style:{color:"#79B8FF"}},"null"),t("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    map."),t("span",{style:{color:"#B392F0"}},"put"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#79B8FF"}},"10"),t("span",{style:{color:"#E1E4E8"}},", "),t("span",{style:{color:"#79B8FF"}},"null"),t("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    map."),t("span",{style:{color:"#B392F0"}},"put"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#79B8FF"}},"16"),t("span",{style:{color:"#E1E4E8"}},", "),t("span",{style:{color:"#79B8FF"}},"null"),t("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    map."),t("span",{style:{color:"#B392F0"}},"put"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#79B8FF"}},"35"),t("span",{style:{color:"#E1E4E8"}},", "),t("span",{style:{color:"#79B8FF"}},"null"),t("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    map."),t("span",{style:{color:"#B392F0"}},"put"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#79B8FF"}},"1"),t("span",{style:{color:"#E1E4E8"}},", "),t("span",{style:{color:"#79B8FF"}},"null"),t("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    System.out."),t("span",{style:{color:"#B392F0"}},"println"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#9ECBFF"}},'"扩容前大小[main]:"'),t("span",{style:{color:"#F97583"}},"+"),t("span",{style:{color:"#E1E4E8"}},"map."),t("span",{style:{color:"#B392F0"}},"size"),t("span",{style:{color:"#E1E4E8"}},"());")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"new"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"Thread"),t("span",{style:{color:"#E1E4E8"}},"() {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        @"),t("span",{style:{color:"#F97583"}},"Override")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"public"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"void"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"run"),t("span",{style:{color:"#E1E4E8"}},"() {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#6A737D"}},"// 放第 13 个元素, 发生扩容")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            map."),t("span",{style:{color:"#B392F0"}},"put"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#79B8FF"}},"50"),t("span",{style:{color:"#E1E4E8"}},", "),t("span",{style:{color:"#79B8FF"}},"null"),t("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            System.out."),t("span",{style:{color:"#B392F0"}},"println"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#9ECBFF"}},'"扩容后大小[Thread-0]:"'),t("span",{style:{color:"#F97583"}},"+"),t("span",{style:{color:"#E1E4E8"}},"map."),t("span",{style:{color:"#B392F0"}},"size"),t("span",{style:{color:"#E1E4E8"}},"());")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    }."),t("span",{style:{color:"#B392F0"}},"start"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"new"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"Thread"),t("span",{style:{color:"#E1E4E8"}},"() {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        @"),t("span",{style:{color:"#F97583"}},"Override")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"public"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"void"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"run"),t("span",{style:{color:"#E1E4E8"}},"() {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#6A737D"}},"// 放第 13 个元素, 发生扩容")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            map."),t("span",{style:{color:"#B392F0"}},"put"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#79B8FF"}},"50"),t("span",{style:{color:"#E1E4E8"}},", "),t("span",{style:{color:"#79B8FF"}},"null"),t("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            System.out."),t("span",{style:{color:"#B392F0"}},"println"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#9ECBFF"}},'"扩容后大小[Thread-1]:"'),t("span",{style:{color:"#F97583"}},"+"),t("span",{style:{color:"#E1E4E8"}},"map."),t("span",{style:{color:"#B392F0"}},"size"),t("span",{style:{color:"#E1E4E8"}},"());")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    }."),t("span",{style:{color:"#B392F0"}},"start"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"}")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"final"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"static"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"hash"),t("span",{style:{color:"#E1E4E8"}},"(Object k) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," h "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"0"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," ("),t("span",{style:{color:"#79B8FF"}},"0"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"!="),t("span",{style:{color:"#E1E4E8"}}," h "),t("span",{style:{color:"#F97583"}},"&&"),t("span",{style:{color:"#E1E4E8"}}," k "),t("span",{style:{color:"#F97583"}},"instanceof"),t("span",{style:{color:"#E1E4E8"}}," String) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"return"),t("span",{style:{color:"#E1E4E8"}}," sun.misc.Hashing."),t("span",{style:{color:"#B392F0"}},"stringHash32"),t("span",{style:{color:"#E1E4E8"}},"((String) k);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    h "),t("span",{style:{color:"#F97583"}},"^="),t("span",{style:{color:"#E1E4E8"}}," k."),t("span",{style:{color:"#B392F0"}},"hashCode"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    h "),t("span",{style:{color:"#F97583"}},"^="),t("span",{style:{color:"#E1E4E8"}}," (h "),t("span",{style:{color:"#F97583"}},">>>"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"20"),t("span",{style:{color:"#E1E4E8"}},") "),t("span",{style:{color:"#F97583"}},"^"),t("span",{style:{color:"#E1E4E8"}}," (h "),t("span",{style:{color:"#F97583"}},">>>"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"12"),t("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"return"),t("span",{style:{color:"#E1E4E8"}}," h "),t("span",{style:{color:"#F97583"}},"^"),t("span",{style:{color:"#E1E4E8"}}," (h "),t("span",{style:{color:"#F97583"}},">>>"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"7"),t("span",{style:{color:"#E1E4E8"}},") "),t("span",{style:{color:"#F97583"}},"^"),t("span",{style:{color:"#E1E4E8"}}," (h "),t("span",{style:{color:"#F97583"}},">>>"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"4"),t("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"}")])])]),t("pre",{class:"shiki github-light vp-code-light"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"public"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"static"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"void"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"main"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#D73A49"}},"String"),t("span",{style:{color:"#24292E"}},"[] args) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// 测试 java 7 中哪些数字的 hash 结果相等")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    System.out."),t("span",{style:{color:"#6F42C1"}},"println"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#032F62"}},'"长度为16时，桶下标为1的key"'),t("span",{style:{color:"#24292E"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"for"),t("span",{style:{color:"#24292E"}}," ("),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," i "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"0"),t("span",{style:{color:"#24292E"}},"; i "),t("span",{style:{color:"#D73A49"}},"<"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"64"),t("span",{style:{color:"#24292E"}},"; i"),t("span",{style:{color:"#D73A49"}},"++"),t("span",{style:{color:"#24292E"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," ("),t("span",{style:{color:"#6F42C1"}},"hash"),t("span",{style:{color:"#24292E"}},"(i) "),t("span",{style:{color:"#D73A49"}},"%"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"16"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"=="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"1"),t("span",{style:{color:"#24292E"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            System.out."),t("span",{style:{color:"#6F42C1"}},"println"),t("span",{style:{color:"#24292E"}},"(i);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    System.out."),t("span",{style:{color:"#6F42C1"}},"println"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#032F62"}},'"长度为32时，桶下标为1的key"'),t("span",{style:{color:"#24292E"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"for"),t("span",{style:{color:"#24292E"}}," ("),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," i "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"0"),t("span",{style:{color:"#24292E"}},"; i "),t("span",{style:{color:"#D73A49"}},"<"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"64"),t("span",{style:{color:"#24292E"}},"; i"),t("span",{style:{color:"#D73A49"}},"++"),t("span",{style:{color:"#24292E"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," ("),t("span",{style:{color:"#6F42C1"}},"hash"),t("span",{style:{color:"#24292E"}},"(i) "),t("span",{style:{color:"#D73A49"}},"%"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"32"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"=="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"1"),t("span",{style:{color:"#24292E"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            System.out."),t("span",{style:{color:"#6F42C1"}},"println"),t("span",{style:{color:"#24292E"}},"(i);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// 1, 35, 16, 50 当大小为16时，它们在一个桶内")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"final"),t("span",{style:{color:"#24292E"}}," HashMap<"),t("span",{style:{color:"#D73A49"}},"Integer"),t("span",{style:{color:"#24292E"}},", "),t("span",{style:{color:"#D73A49"}},"Integer"),t("span",{style:{color:"#24292E"}},"> map "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"new"),t("span",{style:{color:"#24292E"}}," HashMap<"),t("span",{style:{color:"#D73A49"}},"Integer"),t("span",{style:{color:"#24292E"}},", "),t("span",{style:{color:"#D73A49"}},"Integer"),t("span",{style:{color:"#24292E"}},">();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// 放 12 个元素")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    map."),t("span",{style:{color:"#6F42C1"}},"put"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#005CC5"}},"2"),t("span",{style:{color:"#24292E"}},", "),t("span",{style:{color:"#005CC5"}},"null"),t("span",{style:{color:"#24292E"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    map."),t("span",{style:{color:"#6F42C1"}},"put"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#005CC5"}},"3"),t("span",{style:{color:"#24292E"}},", "),t("span",{style:{color:"#005CC5"}},"null"),t("span",{style:{color:"#24292E"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    map."),t("span",{style:{color:"#6F42C1"}},"put"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#005CC5"}},"4"),t("span",{style:{color:"#24292E"}},", "),t("span",{style:{color:"#005CC5"}},"null"),t("span",{style:{color:"#24292E"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    map."),t("span",{style:{color:"#6F42C1"}},"put"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#005CC5"}},"5"),t("span",{style:{color:"#24292E"}},", "),t("span",{style:{color:"#005CC5"}},"null"),t("span",{style:{color:"#24292E"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    map."),t("span",{style:{color:"#6F42C1"}},"put"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#005CC5"}},"6"),t("span",{style:{color:"#24292E"}},", "),t("span",{style:{color:"#005CC5"}},"null"),t("span",{style:{color:"#24292E"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    map."),t("span",{style:{color:"#6F42C1"}},"put"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#005CC5"}},"7"),t("span",{style:{color:"#24292E"}},", "),t("span",{style:{color:"#005CC5"}},"null"),t("span",{style:{color:"#24292E"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    map."),t("span",{style:{color:"#6F42C1"}},"put"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#005CC5"}},"8"),t("span",{style:{color:"#24292E"}},", "),t("span",{style:{color:"#005CC5"}},"null"),t("span",{style:{color:"#24292E"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    map."),t("span",{style:{color:"#6F42C1"}},"put"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#005CC5"}},"9"),t("span",{style:{color:"#24292E"}},", "),t("span",{style:{color:"#005CC5"}},"null"),t("span",{style:{color:"#24292E"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    map."),t("span",{style:{color:"#6F42C1"}},"put"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#005CC5"}},"10"),t("span",{style:{color:"#24292E"}},", "),t("span",{style:{color:"#005CC5"}},"null"),t("span",{style:{color:"#24292E"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    map."),t("span",{style:{color:"#6F42C1"}},"put"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#005CC5"}},"16"),t("span",{style:{color:"#24292E"}},", "),t("span",{style:{color:"#005CC5"}},"null"),t("span",{style:{color:"#24292E"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    map."),t("span",{style:{color:"#6F42C1"}},"put"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#005CC5"}},"35"),t("span",{style:{color:"#24292E"}},", "),t("span",{style:{color:"#005CC5"}},"null"),t("span",{style:{color:"#24292E"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    map."),t("span",{style:{color:"#6F42C1"}},"put"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#005CC5"}},"1"),t("span",{style:{color:"#24292E"}},", "),t("span",{style:{color:"#005CC5"}},"null"),t("span",{style:{color:"#24292E"}},");")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    System.out."),t("span",{style:{color:"#6F42C1"}},"println"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#032F62"}},'"扩容前大小[main]:"'),t("span",{style:{color:"#D73A49"}},"+"),t("span",{style:{color:"#24292E"}},"map."),t("span",{style:{color:"#6F42C1"}},"size"),t("span",{style:{color:"#24292E"}},"());")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"new"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"Thread"),t("span",{style:{color:"#24292E"}},"() {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        @"),t("span",{style:{color:"#D73A49"}},"Override")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"public"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"void"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"run"),t("span",{style:{color:"#24292E"}},"() {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#6A737D"}},"// 放第 13 个元素, 发生扩容")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            map."),t("span",{style:{color:"#6F42C1"}},"put"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#005CC5"}},"50"),t("span",{style:{color:"#24292E"}},", "),t("span",{style:{color:"#005CC5"}},"null"),t("span",{style:{color:"#24292E"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            System.out."),t("span",{style:{color:"#6F42C1"}},"println"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#032F62"}},'"扩容后大小[Thread-0]:"'),t("span",{style:{color:"#D73A49"}},"+"),t("span",{style:{color:"#24292E"}},"map."),t("span",{style:{color:"#6F42C1"}},"size"),t("span",{style:{color:"#24292E"}},"());")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    }."),t("span",{style:{color:"#6F42C1"}},"start"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"new"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"Thread"),t("span",{style:{color:"#24292E"}},"() {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        @"),t("span",{style:{color:"#D73A49"}},"Override")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"public"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"void"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"run"),t("span",{style:{color:"#24292E"}},"() {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#6A737D"}},"// 放第 13 个元素, 发生扩容")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            map."),t("span",{style:{color:"#6F42C1"}},"put"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#005CC5"}},"50"),t("span",{style:{color:"#24292E"}},", "),t("span",{style:{color:"#005CC5"}},"null"),t("span",{style:{color:"#24292E"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            System.out."),t("span",{style:{color:"#6F42C1"}},"println"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#032F62"}},'"扩容后大小[Thread-1]:"'),t("span",{style:{color:"#D73A49"}},"+"),t("span",{style:{color:"#24292E"}},"map."),t("span",{style:{color:"#6F42C1"}},"size"),t("span",{style:{color:"#24292E"}},"());")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    }."),t("span",{style:{color:"#6F42C1"}},"start"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"}")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"final"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"static"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"hash"),t("span",{style:{color:"#24292E"}},"(Object k) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," h "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"0"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," ("),t("span",{style:{color:"#005CC5"}},"0"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"!="),t("span",{style:{color:"#24292E"}}," h "),t("span",{style:{color:"#D73A49"}},"&&"),t("span",{style:{color:"#24292E"}}," k "),t("span",{style:{color:"#D73A49"}},"instanceof"),t("span",{style:{color:"#24292E"}}," String) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"return"),t("span",{style:{color:"#24292E"}}," sun.misc.Hashing."),t("span",{style:{color:"#6F42C1"}},"stringHash32"),t("span",{style:{color:"#24292E"}},"((String) k);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    h "),t("span",{style:{color:"#D73A49"}},"^="),t("span",{style:{color:"#24292E"}}," k."),t("span",{style:{color:"#6F42C1"}},"hashCode"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    h "),t("span",{style:{color:"#D73A49"}},"^="),t("span",{style:{color:"#24292E"}}," (h "),t("span",{style:{color:"#D73A49"}},">>>"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"20"),t("span",{style:{color:"#24292E"}},") "),t("span",{style:{color:"#D73A49"}},"^"),t("span",{style:{color:"#24292E"}}," (h "),t("span",{style:{color:"#D73A49"}},">>>"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"12"),t("span",{style:{color:"#24292E"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"return"),t("span",{style:{color:"#24292E"}}," h "),t("span",{style:{color:"#D73A49"}},"^"),t("span",{style:{color:"#24292E"}}," (h "),t("span",{style:{color:"#D73A49"}},">>>"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"7"),t("span",{style:{color:"#24292E"}},") "),t("span",{style:{color:"#D73A49"}},"^"),t("span",{style:{color:"#24292E"}}," (h "),t("span",{style:{color:"#D73A49"}},">>>"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"4"),t("span",{style:{color:"#24292E"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"}")])])])],-1),pt=t("figure",null,[t("img",{src:"https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230720115250416.png",alt:"image-20230720115250416",loading:"lazy",decoding:"async"})],-1),rt={id:"死链复现",tabindex:"-1"},Et=t("p",null,"调试工具使用 idea 在 HashMap 源码 590 行加断点",-1),yt=t("div",{class:"language-java"},[t("button",{title:"Copy Code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki github-dark vp-code-dark"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," newCapacity "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," newTable.length;")])])]),t("pre",{class:"shiki github-light vp-code-light"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," newCapacity "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," newTable.length;")])])])],-1),it=t("p",null,"扩容前链表 [1]=>1->35->16",-1),Ft=t("figure",null,[t("img",{src:"https://jsd.cdn.zzko.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230720120415589.png",alt:"image-20230720120415589",loading:"lazy",decoding:"async"})],-1),ut=t("p",null,"断点的条件如下，目的是让 HashMap 在扩容为 32 时，并且线程为 Thread-0 或 Thread-1 时停下来",-1),At=t("div",{class:"language-java"},[t("button",{title:"Copy Code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki github-dark vp-code-dark"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"newTable.length"),t("span",{style:{color:"#F97583"}},"=="),t("span",{style:{color:"#79B8FF"}},"32"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"&&")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"(")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"Thread."),t("span",{style:{color:"#B392F0"}},"currentThread"),t("span",{style:{color:"#E1E4E8"}},"()."),t("span",{style:{color:"#B392F0"}},"getName"),t("span",{style:{color:"#E1E4E8"}},"()."),t("span",{style:{color:"#B392F0"}},"equals"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#9ECBFF"}},'"Thread-0"'),t("span",{style:{color:"#E1E4E8"}},")"),t("span",{style:{color:"#F97583"}},"||")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"Thread."),t("span",{style:{color:"#B392F0"}},"currentThread"),t("span",{style:{color:"#E1E4E8"}},"()."),t("span",{style:{color:"#B392F0"}},"getName"),t("span",{style:{color:"#E1E4E8"}},"()."),t("span",{style:{color:"#B392F0"}},"equals"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#9ECBFF"}},'"Thread-1"'),t("span",{style:{color:"#E1E4E8"}},")")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},")")])])]),t("pre",{class:"shiki github-light vp-code-light"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"newTable.length"),t("span",{style:{color:"#D73A49"}},"=="),t("span",{style:{color:"#005CC5"}},"32"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"&&")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"(")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"Thread."),t("span",{style:{color:"#6F42C1"}},"currentThread"),t("span",{style:{color:"#24292E"}},"()."),t("span",{style:{color:"#6F42C1"}},"getName"),t("span",{style:{color:"#24292E"}},"()."),t("span",{style:{color:"#6F42C1"}},"equals"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#032F62"}},'"Thread-0"'),t("span",{style:{color:"#24292E"}},")"),t("span",{style:{color:"#D73A49"}},"||")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"Thread."),t("span",{style:{color:"#6F42C1"}},"currentThread"),t("span",{style:{color:"#24292E"}},"()."),t("span",{style:{color:"#6F42C1"}},"getName"),t("span",{style:{color:"#24292E"}},"()."),t("span",{style:{color:"#6F42C1"}},"equals"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#032F62"}},'"Thread-1"'),t("span",{style:{color:"#24292E"}},")")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},")")])])])],-1),dt=t("p",null,"断点暂停方式选择 Thread，否则在调试 Thread-0 时，Thread-1 无法恢复运行 运行代码，程序在预料的断点位置停了下来，输出",-1),Dt=t("figure",null,[t("img",{src:"https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230720234932862.png",alt:"image-20230720234932862",loading:"lazy",decoding:"async"})],-1),Ct=t("p",null,"接下来进入扩容流程调试 在 HashMap 源码 594 行加断点",-1),ht=t("div",{class:"language-java"},[t("button",{title:"Copy Code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki github-dark vp-code-dark"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"Entry<"),t("span",{style:{color:"#F97583"}},"K"),t("span",{style:{color:"#E1E4E8"}},","),t("span",{style:{color:"#F97583"}},"V"),t("span",{style:{color:"#E1E4E8"}},"> next "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," e.next; "),t("span",{style:{color:"#6A737D"}},"// 593")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (rehash) "),t("span",{style:{color:"#6A737D"}},"// 594")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// ...")])])]),t("pre",{class:"shiki github-light vp-code-light"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"Entry<"),t("span",{style:{color:"#D73A49"}},"K"),t("span",{style:{color:"#24292E"}},","),t("span",{style:{color:"#D73A49"}},"V"),t("span",{style:{color:"#24292E"}},"> next "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," e.next; "),t("span",{style:{color:"#6A737D"}},"// 593")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (rehash) "),t("span",{style:{color:"#6A737D"}},"// 594")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// ...")])])])],-1),gt=t("p",null,[p("这是为了观察 e 节点和 next 节点的状态，Thread-0 单步执行到 594 行，再 594 处再添加一个断点（条件 "),t("code",null,'Thread.currentThread().getName().equals("Thread-0")'),p("）")],-1),Bt=t("p",null,"这时可以在 Variables 面板观察到 e 和 next 变量，使用 view as -> Object 查看节点状态",-1),ft=t("div",{class:"language-java"},[t("button",{title:"Copy Code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki github-dark vp-code-dark"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#B392F0"}},"e"),t("span",{style:{color:"#E1E4E8"}}," ("),t("span",{style:{color:"#79B8FF"}},"1"),t("span",{style:{color:"#E1E4E8"}},")"),t("span",{style:{color:"#F97583"}},"->"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#79B8FF"}},"35"),t("span",{style:{color:"#E1E4E8"}},")"),t("span",{style:{color:"#F97583"}},"->"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#79B8FF"}},"16"),t("span",{style:{color:"#E1E4E8"}},")"),t("span",{style:{color:"#F97583"}},"->"),t("span",{style:{color:"#79B8FF"}},"null")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#B392F0"}},"next"),t("span",{style:{color:"#E1E4E8"}}," ("),t("span",{style:{color:"#79B8FF"}},"35"),t("span",{style:{color:"#E1E4E8"}},")"),t("span",{style:{color:"#F97583"}},"->"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#79B8FF"}},"16"),t("span",{style:{color:"#E1E4E8"}},")"),t("span",{style:{color:"#F97583"}},"->"),t("span",{style:{color:"#79B8FF"}},"null")])])]),t("pre",{class:"shiki github-light vp-code-light"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#6F42C1"}},"e"),t("span",{style:{color:"#24292E"}}," ("),t("span",{style:{color:"#005CC5"}},"1"),t("span",{style:{color:"#24292E"}},")"),t("span",{style:{color:"#D73A49"}},"->"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#005CC5"}},"35"),t("span",{style:{color:"#24292E"}},")"),t("span",{style:{color:"#D73A49"}},"->"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#005CC5"}},"16"),t("span",{style:{color:"#24292E"}},")"),t("span",{style:{color:"#D73A49"}},"->"),t("span",{style:{color:"#005CC5"}},"null")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#6F42C1"}},"next"),t("span",{style:{color:"#24292E"}}," ("),t("span",{style:{color:"#005CC5"}},"35"),t("span",{style:{color:"#24292E"}},")"),t("span",{style:{color:"#D73A49"}},"->"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#005CC5"}},"16"),t("span",{style:{color:"#24292E"}},")"),t("span",{style:{color:"#D73A49"}},"->"),t("span",{style:{color:"#005CC5"}},"null")])])])],-1),kt=t("p",null,"在 Threads 面板选中 Thread-1 恢复运行，可以看到控制台输出新的内容如下，Thread-1 扩容已完成",-1),bt=t("div",{class:"language-java"},[t("button",{title:"Copy Code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki github-dark vp-code-dark"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"newTable["),t("span",{style:{color:"#79B8FF"}},"1"),t("span",{style:{color:"#E1E4E8"}},"] ("),t("span",{style:{color:"#79B8FF"}},"35"),t("span",{style:{color:"#E1E4E8"}},")"),t("span",{style:{color:"#F97583"}},"->"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#79B8FF"}},"1"),t("span",{style:{color:"#E1E4E8"}},")"),t("span",{style:{color:"#F97583"}},"->"),t("span",{style:{color:"#79B8FF"}},"null")])])]),t("pre",{class:"shiki github-light vp-code-light"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"newTable["),t("span",{style:{color:"#005CC5"}},"1"),t("span",{style:{color:"#24292E"}},"] ("),t("span",{style:{color:"#005CC5"}},"35"),t("span",{style:{color:"#24292E"}},")"),t("span",{style:{color:"#D73A49"}},"->"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#005CC5"}},"1"),t("span",{style:{color:"#24292E"}},")"),t("span",{style:{color:"#D73A49"}},"->"),t("span",{style:{color:"#005CC5"}},"null")])])])],-1),mt=t("figure",null,[t("img",{src:"https://jsd.cdn.zzko.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230720121455212.png",alt:"image-20230720121455212",loading:"lazy",decoding:"async"})],-1),St=t("p",null,"将要迁移到新链表的位置，16（计算的桶下标不一样）迁移到不同地方",-1),vt=t("figure",null,[t("img",{src:"https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230720122243893.png",alt:"image-20230720122243893",loading:"lazy",decoding:"async"})],-1),wt=t("p",null,"这时 Thread-1完成扩容并消失",-1),Tt=t("figure",null,[t("img",{src:"https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230720121649327.png",alt:"image-20230720121649327",loading:"lazy",decoding:"async"})],-1),xt=t("figure",null,[t("img",{src:"https://jsd.cdn.zzko.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230720121911063.png",alt:"image-20230720121911063",loading:"lazy",decoding:"async"})],-1),Nt=t("p",null,"这时 Thread-0 还停在 594 处， Variables 面板变量的状态已经变化为",-1),It=t("div",{class:"language-java"},[t("button",{title:"Copy Code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki github-dark vp-code-dark"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#B392F0"}},"e"),t("span",{style:{color:"#E1E4E8"}}," ("),t("span",{style:{color:"#79B8FF"}},"1"),t("span",{style:{color:"#E1E4E8"}},")"),t("span",{style:{color:"#F97583"}},"->"),t("span",{style:{color:"#79B8FF"}},"null"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#6A737D"}},"//因为Thread-0线程切换回来恢复原来状态，e的变量为1")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#B392F0"}},"next"),t("span",{style:{color:"#E1E4E8"}}," ("),t("span",{style:{color:"#79B8FF"}},"35"),t("span",{style:{color:"#E1E4E8"}},")"),t("span",{style:{color:"#F97583"}},"->"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#79B8FF"}},"1"),t("span",{style:{color:"#E1E4E8"}},")"),t("span",{style:{color:"#F97583"}},"->"),t("span",{style:{color:"#79B8FF"}},"null"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#6A737D"}},"//扩容后插入链表方式为头插法")])])]),t("pre",{class:"shiki github-light vp-code-light"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#6F42C1"}},"e"),t("span",{style:{color:"#24292E"}}," ("),t("span",{style:{color:"#005CC5"}},"1"),t("span",{style:{color:"#24292E"}},")"),t("span",{style:{color:"#D73A49"}},"->"),t("span",{style:{color:"#005CC5"}},"null"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6A737D"}},"//因为Thread-0线程切换回来恢复原来状态，e的变量为1")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#6F42C1"}},"next"),t("span",{style:{color:"#24292E"}}," ("),t("span",{style:{color:"#005CC5"}},"35"),t("span",{style:{color:"#24292E"}},")"),t("span",{style:{color:"#D73A49"}},"->"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#005CC5"}},"1"),t("span",{style:{color:"#24292E"}},")"),t("span",{style:{color:"#D73A49"}},"->"),t("span",{style:{color:"#005CC5"}},"null"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6A737D"}},"//扩容后插入链表方式为头插法")])])])],-1),Lt=t("p",null,"为什么呢，因为 Thread-1 扩容时链表也是后加入的元素放入链表头，因此链表就倒过来了，但 Thread-1 虽然结 果正确，但它结束后 Thread-0 还要继续运行 接下来就可以单步调试（F8）观察死链的产生了 下一轮循环到 594，将 e 搬迁到 newTable 链表头",-1),jt=t("div",{class:"language-java"},[t("button",{title:"Copy Code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki github-dark vp-code-dark"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"newTable["),t("span",{style:{color:"#79B8FF"}},"1"),t("span",{style:{color:"#E1E4E8"}},"] ("),t("span",{style:{color:"#79B8FF"}},"1"),t("span",{style:{color:"#E1E4E8"}},")"),t("span",{style:{color:"#F97583"}},"->"),t("span",{style:{color:"#79B8FF"}},"null")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#B392F0"}},"e"),t("span",{style:{color:"#E1E4E8"}}," ("),t("span",{style:{color:"#79B8FF"}},"35"),t("span",{style:{color:"#E1E4E8"}},")"),t("span",{style:{color:"#F97583"}},"->"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#79B8FF"}},"1"),t("span",{style:{color:"#E1E4E8"}},")"),t("span",{style:{color:"#F97583"}},"->"),t("span",{style:{color:"#79B8FF"}},"null")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#B392F0"}},"next"),t("span",{style:{color:"#E1E4E8"}}," ("),t("span",{style:{color:"#79B8FF"}},"1"),t("span",{style:{color:"#E1E4E8"}},")"),t("span",{style:{color:"#F97583"}},"->"),t("span",{style:{color:"#79B8FF"}},"null")])])]),t("pre",{class:"shiki github-light vp-code-light"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"newTable["),t("span",{style:{color:"#005CC5"}},"1"),t("span",{style:{color:"#24292E"}},"] ("),t("span",{style:{color:"#005CC5"}},"1"),t("span",{style:{color:"#24292E"}},")"),t("span",{style:{color:"#D73A49"}},"->"),t("span",{style:{color:"#005CC5"}},"null")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#6F42C1"}},"e"),t("span",{style:{color:"#24292E"}}," ("),t("span",{style:{color:"#005CC5"}},"35"),t("span",{style:{color:"#24292E"}},")"),t("span",{style:{color:"#D73A49"}},"->"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#005CC5"}},"1"),t("span",{style:{color:"#24292E"}},")"),t("span",{style:{color:"#D73A49"}},"->"),t("span",{style:{color:"#005CC5"}},"null")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#6F42C1"}},"next"),t("span",{style:{color:"#24292E"}}," ("),t("span",{style:{color:"#005CC5"}},"1"),t("span",{style:{color:"#24292E"}},")"),t("span",{style:{color:"#D73A49"}},"->"),t("span",{style:{color:"#005CC5"}},"null")])])])],-1),Rt=t("p",null,"最先迁移的是e=1",-1),Ot=t("figure",null,[t("img",{src:"https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230720123629963.png",alt:"image-20230720123629963",loading:"lazy",decoding:"async"})],-1),qt=t("p",null,"下一轮迁移对象为35，next又为1",-1),Pt=t("figure",null,[t("img",{src:"https://jsd.cdn.zzko.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230720123832412.png",alt:"image-20230720123832412",loading:"lazy",decoding:"async"})],-1),zt=t("p",null,"下一轮迁移对象又为1，next为null",-1),_t=t("figure",null,[t("img",{src:"https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230720124011252.png",alt:"image-20230720124011252",loading:"lazy",decoding:"async"})],-1),Kt=t("p",null,"下一轮循环到 594，将 e 搬迁到 newTable 链表头",-1),Vt=t("div",{class:"language-java"},[t("button",{title:"Copy Code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki github-dark vp-code-dark"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"newTable["),t("span",{style:{color:"#79B8FF"}},"1"),t("span",{style:{color:"#E1E4E8"}},"] ("),t("span",{style:{color:"#79B8FF"}},"35"),t("span",{style:{color:"#E1E4E8"}},")"),t("span",{style:{color:"#F97583"}},"->"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#79B8FF"}},"1"),t("span",{style:{color:"#E1E4E8"}},")"),t("span",{style:{color:"#F97583"}},"->"),t("span",{style:{color:"#79B8FF"}},"null")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#B392F0"}},"e"),t("span",{style:{color:"#E1E4E8"}}," ("),t("span",{style:{color:"#79B8FF"}},"1"),t("span",{style:{color:"#E1E4E8"}},")"),t("span",{style:{color:"#F97583"}},"->"),t("span",{style:{color:"#79B8FF"}},"null")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"next "),t("span",{style:{color:"#79B8FF"}},"null")])])]),t("pre",{class:"shiki github-light vp-code-light"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"newTable["),t("span",{style:{color:"#005CC5"}},"1"),t("span",{style:{color:"#24292E"}},"] ("),t("span",{style:{color:"#005CC5"}},"35"),t("span",{style:{color:"#24292E"}},")"),t("span",{style:{color:"#D73A49"}},"->"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#005CC5"}},"1"),t("span",{style:{color:"#24292E"}},")"),t("span",{style:{color:"#D73A49"}},"->"),t("span",{style:{color:"#005CC5"}},"null")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#6F42C1"}},"e"),t("span",{style:{color:"#24292E"}}," ("),t("span",{style:{color:"#005CC5"}},"1"),t("span",{style:{color:"#24292E"}},")"),t("span",{style:{color:"#D73A49"}},"->"),t("span",{style:{color:"#005CC5"}},"null")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"next "),t("span",{style:{color:"#005CC5"}},"null")])])])],-1),Mt=t("p",null,"在迁移过程中发生了死链[1]=>1->35->1，这就会导致2,3,4...节点的迁移也无法继续运行，程序直接阻塞住，停止程序也要等半天",-1),Wt=t("figure",null,[t("img",{src:"https://jsd.cdn.zzko.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230720124644341.png",alt:"image-20230720124644341",loading:"lazy",decoding:"async"})],-1),Ut=t("p",null,"再看看源码",-1),Qt=t("div",{class:"language-java"},[t("button",{title:"Copy Code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki github-dark vp-code-dark"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"e.next "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," newTable["),t("span",{style:{color:"#79B8FF"}},"1"),t("span",{style:{color:"#E1E4E8"}},"];")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// 这时 e (1,35)")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// 而 newTable[1] (35,1)->(1,35) 因为是同一个对象")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"newTable["),t("span",{style:{color:"#79B8FF"}},"1"),t("span",{style:{color:"#E1E4E8"}},"] "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," e;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// 再尝试将 e 作为链表头, 死链已成")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"e "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," next;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// 虽然 next 是 null, 会进入下一个链表的复制, 但死链已经形成了")])])]),t("pre",{class:"shiki github-light vp-code-light"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"e.next "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," newTable["),t("span",{style:{color:"#005CC5"}},"1"),t("span",{style:{color:"#24292E"}},"];")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// 这时 e (1,35)")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// 而 newTable[1] (35,1)->(1,35) 因为是同一个对象")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"newTable["),t("span",{style:{color:"#005CC5"}},"1"),t("span",{style:{color:"#24292E"}},"] "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," e;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// 再尝试将 e 作为链表头, 死链已成")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"e "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," next;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// 虽然 next 是 null, 会进入下一个链表的复制, 但死链已经形成了")])])])],-1),Ht={id:"源码分析-3",tabindex:"-1"},Gt=t("p",null,"HashMap 的并发死链发生在扩容时",-1),Jt=t("div",{class:"language-java"},[t("button",{title:"Copy Code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki github-dark vp-code-dark"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// 将 table 迁移至 newTable")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"void"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"transfer"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#F97583"}},"Entry"),t("span",{style:{color:"#E1E4E8"}},"[] newTable, "),t("span",{style:{color:"#F97583"}},"boolean"),t("span",{style:{color:"#E1E4E8"}}," rehash) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," newCapacity "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," newTable.length;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"for"),t("span",{style:{color:"#E1E4E8"}}," (Entry<"),t("span",{style:{color:"#F97583"}},"K"),t("span",{style:{color:"#E1E4E8"}},","),t("span",{style:{color:"#F97583"}},"V"),t("span",{style:{color:"#E1E4E8"}},"> e "),t("span",{style:{color:"#F97583"}},":"),t("span",{style:{color:"#E1E4E8"}}," table) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"while"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#79B8FF"}},"null"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"!="),t("span",{style:{color:"#E1E4E8"}}," e) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            Entry<"),t("span",{style:{color:"#F97583"}},"K"),t("span",{style:{color:"#E1E4E8"}},","),t("span",{style:{color:"#F97583"}},"V"),t("span",{style:{color:"#E1E4E8"}},"> next "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," e.next;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#6A737D"}},"// 1 处")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (rehash) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            \te.hash "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"null"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"=="),t("span",{style:{color:"#E1E4E8"}}," e.key "),t("span",{style:{color:"#F97583"}},"?"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"0"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},":"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"hash"),t("span",{style:{color:"#E1E4E8"}},"(e.key);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," i "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"indexFor"),t("span",{style:{color:"#E1E4E8"}},"(e.hash, newCapacity);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#6A737D"}},"// 2 处")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#6A737D"}},"// 将新元素加入 newTable[i], 原 newTable[i] 作为新元素的 next")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            e.next "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," newTable[i];")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            newTable[i] "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," e;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            e "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," next;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"}")])])]),t("pre",{class:"shiki github-light vp-code-light"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// 将 table 迁移至 newTable")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"void"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"transfer"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#D73A49"}},"Entry"),t("span",{style:{color:"#24292E"}},"[] newTable, "),t("span",{style:{color:"#D73A49"}},"boolean"),t("span",{style:{color:"#24292E"}}," rehash) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," newCapacity "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," newTable.length;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"for"),t("span",{style:{color:"#24292E"}}," (Entry<"),t("span",{style:{color:"#D73A49"}},"K"),t("span",{style:{color:"#24292E"}},","),t("span",{style:{color:"#D73A49"}},"V"),t("span",{style:{color:"#24292E"}},"> e "),t("span",{style:{color:"#D73A49"}},":"),t("span",{style:{color:"#24292E"}}," table) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"while"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#005CC5"}},"null"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"!="),t("span",{style:{color:"#24292E"}}," e) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            Entry<"),t("span",{style:{color:"#D73A49"}},"K"),t("span",{style:{color:"#24292E"}},","),t("span",{style:{color:"#D73A49"}},"V"),t("span",{style:{color:"#24292E"}},"> next "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," e.next;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#6A737D"}},"// 1 处")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (rehash) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            \te.hash "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"null"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"=="),t("span",{style:{color:"#24292E"}}," e.key "),t("span",{style:{color:"#D73A49"}},"?"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"0"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},":"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"hash"),t("span",{style:{color:"#24292E"}},"(e.key);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," i "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"indexFor"),t("span",{style:{color:"#24292E"}},"(e.hash, newCapacity);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#6A737D"}},"// 2 处")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#6A737D"}},"// 将新元素加入 newTable[i], 原 newTable[i] 作为新元素的 next")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            e.next "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," newTable[i];")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            newTable[i] "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," e;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            e "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," next;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"}")])])])],-1),Yt=t("p",null,"假设 map 中初始元素是",-1),Xt=t("div",{class:"language-java"},[t("button",{title:"Copy Code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki github-dark vp-code-dark"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"原始链表，格式：[下标] (key,next)")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"["),t("span",{style:{color:"#79B8FF"}},"1"),t("span",{style:{color:"#E1E4E8"}},"] ("),t("span",{style:{color:"#79B8FF"}},"1"),t("span",{style:{color:"#E1E4E8"}},","),t("span",{style:{color:"#79B8FF"}},"35"),t("span",{style:{color:"#E1E4E8"}},")"),t("span",{style:{color:"#F97583"}},"->"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#79B8FF"}},"35"),t("span",{style:{color:"#E1E4E8"}},","),t("span",{style:{color:"#79B8FF"}},"16"),t("span",{style:{color:"#E1E4E8"}},")"),t("span",{style:{color:"#F97583"}},"->"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#79B8FF"}},"16"),t("span",{style:{color:"#E1E4E8"}},","),t("span",{style:{color:"#79B8FF"}},"null"),t("span",{style:{color:"#E1E4E8"}},")")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"线程 a 执行到 "),t("span",{style:{color:"#79B8FF"}},"1"),t("span",{style:{color:"#E1E4E8"}}," 处 ，此时局部变量 e 为 ("),t("span",{style:{color:"#79B8FF"}},"1"),t("span",{style:{color:"#E1E4E8"}},","),t("span",{style:{color:"#79B8FF"}},"35"),t("span",{style:{color:"#E1E4E8"}},")，而局部变量 next 为 ("),t("span",{style:{color:"#79B8FF"}},"35"),t("span",{style:{color:"#E1E4E8"}},","),t("span",{style:{color:"#79B8FF"}},"16"),t("span",{style:{color:"#E1E4E8"}},") 线程 a 挂起")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"线程 b 开始执行")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"第一次循环")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"["),t("span",{style:{color:"#79B8FF"}},"1"),t("span",{style:{color:"#E1E4E8"}},"] ("),t("span",{style:{color:"#79B8FF"}},"1"),t("span",{style:{color:"#E1E4E8"}},","),t("span",{style:{color:"#79B8FF"}},"null"),t("span",{style:{color:"#E1E4E8"}},")")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"第二次循环")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"["),t("span",{style:{color:"#79B8FF"}},"1"),t("span",{style:{color:"#E1E4E8"}},"] ("),t("span",{style:{color:"#79B8FF"}},"35"),t("span",{style:{color:"#E1E4E8"}},","),t("span",{style:{color:"#79B8FF"}},"1"),t("span",{style:{color:"#E1E4E8"}},")"),t("span",{style:{color:"#F97583"}},"->"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#79B8FF"}},"1"),t("span",{style:{color:"#E1E4E8"}},","),t("span",{style:{color:"#79B8FF"}},"null"),t("span",{style:{color:"#E1E4E8"}},")")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"第三次循环")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"["),t("span",{style:{color:"#79B8FF"}},"1"),t("span",{style:{color:"#E1E4E8"}},"] ("),t("span",{style:{color:"#79B8FF"}},"35"),t("span",{style:{color:"#E1E4E8"}},","),t("span",{style:{color:"#79B8FF"}},"1"),t("span",{style:{color:"#E1E4E8"}},")"),t("span",{style:{color:"#F97583"}},"->"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#79B8FF"}},"1"),t("span",{style:{color:"#E1E4E8"}},","),t("span",{style:{color:"#79B8FF"}},"null"),t("span",{style:{color:"#E1E4E8"}},")")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"["),t("span",{style:{color:"#79B8FF"}},"17"),t("span",{style:{color:"#E1E4E8"}},"] ("),t("span",{style:{color:"#79B8FF"}},"16"),t("span",{style:{color:"#E1E4E8"}},","),t("span",{style:{color:"#79B8FF"}},"null"),t("span",{style:{color:"#E1E4E8"}},")")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"切换回线程 a，此时局部变量 e 和 next 被恢复，引用没变但内容变了：e 的内容被改为 ("),t("span",{style:{color:"#79B8FF"}},"1"),t("span",{style:{color:"#E1E4E8"}},","),t("span",{style:{color:"#79B8FF"}},"null"),t("span",{style:{color:"#E1E4E8"}},")，而 next 的内")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"容被改为 ("),t("span",{style:{color:"#79B8FF"}},"35"),t("span",{style:{color:"#E1E4E8"}},","),t("span",{style:{color:"#79B8FF"}},"1"),t("span",{style:{color:"#E1E4E8"}},") 并链向 ("),t("span",{style:{color:"#79B8FF"}},"1"),t("span",{style:{color:"#E1E4E8"}},","),t("span",{style:{color:"#79B8FF"}},"null"),t("span",{style:{color:"#E1E4E8"}},")")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"第一次循环")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"["),t("span",{style:{color:"#79B8FF"}},"1"),t("span",{style:{color:"#E1E4E8"}},"] ("),t("span",{style:{color:"#79B8FF"}},"1"),t("span",{style:{color:"#E1E4E8"}},","),t("span",{style:{color:"#79B8FF"}},"null"),t("span",{style:{color:"#E1E4E8"}},")")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"第二次循环，注意这时 e 是 ("),t("span",{style:{color:"#79B8FF"}},"35"),t("span",{style:{color:"#E1E4E8"}},","),t("span",{style:{color:"#79B8FF"}},"1"),t("span",{style:{color:"#E1E4E8"}},") 并链向 ("),t("span",{style:{color:"#79B8FF"}},"1"),t("span",{style:{color:"#E1E4E8"}},","),t("span",{style:{color:"#79B8FF"}},"null"),t("span",{style:{color:"#E1E4E8"}},") 所以 next 又是 ("),t("span",{style:{color:"#79B8FF"}},"1"),t("span",{style:{color:"#E1E4E8"}},","),t("span",{style:{color:"#79B8FF"}},"null"),t("span",{style:{color:"#E1E4E8"}},")")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"["),t("span",{style:{color:"#79B8FF"}},"1"),t("span",{style:{color:"#E1E4E8"}},"] ("),t("span",{style:{color:"#79B8FF"}},"35"),t("span",{style:{color:"#E1E4E8"}},","),t("span",{style:{color:"#79B8FF"}},"1"),t("span",{style:{color:"#E1E4E8"}},")"),t("span",{style:{color:"#F97583"}},"->"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#79B8FF"}},"1"),t("span",{style:{color:"#E1E4E8"}},","),t("span",{style:{color:"#79B8FF"}},"null"),t("span",{style:{color:"#E1E4E8"}},")")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"第三次循环，e 是 ("),t("span",{style:{color:"#79B8FF"}},"1"),t("span",{style:{color:"#E1E4E8"}},","),t("span",{style:{color:"#79B8FF"}},"null"),t("span",{style:{color:"#E1E4E8"}},")，而 next 是 "),t("span",{style:{color:"#79B8FF"}},"null"),t("span",{style:{color:"#E1E4E8"}},"，但 e 被放入链表头，这样 e.next 变成了 "),t("span",{style:{color:"#79B8FF"}},"35"),t("span",{style:{color:"#E1E4E8"}}," （"),t("span",{style:{color:"#79B8FF"}},"2"),t("span",{style:{color:"#E1E4E8"}}," 处）")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"["),t("span",{style:{color:"#79B8FF"}},"1"),t("span",{style:{color:"#E1E4E8"}},"] ("),t("span",{style:{color:"#79B8FF"}},"1"),t("span",{style:{color:"#E1E4E8"}},","),t("span",{style:{color:"#79B8FF"}},"35"),t("span",{style:{color:"#E1E4E8"}},")"),t("span",{style:{color:"#F97583"}},"->"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#79B8FF"}},"35"),t("span",{style:{color:"#E1E4E8"}},","),t("span",{style:{color:"#79B8FF"}},"1"),t("span",{style:{color:"#E1E4E8"}},")"),t("span",{style:{color:"#F97583"}},"->"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#79B8FF"}},"1"),t("span",{style:{color:"#E1E4E8"}},","),t("span",{style:{color:"#79B8FF"}},"35"),t("span",{style:{color:"#E1E4E8"}},")")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"已经是死链了")])])]),t("pre",{class:"shiki github-light vp-code-light"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"原始链表，格式：[下标] (key,next)")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"["),t("span",{style:{color:"#005CC5"}},"1"),t("span",{style:{color:"#24292E"}},"] ("),t("span",{style:{color:"#005CC5"}},"1"),t("span",{style:{color:"#24292E"}},","),t("span",{style:{color:"#005CC5"}},"35"),t("span",{style:{color:"#24292E"}},")"),t("span",{style:{color:"#D73A49"}},"->"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#005CC5"}},"35"),t("span",{style:{color:"#24292E"}},","),t("span",{style:{color:"#005CC5"}},"16"),t("span",{style:{color:"#24292E"}},")"),t("span",{style:{color:"#D73A49"}},"->"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#005CC5"}},"16"),t("span",{style:{color:"#24292E"}},","),t("span",{style:{color:"#005CC5"}},"null"),t("span",{style:{color:"#24292E"}},")")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"线程 a 执行到 "),t("span",{style:{color:"#005CC5"}},"1"),t("span",{style:{color:"#24292E"}}," 处 ，此时局部变量 e 为 ("),t("span",{style:{color:"#005CC5"}},"1"),t("span",{style:{color:"#24292E"}},","),t("span",{style:{color:"#005CC5"}},"35"),t("span",{style:{color:"#24292E"}},")，而局部变量 next 为 ("),t("span",{style:{color:"#005CC5"}},"35"),t("span",{style:{color:"#24292E"}},","),t("span",{style:{color:"#005CC5"}},"16"),t("span",{style:{color:"#24292E"}},") 线程 a 挂起")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"线程 b 开始执行")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"第一次循环")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"["),t("span",{style:{color:"#005CC5"}},"1"),t("span",{style:{color:"#24292E"}},"] ("),t("span",{style:{color:"#005CC5"}},"1"),t("span",{style:{color:"#24292E"}},","),t("span",{style:{color:"#005CC5"}},"null"),t("span",{style:{color:"#24292E"}},")")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"第二次循环")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"["),t("span",{style:{color:"#005CC5"}},"1"),t("span",{style:{color:"#24292E"}},"] ("),t("span",{style:{color:"#005CC5"}},"35"),t("span",{style:{color:"#24292E"}},","),t("span",{style:{color:"#005CC5"}},"1"),t("span",{style:{color:"#24292E"}},")"),t("span",{style:{color:"#D73A49"}},"->"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#005CC5"}},"1"),t("span",{style:{color:"#24292E"}},","),t("span",{style:{color:"#005CC5"}},"null"),t("span",{style:{color:"#24292E"}},")")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"第三次循环")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"["),t("span",{style:{color:"#005CC5"}},"1"),t("span",{style:{color:"#24292E"}},"] ("),t("span",{style:{color:"#005CC5"}},"35"),t("span",{style:{color:"#24292E"}},","),t("span",{style:{color:"#005CC5"}},"1"),t("span",{style:{color:"#24292E"}},")"),t("span",{style:{color:"#D73A49"}},"->"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#005CC5"}},"1"),t("span",{style:{color:"#24292E"}},","),t("span",{style:{color:"#005CC5"}},"null"),t("span",{style:{color:"#24292E"}},")")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"["),t("span",{style:{color:"#005CC5"}},"17"),t("span",{style:{color:"#24292E"}},"] ("),t("span",{style:{color:"#005CC5"}},"16"),t("span",{style:{color:"#24292E"}},","),t("span",{style:{color:"#005CC5"}},"null"),t("span",{style:{color:"#24292E"}},")")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"切换回线程 a，此时局部变量 e 和 next 被恢复，引用没变但内容变了：e 的内容被改为 ("),t("span",{style:{color:"#005CC5"}},"1"),t("span",{style:{color:"#24292E"}},","),t("span",{style:{color:"#005CC5"}},"null"),t("span",{style:{color:"#24292E"}},")，而 next 的内")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"容被改为 ("),t("span",{style:{color:"#005CC5"}},"35"),t("span",{style:{color:"#24292E"}},","),t("span",{style:{color:"#005CC5"}},"1"),t("span",{style:{color:"#24292E"}},") 并链向 ("),t("span",{style:{color:"#005CC5"}},"1"),t("span",{style:{color:"#24292E"}},","),t("span",{style:{color:"#005CC5"}},"null"),t("span",{style:{color:"#24292E"}},")")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"第一次循环")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"["),t("span",{style:{color:"#005CC5"}},"1"),t("span",{style:{color:"#24292E"}},"] ("),t("span",{style:{color:"#005CC5"}},"1"),t("span",{style:{color:"#24292E"}},","),t("span",{style:{color:"#005CC5"}},"null"),t("span",{style:{color:"#24292E"}},")")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"第二次循环，注意这时 e 是 ("),t("span",{style:{color:"#005CC5"}},"35"),t("span",{style:{color:"#24292E"}},","),t("span",{style:{color:"#005CC5"}},"1"),t("span",{style:{color:"#24292E"}},") 并链向 ("),t("span",{style:{color:"#005CC5"}},"1"),t("span",{style:{color:"#24292E"}},","),t("span",{style:{color:"#005CC5"}},"null"),t("span",{style:{color:"#24292E"}},") 所以 next 又是 ("),t("span",{style:{color:"#005CC5"}},"1"),t("span",{style:{color:"#24292E"}},","),t("span",{style:{color:"#005CC5"}},"null"),t("span",{style:{color:"#24292E"}},")")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"["),t("span",{style:{color:"#005CC5"}},"1"),t("span",{style:{color:"#24292E"}},"] ("),t("span",{style:{color:"#005CC5"}},"35"),t("span",{style:{color:"#24292E"}},","),t("span",{style:{color:"#005CC5"}},"1"),t("span",{style:{color:"#24292E"}},")"),t("span",{style:{color:"#D73A49"}},"->"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#005CC5"}},"1"),t("span",{style:{color:"#24292E"}},","),t("span",{style:{color:"#005CC5"}},"null"),t("span",{style:{color:"#24292E"}},")")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"第三次循环，e 是 ("),t("span",{style:{color:"#005CC5"}},"1"),t("span",{style:{color:"#24292E"}},","),t("span",{style:{color:"#005CC5"}},"null"),t("span",{style:{color:"#24292E"}},")，而 next 是 "),t("span",{style:{color:"#005CC5"}},"null"),t("span",{style:{color:"#24292E"}},"，但 e 被放入链表头，这样 e.next 变成了 "),t("span",{style:{color:"#005CC5"}},"35"),t("span",{style:{color:"#24292E"}}," （"),t("span",{style:{color:"#005CC5"}},"2"),t("span",{style:{color:"#24292E"}}," 处）")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"["),t("span",{style:{color:"#005CC5"}},"1"),t("span",{style:{color:"#24292E"}},"] ("),t("span",{style:{color:"#005CC5"}},"1"),t("span",{style:{color:"#24292E"}},","),t("span",{style:{color:"#005CC5"}},"35"),t("span",{style:{color:"#24292E"}},")"),t("span",{style:{color:"#D73A49"}},"->"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#005CC5"}},"35"),t("span",{style:{color:"#24292E"}},","),t("span",{style:{color:"#005CC5"}},"1"),t("span",{style:{color:"#24292E"}},")"),t("span",{style:{color:"#D73A49"}},"->"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#005CC5"}},"1"),t("span",{style:{color:"#24292E"}},","),t("span",{style:{color:"#005CC5"}},"35"),t("span",{style:{color:"#24292E"}},")")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"已经是死链了")])])])],-1),Zt={id:"小结",tabindex:"-1"},$t=t("ul",null,[t("li",null,"究其原因，是因为在多线程环境下使用了非线程安全的 map 集合"),t("li",null,"JDK 8 虽然将扩容算法做了调整，不再将元素加入链表头（而是保持与扩容前一样的顺序），但仍不意味着能够在多线程环境下能够安全扩容，还会出现其它问题（如扩容丢数据）")],-1),sp={id:"jdk-8-concurrenthashmap",tabindex:"-1"},lp={id:"重要属性和内部类",tabindex:"-1"},op=t("div",{class:"language-java"},[t("button",{title:"Copy Code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki github-dark vp-code-dark"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// 默认为 0")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// 当初始化时, 为 -1")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// 当扩容时, 为 -(1 + 扩容线程数)")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// 当初始化或扩容完成后，为 下一次的扩容的阈值大小")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"private"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"transient"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"volatile"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," sizeCtl;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// 整个 ConcurrentHashMap 就是一个 Node[]")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"static"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"class"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"Node"),t("span",{style:{color:"#E1E4E8"}},"<"),t("span",{style:{color:"#F97583"}},"K"),t("span",{style:{color:"#E1E4E8"}},","),t("span",{style:{color:"#F97583"}},"V"),t("span",{style:{color:"#E1E4E8"}},"> "),t("span",{style:{color:"#F97583"}},"implements"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"Map.Entry"),t("span",{style:{color:"#E1E4E8"}},"<"),t("span",{style:{color:"#F97583"}},"K"),t("span",{style:{color:"#E1E4E8"}},","),t("span",{style:{color:"#F97583"}},"V"),t("span",{style:{color:"#E1E4E8"}},"> {}")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// hash 表")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"transient"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"volatile"),t("span",{style:{color:"#E1E4E8"}}," Node<"),t("span",{style:{color:"#F97583"}},"K"),t("span",{style:{color:"#E1E4E8"}},","),t("span",{style:{color:"#F97583"}},"V"),t("span",{style:{color:"#E1E4E8"}},">[] table;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// 扩容时的 新 hash 表")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"private"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"transient"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"volatile"),t("span",{style:{color:"#E1E4E8"}}," Node<"),t("span",{style:{color:"#F97583"}},"K"),t("span",{style:{color:"#E1E4E8"}},","),t("span",{style:{color:"#F97583"}},"V"),t("span",{style:{color:"#E1E4E8"}},">[] nextTable;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// 扩容时如果某个 bin 迁移完毕, 用 ForwardingNode 作为旧 table bin 的头结点")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"static"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"final"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"class"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"ForwardingNode"),t("span",{style:{color:"#E1E4E8"}},"<"),t("span",{style:{color:"#F97583"}},"K"),t("span",{style:{color:"#E1E4E8"}},","),t("span",{style:{color:"#F97583"}},"V"),t("span",{style:{color:"#E1E4E8"}},"> "),t("span",{style:{color:"#F97583"}},"extends"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"Node"),t("span",{style:{color:"#E1E4E8"}},"<"),t("span",{style:{color:"#F97583"}},"K"),t("span",{style:{color:"#E1E4E8"}},","),t("span",{style:{color:"#F97583"}},"V"),t("span",{style:{color:"#E1E4E8"}},"> {}")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// 用在 compute 以及 computeIfAbsent 时, 用来占位, 计算完成后替换为普通 Node")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"static"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"final"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"class"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"ReservationNode"),t("span",{style:{color:"#E1E4E8"}},"<"),t("span",{style:{color:"#F97583"}},"K"),t("span",{style:{color:"#E1E4E8"}},","),t("span",{style:{color:"#F97583"}},"V"),t("span",{style:{color:"#E1E4E8"}},"> "),t("span",{style:{color:"#F97583"}},"extends"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"Node"),t("span",{style:{color:"#E1E4E8"}},"<"),t("span",{style:{color:"#F97583"}},"K"),t("span",{style:{color:"#E1E4E8"}},","),t("span",{style:{color:"#F97583"}},"V"),t("span",{style:{color:"#E1E4E8"}},"> {}")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// 作为 treebin 的头节点, 存储 root 和 first")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"static"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"final"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"class"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"TreeBin"),t("span",{style:{color:"#E1E4E8"}},"<"),t("span",{style:{color:"#F97583"}},"K"),t("span",{style:{color:"#E1E4E8"}},","),t("span",{style:{color:"#F97583"}},"V"),t("span",{style:{color:"#E1E4E8"}},"> "),t("span",{style:{color:"#F97583"}},"extends"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"Node"),t("span",{style:{color:"#E1E4E8"}},"<"),t("span",{style:{color:"#F97583"}},"K"),t("span",{style:{color:"#E1E4E8"}},","),t("span",{style:{color:"#F97583"}},"V"),t("span",{style:{color:"#E1E4E8"}},"> {}")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// 作为 treebin 的节点, 存储 parent, left, right")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"static"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"final"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"class"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"TreeNode"),t("span",{style:{color:"#E1E4E8"}},"<"),t("span",{style:{color:"#F97583"}},"K"),t("span",{style:{color:"#E1E4E8"}},","),t("span",{style:{color:"#F97583"}},"V"),t("span",{style:{color:"#E1E4E8"}},"> "),t("span",{style:{color:"#F97583"}},"extends"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"Node"),t("span",{style:{color:"#E1E4E8"}},"<"),t("span",{style:{color:"#F97583"}},"K"),t("span",{style:{color:"#E1E4E8"}},","),t("span",{style:{color:"#F97583"}},"V"),t("span",{style:{color:"#E1E4E8"}},"> {}")])])]),t("pre",{class:"shiki github-light vp-code-light"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// 默认为 0")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// 当初始化时, 为 -1")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// 当扩容时, 为 -(1 + 扩容线程数)")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// 当初始化或扩容完成后，为 下一次的扩容的阈值大小")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"private"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"transient"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"volatile"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," sizeCtl;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// 整个 ConcurrentHashMap 就是一个 Node[]")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"static"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"class"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"Node"),t("span",{style:{color:"#24292E"}},"<"),t("span",{style:{color:"#D73A49"}},"K"),t("span",{style:{color:"#24292E"}},","),t("span",{style:{color:"#D73A49"}},"V"),t("span",{style:{color:"#24292E"}},"> "),t("span",{style:{color:"#D73A49"}},"implements"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"Map.Entry"),t("span",{style:{color:"#24292E"}},"<"),t("span",{style:{color:"#D73A49"}},"K"),t("span",{style:{color:"#24292E"}},","),t("span",{style:{color:"#D73A49"}},"V"),t("span",{style:{color:"#24292E"}},"> {}")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// hash 表")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"transient"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"volatile"),t("span",{style:{color:"#24292E"}}," Node<"),t("span",{style:{color:"#D73A49"}},"K"),t("span",{style:{color:"#24292E"}},","),t("span",{style:{color:"#D73A49"}},"V"),t("span",{style:{color:"#24292E"}},">[] table;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// 扩容时的 新 hash 表")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"private"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"transient"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"volatile"),t("span",{style:{color:"#24292E"}}," Node<"),t("span",{style:{color:"#D73A49"}},"K"),t("span",{style:{color:"#24292E"}},","),t("span",{style:{color:"#D73A49"}},"V"),t("span",{style:{color:"#24292E"}},">[] nextTable;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// 扩容时如果某个 bin 迁移完毕, 用 ForwardingNode 作为旧 table bin 的头结点")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"static"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"final"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"class"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"ForwardingNode"),t("span",{style:{color:"#24292E"}},"<"),t("span",{style:{color:"#D73A49"}},"K"),t("span",{style:{color:"#24292E"}},","),t("span",{style:{color:"#D73A49"}},"V"),t("span",{style:{color:"#24292E"}},"> "),t("span",{style:{color:"#D73A49"}},"extends"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"Node"),t("span",{style:{color:"#24292E"}},"<"),t("span",{style:{color:"#D73A49"}},"K"),t("span",{style:{color:"#24292E"}},","),t("span",{style:{color:"#D73A49"}},"V"),t("span",{style:{color:"#24292E"}},"> {}")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// 用在 compute 以及 computeIfAbsent 时, 用来占位, 计算完成后替换为普通 Node")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"static"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"final"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"class"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"ReservationNode"),t("span",{style:{color:"#24292E"}},"<"),t("span",{style:{color:"#D73A49"}},"K"),t("span",{style:{color:"#24292E"}},","),t("span",{style:{color:"#D73A49"}},"V"),t("span",{style:{color:"#24292E"}},"> "),t("span",{style:{color:"#D73A49"}},"extends"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"Node"),t("span",{style:{color:"#24292E"}},"<"),t("span",{style:{color:"#D73A49"}},"K"),t("span",{style:{color:"#24292E"}},","),t("span",{style:{color:"#D73A49"}},"V"),t("span",{style:{color:"#24292E"}},"> {}")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// 作为 treebin 的头节点, 存储 root 和 first")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"static"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"final"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"class"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"TreeBin"),t("span",{style:{color:"#24292E"}},"<"),t("span",{style:{color:"#D73A49"}},"K"),t("span",{style:{color:"#24292E"}},","),t("span",{style:{color:"#D73A49"}},"V"),t("span",{style:{color:"#24292E"}},"> "),t("span",{style:{color:"#D73A49"}},"extends"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"Node"),t("span",{style:{color:"#24292E"}},"<"),t("span",{style:{color:"#D73A49"}},"K"),t("span",{style:{color:"#24292E"}},","),t("span",{style:{color:"#D73A49"}},"V"),t("span",{style:{color:"#24292E"}},"> {}")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// 作为 treebin 的节点, 存储 parent, left, right")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"static"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"final"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"class"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"TreeNode"),t("span",{style:{color:"#24292E"}},"<"),t("span",{style:{color:"#D73A49"}},"K"),t("span",{style:{color:"#24292E"}},","),t("span",{style:{color:"#D73A49"}},"V"),t("span",{style:{color:"#24292E"}},"> "),t("span",{style:{color:"#D73A49"}},"extends"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"Node"),t("span",{style:{color:"#24292E"}},"<"),t("span",{style:{color:"#D73A49"}},"K"),t("span",{style:{color:"#24292E"}},","),t("span",{style:{color:"#D73A49"}},"V"),t("span",{style:{color:"#24292E"}},"> {}")])])])],-1),np=t("blockquote",null,[t("p",null,"sizeCtl：sizeControll，作用于扩容，第一次hash表的数组初始化时设为-1，即数组是懒惰初始化的，刚开始的数组是没有初始化的，当第一次用到数组时才初始化"),t("p",null,"Node<K,V>：hash表的链表结构由此方法来完成，k，v，hash，next...")],-1),ap={id:"重要方法",tabindex:"-1"},ep=t("div",{class:"language-java"},[t("button",{title:"Copy Code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki github-dark vp-code-dark"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// 获取 Node[] 中第 i 个 Node")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"static"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"final"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"<"),t("span",{style:{color:"#E1E4E8"}},"K,V"),t("span",{style:{color:"#F97583"}},">"),t("span",{style:{color:"#E1E4E8"}}," Node"),t("span",{style:{color:"#F97583"}},"<"),t("span",{style:{color:"#E1E4E8"}},"K,V"),t("span",{style:{color:"#F97583"}},">"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"tabAt"),t("span",{style:{color:"#E1E4E8"}},"(Node"),t("span",{style:{color:"#F97583"}},"<"),t("span",{style:{color:"#E1E4E8"}},"K,V"),t("span",{style:{color:"#F97583"}},">"),t("span",{style:{color:"#E1E4E8"}},"[] tab, "),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," i)")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// cas 修改 Node[] 中第 i 个 Node 的值, c 为旧值, v 为新值")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"static"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"final"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"<"),t("span",{style:{color:"#E1E4E8"}},"K,V"),t("span",{style:{color:"#F97583"}},">"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"boolean"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"casTabAt"),t("span",{style:{color:"#E1E4E8"}},"(Node"),t("span",{style:{color:"#F97583"}},"<"),t("span",{style:{color:"#E1E4E8"}},"K,V"),t("span",{style:{color:"#F97583"}},">"),t("span",{style:{color:"#E1E4E8"}},"[] tab, "),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," i, Node"),t("span",{style:{color:"#F97583"}},"<"),t("span",{style:{color:"#E1E4E8"}},"K,V"),t("span",{style:{color:"#F97583"}},">"),t("span",{style:{color:"#E1E4E8"}}," c, Node"),t("span",{style:{color:"#F97583"}},"<"),t("span",{style:{color:"#E1E4E8"}},"K,V"),t("span",{style:{color:"#F97583"}},">"),t("span",{style:{color:"#E1E4E8"}}," v)")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// 直接修改 Node[] 中第 i 个 Node 的值, v 为新值")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"static"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"final"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"<"),t("span",{style:{color:"#E1E4E8"}},"K,V"),t("span",{style:{color:"#F97583"}},">"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"void"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"setTabAt"),t("span",{style:{color:"#E1E4E8"}},"(Node"),t("span",{style:{color:"#F97583"}},"<"),t("span",{style:{color:"#E1E4E8"}},"K,V"),t("span",{style:{color:"#F97583"}},">"),t("span",{style:{color:"#E1E4E8"}},"[] tab, "),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," i, Node"),t("span",{style:{color:"#F97583"}},"<"),t("span",{style:{color:"#E1E4E8"}},"K,V"),t("span",{style:{color:"#F97583"}},">"),t("span",{style:{color:"#E1E4E8"}}," v)")])])]),t("pre",{class:"shiki github-light vp-code-light"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// 获取 Node[] 中第 i 个 Node")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"static"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"final"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"<"),t("span",{style:{color:"#24292E"}},"K,V"),t("span",{style:{color:"#D73A49"}},">"),t("span",{style:{color:"#24292E"}}," Node"),t("span",{style:{color:"#D73A49"}},"<"),t("span",{style:{color:"#24292E"}},"K,V"),t("span",{style:{color:"#D73A49"}},">"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"tabAt"),t("span",{style:{color:"#24292E"}},"(Node"),t("span",{style:{color:"#D73A49"}},"<"),t("span",{style:{color:"#24292E"}},"K,V"),t("span",{style:{color:"#D73A49"}},">"),t("span",{style:{color:"#24292E"}},"[] tab, "),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," i)")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// cas 修改 Node[] 中第 i 个 Node 的值, c 为旧值, v 为新值")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"static"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"final"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"<"),t("span",{style:{color:"#24292E"}},"K,V"),t("span",{style:{color:"#D73A49"}},">"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"boolean"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"casTabAt"),t("span",{style:{color:"#24292E"}},"(Node"),t("span",{style:{color:"#D73A49"}},"<"),t("span",{style:{color:"#24292E"}},"K,V"),t("span",{style:{color:"#D73A49"}},">"),t("span",{style:{color:"#24292E"}},"[] tab, "),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," i, Node"),t("span",{style:{color:"#D73A49"}},"<"),t("span",{style:{color:"#24292E"}},"K,V"),t("span",{style:{color:"#D73A49"}},">"),t("span",{style:{color:"#24292E"}}," c, Node"),t("span",{style:{color:"#D73A49"}},"<"),t("span",{style:{color:"#24292E"}},"K,V"),t("span",{style:{color:"#D73A49"}},">"),t("span",{style:{color:"#24292E"}}," v)")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// 直接修改 Node[] 中第 i 个 Node 的值, v 为新值")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"static"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"final"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"<"),t("span",{style:{color:"#24292E"}},"K,V"),t("span",{style:{color:"#D73A49"}},">"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"void"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"setTabAt"),t("span",{style:{color:"#24292E"}},"(Node"),t("span",{style:{color:"#D73A49"}},"<"),t("span",{style:{color:"#24292E"}},"K,V"),t("span",{style:{color:"#D73A49"}},">"),t("span",{style:{color:"#24292E"}},"[] tab, "),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," i, Node"),t("span",{style:{color:"#D73A49"}},"<"),t("span",{style:{color:"#24292E"}},"K,V"),t("span",{style:{color:"#D73A49"}},">"),t("span",{style:{color:"#24292E"}}," v)")])])])],-1),cp={id:"构造器分析",tabindex:"-1"},tp=t("p",null,"可以看到实现了懒惰初始化，在构造方法中仅仅计算了 table 的大小，以后在第一次使用时才会真正创建",-1),pp=t("div",{class:"language-java"},[t("button",{title:"Copy Code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki github-dark vp-code-dark"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"public"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"ConcurrentHashMap"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," initialCapacity, "),t("span",{style:{color:"#F97583"}},"float"),t("span",{style:{color:"#E1E4E8"}}," loadFactor, "),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," concurrencyLevel) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," ("),t("span",{style:{color:"#F97583"}},"!"),t("span",{style:{color:"#E1E4E8"}},"(loadFactor "),t("span",{style:{color:"#F97583"}},">"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"0.0f"),t("span",{style:{color:"#E1E4E8"}},") "),t("span",{style:{color:"#F97583"}},"||"),t("span",{style:{color:"#E1E4E8"}}," initialCapacity "),t("span",{style:{color:"#F97583"}},"<"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"0"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"||"),t("span",{style:{color:"#E1E4E8"}}," concurrencyLevel "),t("span",{style:{color:"#F97583"}},"<="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"0"),t("span",{style:{color:"#E1E4E8"}},")")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"   \t \t"),t("span",{style:{color:"#F97583"}},"throw"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"new"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"IllegalArgumentException"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (initialCapacity "),t("span",{style:{color:"#F97583"}},"<"),t("span",{style:{color:"#E1E4E8"}}," concurrencyLevel) "),t("span",{style:{color:"#6A737D"}},"// Use at least as many bins")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    \tinitialCapacity "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," concurrencyLevel; "),t("span",{style:{color:"#6A737D"}},"// as estimated threads")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"long"),t("span",{style:{color:"#E1E4E8"}}," size "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," ("),t("span",{style:{color:"#F97583"}},"long"),t("span",{style:{color:"#E1E4E8"}},")("),t("span",{style:{color:"#79B8FF"}},"1.0"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"+"),t("span",{style:{color:"#E1E4E8"}}," ("),t("span",{style:{color:"#F97583"}},"long"),t("span",{style:{color:"#E1E4E8"}},")initialCapacity "),t("span",{style:{color:"#F97583"}},"/"),t("span",{style:{color:"#E1E4E8"}}," loadFactor);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// tableSizeFor 仍然是保证计算的大小是 2^n, 即 16,32,64 ...")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," cap "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," (size "),t("span",{style:{color:"#F97583"}},">="),t("span",{style:{color:"#E1E4E8"}}," ("),t("span",{style:{color:"#F97583"}},"long"),t("span",{style:{color:"#E1E4E8"}},")MAXIMUM_CAPACITY) "),t("span",{style:{color:"#F97583"}},"?")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    \tMAXIMUM_CAPACITY "),t("span",{style:{color:"#F97583"}},":"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"tableSizeFor"),t("span",{style:{color:"#E1E4E8"}},"(("),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}},")size);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#79B8FF"}},"this"),t("span",{style:{color:"#E1E4E8"}},".sizeCtl "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," cap;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"}")])])]),t("pre",{class:"shiki github-light vp-code-light"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"public"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"ConcurrentHashMap"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," initialCapacity, "),t("span",{style:{color:"#D73A49"}},"float"),t("span",{style:{color:"#24292E"}}," loadFactor, "),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," concurrencyLevel) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," ("),t("span",{style:{color:"#D73A49"}},"!"),t("span",{style:{color:"#24292E"}},"(loadFactor "),t("span",{style:{color:"#D73A49"}},">"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"0.0f"),t("span",{style:{color:"#24292E"}},") "),t("span",{style:{color:"#D73A49"}},"||"),t("span",{style:{color:"#24292E"}}," initialCapacity "),t("span",{style:{color:"#D73A49"}},"<"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"0"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"||"),t("span",{style:{color:"#24292E"}}," concurrencyLevel "),t("span",{style:{color:"#D73A49"}},"<="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"0"),t("span",{style:{color:"#24292E"}},")")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"   \t \t"),t("span",{style:{color:"#D73A49"}},"throw"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"new"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"IllegalArgumentException"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (initialCapacity "),t("span",{style:{color:"#D73A49"}},"<"),t("span",{style:{color:"#24292E"}}," concurrencyLevel) "),t("span",{style:{color:"#6A737D"}},"// Use at least as many bins")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    \tinitialCapacity "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," concurrencyLevel; "),t("span",{style:{color:"#6A737D"}},"// as estimated threads")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"long"),t("span",{style:{color:"#24292E"}}," size "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," ("),t("span",{style:{color:"#D73A49"}},"long"),t("span",{style:{color:"#24292E"}},")("),t("span",{style:{color:"#005CC5"}},"1.0"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"+"),t("span",{style:{color:"#24292E"}}," ("),t("span",{style:{color:"#D73A49"}},"long"),t("span",{style:{color:"#24292E"}},")initialCapacity "),t("span",{style:{color:"#D73A49"}},"/"),t("span",{style:{color:"#24292E"}}," loadFactor);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// tableSizeFor 仍然是保证计算的大小是 2^n, 即 16,32,64 ...")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," cap "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," (size "),t("span",{style:{color:"#D73A49"}},">="),t("span",{style:{color:"#24292E"}}," ("),t("span",{style:{color:"#D73A49"}},"long"),t("span",{style:{color:"#24292E"}},")MAXIMUM_CAPACITY) "),t("span",{style:{color:"#D73A49"}},"?")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    \tMAXIMUM_CAPACITY "),t("span",{style:{color:"#D73A49"}},":"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"tableSizeFor"),t("span",{style:{color:"#24292E"}},"(("),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}},")size);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#005CC5"}},"this"),t("span",{style:{color:"#24292E"}},".sizeCtl "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," cap;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"}")])])])],-1),rp=t("blockquote",null,[t("p",null,"initialCapacity：初始容量；loadFactor：扩容因子/负载因子；concurrencyLevel：并发度"),t("p",null,"initialCapacity=8 < concurrencyLevel=16 ->initialCapacity=16"),t("p",null,"当初始容量不是2^n，通过tableSizeFor((int)size也会变为2^n")],-1),Ep={id:"get-流程",tabindex:"-1"},yp=t("div",{class:"language-java"},[t("button",{title:"Copy Code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki github-dark vp-code-dark"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"public"),t("span",{style:{color:"#E1E4E8"}}," V "),t("span",{style:{color:"#B392F0"}},"get"),t("span",{style:{color:"#E1E4E8"}},"(Object key) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    Node<"),t("span",{style:{color:"#F97583"}},"K"),t("span",{style:{color:"#E1E4E8"}},","),t("span",{style:{color:"#F97583"}},"V"),t("span",{style:{color:"#E1E4E8"}},">[] tab; Node<"),t("span",{style:{color:"#F97583"}},"K"),t("span",{style:{color:"#E1E4E8"}},","),t("span",{style:{color:"#F97583"}},"V"),t("span",{style:{color:"#E1E4E8"}},"> e, p; "),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," n, eh; K ek;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// spread 方法能确保返回结果是正数")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," h "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"spread"),t("span",{style:{color:"#E1E4E8"}},"(key."),t("span",{style:{color:"#B392F0"}},"hashCode"),t("span",{style:{color:"#E1E4E8"}},"());")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," ((tab "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," table) "),t("span",{style:{color:"#F97583"}},"!="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"null"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"&&"),t("span",{style:{color:"#E1E4E8"}}," (n "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," tab.length) "),t("span",{style:{color:"#F97583"}},">"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"0"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"&&")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        (e "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"tabAt"),t("span",{style:{color:"#E1E4E8"}},"(tab, (n "),t("span",{style:{color:"#F97583"}},"-"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"1"),t("span",{style:{color:"#E1E4E8"}},") "),t("span",{style:{color:"#F97583"}},"&"),t("span",{style:{color:"#E1E4E8"}}," h)) "),t("span",{style:{color:"#F97583"}},"!="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"null"),t("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#6A737D"}},"// 如果头结点已经是要查找的 key")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," ((eh "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," e.hash) "),t("span",{style:{color:"#F97583"}},"=="),t("span",{style:{color:"#E1E4E8"}}," h) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," ((ek "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," e.key) "),t("span",{style:{color:"#F97583"}},"=="),t("span",{style:{color:"#E1E4E8"}}," key "),t("span",{style:{color:"#F97583"}},"||"),t("span",{style:{color:"#E1E4E8"}}," (ek "),t("span",{style:{color:"#F97583"}},"!="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"null"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"&&"),t("span",{style:{color:"#E1E4E8"}}," key."),t("span",{style:{color:"#B392F0"}},"equals"),t("span",{style:{color:"#E1E4E8"}},"(ek)))")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            \t"),t("span",{style:{color:"#F97583"}},"return"),t("span",{style:{color:"#E1E4E8"}}," e.val;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#6A737D"}},"// hash 为负数表示该 bin 在扩容中或是 treebin, 这时调用 find 方法来查找")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"else"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (eh "),t("span",{style:{color:"#F97583"}},"<"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"0"),t("span",{style:{color:"#E1E4E8"}},")")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        \t"),t("span",{style:{color:"#F97583"}},"return"),t("span",{style:{color:"#E1E4E8"}}," (p "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," e."),t("span",{style:{color:"#B392F0"}},"find"),t("span",{style:{color:"#E1E4E8"}},"(h, key)) "),t("span",{style:{color:"#F97583"}},"!="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"null"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"?"),t("span",{style:{color:"#E1E4E8"}}," p.val "),t("span",{style:{color:"#F97583"}},":"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"null"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#6A737D"}},"// 正常遍历链表, 用 equals 比较")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"while"),t("span",{style:{color:"#E1E4E8"}}," ((e "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," e.next) "),t("span",{style:{color:"#F97583"}},"!="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"null"),t("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (e.hash "),t("span",{style:{color:"#F97583"}},"=="),t("span",{style:{color:"#E1E4E8"}}," h "),t("span",{style:{color:"#F97583"}},"&&")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                ((ek "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," e.key) "),t("span",{style:{color:"#F97583"}},"=="),t("span",{style:{color:"#E1E4E8"}}," key "),t("span",{style:{color:"#F97583"}},"||"),t("span",{style:{color:"#E1E4E8"}}," (ek "),t("span",{style:{color:"#F97583"}},"!="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"null"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"&&"),t("span",{style:{color:"#E1E4E8"}}," key."),t("span",{style:{color:"#B392F0"}},"equals"),t("span",{style:{color:"#E1E4E8"}},"(ek))))")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#F97583"}},"return"),t("span",{style:{color:"#E1E4E8"}}," e.val;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"return"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"null"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"}")])])]),t("pre",{class:"shiki github-light vp-code-light"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"public"),t("span",{style:{color:"#24292E"}}," V "),t("span",{style:{color:"#6F42C1"}},"get"),t("span",{style:{color:"#24292E"}},"(Object key) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    Node<"),t("span",{style:{color:"#D73A49"}},"K"),t("span",{style:{color:"#24292E"}},","),t("span",{style:{color:"#D73A49"}},"V"),t("span",{style:{color:"#24292E"}},">[] tab; Node<"),t("span",{style:{color:"#D73A49"}},"K"),t("span",{style:{color:"#24292E"}},","),t("span",{style:{color:"#D73A49"}},"V"),t("span",{style:{color:"#24292E"}},"> e, p; "),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," n, eh; K ek;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// spread 方法能确保返回结果是正数")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," h "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"spread"),t("span",{style:{color:"#24292E"}},"(key."),t("span",{style:{color:"#6F42C1"}},"hashCode"),t("span",{style:{color:"#24292E"}},"());")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," ((tab "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," table) "),t("span",{style:{color:"#D73A49"}},"!="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"null"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"&&"),t("span",{style:{color:"#24292E"}}," (n "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," tab.length) "),t("span",{style:{color:"#D73A49"}},">"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"0"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"&&")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        (e "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"tabAt"),t("span",{style:{color:"#24292E"}},"(tab, (n "),t("span",{style:{color:"#D73A49"}},"-"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"1"),t("span",{style:{color:"#24292E"}},") "),t("span",{style:{color:"#D73A49"}},"&"),t("span",{style:{color:"#24292E"}}," h)) "),t("span",{style:{color:"#D73A49"}},"!="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"null"),t("span",{style:{color:"#24292E"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6A737D"}},"// 如果头结点已经是要查找的 key")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," ((eh "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," e.hash) "),t("span",{style:{color:"#D73A49"}},"=="),t("span",{style:{color:"#24292E"}}," h) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," ((ek "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," e.key) "),t("span",{style:{color:"#D73A49"}},"=="),t("span",{style:{color:"#24292E"}}," key "),t("span",{style:{color:"#D73A49"}},"||"),t("span",{style:{color:"#24292E"}}," (ek "),t("span",{style:{color:"#D73A49"}},"!="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"null"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"&&"),t("span",{style:{color:"#24292E"}}," key."),t("span",{style:{color:"#6F42C1"}},"equals"),t("span",{style:{color:"#24292E"}},"(ek)))")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            \t"),t("span",{style:{color:"#D73A49"}},"return"),t("span",{style:{color:"#24292E"}}," e.val;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6A737D"}},"// hash 为负数表示该 bin 在扩容中或是 treebin, 这时调用 find 方法来查找")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"else"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (eh "),t("span",{style:{color:"#D73A49"}},"<"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"0"),t("span",{style:{color:"#24292E"}},")")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        \t"),t("span",{style:{color:"#D73A49"}},"return"),t("span",{style:{color:"#24292E"}}," (p "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," e."),t("span",{style:{color:"#6F42C1"}},"find"),t("span",{style:{color:"#24292E"}},"(h, key)) "),t("span",{style:{color:"#D73A49"}},"!="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"null"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"?"),t("span",{style:{color:"#24292E"}}," p.val "),t("span",{style:{color:"#D73A49"}},":"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"null"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6A737D"}},"// 正常遍历链表, 用 equals 比较")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"while"),t("span",{style:{color:"#24292E"}}," ((e "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," e.next) "),t("span",{style:{color:"#D73A49"}},"!="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"null"),t("span",{style:{color:"#24292E"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (e.hash "),t("span",{style:{color:"#D73A49"}},"=="),t("span",{style:{color:"#24292E"}}," h "),t("span",{style:{color:"#D73A49"}},"&&")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                ((ek "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," e.key) "),t("span",{style:{color:"#D73A49"}},"=="),t("span",{style:{color:"#24292E"}}," key "),t("span",{style:{color:"#D73A49"}},"||"),t("span",{style:{color:"#24292E"}}," (ek "),t("span",{style:{color:"#D73A49"}},"!="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"null"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"&&"),t("span",{style:{color:"#24292E"}}," key."),t("span",{style:{color:"#6F42C1"}},"equals"),t("span",{style:{color:"#24292E"}},"(ek))))")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#D73A49"}},"return"),t("span",{style:{color:"#24292E"}}," e.val;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"return"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"null"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"}")])])])],-1),ip=t("blockquote",null,[t("p",null,"get方法全程没有加锁，性能高；h是真正去get/put用到的key的hash码"),t("p",null,[t("code",null,"e = tabAt(tab, (n - 1) & h"),p(" 找到桶下标的头节点")]),t("p",null,[t("code",null,"(eh = e.hash) == h"),p("：头节点的hash是否为要找的key的hash；若hash一样再判断是否为同一对象，是则直接返回")]),t("p",null,[t("code",null,"eh < 0"),p("：头节点hash为负数：1、链表在扩容当中，会把扩容栏里的链表头部变为forwardingNode，其取值就是负数，调用其find方法到新的table里去找你的key；"),t("img",{src:"https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230720145239444.png",alt:"image-20230720145239444"})]),t("p",null,"2、当节点为树节点时，treebin节点也覆盖了find方法"),t("figure",null,[t("img",{src:"https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230720145605684.png",alt:"image-20230720145605684",loading:"lazy",decoding:"async"})]),t("p",null,"其他情况正常遍历")],-1),Fp={id:"put-流程",tabindex:"-1"},up=t("p",null,"以下数组简称（table），链表简称（bin）",-1),Ap=t("blockquote",null,[t("p",null,"onlyIfAbsent：true表示只有第一次你put你的键和值时才会将这个键和值放到map中，第二次再put相同的key时就会发现map中已经有了就不会做任何操作，不会用新值覆盖旧值；false就会每次put新值都覆盖掉旧值"),t("p",null,"不允许有空的key或value，否则抛异常；spread保证hash码为正整数"),t("p",null,"懒惰初始化，当第一次put时才创建数组，初始化 table 使用了 cas, 无需 synchronized 创建成功"),t("p",null,"在扩容时，其他线程put的是forwardingNode标记的普通节点（非链表），就会去帮忙扩容，不会干等"),t("p",null,"桶下标冲突时才加synchronized锁；fh >= 0表示普通节点的链表"),t("p",null,"binCount>=0表示桶下标冲突，通过该变量优化链表"),t("p",null,"addCount类似于LongAdder（累加单元cell）原子计数，维护整个hashmap的size计数，如果size计数超过阈值就会发生扩容"),t("p",null,"initTable：懒惰初始化，调用该方法为了保证线程安全，只能让一个线程成功创建hash表，其他线程就不能再创建了；通过CAS操作尝试将sizeCtl设为-1完成初始化创建hash表，未创建hash且未设初始容量则默认为16，然后创建Node数组，并计算下次扩容时的阈值")],-1),dp=t("div",{class:"language-java"},[t("button",{title:"Copy Code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki github-dark vp-code-dark"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"public"),t("span",{style:{color:"#E1E4E8"}}," V "),t("span",{style:{color:"#B392F0"}},"put"),t("span",{style:{color:"#E1E4E8"}},"(K key, V value) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"return"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"putVal"),t("span",{style:{color:"#E1E4E8"}},"(key, value, "),t("span",{style:{color:"#79B8FF"}},"false"),t("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"}")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"final"),t("span",{style:{color:"#E1E4E8"}}," V "),t("span",{style:{color:"#B392F0"}},"putVal"),t("span",{style:{color:"#E1E4E8"}},"(K key, V value, "),t("span",{style:{color:"#F97583"}},"boolean"),t("span",{style:{color:"#E1E4E8"}}," onlyIfAbsent) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (key "),t("span",{style:{color:"#F97583"}},"=="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"null"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"||"),t("span",{style:{color:"#E1E4E8"}}," value "),t("span",{style:{color:"#F97583"}},"=="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"null"),t("span",{style:{color:"#E1E4E8"}},") "),t("span",{style:{color:"#F97583"}},"throw"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"new"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"NullPointerException"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// 其中 spread 方法会综合高位低位, 具有更好的 hash 性")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," hash "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"spread"),t("span",{style:{color:"#E1E4E8"}},"(key."),t("span",{style:{color:"#B392F0"}},"hashCode"),t("span",{style:{color:"#E1E4E8"}},"());")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," binCount "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"0"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"for"),t("span",{style:{color:"#E1E4E8"}}," (Node<"),t("span",{style:{color:"#F97583"}},"K"),t("span",{style:{color:"#E1E4E8"}},","),t("span",{style:{color:"#F97583"}},"V"),t("span",{style:{color:"#E1E4E8"}},">[] tab "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," table;;) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#6A737D"}},"// f 是链表头节点")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#6A737D"}},"// fh 是链表头结点的 hash")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#6A737D"}},"// i 是链表在 table 中的下标")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        Node<"),t("span",{style:{color:"#F97583"}},"K"),t("span",{style:{color:"#E1E4E8"}},","),t("span",{style:{color:"#F97583"}},"V"),t("span",{style:{color:"#E1E4E8"}},"> f; "),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," n, i, fh;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#6A737D"}},"// 要创建 table")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (tab "),t("span",{style:{color:"#F97583"}},"=="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"null"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"||"),t("span",{style:{color:"#E1E4E8"}}," (n "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," tab.length) "),t("span",{style:{color:"#F97583"}},"=="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"0"),t("span",{style:{color:"#E1E4E8"}},")")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#6A737D"}},"// 初始化 table 使用了 cas, 无需 synchronized 创建成功, 进入下一轮循环")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            tab "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"initTable"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#6A737D"}},"// 要创建链表头节点")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"else"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," ((f "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"tabAt"),t("span",{style:{color:"#E1E4E8"}},"(tab, i "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," (n "),t("span",{style:{color:"#F97583"}},"-"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"1"),t("span",{style:{color:"#E1E4E8"}},") "),t("span",{style:{color:"#F97583"}},"&"),t("span",{style:{color:"#E1E4E8"}}," hash)) "),t("span",{style:{color:"#F97583"}},"=="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"null"),t("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#6A737D"}},"// 添加链表头使用了 cas, 无需 synchronized")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," ("),t("span",{style:{color:"#B392F0"}},"casTabAt"),t("span",{style:{color:"#E1E4E8"}},"(tab, i, "),t("span",{style:{color:"#79B8FF"}},"null"),t("span",{style:{color:"#E1E4E8"}},",")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            \t\t"),t("span",{style:{color:"#F97583"}},"new"),t("span",{style:{color:"#E1E4E8"}}," Node<"),t("span",{style:{color:"#F97583"}},"K"),t("span",{style:{color:"#E1E4E8"}},","),t("span",{style:{color:"#F97583"}},"V"),t("span",{style:{color:"#E1E4E8"}},">(hash, key, value, "),t("span",{style:{color:"#79B8FF"}},"null"),t("span",{style:{color:"#E1E4E8"}},")))")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        \t"),t("span",{style:{color:"#F97583"}},"break"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#6A737D"}},"// 帮忙扩容")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"else"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," ((fh "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," f.hash) "),t("span",{style:{color:"#F97583"}},"=="),t("span",{style:{color:"#E1E4E8"}}," MOVED)")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#6A737D"}},"// 帮忙之后, 进入下一轮循环")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            tab "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"helpTransfer"),t("span",{style:{color:"#E1E4E8"}},"(tab, f);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"else"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            V oldVal "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"null"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#6A737D"}},"// 锁住链表头节点")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"synchronized"),t("span",{style:{color:"#E1E4E8"}}," (f) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#6A737D"}},"// 再次确认链表头节点没有被移动")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," ("),t("span",{style:{color:"#B392F0"}},"tabAt"),t("span",{style:{color:"#E1E4E8"}},"(tab, i) "),t("span",{style:{color:"#F97583"}},"=="),t("span",{style:{color:"#E1E4E8"}}," f) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                    "),t("span",{style:{color:"#6A737D"}},"// 链表")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                    "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (fh "),t("span",{style:{color:"#F97583"}},">="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"0"),t("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                        binCount "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"1"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                        "),t("span",{style:{color:"#6A737D"}},"// 遍历链表")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                        "),t("span",{style:{color:"#F97583"}},"for"),t("span",{style:{color:"#E1E4E8"}}," (Node<"),t("span",{style:{color:"#F97583"}},"K"),t("span",{style:{color:"#E1E4E8"}},","),t("span",{style:{color:"#F97583"}},"V"),t("span",{style:{color:"#E1E4E8"}},"> e "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," f;; "),t("span",{style:{color:"#F97583"}},"++"),t("span",{style:{color:"#E1E4E8"}},"binCount) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                            K ek;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                            "),t("span",{style:{color:"#6A737D"}},"// 找到相同的 key")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                            "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (e.hash "),t("span",{style:{color:"#F97583"}},"=="),t("span",{style:{color:"#E1E4E8"}}," hash "),t("span",{style:{color:"#F97583"}},"&&")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                                ((ek "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," e.key) "),t("span",{style:{color:"#F97583"}},"=="),t("span",{style:{color:"#E1E4E8"}}," key "),t("span",{style:{color:"#F97583"}},"||")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                                 (ek "),t("span",{style:{color:"#F97583"}},"!="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"null"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"&&"),t("span",{style:{color:"#E1E4E8"}}," key."),t("span",{style:{color:"#B392F0"}},"equals"),t("span",{style:{color:"#E1E4E8"}},"(ek)))) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                                oldVal "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," e.val;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                                "),t("span",{style:{color:"#6A737D"}},"// 更新")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                                "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," ("),t("span",{style:{color:"#F97583"}},"!"),t("span",{style:{color:"#E1E4E8"}},"onlyIfAbsent)")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                                    "),t("span",{style:{color:"#6A737D"}},"//新值覆盖旧值")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                                     e.val "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," value;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                                "),t("span",{style:{color:"#F97583"}},"break"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                            }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                            Node<"),t("span",{style:{color:"#F97583"}},"K"),t("span",{style:{color:"#E1E4E8"}},","),t("span",{style:{color:"#F97583"}},"V"),t("span",{style:{color:"#E1E4E8"}},"> pred "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," e;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                            ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                            "),t("span",{style:{color:"#6A737D"}},"// 已经是最后的节点了, 新增 Node, 追加至链表尾")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                            "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," ((e "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," e.next) "),t("span",{style:{color:"#F97583"}},"=="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"null"),t("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                                pred.next "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"new"),t("span",{style:{color:"#E1E4E8"}}," Node<"),t("span",{style:{color:"#F97583"}},"K"),t("span",{style:{color:"#E1E4E8"}},","),t("span",{style:{color:"#F97583"}},"V"),t("span",{style:{color:"#E1E4E8"}},">(hash, key,")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                                value, "),t("span",{style:{color:"#79B8FF"}},"null"),t("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                                "),t("span",{style:{color:"#F97583"}},"break"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                            }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                    "),t("span",{style:{color:"#6A737D"}},"// 红黑树")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                    "),t("span",{style:{color:"#F97583"}},"else"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (f "),t("span",{style:{color:"#F97583"}},"instanceof"),t("span",{style:{color:"#E1E4E8"}}," TreeBin) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                        Node<"),t("span",{style:{color:"#F97583"}},"K"),t("span",{style:{color:"#E1E4E8"}},","),t("span",{style:{color:"#F97583"}},"V"),t("span",{style:{color:"#E1E4E8"}},"> p;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                        binCount "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"2"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                        "),t("span",{style:{color:"#6A737D"}},"// putTreeVal 会看 key 是否已经在树中, 是, 则返回对应的 TreeNode")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                        "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," ((p "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," ((TreeBin"),t("span",{style:{color:"#F97583"}},"<"),t("span",{style:{color:"#E1E4E8"}},"K,V"),t("span",{style:{color:"#F97583"}},">"),t("span",{style:{color:"#E1E4E8"}},")f)."),t("span",{style:{color:"#B392F0"}},"putTreeVal"),t("span",{style:{color:"#E1E4E8"}},"(hash, key,")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                                    value)) "),t("span",{style:{color:"#F97583"}},"!="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"null"),t("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                            oldVal "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," p.val;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                            "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," ("),t("span",{style:{color:"#F97583"}},"!"),t("span",{style:{color:"#E1E4E8"}},"onlyIfAbsent)")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                                p.val "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," value;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                \t\t}")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                \t}")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            \t}")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"           "),t("span",{style:{color:"#6A737D"}},"// 释放链表头节点的锁")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"           }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"           "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (binCount "),t("span",{style:{color:"#F97583"}},"!="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"0"),t("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (binCount "),t("span",{style:{color:"#F97583"}},">="),t("span",{style:{color:"#E1E4E8"}}," TREEIFY_THRESHOLD)")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#6A737D"}},"// 如果链表长度 >= 树化阈值(8), 进行链表转为红黑树")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                \t"),t("span",{style:{color:"#B392F0"}},"treeifyBin"),t("span",{style:{color:"#E1E4E8"}},"(tab, i);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (oldVal "),t("span",{style:{color:"#F97583"}},"!="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"null"),t("span",{style:{color:"#E1E4E8"}},")")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                \t"),t("span",{style:{color:"#F97583"}},"return"),t("span",{style:{color:"#E1E4E8"}}," oldVal;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#F97583"}},"break"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"       \t}")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// 增加 size 计数")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#B392F0"}},"addCount"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#79B8FF"}},"1L"),t("span",{style:{color:"#E1E4E8"}},", binCount);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"return"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"null"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"}")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"private"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"final"),t("span",{style:{color:"#E1E4E8"}}," Node"),t("span",{style:{color:"#F97583"}},"<"),t("span",{style:{color:"#E1E4E8"}},"K,V"),t("span",{style:{color:"#F97583"}},">"),t("span",{style:{color:"#E1E4E8"}},"[] "),t("span",{style:{color:"#B392F0"}},"initTable"),t("span",{style:{color:"#E1E4E8"}},"() {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    Node<"),t("span",{style:{color:"#F97583"}},"K"),t("span",{style:{color:"#E1E4E8"}},","),t("span",{style:{color:"#F97583"}},"V"),t("span",{style:{color:"#E1E4E8"}},">[] tab; "),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," sc;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"while"),t("span",{style:{color:"#E1E4E8"}}," ((tab "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," table) "),t("span",{style:{color:"#F97583"}},"=="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"null"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"||"),t("span",{style:{color:"#E1E4E8"}}," tab.length "),t("span",{style:{color:"#F97583"}},"=="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"0"),t("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," ((sc "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," sizeCtl) "),t("span",{style:{color:"#F97583"}},"<"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"0"),t("span",{style:{color:"#E1E4E8"}},")")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        \tThread."),t("span",{style:{color:"#B392F0"}},"yield"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#6A737D"}},"// 尝试将 sizeCtl 设置为 -1（表示初始化 table）")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"else"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (U."),t("span",{style:{color:"#B392F0"}},"compareAndSwapInt"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#79B8FF"}},"this"),t("span",{style:{color:"#E1E4E8"}},", SIZECTL, sc, "),t("span",{style:{color:"#F97583"}},"-"),t("span",{style:{color:"#79B8FF"}},"1"),t("span",{style:{color:"#E1E4E8"}},")) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#6A737D"}},"// 获得锁, 创建 table, 这时其它线程会在 while() 循环中 yield 直至 table 创建")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"try"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," ((tab "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," table) "),t("span",{style:{color:"#F97583"}},"=="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"null"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"||"),t("span",{style:{color:"#E1E4E8"}}," tab.length "),t("span",{style:{color:"#F97583"}},"=="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"0"),t("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                    "),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," n "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," (sc "),t("span",{style:{color:"#F97583"}},">"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"0"),t("span",{style:{color:"#E1E4E8"}},") "),t("span",{style:{color:"#F97583"}},"?"),t("span",{style:{color:"#E1E4E8"}}," sc "),t("span",{style:{color:"#F97583"}},":"),t("span",{style:{color:"#E1E4E8"}}," DEFAULT_CAPACITY;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                    Node<"),t("span",{style:{color:"#F97583"}},"K"),t("span",{style:{color:"#E1E4E8"}},","),t("span",{style:{color:"#F97583"}},"V"),t("span",{style:{color:"#E1E4E8"}},">[] nt "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," (Node"),t("span",{style:{color:"#F97583"}},"<"),t("span",{style:{color:"#E1E4E8"}},"K,V"),t("span",{style:{color:"#F97583"}},">"),t("span",{style:{color:"#E1E4E8"}},"[])"),t("span",{style:{color:"#F97583"}},"new"),t("span",{style:{color:"#E1E4E8"}}," Node<"),t("span",{style:{color:"#F97583"}},"?"),t("span",{style:{color:"#E1E4E8"}},","),t("span",{style:{color:"#F97583"}},"?"),t("span",{style:{color:"#E1E4E8"}},">[n];")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                    table "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," tab "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," nt;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                    sc "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," n "),t("span",{style:{color:"#F97583"}},"-"),t("span",{style:{color:"#E1E4E8"}}," (n "),t("span",{style:{color:"#F97583"}},">>>"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"2"),t("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            } "),t("span",{style:{color:"#F97583"}},"finally"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                sizeCtl "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," sc;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"break"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"return"),t("span",{style:{color:"#E1E4E8"}}," tab;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"}")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// check 是之前 binCount 的个数")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"private"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"final"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"void"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"addCount"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#F97583"}},"long"),t("span",{style:{color:"#E1E4E8"}}," x, "),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," check) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"CounterCell"),t("span",{style:{color:"#E1E4E8"}},"[] as; "),t("span",{style:{color:"#F97583"}},"long"),t("span",{style:{color:"#E1E4E8"}}," b, s;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#6A737D"}},"// 已经有了 counterCells, 向 cell 累加")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        (as "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," counterCells) "),t("span",{style:{color:"#F97583"}},"!="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"null"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"||")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#6A737D"}},"// 还没有, 向 baseCount 累加")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"!"),t("span",{style:{color:"#E1E4E8"}},"U."),t("span",{style:{color:"#B392F0"}},"compareAndSwapLong"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#79B8FF"}},"this"),t("span",{style:{color:"#E1E4E8"}},", BASECOUNT, b "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," baseCount, s "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," b "),t("span",{style:{color:"#F97583"}},"+"),t("span",{style:{color:"#E1E4E8"}}," x)")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    ) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        CounterCell a; "),t("span",{style:{color:"#F97583"}},"long"),t("span",{style:{color:"#E1E4E8"}}," v; "),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," m;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"boolean"),t("span",{style:{color:"#E1E4E8"}}," uncontended "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"true"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#6A737D"}},"// 还没有 counterCells")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            as "),t("span",{style:{color:"#F97583"}},"=="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"null"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"||"),t("span",{style:{color:"#E1E4E8"}}," (m "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," as.length "),t("span",{style:{color:"#F97583"}},"-"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"1"),t("span",{style:{color:"#E1E4E8"}},") "),t("span",{style:{color:"#F97583"}},"<"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"0"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"||")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#6A737D"}},"// 还没有 cell")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            (a "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," as[ThreadLocalRandom."),t("span",{style:{color:"#B392F0"}},"getProbe"),t("span",{style:{color:"#E1E4E8"}},"() "),t("span",{style:{color:"#F97583"}},"&"),t("span",{style:{color:"#E1E4E8"}}," m]) "),t("span",{style:{color:"#F97583"}},"=="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"null"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"||")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#6A737D"}},"// cell cas 增加计数失败")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"!"),t("span",{style:{color:"#E1E4E8"}},"(uncontended "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," U."),t("span",{style:{color:"#B392F0"}},"compareAndSwapLong"),t("span",{style:{color:"#E1E4E8"}},"(a, CELLVALUE, v "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," a.value, v "),t("span",{style:{color:"#F97583"}},"+"),t("span",{style:{color:"#E1E4E8"}}," x))")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        \t) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#6A737D"}},"// 创建累加单元数组和cell, 累加重试")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#B392F0"}},"fullAddCount"),t("span",{style:{color:"#E1E4E8"}},"(x, uncontended);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"return"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (check "),t("span",{style:{color:"#F97583"}},"<="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"1"),t("span",{style:{color:"#E1E4E8"}},")")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        \t"),t("span",{style:{color:"#F97583"}},"return"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#6A737D"}},"// 获取元素个数")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        s "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"sumCount"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (check "),t("span",{style:{color:"#F97583"}},">="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"0"),t("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    Node<"),t("span",{style:{color:"#F97583"}},"K"),t("span",{style:{color:"#E1E4E8"}},","),t("span",{style:{color:"#F97583"}},"V"),t("span",{style:{color:"#E1E4E8"}},">[] tab, nt; "),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," n, sc;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"while"),t("span",{style:{color:"#E1E4E8"}}," (s "),t("span",{style:{color:"#F97583"}},">="),t("span",{style:{color:"#E1E4E8"}}," ("),t("span",{style:{color:"#F97583"}},"long"),t("span",{style:{color:"#E1E4E8"}},")(sc "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," sizeCtl) "),t("span",{style:{color:"#F97583"}},"&&"),t("span",{style:{color:"#E1E4E8"}}," (tab "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," table) "),t("span",{style:{color:"#F97583"}},"!="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"null"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"&&")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"           (n "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," tab.length) "),t("span",{style:{color:"#F97583"}},"<"),t("span",{style:{color:"#E1E4E8"}}," MAXIMUM_CAPACITY) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," rs "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"resizeStamp"),t("span",{style:{color:"#E1E4E8"}},"(n);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (sc "),t("span",{style:{color:"#F97583"}},"<"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"0"),t("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," ((sc "),t("span",{style:{color:"#F97583"}},">>>"),t("span",{style:{color:"#E1E4E8"}}," RESIZE_STAMP_SHIFT) "),t("span",{style:{color:"#F97583"}},"!="),t("span",{style:{color:"#E1E4E8"}}," rs "),t("span",{style:{color:"#F97583"}},"||"),t("span",{style:{color:"#E1E4E8"}}," sc "),t("span",{style:{color:"#F97583"}},"=="),t("span",{style:{color:"#E1E4E8"}}," rs "),t("span",{style:{color:"#F97583"}},"+"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"1"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"||")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                sc "),t("span",{style:{color:"#F97583"}},"=="),t("span",{style:{color:"#E1E4E8"}}," rs "),t("span",{style:{color:"#F97583"}},"+"),t("span",{style:{color:"#E1E4E8"}}," MAX_RESIZERS "),t("span",{style:{color:"#F97583"}},"||"),t("span",{style:{color:"#E1E4E8"}}," (nt "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," nextTable) "),t("span",{style:{color:"#F97583"}},"=="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"null"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"||")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                transferIndex "),t("span",{style:{color:"#F97583"}},"<="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"0"),t("span",{style:{color:"#E1E4E8"}},")")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#F97583"}},"break"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#6A737D"}},"// newtable 已经创建了，帮忙扩容")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (U."),t("span",{style:{color:"#B392F0"}},"compareAndSwapInt"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#79B8FF"}},"this"),t("span",{style:{color:"#E1E4E8"}},", SIZECTL, sc, sc "),t("span",{style:{color:"#F97583"}},"+"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"1"),t("span",{style:{color:"#E1E4E8"}},"))")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            \t"),t("span",{style:{color:"#B392F0"}},"transfer"),t("span",{style:{color:"#E1E4E8"}},"(tab, nt);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#6A737D"}},"// 需要扩容，这时 newtable 未创建")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"else"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (U."),t("span",{style:{color:"#B392F0"}},"compareAndSwapInt"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#79B8FF"}},"this"),t("span",{style:{color:"#E1E4E8"}},", SIZECTL, sc,")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            \t\t\t(rs "),t("span",{style:{color:"#F97583"}},"<<"),t("span",{style:{color:"#E1E4E8"}}," RESIZE_STAMP_SHIFT) "),t("span",{style:{color:"#F97583"}},"+"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"2"),t("span",{style:{color:"#E1E4E8"}},"))")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            \t"),t("span",{style:{color:"#B392F0"}},"transfer"),t("span",{style:{color:"#E1E4E8"}},"(tab, "),t("span",{style:{color:"#79B8FF"}},"null"),t("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            s "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"sumCount"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"}")])])]),t("pre",{class:"shiki github-light vp-code-light"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"public"),t("span",{style:{color:"#24292E"}}," V "),t("span",{style:{color:"#6F42C1"}},"put"),t("span",{style:{color:"#24292E"}},"(K key, V value) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"return"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"putVal"),t("span",{style:{color:"#24292E"}},"(key, value, "),t("span",{style:{color:"#005CC5"}},"false"),t("span",{style:{color:"#24292E"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"}")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"final"),t("span",{style:{color:"#24292E"}}," V "),t("span",{style:{color:"#6F42C1"}},"putVal"),t("span",{style:{color:"#24292E"}},"(K key, V value, "),t("span",{style:{color:"#D73A49"}},"boolean"),t("span",{style:{color:"#24292E"}}," onlyIfAbsent) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (key "),t("span",{style:{color:"#D73A49"}},"=="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"null"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"||"),t("span",{style:{color:"#24292E"}}," value "),t("span",{style:{color:"#D73A49"}},"=="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"null"),t("span",{style:{color:"#24292E"}},") "),t("span",{style:{color:"#D73A49"}},"throw"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"new"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"NullPointerException"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// 其中 spread 方法会综合高位低位, 具有更好的 hash 性")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," hash "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"spread"),t("span",{style:{color:"#24292E"}},"(key."),t("span",{style:{color:"#6F42C1"}},"hashCode"),t("span",{style:{color:"#24292E"}},"());")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," binCount "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"0"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"for"),t("span",{style:{color:"#24292E"}}," (Node<"),t("span",{style:{color:"#D73A49"}},"K"),t("span",{style:{color:"#24292E"}},","),t("span",{style:{color:"#D73A49"}},"V"),t("span",{style:{color:"#24292E"}},">[] tab "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," table;;) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6A737D"}},"// f 是链表头节点")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6A737D"}},"// fh 是链表头结点的 hash")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6A737D"}},"// i 是链表在 table 中的下标")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        Node<"),t("span",{style:{color:"#D73A49"}},"K"),t("span",{style:{color:"#24292E"}},","),t("span",{style:{color:"#D73A49"}},"V"),t("span",{style:{color:"#24292E"}},"> f; "),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," n, i, fh;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6A737D"}},"// 要创建 table")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (tab "),t("span",{style:{color:"#D73A49"}},"=="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"null"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"||"),t("span",{style:{color:"#24292E"}}," (n "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," tab.length) "),t("span",{style:{color:"#D73A49"}},"=="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"0"),t("span",{style:{color:"#24292E"}},")")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#6A737D"}},"// 初始化 table 使用了 cas, 无需 synchronized 创建成功, 进入下一轮循环")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            tab "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"initTable"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6A737D"}},"// 要创建链表头节点")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"else"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," ((f "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"tabAt"),t("span",{style:{color:"#24292E"}},"(tab, i "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," (n "),t("span",{style:{color:"#D73A49"}},"-"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"1"),t("span",{style:{color:"#24292E"}},") "),t("span",{style:{color:"#D73A49"}},"&"),t("span",{style:{color:"#24292E"}}," hash)) "),t("span",{style:{color:"#D73A49"}},"=="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"null"),t("span",{style:{color:"#24292E"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#6A737D"}},"// 添加链表头使用了 cas, 无需 synchronized")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," ("),t("span",{style:{color:"#6F42C1"}},"casTabAt"),t("span",{style:{color:"#24292E"}},"(tab, i, "),t("span",{style:{color:"#005CC5"}},"null"),t("span",{style:{color:"#24292E"}},",")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            \t\t"),t("span",{style:{color:"#D73A49"}},"new"),t("span",{style:{color:"#24292E"}}," Node<"),t("span",{style:{color:"#D73A49"}},"K"),t("span",{style:{color:"#24292E"}},","),t("span",{style:{color:"#D73A49"}},"V"),t("span",{style:{color:"#24292E"}},">(hash, key, value, "),t("span",{style:{color:"#005CC5"}},"null"),t("span",{style:{color:"#24292E"}},")))")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        \t"),t("span",{style:{color:"#D73A49"}},"break"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6A737D"}},"// 帮忙扩容")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"else"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," ((fh "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," f.hash) "),t("span",{style:{color:"#D73A49"}},"=="),t("span",{style:{color:"#24292E"}}," MOVED)")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#6A737D"}},"// 帮忙之后, 进入下一轮循环")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            tab "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"helpTransfer"),t("span",{style:{color:"#24292E"}},"(tab, f);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"else"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            V oldVal "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"null"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#6A737D"}},"// 锁住链表头节点")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"synchronized"),t("span",{style:{color:"#24292E"}}," (f) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#6A737D"}},"// 再次确认链表头节点没有被移动")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," ("),t("span",{style:{color:"#6F42C1"}},"tabAt"),t("span",{style:{color:"#24292E"}},"(tab, i) "),t("span",{style:{color:"#D73A49"}},"=="),t("span",{style:{color:"#24292E"}}," f) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                    "),t("span",{style:{color:"#6A737D"}},"// 链表")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                    "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (fh "),t("span",{style:{color:"#D73A49"}},">="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"0"),t("span",{style:{color:"#24292E"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                        binCount "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"1"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                        "),t("span",{style:{color:"#6A737D"}},"// 遍历链表")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                        "),t("span",{style:{color:"#D73A49"}},"for"),t("span",{style:{color:"#24292E"}}," (Node<"),t("span",{style:{color:"#D73A49"}},"K"),t("span",{style:{color:"#24292E"}},","),t("span",{style:{color:"#D73A49"}},"V"),t("span",{style:{color:"#24292E"}},"> e "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," f;; "),t("span",{style:{color:"#D73A49"}},"++"),t("span",{style:{color:"#24292E"}},"binCount) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                            K ek;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                            "),t("span",{style:{color:"#6A737D"}},"// 找到相同的 key")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                            "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (e.hash "),t("span",{style:{color:"#D73A49"}},"=="),t("span",{style:{color:"#24292E"}}," hash "),t("span",{style:{color:"#D73A49"}},"&&")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                                ((ek "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," e.key) "),t("span",{style:{color:"#D73A49"}},"=="),t("span",{style:{color:"#24292E"}}," key "),t("span",{style:{color:"#D73A49"}},"||")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                                 (ek "),t("span",{style:{color:"#D73A49"}},"!="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"null"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"&&"),t("span",{style:{color:"#24292E"}}," key."),t("span",{style:{color:"#6F42C1"}},"equals"),t("span",{style:{color:"#24292E"}},"(ek)))) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                                oldVal "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," e.val;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                                "),t("span",{style:{color:"#6A737D"}},"// 更新")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                                "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," ("),t("span",{style:{color:"#D73A49"}},"!"),t("span",{style:{color:"#24292E"}},"onlyIfAbsent)")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                                    "),t("span",{style:{color:"#6A737D"}},"//新值覆盖旧值")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                                     e.val "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," value;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                                "),t("span",{style:{color:"#D73A49"}},"break"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                            }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                            Node<"),t("span",{style:{color:"#D73A49"}},"K"),t("span",{style:{color:"#24292E"}},","),t("span",{style:{color:"#D73A49"}},"V"),t("span",{style:{color:"#24292E"}},"> pred "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," e;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                            ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                            "),t("span",{style:{color:"#6A737D"}},"// 已经是最后的节点了, 新增 Node, 追加至链表尾")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                            "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," ((e "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," e.next) "),t("span",{style:{color:"#D73A49"}},"=="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"null"),t("span",{style:{color:"#24292E"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                                pred.next "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"new"),t("span",{style:{color:"#24292E"}}," Node<"),t("span",{style:{color:"#D73A49"}},"K"),t("span",{style:{color:"#24292E"}},","),t("span",{style:{color:"#D73A49"}},"V"),t("span",{style:{color:"#24292E"}},">(hash, key,")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                                value, "),t("span",{style:{color:"#005CC5"}},"null"),t("span",{style:{color:"#24292E"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                                "),t("span",{style:{color:"#D73A49"}},"break"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                            }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                    "),t("span",{style:{color:"#6A737D"}},"// 红黑树")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                    "),t("span",{style:{color:"#D73A49"}},"else"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (f "),t("span",{style:{color:"#D73A49"}},"instanceof"),t("span",{style:{color:"#24292E"}}," TreeBin) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                        Node<"),t("span",{style:{color:"#D73A49"}},"K"),t("span",{style:{color:"#24292E"}},","),t("span",{style:{color:"#D73A49"}},"V"),t("span",{style:{color:"#24292E"}},"> p;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                        binCount "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"2"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                        "),t("span",{style:{color:"#6A737D"}},"// putTreeVal 会看 key 是否已经在树中, 是, 则返回对应的 TreeNode")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                        "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," ((p "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," ((TreeBin"),t("span",{style:{color:"#D73A49"}},"<"),t("span",{style:{color:"#24292E"}},"K,V"),t("span",{style:{color:"#D73A49"}},">"),t("span",{style:{color:"#24292E"}},")f)."),t("span",{style:{color:"#6F42C1"}},"putTreeVal"),t("span",{style:{color:"#24292E"}},"(hash, key,")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                                    value)) "),t("span",{style:{color:"#D73A49"}},"!="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"null"),t("span",{style:{color:"#24292E"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                            oldVal "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," p.val;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                            "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," ("),t("span",{style:{color:"#D73A49"}},"!"),t("span",{style:{color:"#24292E"}},"onlyIfAbsent)")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                                p.val "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," value;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                \t\t}")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                \t}")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            \t}")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"           "),t("span",{style:{color:"#6A737D"}},"// 释放链表头节点的锁")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"           }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"           "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (binCount "),t("span",{style:{color:"#D73A49"}},"!="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"0"),t("span",{style:{color:"#24292E"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (binCount "),t("span",{style:{color:"#D73A49"}},">="),t("span",{style:{color:"#24292E"}}," TREEIFY_THRESHOLD)")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#6A737D"}},"// 如果链表长度 >= 树化阈值(8), 进行链表转为红黑树")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                \t"),t("span",{style:{color:"#6F42C1"}},"treeifyBin"),t("span",{style:{color:"#24292E"}},"(tab, i);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (oldVal "),t("span",{style:{color:"#D73A49"}},"!="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"null"),t("span",{style:{color:"#24292E"}},")")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                \t"),t("span",{style:{color:"#D73A49"}},"return"),t("span",{style:{color:"#24292E"}}," oldVal;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#D73A49"}},"break"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"       \t}")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// 增加 size 计数")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6F42C1"}},"addCount"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#005CC5"}},"1L"),t("span",{style:{color:"#24292E"}},", binCount);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"return"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"null"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"}")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"private"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"final"),t("span",{style:{color:"#24292E"}}," Node"),t("span",{style:{color:"#D73A49"}},"<"),t("span",{style:{color:"#24292E"}},"K,V"),t("span",{style:{color:"#D73A49"}},">"),t("span",{style:{color:"#24292E"}},"[] "),t("span",{style:{color:"#6F42C1"}},"initTable"),t("span",{style:{color:"#24292E"}},"() {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    Node<"),t("span",{style:{color:"#D73A49"}},"K"),t("span",{style:{color:"#24292E"}},","),t("span",{style:{color:"#D73A49"}},"V"),t("span",{style:{color:"#24292E"}},">[] tab; "),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," sc;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"while"),t("span",{style:{color:"#24292E"}}," ((tab "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," table) "),t("span",{style:{color:"#D73A49"}},"=="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"null"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"||"),t("span",{style:{color:"#24292E"}}," tab.length "),t("span",{style:{color:"#D73A49"}},"=="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"0"),t("span",{style:{color:"#24292E"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," ((sc "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," sizeCtl) "),t("span",{style:{color:"#D73A49"}},"<"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"0"),t("span",{style:{color:"#24292E"}},")")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        \tThread."),t("span",{style:{color:"#6F42C1"}},"yield"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6A737D"}},"// 尝试将 sizeCtl 设置为 -1（表示初始化 table）")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"else"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (U."),t("span",{style:{color:"#6F42C1"}},"compareAndSwapInt"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#005CC5"}},"this"),t("span",{style:{color:"#24292E"}},", SIZECTL, sc, "),t("span",{style:{color:"#D73A49"}},"-"),t("span",{style:{color:"#005CC5"}},"1"),t("span",{style:{color:"#24292E"}},")) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#6A737D"}},"// 获得锁, 创建 table, 这时其它线程会在 while() 循环中 yield 直至 table 创建")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"try"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," ((tab "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," table) "),t("span",{style:{color:"#D73A49"}},"=="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"null"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"||"),t("span",{style:{color:"#24292E"}}," tab.length "),t("span",{style:{color:"#D73A49"}},"=="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"0"),t("span",{style:{color:"#24292E"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                    "),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," n "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," (sc "),t("span",{style:{color:"#D73A49"}},">"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"0"),t("span",{style:{color:"#24292E"}},") "),t("span",{style:{color:"#D73A49"}},"?"),t("span",{style:{color:"#24292E"}}," sc "),t("span",{style:{color:"#D73A49"}},":"),t("span",{style:{color:"#24292E"}}," DEFAULT_CAPACITY;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                    Node<"),t("span",{style:{color:"#D73A49"}},"K"),t("span",{style:{color:"#24292E"}},","),t("span",{style:{color:"#D73A49"}},"V"),t("span",{style:{color:"#24292E"}},">[] nt "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," (Node"),t("span",{style:{color:"#D73A49"}},"<"),t("span",{style:{color:"#24292E"}},"K,V"),t("span",{style:{color:"#D73A49"}},">"),t("span",{style:{color:"#24292E"}},"[])"),t("span",{style:{color:"#D73A49"}},"new"),t("span",{style:{color:"#24292E"}}," Node<"),t("span",{style:{color:"#D73A49"}},"?"),t("span",{style:{color:"#24292E"}},","),t("span",{style:{color:"#D73A49"}},"?"),t("span",{style:{color:"#24292E"}},">[n];")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                    table "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," tab "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," nt;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                    sc "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," n "),t("span",{style:{color:"#D73A49"}},"-"),t("span",{style:{color:"#24292E"}}," (n "),t("span",{style:{color:"#D73A49"}},">>>"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"2"),t("span",{style:{color:"#24292E"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            } "),t("span",{style:{color:"#D73A49"}},"finally"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                sizeCtl "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," sc;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"break"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"return"),t("span",{style:{color:"#24292E"}}," tab;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"}")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// check 是之前 binCount 的个数")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"private"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"final"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"void"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"addCount"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#D73A49"}},"long"),t("span",{style:{color:"#24292E"}}," x, "),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," check) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"CounterCell"),t("span",{style:{color:"#24292E"}},"[] as; "),t("span",{style:{color:"#D73A49"}},"long"),t("span",{style:{color:"#24292E"}}," b, s;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6A737D"}},"// 已经有了 counterCells, 向 cell 累加")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        (as "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," counterCells) "),t("span",{style:{color:"#D73A49"}},"!="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"null"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"||")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6A737D"}},"// 还没有, 向 baseCount 累加")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"!"),t("span",{style:{color:"#24292E"}},"U."),t("span",{style:{color:"#6F42C1"}},"compareAndSwapLong"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#005CC5"}},"this"),t("span",{style:{color:"#24292E"}},", BASECOUNT, b "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," baseCount, s "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," b "),t("span",{style:{color:"#D73A49"}},"+"),t("span",{style:{color:"#24292E"}}," x)")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    ) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        CounterCell a; "),t("span",{style:{color:"#D73A49"}},"long"),t("span",{style:{color:"#24292E"}}," v; "),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," m;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"boolean"),t("span",{style:{color:"#24292E"}}," uncontended "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"true"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#6A737D"}},"// 还没有 counterCells")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            as "),t("span",{style:{color:"#D73A49"}},"=="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"null"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"||"),t("span",{style:{color:"#24292E"}}," (m "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," as.length "),t("span",{style:{color:"#D73A49"}},"-"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"1"),t("span",{style:{color:"#24292E"}},") "),t("span",{style:{color:"#D73A49"}},"<"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"0"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"||")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#6A737D"}},"// 还没有 cell")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            (a "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," as[ThreadLocalRandom."),t("span",{style:{color:"#6F42C1"}},"getProbe"),t("span",{style:{color:"#24292E"}},"() "),t("span",{style:{color:"#D73A49"}},"&"),t("span",{style:{color:"#24292E"}}," m]) "),t("span",{style:{color:"#D73A49"}},"=="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"null"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"||")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#6A737D"}},"// cell cas 增加计数失败")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"!"),t("span",{style:{color:"#24292E"}},"(uncontended "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," U."),t("span",{style:{color:"#6F42C1"}},"compareAndSwapLong"),t("span",{style:{color:"#24292E"}},"(a, CELLVALUE, v "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," a.value, v "),t("span",{style:{color:"#D73A49"}},"+"),t("span",{style:{color:"#24292E"}}," x))")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        \t) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#6A737D"}},"// 创建累加单元数组和cell, 累加重试")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#6F42C1"}},"fullAddCount"),t("span",{style:{color:"#24292E"}},"(x, uncontended);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"return"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (check "),t("span",{style:{color:"#D73A49"}},"<="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"1"),t("span",{style:{color:"#24292E"}},")")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        \t"),t("span",{style:{color:"#D73A49"}},"return"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6A737D"}},"// 获取元素个数")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        s "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"sumCount"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (check "),t("span",{style:{color:"#D73A49"}},">="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"0"),t("span",{style:{color:"#24292E"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    Node<"),t("span",{style:{color:"#D73A49"}},"K"),t("span",{style:{color:"#24292E"}},","),t("span",{style:{color:"#D73A49"}},"V"),t("span",{style:{color:"#24292E"}},">[] tab, nt; "),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," n, sc;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"while"),t("span",{style:{color:"#24292E"}}," (s "),t("span",{style:{color:"#D73A49"}},">="),t("span",{style:{color:"#24292E"}}," ("),t("span",{style:{color:"#D73A49"}},"long"),t("span",{style:{color:"#24292E"}},")(sc "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," sizeCtl) "),t("span",{style:{color:"#D73A49"}},"&&"),t("span",{style:{color:"#24292E"}}," (tab "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," table) "),t("span",{style:{color:"#D73A49"}},"!="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"null"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"&&")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"           (n "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," tab.length) "),t("span",{style:{color:"#D73A49"}},"<"),t("span",{style:{color:"#24292E"}}," MAXIMUM_CAPACITY) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," rs "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"resizeStamp"),t("span",{style:{color:"#24292E"}},"(n);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (sc "),t("span",{style:{color:"#D73A49"}},"<"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"0"),t("span",{style:{color:"#24292E"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," ((sc "),t("span",{style:{color:"#D73A49"}},">>>"),t("span",{style:{color:"#24292E"}}," RESIZE_STAMP_SHIFT) "),t("span",{style:{color:"#D73A49"}},"!="),t("span",{style:{color:"#24292E"}}," rs "),t("span",{style:{color:"#D73A49"}},"||"),t("span",{style:{color:"#24292E"}}," sc "),t("span",{style:{color:"#D73A49"}},"=="),t("span",{style:{color:"#24292E"}}," rs "),t("span",{style:{color:"#D73A49"}},"+"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"1"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"||")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                sc "),t("span",{style:{color:"#D73A49"}},"=="),t("span",{style:{color:"#24292E"}}," rs "),t("span",{style:{color:"#D73A49"}},"+"),t("span",{style:{color:"#24292E"}}," MAX_RESIZERS "),t("span",{style:{color:"#D73A49"}},"||"),t("span",{style:{color:"#24292E"}}," (nt "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," nextTable) "),t("span",{style:{color:"#D73A49"}},"=="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"null"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"||")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                transferIndex "),t("span",{style:{color:"#D73A49"}},"<="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"0"),t("span",{style:{color:"#24292E"}},")")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#D73A49"}},"break"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#6A737D"}},"// newtable 已经创建了，帮忙扩容")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (U."),t("span",{style:{color:"#6F42C1"}},"compareAndSwapInt"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#005CC5"}},"this"),t("span",{style:{color:"#24292E"}},", SIZECTL, sc, sc "),t("span",{style:{color:"#D73A49"}},"+"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"1"),t("span",{style:{color:"#24292E"}},"))")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            \t"),t("span",{style:{color:"#6F42C1"}},"transfer"),t("span",{style:{color:"#24292E"}},"(tab, nt);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#6A737D"}},"// 需要扩容，这时 newtable 未创建")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"else"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (U."),t("span",{style:{color:"#6F42C1"}},"compareAndSwapInt"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#005CC5"}},"this"),t("span",{style:{color:"#24292E"}},", SIZECTL, sc,")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            \t\t\t(rs "),t("span",{style:{color:"#D73A49"}},"<<"),t("span",{style:{color:"#24292E"}}," RESIZE_STAMP_SHIFT) "),t("span",{style:{color:"#D73A49"}},"+"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"2"),t("span",{style:{color:"#24292E"}},"))")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            \t"),t("span",{style:{color:"#6F42C1"}},"transfer"),t("span",{style:{color:"#24292E"}},"(tab, "),t("span",{style:{color:"#005CC5"}},"null"),t("span",{style:{color:"#24292E"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            s "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"sumCount"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"}")])])])],-1),Dp={id:"size-计算流程",tabindex:"-1"},Cp=t("p",null,"size 计算实际发生在 put，remove 改变集合元素的操作之中",-1),hp=t("ul",null,[t("li",null,"没有竞争发生，向 baseCount 累加计数"),t("li",null,[p("有竞争发生，新建 counterCells，向其中的一个 cell 累加计数 "),t("ul",null,[t("li",null,"counterCells 初始有两个 cell"),t("li",null,"如果计数竞争比较激烈，会创建新的 cell 来累加计数")])])],-1),gp=t("div",{class:"language-java"},[t("button",{title:"Copy Code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki github-dark vp-code-dark"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"public"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"size"),t("span",{style:{color:"#E1E4E8"}},"() {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"long"),t("span",{style:{color:"#E1E4E8"}}," n "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"sumCount"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"return"),t("span",{style:{color:"#E1E4E8"}}," ((n "),t("span",{style:{color:"#F97583"}},"<"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"0L"),t("span",{style:{color:"#E1E4E8"}},") "),t("span",{style:{color:"#F97583"}},"?"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"0"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},":")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            (n "),t("span",{style:{color:"#F97583"}},">"),t("span",{style:{color:"#E1E4E8"}}," ("),t("span",{style:{color:"#F97583"}},"long"),t("span",{style:{color:"#E1E4E8"}},")Integer.MAX_VALUE) "),t("span",{style:{color:"#F97583"}},"?"),t("span",{style:{color:"#E1E4E8"}}," Integer.MAX_VALUE "),t("span",{style:{color:"#F97583"}},":")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            ("),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}},")n);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"}")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"final"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"long"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"sumCount"),t("span",{style:{color:"#E1E4E8"}},"() {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"CounterCell"),t("span",{style:{color:"#E1E4E8"}},"[] as "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," counterCells; CounterCell a;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// 将 baseCount 计数与所有 cell 计数累加")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"long"),t("span",{style:{color:"#E1E4E8"}}," sum "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," baseCount;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (as "),t("span",{style:{color:"#F97583"}},"!="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"null"),t("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"for"),t("span",{style:{color:"#E1E4E8"}}," ("),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," i "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"0"),t("span",{style:{color:"#E1E4E8"}},"; i "),t("span",{style:{color:"#F97583"}},"<"),t("span",{style:{color:"#E1E4E8"}}," as.length; "),t("span",{style:{color:"#F97583"}},"++"),t("span",{style:{color:"#E1E4E8"}},"i) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        \t"),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," ((a "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," as[i]) "),t("span",{style:{color:"#F97583"}},"!="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"null"),t("span",{style:{color:"#E1E4E8"}},")")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        \t\tsum "),t("span",{style:{color:"#F97583"}},"+="),t("span",{style:{color:"#E1E4E8"}}," a.value;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"return"),t("span",{style:{color:"#E1E4E8"}}," sum;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"}")])])]),t("pre",{class:"shiki github-light vp-code-light"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"public"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"size"),t("span",{style:{color:"#24292E"}},"() {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"long"),t("span",{style:{color:"#24292E"}}," n "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"sumCount"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"return"),t("span",{style:{color:"#24292E"}}," ((n "),t("span",{style:{color:"#D73A49"}},"<"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"0L"),t("span",{style:{color:"#24292E"}},") "),t("span",{style:{color:"#D73A49"}},"?"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"0"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},":")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            (n "),t("span",{style:{color:"#D73A49"}},">"),t("span",{style:{color:"#24292E"}}," ("),t("span",{style:{color:"#D73A49"}},"long"),t("span",{style:{color:"#24292E"}},")Integer.MAX_VALUE) "),t("span",{style:{color:"#D73A49"}},"?"),t("span",{style:{color:"#24292E"}}," Integer.MAX_VALUE "),t("span",{style:{color:"#D73A49"}},":")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            ("),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}},")n);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"}")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"final"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"long"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"sumCount"),t("span",{style:{color:"#24292E"}},"() {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"CounterCell"),t("span",{style:{color:"#24292E"}},"[] as "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," counterCells; CounterCell a;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// 将 baseCount 计数与所有 cell 计数累加")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"long"),t("span",{style:{color:"#24292E"}}," sum "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," baseCount;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (as "),t("span",{style:{color:"#D73A49"}},"!="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"null"),t("span",{style:{color:"#24292E"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"for"),t("span",{style:{color:"#24292E"}}," ("),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," i "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"0"),t("span",{style:{color:"#24292E"}},"; i "),t("span",{style:{color:"#D73A49"}},"<"),t("span",{style:{color:"#24292E"}}," as.length; "),t("span",{style:{color:"#D73A49"}},"++"),t("span",{style:{color:"#24292E"}},"i) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        \t"),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," ((a "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," as[i]) "),t("span",{style:{color:"#D73A49"}},"!="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"null"),t("span",{style:{color:"#24292E"}},")")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        \t\tsum "),t("span",{style:{color:"#D73A49"}},"+="),t("span",{style:{color:"#24292E"}}," a.value;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"return"),t("span",{style:{color:"#24292E"}}," sum;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"}")])])])],-1),Bp={id:"扩容",tabindex:"-1"},fp=t("blockquote",null,[t("p",null,"传入原始的table和新的table，新的table也是懒惰初始化，一开始为null，这时就会把它创建出来，即把原有的容量左移1位(*2)，把新创建的数组赋值给新table，创建完后就会从原来的table进行节点的搬迁（以链表为单位进行移动），当链表头为null表示已经搬迁完了，标记为forwardingNode，当本次循环看到此标记就进入下一次循环迁移下一个节点；当链表是有元素的，就会用synchronized锁锁住这个链表进行迁移处理，看是普通链表节点还是树节点来完成不同的迁移工作")],-1),kp=t("div",{class:"language-java"},[t("button",{title:"Copy Code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki github-dark vp-code-dark"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"private"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"final"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"void"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"transfer"),t("span",{style:{color:"#E1E4E8"}},"(Node"),t("span",{style:{color:"#F97583"}},"<"),t("span",{style:{color:"#E1E4E8"}},"K,V"),t("span",{style:{color:"#F97583"}},">"),t("span",{style:{color:"#E1E4E8"}},"[] tab, Node"),t("span",{style:{color:"#F97583"}},"<"),t("span",{style:{color:"#E1E4E8"}},"K,V"),t("span",{style:{color:"#F97583"}},">"),t("span",{style:{color:"#E1E4E8"}},"[] nextTab) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," n "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," tab.length, stride;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," ((stride "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," (NCPU "),t("span",{style:{color:"#F97583"}},">"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"1"),t("span",{style:{color:"#E1E4E8"}},") "),t("span",{style:{color:"#F97583"}},"?"),t("span",{style:{color:"#E1E4E8"}}," (n "),t("span",{style:{color:"#F97583"}},">>>"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"3"),t("span",{style:{color:"#E1E4E8"}},") "),t("span",{style:{color:"#F97583"}},"/"),t("span",{style:{color:"#E1E4E8"}}," NCPU "),t("span",{style:{color:"#F97583"}},":"),t("span",{style:{color:"#E1E4E8"}}," n) "),t("span",{style:{color:"#F97583"}},"<"),t("span",{style:{color:"#E1E4E8"}}," MIN_TRANSFER_STRIDE)")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        stride "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," MIN_TRANSFER_STRIDE; "),t("span",{style:{color:"#6A737D"}},"// subdivide range")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (nextTab "),t("span",{style:{color:"#F97583"}},"=="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"null"),t("span",{style:{color:"#E1E4E8"}},") {            "),t("span",{style:{color:"#6A737D"}},"// initiating")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"try"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            @"),t("span",{style:{color:"#F97583"}},"SuppressWarnings"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#9ECBFF"}},'"unchecked"'),t("span",{style:{color:"#E1E4E8"}},")")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            Node<"),t("span",{style:{color:"#F97583"}},"K"),t("span",{style:{color:"#E1E4E8"}},","),t("span",{style:{color:"#F97583"}},"V"),t("span",{style:{color:"#E1E4E8"}},">[] nt "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," (Node"),t("span",{style:{color:"#F97583"}},"<"),t("span",{style:{color:"#E1E4E8"}},"K,V"),t("span",{style:{color:"#F97583"}},">"),t("span",{style:{color:"#E1E4E8"}},"[])"),t("span",{style:{color:"#F97583"}},"new"),t("span",{style:{color:"#E1E4E8"}}," Node<"),t("span",{style:{color:"#F97583"}},"?"),t("span",{style:{color:"#E1E4E8"}},","),t("span",{style:{color:"#F97583"}},"?"),t("span",{style:{color:"#E1E4E8"}},">[n "),t("span",{style:{color:"#F97583"}},"<<"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"1"),t("span",{style:{color:"#E1E4E8"}},"];")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            nextTab "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," nt;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        } "),t("span",{style:{color:"#F97583"}},"catch"),t("span",{style:{color:"#E1E4E8"}}," (Throwable "),t("span",{style:{color:"#FFAB70"}},"ex"),t("span",{style:{color:"#E1E4E8"}},") {      "),t("span",{style:{color:"#6A737D"}},"// try to cope with OOME")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            sizeCtl "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," Integer.MAX_VALUE;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"return"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        nextTable "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," nextTab;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        transferIndex "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," n;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," nextn "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," nextTab.length;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    ForwardingNode<"),t("span",{style:{color:"#F97583"}},"K"),t("span",{style:{color:"#E1E4E8"}},","),t("span",{style:{color:"#F97583"}},"V"),t("span",{style:{color:"#E1E4E8"}},"> fwd "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"new"),t("span",{style:{color:"#E1E4E8"}}," ForwardingNode<"),t("span",{style:{color:"#F97583"}},"K"),t("span",{style:{color:"#E1E4E8"}},","),t("span",{style:{color:"#F97583"}},"V"),t("span",{style:{color:"#E1E4E8"}},">(nextTab);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"boolean"),t("span",{style:{color:"#E1E4E8"}}," advance "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"true"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"boolean"),t("span",{style:{color:"#E1E4E8"}}," finishing "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"false"),t("span",{style:{color:"#E1E4E8"}},"; "),t("span",{style:{color:"#6A737D"}},"// to ensure sweep before committing nextTab")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"for"),t("span",{style:{color:"#E1E4E8"}}," ("),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," i "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"0"),t("span",{style:{color:"#E1E4E8"}},", bound "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"0"),t("span",{style:{color:"#E1E4E8"}},";;) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        Node<"),t("span",{style:{color:"#F97583"}},"K"),t("span",{style:{color:"#E1E4E8"}},","),t("span",{style:{color:"#F97583"}},"V"),t("span",{style:{color:"#E1E4E8"}},"> f; "),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," fh;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"while"),t("span",{style:{color:"#E1E4E8"}}," (advance) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," nextIndex, nextBound;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," ("),t("span",{style:{color:"#F97583"}},"--"),t("span",{style:{color:"#E1E4E8"}},"i "),t("span",{style:{color:"#F97583"}},">="),t("span",{style:{color:"#E1E4E8"}}," bound "),t("span",{style:{color:"#F97583"}},"||"),t("span",{style:{color:"#E1E4E8"}}," finishing)")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                advance "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"false"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"else"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," ((nextIndex "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," transferIndex) "),t("span",{style:{color:"#F97583"}},"<="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"0"),t("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                i "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"-"),t("span",{style:{color:"#79B8FF"}},"1"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                advance "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"false"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"else"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (U.compareAndSwapInt")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                     ("),t("span",{style:{color:"#79B8FF"}},"this"),t("span",{style:{color:"#E1E4E8"}},", TRANSFERINDEX, nextIndex,")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                      nextBound "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," (nextIndex "),t("span",{style:{color:"#F97583"}},">"),t("span",{style:{color:"#E1E4E8"}}," stride "),t("span",{style:{color:"#F97583"}},"?")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                                   nextIndex "),t("span",{style:{color:"#F97583"}},"-"),t("span",{style:{color:"#E1E4E8"}}," stride "),t("span",{style:{color:"#F97583"}},":"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"0"),t("span",{style:{color:"#E1E4E8"}},"))) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                bound "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," nextBound;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                i "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," nextIndex "),t("span",{style:{color:"#F97583"}},"-"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"1"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                advance "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"false"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (i "),t("span",{style:{color:"#F97583"}},"<"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"0"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"||"),t("span",{style:{color:"#E1E4E8"}}," i "),t("span",{style:{color:"#F97583"}},">="),t("span",{style:{color:"#E1E4E8"}}," n "),t("span",{style:{color:"#F97583"}},"||"),t("span",{style:{color:"#E1E4E8"}}," i "),t("span",{style:{color:"#F97583"}},"+"),t("span",{style:{color:"#E1E4E8"}}," n "),t("span",{style:{color:"#F97583"}},">="),t("span",{style:{color:"#E1E4E8"}}," nextn) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," sc;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (finishing) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                nextTable "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"null"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                table "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," nextTab;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                sizeCtl "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," (n "),t("span",{style:{color:"#F97583"}},"<<"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"1"),t("span",{style:{color:"#E1E4E8"}},") "),t("span",{style:{color:"#F97583"}},"-"),t("span",{style:{color:"#E1E4E8"}}," (n "),t("span",{style:{color:"#F97583"}},">>>"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"1"),t("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#F97583"}},"return"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (U."),t("span",{style:{color:"#B392F0"}},"compareAndSwapInt"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#79B8FF"}},"this"),t("span",{style:{color:"#E1E4E8"}},", SIZECTL, sc "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," sizeCtl, sc "),t("span",{style:{color:"#F97583"}},"-"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"1"),t("span",{style:{color:"#E1E4E8"}},")) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," ((sc "),t("span",{style:{color:"#F97583"}},"-"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"2"),t("span",{style:{color:"#E1E4E8"}},") "),t("span",{style:{color:"#F97583"}},"!="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"resizeStamp"),t("span",{style:{color:"#E1E4E8"}},"(n) "),t("span",{style:{color:"#F97583"}},"<<"),t("span",{style:{color:"#E1E4E8"}}," RESIZE_STAMP_SHIFT)")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                    "),t("span",{style:{color:"#F97583"}},"return"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                finishing "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," advance "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"true"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                i "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," n; "),t("span",{style:{color:"#6A737D"}},"// recheck before commit")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"else"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," ((f "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"tabAt"),t("span",{style:{color:"#E1E4E8"}},"(tab, i)) "),t("span",{style:{color:"#F97583"}},"=="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"null"),t("span",{style:{color:"#E1E4E8"}},")")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            advance "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"casTabAt"),t("span",{style:{color:"#E1E4E8"}},"(tab, i, "),t("span",{style:{color:"#79B8FF"}},"null"),t("span",{style:{color:"#E1E4E8"}},", fwd);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"else"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," ((fh "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," f.hash) "),t("span",{style:{color:"#F97583"}},"=="),t("span",{style:{color:"#E1E4E8"}}," MOVED)")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            advance "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"true"),t("span",{style:{color:"#E1E4E8"}},"; "),t("span",{style:{color:"#6A737D"}},"// already processed")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"else"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"synchronized"),t("span",{style:{color:"#E1E4E8"}}," (f) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," ("),t("span",{style:{color:"#B392F0"}},"tabAt"),t("span",{style:{color:"#E1E4E8"}},"(tab, i) "),t("span",{style:{color:"#F97583"}},"=="),t("span",{style:{color:"#E1E4E8"}}," f) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                    Node<"),t("span",{style:{color:"#F97583"}},"K"),t("span",{style:{color:"#E1E4E8"}},","),t("span",{style:{color:"#F97583"}},"V"),t("span",{style:{color:"#E1E4E8"}},"> ln, hn;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                    "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (fh "),t("span",{style:{color:"#F97583"}},">="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"0"),t("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                        "),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," runBit "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," fh "),t("span",{style:{color:"#F97583"}},"&"),t("span",{style:{color:"#E1E4E8"}}," n;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                        Node<"),t("span",{style:{color:"#F97583"}},"K"),t("span",{style:{color:"#E1E4E8"}},","),t("span",{style:{color:"#F97583"}},"V"),t("span",{style:{color:"#E1E4E8"}},"> lastRun "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," f;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                        "),t("span",{style:{color:"#F97583"}},"for"),t("span",{style:{color:"#E1E4E8"}}," (Node<"),t("span",{style:{color:"#F97583"}},"K"),t("span",{style:{color:"#E1E4E8"}},","),t("span",{style:{color:"#F97583"}},"V"),t("span",{style:{color:"#E1E4E8"}},"> p "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," f.next; p "),t("span",{style:{color:"#F97583"}},"!="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"null"),t("span",{style:{color:"#E1E4E8"}},"; p "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," p.next) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                            "),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," b "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," p.hash "),t("span",{style:{color:"#F97583"}},"&"),t("span",{style:{color:"#E1E4E8"}}," n;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                            "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (b "),t("span",{style:{color:"#F97583"}},"!="),t("span",{style:{color:"#E1E4E8"}}," runBit) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                                runBit "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," b;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                                lastRun "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," p;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                            }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                        "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (runBit "),t("span",{style:{color:"#F97583"}},"=="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"0"),t("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                            ln "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," lastRun;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                            hn "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"null"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                        "),t("span",{style:{color:"#F97583"}},"else"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                            hn "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," lastRun;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                            ln "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"null"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                        "),t("span",{style:{color:"#F97583"}},"for"),t("span",{style:{color:"#E1E4E8"}}," (Node<"),t("span",{style:{color:"#F97583"}},"K"),t("span",{style:{color:"#E1E4E8"}},","),t("span",{style:{color:"#F97583"}},"V"),t("span",{style:{color:"#E1E4E8"}},"> p "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," f; p "),t("span",{style:{color:"#F97583"}},"!="),t("span",{style:{color:"#E1E4E8"}}," lastRun; p "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," p.next) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                            "),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," ph "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," p.hash; K pk "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," p.key; V pv "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," p.val;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                            "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," ((ph "),t("span",{style:{color:"#F97583"}},"&"),t("span",{style:{color:"#E1E4E8"}}," n) "),t("span",{style:{color:"#F97583"}},"=="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"0"),t("span",{style:{color:"#E1E4E8"}},")")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                                ln "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"new"),t("span",{style:{color:"#E1E4E8"}}," Node<"),t("span",{style:{color:"#F97583"}},"K"),t("span",{style:{color:"#E1E4E8"}},","),t("span",{style:{color:"#F97583"}},"V"),t("span",{style:{color:"#E1E4E8"}},">(ph, pk, pv, ln);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                            "),t("span",{style:{color:"#F97583"}},"else")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                                hn "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"new"),t("span",{style:{color:"#E1E4E8"}}," Node<"),t("span",{style:{color:"#F97583"}},"K"),t("span",{style:{color:"#E1E4E8"}},","),t("span",{style:{color:"#F97583"}},"V"),t("span",{style:{color:"#E1E4E8"}},">(ph, pk, pv, hn);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                        "),t("span",{style:{color:"#B392F0"}},"setTabAt"),t("span",{style:{color:"#E1E4E8"}},"(nextTab, i, ln);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                        "),t("span",{style:{color:"#B392F0"}},"setTabAt"),t("span",{style:{color:"#E1E4E8"}},"(nextTab, i "),t("span",{style:{color:"#F97583"}},"+"),t("span",{style:{color:"#E1E4E8"}}," n, hn);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                        "),t("span",{style:{color:"#B392F0"}},"setTabAt"),t("span",{style:{color:"#E1E4E8"}},"(tab, i, fwd);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                        advance "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"true"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                    "),t("span",{style:{color:"#F97583"}},"else"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (f "),t("span",{style:{color:"#F97583"}},"instanceof"),t("span",{style:{color:"#E1E4E8"}}," TreeBin) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                        TreeBin<"),t("span",{style:{color:"#F97583"}},"K"),t("span",{style:{color:"#E1E4E8"}},","),t("span",{style:{color:"#F97583"}},"V"),t("span",{style:{color:"#E1E4E8"}},"> t "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," (TreeBin"),t("span",{style:{color:"#F97583"}},"<"),t("span",{style:{color:"#E1E4E8"}},"K,V"),t("span",{style:{color:"#F97583"}},">"),t("span",{style:{color:"#E1E4E8"}},")f;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                        TreeNode<"),t("span",{style:{color:"#F97583"}},"K"),t("span",{style:{color:"#E1E4E8"}},","),t("span",{style:{color:"#F97583"}},"V"),t("span",{style:{color:"#E1E4E8"}},"> lo "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"null"),t("span",{style:{color:"#E1E4E8"}},", loTail "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"null"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                        TreeNode<"),t("span",{style:{color:"#F97583"}},"K"),t("span",{style:{color:"#E1E4E8"}},","),t("span",{style:{color:"#F97583"}},"V"),t("span",{style:{color:"#E1E4E8"}},"> hi "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"null"),t("span",{style:{color:"#E1E4E8"}},", hiTail "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"null"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                        "),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," lc "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"0"),t("span",{style:{color:"#E1E4E8"}},", hc "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"0"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                        "),t("span",{style:{color:"#F97583"}},"for"),t("span",{style:{color:"#E1E4E8"}}," (Node<"),t("span",{style:{color:"#F97583"}},"K"),t("span",{style:{color:"#E1E4E8"}},","),t("span",{style:{color:"#F97583"}},"V"),t("span",{style:{color:"#E1E4E8"}},"> e "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," t.first; e "),t("span",{style:{color:"#F97583"}},"!="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"null"),t("span",{style:{color:"#E1E4E8"}},"; e "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," e.next) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                            "),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," h "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," e.hash;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                            TreeNode<"),t("span",{style:{color:"#F97583"}},"K"),t("span",{style:{color:"#E1E4E8"}},","),t("span",{style:{color:"#F97583"}},"V"),t("span",{style:{color:"#E1E4E8"}},"> p "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"new"),t("span",{style:{color:"#E1E4E8"}}," TreeNode<"),t("span",{style:{color:"#F97583"}},"K"),t("span",{style:{color:"#E1E4E8"}},","),t("span",{style:{color:"#F97583"}},"V"),t("span",{style:{color:"#E1E4E8"}},">")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                                (h, e.key, e.val, "),t("span",{style:{color:"#79B8FF"}},"null"),t("span",{style:{color:"#E1E4E8"}},", "),t("span",{style:{color:"#79B8FF"}},"null"),t("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                            "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," ((h "),t("span",{style:{color:"#F97583"}},"&"),t("span",{style:{color:"#E1E4E8"}}," n) "),t("span",{style:{color:"#F97583"}},"=="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"0"),t("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                                "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," ((p.prev "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," loTail) "),t("span",{style:{color:"#F97583"}},"=="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"null"),t("span",{style:{color:"#E1E4E8"}},")")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                                    lo "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," p;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                                "),t("span",{style:{color:"#F97583"}},"else")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                                    loTail.next "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," p;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                                loTail "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," p;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                                "),t("span",{style:{color:"#F97583"}},"++"),t("span",{style:{color:"#E1E4E8"}},"lc;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                            }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                            "),t("span",{style:{color:"#F97583"}},"else"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                                "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," ((p.prev "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," hiTail) "),t("span",{style:{color:"#F97583"}},"=="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"null"),t("span",{style:{color:"#E1E4E8"}},")")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                                    hi "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," p;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                                "),t("span",{style:{color:"#F97583"}},"else")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                                    hiTail.next "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," p;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                                hiTail "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," p;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                                "),t("span",{style:{color:"#F97583"}},"++"),t("span",{style:{color:"#E1E4E8"}},"hc;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                            }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                        ln "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," (lc "),t("span",{style:{color:"#F97583"}},"<="),t("span",{style:{color:"#E1E4E8"}}," UNTREEIFY_THRESHOLD) "),t("span",{style:{color:"#F97583"}},"?"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"untreeify"),t("span",{style:{color:"#E1E4E8"}},"(lo) "),t("span",{style:{color:"#F97583"}},":")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                            (hc "),t("span",{style:{color:"#F97583"}},"!="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"0"),t("span",{style:{color:"#E1E4E8"}},") "),t("span",{style:{color:"#F97583"}},"?"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"new"),t("span",{style:{color:"#E1E4E8"}}," TreeBin<"),t("span",{style:{color:"#F97583"}},"K"),t("span",{style:{color:"#E1E4E8"}},","),t("span",{style:{color:"#F97583"}},"V"),t("span",{style:{color:"#E1E4E8"}},">(lo) "),t("span",{style:{color:"#F97583"}},":"),t("span",{style:{color:"#E1E4E8"}}," t;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                        hn "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," (hc "),t("span",{style:{color:"#F97583"}},"<="),t("span",{style:{color:"#E1E4E8"}}," UNTREEIFY_THRESHOLD) "),t("span",{style:{color:"#F97583"}},"?"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"untreeify"),t("span",{style:{color:"#E1E4E8"}},"(hi) "),t("span",{style:{color:"#F97583"}},":")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                            (lc "),t("span",{style:{color:"#F97583"}},"!="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"0"),t("span",{style:{color:"#E1E4E8"}},") "),t("span",{style:{color:"#F97583"}},"?"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"new"),t("span",{style:{color:"#E1E4E8"}}," TreeBin<"),t("span",{style:{color:"#F97583"}},"K"),t("span",{style:{color:"#E1E4E8"}},","),t("span",{style:{color:"#F97583"}},"V"),t("span",{style:{color:"#E1E4E8"}},">(hi) "),t("span",{style:{color:"#F97583"}},":"),t("span",{style:{color:"#E1E4E8"}}," t;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                        "),t("span",{style:{color:"#B392F0"}},"setTabAt"),t("span",{style:{color:"#E1E4E8"}},"(nextTab, i, ln);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                        "),t("span",{style:{color:"#B392F0"}},"setTabAt"),t("span",{style:{color:"#E1E4E8"}},"(nextTab, i "),t("span",{style:{color:"#F97583"}},"+"),t("span",{style:{color:"#E1E4E8"}}," n, hn);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                        "),t("span",{style:{color:"#B392F0"}},"setTabAt"),t("span",{style:{color:"#E1E4E8"}},"(tab, i, fwd);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                        advance "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"true"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"}")])])]),t("pre",{class:"shiki github-light vp-code-light"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"private"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"final"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"void"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"transfer"),t("span",{style:{color:"#24292E"}},"(Node"),t("span",{style:{color:"#D73A49"}},"<"),t("span",{style:{color:"#24292E"}},"K,V"),t("span",{style:{color:"#D73A49"}},">"),t("span",{style:{color:"#24292E"}},"[] tab, Node"),t("span",{style:{color:"#D73A49"}},"<"),t("span",{style:{color:"#24292E"}},"K,V"),t("span",{style:{color:"#D73A49"}},">"),t("span",{style:{color:"#24292E"}},"[] nextTab) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," n "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," tab.length, stride;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," ((stride "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," (NCPU "),t("span",{style:{color:"#D73A49"}},">"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"1"),t("span",{style:{color:"#24292E"}},") "),t("span",{style:{color:"#D73A49"}},"?"),t("span",{style:{color:"#24292E"}}," (n "),t("span",{style:{color:"#D73A49"}},">>>"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"3"),t("span",{style:{color:"#24292E"}},") "),t("span",{style:{color:"#D73A49"}},"/"),t("span",{style:{color:"#24292E"}}," NCPU "),t("span",{style:{color:"#D73A49"}},":"),t("span",{style:{color:"#24292E"}}," n) "),t("span",{style:{color:"#D73A49"}},"<"),t("span",{style:{color:"#24292E"}}," MIN_TRANSFER_STRIDE)")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        stride "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," MIN_TRANSFER_STRIDE; "),t("span",{style:{color:"#6A737D"}},"// subdivide range")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (nextTab "),t("span",{style:{color:"#D73A49"}},"=="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"null"),t("span",{style:{color:"#24292E"}},") {            "),t("span",{style:{color:"#6A737D"}},"// initiating")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"try"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            @"),t("span",{style:{color:"#D73A49"}},"SuppressWarnings"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#032F62"}},'"unchecked"'),t("span",{style:{color:"#24292E"}},")")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            Node<"),t("span",{style:{color:"#D73A49"}},"K"),t("span",{style:{color:"#24292E"}},","),t("span",{style:{color:"#D73A49"}},"V"),t("span",{style:{color:"#24292E"}},">[] nt "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," (Node"),t("span",{style:{color:"#D73A49"}},"<"),t("span",{style:{color:"#24292E"}},"K,V"),t("span",{style:{color:"#D73A49"}},">"),t("span",{style:{color:"#24292E"}},"[])"),t("span",{style:{color:"#D73A49"}},"new"),t("span",{style:{color:"#24292E"}}," Node<"),t("span",{style:{color:"#D73A49"}},"?"),t("span",{style:{color:"#24292E"}},","),t("span",{style:{color:"#D73A49"}},"?"),t("span",{style:{color:"#24292E"}},">[n "),t("span",{style:{color:"#D73A49"}},"<<"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"1"),t("span",{style:{color:"#24292E"}},"];")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            nextTab "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," nt;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        } "),t("span",{style:{color:"#D73A49"}},"catch"),t("span",{style:{color:"#24292E"}}," (Throwable "),t("span",{style:{color:"#E36209"}},"ex"),t("span",{style:{color:"#24292E"}},") {      "),t("span",{style:{color:"#6A737D"}},"// try to cope with OOME")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            sizeCtl "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," Integer.MAX_VALUE;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"return"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        nextTable "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," nextTab;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        transferIndex "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," n;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," nextn "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," nextTab.length;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    ForwardingNode<"),t("span",{style:{color:"#D73A49"}},"K"),t("span",{style:{color:"#24292E"}},","),t("span",{style:{color:"#D73A49"}},"V"),t("span",{style:{color:"#24292E"}},"> fwd "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"new"),t("span",{style:{color:"#24292E"}}," ForwardingNode<"),t("span",{style:{color:"#D73A49"}},"K"),t("span",{style:{color:"#24292E"}},","),t("span",{style:{color:"#D73A49"}},"V"),t("span",{style:{color:"#24292E"}},">(nextTab);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"boolean"),t("span",{style:{color:"#24292E"}}," advance "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"true"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"boolean"),t("span",{style:{color:"#24292E"}}," finishing "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"false"),t("span",{style:{color:"#24292E"}},"; "),t("span",{style:{color:"#6A737D"}},"// to ensure sweep before committing nextTab")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"for"),t("span",{style:{color:"#24292E"}}," ("),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," i "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"0"),t("span",{style:{color:"#24292E"}},", bound "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"0"),t("span",{style:{color:"#24292E"}},";;) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        Node<"),t("span",{style:{color:"#D73A49"}},"K"),t("span",{style:{color:"#24292E"}},","),t("span",{style:{color:"#D73A49"}},"V"),t("span",{style:{color:"#24292E"}},"> f; "),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," fh;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"while"),t("span",{style:{color:"#24292E"}}," (advance) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," nextIndex, nextBound;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," ("),t("span",{style:{color:"#D73A49"}},"--"),t("span",{style:{color:"#24292E"}},"i "),t("span",{style:{color:"#D73A49"}},">="),t("span",{style:{color:"#24292E"}}," bound "),t("span",{style:{color:"#D73A49"}},"||"),t("span",{style:{color:"#24292E"}}," finishing)")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                advance "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"false"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"else"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," ((nextIndex "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," transferIndex) "),t("span",{style:{color:"#D73A49"}},"<="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"0"),t("span",{style:{color:"#24292E"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                i "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"-"),t("span",{style:{color:"#005CC5"}},"1"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                advance "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"false"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"else"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (U.compareAndSwapInt")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                     ("),t("span",{style:{color:"#005CC5"}},"this"),t("span",{style:{color:"#24292E"}},", TRANSFERINDEX, nextIndex,")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                      nextBound "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," (nextIndex "),t("span",{style:{color:"#D73A49"}},">"),t("span",{style:{color:"#24292E"}}," stride "),t("span",{style:{color:"#D73A49"}},"?")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                                   nextIndex "),t("span",{style:{color:"#D73A49"}},"-"),t("span",{style:{color:"#24292E"}}," stride "),t("span",{style:{color:"#D73A49"}},":"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"0"),t("span",{style:{color:"#24292E"}},"))) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                bound "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," nextBound;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                i "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," nextIndex "),t("span",{style:{color:"#D73A49"}},"-"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"1"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                advance "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"false"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (i "),t("span",{style:{color:"#D73A49"}},"<"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"0"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"||"),t("span",{style:{color:"#24292E"}}," i "),t("span",{style:{color:"#D73A49"}},">="),t("span",{style:{color:"#24292E"}}," n "),t("span",{style:{color:"#D73A49"}},"||"),t("span",{style:{color:"#24292E"}}," i "),t("span",{style:{color:"#D73A49"}},"+"),t("span",{style:{color:"#24292E"}}," n "),t("span",{style:{color:"#D73A49"}},">="),t("span",{style:{color:"#24292E"}}," nextn) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," sc;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (finishing) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                nextTable "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"null"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                table "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," nextTab;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                sizeCtl "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," (n "),t("span",{style:{color:"#D73A49"}},"<<"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"1"),t("span",{style:{color:"#24292E"}},") "),t("span",{style:{color:"#D73A49"}},"-"),t("span",{style:{color:"#24292E"}}," (n "),t("span",{style:{color:"#D73A49"}},">>>"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"1"),t("span",{style:{color:"#24292E"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#D73A49"}},"return"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (U."),t("span",{style:{color:"#6F42C1"}},"compareAndSwapInt"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#005CC5"}},"this"),t("span",{style:{color:"#24292E"}},", SIZECTL, sc "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," sizeCtl, sc "),t("span",{style:{color:"#D73A49"}},"-"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"1"),t("span",{style:{color:"#24292E"}},")) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," ((sc "),t("span",{style:{color:"#D73A49"}},"-"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"2"),t("span",{style:{color:"#24292E"}},") "),t("span",{style:{color:"#D73A49"}},"!="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"resizeStamp"),t("span",{style:{color:"#24292E"}},"(n) "),t("span",{style:{color:"#D73A49"}},"<<"),t("span",{style:{color:"#24292E"}}," RESIZE_STAMP_SHIFT)")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                    "),t("span",{style:{color:"#D73A49"}},"return"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                finishing "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," advance "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"true"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                i "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," n; "),t("span",{style:{color:"#6A737D"}},"// recheck before commit")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"else"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," ((f "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"tabAt"),t("span",{style:{color:"#24292E"}},"(tab, i)) "),t("span",{style:{color:"#D73A49"}},"=="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"null"),t("span",{style:{color:"#24292E"}},")")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            advance "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"casTabAt"),t("span",{style:{color:"#24292E"}},"(tab, i, "),t("span",{style:{color:"#005CC5"}},"null"),t("span",{style:{color:"#24292E"}},", fwd);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"else"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," ((fh "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," f.hash) "),t("span",{style:{color:"#D73A49"}},"=="),t("span",{style:{color:"#24292E"}}," MOVED)")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            advance "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"true"),t("span",{style:{color:"#24292E"}},"; "),t("span",{style:{color:"#6A737D"}},"// already processed")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"else"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"synchronized"),t("span",{style:{color:"#24292E"}}," (f) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," ("),t("span",{style:{color:"#6F42C1"}},"tabAt"),t("span",{style:{color:"#24292E"}},"(tab, i) "),t("span",{style:{color:"#D73A49"}},"=="),t("span",{style:{color:"#24292E"}}," f) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                    Node<"),t("span",{style:{color:"#D73A49"}},"K"),t("span",{style:{color:"#24292E"}},","),t("span",{style:{color:"#D73A49"}},"V"),t("span",{style:{color:"#24292E"}},"> ln, hn;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                    "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (fh "),t("span",{style:{color:"#D73A49"}},">="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"0"),t("span",{style:{color:"#24292E"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                        "),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," runBit "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," fh "),t("span",{style:{color:"#D73A49"}},"&"),t("span",{style:{color:"#24292E"}}," n;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                        Node<"),t("span",{style:{color:"#D73A49"}},"K"),t("span",{style:{color:"#24292E"}},","),t("span",{style:{color:"#D73A49"}},"V"),t("span",{style:{color:"#24292E"}},"> lastRun "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," f;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                        "),t("span",{style:{color:"#D73A49"}},"for"),t("span",{style:{color:"#24292E"}}," (Node<"),t("span",{style:{color:"#D73A49"}},"K"),t("span",{style:{color:"#24292E"}},","),t("span",{style:{color:"#D73A49"}},"V"),t("span",{style:{color:"#24292E"}},"> p "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," f.next; p "),t("span",{style:{color:"#D73A49"}},"!="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"null"),t("span",{style:{color:"#24292E"}},"; p "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," p.next) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                            "),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," b "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," p.hash "),t("span",{style:{color:"#D73A49"}},"&"),t("span",{style:{color:"#24292E"}}," n;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                            "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (b "),t("span",{style:{color:"#D73A49"}},"!="),t("span",{style:{color:"#24292E"}}," runBit) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                                runBit "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," b;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                                lastRun "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," p;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                            }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                        "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (runBit "),t("span",{style:{color:"#D73A49"}},"=="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"0"),t("span",{style:{color:"#24292E"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                            ln "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," lastRun;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                            hn "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"null"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                        "),t("span",{style:{color:"#D73A49"}},"else"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                            hn "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," lastRun;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                            ln "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"null"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                        "),t("span",{style:{color:"#D73A49"}},"for"),t("span",{style:{color:"#24292E"}}," (Node<"),t("span",{style:{color:"#D73A49"}},"K"),t("span",{style:{color:"#24292E"}},","),t("span",{style:{color:"#D73A49"}},"V"),t("span",{style:{color:"#24292E"}},"> p "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," f; p "),t("span",{style:{color:"#D73A49"}},"!="),t("span",{style:{color:"#24292E"}}," lastRun; p "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," p.next) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                            "),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," ph "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," p.hash; K pk "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," p.key; V pv "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," p.val;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                            "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," ((ph "),t("span",{style:{color:"#D73A49"}},"&"),t("span",{style:{color:"#24292E"}}," n) "),t("span",{style:{color:"#D73A49"}},"=="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"0"),t("span",{style:{color:"#24292E"}},")")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                                ln "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"new"),t("span",{style:{color:"#24292E"}}," Node<"),t("span",{style:{color:"#D73A49"}},"K"),t("span",{style:{color:"#24292E"}},","),t("span",{style:{color:"#D73A49"}},"V"),t("span",{style:{color:"#24292E"}},">(ph, pk, pv, ln);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                            "),t("span",{style:{color:"#D73A49"}},"else")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                                hn "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"new"),t("span",{style:{color:"#24292E"}}," Node<"),t("span",{style:{color:"#D73A49"}},"K"),t("span",{style:{color:"#24292E"}},","),t("span",{style:{color:"#D73A49"}},"V"),t("span",{style:{color:"#24292E"}},">(ph, pk, pv, hn);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                        "),t("span",{style:{color:"#6F42C1"}},"setTabAt"),t("span",{style:{color:"#24292E"}},"(nextTab, i, ln);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                        "),t("span",{style:{color:"#6F42C1"}},"setTabAt"),t("span",{style:{color:"#24292E"}},"(nextTab, i "),t("span",{style:{color:"#D73A49"}},"+"),t("span",{style:{color:"#24292E"}}," n, hn);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                        "),t("span",{style:{color:"#6F42C1"}},"setTabAt"),t("span",{style:{color:"#24292E"}},"(tab, i, fwd);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                        advance "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"true"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                    "),t("span",{style:{color:"#D73A49"}},"else"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (f "),t("span",{style:{color:"#D73A49"}},"instanceof"),t("span",{style:{color:"#24292E"}}," TreeBin) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                        TreeBin<"),t("span",{style:{color:"#D73A49"}},"K"),t("span",{style:{color:"#24292E"}},","),t("span",{style:{color:"#D73A49"}},"V"),t("span",{style:{color:"#24292E"}},"> t "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," (TreeBin"),t("span",{style:{color:"#D73A49"}},"<"),t("span",{style:{color:"#24292E"}},"K,V"),t("span",{style:{color:"#D73A49"}},">"),t("span",{style:{color:"#24292E"}},")f;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                        TreeNode<"),t("span",{style:{color:"#D73A49"}},"K"),t("span",{style:{color:"#24292E"}},","),t("span",{style:{color:"#D73A49"}},"V"),t("span",{style:{color:"#24292E"}},"> lo "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"null"),t("span",{style:{color:"#24292E"}},", loTail "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"null"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                        TreeNode<"),t("span",{style:{color:"#D73A49"}},"K"),t("span",{style:{color:"#24292E"}},","),t("span",{style:{color:"#D73A49"}},"V"),t("span",{style:{color:"#24292E"}},"> hi "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"null"),t("span",{style:{color:"#24292E"}},", hiTail "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"null"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                        "),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," lc "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"0"),t("span",{style:{color:"#24292E"}},", hc "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"0"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                        "),t("span",{style:{color:"#D73A49"}},"for"),t("span",{style:{color:"#24292E"}}," (Node<"),t("span",{style:{color:"#D73A49"}},"K"),t("span",{style:{color:"#24292E"}},","),t("span",{style:{color:"#D73A49"}},"V"),t("span",{style:{color:"#24292E"}},"> e "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," t.first; e "),t("span",{style:{color:"#D73A49"}},"!="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"null"),t("span",{style:{color:"#24292E"}},"; e "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," e.next) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                            "),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," h "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," e.hash;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                            TreeNode<"),t("span",{style:{color:"#D73A49"}},"K"),t("span",{style:{color:"#24292E"}},","),t("span",{style:{color:"#D73A49"}},"V"),t("span",{style:{color:"#24292E"}},"> p "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"new"),t("span",{style:{color:"#24292E"}}," TreeNode<"),t("span",{style:{color:"#D73A49"}},"K"),t("span",{style:{color:"#24292E"}},","),t("span",{style:{color:"#D73A49"}},"V"),t("span",{style:{color:"#24292E"}},">")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                                (h, e.key, e.val, "),t("span",{style:{color:"#005CC5"}},"null"),t("span",{style:{color:"#24292E"}},", "),t("span",{style:{color:"#005CC5"}},"null"),t("span",{style:{color:"#24292E"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                            "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," ((h "),t("span",{style:{color:"#D73A49"}},"&"),t("span",{style:{color:"#24292E"}}," n) "),t("span",{style:{color:"#D73A49"}},"=="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"0"),t("span",{style:{color:"#24292E"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                                "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," ((p.prev "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," loTail) "),t("span",{style:{color:"#D73A49"}},"=="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"null"),t("span",{style:{color:"#24292E"}},")")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                                    lo "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," p;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                                "),t("span",{style:{color:"#D73A49"}},"else")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                                    loTail.next "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," p;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                                loTail "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," p;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                                "),t("span",{style:{color:"#D73A49"}},"++"),t("span",{style:{color:"#24292E"}},"lc;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                            }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                            "),t("span",{style:{color:"#D73A49"}},"else"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                                "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," ((p.prev "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," hiTail) "),t("span",{style:{color:"#D73A49"}},"=="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"null"),t("span",{style:{color:"#24292E"}},")")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                                    hi "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," p;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                                "),t("span",{style:{color:"#D73A49"}},"else")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                                    hiTail.next "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," p;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                                hiTail "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," p;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                                "),t("span",{style:{color:"#D73A49"}},"++"),t("span",{style:{color:"#24292E"}},"hc;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                            }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                        ln "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," (lc "),t("span",{style:{color:"#D73A49"}},"<="),t("span",{style:{color:"#24292E"}}," UNTREEIFY_THRESHOLD) "),t("span",{style:{color:"#D73A49"}},"?"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"untreeify"),t("span",{style:{color:"#24292E"}},"(lo) "),t("span",{style:{color:"#D73A49"}},":")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                            (hc "),t("span",{style:{color:"#D73A49"}},"!="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"0"),t("span",{style:{color:"#24292E"}},") "),t("span",{style:{color:"#D73A49"}},"?"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"new"),t("span",{style:{color:"#24292E"}}," TreeBin<"),t("span",{style:{color:"#D73A49"}},"K"),t("span",{style:{color:"#24292E"}},","),t("span",{style:{color:"#D73A49"}},"V"),t("span",{style:{color:"#24292E"}},">(lo) "),t("span",{style:{color:"#D73A49"}},":"),t("span",{style:{color:"#24292E"}}," t;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                        hn "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," (hc "),t("span",{style:{color:"#D73A49"}},"<="),t("span",{style:{color:"#24292E"}}," UNTREEIFY_THRESHOLD) "),t("span",{style:{color:"#D73A49"}},"?"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"untreeify"),t("span",{style:{color:"#24292E"}},"(hi) "),t("span",{style:{color:"#D73A49"}},":")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                            (lc "),t("span",{style:{color:"#D73A49"}},"!="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"0"),t("span",{style:{color:"#24292E"}},") "),t("span",{style:{color:"#D73A49"}},"?"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"new"),t("span",{style:{color:"#24292E"}}," TreeBin<"),t("span",{style:{color:"#D73A49"}},"K"),t("span",{style:{color:"#24292E"}},","),t("span",{style:{color:"#D73A49"}},"V"),t("span",{style:{color:"#24292E"}},">(hi) "),t("span",{style:{color:"#D73A49"}},":"),t("span",{style:{color:"#24292E"}}," t;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                        "),t("span",{style:{color:"#6F42C1"}},"setTabAt"),t("span",{style:{color:"#24292E"}},"(nextTab, i, ln);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                        "),t("span",{style:{color:"#6F42C1"}},"setTabAt"),t("span",{style:{color:"#24292E"}},"(nextTab, i "),t("span",{style:{color:"#D73A49"}},"+"),t("span",{style:{color:"#24292E"}}," n, hn);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                        "),t("span",{style:{color:"#6F42C1"}},"setTabAt"),t("span",{style:{color:"#24292E"}},"(tab, i, fwd);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                        advance "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"true"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"}")])])])],-1),bp=t("p",null,"Java 8 数组（Node） +（ 链表 Node | 红黑树 TreeNode ） 以下数组简称（table），链表简称（bin）",-1),mp=t("ul",null,[t("li",null,"初始化，使用 cas 来保证并发安全，懒惰初始化 table"),t("li",null,"树化，当 table.length < 64 时，先尝试扩容，超过 64 时，并且 bin.length > 8 时，会将链表树化，树化过程会用 synchronized 锁住链表头"),t("li",null,"put，如果该 bin 尚未创建，只需要使用 cas 创建 bin；如果已经有了，锁住链表头进行后续 put 操作，元素添加至 bin 的尾部"),t("li",null,"get，无锁操作仅需要保证可见性，扩容过程中 get 操作拿到的是 ForwardingNode 它会让 get 操作在新table 进行搜索"),t("li",null,"扩容，扩容时以 bin 为单位进行，需要对 bin 进行 synchronized，但这时妙的是其它竞争线程也不是无事可做，它们会帮助把其它 bin 进行扩容，扩容时平均只有 1/6 的节点会把复制到新 table 中"),t("li",null,"size，元素个数保存在 baseCount 中，并发时的个数变动保存在 CounterCell[] 当中。最后统计数量时累加即可")],-1),Sp={id:"jdk-7-concurrenthashmap",tabindex:"-1"},vp=t("p",null,"它维护了一个 segment（分段） 数组，每个 segment 对应一把锁",-1),wp=t("ul",null,[t("li",null,"优点：如果多个线程访问不同的 segment，实际是没有冲突的，这与 jdk8 中是类似的"),t("li",null,"缺点：Segments 数组默认大小为16，这个容量初始化指定后就不能改变了，并且不是懒惰初始化")],-1),Tp={id:"构造器分析-1",tabindex:"-1"},xp=t("blockquote",null,[t("p",null,"segmentShift：移位属性；当segments数组大小为16，则segmentShift=32-4=28"),t("p",null,"segmentMask：掩码属性；当segments数组大小为16，则segmentMask=15 即 0000 0000 0000 1111"),t("p",null,"两者的目的是将来你put/get你的key时，通过移位和掩码计算确定key到底对应segment数组中的哪个元素")],-1),Np=t("div",{class:"language-java"},[t("button",{title:"Copy Code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki github-dark vp-code-dark"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"public"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"ConcurrentHashMap"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," initialCapacity, "),t("span",{style:{color:"#F97583"}},"float"),t("span",{style:{color:"#E1E4E8"}}," loadFactor, "),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," concurrencyLevel) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," ("),t("span",{style:{color:"#F97583"}},"!"),t("span",{style:{color:"#E1E4E8"}},"(loadFactor "),t("span",{style:{color:"#F97583"}},">"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"0"),t("span",{style:{color:"#E1E4E8"}},") "),t("span",{style:{color:"#F97583"}},"||"),t("span",{style:{color:"#E1E4E8"}}," initialCapacity "),t("span",{style:{color:"#F97583"}},"<"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"0"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"||"),t("span",{style:{color:"#E1E4E8"}}," concurrencyLevel "),t("span",{style:{color:"#F97583"}},"<="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"0"),t("span",{style:{color:"#E1E4E8"}},")")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    \t"),t("span",{style:{color:"#F97583"}},"throw"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"new"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"IllegalArgumentException"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (concurrencyLevel "),t("span",{style:{color:"#F97583"}},">"),t("span",{style:{color:"#E1E4E8"}}," MAX_SEGMENTS)")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    \tconcurrencyLevel "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," MAX_SEGMENTS;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// ssize 必须是 2^n, 即 2, 4, 8, 16 ... 表示了 segments 数组的大小")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," sshift "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"0"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," ssize "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"1"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"while"),t("span",{style:{color:"#E1E4E8"}}," (ssize "),t("span",{style:{color:"#F97583"}},"<"),t("span",{style:{color:"#E1E4E8"}}," concurrencyLevel) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"++"),t("span",{style:{color:"#E1E4E8"}},"sshift;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        ssize "),t("span",{style:{color:"#F97583"}},"<<="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"1"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// segmentShift 默认是 32 - 4 = 28")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#79B8FF"}},"this"),t("span",{style:{color:"#E1E4E8"}},".segmentShift "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"32"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"-"),t("span",{style:{color:"#E1E4E8"}}," sshift;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// segmentMask 默认是 15 即 0000 0000 0000 1111")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#79B8FF"}},"this"),t("span",{style:{color:"#E1E4E8"}},".segmentMask "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," ssize "),t("span",{style:{color:"#F97583"}},"-"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"1"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (initialCapacity "),t("span",{style:{color:"#F97583"}},">"),t("span",{style:{color:"#E1E4E8"}}," MAXIMUM_CAPACITY)")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    \tinitialCapacity "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," MAXIMUM_CAPACITY;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," c "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," initialCapacity "),t("span",{style:{color:"#F97583"}},"/"),t("span",{style:{color:"#E1E4E8"}}," ssize;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (c "),t("span",{style:{color:"#F97583"}},"*"),t("span",{style:{color:"#E1E4E8"}}," ssize "),t("span",{style:{color:"#F97583"}},"<"),t("span",{style:{color:"#E1E4E8"}}," initialCapacity)")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    \t"),t("span",{style:{color:"#F97583"}},"++"),t("span",{style:{color:"#E1E4E8"}},"c;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," cap "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," MIN_SEGMENT_TABLE_CAPACITY;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"while"),t("span",{style:{color:"#E1E4E8"}}," (cap "),t("span",{style:{color:"#F97583"}},"<"),t("span",{style:{color:"#E1E4E8"}}," c)")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    \tcap "),t("span",{style:{color:"#F97583"}},"<<="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"1"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// 创建 segments and segments[0]")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    Segment<"),t("span",{style:{color:"#F97583"}},"K"),t("span",{style:{color:"#E1E4E8"}},","),t("span",{style:{color:"#F97583"}},"V"),t("span",{style:{color:"#E1E4E8"}},"> s0 "),t("span",{style:{color:"#F97583"}},"=")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    \t"),t("span",{style:{color:"#F97583"}},"new"),t("span",{style:{color:"#E1E4E8"}}," Segment<"),t("span",{style:{color:"#F97583"}},"K"),t("span",{style:{color:"#E1E4E8"}},","),t("span",{style:{color:"#F97583"}},"V"),t("span",{style:{color:"#E1E4E8"}},">(loadFactor, ("),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}},")(cap "),t("span",{style:{color:"#F97583"}},"*"),t("span",{style:{color:"#E1E4E8"}}," loadFactor),")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    \t\t\t\t\t\t(HashEntry"),t("span",{style:{color:"#F97583"}},"<"),t("span",{style:{color:"#E1E4E8"}},"K,V"),t("span",{style:{color:"#F97583"}},">"),t("span",{style:{color:"#E1E4E8"}},"[])"),t("span",{style:{color:"#F97583"}},"new"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"HashEntry"),t("span",{style:{color:"#E1E4E8"}},"[cap]);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    Segment<"),t("span",{style:{color:"#F97583"}},"K"),t("span",{style:{color:"#E1E4E8"}},","),t("span",{style:{color:"#F97583"}},"V"),t("span",{style:{color:"#E1E4E8"}},">[] ss "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," (Segment"),t("span",{style:{color:"#F97583"}},"<"),t("span",{style:{color:"#E1E4E8"}},"K,V"),t("span",{style:{color:"#F97583"}},">"),t("span",{style:{color:"#E1E4E8"}},"[])"),t("span",{style:{color:"#F97583"}},"new"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"Segment"),t("span",{style:{color:"#E1E4E8"}},"[ssize];")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    UNSAFE."),t("span",{style:{color:"#B392F0"}},"putOrderedObject"),t("span",{style:{color:"#E1E4E8"}},"(ss, SBASE, s0); "),t("span",{style:{color:"#6A737D"}},"// ordered write of segments[0]")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#79B8FF"}},"this"),t("span",{style:{color:"#E1E4E8"}},".segments "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," ss;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"}")])])]),t("pre",{class:"shiki github-light vp-code-light"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"public"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"ConcurrentHashMap"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," initialCapacity, "),t("span",{style:{color:"#D73A49"}},"float"),t("span",{style:{color:"#24292E"}}," loadFactor, "),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," concurrencyLevel) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," ("),t("span",{style:{color:"#D73A49"}},"!"),t("span",{style:{color:"#24292E"}},"(loadFactor "),t("span",{style:{color:"#D73A49"}},">"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"0"),t("span",{style:{color:"#24292E"}},") "),t("span",{style:{color:"#D73A49"}},"||"),t("span",{style:{color:"#24292E"}}," initialCapacity "),t("span",{style:{color:"#D73A49"}},"<"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"0"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"||"),t("span",{style:{color:"#24292E"}}," concurrencyLevel "),t("span",{style:{color:"#D73A49"}},"<="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"0"),t("span",{style:{color:"#24292E"}},")")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    \t"),t("span",{style:{color:"#D73A49"}},"throw"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"new"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"IllegalArgumentException"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (concurrencyLevel "),t("span",{style:{color:"#D73A49"}},">"),t("span",{style:{color:"#24292E"}}," MAX_SEGMENTS)")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    \tconcurrencyLevel "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," MAX_SEGMENTS;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// ssize 必须是 2^n, 即 2, 4, 8, 16 ... 表示了 segments 数组的大小")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," sshift "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"0"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," ssize "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"1"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"while"),t("span",{style:{color:"#24292E"}}," (ssize "),t("span",{style:{color:"#D73A49"}},"<"),t("span",{style:{color:"#24292E"}}," concurrencyLevel) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"++"),t("span",{style:{color:"#24292E"}},"sshift;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        ssize "),t("span",{style:{color:"#D73A49"}},"<<="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"1"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// segmentShift 默认是 32 - 4 = 28")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#005CC5"}},"this"),t("span",{style:{color:"#24292E"}},".segmentShift "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"32"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"-"),t("span",{style:{color:"#24292E"}}," sshift;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// segmentMask 默认是 15 即 0000 0000 0000 1111")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#005CC5"}},"this"),t("span",{style:{color:"#24292E"}},".segmentMask "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," ssize "),t("span",{style:{color:"#D73A49"}},"-"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"1"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (initialCapacity "),t("span",{style:{color:"#D73A49"}},">"),t("span",{style:{color:"#24292E"}}," MAXIMUM_CAPACITY)")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    \tinitialCapacity "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," MAXIMUM_CAPACITY;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," c "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," initialCapacity "),t("span",{style:{color:"#D73A49"}},"/"),t("span",{style:{color:"#24292E"}}," ssize;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (c "),t("span",{style:{color:"#D73A49"}},"*"),t("span",{style:{color:"#24292E"}}," ssize "),t("span",{style:{color:"#D73A49"}},"<"),t("span",{style:{color:"#24292E"}}," initialCapacity)")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    \t"),t("span",{style:{color:"#D73A49"}},"++"),t("span",{style:{color:"#24292E"}},"c;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," cap "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," MIN_SEGMENT_TABLE_CAPACITY;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"while"),t("span",{style:{color:"#24292E"}}," (cap "),t("span",{style:{color:"#D73A49"}},"<"),t("span",{style:{color:"#24292E"}}," c)")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    \tcap "),t("span",{style:{color:"#D73A49"}},"<<="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"1"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// 创建 segments and segments[0]")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    Segment<"),t("span",{style:{color:"#D73A49"}},"K"),t("span",{style:{color:"#24292E"}},","),t("span",{style:{color:"#D73A49"}},"V"),t("span",{style:{color:"#24292E"}},"> s0 "),t("span",{style:{color:"#D73A49"}},"=")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    \t"),t("span",{style:{color:"#D73A49"}},"new"),t("span",{style:{color:"#24292E"}}," Segment<"),t("span",{style:{color:"#D73A49"}},"K"),t("span",{style:{color:"#24292E"}},","),t("span",{style:{color:"#D73A49"}},"V"),t("span",{style:{color:"#24292E"}},">(loadFactor, ("),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}},")(cap "),t("span",{style:{color:"#D73A49"}},"*"),t("span",{style:{color:"#24292E"}}," loadFactor),")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    \t\t\t\t\t\t(HashEntry"),t("span",{style:{color:"#D73A49"}},"<"),t("span",{style:{color:"#24292E"}},"K,V"),t("span",{style:{color:"#D73A49"}},">"),t("span",{style:{color:"#24292E"}},"[])"),t("span",{style:{color:"#D73A49"}},"new"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"HashEntry"),t("span",{style:{color:"#24292E"}},"[cap]);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    Segment<"),t("span",{style:{color:"#D73A49"}},"K"),t("span",{style:{color:"#24292E"}},","),t("span",{style:{color:"#D73A49"}},"V"),t("span",{style:{color:"#24292E"}},">[] ss "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," (Segment"),t("span",{style:{color:"#D73A49"}},"<"),t("span",{style:{color:"#24292E"}},"K,V"),t("span",{style:{color:"#D73A49"}},">"),t("span",{style:{color:"#24292E"}},"[])"),t("span",{style:{color:"#D73A49"}},"new"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"Segment"),t("span",{style:{color:"#24292E"}},"[ssize];")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    UNSAFE."),t("span",{style:{color:"#6F42C1"}},"putOrderedObject"),t("span",{style:{color:"#24292E"}},"(ss, SBASE, s0); "),t("span",{style:{color:"#6A737D"}},"// ordered write of segments[0]")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#005CC5"}},"this"),t("span",{style:{color:"#24292E"}},".segments "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," ss;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"}")])])])],-1),Ip=t("p",null,"构造完成，如下图所示",-1),Lp=t("figure",null,[t("img",{src:"https://jsd.cdn.zzko.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230720153932589.png",alt:"image-20230720153932589",loading:"lazy",decoding:"async"})],-1),jp=t("p",null,[p("可以看到 ConcurrentHashMap 没有实现懒惰初始化，空间占用不友好 其中 this.segmentShift 和 this.segmentMask 的作用是决定将 key 的 hash 结果匹配到哪个 segment 例如，根据某一 hash 值求 segment 位置，先将高位向低位移动 "),t("code",null,"this.segmentShift"),p(" 位")],-1),Rp=t("figure",null,[t("img",{src:"https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230720153953515.png",alt:"image-20230720153953515",loading:"lazy",decoding:"async"})],-1),Op=t("p",null,"结果再与 this.segmentMask 做位于运算（&），最终得到 1010 即下标为 10 的 segment",-1),qp=t("figure",null,[t("img",{src:"https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230720154003822.png",alt:"image-20230720154003822",loading:"lazy",decoding:"async"})],-1),Pp=t("p",null,"put 流程",-1),zp=t("blockquote",null,[t("p",null,[p("除了segment数组和segment[0]不是懒惰初始化，其他位置都是懒惰初始化（"),t("code",null,"segment[1]-hashEntry<key,value>"),p("...）")]),t("p",null,"concurrentHashMap的put方法是调用segment的put方法")],-1),_p=t("div",{class:"language-java"},[t("button",{title:"Copy Code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki github-dark vp-code-dark"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"public"),t("span",{style:{color:"#E1E4E8"}}," V "),t("span",{style:{color:"#B392F0"}},"put"),t("span",{style:{color:"#E1E4E8"}},"(K key, V value) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    Segment<"),t("span",{style:{color:"#F97583"}},"K"),t("span",{style:{color:"#E1E4E8"}},","),t("span",{style:{color:"#F97583"}},"V"),t("span",{style:{color:"#E1E4E8"}},"> s;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (value "),t("span",{style:{color:"#F97583"}},"=="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"null"),t("span",{style:{color:"#E1E4E8"}},")")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    \t"),t("span",{style:{color:"#F97583"}},"throw"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"new"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"NullPointerException"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," hash "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"hash"),t("span",{style:{color:"#E1E4E8"}},"(key);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// 计算出 segment 下标")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," j "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," (hash "),t("span",{style:{color:"#F97583"}},">>>"),t("span",{style:{color:"#E1E4E8"}}," segmentShift) "),t("span",{style:{color:"#F97583"}},"&"),t("span",{style:{color:"#E1E4E8"}}," segmentMask;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// 获得 segment 对象, 判断是否为 null, 是则创建该 segment")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," ((s "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," (Segment"),t("span",{style:{color:"#F97583"}},"<"),t("span",{style:{color:"#E1E4E8"}},"K,V"),t("span",{style:{color:"#F97583"}},">"),t("span",{style:{color:"#E1E4E8"}},")UNSAFE.getObject")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    \t(segments, (j "),t("span",{style:{color:"#F97583"}},"<<"),t("span",{style:{color:"#E1E4E8"}}," SSHIFT) "),t("span",{style:{color:"#F97583"}},"+"),t("span",{style:{color:"#E1E4E8"}}," SBASE)) "),t("span",{style:{color:"#F97583"}},"=="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"null"),t("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#6A737D"}},"// 这时不能确定是否真的为 null, 因为其它线程也发现该 segment 为 null,")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#6A737D"}},"// 因此在 ensureSegment 里用 cas 方式保证该 segment 安全性")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        s "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"ensureSegment"),t("span",{style:{color:"#E1E4E8"}},"(j);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// 进入 segment 的put 流程")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"return"),t("span",{style:{color:"#E1E4E8"}}," s."),t("span",{style:{color:"#B392F0"}},"put"),t("span",{style:{color:"#E1E4E8"}},"(key, hash, value, "),t("span",{style:{color:"#79B8FF"}},"false"),t("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"}")])])]),t("pre",{class:"shiki github-light vp-code-light"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"public"),t("span",{style:{color:"#24292E"}}," V "),t("span",{style:{color:"#6F42C1"}},"put"),t("span",{style:{color:"#24292E"}},"(K key, V value) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    Segment<"),t("span",{style:{color:"#D73A49"}},"K"),t("span",{style:{color:"#24292E"}},","),t("span",{style:{color:"#D73A49"}},"V"),t("span",{style:{color:"#24292E"}},"> s;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (value "),t("span",{style:{color:"#D73A49"}},"=="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"null"),t("span",{style:{color:"#24292E"}},")")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    \t"),t("span",{style:{color:"#D73A49"}},"throw"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"new"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"NullPointerException"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," hash "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"hash"),t("span",{style:{color:"#24292E"}},"(key);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// 计算出 segment 下标")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," j "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," (hash "),t("span",{style:{color:"#D73A49"}},">>>"),t("span",{style:{color:"#24292E"}}," segmentShift) "),t("span",{style:{color:"#D73A49"}},"&"),t("span",{style:{color:"#24292E"}}," segmentMask;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// 获得 segment 对象, 判断是否为 null, 是则创建该 segment")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," ((s "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," (Segment"),t("span",{style:{color:"#D73A49"}},"<"),t("span",{style:{color:"#24292E"}},"K,V"),t("span",{style:{color:"#D73A49"}},">"),t("span",{style:{color:"#24292E"}},")UNSAFE.getObject")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    \t(segments, (j "),t("span",{style:{color:"#D73A49"}},"<<"),t("span",{style:{color:"#24292E"}}," SSHIFT) "),t("span",{style:{color:"#D73A49"}},"+"),t("span",{style:{color:"#24292E"}}," SBASE)) "),t("span",{style:{color:"#D73A49"}},"=="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"null"),t("span",{style:{color:"#24292E"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6A737D"}},"// 这时不能确定是否真的为 null, 因为其它线程也发现该 segment 为 null,")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6A737D"}},"// 因此在 ensureSegment 里用 cas 方式保证该 segment 安全性")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        s "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"ensureSegment"),t("span",{style:{color:"#24292E"}},"(j);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// 进入 segment 的put 流程")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"return"),t("span",{style:{color:"#24292E"}}," s."),t("span",{style:{color:"#6F42C1"}},"put"),t("span",{style:{color:"#24292E"}},"(key, hash, value, "),t("span",{style:{color:"#005CC5"}},"false"),t("span",{style:{color:"#24292E"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"}")])])])],-1),Kp=t("p",null,"segment 继承了可重入锁（ReentrantLock），它的 put 方法为",-1),Vp=t("div",{class:"language-java"},[t("button",{title:"Copy Code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki github-dark vp-code-dark"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"final"),t("span",{style:{color:"#E1E4E8"}}," V "),t("span",{style:{color:"#B392F0"}},"put"),t("span",{style:{color:"#E1E4E8"}},"(K key, "),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," hash, V value, "),t("span",{style:{color:"#F97583"}},"boolean"),t("span",{style:{color:"#E1E4E8"}}," onlyIfAbsent) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// 尝试加锁")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    HashEntry<"),t("span",{style:{color:"#F97583"}},"K"),t("span",{style:{color:"#E1E4E8"}},","),t("span",{style:{color:"#F97583"}},"V"),t("span",{style:{color:"#E1E4E8"}},"> node "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"tryLock"),t("span",{style:{color:"#E1E4E8"}},"() "),t("span",{style:{color:"#F97583"}},"?"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"null"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},":")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// 如果不成功, 进入 scanAndLockForPut 流程")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// 如果是多核 cpu 最多 tryLock 64 次, 进入 lock 流程")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// 在尝试期间, 还可以顺便看该节点在链表中有没有, 如果没有顺便创建出来")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#B392F0"}},"scanAndLockForPut"),t("span",{style:{color:"#E1E4E8"}},"(key, hash, value);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// 执行到这里 segment 已经被成功加锁, 可以安全执行")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    V oldValue;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"try"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        HashEntry<"),t("span",{style:{color:"#F97583"}},"K"),t("span",{style:{color:"#E1E4E8"}},","),t("span",{style:{color:"#F97583"}},"V"),t("span",{style:{color:"#E1E4E8"}},">[] tab "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," table;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," index "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," (tab.length "),t("span",{style:{color:"#F97583"}},"-"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"1"),t("span",{style:{color:"#E1E4E8"}},") "),t("span",{style:{color:"#F97583"}},"&"),t("span",{style:{color:"#E1E4E8"}}," hash;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        HashEntry<"),t("span",{style:{color:"#F97583"}},"K"),t("span",{style:{color:"#E1E4E8"}},","),t("span",{style:{color:"#F97583"}},"V"),t("span",{style:{color:"#E1E4E8"}},"> first "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"entryAt"),t("span",{style:{color:"#E1E4E8"}},"(tab, index);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"for"),t("span",{style:{color:"#E1E4E8"}}," (HashEntry<"),t("span",{style:{color:"#F97583"}},"K"),t("span",{style:{color:"#E1E4E8"}},","),t("span",{style:{color:"#F97583"}},"V"),t("span",{style:{color:"#E1E4E8"}},"> e "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," first;;) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (e "),t("span",{style:{color:"#F97583"}},"!="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"null"),t("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#6A737D"}},"// 更新")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                K k;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," ((k "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," e.key) "),t("span",{style:{color:"#F97583"}},"=="),t("span",{style:{color:"#E1E4E8"}}," key "),t("span",{style:{color:"#F97583"}},"||")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                        (e.hash "),t("span",{style:{color:"#F97583"}},"=="),t("span",{style:{color:"#E1E4E8"}}," hash "),t("span",{style:{color:"#F97583"}},"&&"),t("span",{style:{color:"#E1E4E8"}}," key."),t("span",{style:{color:"#B392F0"}},"equals"),t("span",{style:{color:"#E1E4E8"}},"(k))) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                    oldValue "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," e.value;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                    "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," ("),t("span",{style:{color:"#F97583"}},"!"),t("span",{style:{color:"#E1E4E8"}},"onlyIfAbsent) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                        e.value "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," value;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                        "),t("span",{style:{color:"#F97583"}},"++"),t("span",{style:{color:"#E1E4E8"}},"modCount;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                    "),t("span",{style:{color:"#F97583"}},"break"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                e "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," e.next;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"else"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#6A737D"}},"// 新增")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#6A737D"}},"// 1) 之前等待锁时, node 已经被创建, next 指向链表头")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (node "),t("span",{style:{color:"#F97583"}},"!="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"null"),t("span",{style:{color:"#E1E4E8"}},")")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                    node."),t("span",{style:{color:"#B392F0"}},"setNext"),t("span",{style:{color:"#E1E4E8"}},"(first);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#F97583"}},"else")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                    "),t("span",{style:{color:"#6A737D"}},"// 2) 创建新 node")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                    node "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"new"),t("span",{style:{color:"#E1E4E8"}}," HashEntry<"),t("span",{style:{color:"#F97583"}},"K"),t("span",{style:{color:"#E1E4E8"}},","),t("span",{style:{color:"#F97583"}},"V"),t("span",{style:{color:"#E1E4E8"}},">(hash, key, value, first);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," c "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," count "),t("span",{style:{color:"#F97583"}},"+"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"1"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#6A737D"}},"// 3) 扩容")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (c "),t("span",{style:{color:"#F97583"}},">"),t("span",{style:{color:"#E1E4E8"}}," threshold "),t("span",{style:{color:"#F97583"}},"&&"),t("span",{style:{color:"#E1E4E8"}}," tab.length "),t("span",{style:{color:"#F97583"}},"<"),t("span",{style:{color:"#E1E4E8"}}," MAXIMUM_CAPACITY)")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                    "),t("span",{style:{color:"#B392F0"}},"rehash"),t("span",{style:{color:"#E1E4E8"}},"(node);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#F97583"}},"else")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                    "),t("span",{style:{color:"#6A737D"}},"// 将 node 作为链表头")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                    "),t("span",{style:{color:"#B392F0"}},"setEntryAt"),t("span",{style:{color:"#E1E4E8"}},"(tab, index, node);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#F97583"}},"++"),t("span",{style:{color:"#E1E4E8"}},"modCount;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                count "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," c;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                oldValue "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"null"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#F97583"}},"break"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    } "),t("span",{style:{color:"#F97583"}},"finally"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#B392F0"}},"unlock"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"return"),t("span",{style:{color:"#E1E4E8"}}," oldValue;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"}")])])]),t("pre",{class:"shiki github-light vp-code-light"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"final"),t("span",{style:{color:"#24292E"}}," V "),t("span",{style:{color:"#6F42C1"}},"put"),t("span",{style:{color:"#24292E"}},"(K key, "),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," hash, V value, "),t("span",{style:{color:"#D73A49"}},"boolean"),t("span",{style:{color:"#24292E"}}," onlyIfAbsent) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// 尝试加锁")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    HashEntry<"),t("span",{style:{color:"#D73A49"}},"K"),t("span",{style:{color:"#24292E"}},","),t("span",{style:{color:"#D73A49"}},"V"),t("span",{style:{color:"#24292E"}},"> node "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"tryLock"),t("span",{style:{color:"#24292E"}},"() "),t("span",{style:{color:"#D73A49"}},"?"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"null"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},":")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// 如果不成功, 进入 scanAndLockForPut 流程")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// 如果是多核 cpu 最多 tryLock 64 次, 进入 lock 流程")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// 在尝试期间, 还可以顺便看该节点在链表中有没有, 如果没有顺便创建出来")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6F42C1"}},"scanAndLockForPut"),t("span",{style:{color:"#24292E"}},"(key, hash, value);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// 执行到这里 segment 已经被成功加锁, 可以安全执行")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    V oldValue;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"try"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        HashEntry<"),t("span",{style:{color:"#D73A49"}},"K"),t("span",{style:{color:"#24292E"}},","),t("span",{style:{color:"#D73A49"}},"V"),t("span",{style:{color:"#24292E"}},">[] tab "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," table;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," index "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," (tab.length "),t("span",{style:{color:"#D73A49"}},"-"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"1"),t("span",{style:{color:"#24292E"}},") "),t("span",{style:{color:"#D73A49"}},"&"),t("span",{style:{color:"#24292E"}}," hash;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        HashEntry<"),t("span",{style:{color:"#D73A49"}},"K"),t("span",{style:{color:"#24292E"}},","),t("span",{style:{color:"#D73A49"}},"V"),t("span",{style:{color:"#24292E"}},"> first "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"entryAt"),t("span",{style:{color:"#24292E"}},"(tab, index);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"for"),t("span",{style:{color:"#24292E"}}," (HashEntry<"),t("span",{style:{color:"#D73A49"}},"K"),t("span",{style:{color:"#24292E"}},","),t("span",{style:{color:"#D73A49"}},"V"),t("span",{style:{color:"#24292E"}},"> e "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," first;;) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (e "),t("span",{style:{color:"#D73A49"}},"!="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"null"),t("span",{style:{color:"#24292E"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#6A737D"}},"// 更新")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                K k;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," ((k "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," e.key) "),t("span",{style:{color:"#D73A49"}},"=="),t("span",{style:{color:"#24292E"}}," key "),t("span",{style:{color:"#D73A49"}},"||")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                        (e.hash "),t("span",{style:{color:"#D73A49"}},"=="),t("span",{style:{color:"#24292E"}}," hash "),t("span",{style:{color:"#D73A49"}},"&&"),t("span",{style:{color:"#24292E"}}," key."),t("span",{style:{color:"#6F42C1"}},"equals"),t("span",{style:{color:"#24292E"}},"(k))) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                    oldValue "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," e.value;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                    "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," ("),t("span",{style:{color:"#D73A49"}},"!"),t("span",{style:{color:"#24292E"}},"onlyIfAbsent) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                        e.value "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," value;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                        "),t("span",{style:{color:"#D73A49"}},"++"),t("span",{style:{color:"#24292E"}},"modCount;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                    "),t("span",{style:{color:"#D73A49"}},"break"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                e "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," e.next;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"else"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#6A737D"}},"// 新增")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#6A737D"}},"// 1) 之前等待锁时, node 已经被创建, next 指向链表头")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (node "),t("span",{style:{color:"#D73A49"}},"!="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"null"),t("span",{style:{color:"#24292E"}},")")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                    node."),t("span",{style:{color:"#6F42C1"}},"setNext"),t("span",{style:{color:"#24292E"}},"(first);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#D73A49"}},"else")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                    "),t("span",{style:{color:"#6A737D"}},"// 2) 创建新 node")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                    node "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"new"),t("span",{style:{color:"#24292E"}}," HashEntry<"),t("span",{style:{color:"#D73A49"}},"K"),t("span",{style:{color:"#24292E"}},","),t("span",{style:{color:"#D73A49"}},"V"),t("span",{style:{color:"#24292E"}},">(hash, key, value, first);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," c "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," count "),t("span",{style:{color:"#D73A49"}},"+"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"1"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#6A737D"}},"// 3) 扩容")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (c "),t("span",{style:{color:"#D73A49"}},">"),t("span",{style:{color:"#24292E"}}," threshold "),t("span",{style:{color:"#D73A49"}},"&&"),t("span",{style:{color:"#24292E"}}," tab.length "),t("span",{style:{color:"#D73A49"}},"<"),t("span",{style:{color:"#24292E"}}," MAXIMUM_CAPACITY)")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                    "),t("span",{style:{color:"#6F42C1"}},"rehash"),t("span",{style:{color:"#24292E"}},"(node);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#D73A49"}},"else")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                    "),t("span",{style:{color:"#6A737D"}},"// 将 node 作为链表头")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                    "),t("span",{style:{color:"#6F42C1"}},"setEntryAt"),t("span",{style:{color:"#24292E"}},"(tab, index, node);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#D73A49"}},"++"),t("span",{style:{color:"#24292E"}},"modCount;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                count "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," c;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                oldValue "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"null"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#D73A49"}},"break"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    } "),t("span",{style:{color:"#D73A49"}},"finally"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6F42C1"}},"unlock"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"return"),t("span",{style:{color:"#24292E"}}," oldValue;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"}")])])])],-1),Mp=t("blockquote",null,[t("p",null,[p("在尝试加锁期间, 还可以顺便看你要put的节点（"),t("code",null,"HashEntry<K,V> node"),p("-> <- (k,v) ->）在链表中有没有, 如果没有顺便创建出来")]),t("p",null,"更新的时候，若是同一个对象的值会被新的值覆盖掉"),t("p",null,"新增的时候，（1）因为尝试加锁期间node就创建出来了，那么新增的值就会插入链表头（头插法，线程安全，不会发生死链）；（2）若node还没创建就会先去创建出来；（3）超过阈值就扩容，未超过就将新增节点作为链表头")],-1),Wp={id:"rehash-流程",tabindex:"-1"},Up=t("p",null,"发生在 put 中，因为此时已经获得了锁，因此 rehash 时不需要考虑线程安全",-1),Qp=t("div",{class:"language-java"},[t("button",{title:"Copy Code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki github-dark vp-code-dark"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"private"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"void"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"rehash"),t("span",{style:{color:"#E1E4E8"}},"(HashEntry"),t("span",{style:{color:"#F97583"}},"<"),t("span",{style:{color:"#E1E4E8"}},"K,V"),t("span",{style:{color:"#F97583"}},">"),t("span",{style:{color:"#E1E4E8"}}," node) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        HashEntry<"),t("span",{style:{color:"#F97583"}},"K"),t("span",{style:{color:"#E1E4E8"}},","),t("span",{style:{color:"#F97583"}},"V"),t("span",{style:{color:"#E1E4E8"}},">[] oldTable "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," table;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," oldCapacity "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," oldTable.length;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," newCapacity "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," oldCapacity "),t("span",{style:{color:"#F97583"}},"<<"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"1"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        threshold "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," ("),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}},")(newCapacity "),t("span",{style:{color:"#F97583"}},"*"),t("span",{style:{color:"#E1E4E8"}}," loadFactor);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        HashEntry<"),t("span",{style:{color:"#F97583"}},"K"),t("span",{style:{color:"#E1E4E8"}},","),t("span",{style:{color:"#F97583"}},"V"),t("span",{style:{color:"#E1E4E8"}},">[] newTable "),t("span",{style:{color:"#F97583"}},"=")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                (HashEntry"),t("span",{style:{color:"#F97583"}},"<"),t("span",{style:{color:"#E1E4E8"}},"K,V"),t("span",{style:{color:"#F97583"}},">"),t("span",{style:{color:"#E1E4E8"}},"[]) "),t("span",{style:{color:"#F97583"}},"new"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"HashEntry"),t("span",{style:{color:"#E1E4E8"}},"[newCapacity];")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," sizeMask "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," newCapacity "),t("span",{style:{color:"#F97583"}},"-"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"1"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"for"),t("span",{style:{color:"#E1E4E8"}}," ("),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," i "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"0"),t("span",{style:{color:"#E1E4E8"}},"; i "),t("span",{style:{color:"#F97583"}},"<"),t("span",{style:{color:"#E1E4E8"}}," oldCapacity ; i"),t("span",{style:{color:"#F97583"}},"++"),t("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            HashEntry<"),t("span",{style:{color:"#F97583"}},"K"),t("span",{style:{color:"#E1E4E8"}},","),t("span",{style:{color:"#F97583"}},"V"),t("span",{style:{color:"#E1E4E8"}},"> e "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," oldTable[i];")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (e "),t("span",{style:{color:"#F97583"}},"!="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"null"),t("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                HashEntry<"),t("span",{style:{color:"#F97583"}},"K"),t("span",{style:{color:"#E1E4E8"}},","),t("span",{style:{color:"#F97583"}},"V"),t("span",{style:{color:"#E1E4E8"}},"> next "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," e.next;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," idx "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," e.hash "),t("span",{style:{color:"#F97583"}},"&"),t("span",{style:{color:"#E1E4E8"}}," sizeMask;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (next "),t("span",{style:{color:"#F97583"}},"=="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"null"),t("span",{style:{color:"#E1E4E8"}},") "),t("span",{style:{color:"#6A737D"}},"// Single node on list")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                    newTable[idx] "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," e;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#F97583"}},"else"),t("span",{style:{color:"#E1E4E8"}}," { "),t("span",{style:{color:"#6A737D"}},"// Reuse consecutive sequence at same slot")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                    HashEntry<"),t("span",{style:{color:"#F97583"}},"K"),t("span",{style:{color:"#E1E4E8"}},","),t("span",{style:{color:"#F97583"}},"V"),t("span",{style:{color:"#E1E4E8"}},"> lastRun "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," e;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                    "),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," lastIdx "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," idx;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"\t\t\t\t\t"),t("span",{style:{color:"#6A737D"}},"// 过一遍链表, 尽可能把 rehash 后 idx 不变的节点重用")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                    "),t("span",{style:{color:"#F97583"}},"for"),t("span",{style:{color:"#E1E4E8"}}," (HashEntry<"),t("span",{style:{color:"#F97583"}},"K"),t("span",{style:{color:"#E1E4E8"}},","),t("span",{style:{color:"#F97583"}},"V"),t("span",{style:{color:"#E1E4E8"}},"> last "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," next;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                         last "),t("span",{style:{color:"#F97583"}},"!="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"null"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                         last "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," last.next) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                        "),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," k "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," last.hash "),t("span",{style:{color:"#F97583"}},"&"),t("span",{style:{color:"#E1E4E8"}}," sizeMask;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                        "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (k "),t("span",{style:{color:"#F97583"}},"!="),t("span",{style:{color:"#E1E4E8"}}," lastIdx) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                            lastIdx "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," k;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                            lastRun "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," last;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                    newTable[lastIdx] "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," lastRun;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"\t\t\t\t\t"),t("span",{style:{color:"#6A737D"}},"// 剩余节点需要新建")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                    "),t("span",{style:{color:"#F97583"}},"for"),t("span",{style:{color:"#E1E4E8"}}," (HashEntry<"),t("span",{style:{color:"#F97583"}},"K"),t("span",{style:{color:"#E1E4E8"}},","),t("span",{style:{color:"#F97583"}},"V"),t("span",{style:{color:"#E1E4E8"}},"> p "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," e; p "),t("span",{style:{color:"#F97583"}},"!="),t("span",{style:{color:"#E1E4E8"}}," lastRun; p "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," p.next) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                        V v "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," p.value;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                        "),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," h "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," p.hash;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                        "),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," k "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," h "),t("span",{style:{color:"#F97583"}},"&"),t("span",{style:{color:"#E1E4E8"}}," sizeMask;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                        HashEntry<"),t("span",{style:{color:"#F97583"}},"K"),t("span",{style:{color:"#E1E4E8"}},","),t("span",{style:{color:"#F97583"}},"V"),t("span",{style:{color:"#E1E4E8"}},"> n "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," newTable[k];")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                        newTable[k] "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"new"),t("span",{style:{color:"#E1E4E8"}}," HashEntry<"),t("span",{style:{color:"#F97583"}},"K"),t("span",{style:{color:"#E1E4E8"}},","),t("span",{style:{color:"#F97583"}},"V"),t("span",{style:{color:"#E1E4E8"}},">(h, p.key, v, n);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"\t\t"),t("span",{style:{color:"#6A737D"}},"// 扩容完成, 才加入新的节点")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," nodeIndex "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," node.hash "),t("span",{style:{color:"#F97583"}},"&"),t("span",{style:{color:"#E1E4E8"}}," sizeMask; "),t("span",{style:{color:"#6A737D"}},"// add the new node")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        node."),t("span",{style:{color:"#B392F0"}},"setNext"),t("span",{style:{color:"#E1E4E8"}},"(newTable[nodeIndex]);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        newTable[nodeIndex] "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," node;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"\t\t"),t("span",{style:{color:"#6A737D"}},"// 替换为新的 HashEntry table")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        table "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," newTable;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    }")])])]),t("pre",{class:"shiki github-light vp-code-light"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"private"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"void"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"rehash"),t("span",{style:{color:"#24292E"}},"(HashEntry"),t("span",{style:{color:"#D73A49"}},"<"),t("span",{style:{color:"#24292E"}},"K,V"),t("span",{style:{color:"#D73A49"}},">"),t("span",{style:{color:"#24292E"}}," node) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        HashEntry<"),t("span",{style:{color:"#D73A49"}},"K"),t("span",{style:{color:"#24292E"}},","),t("span",{style:{color:"#D73A49"}},"V"),t("span",{style:{color:"#24292E"}},">[] oldTable "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," table;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," oldCapacity "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," oldTable.length;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," newCapacity "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," oldCapacity "),t("span",{style:{color:"#D73A49"}},"<<"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"1"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        threshold "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," ("),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}},")(newCapacity "),t("span",{style:{color:"#D73A49"}},"*"),t("span",{style:{color:"#24292E"}}," loadFactor);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        HashEntry<"),t("span",{style:{color:"#D73A49"}},"K"),t("span",{style:{color:"#24292E"}},","),t("span",{style:{color:"#D73A49"}},"V"),t("span",{style:{color:"#24292E"}},">[] newTable "),t("span",{style:{color:"#D73A49"}},"=")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                (HashEntry"),t("span",{style:{color:"#D73A49"}},"<"),t("span",{style:{color:"#24292E"}},"K,V"),t("span",{style:{color:"#D73A49"}},">"),t("span",{style:{color:"#24292E"}},"[]) "),t("span",{style:{color:"#D73A49"}},"new"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"HashEntry"),t("span",{style:{color:"#24292E"}},"[newCapacity];")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," sizeMask "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," newCapacity "),t("span",{style:{color:"#D73A49"}},"-"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"1"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"for"),t("span",{style:{color:"#24292E"}}," ("),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," i "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"0"),t("span",{style:{color:"#24292E"}},"; i "),t("span",{style:{color:"#D73A49"}},"<"),t("span",{style:{color:"#24292E"}}," oldCapacity ; i"),t("span",{style:{color:"#D73A49"}},"++"),t("span",{style:{color:"#24292E"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            HashEntry<"),t("span",{style:{color:"#D73A49"}},"K"),t("span",{style:{color:"#24292E"}},","),t("span",{style:{color:"#D73A49"}},"V"),t("span",{style:{color:"#24292E"}},"> e "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," oldTable[i];")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (e "),t("span",{style:{color:"#D73A49"}},"!="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"null"),t("span",{style:{color:"#24292E"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                HashEntry<"),t("span",{style:{color:"#D73A49"}},"K"),t("span",{style:{color:"#24292E"}},","),t("span",{style:{color:"#D73A49"}},"V"),t("span",{style:{color:"#24292E"}},"> next "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," e.next;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," idx "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," e.hash "),t("span",{style:{color:"#D73A49"}},"&"),t("span",{style:{color:"#24292E"}}," sizeMask;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (next "),t("span",{style:{color:"#D73A49"}},"=="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"null"),t("span",{style:{color:"#24292E"}},") "),t("span",{style:{color:"#6A737D"}},"// Single node on list")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                    newTable[idx] "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," e;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#D73A49"}},"else"),t("span",{style:{color:"#24292E"}}," { "),t("span",{style:{color:"#6A737D"}},"// Reuse consecutive sequence at same slot")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                    HashEntry<"),t("span",{style:{color:"#D73A49"}},"K"),t("span",{style:{color:"#24292E"}},","),t("span",{style:{color:"#D73A49"}},"V"),t("span",{style:{color:"#24292E"}},"> lastRun "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," e;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                    "),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," lastIdx "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," idx;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"\t\t\t\t\t"),t("span",{style:{color:"#6A737D"}},"// 过一遍链表, 尽可能把 rehash 后 idx 不变的节点重用")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                    "),t("span",{style:{color:"#D73A49"}},"for"),t("span",{style:{color:"#24292E"}}," (HashEntry<"),t("span",{style:{color:"#D73A49"}},"K"),t("span",{style:{color:"#24292E"}},","),t("span",{style:{color:"#D73A49"}},"V"),t("span",{style:{color:"#24292E"}},"> last "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," next;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                         last "),t("span",{style:{color:"#D73A49"}},"!="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"null"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                         last "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," last.next) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                        "),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," k "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," last.hash "),t("span",{style:{color:"#D73A49"}},"&"),t("span",{style:{color:"#24292E"}}," sizeMask;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                        "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (k "),t("span",{style:{color:"#D73A49"}},"!="),t("span",{style:{color:"#24292E"}}," lastIdx) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                            lastIdx "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," k;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                            lastRun "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," last;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                    newTable[lastIdx] "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," lastRun;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"\t\t\t\t\t"),t("span",{style:{color:"#6A737D"}},"// 剩余节点需要新建")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                    "),t("span",{style:{color:"#D73A49"}},"for"),t("span",{style:{color:"#24292E"}}," (HashEntry<"),t("span",{style:{color:"#D73A49"}},"K"),t("span",{style:{color:"#24292E"}},","),t("span",{style:{color:"#D73A49"}},"V"),t("span",{style:{color:"#24292E"}},"> p "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," e; p "),t("span",{style:{color:"#D73A49"}},"!="),t("span",{style:{color:"#24292E"}}," lastRun; p "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," p.next) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                        V v "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," p.value;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                        "),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," h "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," p.hash;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                        "),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," k "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," h "),t("span",{style:{color:"#D73A49"}},"&"),t("span",{style:{color:"#24292E"}}," sizeMask;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                        HashEntry<"),t("span",{style:{color:"#D73A49"}},"K"),t("span",{style:{color:"#24292E"}},","),t("span",{style:{color:"#D73A49"}},"V"),t("span",{style:{color:"#24292E"}},"> n "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," newTable[k];")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                        newTable[k] "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"new"),t("span",{style:{color:"#24292E"}}," HashEntry<"),t("span",{style:{color:"#D73A49"}},"K"),t("span",{style:{color:"#24292E"}},","),t("span",{style:{color:"#D73A49"}},"V"),t("span",{style:{color:"#24292E"}},">(h, p.key, v, n);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"\t\t"),t("span",{style:{color:"#6A737D"}},"// 扩容完成, 才加入新的节点")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," nodeIndex "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," node.hash "),t("span",{style:{color:"#D73A49"}},"&"),t("span",{style:{color:"#24292E"}}," sizeMask; "),t("span",{style:{color:"#6A737D"}},"// add the new node")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        node."),t("span",{style:{color:"#6F42C1"}},"setNext"),t("span",{style:{color:"#24292E"}},"(newTable[nodeIndex]);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        newTable[nodeIndex] "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," node;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"\t\t"),t("span",{style:{color:"#6A737D"}},"// 替换为新的 HashEntry table")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        table "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," newTable;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    }")])])])],-1),Hp=t("blockquote",null,[t("p",null,"扩容时，有的节点（重新计算得出桶下标一样的）是搬迁过去新的数组（没有使用头插法，直接是原封不动地平移过去），有的节点（重新计算得出桶下标不一样的）则创建新的，原有的会抛弃掉（原有的节点被留在原有的HashEntry中）"),t("figure",null,[t("img",{src:"https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230720194508341.png",alt:"image-20230720194508341",loading:"lazy",decoding:"async"})]),t("p",null,"节点的新增操作发生在扩容完成之后，等节点新增完后就会把旧的table（HashEntry数组）替换为新的table")],-1),Gp={id:"get-流程-1",tabindex:"-1"},Jp=t("p",null,"get 时并未加锁，用了 UNSAFE 方法保证了可见性，扩容过程中，get 先发生就从旧表取内容，get 后发生就从新表取内容",-1),Yp=t("div",{class:"language-java"},[t("button",{title:"Copy Code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki github-dark vp-code-dark"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"public"),t("span",{style:{color:"#E1E4E8"}}," V "),t("span",{style:{color:"#B392F0"}},"get"),t("span",{style:{color:"#E1E4E8"}},"(Object key) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    Segment<"),t("span",{style:{color:"#F97583"}},"K"),t("span",{style:{color:"#E1E4E8"}},","),t("span",{style:{color:"#F97583"}},"V"),t("span",{style:{color:"#E1E4E8"}},"> s; "),t("span",{style:{color:"#6A737D"}},"// manually integrate access methods to reduce overhead")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    HashEntry<"),t("span",{style:{color:"#F97583"}},"K"),t("span",{style:{color:"#E1E4E8"}},","),t("span",{style:{color:"#F97583"}},"V"),t("span",{style:{color:"#E1E4E8"}},">[] tab;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," h "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"hash"),t("span",{style:{color:"#E1E4E8"}},"(key);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// u 为 segment 对象在数组中的偏移量")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"long"),t("span",{style:{color:"#E1E4E8"}}," u "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," (((h "),t("span",{style:{color:"#F97583"}},">>>"),t("span",{style:{color:"#E1E4E8"}}," segmentShift) "),t("span",{style:{color:"#F97583"}},"&"),t("span",{style:{color:"#E1E4E8"}}," segmentMask) "),t("span",{style:{color:"#F97583"}},"<<"),t("span",{style:{color:"#E1E4E8"}}," SSHIFT) "),t("span",{style:{color:"#F97583"}},"+"),t("span",{style:{color:"#E1E4E8"}}," SBASE;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// s 即为 segment")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," ((s "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," (Segment"),t("span",{style:{color:"#F97583"}},"<"),t("span",{style:{color:"#E1E4E8"}},"K,V"),t("span",{style:{color:"#F97583"}},">"),t("span",{style:{color:"#E1E4E8"}},")UNSAFE."),t("span",{style:{color:"#B392F0"}},"getObjectVolatile"),t("span",{style:{color:"#E1E4E8"}},"(segments, u)) "),t("span",{style:{color:"#F97583"}},"!="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"null"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"&&")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    \t(tab "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," s.table) "),t("span",{style:{color:"#F97583"}},"!="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"null"),t("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"for"),t("span",{style:{color:"#E1E4E8"}}," (HashEntry<"),t("span",{style:{color:"#F97583"}},"K"),t("span",{style:{color:"#E1E4E8"}},","),t("span",{style:{color:"#F97583"}},"V"),t("span",{style:{color:"#E1E4E8"}},"> e "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," (HashEntry"),t("span",{style:{color:"#F97583"}},"<"),t("span",{style:{color:"#E1E4E8"}},"K,V"),t("span",{style:{color:"#F97583"}},">"),t("span",{style:{color:"#E1E4E8"}},") UNSAFE.getObjectVolatile")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"             (tab, (("),t("span",{style:{color:"#F97583"}},"long"),t("span",{style:{color:"#E1E4E8"}},")(((tab.length "),t("span",{style:{color:"#F97583"}},"-"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"1"),t("span",{style:{color:"#E1E4E8"}},") "),t("span",{style:{color:"#F97583"}},"&"),t("span",{style:{color:"#E1E4E8"}}," h)) "),t("span",{style:{color:"#F97583"}},"<<"),t("span",{style:{color:"#E1E4E8"}}," TSHIFT) "),t("span",{style:{color:"#F97583"}},"+"),t("span",{style:{color:"#E1E4E8"}}," TBASE);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"             e "),t("span",{style:{color:"#F97583"}},"!="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"null"),t("span",{style:{color:"#E1E4E8"}},"; e "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," e.next) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            K k;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," ((k "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," e.key) "),t("span",{style:{color:"#F97583"}},"=="),t("span",{style:{color:"#E1E4E8"}}," key "),t("span",{style:{color:"#F97583"}},"||"),t("span",{style:{color:"#E1E4E8"}}," (e.hash "),t("span",{style:{color:"#F97583"}},"=="),t("span",{style:{color:"#E1E4E8"}}," h "),t("span",{style:{color:"#F97583"}},"&&"),t("span",{style:{color:"#E1E4E8"}}," key."),t("span",{style:{color:"#B392F0"}},"equals"),t("span",{style:{color:"#E1E4E8"}},"(k)))")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            \t"),t("span",{style:{color:"#F97583"}},"return"),t("span",{style:{color:"#E1E4E8"}}," e.value;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"return"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"null"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"}")])])]),t("pre",{class:"shiki github-light vp-code-light"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"public"),t("span",{style:{color:"#24292E"}}," V "),t("span",{style:{color:"#6F42C1"}},"get"),t("span",{style:{color:"#24292E"}},"(Object key) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    Segment<"),t("span",{style:{color:"#D73A49"}},"K"),t("span",{style:{color:"#24292E"}},","),t("span",{style:{color:"#D73A49"}},"V"),t("span",{style:{color:"#24292E"}},"> s; "),t("span",{style:{color:"#6A737D"}},"// manually integrate access methods to reduce overhead")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    HashEntry<"),t("span",{style:{color:"#D73A49"}},"K"),t("span",{style:{color:"#24292E"}},","),t("span",{style:{color:"#D73A49"}},"V"),t("span",{style:{color:"#24292E"}},">[] tab;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," h "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"hash"),t("span",{style:{color:"#24292E"}},"(key);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// u 为 segment 对象在数组中的偏移量")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"long"),t("span",{style:{color:"#24292E"}}," u "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," (((h "),t("span",{style:{color:"#D73A49"}},">>>"),t("span",{style:{color:"#24292E"}}," segmentShift) "),t("span",{style:{color:"#D73A49"}},"&"),t("span",{style:{color:"#24292E"}}," segmentMask) "),t("span",{style:{color:"#D73A49"}},"<<"),t("span",{style:{color:"#24292E"}}," SSHIFT) "),t("span",{style:{color:"#D73A49"}},"+"),t("span",{style:{color:"#24292E"}}," SBASE;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// s 即为 segment")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," ((s "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," (Segment"),t("span",{style:{color:"#D73A49"}},"<"),t("span",{style:{color:"#24292E"}},"K,V"),t("span",{style:{color:"#D73A49"}},">"),t("span",{style:{color:"#24292E"}},")UNSAFE."),t("span",{style:{color:"#6F42C1"}},"getObjectVolatile"),t("span",{style:{color:"#24292E"}},"(segments, u)) "),t("span",{style:{color:"#D73A49"}},"!="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"null"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"&&")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    \t(tab "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," s.table) "),t("span",{style:{color:"#D73A49"}},"!="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"null"),t("span",{style:{color:"#24292E"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"for"),t("span",{style:{color:"#24292E"}}," (HashEntry<"),t("span",{style:{color:"#D73A49"}},"K"),t("span",{style:{color:"#24292E"}},","),t("span",{style:{color:"#D73A49"}},"V"),t("span",{style:{color:"#24292E"}},"> e "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," (HashEntry"),t("span",{style:{color:"#D73A49"}},"<"),t("span",{style:{color:"#24292E"}},"K,V"),t("span",{style:{color:"#D73A49"}},">"),t("span",{style:{color:"#24292E"}},") UNSAFE.getObjectVolatile")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"             (tab, (("),t("span",{style:{color:"#D73A49"}},"long"),t("span",{style:{color:"#24292E"}},")(((tab.length "),t("span",{style:{color:"#D73A49"}},"-"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"1"),t("span",{style:{color:"#24292E"}},") "),t("span",{style:{color:"#D73A49"}},"&"),t("span",{style:{color:"#24292E"}}," h)) "),t("span",{style:{color:"#D73A49"}},"<<"),t("span",{style:{color:"#24292E"}}," TSHIFT) "),t("span",{style:{color:"#D73A49"}},"+"),t("span",{style:{color:"#24292E"}}," TBASE);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"             e "),t("span",{style:{color:"#D73A49"}},"!="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"null"),t("span",{style:{color:"#24292E"}},"; e "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," e.next) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            K k;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," ((k "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," e.key) "),t("span",{style:{color:"#D73A49"}},"=="),t("span",{style:{color:"#24292E"}}," key "),t("span",{style:{color:"#D73A49"}},"||"),t("span",{style:{color:"#24292E"}}," (e.hash "),t("span",{style:{color:"#D73A49"}},"=="),t("span",{style:{color:"#24292E"}}," h "),t("span",{style:{color:"#D73A49"}},"&&"),t("span",{style:{color:"#24292E"}}," key."),t("span",{style:{color:"#6F42C1"}},"equals"),t("span",{style:{color:"#24292E"}},"(k)))")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            \t"),t("span",{style:{color:"#D73A49"}},"return"),t("span",{style:{color:"#24292E"}}," e.value;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"return"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"null"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"}")])])])],-1),Xp=t("blockquote",null,[t("p",null,"定位桶下标调用了UNSAFE.getObjectVolatile，用了很多的移位运算，其实JDK8也是一样的，只不过封装成了tabAt方法，把移位操作封装起来了，你看不到，其内部都是调用了UNSAFE.getObjectVolatile，因为segment还是链表头它们都是在数组里，数组里的内容你光加volatile来修饰数组本身是不行的，它们属于数组的元素，所以必须配合UNSAFE.getObjectVolatile来保证它们的可见性；"),t("p",null,"定位到桶下标看是不是同一个对象（hash&equals），是直接返回；循环结束仍未找到就返回null")],-1),Zp={id:"size-计算流程-1",tabindex:"-1"},$p=t("ul",null,[t("li",null,"计算元素个数前，先不加锁计算两次，如果前后两次结果都一样，认为个数正确返回"),t("li",null,"如果不一样，进行重试，重试次数超过 3，将所有 segment 锁住，重新计算个数返回")],-1),sr=t("div",{class:"language-java"},[t("button",{title:"Copy Code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki github-dark vp-code-dark"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"public"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"size"),t("span",{style:{color:"#E1E4E8"}},"() {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#6A737D"}},"// Try a few times to get accurate count. On failure due to")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#6A737D"}},"// continuous async changes in table, resort to locking.")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"final"),t("span",{style:{color:"#E1E4E8"}}," Segment<"),t("span",{style:{color:"#F97583"}},"K"),t("span",{style:{color:"#E1E4E8"}},","),t("span",{style:{color:"#F97583"}},"V"),t("span",{style:{color:"#E1E4E8"}},">[] segments "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"this"),t("span",{style:{color:"#E1E4E8"}},".segments;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," size;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"boolean"),t("span",{style:{color:"#E1E4E8"}}," overflow; "),t("span",{style:{color:"#6A737D"}},"// true if size overflows 32 bits")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"long"),t("span",{style:{color:"#E1E4E8"}}," sum; "),t("span",{style:{color:"#6A737D"}},"// sum of modCounts")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"long"),t("span",{style:{color:"#E1E4E8"}}," last "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"0L"),t("span",{style:{color:"#E1E4E8"}},"; "),t("span",{style:{color:"#6A737D"}},"// previous sum")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," retries "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"-"),t("span",{style:{color:"#79B8FF"}},"1"),t("span",{style:{color:"#E1E4E8"}},"; "),t("span",{style:{color:"#6A737D"}},"// first iteration isn't retry")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"try"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"for"),t("span",{style:{color:"#E1E4E8"}}," (;;) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (retries"),t("span",{style:{color:"#F97583"}},"++"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"=="),t("span",{style:{color:"#E1E4E8"}}," RETRIES_BEFORE_LOCK) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                    "),t("span",{style:{color:"#6A737D"}},"// 超过重试次数, 需要创建所有 segment 并加锁")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                    "),t("span",{style:{color:"#F97583"}},"for"),t("span",{style:{color:"#E1E4E8"}}," ("),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," j "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"0"),t("span",{style:{color:"#E1E4E8"}},"; j "),t("span",{style:{color:"#F97583"}},"<"),t("span",{style:{color:"#E1E4E8"}}," segments.length; "),t("span",{style:{color:"#F97583"}},"++"),t("span",{style:{color:"#E1E4E8"}},"j)")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                        "),t("span",{style:{color:"#B392F0"}},"ensureSegment"),t("span",{style:{color:"#E1E4E8"}},"(j)."),t("span",{style:{color:"#B392F0"}},"lock"),t("span",{style:{color:"#E1E4E8"}},"(); "),t("span",{style:{color:"#6A737D"}},"// force creation")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                sum "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"0L"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                size "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"0"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                overflow "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"false"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#F97583"}},"for"),t("span",{style:{color:"#E1E4E8"}}," ("),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," j "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"0"),t("span",{style:{color:"#E1E4E8"}},"; j "),t("span",{style:{color:"#F97583"}},"<"),t("span",{style:{color:"#E1E4E8"}}," segments.length; "),t("span",{style:{color:"#F97583"}},"++"),t("span",{style:{color:"#E1E4E8"}},"j) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                    Segment<"),t("span",{style:{color:"#F97583"}},"K"),t("span",{style:{color:"#E1E4E8"}},","),t("span",{style:{color:"#F97583"}},"V"),t("span",{style:{color:"#E1E4E8"}},"> seg "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"segmentAt"),t("span",{style:{color:"#E1E4E8"}},"(segments, j);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                    "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (seg "),t("span",{style:{color:"#F97583"}},"!="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"null"),t("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                        sum "),t("span",{style:{color:"#F97583"}},"+="),t("span",{style:{color:"#E1E4E8"}}," seg.modCount;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                        "),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," c "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," seg.count;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                        "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (c "),t("span",{style:{color:"#F97583"}},"<"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"0"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"||"),t("span",{style:{color:"#E1E4E8"}}," (size "),t("span",{style:{color:"#F97583"}},"+="),t("span",{style:{color:"#E1E4E8"}}," c) "),t("span",{style:{color:"#F97583"}},"<"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"0"),t("span",{style:{color:"#E1E4E8"}},")")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                            overflow "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"true"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (sum "),t("span",{style:{color:"#F97583"}},"=="),t("span",{style:{color:"#E1E4E8"}}," last)")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                    "),t("span",{style:{color:"#F97583"}},"break"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                last "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," sum;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        } "),t("span",{style:{color:"#F97583"}},"finally"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (retries "),t("span",{style:{color:"#F97583"}},">"),t("span",{style:{color:"#E1E4E8"}}," RETRIES_BEFORE_LOCK) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                "),t("span",{style:{color:"#F97583"}},"for"),t("span",{style:{color:"#E1E4E8"}}," ("),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," j "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"0"),t("span",{style:{color:"#E1E4E8"}},"; j "),t("span",{style:{color:"#F97583"}},"<"),t("span",{style:{color:"#E1E4E8"}}," segments.length; "),t("span",{style:{color:"#F97583"}},"++"),t("span",{style:{color:"#E1E4E8"}},"j)")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                    "),t("span",{style:{color:"#B392F0"}},"segmentAt"),t("span",{style:{color:"#E1E4E8"}},"(segments, j)."),t("span",{style:{color:"#B392F0"}},"unlock"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"return"),t("span",{style:{color:"#E1E4E8"}}," overflow "),t("span",{style:{color:"#F97583"}},"?"),t("span",{style:{color:"#E1E4E8"}}," Integer.MAX_VALUE "),t("span",{style:{color:"#F97583"}},":"),t("span",{style:{color:"#E1E4E8"}}," size;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    }")])])]),t("pre",{class:"shiki github-light vp-code-light"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"public"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"size"),t("span",{style:{color:"#24292E"}},"() {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6A737D"}},"// Try a few times to get accurate count. On failure due to")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6A737D"}},"// continuous async changes in table, resort to locking.")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"final"),t("span",{style:{color:"#24292E"}}," Segment<"),t("span",{style:{color:"#D73A49"}},"K"),t("span",{style:{color:"#24292E"}},","),t("span",{style:{color:"#D73A49"}},"V"),t("span",{style:{color:"#24292E"}},">[] segments "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"this"),t("span",{style:{color:"#24292E"}},".segments;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," size;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"boolean"),t("span",{style:{color:"#24292E"}}," overflow; "),t("span",{style:{color:"#6A737D"}},"// true if size overflows 32 bits")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"long"),t("span",{style:{color:"#24292E"}}," sum; "),t("span",{style:{color:"#6A737D"}},"// sum of modCounts")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"long"),t("span",{style:{color:"#24292E"}}," last "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"0L"),t("span",{style:{color:"#24292E"}},"; "),t("span",{style:{color:"#6A737D"}},"// previous sum")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," retries "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"-"),t("span",{style:{color:"#005CC5"}},"1"),t("span",{style:{color:"#24292E"}},"; "),t("span",{style:{color:"#6A737D"}},"// first iteration isn't retry")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"try"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"for"),t("span",{style:{color:"#24292E"}}," (;;) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (retries"),t("span",{style:{color:"#D73A49"}},"++"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"=="),t("span",{style:{color:"#24292E"}}," RETRIES_BEFORE_LOCK) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                    "),t("span",{style:{color:"#6A737D"}},"// 超过重试次数, 需要创建所有 segment 并加锁")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                    "),t("span",{style:{color:"#D73A49"}},"for"),t("span",{style:{color:"#24292E"}}," ("),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," j "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"0"),t("span",{style:{color:"#24292E"}},"; j "),t("span",{style:{color:"#D73A49"}},"<"),t("span",{style:{color:"#24292E"}}," segments.length; "),t("span",{style:{color:"#D73A49"}},"++"),t("span",{style:{color:"#24292E"}},"j)")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                        "),t("span",{style:{color:"#6F42C1"}},"ensureSegment"),t("span",{style:{color:"#24292E"}},"(j)."),t("span",{style:{color:"#6F42C1"}},"lock"),t("span",{style:{color:"#24292E"}},"(); "),t("span",{style:{color:"#6A737D"}},"// force creation")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                sum "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"0L"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                size "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"0"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                overflow "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"false"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#D73A49"}},"for"),t("span",{style:{color:"#24292E"}}," ("),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," j "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"0"),t("span",{style:{color:"#24292E"}},"; j "),t("span",{style:{color:"#D73A49"}},"<"),t("span",{style:{color:"#24292E"}}," segments.length; "),t("span",{style:{color:"#D73A49"}},"++"),t("span",{style:{color:"#24292E"}},"j) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                    Segment<"),t("span",{style:{color:"#D73A49"}},"K"),t("span",{style:{color:"#24292E"}},","),t("span",{style:{color:"#D73A49"}},"V"),t("span",{style:{color:"#24292E"}},"> seg "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"segmentAt"),t("span",{style:{color:"#24292E"}},"(segments, j);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                    "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (seg "),t("span",{style:{color:"#D73A49"}},"!="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"null"),t("span",{style:{color:"#24292E"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                        sum "),t("span",{style:{color:"#D73A49"}},"+="),t("span",{style:{color:"#24292E"}}," seg.modCount;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                        "),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," c "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," seg.count;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                        "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (c "),t("span",{style:{color:"#D73A49"}},"<"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"0"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"||"),t("span",{style:{color:"#24292E"}}," (size "),t("span",{style:{color:"#D73A49"}},"+="),t("span",{style:{color:"#24292E"}}," c) "),t("span",{style:{color:"#D73A49"}},"<"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"0"),t("span",{style:{color:"#24292E"}},")")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                            overflow "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"true"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (sum "),t("span",{style:{color:"#D73A49"}},"=="),t("span",{style:{color:"#24292E"}}," last)")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                    "),t("span",{style:{color:"#D73A49"}},"break"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                last "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," sum;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        } "),t("span",{style:{color:"#D73A49"}},"finally"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (retries "),t("span",{style:{color:"#D73A49"}},">"),t("span",{style:{color:"#24292E"}}," RETRIES_BEFORE_LOCK) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                "),t("span",{style:{color:"#D73A49"}},"for"),t("span",{style:{color:"#24292E"}}," ("),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," j "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"0"),t("span",{style:{color:"#24292E"}},"; j "),t("span",{style:{color:"#D73A49"}},"<"),t("span",{style:{color:"#24292E"}}," segments.length; "),t("span",{style:{color:"#D73A49"}},"++"),t("span",{style:{color:"#24292E"}},"j)")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                    "),t("span",{style:{color:"#6F42C1"}},"segmentAt"),t("span",{style:{color:"#24292E"}},"(segments, j)."),t("span",{style:{color:"#6F42C1"}},"unlock"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"return"),t("span",{style:{color:"#24292E"}}," overflow "),t("span",{style:{color:"#D73A49"}},"?"),t("span",{style:{color:"#24292E"}}," Integer.MAX_VALUE "),t("span",{style:{color:"#D73A49"}},":"),t("span",{style:{color:"#24292E"}}," size;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    }")])])])],-1),lr=t("blockquote",null,[t("p",null,"首先遍历所有的segment，只要segment不为空就进行一个计数，统计segment内修改的次数（put/remove）和元素个数"),t("p",null,[t("code",null,"c < 0 || (size += c) < 0"),p("表示元素个数超出最大范围导致溢出，即统计失败")]),t("p",null,"将元素个数加到size由sum变量保证，只要前一次的修改次数和这一次的修改次数一致说明没有其他线程干扰，则任务这个计数是准确的，退出循环；若不一致，则重试3次来添加size计数，超过重试次数，则锁住所有的segment，再重新计数，这次会比较准确，计数完成遍历segment进行解锁")],-1),or={id:"_9、linkedblockingqueue-原理",tabindex:"-1"},nr={id:"基本的入队出队",tabindex:"-1"},ar=t("div",{class:"language-java"},[t("button",{title:"Copy Code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki github-dark vp-code-dark"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"public"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"class"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"LinkedBlockingQueue"),t("span",{style:{color:"#E1E4E8"}},"<"),t("span",{style:{color:"#F97583"}},"E"),t("span",{style:{color:"#E1E4E8"}},"> "),t("span",{style:{color:"#F97583"}},"extends"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"AbstractQueue"),t("span",{style:{color:"#E1E4E8"}},"<"),t("span",{style:{color:"#F97583"}},"E"),t("span",{style:{color:"#E1E4E8"}},"> "),t("span",{style:{color:"#F97583"}},"implements"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"BlockingQueue"),t("span",{style:{color:"#E1E4E8"}},"<"),t("span",{style:{color:"#F97583"}},"E"),t("span",{style:{color:"#E1E4E8"}},">, java.io."),t("span",{style:{color:"#B392F0"}},"Serializable"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"static"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"class"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"Node"),t("span",{style:{color:"#E1E4E8"}},"<"),t("span",{style:{color:"#F97583"}},"E"),t("span",{style:{color:"#E1E4E8"}},"> {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        E item;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"        /**")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"        * 下列三种情况之一")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"        * - 真正的后继节点")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"        * - 自己, 发生在出队时")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"        * - null, 表示是没有后继节点, 是最后了")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"        */")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        Node<"),t("span",{style:{color:"#F97583"}},"E"),t("span",{style:{color:"#E1E4E8"}},"> next;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#B392F0"}},"Node"),t("span",{style:{color:"#E1E4E8"}},"(E "),t("span",{style:{color:"#FFAB70"}},"x"),t("span",{style:{color:"#E1E4E8"}},") { item "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," x; }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"}")])])]),t("pre",{class:"shiki github-light vp-code-light"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"public"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"class"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"LinkedBlockingQueue"),t("span",{style:{color:"#24292E"}},"<"),t("span",{style:{color:"#D73A49"}},"E"),t("span",{style:{color:"#24292E"}},"> "),t("span",{style:{color:"#D73A49"}},"extends"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"AbstractQueue"),t("span",{style:{color:"#24292E"}},"<"),t("span",{style:{color:"#D73A49"}},"E"),t("span",{style:{color:"#24292E"}},"> "),t("span",{style:{color:"#D73A49"}},"implements"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"BlockingQueue"),t("span",{style:{color:"#24292E"}},"<"),t("span",{style:{color:"#D73A49"}},"E"),t("span",{style:{color:"#24292E"}},">, java.io."),t("span",{style:{color:"#6F42C1"}},"Serializable"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"static"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"class"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"Node"),t("span",{style:{color:"#24292E"}},"<"),t("span",{style:{color:"#D73A49"}},"E"),t("span",{style:{color:"#24292E"}},"> {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        E item;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"        /**")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"        * 下列三种情况之一")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"        * - 真正的后继节点")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"        * - 自己, 发生在出队时")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"        * - null, 表示是没有后继节点, 是最后了")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"        */")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        Node<"),t("span",{style:{color:"#D73A49"}},"E"),t("span",{style:{color:"#24292E"}},"> next;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6F42C1"}},"Node"),t("span",{style:{color:"#24292E"}},"(E "),t("span",{style:{color:"#E36209"}},"x"),t("span",{style:{color:"#24292E"}},") { item "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," x; }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"}")])])])],-1),er=t("p",null,[p("初始化链表 "),t("code",null,"last = head = new Node<E>(null);"),p("=> "),t("code",null,"last = new Node<E>(null);head = new Node<E>(null);"),p("Dummy 节点用来占位，item 为 null")],-1),cr=t("figure",null,[t("img",{src:"https://jsd.cdn.zzko.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230720202031710.png",alt:"image-20230720202031710",loading:"lazy",decoding:"async"})],-1),tr=t("p",null,[p("当一个节点入队 "),t("code",null,"last = last.next = node;"),p("=> "),t("code",null,"last.next = node;last = node;")],-1),pr=t("figure",null,[t("img",{src:"https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230720202045345.png",alt:"image-20230720202045345",loading:"lazy",decoding:"async"})],-1),rr=t("p",null,[p("再来一个节点入队 "),t("code",null,"last = last.next = node;")],-1),Er=t("figure",null,[t("img",{src:"https://jsd.cdn.zzko.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230720202116388.png",alt:"image-20230720202116388",loading:"lazy",decoding:"async"})],-1),yr=t("p",null,"出队",-1),ir=t("div",{class:"language-java"},[t("button",{title:"Copy Code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki github-dark vp-code-dark"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"Node<"),t("span",{style:{color:"#F97583"}},"E"),t("span",{style:{color:"#E1E4E8"}},"> h "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," head;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"Node<"),t("span",{style:{color:"#F97583"}},"E"),t("span",{style:{color:"#E1E4E8"}},"> first "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," h.next;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"h.next "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," h; "),t("span",{style:{color:"#6A737D"}},"// help GC")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"head "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," first;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"E x "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," first.item;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"first.item "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"null"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"return"),t("span",{style:{color:"#E1E4E8"}}," x;")])])]),t("pre",{class:"shiki github-light vp-code-light"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"Node<"),t("span",{style:{color:"#D73A49"}},"E"),t("span",{style:{color:"#24292E"}},"> h "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," head;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"Node<"),t("span",{style:{color:"#D73A49"}},"E"),t("span",{style:{color:"#24292E"}},"> first "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," h.next;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"h.next "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," h; "),t("span",{style:{color:"#6A737D"}},"// help GC")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"head "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," first;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"E x "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," first.item;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"first.item "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"null"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"return"),t("span",{style:{color:"#24292E"}}," x;")])])])],-1),Fr=t("p",null,"h = head",-1),ur=t("figure",null,[t("img",{src:"https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230720202154330.png",alt:"image-20230720202154330",loading:"lazy",decoding:"async"})],-1),Ar=t("p",null,"first = h.next",-1),dr=t("figure",null,[t("img",{src:"https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230720202208218.png",alt:"image-20230720202208218",loading:"lazy",decoding:"async"})],-1),Dr=t("p",null,"h.next = h",-1),Cr=t("figure",null,[t("img",{src:"https://jsd.cdn.zzko.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230720202219603.png",alt:"image-20230720202219603",loading:"lazy",decoding:"async"})],-1),hr=t("p",null,"head = first",-1),gr=t("figure",null,[t("img",{src:"https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230720202231300.png",alt:"image-20230720202231300",loading:"lazy",decoding:"async"})],-1),Br=t("div",{class:"language-java"},[t("button",{title:"Copy Code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki github-dark vp-code-dark"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"E x "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," first.item;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"first.item "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"null"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"return"),t("span",{style:{color:"#E1E4E8"}}," x;")])])]),t("pre",{class:"shiki github-light vp-code-light"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"E x "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," first.item;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"first.item "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"null"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"return"),t("span",{style:{color:"#24292E"}}," x;")])])])],-1),fr=t("figure",null,[t("img",{src:"https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230720202247035.png",alt:"image-20230720202247035",loading:"lazy",decoding:"async"})],-1),kr={id:"加锁分析",tabindex:"-1"},br=t("p",null,"==高明之处==在于用了两把锁和 dummy 节点",-1),mr=t("ul",null,[t("li",null,"用一把锁，同一时刻，最多只允许有一个线程（生产者或消费者，二选一）执行"),t("li",null,[p("用两把锁，同一时刻，可以允许两个线程同时（一个生产者与一个消费者）执行 "),t("ul",null,[t("li",null,"消费者与消费者线程仍然串行"),t("li",null,"生产者与生产者线程仍然串行")])])],-1),Sr=t("p",null,"线程安全分析",-1),vr=t("ul",null,[t("li",null,"当节点总数大于 2 时（包括 dummy 节点），putLock 保证的是 last 节点的线程安全，takeLock 保证的是head 节点的线程安全。两把锁保证了入队和出队没有竞争"),t("li",null,"当节点总数等于 2 时（即一个 dummy 节点，一个正常节点）这时候，仍然是两把锁锁两个对象，不会竞争"),t("li",null,"当节点总数等于 1 时（就一个 dummy 节点）这时 take 线程会被 notEmpty 条件阻塞，有竞争，会阻塞")],-1),wr=t("div",{class:"language-java"},[t("button",{title:"Copy Code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki github-dark vp-code-dark"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// 用于 put(阻塞) offer(非阻塞)")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"private"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"final"),t("span",{style:{color:"#E1E4E8"}}," ReentrantLock putLock "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"new"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"ReentrantLock"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// 用户 take(阻塞) poll(非阻塞)")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"private"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"final"),t("span",{style:{color:"#E1E4E8"}}," ReentrantLock takeLock "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"new"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"ReentrantLock"),t("span",{style:{color:"#E1E4E8"}},"();")])])]),t("pre",{class:"shiki github-light vp-code-light"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// 用于 put(阻塞) offer(非阻塞)")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"private"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"final"),t("span",{style:{color:"#24292E"}}," ReentrantLock putLock "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"new"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"ReentrantLock"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#6A737D"}},"// 用户 take(阻塞) poll(非阻塞)")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"private"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"final"),t("span",{style:{color:"#24292E"}}," ReentrantLock takeLock "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"new"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"ReentrantLock"),t("span",{style:{color:"#24292E"}},"();")])])])],-1),Tr=t("p",null,"put 操作",-1),xr=t("div",{class:"language-java"},[t("button",{title:"Copy Code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki github-dark vp-code-dark"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"public"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"void"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"put"),t("span",{style:{color:"#E1E4E8"}},"(E e) throws InterruptedException {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (e "),t("span",{style:{color:"#F97583"}},"=="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"null"),t("span",{style:{color:"#E1E4E8"}},") "),t("span",{style:{color:"#F97583"}},"throw"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"new"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"NullPointerException"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," c "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"-"),t("span",{style:{color:"#79B8FF"}},"1"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        Node<"),t("span",{style:{color:"#F97583"}},"E"),t("span",{style:{color:"#E1E4E8"}},"> node "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"new"),t("span",{style:{color:"#E1E4E8"}}," Node<"),t("span",{style:{color:"#F97583"}},"E"),t("span",{style:{color:"#E1E4E8"}},">(e);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"final"),t("span",{style:{color:"#E1E4E8"}}," ReentrantLock putLock "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"this"),t("span",{style:{color:"#E1E4E8"}},".putLock;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"\t\t"),t("span",{style:{color:"#6A737D"}},"// count 用来维护元素计数")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"final"),t("span",{style:{color:"#E1E4E8"}}," AtomicInteger count "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"this"),t("span",{style:{color:"#E1E4E8"}},".count;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        putLock."),t("span",{style:{color:"#B392F0"}},"lockInterruptibly"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"try"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"\t\t\t"),t("span",{style:{color:"#6A737D"}},"// 满了等待")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"while"),t("span",{style:{color:"#E1E4E8"}}," (count."),t("span",{style:{color:"#B392F0"}},"get"),t("span",{style:{color:"#E1E4E8"}},"() "),t("span",{style:{color:"#F97583"}},"=="),t("span",{style:{color:"#E1E4E8"}}," capacity) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"\t\t\t\t"),t("span",{style:{color:"#6A737D"}},"// 倒过来读就好: 等待 notFull")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                notFull."),t("span",{style:{color:"#B392F0"}},"await"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"\t\t\t"),t("span",{style:{color:"#6A737D"}},"// 有空位, 入队且计数加一")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#B392F0"}},"enqueue"),t("span",{style:{color:"#E1E4E8"}},"(node);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            c "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," count."),t("span",{style:{color:"#B392F0"}},"getAndIncrement"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"\t\t\t"),t("span",{style:{color:"#6A737D"}},"// 除了自己 put 以外, 队列还有空位, 由自己叫醒其他 put 线程")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (c "),t("span",{style:{color:"#F97583"}},"+"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"1"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"<"),t("span",{style:{color:"#E1E4E8"}}," capacity)")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"                notFull."),t("span",{style:{color:"#B392F0"}},"signal"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        } "),t("span",{style:{color:"#F97583"}},"finally"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            putLock."),t("span",{style:{color:"#B392F0"}},"unlock"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"\t\t"),t("span",{style:{color:"#6A737D"}},"// 如果队列中有一个元素, 叫醒 take 线程")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (c "),t("span",{style:{color:"#F97583"}},"=="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"0"),t("span",{style:{color:"#E1E4E8"}},")")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"\t\t\t"),t("span",{style:{color:"#6A737D"}},"// 这里调用的是 notEmpty.signal() 而不是 notEmpty.signalAll() 是为了减少竞争")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#B392F0"}},"signalNotEmpty"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    }")])])]),t("pre",{class:"shiki github-light vp-code-light"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"public"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"void"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"put"),t("span",{style:{color:"#24292E"}},"(E e) throws InterruptedException {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (e "),t("span",{style:{color:"#D73A49"}},"=="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"null"),t("span",{style:{color:"#24292E"}},") "),t("span",{style:{color:"#D73A49"}},"throw"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"new"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"NullPointerException"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," c "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"-"),t("span",{style:{color:"#005CC5"}},"1"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        Node<"),t("span",{style:{color:"#D73A49"}},"E"),t("span",{style:{color:"#24292E"}},"> node "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"new"),t("span",{style:{color:"#24292E"}}," Node<"),t("span",{style:{color:"#D73A49"}},"E"),t("span",{style:{color:"#24292E"}},">(e);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"final"),t("span",{style:{color:"#24292E"}}," ReentrantLock putLock "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"this"),t("span",{style:{color:"#24292E"}},".putLock;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"\t\t"),t("span",{style:{color:"#6A737D"}},"// count 用来维护元素计数")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"final"),t("span",{style:{color:"#24292E"}}," AtomicInteger count "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"this"),t("span",{style:{color:"#24292E"}},".count;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        putLock."),t("span",{style:{color:"#6F42C1"}},"lockInterruptibly"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"try"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"\t\t\t"),t("span",{style:{color:"#6A737D"}},"// 满了等待")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"while"),t("span",{style:{color:"#24292E"}}," (count."),t("span",{style:{color:"#6F42C1"}},"get"),t("span",{style:{color:"#24292E"}},"() "),t("span",{style:{color:"#D73A49"}},"=="),t("span",{style:{color:"#24292E"}}," capacity) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"\t\t\t\t"),t("span",{style:{color:"#6A737D"}},"// 倒过来读就好: 等待 notFull")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                notFull."),t("span",{style:{color:"#6F42C1"}},"await"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"\t\t\t"),t("span",{style:{color:"#6A737D"}},"// 有空位, 入队且计数加一")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#6F42C1"}},"enqueue"),t("span",{style:{color:"#24292E"}},"(node);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            c "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," count."),t("span",{style:{color:"#6F42C1"}},"getAndIncrement"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"\t\t\t"),t("span",{style:{color:"#6A737D"}},"// 除了自己 put 以外, 队列还有空位, 由自己叫醒其他 put 线程")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (c "),t("span",{style:{color:"#D73A49"}},"+"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"1"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"<"),t("span",{style:{color:"#24292E"}}," capacity)")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"                notFull."),t("span",{style:{color:"#6F42C1"}},"signal"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        } "),t("span",{style:{color:"#D73A49"}},"finally"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            putLock."),t("span",{style:{color:"#6F42C1"}},"unlock"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"\t\t"),t("span",{style:{color:"#6A737D"}},"// 如果队列中有一个元素, 叫醒 take 线程")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (c "),t("span",{style:{color:"#D73A49"}},"=="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"0"),t("span",{style:{color:"#24292E"}},")")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"\t\t\t"),t("span",{style:{color:"#6A737D"}},"// 这里调用的是 notEmpty.signal() 而不是 notEmpty.signalAll() 是为了减少竞争")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#6F42C1"}},"signalNotEmpty"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    }")])])])],-1),Nr=t("p",null,"take 操作",-1),Ir=t("div",{class:"language-java"},[t("button",{title:"Copy Code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki github-dark vp-code-dark"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"public"),t("span",{style:{color:"#E1E4E8"}}," E "),t("span",{style:{color:"#B392F0"}},"take"),t("span",{style:{color:"#E1E4E8"}},"() throws InterruptedException {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    E x;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," c "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"-"),t("span",{style:{color:"#79B8FF"}},"1"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"final"),t("span",{style:{color:"#E1E4E8"}}," AtomicInteger count "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"this"),t("span",{style:{color:"#E1E4E8"}},".count;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"final"),t("span",{style:{color:"#E1E4E8"}}," ReentrantLock takeLock "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"this"),t("span",{style:{color:"#E1E4E8"}},".takeLock;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    takeLock."),t("span",{style:{color:"#B392F0"}},"lockInterruptibly"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"try"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#6A737D"}},"//空等待")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"while"),t("span",{style:{color:"#E1E4E8"}}," (count."),t("span",{style:{color:"#B392F0"}},"get"),t("span",{style:{color:"#E1E4E8"}},"() "),t("span",{style:{color:"#F97583"}},"=="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"0"),t("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"            "),t("span",{style:{color:"#6A737D"}},"//等待不空")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        \tnotEmpty."),t("span",{style:{color:"#B392F0"}},"await"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        x "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"dequeue"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        c "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," count."),t("span",{style:{color:"#B392F0"}},"getAndDecrement"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (c "),t("span",{style:{color:"#F97583"}},">"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"1"),t("span",{style:{color:"#E1E4E8"}},")")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        \tnotEmpty."),t("span",{style:{color:"#B392F0"}},"signal"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    } "),t("span",{style:{color:"#F97583"}},"finally"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    \ttakeLock."),t("span",{style:{color:"#B392F0"}},"unlock"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// 如果队列中只有一个空位时, 叫醒 put 线程")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"// 如果有多个线程进行出队, 第一个线程满足 c == capacity, 但后续线程 c < capacity")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"if"),t("span",{style:{color:"#E1E4E8"}}," (c "),t("span",{style:{color:"#F97583"}},"=="),t("span",{style:{color:"#E1E4E8"}}," capacity)")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    \t"),t("span",{style:{color:"#6A737D"}},"// 这里调用的是 notFull.signal() 而不是 notFull.signalAll() 是为了减少竞争")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    \t"),t("span",{style:{color:"#B392F0"}},"signalNotFull"),t("span",{style:{color:"#E1E4E8"}},"()")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"return"),t("span",{style:{color:"#E1E4E8"}}," x;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"}")])])]),t("pre",{class:"shiki github-light vp-code-light"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"public"),t("span",{style:{color:"#24292E"}}," E "),t("span",{style:{color:"#6F42C1"}},"take"),t("span",{style:{color:"#24292E"}},"() throws InterruptedException {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    E x;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," c "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"-"),t("span",{style:{color:"#005CC5"}},"1"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"final"),t("span",{style:{color:"#24292E"}}," AtomicInteger count "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"this"),t("span",{style:{color:"#24292E"}},".count;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"final"),t("span",{style:{color:"#24292E"}}," ReentrantLock takeLock "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"this"),t("span",{style:{color:"#24292E"}},".takeLock;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    takeLock."),t("span",{style:{color:"#6F42C1"}},"lockInterruptibly"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"try"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6A737D"}},"//空等待")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"while"),t("span",{style:{color:"#24292E"}}," (count."),t("span",{style:{color:"#6F42C1"}},"get"),t("span",{style:{color:"#24292E"}},"() "),t("span",{style:{color:"#D73A49"}},"=="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"0"),t("span",{style:{color:"#24292E"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"            "),t("span",{style:{color:"#6A737D"}},"//等待不空")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        \tnotEmpty."),t("span",{style:{color:"#6F42C1"}},"await"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        x "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"dequeue"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        c "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," count."),t("span",{style:{color:"#6F42C1"}},"getAndDecrement"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (c "),t("span",{style:{color:"#D73A49"}},">"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"1"),t("span",{style:{color:"#24292E"}},")")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        \tnotEmpty."),t("span",{style:{color:"#6F42C1"}},"signal"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    } "),t("span",{style:{color:"#D73A49"}},"finally"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    \ttakeLock."),t("span",{style:{color:"#6F42C1"}},"unlock"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// 如果队列中只有一个空位时, 叫醒 put 线程")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"// 如果有多个线程进行出队, 第一个线程满足 c == capacity, 但后续线程 c < capacity")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"if"),t("span",{style:{color:"#24292E"}}," (c "),t("span",{style:{color:"#D73A49"}},"=="),t("span",{style:{color:"#24292E"}}," capacity)")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    \t"),t("span",{style:{color:"#6A737D"}},"// 这里调用的是 notFull.signal() 而不是 notFull.signalAll() 是为了减少竞争")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    \t"),t("span",{style:{color:"#6F42C1"}},"signalNotFull"),t("span",{style:{color:"#24292E"}},"()")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"return"),t("span",{style:{color:"#24292E"}}," x;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"}")])])])],-1),Lr=t("blockquote",null,[t("p",null,"由 put 唤醒 put 是为了避免信号不足")],-1),jr={id:"性能比较",tabindex:"-1"},Rr=t("p",null,"主要列举 LinkedBlockingQueue 与 ArrayBlockingQueue 的性能比较",-1),Or=t("ul",null,[t("li",null,"Linked 支持有界，Array 强制有界"),t("li",null,"Linked 实现是链表，Array 实现是数组"),t("li",null,"Linked 是懒惰的，而 Array 需要提前初始化 Node 数组"),t("li",null,"Linked 每次入队会生成新 Node，而 Array 的 Node 是提前创建好的（对Node对象的重用，减少垃圾回收）"),t("li",null,"Linked 两把锁，Array 一把锁（性能不如Linked）")],-1),qr={id:"_10、concurrentlinkedqueue",tabindex:"-1"},Pr=t("p",null,"ConcurrentLinkedQueue 的设计与 LinkedBlockingQueue 非常像，也是",-1),zr=t("ul",null,[t("li",null,"两把【锁】，同一时刻，可以允许两个线程同时（一个生产者与一个消费者）执行"),t("li",null,"dummy 节点的引入让两把【锁】将来锁住的是不同对象，避免竞争"),t("li",null,"只是这【锁】使用了 cas 来实现")],-1),_r=t("p",null,"事实上，ConcurrentLinkedQueue 应用还是非常广泛的 例如之前讲的 Tomcat 的 Connector 结构时，Acceptor 作为生产者向 Poller 消费者传递事件信息时，正是采用了ConcurrentLinkedQueue 将 SocketChannel 给 Poller 使用",-1),Kr=t("figure",null,[t("img",{src:"https://jsd.cdn.zzko.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230720205507789.png",alt:"image-20230720205507789",loading:"lazy",decoding:"async"})],-1),Vr={id:"_11、copyonwritearraylist",tabindex:"-1"},Mr=t("p",null,"CopyOnWriteArraySet 是它的马甲 底层实现采用了 写入时拷贝 的思想，增删改操作会将底层数组拷贝一份，更改操作在新数组上执行，这时不影响其它线程的并发读，读写分离。 以新增为例：",-1),Wr=t("div",{class:"language-java"},[t("button",{title:"Copy Code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki github-dark vp-code-dark"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"public"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"boolean"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"add"),t("span",{style:{color:"#E1E4E8"}},"(E e) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"synchronized"),t("span",{style:{color:"#E1E4E8"}}," (lock) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#6A737D"}},"// 获取旧的数组")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"Object"),t("span",{style:{color:"#E1E4E8"}},"[] es "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"getArray"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"int"),t("span",{style:{color:"#E1E4E8"}}," len "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," es.length;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#6A737D"}},"// 拷贝新的数组（这里是比较耗时的操作，但不影响其它读线程）")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        es "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," Arrays."),t("span",{style:{color:"#B392F0"}},"copyOf"),t("span",{style:{color:"#E1E4E8"}},"(es, len "),t("span",{style:{color:"#F97583"}},"+"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"1"),t("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#6A737D"}},"// 添加新元素")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        es[len] "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," e;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#6A737D"}},"// 替换旧的数组")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#B392F0"}},"setArray"),t("span",{style:{color:"#E1E4E8"}},"(es);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        "),t("span",{style:{color:"#F97583"}},"return"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"true"),t("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"}")])])]),t("pre",{class:"shiki github-light vp-code-light"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"public"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"boolean"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"add"),t("span",{style:{color:"#24292E"}},"(E e) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"synchronized"),t("span",{style:{color:"#24292E"}}," (lock) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6A737D"}},"// 获取旧的数组")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"Object"),t("span",{style:{color:"#24292E"}},"[] es "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"getArray"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"int"),t("span",{style:{color:"#24292E"}}," len "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," es.length;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6A737D"}},"// 拷贝新的数组（这里是比较耗时的操作，但不影响其它读线程）")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        es "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," Arrays."),t("span",{style:{color:"#6F42C1"}},"copyOf"),t("span",{style:{color:"#24292E"}},"(es, len "),t("span",{style:{color:"#D73A49"}},"+"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"1"),t("span",{style:{color:"#24292E"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6A737D"}},"// 添加新元素")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        es[len] "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," e;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6A737D"}},"// 替换旧的数组")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#6F42C1"}},"setArray"),t("span",{style:{color:"#24292E"}},"(es);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        "),t("span",{style:{color:"#D73A49"}},"return"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"true"),t("span",{style:{color:"#24292E"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"}")])])])],-1),Ur=t("blockquote",null,[t("p",null,"CopyOnWriteArraySet跟list的区别是set的元素是唯一的，set调用add方法时首先调用addIfAbsent方法看你的这个原素有没有，没有才添加；CopyOnWriteArraySet是可以读读并发，读写并发，写写才阻塞"),t("p",null,"这里的源码版本是 Java 11，在 Java 1.8 中使用的是可重入锁（ReentrantLock）而不是 synchronized")],-1),Qr=t("p",null,"其它读操作并未加锁，例如：",-1),Hr=t("div",{class:"language-java"},[t("button",{title:"Copy Code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki github-dark vp-code-dark"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"public"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"void"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"forEach"),t("span",{style:{color:"#E1E4E8"}},"(Consumer"),t("span",{style:{color:"#F97583"}},"<?"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#79B8FF"}},"super"),t("span",{style:{color:"#E1E4E8"}}," E"),t("span",{style:{color:"#F97583"}},">"),t("span",{style:{color:"#E1E4E8"}}," action) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    Objects."),t("span",{style:{color:"#B392F0"}},"requireNonNull"),t("span",{style:{color:"#E1E4E8"}},"(action);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#F97583"}},"for"),t("span",{style:{color:"#E1E4E8"}}," (Object x "),t("span",{style:{color:"#F97583"}},":"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"getArray"),t("span",{style:{color:"#E1E4E8"}},"()) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        @"),t("span",{style:{color:"#F97583"}},"SuppressWarnings"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#9ECBFF"}},'"unchecked"'),t("span",{style:{color:"#E1E4E8"}},") E e "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," (E) x;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"        action."),t("span",{style:{color:"#B392F0"}},"accept"),t("span",{style:{color:"#E1E4E8"}},"(e);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"}")])])]),t("pre",{class:"shiki github-light vp-code-light"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"public"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"void"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"forEach"),t("span",{style:{color:"#24292E"}},"(Consumer"),t("span",{style:{color:"#D73A49"}},"<?"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#005CC5"}},"super"),t("span",{style:{color:"#24292E"}}," E"),t("span",{style:{color:"#D73A49"}},">"),t("span",{style:{color:"#24292E"}}," action) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    Objects."),t("span",{style:{color:"#6F42C1"}},"requireNonNull"),t("span",{style:{color:"#24292E"}},"(action);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#D73A49"}},"for"),t("span",{style:{color:"#24292E"}}," (Object x "),t("span",{style:{color:"#D73A49"}},":"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"getArray"),t("span",{style:{color:"#24292E"}},"()) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        @"),t("span",{style:{color:"#D73A49"}},"SuppressWarnings"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#032F62"}},'"unchecked"'),t("span",{style:{color:"#24292E"}},") E e "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," (E) x;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"        action."),t("span",{style:{color:"#6F42C1"}},"accept"),t("span",{style:{color:"#24292E"}},"(e);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"}")])])])],-1),Gr=t("p",null,"适合『读多写少』的应用场景",-1),Jr={id:"get-弱一致性",tabindex:"-1"},Yr=t("figure",null,[t("img",{src:"https://jsd.cdn.zzko.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230720205728245.png",alt:"image-20230720205728245",loading:"lazy",decoding:"async"})],-1),Xr=t("figure",null,[t("img",{src:"https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230720205736316.png",alt:"image-20230720205736316",loading:"lazy",decoding:"async"})],-1),Zr=t("blockquote",null,[t("p",null,"不容易测试，但问题确实存在，Thread-0还是可以读取到就数组的1，引用还未改变")],-1),$r={id:"迭代器弱一致性",tabindex:"-1"},sE=t("div",{class:"language-java"},[t("button",{title:"Copy Code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki github-dark vp-code-dark"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"CopyOnWriteArrayList<"),t("span",{style:{color:"#F97583"}},"Integer"),t("span",{style:{color:"#E1E4E8"}},"> list "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#F97583"}},"new"),t("span",{style:{color:"#E1E4E8"}}," CopyOnWriteArrayList<>();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"list."),t("span",{style:{color:"#B392F0"}},"add"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#79B8FF"}},"1"),t("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"list."),t("span",{style:{color:"#B392F0"}},"add"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#79B8FF"}},"2"),t("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"list."),t("span",{style:{color:"#B392F0"}},"add"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#79B8FF"}},"3"),t("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"Iterator<"),t("span",{style:{color:"#F97583"}},"Integer"),t("span",{style:{color:"#E1E4E8"}},"> iter "),t("span",{style:{color:"#F97583"}},"="),t("span",{style:{color:"#E1E4E8"}}," list."),t("span",{style:{color:"#B392F0"}},"iterator"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"new"),t("span",{style:{color:"#E1E4E8"}}," "),t("span",{style:{color:"#B392F0"}},"Thread"),t("span",{style:{color:"#E1E4E8"}},"(() "),t("span",{style:{color:"#F97583"}},"->"),t("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"//删除的是新数组")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    list."),t("span",{style:{color:"#B392F0"}},"remove"),t("span",{style:{color:"#E1E4E8"}},"("),t("span",{style:{color:"#79B8FF"}},"0"),t("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    System.out."),t("span",{style:{color:"#B392F0"}},"println"),t("span",{style:{color:"#E1E4E8"}},"(list);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"})."),t("span",{style:{color:"#B392F0"}},"start"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#B392F0"}},"sleep1s"),t("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#F97583"}},"while"),t("span",{style:{color:"#E1E4E8"}}," (iter."),t("span",{style:{color:"#B392F0"}},"hasNext"),t("span",{style:{color:"#E1E4E8"}},"()) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"    "),t("span",{style:{color:"#6A737D"}},"//主线程遍历的还是未删除的旧数组")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"\tSystem.out."),t("span",{style:{color:"#B392F0"}},"println"),t("span",{style:{color:"#E1E4E8"}},"(iter."),t("span",{style:{color:"#B392F0"}},"next"),t("span",{style:{color:"#E1E4E8"}},"());")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#E1E4E8"}},"}")])])]),t("pre",{class:"shiki github-light vp-code-light"},[t("code",null,[t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"CopyOnWriteArrayList<"),t("span",{style:{color:"#D73A49"}},"Integer"),t("span",{style:{color:"#24292E"}},"> list "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#D73A49"}},"new"),t("span",{style:{color:"#24292E"}}," CopyOnWriteArrayList<>();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"list."),t("span",{style:{color:"#6F42C1"}},"add"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#005CC5"}},"1"),t("span",{style:{color:"#24292E"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"list."),t("span",{style:{color:"#6F42C1"}},"add"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#005CC5"}},"2"),t("span",{style:{color:"#24292E"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"list."),t("span",{style:{color:"#6F42C1"}},"add"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#005CC5"}},"3"),t("span",{style:{color:"#24292E"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"Iterator<"),t("span",{style:{color:"#D73A49"}},"Integer"),t("span",{style:{color:"#24292E"}},"> iter "),t("span",{style:{color:"#D73A49"}},"="),t("span",{style:{color:"#24292E"}}," list."),t("span",{style:{color:"#6F42C1"}},"iterator"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"new"),t("span",{style:{color:"#24292E"}}," "),t("span",{style:{color:"#6F42C1"}},"Thread"),t("span",{style:{color:"#24292E"}},"(() "),t("span",{style:{color:"#D73A49"}},"->"),t("span",{style:{color:"#24292E"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"//删除的是新数组")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    list."),t("span",{style:{color:"#6F42C1"}},"remove"),t("span",{style:{color:"#24292E"}},"("),t("span",{style:{color:"#005CC5"}},"0"),t("span",{style:{color:"#24292E"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    System.out."),t("span",{style:{color:"#6F42C1"}},"println"),t("span",{style:{color:"#24292E"}},"(list);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"})."),t("span",{style:{color:"#6F42C1"}},"start"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#6F42C1"}},"sleep1s"),t("span",{style:{color:"#24292E"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#D73A49"}},"while"),t("span",{style:{color:"#24292E"}}," (iter."),t("span",{style:{color:"#6F42C1"}},"hasNext"),t("span",{style:{color:"#24292E"}},"()) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"    "),t("span",{style:{color:"#6A737D"}},"//主线程遍历的还是未删除的旧数组")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"\tSystem.out."),t("span",{style:{color:"#6F42C1"}},"println"),t("span",{style:{color:"#24292E"}},"(iter."),t("span",{style:{color:"#6F42C1"}},"next"),t("span",{style:{color:"#24292E"}},"());")]),p("\n"),t("span",{class:"line"},[t("span",{style:{color:"#24292E"}},"}")])])])],-1),lE=t("blockquote",null,[t("p",null,"不要觉得弱一致性就不好"),t("ul",null,[t("li",null,"数据库的 MVCC 都是弱一致性的表现（MySQL的可重复度->MVCC）"),t("li",null,"并发高和一致性是矛盾的，需要权衡")])],-1);const oE=s(u,[["render",function(s,l,o,i,F,u){const oE=y,nE=e;return c(),n(nE,{frontmatter:F.frontmatter,data:F.data},{"main-content-md":a((()=>[t("h1",A,[p("并发编程笔记 "),r(oE,{class:"header-anchor",href:"#并发编程笔记","aria-hidden":"true"},{default:a((()=>[p("#")])),_:1})]),t("p",null,[p("本博客根据"),d,p("学习而做的笔记，链接如下："),r(oE,{href:"https://www.bilibili.com/video/av81461839?from=search&seid=8445102345230304010",target:"_blank",rel:"noreferrer"},{default:a((()=>[p("深入学习Java并发")])),_:1})]),t("h2",D,[p("七、线程池 "),r(oE,{class:"header-anchor",href:"#七、线程池","aria-hidden":"true"},{default:a((()=>[p("#")])),_:1})]),t("h3",C,[p("1、自定义线程池 "),r(oE,{class:"header-anchor",href:"#_1、自定义线程池","aria-hidden":"true"},{default:a((()=>[p("#")])),_:1})]),t("h4",h,[p("背景 "),r(oE,{class:"header-anchor",href:"#背景","aria-hidden":"true"},{default:a((()=>[p("#")])),_:1})]),g,t("h4",B,[p("图解 "),r(oE,{class:"header-anchor",href:"#图解","aria-hidden":"true"},{default:a((()=>[p("#")])),_:1})]),f,k,t("h4",b,[p("代码 "),r(oE,{class:"header-anchor",href:"#代码","aria-hidden":"true"},{default:a((()=>[p("#")])),_:1})]),m,S,v,t("h3",w,[p("2、ThreadPoolExecutor "),r(oE,{class:"header-anchor",href:"#_2、threadpoolexecutor","aria-hidden":"true"},{default:a((()=>[p("#")])),_:1})]),t("h4",T,[p("继承关系 "),r(oE,{class:"header-anchor",href:"#继承关系","aria-hidden":"true"},{default:a((()=>[p("#")])),_:1})]),x,t("h4",N,[p("线程池状态 "),r(oE,{class:"header-anchor",href:"#线程池状态","aria-hidden":"true"},{default:a((()=>[p("#")])),_:1})]),I,L,j,R,O,q,P,z,t("h4",_,[p("线程池属性 "),r(oE,{class:"header-anchor",href:"#线程池属性","aria-hidden":"true"},{default:a((()=>[p("#")])),_:1})]),K,t("h4",V,[p("构造方法极其参数 "),r(oE,{class:"header-anchor",href:"#构造方法极其参数","aria-hidden":"true"},{default:a((()=>[p("#")])),_:1})]),M,W,U,t("h4",Q,[H,p(),r(oE,{class:"header-anchor",href:"#参数解释","aria-hidden":"true"},{default:a((()=>[p("#")])),_:1})]),G,t("h4",J,[p("工作方式 "),r(oE,{class:"header-anchor",href:"#工作方式","aria-hidden":"true"},{default:a((()=>[p("#")])),_:1})]),Y,X,Z,t("h4",$,[p("拒绝策略 "),r(oE,{class:"header-anchor",href:"#拒绝策略","aria-hidden":"true"},{default:a((()=>[p("#")])),_:1})]),ss,ls,os,t("h4",ns,[p("使用 "),r(oE,{class:"header-anchor",href:"#使用","aria-hidden":"true"},{default:a((()=>[p("#")])),_:1})]),as,t("h4",es,[p("FixedThreadPool "),r(oE,{class:"header-anchor",href:"#fixedthreadpool","aria-hidden":"true"},{default:a((()=>[p("#")])),_:1})]),cs,ts,ps,rs,Es,ys,is,Fs,t("h4",us,[p("CachedThreadPool "),r(oE,{class:"header-anchor",href:"#cachedthreadpool","aria-hidden":"true"},{default:a((()=>[p("#")])),_:1})]),As,ds,Ds,Cs,hs,t("h4",gs,[p("SingleThread "),r(oE,{class:"header-anchor",href:"#singlethread","aria-hidden":"true"},{default:a((()=>[p("#")])),_:1})]),Bs,fs,ks,bs,ms,Ss,vs,ws,t("h4",Ts,[p("几个注意 "),r(oE,{class:"header-anchor",href:"#几个注意","aria-hidden":"true"},{default:a((()=>[p("#")])),_:1})]),xs,t("h4",Ns,[p("执行任务 "),r(oE,{class:"header-anchor",href:"#执行任务","aria-hidden":"true"},{default:a((()=>[p("#")])),_:1})]),t("h5",Is,[p("execute()方法 "),r(oE,{class:"header-anchor",href:"#execute-方法","aria-hidden":"true"},{default:a((()=>[p("#")])),_:1})]),Ls,js,Rs,Os,qs,Ps,t("h4",zs,[p("提交任务 "),r(oE,{class:"header-anchor",href:"#提交任务","aria-hidden":"true"},{default:a((()=>[p("#")])),_:1})]),_s,t("h5",Ks,[p("submit()方法 "),r(oE,{class:"header-anchor",href:"#submit-方法","aria-hidden":"true"},{default:a((()=>[p("#")])),_:1})]),Vs,Ms,Ws,Us,t("h5",Qs,[p("invokeAll方法 "),r(oE,{class:"header-anchor",href:"#invokeall方法","aria-hidden":"true"},{default:a((()=>[p("#")])),_:1})]),Hs,t("h4",Gs,[p("停止 "),r(oE,{class:"header-anchor",href:"#停止","aria-hidden":"true"},{default:a((()=>[p("#")])),_:1})]),t("h5",Js,[p("shutdown() "),r(oE,{class:"header-anchor",href:"#shutdown","aria-hidden":"true"},{default:a((()=>[p("#")])),_:1})]),Ys,t("h5",Xs,[p("shutdownNow() "),r(oE,{class:"header-anchor",href:"#shutdownnow","aria-hidden":"true"},{default:a((()=>[p("#")])),_:1})]),Zs,t("h5",$s,[p("其它方法 "),r(oE,{class:"header-anchor",href:"#其它方法","aria-hidden":"true"},{default:a((()=>[p("#")])),_:1})]),sl,t("h4",ll,[p("异步模式之工作线程 "),r(oE,{class:"header-anchor",href:"#异步模式之工作线程","aria-hidden":"true"},{default:a((()=>[p("#")])),_:1})]),t("h5",ol,[p("定义 "),r(oE,{class:"header-anchor",href:"#定义","aria-hidden":"true"},{default:a((()=>[p("#")])),_:1})]),nl,al,t("h5",el,[p("饥饿 "),r(oE,{class:"header-anchor",href:"#饥饿","aria-hidden":"true"},{default:a((()=>[p("#")])),_:1})]),cl,tl,t("h4",pl,[p("任务调度线程池 "),r(oE,{class:"header-anchor",href:"#任务调度线程池","aria-hidden":"true"},{default:a((()=>[p("#")])),_:1})]),rl,El,yl,il,Fl,ul,Al,dl,Dl,Cl,hl,gl,Bl,fl,kl,bl,t("h4",ml,[p("正确处理执行任务异常 "),r(oE,{class:"header-anchor",href:"#正确处理执行任务异常","aria-hidden":"true"},{default:a((()=>[p("#")])),_:1})]),Sl,vl,wl,Tl,xl,t("h4",Nl,[p("定时 "),r(oE,{class:"header-anchor",href:"#定时","aria-hidden":"true"},{default:a((()=>[p("#")])),_:1})]),t("h5",Il,[p("定期执行 "),r(oE,{class:"header-anchor",href:"#定期执行","aria-hidden":"true"},{default:a((()=>[p("#")])),_:1})]),Ll,jl,t("h4",Rl,[p("Tomcat 线程池 "),r(oE,{class:"header-anchor",href:"#tomcat-线程池","aria-hidden":"true"},{default:a((()=>[p("#")])),_:1})]),Ol,ql,Pl,zl,_l,Kl,Vl,Ml,Wl,Ul,Ql,Hl,Gl,Jl,t("h3",Yl,[p("3、Fork/Join "),r(oE,{class:"header-anchor",href:"#_3、fork-join","aria-hidden":"true"},{default:a((()=>[p("#")])),_:1})]),t("h4",Xl,[p("概念 "),r(oE,{class:"header-anchor",href:"#概念","aria-hidden":"true"},{default:a((()=>[p("#")])),_:1})]),Zl,t("h4",$l,[p("使用 "),r(oE,{class:"header-anchor",href:"#使用-1","aria-hidden":"true"},{default:a((()=>[p("#")])),_:1})]),so,lo,oo,no,ao,eo,co,to,t("h2",po,[p("八、JUC "),r(oE,{class:"header-anchor",href:"#八、juc","aria-hidden":"true"},{default:a((()=>[p("#")])),_:1})]),t("h3",ro,[p("1、AQS 原理 "),r(oE,{class:"header-anchor",href:"#_1、aqs-原理","aria-hidden":"true"},{default:a((()=>[p("#")])),_:1})]),Eo,yo,io,Fo,t("h4",uo,[p("实现不可重入锁 "),r(oE,{class:"header-anchor",href:"#实现不可重入锁","aria-hidden":"true"},{default:a((()=>[p("#")])),_:1})]),Ao,Do,Co,t("h4",ho,[p("AQS 的并发工具类 "),r(oE,{class:"header-anchor",href:"#aqs-的并发工具类","aria-hidden":"true"},{default:a((()=>[p("#")])),_:1})]),go,t("h3",Bo,[p("2、ReentrantLock 原理 "),r(oE,{class:"header-anchor",href:"#_2、reentrantlock-原理","aria-hidden":"true"},{default:a((()=>[p("#")])),_:1})]),fo,ko,t("h4",bo,[p("非公平锁实现原理 "),r(oE,{class:"header-anchor",href:"#非公平锁实现原理","aria-hidden":"true"},{default:a((()=>[p("#")])),_:1})]),t("h5",mo,[p("加锁解锁流程 "),r(oE,{class:"header-anchor",href:"#加锁解锁流程","aria-hidden":"true"},{default:a((()=>[p("#")])),_:1})]),So,vo,wo,To,xo,No,Io,Lo,jo,Ro,Oo,qo,Po,zo,_o,Ko,Vo,Mo,Wo,Uo,Qo,Ho,Go,Jo,Yo,Xo,Zo,t("h5",$o,[p("加锁源码 "),r(oE,{class:"header-anchor",href:"#加锁源码","aria-hidden":"true"},{default:a((()=>[p("#")])),_:1})]),sn,ln,t("h5",on,[p("解锁源码 "),r(oE,{class:"header-anchor",href:"#解锁源码","aria-hidden":"true"},{default:a((()=>[p("#")])),_:1})]),nn,t("h4",an,[p("可重入原理 "),r(oE,{class:"header-anchor",href:"#可重入原理","aria-hidden":"true"},{default:a((()=>[p("#")])),_:1})]),en,t("h4",cn,[p("可打断原理 "),r(oE,{class:"header-anchor",href:"#可打断原理","aria-hidden":"true"},{default:a((()=>[p("#")])),_:1})]),tn,pn,rn,En,t("h4",yn,[p("公平锁实现原理 "),r(oE,{class:"header-anchor",href:"#公平锁实现原理","aria-hidden":"true"},{default:a((()=>[p("#")])),_:1})]),Fn,t("h4",un,[p("条件变量实现原理 "),r(oE,{class:"header-anchor",href:"#条件变量实现原理","aria-hidden":"true"},{default:a((()=>[p("#")])),_:1})]),An,t("h5",dn,[p("await 流程 "),r(oE,{class:"header-anchor",href:"#await-流程","aria-hidden":"true"},{default:a((()=>[p("#")])),_:1})]),Dn,Cn,hn,gn,Bn,fn,kn,bn,t("h5",mn,[p("signal 流程 "),r(oE,{class:"header-anchor",href:"#signal-流程","aria-hidden":"true"},{default:a((()=>[p("#")])),_:1})]),Sn,vn,wn,Tn,xn,Nn,In,t("h5",Ln,[p("源码分析 "),r(oE,{class:"header-anchor",href:"#源码分析","aria-hidden":"true"},{default:a((()=>[p("#")])),_:1})]),jn,t("h3",Rn,[p("3、读写锁 "),r(oE,{class:"header-anchor",href:"#_3、读写锁","aria-hidden":"true"},{default:a((()=>[p("#")])),_:1})]),t("h4",On,[p("ReentrantReadWriteLock "),r(oE,{class:"header-anchor",href:"#reentrantreadwritelock","aria-hidden":"true"},{default:a((()=>[p("#")])),_:1})]),qn,Pn,zn,_n,Kn,Vn,Mn,Wn,Un,Qn,Hn,Gn,Jn,Yn,t("h4",Xn,[p("应用之缓存 "),r(oE,{class:"header-anchor",href:"#应用之缓存","aria-hidden":"true"},{default:a((()=>[p("#")])),_:1})]),t("h5",Zn,[p("缓存更新策略 "),r(oE,{class:"header-anchor",href:"#缓存更新策略","aria-hidden":"true"},{default:a((()=>[p("#")])),_:1})]),$n,sa,la,oa,na,aa,ea,ca,t("h5",ta,[p("读写锁实现一致性缓存 "),r(oE,{class:"header-anchor",href:"#读写锁实现一致性缓存","aria-hidden":"true"},{default:a((()=>[p("#")])),_:1})]),pa,ra,Ea,t("h4",ya,[p("读写锁原理 "),r(oE,{class:"header-anchor",href:"#读写锁原理","aria-hidden":"true"},{default:a((()=>[p("#")])),_:1})]),t("h5",ia,[p("图解流程 "),r(oE,{class:"header-anchor",href:"#图解流程","aria-hidden":"true"},{default:a((()=>[p("#")])),_:1})]),Fa,t("h6",ua,[p("t1 w.lock，t2 r.lock "),r(oE,{class:"header-anchor",href:"#t1-w-lock-t2-r-lock","aria-hidden":"true"},{default:a((()=>[p("#")])),_:1})]),Aa,da,Da,Ca,ha,ga,Ba,fa,ka,ba,t("h6",ma,[p("t3 r.lock，t4 w.lock "),r(oE,{class:"header-anchor",href:"#t3-r-lock-t4-w-lock","aria-hidden":"true"},{default:a((()=>[p("#")])),_:1})]),Sa,va,t("h6",wa,[p("t1 w.unlock "),r(oE,{class:"header-anchor",href:"#t1-w-unlock","aria-hidden":"true"},{default:a((()=>[p("#")])),_:1})]),Ta,xa,Na,Ia,La,ja,Ra,Oa,qa,Pa,za,_a,Ka,Va,t("h6",Ma,[p("t2 r.unlock，t3 r.unlock "),r(oE,{class:"header-anchor",href:"#t2-r-unlock-t3-r-unlock","aria-hidden":"true"},{default:a((()=>[p("#")])),_:1})]),Wa,Ua,Qa,Ha,Ga,Ja,t("h5",Ya,[p("源码分析 "),r(oE,{class:"header-anchor",href:"#源码分析-1","aria-hidden":"true"},{default:a((()=>[p("#")])),_:1})]),t("h6",Xa,[p("写锁上锁流程 "),r(oE,{class:"header-anchor",href:"#写锁上锁流程","aria-hidden":"true"},{default:a((()=>[p("#")])),_:1})]),Za,t("h6",$a,[p("写锁释放流程 "),r(oE,{class:"header-anchor",href:"#写锁释放流程","aria-hidden":"true"},{default:a((()=>[p("#")])),_:1})]),se,t("h6",le,[p("读锁上锁流程 "),r(oE,{class:"header-anchor",href:"#读锁上锁流程","aria-hidden":"true"},{default:a((()=>[p("#")])),_:1})]),oe,t("h6",ne,[p("读锁释放流程 "),r(oE,{class:"header-anchor",href:"#读锁释放流程","aria-hidden":"true"},{default:a((()=>[p("#")])),_:1})]),ae,t("h4",ee,[p("StampedLock "),r(oE,{class:"header-anchor",href:"#stampedlock","aria-hidden":"true"},{default:a((()=>[p("#")])),_:1})]),ce,te,pe,re,Ee,ye,ie,Fe,ue,Ae,de,De,Ce,he,ge,Be,t("h3",fe,[p("4、Semaphore "),r(oE,{class:"header-anchor",href:"#_4、semaphore","aria-hidden":"true"},{default:a((()=>[p("#")])),_:1})]),t("h4",ke,[p("基本使用 "),r(oE,{class:"header-anchor",href:"#基本使用","aria-hidden":"true"},{default:a((()=>[p("#")])),_:1})]),be,me,Se,t("h4",ve,[p("Semaphore 应用 "),r(oE,{class:"header-anchor",href:"#semaphore-应用","aria-hidden":"true"},{default:a((()=>[p("#")])),_:1})]),we,Te,xe,t("h4",Ne,[p("Semaphore 原理 "),r(oE,{class:"header-anchor",href:"#semaphore-原理","aria-hidden":"true"},{default:a((()=>[p("#")])),_:1})]),t("h5",Ie,[p("加锁解锁流程 "),r(oE,{class:"header-anchor",href:"#加锁解锁流程-1","aria-hidden":"true"},{default:a((()=>[p("#")])),_:1})]),Le,je,Re,Oe,qe,Pe,ze,_e,t("h5",Ke,[p("源码分析 "),r(oE,{class:"header-anchor",href:"#源码分析-2","aria-hidden":"true"},{default:a((()=>[p("#")])),_:1})]),Ve,t("h5",Me,[p("为什么要有 PROPAGATE "),r(oE,{class:"header-anchor",href:"#为什么要有-propagate","aria-hidden":"true"},{default:a((()=>[p("#")])),_:1})]),We,Ue,Qe,He,Ge,Je,Ye,Xe,Ze,$e,sc,lc,oc,nc,ac,ec,cc,tc,t("h3",pc,[p("5、CountdownLatch "),r(oE,{class:"header-anchor",href:"#_5、countdownlatch","aria-hidden":"true"},{default:a((()=>[p("#")])),_:1})]),rc,Ec,yc,ic,Fc,uc,t("h4",Ac,[p("应用之同步等待多线程准备完毕 "),r(oE,{class:"header-anchor",href:"#应用之同步等待多线程准备完毕","aria-hidden":"true"},{default:a((()=>[p("#")])),_:1})]),dc,Dc,t("h4",Cc,[p("应用之同步等待多个远程调用结束 "),r(oE,{class:"header-anchor",href:"#应用之同步等待多个远程调用结束","aria-hidden":"true"},{default:a((()=>[p("#")])),_:1})]),hc,gc,Bc,fc,t("h3",kc,[p("6、CyclicBarrier "),r(oE,{class:"header-anchor",href:"#_6、cyclicbarrier","aria-hidden":"true"},{default:a((()=>[p("#")])),_:1})]),bc,mc,Sc,vc,wc,Tc,t("h3",xc,[p("7、线程安全集合类概述 "),r(oE,{class:"header-anchor",href:"#_7、线程安全集合类概述","aria-hidden":"true"},{default:a((()=>[p("#")])),_:1})]),Nc,Ic,Lc,jc,Rc,Oc,t("h3",qc,[p("8、ConcurrentHashMap "),r(oE,{class:"header-anchor",href:"#_8、concurrenthashmap","aria-hidden":"true"},{default:a((()=>[p("#")])),_:1})]),t("h4",Pc,[p("练习：单词计数 "),r(oE,{class:"header-anchor",href:"#练习-单词计数","aria-hidden":"true"},{default:a((()=>[p("#")])),_:1})]),zc,_c,Kc,Vc,Mc,Wc,Uc,Qc,Hc,Gc,Jc,Yc,Xc,Zc,$c,st,lt,t("h4",ot,[p("ConcurrentHashMap 原理 "),r(oE,{class:"header-anchor",href:"#concurrenthashmap-原理","aria-hidden":"true"},{default:a((()=>[p("#")])),_:1})]),t("h5",nt,[p("JDK 7 HashMap 并发死链 "),r(oE,{class:"header-anchor",href:"#jdk-7-hashmap-并发死链","aria-hidden":"true"},{default:a((()=>[p("#")])),_:1})]),t("h6",at,[p("测试代码 "),r(oE,{class:"header-anchor",href:"#测试代码","aria-hidden":"true"},{default:a((()=>[p("#")])),_:1})]),et,ct,tt,pt,t("h6",rt,[p("死链复现 "),r(oE,{class:"header-anchor",href:"#死链复现","aria-hidden":"true"},{default:a((()=>[p("#")])),_:1})]),Et,yt,it,Ft,ut,At,dt,Dt,Ct,ht,gt,Bt,ft,kt,bt,mt,St,vt,wt,Tt,xt,Nt,It,Lt,jt,Rt,Ot,qt,Pt,zt,_t,Kt,Vt,Mt,Wt,Ut,Qt,t("h6",Ht,[p("源码分析 "),r(oE,{class:"header-anchor",href:"#源码分析-3","aria-hidden":"true"},{default:a((()=>[p("#")])),_:1})]),Gt,Jt,Yt,Xt,t("h6",Zt,[p("小结 "),r(oE,{class:"header-anchor",href:"#小结","aria-hidden":"true"},{default:a((()=>[p("#")])),_:1})]),$t,t("h5",sp,[p("JDK 8 ConcurrentHashMap "),r(oE,{class:"header-anchor",href:"#jdk-8-concurrenthashmap","aria-hidden":"true"},{default:a((()=>[p("#")])),_:1})]),t("h6",lp,[p("重要属性和内部类 "),r(oE,{class:"header-anchor",href:"#重要属性和内部类","aria-hidden":"true"},{default:a((()=>[p("#")])),_:1})]),op,np,t("h6",ap,[p("重要方法 "),r(oE,{class:"header-anchor",href:"#重要方法","aria-hidden":"true"},{default:a((()=>[p("#")])),_:1})]),ep,t("h6",cp,[p("构造器分析 "),r(oE,{class:"header-anchor",href:"#构造器分析","aria-hidden":"true"},{default:a((()=>[p("#")])),_:1})]),tp,pp,rp,t("h6",Ep,[p("get 流程 "),r(oE,{class:"header-anchor",href:"#get-流程","aria-hidden":"true"},{default:a((()=>[p("#")])),_:1})]),yp,ip,t("h6",Fp,[p("put 流程 "),r(oE,{class:"header-anchor",href:"#put-流程","aria-hidden":"true"},{default:a((()=>[p("#")])),_:1})]),up,Ap,dp,t("h6",Dp,[p("size 计算流程 "),r(oE,{class:"header-anchor",href:"#size-计算流程","aria-hidden":"true"},{default:a((()=>[p("#")])),_:1})]),Cp,hp,gp,t("h6",Bp,[p("扩容 "),r(oE,{class:"header-anchor",href:"#扩容","aria-hidden":"true"},{default:a((()=>[p("#")])),_:1})]),fp,kp,bp,mp,t("p",null,[p("源码分析 "),r(oE,{href:"http://www.importnew.com/28263.html",target:"_blank",rel:"noreferrer"},{default:a((()=>[p("http://www.importnew.com/28263.html")])),_:1}),p(" 其它实现 "),r(oE,{href:"https://github.com/boundary/high-scale-lib",target:"_blank",rel:"noreferrer"},{default:a((()=>[p("Cliff Click's high scale lib")])),_:1})]),t("h5",Sp,[p("JDK 7 ConcurrentHashMap "),r(oE,{class:"header-anchor",href:"#jdk-7-concurrenthashmap","aria-hidden":"true"},{default:a((()=>[p("#")])),_:1})]),vp,wp,t("h6",Tp,[p("构造器分析 "),r(oE,{class:"header-anchor",href:"#构造器分析-1","aria-hidden":"true"},{default:a((()=>[p("#")])),_:1})]),xp,Np,Ip,Lp,jp,Rp,Op,qp,Pp,zp,_p,Kp,Vp,Mp,t("h6",Wp,[p("rehash 流程 "),r(oE,{class:"header-anchor",href:"#rehash-流程","aria-hidden":"true"},{default:a((()=>[p("#")])),_:1})]),Up,Qp,Hp,t("h6",Gp,[p("get 流程 "),r(oE,{class:"header-anchor",href:"#get-流程-1","aria-hidden":"true"},{default:a((()=>[p("#")])),_:1})]),Jp,Yp,Xp,t("h6",Zp,[p("size 计算流程 "),r(oE,{class:"header-anchor",href:"#size-计算流程-1","aria-hidden":"true"},{default:a((()=>[p("#")])),_:1})]),$p,sr,lr,t("h3",or,[p("9、LinkedBlockingQueue 原理 "),r(oE,{class:"header-anchor",href:"#_9、linkedblockingqueue-原理","aria-hidden":"true"},{default:a((()=>[p("#")])),_:1})]),t("h4",nr,[p("基本的入队出队 "),r(oE,{class:"header-anchor",href:"#基本的入队出队","aria-hidden":"true"},{default:a((()=>[p("#")])),_:1})]),ar,er,cr,tr,pr,rr,Er,yr,ir,Fr,ur,Ar,dr,Dr,Cr,hr,gr,Br,fr,t("h4",kr,[p("加锁分析 "),r(oE,{class:"header-anchor",href:"#加锁分析","aria-hidden":"true"},{default:a((()=>[p("#")])),_:1})]),br,mr,Sr,vr,wr,Tr,xr,Nr,Ir,Lr,t("h4",jr,[p("性能比较 "),r(oE,{class:"header-anchor",href:"#性能比较","aria-hidden":"true"},{default:a((()=>[p("#")])),_:1})]),Rr,Or,t("h3",qr,[p("10、ConcurrentLinkedQueue "),r(oE,{class:"header-anchor",href:"#_10、concurrentlinkedqueue","aria-hidden":"true"},{default:a((()=>[p("#")])),_:1})]),Pr,zr,_r,Kr,t("h3",Vr,[p("11、CopyOnWriteArrayList "),r(oE,{class:"header-anchor",href:"#_11、copyonwritearraylist","aria-hidden":"true"},{default:a((()=>[p("#")])),_:1})]),Mr,Wr,Ur,Qr,Hr,Gr,t("h4",Jr,[p("get 弱一致性 "),r(oE,{class:"header-anchor",href:"#get-弱一致性","aria-hidden":"true"},{default:a((()=>[p("#")])),_:1})]),Yr,Xr,Zr,t("h4",$r,[p("迭代器弱一致性 "),r(oE,{class:"header-anchor",href:"#迭代器弱一致性","aria-hidden":"true"},{default:a((()=>[p("#")])),_:1})]),sE,lE])),"main-header":a((()=>[E(s.$slots,"main-header")])),"main-header-after":a((()=>[E(s.$slots,"main-header-after")])),"main-nav":a((()=>[E(s.$slots,"main-nav")])),"main-content":a((()=>[E(s.$slots,"main-content")])),"main-content-after":a((()=>[E(s.$slots,"main-content-after")])),"main-nav-before":a((()=>[E(s.$slots,"main-nav-before")])),"main-nav-after":a((()=>[E(s.$slots,"main-nav-after")])),comment:a((()=>[E(s.$slots,"comment")])),footer:a((()=>[E(s.$slots,"footer")])),aside:a((()=>[E(s.$slots,"aside")])),"aside-custom":a((()=>[E(s.$slots,"aside-custom")])),default:a((()=>[E(s.$slots,"default")])),_:3},8,["frontmatter","data"])}]]);export{i as __pageData,oE as default};
