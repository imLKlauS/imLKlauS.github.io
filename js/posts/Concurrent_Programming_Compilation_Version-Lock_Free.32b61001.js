import{_ as l,u as s,p as o,c as n,w as a,a as e,o as t,b as c,d as p,e as r,r as E,f as y}from"../../assets/app-f772c525.js";const i=JSON.parse('{"title":"并发编程整理版-无锁","description":"","frontmatter":{"cover":"https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/wallhaven-3zqqdy_1920x1080.png","title":"并发编程整理版-无锁","top":301,"author":"imklaus","tags":["CAS","Atomic","volatile","LongAdder","Unsafe","final","ThreadLocal"],"categories":"Java","date":"2023-08-24T18:49:36.000Z","outline":"deep"},"headers":[{"level":2,"title":"无锁","slug":"无锁","link":"#无锁","children":[{"level":3,"title":"CAS","slug":"cas","link":"#cas","children":[]},{"level":3,"title":"Atomic","slug":"atomic","link":"#atomic","children":[]},{"level":3,"title":"Adder","slug":"adder","link":"#adder","children":[]},{"level":3,"title":"ABA","slug":"aba","link":"#aba","children":[]},{"level":3,"title":"Unsafe","slug":"unsafe","link":"#unsafe","children":[]},{"level":3,"title":"final","slug":"final","link":"#final","children":[]},{"level":3,"title":"State","slug":"state","link":"#state","children":[]},{"level":3,"title":"Local","slug":"local","link":"#local","children":[]}]}],"relativePath":"pages/posts/Concurrent_Programming_Compilation_Version-Lock_Free.md","path":"D:\\\\Learning\\\\myblog\\\\valaxy-lastest\\\\imklaus-valaxy-blog\\\\pages\\\\posts\\\\Concurrent_Programming_Compilation_Version-Lock_Free.md","lastUpdated":null}'),F=JSON.parse('{"title":"并发编程整理版-无锁","description":"","frontmatter":{"cover":"https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/wallhaven-3zqqdy_1920x1080.png","title":"并发编程整理版-无锁","top":301,"author":"imklaus","tags":["CAS","Atomic","volatile","LongAdder","Unsafe","final","ThreadLocal"],"categories":"Java","date":"2023-08-24T18:49:36.000Z","outline":"deep"},"headers":[{"level":2,"title":"无锁","slug":"无锁","link":"#无锁","children":[{"level":3,"title":"CAS","slug":"cas","link":"#cas","children":[]},{"level":3,"title":"Atomic","slug":"atomic","link":"#atomic","children":[]},{"level":3,"title":"Adder","slug":"adder","link":"#adder","children":[]},{"level":3,"title":"ABA","slug":"aba","link":"#aba","children":[]},{"level":3,"title":"Unsafe","slug":"unsafe","link":"#unsafe","children":[]},{"level":3,"title":"final","slug":"final","link":"#final","children":[]},{"level":3,"title":"State","slug":"state","link":"#state","children":[]},{"level":3,"title":"Local","slug":"local","link":"#local","children":[]}]}],"relativePath":"pages/posts/Concurrent_Programming_Compilation_Version-Lock_Free.md","path":"D:\\\\Learning\\\\myblog\\\\valaxy-lastest\\\\imklaus-valaxy-blog\\\\pages\\\\posts\\\\Concurrent_Programming_Compilation_Version-Lock_Free.md","lastUpdated":null}'),u={name:"pages/posts/Concurrent_Programming_Compilation_Version-Lock_Free.md",data:()=>({data:F,frontmatter:F.frontmatter,$frontmatter:F.frontmatter}),setup(){const l=s();l.meta.frontmatter=Object.assign(l.meta.frontmatter,F.frontmatter),o("pageData",F)}},A={id:"并发编程整理版",tabindex:"-1"},d=c("p",null,"笔记的整体结构依据视频编写，并随着学习的深入补充了很多知识",-1),D={id:"无锁",tabindex:"-1"},h={id:"cas",tabindex:"-1"},g={id:"例子",tabindex:"-1"},C=c("div",{style:{"max-height":"300px"},class:"language-java"},[c("button",{title:"Copy Code",class:"copy"}),c("span",{class:"lang"},"java"),c("pre",{class:"shiki github-dark vp-code-dark"},[c("code",null,[c("span",{class:"line"},[c("span",{style:{color:"#F97583"}},"interface"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#B392F0"}},"Account"),c("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"\tInteger "),c("span",{style:{color:"#B392F0"}},"getBalance"),c("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"\t"),c("span",{style:{color:"#F97583"}},"void"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#B392F0"}},"withdraw"),c("span",{style:{color:"#E1E4E8"}},"(Integer "),c("span",{style:{color:"#FFAB70"}},"amount"),c("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"\t/**")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"\t * 方法内会启动 1000 个线程，每个线程做 -10 元 的操作     ")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"\t * 如果初始余额为 10000 那么正确的结果应当是 0")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"\t */")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"\t"),c("span",{style:{color:"#F97583"}},"static"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#F97583"}},"void"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#B392F0"}},"demo"),c("span",{style:{color:"#E1E4E8"}},"(Account "),c("span",{style:{color:"#FFAB70"}},"account"),c("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"\t\tList<"),c("span",{style:{color:"#F97583"}},"Thread"),c("span",{style:{color:"#E1E4E8"}},"> ts "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#F97583"}},"new"),c("span",{style:{color:"#E1E4E8"}}," ArrayList<>();")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"\t\t"),c("span",{style:{color:"#F97583"}},"long"),c("span",{style:{color:"#E1E4E8"}}," start "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," System."),c("span",{style:{color:"#B392F0"}},"nanoTime"),c("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"\t\t"),c("span",{style:{color:"#F97583"}},"for"),c("span",{style:{color:"#E1E4E8"}}," ("),c("span",{style:{color:"#F97583"}},"int"),c("span",{style:{color:"#E1E4E8"}}," i "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#79B8FF"}},"0"),c("span",{style:{color:"#E1E4E8"}},"; i "),c("span",{style:{color:"#F97583"}},"<"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#79B8FF"}},"1000"),c("span",{style:{color:"#E1E4E8"}},"; i"),c("span",{style:{color:"#F97583"}},"++"),c("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"\t\t\tts."),c("span",{style:{color:"#B392F0"}},"add"),c("span",{style:{color:"#E1E4E8"}},"("),c("span",{style:{color:"#F97583"}},"new"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#B392F0"}},"Thread"),c("span",{style:{color:"#E1E4E8"}},"(() "),c("span",{style:{color:"#F97583"}},"->"),c("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"\t\t\t\taccount."),c("span",{style:{color:"#B392F0"}},"withdraw"),c("span",{style:{color:"#E1E4E8"}},"("),c("span",{style:{color:"#79B8FF"}},"10"),c("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"\t\t\t}));")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"\t\t}")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"\t\tts."),c("span",{style:{color:"#B392F0"}},"forEach"),c("span",{style:{color:"#E1E4E8"}},"(Thread"),c("span",{style:{color:"#F97583"}},"::"),c("span",{style:{color:"#E1E4E8"}},"start);")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"\t\tts."),c("span",{style:{color:"#B392F0"}},"forEach"),c("span",{style:{color:"#E1E4E8"}},"(t "),c("span",{style:{color:"#F97583"}},"->"),c("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"\t\t\t"),c("span",{style:{color:"#F97583"}},"try"),c("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"\t\t\t\tt."),c("span",{style:{color:"#B392F0"}},"join"),c("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"\t\t\t} "),c("span",{style:{color:"#F97583"}},"catch"),c("span",{style:{color:"#E1E4E8"}}," (InterruptedException "),c("span",{style:{color:"#FFAB70"}},"e"),c("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"\t\t\t\te."),c("span",{style:{color:"#B392F0"}},"printStackTrace"),c("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"\t\t\t}")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"\t\t});")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"\t\t"),c("span",{style:{color:"#F97583"}},"long"),c("span",{style:{color:"#E1E4E8"}}," end "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," System."),c("span",{style:{color:"#B392F0"}},"nanoTime"),c("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"\t\tSystem.out."),c("span",{style:{color:"#B392F0"}},"println"),c("span",{style:{color:"#E1E4E8"}},"(account."),c("span",{style:{color:"#B392F0"}},"getBalance"),c("span",{style:{color:"#E1E4E8"}},"() "),c("span",{style:{color:"#F97583"}},"+"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#9ECBFF"}},'" cost: "'),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#F97583"}},"+"),c("span",{style:{color:"#E1E4E8"}}," (end "),c("span",{style:{color:"#F97583"}},"-"),c("span",{style:{color:"#E1E4E8"}}," start) "),c("span",{style:{color:"#F97583"}},"/"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#79B8FF"}},"1000_000"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#F97583"}},"+"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#9ECBFF"}},'" ms"'),c("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"\t}")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"}")]),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"//线程不安全的做法")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#F97583"}},"class"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#B392F0"}},"AccountUnsafe"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#F97583"}},"implements"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#B392F0"}},"Account"),c("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"\t"),c("span",{style:{color:"#F97583"}},"private"),c("span",{style:{color:"#E1E4E8"}}," Integer balance;")]),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"\t"),c("span",{style:{color:"#F97583"}},"public"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#B392F0"}},"AccountUnsafe"),c("span",{style:{color:"#E1E4E8"}},"(Integer "),c("span",{style:{color:"#FFAB70"}},"balance"),c("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"\t\t"),c("span",{style:{color:"#79B8FF"}},"this"),c("span",{style:{color:"#E1E4E8"}},".balance "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," balance;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"\t}")]),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"\t@"),c("span",{style:{color:"#F97583"}},"Override")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"\t"),c("span",{style:{color:"#F97583"}},"public"),c("span",{style:{color:"#E1E4E8"}}," Integer "),c("span",{style:{color:"#B392F0"}},"getBalance"),c("span",{style:{color:"#E1E4E8"}},"() {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"\t\t"),c("span",{style:{color:"#F97583"}},"return"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#79B8FF"}},"this"),c("span",{style:{color:"#E1E4E8"}},".balance;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"\t}")]),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"\t@"),c("span",{style:{color:"#F97583"}},"Override")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"\t"),c("span",{style:{color:"#F97583"}},"public"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#F97583"}},"synchronized"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#F97583"}},"void"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#B392F0"}},"withdraw"),c("span",{style:{color:"#E1E4E8"}},"(Integer "),c("span",{style:{color:"#FFAB70"}},"amount"),c("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"\t\tbalance "),c("span",{style:{color:"#F97583"}},"-="),c("span",{style:{color:"#E1E4E8"}}," amount;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"\t}")]),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"\t"),c("span",{style:{color:"#F97583"}},"public"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#F97583"}},"static"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#F97583"}},"void"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#B392F0"}},"main"),c("span",{style:{color:"#E1E4E8"}},"("),c("span",{style:{color:"#F97583"}},"String"),c("span",{style:{color:"#E1E4E8"}},"[] "),c("span",{style:{color:"#FFAB70"}},"args"),c("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"\t\tAccount."),c("span",{style:{color:"#B392F0"}},"demo"),c("span",{style:{color:"#E1E4E8"}},"("),c("span",{style:{color:"#F97583"}},"new"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#B392F0"}},"AccountUnsafe"),c("span",{style:{color:"#E1E4E8"}},"("),c("span",{style:{color:"#79B8FF"}},"10000"),c("span",{style:{color:"#E1E4E8"}},"));")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"\t\tAccount."),c("span",{style:{color:"#B392F0"}},"demo"),c("span",{style:{color:"#E1E4E8"}},"("),c("span",{style:{color:"#F97583"}},"new"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#B392F0"}},"AccountCas"),c("span",{style:{color:"#E1E4E8"}},"("),c("span",{style:{color:"#79B8FF"}},"10000"),c("span",{style:{color:"#E1E4E8"}},"));")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"\t}")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"}")]),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"//线程安全的做法")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#F97583"}},"class"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#B392F0"}},"AccountCas"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#F97583"}},"implements"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#B392F0"}},"Account"),c("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"\t"),c("span",{style:{color:"#6A737D"}},"//使用原子整数")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"\t"),c("span",{style:{color:"#F97583"}},"private"),c("span",{style:{color:"#E1E4E8"}}," AtomicInteger balance;")]),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"\t"),c("span",{style:{color:"#F97583"}},"public"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#B392F0"}},"AccountCas"),c("span",{style:{color:"#E1E4E8"}},"("),c("span",{style:{color:"#F97583"}},"int"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#FFAB70"}},"balance"),c("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"\t\t"),c("span",{style:{color:"#79B8FF"}},"this"),c("span",{style:{color:"#E1E4E8"}},".balance "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#F97583"}},"new"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#B392F0"}},"AtomicInteger"),c("span",{style:{color:"#E1E4E8"}},"(balance);")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"\t}")]),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"\t@"),c("span",{style:{color:"#F97583"}},"Override")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"\t"),c("span",{style:{color:"#F97583"}},"public"),c("span",{style:{color:"#E1E4E8"}}," Integer "),c("span",{style:{color:"#B392F0"}},"getBalance"),c("span",{style:{color:"#E1E4E8"}},"() {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"\t\t"),c("span",{style:{color:"#6A737D"}},"//得到原子整数的值")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"\t\t"),c("span",{style:{color:"#F97583"}},"return"),c("span",{style:{color:"#E1E4E8"}}," balance."),c("span",{style:{color:"#B392F0"}},"get"),c("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"\t}")]),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"\t@"),c("span",{style:{color:"#F97583"}},"Override")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"\t"),c("span",{style:{color:"#F97583"}},"public"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#F97583"}},"void"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#B392F0"}},"withdraw"),c("span",{style:{color:"#E1E4E8"}},"(Integer "),c("span",{style:{color:"#FFAB70"}},"amount"),c("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"\t\t\t"),c("span",{style:{color:"#6A737D"}},"// 需要不断尝试，直到成功为止")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"            "),c("span",{style:{color:"#F97583"}},"while"),c("span",{style:{color:"#E1E4E8"}}," ("),c("span",{style:{color:"#79B8FF"}},"true"),c("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"            "),c("span",{style:{color:"#6A737D"}},"// 比如拿到了旧值 1000")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"            "),c("span",{style:{color:"#F97583"}},"int"),c("span",{style:{color:"#E1E4E8"}}," prev "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," balance."),c("span",{style:{color:"#B392F0"}},"get"),c("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"            "),c("span",{style:{color:"#6A737D"}},"// 在这个基础上 1000-10 = 990")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"            "),c("span",{style:{color:"#F97583"}},"int"),c("span",{style:{color:"#E1E4E8"}}," next "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," prev "),c("span",{style:{color:"#F97583"}},"-"),c("span",{style:{color:"#E1E4E8"}}," amount;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"            "),c("span",{style:{color:"#6A737D"}},"/*")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"            compareAndSet 正是做这个检查，在 set 前，先比较 prev 与当前值")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"            - 不一致了，next 作废，返回 false 表示失败")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"            比如，别的线程已经做了减法，当前值已经被减成了 990")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"            那么本线程的这次 990 就作废了，进入 while 下次循环重试")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"            - 一致，以 next 设置为新值，返回 true 表示成功")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"            */")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"\t\t\t"),c("span",{style:{color:"#F97583"}},"if"),c("span",{style:{color:"#E1E4E8"}},"(balance."),c("span",{style:{color:"#B392F0"}},"compareAndSet"),c("span",{style:{color:"#E1E4E8"}},"(prev, next)) {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"\t\t\t\t"),c("span",{style:{color:"#F97583"}},"break"),c("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"\t\t\t}")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"\t\t}")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"\t}")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"}")])])]),c("pre",{class:"shiki github-light vp-code-light"},[c("code",null,[c("span",{class:"line"},[c("span",{style:{color:"#D73A49"}},"interface"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#6F42C1"}},"Account"),c("span",{style:{color:"#24292E"}}," {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"\tInteger "),c("span",{style:{color:"#6F42C1"}},"getBalance"),c("span",{style:{color:"#24292E"}},"();")]),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"\t"),c("span",{style:{color:"#D73A49"}},"void"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#6F42C1"}},"withdraw"),c("span",{style:{color:"#24292E"}},"(Integer "),c("span",{style:{color:"#E36209"}},"amount"),c("span",{style:{color:"#24292E"}},");")]),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"\t/**")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"\t * 方法内会启动 1000 个线程，每个线程做 -10 元 的操作     ")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"\t * 如果初始余额为 10000 那么正确的结果应当是 0")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"\t */")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"\t"),c("span",{style:{color:"#D73A49"}},"static"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#D73A49"}},"void"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#6F42C1"}},"demo"),c("span",{style:{color:"#24292E"}},"(Account "),c("span",{style:{color:"#E36209"}},"account"),c("span",{style:{color:"#24292E"}},") {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"\t\tList<"),c("span",{style:{color:"#D73A49"}},"Thread"),c("span",{style:{color:"#24292E"}},"> ts "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#D73A49"}},"new"),c("span",{style:{color:"#24292E"}}," ArrayList<>();")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"\t\t"),c("span",{style:{color:"#D73A49"}},"long"),c("span",{style:{color:"#24292E"}}," start "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," System."),c("span",{style:{color:"#6F42C1"}},"nanoTime"),c("span",{style:{color:"#24292E"}},"();")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"\t\t"),c("span",{style:{color:"#D73A49"}},"for"),c("span",{style:{color:"#24292E"}}," ("),c("span",{style:{color:"#D73A49"}},"int"),c("span",{style:{color:"#24292E"}}," i "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#005CC5"}},"0"),c("span",{style:{color:"#24292E"}},"; i "),c("span",{style:{color:"#D73A49"}},"<"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#005CC5"}},"1000"),c("span",{style:{color:"#24292E"}},"; i"),c("span",{style:{color:"#D73A49"}},"++"),c("span",{style:{color:"#24292E"}},") {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"\t\t\tts."),c("span",{style:{color:"#6F42C1"}},"add"),c("span",{style:{color:"#24292E"}},"("),c("span",{style:{color:"#D73A49"}},"new"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#6F42C1"}},"Thread"),c("span",{style:{color:"#24292E"}},"(() "),c("span",{style:{color:"#D73A49"}},"->"),c("span",{style:{color:"#24292E"}}," {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"\t\t\t\taccount."),c("span",{style:{color:"#6F42C1"}},"withdraw"),c("span",{style:{color:"#24292E"}},"("),c("span",{style:{color:"#005CC5"}},"10"),c("span",{style:{color:"#24292E"}},");")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"\t\t\t}));")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"\t\t}")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"\t\tts."),c("span",{style:{color:"#6F42C1"}},"forEach"),c("span",{style:{color:"#24292E"}},"(Thread"),c("span",{style:{color:"#D73A49"}},"::"),c("span",{style:{color:"#24292E"}},"start);")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"\t\tts."),c("span",{style:{color:"#6F42C1"}},"forEach"),c("span",{style:{color:"#24292E"}},"(t "),c("span",{style:{color:"#D73A49"}},"->"),c("span",{style:{color:"#24292E"}}," {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"\t\t\t"),c("span",{style:{color:"#D73A49"}},"try"),c("span",{style:{color:"#24292E"}}," {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"\t\t\t\tt."),c("span",{style:{color:"#6F42C1"}},"join"),c("span",{style:{color:"#24292E"}},"();")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"\t\t\t} "),c("span",{style:{color:"#D73A49"}},"catch"),c("span",{style:{color:"#24292E"}}," (InterruptedException "),c("span",{style:{color:"#E36209"}},"e"),c("span",{style:{color:"#24292E"}},") {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"\t\t\t\te."),c("span",{style:{color:"#6F42C1"}},"printStackTrace"),c("span",{style:{color:"#24292E"}},"();")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"\t\t\t}")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"\t\t});")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"\t\t"),c("span",{style:{color:"#D73A49"}},"long"),c("span",{style:{color:"#24292E"}}," end "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," System."),c("span",{style:{color:"#6F42C1"}},"nanoTime"),c("span",{style:{color:"#24292E"}},"();")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"\t\tSystem.out."),c("span",{style:{color:"#6F42C1"}},"println"),c("span",{style:{color:"#24292E"}},"(account."),c("span",{style:{color:"#6F42C1"}},"getBalance"),c("span",{style:{color:"#24292E"}},"() "),c("span",{style:{color:"#D73A49"}},"+"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#032F62"}},'" cost: "'),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#D73A49"}},"+"),c("span",{style:{color:"#24292E"}}," (end "),c("span",{style:{color:"#D73A49"}},"-"),c("span",{style:{color:"#24292E"}}," start) "),c("span",{style:{color:"#D73A49"}},"/"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#005CC5"}},"1000_000"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#D73A49"}},"+"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#032F62"}},'" ms"'),c("span",{style:{color:"#24292E"}},");")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"\t}")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"}")]),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"//线程不安全的做法")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#D73A49"}},"class"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#6F42C1"}},"AccountUnsafe"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#D73A49"}},"implements"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#6F42C1"}},"Account"),c("span",{style:{color:"#24292E"}}," {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"\t"),c("span",{style:{color:"#D73A49"}},"private"),c("span",{style:{color:"#24292E"}}," Integer balance;")]),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"\t"),c("span",{style:{color:"#D73A49"}},"public"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#6F42C1"}},"AccountUnsafe"),c("span",{style:{color:"#24292E"}},"(Integer "),c("span",{style:{color:"#E36209"}},"balance"),c("span",{style:{color:"#24292E"}},") {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"\t\t"),c("span",{style:{color:"#005CC5"}},"this"),c("span",{style:{color:"#24292E"}},".balance "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," balance;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"\t}")]),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"\t@"),c("span",{style:{color:"#D73A49"}},"Override")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"\t"),c("span",{style:{color:"#D73A49"}},"public"),c("span",{style:{color:"#24292E"}}," Integer "),c("span",{style:{color:"#6F42C1"}},"getBalance"),c("span",{style:{color:"#24292E"}},"() {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"\t\t"),c("span",{style:{color:"#D73A49"}},"return"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#005CC5"}},"this"),c("span",{style:{color:"#24292E"}},".balance;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"\t}")]),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"\t@"),c("span",{style:{color:"#D73A49"}},"Override")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"\t"),c("span",{style:{color:"#D73A49"}},"public"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#D73A49"}},"synchronized"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#D73A49"}},"void"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#6F42C1"}},"withdraw"),c("span",{style:{color:"#24292E"}},"(Integer "),c("span",{style:{color:"#E36209"}},"amount"),c("span",{style:{color:"#24292E"}},") {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"\t\tbalance "),c("span",{style:{color:"#D73A49"}},"-="),c("span",{style:{color:"#24292E"}}," amount;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"\t}")]),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"\t"),c("span",{style:{color:"#D73A49"}},"public"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#D73A49"}},"static"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#D73A49"}},"void"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#6F42C1"}},"main"),c("span",{style:{color:"#24292E"}},"("),c("span",{style:{color:"#D73A49"}},"String"),c("span",{style:{color:"#24292E"}},"[] "),c("span",{style:{color:"#E36209"}},"args"),c("span",{style:{color:"#24292E"}},") {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"\t\tAccount."),c("span",{style:{color:"#6F42C1"}},"demo"),c("span",{style:{color:"#24292E"}},"("),c("span",{style:{color:"#D73A49"}},"new"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#6F42C1"}},"AccountUnsafe"),c("span",{style:{color:"#24292E"}},"("),c("span",{style:{color:"#005CC5"}},"10000"),c("span",{style:{color:"#24292E"}},"));")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"\t\tAccount."),c("span",{style:{color:"#6F42C1"}},"demo"),c("span",{style:{color:"#24292E"}},"("),c("span",{style:{color:"#D73A49"}},"new"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#6F42C1"}},"AccountCas"),c("span",{style:{color:"#24292E"}},"("),c("span",{style:{color:"#005CC5"}},"10000"),c("span",{style:{color:"#24292E"}},"));")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"\t}")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"}")]),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"//线程安全的做法")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#D73A49"}},"class"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#6F42C1"}},"AccountCas"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#D73A49"}},"implements"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#6F42C1"}},"Account"),c("span",{style:{color:"#24292E"}}," {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"\t"),c("span",{style:{color:"#6A737D"}},"//使用原子整数")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"\t"),c("span",{style:{color:"#D73A49"}},"private"),c("span",{style:{color:"#24292E"}}," AtomicInteger balance;")]),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"\t"),c("span",{style:{color:"#D73A49"}},"public"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#6F42C1"}},"AccountCas"),c("span",{style:{color:"#24292E"}},"("),c("span",{style:{color:"#D73A49"}},"int"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#E36209"}},"balance"),c("span",{style:{color:"#24292E"}},") {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"\t\t"),c("span",{style:{color:"#005CC5"}},"this"),c("span",{style:{color:"#24292E"}},".balance "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#D73A49"}},"new"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#6F42C1"}},"AtomicInteger"),c("span",{style:{color:"#24292E"}},"(balance);")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"\t}")]),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"\t@"),c("span",{style:{color:"#D73A49"}},"Override")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"\t"),c("span",{style:{color:"#D73A49"}},"public"),c("span",{style:{color:"#24292E"}}," Integer "),c("span",{style:{color:"#6F42C1"}},"getBalance"),c("span",{style:{color:"#24292E"}},"() {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"\t\t"),c("span",{style:{color:"#6A737D"}},"//得到原子整数的值")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"\t\t"),c("span",{style:{color:"#D73A49"}},"return"),c("span",{style:{color:"#24292E"}}," balance."),c("span",{style:{color:"#6F42C1"}},"get"),c("span",{style:{color:"#24292E"}},"();")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"\t}")]),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"\t@"),c("span",{style:{color:"#D73A49"}},"Override")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"\t"),c("span",{style:{color:"#D73A49"}},"public"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#D73A49"}},"void"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#6F42C1"}},"withdraw"),c("span",{style:{color:"#24292E"}},"(Integer "),c("span",{style:{color:"#E36209"}},"amount"),c("span",{style:{color:"#24292E"}},") {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"\t\t\t"),c("span",{style:{color:"#6A737D"}},"// 需要不断尝试，直到成功为止")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"            "),c("span",{style:{color:"#D73A49"}},"while"),c("span",{style:{color:"#24292E"}}," ("),c("span",{style:{color:"#005CC5"}},"true"),c("span",{style:{color:"#24292E"}},") {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"            "),c("span",{style:{color:"#6A737D"}},"// 比如拿到了旧值 1000")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"            "),c("span",{style:{color:"#D73A49"}},"int"),c("span",{style:{color:"#24292E"}}," prev "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," balance."),c("span",{style:{color:"#6F42C1"}},"get"),c("span",{style:{color:"#24292E"}},"();")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"            "),c("span",{style:{color:"#6A737D"}},"// 在这个基础上 1000-10 = 990")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"            "),c("span",{style:{color:"#D73A49"}},"int"),c("span",{style:{color:"#24292E"}}," next "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," prev "),c("span",{style:{color:"#D73A49"}},"-"),c("span",{style:{color:"#24292E"}}," amount;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"            "),c("span",{style:{color:"#6A737D"}},"/*")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"            compareAndSet 正是做这个检查，在 set 前，先比较 prev 与当前值")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"            - 不一致了，next 作废，返回 false 表示失败")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"            比如，别的线程已经做了减法，当前值已经被减成了 990")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"            那么本线程的这次 990 就作废了，进入 while 下次循环重试")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"            - 一致，以 next 设置为新值，返回 true 表示成功")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"            */")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"\t\t\t"),c("span",{style:{color:"#D73A49"}},"if"),c("span",{style:{color:"#24292E"}},"(balance."),c("span",{style:{color:"#6F42C1"}},"compareAndSet"),c("span",{style:{color:"#24292E"}},"(prev, next)) {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"\t\t\t\t"),c("span",{style:{color:"#D73A49"}},"break"),c("span",{style:{color:"#24292E"}},";")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"\t\t\t}")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"\t\t}")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"\t}")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"}")])])]),c("button",{class:"collapse"})],-1),b=c("p",null,[p("前面看到的 AtomicInteger 通过无锁解决线程安全问题，内部并没有用锁来保护共享变量的线程安全。那么它是如何实现的呢？其中的"),c("strong",null,"关键是 compareAndSet"),p("（比较并设置值），它的"),c("strong",null,"简称就是 CAS"),p(" （也有 Compare And Swap 的说法），它必须是"),c("strong",null,"原子操作"),p("。")],-1),m=c("figure",null,[c("img",{alt:"img",class:"lazy","data-src":"https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/20200608145914.png"})],-1),v=c("p",null,[c("strong",null,"工作流程")],-1),f=c("ul",null,[c("li",null,[p("当一个线程要去修改Account对象中的值时，先获取值pre（调用get方法），然后再将其设置为新的值next（调用cas方法）。在调用cas方法时，会将pre与Account中的余额进行比较。 "),c("ul",null,[c("li",null,[p("如果"),c("strong",null,"两者相等"),p("，就说明该值还未被其他线程修改，此时便可以进行修改操作。")]),c("li",null,[p("如果"),c("strong",null,"两者不相等"),p("，就不设置值，重新获取值pre（调用get方法），然后再将其设置为新的值next（调用cas方法），直到修改成功为止。")])])])],-1),B=c("hr",null,null,-1),k={id:"原理",tabindex:"-1"},S=c("p",null,"无锁编程：Lock Free",-1),T=c("p",null,[p("CAS 的全称是 Compare-And-Swap，是 "),c("strong",null,"CPU 并发原语")],-1),x=c("ul",null,[c("li",null,"CAS 并发原语体现在 Java 语言中就是 sun.misc.Unsafe 类的各个方法，调用 UnSafe 类中的 CAS 方法，JVM 会实现出 CAS 汇编指令，这是一种完全依赖于硬件的功能，实现了原子操作"),c("li",null,"CAS 是一种系统原语，原语属于操作系统范畴，是由若干条指令组成 ，用于完成某个功能的一个过程，并且原语的执行必须是连续的，执行过程中不允许被中断，所以 CAS 是一条 CPU 的原子指令，不会造成数据不一致的问题，是线程安全的")],-1),L=c("p",null,[p("底层原理：CAS 的底层是 "),c("code",null,"lock cmpxchg"),p(" 指令（X86 架构），在单核和多核 CPU 下都能够保证比较交换的原子性")],-1),w=c("ul",null,[c("li",null,[c("p",null,"程序是在单核处理器上运行，会省略 lock 前缀，单处理器自身会维护处理器内的顺序一致性，不需要 lock 前缀的内存屏障效果")]),c("li",null,[c("p",null,[p("程序是在多核处理器上运行，会为 cmpxchg 指令加上 lock 前缀。当某个核执行到带 lock 的指令时，CPU 会执行"),c("strong",null,"总线锁定或缓存锁定"),p("，将修改的变量写入到主存，这个过程不会被线程的调度机制所打断，保证了多个线程对内存操作的原子性")])])],-1),I=c("p",null,"作用：比较当前工作内存中的值和主物理内存中的值，如果相同则执行规定操作，否则继续比较直到主内存和工作内存的值一致为止",-1),j=c("hr",null,null,-1),M={id:"前提",tabindex:"-1"},U=c("p",null,[c("strong",null,"CAS 必须借助 volatile"),p(" 才能读取到共享变量的新值来实现【比较并交换】的效果")],-1),P=c("hr",null,null,-1),_={id:"效率高",tabindex:"-1"},R=c("strong",null,"效率高",-1),V=c("ul",null,[c("li",null,"无锁情况下，即使重试失败，线程始终在高速运行，没有停歇，而 synchronized 会让线程在没有获得锁的时候，发生上下文切换，进入阻塞。"),c("li",null,"打个比喻，线程就好像高速跑道上的赛车，高速运行时，速度超快，一旦发生上下文切换，就好比赛车要减速、熄火，等被唤醒又得重新打火、启动、加速... 恢复到高速运行，代价比较大"),c("li",null,[p("但无锁情况下，因为线程要保持运行，需要额外 CPU 的支持，CPU 在这里就好比高速跑道，没有额外的跑道，线程想高速运行也无从谈起，虽然不会进入阻塞，但由于没有分到时间片，仍然会进入不可运行状态，还是会导致上下文切换。（超过了CPU核心数也就没有了额外的跑道了，运行也运行不了，只能上下文切换，所以"),c("strong",null,"在线程数小于CPU核心数时用CAS是非常合适的"),p("）")])],-1),O=c("hr",null,null,-1),z={id:"优缺点",tabindex:"-1"},N=c("p",null,"CAS 特点:",-1),H=c("ul",null,[c("li",null,[p("CAS 体现的是"),c("strong",null,"无锁并发、无阻塞并发"),p("，线程不会陷入阻塞，线程不需要频繁切换状态（上下文切换，系统调用）")]),c("li",null,"CAS 是基于乐观锁的思想")],-1),G=c("p",null,"CAS 缺点：",-1),K=c("ul",null,[c("li",null,[p("执行的是循环操作，如果比较不成功一直在循环，最差的情况某个线程一直取到的值和预期值都不一样，就会无限循环导致饥饿，"),c("strong",null,"使用 CAS 线程数不要超过 CPU 的核心数"),p("，采用分段 CAS 和自动迁移机制")]),c("li",null,[p("只能保证一个共享变量的原子操作 "),c("ul",null,[c("li",null,"对于一个共享变量执行操作时，可以通过循环 CAS 的方式来保证原子操作"),c("li",null,[p("对于多个共享变量操作时，循环 CAS 就无法保证操作的原子性，这个时候"),c("strong",null,"只能用锁来保证原子性")])])]),c("li",null,"引出来 ABA 问题")],-1),J=c("hr",null,null,-1),$={id:"乐观锁",tabindex:"-1"},Y=c("p",null,"CAS 与 synchronized 总结：",-1),q=c("ul",null,[c("li",null,"synchronized 是从悲观的角度出发：总是假设最坏的情况，每次去拿数据的时候都认为别人会修改，所以每次在拿数据的时候都会上锁，这样别人想拿这个数据就会阻塞（共享资源每次只给一个线程使用，其它线程阻塞，用完后再把资源转让给其它线程），因此 synchronized 也称之为悲观锁，ReentrantLock 也是一种悲观锁，性能较差"),c("li",null,[p("CAS 是从乐观的角度出发：总是假设最好的情况，每次去拿数据的时候都认为别人不会修改，所以不会上锁，但是在更新的时候会判断一下在此期间别人有没有去更新这个数据。"),c("strong",null,"如果别人修改过，则获取现在最新的值，如果别人没修改过，直接修改共享数据的值"),p("，CAS 这种机制也称之为乐观锁，综合性能较好")])],-1),W=c("hr",null,null,-1),Q={id:"atomic",tabindex:"-1"},Z={id:"常用api",tabindex:"-1"},X=c("p",null,"常见原子类：AtomicInteger、AtomicBoolean、AtomicLong",-1),ll=c("p",null,"构造方法：",-1),sl=c("ul",null,[c("li",null,[c("code",null,"public AtomicInteger()"),p("：初始化一个默认值为 0 的原子型 Integer")]),c("li",null,[c("code",null,"public AtomicInteger(int initialValue)"),p("：初始化一个指定值的原子型 Integer")])],-1),ol=c("p",null,"常用API：",-1),nl=c("table",null,[c("thead",null,[c("tr",null,[c("th",null,"方法"),c("th",null,"作用")])]),c("tbody",null,[c("tr",null,[c("td",null,"public final int get()"),c("td",null,"获取 AtomicInteger 的值")]),c("tr",null,[c("td",null,"public final int getAndIncrement()"),c("td",null,"以原子方式将当前值加 1，返回的是自增前的值")]),c("tr",null,[c("td",null,"public final int incrementAndGet()"),c("td",null,"以原子方式将当前值加 1，返回的是自增后的值")]),c("tr",null,[c("td",null,"public final int getAndSet(int value)"),c("td",null,"以原子方式设置为 newValue 的值，返回旧值")]),c("tr",null,[c("td",null,"public final int addAndGet(int data)"),c("td",null,[p("以原子方式将输入的数值与实例中的值相加并返回"),c("br"),p("实例：AtomicInteger 里的 value")])])])],-1),al=c("hr",null,null,-1),el={id:"原理分析",tabindex:"-1"},tl=c("p",null,[c("strong",null,"AtomicInteger 原理"),p("：自旋锁 + CAS 算法")],-1),cl=c("p",null,"CAS 算法：有 3 个操作数（内存值 V， 旧的预期值 A，要修改的值 B）",-1),pl=c("ul",null,[c("li",null,"当旧的预期值 A == 内存值 V 此时可以修改，将 V 改为 B"),c("li",null,"当旧的预期值 A != 内存值 V 此时不能修改，并重新获取现在的最新值，重新获取的动作就是自旋")],-1),rl=c("p",null,"分析 getAndSet 方法：",-1),El=c("ul",null,[c("li",null,[c("p",null,"AtomicInteger："),c("div",{style:{"max-height":"300px"},class:"language-java"},[c("button",{title:"Copy Code",class:"copy"}),c("span",{class:"lang"},"java"),c("pre",{class:"shiki github-dark vp-code-dark"},[c("code",null,[c("span",{class:"line"},[c("span",{style:{color:"#F97583"}},"public"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#F97583"}},"final"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#F97583"}},"int"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#B392F0"}},"getAndSet"),c("span",{style:{color:"#E1E4E8"}},"("),c("span",{style:{color:"#F97583"}},"int"),c("span",{style:{color:"#E1E4E8"}}," newValue) {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#6A737D"}},"/**")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"    * this: \t\t当前对象")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"    * valueOffset:\t内存偏移量，内存地址")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"    */")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#F97583"}},"return"),c("span",{style:{color:"#E1E4E8"}}," unsafe."),c("span",{style:{color:"#B392F0"}},"getAndSetInt"),c("span",{style:{color:"#E1E4E8"}},"("),c("span",{style:{color:"#79B8FF"}},"this"),c("span",{style:{color:"#E1E4E8"}},", valueOffset, newValue);")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"}")])])]),c("pre",{class:"shiki github-light vp-code-light"},[c("code",null,[c("span",{class:"line"},[c("span",{style:{color:"#D73A49"}},"public"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#D73A49"}},"final"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#D73A49"}},"int"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#6F42C1"}},"getAndSet"),c("span",{style:{color:"#24292E"}},"("),c("span",{style:{color:"#D73A49"}},"int"),c("span",{style:{color:"#24292E"}}," newValue) {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#6A737D"}},"/**")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"    * this: \t\t当前对象")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"    * valueOffset:\t内存偏移量，内存地址")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"    */")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#D73A49"}},"return"),c("span",{style:{color:"#24292E"}}," unsafe."),c("span",{style:{color:"#6F42C1"}},"getAndSetInt"),c("span",{style:{color:"#24292E"}},"("),c("span",{style:{color:"#005CC5"}},"this"),c("span",{style:{color:"#24292E"}},", valueOffset, newValue);")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"}")])])]),c("button",{class:"collapse"})]),c("p",null,"valueOffset：偏移量表示该变量值相对于当前对象地址的偏移，Unsafe 就是根据内存偏移地址获取数据"),c("div",{style:{"max-height":"300px"},class:"language-java"},[c("button",{title:"Copy Code",class:"copy"}),c("span",{class:"lang"},"java"),c("pre",{class:"shiki github-dark vp-code-dark"},[c("code",null,[c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"valueOffset "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," unsafe.objectFieldOffset")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"                (AtomicInteger.class."),c("span",{style:{color:"#B392F0"}},"getDeclaredField"),c("span",{style:{color:"#E1E4E8"}},"("),c("span",{style:{color:"#9ECBFF"}},'"value"'),c("span",{style:{color:"#E1E4E8"}},"));")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"//调用本地方法   --\x3e")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#F97583"}},"public"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#F97583"}},"native"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#F97583"}},"long"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#B392F0"}},"objectFieldOffset"),c("span",{style:{color:"#E1E4E8"}},"(Field var1);")])])]),c("pre",{class:"shiki github-light vp-code-light"},[c("code",null,[c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"valueOffset "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," unsafe.objectFieldOffset")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"                (AtomicInteger.class."),c("span",{style:{color:"#6F42C1"}},"getDeclaredField"),c("span",{style:{color:"#24292E"}},"("),c("span",{style:{color:"#032F62"}},'"value"'),c("span",{style:{color:"#24292E"}},"));")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"//调用本地方法   --\x3e")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#D73A49"}},"public"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#D73A49"}},"native"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#D73A49"}},"long"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#6F42C1"}},"objectFieldOffset"),c("span",{style:{color:"#24292E"}},"(Field var1);")])])]),c("button",{class:"collapse"})])]),c("li",null,[c("p",null,"unsafe 类："),c("div",{style:{"max-height":"300px"},class:"language-java"},[c("button",{title:"Copy Code",class:"copy"}),c("span",{class:"lang"},"java"),c("pre",{class:"shiki github-dark vp-code-dark"},[c("code",null,[c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"// val1: AtomicInteger对象本身，var2: 该对象值得引用地址，var4: 需要变动的数")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#F97583"}},"public"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#F97583"}},"final"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#F97583"}},"int"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#B392F0"}},"getAndSetInt"),c("span",{style:{color:"#E1E4E8"}},"(Object var1, "),c("span",{style:{color:"#F97583"}},"long"),c("span",{style:{color:"#E1E4E8"}}," var2, "),c("span",{style:{color:"#F97583"}},"int"),c("span",{style:{color:"#E1E4E8"}}," var4) {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#F97583"}},"int"),c("span",{style:{color:"#E1E4E8"}}," var5;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#F97583"}},"do"),c("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        "),c("span",{style:{color:"#6A737D"}},"// var5: 用 var1 和 var2 找到的内存中的真实值")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        var5 "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#79B8FF"}},"this"),c("span",{style:{color:"#E1E4E8"}},"."),c("span",{style:{color:"#B392F0"}},"getIntVolatile"),c("span",{style:{color:"#E1E4E8"}},"(var1, var2);")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    } "),c("span",{style:{color:"#F97583"}},"while"),c("span",{style:{color:"#E1E4E8"}},"("),c("span",{style:{color:"#F97583"}},"!"),c("span",{style:{color:"#79B8FF"}},"this"),c("span",{style:{color:"#E1E4E8"}},"."),c("span",{style:{color:"#B392F0"}},"compareAndSwapInt"),c("span",{style:{color:"#E1E4E8"}},"(var1, var2, var5, var4));")]),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#F97583"}},"return"),c("span",{style:{color:"#E1E4E8"}}," var5;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"}")])])]),c("pre",{class:"shiki github-light vp-code-light"},[c("code",null,[c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"// val1: AtomicInteger对象本身，var2: 该对象值得引用地址，var4: 需要变动的数")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#D73A49"}},"public"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#D73A49"}},"final"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#D73A49"}},"int"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#6F42C1"}},"getAndSetInt"),c("span",{style:{color:"#24292E"}},"(Object var1, "),c("span",{style:{color:"#D73A49"}},"long"),c("span",{style:{color:"#24292E"}}," var2, "),c("span",{style:{color:"#D73A49"}},"int"),c("span",{style:{color:"#24292E"}}," var4) {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#D73A49"}},"int"),c("span",{style:{color:"#24292E"}}," var5;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#D73A49"}},"do"),c("span",{style:{color:"#24292E"}}," {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        "),c("span",{style:{color:"#6A737D"}},"// var5: 用 var1 和 var2 找到的内存中的真实值")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        var5 "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#005CC5"}},"this"),c("span",{style:{color:"#24292E"}},"."),c("span",{style:{color:"#6F42C1"}},"getIntVolatile"),c("span",{style:{color:"#24292E"}},"(var1, var2);")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    } "),c("span",{style:{color:"#D73A49"}},"while"),c("span",{style:{color:"#24292E"}},"("),c("span",{style:{color:"#D73A49"}},"!"),c("span",{style:{color:"#005CC5"}},"this"),c("span",{style:{color:"#24292E"}},"."),c("span",{style:{color:"#6F42C1"}},"compareAndSwapInt"),c("span",{style:{color:"#24292E"}},"(var1, var2, var5, var4));")]),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#D73A49"}},"return"),c("span",{style:{color:"#24292E"}}," var5;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"}")])])]),c("button",{class:"collapse"})]),c("p",null,[p("var5：从主内存中拷贝到工作内存中的值（每次都要从主内存拿到最新的值到本地内存），然后执行 "),c("code",null,"compareAndSwapInt()"),p(" 再和主内存的值进行比较，假设方法返回 false，那么就一直执行 while 方法，直到期望的值和真实值一样，修改数据")])]),c("li",null,[c("p",null,"变量 value 用 volatile 修饰，保证了多线程之间的内存可见性，避免线程从工作缓存中获取失效的变量"),c("div",{style:{"max-height":"300px"},class:"language-java"},[c("button",{title:"Copy Code",class:"copy"}),c("span",{class:"lang"},"java"),c("pre",{class:"shiki github-dark vp-code-dark"},[c("code",null,[c("span",{class:"line"},[c("span",{style:{color:"#F97583"}},"private"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#F97583"}},"volatile"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#F97583"}},"int"),c("span",{style:{color:"#E1E4E8"}}," value")])])]),c("pre",{class:"shiki github-light vp-code-light"},[c("code",null,[c("span",{class:"line"},[c("span",{style:{color:"#D73A49"}},"private"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#D73A49"}},"volatile"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#D73A49"}},"int"),c("span",{style:{color:"#24292E"}}," value")])])]),c("button",{class:"collapse"})]),c("p",null,[c("strong",null,"CAS 必须借助 volatile 才能读取到共享变量的最新值来实现比较并交换的效果")])])],-1),yl=c("p",null,"分析 getAndUpdate 方法：",-1),il=c("ul",null,[c("li",null,[c("p",null,"getAndUpdate："),c("div",{style:{"max-height":"300px"},class:"language-java"},[c("button",{title:"Copy Code",class:"copy"}),c("span",{class:"lang"},"java"),c("pre",{class:"shiki github-dark vp-code-dark"},[c("code",null,[c("span",{class:"line"},[c("span",{style:{color:"#F97583"}},"public"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#F97583"}},"final"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#F97583"}},"int"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#B392F0"}},"getAndUpdate"),c("span",{style:{color:"#E1E4E8"}},"(IntUnaryOperator updateFunction) {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#F97583"}},"int"),c("span",{style:{color:"#E1E4E8"}}," prev, next;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#F97583"}},"do"),c("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        prev "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#B392F0"}},"get"),c("span",{style:{color:"#E1E4E8"}},"();\t"),c("span",{style:{color:"#6A737D"}},"//当前值，cas的期望值")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        next "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," updateFunction."),c("span",{style:{color:"#B392F0"}},"applyAsInt"),c("span",{style:{color:"#E1E4E8"}},"(prev);"),c("span",{style:{color:"#6A737D"}},"//期望值更新到该值")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    } "),c("span",{style:{color:"#F97583"}},"while"),c("span",{style:{color:"#E1E4E8"}}," ("),c("span",{style:{color:"#F97583"}},"!"),c("span",{style:{color:"#B392F0"}},"compareAndSet"),c("span",{style:{color:"#E1E4E8"}},"(prev, next));"),c("span",{style:{color:"#6A737D"}},"//自旋")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#F97583"}},"return"),c("span",{style:{color:"#E1E4E8"}}," prev;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"}")])])]),c("pre",{class:"shiki github-light vp-code-light"},[c("code",null,[c("span",{class:"line"},[c("span",{style:{color:"#D73A49"}},"public"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#D73A49"}},"final"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#D73A49"}},"int"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#6F42C1"}},"getAndUpdate"),c("span",{style:{color:"#24292E"}},"(IntUnaryOperator updateFunction) {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#D73A49"}},"int"),c("span",{style:{color:"#24292E"}}," prev, next;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#D73A49"}},"do"),c("span",{style:{color:"#24292E"}}," {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        prev "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#6F42C1"}},"get"),c("span",{style:{color:"#24292E"}},"();\t"),c("span",{style:{color:"#6A737D"}},"//当前值，cas的期望值")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        next "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," updateFunction."),c("span",{style:{color:"#6F42C1"}},"applyAsInt"),c("span",{style:{color:"#24292E"}},"(prev);"),c("span",{style:{color:"#6A737D"}},"//期望值更新到该值")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    } "),c("span",{style:{color:"#D73A49"}},"while"),c("span",{style:{color:"#24292E"}}," ("),c("span",{style:{color:"#D73A49"}},"!"),c("span",{style:{color:"#6F42C1"}},"compareAndSet"),c("span",{style:{color:"#24292E"}},"(prev, next));"),c("span",{style:{color:"#6A737D"}},"//自旋")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#D73A49"}},"return"),c("span",{style:{color:"#24292E"}}," prev;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"}")])])]),c("button",{class:"collapse"})]),c("p",null,"模仿："),c("div",{style:{"max-height":"300px"},class:"language-java"},[c("button",{title:"Copy Code",class:"copy"}),c("span",{class:"lang"},"java"),c("pre",{class:"shiki github-dark vp-code-dark"},[c("code",null,[c("span",{class:"line"},[c("span",{style:{color:"#F97583"}},"public"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#F97583"}},"static"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#F97583"}},"void"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#B392F0"}},"main"),c("span",{style:{color:"#E1E4E8"}},"("),c("span",{style:{color:"#F97583"}},"String"),c("span",{style:{color:"#E1E4E8"}},"[] args) {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    AtomicInteger i "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#F97583"}},"new"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#B392F0"}},"AtomicInteger"),c("span",{style:{color:"#E1E4E8"}},"("),c("span",{style:{color:"#79B8FF"}},"5"),c("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    System.out."),c("span",{style:{color:"#B392F0"}},"println"),c("span",{style:{color:"#E1E4E8"}},"("),c("span",{style:{color:"#B392F0"}},"updateAndGet"),c("span",{style:{color:"#E1E4E8"}},"(i, p "),c("span",{style:{color:"#F97583"}},"->"),c("span",{style:{color:"#E1E4E8"}}," p "),c("span",{style:{color:"#F97583"}},"/"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#79B8FF"}},"2"),c("span",{style:{color:"#E1E4E8"}},"));")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"}")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#F97583"}},"public"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#F97583"}},"static"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#F97583"}},"int"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#B392F0"}},"updateAndGet"),c("span",{style:{color:"#E1E4E8"}},"(AtomicInteger i, IntUnaryOperator operator) {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        "),c("span",{style:{color:"#F97583"}},"while"),c("span",{style:{color:"#E1E4E8"}}," ("),c("span",{style:{color:"#79B8FF"}},"true"),c("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"            "),c("span",{style:{color:"#F97583"}},"int"),c("span",{style:{color:"#E1E4E8"}}," prev "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," i."),c("span",{style:{color:"#B392F0"}},"get"),c("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"            "),c("span",{style:{color:"#F97583"}},"int"),c("span",{style:{color:"#E1E4E8"}}," next "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," operator."),c("span",{style:{color:"#B392F0"}},"applyAsInt"),c("span",{style:{color:"#E1E4E8"}},"(prev);")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"            "),c("span",{style:{color:"#F97583"}},"if"),c("span",{style:{color:"#E1E4E8"}}," (i."),c("span",{style:{color:"#B392F0"}},"compareAndSet"),c("span",{style:{color:"#E1E4E8"}},"(prev, next)) {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"                "),c("span",{style:{color:"#F97583"}},"return"),c("span",{style:{color:"#E1E4E8"}}," next;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"            }")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        }")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    }")])])]),c("pre",{class:"shiki github-light vp-code-light"},[c("code",null,[c("span",{class:"line"},[c("span",{style:{color:"#D73A49"}},"public"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#D73A49"}},"static"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#D73A49"}},"void"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#6F42C1"}},"main"),c("span",{style:{color:"#24292E"}},"("),c("span",{style:{color:"#D73A49"}},"String"),c("span",{style:{color:"#24292E"}},"[] args) {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    AtomicInteger i "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#D73A49"}},"new"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#6F42C1"}},"AtomicInteger"),c("span",{style:{color:"#24292E"}},"("),c("span",{style:{color:"#005CC5"}},"5"),c("span",{style:{color:"#24292E"}},");")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    System.out."),c("span",{style:{color:"#6F42C1"}},"println"),c("span",{style:{color:"#24292E"}},"("),c("span",{style:{color:"#6F42C1"}},"updateAndGet"),c("span",{style:{color:"#24292E"}},"(i, p "),c("span",{style:{color:"#D73A49"}},"->"),c("span",{style:{color:"#24292E"}}," p "),c("span",{style:{color:"#D73A49"}},"/"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#005CC5"}},"2"),c("span",{style:{color:"#24292E"}},"));")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"}")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#D73A49"}},"public"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#D73A49"}},"static"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#D73A49"}},"int"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#6F42C1"}},"updateAndGet"),c("span",{style:{color:"#24292E"}},"(AtomicInteger i, IntUnaryOperator operator) {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        "),c("span",{style:{color:"#D73A49"}},"while"),c("span",{style:{color:"#24292E"}}," ("),c("span",{style:{color:"#005CC5"}},"true"),c("span",{style:{color:"#24292E"}},") {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"            "),c("span",{style:{color:"#D73A49"}},"int"),c("span",{style:{color:"#24292E"}}," prev "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," i."),c("span",{style:{color:"#6F42C1"}},"get"),c("span",{style:{color:"#24292E"}},"();")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"            "),c("span",{style:{color:"#D73A49"}},"int"),c("span",{style:{color:"#24292E"}}," next "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," operator."),c("span",{style:{color:"#6F42C1"}},"applyAsInt"),c("span",{style:{color:"#24292E"}},"(prev);")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"            "),c("span",{style:{color:"#D73A49"}},"if"),c("span",{style:{color:"#24292E"}}," (i."),c("span",{style:{color:"#6F42C1"}},"compareAndSet"),c("span",{style:{color:"#24292E"}},"(prev, next)) {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"                "),c("span",{style:{color:"#D73A49"}},"return"),c("span",{style:{color:"#24292E"}}," next;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"            }")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        }")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    }")])])]),c("button",{class:"collapse"})]),c("p",null,"函数式接口：可以自定义操作逻辑"),c("div",{style:{"max-height":"300px"},class:"language-java"},[c("button",{title:"Copy Code",class:"copy"}),c("span",{class:"lang"},"java"),c("pre",{class:"shiki github-dark vp-code-dark"},[c("code",null,[c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"AtomicInteger a "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#F97583"}},"new"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#B392F0"}},"AtomicInteger"),c("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"a."),c("span",{style:{color:"#B392F0"}},"getAndUpdate"),c("span",{style:{color:"#E1E4E8"}},"(i "),c("span",{style:{color:"#F97583"}},"->"),c("span",{style:{color:"#E1E4E8"}}," i "),c("span",{style:{color:"#F97583"}},"+"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#79B8FF"}},"10"),c("span",{style:{color:"#E1E4E8"}},");")])])]),c("pre",{class:"shiki github-light vp-code-light"},[c("code",null,[c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"AtomicInteger a "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#D73A49"}},"new"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#6F42C1"}},"AtomicInteger"),c("span",{style:{color:"#24292E"}},"();")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"a."),c("span",{style:{color:"#6F42C1"}},"getAndUpdate"),c("span",{style:{color:"#24292E"}},"(i "),c("span",{style:{color:"#D73A49"}},"->"),c("span",{style:{color:"#24292E"}}," i "),c("span",{style:{color:"#D73A49"}},"+"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#005CC5"}},"10"),c("span",{style:{color:"#24292E"}},");")])])]),c("button",{class:"collapse"})])]),c("li",null,[c("p",null,"compareAndSet："),c("div",{style:{"max-height":"300px"},class:"language-java"},[c("button",{title:"Copy Code",class:"copy"}),c("span",{class:"lang"},"java"),c("pre",{class:"shiki github-dark vp-code-dark"},[c("code",null,[c("span",{class:"line"},[c("span",{style:{color:"#F97583"}},"public"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#F97583"}},"final"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#F97583"}},"boolean"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#B392F0"}},"compareAndSet"),c("span",{style:{color:"#E1E4E8"}},"("),c("span",{style:{color:"#F97583"}},"int"),c("span",{style:{color:"#E1E4E8"}}," expect, "),c("span",{style:{color:"#F97583"}},"int"),c("span",{style:{color:"#E1E4E8"}}," update) {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#6A737D"}},"/**")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"    * this: \t\t当前对象")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"    * valueOffset:\t内存偏移量，内存地址")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"    * expect:\t\t期望的值")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"    * update: \t\t更新的值")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"    */")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#F97583"}},"return"),c("span",{style:{color:"#E1E4E8"}}," unsafe."),c("span",{style:{color:"#B392F0"}},"compareAndSwapInt"),c("span",{style:{color:"#E1E4E8"}},"("),c("span",{style:{color:"#79B8FF"}},"this"),c("span",{style:{color:"#E1E4E8"}},", valueOffset, expect, update);")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"}")])])]),c("pre",{class:"shiki github-light vp-code-light"},[c("code",null,[c("span",{class:"line"},[c("span",{style:{color:"#D73A49"}},"public"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#D73A49"}},"final"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#D73A49"}},"boolean"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#6F42C1"}},"compareAndSet"),c("span",{style:{color:"#24292E"}},"("),c("span",{style:{color:"#D73A49"}},"int"),c("span",{style:{color:"#24292E"}}," expect, "),c("span",{style:{color:"#D73A49"}},"int"),c("span",{style:{color:"#24292E"}}," update) {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#6A737D"}},"/**")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"    * this: \t\t当前对象")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"    * valueOffset:\t内存偏移量，内存地址")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"    * expect:\t\t期望的值")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"    * update: \t\t更新的值")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"    */")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#D73A49"}},"return"),c("span",{style:{color:"#24292E"}}," unsafe."),c("span",{style:{color:"#6F42C1"}},"compareAndSwapInt"),c("span",{style:{color:"#24292E"}},"("),c("span",{style:{color:"#005CC5"}},"this"),c("span",{style:{color:"#24292E"}},", valueOffset, expect, update);")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"}")])])]),c("button",{class:"collapse"})])])],-1),Fl=c("hr",null,null,-1),ul={id:"原子引用",tabindex:"-1"},Al=c("p",null,"原子引用：对 Object 进行原子操作，提供一种读和写都是原子性的对象引用变量",-1),dl=c("p",null,"原子引用类：AtomicReference、AtomicStampedReference、AtomicMarkableReference",-1),Dl=c("p",null,"AtomicReference 类：",-1),hl=c("ul",null,[c("li",null,[c("p",null,"构造方法："),c("ul",null,[c("li",null,[c("p",null,[c("code",null,"public AtomicReference(V initialValue)"),p("：初始化一个指定值的原子引用")])]),c("li",null,[c("p",null,[c("code",null,"public AtomicReference()"),p("：初始化一个默认值为 null 的原子引用")])])])]),c("li",null,[c("p",null,"常用 API："),c("ul",null,[c("li",null,[c("code",null,"public final boolean compareAndSet(V expectedValue, V newValue)"),p("：CAS 操作")]),c("li",null,[c("code",null,"public final void set(V newValue)"),p("：将值设置为 newValue")]),c("li",null,[c("code",null,"public final V get()"),p("：返回当前值")])])])],-1),gl=c("div",{style:{"max-height":"300px"},class:"language-java"},[c("button",{title:"Copy Code",class:"copy"}),c("span",{class:"lang"},"java"),c("pre",{class:"shiki github-dark vp-code-dark"},[c("code",null,[c("span",{class:"line"},[c("span",{style:{color:"#F97583"}},"public"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#F97583"}},"class"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#B392F0"}},"AtomicReferenceDemo"),c("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#F97583"}},"public"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#F97583"}},"static"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#F97583"}},"void"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#B392F0"}},"main"),c("span",{style:{color:"#E1E4E8"}},"("),c("span",{style:{color:"#F97583"}},"String"),c("span",{style:{color:"#E1E4E8"}},"[] "),c("span",{style:{color:"#FFAB70"}},"args"),c("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        Student s1 "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#F97583"}},"new"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#B392F0"}},"Student"),c("span",{style:{color:"#E1E4E8"}},"("),c("span",{style:{color:"#79B8FF"}},"33"),c("span",{style:{color:"#E1E4E8"}},", "),c("span",{style:{color:"#9ECBFF"}},'"z3"'),c("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        ")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        "),c("span",{style:{color:"#6A737D"}},"// 创建原子引用包装类")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        AtomicReference<"),c("span",{style:{color:"#F97583"}},"Student"),c("span",{style:{color:"#E1E4E8"}},"> atomicReference "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#F97583"}},"new"),c("span",{style:{color:"#E1E4E8"}}," AtomicReference<>();")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        "),c("span",{style:{color:"#6A737D"}},"// 设置主内存共享变量为s1")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        atomicReference."),c("span",{style:{color:"#B392F0"}},"set"),c("span",{style:{color:"#E1E4E8"}},"(s1);")]),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        "),c("span",{style:{color:"#6A737D"}},"// 比较并交换，如果现在主物理内存的值为 z3，那么交换成 l4")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        "),c("span",{style:{color:"#F97583"}},"while"),c("span",{style:{color:"#E1E4E8"}}," ("),c("span",{style:{color:"#79B8FF"}},"true"),c("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"            Student s2 "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#F97583"}},"new"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#B392F0"}},"Student"),c("span",{style:{color:"#E1E4E8"}},"("),c("span",{style:{color:"#79B8FF"}},"44"),c("span",{style:{color:"#E1E4E8"}},", "),c("span",{style:{color:"#9ECBFF"}},'"l4"'),c("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"            "),c("span",{style:{color:"#F97583"}},"if"),c("span",{style:{color:"#E1E4E8"}}," (atomicReference."),c("span",{style:{color:"#B392F0"}},"compareAndSet"),c("span",{style:{color:"#E1E4E8"}},"(s1, s2)) {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"                "),c("span",{style:{color:"#F97583"}},"break"),c("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"            }")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        }")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        System.out."),c("span",{style:{color:"#B392F0"}},"println"),c("span",{style:{color:"#E1E4E8"}},"(atomicReference."),c("span",{style:{color:"#B392F0"}},"get"),c("span",{style:{color:"#E1E4E8"}},"());")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"}")]),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#F97583"}},"class"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#B392F0"}},"Student"),c("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#F97583"}},"private"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#F97583"}},"int"),c("span",{style:{color:"#E1E4E8"}}," id;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#F97583"}},"private"),c("span",{style:{color:"#E1E4E8"}}," String name;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#6A737D"}},"//。。。。")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"}")])])]),c("pre",{class:"shiki github-light vp-code-light"},[c("code",null,[c("span",{class:"line"},[c("span",{style:{color:"#D73A49"}},"public"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#D73A49"}},"class"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#6F42C1"}},"AtomicReferenceDemo"),c("span",{style:{color:"#24292E"}}," {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#D73A49"}},"public"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#D73A49"}},"static"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#D73A49"}},"void"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#6F42C1"}},"main"),c("span",{style:{color:"#24292E"}},"("),c("span",{style:{color:"#D73A49"}},"String"),c("span",{style:{color:"#24292E"}},"[] "),c("span",{style:{color:"#E36209"}},"args"),c("span",{style:{color:"#24292E"}},") {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        Student s1 "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#D73A49"}},"new"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#6F42C1"}},"Student"),c("span",{style:{color:"#24292E"}},"("),c("span",{style:{color:"#005CC5"}},"33"),c("span",{style:{color:"#24292E"}},", "),c("span",{style:{color:"#032F62"}},'"z3"'),c("span",{style:{color:"#24292E"}},");")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        ")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        "),c("span",{style:{color:"#6A737D"}},"// 创建原子引用包装类")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        AtomicReference<"),c("span",{style:{color:"#D73A49"}},"Student"),c("span",{style:{color:"#24292E"}},"> atomicReference "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#D73A49"}},"new"),c("span",{style:{color:"#24292E"}}," AtomicReference<>();")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        "),c("span",{style:{color:"#6A737D"}},"// 设置主内存共享变量为s1")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        atomicReference."),c("span",{style:{color:"#6F42C1"}},"set"),c("span",{style:{color:"#24292E"}},"(s1);")]),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        "),c("span",{style:{color:"#6A737D"}},"// 比较并交换，如果现在主物理内存的值为 z3，那么交换成 l4")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        "),c("span",{style:{color:"#D73A49"}},"while"),c("span",{style:{color:"#24292E"}}," ("),c("span",{style:{color:"#005CC5"}},"true"),c("span",{style:{color:"#24292E"}},") {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"            Student s2 "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#D73A49"}},"new"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#6F42C1"}},"Student"),c("span",{style:{color:"#24292E"}},"("),c("span",{style:{color:"#005CC5"}},"44"),c("span",{style:{color:"#24292E"}},", "),c("span",{style:{color:"#032F62"}},'"l4"'),c("span",{style:{color:"#24292E"}},");")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"            "),c("span",{style:{color:"#D73A49"}},"if"),c("span",{style:{color:"#24292E"}}," (atomicReference."),c("span",{style:{color:"#6F42C1"}},"compareAndSet"),c("span",{style:{color:"#24292E"}},"(s1, s2)) {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"                "),c("span",{style:{color:"#D73A49"}},"break"),c("span",{style:{color:"#24292E"}},";")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"            }")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        }")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        System.out."),c("span",{style:{color:"#6F42C1"}},"println"),c("span",{style:{color:"#24292E"}},"(atomicReference."),c("span",{style:{color:"#6F42C1"}},"get"),c("span",{style:{color:"#24292E"}},"());")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    }")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"}")]),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#D73A49"}},"class"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#6F42C1"}},"Student"),c("span",{style:{color:"#24292E"}}," {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#D73A49"}},"private"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#D73A49"}},"int"),c("span",{style:{color:"#24292E"}}," id;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#D73A49"}},"private"),c("span",{style:{color:"#24292E"}}," String name;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#6A737D"}},"//。。。。")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"}")])])]),c("button",{class:"collapse"})],-1),Cl=c("hr",null,null,-1),bl={id:"原子数组",tabindex:"-1"},ml=c("p",null,"原子数组类：AtomicIntegerArray、AtomicLongArray、AtomicReferenceArray",-1),vl=c("p",null,"AtomicIntegerArray 类方法：",-1),fl=c("div",{style:{"max-height":"300px"},class:"language-java"},[c("button",{title:"Copy Code",class:"copy"}),c("span",{class:"lang"},"java"),c("pre",{class:"shiki github-dark vp-code-dark"},[c("code",null,[c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"/**")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"*   i\t\tthe index")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"* expect \tthe expected value")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"* update \tthe new value")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"*/")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#F97583"}},"public"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#F97583"}},"final"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#F97583"}},"boolean"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#B392F0"}},"compareAndSet"),c("span",{style:{color:"#E1E4E8"}},"("),c("span",{style:{color:"#F97583"}},"int"),c("span",{style:{color:"#E1E4E8"}}," i, "),c("span",{style:{color:"#F97583"}},"int"),c("span",{style:{color:"#E1E4E8"}}," expect, "),c("span",{style:{color:"#F97583"}},"int"),c("span",{style:{color:"#E1E4E8"}}," update) {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#F97583"}},"return"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#B392F0"}},"compareAndSetRaw"),c("span",{style:{color:"#E1E4E8"}},"("),c("span",{style:{color:"#B392F0"}},"checkedByteOffset"),c("span",{style:{color:"#E1E4E8"}},"(i), expect, update);")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"}")])])]),c("pre",{class:"shiki github-light vp-code-light"},[c("code",null,[c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"/**")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"*   i\t\tthe index")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"* expect \tthe expected value")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"* update \tthe new value")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"*/")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#D73A49"}},"public"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#D73A49"}},"final"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#D73A49"}},"boolean"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#6F42C1"}},"compareAndSet"),c("span",{style:{color:"#24292E"}},"("),c("span",{style:{color:"#D73A49"}},"int"),c("span",{style:{color:"#24292E"}}," i, "),c("span",{style:{color:"#D73A49"}},"int"),c("span",{style:{color:"#24292E"}}," expect, "),c("span",{style:{color:"#D73A49"}},"int"),c("span",{style:{color:"#24292E"}}," update) {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#D73A49"}},"return"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#6F42C1"}},"compareAndSetRaw"),c("span",{style:{color:"#24292E"}},"("),c("span",{style:{color:"#6F42C1"}},"checkedByteOffset"),c("span",{style:{color:"#24292E"}},"(i), expect, update);")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"}")])])]),c("button",{class:"collapse"})],-1),Bl=c("hr",null,null,-1),kl={id:"原子更新器",tabindex:"-1"},Sl=c("p",null,"原子更新器类：AtomicReferenceFieldUpdater、AtomicIntegerFieldUpdater、AtomicLongFieldUpdater",-1),Tl=c("p",null,[p("利用字段更新器，可以针对对象的某个域（Field）进行原子操作，只能配合 volatile 修饰的字段使用，否则会出现异常 "),c("code",null,"IllegalArgumentException: Must be volatile type")],-1),xl=c("p",null,"常用 API：",-1),Ll=c("ul",null,[c("li",null,[c("code",null,"static <U> AtomicIntegerFieldUpdater<U> newUpdater(Class<U> c, String fieldName)"),p("：静态方法")]),c("li",null,[c("code",null,"abstract boolean compareAndSet(T obj, int expect, int update)"),p("：CAS")])],-1),wl=c("div",{style:{"max-height":"300px"},class:"language-java"},[c("button",{title:"Copy Code",class:"copy"}),c("span",{class:"lang"},"java"),c("pre",{class:"shiki github-dark vp-code-dark"},[c("code",null,[c("span",{class:"line"},[c("span",{style:{color:"#F97583"}},"public"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#F97583"}},"class"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#B392F0"}},"UpdateDemo"),c("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#F97583"}},"private"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#F97583"}},"volatile"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#F97583"}},"int"),c("span",{style:{color:"#E1E4E8"}}," field;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    ")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#F97583"}},"public"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#F97583"}},"static"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#F97583"}},"void"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#B392F0"}},"main"),c("span",{style:{color:"#E1E4E8"}},"("),c("span",{style:{color:"#F97583"}},"String"),c("span",{style:{color:"#E1E4E8"}},"[] "),c("span",{style:{color:"#FFAB70"}},"args"),c("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        AtomicIntegerFieldUpdater fieldUpdater "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," AtomicIntegerFieldUpdater")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"            \t\t."),c("span",{style:{color:"#B392F0"}},"newUpdater"),c("span",{style:{color:"#E1E4E8"}},"(UpdateDemo.class, "),c("span",{style:{color:"#9ECBFF"}},'"field"'),c("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        UpdateDemo updateDemo "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#F97583"}},"new"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#B392F0"}},"UpdateDemo"),c("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        fieldUpdater."),c("span",{style:{color:"#B392F0"}},"compareAndSet"),c("span",{style:{color:"#E1E4E8"}},"(updateDemo, "),c("span",{style:{color:"#79B8FF"}},"0"),c("span",{style:{color:"#E1E4E8"}},", "),c("span",{style:{color:"#79B8FF"}},"10"),c("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        System.out."),c("span",{style:{color:"#B392F0"}},"println"),c("span",{style:{color:"#E1E4E8"}},"(updateDemo.field);"),c("span",{style:{color:"#6A737D"}},"//10")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"}")])])]),c("pre",{class:"shiki github-light vp-code-light"},[c("code",null,[c("span",{class:"line"},[c("span",{style:{color:"#D73A49"}},"public"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#D73A49"}},"class"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#6F42C1"}},"UpdateDemo"),c("span",{style:{color:"#24292E"}}," {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#D73A49"}},"private"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#D73A49"}},"volatile"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#D73A49"}},"int"),c("span",{style:{color:"#24292E"}}," field;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    ")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#D73A49"}},"public"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#D73A49"}},"static"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#D73A49"}},"void"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#6F42C1"}},"main"),c("span",{style:{color:"#24292E"}},"("),c("span",{style:{color:"#D73A49"}},"String"),c("span",{style:{color:"#24292E"}},"[] "),c("span",{style:{color:"#E36209"}},"args"),c("span",{style:{color:"#24292E"}},") {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        AtomicIntegerFieldUpdater fieldUpdater "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," AtomicIntegerFieldUpdater")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"            \t\t."),c("span",{style:{color:"#6F42C1"}},"newUpdater"),c("span",{style:{color:"#24292E"}},"(UpdateDemo.class, "),c("span",{style:{color:"#032F62"}},'"field"'),c("span",{style:{color:"#24292E"}},");")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        UpdateDemo updateDemo "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#D73A49"}},"new"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#6F42C1"}},"UpdateDemo"),c("span",{style:{color:"#24292E"}},"();")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        fieldUpdater."),c("span",{style:{color:"#6F42C1"}},"compareAndSet"),c("span",{style:{color:"#24292E"}},"(updateDemo, "),c("span",{style:{color:"#005CC5"}},"0"),c("span",{style:{color:"#24292E"}},", "),c("span",{style:{color:"#005CC5"}},"10"),c("span",{style:{color:"#24292E"}},");")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        System.out."),c("span",{style:{color:"#6F42C1"}},"println"),c("span",{style:{color:"#24292E"}},"(updateDemo.field);"),c("span",{style:{color:"#6A737D"}},"//10")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    }")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"}")])])]),c("button",{class:"collapse"})],-1),Il=c("hr",null,null,-1),jl={id:"原子累加器",tabindex:"-1"},Ml=c("p",null,"原子累加器类：LongAdder、DoubleAdder、LongAccumulator、DoubleAccumulator",-1),Ul=c("p",null,"LongAdder 和 LongAccumulator 区别：",-1),Pl=c("p",null,"相同点：",-1),_l=c("ul",null,[c("li",null,"LongAdder 与 LongAccumulator 类都是使用非阻塞算法 CAS 实现的"),c("li",null,"LongAdder 类是 LongAccumulator 类的一个特例，只是 LongAccumulator 提供了更强大的功能，可以自定义累加规则，当accumulatorFunction 为 null 时就等价于 LongAdder")],-1),Rl=c("p",null,"不同点：",-1),Vl=c("ul",null,[c("li",null,[c("p",null,"调用 casBase 时，LongAccumulator 使用 function.applyAsLong(b = base, x) 来计算，LongAdder 使用 casBase(b = base, b + x)")]),c("li",null,[c("p",null,"LongAccumulator 类功能更加强大，构造方法参数中"),c("ul",null,[c("li",null,"accumulatorFunction 是一个双目运算器接口，可以指定累加规则，比如累加或者相乘，其根据输入的两个参数返回一个计算值，LongAdder 内置累加规则"),c("li",null,"identity 则是 LongAccumulator 累加器的初始值，LongAccumulator 可以为累加器提供非0的初始值，而 LongAdder 只能提供默认的 0")])])],-1),Ol=c("hr",null,null,-1),zl={id:"adder",tabindex:"-1"},Nl={id:"优化机制",tabindex:"-1"},Hl=c("p",null,"LongAdder 是 Java8 提供的类，跟 AtomicLong 有相同的效果，但对 CAS 机制进行了优化，尝试使用分段 CAS 以及自动分段迁移的方式来大幅度提升多线程高并发执行 CAS 操作的性能",-1),Gl=c("p",null,[p("CAS 底层实现是在一个循环中不断地尝试修改目标值，直到修改成功。如果竞争不激烈修改成功率很高，否则失败率很高，失败后这些重复的原子性操作会耗费性能（导致大量线程"),c("strong",null,"空循环，自旋转"),p("）")],-1),Kl=c("p",null,[p("优化核心思想：数据分离，将 AtomicLong 的"),c("strong",null,"单点的更新压力分担到各个节点，空间换时间"),p("，在低并发的时候直接更新，可以保障和 AtomicLong 的性能基本一致，而在高并发的时候通过分散减少竞争，提高了性能")],-1),Jl=c("p",null,[c("strong",null,"分段 CAS 机制"),p("：")],-1),$l=c("ul",null,[c("li",null,"在发生竞争时，创建 Cell 数组用于将不同线程的操作离散（通过 hash 等算法映射）到不同的节点上"),c("li",null,"设置多个累加单元（会根据需要扩容，最大为 CPU 核数），Therad-0 累加 Cell[0]，而 Thread-1 累加 Cell[1] 等，最后将结果汇总"),c("li",null,"在累加时操作的不同的 Cell 变量，因此减少了 CAS 重试失败，从而提高性能")],-1),Yl=c("p",null,[c("strong",null,"自动分段迁移机制"),p("：某个 Cell 的 value 执行 CAS 失败，就会自动寻找另一个 Cell 分段内的 value 值进行 CAS 操作")],-1),ql=c("hr",null,null,-1),Wl={id:"伪共享",tabindex:"-1"},Ql=c("p",null,"Cell 为累加单元：数组访问索引是通过 Thread 里的 threadLocalRandomProbe 域取模实现的，这个域是 ThreadLocalRandom 更新的",-1),Zl=c("div",{style:{"max-height":"300px"},class:"language-java"},[c("button",{title:"Copy Code",class:"copy"}),c("span",{class:"lang"},"java"),c("pre",{class:"shiki github-dark vp-code-dark"},[c("code",null,[c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"// Striped64.Cell")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"@"),c("span",{style:{color:"#F97583"}},"sun"),c("span",{style:{color:"#E1E4E8"}},".misc.Contended "),c("span",{style:{color:"#F97583"}},"static"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#F97583"}},"final"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#F97583"}},"class"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#B392F0"}},"Cell"),c("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#F97583"}},"volatile"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#F97583"}},"long"),c("span",{style:{color:"#E1E4E8"}}," value;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#B392F0"}},"Cell"),c("span",{style:{color:"#E1E4E8"}},"("),c("span",{style:{color:"#F97583"}},"long"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#FFAB70"}},"x"),c("span",{style:{color:"#E1E4E8"}},") { value "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," x; }")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#6A737D"}},"// 用 cas 方式进行累加, prev 表示旧值, next 表示新值")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#F97583"}},"final"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#F97583"}},"boolean"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#B392F0"}},"cas"),c("span",{style:{color:"#E1E4E8"}},"("),c("span",{style:{color:"#F97583"}},"long"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#FFAB70"}},"prev"),c("span",{style:{color:"#E1E4E8"}},", "),c("span",{style:{color:"#F97583"}},"long"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#FFAB70"}},"next"),c("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    \t"),c("span",{style:{color:"#F97583"}},"return"),c("span",{style:{color:"#E1E4E8"}}," UNSAFE."),c("span",{style:{color:"#B392F0"}},"compareAndSwapLong"),c("span",{style:{color:"#E1E4E8"}},"("),c("span",{style:{color:"#79B8FF"}},"this"),c("span",{style:{color:"#E1E4E8"}},", valueOffset, prev, next);")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#6A737D"}},"// 省略不重要代码")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"}")])])]),c("pre",{class:"shiki github-light vp-code-light"},[c("code",null,[c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"// Striped64.Cell")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"@"),c("span",{style:{color:"#D73A49"}},"sun"),c("span",{style:{color:"#24292E"}},".misc.Contended "),c("span",{style:{color:"#D73A49"}},"static"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#D73A49"}},"final"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#D73A49"}},"class"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#6F42C1"}},"Cell"),c("span",{style:{color:"#24292E"}}," {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#D73A49"}},"volatile"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#D73A49"}},"long"),c("span",{style:{color:"#24292E"}}," value;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#6F42C1"}},"Cell"),c("span",{style:{color:"#24292E"}},"("),c("span",{style:{color:"#D73A49"}},"long"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#E36209"}},"x"),c("span",{style:{color:"#24292E"}},") { value "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," x; }")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#6A737D"}},"// 用 cas 方式进行累加, prev 表示旧值, next 表示新值")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#D73A49"}},"final"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#D73A49"}},"boolean"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#6F42C1"}},"cas"),c("span",{style:{color:"#24292E"}},"("),c("span",{style:{color:"#D73A49"}},"long"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#E36209"}},"prev"),c("span",{style:{color:"#24292E"}},", "),c("span",{style:{color:"#D73A49"}},"long"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#E36209"}},"next"),c("span",{style:{color:"#24292E"}},") {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    \t"),c("span",{style:{color:"#D73A49"}},"return"),c("span",{style:{color:"#24292E"}}," UNSAFE."),c("span",{style:{color:"#6F42C1"}},"compareAndSwapLong"),c("span",{style:{color:"#24292E"}},"("),c("span",{style:{color:"#005CC5"}},"this"),c("span",{style:{color:"#24292E"}},", valueOffset, prev, next);")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    }")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#6A737D"}},"// 省略不重要代码")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"}")])])]),c("button",{class:"collapse"})],-1),Xl=c("p",null,[p("Cell 是数组形式，"),c("strong",null,"在内存中是连续存储的"),p("，64 位系统中，一个 Cell 为 24 字节（16 字节的对象头和 8 字节的 value），每一个 cache line 为 64 字节，因此缓存行可以存下 2 个的 Cell 对象，当 Core-0 要修改 Cell[0]、Core-1 要修改 Cell[1]，"),c("strong",null,"无论谁修改成功都会导致当前缓存行失效"),p("，从而导致对方的数据失效，需要重新去主存获取，影响效率")],-1),ls=c("img",{src:"https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/20200608150111.png",alt:"img",style:{zoom:"67%"}},null,-1),ss=c("p",null,[p("@sun.misc.Contended：防止缓存行伪共享，在使用此注解的对象或字段的前后各增加 128 字节大小的 padding，使用 2 倍于大多数硬件缓存行让 CPU 将对象预读至缓存时"),c("strong",null,"占用不同的缓存行"),p("，这样就不会造成对方缓存行的失效")],-1),os=c("img",{src:"https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/20200608150119.png",alt:"img",style:{zoom:"67%"}},null,-1),ns=c("hr",null,null,-1),as={id:"源码解析",tabindex:"-1"},es=c("p",null,"Striped64 类成员属性：",-1),ts=c("div",{style:{"max-height":"300px"},class:"language-java"},[c("button",{title:"Copy Code",class:"copy"}),c("span",{class:"lang"},"java"),c("pre",{class:"shiki github-dark vp-code-dark"},[c("code",null,[c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"// 表示当前计算机CPU数量")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#F97583"}},"static"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#F97583"}},"final"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#F97583"}},"int"),c("span",{style:{color:"#E1E4E8"}}," NCPU "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," Runtime."),c("span",{style:{color:"#B392F0"}},"getRuntime"),c("span",{style:{color:"#E1E4E8"}},"()."),c("span",{style:{color:"#B392F0"}},"availableProcessors"),c("span",{style:{color:"#E1E4E8"}},"()")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"// 累加单元数组, 懒惰初始化")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#F97583"}},"transient"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#F97583"}},"volatile"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#F97583"}},"Cell"),c("span",{style:{color:"#E1E4E8"}},"[] cells;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"// 基础值, 如果没有竞争, 则用 cas 累加这个域，当 cells 扩容时，也会将数据写到 base 中")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#F97583"}},"transient"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#F97583"}},"volatile"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#F97583"}},"long"),c("span",{style:{color:"#E1E4E8"}}," base;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"// 在 cells 初始化或扩容时只能有一个线程执行, 通过 CAS 更新 cellsBusy 置为 1 来实现一个锁")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#F97583"}},"transient"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#F97583"}},"volatile"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#F97583"}},"int"),c("span",{style:{color:"#E1E4E8"}}," cellsBusy;")])])]),c("pre",{class:"shiki github-light vp-code-light"},[c("code",null,[c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"// 表示当前计算机CPU数量")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#D73A49"}},"static"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#D73A49"}},"final"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#D73A49"}},"int"),c("span",{style:{color:"#24292E"}}," NCPU "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," Runtime."),c("span",{style:{color:"#6F42C1"}},"getRuntime"),c("span",{style:{color:"#24292E"}},"()."),c("span",{style:{color:"#6F42C1"}},"availableProcessors"),c("span",{style:{color:"#24292E"}},"()")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"// 累加单元数组, 懒惰初始化")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#D73A49"}},"transient"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#D73A49"}},"volatile"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#D73A49"}},"Cell"),c("span",{style:{color:"#24292E"}},"[] cells;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"// 基础值, 如果没有竞争, 则用 cas 累加这个域，当 cells 扩容时，也会将数据写到 base 中")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#D73A49"}},"transient"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#D73A49"}},"volatile"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#D73A49"}},"long"),c("span",{style:{color:"#24292E"}}," base;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"// 在 cells 初始化或扩容时只能有一个线程执行, 通过 CAS 更新 cellsBusy 置为 1 来实现一个锁")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#D73A49"}},"transient"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#D73A49"}},"volatile"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#D73A49"}},"int"),c("span",{style:{color:"#24292E"}}," cellsBusy;")])])]),c("button",{class:"collapse"})],-1),cs=c("p",null,"工作流程：",-1),ps=c("ul",null,[c("li",null,[c("p",null,"cells 占用内存是相对比较大的，是惰性加载的，在无竞争或者其他线程正在初始化 cells 数组的情况下，直接更新 base 域")]),c("li",null,[c("p",null,"在第一次发生竞争时（casBase 失败）会创建一个大小为 2 的 cells 数组，将当前累加的值包装为 Cell 对象，放入映射的槽位上")]),c("li",null,[c("p",null,"分段累加的过程中，如果当前线程对应的 cells 槽位为空，就会新建 Cell 填充，如果出现竞争，就会重新计算线程对应的槽位，继续自旋尝试修改")]),c("li",null,[c("p",null,[p("分段迁移后还出现竞争就会扩容 cells 数组长度为原来的两倍，然后 rehash，"),c("strong",null,"数组长度总是 2 的 n 次幂"),p("，默认最大为 CPU 核数，但是可以超过，如果核数是 6 核，数组最长是 8")])])],-1),rs=c("p",null,"方法分析：",-1),Es=c("ul",null,[c("li",null,[c("p",null,"LongAdder#add：累加方法"),c("div",{style:{"max-height":"300px"},class:"language-java"},[c("button",{title:"Copy Code",class:"copy"}),c("span",{class:"lang"},"java"),c("pre",{class:"shiki github-dark vp-code-dark"},[c("code",null,[c("span",{class:"line"},[c("span",{style:{color:"#F97583"}},"public"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#F97583"}},"void"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#B392F0"}},"add"),c("span",{style:{color:"#E1E4E8"}},"("),c("span",{style:{color:"#F97583"}},"long"),c("span",{style:{color:"#E1E4E8"}}," x) {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#6A737D"}},"// as 为累加单元数组的引用，b 为基础值，v 表示期望值")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#6A737D"}},"// m 表示 cells 数组的长度 - 1，a 表示当前线程命中的 cell 单元格")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#F97583"}},"Cell"),c("span",{style:{color:"#E1E4E8"}},"[] as; "),c("span",{style:{color:"#F97583"}},"long"),c("span",{style:{color:"#E1E4E8"}}," b, v; "),c("span",{style:{color:"#F97583"}},"int"),c("span",{style:{color:"#E1E4E8"}}," m; Cell a;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    ")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#6A737D"}},"// cells 不为空说明 cells 已经被初始化，线程发生了竞争，去更新对应的 cell 槽位")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#6A737D"}},"// 进入 || 后的逻辑去更新 base 域，更新失败表示发生竞争进入条件")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#F97583"}},"if"),c("span",{style:{color:"#E1E4E8"}}," ((as "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," cells) "),c("span",{style:{color:"#F97583"}},"!="),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#79B8FF"}},"null"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#F97583"}},"||"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#F97583"}},"!"),c("span",{style:{color:"#B392F0"}},"casBase"),c("span",{style:{color:"#E1E4E8"}},"(b "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," base, b "),c("span",{style:{color:"#F97583"}},"+"),c("span",{style:{color:"#E1E4E8"}}," x)) {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        "),c("span",{style:{color:"#6A737D"}},"// uncontended 为 true 表示 cell 没有竞争")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        "),c("span",{style:{color:"#F97583"}},"boolean"),c("span",{style:{color:"#E1E4E8"}}," uncontended "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#79B8FF"}},"true"),c("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        ")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        "),c("span",{style:{color:"#6A737D"}},"// 条件一: true 说明 cells 未初始化，多线程写 base 发生竞争需要进行初始化 cells 数组")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        "),c("span",{style:{color:"#6A737D"}},"//\t\t  fasle 说明 cells 已经初始化，进行下一个条件寻找自己的 cell 去累加")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        "),c("span",{style:{color:"#6A737D"}},"// 条件二: getProbe() 获取 hash 值，& m 的逻辑和 HashMap 的逻辑相同，保证散列的均匀性")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        "),c("span",{style:{color:"#6A737D"}},"// \t\t  true 说明当前线程对应下标的 cell 为空，需要创建 cell")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        "),c("span",{style:{color:"#6A737D"}},"//        false 说明当前线程对应的 cell 不为空，进行下一个条件【将 x 值累加到对应的 cell 中】")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        "),c("span",{style:{color:"#6A737D"}},"// 条件三: 有取反符号，false 说明 cas 成功，直接返回，true 说明失败，当前线程对应的 cell 有竞争")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        "),c("span",{style:{color:"#F97583"}},"if"),c("span",{style:{color:"#E1E4E8"}}," (as "),c("span",{style:{color:"#F97583"}},"=="),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#79B8FF"}},"null"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#F97583"}},"||"),c("span",{style:{color:"#E1E4E8"}}," (m "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," as.length "),c("span",{style:{color:"#F97583"}},"-"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#79B8FF"}},"1"),c("span",{style:{color:"#E1E4E8"}},") "),c("span",{style:{color:"#F97583"}},"<"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#79B8FF"}},"0"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#F97583"}},"||")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"            (a "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," as["),c("span",{style:{color:"#B392F0"}},"getProbe"),c("span",{style:{color:"#E1E4E8"}},"() "),c("span",{style:{color:"#F97583"}},"&"),c("span",{style:{color:"#E1E4E8"}}," m]) "),c("span",{style:{color:"#F97583"}},"=="),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#79B8FF"}},"null"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#F97583"}},"||")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"            "),c("span",{style:{color:"#F97583"}},"!"),c("span",{style:{color:"#E1E4E8"}},"(uncontended "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," a."),c("span",{style:{color:"#B392F0"}},"cas"),c("span",{style:{color:"#E1E4E8"}},"(v "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," a.value, v "),c("span",{style:{color:"#F97583"}},"+"),c("span",{style:{color:"#E1E4E8"}}," x)))")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"            "),c("span",{style:{color:"#B392F0"}},"longAccumulate"),c("span",{style:{color:"#E1E4E8"}},"(x, "),c("span",{style:{color:"#79B8FF"}},"null"),c("span",{style:{color:"#E1E4E8"}},", uncontended);")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        \t"),c("span",{style:{color:"#6A737D"}},"// 【uncontended 在对应的 cell 上累加失败的时候才为 false，其余情况均为 true】")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"}")])])]),c("pre",{class:"shiki github-light vp-code-light"},[c("code",null,[c("span",{class:"line"},[c("span",{style:{color:"#D73A49"}},"public"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#D73A49"}},"void"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#6F42C1"}},"add"),c("span",{style:{color:"#24292E"}},"("),c("span",{style:{color:"#D73A49"}},"long"),c("span",{style:{color:"#24292E"}}," x) {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#6A737D"}},"// as 为累加单元数组的引用，b 为基础值，v 表示期望值")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#6A737D"}},"// m 表示 cells 数组的长度 - 1，a 表示当前线程命中的 cell 单元格")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#D73A49"}},"Cell"),c("span",{style:{color:"#24292E"}},"[] as; "),c("span",{style:{color:"#D73A49"}},"long"),c("span",{style:{color:"#24292E"}}," b, v; "),c("span",{style:{color:"#D73A49"}},"int"),c("span",{style:{color:"#24292E"}}," m; Cell a;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    ")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#6A737D"}},"// cells 不为空说明 cells 已经被初始化，线程发生了竞争，去更新对应的 cell 槽位")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#6A737D"}},"// 进入 || 后的逻辑去更新 base 域，更新失败表示发生竞争进入条件")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#D73A49"}},"if"),c("span",{style:{color:"#24292E"}}," ((as "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," cells) "),c("span",{style:{color:"#D73A49"}},"!="),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#005CC5"}},"null"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#D73A49"}},"||"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#D73A49"}},"!"),c("span",{style:{color:"#6F42C1"}},"casBase"),c("span",{style:{color:"#24292E"}},"(b "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," base, b "),c("span",{style:{color:"#D73A49"}},"+"),c("span",{style:{color:"#24292E"}}," x)) {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        "),c("span",{style:{color:"#6A737D"}},"// uncontended 为 true 表示 cell 没有竞争")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        "),c("span",{style:{color:"#D73A49"}},"boolean"),c("span",{style:{color:"#24292E"}}," uncontended "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#005CC5"}},"true"),c("span",{style:{color:"#24292E"}},";")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        ")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        "),c("span",{style:{color:"#6A737D"}},"// 条件一: true 说明 cells 未初始化，多线程写 base 发生竞争需要进行初始化 cells 数组")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        "),c("span",{style:{color:"#6A737D"}},"//\t\t  fasle 说明 cells 已经初始化，进行下一个条件寻找自己的 cell 去累加")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        "),c("span",{style:{color:"#6A737D"}},"// 条件二: getProbe() 获取 hash 值，& m 的逻辑和 HashMap 的逻辑相同，保证散列的均匀性")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        "),c("span",{style:{color:"#6A737D"}},"// \t\t  true 说明当前线程对应下标的 cell 为空，需要创建 cell")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        "),c("span",{style:{color:"#6A737D"}},"//        false 说明当前线程对应的 cell 不为空，进行下一个条件【将 x 值累加到对应的 cell 中】")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        "),c("span",{style:{color:"#6A737D"}},"// 条件三: 有取反符号，false 说明 cas 成功，直接返回，true 说明失败，当前线程对应的 cell 有竞争")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        "),c("span",{style:{color:"#D73A49"}},"if"),c("span",{style:{color:"#24292E"}}," (as "),c("span",{style:{color:"#D73A49"}},"=="),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#005CC5"}},"null"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#D73A49"}},"||"),c("span",{style:{color:"#24292E"}}," (m "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," as.length "),c("span",{style:{color:"#D73A49"}},"-"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#005CC5"}},"1"),c("span",{style:{color:"#24292E"}},") "),c("span",{style:{color:"#D73A49"}},"<"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#005CC5"}},"0"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#D73A49"}},"||")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"            (a "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," as["),c("span",{style:{color:"#6F42C1"}},"getProbe"),c("span",{style:{color:"#24292E"}},"() "),c("span",{style:{color:"#D73A49"}},"&"),c("span",{style:{color:"#24292E"}}," m]) "),c("span",{style:{color:"#D73A49"}},"=="),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#005CC5"}},"null"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#D73A49"}},"||")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"            "),c("span",{style:{color:"#D73A49"}},"!"),c("span",{style:{color:"#24292E"}},"(uncontended "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," a."),c("span",{style:{color:"#6F42C1"}},"cas"),c("span",{style:{color:"#24292E"}},"(v "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," a.value, v "),c("span",{style:{color:"#D73A49"}},"+"),c("span",{style:{color:"#24292E"}}," x)))")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"            "),c("span",{style:{color:"#6F42C1"}},"longAccumulate"),c("span",{style:{color:"#24292E"}},"(x, "),c("span",{style:{color:"#005CC5"}},"null"),c("span",{style:{color:"#24292E"}},", uncontended);")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        \t"),c("span",{style:{color:"#6A737D"}},"// 【uncontended 在对应的 cell 上累加失败的时候才为 false，其余情况均为 true】")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    }")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"}")])])]),c("button",{class:"collapse"})])]),c("li",null,[c("p",null,"Striped64#longAccumulate：cell 数组创建"),c("div",{style:{"max-height":"300px"},class:"language-java"},[c("button",{title:"Copy Code",class:"copy"}),c("span",{class:"lang"},"java"),c("pre",{class:"shiki github-dark vp-code-dark"},[c("code",null,[c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"// \t\t\t\t\t\t\tx  \t\t\tnull \t\t\tfalse | true")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#F97583"}},"final"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#F97583"}},"void"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#B392F0"}},"longAccumulate"),c("span",{style:{color:"#E1E4E8"}},"("),c("span",{style:{color:"#F97583"}},"long"),c("span",{style:{color:"#E1E4E8"}}," x, LongBinaryOperator fn, "),c("span",{style:{color:"#F97583"}},"boolean"),c("span",{style:{color:"#E1E4E8"}}," wasUncontended) {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#F97583"}},"int"),c("span",{style:{color:"#E1E4E8"}}," h;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#6A737D"}},"// 当前线程还没有对应的 cell, 需要随机生成一个 hash 值用来将当前线程绑定到 cell")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#F97583"}},"if"),c("span",{style:{color:"#E1E4E8"}}," ((h "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#B392F0"}},"getProbe"),c("span",{style:{color:"#E1E4E8"}},"()) "),c("span",{style:{color:"#F97583"}},"=="),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#79B8FF"}},"0"),c("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        "),c("span",{style:{color:"#6A737D"}},"// 初始化 probe，获取 hash 值")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        ThreadLocalRandom."),c("span",{style:{color:"#B392F0"}},"current"),c("span",{style:{color:"#E1E4E8"}},"(); ")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        h "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#B392F0"}},"getProbe"),c("span",{style:{color:"#E1E4E8"}},"();\t")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        "),c("span",{style:{color:"#6A737D"}},"// 默认情况下 当前线程肯定是写入到了 cells[0] 位置，不把它当做一次真正的竞争")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        wasUncontended "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#79B8FF"}},"true"),c("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#6A737D"}},"// 表示【扩容意向】，false 一定不会扩容，true 可能会扩容")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#F97583"}},"boolean"),c("span",{style:{color:"#E1E4E8"}}," collide "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#79B8FF"}},"false"),c("span",{style:{color:"#E1E4E8"}},"; ")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#6A737D"}},"//自旋")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#F97583"}},"for"),c("span",{style:{color:"#E1E4E8"}}," (;;) {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        "),c("span",{style:{color:"#6A737D"}},"// as 表示cells引用，a 表示当前线程命中的 cell，n 表示 cells 数组长度，v 表示 期望值")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        "),c("span",{style:{color:"#F97583"}},"Cell"),c("span",{style:{color:"#E1E4E8"}},"[] as; Cell a; "),c("span",{style:{color:"#F97583"}},"int"),c("span",{style:{color:"#E1E4E8"}}," n; "),c("span",{style:{color:"#F97583"}},"long"),c("span",{style:{color:"#E1E4E8"}}," v;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        "),c("span",{style:{color:"#6A737D"}},"// 【CASE1】: 表示 cells 已经初始化了，当前线程应该将数据写入到对应的 cell 中")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        "),c("span",{style:{color:"#F97583"}},"if"),c("span",{style:{color:"#E1E4E8"}}," ((as "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," cells) "),c("span",{style:{color:"#F97583"}},"!="),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#79B8FF"}},"null"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#F97583"}},"&&"),c("span",{style:{color:"#E1E4E8"}}," (n "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," as.length) "),c("span",{style:{color:"#F97583"}},">"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#79B8FF"}},"0"),c("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"            "),c("span",{style:{color:"#6A737D"}},"// CASE1.1: true 表示当前线程对应的索引下标的 Cell 为 null，需要创建 new Cell")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"            "),c("span",{style:{color:"#F97583"}},"if"),c("span",{style:{color:"#E1E4E8"}}," ((a "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," as[(n "),c("span",{style:{color:"#F97583"}},"-"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#79B8FF"}},"1"),c("span",{style:{color:"#E1E4E8"}},") "),c("span",{style:{color:"#F97583"}},"&"),c("span",{style:{color:"#E1E4E8"}}," h]) "),c("span",{style:{color:"#F97583"}},"=="),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#79B8FF"}},"null"),c("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"                "),c("span",{style:{color:"#6A737D"}},"// 判断 cellsBusy 是否被锁")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"                "),c("span",{style:{color:"#F97583"}},"if"),c("span",{style:{color:"#E1E4E8"}}," (cellsBusy "),c("span",{style:{color:"#F97583"}},"=="),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#79B8FF"}},"0"),c("span",{style:{color:"#E1E4E8"}},") {   ")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"                    "),c("span",{style:{color:"#6A737D"}},"// 创建 cell, 初始累加值为 x")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"                    Cell r "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#F97583"}},"new"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#B392F0"}},"Cell"),c("span",{style:{color:"#E1E4E8"}},"(x);  ")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"                    "),c("span",{style:{color:"#6A737D"}},"// 加锁")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"                    "),c("span",{style:{color:"#F97583"}},"if"),c("span",{style:{color:"#E1E4E8"}}," (cellsBusy "),c("span",{style:{color:"#F97583"}},"=="),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#79B8FF"}},"0"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#F97583"}},"&&"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#B392F0"}},"casCellsBusy"),c("span",{style:{color:"#E1E4E8"}},"()) {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"                        "),c("span",{style:{color:"#6A737D"}},"// 创建成功标记，进入【创建 cell 逻辑】")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"                        "),c("span",{style:{color:"#F97583"}},"boolean"),c("span",{style:{color:"#E1E4E8"}}," created "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#79B8FF"}},"false"),c("span",{style:{color:"#E1E4E8"}},";\t")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"                        "),c("span",{style:{color:"#F97583"}},"try"),c("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"                            "),c("span",{style:{color:"#F97583"}},"Cell"),c("span",{style:{color:"#E1E4E8"}},"[] rs; "),c("span",{style:{color:"#F97583"}},"int"),c("span",{style:{color:"#E1E4E8"}}," m, j;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"                            "),c("span",{style:{color:"#6A737D"}},"// 把当前 cells 数组赋值给 rs，并且不为 null")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"                            "),c("span",{style:{color:"#F97583"}},"if"),c("span",{style:{color:"#E1E4E8"}}," ((rs "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," cells) "),c("span",{style:{color:"#F97583"}},"!="),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#79B8FF"}},"null"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#F97583"}},"&&")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"                                (m "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," rs.length) "),c("span",{style:{color:"#F97583"}},">"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#79B8FF"}},"0"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#F97583"}},"&&")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"                                "),c("span",{style:{color:"#6A737D"}},"// 再次判断防止其它线程初始化过该位置，当前线程再次初始化该位置会造成数据丢失")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"                                "),c("span",{style:{color:"#6A737D"}},"// 因为这里是线程安全的判断，进行的逻辑不会被其他线程影响")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"                                rs[j "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," (m "),c("span",{style:{color:"#F97583"}},"-"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#79B8FF"}},"1"),c("span",{style:{color:"#E1E4E8"}},") "),c("span",{style:{color:"#F97583"}},"&"),c("span",{style:{color:"#E1E4E8"}}," h] "),c("span",{style:{color:"#F97583"}},"=="),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#79B8FF"}},"null"),c("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"                                "),c("span",{style:{color:"#6A737D"}},"// 把新创建的 cell 填充至当前位置")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"                                rs[j] "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," r;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"                                created "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#79B8FF"}},"true"),c("span",{style:{color:"#E1E4E8"}},";\t"),c("span",{style:{color:"#6A737D"}},"// 表示创建完成")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"                            }")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"                        } "),c("span",{style:{color:"#F97583"}},"finally"),c("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"                            cellsBusy "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#79B8FF"}},"0"),c("span",{style:{color:"#E1E4E8"}},";\t\t"),c("span",{style:{color:"#6A737D"}},"// 解锁")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"                        }")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"                        "),c("span",{style:{color:"#F97583"}},"if"),c("span",{style:{color:"#E1E4E8"}}," (created)\t\t\t"),c("span",{style:{color:"#6A737D"}},"// true 表示创建完成，可以推出循环了")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"                            "),c("span",{style:{color:"#F97583"}},"break"),c("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"                        "),c("span",{style:{color:"#F97583"}},"continue"),c("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"                    }")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"                }")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"                collide "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#79B8FF"}},"false"),c("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"            }")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"            "),c("span",{style:{color:"#6A737D"}},"// CASE1.2: 条件成立说明线程对应的 cell 有竞争, 改变线程对应的 cell 来重试 cas")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"            "),c("span",{style:{color:"#F97583"}},"else"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#F97583"}},"if"),c("span",{style:{color:"#E1E4E8"}}," ("),c("span",{style:{color:"#F97583"}},"!"),c("span",{style:{color:"#E1E4E8"}},"wasUncontended)")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"                wasUncontended "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#79B8FF"}},"true"),c("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"            "),c("span",{style:{color:"#6A737D"}},"// CASE 1.3: 当前线程 rehash 过，如果新命中的 cell 不为空，就尝试累加，false 说明新命中也有竞争")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"            "),c("span",{style:{color:"#F97583"}},"else"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#F97583"}},"if"),c("span",{style:{color:"#E1E4E8"}}," (a."),c("span",{style:{color:"#B392F0"}},"cas"),c("span",{style:{color:"#E1E4E8"}},"(v "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," a.value, ((fn "),c("span",{style:{color:"#F97583"}},"=="),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#79B8FF"}},"null"),c("span",{style:{color:"#E1E4E8"}},") "),c("span",{style:{color:"#F97583"}},"?"),c("span",{style:{color:"#E1E4E8"}}," v "),c("span",{style:{color:"#F97583"}},"+"),c("span",{style:{color:"#E1E4E8"}}," x "),c("span",{style:{color:"#F97583"}},":"),c("span",{style:{color:"#E1E4E8"}}," fn."),c("span",{style:{color:"#B392F0"}},"applyAsLong"),c("span",{style:{color:"#E1E4E8"}},"(v, x))))")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"                "),c("span",{style:{color:"#F97583"}},"break"),c("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"            "),c("span",{style:{color:"#6A737D"}},"// CASE 1.4: cells 长度已经超过了最大长度 CPU 内核的数量或者已经扩容")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"            "),c("span",{style:{color:"#F97583"}},"else"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#F97583"}},"if"),c("span",{style:{color:"#E1E4E8"}}," (n "),c("span",{style:{color:"#F97583"}},">="),c("span",{style:{color:"#E1E4E8"}}," NCPU "),c("span",{style:{color:"#F97583"}},"||"),c("span",{style:{color:"#E1E4E8"}}," cells "),c("span",{style:{color:"#F97583"}},"!="),c("span",{style:{color:"#E1E4E8"}}," as)")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"                collide "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#79B8FF"}},"false"),c("span",{style:{color:"#E1E4E8"}},"; \t\t"),c("span",{style:{color:"#6A737D"}},"// 扩容意向改为false，【表示不能扩容了】")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"            "),c("span",{style:{color:"#6A737D"}},"// CASE 1.5: 更改扩容意向，如果 n >= NCPU，这里就永远不会执行到，case1.4 永远先于 1.5 执行")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"            "),c("span",{style:{color:"#F97583"}},"else"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#F97583"}},"if"),c("span",{style:{color:"#E1E4E8"}}," ("),c("span",{style:{color:"#F97583"}},"!"),c("span",{style:{color:"#E1E4E8"}},"collide)")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"                collide "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#79B8FF"}},"true"),c("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"            "),c("span",{style:{color:"#6A737D"}},"// CASE 1.6: 【扩容逻辑】，进行加锁")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"            "),c("span",{style:{color:"#F97583"}},"else"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#F97583"}},"if"),c("span",{style:{color:"#E1E4E8"}}," (cellsBusy "),c("span",{style:{color:"#F97583"}},"=="),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#79B8FF"}},"0"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#F97583"}},"&&"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#B392F0"}},"casCellsBusy"),c("span",{style:{color:"#E1E4E8"}},"()) {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"                "),c("span",{style:{color:"#F97583"}},"try"),c("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"                    "),c("span",{style:{color:"#6A737D"}},"// 线程安全的检查，防止期间被其他线程扩容了")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"                    "),c("span",{style:{color:"#F97583"}},"if"),c("span",{style:{color:"#E1E4E8"}}," (cells "),c("span",{style:{color:"#F97583"}},"=="),c("span",{style:{color:"#E1E4E8"}}," as) {     ")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"                        "),c("span",{style:{color:"#6A737D"}},"// 扩容为以前的 2 倍")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"                        "),c("span",{style:{color:"#F97583"}},"Cell"),c("span",{style:{color:"#E1E4E8"}},"[] rs "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#F97583"}},"new"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#F97583"}},"Cell"),c("span",{style:{color:"#E1E4E8"}},"[n "),c("span",{style:{color:"#F97583"}},"<<"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#79B8FF"}},"1"),c("span",{style:{color:"#E1E4E8"}},"];")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"                        "),c("span",{style:{color:"#6A737D"}},"// 遍历移动值")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"                        "),c("span",{style:{color:"#F97583"}},"for"),c("span",{style:{color:"#E1E4E8"}}," ("),c("span",{style:{color:"#F97583"}},"int"),c("span",{style:{color:"#E1E4E8"}}," i "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#79B8FF"}},"0"),c("span",{style:{color:"#E1E4E8"}},"; i "),c("span",{style:{color:"#F97583"}},"<"),c("span",{style:{color:"#E1E4E8"}}," n; "),c("span",{style:{color:"#F97583"}},"++"),c("span",{style:{color:"#E1E4E8"}},"i)")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"                            rs[i] "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," as[i];")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"                        "),c("span",{style:{color:"#6A737D"}},"// 把扩容后的引用给 cells")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"                        cells "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," rs;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"                    }")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"                } "),c("span",{style:{color:"#F97583"}},"finally"),c("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"                    cellsBusy "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#79B8FF"}},"0"),c("span",{style:{color:"#E1E4E8"}},";\t"),c("span",{style:{color:"#6A737D"}},"// 解锁")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"                }")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"                collide "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#79B8FF"}},"false"),c("span",{style:{color:"#E1E4E8"}},";\t"),c("span",{style:{color:"#6A737D"}},"// 扩容意向改为 false，表示不扩容了")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"                "),c("span",{style:{color:"#F97583"}},"continue"),c("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"            }")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"            "),c("span",{style:{color:"#6A737D"}},"// 重置当前线程 Hash 值，这就是【分段迁移机制】")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"            h "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#B392F0"}},"advanceProbe"),c("span",{style:{color:"#E1E4E8"}},"(h);")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        }")]),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        "),c("span",{style:{color:"#6A737D"}},"// 【CASE2】: 运行到这说明 cells 还未初始化，as 为null")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        "),c("span",{style:{color:"#6A737D"}},"// 判断是否没有加锁，没有加锁就用 CAS 加锁")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        "),c("span",{style:{color:"#6A737D"}},"// 条件二判断是否其它线程在当前线程给 as 赋值之后修改了 cells，这里不是线程安全的判断")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        "),c("span",{style:{color:"#F97583"}},"else"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#F97583"}},"if"),c("span",{style:{color:"#E1E4E8"}}," (cellsBusy "),c("span",{style:{color:"#F97583"}},"=="),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#79B8FF"}},"0"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#F97583"}},"&&"),c("span",{style:{color:"#E1E4E8"}}," cells "),c("span",{style:{color:"#F97583"}},"=="),c("span",{style:{color:"#E1E4E8"}}," as "),c("span",{style:{color:"#F97583"}},"&&"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#B392F0"}},"casCellsBusy"),c("span",{style:{color:"#E1E4E8"}},"()) {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"            "),c("span",{style:{color:"#6A737D"}},"// 初始化标志，开始 【初始化 cells 数组】")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"            "),c("span",{style:{color:"#F97583"}},"boolean"),c("span",{style:{color:"#E1E4E8"}}," init "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#79B8FF"}},"false"),c("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"            "),c("span",{style:{color:"#F97583"}},"try"),c("span",{style:{color:"#E1E4E8"}}," { ")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"               \t"),c("span",{style:{color:"#6A737D"}},"// 再次判断 cells == as 防止其它线程已经提前初始化了，当前线程再次初始化导致丢失数据")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"                "),c("span",{style:{color:"#6A737D"}},"// 因为这里是【线程安全的，重新检查，经典 DCL】")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"                "),c("span",{style:{color:"#F97583"}},"if"),c("span",{style:{color:"#E1E4E8"}}," (cells "),c("span",{style:{color:"#F97583"}},"=="),c("span",{style:{color:"#E1E4E8"}}," as) {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"                    "),c("span",{style:{color:"#F97583"}},"Cell"),c("span",{style:{color:"#E1E4E8"}},"[] rs "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#F97583"}},"new"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#F97583"}},"Cell"),c("span",{style:{color:"#E1E4E8"}},"["),c("span",{style:{color:"#79B8FF"}},"2"),c("span",{style:{color:"#E1E4E8"}},"];\t"),c("span",{style:{color:"#6A737D"}},"// 初始化数组大小为2")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"                    rs[h "),c("span",{style:{color:"#F97583"}},"&"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#79B8FF"}},"1"),c("span",{style:{color:"#E1E4E8"}},"] "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#F97583"}},"new"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#B392F0"}},"Cell"),c("span",{style:{color:"#E1E4E8"}},"(x);\t"),c("span",{style:{color:"#6A737D"}},"// 填充线程对应的cell")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"                    cells "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," rs;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"                    init "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#79B8FF"}},"true"),c("span",{style:{color:"#E1E4E8"}},";\t\t\t\t"),c("span",{style:{color:"#6A737D"}},"// 初始化成功，标记置为 true")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"                }")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"            } "),c("span",{style:{color:"#F97583"}},"finally"),c("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"                cellsBusy "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#79B8FF"}},"0"),c("span",{style:{color:"#E1E4E8"}},";\t\t\t\t\t"),c("span",{style:{color:"#6A737D"}},"// 解锁")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"            }")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"            "),c("span",{style:{color:"#F97583"}},"if"),c("span",{style:{color:"#E1E4E8"}}," (init)")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"                "),c("span",{style:{color:"#F97583"}},"break"),c("span",{style:{color:"#E1E4E8"}},";\t\t\t\t\t\t\t"),c("span",{style:{color:"#6A737D"}},"// 初始化成功直接跳出自旋")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        }")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        "),c("span",{style:{color:"#6A737D"}},"// 【CASE3】: 运行到这说明其他线程在初始化 cells，当前线程将值累加到 base，累加成功直接结束自旋")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        "),c("span",{style:{color:"#F97583"}},"else"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#F97583"}},"if"),c("span",{style:{color:"#E1E4E8"}}," ("),c("span",{style:{color:"#B392F0"}},"casBase"),c("span",{style:{color:"#E1E4E8"}},"(v "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," base, ((fn "),c("span",{style:{color:"#F97583"}},"=="),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#79B8FF"}},"null"),c("span",{style:{color:"#E1E4E8"}},") "),c("span",{style:{color:"#F97583"}},"?"),c("span",{style:{color:"#E1E4E8"}}," v "),c("span",{style:{color:"#F97583"}},"+"),c("span",{style:{color:"#E1E4E8"}}," x "),c("span",{style:{color:"#F97583"}},":")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"                                    fn."),c("span",{style:{color:"#B392F0"}},"applyAsLong"),c("span",{style:{color:"#E1E4E8"}},"(v, x))))")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"            "),c("span",{style:{color:"#F97583"}},"break"),c("span",{style:{color:"#E1E4E8"}},"; ")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"}")])])]),c("pre",{class:"shiki github-light vp-code-light"},[c("code",null,[c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"// \t\t\t\t\t\t\tx  \t\t\tnull \t\t\tfalse | true")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#D73A49"}},"final"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#D73A49"}},"void"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#6F42C1"}},"longAccumulate"),c("span",{style:{color:"#24292E"}},"("),c("span",{style:{color:"#D73A49"}},"long"),c("span",{style:{color:"#24292E"}}," x, LongBinaryOperator fn, "),c("span",{style:{color:"#D73A49"}},"boolean"),c("span",{style:{color:"#24292E"}}," wasUncontended) {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#D73A49"}},"int"),c("span",{style:{color:"#24292E"}}," h;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#6A737D"}},"// 当前线程还没有对应的 cell, 需要随机生成一个 hash 值用来将当前线程绑定到 cell")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#D73A49"}},"if"),c("span",{style:{color:"#24292E"}}," ((h "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#6F42C1"}},"getProbe"),c("span",{style:{color:"#24292E"}},"()) "),c("span",{style:{color:"#D73A49"}},"=="),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#005CC5"}},"0"),c("span",{style:{color:"#24292E"}},") {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        "),c("span",{style:{color:"#6A737D"}},"// 初始化 probe，获取 hash 值")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        ThreadLocalRandom."),c("span",{style:{color:"#6F42C1"}},"current"),c("span",{style:{color:"#24292E"}},"(); ")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        h "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#6F42C1"}},"getProbe"),c("span",{style:{color:"#24292E"}},"();\t")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        "),c("span",{style:{color:"#6A737D"}},"// 默认情况下 当前线程肯定是写入到了 cells[0] 位置，不把它当做一次真正的竞争")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        wasUncontended "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#005CC5"}},"true"),c("span",{style:{color:"#24292E"}},";")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    }")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#6A737D"}},"// 表示【扩容意向】，false 一定不会扩容，true 可能会扩容")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#D73A49"}},"boolean"),c("span",{style:{color:"#24292E"}}," collide "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#005CC5"}},"false"),c("span",{style:{color:"#24292E"}},"; ")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#6A737D"}},"//自旋")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#D73A49"}},"for"),c("span",{style:{color:"#24292E"}}," (;;) {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        "),c("span",{style:{color:"#6A737D"}},"// as 表示cells引用，a 表示当前线程命中的 cell，n 表示 cells 数组长度，v 表示 期望值")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        "),c("span",{style:{color:"#D73A49"}},"Cell"),c("span",{style:{color:"#24292E"}},"[] as; Cell a; "),c("span",{style:{color:"#D73A49"}},"int"),c("span",{style:{color:"#24292E"}}," n; "),c("span",{style:{color:"#D73A49"}},"long"),c("span",{style:{color:"#24292E"}}," v;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        "),c("span",{style:{color:"#6A737D"}},"// 【CASE1】: 表示 cells 已经初始化了，当前线程应该将数据写入到对应的 cell 中")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        "),c("span",{style:{color:"#D73A49"}},"if"),c("span",{style:{color:"#24292E"}}," ((as "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," cells) "),c("span",{style:{color:"#D73A49"}},"!="),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#005CC5"}},"null"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#D73A49"}},"&&"),c("span",{style:{color:"#24292E"}}," (n "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," as.length) "),c("span",{style:{color:"#D73A49"}},">"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#005CC5"}},"0"),c("span",{style:{color:"#24292E"}},") {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"            "),c("span",{style:{color:"#6A737D"}},"// CASE1.1: true 表示当前线程对应的索引下标的 Cell 为 null，需要创建 new Cell")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"            "),c("span",{style:{color:"#D73A49"}},"if"),c("span",{style:{color:"#24292E"}}," ((a "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," as[(n "),c("span",{style:{color:"#D73A49"}},"-"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#005CC5"}},"1"),c("span",{style:{color:"#24292E"}},") "),c("span",{style:{color:"#D73A49"}},"&"),c("span",{style:{color:"#24292E"}}," h]) "),c("span",{style:{color:"#D73A49"}},"=="),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#005CC5"}},"null"),c("span",{style:{color:"#24292E"}},") {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"                "),c("span",{style:{color:"#6A737D"}},"// 判断 cellsBusy 是否被锁")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"                "),c("span",{style:{color:"#D73A49"}},"if"),c("span",{style:{color:"#24292E"}}," (cellsBusy "),c("span",{style:{color:"#D73A49"}},"=="),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#005CC5"}},"0"),c("span",{style:{color:"#24292E"}},") {   ")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"                    "),c("span",{style:{color:"#6A737D"}},"// 创建 cell, 初始累加值为 x")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"                    Cell r "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#D73A49"}},"new"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#6F42C1"}},"Cell"),c("span",{style:{color:"#24292E"}},"(x);  ")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"                    "),c("span",{style:{color:"#6A737D"}},"// 加锁")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"                    "),c("span",{style:{color:"#D73A49"}},"if"),c("span",{style:{color:"#24292E"}}," (cellsBusy "),c("span",{style:{color:"#D73A49"}},"=="),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#005CC5"}},"0"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#D73A49"}},"&&"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#6F42C1"}},"casCellsBusy"),c("span",{style:{color:"#24292E"}},"()) {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"                        "),c("span",{style:{color:"#6A737D"}},"// 创建成功标记，进入【创建 cell 逻辑】")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"                        "),c("span",{style:{color:"#D73A49"}},"boolean"),c("span",{style:{color:"#24292E"}}," created "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#005CC5"}},"false"),c("span",{style:{color:"#24292E"}},";\t")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"                        "),c("span",{style:{color:"#D73A49"}},"try"),c("span",{style:{color:"#24292E"}}," {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"                            "),c("span",{style:{color:"#D73A49"}},"Cell"),c("span",{style:{color:"#24292E"}},"[] rs; "),c("span",{style:{color:"#D73A49"}},"int"),c("span",{style:{color:"#24292E"}}," m, j;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"                            "),c("span",{style:{color:"#6A737D"}},"// 把当前 cells 数组赋值给 rs，并且不为 null")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"                            "),c("span",{style:{color:"#D73A49"}},"if"),c("span",{style:{color:"#24292E"}}," ((rs "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," cells) "),c("span",{style:{color:"#D73A49"}},"!="),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#005CC5"}},"null"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#D73A49"}},"&&")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"                                (m "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," rs.length) "),c("span",{style:{color:"#D73A49"}},">"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#005CC5"}},"0"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#D73A49"}},"&&")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"                                "),c("span",{style:{color:"#6A737D"}},"// 再次判断防止其它线程初始化过该位置，当前线程再次初始化该位置会造成数据丢失")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"                                "),c("span",{style:{color:"#6A737D"}},"// 因为这里是线程安全的判断，进行的逻辑不会被其他线程影响")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"                                rs[j "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," (m "),c("span",{style:{color:"#D73A49"}},"-"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#005CC5"}},"1"),c("span",{style:{color:"#24292E"}},") "),c("span",{style:{color:"#D73A49"}},"&"),c("span",{style:{color:"#24292E"}}," h] "),c("span",{style:{color:"#D73A49"}},"=="),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#005CC5"}},"null"),c("span",{style:{color:"#24292E"}},") {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"                                "),c("span",{style:{color:"#6A737D"}},"// 把新创建的 cell 填充至当前位置")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"                                rs[j] "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," r;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"                                created "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#005CC5"}},"true"),c("span",{style:{color:"#24292E"}},";\t"),c("span",{style:{color:"#6A737D"}},"// 表示创建完成")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"                            }")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"                        } "),c("span",{style:{color:"#D73A49"}},"finally"),c("span",{style:{color:"#24292E"}}," {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"                            cellsBusy "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#005CC5"}},"0"),c("span",{style:{color:"#24292E"}},";\t\t"),c("span",{style:{color:"#6A737D"}},"// 解锁")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"                        }")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"                        "),c("span",{style:{color:"#D73A49"}},"if"),c("span",{style:{color:"#24292E"}}," (created)\t\t\t"),c("span",{style:{color:"#6A737D"}},"// true 表示创建完成，可以推出循环了")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"                            "),c("span",{style:{color:"#D73A49"}},"break"),c("span",{style:{color:"#24292E"}},";")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"                        "),c("span",{style:{color:"#D73A49"}},"continue"),c("span",{style:{color:"#24292E"}},";")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"                    }")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"                }")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"                collide "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#005CC5"}},"false"),c("span",{style:{color:"#24292E"}},";")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"            }")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"            "),c("span",{style:{color:"#6A737D"}},"// CASE1.2: 条件成立说明线程对应的 cell 有竞争, 改变线程对应的 cell 来重试 cas")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"            "),c("span",{style:{color:"#D73A49"}},"else"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#D73A49"}},"if"),c("span",{style:{color:"#24292E"}}," ("),c("span",{style:{color:"#D73A49"}},"!"),c("span",{style:{color:"#24292E"}},"wasUncontended)")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"                wasUncontended "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#005CC5"}},"true"),c("span",{style:{color:"#24292E"}},";")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"            "),c("span",{style:{color:"#6A737D"}},"// CASE 1.3: 当前线程 rehash 过，如果新命中的 cell 不为空，就尝试累加，false 说明新命中也有竞争")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"            "),c("span",{style:{color:"#D73A49"}},"else"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#D73A49"}},"if"),c("span",{style:{color:"#24292E"}}," (a."),c("span",{style:{color:"#6F42C1"}},"cas"),c("span",{style:{color:"#24292E"}},"(v "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," a.value, ((fn "),c("span",{style:{color:"#D73A49"}},"=="),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#005CC5"}},"null"),c("span",{style:{color:"#24292E"}},") "),c("span",{style:{color:"#D73A49"}},"?"),c("span",{style:{color:"#24292E"}}," v "),c("span",{style:{color:"#D73A49"}},"+"),c("span",{style:{color:"#24292E"}}," x "),c("span",{style:{color:"#D73A49"}},":"),c("span",{style:{color:"#24292E"}}," fn."),c("span",{style:{color:"#6F42C1"}},"applyAsLong"),c("span",{style:{color:"#24292E"}},"(v, x))))")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"                "),c("span",{style:{color:"#D73A49"}},"break"),c("span",{style:{color:"#24292E"}},";")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"            "),c("span",{style:{color:"#6A737D"}},"// CASE 1.4: cells 长度已经超过了最大长度 CPU 内核的数量或者已经扩容")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"            "),c("span",{style:{color:"#D73A49"}},"else"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#D73A49"}},"if"),c("span",{style:{color:"#24292E"}}," (n "),c("span",{style:{color:"#D73A49"}},">="),c("span",{style:{color:"#24292E"}}," NCPU "),c("span",{style:{color:"#D73A49"}},"||"),c("span",{style:{color:"#24292E"}}," cells "),c("span",{style:{color:"#D73A49"}},"!="),c("span",{style:{color:"#24292E"}}," as)")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"                collide "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#005CC5"}},"false"),c("span",{style:{color:"#24292E"}},"; \t\t"),c("span",{style:{color:"#6A737D"}},"// 扩容意向改为false，【表示不能扩容了】")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"            "),c("span",{style:{color:"#6A737D"}},"// CASE 1.5: 更改扩容意向，如果 n >= NCPU，这里就永远不会执行到，case1.4 永远先于 1.5 执行")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"            "),c("span",{style:{color:"#D73A49"}},"else"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#D73A49"}},"if"),c("span",{style:{color:"#24292E"}}," ("),c("span",{style:{color:"#D73A49"}},"!"),c("span",{style:{color:"#24292E"}},"collide)")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"                collide "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#005CC5"}},"true"),c("span",{style:{color:"#24292E"}},";")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"            "),c("span",{style:{color:"#6A737D"}},"// CASE 1.6: 【扩容逻辑】，进行加锁")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"            "),c("span",{style:{color:"#D73A49"}},"else"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#D73A49"}},"if"),c("span",{style:{color:"#24292E"}}," (cellsBusy "),c("span",{style:{color:"#D73A49"}},"=="),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#005CC5"}},"0"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#D73A49"}},"&&"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#6F42C1"}},"casCellsBusy"),c("span",{style:{color:"#24292E"}},"()) {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"                "),c("span",{style:{color:"#D73A49"}},"try"),c("span",{style:{color:"#24292E"}}," {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"                    "),c("span",{style:{color:"#6A737D"}},"// 线程安全的检查，防止期间被其他线程扩容了")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"                    "),c("span",{style:{color:"#D73A49"}},"if"),c("span",{style:{color:"#24292E"}}," (cells "),c("span",{style:{color:"#D73A49"}},"=="),c("span",{style:{color:"#24292E"}}," as) {     ")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"                        "),c("span",{style:{color:"#6A737D"}},"// 扩容为以前的 2 倍")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"                        "),c("span",{style:{color:"#D73A49"}},"Cell"),c("span",{style:{color:"#24292E"}},"[] rs "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#D73A49"}},"new"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#D73A49"}},"Cell"),c("span",{style:{color:"#24292E"}},"[n "),c("span",{style:{color:"#D73A49"}},"<<"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#005CC5"}},"1"),c("span",{style:{color:"#24292E"}},"];")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"                        "),c("span",{style:{color:"#6A737D"}},"// 遍历移动值")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"                        "),c("span",{style:{color:"#D73A49"}},"for"),c("span",{style:{color:"#24292E"}}," ("),c("span",{style:{color:"#D73A49"}},"int"),c("span",{style:{color:"#24292E"}}," i "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#005CC5"}},"0"),c("span",{style:{color:"#24292E"}},"; i "),c("span",{style:{color:"#D73A49"}},"<"),c("span",{style:{color:"#24292E"}}," n; "),c("span",{style:{color:"#D73A49"}},"++"),c("span",{style:{color:"#24292E"}},"i)")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"                            rs[i] "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," as[i];")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"                        "),c("span",{style:{color:"#6A737D"}},"// 把扩容后的引用给 cells")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"                        cells "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," rs;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"                    }")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"                } "),c("span",{style:{color:"#D73A49"}},"finally"),c("span",{style:{color:"#24292E"}}," {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"                    cellsBusy "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#005CC5"}},"0"),c("span",{style:{color:"#24292E"}},";\t"),c("span",{style:{color:"#6A737D"}},"// 解锁")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"                }")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"                collide "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#005CC5"}},"false"),c("span",{style:{color:"#24292E"}},";\t"),c("span",{style:{color:"#6A737D"}},"// 扩容意向改为 false，表示不扩容了")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"                "),c("span",{style:{color:"#D73A49"}},"continue"),c("span",{style:{color:"#24292E"}},";")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"            }")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"            "),c("span",{style:{color:"#6A737D"}},"// 重置当前线程 Hash 值，这就是【分段迁移机制】")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"            h "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#6F42C1"}},"advanceProbe"),c("span",{style:{color:"#24292E"}},"(h);")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        }")]),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        "),c("span",{style:{color:"#6A737D"}},"// 【CASE2】: 运行到这说明 cells 还未初始化，as 为null")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        "),c("span",{style:{color:"#6A737D"}},"// 判断是否没有加锁，没有加锁就用 CAS 加锁")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        "),c("span",{style:{color:"#6A737D"}},"// 条件二判断是否其它线程在当前线程给 as 赋值之后修改了 cells，这里不是线程安全的判断")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        "),c("span",{style:{color:"#D73A49"}},"else"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#D73A49"}},"if"),c("span",{style:{color:"#24292E"}}," (cellsBusy "),c("span",{style:{color:"#D73A49"}},"=="),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#005CC5"}},"0"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#D73A49"}},"&&"),c("span",{style:{color:"#24292E"}}," cells "),c("span",{style:{color:"#D73A49"}},"=="),c("span",{style:{color:"#24292E"}}," as "),c("span",{style:{color:"#D73A49"}},"&&"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#6F42C1"}},"casCellsBusy"),c("span",{style:{color:"#24292E"}},"()) {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"            "),c("span",{style:{color:"#6A737D"}},"// 初始化标志，开始 【初始化 cells 数组】")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"            "),c("span",{style:{color:"#D73A49"}},"boolean"),c("span",{style:{color:"#24292E"}}," init "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#005CC5"}},"false"),c("span",{style:{color:"#24292E"}},";")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"            "),c("span",{style:{color:"#D73A49"}},"try"),c("span",{style:{color:"#24292E"}}," { ")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"               \t"),c("span",{style:{color:"#6A737D"}},"// 再次判断 cells == as 防止其它线程已经提前初始化了，当前线程再次初始化导致丢失数据")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"                "),c("span",{style:{color:"#6A737D"}},"// 因为这里是【线程安全的，重新检查，经典 DCL】")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"                "),c("span",{style:{color:"#D73A49"}},"if"),c("span",{style:{color:"#24292E"}}," (cells "),c("span",{style:{color:"#D73A49"}},"=="),c("span",{style:{color:"#24292E"}}," as) {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"                    "),c("span",{style:{color:"#D73A49"}},"Cell"),c("span",{style:{color:"#24292E"}},"[] rs "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#D73A49"}},"new"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#D73A49"}},"Cell"),c("span",{style:{color:"#24292E"}},"["),c("span",{style:{color:"#005CC5"}},"2"),c("span",{style:{color:"#24292E"}},"];\t"),c("span",{style:{color:"#6A737D"}},"// 初始化数组大小为2")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"                    rs[h "),c("span",{style:{color:"#D73A49"}},"&"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#005CC5"}},"1"),c("span",{style:{color:"#24292E"}},"] "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#D73A49"}},"new"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#6F42C1"}},"Cell"),c("span",{style:{color:"#24292E"}},"(x);\t"),c("span",{style:{color:"#6A737D"}},"// 填充线程对应的cell")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"                    cells "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," rs;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"                    init "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#005CC5"}},"true"),c("span",{style:{color:"#24292E"}},";\t\t\t\t"),c("span",{style:{color:"#6A737D"}},"// 初始化成功，标记置为 true")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"                }")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"            } "),c("span",{style:{color:"#D73A49"}},"finally"),c("span",{style:{color:"#24292E"}}," {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"                cellsBusy "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#005CC5"}},"0"),c("span",{style:{color:"#24292E"}},";\t\t\t\t\t"),c("span",{style:{color:"#6A737D"}},"// 解锁")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"            }")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"            "),c("span",{style:{color:"#D73A49"}},"if"),c("span",{style:{color:"#24292E"}}," (init)")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"                "),c("span",{style:{color:"#D73A49"}},"break"),c("span",{style:{color:"#24292E"}},";\t\t\t\t\t\t\t"),c("span",{style:{color:"#6A737D"}},"// 初始化成功直接跳出自旋")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        }")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        "),c("span",{style:{color:"#6A737D"}},"// 【CASE3】: 运行到这说明其他线程在初始化 cells，当前线程将值累加到 base，累加成功直接结束自旋")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        "),c("span",{style:{color:"#D73A49"}},"else"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#D73A49"}},"if"),c("span",{style:{color:"#24292E"}}," ("),c("span",{style:{color:"#6F42C1"}},"casBase"),c("span",{style:{color:"#24292E"}},"(v "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," base, ((fn "),c("span",{style:{color:"#D73A49"}},"=="),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#005CC5"}},"null"),c("span",{style:{color:"#24292E"}},") "),c("span",{style:{color:"#D73A49"}},"?"),c("span",{style:{color:"#24292E"}}," v "),c("span",{style:{color:"#D73A49"}},"+"),c("span",{style:{color:"#24292E"}}," x "),c("span",{style:{color:"#D73A49"}},":")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"                                    fn."),c("span",{style:{color:"#6F42C1"}},"applyAsLong"),c("span",{style:{color:"#24292E"}},"(v, x))))")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"            "),c("span",{style:{color:"#D73A49"}},"break"),c("span",{style:{color:"#24292E"}},"; ")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    }")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"}")])])]),c("button",{class:"collapse"})])]),c("li",null,[c("p",null,[p("sum：获取最终结果通过 sum 整合，"),c("strong",null,"保证最终一致性，不保证强一致性")]),c("div",{style:{"max-height":"300px"},class:"language-java"},[c("button",{title:"Copy Code",class:"copy"}),c("span",{class:"lang"},"java"),c("pre",{class:"shiki github-dark vp-code-dark"},[c("code",null,[c("span",{class:"line"},[c("span",{style:{color:"#F97583"}},"public"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#F97583"}},"long"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#B392F0"}},"sum"),c("span",{style:{color:"#E1E4E8"}},"() {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#F97583"}},"Cell"),c("span",{style:{color:"#E1E4E8"}},"[] as "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," cells; Cell a;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#F97583"}},"long"),c("span",{style:{color:"#E1E4E8"}}," sum "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," base;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#F97583"}},"if"),c("span",{style:{color:"#E1E4E8"}}," (as "),c("span",{style:{color:"#F97583"}},"!="),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#79B8FF"}},"null"),c("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        "),c("span",{style:{color:"#6A737D"}},"// 遍历 累加")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        "),c("span",{style:{color:"#F97583"}},"for"),c("span",{style:{color:"#E1E4E8"}}," ("),c("span",{style:{color:"#F97583"}},"int"),c("span",{style:{color:"#E1E4E8"}}," i "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#79B8FF"}},"0"),c("span",{style:{color:"#E1E4E8"}},"; i "),c("span",{style:{color:"#F97583"}},"<"),c("span",{style:{color:"#E1E4E8"}}," as.length; "),c("span",{style:{color:"#F97583"}},"++"),c("span",{style:{color:"#E1E4E8"}},"i) {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"            "),c("span",{style:{color:"#F97583"}},"if"),c("span",{style:{color:"#E1E4E8"}}," ((a "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," as[i]) "),c("span",{style:{color:"#F97583"}},"!="),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#79B8FF"}},"null"),c("span",{style:{color:"#E1E4E8"}},")")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"                sum "),c("span",{style:{color:"#F97583"}},"+="),c("span",{style:{color:"#E1E4E8"}}," a.value;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        }")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#F97583"}},"return"),c("span",{style:{color:"#E1E4E8"}}," sum;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"}")])])]),c("pre",{class:"shiki github-light vp-code-light"},[c("code",null,[c("span",{class:"line"},[c("span",{style:{color:"#D73A49"}},"public"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#D73A49"}},"long"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#6F42C1"}},"sum"),c("span",{style:{color:"#24292E"}},"() {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#D73A49"}},"Cell"),c("span",{style:{color:"#24292E"}},"[] as "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," cells; Cell a;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#D73A49"}},"long"),c("span",{style:{color:"#24292E"}}," sum "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," base;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#D73A49"}},"if"),c("span",{style:{color:"#24292E"}}," (as "),c("span",{style:{color:"#D73A49"}},"!="),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#005CC5"}},"null"),c("span",{style:{color:"#24292E"}},") {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        "),c("span",{style:{color:"#6A737D"}},"// 遍历 累加")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        "),c("span",{style:{color:"#D73A49"}},"for"),c("span",{style:{color:"#24292E"}}," ("),c("span",{style:{color:"#D73A49"}},"int"),c("span",{style:{color:"#24292E"}}," i "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#005CC5"}},"0"),c("span",{style:{color:"#24292E"}},"; i "),c("span",{style:{color:"#D73A49"}},"<"),c("span",{style:{color:"#24292E"}}," as.length; "),c("span",{style:{color:"#D73A49"}},"++"),c("span",{style:{color:"#24292E"}},"i) {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"            "),c("span",{style:{color:"#D73A49"}},"if"),c("span",{style:{color:"#24292E"}}," ((a "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," as[i]) "),c("span",{style:{color:"#D73A49"}},"!="),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#005CC5"}},"null"),c("span",{style:{color:"#24292E"}},")")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"                sum "),c("span",{style:{color:"#D73A49"}},"+="),c("span",{style:{color:"#24292E"}}," a.value;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        }")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    }")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#D73A49"}},"return"),c("span",{style:{color:"#24292E"}}," sum;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"}")])])]),c("button",{class:"collapse"})])])],-1),ys=c("hr",null,null,-1),is={id:"aba",tabindex:"-1"},Fs=c("p",null,"ABA 问题：当进行获取主内存值时，该内存值在写入主内存时已经被修改了 N 次，但是最终又改成原来的值",-1),us=c("p",null,[p("其他线程先把 A 改成 B 又改回 A，主线程"),c("strong",null,"仅能判断出共享变量的值与最初值 A 是否相同"),p("，不能感知到这种从 A 改为 B 又 改回 A 的情况，这时 CAS 虽然成功，但是过程存在问题")],-1),As={id:"atomicstampedreference",tabindex:"-1"},ds=c("strong",null,"AtomicStampedReference",-1),Ds=c("ul",null,[c("li",null,[c("p",null,"构造方法："),c("ul",null,[c("li",null,[c("code",null,"public AtomicStampedReference(V initialRef, int initialStamp)"),p("：初始值和初始版本号")])])]),c("li",null,[c("p",null,"常用API："),c("ul",null,[c("li",null,[c("code",null," public boolean compareAndSet(V expectedReference, V newReference, int expectedStamp, int newStamp)"),p("："),c("strong",null,"期望引用和期望版本号都一致"),p("才进行 CAS 修改数据")]),c("li",null,[c("code",null,"public void set(V newReference, int newStamp)"),p("：设置值和版本号")]),c("li",null,[c("code",null,"public V getReference()"),p("：返回引用的值")]),c("li",null,[c("code",null,"public int getStamp()"),p("：返回当前版本号")])])])],-1),hs=c("div",{style:{"max-height":"300px"},class:"language-java"},[c("button",{title:"Copy Code",class:"copy"}),c("span",{class:"lang"},"java"),c("pre",{class:"shiki github-dark vp-code-dark"},[c("code",null,[c("span",{class:"line"},[c("span",{style:{color:"#F97583"}},"public"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#F97583"}},"static"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#F97583"}},"void"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#B392F0"}},"main"),c("span",{style:{color:"#E1E4E8"}},"("),c("span",{style:{color:"#F97583"}},"String"),c("span",{style:{color:"#E1E4E8"}},"[] args) {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    AtomicStampedReference<"),c("span",{style:{color:"#F97583"}},"Integer"),c("span",{style:{color:"#E1E4E8"}},"> atomicReference "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#F97583"}},"new"),c("span",{style:{color:"#E1E4E8"}}," AtomicStampedReference<>("),c("span",{style:{color:"#79B8FF"}},"100"),c("span",{style:{color:"#E1E4E8"}},","),c("span",{style:{color:"#79B8FF"}},"1"),c("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#F97583"}},"int"),c("span",{style:{color:"#E1E4E8"}}," startStamp "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," atomicReference."),c("span",{style:{color:"#B392F0"}},"getStamp"),c("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#F97583"}},"new"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#B392F0"}},"Thread"),c("span",{style:{color:"#E1E4E8"}},"(() "),c("span",{style:{color:"#F97583"}},"->"),c("span",{style:{color:"#E1E4E8"}},"{")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        "),c("span",{style:{color:"#F97583"}},"int"),c("span",{style:{color:"#E1E4E8"}}," stamp "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," atomicReference."),c("span",{style:{color:"#B392F0"}},"getStamp"),c("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        atomicReference."),c("span",{style:{color:"#B392F0"}},"compareAndSet"),c("span",{style:{color:"#E1E4E8"}},"("),c("span",{style:{color:"#79B8FF"}},"100"),c("span",{style:{color:"#E1E4E8"}},", "),c("span",{style:{color:"#79B8FF"}},"101"),c("span",{style:{color:"#E1E4E8"}},", stamp, stamp "),c("span",{style:{color:"#F97583"}},"+"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#79B8FF"}},"1"),c("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        stamp "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," atomicReference."),c("span",{style:{color:"#B392F0"}},"getStamp"),c("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        atomicReference."),c("span",{style:{color:"#B392F0"}},"compareAndSet"),c("span",{style:{color:"#E1E4E8"}},"("),c("span",{style:{color:"#79B8FF"}},"101"),c("span",{style:{color:"#E1E4E8"}},", "),c("span",{style:{color:"#79B8FF"}},"100"),c("span",{style:{color:"#E1E4E8"}},", stamp, stamp "),c("span",{style:{color:"#F97583"}},"+"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#79B8FF"}},"1"),c("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    },"),c("span",{style:{color:"#9ECBFF"}},'"t1"'),c("span",{style:{color:"#E1E4E8"}},")."),c("span",{style:{color:"#B392F0"}},"start"),c("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#F97583"}},"new"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#B392F0"}},"Thread"),c("span",{style:{color:"#E1E4E8"}},"(() "),c("span",{style:{color:"#F97583"}},"->"),c("span",{style:{color:"#E1E4E8"}},"{")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        "),c("span",{style:{color:"#F97583"}},"try"),c("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"            Thread."),c("span",{style:{color:"#B392F0"}},"sleep"),c("span",{style:{color:"#E1E4E8"}},"("),c("span",{style:{color:"#79B8FF"}},"1000"),c("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        } "),c("span",{style:{color:"#F97583"}},"catch"),c("span",{style:{color:"#E1E4E8"}}," (InterruptedException "),c("span",{style:{color:"#FFAB70"}},"e"),c("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"            e."),c("span",{style:{color:"#B392F0"}},"printStackTrace"),c("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        }")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        "),c("span",{style:{color:"#F97583"}},"if"),c("span",{style:{color:"#E1E4E8"}}," ("),c("span",{style:{color:"#F97583"}},"!"),c("span",{style:{color:"#E1E4E8"}},"atomicReference."),c("span",{style:{color:"#B392F0"}},"compareAndSet"),c("span",{style:{color:"#E1E4E8"}},"("),c("span",{style:{color:"#79B8FF"}},"100"),c("span",{style:{color:"#E1E4E8"}},", "),c("span",{style:{color:"#79B8FF"}},"200"),c("span",{style:{color:"#E1E4E8"}},", startStamp, startStamp "),c("span",{style:{color:"#F97583"}},"+"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#79B8FF"}},"1"),c("span",{style:{color:"#E1E4E8"}},")) {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"            System.out."),c("span",{style:{color:"#B392F0"}},"println"),c("span",{style:{color:"#E1E4E8"}},"(atomicReference."),c("span",{style:{color:"#B392F0"}},"getReference"),c("span",{style:{color:"#E1E4E8"}},"());"),c("span",{style:{color:"#6A737D"}},"//100")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"            System.out."),c("span",{style:{color:"#B392F0"}},"println"),c("span",{style:{color:"#E1E4E8"}},"(Thread."),c("span",{style:{color:"#B392F0"}},"currentThread"),c("span",{style:{color:"#E1E4E8"}},"()."),c("span",{style:{color:"#B392F0"}},"getName"),c("span",{style:{color:"#E1E4E8"}},"() "),c("span",{style:{color:"#F97583"}},"+"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#9ECBFF"}},'"线程修改失败"'),c("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        }")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    },"),c("span",{style:{color:"#9ECBFF"}},'"t2"'),c("span",{style:{color:"#E1E4E8"}},")."),c("span",{style:{color:"#B392F0"}},"start"),c("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"}")])])]),c("pre",{class:"shiki github-light vp-code-light"},[c("code",null,[c("span",{class:"line"},[c("span",{style:{color:"#D73A49"}},"public"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#D73A49"}},"static"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#D73A49"}},"void"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#6F42C1"}},"main"),c("span",{style:{color:"#24292E"}},"("),c("span",{style:{color:"#D73A49"}},"String"),c("span",{style:{color:"#24292E"}},"[] args) {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    AtomicStampedReference<"),c("span",{style:{color:"#D73A49"}},"Integer"),c("span",{style:{color:"#24292E"}},"> atomicReference "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#D73A49"}},"new"),c("span",{style:{color:"#24292E"}}," AtomicStampedReference<>("),c("span",{style:{color:"#005CC5"}},"100"),c("span",{style:{color:"#24292E"}},","),c("span",{style:{color:"#005CC5"}},"1"),c("span",{style:{color:"#24292E"}},");")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#D73A49"}},"int"),c("span",{style:{color:"#24292E"}}," startStamp "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," atomicReference."),c("span",{style:{color:"#6F42C1"}},"getStamp"),c("span",{style:{color:"#24292E"}},"();")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#D73A49"}},"new"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#6F42C1"}},"Thread"),c("span",{style:{color:"#24292E"}},"(() "),c("span",{style:{color:"#D73A49"}},"->"),c("span",{style:{color:"#24292E"}},"{")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        "),c("span",{style:{color:"#D73A49"}},"int"),c("span",{style:{color:"#24292E"}}," stamp "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," atomicReference."),c("span",{style:{color:"#6F42C1"}},"getStamp"),c("span",{style:{color:"#24292E"}},"();")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        atomicReference."),c("span",{style:{color:"#6F42C1"}},"compareAndSet"),c("span",{style:{color:"#24292E"}},"("),c("span",{style:{color:"#005CC5"}},"100"),c("span",{style:{color:"#24292E"}},", "),c("span",{style:{color:"#005CC5"}},"101"),c("span",{style:{color:"#24292E"}},", stamp, stamp "),c("span",{style:{color:"#D73A49"}},"+"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#005CC5"}},"1"),c("span",{style:{color:"#24292E"}},");")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        stamp "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," atomicReference."),c("span",{style:{color:"#6F42C1"}},"getStamp"),c("span",{style:{color:"#24292E"}},"();")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        atomicReference."),c("span",{style:{color:"#6F42C1"}},"compareAndSet"),c("span",{style:{color:"#24292E"}},"("),c("span",{style:{color:"#005CC5"}},"101"),c("span",{style:{color:"#24292E"}},", "),c("span",{style:{color:"#005CC5"}},"100"),c("span",{style:{color:"#24292E"}},", stamp, stamp "),c("span",{style:{color:"#D73A49"}},"+"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#005CC5"}},"1"),c("span",{style:{color:"#24292E"}},");")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    },"),c("span",{style:{color:"#032F62"}},'"t1"'),c("span",{style:{color:"#24292E"}},")."),c("span",{style:{color:"#6F42C1"}},"start"),c("span",{style:{color:"#24292E"}},"();")]),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#D73A49"}},"new"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#6F42C1"}},"Thread"),c("span",{style:{color:"#24292E"}},"(() "),c("span",{style:{color:"#D73A49"}},"->"),c("span",{style:{color:"#24292E"}},"{")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        "),c("span",{style:{color:"#D73A49"}},"try"),c("span",{style:{color:"#24292E"}}," {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"            Thread."),c("span",{style:{color:"#6F42C1"}},"sleep"),c("span",{style:{color:"#24292E"}},"("),c("span",{style:{color:"#005CC5"}},"1000"),c("span",{style:{color:"#24292E"}},");")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        } "),c("span",{style:{color:"#D73A49"}},"catch"),c("span",{style:{color:"#24292E"}}," (InterruptedException "),c("span",{style:{color:"#E36209"}},"e"),c("span",{style:{color:"#24292E"}},") {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"            e."),c("span",{style:{color:"#6F42C1"}},"printStackTrace"),c("span",{style:{color:"#24292E"}},"();")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        }")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        "),c("span",{style:{color:"#D73A49"}},"if"),c("span",{style:{color:"#24292E"}}," ("),c("span",{style:{color:"#D73A49"}},"!"),c("span",{style:{color:"#24292E"}},"atomicReference."),c("span",{style:{color:"#6F42C1"}},"compareAndSet"),c("span",{style:{color:"#24292E"}},"("),c("span",{style:{color:"#005CC5"}},"100"),c("span",{style:{color:"#24292E"}},", "),c("span",{style:{color:"#005CC5"}},"200"),c("span",{style:{color:"#24292E"}},", startStamp, startStamp "),c("span",{style:{color:"#D73A49"}},"+"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#005CC5"}},"1"),c("span",{style:{color:"#24292E"}},")) {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"            System.out."),c("span",{style:{color:"#6F42C1"}},"println"),c("span",{style:{color:"#24292E"}},"(atomicReference."),c("span",{style:{color:"#6F42C1"}},"getReference"),c("span",{style:{color:"#24292E"}},"());"),c("span",{style:{color:"#6A737D"}},"//100")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"            System.out."),c("span",{style:{color:"#6F42C1"}},"println"),c("span",{style:{color:"#24292E"}},"(Thread."),c("span",{style:{color:"#6F42C1"}},"currentThread"),c("span",{style:{color:"#24292E"}},"()."),c("span",{style:{color:"#6F42C1"}},"getName"),c("span",{style:{color:"#24292E"}},"() "),c("span",{style:{color:"#D73A49"}},"+"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#032F62"}},'"线程修改失败"'),c("span",{style:{color:"#24292E"}},");")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        }")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    },"),c("span",{style:{color:"#032F62"}},'"t2"'),c("span",{style:{color:"#24292E"}},")."),c("span",{style:{color:"#6F42C1"}},"start"),c("span",{style:{color:"#24292E"}},"();")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"}")])])]),c("button",{class:"collapse"})],-1),gs=c("hr",null,null,-1),Cs={id:"atomicmarkablereference",tabindex:"-1"},bs=c("p",null,[p("AtomicStampedReference 可以给原子引用加上版本号，追踪原子引用整个的变化过程，如： A -> B -> A -> C ，通过AtomicStampedReference，我们可以知道，引用变量中途被更改了几次。 但是有时候，并不关心引用变量更改了几次，只是单纯的关心"),c("strong",null,"是否更改过"),p("，所以就有了 "),c("strong",null,"AtomicMarkableReference")],-1),ms=c("figure",null,[c("img",{alt:"image-20230714183156551",class:"lazy","data-src":"https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230714183156551.png"})],-1),vs=c("div",{style:{"max-height":"300px"},class:"language-java"},[c("button",{title:"Copy Code",class:"copy"}),c("span",{class:"lang"},"java"),c("pre",{class:"shiki github-dark vp-code-dark"},[c("code",null,[c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"@"),c("span",{style:{color:"#F97583"}},"Slf4j"),c("span",{style:{color:"#E1E4E8"}},"("),c("span",{style:{color:"#79B8FF"}},"topic"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#9ECBFF"}},'"c.Test38"'),c("span",{style:{color:"#E1E4E8"}},")")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#F97583"}},"public"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#F97583"}},"class"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#B392F0"}},"Test38"),c("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#F97583"}},"public"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#F97583"}},"static"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#F97583"}},"void"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#B392F0"}},"main"),c("span",{style:{color:"#E1E4E8"}},"("),c("span",{style:{color:"#F97583"}},"String"),c("span",{style:{color:"#E1E4E8"}},"[] "),c("span",{style:{color:"#FFAB70"}},"args"),c("span",{style:{color:"#E1E4E8"}},") "),c("span",{style:{color:"#F97583"}},"throws"),c("span",{style:{color:"#E1E4E8"}}," InterruptedException {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        GarbageBag bag "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#F97583"}},"new"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#B392F0"}},"GarbageBag"),c("span",{style:{color:"#E1E4E8"}},"("),c("span",{style:{color:"#9ECBFF"}},'"装满了垃圾"'),c("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        "),c("span",{style:{color:"#6A737D"}},"// 参数2 mark 可以看作一个标记，表示垃圾袋满了")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        AtomicMarkableReference<"),c("span",{style:{color:"#F97583"}},"GarbageBag"),c("span",{style:{color:"#E1E4E8"}},"> ref "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#F97583"}},"new"),c("span",{style:{color:"#E1E4E8"}}," AtomicMarkableReference<>(bag, "),c("span",{style:{color:"#79B8FF"}},"true"),c("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        log."),c("span",{style:{color:"#B392F0"}},"debug"),c("span",{style:{color:"#E1E4E8"}},"("),c("span",{style:{color:"#9ECBFF"}},'"start..."'),c("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        GarbageBag prev "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," ref."),c("span",{style:{color:"#B392F0"}},"getReference"),c("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        log."),c("span",{style:{color:"#B392F0"}},"debug"),c("span",{style:{color:"#E1E4E8"}},"(prev."),c("span",{style:{color:"#B392F0"}},"toString"),c("span",{style:{color:"#E1E4E8"}},"());")]),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        "),c("span",{style:{color:"#F97583"}},"new"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#B392F0"}},"Thread"),c("span",{style:{color:"#E1E4E8"}},"(() "),c("span",{style:{color:"#F97583"}},"->"),c("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"            log."),c("span",{style:{color:"#B392F0"}},"debug"),c("span",{style:{color:"#E1E4E8"}},"("),c("span",{style:{color:"#9ECBFF"}},'"start..."'),c("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"            bag."),c("span",{style:{color:"#B392F0"}},"setDesc"),c("span",{style:{color:"#E1E4E8"}},"("),c("span",{style:{color:"#9ECBFF"}},'"空垃圾袋"'),c("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"            ref."),c("span",{style:{color:"#B392F0"}},"compareAndSet"),c("span",{style:{color:"#E1E4E8"}},"(bag, bag, "),c("span",{style:{color:"#79B8FF"}},"true"),c("span",{style:{color:"#E1E4E8"}},", "),c("span",{style:{color:"#79B8FF"}},"false"),c("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"            log."),c("span",{style:{color:"#B392F0"}},"debug"),c("span",{style:{color:"#E1E4E8"}},"(bag."),c("span",{style:{color:"#B392F0"}},"toString"),c("span",{style:{color:"#E1E4E8"}},"());")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        },"),c("span",{style:{color:"#9ECBFF"}},'"保洁阿姨"'),c("span",{style:{color:"#E1E4E8"}},")."),c("span",{style:{color:"#B392F0"}},"start"),c("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        "),c("span",{style:{color:"#B392F0"}},"sleep"),c("span",{style:{color:"#E1E4E8"}},"("),c("span",{style:{color:"#79B8FF"}},"1"),c("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        log."),c("span",{style:{color:"#B392F0"}},"debug"),c("span",{style:{color:"#E1E4E8"}},"("),c("span",{style:{color:"#9ECBFF"}},'"想换一只新垃圾袋？"'),c("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        "),c("span",{style:{color:"#F97583"}},"boolean"),c("span",{style:{color:"#E1E4E8"}}," success "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," ref."),c("span",{style:{color:"#B392F0"}},"compareAndSet"),c("span",{style:{color:"#E1E4E8"}},"(prev, "),c("span",{style:{color:"#F97583"}},"new"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#B392F0"}},"GarbageBag"),c("span",{style:{color:"#E1E4E8"}},"("),c("span",{style:{color:"#9ECBFF"}},'"空垃圾袋"'),c("span",{style:{color:"#E1E4E8"}},"), "),c("span",{style:{color:"#79B8FF"}},"true"),c("span",{style:{color:"#E1E4E8"}},", "),c("span",{style:{color:"#79B8FF"}},"false"),c("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        log."),c("span",{style:{color:"#B392F0"}},"debug"),c("span",{style:{color:"#E1E4E8"}},"("),c("span",{style:{color:"#9ECBFF"}},'"换了么？"'),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#F97583"}},"+"),c("span",{style:{color:"#E1E4E8"}}," success);")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        log."),c("span",{style:{color:"#B392F0"}},"debug"),c("span",{style:{color:"#E1E4E8"}},"(ref."),c("span",{style:{color:"#B392F0"}},"getReference"),c("span",{style:{color:"#E1E4E8"}},"()."),c("span",{style:{color:"#B392F0"}},"toString"),c("span",{style:{color:"#E1E4E8"}},"());")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"}")]),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#F97583"}},"class"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#B392F0"}},"GarbageBag"),c("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    String desc;")]),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#F97583"}},"public"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#B392F0"}},"GarbageBag"),c("span",{style:{color:"#E1E4E8"}},"(String "),c("span",{style:{color:"#FFAB70"}},"desc"),c("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        "),c("span",{style:{color:"#79B8FF"}},"this"),c("span",{style:{color:"#E1E4E8"}},".desc "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," desc;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#F97583"}},"public"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#F97583"}},"void"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#B392F0"}},"setDesc"),c("span",{style:{color:"#E1E4E8"}},"(String "),c("span",{style:{color:"#FFAB70"}},"desc"),c("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        "),c("span",{style:{color:"#79B8FF"}},"this"),c("span",{style:{color:"#E1E4E8"}},".desc "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," desc;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    @"),c("span",{style:{color:"#F97583"}},"Override")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#F97583"}},"public"),c("span",{style:{color:"#E1E4E8"}}," String "),c("span",{style:{color:"#B392F0"}},"toString"),c("span",{style:{color:"#E1E4E8"}},"() {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        "),c("span",{style:{color:"#F97583"}},"return"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#79B8FF"}},"super"),c("span",{style:{color:"#E1E4E8"}},"."),c("span",{style:{color:"#B392F0"}},"toString"),c("span",{style:{color:"#E1E4E8"}},"() "),c("span",{style:{color:"#F97583"}},"+"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#9ECBFF"}},'" "'),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#F97583"}},"+"),c("span",{style:{color:"#E1E4E8"}}," desc;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"}")])])]),c("pre",{class:"shiki github-light vp-code-light"},[c("code",null,[c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"@"),c("span",{style:{color:"#D73A49"}},"Slf4j"),c("span",{style:{color:"#24292E"}},"("),c("span",{style:{color:"#005CC5"}},"topic"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#032F62"}},'"c.Test38"'),c("span",{style:{color:"#24292E"}},")")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#D73A49"}},"public"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#D73A49"}},"class"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#6F42C1"}},"Test38"),c("span",{style:{color:"#24292E"}}," {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#D73A49"}},"public"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#D73A49"}},"static"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#D73A49"}},"void"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#6F42C1"}},"main"),c("span",{style:{color:"#24292E"}},"("),c("span",{style:{color:"#D73A49"}},"String"),c("span",{style:{color:"#24292E"}},"[] "),c("span",{style:{color:"#E36209"}},"args"),c("span",{style:{color:"#24292E"}},") "),c("span",{style:{color:"#D73A49"}},"throws"),c("span",{style:{color:"#24292E"}}," InterruptedException {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        GarbageBag bag "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#D73A49"}},"new"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#6F42C1"}},"GarbageBag"),c("span",{style:{color:"#24292E"}},"("),c("span",{style:{color:"#032F62"}},'"装满了垃圾"'),c("span",{style:{color:"#24292E"}},");")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        "),c("span",{style:{color:"#6A737D"}},"// 参数2 mark 可以看作一个标记，表示垃圾袋满了")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        AtomicMarkableReference<"),c("span",{style:{color:"#D73A49"}},"GarbageBag"),c("span",{style:{color:"#24292E"}},"> ref "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#D73A49"}},"new"),c("span",{style:{color:"#24292E"}}," AtomicMarkableReference<>(bag, "),c("span",{style:{color:"#005CC5"}},"true"),c("span",{style:{color:"#24292E"}},");")]),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        log."),c("span",{style:{color:"#6F42C1"}},"debug"),c("span",{style:{color:"#24292E"}},"("),c("span",{style:{color:"#032F62"}},'"start..."'),c("span",{style:{color:"#24292E"}},");")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        GarbageBag prev "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," ref."),c("span",{style:{color:"#6F42C1"}},"getReference"),c("span",{style:{color:"#24292E"}},"();")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        log."),c("span",{style:{color:"#6F42C1"}},"debug"),c("span",{style:{color:"#24292E"}},"(prev."),c("span",{style:{color:"#6F42C1"}},"toString"),c("span",{style:{color:"#24292E"}},"());")]),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        "),c("span",{style:{color:"#D73A49"}},"new"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#6F42C1"}},"Thread"),c("span",{style:{color:"#24292E"}},"(() "),c("span",{style:{color:"#D73A49"}},"->"),c("span",{style:{color:"#24292E"}}," {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"            log."),c("span",{style:{color:"#6F42C1"}},"debug"),c("span",{style:{color:"#24292E"}},"("),c("span",{style:{color:"#032F62"}},'"start..."'),c("span",{style:{color:"#24292E"}},");")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"            bag."),c("span",{style:{color:"#6F42C1"}},"setDesc"),c("span",{style:{color:"#24292E"}},"("),c("span",{style:{color:"#032F62"}},'"空垃圾袋"'),c("span",{style:{color:"#24292E"}},");")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"            ref."),c("span",{style:{color:"#6F42C1"}},"compareAndSet"),c("span",{style:{color:"#24292E"}},"(bag, bag, "),c("span",{style:{color:"#005CC5"}},"true"),c("span",{style:{color:"#24292E"}},", "),c("span",{style:{color:"#005CC5"}},"false"),c("span",{style:{color:"#24292E"}},");")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"            log."),c("span",{style:{color:"#6F42C1"}},"debug"),c("span",{style:{color:"#24292E"}},"(bag."),c("span",{style:{color:"#6F42C1"}},"toString"),c("span",{style:{color:"#24292E"}},"());")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        },"),c("span",{style:{color:"#032F62"}},'"保洁阿姨"'),c("span",{style:{color:"#24292E"}},")."),c("span",{style:{color:"#6F42C1"}},"start"),c("span",{style:{color:"#24292E"}},"();")]),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        "),c("span",{style:{color:"#6F42C1"}},"sleep"),c("span",{style:{color:"#24292E"}},"("),c("span",{style:{color:"#005CC5"}},"1"),c("span",{style:{color:"#24292E"}},");")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        log."),c("span",{style:{color:"#6F42C1"}},"debug"),c("span",{style:{color:"#24292E"}},"("),c("span",{style:{color:"#032F62"}},'"想换一只新垃圾袋？"'),c("span",{style:{color:"#24292E"}},");")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        "),c("span",{style:{color:"#D73A49"}},"boolean"),c("span",{style:{color:"#24292E"}}," success "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," ref."),c("span",{style:{color:"#6F42C1"}},"compareAndSet"),c("span",{style:{color:"#24292E"}},"(prev, "),c("span",{style:{color:"#D73A49"}},"new"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#6F42C1"}},"GarbageBag"),c("span",{style:{color:"#24292E"}},"("),c("span",{style:{color:"#032F62"}},'"空垃圾袋"'),c("span",{style:{color:"#24292E"}},"), "),c("span",{style:{color:"#005CC5"}},"true"),c("span",{style:{color:"#24292E"}},", "),c("span",{style:{color:"#005CC5"}},"false"),c("span",{style:{color:"#24292E"}},");")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        log."),c("span",{style:{color:"#6F42C1"}},"debug"),c("span",{style:{color:"#24292E"}},"("),c("span",{style:{color:"#032F62"}},'"换了么？"'),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#D73A49"}},"+"),c("span",{style:{color:"#24292E"}}," success);")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        log."),c("span",{style:{color:"#6F42C1"}},"debug"),c("span",{style:{color:"#24292E"}},"(ref."),c("span",{style:{color:"#6F42C1"}},"getReference"),c("span",{style:{color:"#24292E"}},"()."),c("span",{style:{color:"#6F42C1"}},"toString"),c("span",{style:{color:"#24292E"}},"());")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    }")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"}")]),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#D73A49"}},"class"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#6F42C1"}},"GarbageBag"),c("span",{style:{color:"#24292E"}}," {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    String desc;")]),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#D73A49"}},"public"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#6F42C1"}},"GarbageBag"),c("span",{style:{color:"#24292E"}},"(String "),c("span",{style:{color:"#E36209"}},"desc"),c("span",{style:{color:"#24292E"}},") {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        "),c("span",{style:{color:"#005CC5"}},"this"),c("span",{style:{color:"#24292E"}},".desc "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," desc;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    }")]),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#D73A49"}},"public"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#D73A49"}},"void"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#6F42C1"}},"setDesc"),c("span",{style:{color:"#24292E"}},"(String "),c("span",{style:{color:"#E36209"}},"desc"),c("span",{style:{color:"#24292E"}},") {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        "),c("span",{style:{color:"#005CC5"}},"this"),c("span",{style:{color:"#24292E"}},".desc "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," desc;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    }")]),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    @"),c("span",{style:{color:"#D73A49"}},"Override")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#D73A49"}},"public"),c("span",{style:{color:"#24292E"}}," String "),c("span",{style:{color:"#6F42C1"}},"toString"),c("span",{style:{color:"#24292E"}},"() {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        "),c("span",{style:{color:"#D73A49"}},"return"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#005CC5"}},"super"),c("span",{style:{color:"#24292E"}},"."),c("span",{style:{color:"#6F42C1"}},"toString"),c("span",{style:{color:"#24292E"}},"() "),c("span",{style:{color:"#D73A49"}},"+"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#032F62"}},'" "'),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#D73A49"}},"+"),c("span",{style:{color:"#24292E"}}," desc;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    }")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"}")])])]),c("button",{class:"collapse"})],-1),fs=c("figure",null,[c("img",{alt:"image-20230714183338108",class:"lazy","data-src":"https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230714183338108.png"})],-1),Bs=c("hr",null,null,-1),ks={id:"两者的区别",tabindex:"-1"},Ss=c("ul",null,[c("li",null,[c("strong",null,"AtomicStampedReference"),p(" 需要我们传入"),c("strong",null,"整型变量"),p("作为版本号，来判定是否被更改过")]),c("li",null,[c("strong",null,"AtomicMarkableReference"),p("需要我们传入"),c("strong",null,"布尔变量"),p("作为标记，来判断是否被更改过")])],-1),Ts=c("hr",null,null,-1),xs={id:"unsafe",tabindex:"-1"},Ls=c("p",null,"Unsafe 是 CAS 的核心类，由于 Java 无法直接访问底层系统，需要通过本地（Native）方法来访问",-1),ws=c("p",null,[p("Unsafe 类存在 sun.misc 包，其中所有方法都是 native 修饰的，都是直接调用"),c("strong",null,"操作系统底层资源"),p("执行相应的任务，基于该类可以直接操作特定的内存数据，其内部方法操作类似 C 的指针")],-1),Is=c("p",null,"模拟实现原子整数：",-1),js=c("div",{style:{"max-height":"300px"},class:"language-java"},[c("button",{title:"Copy Code",class:"copy"}),c("span",{class:"lang"},"java"),c("pre",{class:"shiki github-dark vp-code-dark"},[c("code",null,[c("span",{class:"line"},[c("span",{style:{color:"#F97583"}},"public"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#F97583"}},"static"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#F97583"}},"void"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#B392F0"}},"main"),c("span",{style:{color:"#E1E4E8"}},"("),c("span",{style:{color:"#F97583"}},"String"),c("span",{style:{color:"#E1E4E8"}},"[] args) {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    MyAtomicInteger atomicInteger "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#F97583"}},"new"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#B392F0"}},"MyAtomicInteger"),c("span",{style:{color:"#E1E4E8"}},"("),c("span",{style:{color:"#79B8FF"}},"10"),c("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#F97583"}},"if"),c("span",{style:{color:"#E1E4E8"}}," (atomicInteger."),c("span",{style:{color:"#B392F0"}},"compareAndSwap"),c("span",{style:{color:"#E1E4E8"}},"("),c("span",{style:{color:"#79B8FF"}},"20"),c("span",{style:{color:"#E1E4E8"}},")) {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        System.out."),c("span",{style:{color:"#B392F0"}},"println"),c("span",{style:{color:"#E1E4E8"}},"(atomicInteger."),c("span",{style:{color:"#B392F0"}},"getValue"),c("span",{style:{color:"#E1E4E8"}},"());")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"}")]),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#F97583"}},"class"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#B392F0"}},"MyAtomicInteger"),c("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#F97583"}},"private"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#F97583"}},"static"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#F97583"}},"final"),c("span",{style:{color:"#E1E4E8"}}," Unsafe UNSAFE;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#F97583"}},"private"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#F97583"}},"static"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#F97583"}},"final"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#F97583"}},"long"),c("span",{style:{color:"#E1E4E8"}}," VALUE_OFFSET;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#F97583"}},"private"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#F97583"}},"volatile"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#F97583"}},"int"),c("span",{style:{color:"#E1E4E8"}}," value;")]),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#F97583"}},"static"),c("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        "),c("span",{style:{color:"#F97583"}},"try"),c("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"            "),c("span",{style:{color:"#6A737D"}},"//Unsafe unsafe = Unsafe.getUnsafe()这样会报错，需要反射获取")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"            Field theUnsafe "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," Unsafe.class."),c("span",{style:{color:"#B392F0"}},"getDeclaredField"),c("span",{style:{color:"#E1E4E8"}},"("),c("span",{style:{color:"#9ECBFF"}},'"theUnsafe"'),c("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"            theUnsafe."),c("span",{style:{color:"#B392F0"}},"setAccessible"),c("span",{style:{color:"#E1E4E8"}},"("),c("span",{style:{color:"#79B8FF"}},"true"),c("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"            UNSAFE "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," (Unsafe) theUnsafe."),c("span",{style:{color:"#B392F0"}},"get"),c("span",{style:{color:"#E1E4E8"}},"("),c("span",{style:{color:"#79B8FF"}},"null"),c("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"            "),c("span",{style:{color:"#6A737D"}},"// 获取 value 属性的内存地址，value 属性指向该地址，直接设置该地址的值可以修改 value 的值")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"            VALUE_OFFSET "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," UNSAFE."),c("span",{style:{color:"#B392F0"}},"objectFieldOffset"),c("span",{style:{color:"#E1E4E8"}},"(")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"                \t\t   MyAtomicInteger.class."),c("span",{style:{color:"#B392F0"}},"getDeclaredField"),c("span",{style:{color:"#E1E4E8"}},"("),c("span",{style:{color:"#9ECBFF"}},'"value"'),c("span",{style:{color:"#E1E4E8"}},"));")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        } "),c("span",{style:{color:"#F97583"}},"catch"),c("span",{style:{color:"#E1E4E8"}}," (NoSuchFieldException | IllegalAccessException "),c("span",{style:{color:"#FFAB70"}},"e"),c("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"            e."),c("span",{style:{color:"#B392F0"}},"printStackTrace"),c("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"            "),c("span",{style:{color:"#F97583"}},"throw"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#F97583"}},"new"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#B392F0"}},"RuntimeException"),c("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        }")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#F97583"}},"public"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#B392F0"}},"MyAtomicInteger"),c("span",{style:{color:"#E1E4E8"}},"("),c("span",{style:{color:"#F97583"}},"int"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#FFAB70"}},"value"),c("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        "),c("span",{style:{color:"#79B8FF"}},"this"),c("span",{style:{color:"#E1E4E8"}},".value "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," value;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#F97583"}},"public"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#F97583"}},"int"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#B392F0"}},"getValue"),c("span",{style:{color:"#E1E4E8"}},"() {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        "),c("span",{style:{color:"#F97583"}},"return"),c("span",{style:{color:"#E1E4E8"}}," value;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#F97583"}},"public"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#F97583"}},"boolean"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#B392F0"}},"compareAndSwap"),c("span",{style:{color:"#E1E4E8"}},"("),c("span",{style:{color:"#F97583"}},"int"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#FFAB70"}},"update"),c("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        "),c("span",{style:{color:"#F97583"}},"while"),c("span",{style:{color:"#E1E4E8"}}," ("),c("span",{style:{color:"#79B8FF"}},"true"),c("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"            "),c("span",{style:{color:"#F97583"}},"int"),c("span",{style:{color:"#E1E4E8"}}," prev "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#79B8FF"}},"this"),c("span",{style:{color:"#E1E4E8"}},".value;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"            "),c("span",{style:{color:"#F97583"}},"int"),c("span",{style:{color:"#E1E4E8"}}," next "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," update;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"            "),c("span",{style:{color:"#6A737D"}},"//\t\t\t\t\t\t\t当前对象  内存偏移量    期望值 更新值")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"            "),c("span",{style:{color:"#F97583"}},"if"),c("span",{style:{color:"#E1E4E8"}}," (UNSAFE."),c("span",{style:{color:"#B392F0"}},"compareAndSwapInt"),c("span",{style:{color:"#E1E4E8"}},"("),c("span",{style:{color:"#79B8FF"}},"this"),c("span",{style:{color:"#E1E4E8"}},", VALUE_OFFSET, prev, update)) {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"                System.out."),c("span",{style:{color:"#B392F0"}},"println"),c("span",{style:{color:"#E1E4E8"}},"("),c("span",{style:{color:"#9ECBFF"}},'"CAS成功"'),c("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"                "),c("span",{style:{color:"#F97583"}},"return"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#79B8FF"}},"true"),c("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"            }")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        }")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"}")])])]),c("pre",{class:"shiki github-light vp-code-light"},[c("code",null,[c("span",{class:"line"},[c("span",{style:{color:"#D73A49"}},"public"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#D73A49"}},"static"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#D73A49"}},"void"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#6F42C1"}},"main"),c("span",{style:{color:"#24292E"}},"("),c("span",{style:{color:"#D73A49"}},"String"),c("span",{style:{color:"#24292E"}},"[] args) {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    MyAtomicInteger atomicInteger "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#D73A49"}},"new"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#6F42C1"}},"MyAtomicInteger"),c("span",{style:{color:"#24292E"}},"("),c("span",{style:{color:"#005CC5"}},"10"),c("span",{style:{color:"#24292E"}},");")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#D73A49"}},"if"),c("span",{style:{color:"#24292E"}}," (atomicInteger."),c("span",{style:{color:"#6F42C1"}},"compareAndSwap"),c("span",{style:{color:"#24292E"}},"("),c("span",{style:{color:"#005CC5"}},"20"),c("span",{style:{color:"#24292E"}},")) {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        System.out."),c("span",{style:{color:"#6F42C1"}},"println"),c("span",{style:{color:"#24292E"}},"(atomicInteger."),c("span",{style:{color:"#6F42C1"}},"getValue"),c("span",{style:{color:"#24292E"}},"());")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    }")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"}")]),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#D73A49"}},"class"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#6F42C1"}},"MyAtomicInteger"),c("span",{style:{color:"#24292E"}}," {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#D73A49"}},"private"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#D73A49"}},"static"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#D73A49"}},"final"),c("span",{style:{color:"#24292E"}}," Unsafe UNSAFE;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#D73A49"}},"private"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#D73A49"}},"static"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#D73A49"}},"final"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#D73A49"}},"long"),c("span",{style:{color:"#24292E"}}," VALUE_OFFSET;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#D73A49"}},"private"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#D73A49"}},"volatile"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#D73A49"}},"int"),c("span",{style:{color:"#24292E"}}," value;")]),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#D73A49"}},"static"),c("span",{style:{color:"#24292E"}}," {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        "),c("span",{style:{color:"#D73A49"}},"try"),c("span",{style:{color:"#24292E"}}," {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"            "),c("span",{style:{color:"#6A737D"}},"//Unsafe unsafe = Unsafe.getUnsafe()这样会报错，需要反射获取")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"            Field theUnsafe "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," Unsafe.class."),c("span",{style:{color:"#6F42C1"}},"getDeclaredField"),c("span",{style:{color:"#24292E"}},"("),c("span",{style:{color:"#032F62"}},'"theUnsafe"'),c("span",{style:{color:"#24292E"}},");")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"            theUnsafe."),c("span",{style:{color:"#6F42C1"}},"setAccessible"),c("span",{style:{color:"#24292E"}},"("),c("span",{style:{color:"#005CC5"}},"true"),c("span",{style:{color:"#24292E"}},");")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"            UNSAFE "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," (Unsafe) theUnsafe."),c("span",{style:{color:"#6F42C1"}},"get"),c("span",{style:{color:"#24292E"}},"("),c("span",{style:{color:"#005CC5"}},"null"),c("span",{style:{color:"#24292E"}},");")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"            "),c("span",{style:{color:"#6A737D"}},"// 获取 value 属性的内存地址，value 属性指向该地址，直接设置该地址的值可以修改 value 的值")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"            VALUE_OFFSET "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," UNSAFE."),c("span",{style:{color:"#6F42C1"}},"objectFieldOffset"),c("span",{style:{color:"#24292E"}},"(")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"                \t\t   MyAtomicInteger.class."),c("span",{style:{color:"#6F42C1"}},"getDeclaredField"),c("span",{style:{color:"#24292E"}},"("),c("span",{style:{color:"#032F62"}},'"value"'),c("span",{style:{color:"#24292E"}},"));")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        } "),c("span",{style:{color:"#D73A49"}},"catch"),c("span",{style:{color:"#24292E"}}," (NoSuchFieldException | IllegalAccessException "),c("span",{style:{color:"#E36209"}},"e"),c("span",{style:{color:"#24292E"}},") {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"            e."),c("span",{style:{color:"#6F42C1"}},"printStackTrace"),c("span",{style:{color:"#24292E"}},"();")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"            "),c("span",{style:{color:"#D73A49"}},"throw"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#D73A49"}},"new"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#6F42C1"}},"RuntimeException"),c("span",{style:{color:"#24292E"}},"();")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        }")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    }")]),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#D73A49"}},"public"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#6F42C1"}},"MyAtomicInteger"),c("span",{style:{color:"#24292E"}},"("),c("span",{style:{color:"#D73A49"}},"int"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#E36209"}},"value"),c("span",{style:{color:"#24292E"}},") {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        "),c("span",{style:{color:"#005CC5"}},"this"),c("span",{style:{color:"#24292E"}},".value "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," value;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    }")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#D73A49"}},"public"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#D73A49"}},"int"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#6F42C1"}},"getValue"),c("span",{style:{color:"#24292E"}},"() {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        "),c("span",{style:{color:"#D73A49"}},"return"),c("span",{style:{color:"#24292E"}}," value;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    }")]),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#D73A49"}},"public"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#D73A49"}},"boolean"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#6F42C1"}},"compareAndSwap"),c("span",{style:{color:"#24292E"}},"("),c("span",{style:{color:"#D73A49"}},"int"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#E36209"}},"update"),c("span",{style:{color:"#24292E"}},") {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        "),c("span",{style:{color:"#D73A49"}},"while"),c("span",{style:{color:"#24292E"}}," ("),c("span",{style:{color:"#005CC5"}},"true"),c("span",{style:{color:"#24292E"}},") {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"            "),c("span",{style:{color:"#D73A49"}},"int"),c("span",{style:{color:"#24292E"}}," prev "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#005CC5"}},"this"),c("span",{style:{color:"#24292E"}},".value;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"            "),c("span",{style:{color:"#D73A49"}},"int"),c("span",{style:{color:"#24292E"}}," next "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," update;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"            "),c("span",{style:{color:"#6A737D"}},"//\t\t\t\t\t\t\t当前对象  内存偏移量    期望值 更新值")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"            "),c("span",{style:{color:"#D73A49"}},"if"),c("span",{style:{color:"#24292E"}}," (UNSAFE."),c("span",{style:{color:"#6F42C1"}},"compareAndSwapInt"),c("span",{style:{color:"#24292E"}},"("),c("span",{style:{color:"#005CC5"}},"this"),c("span",{style:{color:"#24292E"}},", VALUE_OFFSET, prev, update)) {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"                System.out."),c("span",{style:{color:"#6F42C1"}},"println"),c("span",{style:{color:"#24292E"}},"("),c("span",{style:{color:"#032F62"}},'"CAS成功"'),c("span",{style:{color:"#24292E"}},");")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"                "),c("span",{style:{color:"#D73A49"}},"return"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#005CC5"}},"true"),c("span",{style:{color:"#24292E"}},";")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"            }")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        }")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    }")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"}")])])]),c("button",{class:"collapse"})],-1),Ms=c("hr",null,null,-1),Us={id:"final",tabindex:"-1"},Ps={id:"原理-1",tabindex:"-1"},_s=c("div",{style:{"max-height":"300px"},class:"language-java"},[c("button",{title:"Copy Code",class:"copy"}),c("span",{class:"lang"},"java"),c("pre",{class:"shiki github-dark vp-code-dark"},[c("code",null,[c("span",{class:"line"},[c("span",{style:{color:"#F97583"}},"public"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#F97583"}},"class"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#B392F0"}},"TestFinal"),c("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"\t"),c("span",{style:{color:"#F97583"}},"final"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#F97583"}},"int"),c("span",{style:{color:"#E1E4E8"}}," a "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#79B8FF"}},"20"),c("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"}")])])]),c("pre",{class:"shiki github-light vp-code-light"},[c("code",null,[c("span",{class:"line"},[c("span",{style:{color:"#D73A49"}},"public"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#D73A49"}},"class"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#6F42C1"}},"TestFinal"),c("span",{style:{color:"#24292E"}}," {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"\t"),c("span",{style:{color:"#D73A49"}},"final"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#D73A49"}},"int"),c("span",{style:{color:"#24292E"}}," a "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#005CC5"}},"20"),c("span",{style:{color:"#24292E"}},";")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"}")])])]),c("button",{class:"collapse"})],-1),Rs=c("p",null,"字节码：",-1),Vs=c("div",{style:{"max-height":"300px"},class:"language-java"},[c("button",{title:"Copy Code",class:"copy"}),c("span",{class:"lang"},"java"),c("pre",{class:"shiki github-dark vp-code-dark"},[c("code",null,[c("span",{class:"line"},[c("span",{style:{color:"#79B8FF"}},"0"),c("span",{style:{color:"#F97583"}},":"),c("span",{style:{color:"#E1E4E8"}}," aload_0")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#79B8FF"}},"1"),c("span",{style:{color:"#F97583"}},":"),c("span",{style:{color:"#E1E4E8"}}," invokespecial #"),c("span",{style:{color:"#79B8FF"}},"1"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#6A737D"}},'// Method java/lang/Object."<init>":()V')]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#79B8FF"}},"4"),c("span",{style:{color:"#F97583"}},":"),c("span",{style:{color:"#E1E4E8"}}," aload_0")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#79B8FF"}},"5"),c("span",{style:{color:"#F97583"}},":"),c("span",{style:{color:"#E1E4E8"}}," bipush "),c("span",{style:{color:"#79B8FF"}},"20"),c("span",{style:{color:"#E1E4E8"}},"\t\t"),c("span",{style:{color:"#6A737D"}},"// 将值直接放入栈中")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#79B8FF"}},"7"),c("span",{style:{color:"#F97583"}},":"),c("span",{style:{color:"#E1E4E8"}}," putfield #"),c("span",{style:{color:"#79B8FF"}},"2"),c("span",{style:{color:"#E1E4E8"}}," \t\t"),c("span",{style:{color:"#6A737D"}},"// Field a:I")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#F97583"}},"<--"),c("span",{style:{color:"#E1E4E8"}}," 写屏障")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#79B8FF"}},"10"),c("span",{style:{color:"#F97583"}},":"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#F97583"}},"return")])])]),c("pre",{class:"shiki github-light vp-code-light"},[c("code",null,[c("span",{class:"line"},[c("span",{style:{color:"#005CC5"}},"0"),c("span",{style:{color:"#D73A49"}},":"),c("span",{style:{color:"#24292E"}}," aload_0")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#005CC5"}},"1"),c("span",{style:{color:"#D73A49"}},":"),c("span",{style:{color:"#24292E"}}," invokespecial #"),c("span",{style:{color:"#005CC5"}},"1"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#6A737D"}},'// Method java/lang/Object."<init>":()V')]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#005CC5"}},"4"),c("span",{style:{color:"#D73A49"}},":"),c("span",{style:{color:"#24292E"}}," aload_0")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#005CC5"}},"5"),c("span",{style:{color:"#D73A49"}},":"),c("span",{style:{color:"#24292E"}}," bipush "),c("span",{style:{color:"#005CC5"}},"20"),c("span",{style:{color:"#24292E"}},"\t\t"),c("span",{style:{color:"#6A737D"}},"// 将值直接放入栈中")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#005CC5"}},"7"),c("span",{style:{color:"#D73A49"}},":"),c("span",{style:{color:"#24292E"}}," putfield #"),c("span",{style:{color:"#005CC5"}},"2"),c("span",{style:{color:"#24292E"}}," \t\t"),c("span",{style:{color:"#6A737D"}},"// Field a:I")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#D73A49"}},"<--"),c("span",{style:{color:"#24292E"}}," 写屏障")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#005CC5"}},"10"),c("span",{style:{color:"#D73A49"}},":"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#D73A49"}},"return")])])]),c("button",{class:"collapse"})],-1),Os=c("p",null,"final 变量的赋值通过 putfield 指令来完成，在这条指令之后也会加入写屏障，保证在其它线程读到它的值时不会出现为 0 的情况",-1),zs=c("p",null,[p("其他线程访问 final 修饰的变量"),c("strong",null,"会复制一份放入栈中"),p("，效率更高")],-1),Ns=c("hr",null,null,-1),Hs={id:"不可变",tabindex:"-1"},Gs=c("p",null,"不可变：如果一个对象不能够修改其内部状态（属性），那么就是不可变对象",-1),Ks=c("p",null,"不可变对象线程安全的，不存在并发修改和可见性问题，是另一种避免竞争的方式",-1),Js=c("p",null,"String 类也是不可变的，该类和类中所有属性都是 final 的",-1),$s=c("ul",null,[c("li",null,[c("p",null,"类用 final 修饰保证了该类中的方法不能被覆盖，防止子类无意间破坏不可变性")]),c("li",null,[c("p",null,"无写入方法（set）确保外部不能对内部属性进行修改")]),c("li",null,[c("p",null,"属性用 final 修饰保证了该属性是只读的，不能修改"),c("div",{style:{"max-height":"300px"},class:"language-java"},[c("button",{title:"Copy Code",class:"copy"}),c("span",{class:"lang"},"java"),c("pre",{class:"shiki github-dark vp-code-dark"},[c("code",null,[c("span",{class:"line"},[c("span",{style:{color:"#F97583"}},"public"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#F97583"}},"final"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#F97583"}},"class"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#B392F0"}},"String")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#F97583"}},"implements"),c("span",{style:{color:"#E1E4E8"}}," java.io."),c("span",{style:{color:"#B392F0"}},"Serializable"),c("span",{style:{color:"#E1E4E8"}},", "),c("span",{style:{color:"#B392F0"}},"Comparable"),c("span",{style:{color:"#E1E4E8"}},"<"),c("span",{style:{color:"#F97583"}},"String"),c("span",{style:{color:"#E1E4E8"}},">, "),c("span",{style:{color:"#B392F0"}},"CharSequence"),c("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"    /** The value is used for character storage. */")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#F97583"}},"private"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#F97583"}},"final"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#F97583"}},"char"),c("span",{style:{color:"#E1E4E8"}}," value[];")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#6A737D"}},"//....")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"}")])])]),c("pre",{class:"shiki github-light vp-code-light"},[c("code",null,[c("span",{class:"line"},[c("span",{style:{color:"#D73A49"}},"public"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#D73A49"}},"final"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#D73A49"}},"class"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#6F42C1"}},"String")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#D73A49"}},"implements"),c("span",{style:{color:"#24292E"}}," java.io."),c("span",{style:{color:"#6F42C1"}},"Serializable"),c("span",{style:{color:"#24292E"}},", "),c("span",{style:{color:"#6F42C1"}},"Comparable"),c("span",{style:{color:"#24292E"}},"<"),c("span",{style:{color:"#D73A49"}},"String"),c("span",{style:{color:"#24292E"}},">, "),c("span",{style:{color:"#6F42C1"}},"CharSequence"),c("span",{style:{color:"#24292E"}}," {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"    /** The value is used for character storage. */")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#D73A49"}},"private"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#D73A49"}},"final"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#D73A49"}},"char"),c("span",{style:{color:"#24292E"}}," value[];")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#6A737D"}},"//....")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"}")])])]),c("button",{class:"collapse"})])]),c("li",null,[c("p",null,[p("更改 String 类数据时，会构造新字符串对象，生成新的 char[] value，通过"),c("strong",null,"创建副本对象来避免共享的方式称之为保护性拷贝")])])],-1),Ys=c("hr",null,null,-1),qs={id:"state",tabindex:"-1"},Ws=c("p",null,"无状态：成员变量保存的数据也可以称为状态信息，无状态就是没有成员变量",-1),Qs=c("p",null,"Servlet 为了保证其线程安全，一般不为 Servlet 设置成员变量，这种没有任何成员变量的类是线程安全的",-1),Zs=c("hr",null,null,-1),Xs={id:"local",tabindex:"-1"},lo={id:"基本介绍",tabindex:"-1"},so=c("p",null,[p("ThreadLocal 类用来提供线程内部的局部变量，这种变量在多线程环境下访问（通过 get 和 set 方法访问）时能保证各个线程的变量相对独立于其他线程内的变量，分配在堆内的 "),c("strong",null,"TLAB"),p(" 中")],-1),oo=c("p",null,[p("ThreadLocal 实例通常来说都是 "),c("code",null,"private static"),p(" 类型的，属于一个线程的本地变量，用于关联线程和线程上下文。每个线程都会在 ThreadLocal 中保存一份该线程独有的数据，所以是线程安全的")],-1),no=c("p",null,"ThreadLocal 作用：",-1),ao=c("ul",null,[c("li",null,[c("p",null,"线程并发：应用在多线程并发的场景下")]),c("li",null,[c("p",null,"传递数据：通过 ThreadLocal 实现在同一线程不同函数或组件中传递公共变量，减少传递复杂度")]),c("li",null,[c("p",null,"线程隔离：每个线程的变量都是独立的，不会互相影响")])],-1),eo=c("p",null,"对比 synchronized：",-1),to=c("table",null,[c("thead",null,[c("tr",null,[c("th"),c("th",null,"synchronized"),c("th",null,"ThreadLocal")])]),c("tbody",null,[c("tr",null,[c("td",null,"原理"),c("td",null,[p("同步机制采用"),c("strong",null,"以时间换空间"),p("的方式，只提供了一份变量，让不同的线程排队访问")]),c("td",null,[p("ThreadLocal 采用"),c("strong",null,"以空间换时间"),p("的方式，为每个线程都提供了一份变量的副本，从而实现同时访问而互不干扰")])]),c("tr",null,[c("td",null,"侧重点"),c("td",null,"多个线程之间访问资源的同步"),c("td",null,"多线程中让每个线程之间的数据相互隔离")])])],-1),co=c("hr",null,null,-1),po={id:"基本使用",tabindex:"-1"},ro={id:"常用方法",tabindex:"-1"},Eo=c("table",null,[c("thead",null,[c("tr",null,[c("th",null,"方法"),c("th",null,"描述")])]),c("tbody",null,[c("tr",null,[c("td",null,"ThreadLocal<>()"),c("td",null,"创建 ThreadLocal 对象")]),c("tr",null,[c("td",null,"protected T initialValue()"),c("td",null,"返回当前线程局部变量的初始值")]),c("tr",null,[c("td",null,"public void set( T value)"),c("td",null,"设置当前线程绑定的局部变量")]),c("tr",null,[c("td",null,"public T get()"),c("td",null,"获取当前线程绑定的局部变量")]),c("tr",null,[c("td",null,"public void remove()"),c("td",null,"移除当前线程绑定的局部变量")])])],-1),yo=c("div",{style:{"max-height":"300px"},class:"language-java"},[c("button",{title:"Copy Code",class:"copy"}),c("span",{class:"lang"},"java"),c("pre",{class:"shiki github-dark vp-code-dark"},[c("code",null,[c("span",{class:"line"},[c("span",{style:{color:"#F97583"}},"public"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#F97583"}},"class"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#B392F0"}},"MyDemo"),c("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#F97583"}},"private"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#F97583"}},"static"),c("span",{style:{color:"#E1E4E8"}}," ThreadLocal<"),c("span",{style:{color:"#F97583"}},"String"),c("span",{style:{color:"#E1E4E8"}},"> tl "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#F97583"}},"new"),c("span",{style:{color:"#E1E4E8"}}," ThreadLocal<>();")]),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#F97583"}},"private"),c("span",{style:{color:"#E1E4E8"}}," String content;")]),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#F97583"}},"private"),c("span",{style:{color:"#E1E4E8"}}," String "),c("span",{style:{color:"#B392F0"}},"getContent"),c("span",{style:{color:"#E1E4E8"}},"() {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        "),c("span",{style:{color:"#6A737D"}},"// 获取当前线程绑定的变量")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        "),c("span",{style:{color:"#F97583"}},"return"),c("span",{style:{color:"#E1E4E8"}}," tl."),c("span",{style:{color:"#B392F0"}},"get"),c("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#F97583"}},"private"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#F97583"}},"void"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#B392F0"}},"setContent"),c("span",{style:{color:"#E1E4E8"}},"(String "),c("span",{style:{color:"#FFAB70"}},"content"),c("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        "),c("span",{style:{color:"#6A737D"}},"// 变量content绑定到当前线程")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        tl."),c("span",{style:{color:"#B392F0"}},"set"),c("span",{style:{color:"#E1E4E8"}},"(content);")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#F97583"}},"public"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#F97583"}},"static"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#F97583"}},"void"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#B392F0"}},"main"),c("span",{style:{color:"#E1E4E8"}},"("),c("span",{style:{color:"#F97583"}},"String"),c("span",{style:{color:"#E1E4E8"}},"[] "),c("span",{style:{color:"#FFAB70"}},"args"),c("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        MyDemo demo "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#F97583"}},"new"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#B392F0"}},"MyDemo"),c("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        "),c("span",{style:{color:"#F97583"}},"for"),c("span",{style:{color:"#E1E4E8"}}," ("),c("span",{style:{color:"#F97583"}},"int"),c("span",{style:{color:"#E1E4E8"}}," i "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#79B8FF"}},"0"),c("span",{style:{color:"#E1E4E8"}},"; i "),c("span",{style:{color:"#F97583"}},"<"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#79B8FF"}},"5"),c("span",{style:{color:"#E1E4E8"}},"; i"),c("span",{style:{color:"#F97583"}},"++"),c("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"            Thread thread "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#F97583"}},"new"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#B392F0"}},"Thread"),c("span",{style:{color:"#E1E4E8"}},"("),c("span",{style:{color:"#F97583"}},"new"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#B392F0"}},"Runnable"),c("span",{style:{color:"#E1E4E8"}},"() {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"                @"),c("span",{style:{color:"#F97583"}},"Override")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"                "),c("span",{style:{color:"#F97583"}},"public"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#F97583"}},"void"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#B392F0"}},"run"),c("span",{style:{color:"#E1E4E8"}},"() {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"                    "),c("span",{style:{color:"#6A737D"}},"// 设置数据")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"                    demo."),c("span",{style:{color:"#B392F0"}},"setContent"),c("span",{style:{color:"#E1E4E8"}},"(Thread."),c("span",{style:{color:"#B392F0"}},"currentThread"),c("span",{style:{color:"#E1E4E8"}},"()."),c("span",{style:{color:"#B392F0"}},"getName"),c("span",{style:{color:"#E1E4E8"}},"() "),c("span",{style:{color:"#F97583"}},"+"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#9ECBFF"}},'"的数据"'),c("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"                    System.out."),c("span",{style:{color:"#B392F0"}},"println"),c("span",{style:{color:"#E1E4E8"}},"("),c("span",{style:{color:"#9ECBFF"}},'"-----------------------"'),c("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"                    System.out."),c("span",{style:{color:"#B392F0"}},"println"),c("span",{style:{color:"#E1E4E8"}},"(Thread."),c("span",{style:{color:"#B392F0"}},"currentThread"),c("span",{style:{color:"#E1E4E8"}},"()."),c("span",{style:{color:"#B392F0"}},"getName"),c("span",{style:{color:"#E1E4E8"}},"() "),c("span",{style:{color:"#F97583"}},"+"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#9ECBFF"}},'"---\x3e"'),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#F97583"}},"+"),c("span",{style:{color:"#E1E4E8"}}," demo."),c("span",{style:{color:"#B392F0"}},"getContent"),c("span",{style:{color:"#E1E4E8"}},"());")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"                }")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"            });")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"            thread."),c("span",{style:{color:"#B392F0"}},"setName"),c("span",{style:{color:"#E1E4E8"}},"("),c("span",{style:{color:"#9ECBFF"}},'"线程"'),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#F97583"}},"+"),c("span",{style:{color:"#E1E4E8"}}," i);")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"            thread."),c("span",{style:{color:"#B392F0"}},"start"),c("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        }")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"}")])])]),c("pre",{class:"shiki github-light vp-code-light"},[c("code",null,[c("span",{class:"line"},[c("span",{style:{color:"#D73A49"}},"public"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#D73A49"}},"class"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#6F42C1"}},"MyDemo"),c("span",{style:{color:"#24292E"}}," {")]),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#D73A49"}},"private"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#D73A49"}},"static"),c("span",{style:{color:"#24292E"}}," ThreadLocal<"),c("span",{style:{color:"#D73A49"}},"String"),c("span",{style:{color:"#24292E"}},"> tl "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#D73A49"}},"new"),c("span",{style:{color:"#24292E"}}," ThreadLocal<>();")]),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#D73A49"}},"private"),c("span",{style:{color:"#24292E"}}," String content;")]),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#D73A49"}},"private"),c("span",{style:{color:"#24292E"}}," String "),c("span",{style:{color:"#6F42C1"}},"getContent"),c("span",{style:{color:"#24292E"}},"() {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        "),c("span",{style:{color:"#6A737D"}},"// 获取当前线程绑定的变量")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        "),c("span",{style:{color:"#D73A49"}},"return"),c("span",{style:{color:"#24292E"}}," tl."),c("span",{style:{color:"#6F42C1"}},"get"),c("span",{style:{color:"#24292E"}},"();")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    }")]),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#D73A49"}},"private"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#D73A49"}},"void"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#6F42C1"}},"setContent"),c("span",{style:{color:"#24292E"}},"(String "),c("span",{style:{color:"#E36209"}},"content"),c("span",{style:{color:"#24292E"}},") {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        "),c("span",{style:{color:"#6A737D"}},"// 变量content绑定到当前线程")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        tl."),c("span",{style:{color:"#6F42C1"}},"set"),c("span",{style:{color:"#24292E"}},"(content);")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    }")]),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#D73A49"}},"public"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#D73A49"}},"static"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#D73A49"}},"void"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#6F42C1"}},"main"),c("span",{style:{color:"#24292E"}},"("),c("span",{style:{color:"#D73A49"}},"String"),c("span",{style:{color:"#24292E"}},"[] "),c("span",{style:{color:"#E36209"}},"args"),c("span",{style:{color:"#24292E"}},") {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        MyDemo demo "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#D73A49"}},"new"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#6F42C1"}},"MyDemo"),c("span",{style:{color:"#24292E"}},"();")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        "),c("span",{style:{color:"#D73A49"}},"for"),c("span",{style:{color:"#24292E"}}," ("),c("span",{style:{color:"#D73A49"}},"int"),c("span",{style:{color:"#24292E"}}," i "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#005CC5"}},"0"),c("span",{style:{color:"#24292E"}},"; i "),c("span",{style:{color:"#D73A49"}},"<"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#005CC5"}},"5"),c("span",{style:{color:"#24292E"}},"; i"),c("span",{style:{color:"#D73A49"}},"++"),c("span",{style:{color:"#24292E"}},") {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"            Thread thread "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#D73A49"}},"new"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#6F42C1"}},"Thread"),c("span",{style:{color:"#24292E"}},"("),c("span",{style:{color:"#D73A49"}},"new"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#6F42C1"}},"Runnable"),c("span",{style:{color:"#24292E"}},"() {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"                @"),c("span",{style:{color:"#D73A49"}},"Override")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"                "),c("span",{style:{color:"#D73A49"}},"public"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#D73A49"}},"void"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#6F42C1"}},"run"),c("span",{style:{color:"#24292E"}},"() {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"                    "),c("span",{style:{color:"#6A737D"}},"// 设置数据")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"                    demo."),c("span",{style:{color:"#6F42C1"}},"setContent"),c("span",{style:{color:"#24292E"}},"(Thread."),c("span",{style:{color:"#6F42C1"}},"currentThread"),c("span",{style:{color:"#24292E"}},"()."),c("span",{style:{color:"#6F42C1"}},"getName"),c("span",{style:{color:"#24292E"}},"() "),c("span",{style:{color:"#D73A49"}},"+"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#032F62"}},'"的数据"'),c("span",{style:{color:"#24292E"}},");")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"                    System.out."),c("span",{style:{color:"#6F42C1"}},"println"),c("span",{style:{color:"#24292E"}},"("),c("span",{style:{color:"#032F62"}},'"-----------------------"'),c("span",{style:{color:"#24292E"}},");")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"                    System.out."),c("span",{style:{color:"#6F42C1"}},"println"),c("span",{style:{color:"#24292E"}},"(Thread."),c("span",{style:{color:"#6F42C1"}},"currentThread"),c("span",{style:{color:"#24292E"}},"()."),c("span",{style:{color:"#6F42C1"}},"getName"),c("span",{style:{color:"#24292E"}},"() "),c("span",{style:{color:"#D73A49"}},"+"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#032F62"}},'"---\x3e"'),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#D73A49"}},"+"),c("span",{style:{color:"#24292E"}}," demo."),c("span",{style:{color:"#6F42C1"}},"getContent"),c("span",{style:{color:"#24292E"}},"());")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"                }")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"            });")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"            thread."),c("span",{style:{color:"#6F42C1"}},"setName"),c("span",{style:{color:"#24292E"}},"("),c("span",{style:{color:"#032F62"}},'"线程"'),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#D73A49"}},"+"),c("span",{style:{color:"#24292E"}}," i);")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"            thread."),c("span",{style:{color:"#6F42C1"}},"start"),c("span",{style:{color:"#24292E"}},"();")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        }")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    }")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"}")])])]),c("button",{class:"collapse"})],-1),io=c("hr",null,null,-1),Fo={id:"应用场景",tabindex:"-1"},uo=c("p",null,"ThreadLocal 适用于下面两种场景：",-1),Ao=c("ul",null,[c("li",null,"每个线程需要有自己单独的实例"),c("li",null,"实例需要在多个方法中共享，但不希望被多线程共享")],-1),Do=c("p",null,"ThreadLocal 方案有两个突出的优势：",-1),ho=c("ol",null,[c("li",null,"传递数据：保存每个线程绑定的数据，在需要的地方可以直接获取，避免参数直接传递带来的代码耦合问题"),c("li",null,"线程隔离：各线程之间的数据相互隔离却又具备并发性，避免同步方式带来的性能损失")],-1),go=c("p",null,"ThreadLocal 用于数据连接的事务管理：",-1),Co=c("div",{style:{"max-height":"300px"},class:"language-java"},[c("button",{title:"Copy Code",class:"copy"}),c("span",{class:"lang"},"java"),c("pre",{class:"shiki github-dark vp-code-dark"},[c("code",null,[c("span",{class:"line"},[c("span",{style:{color:"#F97583"}},"public"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#F97583"}},"class"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#B392F0"}},"JdbcUtils"),c("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#6A737D"}},"// ThreadLocal对象，将connection绑定在当前线程中")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#F97583"}},"private"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#F97583"}},"static"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#F97583"}},"final"),c("span",{style:{color:"#E1E4E8"}}," ThreadLocal<"),c("span",{style:{color:"#F97583"}},"Connection"),c("span",{style:{color:"#E1E4E8"}},"> tl "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#F97583"}},"new"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#B392F0"}},"ThreadLocal"),c("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#6A737D"}},"// c3p0 数据库连接池对象属性")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#F97583"}},"private"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#F97583"}},"static"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#F97583"}},"final"),c("span",{style:{color:"#E1E4E8"}}," ComboPooledDataSource ds "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#F97583"}},"new"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#B392F0"}},"ComboPooledDataSource"),c("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#6A737D"}},"// 获取连接")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#F97583"}},"public"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#F97583"}},"static"),c("span",{style:{color:"#E1E4E8"}}," Connection "),c("span",{style:{color:"#B392F0"}},"getConnection"),c("span",{style:{color:"#E1E4E8"}},"() "),c("span",{style:{color:"#F97583"}},"throws"),c("span",{style:{color:"#E1E4E8"}}," SQLException {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        "),c("span",{style:{color:"#6A737D"}},"//取出当前线程绑定的connection对象")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        Connection conn "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," tl."),c("span",{style:{color:"#B392F0"}},"get"),c("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        "),c("span",{style:{color:"#F97583"}},"if"),c("span",{style:{color:"#E1E4E8"}}," (conn "),c("span",{style:{color:"#F97583"}},"=="),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#79B8FF"}},"null"),c("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"            "),c("span",{style:{color:"#6A737D"}},"//如果没有，则从连接池中取出")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"            conn "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," ds."),c("span",{style:{color:"#B392F0"}},"getConnection"),c("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"            "),c("span",{style:{color:"#6A737D"}},"//再将connection对象绑定到当前线程中，非常重要的操作")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"            tl."),c("span",{style:{color:"#B392F0"}},"set"),c("span",{style:{color:"#E1E4E8"}},"(conn);")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        }")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        "),c("span",{style:{color:"#F97583"}},"return"),c("span",{style:{color:"#E1E4E8"}}," conn;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"\t"),c("span",{style:{color:"#6A737D"}},"// ...")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"}")])])]),c("pre",{class:"shiki github-light vp-code-light"},[c("code",null,[c("span",{class:"line"},[c("span",{style:{color:"#D73A49"}},"public"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#D73A49"}},"class"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#6F42C1"}},"JdbcUtils"),c("span",{style:{color:"#24292E"}}," {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#6A737D"}},"// ThreadLocal对象，将connection绑定在当前线程中")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#D73A49"}},"private"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#D73A49"}},"static"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#D73A49"}},"final"),c("span",{style:{color:"#24292E"}}," ThreadLocal<"),c("span",{style:{color:"#D73A49"}},"Connection"),c("span",{style:{color:"#24292E"}},"> tl "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#D73A49"}},"new"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#6F42C1"}},"ThreadLocal"),c("span",{style:{color:"#24292E"}},"();")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#6A737D"}},"// c3p0 数据库连接池对象属性")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#D73A49"}},"private"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#D73A49"}},"static"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#D73A49"}},"final"),c("span",{style:{color:"#24292E"}}," ComboPooledDataSource ds "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#D73A49"}},"new"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#6F42C1"}},"ComboPooledDataSource"),c("span",{style:{color:"#24292E"}},"();")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#6A737D"}},"// 获取连接")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#D73A49"}},"public"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#D73A49"}},"static"),c("span",{style:{color:"#24292E"}}," Connection "),c("span",{style:{color:"#6F42C1"}},"getConnection"),c("span",{style:{color:"#24292E"}},"() "),c("span",{style:{color:"#D73A49"}},"throws"),c("span",{style:{color:"#24292E"}}," SQLException {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        "),c("span",{style:{color:"#6A737D"}},"//取出当前线程绑定的connection对象")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        Connection conn "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," tl."),c("span",{style:{color:"#6F42C1"}},"get"),c("span",{style:{color:"#24292E"}},"();")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        "),c("span",{style:{color:"#D73A49"}},"if"),c("span",{style:{color:"#24292E"}}," (conn "),c("span",{style:{color:"#D73A49"}},"=="),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#005CC5"}},"null"),c("span",{style:{color:"#24292E"}},") {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"            "),c("span",{style:{color:"#6A737D"}},"//如果没有，则从连接池中取出")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"            conn "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," ds."),c("span",{style:{color:"#6F42C1"}},"getConnection"),c("span",{style:{color:"#24292E"}},"();")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"            "),c("span",{style:{color:"#6A737D"}},"//再将connection对象绑定到当前线程中，非常重要的操作")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"            tl."),c("span",{style:{color:"#6F42C1"}},"set"),c("span",{style:{color:"#24292E"}},"(conn);")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        }")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        "),c("span",{style:{color:"#D73A49"}},"return"),c("span",{style:{color:"#24292E"}}," conn;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    }")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"\t"),c("span",{style:{color:"#6A737D"}},"// ...")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"}")])])]),c("button",{class:"collapse"})],-1),bo=c("p",null,"用 ThreadLocal 使 SimpleDateFormat 从独享变量变成单个线程变量：",-1),mo=c("div",{style:{"max-height":"300px"},class:"language-java"},[c("button",{title:"Copy Code",class:"copy"}),c("span",{class:"lang"},"java"),c("pre",{class:"shiki github-dark vp-code-dark"},[c("code",null,[c("span",{class:"line"},[c("span",{style:{color:"#F97583"}},"public"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#F97583"}},"class"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#B392F0"}},"ThreadLocalDateUtil"),c("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#F97583"}},"private"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#F97583"}},"static"),c("span",{style:{color:"#E1E4E8"}}," ThreadLocal<"),c("span",{style:{color:"#F97583"}},"DateFormat"),c("span",{style:{color:"#E1E4E8"}},"> threadLocal "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#F97583"}},"new"),c("span",{style:{color:"#E1E4E8"}}," ThreadLocal<"),c("span",{style:{color:"#F97583"}},"DateFormat"),c("span",{style:{color:"#E1E4E8"}},">() {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        @"),c("span",{style:{color:"#F97583"}},"Override")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        "),c("span",{style:{color:"#F97583"}},"protected"),c("span",{style:{color:"#E1E4E8"}}," DateFormat "),c("span",{style:{color:"#B392F0"}},"initialValue"),c("span",{style:{color:"#E1E4E8"}},"() {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"            "),c("span",{style:{color:"#F97583"}},"return"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#F97583"}},"new"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#B392F0"}},"SimpleDateFormat"),c("span",{style:{color:"#E1E4E8"}},"("),c("span",{style:{color:"#9ECBFF"}},'"yyyy-MM-dd HH:mm:ss"'),c("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        }")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    };")]),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#F97583"}},"public"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#F97583"}},"static"),c("span",{style:{color:"#E1E4E8"}}," Date "),c("span",{style:{color:"#B392F0"}},"parse"),c("span",{style:{color:"#E1E4E8"}},"(String "),c("span",{style:{color:"#FFAB70"}},"dateStr"),c("span",{style:{color:"#E1E4E8"}},") "),c("span",{style:{color:"#F97583"}},"throws"),c("span",{style:{color:"#E1E4E8"}}," ParseException {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        "),c("span",{style:{color:"#F97583"}},"return"),c("span",{style:{color:"#E1E4E8"}}," threadLocal."),c("span",{style:{color:"#B392F0"}},"get"),c("span",{style:{color:"#E1E4E8"}},"()."),c("span",{style:{color:"#B392F0"}},"parse"),c("span",{style:{color:"#E1E4E8"}},"(dateStr);")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#F97583"}},"public"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#F97583"}},"static"),c("span",{style:{color:"#E1E4E8"}}," String "),c("span",{style:{color:"#B392F0"}},"format"),c("span",{style:{color:"#E1E4E8"}},"(Date "),c("span",{style:{color:"#FFAB70"}},"date"),c("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        "),c("span",{style:{color:"#F97583"}},"return"),c("span",{style:{color:"#E1E4E8"}}," threadLocal."),c("span",{style:{color:"#B392F0"}},"get"),c("span",{style:{color:"#E1E4E8"}},"()."),c("span",{style:{color:"#B392F0"}},"format"),c("span",{style:{color:"#E1E4E8"}},"(date);")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"}")])])]),c("pre",{class:"shiki github-light vp-code-light"},[c("code",null,[c("span",{class:"line"},[c("span",{style:{color:"#D73A49"}},"public"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#D73A49"}},"class"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#6F42C1"}},"ThreadLocalDateUtil"),c("span",{style:{color:"#24292E"}}," {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#D73A49"}},"private"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#D73A49"}},"static"),c("span",{style:{color:"#24292E"}}," ThreadLocal<"),c("span",{style:{color:"#D73A49"}},"DateFormat"),c("span",{style:{color:"#24292E"}},"> threadLocal "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#D73A49"}},"new"),c("span",{style:{color:"#24292E"}}," ThreadLocal<"),c("span",{style:{color:"#D73A49"}},"DateFormat"),c("span",{style:{color:"#24292E"}},">() {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        @"),c("span",{style:{color:"#D73A49"}},"Override")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        "),c("span",{style:{color:"#D73A49"}},"protected"),c("span",{style:{color:"#24292E"}}," DateFormat "),c("span",{style:{color:"#6F42C1"}},"initialValue"),c("span",{style:{color:"#24292E"}},"() {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"            "),c("span",{style:{color:"#D73A49"}},"return"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#D73A49"}},"new"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#6F42C1"}},"SimpleDateFormat"),c("span",{style:{color:"#24292E"}},"("),c("span",{style:{color:"#032F62"}},'"yyyy-MM-dd HH:mm:ss"'),c("span",{style:{color:"#24292E"}},");")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        }")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    };")]),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#D73A49"}},"public"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#D73A49"}},"static"),c("span",{style:{color:"#24292E"}}," Date "),c("span",{style:{color:"#6F42C1"}},"parse"),c("span",{style:{color:"#24292E"}},"(String "),c("span",{style:{color:"#E36209"}},"dateStr"),c("span",{style:{color:"#24292E"}},") "),c("span",{style:{color:"#D73A49"}},"throws"),c("span",{style:{color:"#24292E"}}," ParseException {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        "),c("span",{style:{color:"#D73A49"}},"return"),c("span",{style:{color:"#24292E"}}," threadLocal."),c("span",{style:{color:"#6F42C1"}},"get"),c("span",{style:{color:"#24292E"}},"()."),c("span",{style:{color:"#6F42C1"}},"parse"),c("span",{style:{color:"#24292E"}},"(dateStr);")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    }")]),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#D73A49"}},"public"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#D73A49"}},"static"),c("span",{style:{color:"#24292E"}}," String "),c("span",{style:{color:"#6F42C1"}},"format"),c("span",{style:{color:"#24292E"}},"(Date "),c("span",{style:{color:"#E36209"}},"date"),c("span",{style:{color:"#24292E"}},") {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        "),c("span",{style:{color:"#D73A49"}},"return"),c("span",{style:{color:"#24292E"}}," threadLocal."),c("span",{style:{color:"#6F42C1"}},"get"),c("span",{style:{color:"#24292E"}},"()."),c("span",{style:{color:"#6F42C1"}},"format"),c("span",{style:{color:"#24292E"}},"(date);")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    }")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"}")])])]),c("button",{class:"collapse"})],-1),vo=c("hr",null,null,-1),fo={id:"实现原理",tabindex:"-1"},Bo={id:"底层结构",tabindex:"-1"},ko=c("p",null,"JDK8 以前：每个 ThreadLocal 都创建一个 Map，然后用线程作为 Map 的 key，要存储的局部变量作为 Map 的 value，达到各个线程的局部变量隔离的效果。这种结构会造成 Map 结构过大和内存泄露，因为 Thread 停止后无法通过 key 删除对应的数据",-1),So=c("img",{src:"https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230824171552294.png",alt:"image-20230824171552294",style:{zoom:"80%"}},null,-1),To=c("p",null,"JDK8 以后：每个 Thread 维护一个 ThreadLocalMap，这个 Map 的 key 是 ThreadLocal 实例本身，value 是真正要存储的值",-1),xo=c("ul",null,[c("li",null,[c("strong",null,"每个 Thread 线程内部都有一个 Map (ThreadLocalMap)")]),c("li",null,"Map 里面存储 ThreadLocal 对象（key）和线程的私有变量（value）"),c("li",null,"Thread 内部的 Map 是由 ThreadLocal 维护的，由 ThreadLocal 负责向 map 获取和设置线程的变量值"),c("li",null,"对于不同的线程，每次获取副本值时，别的线程并不能获取到当前线程的副本值，形成副本的隔离，互不干扰")],-1),Lo=c("img",{src:"https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230824171625312.png",alt:"image-20230824171625312",style:{zoom:"80%"}},null,-1),wo=c("p",null,"JDK8 前后对比：",-1),Io=c("ul",null,[c("li",null,"每个 Map 存储的 Entry 数量会变少，因为之前的存储数量由 Thread 的数量决定，现在由 ThreadLocal 的数量决定，在实际编程当中，往往 ThreadLocal 的数量要少于 Thread 的数量"),c("li",null,[p("当 Thread 销毁之后，对应的 ThreadLocalMap 也会随之销毁，能减少内存的使用，"),c("strong",null,"防止内存泄露")])],-1),jo=c("hr",null,null,-1),Mo={id:"成员变量",tabindex:"-1"},Uo=c("ul",null,[c("li",null,[c("p",null,[p("Thread 类的相关属性："),c("strong",null,"每一个线程持有一个 ThreadLocalMap 对象"),p("，存放由 ThreadLocal 和数据组成的 Entry 键值对")]),c("div",{style:{"max-height":"300px"},class:"language-java"},[c("button",{title:"Copy Code",class:"copy"}),c("span",{class:"lang"},"java"),c("pre",{class:"shiki github-dark vp-code-dark"},[c("code",null,[c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"ThreadLocal.ThreadLocalMap threadLocals "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#79B8FF"}},"null")])])]),c("pre",{class:"shiki github-light vp-code-light"},[c("code",null,[c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"ThreadLocal.ThreadLocalMap threadLocals "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#005CC5"}},"null")])])]),c("button",{class:"collapse"})])]),c("li",null,[c("p",null,"计算 ThreadLocal 对象的哈希值："),c("div",{style:{"max-height":"300px"},class:"language-java"},[c("button",{title:"Copy Code",class:"copy"}),c("span",{class:"lang"},"java"),c("pre",{class:"shiki github-dark vp-code-dark"},[c("code",null,[c("span",{class:"line"},[c("span",{style:{color:"#F97583"}},"private"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#F97583"}},"final"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#F97583"}},"int"),c("span",{style:{color:"#E1E4E8"}}," threadLocalHashCode "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#B392F0"}},"nextHashCode"),c("span",{style:{color:"#E1E4E8"}},"()")])])]),c("pre",{class:"shiki github-light vp-code-light"},[c("code",null,[c("span",{class:"line"},[c("span",{style:{color:"#D73A49"}},"private"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#D73A49"}},"final"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#D73A49"}},"int"),c("span",{style:{color:"#24292E"}}," threadLocalHashCode "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#6F42C1"}},"nextHashCode"),c("span",{style:{color:"#24292E"}},"()")])])]),c("button",{class:"collapse"})]),c("p",null,[p("使用 "),c("code",null,"threadLocalHashCode & (table.length - 1)"),p(" 计算当前 entry 需要存放的位置")])]),c("li",null,[c("p",null,"每创建一个 ThreadLocal 对象就会使用 nextHashCode 分配一个 hash 值给这个对象："),c("div",{style:{"max-height":"300px"},class:"language-java"},[c("button",{title:"Copy Code",class:"copy"}),c("span",{class:"lang"},"java"),c("pre",{class:"shiki github-dark vp-code-dark"},[c("code",null,[c("span",{class:"line"},[c("span",{style:{color:"#F97583"}},"private"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#F97583"}},"static"),c("span",{style:{color:"#E1E4E8"}}," AtomicInteger nextHashCode "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#F97583"}},"new"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#B392F0"}},"AtomicInteger"),c("span",{style:{color:"#E1E4E8"}},"()")])])]),c("pre",{class:"shiki github-light vp-code-light"},[c("code",null,[c("span",{class:"line"},[c("span",{style:{color:"#D73A49"}},"private"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#D73A49"}},"static"),c("span",{style:{color:"#24292E"}}," AtomicInteger nextHashCode "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#D73A49"}},"new"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#6F42C1"}},"AtomicInteger"),c("span",{style:{color:"#24292E"}},"()")])])]),c("button",{class:"collapse"})])]),c("li",null,[c("p",null,[p("斐波那契数也叫黄金分割数，hash 的"),c("strong",null,"增量"),p("就是这个数字，带来的好处是 hash 分布非常均匀：")]),c("div",{style:{"max-height":"300px"},class:"language-java"},[c("button",{title:"Copy Code",class:"copy"}),c("span",{class:"lang"},"java"),c("pre",{class:"shiki github-dark vp-code-dark"},[c("code",null,[c("span",{class:"line"},[c("span",{style:{color:"#F97583"}},"private"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#F97583"}},"static"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#F97583"}},"final"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#F97583"}},"int"),c("span",{style:{color:"#E1E4E8"}}," HASH_INCREMENT "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#79B8FF"}},"0x61c88647")])])]),c("pre",{class:"shiki github-light vp-code-light"},[c("code",null,[c("span",{class:"line"},[c("span",{style:{color:"#D73A49"}},"private"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#D73A49"}},"static"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#D73A49"}},"final"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#D73A49"}},"int"),c("span",{style:{color:"#24292E"}}," HASH_INCREMENT "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#005CC5"}},"0x61c88647")])])]),c("button",{class:"collapse"})])])],-1),Po=c("hr",null,null,-1),_o={id:"成员方法",tabindex:"-1"},Ro=c("p",null,"方法都是线程安全的，因为 ThreadLocal 属于一个线程的，ThreadLocal 中的方法，逻辑都是获取当前线程维护的 ThreadLocalMap 对象，然后进行数据的增删改查，没有指定初始值的 threadlcoal 对象默认赋值为 null",-1),Vo=c("ul",null,[c("li",null,[c("p",null,"initialValue()：返回该线程局部变量的初始值"),c("ul",null,[c("li",null,"延迟调用的方法，在执行 get 方法时才执行"),c("li",null,"该方法缺省（默认）实现直接返回一个 null"),c("li",null,[p("如果想要一个初始值，可以重写此方法， 该方法是一个 "),c("code",null,"protected"),p(" 的方法，为了让子类覆盖而设计的")])]),c("div",{style:{"max-height":"300px"},class:"language-java"},[c("button",{title:"Copy Code",class:"copy"}),c("span",{class:"lang"},"java"),c("pre",{class:"shiki github-dark vp-code-dark"},[c("code",null,[c("span",{class:"line"},[c("span",{style:{color:"#F97583"}},"protected"),c("span",{style:{color:"#E1E4E8"}}," T "),c("span",{style:{color:"#B392F0"}},"initialValue"),c("span",{style:{color:"#E1E4E8"}},"() {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#F97583"}},"return"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#79B8FF"}},"null"),c("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"}")])])]),c("pre",{class:"shiki github-light vp-code-light"},[c("code",null,[c("span",{class:"line"},[c("span",{style:{color:"#D73A49"}},"protected"),c("span",{style:{color:"#24292E"}}," T "),c("span",{style:{color:"#6F42C1"}},"initialValue"),c("span",{style:{color:"#24292E"}},"() {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#D73A49"}},"return"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#005CC5"}},"null"),c("span",{style:{color:"#24292E"}},";")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"}")])])]),c("button",{class:"collapse"})])]),c("li",null,[c("p",null,[p("nextHashCode()：计算哈希值，ThreadLocal 的散列方式称之为"),c("strong",null,"斐波那契散列"),p("，每次获取哈希值都会加上 HASH_INCREMENT，这样做可以尽量避免 hash 冲突，让哈希值能均匀的分布在 2 的 n 次方的数组中")]),c("div",{style:{"max-height":"300px"},class:"language-java"},[c("button",{title:"Copy Code",class:"copy"}),c("span",{class:"lang"},"java"),c("pre",{class:"shiki github-dark vp-code-dark"},[c("code",null,[c("span",{class:"line"},[c("span",{style:{color:"#F97583"}},"private"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#F97583"}},"static"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#F97583"}},"int"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#B392F0"}},"nextHashCode"),c("span",{style:{color:"#E1E4E8"}},"() {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#6A737D"}},"// 哈希值自增一个 HASH_INCREMENT 数值")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#F97583"}},"return"),c("span",{style:{color:"#E1E4E8"}}," nextHashCode."),c("span",{style:{color:"#B392F0"}},"getAndAdd"),c("span",{style:{color:"#E1E4E8"}},"(HASH_INCREMENT);")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"}")])])]),c("pre",{class:"shiki github-light vp-code-light"},[c("code",null,[c("span",{class:"line"},[c("span",{style:{color:"#D73A49"}},"private"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#D73A49"}},"static"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#D73A49"}},"int"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#6F42C1"}},"nextHashCode"),c("span",{style:{color:"#24292E"}},"() {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#6A737D"}},"// 哈希值自增一个 HASH_INCREMENT 数值")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#D73A49"}},"return"),c("span",{style:{color:"#24292E"}}," nextHashCode."),c("span",{style:{color:"#6F42C1"}},"getAndAdd"),c("span",{style:{color:"#24292E"}},"(HASH_INCREMENT);")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"}")])])]),c("button",{class:"collapse"})])]),c("li",null,[c("p",null,"set()：修改当前线程与当前 threadlocal 对象相关联的线程局部变量"),c("div",{style:{"max-height":"300px"},class:"language-java"},[c("button",{title:"Copy Code",class:"copy"}),c("span",{class:"lang"},"java"),c("pre",{class:"shiki github-dark vp-code-dark"},[c("code",null,[c("span",{class:"line"},[c("span",{style:{color:"#F97583"}},"public"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#F97583"}},"void"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#B392F0"}},"set"),c("span",{style:{color:"#E1E4E8"}},"(T value) {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#6A737D"}},"// 获取当前线程对象")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    Thread t "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," Thread."),c("span",{style:{color:"#B392F0"}},"currentThread"),c("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#6A737D"}},"// 获取此线程对象中维护的 ThreadLocalMap 对象")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    ThreadLocalMap map "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#B392F0"}},"getMap"),c("span",{style:{color:"#E1E4E8"}},"(t);")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#6A737D"}},"// 判断 map 是否存在")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#F97583"}},"if"),c("span",{style:{color:"#E1E4E8"}}," (map "),c("span",{style:{color:"#F97583"}},"!="),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#79B8FF"}},"null"),c("span",{style:{color:"#E1E4E8"}},")")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        "),c("span",{style:{color:"#6A737D"}},"// 调用 threadLocalMap.set 方法进行重写或者添加")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        map."),c("span",{style:{color:"#B392F0"}},"set"),c("span",{style:{color:"#E1E4E8"}},"("),c("span",{style:{color:"#79B8FF"}},"this"),c("span",{style:{color:"#E1E4E8"}},", value);")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#F97583"}},"else")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        "),c("span",{style:{color:"#6A737D"}},"// map 为空，调用 createMap 进行 ThreadLocalMap 对象的初始化。参数1是当前线程，参数2是局部变量")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        "),c("span",{style:{color:"#B392F0"}},"createMap"),c("span",{style:{color:"#E1E4E8"}},"(t, value);")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"}")])])]),c("pre",{class:"shiki github-light vp-code-light"},[c("code",null,[c("span",{class:"line"},[c("span",{style:{color:"#D73A49"}},"public"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#D73A49"}},"void"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#6F42C1"}},"set"),c("span",{style:{color:"#24292E"}},"(T value) {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#6A737D"}},"// 获取当前线程对象")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    Thread t "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," Thread."),c("span",{style:{color:"#6F42C1"}},"currentThread"),c("span",{style:{color:"#24292E"}},"();")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#6A737D"}},"// 获取此线程对象中维护的 ThreadLocalMap 对象")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    ThreadLocalMap map "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#6F42C1"}},"getMap"),c("span",{style:{color:"#24292E"}},"(t);")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#6A737D"}},"// 判断 map 是否存在")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#D73A49"}},"if"),c("span",{style:{color:"#24292E"}}," (map "),c("span",{style:{color:"#D73A49"}},"!="),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#005CC5"}},"null"),c("span",{style:{color:"#24292E"}},")")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        "),c("span",{style:{color:"#6A737D"}},"// 调用 threadLocalMap.set 方法进行重写或者添加")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        map."),c("span",{style:{color:"#6F42C1"}},"set"),c("span",{style:{color:"#24292E"}},"("),c("span",{style:{color:"#005CC5"}},"this"),c("span",{style:{color:"#24292E"}},", value);")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#D73A49"}},"else")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        "),c("span",{style:{color:"#6A737D"}},"// map 为空，调用 createMap 进行 ThreadLocalMap 对象的初始化。参数1是当前线程，参数2是局部变量")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        "),c("span",{style:{color:"#6F42C1"}},"createMap"),c("span",{style:{color:"#24292E"}},"(t, value);")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"}")])])]),c("button",{class:"collapse"})]),c("div",{style:{"max-height":"300px"},class:"language-java"},[c("button",{title:"Copy Code",class:"copy"}),c("span",{class:"lang"},"java"),c("pre",{class:"shiki github-dark vp-code-dark"},[c("code",null,[c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"// 获取当前线程 Thread 对应维护的 ThreadLocalMap ")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"ThreadLocalMap "),c("span",{style:{color:"#B392F0"}},"getMap"),c("span",{style:{color:"#E1E4E8"}},"(Thread t) {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#F97583"}},"return"),c("span",{style:{color:"#E1E4E8"}}," t.threadLocals;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"}")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"// 创建当前线程Thread对应维护的ThreadLocalMap ")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#F97583"}},"void"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#B392F0"}},"createMap"),c("span",{style:{color:"#E1E4E8"}},"(Thread t, T firstValue) {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#6A737D"}},"// 【这里的 this 是调用此方法的 threadLocal】，创建一个新的 Map 并设置第一个数据")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    t.threadLocals "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#F97583"}},"new"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#B392F0"}},"ThreadLocalMap"),c("span",{style:{color:"#E1E4E8"}},"("),c("span",{style:{color:"#79B8FF"}},"this"),c("span",{style:{color:"#E1E4E8"}},", firstValue);")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"}")])])]),c("pre",{class:"shiki github-light vp-code-light"},[c("code",null,[c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"// 获取当前线程 Thread 对应维护的 ThreadLocalMap ")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"ThreadLocalMap "),c("span",{style:{color:"#6F42C1"}},"getMap"),c("span",{style:{color:"#24292E"}},"(Thread t) {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#D73A49"}},"return"),c("span",{style:{color:"#24292E"}}," t.threadLocals;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"}")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"// 创建当前线程Thread对应维护的ThreadLocalMap ")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#D73A49"}},"void"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#6F42C1"}},"createMap"),c("span",{style:{color:"#24292E"}},"(Thread t, T firstValue) {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#6A737D"}},"// 【这里的 this 是调用此方法的 threadLocal】，创建一个新的 Map 并设置第一个数据")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    t.threadLocals "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#D73A49"}},"new"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#6F42C1"}},"ThreadLocalMap"),c("span",{style:{color:"#24292E"}},"("),c("span",{style:{color:"#005CC5"}},"this"),c("span",{style:{color:"#24292E"}},", firstValue);")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"}")])])]),c("button",{class:"collapse"})])]),c("li",null,[c("p",null,"get()：获取当前线程与当前 ThreadLocal 对象相关联的线程局部变量"),c("div",{style:{"max-height":"300px"},class:"language-java"},[c("button",{title:"Copy Code",class:"copy"}),c("span",{class:"lang"},"java"),c("pre",{class:"shiki github-dark vp-code-dark"},[c("code",null,[c("span",{class:"line"},[c("span",{style:{color:"#F97583"}},"public"),c("span",{style:{color:"#E1E4E8"}}," T "),c("span",{style:{color:"#B392F0"}},"get"),c("span",{style:{color:"#E1E4E8"}},"() {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    Thread t "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," Thread."),c("span",{style:{color:"#B392F0"}},"currentThread"),c("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    ThreadLocalMap map "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#B392F0"}},"getMap"),c("span",{style:{color:"#E1E4E8"}},"(t);")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#6A737D"}},"// 如果此map存在")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#F97583"}},"if"),c("span",{style:{color:"#E1E4E8"}}," (map "),c("span",{style:{color:"#F97583"}},"!="),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#79B8FF"}},"null"),c("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        "),c("span",{style:{color:"#6A737D"}},"// 以当前的 ThreadLocal 为 key，调用 getEntry 获取对应的存储实体 e")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        ThreadLocalMap.Entry e "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," map."),c("span",{style:{color:"#B392F0"}},"getEntry"),c("span",{style:{color:"#E1E4E8"}},"("),c("span",{style:{color:"#79B8FF"}},"this"),c("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        "),c("span",{style:{color:"#6A737D"}},"// 对 e 进行判空 ")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        "),c("span",{style:{color:"#F97583"}},"if"),c("span",{style:{color:"#E1E4E8"}}," (e "),c("span",{style:{color:"#F97583"}},"!="),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#79B8FF"}},"null"),c("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"            "),c("span",{style:{color:"#6A737D"}},"// 获取存储实体 e 对应的 value值")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"            T result "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," (T)e.value;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"            "),c("span",{style:{color:"#F97583"}},"return"),c("span",{style:{color:"#E1E4E8"}}," result;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        }")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#6A737D"}},"/*有两种情况有执行当前代码")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"      第一种情况: map 不存在，表示此线程没有维护的 ThreadLocalMap 对象")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"      第二种情况: map 存在, 但是【没有与当前 ThreadLocal 关联的 entry】，就会设置为默认值 */")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#6A737D"}},"// 初始化当前线程与当前 threadLocal 对象相关联的 value")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#F97583"}},"return"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#B392F0"}},"setInitialValue"),c("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"}")])])]),c("pre",{class:"shiki github-light vp-code-light"},[c("code",null,[c("span",{class:"line"},[c("span",{style:{color:"#D73A49"}},"public"),c("span",{style:{color:"#24292E"}}," T "),c("span",{style:{color:"#6F42C1"}},"get"),c("span",{style:{color:"#24292E"}},"() {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    Thread t "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," Thread."),c("span",{style:{color:"#6F42C1"}},"currentThread"),c("span",{style:{color:"#24292E"}},"();")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    ThreadLocalMap map "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#6F42C1"}},"getMap"),c("span",{style:{color:"#24292E"}},"(t);")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#6A737D"}},"// 如果此map存在")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#D73A49"}},"if"),c("span",{style:{color:"#24292E"}}," (map "),c("span",{style:{color:"#D73A49"}},"!="),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#005CC5"}},"null"),c("span",{style:{color:"#24292E"}},") {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        "),c("span",{style:{color:"#6A737D"}},"// 以当前的 ThreadLocal 为 key，调用 getEntry 获取对应的存储实体 e")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        ThreadLocalMap.Entry e "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," map."),c("span",{style:{color:"#6F42C1"}},"getEntry"),c("span",{style:{color:"#24292E"}},"("),c("span",{style:{color:"#005CC5"}},"this"),c("span",{style:{color:"#24292E"}},");")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        "),c("span",{style:{color:"#6A737D"}},"// 对 e 进行判空 ")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        "),c("span",{style:{color:"#D73A49"}},"if"),c("span",{style:{color:"#24292E"}}," (e "),c("span",{style:{color:"#D73A49"}},"!="),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#005CC5"}},"null"),c("span",{style:{color:"#24292E"}},") {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"            "),c("span",{style:{color:"#6A737D"}},"// 获取存储实体 e 对应的 value值")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"            T result "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," (T)e.value;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"            "),c("span",{style:{color:"#D73A49"}},"return"),c("span",{style:{color:"#24292E"}}," result;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        }")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    }")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#6A737D"}},"/*有两种情况有执行当前代码")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"      第一种情况: map 不存在，表示此线程没有维护的 ThreadLocalMap 对象")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"      第二种情况: map 存在, 但是【没有与当前 ThreadLocal 关联的 entry】，就会设置为默认值 */")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#6A737D"}},"// 初始化当前线程与当前 threadLocal 对象相关联的 value")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#D73A49"}},"return"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#6F42C1"}},"setInitialValue"),c("span",{style:{color:"#24292E"}},"();")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"}")])])]),c("button",{class:"collapse"})]),c("div",{style:{"max-height":"300px"},class:"language-java"},[c("button",{title:"Copy Code",class:"copy"}),c("span",{class:"lang"},"java"),c("pre",{class:"shiki github-dark vp-code-dark"},[c("code",null,[c("span",{class:"line"},[c("span",{style:{color:"#F97583"}},"private"),c("span",{style:{color:"#E1E4E8"}}," T "),c("span",{style:{color:"#B392F0"}},"setInitialValue"),c("span",{style:{color:"#E1E4E8"}},"() {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#6A737D"}},"// 调用initialValue获取初始化的值，此方法可以被子类重写, 如果不重写默认返回 null")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    T value "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#B392F0"}},"initialValue"),c("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    Thread t "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," Thread."),c("span",{style:{color:"#B392F0"}},"currentThread"),c("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    ThreadLocalMap map "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#B392F0"}},"getMap"),c("span",{style:{color:"#E1E4E8"}},"(t);")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#6A737D"}},"// 判断 map 是否初始化过")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#F97583"}},"if"),c("span",{style:{color:"#E1E4E8"}}," (map "),c("span",{style:{color:"#F97583"}},"!="),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#79B8FF"}},"null"),c("span",{style:{color:"#E1E4E8"}},")")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        "),c("span",{style:{color:"#6A737D"}},"// 存在则调用 map.set 设置此实体 entry，value 是默认的值")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        map."),c("span",{style:{color:"#B392F0"}},"set"),c("span",{style:{color:"#E1E4E8"}},"("),c("span",{style:{color:"#79B8FF"}},"this"),c("span",{style:{color:"#E1E4E8"}},", value);")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#F97583"}},"else")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        "),c("span",{style:{color:"#6A737D"}},"// 调用 createMap 进行 ThreadLocalMap 对象的初始化中")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        "),c("span",{style:{color:"#B392F0"}},"createMap"),c("span",{style:{color:"#E1E4E8"}},"(t, value);")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#6A737D"}},"// 返回线程与当前 threadLocal 关联的局部变量")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#F97583"}},"return"),c("span",{style:{color:"#E1E4E8"}}," value;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"}")])])]),c("pre",{class:"shiki github-light vp-code-light"},[c("code",null,[c("span",{class:"line"},[c("span",{style:{color:"#D73A49"}},"private"),c("span",{style:{color:"#24292E"}}," T "),c("span",{style:{color:"#6F42C1"}},"setInitialValue"),c("span",{style:{color:"#24292E"}},"() {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#6A737D"}},"// 调用initialValue获取初始化的值，此方法可以被子类重写, 如果不重写默认返回 null")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    T value "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#6F42C1"}},"initialValue"),c("span",{style:{color:"#24292E"}},"();")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    Thread t "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," Thread."),c("span",{style:{color:"#6F42C1"}},"currentThread"),c("span",{style:{color:"#24292E"}},"();")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    ThreadLocalMap map "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#6F42C1"}},"getMap"),c("span",{style:{color:"#24292E"}},"(t);")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#6A737D"}},"// 判断 map 是否初始化过")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#D73A49"}},"if"),c("span",{style:{color:"#24292E"}}," (map "),c("span",{style:{color:"#D73A49"}},"!="),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#005CC5"}},"null"),c("span",{style:{color:"#24292E"}},")")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        "),c("span",{style:{color:"#6A737D"}},"// 存在则调用 map.set 设置此实体 entry，value 是默认的值")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        map."),c("span",{style:{color:"#6F42C1"}},"set"),c("span",{style:{color:"#24292E"}},"("),c("span",{style:{color:"#005CC5"}},"this"),c("span",{style:{color:"#24292E"}},", value);")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#D73A49"}},"else")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        "),c("span",{style:{color:"#6A737D"}},"// 调用 createMap 进行 ThreadLocalMap 对象的初始化中")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        "),c("span",{style:{color:"#6F42C1"}},"createMap"),c("span",{style:{color:"#24292E"}},"(t, value);")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#6A737D"}},"// 返回线程与当前 threadLocal 关联的局部变量")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#D73A49"}},"return"),c("span",{style:{color:"#24292E"}}," value;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"}")])])]),c("button",{class:"collapse"})])]),c("li",null,[c("p",null,"remove()：移除当前线程与当前 threadLocal 对象相关联的线程局部变量"),c("div",{style:{"max-height":"300px"},class:"language-java"},[c("button",{title:"Copy Code",class:"copy"}),c("span",{class:"lang"},"java"),c("pre",{class:"shiki github-dark vp-code-dark"},[c("code",null,[c("span",{class:"line"},[c("span",{style:{color:"#F97583"}},"public"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#F97583"}},"void"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#B392F0"}},"remove"),c("span",{style:{color:"#E1E4E8"}},"() {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#6A737D"}},"// 获取当前线程对象中维护的 ThreadLocalMap 对象")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    ThreadLocalMap m "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#B392F0"}},"getMap"),c("span",{style:{color:"#E1E4E8"}},"(Thread."),c("span",{style:{color:"#B392F0"}},"currentThread"),c("span",{style:{color:"#E1E4E8"}},"());")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#F97583"}},"if"),c("span",{style:{color:"#E1E4E8"}}," (m "),c("span",{style:{color:"#F97583"}},"!="),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#79B8FF"}},"null"),c("span",{style:{color:"#E1E4E8"}},")")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        "),c("span",{style:{color:"#6A737D"}},"// map 存在则调用 map.remove，this时当前ThreadLocal，以this为key删除对应的实体")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        m."),c("span",{style:{color:"#B392F0"}},"remove"),c("span",{style:{color:"#E1E4E8"}},"("),c("span",{style:{color:"#79B8FF"}},"this"),c("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"}")])])]),c("pre",{class:"shiki github-light vp-code-light"},[c("code",null,[c("span",{class:"line"},[c("span",{style:{color:"#D73A49"}},"public"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#D73A49"}},"void"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#6F42C1"}},"remove"),c("span",{style:{color:"#24292E"}},"() {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#6A737D"}},"// 获取当前线程对象中维护的 ThreadLocalMap 对象")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    ThreadLocalMap m "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#6F42C1"}},"getMap"),c("span",{style:{color:"#24292E"}},"(Thread."),c("span",{style:{color:"#6F42C1"}},"currentThread"),c("span",{style:{color:"#24292E"}},"());")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#D73A49"}},"if"),c("span",{style:{color:"#24292E"}}," (m "),c("span",{style:{color:"#D73A49"}},"!="),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#005CC5"}},"null"),c("span",{style:{color:"#24292E"}},")")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        "),c("span",{style:{color:"#6A737D"}},"// map 存在则调用 map.remove，this时当前ThreadLocal，以this为key删除对应的实体")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        m."),c("span",{style:{color:"#6F42C1"}},"remove"),c("span",{style:{color:"#24292E"}},"("),c("span",{style:{color:"#005CC5"}},"this"),c("span",{style:{color:"#24292E"}},");")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"}")])])]),c("button",{class:"collapse"})])])],-1),Oo=c("hr",null,null,-1),zo={id:"localmap",tabindex:"-1"},No={id:"成员属性",tabindex:"-1"},Ho=c("p",null,"ThreadLocalMap 是 ThreadLocal 的内部类，没有实现 Map 接口，用独立的方式实现了 Map 的功能，其内部 Entry 也是独立实现",-1),Go=c("div",{style:{"max-height":"300px"},class:"language-java"},[c("button",{title:"Copy Code",class:"copy"}),c("span",{class:"lang"},"java"),c("pre",{class:"shiki github-dark vp-code-dark"},[c("code",null,[c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"// 初始化当前 map 内部散列表数组的初始长度 16")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#F97583"}},"private"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#F97583"}},"static"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#F97583"}},"final"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#F97583"}},"int"),c("span",{style:{color:"#E1E4E8"}}," INITIAL_CAPACITY "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#79B8FF"}},"16"),c("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"// 存放数据的table，数组长度必须是2的整次幂。")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#F97583"}},"private"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#F97583"}},"Entry"),c("span",{style:{color:"#E1E4E8"}},"[] table;")]),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"// 数组里面 entrys 的个数，可以用于判断 table 当前使用量是否超过阈值")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#F97583"}},"private"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#F97583"}},"int"),c("span",{style:{color:"#E1E4E8"}}," size "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#79B8FF"}},"0"),c("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"// 进行扩容的阈值，表使用量大于它的时候进行扩容。")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#F97583"}},"private"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#F97583"}},"int"),c("span",{style:{color:"#E1E4E8"}}," threshold;")])])]),c("pre",{class:"shiki github-light vp-code-light"},[c("code",null,[c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"// 初始化当前 map 内部散列表数组的初始长度 16")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#D73A49"}},"private"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#D73A49"}},"static"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#D73A49"}},"final"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#D73A49"}},"int"),c("span",{style:{color:"#24292E"}}," INITIAL_CAPACITY "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#005CC5"}},"16"),c("span",{style:{color:"#24292E"}},";")]),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"// 存放数据的table，数组长度必须是2的整次幂。")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#D73A49"}},"private"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#D73A49"}},"Entry"),c("span",{style:{color:"#24292E"}},"[] table;")]),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"// 数组里面 entrys 的个数，可以用于判断 table 当前使用量是否超过阈值")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#D73A49"}},"private"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#D73A49"}},"int"),c("span",{style:{color:"#24292E"}}," size "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#005CC5"}},"0"),c("span",{style:{color:"#24292E"}},";")]),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"// 进行扩容的阈值，表使用量大于它的时候进行扩容。")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#D73A49"}},"private"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#D73A49"}},"int"),c("span",{style:{color:"#24292E"}}," threshold;")])])]),c("button",{class:"collapse"})],-1),Ko=c("p",null,"存储结构 Entry：",-1),Jo=c("ul",null,[c("li",null,"Entry 继承 WeakReference，key 是弱引用，目的是将 ThreadLocal 对象的生命周期和线程生命周期解绑"),c("li",null,"Entry 限制只能用 ThreadLocal 作为 key，key 为 null (entry.get() == null) 意味着 key 不再被引用，entry 也可以从 table 中清除")],-1),$o=c("div",{style:{"max-height":"300px"},class:"language-java"},[c("button",{title:"Copy Code",class:"copy"}),c("span",{class:"lang"},"java"),c("pre",{class:"shiki github-dark vp-code-dark"},[c("code",null,[c("span",{class:"line"},[c("span",{style:{color:"#F97583"}},"static"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#F97583"}},"class"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#B392F0"}},"Entry"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#F97583"}},"extends"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#B392F0"}},"WeakReference"),c("span",{style:{color:"#E1E4E8"}},"<ThreadLocal<"),c("span",{style:{color:"#F97583"}},"?"),c("span",{style:{color:"#E1E4E8"}},">> {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    Object value;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#B392F0"}},"Entry"),c("span",{style:{color:"#E1E4E8"}},"(ThreadLocal<"),c("span",{style:{color:"#F97583"}},"?"),c("span",{style:{color:"#E1E4E8"}},"> "),c("span",{style:{color:"#FFAB70"}},"k"),c("span",{style:{color:"#E1E4E8"}},", Object "),c("span",{style:{color:"#FFAB70"}},"v"),c("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        "),c("span",{style:{color:"#6A737D"}},"// this.referent = referent = key;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        "),c("span",{style:{color:"#79B8FF"}},"super"),c("span",{style:{color:"#E1E4E8"}},"(k);")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        value "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," v;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"}")])])]),c("pre",{class:"shiki github-light vp-code-light"},[c("code",null,[c("span",{class:"line"},[c("span",{style:{color:"#D73A49"}},"static"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#D73A49"}},"class"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#6F42C1"}},"Entry"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#D73A49"}},"extends"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#6F42C1"}},"WeakReference"),c("span",{style:{color:"#24292E"}},"<ThreadLocal<"),c("span",{style:{color:"#D73A49"}},"?"),c("span",{style:{color:"#24292E"}},">> {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    Object value;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#6F42C1"}},"Entry"),c("span",{style:{color:"#24292E"}},"(ThreadLocal<"),c("span",{style:{color:"#D73A49"}},"?"),c("span",{style:{color:"#24292E"}},"> "),c("span",{style:{color:"#E36209"}},"k"),c("span",{style:{color:"#24292E"}},", Object "),c("span",{style:{color:"#E36209"}},"v"),c("span",{style:{color:"#24292E"}},") {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        "),c("span",{style:{color:"#6A737D"}},"// this.referent = referent = key;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        "),c("span",{style:{color:"#005CC5"}},"super"),c("span",{style:{color:"#24292E"}},"(k);")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        value "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," v;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    }")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"}")])])]),c("button",{class:"collapse"})],-1),Yo=c("p",null,"构造方法：延迟初始化的，线程第一次存储 threadLocal - value 时才会创建 threadLocalMap 对象",-1),qo=c("div",{style:{"max-height":"300px"},class:"language-java"},[c("button",{title:"Copy Code",class:"copy"}),c("span",{class:"lang"},"java"),c("pre",{class:"shiki github-dark vp-code-dark"},[c("code",null,[c("span",{class:"line"},[c("span",{style:{color:"#B392F0"}},"ThreadLocalMap"),c("span",{style:{color:"#E1E4E8"}},"(ThreadLocal"),c("span",{style:{color:"#F97583"}},"<?>"),c("span",{style:{color:"#E1E4E8"}}," firstKey, Object firstValue) {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#6A737D"}},"// 初始化table，创建一个长度为16的Entry数组")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    table "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#F97583"}},"new"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#F97583"}},"Entry"),c("span",{style:{color:"#E1E4E8"}},"[INITIAL_CAPACITY];")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#6A737D"}},"// 【寻址算法】计算索引")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#F97583"}},"int"),c("span",{style:{color:"#E1E4E8"}}," i "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," firstKey.threadLocalHashCode "),c("span",{style:{color:"#F97583"}},"&"),c("span",{style:{color:"#E1E4E8"}}," (INITIAL_CAPACITY "),c("span",{style:{color:"#F97583"}},"-"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#79B8FF"}},"1"),c("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#6A737D"}},"// 创建 entry 对象，存放到指定位置的 slot 中")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    table[i] "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#F97583"}},"new"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#B392F0"}},"Entry"),c("span",{style:{color:"#E1E4E8"}},"(firstKey, firstValue);")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#6A737D"}},"// 数据总量是 1")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    size "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#79B8FF"}},"1"),c("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#6A737D"}},"// 将阈值设置为 （当前数组长度 * 2）/ 3。")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#B392F0"}},"setThreshold"),c("span",{style:{color:"#E1E4E8"}},"(INITIAL_CAPACITY);")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"}")])])]),c("pre",{class:"shiki github-light vp-code-light"},[c("code",null,[c("span",{class:"line"},[c("span",{style:{color:"#6F42C1"}},"ThreadLocalMap"),c("span",{style:{color:"#24292E"}},"(ThreadLocal"),c("span",{style:{color:"#D73A49"}},"<?>"),c("span",{style:{color:"#24292E"}}," firstKey, Object firstValue) {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#6A737D"}},"// 初始化table，创建一个长度为16的Entry数组")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    table "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#D73A49"}},"new"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#D73A49"}},"Entry"),c("span",{style:{color:"#24292E"}},"[INITIAL_CAPACITY];")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#6A737D"}},"// 【寻址算法】计算索引")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#D73A49"}},"int"),c("span",{style:{color:"#24292E"}}," i "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," firstKey.threadLocalHashCode "),c("span",{style:{color:"#D73A49"}},"&"),c("span",{style:{color:"#24292E"}}," (INITIAL_CAPACITY "),c("span",{style:{color:"#D73A49"}},"-"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#005CC5"}},"1"),c("span",{style:{color:"#24292E"}},");")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#6A737D"}},"// 创建 entry 对象，存放到指定位置的 slot 中")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    table[i] "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#D73A49"}},"new"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#6F42C1"}},"Entry"),c("span",{style:{color:"#24292E"}},"(firstKey, firstValue);")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#6A737D"}},"// 数据总量是 1")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    size "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#005CC5"}},"1"),c("span",{style:{color:"#24292E"}},";")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#6A737D"}},"// 将阈值设置为 （当前数组长度 * 2）/ 3。")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#6F42C1"}},"setThreshold"),c("span",{style:{color:"#24292E"}},"(INITIAL_CAPACITY);")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"}")])])]),c("button",{class:"collapse"})],-1),Wo=c("hr",null,null,-1),Qo={id:"成员方法-1",tabindex:"-1"},Zo=c("ul",null,[c("li",null,[c("p",null,[p("set()：添加数据，ThreadLocalMap 使用"),c("strong",null,"线性探测法来解决哈希冲突")]),c("ul",null,[c("li",null,[c("p",null,"该方法会一直探测下一个地址，直到有空的地址后插入，若插入后 Map 数量超过阈值，数组会扩容为原来的 2 倍"),c("p",null,[p("假设当前 table 长度为16，计算出来 key 的 hash 值为 14，如果 table[14] 上已经有值，并且其 key 与当前 key 不一致，那么就发生了 hash 冲突，这个时候将 14 加 1 得到 15，取 table[15] 进行判断，如果还是冲突会回到 0，取 table[0]，以此类推，直到可以插入，可以把 Entry[] table 看成一个"),c("strong",null,"环形数组")])]),c("li",null,[c("p",null,[p("线性探测法会出现"),c("strong",null,"堆积问题"),p("，可以采取平方探测法解决")])]),c("li",null,[c("p",null,"在探测过程中 ThreadLocal 会复用 key 为 null 的脏 Entry 对象，并进行垃圾清理，防止出现内存泄漏")])]),c("div",{style:{"max-height":"300px"},class:"language-java"},[c("button",{title:"Copy Code",class:"copy"}),c("span",{class:"lang"},"java"),c("pre",{class:"shiki github-dark vp-code-dark"},[c("code",null,[c("span",{class:"line"},[c("span",{style:{color:"#F97583"}},"private"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#F97583"}},"void"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#B392F0"}},"set"),c("span",{style:{color:"#E1E4E8"}},"(ThreadLocal"),c("span",{style:{color:"#F97583"}},"<?>"),c("span",{style:{color:"#E1E4E8"}}," key, Object value) {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#6A737D"}},"// 获取散列表")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    ThreadLocal.ThreadLocalMap."),c("span",{style:{color:"#F97583"}},"Entry"),c("span",{style:{color:"#E1E4E8"}},"[] tab "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," table;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#F97583"}},"int"),c("span",{style:{color:"#E1E4E8"}}," len "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," tab.length;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#6A737D"}},"// 哈希寻址")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#F97583"}},"int"),c("span",{style:{color:"#E1E4E8"}}," i "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," key.threadLocalHashCode "),c("span",{style:{color:"#F97583"}},"&"),c("span",{style:{color:"#E1E4E8"}}," (len"),c("span",{style:{color:"#F97583"}},"-"),c("span",{style:{color:"#79B8FF"}},"1"),c("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#6A737D"}},"// 使用线性探测法向后查找元素，碰到 entry 为空时停止探测")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#F97583"}},"for"),c("span",{style:{color:"#E1E4E8"}}," (ThreadLocal.ThreadLocalMap.Entry e "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," tab[i]; e "),c("span",{style:{color:"#F97583"}},"!="),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#79B8FF"}},"null"),c("span",{style:{color:"#E1E4E8"}},"; e "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," tab[i "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#B392F0"}},"nextIndex"),c("span",{style:{color:"#E1E4E8"}},"(i, len)]) {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        "),c("span",{style:{color:"#6A737D"}},"// 获取当前元素 key")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        ThreadLocal<"),c("span",{style:{color:"#F97583"}},"?"),c("span",{style:{color:"#E1E4E8"}},"> k "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," e."),c("span",{style:{color:"#B392F0"}},"get"),c("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        "),c("span",{style:{color:"#6A737D"}},"// ThreadLocal 对应的 key 存在，【直接覆盖之前的值】")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        "),c("span",{style:{color:"#F97583"}},"if"),c("span",{style:{color:"#E1E4E8"}}," (k "),c("span",{style:{color:"#F97583"}},"=="),c("span",{style:{color:"#E1E4E8"}}," key) {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"            e.value "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," value;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"            "),c("span",{style:{color:"#F97583"}},"return"),c("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        }")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        "),c("span",{style:{color:"#6A737D"}},"// 【这两个条件谁先成立不一定，所以 replaceStaleEntry 中还需要判断 k == key 的情况】")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        ")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        "),c("span",{style:{color:"#6A737D"}},"// key 为 null，但是值不为 null，说明之前的 ThreadLocal 对象已经被回收了，当前是【过期数据】")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        "),c("span",{style:{color:"#F97583"}},"if"),c("span",{style:{color:"#E1E4E8"}}," (k "),c("span",{style:{color:"#F97583"}},"=="),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#79B8FF"}},"null"),c("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"            "),c("span",{style:{color:"#6A737D"}},"// 【碰到一个过期的 slot，当前数据复用该槽位，替换过期数据】")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"            "),c("span",{style:{color:"#6A737D"}},"// 这个方法还进行了垃圾清理动作，防止内存泄漏")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"            "),c("span",{style:{color:"#B392F0"}},"replaceStaleEntry"),c("span",{style:{color:"#E1E4E8"}},"(key, value, i);")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"            "),c("span",{style:{color:"#F97583"}},"return"),c("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        }")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"\t"),c("span",{style:{color:"#6A737D"}},"// 逻辑到这说明碰到 slot == null 的位置，则在空元素的位置创建一个新的 Entry")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    tab[i] "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#F97583"}},"new"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#B392F0"}},"Entry"),c("span",{style:{color:"#E1E4E8"}},"(key, value);")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#6A737D"}},"// 数量 + 1")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#F97583"}},"int"),c("span",{style:{color:"#E1E4E8"}}," sz "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#F97583"}},"++"),c("span",{style:{color:"#E1E4E8"}},"size;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    ")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#6A737D"}},"// 【做一次启发式清理】，如果没有清除任何 entry 并且【当前使用量达到了负载因子所定义，那么进行 rehash")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#F97583"}},"if"),c("span",{style:{color:"#E1E4E8"}}," ("),c("span",{style:{color:"#F97583"}},"!"),c("span",{style:{color:"#B392F0"}},"cleanSomeSlots"),c("span",{style:{color:"#E1E4E8"}},"(i, sz) "),c("span",{style:{color:"#F97583"}},"&&"),c("span",{style:{color:"#E1E4E8"}}," sz "),c("span",{style:{color:"#F97583"}},">="),c("span",{style:{color:"#E1E4E8"}}," threshold)")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        "),c("span",{style:{color:"#6A737D"}},"// 扩容")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        "),c("span",{style:{color:"#B392F0"}},"rehash"),c("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"}")])])]),c("pre",{class:"shiki github-light vp-code-light"},[c("code",null,[c("span",{class:"line"},[c("span",{style:{color:"#D73A49"}},"private"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#D73A49"}},"void"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#6F42C1"}},"set"),c("span",{style:{color:"#24292E"}},"(ThreadLocal"),c("span",{style:{color:"#D73A49"}},"<?>"),c("span",{style:{color:"#24292E"}}," key, Object value) {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#6A737D"}},"// 获取散列表")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    ThreadLocal.ThreadLocalMap."),c("span",{style:{color:"#D73A49"}},"Entry"),c("span",{style:{color:"#24292E"}},"[] tab "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," table;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#D73A49"}},"int"),c("span",{style:{color:"#24292E"}}," len "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," tab.length;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#6A737D"}},"// 哈希寻址")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#D73A49"}},"int"),c("span",{style:{color:"#24292E"}}," i "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," key.threadLocalHashCode "),c("span",{style:{color:"#D73A49"}},"&"),c("span",{style:{color:"#24292E"}}," (len"),c("span",{style:{color:"#D73A49"}},"-"),c("span",{style:{color:"#005CC5"}},"1"),c("span",{style:{color:"#24292E"}},");")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#6A737D"}},"// 使用线性探测法向后查找元素，碰到 entry 为空时停止探测")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#D73A49"}},"for"),c("span",{style:{color:"#24292E"}}," (ThreadLocal.ThreadLocalMap.Entry e "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," tab[i]; e "),c("span",{style:{color:"#D73A49"}},"!="),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#005CC5"}},"null"),c("span",{style:{color:"#24292E"}},"; e "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," tab[i "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#6F42C1"}},"nextIndex"),c("span",{style:{color:"#24292E"}},"(i, len)]) {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        "),c("span",{style:{color:"#6A737D"}},"// 获取当前元素 key")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        ThreadLocal<"),c("span",{style:{color:"#D73A49"}},"?"),c("span",{style:{color:"#24292E"}},"> k "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," e."),c("span",{style:{color:"#6F42C1"}},"get"),c("span",{style:{color:"#24292E"}},"();")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        "),c("span",{style:{color:"#6A737D"}},"// ThreadLocal 对应的 key 存在，【直接覆盖之前的值】")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        "),c("span",{style:{color:"#D73A49"}},"if"),c("span",{style:{color:"#24292E"}}," (k "),c("span",{style:{color:"#D73A49"}},"=="),c("span",{style:{color:"#24292E"}}," key) {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"            e.value "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," value;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"            "),c("span",{style:{color:"#D73A49"}},"return"),c("span",{style:{color:"#24292E"}},";")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        }")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        "),c("span",{style:{color:"#6A737D"}},"// 【这两个条件谁先成立不一定，所以 replaceStaleEntry 中还需要判断 k == key 的情况】")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        ")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        "),c("span",{style:{color:"#6A737D"}},"// key 为 null，但是值不为 null，说明之前的 ThreadLocal 对象已经被回收了，当前是【过期数据】")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        "),c("span",{style:{color:"#D73A49"}},"if"),c("span",{style:{color:"#24292E"}}," (k "),c("span",{style:{color:"#D73A49"}},"=="),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#005CC5"}},"null"),c("span",{style:{color:"#24292E"}},") {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"            "),c("span",{style:{color:"#6A737D"}},"// 【碰到一个过期的 slot，当前数据复用该槽位，替换过期数据】")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"            "),c("span",{style:{color:"#6A737D"}},"// 这个方法还进行了垃圾清理动作，防止内存泄漏")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"            "),c("span",{style:{color:"#6F42C1"}},"replaceStaleEntry"),c("span",{style:{color:"#24292E"}},"(key, value, i);")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"            "),c("span",{style:{color:"#D73A49"}},"return"),c("span",{style:{color:"#24292E"}},";")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        }")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    }")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"\t"),c("span",{style:{color:"#6A737D"}},"// 逻辑到这说明碰到 slot == null 的位置，则在空元素的位置创建一个新的 Entry")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    tab[i] "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#D73A49"}},"new"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#6F42C1"}},"Entry"),c("span",{style:{color:"#24292E"}},"(key, value);")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#6A737D"}},"// 数量 + 1")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#D73A49"}},"int"),c("span",{style:{color:"#24292E"}}," sz "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#D73A49"}},"++"),c("span",{style:{color:"#24292E"}},"size;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    ")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#6A737D"}},"// 【做一次启发式清理】，如果没有清除任何 entry 并且【当前使用量达到了负载因子所定义，那么进行 rehash")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#D73A49"}},"if"),c("span",{style:{color:"#24292E"}}," ("),c("span",{style:{color:"#D73A49"}},"!"),c("span",{style:{color:"#6F42C1"}},"cleanSomeSlots"),c("span",{style:{color:"#24292E"}},"(i, sz) "),c("span",{style:{color:"#D73A49"}},"&&"),c("span",{style:{color:"#24292E"}}," sz "),c("span",{style:{color:"#D73A49"}},">="),c("span",{style:{color:"#24292E"}}," threshold)")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        "),c("span",{style:{color:"#6A737D"}},"// 扩容")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        "),c("span",{style:{color:"#6F42C1"}},"rehash"),c("span",{style:{color:"#24292E"}},"();")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"}")])])]),c("button",{class:"collapse"})]),c("div",{style:{"max-height":"300px"},class:"language-java"},[c("button",{title:"Copy Code",class:"copy"}),c("span",{class:"lang"},"java"),c("pre",{class:"shiki github-dark vp-code-dark"},[c("code",null,[c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"// 获取【环形数组】的下一个索引")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#F97583"}},"private"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#F97583"}},"static"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#F97583"}},"int"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#B392F0"}},"nextIndex"),c("span",{style:{color:"#E1E4E8"}},"("),c("span",{style:{color:"#F97583"}},"int"),c("span",{style:{color:"#E1E4E8"}}," i, "),c("span",{style:{color:"#F97583"}},"int"),c("span",{style:{color:"#E1E4E8"}}," len) {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#6A737D"}},"// 索引越界后从 0 开始继续获取")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#F97583"}},"return"),c("span",{style:{color:"#E1E4E8"}}," ((i "),c("span",{style:{color:"#F97583"}},"+"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#79B8FF"}},"1"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#F97583"}},"<"),c("span",{style:{color:"#E1E4E8"}}," len) "),c("span",{style:{color:"#F97583"}},"?"),c("span",{style:{color:"#E1E4E8"}}," i "),c("span",{style:{color:"#F97583"}},"+"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#79B8FF"}},"1"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#F97583"}},":"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#79B8FF"}},"0"),c("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"}")])])]),c("pre",{class:"shiki github-light vp-code-light"},[c("code",null,[c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"// 获取【环形数组】的下一个索引")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#D73A49"}},"private"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#D73A49"}},"static"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#D73A49"}},"int"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#6F42C1"}},"nextIndex"),c("span",{style:{color:"#24292E"}},"("),c("span",{style:{color:"#D73A49"}},"int"),c("span",{style:{color:"#24292E"}}," i, "),c("span",{style:{color:"#D73A49"}},"int"),c("span",{style:{color:"#24292E"}}," len) {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#6A737D"}},"// 索引越界后从 0 开始继续获取")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#D73A49"}},"return"),c("span",{style:{color:"#24292E"}}," ((i "),c("span",{style:{color:"#D73A49"}},"+"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#005CC5"}},"1"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#D73A49"}},"<"),c("span",{style:{color:"#24292E"}}," len) "),c("span",{style:{color:"#D73A49"}},"?"),c("span",{style:{color:"#24292E"}}," i "),c("span",{style:{color:"#D73A49"}},"+"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#005CC5"}},"1"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#D73A49"}},":"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#005CC5"}},"0"),c("span",{style:{color:"#24292E"}},");")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"}")])])]),c("button",{class:"collapse"})]),c("div",{style:{"max-height":"300px"},class:"language-java"},[c("button",{title:"Copy Code",class:"copy"}),c("span",{class:"lang"},"java"),c("pre",{class:"shiki github-dark vp-code-dark"},[c("code",null,[c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"// 在指定位置插入指定的数据")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#F97583"}},"private"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#F97583"}},"void"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#B392F0"}},"replaceStaleEntry"),c("span",{style:{color:"#E1E4E8"}},"(ThreadLocal"),c("span",{style:{color:"#F97583"}},"<?>"),c("span",{style:{color:"#E1E4E8"}}," key, Object value, "),c("span",{style:{color:"#F97583"}},"int"),c("span",{style:{color:"#E1E4E8"}}," staleSlot) {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#6A737D"}},"// 获取散列表")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#F97583"}},"Entry"),c("span",{style:{color:"#E1E4E8"}},"[] tab "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," table;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#F97583"}},"int"),c("span",{style:{color:"#E1E4E8"}}," len "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," tab.length;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    Entry e;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"\t"),c("span",{style:{color:"#6A737D"}},"// 探测式清理的开始下标，默认从当前 staleSlot 开始")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#F97583"}},"int"),c("span",{style:{color:"#E1E4E8"}}," slotToExpunge "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," staleSlot;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#6A737D"}},"// 以当前 staleSlot 开始【向前迭代查找】，找到索引靠前过期数据，找到以后替换 slotToExpunge 值")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#6A737D"}},"// 【保证在一个区间段内，从最前面的过期数据开始清理】")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#F97583"}},"for"),c("span",{style:{color:"#E1E4E8"}}," ("),c("span",{style:{color:"#F97583"}},"int"),c("span",{style:{color:"#E1E4E8"}}," i "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#B392F0"}},"prevIndex"),c("span",{style:{color:"#E1E4E8"}},"(staleSlot, len); (e "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," tab[i]) "),c("span",{style:{color:"#F97583"}},"!="),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#79B8FF"}},"null"),c("span",{style:{color:"#E1E4E8"}},"; i "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#B392F0"}},"prevIndex"),c("span",{style:{color:"#E1E4E8"}},"(i, len))")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        "),c("span",{style:{color:"#F97583"}},"if"),c("span",{style:{color:"#E1E4E8"}}," (e."),c("span",{style:{color:"#B392F0"}},"get"),c("span",{style:{color:"#E1E4E8"}},"() "),c("span",{style:{color:"#F97583"}},"=="),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#79B8FF"}},"null"),c("span",{style:{color:"#E1E4E8"}},")")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"            slotToExpunge "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," i;")]),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"\t"),c("span",{style:{color:"#6A737D"}},"// 以 staleSlot 【向后去查找】，直到碰到 null 为止，还是线性探测")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#F97583"}},"for"),c("span",{style:{color:"#E1E4E8"}}," ("),c("span",{style:{color:"#F97583"}},"int"),c("span",{style:{color:"#E1E4E8"}}," i "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#B392F0"}},"nextIndex"),c("span",{style:{color:"#E1E4E8"}},"(staleSlot, len); (e "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," tab[i]) "),c("span",{style:{color:"#F97583"}},"!="),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#79B8FF"}},"null"),c("span",{style:{color:"#E1E4E8"}},"; i "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#B392F0"}},"nextIndex"),c("span",{style:{color:"#E1E4E8"}},"(i, len)) {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        "),c("span",{style:{color:"#6A737D"}},"// 获取当前节点的 key")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        ThreadLocal<"),c("span",{style:{color:"#F97583"}},"?"),c("span",{style:{color:"#E1E4E8"}},"> k "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," e."),c("span",{style:{color:"#B392F0"}},"get"),c("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"\t\t"),c("span",{style:{color:"#6A737D"}},"// 条件成立说明是【替换逻辑】")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        "),c("span",{style:{color:"#F97583"}},"if"),c("span",{style:{color:"#E1E4E8"}}," (k "),c("span",{style:{color:"#F97583"}},"=="),c("span",{style:{color:"#E1E4E8"}}," key) {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"            e.value "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," value;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"            "),c("span",{style:{color:"#6A737D"}},"// 因为本来要在 staleSlot 索引处插入该数据，现在找到了i索引处的key与数据一致")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"            "),c("span",{style:{color:"#6A737D"}},"// 但是 i 位置距离正确的位置更远，因为是向后查找，所以还是要在 staleSlot 位置插入当前 entry")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"            "),c("span",{style:{color:"#6A737D"}},"// 然后将 table[staleSlot] 这个过期数据放到当前循环到的 table[i] 这个位置，")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"            tab[i] "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," tab[staleSlot];")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"            tab[staleSlot] "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," e;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"\t\t\t")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"            "),c("span",{style:{color:"#6A737D"}},"// 条件成立说明向前查找过期数据并未找到过期的 entry，但 staleSlot 位置已经不是过期数据了，i 位置才是")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"            "),c("span",{style:{color:"#F97583"}},"if"),c("span",{style:{color:"#E1E4E8"}}," (slotToExpunge "),c("span",{style:{color:"#F97583"}},"=="),c("span",{style:{color:"#E1E4E8"}}," staleSlot)")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"                slotToExpunge "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," i;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"            ")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"            "),c("span",{style:{color:"#6A737D"}},"// 【清理过期数据，expungeStaleEntry 探测式清理，cleanSomeSlots 启发式清理】")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"            "),c("span",{style:{color:"#B392F0"}},"cleanSomeSlots"),c("span",{style:{color:"#E1E4E8"}},"("),c("span",{style:{color:"#B392F0"}},"expungeStaleEntry"),c("span",{style:{color:"#E1E4E8"}},"(slotToExpunge), len);")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"            "),c("span",{style:{color:"#F97583"}},"return"),c("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        }")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"\t\t"),c("span",{style:{color:"#6A737D"}},"// 条件成立说明当前遍历的 entry 是一个过期数据，并且该位置前面也没有过期数据")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        "),c("span",{style:{color:"#F97583"}},"if"),c("span",{style:{color:"#E1E4E8"}}," (k "),c("span",{style:{color:"#F97583"}},"=="),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#79B8FF"}},"null"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#F97583"}},"&&"),c("span",{style:{color:"#E1E4E8"}}," slotToExpunge "),c("span",{style:{color:"#F97583"}},"=="),c("span",{style:{color:"#E1E4E8"}}," staleSlot)")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"            "),c("span",{style:{color:"#6A737D"}},"// 探测式清理过期数据的开始下标修改为当前循环的 index，因为 staleSlot 会放入要添加的数据")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"            slotToExpunge "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," i;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"\t"),c("span",{style:{color:"#6A737D"}},"// 向后查找过程中并未发现 k == key 的 entry，说明当前是一个【取代过期数据逻辑】")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#6A737D"}},"// 删除原有的数据引用，防止内存泄露")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    tab[staleSlot].value "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#79B8FF"}},"null"),c("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#6A737D"}},"// staleSlot 位置添加数据，【上面的所有逻辑都不会更改 staleSlot 的值】")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    tab[staleSlot] "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#F97583"}},"new"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#B392F0"}},"Entry"),c("span",{style:{color:"#E1E4E8"}},"(key, value);")]),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#6A737D"}},"// 条件成立说明除了 staleSlot 以外，还发现其它的过期 slot，所以要【开启清理数据的逻辑】")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#F97583"}},"if"),c("span",{style:{color:"#E1E4E8"}}," (slotToExpunge "),c("span",{style:{color:"#F97583"}},"!="),c("span",{style:{color:"#E1E4E8"}}," staleSlot)")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        "),c("span",{style:{color:"#B392F0"}},"cleanSomeSlots"),c("span",{style:{color:"#E1E4E8"}},"("),c("span",{style:{color:"#B392F0"}},"expungeStaleEntry"),c("span",{style:{color:"#E1E4E8"}},"(slotToExpunge), len);")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"}")])])]),c("pre",{class:"shiki github-light vp-code-light"},[c("code",null,[c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"// 在指定位置插入指定的数据")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#D73A49"}},"private"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#D73A49"}},"void"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#6F42C1"}},"replaceStaleEntry"),c("span",{style:{color:"#24292E"}},"(ThreadLocal"),c("span",{style:{color:"#D73A49"}},"<?>"),c("span",{style:{color:"#24292E"}}," key, Object value, "),c("span",{style:{color:"#D73A49"}},"int"),c("span",{style:{color:"#24292E"}}," staleSlot) {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#6A737D"}},"// 获取散列表")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#D73A49"}},"Entry"),c("span",{style:{color:"#24292E"}},"[] tab "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," table;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#D73A49"}},"int"),c("span",{style:{color:"#24292E"}}," len "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," tab.length;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    Entry e;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"\t"),c("span",{style:{color:"#6A737D"}},"// 探测式清理的开始下标，默认从当前 staleSlot 开始")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#D73A49"}},"int"),c("span",{style:{color:"#24292E"}}," slotToExpunge "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," staleSlot;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#6A737D"}},"// 以当前 staleSlot 开始【向前迭代查找】，找到索引靠前过期数据，找到以后替换 slotToExpunge 值")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#6A737D"}},"// 【保证在一个区间段内，从最前面的过期数据开始清理】")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#D73A49"}},"for"),c("span",{style:{color:"#24292E"}}," ("),c("span",{style:{color:"#D73A49"}},"int"),c("span",{style:{color:"#24292E"}}," i "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#6F42C1"}},"prevIndex"),c("span",{style:{color:"#24292E"}},"(staleSlot, len); (e "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," tab[i]) "),c("span",{style:{color:"#D73A49"}},"!="),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#005CC5"}},"null"),c("span",{style:{color:"#24292E"}},"; i "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#6F42C1"}},"prevIndex"),c("span",{style:{color:"#24292E"}},"(i, len))")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        "),c("span",{style:{color:"#D73A49"}},"if"),c("span",{style:{color:"#24292E"}}," (e."),c("span",{style:{color:"#6F42C1"}},"get"),c("span",{style:{color:"#24292E"}},"() "),c("span",{style:{color:"#D73A49"}},"=="),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#005CC5"}},"null"),c("span",{style:{color:"#24292E"}},")")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"            slotToExpunge "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," i;")]),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"\t"),c("span",{style:{color:"#6A737D"}},"// 以 staleSlot 【向后去查找】，直到碰到 null 为止，还是线性探测")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#D73A49"}},"for"),c("span",{style:{color:"#24292E"}}," ("),c("span",{style:{color:"#D73A49"}},"int"),c("span",{style:{color:"#24292E"}}," i "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#6F42C1"}},"nextIndex"),c("span",{style:{color:"#24292E"}},"(staleSlot, len); (e "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," tab[i]) "),c("span",{style:{color:"#D73A49"}},"!="),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#005CC5"}},"null"),c("span",{style:{color:"#24292E"}},"; i "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#6F42C1"}},"nextIndex"),c("span",{style:{color:"#24292E"}},"(i, len)) {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        "),c("span",{style:{color:"#6A737D"}},"// 获取当前节点的 key")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        ThreadLocal<"),c("span",{style:{color:"#D73A49"}},"?"),c("span",{style:{color:"#24292E"}},"> k "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," e."),c("span",{style:{color:"#6F42C1"}},"get"),c("span",{style:{color:"#24292E"}},"();")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"\t\t"),c("span",{style:{color:"#6A737D"}},"// 条件成立说明是【替换逻辑】")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        "),c("span",{style:{color:"#D73A49"}},"if"),c("span",{style:{color:"#24292E"}}," (k "),c("span",{style:{color:"#D73A49"}},"=="),c("span",{style:{color:"#24292E"}}," key) {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"            e.value "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," value;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"            "),c("span",{style:{color:"#6A737D"}},"// 因为本来要在 staleSlot 索引处插入该数据，现在找到了i索引处的key与数据一致")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"            "),c("span",{style:{color:"#6A737D"}},"// 但是 i 位置距离正确的位置更远，因为是向后查找，所以还是要在 staleSlot 位置插入当前 entry")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"            "),c("span",{style:{color:"#6A737D"}},"// 然后将 table[staleSlot] 这个过期数据放到当前循环到的 table[i] 这个位置，")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"            tab[i] "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," tab[staleSlot];")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"            tab[staleSlot] "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," e;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"\t\t\t")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"            "),c("span",{style:{color:"#6A737D"}},"// 条件成立说明向前查找过期数据并未找到过期的 entry，但 staleSlot 位置已经不是过期数据了，i 位置才是")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"            "),c("span",{style:{color:"#D73A49"}},"if"),c("span",{style:{color:"#24292E"}}," (slotToExpunge "),c("span",{style:{color:"#D73A49"}},"=="),c("span",{style:{color:"#24292E"}}," staleSlot)")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"                slotToExpunge "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," i;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"            ")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"            "),c("span",{style:{color:"#6A737D"}},"// 【清理过期数据，expungeStaleEntry 探测式清理，cleanSomeSlots 启发式清理】")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"            "),c("span",{style:{color:"#6F42C1"}},"cleanSomeSlots"),c("span",{style:{color:"#24292E"}},"("),c("span",{style:{color:"#6F42C1"}},"expungeStaleEntry"),c("span",{style:{color:"#24292E"}},"(slotToExpunge), len);")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"            "),c("span",{style:{color:"#D73A49"}},"return"),c("span",{style:{color:"#24292E"}},";")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        }")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"\t\t"),c("span",{style:{color:"#6A737D"}},"// 条件成立说明当前遍历的 entry 是一个过期数据，并且该位置前面也没有过期数据")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        "),c("span",{style:{color:"#D73A49"}},"if"),c("span",{style:{color:"#24292E"}}," (k "),c("span",{style:{color:"#D73A49"}},"=="),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#005CC5"}},"null"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#D73A49"}},"&&"),c("span",{style:{color:"#24292E"}}," slotToExpunge "),c("span",{style:{color:"#D73A49"}},"=="),c("span",{style:{color:"#24292E"}}," staleSlot)")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"            "),c("span",{style:{color:"#6A737D"}},"// 探测式清理过期数据的开始下标修改为当前循环的 index，因为 staleSlot 会放入要添加的数据")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"            slotToExpunge "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," i;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    }")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"\t"),c("span",{style:{color:"#6A737D"}},"// 向后查找过程中并未发现 k == key 的 entry，说明当前是一个【取代过期数据逻辑】")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#6A737D"}},"// 删除原有的数据引用，防止内存泄露")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    tab[staleSlot].value "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#005CC5"}},"null"),c("span",{style:{color:"#24292E"}},";")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#6A737D"}},"// staleSlot 位置添加数据，【上面的所有逻辑都不会更改 staleSlot 的值】")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    tab[staleSlot] "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#D73A49"}},"new"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#6F42C1"}},"Entry"),c("span",{style:{color:"#24292E"}},"(key, value);")]),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#6A737D"}},"// 条件成立说明除了 staleSlot 以外，还发现其它的过期 slot，所以要【开启清理数据的逻辑】")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#D73A49"}},"if"),c("span",{style:{color:"#24292E"}}," (slotToExpunge "),c("span",{style:{color:"#D73A49"}},"!="),c("span",{style:{color:"#24292E"}}," staleSlot)")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        "),c("span",{style:{color:"#6F42C1"}},"cleanSomeSlots"),c("span",{style:{color:"#24292E"}},"("),c("span",{style:{color:"#6F42C1"}},"expungeStaleEntry"),c("span",{style:{color:"#24292E"}},"(slotToExpunge), len);")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"}")])])]),c("button",{class:"collapse"})]),c("figure",null,[c("img",{alt:"image-20230824171823217",class:"lazy","data-src":"https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230824171823217.png"})]),c("div",{style:{"max-height":"300px"},class:"language-java"},[c("button",{title:"Copy Code",class:"copy"}),c("span",{class:"lang"},"java"),c("pre",{class:"shiki github-dark vp-code-dark"},[c("code",null,[c("span",{class:"line"},[c("span",{style:{color:"#F97583"}},"private"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#F97583"}},"static"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#F97583"}},"int"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#B392F0"}},"prevIndex"),c("span",{style:{color:"#E1E4E8"}},"("),c("span",{style:{color:"#F97583"}},"int"),c("span",{style:{color:"#E1E4E8"}}," i, "),c("span",{style:{color:"#F97583"}},"int"),c("span",{style:{color:"#E1E4E8"}}," len) {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#6A737D"}},"// 形成一个环绕式的访问，头索引越界后置为尾索引")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#F97583"}},"return"),c("span",{style:{color:"#E1E4E8"}}," ((i "),c("span",{style:{color:"#F97583"}},"-"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#79B8FF"}},"1"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#F97583"}},">="),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#79B8FF"}},"0"),c("span",{style:{color:"#E1E4E8"}},") "),c("span",{style:{color:"#F97583"}},"?"),c("span",{style:{color:"#E1E4E8"}}," i "),c("span",{style:{color:"#F97583"}},"-"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#79B8FF"}},"1"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#F97583"}},":"),c("span",{style:{color:"#E1E4E8"}}," len "),c("span",{style:{color:"#F97583"}},"-"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#79B8FF"}},"1"),c("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"}")])])]),c("pre",{class:"shiki github-light vp-code-light"},[c("code",null,[c("span",{class:"line"},[c("span",{style:{color:"#D73A49"}},"private"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#D73A49"}},"static"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#D73A49"}},"int"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#6F42C1"}},"prevIndex"),c("span",{style:{color:"#24292E"}},"("),c("span",{style:{color:"#D73A49"}},"int"),c("span",{style:{color:"#24292E"}}," i, "),c("span",{style:{color:"#D73A49"}},"int"),c("span",{style:{color:"#24292E"}}," len) {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#6A737D"}},"// 形成一个环绕式的访问，头索引越界后置为尾索引")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#D73A49"}},"return"),c("span",{style:{color:"#24292E"}}," ((i "),c("span",{style:{color:"#D73A49"}},"-"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#005CC5"}},"1"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#D73A49"}},">="),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#005CC5"}},"0"),c("span",{style:{color:"#24292E"}},") "),c("span",{style:{color:"#D73A49"}},"?"),c("span",{style:{color:"#24292E"}}," i "),c("span",{style:{color:"#D73A49"}},"-"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#005CC5"}},"1"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#D73A49"}},":"),c("span",{style:{color:"#24292E"}}," len "),c("span",{style:{color:"#D73A49"}},"-"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#005CC5"}},"1"),c("span",{style:{color:"#24292E"}},");")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"}")])])]),c("button",{class:"collapse"})])]),c("li",null,[c("p",null,"getEntry()：ThreadLocal 的 get 方法以当前的 ThreadLocal 为 key，调用 getEntry 获取对应的存储实体 e"),c("div",{style:{"max-height":"300px"},class:"language-java"},[c("button",{title:"Copy Code",class:"copy"}),c("span",{class:"lang"},"java"),c("pre",{class:"shiki github-dark vp-code-dark"},[c("code",null,[c("span",{class:"line"},[c("span",{style:{color:"#F97583"}},"private"),c("span",{style:{color:"#E1E4E8"}}," Entry "),c("span",{style:{color:"#B392F0"}},"getEntry"),c("span",{style:{color:"#E1E4E8"}},"(ThreadLocal"),c("span",{style:{color:"#F97583"}},"<?>"),c("span",{style:{color:"#E1E4E8"}}," key) {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#6A737D"}},"// 哈希寻址")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#F97583"}},"int"),c("span",{style:{color:"#E1E4E8"}}," i "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," key.threadLocalHashCode "),c("span",{style:{color:"#F97583"}},"&"),c("span",{style:{color:"#E1E4E8"}}," (table.length "),c("span",{style:{color:"#F97583"}},"-"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#79B8FF"}},"1"),c("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#6A737D"}},"// 访问散列表中指定指定位置的 slot ")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    Entry e "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," table[i];")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#6A737D"}},"// 条件成立，说明 slot 有值并且 key 就是要寻找的 key，直接返回")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#F97583"}},"if"),c("span",{style:{color:"#E1E4E8"}}," (e "),c("span",{style:{color:"#F97583"}},"!="),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#79B8FF"}},"null"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#F97583"}},"&&"),c("span",{style:{color:"#E1E4E8"}}," e."),c("span",{style:{color:"#B392F0"}},"get"),c("span",{style:{color:"#E1E4E8"}},"() "),c("span",{style:{color:"#F97583"}},"=="),c("span",{style:{color:"#E1E4E8"}}," key)")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        "),c("span",{style:{color:"#F97583"}},"return"),c("span",{style:{color:"#E1E4E8"}}," e;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#F97583"}},"else")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        "),c("span",{style:{color:"#6A737D"}},"// 进行线性探测")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        "),c("span",{style:{color:"#F97583"}},"return"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#B392F0"}},"getEntryAfterMiss"),c("span",{style:{color:"#E1E4E8"}},"(key, i, e);")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"}")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"// 线性探测寻址")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#F97583"}},"private"),c("span",{style:{color:"#E1E4E8"}}," Entry "),c("span",{style:{color:"#B392F0"}},"getEntryAfterMiss"),c("span",{style:{color:"#E1E4E8"}},"(ThreadLocal"),c("span",{style:{color:"#F97583"}},"<?>"),c("span",{style:{color:"#E1E4E8"}}," key, "),c("span",{style:{color:"#F97583"}},"int"),c("span",{style:{color:"#E1E4E8"}}," i, Entry e) {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#6A737D"}},"// 获取散列表")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#F97583"}},"Entry"),c("span",{style:{color:"#E1E4E8"}},"[] tab "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," table;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#F97583"}},"int"),c("span",{style:{color:"#E1E4E8"}}," len "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," tab.length;")]),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#6A737D"}},"// 开始遍历，碰到 slot == null 的情况，搜索结束")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#F97583"}},"while"),c("span",{style:{color:"#E1E4E8"}}," (e "),c("span",{style:{color:"#F97583"}},"!="),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#79B8FF"}},"null"),c("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"\t\t"),c("span",{style:{color:"#6A737D"}},"// 获取当前 slot 中 entry 对象的 key")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        ThreadLocal<"),c("span",{style:{color:"#F97583"}},"?"),c("span",{style:{color:"#E1E4E8"}},"> k "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," e."),c("span",{style:{color:"#B392F0"}},"get"),c("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        "),c("span",{style:{color:"#6A737D"}},"// 条件成立说明找到了，直接返回")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        "),c("span",{style:{color:"#F97583"}},"if"),c("span",{style:{color:"#E1E4E8"}}," (k "),c("span",{style:{color:"#F97583"}},"=="),c("span",{style:{color:"#E1E4E8"}}," key)")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"            "),c("span",{style:{color:"#F97583"}},"return"),c("span",{style:{color:"#E1E4E8"}}," e;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        "),c("span",{style:{color:"#F97583"}},"if"),c("span",{style:{color:"#E1E4E8"}}," (k "),c("span",{style:{color:"#F97583"}},"=="),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#79B8FF"}},"null"),c("span",{style:{color:"#E1E4E8"}},")")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"             "),c("span",{style:{color:"#6A737D"}},"// 过期数据，【探测式过期数据回收】")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"            "),c("span",{style:{color:"#B392F0"}},"expungeStaleEntry"),c("span",{style:{color:"#E1E4E8"}},"(i);")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        "),c("span",{style:{color:"#F97583"}},"else")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"            "),c("span",{style:{color:"#6A737D"}},"// 更新 index 继续向后走")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"            i "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#B392F0"}},"nextIndex"),c("span",{style:{color:"#E1E4E8"}},"(i, len);")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        "),c("span",{style:{color:"#6A737D"}},"// 获取下一个槽位中的 entry")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        e "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," tab[i];")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#6A737D"}},"// 说明当前区段没有找到相应数据")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#6A737D"}},"// 【因为存放数据是线性的向后寻找槽位，都是紧挨着的，不可能越过一个 空槽位 在后面放】，可以减少遍历的次数")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#F97583"}},"return"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#79B8FF"}},"null"),c("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"}")])])]),c("pre",{class:"shiki github-light vp-code-light"},[c("code",null,[c("span",{class:"line"},[c("span",{style:{color:"#D73A49"}},"private"),c("span",{style:{color:"#24292E"}}," Entry "),c("span",{style:{color:"#6F42C1"}},"getEntry"),c("span",{style:{color:"#24292E"}},"(ThreadLocal"),c("span",{style:{color:"#D73A49"}},"<?>"),c("span",{style:{color:"#24292E"}}," key) {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#6A737D"}},"// 哈希寻址")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#D73A49"}},"int"),c("span",{style:{color:"#24292E"}}," i "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," key.threadLocalHashCode "),c("span",{style:{color:"#D73A49"}},"&"),c("span",{style:{color:"#24292E"}}," (table.length "),c("span",{style:{color:"#D73A49"}},"-"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#005CC5"}},"1"),c("span",{style:{color:"#24292E"}},");")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#6A737D"}},"// 访问散列表中指定指定位置的 slot ")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    Entry e "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," table[i];")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#6A737D"}},"// 条件成立，说明 slot 有值并且 key 就是要寻找的 key，直接返回")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#D73A49"}},"if"),c("span",{style:{color:"#24292E"}}," (e "),c("span",{style:{color:"#D73A49"}},"!="),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#005CC5"}},"null"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#D73A49"}},"&&"),c("span",{style:{color:"#24292E"}}," e."),c("span",{style:{color:"#6F42C1"}},"get"),c("span",{style:{color:"#24292E"}},"() "),c("span",{style:{color:"#D73A49"}},"=="),c("span",{style:{color:"#24292E"}}," key)")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        "),c("span",{style:{color:"#D73A49"}},"return"),c("span",{style:{color:"#24292E"}}," e;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#D73A49"}},"else")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        "),c("span",{style:{color:"#6A737D"}},"// 进行线性探测")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        "),c("span",{style:{color:"#D73A49"}},"return"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#6F42C1"}},"getEntryAfterMiss"),c("span",{style:{color:"#24292E"}},"(key, i, e);")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"}")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"// 线性探测寻址")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#D73A49"}},"private"),c("span",{style:{color:"#24292E"}}," Entry "),c("span",{style:{color:"#6F42C1"}},"getEntryAfterMiss"),c("span",{style:{color:"#24292E"}},"(ThreadLocal"),c("span",{style:{color:"#D73A49"}},"<?>"),c("span",{style:{color:"#24292E"}}," key, "),c("span",{style:{color:"#D73A49"}},"int"),c("span",{style:{color:"#24292E"}}," i, Entry e) {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#6A737D"}},"// 获取散列表")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#D73A49"}},"Entry"),c("span",{style:{color:"#24292E"}},"[] tab "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," table;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#D73A49"}},"int"),c("span",{style:{color:"#24292E"}}," len "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," tab.length;")]),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#6A737D"}},"// 开始遍历，碰到 slot == null 的情况，搜索结束")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#D73A49"}},"while"),c("span",{style:{color:"#24292E"}}," (e "),c("span",{style:{color:"#D73A49"}},"!="),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#005CC5"}},"null"),c("span",{style:{color:"#24292E"}},") {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"\t\t"),c("span",{style:{color:"#6A737D"}},"// 获取当前 slot 中 entry 对象的 key")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        ThreadLocal<"),c("span",{style:{color:"#D73A49"}},"?"),c("span",{style:{color:"#24292E"}},"> k "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," e."),c("span",{style:{color:"#6F42C1"}},"get"),c("span",{style:{color:"#24292E"}},"();")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        "),c("span",{style:{color:"#6A737D"}},"// 条件成立说明找到了，直接返回")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        "),c("span",{style:{color:"#D73A49"}},"if"),c("span",{style:{color:"#24292E"}}," (k "),c("span",{style:{color:"#D73A49"}},"=="),c("span",{style:{color:"#24292E"}}," key)")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"            "),c("span",{style:{color:"#D73A49"}},"return"),c("span",{style:{color:"#24292E"}}," e;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        "),c("span",{style:{color:"#D73A49"}},"if"),c("span",{style:{color:"#24292E"}}," (k "),c("span",{style:{color:"#D73A49"}},"=="),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#005CC5"}},"null"),c("span",{style:{color:"#24292E"}},")")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"             "),c("span",{style:{color:"#6A737D"}},"// 过期数据，【探测式过期数据回收】")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"            "),c("span",{style:{color:"#6F42C1"}},"expungeStaleEntry"),c("span",{style:{color:"#24292E"}},"(i);")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        "),c("span",{style:{color:"#D73A49"}},"else")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"            "),c("span",{style:{color:"#6A737D"}},"// 更新 index 继续向后走")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"            i "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#6F42C1"}},"nextIndex"),c("span",{style:{color:"#24292E"}},"(i, len);")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        "),c("span",{style:{color:"#6A737D"}},"// 获取下一个槽位中的 entry")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        e "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," tab[i];")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    }")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#6A737D"}},"// 说明当前区段没有找到相应数据")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#6A737D"}},"// 【因为存放数据是线性的向后寻找槽位，都是紧挨着的，不可能越过一个 空槽位 在后面放】，可以减少遍历的次数")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#D73A49"}},"return"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#005CC5"}},"null"),c("span",{style:{color:"#24292E"}},";")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"}")])])]),c("button",{class:"collapse"})])]),c("li",null,[c("p",null,[p("rehash()：触发一次全量清理，如果数组长度大于等于长度的 "),c("code",null,"2/3 * 3/4 = 1/2"),p("，则进行 resize")]),c("div",{style:{"max-height":"300px"},class:"language-java"},[c("button",{title:"Copy Code",class:"copy"}),c("span",{class:"lang"},"java"),c("pre",{class:"shiki github-dark vp-code-dark"},[c("code",null,[c("span",{class:"line"},[c("span",{style:{color:"#F97583"}},"private"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#F97583"}},"void"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#B392F0"}},"rehash"),c("span",{style:{color:"#E1E4E8"}},"() {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#6A737D"}},"// 清除当前散列表内的【所有】过期的数据")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#B392F0"}},"expungeStaleEntries"),c("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    ")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#6A737D"}},"// threshold = len * 2 / 3，就是 2/3 * (1 - 1/4)")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#F97583"}},"if"),c("span",{style:{color:"#E1E4E8"}}," (size "),c("span",{style:{color:"#F97583"}},">="),c("span",{style:{color:"#E1E4E8"}}," threshold "),c("span",{style:{color:"#F97583"}},"-"),c("span",{style:{color:"#E1E4E8"}}," threshold "),c("span",{style:{color:"#F97583"}},"/"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#79B8FF"}},"4"),c("span",{style:{color:"#E1E4E8"}},")")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        "),c("span",{style:{color:"#B392F0"}},"resize"),c("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"}")])])]),c("pre",{class:"shiki github-light vp-code-light"},[c("code",null,[c("span",{class:"line"},[c("span",{style:{color:"#D73A49"}},"private"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#D73A49"}},"void"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#6F42C1"}},"rehash"),c("span",{style:{color:"#24292E"}},"() {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#6A737D"}},"// 清除当前散列表内的【所有】过期的数据")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#6F42C1"}},"expungeStaleEntries"),c("span",{style:{color:"#24292E"}},"();")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    ")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#6A737D"}},"// threshold = len * 2 / 3，就是 2/3 * (1 - 1/4)")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#D73A49"}},"if"),c("span",{style:{color:"#24292E"}}," (size "),c("span",{style:{color:"#D73A49"}},">="),c("span",{style:{color:"#24292E"}}," threshold "),c("span",{style:{color:"#D73A49"}},"-"),c("span",{style:{color:"#24292E"}}," threshold "),c("span",{style:{color:"#D73A49"}},"/"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#005CC5"}},"4"),c("span",{style:{color:"#24292E"}},")")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        "),c("span",{style:{color:"#6F42C1"}},"resize"),c("span",{style:{color:"#24292E"}},"();")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"}")])])]),c("button",{class:"collapse"})]),c("div",{style:{"max-height":"300px"},class:"language-java"},[c("button",{title:"Copy Code",class:"copy"}),c("span",{class:"lang"},"java"),c("pre",{class:"shiki github-dark vp-code-dark"},[c("code",null,[c("span",{class:"line"},[c("span",{style:{color:"#F97583"}},"private"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#F97583"}},"void"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#B392F0"}},"expungeStaleEntries"),c("span",{style:{color:"#E1E4E8"}},"() {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#F97583"}},"Entry"),c("span",{style:{color:"#E1E4E8"}},"[] tab "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," table;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#F97583"}},"int"),c("span",{style:{color:"#E1E4E8"}}," len "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," tab.length;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#6A737D"}},"// 【遍历所有的槽位，清理过期数据】")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#F97583"}},"for"),c("span",{style:{color:"#E1E4E8"}}," ("),c("span",{style:{color:"#F97583"}},"int"),c("span",{style:{color:"#E1E4E8"}}," j "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#79B8FF"}},"0"),c("span",{style:{color:"#E1E4E8"}},"; j "),c("span",{style:{color:"#F97583"}},"<"),c("span",{style:{color:"#E1E4E8"}}," len; j"),c("span",{style:{color:"#F97583"}},"++"),c("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        Entry e "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," tab[j];")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        "),c("span",{style:{color:"#F97583"}},"if"),c("span",{style:{color:"#E1E4E8"}}," (e "),c("span",{style:{color:"#F97583"}},"!="),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#79B8FF"}},"null"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#F97583"}},"&&"),c("span",{style:{color:"#E1E4E8"}}," e."),c("span",{style:{color:"#B392F0"}},"get"),c("span",{style:{color:"#E1E4E8"}},"() "),c("span",{style:{color:"#F97583"}},"=="),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#79B8FF"}},"null"),c("span",{style:{color:"#E1E4E8"}},")")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"            "),c("span",{style:{color:"#B392F0"}},"expungeStaleEntry"),c("span",{style:{color:"#E1E4E8"}},"(j);")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"}")])])]),c("pre",{class:"shiki github-light vp-code-light"},[c("code",null,[c("span",{class:"line"},[c("span",{style:{color:"#D73A49"}},"private"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#D73A49"}},"void"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#6F42C1"}},"expungeStaleEntries"),c("span",{style:{color:"#24292E"}},"() {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#D73A49"}},"Entry"),c("span",{style:{color:"#24292E"}},"[] tab "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," table;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#D73A49"}},"int"),c("span",{style:{color:"#24292E"}}," len "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," tab.length;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#6A737D"}},"// 【遍历所有的槽位，清理过期数据】")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#D73A49"}},"for"),c("span",{style:{color:"#24292E"}}," ("),c("span",{style:{color:"#D73A49"}},"int"),c("span",{style:{color:"#24292E"}}," j "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#005CC5"}},"0"),c("span",{style:{color:"#24292E"}},"; j "),c("span",{style:{color:"#D73A49"}},"<"),c("span",{style:{color:"#24292E"}}," len; j"),c("span",{style:{color:"#D73A49"}},"++"),c("span",{style:{color:"#24292E"}},") {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        Entry e "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," tab[j];")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        "),c("span",{style:{color:"#D73A49"}},"if"),c("span",{style:{color:"#24292E"}}," (e "),c("span",{style:{color:"#D73A49"}},"!="),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#005CC5"}},"null"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#D73A49"}},"&&"),c("span",{style:{color:"#24292E"}}," e."),c("span",{style:{color:"#6F42C1"}},"get"),c("span",{style:{color:"#24292E"}},"() "),c("span",{style:{color:"#D73A49"}},"=="),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#005CC5"}},"null"),c("span",{style:{color:"#24292E"}},")")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"            "),c("span",{style:{color:"#6F42C1"}},"expungeStaleEntry"),c("span",{style:{color:"#24292E"}},"(j);")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    }")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"}")])])]),c("button",{class:"collapse"})]),c("p",null,[p("Entry "),c("strong",null,"数组扩容为原来的 2 倍"),p(" ，重新计算 key 的散列值，如果遇到 key 为 null 的情况，会将其 value 也置为 null，帮助 GC")]),c("div",{style:{"max-height":"300px"},class:"language-java"},[c("button",{title:"Copy Code",class:"copy"}),c("span",{class:"lang"},"java"),c("pre",{class:"shiki github-dark vp-code-dark"},[c("code",null,[c("span",{class:"line"},[c("span",{style:{color:"#F97583"}},"private"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#F97583"}},"void"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#B392F0"}},"resize"),c("span",{style:{color:"#E1E4E8"}},"() {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#F97583"}},"Entry"),c("span",{style:{color:"#E1E4E8"}},"[] oldTab "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," table;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#F97583"}},"int"),c("span",{style:{color:"#E1E4E8"}}," oldLen "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," oldTab.length;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#6A737D"}},"// 新数组的长度是老数组的二倍")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#F97583"}},"int"),c("span",{style:{color:"#E1E4E8"}}," newLen "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," oldLen "),c("span",{style:{color:"#F97583"}},"*"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#79B8FF"}},"2"),c("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#F97583"}},"Entry"),c("span",{style:{color:"#E1E4E8"}},"[] newTab "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#F97583"}},"new"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#F97583"}},"Entry"),c("span",{style:{color:"#E1E4E8"}},"[newLen];")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#6A737D"}},"// 统计新table中的entry数量")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#F97583"}},"int"),c("span",{style:{color:"#E1E4E8"}}," count "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#79B8FF"}},"0"),c("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"\t"),c("span",{style:{color:"#6A737D"}},"// 遍历老表，进行【数据迁移】")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#F97583"}},"for"),c("span",{style:{color:"#E1E4E8"}}," ("),c("span",{style:{color:"#F97583"}},"int"),c("span",{style:{color:"#E1E4E8"}}," j "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#79B8FF"}},"0"),c("span",{style:{color:"#E1E4E8"}},"; j "),c("span",{style:{color:"#F97583"}},"<"),c("span",{style:{color:"#E1E4E8"}}," oldLen; "),c("span",{style:{color:"#F97583"}},"++"),c("span",{style:{color:"#E1E4E8"}},"j) {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        "),c("span",{style:{color:"#6A737D"}},"// 访问老表的指定位置的 entry")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        Entry e "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," oldTab[j];")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        "),c("span",{style:{color:"#6A737D"}},"// 条件成立说明老表中该位置有数据，可能是过期数据也可能不是")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        "),c("span",{style:{color:"#F97583"}},"if"),c("span",{style:{color:"#E1E4E8"}}," (e "),c("span",{style:{color:"#F97583"}},"!="),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#79B8FF"}},"null"),c("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"            ThreadLocal<"),c("span",{style:{color:"#F97583"}},"?"),c("span",{style:{color:"#E1E4E8"}},"> k "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," e."),c("span",{style:{color:"#B392F0"}},"get"),c("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"            "),c("span",{style:{color:"#6A737D"}},"// 过期数据")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"            "),c("span",{style:{color:"#F97583"}},"if"),c("span",{style:{color:"#E1E4E8"}}," (k "),c("span",{style:{color:"#F97583"}},"=="),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#79B8FF"}},"null"),c("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"                e.value "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#79B8FF"}},"null"),c("span",{style:{color:"#E1E4E8"}},"; "),c("span",{style:{color:"#6A737D"}},"// Help the GC")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"            } "),c("span",{style:{color:"#F97583"}},"else"),c("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"                "),c("span",{style:{color:"#6A737D"}},"// 非过期数据，在新表中进行哈希寻址")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"                "),c("span",{style:{color:"#F97583"}},"int"),c("span",{style:{color:"#E1E4E8"}}," h "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," k.threadLocalHashCode "),c("span",{style:{color:"#F97583"}},"&"),c("span",{style:{color:"#E1E4E8"}}," (newLen "),c("span",{style:{color:"#F97583"}},"-"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#79B8FF"}},"1"),c("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"                "),c("span",{style:{color:"#6A737D"}},"// 【线程探测】")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"                "),c("span",{style:{color:"#F97583"}},"while"),c("span",{style:{color:"#E1E4E8"}}," (newTab[h] "),c("span",{style:{color:"#F97583"}},"!="),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#79B8FF"}},"null"),c("span",{style:{color:"#E1E4E8"}},")")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"                    h "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#B392F0"}},"nextIndex"),c("span",{style:{color:"#E1E4E8"}},"(h, newLen);")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"                "),c("span",{style:{color:"#6A737D"}},"// 将数据存放到新表合适的 slot 中")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"                newTab[h] "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," e;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"                count"),c("span",{style:{color:"#F97583"}},"++"),c("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"            }")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        }")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"\t"),c("span",{style:{color:"#6A737D"}},"// 设置下一次触发扩容的指标：threshold = len * 2 / 3;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#B392F0"}},"setThreshold"),c("span",{style:{color:"#E1E4E8"}},"(newLen);")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    size "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," count;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#6A737D"}},"// 将扩容后的新表赋值给 threadLocalMap 内部散列表数组引用")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    table "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," newTab;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"}")])])]),c("pre",{class:"shiki github-light vp-code-light"},[c("code",null,[c("span",{class:"line"},[c("span",{style:{color:"#D73A49"}},"private"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#D73A49"}},"void"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#6F42C1"}},"resize"),c("span",{style:{color:"#24292E"}},"() {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#D73A49"}},"Entry"),c("span",{style:{color:"#24292E"}},"[] oldTab "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," table;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#D73A49"}},"int"),c("span",{style:{color:"#24292E"}}," oldLen "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," oldTab.length;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#6A737D"}},"// 新数组的长度是老数组的二倍")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#D73A49"}},"int"),c("span",{style:{color:"#24292E"}}," newLen "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," oldLen "),c("span",{style:{color:"#D73A49"}},"*"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#005CC5"}},"2"),c("span",{style:{color:"#24292E"}},";")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#D73A49"}},"Entry"),c("span",{style:{color:"#24292E"}},"[] newTab "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#D73A49"}},"new"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#D73A49"}},"Entry"),c("span",{style:{color:"#24292E"}},"[newLen];")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#6A737D"}},"// 统计新table中的entry数量")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#D73A49"}},"int"),c("span",{style:{color:"#24292E"}}," count "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#005CC5"}},"0"),c("span",{style:{color:"#24292E"}},";")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"\t"),c("span",{style:{color:"#6A737D"}},"// 遍历老表，进行【数据迁移】")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#D73A49"}},"for"),c("span",{style:{color:"#24292E"}}," ("),c("span",{style:{color:"#D73A49"}},"int"),c("span",{style:{color:"#24292E"}}," j "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#005CC5"}},"0"),c("span",{style:{color:"#24292E"}},"; j "),c("span",{style:{color:"#D73A49"}},"<"),c("span",{style:{color:"#24292E"}}," oldLen; "),c("span",{style:{color:"#D73A49"}},"++"),c("span",{style:{color:"#24292E"}},"j) {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        "),c("span",{style:{color:"#6A737D"}},"// 访问老表的指定位置的 entry")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        Entry e "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," oldTab[j];")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        "),c("span",{style:{color:"#6A737D"}},"// 条件成立说明老表中该位置有数据，可能是过期数据也可能不是")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        "),c("span",{style:{color:"#D73A49"}},"if"),c("span",{style:{color:"#24292E"}}," (e "),c("span",{style:{color:"#D73A49"}},"!="),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#005CC5"}},"null"),c("span",{style:{color:"#24292E"}},") {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"            ThreadLocal<"),c("span",{style:{color:"#D73A49"}},"?"),c("span",{style:{color:"#24292E"}},"> k "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," e."),c("span",{style:{color:"#6F42C1"}},"get"),c("span",{style:{color:"#24292E"}},"();")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"            "),c("span",{style:{color:"#6A737D"}},"// 过期数据")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"            "),c("span",{style:{color:"#D73A49"}},"if"),c("span",{style:{color:"#24292E"}}," (k "),c("span",{style:{color:"#D73A49"}},"=="),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#005CC5"}},"null"),c("span",{style:{color:"#24292E"}},") {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"                e.value "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#005CC5"}},"null"),c("span",{style:{color:"#24292E"}},"; "),c("span",{style:{color:"#6A737D"}},"// Help the GC")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"            } "),c("span",{style:{color:"#D73A49"}},"else"),c("span",{style:{color:"#24292E"}}," {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"                "),c("span",{style:{color:"#6A737D"}},"// 非过期数据，在新表中进行哈希寻址")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"                "),c("span",{style:{color:"#D73A49"}},"int"),c("span",{style:{color:"#24292E"}}," h "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," k.threadLocalHashCode "),c("span",{style:{color:"#D73A49"}},"&"),c("span",{style:{color:"#24292E"}}," (newLen "),c("span",{style:{color:"#D73A49"}},"-"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#005CC5"}},"1"),c("span",{style:{color:"#24292E"}},");")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"                "),c("span",{style:{color:"#6A737D"}},"// 【线程探测】")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"                "),c("span",{style:{color:"#D73A49"}},"while"),c("span",{style:{color:"#24292E"}}," (newTab[h] "),c("span",{style:{color:"#D73A49"}},"!="),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#005CC5"}},"null"),c("span",{style:{color:"#24292E"}},")")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"                    h "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#6F42C1"}},"nextIndex"),c("span",{style:{color:"#24292E"}},"(h, newLen);")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"                "),c("span",{style:{color:"#6A737D"}},"// 将数据存放到新表合适的 slot 中")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"                newTab[h] "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," e;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"                count"),c("span",{style:{color:"#D73A49"}},"++"),c("span",{style:{color:"#24292E"}},";")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"            }")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        }")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    }")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"\t"),c("span",{style:{color:"#6A737D"}},"// 设置下一次触发扩容的指标：threshold = len * 2 / 3;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#6F42C1"}},"setThreshold"),c("span",{style:{color:"#24292E"}},"(newLen);")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    size "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," count;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#6A737D"}},"// 将扩容后的新表赋值给 threadLocalMap 内部散列表数组引用")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    table "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," newTab;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"}")])])]),c("button",{class:"collapse"})])]),c("li",null,[c("p",null,"remove()：删除 Entry"),c("div",{style:{"max-height":"300px"},class:"language-java"},[c("button",{title:"Copy Code",class:"copy"}),c("span",{class:"lang"},"java"),c("pre",{class:"shiki github-dark vp-code-dark"},[c("code",null,[c("span",{class:"line"},[c("span",{style:{color:"#F97583"}},"private"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#F97583"}},"void"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#B392F0"}},"remove"),c("span",{style:{color:"#E1E4E8"}},"(ThreadLocal"),c("span",{style:{color:"#F97583"}},"<?>"),c("span",{style:{color:"#E1E4E8"}}," key) {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#F97583"}},"Entry"),c("span",{style:{color:"#E1E4E8"}},"[] tab "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," table;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#F97583"}},"int"),c("span",{style:{color:"#E1E4E8"}}," len "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," tab.length;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#6A737D"}},"// 哈希寻址")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#F97583"}},"int"),c("span",{style:{color:"#E1E4E8"}}," i "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," key.threadLocalHashCode "),c("span",{style:{color:"#F97583"}},"&"),c("span",{style:{color:"#E1E4E8"}}," (len"),c("span",{style:{color:"#F97583"}},"-"),c("span",{style:{color:"#79B8FF"}},"1"),c("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#F97583"}},"for"),c("span",{style:{color:"#E1E4E8"}}," (Entry e "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," tab[i]; e "),c("span",{style:{color:"#F97583"}},"!="),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#79B8FF"}},"null"),c("span",{style:{color:"#E1E4E8"}},"; e "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," tab[i "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#B392F0"}},"nextIndex"),c("span",{style:{color:"#E1E4E8"}},"(i, len)]) {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        "),c("span",{style:{color:"#6A737D"}},"// 找到了对应的 key")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        "),c("span",{style:{color:"#F97583"}},"if"),c("span",{style:{color:"#E1E4E8"}}," (e."),c("span",{style:{color:"#B392F0"}},"get"),c("span",{style:{color:"#E1E4E8"}},"() "),c("span",{style:{color:"#F97583"}},"=="),c("span",{style:{color:"#E1E4E8"}}," key) {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"            "),c("span",{style:{color:"#6A737D"}},"// 设置 key 为 null")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"            e."),c("span",{style:{color:"#B392F0"}},"clear"),c("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"            "),c("span",{style:{color:"#6A737D"}},"// 探测式清理")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"            "),c("span",{style:{color:"#B392F0"}},"expungeStaleEntry"),c("span",{style:{color:"#E1E4E8"}},"(i);")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"            "),c("span",{style:{color:"#F97583"}},"return"),c("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        }")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"}")])])]),c("pre",{class:"shiki github-light vp-code-light"},[c("code",null,[c("span",{class:"line"},[c("span",{style:{color:"#D73A49"}},"private"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#D73A49"}},"void"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#6F42C1"}},"remove"),c("span",{style:{color:"#24292E"}},"(ThreadLocal"),c("span",{style:{color:"#D73A49"}},"<?>"),c("span",{style:{color:"#24292E"}}," key) {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#D73A49"}},"Entry"),c("span",{style:{color:"#24292E"}},"[] tab "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," table;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#D73A49"}},"int"),c("span",{style:{color:"#24292E"}}," len "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," tab.length;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#6A737D"}},"// 哈希寻址")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#D73A49"}},"int"),c("span",{style:{color:"#24292E"}}," i "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," key.threadLocalHashCode "),c("span",{style:{color:"#D73A49"}},"&"),c("span",{style:{color:"#24292E"}}," (len"),c("span",{style:{color:"#D73A49"}},"-"),c("span",{style:{color:"#005CC5"}},"1"),c("span",{style:{color:"#24292E"}},");")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#D73A49"}},"for"),c("span",{style:{color:"#24292E"}}," (Entry e "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," tab[i]; e "),c("span",{style:{color:"#D73A49"}},"!="),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#005CC5"}},"null"),c("span",{style:{color:"#24292E"}},"; e "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," tab[i "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#6F42C1"}},"nextIndex"),c("span",{style:{color:"#24292E"}},"(i, len)]) {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        "),c("span",{style:{color:"#6A737D"}},"// 找到了对应的 key")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        "),c("span",{style:{color:"#D73A49"}},"if"),c("span",{style:{color:"#24292E"}}," (e."),c("span",{style:{color:"#6F42C1"}},"get"),c("span",{style:{color:"#24292E"}},"() "),c("span",{style:{color:"#D73A49"}},"=="),c("span",{style:{color:"#24292E"}}," key) {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"            "),c("span",{style:{color:"#6A737D"}},"// 设置 key 为 null")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"            e."),c("span",{style:{color:"#6F42C1"}},"clear"),c("span",{style:{color:"#24292E"}},"();")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"            "),c("span",{style:{color:"#6A737D"}},"// 探测式清理")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"            "),c("span",{style:{color:"#6F42C1"}},"expungeStaleEntry"),c("span",{style:{color:"#24292E"}},"(i);")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"            "),c("span",{style:{color:"#D73A49"}},"return"),c("span",{style:{color:"#24292E"}},";")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        }")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    }")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"}")])])]),c("button",{class:"collapse"})])])],-1),Xo=c("hr",null,null,-1),ln={id:"清理方法",tabindex:"-1"},sn=c("ul",null,[c("li",null,[c("p",null,[p("探测式清理：沿着开始位置向后探测清理过期数据，沿途中碰到未过期数据则将此数据 rehash 在 table 数组中的定位，重定位后的元素理论上更接近 "),c("code",null,"i = entry.key & (table.length - 1)"),p("，让"),c("strong",null,"数据的排列更紧凑"),p("，会优化整个散列表查询性能")]),c("div",{style:{"max-height":"300px"},class:"language-java"},[c("button",{title:"Copy Code",class:"copy"}),c("span",{class:"lang"},"java"),c("pre",{class:"shiki github-dark vp-code-dark"},[c("code",null,[c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"// table[staleSlot] 是一个过期数据，以这个位置开始继续向后查找过期数据")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#F97583"}},"private"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#F97583"}},"int"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#B392F0"}},"expungeStaleEntry"),c("span",{style:{color:"#E1E4E8"}},"("),c("span",{style:{color:"#F97583"}},"int"),c("span",{style:{color:"#E1E4E8"}}," staleSlot) {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#6A737D"}},"// 获取散列表和数组长度")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#F97583"}},"Entry"),c("span",{style:{color:"#E1E4E8"}},"[] tab "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," table;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#F97583"}},"int"),c("span",{style:{color:"#E1E4E8"}}," len "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," tab.length;")]),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#6A737D"}},"// help gc，先把当前过期的 entry 置空，在取消对 entry 的引用")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    tab[staleSlot].value "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#79B8FF"}},"null"),c("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    tab[staleSlot] "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#79B8FF"}},"null"),c("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#6A737D"}},"// 数量-1")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    size"),c("span",{style:{color:"#F97583"}},"--"),c("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    Entry e;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#F97583"}},"int"),c("span",{style:{color:"#E1E4E8"}}," i;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#6A737D"}},"// 从 staleSlot 开始向后遍历，直到碰到 slot == null 结束，【区间内清理过期数据】")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#F97583"}},"for"),c("span",{style:{color:"#E1E4E8"}}," (i "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#B392F0"}},"nextIndex"),c("span",{style:{color:"#E1E4E8"}},"(staleSlot, len); (e "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," tab[i]) "),c("span",{style:{color:"#F97583"}},"!="),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#79B8FF"}},"null"),c("span",{style:{color:"#E1E4E8"}},"; i "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#B392F0"}},"nextIndex"),c("span",{style:{color:"#E1E4E8"}},"(i, len)) {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        ThreadLocal<"),c("span",{style:{color:"#F97583"}},"?"),c("span",{style:{color:"#E1E4E8"}},"> k "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," e."),c("span",{style:{color:"#B392F0"}},"get"),c("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        "),c("span",{style:{color:"#6A737D"}},"// 当前 entry 是过期数据")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        "),c("span",{style:{color:"#F97583"}},"if"),c("span",{style:{color:"#E1E4E8"}}," (k "),c("span",{style:{color:"#F97583"}},"=="),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#79B8FF"}},"null"),c("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"            "),c("span",{style:{color:"#6A737D"}},"// help gc")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"            e.value "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#79B8FF"}},"null"),c("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"            tab[i] "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#79B8FF"}},"null"),c("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"            size"),c("span",{style:{color:"#F97583"}},"--"),c("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        } "),c("span",{style:{color:"#F97583"}},"else"),c("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"            "),c("span",{style:{color:"#6A737D"}},"// 当前 entry 不是过期数据的逻辑，【rehash】")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"            "),c("span",{style:{color:"#6A737D"}},"// 重新计算当前 entry 对应的 index")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"            "),c("span",{style:{color:"#F97583"}},"int"),c("span",{style:{color:"#E1E4E8"}}," h "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," k.threadLocalHashCode "),c("span",{style:{color:"#F97583"}},"&"),c("span",{style:{color:"#E1E4E8"}}," (len "),c("span",{style:{color:"#F97583"}},"-"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#79B8FF"}},"1"),c("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"            "),c("span",{style:{color:"#6A737D"}},"// 条件成立说明当前 entry 存储时发生过 hash 冲突，向后偏移过了")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"            "),c("span",{style:{color:"#F97583"}},"if"),c("span",{style:{color:"#E1E4E8"}}," (h "),c("span",{style:{color:"#F97583"}},"!="),c("span",{style:{color:"#E1E4E8"}}," i) {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"                "),c("span",{style:{color:"#6A737D"}},"// 当前位置置空")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"                tab[i] "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#79B8FF"}},"null"),c("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"                "),c("span",{style:{color:"#6A737D"}},"// 以正确位置 h 开始，向后查找第一个可以存放 entry 的位置")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"                "),c("span",{style:{color:"#F97583"}},"while"),c("span",{style:{color:"#E1E4E8"}}," (tab[h] "),c("span",{style:{color:"#F97583"}},"!="),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#79B8FF"}},"null"),c("span",{style:{color:"#E1E4E8"}},")")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"                    h "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#B392F0"}},"nextIndex"),c("span",{style:{color:"#E1E4E8"}},"(h, len);")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"                "),c("span",{style:{color:"#6A737D"}},"// 将当前元素放入到【距离正确位置更近的位置，有可能就是正确位置】")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"                tab[h] "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," e;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"            }")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        }")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#6A737D"}},"// 返回 slot = null 的槽位索引，图例是 7，这个索引代表【索引前面的区间已经清理完成垃圾了】")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#F97583"}},"return"),c("span",{style:{color:"#E1E4E8"}}," i;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"}")])])]),c("pre",{class:"shiki github-light vp-code-light"},[c("code",null,[c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"// table[staleSlot] 是一个过期数据，以这个位置开始继续向后查找过期数据")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#D73A49"}},"private"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#D73A49"}},"int"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#6F42C1"}},"expungeStaleEntry"),c("span",{style:{color:"#24292E"}},"("),c("span",{style:{color:"#D73A49"}},"int"),c("span",{style:{color:"#24292E"}}," staleSlot) {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#6A737D"}},"// 获取散列表和数组长度")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#D73A49"}},"Entry"),c("span",{style:{color:"#24292E"}},"[] tab "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," table;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#D73A49"}},"int"),c("span",{style:{color:"#24292E"}}," len "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," tab.length;")]),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#6A737D"}},"// help gc，先把当前过期的 entry 置空，在取消对 entry 的引用")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    tab[staleSlot].value "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#005CC5"}},"null"),c("span",{style:{color:"#24292E"}},";")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    tab[staleSlot] "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#005CC5"}},"null"),c("span",{style:{color:"#24292E"}},";")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#6A737D"}},"// 数量-1")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    size"),c("span",{style:{color:"#D73A49"}},"--"),c("span",{style:{color:"#24292E"}},";")]),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    Entry e;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#D73A49"}},"int"),c("span",{style:{color:"#24292E"}}," i;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#6A737D"}},"// 从 staleSlot 开始向后遍历，直到碰到 slot == null 结束，【区间内清理过期数据】")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#D73A49"}},"for"),c("span",{style:{color:"#24292E"}}," (i "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#6F42C1"}},"nextIndex"),c("span",{style:{color:"#24292E"}},"(staleSlot, len); (e "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," tab[i]) "),c("span",{style:{color:"#D73A49"}},"!="),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#005CC5"}},"null"),c("span",{style:{color:"#24292E"}},"; i "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#6F42C1"}},"nextIndex"),c("span",{style:{color:"#24292E"}},"(i, len)) {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        ThreadLocal<"),c("span",{style:{color:"#D73A49"}},"?"),c("span",{style:{color:"#24292E"}},"> k "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," e."),c("span",{style:{color:"#6F42C1"}},"get"),c("span",{style:{color:"#24292E"}},"();")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        "),c("span",{style:{color:"#6A737D"}},"// 当前 entry 是过期数据")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        "),c("span",{style:{color:"#D73A49"}},"if"),c("span",{style:{color:"#24292E"}}," (k "),c("span",{style:{color:"#D73A49"}},"=="),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#005CC5"}},"null"),c("span",{style:{color:"#24292E"}},") {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"            "),c("span",{style:{color:"#6A737D"}},"// help gc")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"            e.value "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#005CC5"}},"null"),c("span",{style:{color:"#24292E"}},";")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"            tab[i] "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#005CC5"}},"null"),c("span",{style:{color:"#24292E"}},";")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"            size"),c("span",{style:{color:"#D73A49"}},"--"),c("span",{style:{color:"#24292E"}},";")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        } "),c("span",{style:{color:"#D73A49"}},"else"),c("span",{style:{color:"#24292E"}}," {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"            "),c("span",{style:{color:"#6A737D"}},"// 当前 entry 不是过期数据的逻辑，【rehash】")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"            "),c("span",{style:{color:"#6A737D"}},"// 重新计算当前 entry 对应的 index")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"            "),c("span",{style:{color:"#D73A49"}},"int"),c("span",{style:{color:"#24292E"}}," h "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," k.threadLocalHashCode "),c("span",{style:{color:"#D73A49"}},"&"),c("span",{style:{color:"#24292E"}}," (len "),c("span",{style:{color:"#D73A49"}},"-"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#005CC5"}},"1"),c("span",{style:{color:"#24292E"}},");")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"            "),c("span",{style:{color:"#6A737D"}},"// 条件成立说明当前 entry 存储时发生过 hash 冲突，向后偏移过了")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"            "),c("span",{style:{color:"#D73A49"}},"if"),c("span",{style:{color:"#24292E"}}," (h "),c("span",{style:{color:"#D73A49"}},"!="),c("span",{style:{color:"#24292E"}}," i) {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"                "),c("span",{style:{color:"#6A737D"}},"// 当前位置置空")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"                tab[i] "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#005CC5"}},"null"),c("span",{style:{color:"#24292E"}},";")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"                "),c("span",{style:{color:"#6A737D"}},"// 以正确位置 h 开始，向后查找第一个可以存放 entry 的位置")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"                "),c("span",{style:{color:"#D73A49"}},"while"),c("span",{style:{color:"#24292E"}}," (tab[h] "),c("span",{style:{color:"#D73A49"}},"!="),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#005CC5"}},"null"),c("span",{style:{color:"#24292E"}},")")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"                    h "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#6F42C1"}},"nextIndex"),c("span",{style:{color:"#24292E"}},"(h, len);")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"                "),c("span",{style:{color:"#6A737D"}},"// 将当前元素放入到【距离正确位置更近的位置，有可能就是正确位置】")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"                tab[h] "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," e;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"            }")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        }")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    }")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#6A737D"}},"// 返回 slot = null 的槽位索引，图例是 7，这个索引代表【索引前面的区间已经清理完成垃圾了】")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#D73A49"}},"return"),c("span",{style:{color:"#24292E"}}," i;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"}")])])]),c("button",{class:"collapse"})]),c("img",{src:"https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230824171939245.png",alt:"image-20230824171939245",style:{zoom:"80%"}}),c("img",{src:"https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230824172017188.png",alt:"image-20230824172017188",style:{zoom:"80%"}})]),c("li",null,[c("p",null,"启发式清理：向后循环扫描过期数据，发现过期数据调用探测式清理方法，如果连续几次的循环都没有发现过期数据，就停止扫描"),c("div",{style:{"max-height":"300px"},class:"language-java"},[c("button",{title:"Copy Code",class:"copy"}),c("span",{class:"lang"},"java"),c("pre",{class:"shiki github-dark vp-code-dark"},[c("code",null,[c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"//  i 表示启发式清理工作开始位置，一般是空 slot，n 一般传递的是 table.length ")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#F97583"}},"private"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#F97583"}},"boolean"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#B392F0"}},"cleanSomeSlots"),c("span",{style:{color:"#E1E4E8"}},"("),c("span",{style:{color:"#F97583"}},"int"),c("span",{style:{color:"#E1E4E8"}}," i, "),c("span",{style:{color:"#F97583"}},"int"),c("span",{style:{color:"#E1E4E8"}}," n) {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#6A737D"}},"// 表示启发式清理工作是否清除了过期数据")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#F97583"}},"boolean"),c("span",{style:{color:"#E1E4E8"}}," removed "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#79B8FF"}},"false"),c("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#6A737D"}},"// 获取当前 map 的散列表引用")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#F97583"}},"Entry"),c("span",{style:{color:"#E1E4E8"}},"[] tab "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," table;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#F97583"}},"int"),c("span",{style:{color:"#E1E4E8"}}," len "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," tab.length;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#F97583"}},"do"),c("span",{style:{color:"#E1E4E8"}}," {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        "),c("span",{style:{color:"#6A737D"}},"// 获取下一个索引，因为探测式返回的 slot 为 null")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        i "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#B392F0"}},"nextIndex"),c("span",{style:{color:"#E1E4E8"}},"(i, len);")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        Entry e "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," tab[i];")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        "),c("span",{style:{color:"#6A737D"}},"// 条件成立说明是过期的数据，key 被 gc 了")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        "),c("span",{style:{color:"#F97583"}},"if"),c("span",{style:{color:"#E1E4E8"}}," (e "),c("span",{style:{color:"#F97583"}},"!="),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#79B8FF"}},"null"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#F97583"}},"&&"),c("span",{style:{color:"#E1E4E8"}}," e."),c("span",{style:{color:"#B392F0"}},"get"),c("span",{style:{color:"#E1E4E8"}},"() "),c("span",{style:{color:"#F97583"}},"=="),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#79B8FF"}},"null"),c("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"            "),c("span",{style:{color:"#6A737D"}},"// 【发现过期数据重置 n 为数组的长度】")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"            n "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," len;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"            "),c("span",{style:{color:"#6A737D"}},"// 表示清理过过期数据")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"            removed "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#79B8FF"}},"true"),c("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"            "),c("span",{style:{color:"#6A737D"}},"// 以当前过期的 slot 为开始节点 做一次探测式清理工作")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"            i "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#B392F0"}},"expungeStaleEntry"),c("span",{style:{color:"#E1E4E8"}},"(i);")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        }")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        "),c("span",{style:{color:"#6A737D"}},"// 假设 table 长度为 16")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        "),c("span",{style:{color:"#6A737D"}},"// 16 >>> 1 ==> 8，8 >>> 1 ==> 4，4 >>> 1 ==> 2，2 >>> 1 ==> 1，1 >>> 1 ==> 0")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        "),c("span",{style:{color:"#6A737D"}},"// 连续经过这么多次循环【没有扫描到过期数据】，就停止循环，扫描到空 slot 不算，因为不是过期数据")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    } "),c("span",{style:{color:"#F97583"}},"while"),c("span",{style:{color:"#E1E4E8"}}," ((n "),c("span",{style:{color:"#F97583"}},">>>="),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#79B8FF"}},"1"),c("span",{style:{color:"#E1E4E8"}},") "),c("span",{style:{color:"#F97583"}},"!="),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#79B8FF"}},"0"),c("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    ")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#6A737D"}},"// 返回清除标记")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#F97583"}},"return"),c("span",{style:{color:"#E1E4E8"}}," removed;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"}")])])]),c("pre",{class:"shiki github-light vp-code-light"},[c("code",null,[c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"//  i 表示启发式清理工作开始位置，一般是空 slot，n 一般传递的是 table.length ")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#D73A49"}},"private"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#D73A49"}},"boolean"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#6F42C1"}},"cleanSomeSlots"),c("span",{style:{color:"#24292E"}},"("),c("span",{style:{color:"#D73A49"}},"int"),c("span",{style:{color:"#24292E"}}," i, "),c("span",{style:{color:"#D73A49"}},"int"),c("span",{style:{color:"#24292E"}}," n) {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#6A737D"}},"// 表示启发式清理工作是否清除了过期数据")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#D73A49"}},"boolean"),c("span",{style:{color:"#24292E"}}," removed "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#005CC5"}},"false"),c("span",{style:{color:"#24292E"}},";")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#6A737D"}},"// 获取当前 map 的散列表引用")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#D73A49"}},"Entry"),c("span",{style:{color:"#24292E"}},"[] tab "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," table;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#D73A49"}},"int"),c("span",{style:{color:"#24292E"}}," len "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," tab.length;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#D73A49"}},"do"),c("span",{style:{color:"#24292E"}}," {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        "),c("span",{style:{color:"#6A737D"}},"// 获取下一个索引，因为探测式返回的 slot 为 null")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        i "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#6F42C1"}},"nextIndex"),c("span",{style:{color:"#24292E"}},"(i, len);")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        Entry e "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," tab[i];")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        "),c("span",{style:{color:"#6A737D"}},"// 条件成立说明是过期的数据，key 被 gc 了")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        "),c("span",{style:{color:"#D73A49"}},"if"),c("span",{style:{color:"#24292E"}}," (e "),c("span",{style:{color:"#D73A49"}},"!="),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#005CC5"}},"null"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#D73A49"}},"&&"),c("span",{style:{color:"#24292E"}}," e."),c("span",{style:{color:"#6F42C1"}},"get"),c("span",{style:{color:"#24292E"}},"() "),c("span",{style:{color:"#D73A49"}},"=="),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#005CC5"}},"null"),c("span",{style:{color:"#24292E"}},") {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"            "),c("span",{style:{color:"#6A737D"}},"// 【发现过期数据重置 n 为数组的长度】")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"            n "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," len;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"            "),c("span",{style:{color:"#6A737D"}},"// 表示清理过过期数据")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"            removed "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#005CC5"}},"true"),c("span",{style:{color:"#24292E"}},";")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"            "),c("span",{style:{color:"#6A737D"}},"// 以当前过期的 slot 为开始节点 做一次探测式清理工作")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"            i "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#6F42C1"}},"expungeStaleEntry"),c("span",{style:{color:"#24292E"}},"(i);")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        }")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        "),c("span",{style:{color:"#6A737D"}},"// 假设 table 长度为 16")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        "),c("span",{style:{color:"#6A737D"}},"// 16 >>> 1 ==> 8，8 >>> 1 ==> 4，4 >>> 1 ==> 2，2 >>> 1 ==> 1，1 >>> 1 ==> 0")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        "),c("span",{style:{color:"#6A737D"}},"// 连续经过这么多次循环【没有扫描到过期数据】，就停止循环，扫描到空 slot 不算，因为不是过期数据")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    } "),c("span",{style:{color:"#D73A49"}},"while"),c("span",{style:{color:"#24292E"}}," ((n "),c("span",{style:{color:"#D73A49"}},">>>="),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#005CC5"}},"1"),c("span",{style:{color:"#24292E"}},") "),c("span",{style:{color:"#D73A49"}},"!="),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#005CC5"}},"0"),c("span",{style:{color:"#24292E"}},");")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    ")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#6A737D"}},"// 返回清除标记")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#D73A49"}},"return"),c("span",{style:{color:"#24292E"}}," removed;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"}")])])]),c("button",{class:"collapse"})])])],-1),on=c("hr",null,null,-1),nn={id:"内存泄漏",tabindex:"-1"},an=c("p",null,"Memory leak：内存泄漏是指程序中动态分配的堆内存由于某种原因未释放或无法释放，造成系统内存的浪费，导致程序运行速度减慢甚至系统崩溃等严重后果，内存泄漏的堆积终将导致内存溢出",-1),en=c("ul",null,[c("li",null,[c("p",null,"如果 key 使用强引用：使用完 ThreadLocal ，threadLocal Ref 被回收，但是 threadLocalMap 的 Entry 强引用了 threadLocal，造成 threadLocal 无法被回收，无法完全避免内存泄漏"),c("img",{src:"https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230824172101315.png",alt:"image-20230824172101315",style:{zoom:"80%"}})]),c("li",null,[c("p",null,"如果 key 使用弱引用：使用完 ThreadLocal ，threadLocal Ref 被回收，ThreadLocalMap 只持有 ThreadLocal 的弱引用，所以threadlocal 也可以被回收，此时 Entry 中的 key = null。但没有手动删除这个 Entry 或者 CurrentThread 依然运行，依然存在强引用链，value 不会被回收，而这块 value 永远不会被访问到，也会导致 value 内存泄漏"),c("img",{src:"https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230824172141253.png",alt:"image-20230824172141253",style:{zoom:"80%"}})]),c("li",null,[c("p",null,"两个主要原因："),c("ul",null,[c("li",null,"没有手动删除这个 Entry"),c("li",null,"CurrentThread 依然运行")])])],-1),tn=c("p",null,[p("根本原因：ThreadLocalMap 是 Thread的一个属性，"),c("strong",null,"生命周期跟 Thread 一样长"),p("，如果没有手动删除对应 Entry 就会导致内存泄漏")],-1),cn=c("p",null,"解决方法：使用完 ThreadLocal 中存储的内容后将它 remove 掉就可以",-1),pn=c("p",null,[p("ThreadLocal 内部解决方法：在 ThreadLocalMap 中的 set/getEntry 方法中，通过线性探测法对 key 进行判断，如果 key 为 null（ThreadLocal 为 null）会对 Entry 进行垃圾回收。所以"),c("strong",null,"使用弱引用比强引用多一层保障"),p("，就算不调用 remove，也有机会进行 GC")],-1),rn=c("hr",null,null,-1),En={id:"补充-内存释放时机",tabindex:"-1"},yn=c("ul",null,[c("li",null,[p("被动 GC 释放 key "),c("ul",null,[c("li",null,"仅是让 key 的内存释放，关联 value 的内存并不会释放")])]),c("li",null,[p("懒惰被动释放 value "),c("ul",null,[c("li",null,"get key 时，发现是 null key，则释放其 value 内存"),c("li",null,"set key 时，会使用启发式扫描，清除临近的 null key 的 value 内存，启发次数与元素个数，是否发现 null key 有关")])]),c("li",null,[p("主动 remove 释放 key，value "),c("ul",null,[c("li",null,"会同时释放 key，value 的内存，也会清除临近的 null key 的 value 内存"),c("li",null,"推荐使用它，因为一般使用 ThreadLocal 时都把它作为静态变量（即强引用），因此无法被动依靠 GC 回收")])])],-1),Fn=c("blockquote",null,[c("ul",null,[c("li",null,"threadLocal是弱引用作为key来存储的，当下面线程1一直处于运行状态，不断的插入元素，这样键值就会越来越多，这时只能等GC垃圾回收了，如果threadLocal设计成强引用就不能被垃圾回收了（即使别的地方都没有引用threadLocal，只要threadLocalMap使用强引用引用资源，那被引用的资源就得不到释放），所以弱引用引用资源将来没人引用了就会被回收，但值是强引用的，GC仅是让key的内存释放，后续还要根据 key 是否为 null来进一步释放值的内存"),c("li",null,"GC垃圾回收时，把未被引用的threadLocal（a）清理掉，变为null，值还在；当新的threadLocal（c）去get这个key为Null的位置时，此时值就会被垃圾回收掉，变为Null；当get一个空闲位置时，map就会把当前新的threadLocal（d）作为key，但值为Null")]),c("figure",null,[c("img",{alt:"image-20230421195247137",class:"lazy","data-src":"https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230421195247137.png"})]),c("ul",null,[c("li",null,"当在被垃圾回收掉key的位置set（8）时，不光清理掉当前位置的值（清理并存储），还会把相邻位置也一起清理掉（9,10 的 k v），但离得比较远的位置就不会去清理（14）")]),c("figure",null,[c("img",{alt:"image-20230421195536553",class:"lazy","data-src":"https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230421195536553.png"})]),c("ul",null,[c("li",null,"一般情况是没有其他地方引用threadLocal就会被垃圾回收，key=Null，get，set发现Nullkey才会进一步清理value"),c("li",null,"实际情况是用静态变量来引用threadLocal对象，即静态变量跟这个对象为强引用，所以静态变量一直强引用使用对象，垃圾回收不了，即使threadLocal是弱引用，但是静态变量对threadLocal一直保持强引用状态，所以懒惰被动释放 value的两种方式是行不通的"),c("li",null,"使用remove主动清理直接将map的键值清理掉，前两种方式清理（get set）会产生内存泄露，需要用remove来及时清理；假设长时间运行的线程池资源（含threadLocal关联静态资源）没有即使清理的话，就会积累越来越多的键值资源，还有其他的静态变量强引用key，GC也没办法把它们回收，久而久之就会造成内存泄漏")]),c("figure",null,[c("img",{alt:"image-20230421200401064",class:"lazy","data-src":"https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230421200401064.png"})])],-1),un=c("hr",null,null,-1),An={id:"变量传递",tabindex:"-1"},dn={id:"基本使用-1",tabindex:"-1"},Dn=c("p",null,"父子线程：创建子线程的线程是父线程，比如实例中的 main 线程就是父线程",-1),hn=c("p",null,[p("ThreadLocal 中存储的是线程的局部变量，如果想"),c("strong",null,"实现线程间局部变量传递"),p("可以使用 InheritableThreadLocal 类")],-1),gn=c("div",{style:{"max-height":"300px"},class:"language-java"},[c("button",{title:"Copy Code",class:"copy"}),c("span",{class:"lang"},"java"),c("pre",{class:"shiki github-dark vp-code-dark"},[c("code",null,[c("span",{class:"line"},[c("span",{style:{color:"#F97583"}},"public"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#F97583"}},"static"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#F97583"}},"void"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#B392F0"}},"main"),c("span",{style:{color:"#E1E4E8"}},"("),c("span",{style:{color:"#F97583"}},"String"),c("span",{style:{color:"#E1E4E8"}},"[] args) {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    ThreadLocal<"),c("span",{style:{color:"#F97583"}},"String"),c("span",{style:{color:"#E1E4E8"}},"> threadLocal "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#F97583"}},"new"),c("span",{style:{color:"#E1E4E8"}}," InheritableThreadLocal<>();")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    threadLocal."),c("span",{style:{color:"#B392F0"}},"set"),c("span",{style:{color:"#E1E4E8"}},"("),c("span",{style:{color:"#9ECBFF"}},'"父线程设置的值"'),c("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#F97583"}},"new"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#B392F0"}},"Thread"),c("span",{style:{color:"#E1E4E8"}},"(() "),c("span",{style:{color:"#F97583"}},"->"),c("span",{style:{color:"#E1E4E8"}}," System.out."),c("span",{style:{color:"#B392F0"}},"println"),c("span",{style:{color:"#E1E4E8"}},"("),c("span",{style:{color:"#9ECBFF"}},'"子线程输出："'),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#F97583"}},"+"),c("span",{style:{color:"#E1E4E8"}}," threadLocal."),c("span",{style:{color:"#B392F0"}},"get"),c("span",{style:{color:"#E1E4E8"}},"()))."),c("span",{style:{color:"#B392F0"}},"start"),c("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"}")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"// 子线程输出：父线程设置的值")])])]),c("pre",{class:"shiki github-light vp-code-light"},[c("code",null,[c("span",{class:"line"},[c("span",{style:{color:"#D73A49"}},"public"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#D73A49"}},"static"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#D73A49"}},"void"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#6F42C1"}},"main"),c("span",{style:{color:"#24292E"}},"("),c("span",{style:{color:"#D73A49"}},"String"),c("span",{style:{color:"#24292E"}},"[] args) {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    ThreadLocal<"),c("span",{style:{color:"#D73A49"}},"String"),c("span",{style:{color:"#24292E"}},"> threadLocal "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#D73A49"}},"new"),c("span",{style:{color:"#24292E"}}," InheritableThreadLocal<>();")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    threadLocal."),c("span",{style:{color:"#6F42C1"}},"set"),c("span",{style:{color:"#24292E"}},"("),c("span",{style:{color:"#032F62"}},'"父线程设置的值"'),c("span",{style:{color:"#24292E"}},");")]),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#D73A49"}},"new"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#6F42C1"}},"Thread"),c("span",{style:{color:"#24292E"}},"(() "),c("span",{style:{color:"#D73A49"}},"->"),c("span",{style:{color:"#24292E"}}," System.out."),c("span",{style:{color:"#6F42C1"}},"println"),c("span",{style:{color:"#24292E"}},"("),c("span",{style:{color:"#032F62"}},'"子线程输出："'),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#D73A49"}},"+"),c("span",{style:{color:"#24292E"}}," threadLocal."),c("span",{style:{color:"#6F42C1"}},"get"),c("span",{style:{color:"#24292E"}},"()))."),c("span",{style:{color:"#6F42C1"}},"start"),c("span",{style:{color:"#24292E"}},"();")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"}")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"// 子线程输出：父线程设置的值")])])]),c("button",{class:"collapse"})],-1),Cn=c("hr",null,null,-1),bn={id:"实现原理-1",tabindex:"-1"},mn=c("p",null,"InheritableThreadLocal 源码：",-1),vn=c("div",{style:{"max-height":"300px"},class:"language-java"},[c("button",{title:"Copy Code",class:"copy"}),c("span",{class:"lang"},"java"),c("pre",{class:"shiki github-dark vp-code-dark"},[c("code",null,[c("span",{class:"line"},[c("span",{style:{color:"#F97583"}},"public"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#F97583"}},"class"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#B392F0"}},"InheritableThreadLocal"),c("span",{style:{color:"#E1E4E8"}},"<"),c("span",{style:{color:"#F97583"}},"T"),c("span",{style:{color:"#E1E4E8"}},"> "),c("span",{style:{color:"#F97583"}},"extends"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#B392F0"}},"ThreadLocal"),c("span",{style:{color:"#E1E4E8"}},"<"),c("span",{style:{color:"#F97583"}},"T"),c("span",{style:{color:"#E1E4E8"}},"> {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#F97583"}},"protected"),c("span",{style:{color:"#E1E4E8"}}," T "),c("span",{style:{color:"#B392F0"}},"childValue"),c("span",{style:{color:"#E1E4E8"}},"(T "),c("span",{style:{color:"#FFAB70"}},"parentValue"),c("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        "),c("span",{style:{color:"#F97583"}},"return"),c("span",{style:{color:"#E1E4E8"}}," parentValue;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    ThreadLocalMap "),c("span",{style:{color:"#B392F0"}},"getMap"),c("span",{style:{color:"#E1E4E8"}},"(Thread "),c("span",{style:{color:"#FFAB70"}},"t"),c("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"       "),c("span",{style:{color:"#F97583"}},"return"),c("span",{style:{color:"#E1E4E8"}}," t.inheritableThreadLocals;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#F97583"}},"void"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#B392F0"}},"createMap"),c("span",{style:{color:"#E1E4E8"}},"(Thread "),c("span",{style:{color:"#FFAB70"}},"t"),c("span",{style:{color:"#E1E4E8"}},", T "),c("span",{style:{color:"#FFAB70"}},"firstValue"),c("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        t.inheritableThreadLocals "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#F97583"}},"new"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#B392F0"}},"ThreadLocalMap"),c("span",{style:{color:"#E1E4E8"}},"("),c("span",{style:{color:"#79B8FF"}},"this"),c("span",{style:{color:"#E1E4E8"}},", firstValue);")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"}")])])]),c("pre",{class:"shiki github-light vp-code-light"},[c("code",null,[c("span",{class:"line"},[c("span",{style:{color:"#D73A49"}},"public"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#D73A49"}},"class"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#6F42C1"}},"InheritableThreadLocal"),c("span",{style:{color:"#24292E"}},"<"),c("span",{style:{color:"#D73A49"}},"T"),c("span",{style:{color:"#24292E"}},"> "),c("span",{style:{color:"#D73A49"}},"extends"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#6F42C1"}},"ThreadLocal"),c("span",{style:{color:"#24292E"}},"<"),c("span",{style:{color:"#D73A49"}},"T"),c("span",{style:{color:"#24292E"}},"> {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#D73A49"}},"protected"),c("span",{style:{color:"#24292E"}}," T "),c("span",{style:{color:"#6F42C1"}},"childValue"),c("span",{style:{color:"#24292E"}},"(T "),c("span",{style:{color:"#E36209"}},"parentValue"),c("span",{style:{color:"#24292E"}},") {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        "),c("span",{style:{color:"#D73A49"}},"return"),c("span",{style:{color:"#24292E"}}," parentValue;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    }")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    ThreadLocalMap "),c("span",{style:{color:"#6F42C1"}},"getMap"),c("span",{style:{color:"#24292E"}},"(Thread "),c("span",{style:{color:"#E36209"}},"t"),c("span",{style:{color:"#24292E"}},") {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"       "),c("span",{style:{color:"#D73A49"}},"return"),c("span",{style:{color:"#24292E"}}," t.inheritableThreadLocals;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    }")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#D73A49"}},"void"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#6F42C1"}},"createMap"),c("span",{style:{color:"#24292E"}},"(Thread "),c("span",{style:{color:"#E36209"}},"t"),c("span",{style:{color:"#24292E"}},", T "),c("span",{style:{color:"#E36209"}},"firstValue"),c("span",{style:{color:"#24292E"}},") {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        t.inheritableThreadLocals "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#D73A49"}},"new"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#6F42C1"}},"ThreadLocalMap"),c("span",{style:{color:"#24292E"}},"("),c("span",{style:{color:"#005CC5"}},"this"),c("span",{style:{color:"#24292E"}},", firstValue);")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    }")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"}")])])]),c("button",{class:"collapse"})],-1),fn=c("p",null,"实现父子线程间的局部变量共享需要追溯到 Thread 对象的构造方法：",-1),Bn=c("div",{style:{"max-height":"300px"},class:"language-java"},[c("button",{title:"Copy Code",class:"copy"}),c("span",{class:"lang"},"java"),c("pre",{class:"shiki github-dark vp-code-dark"},[c("code",null,[c("span",{class:"line"},[c("span",{style:{color:"#F97583"}},"private"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#F97583"}},"void"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#B392F0"}},"init"),c("span",{style:{color:"#E1E4E8"}},"(ThreadGroup g, Runnable target, String name, "),c("span",{style:{color:"#F97583"}},"long"),c("span",{style:{color:"#E1E4E8"}}," stackSize, AccessControlContext acc,")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"                  "),c("span",{style:{color:"#6A737D"}},"// 该参数默认是 true")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"                  "),c("span",{style:{color:"#F97583"}},"boolean"),c("span",{style:{color:"#E1E4E8"}}," inheritThreadLocals) {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"  \t"),c("span",{style:{color:"#6A737D"}},"// ...")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    Thread parent "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#B392F0"}},"currentThread"),c("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#6A737D"}},"// 判断父线程（创建子线程的线程）的 inheritableThreadLocals 属性不为 null")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#F97583"}},"if"),c("span",{style:{color:"#E1E4E8"}}," (inheritThreadLocals "),c("span",{style:{color:"#F97583"}},"&&"),c("span",{style:{color:"#E1E4E8"}}," parent.inheritableThreadLocals "),c("span",{style:{color:"#F97583"}},"!="),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#79B8FF"}},"null"),c("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        "),c("span",{style:{color:"#6A737D"}},"// 复制父线程的 inheritableThreadLocals 属性，实现父子线程局部变量共享")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        "),c("span",{style:{color:"#79B8FF"}},"this"),c("span",{style:{color:"#E1E4E8"}},".inheritableThreadLocals "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," ThreadLocal."),c("span",{style:{color:"#B392F0"}},"createInheritedMap"),c("span",{style:{color:"#E1E4E8"}},"(parent.inheritableThreadLocals); ")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#6A737D"}},"// ..")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"}")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"// 【本质上还是创建 ThreadLocalMap，只是把父类中的可继承数据设置进去了】")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#F97583"}},"static"),c("span",{style:{color:"#E1E4E8"}}," ThreadLocalMap "),c("span",{style:{color:"#B392F0"}},"createInheritedMap"),c("span",{style:{color:"#E1E4E8"}},"(ThreadLocalMap parentMap) {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#F97583"}},"return"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#F97583"}},"new"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#B392F0"}},"ThreadLocalMap"),c("span",{style:{color:"#E1E4E8"}},"(parentMap);")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"}")])])]),c("pre",{class:"shiki github-light vp-code-light"},[c("code",null,[c("span",{class:"line"},[c("span",{style:{color:"#D73A49"}},"private"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#D73A49"}},"void"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#6F42C1"}},"init"),c("span",{style:{color:"#24292E"}},"(ThreadGroup g, Runnable target, String name, "),c("span",{style:{color:"#D73A49"}},"long"),c("span",{style:{color:"#24292E"}}," stackSize, AccessControlContext acc,")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"                  "),c("span",{style:{color:"#6A737D"}},"// 该参数默认是 true")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"                  "),c("span",{style:{color:"#D73A49"}},"boolean"),c("span",{style:{color:"#24292E"}}," inheritThreadLocals) {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"  \t"),c("span",{style:{color:"#6A737D"}},"// ...")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    Thread parent "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#6F42C1"}},"currentThread"),c("span",{style:{color:"#24292E"}},"();")]),p("\n"),c("span",{class:"line"}),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#6A737D"}},"// 判断父线程（创建子线程的线程）的 inheritableThreadLocals 属性不为 null")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#D73A49"}},"if"),c("span",{style:{color:"#24292E"}}," (inheritThreadLocals "),c("span",{style:{color:"#D73A49"}},"&&"),c("span",{style:{color:"#24292E"}}," parent.inheritableThreadLocals "),c("span",{style:{color:"#D73A49"}},"!="),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#005CC5"}},"null"),c("span",{style:{color:"#24292E"}},") {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        "),c("span",{style:{color:"#6A737D"}},"// 复制父线程的 inheritableThreadLocals 属性，实现父子线程局部变量共享")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        "),c("span",{style:{color:"#005CC5"}},"this"),c("span",{style:{color:"#24292E"}},".inheritableThreadLocals "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," ThreadLocal."),c("span",{style:{color:"#6F42C1"}},"createInheritedMap"),c("span",{style:{color:"#24292E"}},"(parent.inheritableThreadLocals); ")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    }")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#6A737D"}},"// ..")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"}")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#6A737D"}},"// 【本质上还是创建 ThreadLocalMap，只是把父类中的可继承数据设置进去了】")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#D73A49"}},"static"),c("span",{style:{color:"#24292E"}}," ThreadLocalMap "),c("span",{style:{color:"#6F42C1"}},"createInheritedMap"),c("span",{style:{color:"#24292E"}},"(ThreadLocalMap parentMap) {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#D73A49"}},"return"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#D73A49"}},"new"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#6F42C1"}},"ThreadLocalMap"),c("span",{style:{color:"#24292E"}},"(parentMap);")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"}")])])]),c("button",{class:"collapse"})],-1),kn=c("div",{style:{"max-height":"300px"},class:"language-java"},[c("button",{title:"Copy Code",class:"copy"}),c("span",{class:"lang"},"java"),c("pre",{class:"shiki github-dark vp-code-dark"},[c("code",null,[c("span",{class:"line"},[c("span",{style:{color:"#F97583"}},"private"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#B392F0"}},"ThreadLocalMap"),c("span",{style:{color:"#E1E4E8"}},"(ThreadLocalMap parentMap) {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#6A737D"}},"// 获取父线程的哈希表")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#F97583"}},"Entry"),c("span",{style:{color:"#E1E4E8"}},"[] parentTable "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," parentMap.table;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#F97583"}},"int"),c("span",{style:{color:"#E1E4E8"}}," len "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," parentTable.length;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#B392F0"}},"setThreshold"),c("span",{style:{color:"#E1E4E8"}},"(len);")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    table "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#F97583"}},"new"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#F97583"}},"Entry"),c("span",{style:{color:"#E1E4E8"}},"[len];")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"\t"),c("span",{style:{color:"#6A737D"}},"// 【逐个复制父线程 ThreadLocalMap 中的数据】")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    "),c("span",{style:{color:"#F97583"}},"for"),c("span",{style:{color:"#E1E4E8"}}," ("),c("span",{style:{color:"#F97583"}},"int"),c("span",{style:{color:"#E1E4E8"}}," j "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#79B8FF"}},"0"),c("span",{style:{color:"#E1E4E8"}},"; j "),c("span",{style:{color:"#F97583"}},"<"),c("span",{style:{color:"#E1E4E8"}}," len; j"),c("span",{style:{color:"#F97583"}},"++"),c("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        Entry e "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," parentTable[j];")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        "),c("span",{style:{color:"#F97583"}},"if"),c("span",{style:{color:"#E1E4E8"}}," (e "),c("span",{style:{color:"#F97583"}},"!="),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#79B8FF"}},"null"),c("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"            ThreadLocal<"),c("span",{style:{color:"#F97583"}},"Object"),c("span",{style:{color:"#E1E4E8"}},"> key "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," (ThreadLocal"),c("span",{style:{color:"#F97583"}},"<"),c("span",{style:{color:"#E1E4E8"}},"Object"),c("span",{style:{color:"#F97583"}},">"),c("span",{style:{color:"#E1E4E8"}},") e."),c("span",{style:{color:"#B392F0"}},"get"),c("span",{style:{color:"#E1E4E8"}},"();")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"            "),c("span",{style:{color:"#F97583"}},"if"),c("span",{style:{color:"#E1E4E8"}}," (key "),c("span",{style:{color:"#F97583"}},"!="),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#79B8FF"}},"null"),c("span",{style:{color:"#E1E4E8"}},") {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"                "),c("span",{style:{color:"#6A737D"}},"// 调用的是 InheritableThreadLocal#childValue(T parentValue)")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"                Object value "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," key."),c("span",{style:{color:"#B392F0"}},"childValue"),c("span",{style:{color:"#E1E4E8"}},"(e.value);")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"                Entry c "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#F97583"}},"new"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#B392F0"}},"Entry"),c("span",{style:{color:"#E1E4E8"}},"(key, value);")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"                "),c("span",{style:{color:"#F97583"}},"int"),c("span",{style:{color:"#E1E4E8"}}," h "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," key.threadLocalHashCode "),c("span",{style:{color:"#F97583"}},"&"),c("span",{style:{color:"#E1E4E8"}}," (len "),c("span",{style:{color:"#F97583"}},"-"),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#79B8FF"}},"1"),c("span",{style:{color:"#E1E4E8"}},");")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"                "),c("span",{style:{color:"#6A737D"}},"// 线性探测")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"                "),c("span",{style:{color:"#F97583"}},"while"),c("span",{style:{color:"#E1E4E8"}}," (table[h] "),c("span",{style:{color:"#F97583"}},"!="),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#79B8FF"}},"null"),c("span",{style:{color:"#E1E4E8"}},")")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"                    h "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," "),c("span",{style:{color:"#B392F0"}},"nextIndex"),c("span",{style:{color:"#E1E4E8"}},"(h, len);")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"                table[h] "),c("span",{style:{color:"#F97583"}},"="),c("span",{style:{color:"#E1E4E8"}}," c;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"                size"),c("span",{style:{color:"#F97583"}},"++"),c("span",{style:{color:"#E1E4E8"}},";")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"            }")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"        }")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"    }")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#E1E4E8"}},"}")])])]),c("pre",{class:"shiki github-light vp-code-light"},[c("code",null,[c("span",{class:"line"},[c("span",{style:{color:"#D73A49"}},"private"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#6F42C1"}},"ThreadLocalMap"),c("span",{style:{color:"#24292E"}},"(ThreadLocalMap parentMap) {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#6A737D"}},"// 获取父线程的哈希表")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#D73A49"}},"Entry"),c("span",{style:{color:"#24292E"}},"[] parentTable "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," parentMap.table;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#D73A49"}},"int"),c("span",{style:{color:"#24292E"}}," len "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," parentTable.length;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#6F42C1"}},"setThreshold"),c("span",{style:{color:"#24292E"}},"(len);")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    table "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#D73A49"}},"new"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#D73A49"}},"Entry"),c("span",{style:{color:"#24292E"}},"[len];")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"\t"),c("span",{style:{color:"#6A737D"}},"// 【逐个复制父线程 ThreadLocalMap 中的数据】")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    "),c("span",{style:{color:"#D73A49"}},"for"),c("span",{style:{color:"#24292E"}}," ("),c("span",{style:{color:"#D73A49"}},"int"),c("span",{style:{color:"#24292E"}}," j "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#005CC5"}},"0"),c("span",{style:{color:"#24292E"}},"; j "),c("span",{style:{color:"#D73A49"}},"<"),c("span",{style:{color:"#24292E"}}," len; j"),c("span",{style:{color:"#D73A49"}},"++"),c("span",{style:{color:"#24292E"}},") {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        Entry e "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," parentTable[j];")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        "),c("span",{style:{color:"#D73A49"}},"if"),c("span",{style:{color:"#24292E"}}," (e "),c("span",{style:{color:"#D73A49"}},"!="),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#005CC5"}},"null"),c("span",{style:{color:"#24292E"}},") {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"            ThreadLocal<"),c("span",{style:{color:"#D73A49"}},"Object"),c("span",{style:{color:"#24292E"}},"> key "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," (ThreadLocal"),c("span",{style:{color:"#D73A49"}},"<"),c("span",{style:{color:"#24292E"}},"Object"),c("span",{style:{color:"#D73A49"}},">"),c("span",{style:{color:"#24292E"}},") e."),c("span",{style:{color:"#6F42C1"}},"get"),c("span",{style:{color:"#24292E"}},"();")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"            "),c("span",{style:{color:"#D73A49"}},"if"),c("span",{style:{color:"#24292E"}}," (key "),c("span",{style:{color:"#D73A49"}},"!="),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#005CC5"}},"null"),c("span",{style:{color:"#24292E"}},") {")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"                "),c("span",{style:{color:"#6A737D"}},"// 调用的是 InheritableThreadLocal#childValue(T parentValue)")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"                Object value "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," key."),c("span",{style:{color:"#6F42C1"}},"childValue"),c("span",{style:{color:"#24292E"}},"(e.value);")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"                Entry c "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#D73A49"}},"new"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#6F42C1"}},"Entry"),c("span",{style:{color:"#24292E"}},"(key, value);")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"                "),c("span",{style:{color:"#D73A49"}},"int"),c("span",{style:{color:"#24292E"}}," h "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," key.threadLocalHashCode "),c("span",{style:{color:"#D73A49"}},"&"),c("span",{style:{color:"#24292E"}}," (len "),c("span",{style:{color:"#D73A49"}},"-"),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#005CC5"}},"1"),c("span",{style:{color:"#24292E"}},");")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"                "),c("span",{style:{color:"#6A737D"}},"// 线性探测")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"                "),c("span",{style:{color:"#D73A49"}},"while"),c("span",{style:{color:"#24292E"}}," (table[h] "),c("span",{style:{color:"#D73A49"}},"!="),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#005CC5"}},"null"),c("span",{style:{color:"#24292E"}},")")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"                    h "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," "),c("span",{style:{color:"#6F42C1"}},"nextIndex"),c("span",{style:{color:"#24292E"}},"(h, len);")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"                table[h] "),c("span",{style:{color:"#D73A49"}},"="),c("span",{style:{color:"#24292E"}}," c;")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"                size"),c("span",{style:{color:"#D73A49"}},"++"),c("span",{style:{color:"#24292E"}},";")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"            }")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"        }")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"    }")]),p("\n"),c("span",{class:"line"},[c("span",{style:{color:"#24292E"}},"}")])])]),c("button",{class:"collapse"})],-1),Sn=c("hr",null,null,-1);const Tn=l(u,[["render",function(l,s,o,i,F,u){const Tn=y,xn=e;return t(),n(xn,{frontmatter:F.frontmatter,data:F.data},{"main-content-md":a((()=>[c("h1",A,[p("并发编程整理版 "),r(Tn,{class:"header-anchor",href:"#并发编程整理版","aria-label":'Permalink to "并发编程整理版"'},{default:a((()=>[p("​")])),_:1})]),c("p",null,[p("参考视频："),r(Tn,{href:"https://www.bilibili.com/video/BV16J411h7Rd",target:"_blank",rel:"noreferrer"},{default:a((()=>[p("https://www.bilibili.com/video/BV16J411h7Rd")])),_:1})]),d,c("h2",D,[p("无锁 "),r(Tn,{class:"header-anchor",href:"#无锁","aria-label":'Permalink to "无锁"'},{default:a((()=>[p("​")])),_:1})]),c("h3",h,[p("CAS "),r(Tn,{class:"header-anchor",href:"#cas","aria-label":'Permalink to "CAS"'},{default:a((()=>[p("​")])),_:1})]),c("h4",g,[p("例子 "),r(Tn,{class:"header-anchor",href:"#例子","aria-label":'Permalink to "例子"'},{default:a((()=>[p("​")])),_:1})]),C,b,m,v,f,B,c("h4",k,[p("原理 "),r(Tn,{class:"header-anchor",href:"#原理","aria-label":'Permalink to "原理"'},{default:a((()=>[p("​")])),_:1})]),S,T,x,L,w,I,j,c("h4",M,[p("前提 "),r(Tn,{class:"header-anchor",href:"#前提","aria-label":'Permalink to "前提"'},{default:a((()=>[p("​")])),_:1})]),U,P,c("h4",_,[R,p(),r(Tn,{class:"header-anchor",href:"#效率高","aria-label":'Permalink to "**效率高**"'},{default:a((()=>[p("​")])),_:1})]),V,O,c("h4",z,[p("优缺点 "),r(Tn,{class:"header-anchor",href:"#优缺点","aria-label":'Permalink to "优缺点"'},{default:a((()=>[p("​")])),_:1})]),N,H,G,K,J,c("h4",$,[p("乐观锁 "),r(Tn,{class:"header-anchor",href:"#乐观锁","aria-label":'Permalink to "乐观锁"'},{default:a((()=>[p("​")])),_:1})]),Y,q,W,c("h3",Q,[p("Atomic "),r(Tn,{class:"header-anchor",href:"#atomic","aria-label":'Permalink to "Atomic"'},{default:a((()=>[p("​")])),_:1})]),c("h4",Z,[p("常用API "),r(Tn,{class:"header-anchor",href:"#常用api","aria-label":'Permalink to "常用API"'},{default:a((()=>[p("​")])),_:1})]),X,ll,sl,ol,nl,al,c("h4",el,[p("原理分析 "),r(Tn,{class:"header-anchor",href:"#原理分析","aria-label":'Permalink to "原理分析"'},{default:a((()=>[p("​")])),_:1})]),tl,cl,pl,rl,El,yl,il,Fl,c("h4",ul,[p("原子引用 "),r(Tn,{class:"header-anchor",href:"#原子引用","aria-label":'Permalink to "原子引用"'},{default:a((()=>[p("​")])),_:1})]),Al,dl,Dl,hl,gl,Cl,c("h4",bl,[p("原子数组 "),r(Tn,{class:"header-anchor",href:"#原子数组","aria-label":'Permalink to "原子数组"'},{default:a((()=>[p("​")])),_:1})]),ml,vl,fl,Bl,c("h4",kl,[p("原子更新器 "),r(Tn,{class:"header-anchor",href:"#原子更新器","aria-label":'Permalink to "原子更新器"'},{default:a((()=>[p("​")])),_:1})]),Sl,Tl,xl,Ll,wl,Il,c("h4",jl,[p("原子累加器 "),r(Tn,{class:"header-anchor",href:"#原子累加器","aria-label":'Permalink to "原子累加器"'},{default:a((()=>[p("​")])),_:1})]),Ml,Ul,Pl,_l,Rl,Vl,Ol,c("h3",zl,[p("Adder "),r(Tn,{class:"header-anchor",href:"#adder","aria-label":'Permalink to "Adder"'},{default:a((()=>[p("​")])),_:1})]),c("h4",Nl,[p("优化机制 "),r(Tn,{class:"header-anchor",href:"#优化机制","aria-label":'Permalink to "优化机制"'},{default:a((()=>[p("​")])),_:1})]),Hl,Gl,Kl,Jl,$l,Yl,ql,c("h4",Wl,[p("伪共享 "),r(Tn,{class:"header-anchor",href:"#伪共享","aria-label":'Permalink to "伪共享"'},{default:a((()=>[p("​")])),_:1})]),Ql,Zl,Xl,ls,ss,os,ns,c("h4",as,[p("源码解析 "),r(Tn,{class:"header-anchor",href:"#源码解析","aria-label":'Permalink to "源码解析"'},{default:a((()=>[p("​")])),_:1})]),es,ts,cs,ps,rs,Es,ys,c("h3",is,[p("ABA "),r(Tn,{class:"header-anchor",href:"#aba","aria-label":'Permalink to "ABA"'},{default:a((()=>[p("​")])),_:1})]),Fs,us,c("h4",As,[ds,p(),r(Tn,{class:"header-anchor",href:"#atomicstampedreference","aria-label":'Permalink to "**AtomicStampedReference**"'},{default:a((()=>[p("​")])),_:1})]),Ds,hs,gs,c("h4",Cs,[p("AtomicMarkableReference "),r(Tn,{class:"header-anchor",href:"#atomicmarkablereference","aria-label":'Permalink to "AtomicMarkableReference"'},{default:a((()=>[p("​")])),_:1})]),bs,ms,vs,fs,Bs,c("h4",ks,[p("两者的区别 "),r(Tn,{class:"header-anchor",href:"#两者的区别","aria-label":'Permalink to "两者的区别"'},{default:a((()=>[p("​")])),_:1})]),Ss,Ts,c("h3",xs,[p("Unsafe "),r(Tn,{class:"header-anchor",href:"#unsafe","aria-label":'Permalink to "Unsafe"'},{default:a((()=>[p("​")])),_:1})]),Ls,ws,Is,js,Ms,c("h3",Us,[p("final "),r(Tn,{class:"header-anchor",href:"#final","aria-label":'Permalink to "final"'},{default:a((()=>[p("​")])),_:1})]),c("h4",Ps,[p("原理 "),r(Tn,{class:"header-anchor",href:"#原理-1","aria-label":'Permalink to "原理"'},{default:a((()=>[p("​")])),_:1})]),_s,Rs,Vs,Os,zs,Ns,c("h4",Hs,[p("不可变 "),r(Tn,{class:"header-anchor",href:"#不可变","aria-label":'Permalink to "不可变"'},{default:a((()=>[p("​")])),_:1})]),Gs,Ks,Js,$s,Ys,c("h3",qs,[p("State "),r(Tn,{class:"header-anchor",href:"#state","aria-label":'Permalink to "State"'},{default:a((()=>[p("​")])),_:1})]),Ws,Qs,Zs,c("h3",Xs,[p("Local "),r(Tn,{class:"header-anchor",href:"#local","aria-label":'Permalink to "Local"'},{default:a((()=>[p("​")])),_:1})]),c("h4",lo,[p("基本介绍 "),r(Tn,{class:"header-anchor",href:"#基本介绍","aria-label":'Permalink to "基本介绍"'},{default:a((()=>[p("​")])),_:1})]),so,oo,no,ao,eo,to,co,c("h4",po,[p("基本使用 "),r(Tn,{class:"header-anchor",href:"#基本使用","aria-label":'Permalink to "基本使用"'},{default:a((()=>[p("​")])),_:1})]),c("h5",ro,[p("常用方法 "),r(Tn,{class:"header-anchor",href:"#常用方法","aria-label":'Permalink to "常用方法"'},{default:a((()=>[p("​")])),_:1})]),Eo,yo,io,c("h5",Fo,[p("应用场景 "),r(Tn,{class:"header-anchor",href:"#应用场景","aria-label":'Permalink to "应用场景"'},{default:a((()=>[p("​")])),_:1})]),uo,Ao,Do,ho,go,Co,bo,mo,vo,c("h4",fo,[p("实现原理 "),r(Tn,{class:"header-anchor",href:"#实现原理","aria-label":'Permalink to "实现原理"'},{default:a((()=>[p("​")])),_:1})]),c("h5",Bo,[p("底层结构 "),r(Tn,{class:"header-anchor",href:"#底层结构","aria-label":'Permalink to "底层结构"'},{default:a((()=>[p("​")])),_:1})]),ko,So,To,xo,Lo,wo,Io,jo,c("h5",Mo,[p("成员变量 "),r(Tn,{class:"header-anchor",href:"#成员变量","aria-label":'Permalink to "成员变量"'},{default:a((()=>[p("​")])),_:1})]),Uo,Po,c("h5",_o,[p("成员方法 "),r(Tn,{class:"header-anchor",href:"#成员方法","aria-label":'Permalink to "成员方法"'},{default:a((()=>[p("​")])),_:1})]),Ro,Vo,Oo,c("h4",zo,[p("LocalMap "),r(Tn,{class:"header-anchor",href:"#localmap","aria-label":'Permalink to "LocalMap"'},{default:a((()=>[p("​")])),_:1})]),c("h5",No,[p("成员属性 "),r(Tn,{class:"header-anchor",href:"#成员属性","aria-label":'Permalink to "成员属性"'},{default:a((()=>[p("​")])),_:1})]),Ho,Go,Ko,Jo,$o,Yo,qo,Wo,c("h5",Qo,[p("成员方法 "),r(Tn,{class:"header-anchor",href:"#成员方法-1","aria-label":'Permalink to "成员方法"'},{default:a((()=>[p("​")])),_:1})]),Zo,Xo,c("h5",ln,[p("清理方法 "),r(Tn,{class:"header-anchor",href:"#清理方法","aria-label":'Permalink to "清理方法"'},{default:a((()=>[p("​")])),_:1})]),sn,c("p",null,[p("参考视频："),r(Tn,{href:"https://space.bilibili.com/457326371/",target:"_blank",rel:"noreferrer"},{default:a((()=>[p("https://space.bilibili.com/457326371/")])),_:1})]),on,c("h4",nn,[p("内存泄漏 "),r(Tn,{class:"header-anchor",href:"#内存泄漏","aria-label":'Permalink to "内存泄漏"'},{default:a((()=>[p("​")])),_:1})]),an,en,tn,cn,pn,rn,c("h4",En,[p("补充：内存释放时机 "),r(Tn,{class:"header-anchor",href:"#补充-内存释放时机","aria-label":'Permalink to "补充：内存释放时机"'},{default:a((()=>[p("​")])),_:1})]),yn,Fn,un,c("h4",An,[p("变量传递 "),r(Tn,{class:"header-anchor",href:"#变量传递","aria-label":'Permalink to "变量传递"'},{default:a((()=>[p("​")])),_:1})]),c("h5",dn,[p("基本使用 "),r(Tn,{class:"header-anchor",href:"#基本使用-1","aria-label":'Permalink to "基本使用"'},{default:a((()=>[p("​")])),_:1})]),Dn,hn,gn,Cn,c("h5",bn,[p("实现原理 "),r(Tn,{class:"header-anchor",href:"#实现原理-1","aria-label":'Permalink to "实现原理"'},{default:a((()=>[p("​")])),_:1})]),mn,vn,fn,Bn,kn,c("p",null,[p("参考文章："),r(Tn,{href:"https://blog.csdn.net/feichitianxia/article/details/110495764",target:"_blank",rel:"noreferrer"},{default:a((()=>[p("https://blog.csdn.net/feichitianxia/article/details/110495764")])),_:1})]),Sn])),"main-header":a((()=>[E(l.$slots,"main-header")])),"main-header-after":a((()=>[E(l.$slots,"main-header-after")])),"main-nav":a((()=>[E(l.$slots,"main-nav")])),"main-content":a((()=>[E(l.$slots,"main-content")])),"main-content-after":a((()=>[E(l.$slots,"main-content-after")])),"main-nav-before":a((()=>[E(l.$slots,"main-nav-before")])),"main-nav-after":a((()=>[E(l.$slots,"main-nav-after")])),comment:a((()=>[E(l.$slots,"comment")])),footer:a((()=>[E(l.$slots,"footer")])),aside:a((()=>[E(l.$slots,"aside")])),"aside-custom":a((()=>[E(l.$slots,"aside-custom")])),default:a((()=>[E(l.$slots,"default")])),_:3},8,["frontmatter","data"])}]]);export{i as __pageData,Tn as default};
