<!DOCTYPE html><html lang="en" data-critters-container><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><link rel="icon" href="https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230825001534253.png"><script>const prefersDark=window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches,colorSchemeSetting=localStorage.getItem("vueuse-color-scheme")||"auto";("dark"===colorSchemeSetting||prefersDark&&"light"!==colorSchemeSetting)&&document.documentElement.classList.toggle("dark",!0)</script><script>const locale=localStorage.getItem("valaxy-locale")||"zh-CN";document.documentElement.setAttribute("lang",locale)</script><script type="module" async crossorigin src="/assets/app-eda06591.js"></script><link rel="modulepreload" crossorigin href="/js/animejs/animejs.82133372.js"><link rel="modulepreload" crossorigin href="/assets/app-eda06591.js"><link rel="modulepreload" crossorigin href="/js/@vueuse/@vueuse.592447f3.js"><style>@charset "UTF-8";.back-to-top{position:fixed;right:-1.5rem;bottom:1rem;z-index:var(--yun-z-go-up-btn);opacity:0;pointer-events:none;color:var(--va-c-primary);transform:translate(0) rotate(270deg);transition:transform var(--va-transition-duration),opacity var(--va-transition-duration-fast)!important}.progress-circle{transition:.3s stroke-dashoffset;transform:rotate(-90deg);transform-origin:50% 50%}.progress-circle-container{position:absolute}.links-of-author{display:flex;flex-wrap:wrap;justify-content:center}.links-of-author .icon{width:1.5rem;height:1.5rem}.links-of-author-item{line-height:1;font-size:.9rem}.site-nav{display:flex;justify-content:center;overflow:hidden;line-height:1.5;white-space:nowrap;text-align:center;margin-top:1rem}.site-link-item{display:flex;padding:0 15px;align-items:center;border-left:1px solid var(--va-c-gray);flex-direction:column;color:var(--va-c-text)}.site-link-item:first-child,.site-link-item:last-child{line-height:1;padding:0}.site-link-item:first-child{border-left:none;border-right:1px solid var(--va-c-gray)}.site-link-item:last-child{border-left:1px solid var(--va-c-gray)}.site-link-item:nth-child(2){border:none}.site-link-item .count{color:var(--va-c-text);font-family:var(--va-font-sans);display:block;text-align:center;font-size:1rem}.site-link-item .icon{width:1.5rem;height:1.5rem}.site-link-item .icon:hover{color:var(--va-c-primary-light)}.site-author-avatar{display:inline-block;line-height:0;position:relative}.site-author-avatar img{height:96px;width:96px;max-width:100%;margin:0;padding:4px;background-color:#fff;box-shadow:0 0 10px #0003;transition:.4s}.site-author-avatar img:hover{box-shadow:0 0 30px rgba(var(--va-c-primary-rgb),.2)}.site-author-status{position:absolute;height:1.8rem;width:1.8rem;bottom:0;right:0;line-height:1.8rem;border-radius:50%;box-shadow:0 1px 2px #0003;background-color:var(--va-c-bg-light);border:1px solid rgba(255,255,255,.1)}.site-name{color:var(--va-c-text);font-family:var(--va-font-serif);font-weight:900}.site-subtitle{color:var(--va-c-gray);display:block}.sidebar{width:calc(100vw - 64px);max-width:var(--va-sidebar-width);background-image:var(--yun-sidebar-bg-img);background-position:bottom 1rem center;transform:translate(-100%);transition:box-shadow var(--va-transition-duration),background-color var(--va-transition-duration),opacity .25s,transform var(--va-transition-duration) cubic-bezier(.19,1,.22,1)!important}.yun-search-btn{position:fixed;top:.6rem;right:.8rem;color:var(--va-c-primary);z-index:var(--yun-z-search-btn)}.yun-bg{position:fixed;width:100%;height:100%;z-index:-1;background-image:var(--yun-bg-img);background-size:cover;background-position:center;background-repeat:no-repeat;background-attachment:fixed;animation-name:bgFadeIn;animation-duration:2s;opacity:var(--yun-bg-img-opacity,1)}@supports (-webkit-touch-callout:none){.yun-bg{background-attachment:scroll}}@keyframes bgFadeIn{0%{opacity:0}to{opacity:var(--yun-bg-img-opacity,1)}}canvas.fireworks{position:fixed;left:0;top:0;z-index:1;pointer-events:none}*,:after,:before{box-sizing:border-box;border-width:0;border-style:solid;border-color:var(--un-default-border-color,#e5e7eb)}html{line-height:1.5;-webkit-text-size-adjust:100%;text-size-adjust:100%;-moz-tab-size:4;tab-size:4;font-family:ui-sans-serif,system-ui,-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica Neue,Arial,Noto Sans,sans-serif,"Apple Color Emoji","Segoe UI Emoji",Segoe UI Symbol,"Noto Color Emoji"}body{margin:0;line-height:inherit}hr{height:0;color:inherit;border-top-width:1px}h1,h2,h3,h4,h5{font-size:inherit;font-weight:inherit}a{color:inherit;text-decoration:inherit}strong{font-weight:bolder}code,pre{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,Liberation Mono,Courier New,monospace;font-size:1em}button{font-family:inherit;font-feature-settings:inherit;font-variation-settings:inherit;font-size:100%;font-weight:inherit;line-height:inherit;color:inherit;margin:0;padding:0}button{text-transform:none}[type=button],button{-webkit-appearance:button;background-image:none}blockquote,figure,h1,h2,h3,h4,h5,hr,p,pre{margin:0}ul{list-style:none;margin:0;padding:0}button{cursor:pointer}canvas,img,svg{display:block;vertical-align:middle}img{max-width:100%;height:auto}body{counter-reset:katexEqnNo mmlEqnNo}html{-webkit-tap-highlight-color:transparent}a{color:var(--va-c-link);font-weight:500}*{outline:0}hr{opacity:.2;margin:1rem}button{background-color:transparent}#app,body,html{margin:0;padding:0;line-height:2}body{background-color:var(--va-c-bg)}a{cursor:pointer}html:not(.dark) .vp-code-dark{display:none}@media screen and (max-width:640px){.markdown-body div[class*=language-]{margin:0 var(--va-code-mobile-margin-x,-1rem)}}@media (min-width:640px){.markdown-body div[class*=language-]{border-radius:6px;margin:16px 0}}@media (max-width:639px){.markdown-body li div[class*=language-]{border-radius:6px 0 0 6px}}.markdown-body code{font-size:.85em}.markdown-body div[class*=language-]{position:relative;background-color:var(--va-code-block-bg);overflow-x:auto}.markdown-body div[class*=language-] code{padding:0 24px;line-height:var(--va-code-line-height);font-size:var(--va-code-font-size);color:var(--va-code-block-color);transition:color .5s;width:fit-content;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none}.markdown-body div[class*=language-] pre{position:relative;z-index:1;margin:0;padding:1rem 0;background:0 0;overflow-x:auto}.markdown-body div[class*=language-] pre code{display:block}.markdown-body [class*=language-]>button.copy{direction:ltr;position:absolute;top:12px;right:12px;z-index:3;border:1px solid var(--va-code-copy-code-border-color);border-radius:4px;width:40px;height:40px;background-color:var(--va-code-copy-code-bg);opacity:0;cursor:pointer;background-image:var(--va-icon-copy);background-position:50%;background-size:20px;background-repeat:no-repeat;transition:border-color .25s,background-color .25s,opacity .25s}.markdown-body [class*=language-]:hover>button.copy,.markdown-body [class*=language-]>button.copy:focus{opacity:1}.markdown-body [class*=language-]>button.copy:hover{border-color:var(--va-code-copy-code-hover-border-color);background-color:var(--va-code-copy-code-hover-bg)}.markdown-body [class*=language-]>span.lang{position:absolute;top:2px;right:8px;z-index:2;font-size:12px;font-weight:500;color:var(--va-code-lang-color);transition:color .4s,opacity .4s}.markdown-body [class*=language-]:hover>button.copy+span.lang,.markdown-body [class*=language-]>button.copy:focus+span.lang{opacity:0}:root{--va-c-text-warning:#544500}.vt-hamburger{display:flex;justify-content:center;align-items:center}.vt-hamburger:hover .vt-hamburger-top{transform:translate(-5.5px)}.vt-hamburger:hover .vt-hamburger-middle{transform:translate(0)}.vt-hamburger:hover .vt-hamburger-bottom{transform:translate(-11px)}.vt-hamburger-container{position:relative;width:22px;height:20px;overflow:hidden}.vt-hamburger-bottom,.vt-hamburger-middle,.vt-hamburger-top{left:0;position:absolute;width:22px;height:2px;background-color:var(--va-c-primary);transition:top .25s,background-color .5s,transform .25s}.vt-hamburger-top{top:0;transform:translate(0)}.vt-hamburger-middle{top:9px;transform:translate(-11px)}.vt-hamburger-bottom{top:18px;transform:translate(-5.5px)}h1:focus .header-anchor,h1:hover .header-anchor,h2:focus .header-anchor,h2:hover .header-anchor,h3:focus .header-anchor,h3:hover .header-anchor,h4:focus .header-anchor,h4:hover .header-anchor,h5:focus .header-anchor,h5:hover .header-anchor{visibility:visible;opacity:1}a.header-anchor{float:left;margin-top:.125em;margin-left:-.87em;padding-right:.23em;font-size:.85em;visibility:hidden;opacity:0;transition:opacity var(--va-transition-duration)}a.header-anchor:before{content:none}a.header-anchor:focus,a.header-anchor:hover{text-decoration:none}.markdown-body figure{text-align:center}:root{--va-aside-width:256px;--va-sidebar-width:300px;--va-border-width:1px;--va-font-serif:"Noto Serif SC",STZhongsong,STKaiti,KaiTi,Roboto,serif;--va-font-sans:Inter,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Oxygen,Ubuntu,Cantarell,"Fira Sans","Droid Sans","Helvetica Neue",sans-serif;--va-font-mono:Menlo,Monaco,Consolas,"Courier New",monospace;--va-transition-duration-fast:.2s;--va-transition-duration:.4s;--va-transition-duration-slow:.6s;--va-transition:all var(--va-transition-duration-fast) ease-in-out}:root{--va-c-white:#ffffff;--va-c-black:#1a1a1a;--va-c-gray:#8e8e8e;--va-c-danger:#db2828;--va-c-warning:#f2711c;--va-c-text-light-1:#213547;--va-c-text-light-2:rgba(60, 60, 60, .7);--va-c-text-light-3:rgba(60, 60, 60, .33);--va-c-text-light-4:rgba(60, 60, 60, .18);--va-c-text-dark-1:rgba(255, 255, 255, .87);--va-c-text-dark-2:rgba(235, 235, 235, .6);--va-c-text-dark-3:rgba(235, 235, 235, .38);--va-c-text-dark-4:rgba(235, 235, 235, .18);--va-c-primary-light:#8ad9e0;--va-c-primary-lighter:#c6edf0;--va-c-primary-dark:#39c0cb;--va-c-primary:#4dc6d0}:root{color-scheme:light;--va-c-brand:#4dc6d0;--va-border-color:#222;--va-c-bg:white;--va-c-bg-light:white;--va-c-bg-dark:#fafafa;--va-c-bg-opacity:rgba(255, 255, 255, .8);--va-c-bg-soft:#f9f9f9;--va-c-bg-alt:#f9f9f9;--va-c-bg-mute:#f1f1f1;--va-c-text:#333;--va-c-text-light:#555;--va-c-text-lighter:#666;--va-c-text-dark:#111;--va-c-primary-rgb:77,198,208;--va-c-link:var(--va-c-primary-dark);--va-c-divider:rgba(60, 60, 60, .2)}:root{--va-c-text-1:rgba(60, 60, 67);--va-c-text-2:rgba(60, 60, 67, .78);--va-c-text-3:rgba(60, 60, 67, .56)}:root{--va-code-line-height:1.7;--va-code-font-size:.875em;--va-code-block-color:var(--va-c-text-2);--va-code-block-bg:var(--va-c-bg-alt);--va-code-block-divider-color:var(--va-c-gutter);--va-code-lang-color:var(--va-c-text-3);--va-code-line-highlight-color:rgba(0, 0, 0, .5);--va-code-line-number-color:var(--va-c-text-dark-3);--va-code-copy-code-border-color:var(--va-c-divider);--va-code-copy-code-bg:var(--va-c-bg-soft);--va-code-copy-code-hover-border-color:var(--va-c-divider);--va-code-copy-code-hover-bg:var(--va-c-bg);--va-code-copy-code-active-text:var(--va-c-text-2);--va-code-copy-copied-text-content:"Copied"}:root{--va-icon-copy:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' height='20' width='20' stroke='rgba(128,128,128,1)' stroke-width='2' class='h-6 w-6' viewBox='0 0 24 24'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' d='M9 5H7a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2h-2M9 5a2 2 0 0 0 2 2h2a2 2 0 0 0 2-2M9 5a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2'/%3E%3C/svg%3E");--va-icon-copied:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' height='20' width='20' stroke='rgba(128,128,128,1)' stroke-width='2' class='h-6 w-6' viewBox='0 0 24 24'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' d='M9 5H7a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2h-2M9 5a2 2 0 0 0 2 2h2a2 2 0 0 0 2-2M9 5a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2m-6 9 2 2 4-4'/%3E%3C/svg%3E")}.post-category{color:var(--va-c-text)}.post-tag{white-space:nowrap;color:var(--yun-tag-color)}.post-tag:hover{color:var(--va-c-primary)}html{overflow-y:scroll}.yun-main{padding-left:var(--va-sidebar-width);transition:padding-left var(--va-transition-duration);box-sizing:border-box}.yun-icon-btn{background-color:transparent;cursor:pointer;display:inline-flex;align-items:center;justify-content:center;border:none;width:3rem;height:3rem;border-radius:50%;transition:background-color var(--va-transition-duration)}.yun-icon-btn div{font-size:1.2rem}.yun-icon-btn:hover{background-color:rgba(var(--va-c-primary-rgb),.08)}.yun-icon-btn:active{background-color:rgba(var(--va-c-primary-rgb),.16)}:root{--smc-font-sans:Raleway,-apple-system,"PingFang SC","Microsoft YaHei",Arial,sans-serif;--smc-font-serif:"Songti SC","Noto Serif SC",STZhongsong,STKaiti,KaiTi,Roboto,serif;--smc-font-mono:Menlo,Monaco,Consolas,"Courier New",monospace}:root{--smc-c-primary-light:#9ee0e5;--smc-c-primary-lighter:#daf3f5;--smc-c-primary:#4dc6d0;--smc-theme-name:yun;--smc-line-height:1.8;--smc-c-primary-rgb:77,198,208;--smc-c-text:#24292e;--smc-c-text-light:#555;--smc-c-text-lighter:#666;--smc-header-bottom-color:#eaecef;--smc-border-color:var(--smc-c-primary-light);--smc-code-bg-color:#f6f8fa;--smc-link-color:#31afb9}.markdown-body{-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%;background:var(--smc-bg-color);color:var(--smc-c-text);font-family:var(--smc-font-sans);font-size:1rem;line-height:var(--smc-line-height);overflow-wrap:break-word}.markdown-body *{box-sizing:border-box}.markdown-body a{background-color:transparent}.markdown-body a:active,.markdown-body a:hover{outline-width:0}.markdown-body blockquote{margin:1rem 0;padding:0 1rem;border-left:.25em solid var(--smc-border-color)}.markdown-body code,.markdown-body pre{font-family:Source Code Pro,Consolas,Monaco,SFMono-Regular,Ubuntu Mono,Menlo,monospace}.markdown-body code{padding:3px 6px;font-size:.85rem;color:var(--smc-c-text-light);background:var(--smc-code-bg-color);border-radius:3px}.markdown-body pre{margin-top:0;margin-bottom:0;overflow-wrap:normal;padding:1rem;overflow:auto;background-color:var(--smc-code-bg-color);border-radius:3px}.markdown-body pre>code{font-size:.85rem;white-space:pre}.markdown-body pre code{display:block;padding:0;margin:0;overflow:visible;line-height:inherit;word-break:normal;background-color:transparent;border:0}.markdown-body img{display:block;margin:1rem auto;max-width:92%;max-height:600px;border-radius:.2rem;transition:.4s;--tw-shadow:0 1px 3px 0 rgb(0 0 0/.1),0 1px 2px -1px rgb(0 0 0/.1);--tw-shadow-colored:0 1px 3px 0 var(--tw-shadow-color),0 1px 2px -1px var(--tw-shadow-color);-webkit-box-shadow:var(--tw-ring-offset-shadow,0 0 transparent),var(--tw-ring-shadow,0 0 transparent),var(--tw-shadow);box-shadow:var(--tw-ring-offset-shadow,0 0 transparent),var(--tw-ring-shadow,0 0 transparent),var(--tw-shadow)}.markdown-body img:hover{--tw-shadow:0 4px 6px -1px rgb(0 0 0/.1),0 2px 4px -2px rgb(0 0 0/.1);--tw-shadow-colored:0 4px 6px -1px var(--tw-shadow-color),0 2px 4px -2px var(--tw-shadow-color)}.markdown-body img:before{content:"「 LOADING ERROR 」"}@media screen and (min-width:1600px){.markdown-body img{max-width:800px}}.markdown-body a{color:var(--smc-c-primary);text-decoration:none;border-bottom:1px solid transparent;transition:all .2s ease-in-out}.markdown-body a:hover{color:var(--smc-link-color);border-bottom:1px solid var(--smc-link-color)}.markdown-body ul{padding-left:2em}.markdown-body ul ul{margin-top:0;margin-bottom:0}.markdown-body li{overflow-wrap:break-all;margin-top:.25em}.markdown-body li>p{margin-top:16px}.markdown-body strong{font-family:var(--smc-font-serif);font-weight:900}.markdown-body p{margin-top:1rem;margin-bottom:1rem;overflow-x:auto;overflow-y:hidden}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5{margin-top:1.5rem;margin-bottom:1rem;font-weight:300;line-height:1.5}.markdown-body h1{font-size:2.5rem;border-bottom:1px solid var(--smc-header-bottom-color)}.markdown-body h2{font-size:2.2rem;border-bottom:1px solid var(--smc-header-bottom-color)}.markdown-body h3{font-size:1.9rem}.markdown-body h4{font-size:1.6rem}.markdown-body h5{font-size:1.3rem}@media screen and (max-width:768px){.markdown-body h1{font-size:2rem}.markdown-body h2{font-size:1.8rem}.markdown-body h3{font-size:1.6rem}.markdown-body h4{font-size:1.4rem}.markdown-body h5{font-size:1.2rem}}.markdown-body{--smc-font-family:var(--va-font-sans);--c-toc-link:var(--va-c-text-light)}.markdown-body{word-wrap:break-word}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5{font-family:var(--va-font-serif);font-weight:900}.markdown-body ul{list-style:initial}.markdown-body ul li>p{margin-bottom:0}.markdown-body img{margin:.5rem auto;height:auto}.markdown-body p{overflow:unset}:root{--yun-post-card-max-width:900px;--yun-c-cloud:white;--yun-z-toc-btn:7;--yun-z-cloud:7;--yun-z-go-down:9;--yun-z-backdrop:9;--yun-z-sidebar:10;--yun-z-fireworks:11;--yun-z-menu-btn:20;--yun-z-go-up-btn:20;--yun-z-search-popup:30;--yun-z-search-btn:31;--va-z-overlay:var(--yun-z-backdrop)}:root{--yun-bg-img:url(/assets/bg-img-73ffcfc5.jpg);--yun-sidebar-bg-color:var(--va-c-bg-light);--yun-sidebar-bg-img:url(/assets/sidebar-bg-img-b7854581.webp)}:root{--va-c-bg-light:rgba(255, 255, 255, .8);--yun-sidebar-bg-img:url(https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230825004631944.png);--yun-sidebar-bg-color:rgba(255, 255, 255, 0)}*,:after,:before{--un-rotate:0;--un-rotate-x:0;--un-rotate-y:0;--un-rotate-z:0;--un-scale-x:1;--un-scale-y:1;--un-scale-z:1;--un-skew-x:0;--un-skew-y:0;--un-translate-x:0;--un-translate-y:0;--un-translate-z:0;--un-scroll-snap-strictness:proximity;--un-border-spacing-x:0;--un-border-spacing-y:0;--un-ring-offset-shadow:0 0 rgba(0,0,0,0);--un-ring-shadow:0 0 rgba(0,0,0,0);--un-shadow:0 0 rgba(0,0,0,0);--un-ring-offset-width:0px;--un-ring-offset-color:#fff;--un-ring-width:0px;--un-ring-color:rgba(147,197,253,.5)}.i-ri-alipay-line{--un-icon:url("data:image/svg+xml;utf8,%3Csvg viewBox='0 0 24 24' width='1.2em' height='1.2em' xmlns='http://www.w3.org/2000/svg' %3E%3Cpath fill='currentColor' d='M18.408 16.79c-2.173-.95-3.72-1.646-4.64-2.086c-1.4 1.696-2.872 2.72-5.08 2.72S5 16.064 5.176 14.392c.12-1.096.872-2.888 4.128-2.576c1.72.16 2.504.48 3.912.944c.36-.664.664-1.4.888-2.176H7.88v-.616h3.072V8.864H7.2v-.68h3.752V6.592s.032-.248.312-.248H12.8v1.848h4v.68h-4v1.104h3.264a12.41 12.41 0 0 1-1.32 3.32c.51.182 2.097.676 4.76 1.482a8 8 0 1 0-1.096 2.012ZM12 22C6.477 22 2 17.523 2 12S6.477 2 12 2s10 4.477 10 10s-4.477 10-10 10Zm-3.568-5.632c1.44 0 2.824-.872 3.96-2.352c-1.608-.776-2.944-1.16-4.44-1.16c-1.304 0-1.984.8-2.104 1.416c-.12.616.248 2.096 2.584 2.096Z'/%3E%3C/svg%3E");-webkit-mask:var(--un-icon) no-repeat;mask:var(--un-icon) no-repeat;-webkit-mask-size:100% 100%;mask-size:100% 100%;background-color:currentColor;color:inherit;width:1.2em;height:1.2em}[i-ri-archive-line=""]{--un-icon:url("data:image/svg+xml;utf8,%3Csvg viewBox='0 0 24 24' width='1.2em' height='1.2em' xmlns='http://www.w3.org/2000/svg' %3E%3Cpath fill='currentColor' d='M3 10H2V4.003C2 3.449 2.455 3 2.992 3h18.016A.99.99 0 0 1 22 4.003V10h-1v10.002a.996.996 0 0 1-.993.998H3.993A.996.996 0 0 1 3 20.002V10Zm16 0H5v9h14v-9ZM4 5v3h16V5H4Zm5 7h6v2H9v-2Z'/%3E%3C/svg%3E");-webkit-mask:var(--un-icon) no-repeat;mask:var(--un-icon) no-repeat;-webkit-mask-size:100% 100%;mask-size:100% 100%;background-color:currentColor;color:inherit;width:1.2em;height:1.2em}[i-ri-arrow-left-s-line=""]{--un-icon:url("data:image/svg+xml;utf8,%3Csvg viewBox='0 0 24 24' width='1.2em' height='1.2em' xmlns='http://www.w3.org/2000/svg' %3E%3Cpath fill='currentColor' d='m10.828 12l4.95 4.95l-1.414 1.415L8 12l6.364-6.364l1.414 1.414l-4.95 4.95Z'/%3E%3C/svg%3E");-webkit-mask:var(--un-icon) no-repeat;mask:var(--un-icon) no-repeat;-webkit-mask-size:100% 100%;mask-size:100% 100%;background-color:currentColor;color:inherit;width:1.2em;height:1.2em}[i-ri-arrow-right-s-line=""]{--un-icon:url("data:image/svg+xml;utf8,%3Csvg viewBox='0 0 24 24' width='1.2em' height='1.2em' xmlns='http://www.w3.org/2000/svg' %3E%3Cpath fill='currentColor' d='m13.171 12l-4.95-4.95l1.415-1.413L16 12l-6.364 6.364l-1.414-1.415l4.95-4.95Z'/%3E%3C/svg%3E");-webkit-mask:var(--un-icon) no-repeat;mask:var(--un-icon) no-repeat;-webkit-mask-size:100% 100%;mask-size:100% 100%;background-color:currentColor;color:inherit;width:1.2em;height:1.2em}[i-ri-arrow-up-s-line=""]{--un-icon:url("data:image/svg+xml;utf8,%3Csvg viewBox='0 0 24 24' width='1.2em' height='1.2em' xmlns='http://www.w3.org/2000/svg' %3E%3Cpath fill='currentColor' d='m12 10.828l-4.95 4.95l-1.414-1.414L12 8l6.364 6.364l-1.415 1.414l-4.95-4.95Z'/%3E%3C/svg%3E");-webkit-mask:var(--un-icon) no-repeat;mask:var(--un-icon) no-repeat;-webkit-mask-size:100% 100%;mask-size:100% 100%;background-color:currentColor;color:inherit;width:1.2em;height:1.2em}.i-ri-bilibili-line{--un-icon:url("data:image/svg+xml;utf8,%3Csvg viewBox='0 0 24 24' width='1.2em' height='1.2em' xmlns='http://www.w3.org/2000/svg' %3E%3Cpath fill='currentColor' d='M7.172 2.757L10.414 6h3.171l3.243-3.242a1 1 0 1 1 1.415 1.414L16.414 6H18.5A3.5 3.5 0 0 1 22 9.5v8a3.5 3.5 0 0 1-3.5 3.5h-13A3.5 3.5 0 0 1 2 17.5v-8A3.5 3.5 0 0 1 5.5 6h2.085L5.757 4.171a1 1 0 0 1 1.415-1.414ZM18.5 8h-13a1.5 1.5 0 0 0-1.493 1.355L4 9.5v8a1.5 1.5 0 0 0 1.356 1.493L5.5 19h13a1.5 1.5 0 0 0 1.493-1.356L20 17.5v-8A1.5 1.5 0 0 0 18.5 8ZM8 11a1 1 0 0 1 1 1v2a1 1 0 1 1-2 0v-2a1 1 0 0 1 1-1Zm8 0a1 1 0 0 1 1 1v2a1 1 0 1 1-2 0v-2a1 1 0 0 1 1-1Z'/%3E%3C/svg%3E");-webkit-mask:var(--un-icon) no-repeat;mask:var(--un-icon) no-repeat;-webkit-mask-size:100% 100%;mask-size:100% 100%;background-color:currentColor;color:inherit;width:1.2em;height:1.2em}[i-ri-calendar-2-line=""]{--un-icon:url("data:image/svg+xml;utf8,%3Csvg viewBox='0 0 24 24' width='1.2em' height='1.2em' xmlns='http://www.w3.org/2000/svg' %3E%3Cpath fill='currentColor' d='M9 1v2h6V1h2v2h4a1 1 0 0 1 1 1v16a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V4a1 1 0 0 1 1-1h4V1h2Zm11 10H4v8h16v-8ZM8 13v2H6v-2h2Zm5 0v2h-2v-2h2Zm5 0v2h-2v-2h2ZM7 5H4v4h16V5h-3v2h-2V5H9v2H7V5Z'/%3E%3C/svg%3E");-webkit-mask:var(--un-icon) no-repeat;mask:var(--un-icon) no-repeat;-webkit-mask-size:100% 100%;mask-size:100% 100%;background-color:currentColor;color:inherit;width:1.2em;height:1.2em}[i-ri-calendar-line=""]{--un-icon:url("data:image/svg+xml;utf8,%3Csvg viewBox='0 0 24 24' width='1.2em' height='1.2em' xmlns='http://www.w3.org/2000/svg' %3E%3Cpath fill='currentColor' d='M9 1v2h6V1h2v2h4a1 1 0 0 1 1 1v16a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V4a1 1 0 0 1 1-1h4V1h2Zm11 10H4v8h16v-8ZM7 5H4v4h16V5h-3v2h-2V5H9v2H7V5Z'/%3E%3C/svg%3E");-webkit-mask:var(--un-icon) no-repeat;mask:var(--un-icon) no-repeat;-webkit-mask-size:100% 100%;mask-size:100% 100%;background-color:currentColor;color:inherit;width:1.2em;height:1.2em}[i-ri-chat-4-line=""]{--un-icon:url("data:image/svg+xml;utf8,%3Csvg viewBox='0 0 24 24' width='1.2em' height='1.2em' xmlns='http://www.w3.org/2000/svg' %3E%3Cpath fill='currentColor' d='M5.763 17H20V5H4v13.385L5.763 17Zm.692 2L2 22.5V4a1 1 0 0 1 1-1h18a1 1 0 0 1 1 1v14a1 1 0 0 1-1 1H6.455Z'/%3E%3C/svg%3E");-webkit-mask:var(--un-icon) no-repeat;mask:var(--un-icon) no-repeat;-webkit-mask-size:100% 100%;mask-size:100% 100%;background-color:currentColor;color:inherit;width:1.2em;height:1.2em}.i-ri-clipboard-line{--un-icon:url("data:image/svg+xml;utf8,%3Csvg viewBox='0 0 24 24' width='1.2em' height='1.2em' xmlns='http://www.w3.org/2000/svg' %3E%3Cpath fill='currentColor' d='M7 4V2h10v2h3.007c.548 0 .993.445.993.993v16.014a.994.994 0 0 1-.993.993H3.993A.993.993 0 0 1 3 21.007V4.993C3 4.445 3.445 4 3.993 4H7Zm0 2H5v14h14V6h-2v2H7V6Zm2-2v2h6V4H9Z'/%3E%3C/svg%3E");-webkit-mask:var(--un-icon) no-repeat;mask:var(--un-icon) no-repeat;-webkit-mask-size:100% 100%;mask-size:100% 100%;background-color:currentColor;color:inherit;width:1.2em;height:1.2em}[i-ri-eye-line=""]{--un-icon:url("data:image/svg+xml;utf8,%3Csvg viewBox='0 0 24 24' width='1.2em' height='1.2em' xmlns='http://www.w3.org/2000/svg' %3E%3Cpath fill='currentColor' d='M12 3c5.392 0 9.878 3.88 10.819 9c-.94 5.12-5.427 9-10.819 9c-5.392 0-9.878-3.88-10.818-9C2.122 6.88 6.608 3 12 3Zm0 16a9.005 9.005 0 0 0 8.778-7a9.005 9.005 0 0 0-17.555 0A9.005 9.005 0 0 0 12 19Zm0-2.5a4.5 4.5 0 1 1 0-9a4.5 4.5 0 0 1 0 9Zm0-2a2.5 2.5 0 1 0 0-5a2.5 2.5 0 0 0 0 5Z'/%3E%3C/svg%3E");-webkit-mask:var(--un-icon) no-repeat;mask:var(--un-icon) no-repeat;-webkit-mask-size:100% 100%;mask-size:100% 100%;background-color:currentColor;color:inherit;width:1.2em;height:1.2em}[i-ri-file-list-line=""]{--un-icon:url("data:image/svg+xml;utf8,%3Csvg viewBox='0 0 24 24' width='1.2em' height='1.2em' xmlns='http://www.w3.org/2000/svg' %3E%3Cpath fill='currentColor' d='M20 22H4a1 1 0 0 1-1-1V3a1 1 0 0 1 1-1h16a1 1 0 0 1 1 1v18a1 1 0 0 1-1 1Zm-1-2V4H5v16h14ZM8 7h8v2H8V7Zm0 4h8v2H8v-2Zm0 4h8v2H8v-2Z'/%3E%3C/svg%3E");-webkit-mask:var(--un-icon) no-repeat;mask:var(--un-icon) no-repeat;-webkit-mask-size:100% 100%;mask-size:100% 100%;background-color:currentColor;color:inherit;width:1.2em;height:1.2em}[i-ri-file-word-line=""]{--un-icon:url("data:image/svg+xml;utf8,%3Csvg viewBox='0 0 24 24' width='1.2em' height='1.2em' xmlns='http://www.w3.org/2000/svg' %3E%3Cpath fill='currentColor' d='M16 8v8h-2l-2-2l-2 2H8V8h2v5l2-2l2 2V8h1V4H5v16h14V8h-3ZM3 2.992C3 2.444 3.447 2 3.998 2H16l5 5v13.992A1 1 0 0 1 20.007 22H3.993A1 1 0 0 1 3 21.008V2.992Z'/%3E%3C/svg%3E");-webkit-mask:var(--un-icon) no-repeat;mask:var(--un-icon) no-repeat;-webkit-mask-size:100% 100%;mask-size:100% 100%;background-color:currentColor;color:inherit;width:1.2em;height:1.2em}[i-ri-folder-2-line=""]{--un-icon:url("data:image/svg+xml;utf8,%3Csvg viewBox='0 0 24 24' width='1.2em' height='1.2em' xmlns='http://www.w3.org/2000/svg' %3E%3Cpath fill='currentColor' d='M12.414 5H21a1 1 0 0 1 1 1v14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V4a1 1 0 0 1 1-1h7.414l2 2ZM20 11H4v8h16v-8Zm0-2V7h-8.414l-2-2H4v4h16Z'/%3E%3C/svg%3E");-webkit-mask:var(--un-icon) no-repeat;mask:var(--un-icon) no-repeat;-webkit-mask-size:100% 100%;mask-size:100% 100%;background-color:currentColor;color:inherit;width:1.2em;height:1.2em}.i-ri-gallery-line{--un-icon:url("data:image/svg+xml;utf8,%3Csvg viewBox='0 0 24 24' width='1.2em' height='1.2em' xmlns='http://www.w3.org/2000/svg' %3E%3Cpath fill='currentColor' d='M20 13c-1.678 0-3.249.46-4.593 1.259A14.984 14.984 0 0 1 18.147 19H20v-6Zm-3.996 6C14.044 14.302 9.408 11 4 11v8h12.004ZM4 9c3.83 0 7.323 1.435 9.974 3.796A10.949 10.949 0 0 1 20 11V3h1.008c.548 0 .992.445.992.993v16.014a1 1 0 0 1-.992.993H2.992A.993.993 0 0 1 2 20.007V3.993A1 1 0 0 1 2.992 3H6V1h2v4H4v4Zm14-8v4h-8V3h6V1h2Zm-1.5 9a1.5 1.5 0 1 1 0-3a1.5 1.5 0 0 1 0 3Z'/%3E%3C/svg%3E");-webkit-mask:var(--un-icon) no-repeat;mask:var(--un-icon) no-repeat;-webkit-mask-size:100% 100%;mask-size:100% 100%;background-color:currentColor;color:inherit;width:1.2em;height:1.2em}.i-ri-github-line{--un-icon:url("data:image/svg+xml;utf8,%3Csvg viewBox='0 0 24 24' width='1.2em' height='1.2em' xmlns='http://www.w3.org/2000/svg' %3E%3Cpath fill='currentColor' d='M5.884 18.653c-.3-.2-.558-.456-.86-.816a50.59 50.59 0 0 1-.466-.579c-.463-.575-.755-.841-1.056-.95a1 1 0 1 1 .675-1.882c.752.27 1.261.735 1.947 1.588c-.094-.117.34.427.433.539c.19.227.33.365.44.438c.204.137.588.196 1.15.14c.024-.382.094-.753.202-1.096c-2.968-.725-4.648-2.64-4.648-6.396c0-1.238.37-2.355 1.058-3.291c-.218-.894-.185-1.975.302-3.192a1 1 0 0 1 .63-.583c.081-.024.127-.034.208-.047c.803-.123 1.937.17 3.415 1.097a11.731 11.731 0 0 1 2.687-.308c.912 0 1.819.103 2.684.308c1.477-.933 2.614-1.227 3.422-1.097c.085.014.158.032.218.051a1 1 0 0 1 .616.58c.487 1.215.52 2.296.302 3.19c.691.936 1.058 2.045 1.058 3.292c0 3.758-1.674 5.666-4.642 6.393c.125.415.19.878.19 1.38c0 .664-.002 1.299-.007 2.01c0 .19-.002.394-.005.706a1 1 0 0 1-.018 1.957c-1.14.228-1.984-.532-1.984-1.524l.002-.447l.005-.705c.005-.707.008-1.338.008-1.997c0-.697-.184-1.152-.426-1.361c-.661-.57-.326-1.654.541-1.751c2.966-.334 4.336-1.483 4.336-4.66c0-.955-.312-1.745-.913-2.405a1 1 0 0 1-.189-1.044c.166-.415.236-.957.095-1.614l-.01.002c-.491.14-1.11.44-1.858.95a1 1 0 0 1-.833.135a9.626 9.626 0 0 0-2.592-.35c-.89 0-1.772.12-2.592.35a1 1 0 0 1-.829-.133c-.753-.507-1.374-.807-1.87-.947c-.143.653-.072 1.194.093 1.607a1 1 0 0 1-.189 1.044c-.597.656-.913 1.459-.913 2.404c0 3.172 1.371 4.33 4.322 4.66c.865.098 1.202 1.178.545 1.749c-.193.167-.43.732-.43 1.364v3.149c0 .986-.834 1.726-1.96 1.529a1 1 0 0 1-.04-1.963v-.99c-.91.062-1.661-.087-2.254-.484Z'/%3E%3C/svg%3E");-webkit-mask:var(--un-icon) no-repeat;mask:var(--un-icon) no-repeat;-webkit-mask-size:100% 100%;mask-size:100% 100%;background-color:currentColor;color:inherit;width:1.2em;height:1.2em}.i-ri-heart-line,[i-ri-heart-line=""]{--un-icon:url("data:image/svg+xml;utf8,%3Csvg viewBox='0 0 24 24' width='1.2em' height='1.2em' xmlns='http://www.w3.org/2000/svg' %3E%3Cpath fill='currentColor' d='M12.001 4.529a5.998 5.998 0 0 1 8.242.228a6 6 0 0 1 .236 8.236l-8.48 8.492l-8.478-8.492a6 6 0 0 1 8.48-8.464Zm6.826 1.641a3.998 3.998 0 0 0-5.49-.153l-1.335 1.198l-1.336-1.197a4 4 0 0 0-5.686 5.605L12 18.654l7.02-7.03a4 4 0 0 0-.193-5.454Z'/%3E%3C/svg%3E");-webkit-mask:var(--un-icon) no-repeat;mask:var(--un-icon) no-repeat;-webkit-mask-size:100% 100%;mask-size:100% 100%;background-color:currentColor;color:inherit;width:1.2em;height:1.2em}[i-ri-home-4-line=""]{--un-icon:url("data:image/svg+xml;utf8,%3Csvg viewBox='0 0 24 24' width='1.2em' height='1.2em' xmlns='http://www.w3.org/2000/svg' %3E%3Cpath fill='currentColor' d='M19 21H5a1 1 0 0 1-1-1v-9H1l10.327-9.388a1 1 0 0 1 1.346 0L23 11h-3v9a1 1 0 0 1-1 1Zm-6-2h5V9.158l-6-5.455l-6 5.455V19h5v-6h2v6Z'/%3E%3C/svg%3E");-webkit-mask:var(--un-icon) no-repeat;mask:var(--un-icon) no-repeat;-webkit-mask-size:100% 100%;mask-size:100% 100%;background-color:currentColor;color:inherit;width:1.2em;height:1.2em}.i-ri-keynote-line{--un-icon:url("data:image/svg+xml;utf8,%3Csvg viewBox='0 0 24 24' width='1.2em' height='1.2em' xmlns='http://www.w3.org/2000/svg' %3E%3Cpath fill='currentColor' d='M4.44 10h15.12l-1.2-6H5.64l-1.2 6ZM13 12v8h4v2H7v-2h4v-8H2.992c-.548 0-.906-.43-.797-.977l1.61-8.046C3.913 2.437 4.445 2 5 2h13.998c.553 0 1.087.43 1.197.977l1.609 8.046c.108.54-.26.977-.797.977H13Z'/%3E%3C/svg%3E");-webkit-mask:var(--un-icon) no-repeat;mask:var(--un-icon) no-repeat;-webkit-mask-size:100% 100%;mask-size:100% 100%;background-color:currentColor;color:inherit;width:1.2em;height:1.2em}.i-ri-mail-line{--un-icon:url("data:image/svg+xml;utf8,%3Csvg viewBox='0 0 24 24' width='1.2em' height='1.2em' xmlns='http://www.w3.org/2000/svg' %3E%3Cpath fill='currentColor' d='M3 3h18a1 1 0 0 1 1 1v16a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V4a1 1 0 0 1 1-1Zm17 4.238l-7.928 7.1L4 7.216V19h16V7.238ZM4.511 5l7.55 6.662L19.502 5H4.511Z'/%3E%3C/svg%3E");-webkit-mask:var(--un-icon) no-repeat;mask:var(--un-icon) no-repeat;-webkit-mask-size:100% 100%;mask-size:100% 100%;background-color:currentColor;color:inherit;width:1.2em;height:1.2em}.i-ri-netease-cloud-music-line{--un-icon:url("data:image/svg+xml;utf8,%3Csvg viewBox='0 0 24 24' width='1.2em' height='1.2em' xmlns='http://www.w3.org/2000/svg' %3E%3Cpath fill='currentColor' d='M10.422 11.375c-.294 1.028.012 2.065.784 2.653c1.061.81 2.565.3 2.874-.995c.08-.337.103-.722.027-1.056c-.23-1.001-.521-1.988-.792-2.996c-1.33.154-2.543 1.172-2.893 2.394Zm5.548-.287c.273 1.012.285 2.017-.127 3c-1.128 2.69-4.722 3.14-6.573.826c-1.302-1.627-1.28-3.961.06-5.734c.78-1.032 1.804-1.707 3.048-2.054l.379-.104c-.084-.415-.188-.816-.243-1.224c-.176-1.317.512-2.503 1.744-3.04c1.226-.535 2.708-.216 3.53.76c.406.479.395 1.08-.025 1.464c-.412.377-.997.346-1.435-.09c-.247-.246-.51-.44-.877-.436c-.525.006-.987.418-.945.937c.037.468.172.93.3 1.386c.022.078.216.135.338.153c1.333.197 2.504.731 3.472 1.676c2.558 2.493 2.861 6.531.672 9.44c-1.529 2.032-3.61 3.169-6.127 3.409c-4.621.44-8.664-2.53-9.7-7.058C2.516 10.255 4.84 5.831 8.796 4.25c.586-.234 1.143-.031 1.371.498c.232.537-.019 1.086-.61 1.35c-2.368 1.06-3.817 2.855-4.215 5.423c-.533 3.434 1.656 6.777 5 7.722c2.723.769 5.658-.167 7.308-2.33c1.586-2.08 1.4-5.1-.427-6.874A3.978 3.978 0 0 0 15.4 9.026c.198.716.389 1.388.57 2.062Z'/%3E%3C/svg%3E");-webkit-mask:var(--un-icon) no-repeat;mask:var(--un-icon) no-repeat;-webkit-mask-size:100% 100%;mask-size:100% 100%;background-color:currentColor;color:inherit;width:1.2em;height:1.2em}.i-ri-open-arm-line{--un-icon:url("data:image/svg+xml;utf8,%3Csvg viewBox='0 0 24 24' width='1.2em' height='1.2em' xmlns='http://www.w3.org/2000/svg' %3E%3Cpath fill='currentColor' d='M18.001 17v5h-2v-5c0-4.451 2.644-8.285 6.447-10.016l.828 1.82A9.002 9.002 0 0 0 18.001 17Zm-10 0v5h-2v-5A9.002 9.002 0 0 0 .727 8.805l.827-1.821A11.002 11.002 0 0 1 8.001 17Zm4-5a5 5 0 1 1 0-10a5 5 0 0 1 0 10Zm0-2a3 3 0 1 0 0-6a3 3 0 0 0 0 6Z'/%3E%3C/svg%3E");-webkit-mask:var(--un-icon) no-repeat;mask:var(--un-icon) no-repeat;-webkit-mask-size:100% 100%;mask-size:100% 100%;background-color:currentColor;color:inherit;width:1.2em;height:1.2em}[i-ri-price-tag-3-line=""]{--un-icon:url("data:image/svg+xml;utf8,%3Csvg viewBox='0 0 24 24' width='1.2em' height='1.2em' xmlns='http://www.w3.org/2000/svg' %3E%3Cpath fill='currentColor' d='m10.904 2.1l9.9 1.414l1.414 9.9l-9.193 9.192a1 1 0 0 1-1.414 0l-9.9-9.9a1 1 0 0 1 0-1.413L10.905 2.1Zm.707 2.121L3.833 12l8.485 8.485l7.779-7.778l-1.061-7.425l-7.425-1.06Zm2.122 6.364a2 2 0 1 1 2.828-2.828a2 2 0 0 1-2.828 2.828Z'/%3E%3C/svg%3E");-webkit-mask:var(--un-icon) no-repeat;mask:var(--un-icon) no-repeat;-webkit-mask-size:100% 100%;mask-size:100% 100%;background-color:currentColor;color:inherit;width:1.2em;height:1.2em}[i-ri-pushpin-line=""]{--un-icon:url("data:image/svg+xml;utf8,%3Csvg viewBox='0 0 24 24' width='1.2em' height='1.2em' xmlns='http://www.w3.org/2000/svg' %3E%3Cpath fill='currentColor' d='m13.827 1.69l8.486 8.485l-1.415 1.414l-.707-.707l-4.242 4.243l-.707 3.535l-1.415 1.415l-4.242-4.243l-4.95 4.95l-1.414-1.414l4.95-4.95l-4.243-4.243l1.414-1.414l3.536-.707L13.12 3.81l-.707-.707l1.414-1.414Zm.707 3.535l-4.67 4.671l-2.822.565l6.5 6.5l.564-2.822l4.671-4.67l-4.243-4.244Z'/%3E%3C/svg%3E");-webkit-mask:var(--un-icon) no-repeat;mask:var(--un-icon) no-repeat;-webkit-mask-size:100% 100%;mask-size:100% 100%;background-color:currentColor;color:inherit;width:1.2em;height:1.2em}.i-ri-rss-line{--un-icon:url("data:image/svg+xml;utf8,%3Csvg viewBox='0 0 24 24' width='1.2em' height='1.2em' xmlns='http://www.w3.org/2000/svg' %3E%3Cpath fill='currentColor' d='M3 17a4 4 0 0 1 4 4H3v-4Zm0-7c6.075 0 11 4.925 11 11h-2a9 9 0 0 0-9-9v-2Zm0-7c9.941 0 18 8.059 18 18h-2c0-8.837-7.163-16-16-16V3Z'/%3E%3C/svg%3E");-webkit-mask:var(--un-icon) no-repeat;mask:var(--un-icon) no-repeat;-webkit-mask-size:100% 100%;mask-size:100% 100%;background-color:currentColor;color:inherit;width:1.2em;height:1.2em}[i-ri-search-line=""]{--un-icon:url("data:image/svg+xml;utf8,%3Csvg viewBox='0 0 24 24' width='1.2em' height='1.2em' xmlns='http://www.w3.org/2000/svg' %3E%3Cpath fill='currentColor' d='m18.031 16.617l4.283 4.282l-1.415 1.415l-4.282-4.283A8.96 8.96 0 0 1 11 20c-4.968 0-9-4.032-9-9s4.032-9 9-9s9 4.032 9 9a8.96 8.96 0 0 1-1.969 5.617Zm-2.006-.742A6.977 6.977 0 0 0 18 11c0-3.867-3.133-7-7-7s-7 3.133-7 7s3.133 7 7 7a6.977 6.977 0 0 0 4.875-1.975l.15-.15Z'/%3E%3C/svg%3E");-webkit-mask:var(--un-icon) no-repeat;mask:var(--un-icon) no-repeat;-webkit-mask-size:100% 100%;mask-size:100% 100%;background-color:currentColor;color:inherit;width:1.2em;height:1.2em}.i-ri-telegram-line{--un-icon:url("data:image/svg+xml;utf8,%3Csvg viewBox='0 0 24 24' width='1.2em' height='1.2em' xmlns='http://www.w3.org/2000/svg' %3E%3Cpath fill='currentColor' d='M12.001 20a8 8 0 1 0 0-16a8 8 0 0 0 0 16Zm0 2c-5.523 0-10-4.477-10-10s4.477-10 10-10s10 4.477 10 10s-4.477 10-10 10Zm-3.11-8.83l-2.498-.779c-.54-.165-.543-.537.121-.804l9.733-3.76c.564-.23.886.061.703.79l-1.658 7.82c-.116.557-.451.69-.916.433l-2.551-1.888l-1.189 1.148c-.122.118-.221.219-.409.244c-.187.026-.341-.03-.454-.34l-.87-2.871l-.012.008Z'/%3E%3C/svg%3E");-webkit-mask:var(--un-icon) no-repeat;mask:var(--un-icon) no-repeat;-webkit-mask-size:100% 100%;mask-size:100% 100%;background-color:currentColor;color:inherit;width:1.2em;height:1.2em}[i-ri-timer-line=""]{--un-icon:url("data:image/svg+xml;utf8,%3Csvg viewBox='0 0 24 24' width='1.2em' height='1.2em' xmlns='http://www.w3.org/2000/svg' %3E%3Cpath fill='currentColor' d='m17.618 5.968l1.453-1.453l1.414 1.414l-1.453 1.453A9 9 0 1 1 12 4c2.125 0 4.078.736 5.618 1.968ZM12 20a7 7 0 1 0 0-14a7 7 0 0 0 0 14ZM11 8h2v6h-2V8ZM8 1h8v2H8V1Z'/%3E%3C/svg%3E");-webkit-mask:var(--un-icon) no-repeat;mask:var(--un-icon) no-repeat;-webkit-mask-size:100% 100%;mask-size:100% 100%;background-color:currentColor;color:inherit;width:1.2em;height:1.2em}.i-ri-train-line{--un-icon:url("data:image/svg+xml;utf8,%3Csvg viewBox='0 0 24 24' width='1.2em' height='1.2em' xmlns='http://www.w3.org/2000/svg' %3E%3Cpath fill='currentColor' d='m17.2 20l1.8 1.5v.5H5v-.5L6.8 20H5a2 2 0 0 1-2-2V7a4 4 0 0 1 4-4h10a4 4 0 0 1 4 4v11a2 2 0 0 1-2 2h-1.8ZM7 5a2 2 0 0 0-2 2v11h14V7a2 2 0 0 0-2-2H7Zm5 12a2 2 0 1 1 0-4a2 2 0 0 1 0 4ZM6 7h12v4H6V7Z'/%3E%3C/svg%3E");-webkit-mask:var(--un-icon) no-repeat;mask:var(--un-icon) no-repeat;-webkit-mask-size:100% 100%;mask-size:100% 100%;background-color:currentColor;color:inherit;width:1.2em;height:1.2em}[i-ri-translate=""]{--un-icon:url("data:image/svg+xml;utf8,%3Csvg viewBox='0 0 24 24' width='1.2em' height='1.2em' xmlns='http://www.w3.org/2000/svg' %3E%3Cpath fill='currentColor' d='M5 15v2a2 2 0 0 0 1.85 1.994L7 19h3v2H7a4 4 0 0 1-4-4v-2h2Zm13-5l4.4 11h-2.155l-1.201-3h-4.09l-1.199 3h-2.154L16 10h2Zm-1 2.885L15.753 16h2.492L17 12.885ZM8 2v2h4v7H8v3H6v-3H2V4h4V2h2Zm9 1a4 4 0 0 1 4 4v2h-2V7a2 2 0 0 0-2-2h-3V3h3ZM6 6H4v3h2V6Zm4 0H8v3h2V6Z'/%3E%3C/svg%3E");-webkit-mask:var(--un-icon) no-repeat;mask:var(--un-icon) no-repeat;-webkit-mask-size:100% 100%;mask-size:100% 100%;background-color:currentColor;color:inherit;width:1.2em;height:1.2em}.i-ri-wechat-pay-line{--un-icon:url("data:image/svg+xml;utf8,%3Csvg viewBox='0 0 24 24' width='1.2em' height='1.2em' xmlns='http://www.w3.org/2000/svg' %3E%3Cpath fill='currentColor' d='m19.146 8.993l-9.799 5.608l-.07.046a.647.647 0 0 1-.3.069a.655.655 0 0 1-.58-.345l-.046-.092l-1.831-3.95c-.023-.046-.023-.092-.023-.138c0-.183.139-.321.324-.321c.07 0 .139.023.209.069l2.155 1.515c.162.092.347.161.556.161a.938.938 0 0 0 .348-.069l8.274-3.648C16.935 6.273 14.635 5.2 12.001 5.2c-4.421 0-7.9 3.023-7.9 6.6c0 1.366.5 2.673 1.431 3.781c.049.058.12.137.215.235a4 4 0 0 1 1.1 3.102l-.024.298l.715-.437a4 4 0 0 1 2.706-.536c.211.033.385.059.52.077c.406.053.819.08 1.237.08c4.42 0 7.9-3.022 7.9-6.6c0-.996-.27-1.95-.755-2.807ZM6.193 21.943a1 1 0 0 1-1.527-.931l.189-2.26a2 2 0 0 0-.55-1.551a6.935 6.935 0 0 1-.303-.332C2.806 15.447 2.1 13.695 2.1 11.8c0-4.75 4.432-8.6 9.9-8.6c5.467 0 9.9 3.85 9.9 8.6s-4.433 8.6-9.9 8.6c-.51 0-1.01-.033-1.5-.098c-.152-.02-.342-.048-.568-.084a2 2 0 0 0-1.353.269l-2.387 1.456Z'/%3E%3C/svg%3E");-webkit-mask:var(--un-icon) no-repeat;mask:var(--un-icon) no-repeat;-webkit-mask-size:100% 100%;mask-size:100% 100%;background-color:currentColor;color:inherit;width:1.2em;height:1.2em}[i~=ri-sun-line]{--un-icon:url("data:image/svg+xml;utf8,%3Csvg viewBox='0 0 24 24' width='1.2em' height='1.2em' xmlns='http://www.w3.org/2000/svg' %3E%3Cpath fill='currentColor' d='M12 18a6 6 0 1 1 0-12a6 6 0 0 1 0 12Zm0-2a4 4 0 1 0 0-8a4 4 0 0 0 0 8ZM11 1h2v3h-2V1Zm0 19h2v3h-2v-3ZM3.515 4.929l1.414-1.414L7.05 5.636L5.636 7.05L3.515 4.93ZM16.95 18.364l1.414-1.414l2.121 2.121l-1.414 1.414l-2.121-2.121Zm2.121-14.85l1.414 1.415l-2.121 2.121l-1.414-1.414l2.121-2.121ZM5.636 16.95l1.414 1.414l-2.121 2.121l-1.414-1.414l2.121-2.121ZM23 11v2h-3v-2h3ZM4 11v2H1v-2h3Z'/%3E%3C/svg%3E");-webkit-mask:var(--un-icon) no-repeat;mask:var(--un-icon) no-repeat;-webkit-mask-size:100% 100%;mask-size:100% 100%;background-color:currentColor;color:inherit;width:1.2em;height:1.2em}.yun-card{margin:auto;--un-shadow:var(--un-shadow-inset) 0 1px 3px 0 var(--un-shadow-color, rgba(0,0,0,.1)),var(--un-shadow-inset) 0 1px 2px -1px var(--un-shadow-color, rgba(0,0,0,.1));box-shadow:var(--un-ring-offset-shadow),var(--un-ring-shadow),var(--un-shadow);transition-property:color,background-color,border-color,outline-color,text-decoration-color,fill,stroke,opacity,box-shadow,transform,filter,backdrop-filter;transition-timing-function:cubic-bezier(.4,0,.2,1);transition-duration:.15s;transition-duration:var(--va-transition-duration)}.flex-center{display:flex;align-items:center;justify-content:center}.inline-flex-center{display:inline-flex;align-items:center;justify-content:center}.va-card{background-color:var(--va-c-bg-light);--un-shadow:var(--un-shadow-inset) 0 1px 3px 0 var(--un-shadow-color, rgba(0,0,0,.1)),var(--un-shadow-inset) 0 1px 2px -1px var(--un-shadow-color, rgba(0,0,0,.1));box-shadow:var(--un-ring-offset-shadow),var(--un-ring-shadow),var(--un-shadow)}.va-card:hover,.yun-card:hover{--un-shadow:var(--un-shadow-inset) 0 10px 15px -3px var(--un-shadow-color, rgba(0,0,0,.1)),var(--un-shadow-inset) 0 4px 6px -4px var(--un-shadow-color, rgba(0,0,0,.1));box-shadow:var(--un-ring-offset-shadow),var(--un-ring-shadow),var(--un-shadow)}@media (max-width:767.9px){.yun-main{padding-left:0}}.fixed{position:fixed}.relative{position:relative}.inset-y-0{top:0;bottom:0}.left-0{left:0}.left-0\.8rem{left:.8rem}.top-0\.6rem{top:.6rem}[bottom~="19"]{bottom:4.75rem}[right~="2"]{right:.5rem}.z-1{z-index:1}.z-350{z-index:350}[z~="$yun-z-menu-btn"]{z-index:var(--yun-z-menu-btn)}[z~="$yun-z-sidebar"]{z-index:var(--yun-z-sidebar)}[m~="0"]{margin:0}[m~="2"]{margin:.5rem}[m~=y-4]{margin-top:1rem;margin-bottom:1rem}[my~="1"]{margin-top:.25rem;margin-bottom:.25rem}[m~=x-1]{margin-left:.25rem;margin-right:.25rem}[mx~="2"],[m~=x-2]{margin-left:.5rem;margin-right:.5rem}[m~=y-2]{margin-top:.5rem;margin-bottom:.5rem}[mb~="4"],[m~=b-4]{margin-bottom:1rem}.mb-2,[m~=b-2]{margin-bottom:.5rem}[ml-1=""],[m~=l-1]{margin-left:.25rem}[m~=t-4]{margin-top:1rem}[mt-6=""],[m~=t-6]{margin-top:1.5rem}[m~=l-4]{margin-left:1rem}[m~=r-1]{margin-right:.25rem}[m~=t-0]{margin-top:0}[m~=t-16]{margin-top:4rem}[mt~="2"]{margin-top:.5rem}.block{display:block}.inline-block{display:inline-block}.h-8,[h~="8"]{height:2rem}[h~="5"]{height:1.25rem}.w-8,[w~="8"]{width:2rem}[w~=full]{width:100%}[h~="64"]{height:16rem}[min-h~="100px"]{min-height:100px}.flex,[flex~="~"]{display:flex}.inline-flex,[inline-flex=""]{display:inline-flex}.flex-grow,[flex~=grow]{flex-grow:1}.flex-col,[flex~=col]{flex-direction:column}.transform{transform:translate(var(--un-translate-x)) translateY(var(--un-translate-y)) translateZ(var(--un-translate-z)) rotate(var(--un-rotate)) rotateX(var(--un-rotate-x)) rotateY(var(--un-rotate-y)) rotate(var(--un-rotate-z)) skew(var(--un-skew-x)) skewY(var(--un-skew-y)) scaleX(var(--un-scale-x)) scaleY(var(--un-scale-y)) scaleZ(var(--un-scale-z))}@keyframes fade-in{0%{opacity:0}to{opacity:1}}@keyframes pulse{0%,to{opacity:1}50%{opacity:.5}}.animate-fade-in{animation:fade-in 1s linear 1}.animate-pulse{animation:pulse 2s cubic-bezier(.4,0,.6,1) infinite}.animate-iteration-1{animation-iteration-count:1}[cursor~=pointer]{cursor:pointer}.select-none{-webkit-user-select:none;user-select:none}.items-center,[items~=center]{align-items:center}.justify-center,[justify~=center]{justify-content:center}.justify-around{justify-content:space-around}.gap-2{gap:.5rem}[overflow~=auto]{overflow:auto}.overflow-y-auto{overflow-y:auto}.truncate{overflow:hidden;text-overflow:ellipsis;white-space:nowrap}[border~="~"]{border-width:1px}[border~=rounded]{border-radius:.25rem}.rounded-full{border-radius:9999px}[bg~="$va-c-bg-light"]{background-color:var(--va-c-bg-light)}[bg~="$yun-sidebar-bg-color"]{background-color:var(--yun-sidebar-bg-color)}[bg~=contain]{background-size:contain}[bg~=no-repeat]{background-repeat:no-repeat}[stroke-width~="2"]{stroke-width:2px}.object-cover{object-fit:cover}.p-4,[p~="4"]{padding:1rem}[p~="1"]{padding:.25rem}[p~="2"]{padding:.5rem}[p~=x-4]{padding-left:1rem;padding-right:1rem}[py~="1"]{padding-top:.25rem;padding-bottom:.25rem}[p~=b-8]{padding-bottom:2rem}[p~=l-4]{padding-left:1rem}[text~=center]{text-align:center}[text~="2xl"]{font-size:1.5rem;line-height:2rem}[text-xl=""],[text~=xl]{font-size:1.25rem;line-height:1.75rem}[text~=xs]{font-size:.75rem;line-height:1rem}[text~=sm]{font-size:.875rem;line-height:1.25rem}[font~=black]{font-weight:900}.leading-4{line-height:1rem}.leading-6{line-height:1.5rem}.leading-none{line-height:1}[color~="$va-c-warning"]{color:var(--va-c-warning)}.text-\$va-c-text-light{color:var(--va-c-text-light)}[text~=red-400]{--un-text-opacity:1;color:rgba(248,113,113,var(--un-text-opacity))}.shadow{--un-shadow:var(--un-shadow-inset) 0 1px 3px 0 var(--un-shadow-color, rgba(0,0,0,.1)),var(--un-shadow-inset) 0 1px 2px -1px var(--un-shadow-color, rgba(0,0,0,.1));box-shadow:var(--un-ring-offset-shadow),var(--un-ring-shadow),var(--un-shadow)}.hover\:shadow-md:hover{--un-shadow:var(--un-shadow-inset) 0 4px 6px -1px var(--un-shadow-color, rgba(0,0,0,.1)),var(--un-shadow-inset) 0 2px 4px -2px var(--un-shadow-color, rgba(0,0,0,.1));box-shadow:var(--un-ring-offset-shadow),var(--un-ring-shadow),var(--un-shadow)}.transition{transition-property:color,background-color,border-color,outline-color,text-decoration-color,fill,stroke,opacity,box-shadow,transform,filter,backdrop-filter;transition-timing-function:cubic-bezier(.4,0,.2,1);transition-duration:.15s}[font~=serif]{font-family:var(--va-font-serif)}@media (max-width:767.9px){.lt-md\:ml-0{margin-left:0}[p~="lt-md:0"]{padding:0}}@media (min-width:640px){.sm\:p-6{padding:1.5rem}.sm\:px-6{padding-left:1.5rem;padding-right:1.5rem}}@media (min-width:768px){.md\:hidden{display:none}.md\:translate-x-0{--un-translate-x:0;transform:translate(var(--un-translate-x)) translateY(var(--un-translate-y)) translateZ(var(--un-translate-z)) rotate(var(--un-rotate)) rotateX(var(--un-rotate-x)) rotateY(var(--un-rotate-y)) rotate(var(--un-rotate-z)) skew(var(--un-skew-x)) skewY(var(--un-skew-y)) scaleX(var(--un-scale-x)) scaleY(var(--un-scale-y)) scaleZ(var(--un-scale-z))}}@media (min-width:1024px){.lg\:px-12{padding-left:3rem;padding-right:3rem}}@media (min-width:1280px){.xl\:hidden{display:none}.xl\:px-16{padding-left:4rem;padding-right:4rem}}.va-toc[data-v-22b646a4]{text-align:left}.content[data-v-22b646a4]{position:relative;padding-left:16px;font-size:14px;text-align:left}.outline-marker[data-v-22b646a4]{position:absolute;top:32px;left:-2px;z-index:0;opacity:0;width:4px;height:18px;background-color:var(--va-c-brand);transition:top .25s cubic-bezier(0,1,.5,1),background-color .5s,opacity .25s;border-top-right-radius:2px;border-bottom-right-radius:2px}.outline-title[data-v-22b646a4]{letter-spacing:.4px;line-height:28px;font-size:14px;font-weight:600}.visually-hidden[data-v-22b646a4]{position:absolute;width:1px;height:1px;white-space:nowrap;clip:rect(0 0 0 0);clip-path:inset(50%);overflow:hidden}.yun-aside{position:fixed;right:0;top:0;bottom:0;width:var(--va-sidebar-width,300px);transform:translate(100%);transition:box-shadow var(--va-transition-duration),background-color var(--va-transition-duration),opacity .25s,transform var(--va-transition-duration) cubic-bezier(.19,1,.22,1)}@media screen and (min-width:1280px){.yun-aside{transform:translate(0)}}.toc-btn{color:var(--va-c-primary);background-color:#fff;z-index:var(--yun-z-toc-btn)}.post-nav{display:flex;justify-content:space-between;align-items:center}.post-nav-item{display:inline-flex;justify-content:center;align-items:center;color:var(--va-c-primary);outline:0;font-size:1.5rem;font-weight:700;text-transform:uppercase;height:3rem;transition:.4s}.post-nav-item:hover{background-color:rgba(var(--va-c-primary-rgb),.1);box-shadow:0 0 15px #0000001a}.post-nav-prev{padding:0 .6rem 0 .1rem}.post-nav-next{padding:0 .1rem 0 .6rem}.post-nav-next,.post-nav-prev{display:inline-flex;align-items:center;height:3rem;font-size:1rem}.post-nav-next .title,.post-nav-prev .title{overflow:hidden;max-width:10rem}.post-nav-next .icon,.post-nav-prev .icon{width:1.2rem;height:1.2rem}@media screen and (min-width:1024px){.post-nav-next .title,.post-nav-prev .title{max-width:18rem}}@media screen and (min-width:1280px){.content{max-width:calc(100vw - 2 * var(--va-sidebar-width) - 1rem - 8px)}}.link-item{display:inline-flex}:root{--page-btn-bg-color:rgba(255, 255, 255, .5);--page-btn-hover-bg-color:var(--va-c-primary-lighter);--page-btn-active-bg-color:var(--va-c-primary-light)}.post-top-icon{position:absolute;top:1rem;right:1rem;font-size:1.2rem}@-webkit-keyframes lg-right-end{0%{left:0}50%{left:-30px}to{left:0}}@-webkit-keyframes lg-left-end{0%{left:0}50%{left:30px}to{left:0}}:root{--banner-line-color:black;--banner-char-color:black;--banner-char-bg-color:rgba(255, 255, 255, .5);--banner-char-hover-color:white}.post-copyright{font-size:.9rem;padding:.5rem 1rem;border-left:4px solid #ff5252;background-color:var(--va-c-bg-dark);list-style:none;word-break:break-all;position:relative;overflow:hidden}.post-copyright:after{pointer-events:none;position:absolute;color:#fff;background:url("data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 496 512'%3E%3Cpath fill='gray' d='M245.8 214.9l-33.2 17.3c-9.4-19.6-25.2-20-27.4-20-22.2 0-33.3 14.6-33.3 43.9 0 23.5 9.2 43.8 33.3 43.8 14.4 0 24.6-7 30.5-21.3l30.6 15.5a73.2 73.2 0 01-65.1 39c-22.6 0-74-10.3-74-77 0-58.7 43-77 72.6-77 30.8-.1 52.7 11.9 66 35.8zm143 0l-32.7 17.3c-9.5-19.8-25.7-20-27.9-20-22.1 0-33.2 14.6-33.2 43.9 0 23.5 9.2 43.8 33.2 43.8 14.5 0 24.7-7 30.5-21.3l31 15.5c-2 3.8-21.3 39-65 39-22.7 0-74-9.9-74-77 0-58.7 43-77 72.6-77C354 179 376 191 389 214.8zM247.7 8C104.7 8 0 123 0 256c0 138.4 113.6 248 247.6 248C377.5 504 496 403 496 256 496 118 389.4 8 247.6 8zm.8 450.8c-112.5 0-203.7-93-203.7-202.8 0-105.5 85.5-203.3 203.8-203.3A201.7 201.7 0 01451.3 256c0 121.7-99.7 202.9-202.9 202.9z'/%3E%3C/svg%3E");content:" ";height:10rem;width:10rem;right:-2rem;top:-2rem;opacity:.1}.sponsor-button{background-color:#ffffff1a}.sponsor-button div{transform:scale(1.1);transition:transform var(--va-transition-duration) ease-in-out}.sponsor-button:hover{background-color:#ffffffe6}.sponsor-button:hover div{transform:scale(1.2)}.qrcode-container{overflow:hidden;height:0;transition:height var(--va-transition-duration) ease-in-out}.sponsor-description{color:var(--va-c-gray)}.sponsor-method-img{width:12rem;max-width:90%;aspect-ratio:1}:root{--waline-font-size:1rem;--waline-white:#fff;--waline-light-grey:#999;--waline-dark-grey:#666;--waline-theme-color:#27ae60;--waline-active-color:#2ecc71;--waline-color:#444;--waline-bgcolor:#fff;--waline-bgcolor-light:#f8f8f8;--waline-bgcolor-hover:#f0f0f0;--waline-border-color:#ddd;--waline-disable-bgcolor:#f8f8f8;--waline-disable-color:#000;--waline-code-bgcolor:#282c34;--waline-bq-color:#f0f0f0;--waline-avatar-size:3.25rem;--waline-m-avatar-size:calc(var(--waline-avatar-size) * 9 / 13);--waline-badge-color:#3498db;--waline-badge-font-size:.75em;--waline-info-bgcolor:#f8f8f8;--waline-info-color:#999;--waline-info-font-size:.625em;--waline-border:1px solid var(--waline-border-color);--waline-avatar-radius:50%;--waline-box-shadow:none}:root{--waline-theme-color:var(--va-c-primary);--waline-active-color:var(--va-c-primary-light)}</style><link rel="preload" href="/assets/index-e381b313.css" as="style"><link rel="modulepreload" crossorigin href="/js/posts/Deep Study of Java Concurrent Programming - Intermediate Level.291e374f.js"><title>深入学习Java并发编程-中级篇 - imklaus's Blog</title><link rel="icon" href="https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230825001534253.png" type="image/png"><meta name="theme-color" content="#ffffff"><meta name="msapplication-TileColor" content="#ffffff"><meta name="generator" content="Valaxy 0.14.61"><meta name="description" content><meta property="og:description" content><meta property="og:locale" content="zh-CN"><meta property="og:site_name" content="imklaus's Blog "><meta property="og:title" content="深入学习Java并发编程-中级篇"><meta property="og:image" content="https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/wallhaven-57o9j5_1920x1080.png"><meta property="og:url" content="https://imlklaus.github.io/"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@900&amp;display=swap"><link rel="preload" as="font" crossorigin="anonymous" href="/assets/KaTeX_AMS-Regular-0cdd387c.woff2"><link rel="preload" as="font" crossorigin="anonymous" href="/assets/KaTeX_Caligraphic-Bold-de7701e4.woff2"><link rel="preload" as="font" crossorigin="anonymous" href="/assets/KaTeX_Caligraphic-Regular-5d53e70a.woff2"><link rel="preload" as="font" crossorigin="anonymous" href="/assets/KaTeX_Fraktur-Bold-74444efd.woff2"><link rel="preload" as="font" crossorigin="anonymous" href="/assets/KaTeX_Fraktur-Regular-51814d27.woff2"><link rel="preload" as="font" crossorigin="anonymous" href="/assets/KaTeX_Main-Bold-0f60d1b8.woff2"><link rel="preload" as="font" crossorigin="anonymous" href="/assets/KaTeX_Main-BoldItalic-99cd42a3.woff2"><link rel="preload" as="font" crossorigin="anonymous" href="/assets/KaTeX_Main-Italic-97479ca6.woff2"><link rel="preload" as="font" crossorigin="anonymous" href="/assets/KaTeX_Main-Regular-c2342cd8.woff2"><link rel="preload" as="font" crossorigin="anonymous" href="/assets/KaTeX_Math-BoldItalic-dc47344d.woff2"><link rel="preload" as="font" crossorigin="anonymous" href="/assets/KaTeX_Math-Italic-7af58c5e.woff2"><link rel="preload" as="font" crossorigin="anonymous" href="/assets/KaTeX_SansSerif-Bold-e99ae511.woff2"><link rel="preload" as="font" crossorigin="anonymous" href="/assets/KaTeX_SansSerif-Italic-00b26ac8.woff2"><link rel="preload" as="font" crossorigin="anonymous" href="/assets/KaTeX_SansSerif-Regular-68e8c73e.woff2"><link rel="preload" as="font" crossorigin="anonymous" href="/assets/KaTeX_Script-Regular-036d4e95.woff2"><link rel="preload" as="font" crossorigin="anonymous" href="/assets/KaTeX_Size1-Regular-6b47c401.woff2"><link rel="preload" as="font" crossorigin="anonymous" href="/assets/KaTeX_Size2-Regular-d04c5421.woff2"><link rel="preload" as="font" crossorigin="anonymous" href="data:font/woff2;base64,d09GMgABAAAAAA4oAA4AAAAAHbQAAA3TAAEAAAAAAAAAAAAAAAAAAAAAAAAAAAAABmAAgRQIDgmcDBEICo1oijYBNgIkA14LMgAEIAWJAAeBHAyBHBvbGiMRdnO0IkRRkiYDgr9KsJ1NUAf2kILNxgUmgqIgq1P89vcbIcmsQbRps3vCcXdYOKSWEPEKgZgQkprQQsxIXUgq0DqpGKmIvrgkeVGtEQD9DzAO29fM9jYhxZEsL2FeURH2JN4MIcTdO049NCVdxQ/w9NrSYFEBKTDKpLKfNkCGDc1RwjZLQcm3vqJ2UW9Xfa3tgAHz6ivp6vgC2yD4/6352ndnN0X0TL7seypkjZlMsjmZnf0Mm5Q+JykRWQBKCVCVPbARPXWyQtb5VgLB6Biq7/Uixcj2WGqdI8tGSgkuRG+t910GKP2D7AQH0DB9FMDW/obJZ8giFI3Wg8Cvevz0M+5m0rTh7XDBlvo9Y4vm13EXmfttwI4mBo1EG15fxJhUiCLbiiyCf/ZA6MFAhg3pGIZGdGIVjtPn6UcMk9A/UUr9PhoNsCENw1APAq0gpH73e+M+0ueyHbabc3vkbcdtzcf/fiy+NxQEjf9ud/ELBHAXJ0nk4z+MXH2Ev/kWyV4k7SkvpPc9Qr38F6RPWnM9cN6DJ0AdD1BhtgABtmoRoFCvPsBAumNm6soZG2Gk5GyVTo2sJncSyp0jQTYoR6WDvTwaaEcHsxHfvuWhHA3a6bN7twRKtcGok6NsCi7jYRrM2jExsUFMxMQYuJbMhuWNOumEJy9hi29Dmg5zMp/A5+hhPG19j1vBrq8JTLr8ki5VLPmG/PynJHVul440bxg5xuymHUFPBshC+nA9I1FmwbRBTNHAcik3Oae0cxKoI3MOriM42UrPe51nsaGxJ+WfXubAsP84aabUlQSJ1IiE0iPETLUU4CATgfXSCSpuRFRmCGbO+wSpAnzaeaCYW1VNEysRtuXCEL1kUFUbbtMv3Tilt/1c11jt3Q5bbMa84cpWipp8Elw3MZhOHsOlwwVUQM3lAR35JiFQbaYCRnMF2lxAWoOg2gyoIV4PouX8HytNIfLhqpJtXB4vjiViUI8IJ7bkC4ikkQvKksnOTKICwnqWSZ9YS5f0WCxmpgjbIq7EJcM4aI2nmhLNY2JIUgOjXZFWBHb+x5oh6cwb0Tv1ackHdKi0I9OO2wE9aogIOn540CCCziyhN+IaejtgAONKznHlHyutPrHGwCx9S6B8kfS4Mfi4Eyv7OU730bT1SCBjt834cXsf43zVjPUqqJjgrjeGnBxSG4aYAKFuVbeCfkDIjAqMb6yLNIbCuvXhMH2/+k2vkNpkORhR59N1CkzoOENvneIosjYmuTxlhUzaGEJQ/iWqx4dmwpmKjrwTiTGTCVozNAYqk/zXOndWxuWSmJkQpJw3pK5KX6QrLt5LATMqpmPAQhkhK6PUjzHUn7E0gHE0kPE0iKkolgkUx9SZmVAdDgpffdyJKg3k7VmzYGCwVXGz/tXmkOIp+vcWs+EMuhhvN0h9uhfzWJziBQmCREGSIFmQIkgVpAnSBRmC//6hkLZwaVhwxlrJSOdqlFtOYxlau9F2QN5Y98xmIAsiM1HVp2VFX+DHHGg6Ecjh3vmqtidX3qHI2qycTk/iwxSt5UzTmEP92ZBnEWTk4Mx8Mpl78ZDokxg/KWb+Q0QkvdKVmq3TMW+RXEgrsziSAfNXFMhDc60N5N9jQzjfO0kBKpUZl0ZmwJ41j/B9Hz6wmRaJB84niNmQrzp9eSlQCDDzazGDdVi3P36VZQ+Jy4f9UBNp+3zTjqI4abaFAm+GShVaXlsGdF3FYzZcDI6cori4kMxUECl9IjJZpzkvitAoxKue+90pDMvcKRxLl53TmOKCmV/xRolNKSqqUxc6LStOETmFOiLZZptlZepcKiAzteG8PEdpnQpbOMNcMsR4RR2Bs0cKFEvSmIjAFcnarqwUL4lDhHmnVkwu1IwshbiCcgvOheZuYyOteufZZwlcTlLgnZ3o/WcYdzZHW/WGaqaVfmTZ1aWCceJjkbZqsfbkOtcFlUZM/jy+hXHDbaUobWqqXaeWobbLO99yG5N3U4wxco0rQGGcOLASFMXeJoham8M+/x6O2WywK2l4HGbq1CoUyC/IZikQhdq3SiuNrvAEj0AVu9x2x3lp/xWzahaxidezFVtdcb5uEnzyl0ZmYiuKI0exvCd4Xc9CV1KB0db00z92wDPde0kukbvZIWN6jUWFTmPIC/Y4UPCm8UfDTFZpZNon1qLFTkBhxzB+FjQRA2Q/YRJT8pQigslMaUpFyAG8TMlXigiqmAZX4xgijKjRlGpLE0GdplRfCaJo0JQaSxNBk6ZmMzcya0FmrcisDdn0Q3HI2sWSppYigmlM1XT/kLQZSNpMJG0WkjYbSZuDpM1F0uYhFc1HxU4m1QJjDK6iL0S5uSj5rgXc3RejEigtcRBtqYPQsiTskmO5vosV+q4VGIKbOkDg0jtRrq+Em1YloaTFar3EGr1EUC8R0kus1Uus00usL97ABr2BjXoDm/QGNhuWtMVBKOwg/i78lT7hBsAvDmwHc/ao3vmUbBmhjeYySZNWvGkfZAgISDSaDo1SVpzGDsAEkF8B+gEapViUoZgUWXcRIGFZNm6gWbAKk0bp0k1MHG9fLYtV4iS2SmLEQFARzRcnf9PUS0LVn05/J9MiRRBU3v2IrvW974v4N00L7ZMk0wXP1409CHo/an8zTRHD3eSJ6m8D4YMkZNl3M79sqeuAsr/m3f+8/yl7A50aiAEJgeBeMWzu7ui9UfUBCe2TIqZIoOd/3/udRBOQidQZUERzb2/VwZN1H/Sju82ew2H2Wfr6qvfVf3hqwDvAIpkQVFy4B9Pe9e4/XvPeceu7h3dvO56iJPf0+A6cqA2ip18ER+iFgggiuOkvj24bby0N9j2UHIkgqIt+sVgfodC4YghLSMjSZbH0VR/6dMDrYJeKHilKTemt6v6kvzvn3/RrdWtr0GoN/xL+Sex/cPYLUpepx9cz/D46UPU5KXgAQa+NDps1v6J3xP1i2HtaDB0M9aX2deA7SYff//+gUCovMmIK/qfsFcOk+4Y5ZN97XlG6zebqtMbKgeRFi51vnxTQYBUik2rS/Cn6PC8ADR8FGxsRPB82dzfND90gIcshOcYUkfjherBz53odpm6TP8txlwOZ71xmfHHOvq053qFF/MRlS3jP0ELudrf2OeN8DHvp6ZceLe8qKYvWz/7yp0u4dKPfli3CYq0O13Ih71mylJ80tOi10On8wi+F4+LWgDPeJ30msSQt9/vkmHq9/Lvo2b461mP801v3W4xTcs6CbvF9UDdrSt+A8OUbpSh55qAUFXWznBBfdeJ8a4d7ugT5tvxUza3h9m4H7ptTqiG4z0g5dc0X29OcGlhpGFMpQo9ytTS+NViZpNdvU4kWx+LKxNY10kQ1yqGXrhe4/1nvP7E+nd5A92TtaRplbHSqoIdOqtRWti+fkB5/n1+/VvCmz12pG1kpQWsfi1ftlBobm0bpngs16CHkbIwdLnParxtTV3QYRlfJ0KFskH7pdN/YDn+yRuSd7sNH3aO0DYPggk6uWuXrfOc+fa3VTxFVvKaNxHsiHmsXyCLIE5yuOeN3/Jdf8HBL/5M6shjyhxHx9BjB1O0+4NLOnjLLSxwO7ukN4jMbOIcD879KLSi6Pk61Oqm2377n8079PXEEQ7cy7OKEC9nbpet118fxweTafpt69x/Bt8UqGzNQt7aelpc44dn5cqhwf71+qKp/Zf/+a0zcizOUWpl/iBcSXip0pplkatCchoH5c5aUM8I7/dWxAej8WicPL1URFZ9BDJelUwEwTkGqUhgSlydVes95YdXvhh9Gfz/aeFWvgVb4tuLbcv4+wLdutVZv/cUonwBD/6eDlE0aSiKK/uoH3+J1wDE/jMVqY2ysGufN84oIXB0sPzy8ollX/LegY74DgJXJR57sn+VGza0x3DnuIgABFM15LmajjjsNlYj+JEZGbuRYcAMOWxFkPN2w6Wd46xo4gVWQR/X4lyI/R6K/YK0110GzudPRW7Y+UOBGTfNNzHeYT0fiH0taunBpq9HEW8OKSaBGj21L0MqenEmNRWBAWDWAk4CpNoEZJ2tTaPFgbQYj8HxtFilErs3BTRwT8uO1NXQaWfIotchmPkAF5mMBAliEmZiOGVgCG9LgRzpscMAOOwowlT3JhusdazXGSC/hxR3UlmWVwWHpOIKheqONvjyhSiTHIkVUco5bnji8m//zL7PKaT1Vl5I6UE609f+gkr6MZKVyKc7zJRmCahLsdlyA5fdQkRSan9LgnnLEyGSkaKJCJog0wAgvepWBt80+1yKln1bMVtCljfNWDueKLsWwaEbBSfSPTEmVRsUcYYMnEjcjeyCZzBXK9E9BYBXLKjOSpUDR+nEV3TFSUdQaz+ot98QxgXwx0GQ+EEUAKB2qZPkQQ0GqFD8UPFMqyaCHM24BZmSGic9EYMagKizOw9Hz50DMrDLrqqLkTAhplMictiCAx5S3BIUQdeJeLnBy2CNtMfz6cV4u8XKoFZQesbf9YZiIERiHjaNodDW6LgcirX/mPnJIkBGDUpTBhSa0EIr38D5hCIszhCM8URGBqImoWjpvpt1ebu/v3Gl3qJfMnNM+9V+kiRFyROTPHQWOcs1dNW94/ukKMPZBvDi55i5CttdeJz84DLngLqjcdwEZ87bFFR8CIG35OAkDVN6VRDZ7aq67NteYqZ2lpT8oYB2CytoBd6VuAx4WgiAsnuj3WohG+LugzXiQRDeM3XYXlULv4dp5VFYC"><link rel="preload" as="font" crossorigin="anonymous" href="/assets/KaTeX_Size4-Regular-a4af7d41.woff2"><link rel="preload" as="font" crossorigin="anonymous" href="/assets/KaTeX_Typewriter-Regular-71d517d6.woff2"><link rel="preload" as="font" crossorigin="anonymous" href="data:font/woff2;base64,d09GMgABAAAAAAkcAAsAAAAAEogAAAjNAAEAAAAAAAAAAAAAAAAAAAAAAAAAAAAABmAAgSQRCAqcLJZKCzoAATYCJANwBCAFgkoHIBupDgDm53Gzej8JpU0wqygVVyoWwphIsuuw60jpmBY6ppTa7mk7jtx57UQ0V2ulvfmteSIQji061T2HvfDEECASKizU5VUQXFjFRtgYTVg+woiYDVezOThR4tAvr/YYgOO/RZ+BAABzYtMA8Kl8Neg3UIDCoCkOyWBuLcCvSHycH78QvhFxmUCK03A0RwGSvXBAHgR8UB8DMvocJYAgbiZiJnqmYGbXjG3mz7P8nHhe8Uvxr0j+fzwPABAjWT1E83IJHh/x87G/jv1l7JtYR+y+WF2MKAai/qfDtfIRt7hBikI8D1IpipXqWqYSDgDBfwE7qDLw5EEALqFRDMKAsApNwchXAJgFL/WETMbKcDVSifR6QkjwkDaRTEugqlBtKVcL6Smi1dHlIqUmuii6Pic1JTIlFTX3uRenMNpiCiKOCZBm2ges0b/ScigDVgcb2MEHfloel7e1z208KrZUeQFjK0dIkbl6FOFczRhFE6zaRklPlz52tOXcKtmpdqisgHnbxRatg66vsZNHaWMPQ/eZmH6jaavlNASsipbKwVZSYrRm1mywI0670UEdhLy+yuscolSZJHKwg5IyNzRJQbKRZiicwnYiChjO1vSbKCBpkAgCjGIb6KCvA5GL0VHeUDwAQEHkSC2ToBJhKN9KAneim2ekLf1vENf3mjT3vAS295XY2MMgzRpSqTVWpt4ang+ksXynRUQPlkFOu+b6Yw0jBp8krbXbYbjc5mn6KpsNWKtqtcNz0D8xTTQKzthbZYAxLev3NkFgyYWsngBjGo8jg6a9Y3rKR9Pfqun10RvJi9X9foZGvrltMkJgWR7dhI7SSITEaBWIQQTMUSOJkTi5nlqpZUfNKcYD1Do/ZdkbR8UeVpKLSbMVgKLX0flzQYqCrLpll+/vus2IM9+lbdTgWWRLQJqvaq7eHKulgL2ssp7LrpxR2DBI/ja1zXvi7cS1E0Gr0uhy7PUGwPmdkkdjEYOjpGnQRXowC/GBq51eymLRXrsXsTzXX37VlXzeVxoI6m8Gy67oBnzsB6DoQYY7GHM2fbT4oS9zON45lPnwbmww2BL0G89EnfaVPi5eJ3NZFtjc277Wb9M1A+UWG2WZyrj6PMKmLHRoH04iZLuivlsHTmm9/qYJ1r2Z90DtuKYduK6SdNZ3dRRxHAoE+l4HGM6MyIe+0se+zHEfsP4s2sqqnVdSTE/8lCVYMRVsuBVEJOvT3fa1Xr4X2iDZflVFmxyDmpu1r8b9IsVzXUB9w1/l9ccf7WCszaI1ATtUx7oRztk1dtbBcciudJAi83Vv2yaTg9uON6toxLlIM2GVxClo2eVBt5gcOHRwHLIpptC92TeKRi3MjtBkTAOaoU+6P1q364+kdgt/+xh2fRvlOf2p5xR4ut7P4s0sPwY63OguajQWuYqMjUWaA9100ya6yHdHr/BMyxN9QmGa2zjPnbZr17KTy9weKwqXYtqjcMunRkgE9kP+Refvml14hAZw8WFQGmZnnaEi0eLUQTCc+tLSphVyaUH6lAJoXjF1MDiaFSOexNCRKYW8TOkhKzDEDjPDvHHI3c5hXbQLhujhUuPmBYd+N/EaktFsDqoDo4/G0yx70s3SSuXJDIvjMNsIQ7TDqb+/sv8NHGl6BvDAMOnsCpv9PQcP9tS6N294zEnwtNdt2tfTXSz7JGwAqALmbKpr90BaeqA9tlvduWP4/xa0thZcJMNDC6XqrFuy2xGF7YaiQkN7UfhEbMaNkOxQHezh7YVFBsP9TcoybgmzhaExmpxb/78Naf89LmVWthVvvSWh3rZUWtlMFStWENDf5uqEd2LiP/M/fvWEWUntjnTynpI2ainnLdjPUIvL2uGFJvoUQy0taZvPePLqxy0lK6mUo8yp6B+WtdyyTHivdrgLZrhbvAOlWMbQEJtJZ7JuXgRLC+hwe/kb90WvW4U4/PGGRUmLk995J1loWLRhQwVCKkve4JOS8YJASY+P8KQNe/vahGNU8TJRe/eCaaG7ozsrt6Ixu623v/ck0rvlG2EYBoAh6abIxoZ9UeHoNQAiMPKv/8pIi+47EAMHcfLh7dyX8q0Po+Iap94fFob+4fr/DXr96x+j1x2dhZ0dBfRqardjBIZ+M+S6Lo6ojE+4HKF7Kz7zG+eCOkwQ98UfOirDqrckKPVz3sR8srT/gsev3H0p3Rq7wkD1JLE/XZ+2Ze5pV5eqPiqqmBkc1PQYDBvlk5MdqQff21UyInvyhyjMsHXV33tD3zaQ7Us/NKfX44qLQ/8ffOtzXIjnymRNXampDWkGDR5yOyThG2/9UXC6liWEEz0hX+uR1Xg780i4eNOSig3Fk2pSkPpBqrrmx3/+TbB2ya9ePfrGJx98H8rvjKsRQoSh/G0s8cO6bhwwUI8vUz1c21B04cscrjVV1q8zzCVJkmv/T8y21/bLszJpxeqptculJZpleUyKrPX/X3QZBL+rl+hTWuR/2At7LhYVX9BBsULaqi9LWh+6xMDLW6V65dy2gsMbszemQ96XMDvrSfRM60ceo5R/oGDXB0KrxJsTACBhbV48S4Cd5IeyAVdU5Yg+2nPGKS+XAwmOljrwpIdMmdJPexI9ndnIXUIVgety83YzRdXD6E6YvF0gVGJRMhpOyQW6xGM0Zbq7zw8AoAcWAYa7cSOsARF+Fm8DBAAYgDUq07ZSWvm3UIoAAIAfde39SB7Hz+K/xR9vAkMBg0YE8PKEChkH47+9MDggitAdAEObxnBmZAFu5C4eyMxqN/2c3ZUK2qJ+tDUvrTR/BGHDbqZplsDNZVVQjIaim4XA6TE4YLCfEdweIwAKaArx8aN1JETYMNMDEWGYZdRjMJDAB4T7+EEiwAdiBKCBlRQCfnwjEgohbttG2AYb3yS+7tWIDW1rd/6mMedAM+yEHbAvWge0XgNevwdW20Cmdfb6NXBYqm+DtZHUyUW88R/abjA/OxeYpIa9sNmNGMqHbMgd2CAZPzVuOfQFg5H275pWwx73mQMODQAAAA=="></head><body><div id="app" data-server-rendered="true"><!--[--><!--[--><canvas class="fireworks"></canvas><!--[--><div class="yun-bg"></div><!--]--><!--[--><button class="yun-search-btn popup-trigger yun-icon-btn" title="搜索"><div i-ri-search-line></div></button><!----><!--]--><!--]--><!--[--><!--]--><!----><!--[--><!--[--><!----><button type="button" class="vt-hamburger menu-btn sidebar-toggle yun-icon-btn leading-4 fixed left-0.8rem top-0.6rem md:hidden" aria-label="mobile navigation" aria-expanded="false" inline-flex cursor="pointer" z="$yun-z-menu-btn"><span class="vt-hamburger-container"><span class="vt-hamburger-top"></span><span class="vt-hamburger-middle"></span><span class="vt-hamburger-bottom"></span></span></button><aside class="md:translate-x-0 va-card transition sidebar fixed inset-y-0 left-0 overflow-y-auto" text="center" bg="$yun-sidebar-bg-color contain no-repeat" z="$yun-z-sidebar"><!----><div class><!--[--><div class="sidebar-panel" p="2"><div class="site-info" m="t-6"><a href="/about" class="site-author-avatar"><img class="rounded-full" src="/images/avatar.jpg" alt="avatar"><span class="site-author-status" title="The moonlight is beautiful.">💛</span></a><div class="site-author-name leading-6" m="t-0 b-4"><a href="/about" class>imklaus</a></div><a href="/about/site" class="site-name">imklaus's Blog</a><h4 class="site-subtitle block" text="xs">The Winner Takes It All.</h4><!----></div><nav class="site-nav" text-xl mt-6><a href="/" class="site-link-item yun-icon-btn" title="首页"><div i-ri-home-4-line></div></a><a href="/archives/" class="site-link-item" title="归档"><div class="icon" i-ri-archive-line></div><span class="count">27</span></a><a href="/categories/" class="site-link-item" title="分类"><div class="icon" i-ri-folder-2-line></div><span class="count">2</span></a><a href="/tags/" class="site-link-item" title="标签"><div class="icon" i-ri-price-tag-3-line></div><span class="count">76</span></a><a href="/slides/" class="site-link-item yun-icon-btn" title="幻灯片"><!--[--><div class="i-ri-keynote-line"></div><!--]--></a></nav><hr m="t-4 b-2"><div class="links-of-author"><!--[--><a class="links-of-author-item yun-icon-btn" rel="noopener" href="/atom.xml" title="RSS" target="_blank" style="color:orange"><div class="i-ri-rss-line icon"></div></a><a class="links-of-author-item yun-icon-btn" rel="noopener" href="https://github.com/imLKlauS" title="GitHub" target="_blank" style="color:#6e5494"><div class="i-ri-github-line icon"></div></a><a class="links-of-author-item yun-icon-btn" rel="noopener" href="https://music.163.com/#/user/home?id=102158629" title="冷门歌手" target="_blank" style="color:#c20c0c"><div class="i-ri-netease-cloud-music-line icon"></div></a><a class="links-of-author-item yun-icon-btn" rel="noopener" href="https://space.bilibili.com/19430480" title="哔哩哔哩" target="_blank" style="color:#ff8eb3"><div class="i-ri-bilibili-line icon"></div></a><a class="links-of-author-item yun-icon-btn" rel="noopener" href="https://t.me/elpsycn" title="Telegram Channel" target="_blank" style="color:#08c"><div class="i-ri-telegram-line icon"></div></a><a class="links-of-author-item yun-icon-btn" rel="noopener" href="q1064779584@163.com" title="E-Mail" target="_blank" style="color:#8e71c1"><div class="i-ri-mail-line icon"></div></a><a class="links-of-author-item yun-icon-btn" rel="noopener" href="https://www.travellings.cn/go.html" title="Travelling" target="_blank" style="color:var(--va-c-text)"><div class="i-ri-train-line icon"></div></a><!--]--></div><hr m="y-2"><div class="links flex-center"><!--[--><a href="/comment/" class="link-item yun-icon-btn" inline-flex title="留言板" style="color:#737de5"><!--[--><div class="i-ri-clipboard-line icon w-8 h-8"></div><!--]--></a><a href="/albums/" class="link-item yun-icon-btn" inline-flex title="相册" style="color:#43abee"><!--[--><div class="i-ri-gallery-line icon w-8 h-8"></div><!--]--></a><a href="/links/" class="link-item yun-icon-btn" inline-flex title="友链" style="color:#4bbea4"><!--[--><div class="i-ri-open-arm-line icon w-8 h-8"></div><!--]--></a><a href="/music/" class="link-item yun-icon-btn" inline-flex title="听歌" style="color:#1e90ff"><!--[--><div class="i-ri-netease-cloud-music-line icon w-8 h-8"></div><!--]--></a><!--]--></div><br></div><div><button class="yun-icon-btn" title="切换深色模式" style="color:#f1cb64"><div i="ri-sun-line dark:ri-moon-line"></div></button><button class="yun-icon-btn" title="切换语言" style="color:var(--va-c-text)"><div i-ri-translate class="transition transform"></div></button></div><!--]--></div></aside><!--]--><main class="yun-main lt-md:ml-0" flex="~"><div w="full" flex="~"><!--[--><div class="content" flex="~ col grow" w="full" p="l-4 lt-md:0"><div class="yun-card flex-center relative" flex="col" min-h="100px" bg="$va-c-bg-light" m="0" style><img width="640" height="360" class="object-cover select-none" h="64 md:sm" w="full" src="https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/wallhaven-57o9j5_1920x1080.png"><!----><!--[--><!--[--><header class="post-header mb-2" m="t-16 sm:t-6" cover="https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/wallhaven-57o9j5_1920x1080.png"><h1 class="post-title flex-center" p="2" text="2xl center" font="serif black" style=""><!----><span inline-flex class="leading-none">深入学习Java并发编程-中级篇</span></h1></header><!--]--><!--[--><!--[--><!--[--><!--[--><!----><!----><div class="post-top-icon" color="$va-c-warning"><div i-ri-pushpin-line></div></div><div class="post-meta" flex="~ col" justify="center" items="center" text="sm" py="1"><div class="post-time flex items-center"><span class="inline-flex-center" title="发表于2023-07-07T22:52:11.000Z"><div class="inline-block" i-ri-calendar-line></div><time m="l-1">2023-07-07</time></span><span class="inline-flex-center" title="更新于2023-10-03T04:41:59.556Z"><span m="x-2">-</span><div i-ri-calendar-2-line></div><time m="l-1">2023-10-03</time></span></div><div class="post-counter flex items-center" mt="2"><span class="inline-flex-center" title="本文字数"><div class="inline-block" i-ri-file-word-line></div><time m="l-1">24.6k</time></span><span class="inline-flex-center" title="阅读时长"><span m="x-2">-</span><div i-ri-timer-line></div><time m="l-1">139m</time></span></div></div><!--[--><!--]--><!--]--><div flex="~" text="sm" my="1" h="5"><div inline-flex justify="center" items="center" mx="2" title="阅读次数"><div inline-flex i-ri-eye-line></div><span ml-1 inline-flex class="waline-pageview-count" data-path="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20intermediate%20level"></span></div><div inline-flex justify="center" items="center" mx="2" title="评论数"><div inline-flex i-ri-chat-4-line></div><span ml-1 inline-flex class="waline-comment-count" data-path="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20intermediate%20level"></span></div></div><div class="inline-flex" text="sm" py="1"><a href="/categories/?category=Java" class="post-category inline-flex-center"><div m="x-1" inline-flex i-ri-folder-2-line></div><span>Java</span></a><span mx="2">-</span><!--[--><a href="/tags/?tag=ReentrantLock" class="post-tag inline-flex-center" m="x-1"><div m="r-1" i-ri-price-tag-3-line></div><span>ReentrantLock</span></a><a href="/tags/?tag=Synchronized" class="post-tag inline-flex-center" m="x-1"><div m="r-1" i-ri-price-tag-3-line></div><span>Synchronized</span></a><a href="/tags/?tag=volatile" class="post-tag inline-flex-center" m="x-1"><div m="r-1" i-ri-price-tag-3-line></div><span>volatile</span></a><a href="/tags/?tag=ThreadLocal" class="post-tag inline-flex-center" m="x-1"><div m="r-1" i-ri-price-tag-3-line></div><span>ThreadLocal</span></a><a href="/tags/?tag=Atomic" class="post-tag inline-flex-center" m="x-1"><div m="r-1" i-ri-price-tag-3-line></div><span>Atomic</span></a><a href="/tags/?tag=LongAdder" class="post-tag inline-flex-center" m="x-1"><div m="r-1" i-ri-price-tag-3-line></div><span>LongAdder</span></a><!--]--></div><!--]--><!--]--><!--]--><div p="x-4 b-8" class="sm:px-6 lg:px-12 xl:px-16" w="full"><!--[--><article class="markdown-body"><!--[--><!----><!--[--><h1 id="并发编程笔记" tabindex="-1">并发编程笔记 <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20intermediate%20level#并发编程笔记" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h1><p>本博客根据<strong>黑马java并发编程教程</strong>学习而做的笔记，链接如下：<a target="_blank" rel="noreferrer" href="https://www.bilibili.com/video/av81461839?from=search&amp;seid=8445102345230304010"><!--[-->深入学习Java并发<!--]--><!----></a></p><h2 id="三、共享模型之管程" tabindex="-1">三、共享模型之管程 <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20intermediate%20level#三、共享模型之管程" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h2><h3 id="_1、共享带来的问题" tabindex="-1">1、共享带来的问题 <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20intermediate%20level#_1、共享带来的问题" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h3><h4 id="_1-问题分析" tabindex="-1">(1)问题分析 <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20intermediate%20level#_1-问题分析" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h4><figure><img src="https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230712134850509.png" alt="image-20230712134850509" loading="lazy" decoding="async"></figure><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#f97583">static</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> counter </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">static</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">void</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">main</span><span style="color:#e1e4e8">(</span><span style="color:#f97583">String</span><span style="color:#e1e4e8">[] args) throws InterruptedException {</span></span>
<span class="line"><span style="color:#e1e4e8">    Thread t1 </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Thread</span><span style="color:#e1e4e8">(() </span><span style="color:#f97583">-&gt;</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">for</span><span style="color:#e1e4e8"> (</span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> i </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8">; i </span><span style="color:#f97583">&lt;</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">5000</span><span style="color:#e1e4e8">; i</span><span style="color:#f97583">++</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">        	counter</span><span style="color:#f97583">++</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">        }</span></span>
<span class="line"><span style="color:#e1e4e8">    }, </span><span style="color:#9ecbff">"t1"</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">    Thread t2 </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Thread</span><span style="color:#e1e4e8">(() </span><span style="color:#f97583">-&gt;</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">for</span><span style="color:#e1e4e8"> (</span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> i </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8">; i </span><span style="color:#f97583">&lt;</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">5000</span><span style="color:#e1e4e8">; i</span><span style="color:#f97583">++</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">        	counter</span><span style="color:#f97583">--</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">        }</span></span>
<span class="line"><span style="color:#e1e4e8">    }, </span><span style="color:#9ecbff">"t2"</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">    t1.</span><span style="color:#b392f0">start</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">    t2.</span><span style="color:#b392f0">start</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">    t1.</span><span style="color:#b392f0">join</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">    t2.</span><span style="color:#b392f0">join</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">    log.</span><span style="color:#b392f0">debug</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"{}"</span><span style="color:#e1e4e8">,counter);</span></span>
<span class="line"><span style="color:#e1e4e8">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#d73a49">static</span><span style="color:#24292e"> </span><span style="color:#d73a49">int</span><span style="color:#24292e"> counter </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#005cc5">0</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">static</span><span style="color:#24292e"> </span><span style="color:#d73a49">void</span><span style="color:#24292e"> </span><span style="color:#6f42c1">main</span><span style="color:#24292e">(</span><span style="color:#d73a49">String</span><span style="color:#24292e">[] args) throws InterruptedException {</span></span>
<span class="line"><span style="color:#24292e">    Thread t1 </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Thread</span><span style="color:#24292e">(() </span><span style="color:#d73a49">-&gt;</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">for</span><span style="color:#24292e"> (</span><span style="color:#d73a49">int</span><span style="color:#24292e"> i </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#005cc5">0</span><span style="color:#24292e">; i </span><span style="color:#d73a49">&lt;</span><span style="color:#24292e"> </span><span style="color:#005cc5">5000</span><span style="color:#24292e">; i</span><span style="color:#d73a49">++</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">        	counter</span><span style="color:#d73a49">++</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">        }</span></span>
<span class="line"><span style="color:#24292e">    }, </span><span style="color:#032f62">"t1"</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">    Thread t2 </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Thread</span><span style="color:#24292e">(() </span><span style="color:#d73a49">-&gt;</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">for</span><span style="color:#24292e"> (</span><span style="color:#d73a49">int</span><span style="color:#24292e"> i </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#005cc5">0</span><span style="color:#24292e">; i </span><span style="color:#d73a49">&lt;</span><span style="color:#24292e"> </span><span style="color:#005cc5">5000</span><span style="color:#24292e">; i</span><span style="color:#d73a49">++</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">        	counter</span><span style="color:#d73a49">--</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">        }</span></span>
<span class="line"><span style="color:#24292e">    }, </span><span style="color:#032f62">"t2"</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">    t1.</span><span style="color:#6f42c1">start</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">    t2.</span><span style="color:#6f42c1">start</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">    t1.</span><span style="color:#6f42c1">join</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">    t2.</span><span style="color:#6f42c1">join</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">    log.</span><span style="color:#6f42c1">debug</span><span style="color:#24292e">(</span><span style="color:#032f62">"{}"</span><span style="color:#24292e">,counter);</span></span>
<span class="line"><span style="color:#24292e">}</span></span></code></pre></div><p><strong>问题分析</strong></p><p>以上的结果可能是正数、负数、零。为什么呢？因为 Java 中对静态变量的自增，自减并不是原子操作，要彻底理 解，必须从字节码来进行分析 例如对于 <code>i++</code> 而言（i 为静态变量），实际会产生如下的 JVM 字节码指令：</p><div class="language-css"><button title="Copy Code" class="copy"></button><span class="lang">css</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8">getstatic </span><span style="color:#85e89d">i</span><span style="color:#e1e4e8"> // 获取静态变量i的值</span></span>
<span class="line"><span style="color:#e1e4e8">iconst_1 // 准备常量1</span></span>
<span class="line"><span style="color:#e1e4e8">iadd // 自增</span></span>
<span class="line"><span style="color:#e1e4e8">putstatic </span><span style="color:#85e89d">i</span><span style="color:#e1e4e8"> // 将修改后的值存入静态变量i</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e">getstatic </span><span style="color:#22863a">i</span><span style="color:#24292e"> // 获取静态变量i的值</span></span>
<span class="line"><span style="color:#24292e">iconst_1 // 准备常量1</span></span>
<span class="line"><span style="color:#24292e">iadd // 自增</span></span>
<span class="line"><span style="color:#24292e">putstatic </span><span style="color:#22863a">i</span><span style="color:#24292e"> // 将修改后的值存入静态变量i</span></span></code></pre></div><p>而对应 <code>i--</code> 也是类似：</p><div class="language-css"><button title="Copy Code" class="copy"></button><span class="lang">css</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8">getstatic </span><span style="color:#85e89d">i</span><span style="color:#e1e4e8"> // 获取静态变量i的值</span></span>
<span class="line"><span style="color:#e1e4e8">iconst_1 // 准备常量1</span></span>
<span class="line"><span style="color:#e1e4e8">isub // 自减</span></span>
<span class="line"><span style="color:#e1e4e8">putstatic </span><span style="color:#85e89d">i</span><span style="color:#e1e4e8"> // 将修改后的值存入静态变量i</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e">getstatic </span><span style="color:#22863a">i</span><span style="color:#24292e"> // 获取静态变量i的值</span></span>
<span class="line"><span style="color:#24292e">iconst_1 // 准备常量1</span></span>
<span class="line"><span style="color:#24292e">isub // 自减</span></span>
<span class="line"><span style="color:#24292e">putstatic </span><span style="color:#22863a">i</span><span style="color:#24292e"> // 将修改后的值存入静态变量i</span></span></code></pre></div><p>而 Java 的内存模型如下，完成静态变量的自增，自减需要在主存和工作内存中进行数据交换：</p><figure><img src="https://jsd.cdn.zzko.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230712135307374.png" alt="image-20230712135307374" loading="lazy" decoding="async"></figure><p>如果是单线程以上 8 行代码是顺序执行（不会交错）没有问题：</p><figure><img src="https://jsd.cdn.zzko.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230712135330938.png" alt="image-20230712135330938" loading="lazy" decoding="async"></figure><p>但多线程下这 8 行代码可能交错运行： 出现负数的情况：</p><figure><img src="https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230712135408865.png" alt="image-20230712135408865" loading="lazy" decoding="async"></figure><p>出现正数的情况：</p><figure><img src="https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230712135429731.png" alt="image-20230712135429731" loading="lazy" decoding="async"></figure><h4 id="_2-临界区-critical-section" tabindex="-1">(2)临界区 Critical Section <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20intermediate%20level#_2-临界区-critical-section" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h4><ul><li>一个程序运行多个线程本身是没有问题的</li><li>问题出在多个线程访问共享资源<ul><li>多个线程读共享资源其实也没有问题</li><li>在多个线程对共享资源读写操作时发生指令交错，就会出现问题</li></ul></li><li>一段代码块内如果存在对共享资源的多线程读写操作，称这段代码块为<strong>临界区</strong> 例如，下面代码中的临界区</li></ul><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#f97583">static</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> counter </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8"> </span></span>
<span class="line"><span style="color:#f97583">static</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">void</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">increment</span><span style="color:#e1e4e8">() </span></span>
<span class="line"><span style="color:#6a737d">// 临界区 </span></span>
<span class="line"><span style="color:#e1e4e8">{   </span></span>
<span class="line"><span style="color:#e1e4e8">    counter</span><span style="color:#f97583">++</span><span style="color:#e1e4e8">; </span></span>
<span class="line"><span style="color:#e1e4e8">}</span></span>
<span class="line"><span style="color:#e1e4e8"> </span></span>
<span class="line"><span style="color:#f97583">static</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">void</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">decrement</span><span style="color:#e1e4e8">() </span></span>
<span class="line"><span style="color:#6a737d">// 临界区 </span></span>
<span class="line"><span style="color:#e1e4e8">{ </span></span>
<span class="line"><span style="color:#e1e4e8">    counter</span><span style="color:#f97583">--</span><span style="color:#e1e4e8">; </span></span>
<span class="line"><span style="color:#e1e4e8">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#d73a49">static</span><span style="color:#24292e"> </span><span style="color:#d73a49">int</span><span style="color:#24292e"> counter </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#005cc5">0</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e"> </span></span>
<span class="line"><span style="color:#d73a49">static</span><span style="color:#24292e"> </span><span style="color:#d73a49">void</span><span style="color:#24292e"> </span><span style="color:#6f42c1">increment</span><span style="color:#24292e">() </span></span>
<span class="line"><span style="color:#6a737d">// 临界区 </span></span>
<span class="line"><span style="color:#24292e">{   </span></span>
<span class="line"><span style="color:#24292e">    counter</span><span style="color:#d73a49">++</span><span style="color:#24292e">; </span></span>
<span class="line"><span style="color:#24292e">}</span></span>
<span class="line"><span style="color:#24292e"> </span></span>
<span class="line"><span style="color:#d73a49">static</span><span style="color:#24292e"> </span><span style="color:#d73a49">void</span><span style="color:#24292e"> </span><span style="color:#6f42c1">decrement</span><span style="color:#24292e">() </span></span>
<span class="line"><span style="color:#6a737d">// 临界区 </span></span>
<span class="line"><span style="color:#24292e">{ </span></span>
<span class="line"><span style="color:#24292e">    counter</span><span style="color:#d73a49">--</span><span style="color:#24292e">; </span></span>
<span class="line"><span style="color:#24292e">}</span></span></code></pre></div><h4 id="_3-竞态条件-race-condition" tabindex="-1"><strong>(3)竞态条件 Race Condition</strong> <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20intermediate%20level#_3-竞态条件-race-condition" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h4><p>多个线程在<strong>临界区</strong>内执行，由于代码的执行序列不同而导致结果无法预测，称之为发生了<strong>竞态条件</strong></p><h3 id="_2、synchronized-解决方案" tabindex="-1">2、synchronized 解决方案 <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20intermediate%20level#_2、synchronized-解决方案" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h3><h4 id="_1-解决手段" tabindex="-1">(1)解决手段 <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20intermediate%20level#_1-解决手段" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h4><p>为了避免临界区的竞态条件发生，有多种手段可以达到目的。</p><ul><li>阻塞式的解决方案：synchronized，Lock</li><li>非阻塞式的解决方案：原子变量</li></ul><p>本次课使用阻塞式的解决方案：<strong>synchronized</strong>，来解决上述问题，即俗称的【<strong>对象锁</strong>】，它采用互斥的方式让同一 时刻至多只有一个线程能持有【对象锁】，其它线程再想获取这个【对象锁】时就会阻塞住(blocked)。这样就能保证拥有锁 的线程可以安全的执行临界区内的代码，不用担心线程上下文切换</p><blockquote><p><strong>注意</strong></p><p>虽然 java 中互斥和同步都可以采用 synchronized 关键字来完成，但它们还是有区别的：</p><ul><li>互斥是保证临界区的竞态条件发生，同一时刻只能有一个线程执行临界区代码</li><li>同步是由于线程执行的先后、顺序不同、需要一个线程等待其它线程运行到某个点</li></ul></blockquote><h4 id="_2-synchronized语法" tabindex="-1">(2)synchronized语法 <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20intermediate%20level#_2-synchronized语法" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h4><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#f97583">synchronized</span><span style="color:#e1e4e8">(对象) {</span></span>
<span class="line"><span style="color:#e1e4e8">	</span><span style="color:#6a737d">//临界区</span></span>
<span class="line"><span style="color:#e1e4e8">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#d73a49">synchronized</span><span style="color:#24292e">(对象) {</span></span>
<span class="line"><span style="color:#24292e">	</span><span style="color:#6a737d">//临界区</span></span>
<span class="line"><span style="color:#24292e">}</span></span></code></pre></div><p>例：</p><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#f97583">static</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> counter </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8">; </span></span>
<span class="line"><span style="color:#6a737d">//创建一个公共对象，作为对象锁的对象</span></span>
<span class="line"><span style="color:#f97583">static</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">final</span><span style="color:#e1e4e8"> Object room </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Object</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8"> </span></span>
<span class="line"><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">static</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">void</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">main</span><span style="color:#e1e4e8">(</span><span style="color:#f97583">String</span><span style="color:#e1e4e8">[] args) throws InterruptedException {    </span></span>
<span class="line"><span style="color:#e1e4e8">	Thread t1 </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Thread</span><span style="color:#e1e4e8">(() </span><span style="color:#f97583">-&gt;</span><span style="color:#e1e4e8"> {        </span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">for</span><span style="color:#e1e4e8"> (</span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> i </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8">; i </span><span style="color:#f97583">&lt;</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">5000</span><span style="color:#e1e4e8">; i</span><span style="color:#f97583">++</span><span style="color:#e1e4e8">) {            </span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">synchronized</span><span style="color:#e1e4e8"> (room) {     </span></span>
<span class="line"><span style="color:#e1e4e8">        counter</span><span style="color:#f97583">++</span><span style="color:#e1e4e8">;            </span></span>
<span class="line"><span style="color:#e1e4e8">       	 }       </span></span>
<span class="line"><span style="color:#e1e4e8"> 	   }    </span></span>
<span class="line"><span style="color:#e1e4e8">    }, </span><span style="color:#9ecbff">"t1"</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8"> </span></span>
<span class="line"><span style="color:#e1e4e8">    Thread t2 </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Thread</span><span style="color:#e1e4e8">(() </span><span style="color:#f97583">-&gt;</span><span style="color:#e1e4e8"> {       </span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">for</span><span style="color:#e1e4e8"> (</span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> i </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8">; i </span><span style="color:#f97583">&lt;</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">5000</span><span style="color:#e1e4e8">; i</span><span style="color:#f97583">++</span><span style="color:#e1e4e8">) {         </span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">synchronized</span><span style="color:#e1e4e8"> (room) {            </span></span>
<span class="line"><span style="color:#e1e4e8">            counter</span><span style="color:#f97583">--</span><span style="color:#e1e4e8">;          </span></span>
<span class="line"><span style="color:#e1e4e8">            }    </span></span>
<span class="line"><span style="color:#e1e4e8">        } </span></span>
<span class="line"><span style="color:#e1e4e8">    }, </span><span style="color:#9ecbff">"t2"</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8"> </span></span>
<span class="line"><span style="color:#e1e4e8">    t1.</span><span style="color:#b392f0">start</span><span style="color:#e1e4e8">();    </span></span>
<span class="line"><span style="color:#e1e4e8">    t2.</span><span style="color:#b392f0">start</span><span style="color:#e1e4e8">(); </span></span>
<span class="line"><span style="color:#e1e4e8">    t1.</span><span style="color:#b392f0">join</span><span style="color:#e1e4e8">();   </span></span>
<span class="line"><span style="color:#e1e4e8">    t2.</span><span style="color:#b392f0">join</span><span style="color:#e1e4e8">();    </span></span>
<span class="line"><span style="color:#e1e4e8">    log.</span><span style="color:#b392f0">debug</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"{}"</span><span style="color:#e1e4e8">,counter); </span></span>
<span class="line"><span style="color:#e1e4e8">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#d73a49">static</span><span style="color:#24292e"> </span><span style="color:#d73a49">int</span><span style="color:#24292e"> counter </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#005cc5">0</span><span style="color:#24292e">; </span></span>
<span class="line"><span style="color:#6a737d">//创建一个公共对象，作为对象锁的对象</span></span>
<span class="line"><span style="color:#d73a49">static</span><span style="color:#24292e"> </span><span style="color:#d73a49">final</span><span style="color:#24292e"> Object room </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Object</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e"> </span></span>
<span class="line"><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">static</span><span style="color:#24292e"> </span><span style="color:#d73a49">void</span><span style="color:#24292e"> </span><span style="color:#6f42c1">main</span><span style="color:#24292e">(</span><span style="color:#d73a49">String</span><span style="color:#24292e">[] args) throws InterruptedException {    </span></span>
<span class="line"><span style="color:#24292e">	Thread t1 </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Thread</span><span style="color:#24292e">(() </span><span style="color:#d73a49">-&gt;</span><span style="color:#24292e"> {        </span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">for</span><span style="color:#24292e"> (</span><span style="color:#d73a49">int</span><span style="color:#24292e"> i </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#005cc5">0</span><span style="color:#24292e">; i </span><span style="color:#d73a49">&lt;</span><span style="color:#24292e"> </span><span style="color:#005cc5">5000</span><span style="color:#24292e">; i</span><span style="color:#d73a49">++</span><span style="color:#24292e">) {            </span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">synchronized</span><span style="color:#24292e"> (room) {     </span></span>
<span class="line"><span style="color:#24292e">        counter</span><span style="color:#d73a49">++</span><span style="color:#24292e">;            </span></span>
<span class="line"><span style="color:#24292e">       	 }       </span></span>
<span class="line"><span style="color:#24292e"> 	   }    </span></span>
<span class="line"><span style="color:#24292e">    }, </span><span style="color:#032f62">"t1"</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e"> </span></span>
<span class="line"><span style="color:#24292e">    Thread t2 </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Thread</span><span style="color:#24292e">(() </span><span style="color:#d73a49">-&gt;</span><span style="color:#24292e"> {       </span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">for</span><span style="color:#24292e"> (</span><span style="color:#d73a49">int</span><span style="color:#24292e"> i </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#005cc5">0</span><span style="color:#24292e">; i </span><span style="color:#d73a49">&lt;</span><span style="color:#24292e"> </span><span style="color:#005cc5">5000</span><span style="color:#24292e">; i</span><span style="color:#d73a49">++</span><span style="color:#24292e">) {         </span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">synchronized</span><span style="color:#24292e"> (room) {            </span></span>
<span class="line"><span style="color:#24292e">            counter</span><span style="color:#d73a49">--</span><span style="color:#24292e">;          </span></span>
<span class="line"><span style="color:#24292e">            }    </span></span>
<span class="line"><span style="color:#24292e">        } </span></span>
<span class="line"><span style="color:#24292e">    }, </span><span style="color:#032f62">"t2"</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e"> </span></span>
<span class="line"><span style="color:#24292e">    t1.</span><span style="color:#6f42c1">start</span><span style="color:#24292e">();    </span></span>
<span class="line"><span style="color:#24292e">    t2.</span><span style="color:#6f42c1">start</span><span style="color:#24292e">(); </span></span>
<span class="line"><span style="color:#24292e">    t1.</span><span style="color:#6f42c1">join</span><span style="color:#24292e">();   </span></span>
<span class="line"><span style="color:#24292e">    t2.</span><span style="color:#6f42c1">join</span><span style="color:#24292e">();    </span></span>
<span class="line"><span style="color:#24292e">    log.</span><span style="color:#6f42c1">debug</span><span style="color:#24292e">(</span><span style="color:#032f62">"{}"</span><span style="color:#24292e">,counter); </span></span>
<span class="line"><span style="color:#24292e">}</span></span></code></pre></div><p>以上是面向过程的实现方式</p><figure><img src="https://jsd.cdn.zzko.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230712133454860.png" alt="image-20230712133454860" loading="lazy" decoding="async"></figure><p>你可以做这样的类比：</p><ul><li>synchronized(对象) 中的对象，可以想象为一个房间（room），有唯一入口（门）房间只能一次进入一人进行计算，线程 t1，t2 想象成两个人</li><li>当线程 t1 执行到 synchronized(room) 时就好比 t1 进入了这个房间，并锁住了门拿走了钥匙，在门内执行<code>count++</code> 代码</li><li>这时候如果 t2 也运行到了 <code>synchronized(room)</code> 时，它发现门被锁住了，只能在门外等待，发生了上下文切换，阻塞住了</li><li>这中间即使 t1 的 cpu 时间片不幸用完，被踢出了门外（不要错误理解为锁住了对象就能一直执行下去哦），这时门还是锁住的，t1 仍拿着钥匙，t2 线程还在阻塞状态进不来，只有下次轮到 t1 自己再次获得时间片时才能开门进入</li><li>当 t1 执行完 <code>synchronized{}</code> 块内的代码，这时候才会从 obj 房间出来并解开门上的锁，唤醒 t2 线程把钥匙给他。t2 线程这时才可以进入 obj 房间，锁住了门拿上钥匙，执行它的 <code>count--</code> 代码</li></ul><p>用图来表示</p><figure><img src="https://jsd.cdn.zzko.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230712133916562.png" alt="image-20230712133916562" loading="lazy" decoding="async"></figure><p><strong>思考</strong> synchronized 实际是用对象锁保证了临界区内代码的原子性，临界区内的代码对外是不可分割的，不会被线程切换所打断。为了加深理解，请思考下面的问题</p><ul><li>如果把 synchronized(obj) 放在 for 循环的外面，如何理解？<code>-- 原子性</code>循环体为以一整体运行</li><li>如果 t1 synchronized(obj1) 而 t2 synchronized(obj2) 会怎样运作？<code>-- 锁对象</code>不同的对象锁，各管各的，相当于没加锁</li><li>如果 t1 synchronized(obj) 而 t2 没有加会怎么样？如何理解？<code>-- 锁对象</code>相当于没加锁，依然出现临界区问题</li></ul><h4 id="_3-synchronized加在方法上" tabindex="-1">(3)synchronized加在方法上 <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20intermediate%20level#_3-synchronized加在方法上" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h4><ul><li><p>加在成员方法上</p><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">class</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Demo</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">	</span><span style="color:#6a737d">//在方法上加上synchronized关键字</span></span>
<span class="line"><span style="color:#e1e4e8">	</span><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">synchronized</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">void</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">test</span><span style="color:#e1e4e8">() {</span></span>
<span class="line"><span style="color:#e1e4e8">	</span></span>
<span class="line"><span style="color:#e1e4e8">	}</span></span>
<span class="line"><span style="color:#e1e4e8">	</span><span style="color:#6a737d">//等价于</span></span>
<span class="line"><span style="color:#e1e4e8">	</span><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">void</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">test</span><span style="color:#e1e4e8">() {</span></span>
<span class="line"><span style="color:#e1e4e8">		</span><span style="color:#f97583">synchronized</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">this</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">		</span></span>
<span class="line"><span style="color:#e1e4e8">		}</span></span>
<span class="line"><span style="color:#e1e4e8">	}</span></span>
<span class="line"><span style="color:#e1e4e8">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">class</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Demo</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">	</span><span style="color:#6a737d">//在方法上加上synchronized关键字</span></span>
<span class="line"><span style="color:#24292e">	</span><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">synchronized</span><span style="color:#24292e"> </span><span style="color:#d73a49">void</span><span style="color:#24292e"> </span><span style="color:#6f42c1">test</span><span style="color:#24292e">() {</span></span>
<span class="line"><span style="color:#24292e">	</span></span>
<span class="line"><span style="color:#24292e">	}</span></span>
<span class="line"><span style="color:#24292e">	</span><span style="color:#6a737d">//等价于</span></span>
<span class="line"><span style="color:#24292e">	</span><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">void</span><span style="color:#24292e"> </span><span style="color:#6f42c1">test</span><span style="color:#24292e">() {</span></span>
<span class="line"><span style="color:#24292e">		</span><span style="color:#d73a49">synchronized</span><span style="color:#24292e">(</span><span style="color:#005cc5">this</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">		</span></span>
<span class="line"><span style="color:#24292e">		}</span></span>
<span class="line"><span style="color:#24292e">	}</span></span>
<span class="line"><span style="color:#24292e">}</span></span></code></pre></div></li><li><p>加在静态方法上</p><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">class</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Demo</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">	</span><span style="color:#6a737d">//在静态方法上加上synchronized关键字</span></span>
<span class="line"><span style="color:#e1e4e8">	</span><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">synchronized</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">static</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">void</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">test</span><span style="color:#e1e4e8">() {</span></span>
<span class="line"><span style="color:#e1e4e8">	</span></span>
<span class="line"><span style="color:#e1e4e8">	}</span></span>
<span class="line"><span style="color:#e1e4e8">	</span><span style="color:#6a737d">//等价于</span></span>
<span class="line"><span style="color:#e1e4e8">	</span><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">void</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">test</span><span style="color:#e1e4e8">() {</span></span>
<span class="line"><span style="color:#e1e4e8">		</span><span style="color:#f97583">synchronized</span><span style="color:#e1e4e8">(Demo.class) {</span></span>
<span class="line"><span style="color:#e1e4e8">		</span></span>
<span class="line"><span style="color:#e1e4e8">		}</span></span>
<span class="line"><span style="color:#e1e4e8">	}</span></span>
<span class="line"><span style="color:#e1e4e8">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">class</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Demo</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">	</span><span style="color:#6a737d">//在静态方法上加上synchronized关键字</span></span>
<span class="line"><span style="color:#24292e">	</span><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">synchronized</span><span style="color:#24292e"> </span><span style="color:#d73a49">static</span><span style="color:#24292e"> </span><span style="color:#d73a49">void</span><span style="color:#24292e"> </span><span style="color:#6f42c1">test</span><span style="color:#24292e">() {</span></span>
<span class="line"><span style="color:#24292e">	</span></span>
<span class="line"><span style="color:#24292e">	}</span></span>
<span class="line"><span style="color:#24292e">	</span><span style="color:#6a737d">//等价于</span></span>
<span class="line"><span style="color:#24292e">	</span><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">void</span><span style="color:#24292e"> </span><span style="color:#6f42c1">test</span><span style="color:#24292e">() {</span></span>
<span class="line"><span style="color:#24292e">		</span><span style="color:#d73a49">synchronized</span><span style="color:#24292e">(Demo.class) {</span></span>
<span class="line"><span style="color:#24292e">		</span></span>
<span class="line"><span style="color:#24292e">		}</span></span>
<span class="line"><span style="color:#24292e">	}</span></span>
<span class="line"><span style="color:#24292e">}</span></span></code></pre></div></li></ul><h3 id="_3、变量的线程安全分析" tabindex="-1">3、变量的线程安全分析 <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20intermediate%20level#_3、变量的线程安全分析" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h3><h4 id="成员变量和静态变量是否线程安全" tabindex="-1">成员变量和静态变量是否线程安全？ <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20intermediate%20level#成员变量和静态变量是否线程安全" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h4><ul><li>如果它们没有共享，则线程安全</li><li>如果它们被共享了，根据它们的状态是否能够改变，又分两种情况<ul><li>如果只有读操作，则线程安全</li><li>如果有读写操作，则这段代码是临界区，需要考虑线程安全</li></ul></li></ul><h4 id="局部变量是否线程安全" tabindex="-1">局部变量是否线程安全？ <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20intermediate%20level#局部变量是否线程安全" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h4><ul><li><p>局部变量是线程安全的</p></li><li><p>但局部变量引用的对象则未必 （要看该对象</p><p>是否被共享</p><p>且被执行了读写操作）</p><ul><li>如果该对象没有逃离方法的作用范围，它是线程安全的</li><li>如果该对象逃离方法的作用范围，需要考虑线程安全</li></ul></li><li><p>局部变量是线程安全的——每个方法都在对应线程的栈中创建栈帧，不会被其他线程共享</p></li></ul><figure><img src="https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/20200608144636.png" alt="img" loading="lazy" decoding="async"></figure><ul><li>如果调用的对象被共享，且执行了读写操作，则<strong>线程不安全</strong></li></ul><figure><img src="https://jsd.cdn.zzko.cn/gh/imLKlauS/blog-picture@main/blogs/20200608144649.png" alt="img" loading="lazy" decoding="async"></figure><ul><li>如果是局部变量，则会在堆中创建对应的对象，不会存在线程安全问题。</li></ul><figure><img src="https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/20200608144702.png" alt="img" loading="lazy" decoding="async"></figure><h4 id="常见线程安全类" tabindex="-1">常见线程安全类 <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20intermediate%20level#常见线程安全类" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h4><ul><li>String</li><li>Integer</li><li>StringBuﬀer</li><li>Random</li><li>Vector （List的线程安全实现类）</li><li>Hashtable （Hash的线程安全实现类）</li><li>java.util.concurrent 包下的类</li></ul><p>这里说它们是线程安全的是指，多个线程调用它们<strong>同一个实例的某个方法时</strong>，是线程安全的</p><ul><li>它们的每个方法是原子的（都被加上了synchronized）</li><li>但注意它们<strong>多个方法的组合不是原子的</strong>，所以可能会出现线程安全问题</li></ul><figure><img src="https://jsd.cdn.zzko.cn/gh/imLKlauS/blog-picture@main/blogs/20200608144903.png" alt="img" loading="lazy" decoding="async"></figure><h4 id="不可变类线程安全性" tabindex="-1">不可变类线程安全性 <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20intermediate%20level#不可变类线程安全性" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h4><p>String、Integer 等都是<strong>不可变类</strong>，因为其内部的状态不可以改变，因此它们的方法都是线程安全的</p><p>有同学或许有疑问，String 有 replace，substring 等方法【可以】改变值啊，那么这些方法又是如何保证线程安 全的呢？</p><p>这是因为这些方法的返回值都<strong>创建了一个新的对象</strong>，而不是直接改变String、Integer对象本身。</p><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">abstract</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">class</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Test</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">void</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">bar</span><span style="color:#e1e4e8">() {</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#6a737d">// 是否安全</span></span>
<span class="line"><span style="color:#e1e4e8">        SimpleDateFormat sdf </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">SimpleDateFormat</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"yyyy-MM-dd HH:mm:ss"</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#b392f0">foo</span><span style="color:#e1e4e8">(sdf);</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">abstract</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">foo</span><span style="color:#e1e4e8">(SimpleDateFormat </span><span style="color:#ffab70">sdf</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">static</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">void</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">main</span><span style="color:#e1e4e8">(</span><span style="color:#f97583">String</span><span style="color:#e1e4e8">[] </span><span style="color:#ffab70">args</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">    	</span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Test</span><span style="color:#e1e4e8">().</span><span style="color:#b392f0">bar</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"><span style="color:#e1e4e8">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">abstract</span><span style="color:#24292e"> </span><span style="color:#d73a49">class</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Test</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">void</span><span style="color:#24292e"> </span><span style="color:#6f42c1">bar</span><span style="color:#24292e">() {</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6a737d">// 是否安全</span></span>
<span class="line"><span style="color:#24292e">        SimpleDateFormat sdf </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">SimpleDateFormat</span><span style="color:#24292e">(</span><span style="color:#032f62">"yyyy-MM-dd HH:mm:ss"</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6f42c1">foo</span><span style="color:#24292e">(sdf);</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">abstract</span><span style="color:#24292e"> </span><span style="color:#6f42c1">foo</span><span style="color:#24292e">(SimpleDateFormat </span><span style="color:#e36209">sdf</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">static</span><span style="color:#24292e"> </span><span style="color:#d73a49">void</span><span style="color:#24292e"> </span><span style="color:#6f42c1">main</span><span style="color:#24292e">(</span><span style="color:#d73a49">String</span><span style="color:#24292e">[] </span><span style="color:#e36209">args</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">    	</span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Test</span><span style="color:#24292e">().</span><span style="color:#6f42c1">bar</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"><span style="color:#24292e">}</span></span></code></pre></div><p>其中 foo 的行为是不确定的，可能导致不安全的发生，被称之为外星方法</p><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">void</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">foo</span><span style="color:#e1e4e8">(SimpleDateFormat sdf) {</span></span>
<span class="line"><span style="color:#e1e4e8">    String dateStr </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#9ecbff">"1999-10-11 00:00:00"</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">for</span><span style="color:#e1e4e8"> (</span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> i </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8">; i </span><span style="color:#f97583">&lt;</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">20</span><span style="color:#e1e4e8">; i</span><span style="color:#f97583">++</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Thread</span><span style="color:#e1e4e8">(() </span><span style="color:#f97583">-&gt;</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">try</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">            	sdf.</span><span style="color:#b392f0">parse</span><span style="color:#e1e4e8">(dateStr);</span></span>
<span class="line"><span style="color:#e1e4e8">            } </span><span style="color:#f97583">catch</span><span style="color:#e1e4e8"> (ParseException </span><span style="color:#ffab70">e</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">            	e.</span><span style="color:#b392f0">printStackTrace</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">            }</span></span>
<span class="line"><span style="color:#e1e4e8">        }).</span><span style="color:#b392f0">start</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"><span style="color:#e1e4e8">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">void</span><span style="color:#24292e"> </span><span style="color:#6f42c1">foo</span><span style="color:#24292e">(SimpleDateFormat sdf) {</span></span>
<span class="line"><span style="color:#24292e">    String dateStr </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#032f62">"1999-10-11 00:00:00"</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">for</span><span style="color:#24292e"> (</span><span style="color:#d73a49">int</span><span style="color:#24292e"> i </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#005cc5">0</span><span style="color:#24292e">; i </span><span style="color:#d73a49">&lt;</span><span style="color:#24292e"> </span><span style="color:#005cc5">20</span><span style="color:#24292e">; i</span><span style="color:#d73a49">++</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Thread</span><span style="color:#24292e">(() </span><span style="color:#d73a49">-&gt;</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">try</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">            	sdf.</span><span style="color:#6f42c1">parse</span><span style="color:#24292e">(dateStr);</span></span>
<span class="line"><span style="color:#24292e">            } </span><span style="color:#d73a49">catch</span><span style="color:#24292e"> (ParseException </span><span style="color:#e36209">e</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">            	e.</span><span style="color:#6f42c1">printStackTrace</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">            }</span></span>
<span class="line"><span style="color:#24292e">        }).</span><span style="color:#6f42c1">start</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"><span style="color:#24292e">}</span></span></code></pre></div><p>请比较 JDK 中 String 类的实现</p><blockquote><p>如果String类不设计为final的话，那它的子类就可能覆盖掉String中父类的一些行为，导致不安全的发生</p></blockquote><h3 id="_4、monitor概念" tabindex="-1">4、Monitor概念 <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20intermediate%20level#_4、monitor概念" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h3><h4 id="_1-java对象头" tabindex="-1">(1)Java对象头 <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20intermediate%20level#_1-java对象头" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h4><p>以 32 位虚拟机为例</p><p>普通对象</p><blockquote><p>1字节 = 8 ⽐特 Integer 占 8（对象头）+4（要有一个value来存储int的4个字节(转换时用到)）字节，引用类型占用空间大 32位虚拟机普通对象对象头<code>64bits(8*8byte)</code> int 占 4 字节</p></blockquote><figure><img src="https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230712141833301.png" alt="image-20230712141833301" loading="lazy" decoding="async"></figure><p>数组对象</p><figure><img src="https://jsd.cdn.zzko.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230712141844467.png" alt="image-20230712141844467" loading="lazy" decoding="async"></figure><p>其中 Mark Word 结构为</p><figure><img src="https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230712141854417.png" alt="image-20230712141854417" loading="lazy" decoding="async"></figure><p>64 位虚拟机 Mark Word</p><figure><img src="https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230712141907430.png" alt="image-20230712141907430" loading="lazy" decoding="async"></figure><blockquote><p><strong>参考资料</strong></p><p><a target="_blank" rel="noreferrer" href="https://stackoverflow.com/questions/26357186/what-is-in-java-object-header"><!--[-->https://stackoverflow.com/questions/26357186/what-is-in-java-object-header<!--]--><!----></a></p></blockquote><h4 id="_2-原理之monitor" tabindex="-1">(2)原理之Monitor <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20intermediate%20level#_2-原理之monitor" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h4><p>Monitor 被翻译为<strong>监视器</strong>或<strong>管程</strong> 每个 Java 对象都可以关联一个 Monitor 对象，如果使用 synchronized 给对象上锁（重量级）之后，该对象头的 Mark Word 中就被设置指向 Monitor 对象的指针 Monitor 结构如下</p><figure><img src="https://jsd.cdn.zzko.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230712155102089.png" alt="image-20230712155102089" loading="lazy" decoding="async"></figure><figure><img src="https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/20200608144917.png" alt="img" loading="lazy" decoding="async"></figure><ul><li><p>当线程执行到临界区代码时，如果使用了synchronized，会先查询synchronized中所指定的对象(obj)<strong>是否绑定了Monitor</strong>。</p><ul><li><p>如果<strong>没有绑定</strong>，则会先去与Monitor绑定，并且将Owner设为当前线程。</p></li><li><p>如果已经绑定，则会去查询该Monitor是否已经有了Owner</p><ul><li>如果没有，则Owner与将当前线程绑定</li></ul></li><li><p>如果有，则放入EntryList，进入阻塞状态(blocked)</p></li></ul></li><li><p>当Monitor的Owner将临界区中代码执行完毕后，Owner便会被清空，此时EntryList中处于<strong>阻塞</strong>状态的线程会被<strong>叫醒并竞争</strong>，此时的竞争是<strong>非公平的</strong></p></li><li><p><strong>注意</strong>：</p><ul><li>对象在使用了synchronized后与Monitor绑定时，会将对象头中的<strong>Mark Word</strong>置为Monitor指针。</li><li>每个对象都会绑定一个<strong>唯一的Monitor</strong>，如果synchronized中所指定的对象(obj)<strong>不同</strong>，则会绑定<strong>不同</strong>的Monitor</li></ul></li></ul><h3 id="_5、synchronized原理进阶" tabindex="-1">5、Synchronized原理进阶 <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20intermediate%20level#_5、synchronized原理进阶" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h3><figure><img src="https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230712141422017.png" alt="image-20230712141422017" loading="lazy" decoding="async"></figure><p>对应字节码：</p><figure><img src="https://jsd.cdn.zzko.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230712141514931.png" alt="image-20230712141514931" loading="lazy" decoding="async"></figure><h4 id="_1-轻量级锁-用于优化monitor这类的重量级锁" tabindex="-1">(1)轻量级锁（用于优化Monitor这类的重量级锁） <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20intermediate%20level#_1-轻量级锁-用于优化monitor这类的重量级锁" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h4><p><strong>轻量级锁使用场景：<strong>当一个对象被多个线程所访问，但访问的时间是</strong>错开的（不存在竞争）</strong>，此时就可以使用<strong>轻量级锁</strong>来优化。</p><ul><li><p>创建<strong>锁记录</strong>（Lock Record）对象，每个线程的栈帧都会包含一个锁记录对象，内部可以存储锁定对象的mark word（不再一开始就使用Monitor）</p><figure><img src="https://jsd.cdn.zzko.cn/gh/imLKlauS/blog-picture@main/blogs/20200608144942.png" alt="img" loading="lazy" decoding="async"></figure></li><li><p>让锁记录中的Object reference指向锁对象（Object），并尝试用cas去替换Object中的mark word，将此mark word放入lock record中保存</p></li></ul><figure><img src="https://jsd.cdn.zzko.cn/gh/imLKlauS/blog-picture@main/blogs/20200608144950.png" alt="img" loading="lazy" decoding="async"></figure><ul><li>如果cas替换成功，则将Object的对象头替换为<strong>锁记录的地址</strong>和<strong>状态 00（轻量级锁状态）</strong>，并由该线程给对象加锁</li></ul><figure><img src="https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/20200608144957.png" alt="img" loading="lazy" decoding="async"></figure><ul><li>如果 cas 失败，有两种情况<ul><li>如果是其它线程已经持有了该 Object 的轻量级锁，这时表明有竞争，进入锁膨胀过程</li><li>如果是自己执行了 synchronized 锁重入，那么再添加一条 Lock Record 作为重入的计数</li></ul></li></ul><figure><img src="https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230712155321048.png" alt="image-20230712155321048" loading="lazy" decoding="async"></figure><ul><li>当退出 synchronized 代码块（解锁时）如果有取值为 null 的锁记录，表示有重入，这时重置锁记录，表示重入计数减一</li></ul><figure><img src="https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230712155353278.png" alt="image-20230712155353278" loading="lazy" decoding="async"></figure><ul><li>当退出 synchronized 代码块（解锁时）锁记录的值不为 null，这时使用 cas 将 Mark Word 的值恢复给对象头<ul><li>成功，则解锁成功</li><li>失败，说明轻量级锁进行了锁膨胀或已经升级为重量级锁，进入重量级锁解锁流程</li></ul></li></ul><h4 id="_2-锁膨胀" tabindex="-1">(2)锁膨胀 <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20intermediate%20level#_2-锁膨胀" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h4><ul><li>如果一个线程（Thread-1）在给一个对象加轻量级锁时，<strong>cas替换操作失败</strong>（因为此时其他线程已经给对象加了轻量级锁），此时该线程就会进入<strong>锁膨胀</strong>过程</li></ul><figure><img src="https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/20200608145004.png" alt="img" loading="lazy" decoding="async"></figure><ul><li><p>此时便会给对象加上重量级锁（使用Monitor）</p><ul><li><p>将对象头的Mark Word改为Monitor的地址，并且状态改为01(重量级锁)</p></li><li><p>并且将该线程放入EntryList中，并进入阻塞状态(blocked)</p><figure><img src="https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/20200608145148.png" alt="img" loading="lazy" decoding="async"></figure></li></ul></li><li><p>当 Thread-0 退出同步块解锁时，使用cas将 Mark Word 的值恢复给对象头，失败。这时会进入重量级解锁流程，即按照 Monitor 地址找到 Monitor 对象，设置 Owner 为 null，唤醒 EntryList 中 BLOCKED 线程</p></li></ul><h4 id="_3-自旋优化" tabindex="-1">(3)自旋优化 <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20intermediate%20level#_3-自旋优化" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h4><p><strong>重量级锁</strong>竞争时，还可以使用自选来优化，如果当前线程在<strong>自旋成功</strong>（使用锁的线程退出了同步块，<strong>释放了锁</strong>），这时就可以避免线程进入阻塞状态（避免上下文切换）。</p><ul><li>第一种情况</li></ul><figure><img src="https://jsd.cdn.zzko.cn/gh/imLKlauS/blog-picture@main/blogs/20200608145136.png" alt="img" loading="lazy" decoding="async"></figure><ul><li>第二种情况</li></ul><figure><img src="https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/20200608145125.png" alt="img" loading="lazy" decoding="async"></figure><ul><li>自旋会占用 CPU 时间，单核 CPU 自旋就是浪费，多核 CPU 自旋才能发挥优势。</li><li>在 Java 6 之后自旋锁是自适应的，比如对象刚刚的一次自旋操作成功过，那么认为这次自旋成功的可能性会</li><li>高，就多自旋几次；反之，就少自旋甚至不自旋，总之，比较智能。</li><li>Java 7 之后不能控制是否开启自旋功能</li></ul><h4 id="_4-偏向锁-用于优化轻量级锁重入" tabindex="-1">(4)偏向锁(用于优化轻量级锁重入) <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20intermediate%20level#_4-偏向锁-用于优化轻量级锁重入" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h4><p>轻量级锁在没有竞争时，每次<strong>重入</strong>（该线程执行的方法中再次锁住该对象）操作仍需要cas替换操作，这样是会使性能降低的。</p><p>所以JDK1.6引入了<strong>偏向锁</strong>对性能进行优化：在<strong>第一次</strong>cas时会将<strong>线程的ID</strong>写入对象的Mark Word中。此后发现这个线程ID就是自己的，就表示没有竞争，就不需要再次cas，以后只要不发生竞争，这个对象就归该线程所有。</p><figure><img src="https://jsd.cdn.zzko.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230712154420092.png" alt="image-20230712154420092" loading="lazy" decoding="async"></figure><figure><img src="https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230712154150202.png" alt="image-20230712154150202" loading="lazy" decoding="async"></figure><p>只有第一次设置对象头时才进行CAS操作（类似于刻名字）</p><figure><img src="https://jsd.cdn.zzko.cn/gh/imLKlauS/blog-picture@main/blogs/20200608145109.png" alt="img" loading="lazy" decoding="async"></figure><h5 id="偏向状态" tabindex="-1">偏向状态 <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20intermediate%20level#偏向状态" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h5><ul><li>Normal：一般状态，没有加任何锁，前面62位保存的是对象的信息，<strong>最后2位为状态（01），倒数第三位表示是否使用偏向锁（未使用：0）</strong></li><li>Biased：偏向状态，使用偏向锁，前面54位保存的当前线程的ID，<strong>最后2位为状态（01），倒数第三位表示是否使用偏向锁（使用：1）</strong></li><li>Lightweight：使用轻量级锁，前62位保存的是锁记录的指针，<strong>最后两位为状态（00）</strong></li><li>Heavyweight：使用重量级锁，前62位保存的是Monitor的地址指针，<strong>后两位为状态(10)</strong></li></ul><figure><img src="https://jsd.cdn.zzko.cn/gh/imLKlauS/blog-picture@main/blogs/20200608145101.png" alt="img" loading="lazy" decoding="async"></figure><p>一个对象创建时：</p><ul><li>如果开启了偏向锁（默认开启），那么对象创建后，markword 值为 0x05 即最后 3 位为 101，这时它的 thread、epoch、age 都为 0</li><li>偏向锁是默认是延迟的，不会在程序启动时立即生效，如果想避免延迟，可以加 VM 参数 - XX:BiasedLockingStartupDelay=0 来禁用延迟</li><li>如果没有开启偏向锁，那么对象创建后，markword 值为 0x01 即最后 3 位为 001，这时它的 hashcode、 age 都为 0，第一次用到 hashcode 时才会赋值</li></ul><h5 id="撤销偏向" tabindex="-1">撤销偏向 <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20intermediate%20level#撤销偏向" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h5><p>以下几种情况会使对象的偏向锁失效</p><ul><li><p>调用对象的hashCode方法</p><ul><li><p>调用了对象的 hashCode，但偏向锁的对象 MarkWord 中存储的是线程 id，如果调用 hashCode 会导致偏向锁被撤销，因为对象头里 Mark Word 存储线程Id用了54位，剩余空间不够存储hash值(31位)了</p><ul><li><p>轻量级锁会在锁记录中记录 hashCode</p></li><li><p>重量级锁会在 Monitor 中记录 hashCode</p></li></ul></li></ul></li><li><p>多个线程使用该对象（当有其它线程使用偏向锁对象时，会将偏向锁升级为轻量级锁）</p></li><li><p><strong>调用了wait/notify方法</strong>（wait/notify只有重量级锁才有，调用wait/notify方法会导致轻量级锁或偏向锁膨胀而使用<strong>重量级锁</strong>）</p></li></ul><h5 id="批量重偏向" tabindex="-1">批量重偏向 <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20intermediate%20level#批量重偏向" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h5><ul><li>如果对象虽然被多个线程访问，但是线程间不存在竞争，这时偏向T1的对象仍有机会重新偏向T2<ul><li>重偏向会重置Thread ID</li></ul></li><li>当撤销超过20次后（超过阈值），JVM会觉得是不是偏向错了，这时会在给对象加锁时，重新偏向至加锁线程。</li></ul><h5 id="批量撤销" tabindex="-1">批量撤销 <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20intermediate%20level#批量撤销" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h5><p>当撤销偏向锁阈值超过 40 次后，jvm 会这样觉得，自己确实偏向错了，根本就不该偏向。于是整个类的所有对象 都会变为不可偏向的，新建的对象也是不可偏向的</p><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#f97583">static</span><span style="color:#e1e4e8"> Thread t1,t2,t3;</span></span>
<span class="line"><span style="color:#f97583">private</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">static</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">void</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">test4</span><span style="color:#e1e4e8">() throws InterruptedException {</span></span>
<span class="line"><span style="color:#e1e4e8">    Vector&lt;</span><span style="color:#f97583">Dog</span><span style="color:#e1e4e8">&gt; list </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> Vector&lt;&gt;();</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> loopNumber </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">39</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">    t1 </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Thread</span><span style="color:#e1e4e8">(() </span><span style="color:#f97583">-&gt;</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">for</span><span style="color:#e1e4e8"> (</span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> i </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8">; i </span><span style="color:#f97583">&lt;</span><span style="color:#e1e4e8"> loopNumber; i</span><span style="color:#f97583">++</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">            Dog d </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Dog</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">            list.</span><span style="color:#b392f0">add</span><span style="color:#e1e4e8">(d);</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">synchronized</span><span style="color:#e1e4e8"> (d) {</span></span>
<span class="line"><span style="color:#e1e4e8">                log.</span><span style="color:#b392f0">debug</span><span style="color:#e1e4e8">(i </span><span style="color:#f97583">+</span><span style="color:#e1e4e8"> </span><span style="color:#9ecbff">"</span><span style="color:#79b8ff">\t</span><span style="color:#9ecbff">"</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">+</span><span style="color:#e1e4e8"> ClassLayout.</span><span style="color:#b392f0">parseInstance</span><span style="color:#e1e4e8">(d).</span><span style="color:#b392f0">toPrintableSimple</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">true</span><span style="color:#e1e4e8">));</span></span>
<span class="line"><span style="color:#e1e4e8">            }</span></span>
<span class="line"><span style="color:#e1e4e8">        }</span></span>
<span class="line"><span style="color:#e1e4e8">        LockSupport.</span><span style="color:#b392f0">unpark</span><span style="color:#e1e4e8">(t2);</span></span>
<span class="line"><span style="color:#e1e4e8">    }, </span><span style="color:#9ecbff">"t1"</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">    t1.</span><span style="color:#b392f0">start</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">    t2 </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Thread</span><span style="color:#e1e4e8">(() </span><span style="color:#f97583">-&gt;</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">        LockSupport.</span><span style="color:#b392f0">park</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">        log.</span><span style="color:#b392f0">debug</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"===============&gt; "</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">for</span><span style="color:#e1e4e8"> (</span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> i </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8">; i </span><span style="color:#f97583">&lt;</span><span style="color:#e1e4e8"> loopNumber; i</span><span style="color:#f97583">++</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">            Dog d </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> list.</span><span style="color:#b392f0">get</span><span style="color:#e1e4e8">(i);</span></span>
<span class="line"><span style="color:#e1e4e8">            log.</span><span style="color:#b392f0">debug</span><span style="color:#e1e4e8">(i </span><span style="color:#f97583">+</span><span style="color:#e1e4e8"> </span><span style="color:#9ecbff">"</span><span style="color:#79b8ff">\t</span><span style="color:#9ecbff">"</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">+</span><span style="color:#e1e4e8"> ClassLayout.</span><span style="color:#b392f0">parseInstance</span><span style="color:#e1e4e8">(d).</span><span style="color:#b392f0">toPrintableSimple</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">true</span><span style="color:#e1e4e8">));</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">synchronized</span><span style="color:#e1e4e8"> (d) {</span></span>
<span class="line"><span style="color:#e1e4e8">            	log.</span><span style="color:#b392f0">debug</span><span style="color:#e1e4e8">(i </span><span style="color:#f97583">+</span><span style="color:#e1e4e8"> </span><span style="color:#9ecbff">"</span><span style="color:#79b8ff">\t</span><span style="color:#9ecbff">"</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">+</span><span style="color:#e1e4e8"> ClassLayout.</span><span style="color:#b392f0">parseInstance</span><span style="color:#e1e4e8">(d).</span><span style="color:#b392f0">toPrintableSimple</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">true</span><span style="color:#e1e4e8">));</span></span>
<span class="line"><span style="color:#e1e4e8">            }</span></span>
<span class="line"><span style="color:#e1e4e8">            log.</span><span style="color:#b392f0">debug</span><span style="color:#e1e4e8">(i </span><span style="color:#f97583">+</span><span style="color:#e1e4e8"> </span><span style="color:#9ecbff">"</span><span style="color:#79b8ff">\t</span><span style="color:#9ecbff">"</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">+</span><span style="color:#e1e4e8"> ClassLayout.</span><span style="color:#b392f0">parseInstance</span><span style="color:#e1e4e8">(d).</span><span style="color:#b392f0">toPrintableSimple</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">true</span><span style="color:#e1e4e8">));</span></span>
<span class="line"><span style="color:#e1e4e8">        }</span></span>
<span class="line"><span style="color:#e1e4e8">        LockSupport.</span><span style="color:#b392f0">unpark</span><span style="color:#e1e4e8">(t3);</span></span>
<span class="line"><span style="color:#e1e4e8">    }, </span><span style="color:#9ecbff">"t2"</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">    t2.</span><span style="color:#b392f0">start</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">    t3 </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Thread</span><span style="color:#e1e4e8">(() </span><span style="color:#f97583">-&gt;</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">        LockSupport.</span><span style="color:#b392f0">park</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">        log.</span><span style="color:#b392f0">debug</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"===============&gt; "</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">for</span><span style="color:#e1e4e8"> (</span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> i </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8">; i </span><span style="color:#f97583">&lt;</span><span style="color:#e1e4e8"> loopNumber; i</span><span style="color:#f97583">++</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">            Dog d </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> list.</span><span style="color:#b392f0">get</span><span style="color:#e1e4e8">(i);</span></span>
<span class="line"><span style="color:#e1e4e8">            log.</span><span style="color:#b392f0">debug</span><span style="color:#e1e4e8">(i </span><span style="color:#f97583">+</span><span style="color:#e1e4e8"> </span><span style="color:#9ecbff">"</span><span style="color:#79b8ff">\t</span><span style="color:#9ecbff">"</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">+</span><span style="color:#e1e4e8"> ClassLayout.</span><span style="color:#b392f0">parseInstance</span><span style="color:#e1e4e8">(d).</span><span style="color:#b392f0">toPrintableSimple</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">true</span><span style="color:#e1e4e8">));</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">synchronized</span><span style="color:#e1e4e8"> (d) {</span></span>
<span class="line"><span style="color:#e1e4e8">            	log.</span><span style="color:#b392f0">debug</span><span style="color:#e1e4e8">(i </span><span style="color:#f97583">+</span><span style="color:#e1e4e8"> </span><span style="color:#9ecbff">"</span><span style="color:#79b8ff">\t</span><span style="color:#9ecbff">"</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">+</span><span style="color:#e1e4e8"> ClassLayout.</span><span style="color:#b392f0">parseInstance</span><span style="color:#e1e4e8">(d).</span><span style="color:#b392f0">toPrintableSimple</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">true</span><span style="color:#e1e4e8">));</span></span>
<span class="line"><span style="color:#e1e4e8">            }</span></span>
<span class="line"><span style="color:#e1e4e8">            log.</span><span style="color:#b392f0">debug</span><span style="color:#e1e4e8">(i </span><span style="color:#f97583">+</span><span style="color:#e1e4e8"> </span><span style="color:#9ecbff">"</span><span style="color:#79b8ff">\t</span><span style="color:#9ecbff">"</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">+</span><span style="color:#e1e4e8"> ClassLayout.</span><span style="color:#b392f0">parseInstance</span><span style="color:#e1e4e8">(d).</span><span style="color:#b392f0">toPrintableSimple</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">true</span><span style="color:#e1e4e8">));</span></span>
<span class="line"><span style="color:#e1e4e8">        }</span></span>
<span class="line"><span style="color:#e1e4e8">    }, </span><span style="color:#9ecbff">"t3"</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">    t3.</span><span style="color:#b392f0">start</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">    t3.</span><span style="color:#b392f0">join</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">    log.</span><span style="color:#b392f0">debug</span><span style="color:#e1e4e8">(ClassLayout.</span><span style="color:#b392f0">parseInstance</span><span style="color:#e1e4e8">(</span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Dog</span><span style="color:#e1e4e8">()).</span><span style="color:#b392f0">toPrintableSimple</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">true</span><span style="color:#e1e4e8">));</span></span>
<span class="line"><span style="color:#e1e4e8">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#d73a49">static</span><span style="color:#24292e"> Thread t1,t2,t3;</span></span>
<span class="line"><span style="color:#d73a49">private</span><span style="color:#24292e"> </span><span style="color:#d73a49">static</span><span style="color:#24292e"> </span><span style="color:#d73a49">void</span><span style="color:#24292e"> </span><span style="color:#6f42c1">test4</span><span style="color:#24292e">() throws InterruptedException {</span></span>
<span class="line"><span style="color:#24292e">    Vector&lt;</span><span style="color:#d73a49">Dog</span><span style="color:#24292e">&gt; list </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> Vector&lt;&gt;();</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">int</span><span style="color:#24292e"> loopNumber </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#005cc5">39</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">    t1 </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Thread</span><span style="color:#24292e">(() </span><span style="color:#d73a49">-&gt;</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">for</span><span style="color:#24292e"> (</span><span style="color:#d73a49">int</span><span style="color:#24292e"> i </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#005cc5">0</span><span style="color:#24292e">; i </span><span style="color:#d73a49">&lt;</span><span style="color:#24292e"> loopNumber; i</span><span style="color:#d73a49">++</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">            Dog d </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Dog</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">            list.</span><span style="color:#6f42c1">add</span><span style="color:#24292e">(d);</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">synchronized</span><span style="color:#24292e"> (d) {</span></span>
<span class="line"><span style="color:#24292e">                log.</span><span style="color:#6f42c1">debug</span><span style="color:#24292e">(i </span><span style="color:#d73a49">+</span><span style="color:#24292e"> </span><span style="color:#032f62">"</span><span style="color:#005cc5">\t</span><span style="color:#032f62">"</span><span style="color:#24292e"> </span><span style="color:#d73a49">+</span><span style="color:#24292e"> ClassLayout.</span><span style="color:#6f42c1">parseInstance</span><span style="color:#24292e">(d).</span><span style="color:#6f42c1">toPrintableSimple</span><span style="color:#24292e">(</span><span style="color:#005cc5">true</span><span style="color:#24292e">));</span></span>
<span class="line"><span style="color:#24292e">            }</span></span>
<span class="line"><span style="color:#24292e">        }</span></span>
<span class="line"><span style="color:#24292e">        LockSupport.</span><span style="color:#6f42c1">unpark</span><span style="color:#24292e">(t2);</span></span>
<span class="line"><span style="color:#24292e">    }, </span><span style="color:#032f62">"t1"</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">    t1.</span><span style="color:#6f42c1">start</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">    t2 </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Thread</span><span style="color:#24292e">(() </span><span style="color:#d73a49">-&gt;</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">        LockSupport.</span><span style="color:#6f42c1">park</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">        log.</span><span style="color:#6f42c1">debug</span><span style="color:#24292e">(</span><span style="color:#032f62">"===============&gt; "</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">for</span><span style="color:#24292e"> (</span><span style="color:#d73a49">int</span><span style="color:#24292e"> i </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#005cc5">0</span><span style="color:#24292e">; i </span><span style="color:#d73a49">&lt;</span><span style="color:#24292e"> loopNumber; i</span><span style="color:#d73a49">++</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">            Dog d </span><span style="color:#d73a49">=</span><span style="color:#24292e"> list.</span><span style="color:#6f42c1">get</span><span style="color:#24292e">(i);</span></span>
<span class="line"><span style="color:#24292e">            log.</span><span style="color:#6f42c1">debug</span><span style="color:#24292e">(i </span><span style="color:#d73a49">+</span><span style="color:#24292e"> </span><span style="color:#032f62">"</span><span style="color:#005cc5">\t</span><span style="color:#032f62">"</span><span style="color:#24292e"> </span><span style="color:#d73a49">+</span><span style="color:#24292e"> ClassLayout.</span><span style="color:#6f42c1">parseInstance</span><span style="color:#24292e">(d).</span><span style="color:#6f42c1">toPrintableSimple</span><span style="color:#24292e">(</span><span style="color:#005cc5">true</span><span style="color:#24292e">));</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">synchronized</span><span style="color:#24292e"> (d) {</span></span>
<span class="line"><span style="color:#24292e">            	log.</span><span style="color:#6f42c1">debug</span><span style="color:#24292e">(i </span><span style="color:#d73a49">+</span><span style="color:#24292e"> </span><span style="color:#032f62">"</span><span style="color:#005cc5">\t</span><span style="color:#032f62">"</span><span style="color:#24292e"> </span><span style="color:#d73a49">+</span><span style="color:#24292e"> ClassLayout.</span><span style="color:#6f42c1">parseInstance</span><span style="color:#24292e">(d).</span><span style="color:#6f42c1">toPrintableSimple</span><span style="color:#24292e">(</span><span style="color:#005cc5">true</span><span style="color:#24292e">));</span></span>
<span class="line"><span style="color:#24292e">            }</span></span>
<span class="line"><span style="color:#24292e">            log.</span><span style="color:#6f42c1">debug</span><span style="color:#24292e">(i </span><span style="color:#d73a49">+</span><span style="color:#24292e"> </span><span style="color:#032f62">"</span><span style="color:#005cc5">\t</span><span style="color:#032f62">"</span><span style="color:#24292e"> </span><span style="color:#d73a49">+</span><span style="color:#24292e"> ClassLayout.</span><span style="color:#6f42c1">parseInstance</span><span style="color:#24292e">(d).</span><span style="color:#6f42c1">toPrintableSimple</span><span style="color:#24292e">(</span><span style="color:#005cc5">true</span><span style="color:#24292e">));</span></span>
<span class="line"><span style="color:#24292e">        }</span></span>
<span class="line"><span style="color:#24292e">        LockSupport.</span><span style="color:#6f42c1">unpark</span><span style="color:#24292e">(t3);</span></span>
<span class="line"><span style="color:#24292e">    }, </span><span style="color:#032f62">"t2"</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">    t2.</span><span style="color:#6f42c1">start</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">    t3 </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Thread</span><span style="color:#24292e">(() </span><span style="color:#d73a49">-&gt;</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">        LockSupport.</span><span style="color:#6f42c1">park</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">        log.</span><span style="color:#6f42c1">debug</span><span style="color:#24292e">(</span><span style="color:#032f62">"===============&gt; "</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">for</span><span style="color:#24292e"> (</span><span style="color:#d73a49">int</span><span style="color:#24292e"> i </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#005cc5">0</span><span style="color:#24292e">; i </span><span style="color:#d73a49">&lt;</span><span style="color:#24292e"> loopNumber; i</span><span style="color:#d73a49">++</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">            Dog d </span><span style="color:#d73a49">=</span><span style="color:#24292e"> list.</span><span style="color:#6f42c1">get</span><span style="color:#24292e">(i);</span></span>
<span class="line"><span style="color:#24292e">            log.</span><span style="color:#6f42c1">debug</span><span style="color:#24292e">(i </span><span style="color:#d73a49">+</span><span style="color:#24292e"> </span><span style="color:#032f62">"</span><span style="color:#005cc5">\t</span><span style="color:#032f62">"</span><span style="color:#24292e"> </span><span style="color:#d73a49">+</span><span style="color:#24292e"> ClassLayout.</span><span style="color:#6f42c1">parseInstance</span><span style="color:#24292e">(d).</span><span style="color:#6f42c1">toPrintableSimple</span><span style="color:#24292e">(</span><span style="color:#005cc5">true</span><span style="color:#24292e">));</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">synchronized</span><span style="color:#24292e"> (d) {</span></span>
<span class="line"><span style="color:#24292e">            	log.</span><span style="color:#6f42c1">debug</span><span style="color:#24292e">(i </span><span style="color:#d73a49">+</span><span style="color:#24292e"> </span><span style="color:#032f62">"</span><span style="color:#005cc5">\t</span><span style="color:#032f62">"</span><span style="color:#24292e"> </span><span style="color:#d73a49">+</span><span style="color:#24292e"> ClassLayout.</span><span style="color:#6f42c1">parseInstance</span><span style="color:#24292e">(d).</span><span style="color:#6f42c1">toPrintableSimple</span><span style="color:#24292e">(</span><span style="color:#005cc5">true</span><span style="color:#24292e">));</span></span>
<span class="line"><span style="color:#24292e">            }</span></span>
<span class="line"><span style="color:#24292e">            log.</span><span style="color:#6f42c1">debug</span><span style="color:#24292e">(i </span><span style="color:#d73a49">+</span><span style="color:#24292e"> </span><span style="color:#032f62">"</span><span style="color:#005cc5">\t</span><span style="color:#032f62">"</span><span style="color:#24292e"> </span><span style="color:#d73a49">+</span><span style="color:#24292e"> ClassLayout.</span><span style="color:#6f42c1">parseInstance</span><span style="color:#24292e">(d).</span><span style="color:#6f42c1">toPrintableSimple</span><span style="color:#24292e">(</span><span style="color:#005cc5">true</span><span style="color:#24292e">));</span></span>
<span class="line"><span style="color:#24292e">        }</span></span>
<span class="line"><span style="color:#24292e">    }, </span><span style="color:#032f62">"t3"</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">    t3.</span><span style="color:#6f42c1">start</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">    t3.</span><span style="color:#6f42c1">join</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">    log.</span><span style="color:#6f42c1">debug</span><span style="color:#24292e">(ClassLayout.</span><span style="color:#6f42c1">parseInstance</span><span style="color:#24292e">(</span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Dog</span><span style="color:#24292e">()).</span><span style="color:#6f42c1">toPrintableSimple</span><span style="color:#24292e">(</span><span style="color:#005cc5">true</span><span style="color:#24292e">));</span></span>
<span class="line"><span style="color:#24292e">}</span></span></code></pre></div><figure><img src="https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230712172438740.png" alt="image-20230712172438740" loading="lazy" decoding="async"></figure><blockquote><p><strong>参考资料</strong><a target="_blank" rel="noreferrer" href="https://github.com/farmerjohngit/myblog/issues/12"><!--[-->https://github.com/farmerjohngit/myblog/issues/12<!--]--><!----></a><a target="_blank" rel="noreferrer" href="https://www.cnblogs.com/LemonFive/p/11246086.html"><!--[-->https://www.cnblogs.com/LemonFive/p/11246086.html<!--]--><!----></a><a target="_blank" rel="noreferrer" href="https://www.cnblogs.com/LemonFive/p/11248248.html"><!--[-->https://www.cnblogs.com/LemonFive/p/11248248.html<!--]--><!----></a><a target="_blank" rel="noreferrer" href="https://www.oracle.com/technetwork/java/biasedlocking-oopsla2006-wp-149958.pdf"><!--[-->偏向锁论文<!--]--><!----></a></p></blockquote><h4 id="_5-锁消除" tabindex="-1">(5)锁消除 <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20intermediate%20level#_5-锁消除" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h4><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8">@</span><span style="color:#f97583">Fork</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">1</span><span style="color:#e1e4e8">)</span></span>
<span class="line"><span style="color:#e1e4e8">@</span><span style="color:#f97583">BenchmarkMode</span><span style="color:#e1e4e8">(Mode.AverageTime)</span></span>
<span class="line"><span style="color:#e1e4e8">@</span><span style="color:#f97583">Warmup</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">iterations</span><span style="color:#f97583">=</span><span style="color:#79b8ff">3</span><span style="color:#e1e4e8">)</span></span>
<span class="line"><span style="color:#e1e4e8">@</span><span style="color:#f97583">Measurement</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">iterations</span><span style="color:#f97583">=</span><span style="color:#79b8ff">5</span><span style="color:#e1e4e8">)</span></span>
<span class="line"><span style="color:#e1e4e8">@</span><span style="color:#f97583">OutputTimeUnit</span><span style="color:#e1e4e8">(TimeUnit.NANOSECONDS)</span></span>
<span class="line"><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">class</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">MyBenchmark</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">static</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> x </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">    @</span><span style="color:#f97583">Benchmark</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">void</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">a</span><span style="color:#e1e4e8">() </span><span style="color:#f97583">throws</span><span style="color:#e1e4e8"> Exception {</span></span>
<span class="line"><span style="color:#e1e4e8">    	x</span><span style="color:#f97583">++</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"><span style="color:#e1e4e8">    @</span><span style="color:#f97583">Benchmark</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">void</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">b</span><span style="color:#e1e4e8">() </span><span style="color:#f97583">throws</span><span style="color:#e1e4e8"> Exception {</span></span>
<span class="line"><span style="color:#e1e4e8">    Object o </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Object</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">synchronized</span><span style="color:#e1e4e8"> (o) {</span></span>
<span class="line"><span style="color:#e1e4e8">       	   x</span><span style="color:#f97583">++</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">        }</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"><span style="color:#e1e4e8">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e">@</span><span style="color:#d73a49">Fork</span><span style="color:#24292e">(</span><span style="color:#005cc5">1</span><span style="color:#24292e">)</span></span>
<span class="line"><span style="color:#24292e">@</span><span style="color:#d73a49">BenchmarkMode</span><span style="color:#24292e">(Mode.AverageTime)</span></span>
<span class="line"><span style="color:#24292e">@</span><span style="color:#d73a49">Warmup</span><span style="color:#24292e">(</span><span style="color:#005cc5">iterations</span><span style="color:#d73a49">=</span><span style="color:#005cc5">3</span><span style="color:#24292e">)</span></span>
<span class="line"><span style="color:#24292e">@</span><span style="color:#d73a49">Measurement</span><span style="color:#24292e">(</span><span style="color:#005cc5">iterations</span><span style="color:#d73a49">=</span><span style="color:#005cc5">5</span><span style="color:#24292e">)</span></span>
<span class="line"><span style="color:#24292e">@</span><span style="color:#d73a49">OutputTimeUnit</span><span style="color:#24292e">(TimeUnit.NANOSECONDS)</span></span>
<span class="line"><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">class</span><span style="color:#24292e"> </span><span style="color:#6f42c1">MyBenchmark</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">static</span><span style="color:#24292e"> </span><span style="color:#d73a49">int</span><span style="color:#24292e"> x </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#005cc5">0</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">    @</span><span style="color:#d73a49">Benchmark</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">void</span><span style="color:#24292e"> </span><span style="color:#6f42c1">a</span><span style="color:#24292e">() </span><span style="color:#d73a49">throws</span><span style="color:#24292e"> Exception {</span></span>
<span class="line"><span style="color:#24292e">    	x</span><span style="color:#d73a49">++</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"><span style="color:#24292e">    @</span><span style="color:#d73a49">Benchmark</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">void</span><span style="color:#24292e"> </span><span style="color:#6f42c1">b</span><span style="color:#24292e">() </span><span style="color:#d73a49">throws</span><span style="color:#24292e"> Exception {</span></span>
<span class="line"><span style="color:#24292e">    Object o </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Object</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">synchronized</span><span style="color:#24292e"> (o) {</span></span>
<span class="line"><span style="color:#24292e">       	   x</span><span style="color:#d73a49">++</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">        }</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"><span style="color:#24292e">}</span></span></code></pre></div><p><code>java -jar benchmarks.jar</code></p><figure><img src="https://jsd.cdn.zzko.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230712173504066.png" alt="image-20230712173504066" loading="lazy" decoding="async"></figure><p><code>java -XX:-EliminateLocks -jar benchmarks.jar</code></p><figure><img src="https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230712173526893.png" alt="image-20230712173526893" loading="lazy" decoding="async"></figure><blockquote><p>当局部变量/对象做为锁时，如果这个锁根本不会共享出去/返回出去，那么JVM中的JIT（即时编译器）就会对Java的字节码进行进一步的优化，优化的其中一个手段是分析出你的局部变量/对象的作用范围如果根本不会逃离这个方法，即不可能被共享，那么就会把synchronized的加锁代码给优化掉，真正执行的是代码块里代码； 虚拟机即时编译器在运行时，对一些代码上要求同步，但是被检测到不可能存在共享数据竞争的锁进行消除。</p></blockquote><h4 id="_6-锁粗化" tabindex="-1">(6)锁粗化 <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20intermediate%20level#_6-锁粗化" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h4><p>对相同对象多次加锁，导致线程发生多次重入，可以使用锁粗化方式来优化，这不同于之前讲的细分锁的粒度。</p><blockquote><p>将多个连续的加锁、解锁操作连接在一起，扩展成一个范围更大的锁。</p></blockquote><h3 id="_6、wait-notify" tabindex="-1">6、Wait/Notify <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20intermediate%20level#_6、wait-notify" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h3><h4 id="_1-原理" tabindex="-1">(1)原理 <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20intermediate%20level#_1-原理" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h4><figure><img src="https://jsd.cdn.zzko.cn/gh/imLKlauS/blog-picture@main/blogs/20200608145204.png" alt="img" loading="lazy" decoding="async"></figure><ul><li><p>锁对象调用wait方法（obj.wait），就会使当前线程进入WaitSet中，变为WAITING状态。</p></li><li><p>处于BLOCKED和WAITING状态的线程都为</p><p>阻塞</p><p>状态，CPU都不会分给他们时间片。但是有所区别：</p><ul><li>BLOCKED状态的线程是在竞争对象时，发现Monitor的Owner已经是别的线程了，此时就会进入EntryList中，并处于BLOCKED状态</li><li>WAITING状态的线程是获得了对象的锁，但是自身因为某些原因需要进入阻塞状态时，锁对象调用了wait方法而进入了WaitSet中，处于WAITING状态</li></ul></li><li><p>BLOCKED状态的线程会在锁被释放的时候被唤醒，但是处于WAITING状态的线程只有被锁对象调用了notify方法(obj.notify/obj.notifyAll)，才会被唤醒。</p></li></ul><p><strong>注：只有当对象被锁以后，才能调用wait和notify方法</strong></p><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">class</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Test1</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">	</span><span style="color:#f97583">final</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">static</span><span style="color:#e1e4e8"> Object LOCK </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Object</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">	</span><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">static</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">void</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">main</span><span style="color:#e1e4e8">(</span><span style="color:#f97583">String</span><span style="color:#e1e4e8">[] </span><span style="color:#ffab70">args</span><span style="color:#e1e4e8">) </span><span style="color:#f97583">throws</span><span style="color:#e1e4e8"> InterruptedException {</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#6a737d">//只有在对象被锁住后才能调用wait方法</span></span>
<span class="line"><span style="color:#e1e4e8">		</span><span style="color:#f97583">synchronized</span><span style="color:#e1e4e8"> (LOCK) {</span></span>
<span class="line"><span style="color:#e1e4e8">			LOCK.</span><span style="color:#b392f0">wait</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">		}</span></span>
<span class="line"><span style="color:#e1e4e8">	}</span></span>
<span class="line"><span style="color:#e1e4e8">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">class</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Test1</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">	</span><span style="color:#d73a49">final</span><span style="color:#24292e"> </span><span style="color:#d73a49">static</span><span style="color:#24292e"> Object LOCK </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Object</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">	</span><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">static</span><span style="color:#24292e"> </span><span style="color:#d73a49">void</span><span style="color:#24292e"> </span><span style="color:#6f42c1">main</span><span style="color:#24292e">(</span><span style="color:#d73a49">String</span><span style="color:#24292e">[] </span><span style="color:#e36209">args</span><span style="color:#24292e">) </span><span style="color:#d73a49">throws</span><span style="color:#24292e"> InterruptedException {</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6a737d">//只有在对象被锁住后才能调用wait方法</span></span>
<span class="line"><span style="color:#24292e">		</span><span style="color:#d73a49">synchronized</span><span style="color:#24292e"> (LOCK) {</span></span>
<span class="line"><span style="color:#24292e">			LOCK.</span><span style="color:#6f42c1">wait</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">		}</span></span>
<span class="line"><span style="color:#24292e">	}</span></span>
<span class="line"><span style="color:#24292e">}</span></span></code></pre></div><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8">@</span><span style="color:#f97583">Slf4j</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">topic</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#9ecbff">"c.TestWaitNotify"</span><span style="color:#e1e4e8">)</span></span>
<span class="line"><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">class</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">TestWaitNotify</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">final</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">static</span><span style="color:#e1e4e8"> Object obj </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Object</span><span style="color:#e1e4e8">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">static</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">void</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">main</span><span style="color:#e1e4e8">(</span><span style="color:#f97583">String</span><span style="color:#e1e4e8">[] </span><span style="color:#ffab70">args</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Thread</span><span style="color:#e1e4e8">(() </span><span style="color:#f97583">-&gt;</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">synchronized</span><span style="color:#e1e4e8"> (obj) {</span></span>
<span class="line"><span style="color:#e1e4e8">                log.</span><span style="color:#b392f0">debug</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"执行...."</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#f97583">try</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">                    obj.</span><span style="color:#b392f0">wait</span><span style="color:#e1e4e8">(); </span><span style="color:#6a737d">// 让线程在obj上一直等待下去</span></span>
<span class="line"><span style="color:#e1e4e8">                } </span><span style="color:#f97583">catch</span><span style="color:#e1e4e8"> (InterruptedException </span><span style="color:#ffab70">e</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">                    e.</span><span style="color:#b392f0">printStackTrace</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">                }</span></span>
<span class="line"><span style="color:#e1e4e8">                log.</span><span style="color:#b392f0">debug</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"其它代码...."</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">            }</span></span>
<span class="line"><span style="color:#e1e4e8">        },</span><span style="color:#9ecbff">"t1"</span><span style="color:#e1e4e8">).</span><span style="color:#b392f0">start</span><span style="color:#e1e4e8">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Thread</span><span style="color:#e1e4e8">(() </span><span style="color:#f97583">-&gt;</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">synchronized</span><span style="color:#e1e4e8"> (obj) {</span></span>
<span class="line"><span style="color:#e1e4e8">                log.</span><span style="color:#b392f0">debug</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"执行...."</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#f97583">try</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">                    obj.</span><span style="color:#b392f0">wait</span><span style="color:#e1e4e8">(); </span><span style="color:#6a737d">// 让线程在obj上一直等待下去</span></span>
<span class="line"><span style="color:#e1e4e8">                } </span><span style="color:#f97583">catch</span><span style="color:#e1e4e8"> (InterruptedException </span><span style="color:#ffab70">e</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">                    e.</span><span style="color:#b392f0">printStackTrace</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">                }</span></span>
<span class="line"><span style="color:#e1e4e8">                log.</span><span style="color:#b392f0">debug</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"其它代码...."</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">            }</span></span>
<span class="line"><span style="color:#e1e4e8">        },</span><span style="color:#9ecbff">"t2"</span><span style="color:#e1e4e8">).</span><span style="color:#b392f0">start</span><span style="color:#e1e4e8">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#6a737d">// 主线程两秒后执行</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#b392f0">sleep</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">0.5</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">        log.</span><span style="color:#b392f0">debug</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"唤醒 obj 上其它线程"</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">synchronized</span><span style="color:#e1e4e8"> (obj) {</span></span>
<span class="line"><span style="color:#6a737d">//            obj.notify(); // 唤醒obj上一个线程</span></span>
<span class="line"><span style="color:#e1e4e8">            obj.</span><span style="color:#b392f0">notifyAll</span><span style="color:#e1e4e8">(); </span><span style="color:#6a737d">// 唤醒obj上所有等待线程</span></span>
<span class="line"><span style="color:#e1e4e8">        }</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"><span style="color:#e1e4e8">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e">@</span><span style="color:#d73a49">Slf4j</span><span style="color:#24292e">(</span><span style="color:#005cc5">topic</span><span style="color:#24292e"> </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#032f62">"c.TestWaitNotify"</span><span style="color:#24292e">)</span></span>
<span class="line"><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">class</span><span style="color:#24292e"> </span><span style="color:#6f42c1">TestWaitNotify</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">final</span><span style="color:#24292e"> </span><span style="color:#d73a49">static</span><span style="color:#24292e"> Object obj </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Object</span><span style="color:#24292e">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">static</span><span style="color:#24292e"> </span><span style="color:#d73a49">void</span><span style="color:#24292e"> </span><span style="color:#6f42c1">main</span><span style="color:#24292e">(</span><span style="color:#d73a49">String</span><span style="color:#24292e">[] </span><span style="color:#e36209">args</span><span style="color:#24292e">) {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Thread</span><span style="color:#24292e">(() </span><span style="color:#d73a49">-&gt;</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">synchronized</span><span style="color:#24292e"> (obj) {</span></span>
<span class="line"><span style="color:#24292e">                log.</span><span style="color:#6f42c1">debug</span><span style="color:#24292e">(</span><span style="color:#032f62">"执行...."</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#d73a49">try</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">                    obj.</span><span style="color:#6f42c1">wait</span><span style="color:#24292e">(); </span><span style="color:#6a737d">// 让线程在obj上一直等待下去</span></span>
<span class="line"><span style="color:#24292e">                } </span><span style="color:#d73a49">catch</span><span style="color:#24292e"> (InterruptedException </span><span style="color:#e36209">e</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">                    e.</span><span style="color:#6f42c1">printStackTrace</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">                }</span></span>
<span class="line"><span style="color:#24292e">                log.</span><span style="color:#6f42c1">debug</span><span style="color:#24292e">(</span><span style="color:#032f62">"其它代码...."</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">            }</span></span>
<span class="line"><span style="color:#24292e">        },</span><span style="color:#032f62">"t1"</span><span style="color:#24292e">).</span><span style="color:#6f42c1">start</span><span style="color:#24292e">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Thread</span><span style="color:#24292e">(() </span><span style="color:#d73a49">-&gt;</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">synchronized</span><span style="color:#24292e"> (obj) {</span></span>
<span class="line"><span style="color:#24292e">                log.</span><span style="color:#6f42c1">debug</span><span style="color:#24292e">(</span><span style="color:#032f62">"执行...."</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#d73a49">try</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">                    obj.</span><span style="color:#6f42c1">wait</span><span style="color:#24292e">(); </span><span style="color:#6a737d">// 让线程在obj上一直等待下去</span></span>
<span class="line"><span style="color:#24292e">                } </span><span style="color:#d73a49">catch</span><span style="color:#24292e"> (InterruptedException </span><span style="color:#e36209">e</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">                    e.</span><span style="color:#6f42c1">printStackTrace</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">                }</span></span>
<span class="line"><span style="color:#24292e">                log.</span><span style="color:#6f42c1">debug</span><span style="color:#24292e">(</span><span style="color:#032f62">"其它代码...."</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">            }</span></span>
<span class="line"><span style="color:#24292e">        },</span><span style="color:#032f62">"t2"</span><span style="color:#24292e">).</span><span style="color:#6f42c1">start</span><span style="color:#24292e">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6a737d">// 主线程两秒后执行</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6f42c1">sleep</span><span style="color:#24292e">(</span><span style="color:#005cc5">0.5</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">        log.</span><span style="color:#6f42c1">debug</span><span style="color:#24292e">(</span><span style="color:#032f62">"唤醒 obj 上其它线程"</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">synchronized</span><span style="color:#24292e"> (obj) {</span></span>
<span class="line"><span style="color:#6a737d">//            obj.notify(); // 唤醒obj上一个线程</span></span>
<span class="line"><span style="color:#24292e">            obj.</span><span style="color:#6f42c1">notifyAll</span><span style="color:#24292e">(); </span><span style="color:#6a737d">// 唤醒obj上所有等待线程</span></span>
<span class="line"><span style="color:#24292e">        }</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"><span style="color:#24292e">}</span></span></code></pre></div><figure><img src="https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230713140704394.png" alt="image-20230713140704394" loading="lazy" decoding="async"></figure><h4 id="_2-wait与sleep的区别" tabindex="-1">(2)Wait与Sleep的区别 <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20intermediate%20level#_2-wait与sleep的区别" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h4><p><strong>不同点</strong></p><ul><li>Sleep是Thread类的静态方法，Wait是Object的方法，Object又是所有类的父类，所以所有类都有Wait方法。</li><li>Sleep在阻塞的时候不会释放锁，而Wait在阻塞的时候会释放锁</li><li>Sleep不需要与synchronized一起使用，而Wait需要与synchronized一起使用（对象被锁以后才能使用）</li></ul><p><strong>相同点</strong></p><ul><li>阻塞状态都为<strong>TIMED_WAITING</strong></li></ul><h4 id="_3-优雅地使用wait-notify" tabindex="-1">(3)优雅地使用wait/notify <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20intermediate%20level#_3-优雅地使用wait-notify" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h4><p><strong>什么时候适合使用wait</strong></p><ul><li>当线程<strong>不满足某些条件</strong>，需要暂停运行时，可以使用wait。这样会将<strong>对象的锁释放</strong>，让其他线程能够继续运行。如果此时使用sleep，会导致所有线程都进入阻塞，导致所有线程都没法运行，直到当前线程sleep结束后，运行完毕，才能得到执行。</li></ul><p><strong>使用wait/notify需要注意什么</strong></p><ul><li>当有<strong>多个</strong>线程在运行时，对象调用了wait方法，此时这些线程都会进入WaitSet中等待。如果这时使用了<strong>notify</strong>方法，可能会造成<strong>虚假唤醒</strong>（唤醒的不是满足条件的等待线程），这时就需要使用<strong>notifyAll</strong>方法</li></ul><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#f97583">synchronized</span><span style="color:#e1e4e8"> (LOCK) {</span></span>
<span class="line"><span style="color:#e1e4e8">	</span><span style="color:#f97583">while</span><span style="color:#e1e4e8">(</span><span style="color:#6a737d">//不满足条件，一直等待，避免虚假唤醒) {</span></span>
<span class="line"><span style="color:#e1e4e8">		LOCK.</span><span style="color:#b392f0">wait</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">	}</span></span>
<span class="line"><span style="color:#e1e4e8">	</span><span style="color:#6a737d">//满足条件后再运行</span></span>
<span class="line"><span style="color:#e1e4e8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#f97583">synchronized</span><span style="color:#e1e4e8"> (LOCK) {</span></span>
<span class="line"><span style="color:#e1e4e8">	</span><span style="color:#6a737d">//唤醒所有等待线程</span></span>
<span class="line"><span style="color:#e1e4e8">	LOCK.</span><span style="color:#b392f0">notifyAll</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#d73a49">synchronized</span><span style="color:#24292e"> (LOCK) {</span></span>
<span class="line"><span style="color:#24292e">	</span><span style="color:#d73a49">while</span><span style="color:#24292e">(</span><span style="color:#6a737d">//不满足条件，一直等待，避免虚假唤醒) {</span></span>
<span class="line"><span style="color:#24292e">		LOCK.</span><span style="color:#6f42c1">wait</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">	}</span></span>
<span class="line"><span style="color:#24292e">	</span><span style="color:#6a737d">//满足条件后再运行</span></span>
<span class="line"><span style="color:#24292e">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#d73a49">synchronized</span><span style="color:#24292e"> (LOCK) {</span></span>
<span class="line"><span style="color:#24292e">	</span><span style="color:#6a737d">//唤醒所有等待线程</span></span>
<span class="line"><span style="color:#24292e">	LOCK.</span><span style="color:#6f42c1">notifyAll</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">}</span></span></code></pre></div><h3 id="_7、同步模式之保护性暂停" tabindex="-1">7、同步模式之保护性暂停 <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20intermediate%20level#_7、同步模式之保护性暂停" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h3><h4 id="_1-定义" tabindex="-1">(1)定义 <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20intermediate%20level#_1-定义" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h4><figure><img src="https://jsd.cdn.zzko.cn/gh/imLKlauS/blog-picture@main/blogs/20200608145223.png" alt="img" loading="lazy" decoding="async"></figure><h4 id="_2-实现" tabindex="-1">(2)实现 <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20intermediate%20level#_2-实现" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h4><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">class</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Test2</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">	</span><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">static</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">void</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">main</span><span style="color:#e1e4e8">(</span><span style="color:#f97583">String</span><span style="color:#e1e4e8">[] </span><span style="color:#ffab70">args</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">		String hello </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#9ecbff">"hello thread!"</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">		Guarded guarded </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Guarded</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">		</span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Thread</span><span style="color:#e1e4e8">(()</span><span style="color:#f97583">-&gt;</span><span style="color:#e1e4e8">{</span></span>
<span class="line"><span style="color:#e1e4e8">			System.out.</span><span style="color:#b392f0">println</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"想要得到结果"</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">			</span><span style="color:#f97583">synchronized</span><span style="color:#e1e4e8"> (guarded) {</span></span>
<span class="line"><span style="color:#e1e4e8">				System.out.</span><span style="color:#b392f0">println</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"结果是："</span><span style="color:#f97583">+</span><span style="color:#e1e4e8">guarded.</span><span style="color:#b392f0">getResponse</span><span style="color:#e1e4e8">());</span></span>
<span class="line"><span style="color:#e1e4e8">			}</span></span>
<span class="line"><span style="color:#e1e4e8">			System.out.</span><span style="color:#b392f0">println</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"得到结果"</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">		}).</span><span style="color:#b392f0">start</span><span style="color:#e1e4e8">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">		</span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Thread</span><span style="color:#e1e4e8">(()</span><span style="color:#f97583">-&gt;</span><span style="color:#e1e4e8">{</span></span>
<span class="line"><span style="color:#e1e4e8">			System.out.</span><span style="color:#b392f0">println</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"设置结果"</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">			</span><span style="color:#f97583">synchronized</span><span style="color:#e1e4e8"> (guarded) {</span></span>
<span class="line"><span style="color:#e1e4e8">				guarded.</span><span style="color:#b392f0">setResponse</span><span style="color:#e1e4e8">(hello);</span></span>
<span class="line"><span style="color:#e1e4e8">			}</span></span>
<span class="line"><span style="color:#e1e4e8">		}).</span><span style="color:#b392f0">start</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">	}</span></span>
<span class="line"><span style="color:#e1e4e8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#f97583">class</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Guarded</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#6a737d">	/**</span></span>
<span class="line"><span style="color:#6a737d">	 * 要返回的结果</span></span>
<span class="line"><span style="color:#6a737d">	 */</span></span>
<span class="line"><span style="color:#e1e4e8">	</span><span style="color:#f97583">private</span><span style="color:#e1e4e8"> Object response;</span></span>
<span class="line"><span style="color:#e1e4e8">	</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">//优雅地使用wait/notify</span></span>
<span class="line"><span style="color:#e1e4e8">	</span><span style="color:#f97583">public</span><span style="color:#e1e4e8"> Object </span><span style="color:#b392f0">getResponse</span><span style="color:#e1e4e8">() {</span></span>
<span class="line"><span style="color:#e1e4e8">		</span><span style="color:#6a737d">//如果返回结果为空就一直等待，避免虚假唤醒</span></span>
<span class="line"><span style="color:#e1e4e8">		</span><span style="color:#f97583">while</span><span style="color:#e1e4e8">(response </span><span style="color:#f97583">==</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">			</span><span style="color:#f97583">synchronized</span><span style="color:#e1e4e8"> (</span><span style="color:#79b8ff">this</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">				</span><span style="color:#f97583">try</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">					</span><span style="color:#79b8ff">this</span><span style="color:#e1e4e8">.</span><span style="color:#b392f0">wait</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">				} </span><span style="color:#f97583">catch</span><span style="color:#e1e4e8"> (InterruptedException </span><span style="color:#ffab70">e</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">					e.</span><span style="color:#b392f0">printStackTrace</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">				}</span></span>
<span class="line"><span style="color:#e1e4e8">			}</span></span>
<span class="line"><span style="color:#e1e4e8">		}</span></span>
<span class="line"><span style="color:#e1e4e8">		</span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> response;</span></span>
<span class="line"><span style="color:#e1e4e8">	}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">	</span><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">void</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">setResponse</span><span style="color:#e1e4e8">(Object </span><span style="color:#ffab70">response</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">		</span><span style="color:#79b8ff">this</span><span style="color:#e1e4e8">.response </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> response;</span></span>
<span class="line"><span style="color:#e1e4e8">		</span><span style="color:#f97583">synchronized</span><span style="color:#e1e4e8"> (</span><span style="color:#79b8ff">this</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">			</span><span style="color:#6a737d">//唤醒休眠的线程</span></span>
<span class="line"><span style="color:#e1e4e8">			</span><span style="color:#79b8ff">this</span><span style="color:#e1e4e8">.</span><span style="color:#b392f0">notifyAll</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">		}</span></span>
<span class="line"><span style="color:#e1e4e8">	}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">	@</span><span style="color:#f97583">Override</span></span>
<span class="line"><span style="color:#e1e4e8">	</span><span style="color:#f97583">public</span><span style="color:#e1e4e8"> String </span><span style="color:#b392f0">toString</span><span style="color:#e1e4e8">() {</span></span>
<span class="line"><span style="color:#e1e4e8">		</span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> </span><span style="color:#9ecbff">"Guarded{"</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">+</span></span>
<span class="line"><span style="color:#e1e4e8">				</span><span style="color:#9ecbff">"response="</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">+</span><span style="color:#e1e4e8"> response </span><span style="color:#f97583">+</span></span>
<span class="line"><span style="color:#e1e4e8">				</span><span style="color:#9ecbff">'}'</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">	}</span></span>
<span class="line"><span style="color:#e1e4e8">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">class</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Test2</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">	</span><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">static</span><span style="color:#24292e"> </span><span style="color:#d73a49">void</span><span style="color:#24292e"> </span><span style="color:#6f42c1">main</span><span style="color:#24292e">(</span><span style="color:#d73a49">String</span><span style="color:#24292e">[] </span><span style="color:#e36209">args</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">		String hello </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#032f62">"hello thread!"</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">		Guarded guarded </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Guarded</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">		</span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Thread</span><span style="color:#24292e">(()</span><span style="color:#d73a49">-&gt;</span><span style="color:#24292e">{</span></span>
<span class="line"><span style="color:#24292e">			System.out.</span><span style="color:#6f42c1">println</span><span style="color:#24292e">(</span><span style="color:#032f62">"想要得到结果"</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">			</span><span style="color:#d73a49">synchronized</span><span style="color:#24292e"> (guarded) {</span></span>
<span class="line"><span style="color:#24292e">				System.out.</span><span style="color:#6f42c1">println</span><span style="color:#24292e">(</span><span style="color:#032f62">"结果是："</span><span style="color:#d73a49">+</span><span style="color:#24292e">guarded.</span><span style="color:#6f42c1">getResponse</span><span style="color:#24292e">());</span></span>
<span class="line"><span style="color:#24292e">			}</span></span>
<span class="line"><span style="color:#24292e">			System.out.</span><span style="color:#6f42c1">println</span><span style="color:#24292e">(</span><span style="color:#032f62">"得到结果"</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">		}).</span><span style="color:#6f42c1">start</span><span style="color:#24292e">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">		</span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Thread</span><span style="color:#24292e">(()</span><span style="color:#d73a49">-&gt;</span><span style="color:#24292e">{</span></span>
<span class="line"><span style="color:#24292e">			System.out.</span><span style="color:#6f42c1">println</span><span style="color:#24292e">(</span><span style="color:#032f62">"设置结果"</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">			</span><span style="color:#d73a49">synchronized</span><span style="color:#24292e"> (guarded) {</span></span>
<span class="line"><span style="color:#24292e">				guarded.</span><span style="color:#6f42c1">setResponse</span><span style="color:#24292e">(hello);</span></span>
<span class="line"><span style="color:#24292e">			}</span></span>
<span class="line"><span style="color:#24292e">		}).</span><span style="color:#6f42c1">start</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">	}</span></span>
<span class="line"><span style="color:#24292e">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#d73a49">class</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Guarded</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#6a737d">	/**</span></span>
<span class="line"><span style="color:#6a737d">	 * 要返回的结果</span></span>
<span class="line"><span style="color:#6a737d">	 */</span></span>
<span class="line"><span style="color:#24292e">	</span><span style="color:#d73a49">private</span><span style="color:#24292e"> Object response;</span></span>
<span class="line"><span style="color:#24292e">	</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">//优雅地使用wait/notify</span></span>
<span class="line"><span style="color:#24292e">	</span><span style="color:#d73a49">public</span><span style="color:#24292e"> Object </span><span style="color:#6f42c1">getResponse</span><span style="color:#24292e">() {</span></span>
<span class="line"><span style="color:#24292e">		</span><span style="color:#6a737d">//如果返回结果为空就一直等待，避免虚假唤醒</span></span>
<span class="line"><span style="color:#24292e">		</span><span style="color:#d73a49">while</span><span style="color:#24292e">(response </span><span style="color:#d73a49">==</span><span style="color:#24292e"> </span><span style="color:#005cc5">null</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">			</span><span style="color:#d73a49">synchronized</span><span style="color:#24292e"> (</span><span style="color:#005cc5">this</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">				</span><span style="color:#d73a49">try</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">					</span><span style="color:#005cc5">this</span><span style="color:#24292e">.</span><span style="color:#6f42c1">wait</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">				} </span><span style="color:#d73a49">catch</span><span style="color:#24292e"> (InterruptedException </span><span style="color:#e36209">e</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">					e.</span><span style="color:#6f42c1">printStackTrace</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">				}</span></span>
<span class="line"><span style="color:#24292e">			}</span></span>
<span class="line"><span style="color:#24292e">		}</span></span>
<span class="line"><span style="color:#24292e">		</span><span style="color:#d73a49">return</span><span style="color:#24292e"> response;</span></span>
<span class="line"><span style="color:#24292e">	}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">	</span><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">void</span><span style="color:#24292e"> </span><span style="color:#6f42c1">setResponse</span><span style="color:#24292e">(Object </span><span style="color:#e36209">response</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">		</span><span style="color:#005cc5">this</span><span style="color:#24292e">.response </span><span style="color:#d73a49">=</span><span style="color:#24292e"> response;</span></span>
<span class="line"><span style="color:#24292e">		</span><span style="color:#d73a49">synchronized</span><span style="color:#24292e"> (</span><span style="color:#005cc5">this</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">			</span><span style="color:#6a737d">//唤醒休眠的线程</span></span>
<span class="line"><span style="color:#24292e">			</span><span style="color:#005cc5">this</span><span style="color:#24292e">.</span><span style="color:#6f42c1">notifyAll</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">		}</span></span>
<span class="line"><span style="color:#24292e">	}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">	@</span><span style="color:#d73a49">Override</span></span>
<span class="line"><span style="color:#24292e">	</span><span style="color:#d73a49">public</span><span style="color:#24292e"> String </span><span style="color:#6f42c1">toString</span><span style="color:#24292e">() {</span></span>
<span class="line"><span style="color:#24292e">		</span><span style="color:#d73a49">return</span><span style="color:#24292e"> </span><span style="color:#032f62">"Guarded{"</span><span style="color:#24292e"> </span><span style="color:#d73a49">+</span></span>
<span class="line"><span style="color:#24292e">				</span><span style="color:#032f62">"response="</span><span style="color:#24292e"> </span><span style="color:#d73a49">+</span><span style="color:#24292e"> response </span><span style="color:#d73a49">+</span></span>
<span class="line"><span style="color:#24292e">				</span><span style="color:#032f62">'}'</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">	}</span></span>
<span class="line"><span style="color:#24292e">}</span></span></code></pre></div><h4 id="_3-带超时判断的暂停" tabindex="-1"><strong>(3)带超时判断的暂停</strong> <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20intermediate%20level#_3-带超时判断的暂停" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h4><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#f97583">public</span><span style="color:#e1e4e8"> Object </span><span style="color:#b392f0">getResponse</span><span style="color:#e1e4e8">(</span><span style="color:#f97583">long</span><span style="color:#e1e4e8"> time) {</span></span>
<span class="line"><span style="color:#e1e4e8">		</span><span style="color:#f97583">synchronized</span><span style="color:#e1e4e8"> (</span><span style="color:#79b8ff">this</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">			</span><span style="color:#6a737d">//获取开始时间 15:00:00</span></span>
<span class="line"><span style="color:#e1e4e8">			</span><span style="color:#f97583">long</span><span style="color:#e1e4e8"> currentTime </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> System.</span><span style="color:#b392f0">currentTimeMillis</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">			</span><span style="color:#6a737d">//经历的时间</span></span>
<span class="line"><span style="color:#e1e4e8">			</span><span style="color:#f97583">long</span><span style="color:#e1e4e8"> passedTime </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">			</span><span style="color:#f97583">while</span><span style="color:#e1e4e8">(response </span><span style="color:#f97583">==</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">				</span><span style="color:#6a737d">//这一轮循环应该等待的时间  对等待时间的处理能够解决虚假唤醒:2-1=1;2-2=0  | 2-3=-1</span></span>
<span class="line"><span style="color:#e1e4e8">				</span><span style="color:#f97583">long</span><span style="color:#e1e4e8"> waitTime </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> time </span><span style="color:#f97583">-</span><span style="color:#e1e4e8">passedTime;</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#6a737d">//经历的时间超过了最大等待时间时，退出循环</span></span>
<span class="line"><span style="color:#e1e4e8">				</span><span style="color:#f97583">if</span><span style="color:#e1e4e8">(waitTime </span><span style="color:#f97583">&lt;=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">					</span><span style="color:#f97583">break</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">				}</span></span>
<span class="line"><span style="color:#e1e4e8">				</span><span style="color:#f97583">try</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">                   	</span><span style="color:#6a737d">//等待剩余时间  如果wait传入time，虚假唤醒就会多等待1s，即3s</span></span>
<span class="line"><span style="color:#e1e4e8">					</span><span style="color:#79b8ff">this</span><span style="color:#e1e4e8">.</span><span style="color:#b392f0">wait</span><span style="color:#e1e4e8">(waitTime);</span><span style="color:#6a737d">//2s  第一轮虚假唤醒15:00:01  第二轮就不需等2s了（2-1=1s）</span></span>
<span class="line"><span style="color:#e1e4e8">				} </span><span style="color:#f97583">catch</span><span style="color:#e1e4e8"> (InterruptedException </span><span style="color:#ffab70">e</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">					e.</span><span style="color:#b392f0">printStackTrace</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">				}</span></span>
<span class="line"><span style="color:#e1e4e8">				</span><span style="color:#6a737d">//获取经历时间</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#6a737d">//2-0=&gt;15:00:02 虚假唤醒:1-0=1s;2-0=2s | 3-0=s</span></span>
<span class="line"><span style="color:#e1e4e8">				passedTime </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> System.</span><span style="color:#b392f0">currentTimeMillis</span><span style="color:#e1e4e8">()</span><span style="color:#f97583">-</span><span style="color:#e1e4e8">currentTime;</span></span>
<span class="line"><span style="color:#e1e4e8">            }</span></span>
<span class="line"><span style="color:#e1e4e8">		}</span></span>
<span class="line"><span style="color:#e1e4e8">		</span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> response;</span></span>
<span class="line"><span style="color:#e1e4e8">	}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#d73a49">public</span><span style="color:#24292e"> Object </span><span style="color:#6f42c1">getResponse</span><span style="color:#24292e">(</span><span style="color:#d73a49">long</span><span style="color:#24292e"> time) {</span></span>
<span class="line"><span style="color:#24292e">		</span><span style="color:#d73a49">synchronized</span><span style="color:#24292e"> (</span><span style="color:#005cc5">this</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">			</span><span style="color:#6a737d">//获取开始时间 15:00:00</span></span>
<span class="line"><span style="color:#24292e">			</span><span style="color:#d73a49">long</span><span style="color:#24292e"> currentTime </span><span style="color:#d73a49">=</span><span style="color:#24292e"> System.</span><span style="color:#6f42c1">currentTimeMillis</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">			</span><span style="color:#6a737d">//经历的时间</span></span>
<span class="line"><span style="color:#24292e">			</span><span style="color:#d73a49">long</span><span style="color:#24292e"> passedTime </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#005cc5">0</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">			</span><span style="color:#d73a49">while</span><span style="color:#24292e">(response </span><span style="color:#d73a49">==</span><span style="color:#24292e"> </span><span style="color:#005cc5">null</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">				</span><span style="color:#6a737d">//这一轮循环应该等待的时间  对等待时间的处理能够解决虚假唤醒:2-1=1;2-2=0  | 2-3=-1</span></span>
<span class="line"><span style="color:#24292e">				</span><span style="color:#d73a49">long</span><span style="color:#24292e"> waitTime </span><span style="color:#d73a49">=</span><span style="color:#24292e"> time </span><span style="color:#d73a49">-</span><span style="color:#24292e">passedTime;</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#6a737d">//经历的时间超过了最大等待时间时，退出循环</span></span>
<span class="line"><span style="color:#24292e">				</span><span style="color:#d73a49">if</span><span style="color:#24292e">(waitTime </span><span style="color:#d73a49">&lt;=</span><span style="color:#24292e"> </span><span style="color:#005cc5">0</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">					</span><span style="color:#d73a49">break</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">				}</span></span>
<span class="line"><span style="color:#24292e">				</span><span style="color:#d73a49">try</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">                   	</span><span style="color:#6a737d">//等待剩余时间  如果wait传入time，虚假唤醒就会多等待1s，即3s</span></span>
<span class="line"><span style="color:#24292e">					</span><span style="color:#005cc5">this</span><span style="color:#24292e">.</span><span style="color:#6f42c1">wait</span><span style="color:#24292e">(waitTime);</span><span style="color:#6a737d">//2s  第一轮虚假唤醒15:00:01  第二轮就不需等2s了（2-1=1s）</span></span>
<span class="line"><span style="color:#24292e">				} </span><span style="color:#d73a49">catch</span><span style="color:#24292e"> (InterruptedException </span><span style="color:#e36209">e</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">					e.</span><span style="color:#6f42c1">printStackTrace</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">				}</span></span>
<span class="line"><span style="color:#24292e">				</span><span style="color:#6a737d">//获取经历时间</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#6a737d">//2-0=&gt;15:00:02 虚假唤醒:1-0=1s;2-0=2s | 3-0=s</span></span>
<span class="line"><span style="color:#24292e">				passedTime </span><span style="color:#d73a49">=</span><span style="color:#24292e"> System.</span><span style="color:#6f42c1">currentTimeMillis</span><span style="color:#24292e">()</span><span style="color:#d73a49">-</span><span style="color:#24292e">currentTime;</span></span>
<span class="line"><span style="color:#24292e">            }</span></span>
<span class="line"><span style="color:#24292e">		}</span></span>
<span class="line"><span style="color:#24292e">		</span><span style="color:#d73a49">return</span><span style="color:#24292e"> response;</span></span>
<span class="line"><span style="color:#24292e">	}</span></span></code></pre></div><h4 id="_4-join源码——使用保护性暂停模式" tabindex="-1">(4)join源码——使用保护性暂停模式 <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20intermediate%20level#_4-join源码——使用保护性暂停模式" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h4><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">final</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">synchronized</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">void</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">join</span><span style="color:#e1e4e8">(</span><span style="color:#f97583">long</span><span style="color:#e1e4e8"> millis)</span></span>
<span class="line"><span style="color:#e1e4e8">    throws InterruptedException {</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">long</span><span style="color:#e1e4e8"> base </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> System.</span><span style="color:#b392f0">currentTimeMillis</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">long</span><span style="color:#e1e4e8"> now </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (millis </span><span style="color:#f97583">&lt;</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">throw</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">IllegalArgumentException</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"timeout value is negative"</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">        }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (millis </span><span style="color:#f97583">==</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">while</span><span style="color:#e1e4e8"> (</span><span style="color:#b392f0">isAlive</span><span style="color:#e1e4e8">()) {</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#b392f0">wait</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">            }</span></span>
<span class="line"><span style="color:#e1e4e8">        } </span><span style="color:#f97583">else</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">while</span><span style="color:#e1e4e8"> (</span><span style="color:#b392f0">isAlive</span><span style="color:#e1e4e8">()) {</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#f97583">long</span><span style="color:#e1e4e8"> delay </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> millis </span><span style="color:#f97583">-</span><span style="color:#e1e4e8"> now;</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (delay </span><span style="color:#f97583">&lt;=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">                    </span><span style="color:#f97583">break</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">                }</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#b392f0">wait</span><span style="color:#e1e4e8">(delay);</span></span>
<span class="line"><span style="color:#e1e4e8">                now </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> System.</span><span style="color:#b392f0">currentTimeMillis</span><span style="color:#e1e4e8">() </span><span style="color:#f97583">-</span><span style="color:#e1e4e8"> base;</span></span>
<span class="line"><span style="color:#e1e4e8">            }</span></span>
<span class="line"><span style="color:#e1e4e8">        }</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">final</span><span style="color:#24292e"> </span><span style="color:#d73a49">synchronized</span><span style="color:#24292e"> </span><span style="color:#d73a49">void</span><span style="color:#24292e"> </span><span style="color:#6f42c1">join</span><span style="color:#24292e">(</span><span style="color:#d73a49">long</span><span style="color:#24292e"> millis)</span></span>
<span class="line"><span style="color:#24292e">    throws InterruptedException {</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">long</span><span style="color:#24292e"> base </span><span style="color:#d73a49">=</span><span style="color:#24292e"> System.</span><span style="color:#6f42c1">currentTimeMillis</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">long</span><span style="color:#24292e"> now </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#005cc5">0</span><span style="color:#24292e">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (millis </span><span style="color:#d73a49">&lt;</span><span style="color:#24292e"> </span><span style="color:#005cc5">0</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">throw</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">IllegalArgumentException</span><span style="color:#24292e">(</span><span style="color:#032f62">"timeout value is negative"</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">        }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (millis </span><span style="color:#d73a49">==</span><span style="color:#24292e"> </span><span style="color:#005cc5">0</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">while</span><span style="color:#24292e"> (</span><span style="color:#6f42c1">isAlive</span><span style="color:#24292e">()) {</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#6f42c1">wait</span><span style="color:#24292e">(</span><span style="color:#005cc5">0</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">            }</span></span>
<span class="line"><span style="color:#24292e">        } </span><span style="color:#d73a49">else</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">while</span><span style="color:#24292e"> (</span><span style="color:#6f42c1">isAlive</span><span style="color:#24292e">()) {</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#d73a49">long</span><span style="color:#24292e"> delay </span><span style="color:#d73a49">=</span><span style="color:#24292e"> millis </span><span style="color:#d73a49">-</span><span style="color:#24292e"> now;</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (delay </span><span style="color:#d73a49">&lt;=</span><span style="color:#24292e"> </span><span style="color:#005cc5">0</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">                    </span><span style="color:#d73a49">break</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">                }</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#6f42c1">wait</span><span style="color:#24292e">(delay);</span></span>
<span class="line"><span style="color:#24292e">                now </span><span style="color:#d73a49">=</span><span style="color:#24292e"> System.</span><span style="color:#6f42c1">currentTimeMillis</span><span style="color:#24292e">() </span><span style="color:#d73a49">-</span><span style="color:#24292e"> base;</span></span>
<span class="line"><span style="color:#24292e">            }</span></span>
<span class="line"><span style="color:#24292e">        }</span></span>
<span class="line"><span style="color:#24292e">    }</span></span></code></pre></div><h4 id="_5-多任务版-guardedobject" tabindex="-1">(5)多任务版 GuardedObject <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20intermediate%20level#_5-多任务版-guardedobject" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h4><p>图中 Futures 就好比居民楼一层的信箱（每个信箱有房间编号），左侧的 t0，t2，t4 就好比等待邮件的居民，右 侧的 t1，t3，t5 就好比邮递员 如果需要在多个类之间使用 GuardedObject 对象，作为参数传递不是很方便，因此设计一个用来解耦的中间类， 这样不仅能够解耦【结果等待者】和【结果生产者】，还能够同时支持多个任务的管理</p><figure><img src="https://jsd.cdn.zzko.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230712214912432.png" alt="image-20230712214912432" loading="lazy" decoding="async"></figure><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8">@</span><span style="color:#f97583">Slf4j</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">topic</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#9ecbff">"c.Test20"</span><span style="color:#e1e4e8">)</span></span>
<span class="line"><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">class</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Test20</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">static</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">void</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">main</span><span style="color:#e1e4e8">(</span><span style="color:#f97583">String</span><span style="color:#e1e4e8">[] </span><span style="color:#ffab70">args</span><span style="color:#e1e4e8">) </span><span style="color:#f97583">throws</span><span style="color:#e1e4e8"> InterruptedException {</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">for</span><span style="color:#e1e4e8"> (</span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> i </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8">; i </span><span style="color:#f97583">&lt;</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">3</span><span style="color:#e1e4e8">; i</span><span style="color:#f97583">++</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">People</span><span style="color:#e1e4e8">().</span><span style="color:#b392f0">start</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">        }</span></span>
<span class="line"><span style="color:#e1e4e8">        Sleeper.</span><span style="color:#b392f0">sleep</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">1</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">for</span><span style="color:#e1e4e8"> (Integer id </span><span style="color:#f97583">:</span><span style="color:#e1e4e8"> Mailboxes.</span><span style="color:#b392f0">getIds</span><span style="color:#e1e4e8">()) {</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Postman</span><span style="color:#e1e4e8">(id, </span><span style="color:#9ecbff">"内容"</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">+</span><span style="color:#e1e4e8"> id).</span><span style="color:#b392f0">start</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">        }</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"><span style="color:#e1e4e8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">@</span><span style="color:#f97583">Slf4j</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">topic</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#9ecbff">"c.People"</span><span style="color:#e1e4e8">)</span></span>
<span class="line"><span style="color:#f97583">class</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">People</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">extends</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Thread</span><span style="color:#e1e4e8">{</span></span>
<span class="line"><span style="color:#e1e4e8">    @</span><span style="color:#f97583">Override</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">void</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">run</span><span style="color:#e1e4e8">() {</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#6a737d">// 收信</span></span>
<span class="line"><span style="color:#e1e4e8">        GuardedObject guardedObject </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> Mailboxes.</span><span style="color:#b392f0">createGuardedObject</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">        log.</span><span style="color:#b392f0">debug</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"开始收信 id:{}"</span><span style="color:#e1e4e8">, guardedObject.</span><span style="color:#b392f0">getId</span><span style="color:#e1e4e8">());</span></span>
<span class="line"><span style="color:#e1e4e8">        Object mail </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> guardedObject.</span><span style="color:#b392f0">get</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">5000</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">        log.</span><span style="color:#b392f0">debug</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"收到信 id:{}, 内容:{}"</span><span style="color:#e1e4e8">, guardedObject.</span><span style="color:#b392f0">getId</span><span style="color:#e1e4e8">(), mail);</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"><span style="color:#e1e4e8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">@</span><span style="color:#f97583">Slf4j</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">topic</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#9ecbff">"c.Postman"</span><span style="color:#e1e4e8">)</span></span>
<span class="line"><span style="color:#f97583">class</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Postman</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">extends</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Thread</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">private</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> id;</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">private</span><span style="color:#e1e4e8"> String mail;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Postman</span><span style="color:#e1e4e8">(</span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> </span><span style="color:#ffab70">id</span><span style="color:#e1e4e8">, String </span><span style="color:#ffab70">mail</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#79b8ff">this</span><span style="color:#e1e4e8">.id </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> id;</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#79b8ff">this</span><span style="color:#e1e4e8">.mail </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> mail;</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">    @</span><span style="color:#f97583">Override</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">void</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">run</span><span style="color:#e1e4e8">() {</span></span>
<span class="line"><span style="color:#e1e4e8">        GuardedObject guardedObject </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> Mailboxes.</span><span style="color:#b392f0">getGuardedObject</span><span style="color:#e1e4e8">(id);</span></span>
<span class="line"><span style="color:#e1e4e8">        log.</span><span style="color:#b392f0">debug</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"送信 id:{}, 内容:{}"</span><span style="color:#e1e4e8">, id, mail);</span></span>
<span class="line"><span style="color:#e1e4e8">        guardedObject.</span><span style="color:#b392f0">complete</span><span style="color:#e1e4e8">(mail);</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"><span style="color:#e1e4e8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#f97583">class</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Mailboxes</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">private</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">static</span><span style="color:#e1e4e8"> Map&lt;</span><span style="color:#f97583">Integer</span><span style="color:#e1e4e8">, </span><span style="color:#f97583">GuardedObject</span><span style="color:#e1e4e8">&gt; boxes </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> Hashtable&lt;&gt;();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">private</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">static</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> id </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">1</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">// 产生唯一 id</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">private</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">static</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">synchronized</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">generateId</span><span style="color:#e1e4e8">() {</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> id</span><span style="color:#f97583">++</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">static</span><span style="color:#e1e4e8"> GuardedObject </span><span style="color:#b392f0">getGuardedObject</span><span style="color:#e1e4e8">(</span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> </span><span style="color:#ffab70">id</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> boxes.</span><span style="color:#b392f0">remove</span><span style="color:#e1e4e8">(id);</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">static</span><span style="color:#e1e4e8"> GuardedObject </span><span style="color:#b392f0">createGuardedObject</span><span style="color:#e1e4e8">() {</span></span>
<span class="line"><span style="color:#e1e4e8">        GuardedObject go </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">GuardedObject</span><span style="color:#e1e4e8">(</span><span style="color:#b392f0">generateId</span><span style="color:#e1e4e8">());</span></span>
<span class="line"><span style="color:#e1e4e8">        boxes.</span><span style="color:#b392f0">put</span><span style="color:#e1e4e8">(go.</span><span style="color:#b392f0">getId</span><span style="color:#e1e4e8">(), go);</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> go;</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">static</span><span style="color:#e1e4e8"> Set&lt;</span><span style="color:#f97583">Integer</span><span style="color:#e1e4e8">&gt; </span><span style="color:#b392f0">getIds</span><span style="color:#e1e4e8">() {</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> boxes.</span><span style="color:#b392f0">keySet</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"><span style="color:#e1e4e8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6a737d">// 增加超时效果</span></span>
<span class="line"><span style="color:#f97583">class</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">GuardedObject</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">// 标识 Guarded Object</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">private</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> id;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">GuardedObject</span><span style="color:#e1e4e8">(</span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> </span><span style="color:#ffab70">id</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#79b8ff">this</span><span style="color:#e1e4e8">.id </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> id;</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">getId</span><span style="color:#e1e4e8">() {</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> id;</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">// 结果</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">private</span><span style="color:#e1e4e8"> Object response;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">// 获取结果</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">// timeout 表示要等待多久 2000</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">public</span><span style="color:#e1e4e8"> Object </span><span style="color:#b392f0">get</span><span style="color:#e1e4e8">(</span><span style="color:#f97583">long</span><span style="color:#e1e4e8"> </span><span style="color:#ffab70">timeout</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">synchronized</span><span style="color:#e1e4e8"> (</span><span style="color:#79b8ff">this</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#6a737d">// 开始时间 15:00:00</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">long</span><span style="color:#e1e4e8"> begin </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> System.</span><span style="color:#b392f0">currentTimeMillis</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#6a737d">// 经历的时间</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">long</span><span style="color:#e1e4e8"> passedTime </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">while</span><span style="color:#e1e4e8"> (response </span><span style="color:#f97583">==</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#6a737d">// 这一轮循环应该等待的时间</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#f97583">long</span><span style="color:#e1e4e8"> waitTime </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> timeout </span><span style="color:#f97583">-</span><span style="color:#e1e4e8"> passedTime;</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#6a737d">// 经历的时间超过了最大等待时间时，退出循环</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (timeout </span><span style="color:#f97583">-</span><span style="color:#e1e4e8"> passedTime </span><span style="color:#f97583">&lt;=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">                    </span><span style="color:#f97583">break</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">                }</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#f97583">try</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">                    </span><span style="color:#79b8ff">this</span><span style="color:#e1e4e8">.</span><span style="color:#b392f0">wait</span><span style="color:#e1e4e8">(waitTime); </span><span style="color:#6a737d">// 虚假唤醒 15:00:01</span></span>
<span class="line"><span style="color:#e1e4e8">                } </span><span style="color:#f97583">catch</span><span style="color:#e1e4e8"> (InterruptedException </span><span style="color:#ffab70">e</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">                    e.</span><span style="color:#b392f0">printStackTrace</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">                }</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#6a737d">// 求得经历时间</span></span>
<span class="line"><span style="color:#e1e4e8">                passedTime </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> System.</span><span style="color:#b392f0">currentTimeMillis</span><span style="color:#e1e4e8">() </span><span style="color:#f97583">-</span><span style="color:#e1e4e8"> begin; </span><span style="color:#6a737d">// 15:00:02  1s</span></span>
<span class="line"><span style="color:#e1e4e8">            }</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> response;</span></span>
<span class="line"><span style="color:#e1e4e8">        }</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">// 产生结果</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">void</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">complete</span><span style="color:#e1e4e8">(Object </span><span style="color:#ffab70">response</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">synchronized</span><span style="color:#e1e4e8"> (</span><span style="color:#79b8ff">this</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#6a737d">// 给结果成员变量赋值</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#79b8ff">this</span><span style="color:#e1e4e8">.response </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> response;</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#79b8ff">this</span><span style="color:#e1e4e8">.</span><span style="color:#b392f0">notifyAll</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">        }</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"><span style="color:#e1e4e8">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e">@</span><span style="color:#d73a49">Slf4j</span><span style="color:#24292e">(</span><span style="color:#005cc5">topic</span><span style="color:#24292e"> </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#032f62">"c.Test20"</span><span style="color:#24292e">)</span></span>
<span class="line"><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">class</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Test20</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">static</span><span style="color:#24292e"> </span><span style="color:#d73a49">void</span><span style="color:#24292e"> </span><span style="color:#6f42c1">main</span><span style="color:#24292e">(</span><span style="color:#d73a49">String</span><span style="color:#24292e">[] </span><span style="color:#e36209">args</span><span style="color:#24292e">) </span><span style="color:#d73a49">throws</span><span style="color:#24292e"> InterruptedException {</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">for</span><span style="color:#24292e"> (</span><span style="color:#d73a49">int</span><span style="color:#24292e"> i </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#005cc5">0</span><span style="color:#24292e">; i </span><span style="color:#d73a49">&lt;</span><span style="color:#24292e"> </span><span style="color:#005cc5">3</span><span style="color:#24292e">; i</span><span style="color:#d73a49">++</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">People</span><span style="color:#24292e">().</span><span style="color:#6f42c1">start</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">        }</span></span>
<span class="line"><span style="color:#24292e">        Sleeper.</span><span style="color:#6f42c1">sleep</span><span style="color:#24292e">(</span><span style="color:#005cc5">1</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">for</span><span style="color:#24292e"> (Integer id </span><span style="color:#d73a49">:</span><span style="color:#24292e"> Mailboxes.</span><span style="color:#6f42c1">getIds</span><span style="color:#24292e">()) {</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Postman</span><span style="color:#24292e">(id, </span><span style="color:#032f62">"内容"</span><span style="color:#24292e"> </span><span style="color:#d73a49">+</span><span style="color:#24292e"> id).</span><span style="color:#6f42c1">start</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">        }</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"><span style="color:#24292e">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">@</span><span style="color:#d73a49">Slf4j</span><span style="color:#24292e">(</span><span style="color:#005cc5">topic</span><span style="color:#24292e"> </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#032f62">"c.People"</span><span style="color:#24292e">)</span></span>
<span class="line"><span style="color:#d73a49">class</span><span style="color:#24292e"> </span><span style="color:#6f42c1">People</span><span style="color:#24292e"> </span><span style="color:#d73a49">extends</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Thread</span><span style="color:#24292e">{</span></span>
<span class="line"><span style="color:#24292e">    @</span><span style="color:#d73a49">Override</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">void</span><span style="color:#24292e"> </span><span style="color:#6f42c1">run</span><span style="color:#24292e">() {</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6a737d">// 收信</span></span>
<span class="line"><span style="color:#24292e">        GuardedObject guardedObject </span><span style="color:#d73a49">=</span><span style="color:#24292e"> Mailboxes.</span><span style="color:#6f42c1">createGuardedObject</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">        log.</span><span style="color:#6f42c1">debug</span><span style="color:#24292e">(</span><span style="color:#032f62">"开始收信 id:{}"</span><span style="color:#24292e">, guardedObject.</span><span style="color:#6f42c1">getId</span><span style="color:#24292e">());</span></span>
<span class="line"><span style="color:#24292e">        Object mail </span><span style="color:#d73a49">=</span><span style="color:#24292e"> guardedObject.</span><span style="color:#6f42c1">get</span><span style="color:#24292e">(</span><span style="color:#005cc5">5000</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">        log.</span><span style="color:#6f42c1">debug</span><span style="color:#24292e">(</span><span style="color:#032f62">"收到信 id:{}, 内容:{}"</span><span style="color:#24292e">, guardedObject.</span><span style="color:#6f42c1">getId</span><span style="color:#24292e">(), mail);</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"><span style="color:#24292e">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">@</span><span style="color:#d73a49">Slf4j</span><span style="color:#24292e">(</span><span style="color:#005cc5">topic</span><span style="color:#24292e"> </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#032f62">"c.Postman"</span><span style="color:#24292e">)</span></span>
<span class="line"><span style="color:#d73a49">class</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Postman</span><span style="color:#24292e"> </span><span style="color:#d73a49">extends</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Thread</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">private</span><span style="color:#24292e"> </span><span style="color:#d73a49">int</span><span style="color:#24292e"> id;</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">private</span><span style="color:#24292e"> String mail;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Postman</span><span style="color:#24292e">(</span><span style="color:#d73a49">int</span><span style="color:#24292e"> </span><span style="color:#e36209">id</span><span style="color:#24292e">, String </span><span style="color:#e36209">mail</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#005cc5">this</span><span style="color:#24292e">.id </span><span style="color:#d73a49">=</span><span style="color:#24292e"> id;</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#005cc5">this</span><span style="color:#24292e">.mail </span><span style="color:#d73a49">=</span><span style="color:#24292e"> mail;</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">    @</span><span style="color:#d73a49">Override</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">void</span><span style="color:#24292e"> </span><span style="color:#6f42c1">run</span><span style="color:#24292e">() {</span></span>
<span class="line"><span style="color:#24292e">        GuardedObject guardedObject </span><span style="color:#d73a49">=</span><span style="color:#24292e"> Mailboxes.</span><span style="color:#6f42c1">getGuardedObject</span><span style="color:#24292e">(id);</span></span>
<span class="line"><span style="color:#24292e">        log.</span><span style="color:#6f42c1">debug</span><span style="color:#24292e">(</span><span style="color:#032f62">"送信 id:{}, 内容:{}"</span><span style="color:#24292e">, id, mail);</span></span>
<span class="line"><span style="color:#24292e">        guardedObject.</span><span style="color:#6f42c1">complete</span><span style="color:#24292e">(mail);</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"><span style="color:#24292e">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#d73a49">class</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Mailboxes</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">private</span><span style="color:#24292e"> </span><span style="color:#d73a49">static</span><span style="color:#24292e"> Map&lt;</span><span style="color:#d73a49">Integer</span><span style="color:#24292e">, </span><span style="color:#d73a49">GuardedObject</span><span style="color:#24292e">&gt; boxes </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> Hashtable&lt;&gt;();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">private</span><span style="color:#24292e"> </span><span style="color:#d73a49">static</span><span style="color:#24292e"> </span><span style="color:#d73a49">int</span><span style="color:#24292e"> id </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#005cc5">1</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">// 产生唯一 id</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">private</span><span style="color:#24292e"> </span><span style="color:#d73a49">static</span><span style="color:#24292e"> </span><span style="color:#d73a49">synchronized</span><span style="color:#24292e"> </span><span style="color:#d73a49">int</span><span style="color:#24292e"> </span><span style="color:#6f42c1">generateId</span><span style="color:#24292e">() {</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">return</span><span style="color:#24292e"> id</span><span style="color:#d73a49">++</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">static</span><span style="color:#24292e"> GuardedObject </span><span style="color:#6f42c1">getGuardedObject</span><span style="color:#24292e">(</span><span style="color:#d73a49">int</span><span style="color:#24292e"> </span><span style="color:#e36209">id</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">return</span><span style="color:#24292e"> boxes.</span><span style="color:#6f42c1">remove</span><span style="color:#24292e">(id);</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">static</span><span style="color:#24292e"> GuardedObject </span><span style="color:#6f42c1">createGuardedObject</span><span style="color:#24292e">() {</span></span>
<span class="line"><span style="color:#24292e">        GuardedObject go </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">GuardedObject</span><span style="color:#24292e">(</span><span style="color:#6f42c1">generateId</span><span style="color:#24292e">());</span></span>
<span class="line"><span style="color:#24292e">        boxes.</span><span style="color:#6f42c1">put</span><span style="color:#24292e">(go.</span><span style="color:#6f42c1">getId</span><span style="color:#24292e">(), go);</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">return</span><span style="color:#24292e"> go;</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">static</span><span style="color:#24292e"> Set&lt;</span><span style="color:#d73a49">Integer</span><span style="color:#24292e">&gt; </span><span style="color:#6f42c1">getIds</span><span style="color:#24292e">() {</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">return</span><span style="color:#24292e"> boxes.</span><span style="color:#6f42c1">keySet</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"><span style="color:#24292e">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6a737d">// 增加超时效果</span></span>
<span class="line"><span style="color:#d73a49">class</span><span style="color:#24292e"> </span><span style="color:#6f42c1">GuardedObject</span><span style="color:#24292e"> {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">// 标识 Guarded Object</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">private</span><span style="color:#24292e"> </span><span style="color:#d73a49">int</span><span style="color:#24292e"> id;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#6f42c1">GuardedObject</span><span style="color:#24292e">(</span><span style="color:#d73a49">int</span><span style="color:#24292e"> </span><span style="color:#e36209">id</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#005cc5">this</span><span style="color:#24292e">.id </span><span style="color:#d73a49">=</span><span style="color:#24292e"> id;</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">int</span><span style="color:#24292e"> </span><span style="color:#6f42c1">getId</span><span style="color:#24292e">() {</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">return</span><span style="color:#24292e"> id;</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">// 结果</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">private</span><span style="color:#24292e"> Object response;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">// 获取结果</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">// timeout 表示要等待多久 2000</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">public</span><span style="color:#24292e"> Object </span><span style="color:#6f42c1">get</span><span style="color:#24292e">(</span><span style="color:#d73a49">long</span><span style="color:#24292e"> </span><span style="color:#e36209">timeout</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">synchronized</span><span style="color:#24292e"> (</span><span style="color:#005cc5">this</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#6a737d">// 开始时间 15:00:00</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">long</span><span style="color:#24292e"> begin </span><span style="color:#d73a49">=</span><span style="color:#24292e"> System.</span><span style="color:#6f42c1">currentTimeMillis</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#6a737d">// 经历的时间</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">long</span><span style="color:#24292e"> passedTime </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#005cc5">0</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">while</span><span style="color:#24292e"> (response </span><span style="color:#d73a49">==</span><span style="color:#24292e"> </span><span style="color:#005cc5">null</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#6a737d">// 这一轮循环应该等待的时间</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#d73a49">long</span><span style="color:#24292e"> waitTime </span><span style="color:#d73a49">=</span><span style="color:#24292e"> timeout </span><span style="color:#d73a49">-</span><span style="color:#24292e"> passedTime;</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#6a737d">// 经历的时间超过了最大等待时间时，退出循环</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (timeout </span><span style="color:#d73a49">-</span><span style="color:#24292e"> passedTime </span><span style="color:#d73a49">&lt;=</span><span style="color:#24292e"> </span><span style="color:#005cc5">0</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">                    </span><span style="color:#d73a49">break</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">                }</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#d73a49">try</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">                    </span><span style="color:#005cc5">this</span><span style="color:#24292e">.</span><span style="color:#6f42c1">wait</span><span style="color:#24292e">(waitTime); </span><span style="color:#6a737d">// 虚假唤醒 15:00:01</span></span>
<span class="line"><span style="color:#24292e">                } </span><span style="color:#d73a49">catch</span><span style="color:#24292e"> (InterruptedException </span><span style="color:#e36209">e</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">                    e.</span><span style="color:#6f42c1">printStackTrace</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">                }</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#6a737d">// 求得经历时间</span></span>
<span class="line"><span style="color:#24292e">                passedTime </span><span style="color:#d73a49">=</span><span style="color:#24292e"> System.</span><span style="color:#6f42c1">currentTimeMillis</span><span style="color:#24292e">() </span><span style="color:#d73a49">-</span><span style="color:#24292e"> begin; </span><span style="color:#6a737d">// 15:00:02  1s</span></span>
<span class="line"><span style="color:#24292e">            }</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">return</span><span style="color:#24292e"> response;</span></span>
<span class="line"><span style="color:#24292e">        }</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">// 产生结果</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">void</span><span style="color:#24292e"> </span><span style="color:#6f42c1">complete</span><span style="color:#24292e">(Object </span><span style="color:#e36209">response</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">synchronized</span><span style="color:#24292e"> (</span><span style="color:#005cc5">this</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#6a737d">// 给结果成员变量赋值</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#005cc5">this</span><span style="color:#24292e">.response </span><span style="color:#d73a49">=</span><span style="color:#24292e"> response;</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#005cc5">this</span><span style="color:#24292e">.</span><span style="color:#6f42c1">notifyAll</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">        }</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"><span style="color:#24292e">}</span></span></code></pre></div><p>某次结果：</p><figure><img src="https://jsd.cdn.zzko.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230712214931473.png" alt="image-20230712214931473" loading="lazy" decoding="async"></figure><p>一个邮递员对应一封信，是一种一一对应的关系，是这种保护性暂停特有的东西，通过中间类解耦结果产生者和结果接收者，这种模式在RPC框架中经常见到，而且这个中间类是可以重用的，具有一定的复用性</p><h3 id="_7-5、异步模式之生产者-消费者" tabindex="-1">7.5、异步模式之生产者/消费者 <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20intermediate%20level#_7-5、异步模式之生产者-消费者" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h3><h4 id="_1-定义-1" tabindex="-1">(1)定义 <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20intermediate%20level#_1-定义-1" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h4><p>要点</p><ul><li>与前面的保护性暂停中的 GuardObject 不同，不需要产生结果和消费结果的线程一一对应</li><li>消费队列可以用来平衡生产和消费的线程资源</li><li>生产者仅负责产生结果数据，不关心数据该如何处理，而消费者专心处理结果数据</li><li>消息队列是有容量限制的，满时不会再加入数据，空时不会再消耗数据</li><li>JDK 中各种阻塞队列，采用的就是这种模式</li></ul><figure><img src="https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230712221519679.png" alt="image-20230712221519679" loading="lazy" decoding="async"></figure><h4 id="_2-实现-1" tabindex="-1">(2)实现 <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20intermediate%20level#_2-实现-1" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h4><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8">@</span><span style="color:#f97583">Slf4j</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">topic</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#9ecbff">"c.Test21"</span><span style="color:#e1e4e8">)</span></span>
<span class="line"><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">class</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Test21</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">static</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">void</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">main</span><span style="color:#e1e4e8">(</span><span style="color:#f97583">String</span><span style="color:#e1e4e8">[] </span><span style="color:#ffab70">args</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">        MessageQueue queue </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">MessageQueue</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">2</span><span style="color:#e1e4e8">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">for</span><span style="color:#e1e4e8"> (</span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> i </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8">; i </span><span style="color:#f97583">&lt;</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">3</span><span style="color:#e1e4e8">; i</span><span style="color:#f97583">++</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> id </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> i;</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Thread</span><span style="color:#e1e4e8">(() </span><span style="color:#f97583">-&gt;</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">                queue.</span><span style="color:#b392f0">put</span><span style="color:#e1e4e8">(</span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Message</span><span style="color:#e1e4e8">(id , </span><span style="color:#9ecbff">"值"</span><span style="color:#f97583">+</span><span style="color:#e1e4e8">id));</span></span>
<span class="line"><span style="color:#e1e4e8">            }, </span><span style="color:#9ecbff">"生产者"</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">+</span><span style="color:#e1e4e8"> i).</span><span style="color:#b392f0">start</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">        }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Thread</span><span style="color:#e1e4e8">(() </span><span style="color:#f97583">-&gt;</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">while</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">true</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#b392f0">sleep</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">1</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">                Message message </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> queue.</span><span style="color:#b392f0">take</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">            }</span></span>
<span class="line"><span style="color:#e1e4e8">        }, </span><span style="color:#9ecbff">"消费者"</span><span style="color:#e1e4e8">).</span><span style="color:#b392f0">start</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6a737d">// 消息队列类 ， java 线程之间通信</span></span>
<span class="line"><span style="color:#e1e4e8">@</span><span style="color:#f97583">Slf4j</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">topic</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#9ecbff">"c.MessageQueue"</span><span style="color:#e1e4e8">)</span></span>
<span class="line"><span style="color:#f97583">class</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">MessageQueue</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">// 消息的队列集合</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">private</span><span style="color:#e1e4e8"> LinkedList&lt;</span><span style="color:#f97583">Message</span><span style="color:#e1e4e8">&gt; list </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> LinkedList&lt;&gt;();</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">// 队列容量</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">private</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> capcity;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">MessageQueue</span><span style="color:#e1e4e8">(</span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> </span><span style="color:#ffab70">capcity</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#79b8ff">this</span><span style="color:#e1e4e8">.capcity </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> capcity;</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">// 获取消息</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">public</span><span style="color:#e1e4e8"> Message </span><span style="color:#b392f0">take</span><span style="color:#e1e4e8">() {</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#6a737d">// 检查队列是否为空</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">synchronized</span><span style="color:#e1e4e8"> (list) {</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">while</span><span style="color:#e1e4e8">(list.</span><span style="color:#b392f0">isEmpty</span><span style="color:#e1e4e8">()) {</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#f97583">try</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">                    log.</span><span style="color:#b392f0">debug</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"队列为空, 消费者线程等待"</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">                    list.</span><span style="color:#b392f0">wait</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">                } </span><span style="color:#f97583">catch</span><span style="color:#e1e4e8"> (InterruptedException </span><span style="color:#ffab70">e</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">                    e.</span><span style="color:#b392f0">printStackTrace</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">                }</span></span>
<span class="line"><span style="color:#e1e4e8">            }</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#6a737d">// 从队列头部获取消息并返回</span></span>
<span class="line"><span style="color:#e1e4e8">            Message message </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> list.</span><span style="color:#b392f0">removeFirst</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">            log.</span><span style="color:#b392f0">debug</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"已消费消息 {}"</span><span style="color:#e1e4e8">, message);</span></span>
<span class="line"><span style="color:#e1e4e8">            list.</span><span style="color:#b392f0">notifyAll</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> message;</span></span>
<span class="line"><span style="color:#e1e4e8">        }</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">// 存入消息</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">void</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">put</span><span style="color:#e1e4e8">(Message </span><span style="color:#ffab70">message</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">synchronized</span><span style="color:#e1e4e8"> (list) {</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#6a737d">// 检查对象是否已满</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">while</span><span style="color:#e1e4e8">(list.</span><span style="color:#b392f0">size</span><span style="color:#e1e4e8">() </span><span style="color:#f97583">==</span><span style="color:#e1e4e8"> capcity) {</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#f97583">try</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">                    log.</span><span style="color:#b392f0">debug</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"队列已满, 生产者线程等待"</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">                    list.</span><span style="color:#b392f0">wait</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">                } </span><span style="color:#f97583">catch</span><span style="color:#e1e4e8"> (InterruptedException </span><span style="color:#ffab70">e</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">                    e.</span><span style="color:#b392f0">printStackTrace</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">                }</span></span>
<span class="line"><span style="color:#e1e4e8">            }</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#6a737d">// 将消息加入队列尾部</span></span>
<span class="line"><span style="color:#e1e4e8">            list.</span><span style="color:#b392f0">addLast</span><span style="color:#e1e4e8">(message);</span></span>
<span class="line"><span style="color:#e1e4e8">            log.</span><span style="color:#b392f0">debug</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"已生产消息 {}"</span><span style="color:#e1e4e8">, message);</span></span>
<span class="line"><span style="color:#e1e4e8">            list.</span><span style="color:#b392f0">notifyAll</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">        }</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"><span style="color:#e1e4e8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#f97583">final</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">class</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Message</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">private</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> id;</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">private</span><span style="color:#e1e4e8"> Object value;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Message</span><span style="color:#e1e4e8">(</span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> </span><span style="color:#ffab70">id</span><span style="color:#e1e4e8">, Object </span><span style="color:#ffab70">value</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#79b8ff">this</span><span style="color:#e1e4e8">.id </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> id;</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#79b8ff">this</span><span style="color:#e1e4e8">.value </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> value;</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">getId</span><span style="color:#e1e4e8">() {</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> id;</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">public</span><span style="color:#e1e4e8"> Object </span><span style="color:#b392f0">getValue</span><span style="color:#e1e4e8">() {</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> value;</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">    @</span><span style="color:#f97583">Override</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">public</span><span style="color:#e1e4e8"> String </span><span style="color:#b392f0">toString</span><span style="color:#e1e4e8">() {</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> </span><span style="color:#9ecbff">"Message{"</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">+</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#9ecbff">"id="</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">+</span><span style="color:#e1e4e8"> id </span><span style="color:#f97583">+</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#9ecbff">", value="</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">+</span><span style="color:#e1e4e8"> value </span><span style="color:#f97583">+</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#9ecbff">'}'</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"><span style="color:#e1e4e8">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e">@</span><span style="color:#d73a49">Slf4j</span><span style="color:#24292e">(</span><span style="color:#005cc5">topic</span><span style="color:#24292e"> </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#032f62">"c.Test21"</span><span style="color:#24292e">)</span></span>
<span class="line"><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">class</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Test21</span><span style="color:#24292e"> {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">static</span><span style="color:#24292e"> </span><span style="color:#d73a49">void</span><span style="color:#24292e"> </span><span style="color:#6f42c1">main</span><span style="color:#24292e">(</span><span style="color:#d73a49">String</span><span style="color:#24292e">[] </span><span style="color:#e36209">args</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">        MessageQueue queue </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">MessageQueue</span><span style="color:#24292e">(</span><span style="color:#005cc5">2</span><span style="color:#24292e">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">for</span><span style="color:#24292e"> (</span><span style="color:#d73a49">int</span><span style="color:#24292e"> i </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#005cc5">0</span><span style="color:#24292e">; i </span><span style="color:#d73a49">&lt;</span><span style="color:#24292e"> </span><span style="color:#005cc5">3</span><span style="color:#24292e">; i</span><span style="color:#d73a49">++</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">int</span><span style="color:#24292e"> id </span><span style="color:#d73a49">=</span><span style="color:#24292e"> i;</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Thread</span><span style="color:#24292e">(() </span><span style="color:#d73a49">-&gt;</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">                queue.</span><span style="color:#6f42c1">put</span><span style="color:#24292e">(</span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Message</span><span style="color:#24292e">(id , </span><span style="color:#032f62">"值"</span><span style="color:#d73a49">+</span><span style="color:#24292e">id));</span></span>
<span class="line"><span style="color:#24292e">            }, </span><span style="color:#032f62">"生产者"</span><span style="color:#24292e"> </span><span style="color:#d73a49">+</span><span style="color:#24292e"> i).</span><span style="color:#6f42c1">start</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">        }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Thread</span><span style="color:#24292e">(() </span><span style="color:#d73a49">-&gt;</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">while</span><span style="color:#24292e">(</span><span style="color:#005cc5">true</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#6f42c1">sleep</span><span style="color:#24292e">(</span><span style="color:#005cc5">1</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">                Message message </span><span style="color:#d73a49">=</span><span style="color:#24292e"> queue.</span><span style="color:#6f42c1">take</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">            }</span></span>
<span class="line"><span style="color:#24292e">        }, </span><span style="color:#032f62">"消费者"</span><span style="color:#24292e">).</span><span style="color:#6f42c1">start</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6a737d">// 消息队列类 ， java 线程之间通信</span></span>
<span class="line"><span style="color:#24292e">@</span><span style="color:#d73a49">Slf4j</span><span style="color:#24292e">(</span><span style="color:#005cc5">topic</span><span style="color:#24292e"> </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#032f62">"c.MessageQueue"</span><span style="color:#24292e">)</span></span>
<span class="line"><span style="color:#d73a49">class</span><span style="color:#24292e"> </span><span style="color:#6f42c1">MessageQueue</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">// 消息的队列集合</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">private</span><span style="color:#24292e"> LinkedList&lt;</span><span style="color:#d73a49">Message</span><span style="color:#24292e">&gt; list </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> LinkedList&lt;&gt;();</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">// 队列容量</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">private</span><span style="color:#24292e"> </span><span style="color:#d73a49">int</span><span style="color:#24292e"> capcity;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#6f42c1">MessageQueue</span><span style="color:#24292e">(</span><span style="color:#d73a49">int</span><span style="color:#24292e"> </span><span style="color:#e36209">capcity</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#005cc5">this</span><span style="color:#24292e">.capcity </span><span style="color:#d73a49">=</span><span style="color:#24292e"> capcity;</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">// 获取消息</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">public</span><span style="color:#24292e"> Message </span><span style="color:#6f42c1">take</span><span style="color:#24292e">() {</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6a737d">// 检查队列是否为空</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">synchronized</span><span style="color:#24292e"> (list) {</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">while</span><span style="color:#24292e">(list.</span><span style="color:#6f42c1">isEmpty</span><span style="color:#24292e">()) {</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#d73a49">try</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">                    log.</span><span style="color:#6f42c1">debug</span><span style="color:#24292e">(</span><span style="color:#032f62">"队列为空, 消费者线程等待"</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">                    list.</span><span style="color:#6f42c1">wait</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">                } </span><span style="color:#d73a49">catch</span><span style="color:#24292e"> (InterruptedException </span><span style="color:#e36209">e</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">                    e.</span><span style="color:#6f42c1">printStackTrace</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">                }</span></span>
<span class="line"><span style="color:#24292e">            }</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#6a737d">// 从队列头部获取消息并返回</span></span>
<span class="line"><span style="color:#24292e">            Message message </span><span style="color:#d73a49">=</span><span style="color:#24292e"> list.</span><span style="color:#6f42c1">removeFirst</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">            log.</span><span style="color:#6f42c1">debug</span><span style="color:#24292e">(</span><span style="color:#032f62">"已消费消息 {}"</span><span style="color:#24292e">, message);</span></span>
<span class="line"><span style="color:#24292e">            list.</span><span style="color:#6f42c1">notifyAll</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">return</span><span style="color:#24292e"> message;</span></span>
<span class="line"><span style="color:#24292e">        }</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">// 存入消息</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">void</span><span style="color:#24292e"> </span><span style="color:#6f42c1">put</span><span style="color:#24292e">(Message </span><span style="color:#e36209">message</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">synchronized</span><span style="color:#24292e"> (list) {</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#6a737d">// 检查对象是否已满</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">while</span><span style="color:#24292e">(list.</span><span style="color:#6f42c1">size</span><span style="color:#24292e">() </span><span style="color:#d73a49">==</span><span style="color:#24292e"> capcity) {</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#d73a49">try</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">                    log.</span><span style="color:#6f42c1">debug</span><span style="color:#24292e">(</span><span style="color:#032f62">"队列已满, 生产者线程等待"</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">                    list.</span><span style="color:#6f42c1">wait</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">                } </span><span style="color:#d73a49">catch</span><span style="color:#24292e"> (InterruptedException </span><span style="color:#e36209">e</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">                    e.</span><span style="color:#6f42c1">printStackTrace</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">                }</span></span>
<span class="line"><span style="color:#24292e">            }</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#6a737d">// 将消息加入队列尾部</span></span>
<span class="line"><span style="color:#24292e">            list.</span><span style="color:#6f42c1">addLast</span><span style="color:#24292e">(message);</span></span>
<span class="line"><span style="color:#24292e">            log.</span><span style="color:#6f42c1">debug</span><span style="color:#24292e">(</span><span style="color:#032f62">"已生产消息 {}"</span><span style="color:#24292e">, message);</span></span>
<span class="line"><span style="color:#24292e">            list.</span><span style="color:#6f42c1">notifyAll</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">        }</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"><span style="color:#24292e">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#d73a49">final</span><span style="color:#24292e"> </span><span style="color:#d73a49">class</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Message</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">private</span><span style="color:#24292e"> </span><span style="color:#d73a49">int</span><span style="color:#24292e"> id;</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">private</span><span style="color:#24292e"> Object value;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Message</span><span style="color:#24292e">(</span><span style="color:#d73a49">int</span><span style="color:#24292e"> </span><span style="color:#e36209">id</span><span style="color:#24292e">, Object </span><span style="color:#e36209">value</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#005cc5">this</span><span style="color:#24292e">.id </span><span style="color:#d73a49">=</span><span style="color:#24292e"> id;</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#005cc5">this</span><span style="color:#24292e">.value </span><span style="color:#d73a49">=</span><span style="color:#24292e"> value;</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">int</span><span style="color:#24292e"> </span><span style="color:#6f42c1">getId</span><span style="color:#24292e">() {</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">return</span><span style="color:#24292e"> id;</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">public</span><span style="color:#24292e"> Object </span><span style="color:#6f42c1">getValue</span><span style="color:#24292e">() {</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">return</span><span style="color:#24292e"> value;</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">    @</span><span style="color:#d73a49">Override</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">public</span><span style="color:#24292e"> String </span><span style="color:#6f42c1">toString</span><span style="color:#24292e">() {</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">return</span><span style="color:#24292e"> </span><span style="color:#032f62">"Message{"</span><span style="color:#24292e"> </span><span style="color:#d73a49">+</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#032f62">"id="</span><span style="color:#24292e"> </span><span style="color:#d73a49">+</span><span style="color:#24292e"> id </span><span style="color:#d73a49">+</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#032f62">", value="</span><span style="color:#24292e"> </span><span style="color:#d73a49">+</span><span style="color:#24292e"> value </span><span style="color:#d73a49">+</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#032f62">'}'</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"><span style="color:#24292e">}</span></span></code></pre></div><figure><img src="https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230712223137393.png" alt="image-20230712223137393" loading="lazy" decoding="async"></figure><h3 id="_8、park-unpark" tabindex="-1">8、park/unpark <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20intermediate%20level#_8、park-unpark" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h3><h4 id="_1-基本使用" tabindex="-1">(1)基本使用 <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20intermediate%20level#_1-基本使用" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h4><p><strong>park/unpark都是LockSupport类中的的方法</strong></p><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6a737d">//暂停线程运行</span></span>
<span class="line"><span style="color:#e1e4e8">LockSupport.park;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6a737d">//恢复线程运行</span></span>
<span class="line"><span style="color:#e1e4e8">LockSupport.</span><span style="color:#b392f0">unpark</span><span style="color:#e1e4e8">(thread);</span></span>
<span class="line"><span style="color:#e1e4e8">@</span><span style="color:#f97583">Slf4j</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">topic</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#9ecbff">"c.TestParkUnpark"</span><span style="color:#e1e4e8">)</span></span>
<span class="line"><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">class</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">TestParkUnpark</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">static</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">void</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">main</span><span style="color:#e1e4e8">(</span><span style="color:#f97583">String</span><span style="color:#e1e4e8">[] </span><span style="color:#ffab70">args</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">        Thread t1 </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Thread</span><span style="color:#e1e4e8">(() </span><span style="color:#f97583">-&gt;</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">            log.</span><span style="color:#b392f0">debug</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"start..."</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#b392f0">sleep</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">1</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">            log.</span><span style="color:#b392f0">debug</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"park..."</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">            LockSupport.</span><span style="color:#b392f0">park</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">            log.</span><span style="color:#b392f0">debug</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"resume..."</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">        }, </span><span style="color:#9ecbff">"t1"</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">        t1.</span><span style="color:#b392f0">start</span><span style="color:#e1e4e8">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#b392f0">sleep</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">2</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">        log.</span><span style="color:#b392f0">debug</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"unpark..."</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">        LockSupport.</span><span style="color:#b392f0">unpark</span><span style="color:#e1e4e8">(t1);</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"><span style="color:#e1e4e8">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6a737d">//暂停线程运行</span></span>
<span class="line"><span style="color:#24292e">LockSupport.park;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6a737d">//恢复线程运行</span></span>
<span class="line"><span style="color:#24292e">LockSupport.</span><span style="color:#6f42c1">unpark</span><span style="color:#24292e">(thread);</span></span>
<span class="line"><span style="color:#24292e">@</span><span style="color:#d73a49">Slf4j</span><span style="color:#24292e">(</span><span style="color:#005cc5">topic</span><span style="color:#24292e"> </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#032f62">"c.TestParkUnpark"</span><span style="color:#24292e">)</span></span>
<span class="line"><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">class</span><span style="color:#24292e"> </span><span style="color:#6f42c1">TestParkUnpark</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">static</span><span style="color:#24292e"> </span><span style="color:#d73a49">void</span><span style="color:#24292e"> </span><span style="color:#6f42c1">main</span><span style="color:#24292e">(</span><span style="color:#d73a49">String</span><span style="color:#24292e">[] </span><span style="color:#e36209">args</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">        Thread t1 </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Thread</span><span style="color:#24292e">(() </span><span style="color:#d73a49">-&gt;</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">            log.</span><span style="color:#6f42c1">debug</span><span style="color:#24292e">(</span><span style="color:#032f62">"start..."</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#6f42c1">sleep</span><span style="color:#24292e">(</span><span style="color:#005cc5">1</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">            log.</span><span style="color:#6f42c1">debug</span><span style="color:#24292e">(</span><span style="color:#032f62">"park..."</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">            LockSupport.</span><span style="color:#6f42c1">park</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">            log.</span><span style="color:#6f42c1">debug</span><span style="color:#24292e">(</span><span style="color:#032f62">"resume..."</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">        }, </span><span style="color:#032f62">"t1"</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">        t1.</span><span style="color:#6f42c1">start</span><span style="color:#24292e">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6f42c1">sleep</span><span style="color:#24292e">(</span><span style="color:#005cc5">2</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">        log.</span><span style="color:#6f42c1">debug</span><span style="color:#24292e">(</span><span style="color:#032f62">"unpark..."</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">        LockSupport.</span><span style="color:#6f42c1">unpark</span><span style="color:#24292e">(t1);</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"><span style="color:#24292e">}</span></span></code></pre></div><p>先park后unpark情况</p><figure><img src="https://jsd.cdn.zzko.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230713003635612.png" alt="image-20230713003635612" loading="lazy" decoding="async"></figure><p>暂停运行时处于等待状态</p><figure><img src="https://jsd.cdn.zzko.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230713003710458.png" alt="image-20230713003710458" loading="lazy" decoding="async"></figure><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8">...</span></span>
<span class="line"><span style="color:#b392f0">sleep</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">2</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">log.</span><span style="color:#b392f0">debug</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"park..."</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">LockSupport.</span><span style="color:#b392f0">park</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">...</span></span>
<span class="line"><span style="color:#b392f0">sleep</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">1</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">log.</span><span style="color:#b392f0">debug</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"unpark..."</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">LockSupport.</span><span style="color:#b392f0">unpark</span><span style="color:#e1e4e8">(t1);</span></span>
<span class="line"><span style="color:#e1e4e8">...</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e">...</span></span>
<span class="line"><span style="color:#6f42c1">sleep</span><span style="color:#24292e">(</span><span style="color:#005cc5">2</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">log.</span><span style="color:#6f42c1">debug</span><span style="color:#24292e">(</span><span style="color:#032f62">"park..."</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">LockSupport.</span><span style="color:#6f42c1">park</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">...</span></span>
<span class="line"><span style="color:#6f42c1">sleep</span><span style="color:#24292e">(</span><span style="color:#005cc5">1</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">log.</span><span style="color:#6f42c1">debug</span><span style="color:#24292e">(</span><span style="color:#032f62">"unpark..."</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">LockSupport.</span><span style="color:#6f42c1">unpark</span><span style="color:#24292e">(t1);</span></span>
<span class="line"><span style="color:#24292e">...</span></span></code></pre></div><p>先unpark后park情况</p><figure><img src="https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230713003826567.png" alt="image-20230713003826567" loading="lazy" decoding="async"></figure><h4 id="_2-特点" tabindex="-1">(2)特点 <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20intermediate%20level#_2-特点" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h4><p><strong>与wait/notify的区别</strong></p><ul><li>wait，notify 和 notifyAll 必须配合<strong>Object Monitor</strong>一起使用，而park，unpark不必</li><li>park ，unpark 是以<strong>线程为单位</strong>来<strong>阻塞</strong>和<strong>唤醒</strong>线程，而 notify 只能随机唤醒一个等待线程，notifyAll 是唤醒所有等待线程，就不那么精确</li><li>park &amp; unpark 可以<strong>先 unpark</strong>，而 wait &amp; notify 不能先 notify</li><li><strong>park不会释放锁</strong>，而wait会释放锁</li></ul><h4 id="_3-原理" tabindex="-1">(3)原理 <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20intermediate%20level#_3-原理" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h4><blockquote><ul><li>每个线程都有自己的一个 Parker 对象，由三部分组成 _counter ， _cond 和 _mutex 打个比喻</li><li>线程就像一个旅人，Parker 就像他随身携带的背包，条件变量就好比背包中的帐篷。_counter 就好比背包中的备用干粮（0 为耗尽，1 为充足）</li><li>调用 park 就是要看需不需要停下来歇息<ul><li>如果备用干粮耗尽，那么钻进帐篷歇息</li><li>如果备用干粮充足，那么不需停留，继续前进</li></ul></li><li>调用 unpark，就好比令干粮充足<ul><li>如果这时线程还在帐篷，就唤醒让他继续前进</li><li>如果这时线程还在运行，那么下次他调用 park 时，仅是消耗掉备用干粮，不需停留继续前进<ul><li>因为背包空间有限，多次调用 unpark 仅会补充一份备用干粮</li></ul></li></ul></li></ul></blockquote><p>每个线程都有一个自己的<strong>Park对象</strong>，并且该对象**_counter, _cond,__mutex**组成</p><ul><li><p>先调用park再调用unpark时</p><ul><li><p>先调用park</p><ul><li>线程运行时，会将Park对象中的**_counter的值设为0**；</li><li>调用park时，会先查看counter的值是否为0，如果为0，则将线程放入阻塞队列cond中</li><li>放入阻塞队列中后，会<strong>再次</strong>将counter设置为0</li></ul></li></ul><figure><img src="https://jsd.cdn.zzko.cn/gh/imLKlauS/blog-picture@main/blogs/20200608145250.png" alt="img" loading="lazy" decoding="async"></figure><ul><li><p>然后调用unpark</p><ul><li><p>调用unpark方法后，会将counter的值设置为1</p></li><li><p>去唤醒阻塞队列cond中的线程</p></li><li><p>线程继续运行并将counter的值设为0</p></li></ul></li></ul></li></ul><figure><img src="https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/20200608145303.png" alt="img" loading="lazy" decoding="async"></figure><ul><li>先调用unpark，再调用park<ul><li>调用unpark<ul><li>会将counter设置为1（运行时0）</li></ul></li><li>调用park方法<ul><li>查看counter是否为0</li><li>因为unpark已经把counter设置为1，所以此时将counter设置为0，但<strong>不放入</strong>阻塞队列cond中</li></ul></li></ul></li></ul><figure><img src="https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/20200608145313.png" alt="img" loading="lazy" decoding="async"></figure><h3 id="_9、线程中的状态转换" tabindex="-1">9、线程中的状态转换 <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20intermediate%20level#_9、线程中的状态转换" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h3><figure><img src="https://jsd.cdn.zzko.cn/gh/imLKlauS/blog-picture@main/blogs/20200608145330.png" alt="img" loading="lazy" decoding="async"></figure><h4 id="情况一-new-–-runnable" tabindex="-1">情况一：NEW –&gt; RUNNABLE <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20intermediate%20level#情况一-new-–-runnable" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h4><ul><li>当调用了t.start()方法时，由 NEW –&gt; RUNNABLE</li></ul><h4 id="情况二-runnable-–-waiting" tabindex="-1">情况二： RUNNABLE &lt;–&gt; WAITING <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20intermediate%20level#情况二-runnable-–-waiting" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h4><ul><li>当调用了t 线程用 synchronized(obj) 获取了对象锁后<ul><li>调用 obj.wait() 方法时，t 线程从 RUNNABLE –&gt; WAITING</li><li>调用 obj.notify() ， obj.notifyAll() ， t.interrupt() 时<ul><li>竞争锁成功，t 线程从 WAITING –&gt; RUNNABLE</li><li>竞争锁失败，t 线程从 WAITING –&gt; BLOCKED</li></ul></li></ul></li></ul><h4 id="情况三-runnable-–-waiting" tabindex="-1">情况三：RUNNABLE &lt;–&gt; WAITING <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20intermediate%20level#情况三-runnable-–-waiting" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h4><ul><li><p>当前线程</p><p>调用 t.join() 方法时，当前线程从 RUNNABLE –&gt; WAITING</p><ul><li>注意是<strong>当前线程</strong>在t 线程对象的监视器上等待</li></ul></li><li><p>t 线程<strong>运行结束</strong>，或调用了<strong>当前线程</strong>的 interrupt() 时，当前线程从 WAITING –&gt; RUNNABLE</p></li></ul><h4 id="情况四-runnable-–-waiting" tabindex="-1">情况四： RUNNABLE &lt;–&gt; WAITING <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20intermediate%20level#情况四-runnable-–-waiting" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h4><ul><li>当前线程调用 LockSupport.park() 方法会让当前线程从 RUNNABLE –&gt; WAITING</li><li>调用 LockSupport.unpark(目标线程) 或调用了线程 的 interrupt() ，会让目标线程从 WAITING –&gt; RUNNABLE</li></ul><h4 id="情况五-runnable-–-timed-waiting" tabindex="-1">情况五： RUNNABLE &lt;–&gt; TIMED_WAITING <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20intermediate%20level#情况五-runnable-–-timed-waiting" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h4><p>t 线程用 synchronized(obj) 获取了对象锁后</p><ul><li>调用 obj.wait(<strong>long n</strong>) 方法时，t 线程从 RUNNABLE –&gt; TIMED_WAITING</li><li>t 线程等待时间超过了 n 毫秒，或调用 obj.notify() ， obj.notifyAll() ， t.interrupt() 时<ul><li>竞争锁成功，t 线程从 TIMED_WAITING –&gt; RUNNABLE</li><li>竞争锁失败，t 线程从 TIMED_WAITING –&gt; BLOCKED</li></ul></li></ul><h4 id="情况六-runnable-–-timed-waiting" tabindex="-1">情况六：RUNNABLE &lt;–&gt; TIMED_WAITING <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20intermediate%20level#情况六-runnable-–-timed-waiting" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h4><ul><li><p>当前线程调用 t.join(long n) 方法时，当前线程从 RUNNABLE –&gt; TIMED_WAITING</p><ul><li>注意是当前线程在t 线程对象的监视器上等待</li></ul></li><li><p>当前线程等待时间超过了 n 毫秒，或t 线程运行结束，或调用了当前线程的 interrupt() 时，当前线程从 TIMED_WAITING –&gt; RUNNABLE</p></li></ul><h4 id="情况七-runnable-–-timed-waiting" tabindex="-1">情况七：RUNNABLE &lt;–&gt; TIMED_WAITING <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20intermediate%20level#情况七-runnable-–-timed-waiting" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h4><ul><li>当前线程调用 Thread.sleep(long n) ，当前线程从 RUNNABLE –&gt; TIMED_WAITING</li><li>当前线程等待时间超过了 n 毫秒，当前线程从 TIMED_WAITING –&gt; RUNNABLE</li></ul><h4 id="情况八-runnable-–-timed-waiting" tabindex="-1">情况八：RUNNABLE &lt;–&gt; TIMED_WAITING <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20intermediate%20level#情况八-runnable-–-timed-waiting" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h4><ul><li>当前线程调用 LockSupport.parkNanos(long nanos) 或 LockSupport.parkUntil(long millis) 时，当前线 程从 RUNNABLE –&gt; TIMED_WAITING</li><li>调用 LockSupport.unpark(目标线程) 或调用了线程 的 interrupt() ，或是等待超时，会让目标线程从 TIMED_WAITING–&gt; RUNNABLE</li></ul><h4 id="情况九-runnable-–-blocked" tabindex="-1">情况九：RUNNABLE &lt;–&gt; BLOCKED <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20intermediate%20level#情况九-runnable-–-blocked" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h4><ul><li>t 线程用 synchronized(obj) 获取了对象锁时如果<strong>竞争失败</strong>，从 RUNNABLE –&gt; BLOCKED</li><li>持 obj 锁线程的同步代码块执行完毕，会唤醒该对象上所有 BLOCKED 的线程重新竞争，如果其中 t 线程竞争 成功，从 BLOCKED –&gt; RUNNABLE ，其它<strong>失败</strong>的线程仍然 BLOCKED</li></ul><h4 id="情况十-runnable-–-terminated" tabindex="-1">情况十： RUNNABLE &lt;–&gt; TERMINATED <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20intermediate%20level#情况十-runnable-–-terminated" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h4><p>当前线<strong>程所有代码运行完毕</strong>，进入 TERMINATED</p><h3 id="_10、多把锁" tabindex="-1">10、多把锁 <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20intermediate%20level#_10、多把锁" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h3><p><strong>将锁的粒度细分</strong></p><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">class</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">TestMultiLock</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">static</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">void</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">main</span><span style="color:#e1e4e8">(</span><span style="color:#f97583">String</span><span style="color:#e1e4e8">[] </span><span style="color:#ffab70">args</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">        BigRoom bigRoom </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">BigRoom</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Thread</span><span style="color:#e1e4e8">(() </span><span style="color:#f97583">-&gt;</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">            bigRoom.</span><span style="color:#b392f0">study</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">        },</span><span style="color:#9ecbff">"小南"</span><span style="color:#e1e4e8">).</span><span style="color:#b392f0">start</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Thread</span><span style="color:#e1e4e8">(() </span><span style="color:#f97583">-&gt;</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">            bigRoom.</span><span style="color:#b392f0">sleep</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">        },</span><span style="color:#9ecbff">"小女"</span><span style="color:#e1e4e8">).</span><span style="color:#b392f0">start</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"><span style="color:#e1e4e8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">@</span><span style="color:#f97583">Slf4j</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">topic</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#9ecbff">"c.BigRoom"</span><span style="color:#e1e4e8">)</span></span>
<span class="line"><span style="color:#f97583">class</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">BigRoom</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">private</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">final</span><span style="color:#e1e4e8"> Object studyRoom </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Object</span><span style="color:#e1e4e8">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">private</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">final</span><span style="color:#e1e4e8"> Object bedRoom </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Object</span><span style="color:#e1e4e8">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">void</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">sleep</span><span style="color:#e1e4e8">() {</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">synchronized</span><span style="color:#e1e4e8"> (bedRoom) {</span></span>
<span class="line"><span style="color:#e1e4e8">            log.</span><span style="color:#b392f0">debug</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"sleeping 2 小时"</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">            Sleeper.</span><span style="color:#b392f0">sleep</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">2</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">        }</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">void</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">study</span><span style="color:#e1e4e8">() {</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">synchronized</span><span style="color:#e1e4e8"> (studyRoom) {</span></span>
<span class="line"><span style="color:#e1e4e8">            log.</span><span style="color:#b392f0">debug</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"study 1 小时"</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">            Sleeper.</span><span style="color:#b392f0">sleep</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">1</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">        }</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">class</span><span style="color:#24292e"> </span><span style="color:#6f42c1">TestMultiLock</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">static</span><span style="color:#24292e"> </span><span style="color:#d73a49">void</span><span style="color:#24292e"> </span><span style="color:#6f42c1">main</span><span style="color:#24292e">(</span><span style="color:#d73a49">String</span><span style="color:#24292e">[] </span><span style="color:#e36209">args</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">        BigRoom bigRoom </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">BigRoom</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Thread</span><span style="color:#24292e">(() </span><span style="color:#d73a49">-&gt;</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">            bigRoom.</span><span style="color:#6f42c1">study</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">        },</span><span style="color:#032f62">"小南"</span><span style="color:#24292e">).</span><span style="color:#6f42c1">start</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Thread</span><span style="color:#24292e">(() </span><span style="color:#d73a49">-&gt;</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">            bigRoom.</span><span style="color:#6f42c1">sleep</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">        },</span><span style="color:#032f62">"小女"</span><span style="color:#24292e">).</span><span style="color:#6f42c1">start</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"><span style="color:#24292e">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">@</span><span style="color:#d73a49">Slf4j</span><span style="color:#24292e">(</span><span style="color:#005cc5">topic</span><span style="color:#24292e"> </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#032f62">"c.BigRoom"</span><span style="color:#24292e">)</span></span>
<span class="line"><span style="color:#d73a49">class</span><span style="color:#24292e"> </span><span style="color:#6f42c1">BigRoom</span><span style="color:#24292e"> {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">private</span><span style="color:#24292e"> </span><span style="color:#d73a49">final</span><span style="color:#24292e"> Object studyRoom </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Object</span><span style="color:#24292e">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">private</span><span style="color:#24292e"> </span><span style="color:#d73a49">final</span><span style="color:#24292e"> Object bedRoom </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Object</span><span style="color:#24292e">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">void</span><span style="color:#24292e"> </span><span style="color:#6f42c1">sleep</span><span style="color:#24292e">() {</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">synchronized</span><span style="color:#24292e"> (bedRoom) {</span></span>
<span class="line"><span style="color:#24292e">            log.</span><span style="color:#6f42c1">debug</span><span style="color:#24292e">(</span><span style="color:#032f62">"sleeping 2 小时"</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">            Sleeper.</span><span style="color:#6f42c1">sleep</span><span style="color:#24292e">(</span><span style="color:#005cc5">2</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">        }</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">void</span><span style="color:#24292e"> </span><span style="color:#6f42c1">study</span><span style="color:#24292e">() {</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">synchronized</span><span style="color:#24292e"> (studyRoom) {</span></span>
<span class="line"><span style="color:#24292e">            log.</span><span style="color:#6f42c1">debug</span><span style="color:#24292e">(</span><span style="color:#032f62">"study 1 小时"</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">            Sleeper.</span><span style="color:#6f42c1">sleep</span><span style="color:#24292e">(</span><span style="color:#005cc5">1</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">        }</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">}</span></span></code></pre></div><figure><img src="https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230713143401075.png" alt="image-20230713143401075" loading="lazy" decoding="async"></figure><p>将锁的粒度细分</p><ul><li>好处，是可以增强并发度</li><li>坏处，如果一个线程需要同时获得多把锁，就容易发生死锁</li></ul><h3 id="_11、活跃性" tabindex="-1">11、活跃性 <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20intermediate%20level#_11、活跃性" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h3><h4 id="_1-定义-2" tabindex="-1">(1)定义 <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20intermediate%20level#_1-定义-2" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h4><p>因为某种原因，使得代码一直无法执行完毕，这样的现象叫做活跃性</p><h4 id="_2-死锁" tabindex="-1">(2)死锁 <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20intermediate%20level#_2-死锁" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h4><p>有这样的情况：一个线程需要<strong>同时获取多把锁</strong>，这时就容易发生死锁</p><p>如：t1线程获得A对象 锁，接下来想获取B对象的锁t2线程获得B对象锁，接下来想获取A对象的锁</p><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">static</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">void</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">main</span><span style="color:#e1e4e8">(</span><span style="color:#f97583">String</span><span style="color:#e1e4e8">[] args) {</span></span>
<span class="line"><span style="color:#e1e4e8">		</span><span style="color:#f97583">final</span><span style="color:#e1e4e8"> Object A </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Object</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">		</span><span style="color:#f97583">final</span><span style="color:#e1e4e8"> Object B </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Object</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">		</span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Thread</span><span style="color:#e1e4e8">(()</span><span style="color:#f97583">-&gt;</span><span style="color:#e1e4e8">{</span></span>
<span class="line"><span style="color:#e1e4e8">			</span><span style="color:#f97583">synchronized</span><span style="color:#e1e4e8"> (A) {</span></span>
<span class="line"><span style="color:#e1e4e8">				</span><span style="color:#f97583">try</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">					Thread.</span><span style="color:#b392f0">sleep</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">2000</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">				} </span><span style="color:#f97583">catch</span><span style="color:#e1e4e8"> (InterruptedException </span><span style="color:#ffab70">e</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">					e.</span><span style="color:#b392f0">printStackTrace</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">				}</span></span>
<span class="line"><span style="color:#e1e4e8">				</span><span style="color:#f97583">synchronized</span><span style="color:#e1e4e8"> (B) {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">				}</span></span>
<span class="line"><span style="color:#e1e4e8">			}</span></span>
<span class="line"><span style="color:#e1e4e8">		}).</span><span style="color:#b392f0">start</span><span style="color:#e1e4e8">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">		</span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Thread</span><span style="color:#e1e4e8">(()</span><span style="color:#f97583">-&gt;</span><span style="color:#e1e4e8">{</span></span>
<span class="line"><span style="color:#e1e4e8">			</span><span style="color:#f97583">synchronized</span><span style="color:#e1e4e8"> (B) {</span></span>
<span class="line"><span style="color:#e1e4e8">				</span><span style="color:#f97583">try</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">					Thread.</span><span style="color:#b392f0">sleep</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">1000</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">				} </span><span style="color:#f97583">catch</span><span style="color:#e1e4e8"> (InterruptedException </span><span style="color:#ffab70">e</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">					e.</span><span style="color:#b392f0">printStackTrace</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">				}</span></span>
<span class="line"><span style="color:#e1e4e8">				</span><span style="color:#f97583">synchronized</span><span style="color:#e1e4e8"> (A) {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">				}</span></span>
<span class="line"><span style="color:#e1e4e8">			}</span></span>
<span class="line"><span style="color:#e1e4e8">		}).</span><span style="color:#b392f0">start</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">	}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">static</span><span style="color:#24292e"> </span><span style="color:#d73a49">void</span><span style="color:#24292e"> </span><span style="color:#6f42c1">main</span><span style="color:#24292e">(</span><span style="color:#d73a49">String</span><span style="color:#24292e">[] args) {</span></span>
<span class="line"><span style="color:#24292e">		</span><span style="color:#d73a49">final</span><span style="color:#24292e"> Object A </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Object</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">		</span><span style="color:#d73a49">final</span><span style="color:#24292e"> Object B </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Object</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">		</span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Thread</span><span style="color:#24292e">(()</span><span style="color:#d73a49">-&gt;</span><span style="color:#24292e">{</span></span>
<span class="line"><span style="color:#24292e">			</span><span style="color:#d73a49">synchronized</span><span style="color:#24292e"> (A) {</span></span>
<span class="line"><span style="color:#24292e">				</span><span style="color:#d73a49">try</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">					Thread.</span><span style="color:#6f42c1">sleep</span><span style="color:#24292e">(</span><span style="color:#005cc5">2000</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">				} </span><span style="color:#d73a49">catch</span><span style="color:#24292e"> (InterruptedException </span><span style="color:#e36209">e</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">					e.</span><span style="color:#6f42c1">printStackTrace</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">				}</span></span>
<span class="line"><span style="color:#24292e">				</span><span style="color:#d73a49">synchronized</span><span style="color:#24292e"> (B) {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">				}</span></span>
<span class="line"><span style="color:#24292e">			}</span></span>
<span class="line"><span style="color:#24292e">		}).</span><span style="color:#6f42c1">start</span><span style="color:#24292e">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">		</span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Thread</span><span style="color:#24292e">(()</span><span style="color:#d73a49">-&gt;</span><span style="color:#24292e">{</span></span>
<span class="line"><span style="color:#24292e">			</span><span style="color:#d73a49">synchronized</span><span style="color:#24292e"> (B) {</span></span>
<span class="line"><span style="color:#24292e">				</span><span style="color:#d73a49">try</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">					Thread.</span><span style="color:#6f42c1">sleep</span><span style="color:#24292e">(</span><span style="color:#005cc5">1000</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">				} </span><span style="color:#d73a49">catch</span><span style="color:#24292e"> (InterruptedException </span><span style="color:#e36209">e</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">					e.</span><span style="color:#6f42c1">printStackTrace</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">				}</span></span>
<span class="line"><span style="color:#24292e">				</span><span style="color:#d73a49">synchronized</span><span style="color:#24292e"> (A) {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">				}</span></span>
<span class="line"><span style="color:#24292e">			}</span></span>
<span class="line"><span style="color:#24292e">		}).</span><span style="color:#6f42c1">start</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">	}</span></span></code></pre></div><h5 id="发生死锁的必要条件" tabindex="-1">发生死锁的必要条件 <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20intermediate%20level#发生死锁的必要条件" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h5><ul><li>互斥条件<ul><li>在一段时间内，一种资源只能被一个进程所使用</li></ul></li><li>请求和保持条件<ul><li>进程已经拥有了至少一种资源，同时又去申请其他资源。因为其他资源被别的进程所使用，该进程进入阻塞状态，并且不释放自己已有的资源</li></ul></li><li>不可抢占条件<ul><li>进程对已获得的资源在未使用完成前不能被强占，只能在进程使用完后自己释放</li></ul></li><li>循环等待条件<ul><li>发生死锁时，必然存在一个进程——资源的循环链。</li></ul></li></ul><h5 id="定位死锁的方法" tabindex="-1">定位死锁的方法 <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20intermediate%20level#定位死锁的方法" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h5><ul><li><p>jps+jstack ThreadID</p><ul><li><p>在JAVA控制台中的Terminal中输入<strong>jps</strong>指令可以查看运行中的线程ID，使用<strong>jstack ThreadID</strong>可以查看线程状态。</p><figure><img src="https://jsd.cdn.zzko.cn/gh/imLKlauS/blog-picture@main/blogs/20200608145351.png" alt="img" loading="lazy" decoding="async"></figure></li></ul><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8">F</span><span style="color:#f97583">:</span><span style="color:#e1e4e8">\Thread_study</span><span style="color:#f97583">&gt;</span><span style="color:#e1e4e8">jps</span></span>
<span class="line"><span style="color:#79b8ff">20672</span><span style="color:#e1e4e8"> RemoteMavenServer36</span></span>
<span class="line"><span style="color:#79b8ff">22880</span><span style="color:#e1e4e8"> Jps</span></span>
<span class="line"><span style="color:#79b8ff">4432</span><span style="color:#e1e4e8"> Launcher</span></span>
<span class="line"><span style="color:#79b8ff">5316</span><span style="color:#e1e4e8"> Test5</span></span>
<span class="line"><span style="color:#79b8ff">20184</span><span style="color:#e1e4e8"> KotlinCompileDaemon</span></span>
<span class="line"><span style="color:#79b8ff">11132</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">F</span><span style="color:#f97583">:</span><span style="color:#e1e4e8">\Thread_study</span><span style="color:#f97583">&gt;</span><span style="color:#e1e4e8">jstack </span><span style="color:#79b8ff">5316</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e">F</span><span style="color:#d73a49">:</span><span style="color:#24292e">\Thread_study</span><span style="color:#d73a49">&gt;</span><span style="color:#24292e">jps</span></span>
<span class="line"><span style="color:#005cc5">20672</span><span style="color:#24292e"> RemoteMavenServer36</span></span>
<span class="line"><span style="color:#005cc5">22880</span><span style="color:#24292e"> Jps</span></span>
<span class="line"><span style="color:#005cc5">4432</span><span style="color:#24292e"> Launcher</span></span>
<span class="line"><span style="color:#005cc5">5316</span><span style="color:#24292e"> Test5</span></span>
<span class="line"><span style="color:#005cc5">20184</span><span style="color:#24292e"> KotlinCompileDaemon</span></span>
<span class="line"><span style="color:#005cc5">11132</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">F</span><span style="color:#d73a49">:</span><span style="color:#24292e">\Thread_study</span><span style="color:#d73a49">&gt;</span><span style="color:#24292e">jstack </span><span style="color:#005cc5">5316</span></span></code></pre></div></li><li><p>打印的结果</p><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6a737d">//找到一个java级别的死锁</span></span>
<span class="line"><span style="color:#e1e4e8">Found one Java</span><span style="color:#f97583">-</span><span style="color:#e1e4e8">level deadlock</span><span style="color:#f97583">:</span></span>
<span class="line"><span style="color:#f97583">=============================</span></span>
<span class="line"><span style="color:#9ecbff">"Thread-1"</span><span style="color:#f97583">:</span></span>
<span class="line"><span style="color:#e1e4e8">  waiting to lock monitor </span><span style="color:#79b8ff">0x0000000017f40de8</span><span style="color:#e1e4e8"> (object </span><span style="color:#79b8ff">0x00000000d6188880</span><span style="color:#e1e4e8">, a java.lang.Object),</span></span>
<span class="line"><span style="color:#e1e4e8">  which is held by </span><span style="color:#9ecbff">"Thread-0"</span></span>
<span class="line"><span style="color:#9ecbff">"Thread-0"</span><span style="color:#f97583">:</span></span>
<span class="line"><span style="color:#e1e4e8">  waiting to lock monitor </span><span style="color:#79b8ff">0x0000000017f43678</span><span style="color:#e1e4e8"> (object </span><span style="color:#79b8ff">0x00000000d6188890</span><span style="color:#e1e4e8">, a java.lang.Object),</span></span>
<span class="line"><span style="color:#e1e4e8">  which is held by </span><span style="color:#9ecbff">"Thread-1"</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6a737d">//找到一个java级别的死锁</span></span>
<span class="line"><span style="color:#24292e">Found one Java</span><span style="color:#d73a49">-</span><span style="color:#24292e">level deadlock</span><span style="color:#d73a49">:</span></span>
<span class="line"><span style="color:#d73a49">=============================</span></span>
<span class="line"><span style="color:#032f62">"Thread-1"</span><span style="color:#d73a49">:</span></span>
<span class="line"><span style="color:#24292e">  waiting to lock monitor </span><span style="color:#005cc5">0x0000000017f40de8</span><span style="color:#24292e"> (object </span><span style="color:#005cc5">0x00000000d6188880</span><span style="color:#24292e">, a java.lang.Object),</span></span>
<span class="line"><span style="color:#24292e">  which is held by </span><span style="color:#032f62">"Thread-0"</span></span>
<span class="line"><span style="color:#032f62">"Thread-0"</span><span style="color:#d73a49">:</span></span>
<span class="line"><span style="color:#24292e">  waiting to lock monitor </span><span style="color:#005cc5">0x0000000017f43678</span><span style="color:#24292e"> (object </span><span style="color:#005cc5">0x00000000d6188890</span><span style="color:#24292e">, a java.lang.Object),</span></span>
<span class="line"><span style="color:#24292e">  which is held by </span><span style="color:#032f62">"Thread-1"</span></span></code></pre></div></li><li><p>jconsole检测死锁</p><figure><img src="https://jsd.cdn.zzko.cn/gh/imLKlauS/blog-picture@main/blogs/20200608145405.png" alt="img" loading="lazy" decoding="async"></figure><figure><img src="https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/20200608145416.png" alt="img" loading="lazy" decoding="async"></figure></li></ul><h5 id="哲学家就餐问题" tabindex="-1">哲学家就餐问题 <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20intermediate%20level#哲学家就餐问题" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h5><figure><img src="https://jsd.cdn.zzko.cn/gh/imLKlauS/blog-picture@main/blogs/20200608145436.png" alt="img" loading="lazy" decoding="async"></figure><figure><img src="https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230713150809657.png" alt="image-20230713150809657" loading="lazy" decoding="async"></figure><h5 id="避免死锁的方法" tabindex="-1">避免死锁的方法 <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20intermediate%20level#避免死锁的方法" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h5><p>在线程使用锁对象时，<strong>顺序加锁</strong>即可避免死锁</p><figure><img src="https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/20200608145450.png" alt="img" loading="lazy" decoding="async"></figure><h4 id="_3-活锁" tabindex="-1">(3)活锁 <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20intermediate%20level#_3-活锁" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h4><p>活锁出现在两个线程<strong>互相改变对方的结束条件</strong>，后谁也无法结束。</p><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8">@</span><span style="color:#f97583">Slf4j</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">topic</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#9ecbff">"c.TestLiveLock"</span><span style="color:#e1e4e8">)</span></span>
<span class="line"><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">class</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">TestLiveLock</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">static</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">volatile</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> count </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">10</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">static</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">final</span><span style="color:#e1e4e8"> Object lock </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Object</span><span style="color:#e1e4e8">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">static</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">void</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">main</span><span style="color:#e1e4e8">(</span><span style="color:#f97583">String</span><span style="color:#e1e4e8">[] </span><span style="color:#ffab70">args</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Thread</span><span style="color:#e1e4e8">(() </span><span style="color:#f97583">-&gt;</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#6a737d">// 期望减到 0 退出循环</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">while</span><span style="color:#e1e4e8"> (count </span><span style="color:#f97583">&gt;</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#b392f0">sleep</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">0.2</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">                count</span><span style="color:#f97583">--</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">                log.</span><span style="color:#b392f0">debug</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"count: {}"</span><span style="color:#e1e4e8">, count);</span></span>
<span class="line"><span style="color:#e1e4e8">            }</span></span>
<span class="line"><span style="color:#e1e4e8">        }, </span><span style="color:#9ecbff">"t1"</span><span style="color:#e1e4e8">).</span><span style="color:#b392f0">start</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Thread</span><span style="color:#e1e4e8">(() </span><span style="color:#f97583">-&gt;</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#6a737d">// 期望超过 20 退出循环</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">while</span><span style="color:#e1e4e8"> (count </span><span style="color:#f97583">&lt;</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">20</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#b392f0">sleep</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">0.2</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">                count</span><span style="color:#f97583">++</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">                log.</span><span style="color:#b392f0">debug</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"count: {}"</span><span style="color:#e1e4e8">, count);</span></span>
<span class="line"><span style="color:#e1e4e8">            }</span></span>
<span class="line"><span style="color:#e1e4e8">        }, </span><span style="color:#9ecbff">"t2"</span><span style="color:#e1e4e8">).</span><span style="color:#b392f0">start</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"><span style="color:#e1e4e8">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e">@</span><span style="color:#d73a49">Slf4j</span><span style="color:#24292e">(</span><span style="color:#005cc5">topic</span><span style="color:#24292e"> </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#032f62">"c.TestLiveLock"</span><span style="color:#24292e">)</span></span>
<span class="line"><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">class</span><span style="color:#24292e"> </span><span style="color:#6f42c1">TestLiveLock</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">static</span><span style="color:#24292e"> </span><span style="color:#d73a49">volatile</span><span style="color:#24292e"> </span><span style="color:#d73a49">int</span><span style="color:#24292e"> count </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#005cc5">10</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">static</span><span style="color:#24292e"> </span><span style="color:#d73a49">final</span><span style="color:#24292e"> Object lock </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Object</span><span style="color:#24292e">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">static</span><span style="color:#24292e"> </span><span style="color:#d73a49">void</span><span style="color:#24292e"> </span><span style="color:#6f42c1">main</span><span style="color:#24292e">(</span><span style="color:#d73a49">String</span><span style="color:#24292e">[] </span><span style="color:#e36209">args</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Thread</span><span style="color:#24292e">(() </span><span style="color:#d73a49">-&gt;</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#6a737d">// 期望减到 0 退出循环</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">while</span><span style="color:#24292e"> (count </span><span style="color:#d73a49">&gt;</span><span style="color:#24292e"> </span><span style="color:#005cc5">0</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#6f42c1">sleep</span><span style="color:#24292e">(</span><span style="color:#005cc5">0.2</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">                count</span><span style="color:#d73a49">--</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">                log.</span><span style="color:#6f42c1">debug</span><span style="color:#24292e">(</span><span style="color:#032f62">"count: {}"</span><span style="color:#24292e">, count);</span></span>
<span class="line"><span style="color:#24292e">            }</span></span>
<span class="line"><span style="color:#24292e">        }, </span><span style="color:#032f62">"t1"</span><span style="color:#24292e">).</span><span style="color:#6f42c1">start</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Thread</span><span style="color:#24292e">(() </span><span style="color:#d73a49">-&gt;</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#6a737d">// 期望超过 20 退出循环</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">while</span><span style="color:#24292e"> (count </span><span style="color:#d73a49">&lt;</span><span style="color:#24292e"> </span><span style="color:#005cc5">20</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#6f42c1">sleep</span><span style="color:#24292e">(</span><span style="color:#005cc5">0.2</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">                count</span><span style="color:#d73a49">++</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">                log.</span><span style="color:#6f42c1">debug</span><span style="color:#24292e">(</span><span style="color:#032f62">"count: {}"</span><span style="color:#24292e">, count);</span></span>
<span class="line"><span style="color:#24292e">            }</span></span>
<span class="line"><span style="color:#24292e">        }, </span><span style="color:#032f62">"t2"</span><span style="color:#24292e">).</span><span style="color:#6f42c1">start</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"><span style="color:#24292e">}</span></span></code></pre></div><h5 id="避免活锁的方法" tabindex="-1">避免活锁的方法 <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20intermediate%20level#避免活锁的方法" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h5><p>在线程执行时，中途给予<strong>不同的间隔时间</strong>即可。</p><h5 id="死锁与活锁的区别" tabindex="-1">死锁与活锁的区别 <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20intermediate%20level#死锁与活锁的区别" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h5><ul><li>死锁是因为线程互相持有对象想要的锁，并且都不释放，最后到时<strong>线程阻塞</strong>，<strong>停止运行</strong>的现象。</li><li>活锁是因为线程间修改了对方的结束条件，而导致代码<strong>一直在运行</strong>，却一直<strong>运行不完</strong>的现象。</li></ul><h4 id="_4-饥饿" tabindex="-1">(4)饥饿 <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20intermediate%20level#_4-饥饿" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h4><p>某些线程因为优先级太低，导致一直无法获得资源的现象。</p><p>在使用顺序加锁时，可能会出现饥饿现象</p><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Philosopher</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"苏格拉底"</span><span style="color:#e1e4e8">, c1, c2).</span><span style="color:#b392f0">start</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Philosopher</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"柏拉图"</span><span style="color:#e1e4e8">, c2, c3).</span><span style="color:#b392f0">start</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Philosopher</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"亚里士多德"</span><span style="color:#e1e4e8">, c3, c4).</span><span style="color:#b392f0">start</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Philosopher</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"赫拉克利特"</span><span style="color:#e1e4e8">, c4, c5).</span><span style="color:#b392f0">start</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Philosopher</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"阿基米德"</span><span style="color:#e1e4e8">, c5, c1).</span><span style="color:#b392f0">start</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#6a737d">//=&gt;new Philosopher("阿基米德", c1, c5).start();阿基米德抢到锁的概率极低，即出现饥饿现象</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Philosopher</span><span style="color:#24292e">(</span><span style="color:#032f62">"苏格拉底"</span><span style="color:#24292e">, c1, c2).</span><span style="color:#6f42c1">start</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Philosopher</span><span style="color:#24292e">(</span><span style="color:#032f62">"柏拉图"</span><span style="color:#24292e">, c2, c3).</span><span style="color:#6f42c1">start</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Philosopher</span><span style="color:#24292e">(</span><span style="color:#032f62">"亚里士多德"</span><span style="color:#24292e">, c3, c4).</span><span style="color:#6f42c1">start</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Philosopher</span><span style="color:#24292e">(</span><span style="color:#032f62">"赫拉克利特"</span><span style="color:#24292e">, c4, c5).</span><span style="color:#6f42c1">start</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Philosopher</span><span style="color:#24292e">(</span><span style="color:#032f62">"阿基米德"</span><span style="color:#24292e">, c5, c1).</span><span style="color:#6f42c1">start</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#6a737d">//=&gt;new Philosopher("阿基米德", c1, c5).start();阿基米德抢到锁的概率极低，即出现饥饿现象</span></span></code></pre></div><h3 id="_12、reentrantlock" tabindex="-1">12、ReentrantLock <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20intermediate%20level#_12、reentrantlock" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h3><p><strong>和synchronized相比具有的的特点</strong></p><ul><li>可中断</li><li>可以设置超时时间</li><li>可以设置为公平锁 (先到先得)</li><li>支持多个条件变量( 具有<strong>多个</strong>waitset)</li></ul><p><strong>基本语法</strong></p><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6a737d">//获取ReentrantLock对象</span></span>
<span class="line"><span style="color:#f97583">private</span><span style="color:#e1e4e8"> ReentrantLock lock </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">ReentrantLock</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#6a737d">//加锁</span></span>
<span class="line"><span style="color:#e1e4e8">lock.</span><span style="color:#b392f0">lock</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#f97583">try</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">	</span><span style="color:#6a737d">//需要执行的代码</span></span>
<span class="line"><span style="color:#e1e4e8">}</span><span style="color:#f97583">finally</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">	</span><span style="color:#6a737d">//释放锁</span></span>
<span class="line"><span style="color:#e1e4e8">	lock.</span><span style="color:#b392f0">unlock</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6a737d">//获取ReentrantLock对象</span></span>
<span class="line"><span style="color:#d73a49">private</span><span style="color:#24292e"> ReentrantLock lock </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">ReentrantLock</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#6a737d">//加锁</span></span>
<span class="line"><span style="color:#24292e">lock.</span><span style="color:#6f42c1">lock</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#d73a49">try</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">	</span><span style="color:#6a737d">//需要执行的代码</span></span>
<span class="line"><span style="color:#24292e">}</span><span style="color:#d73a49">finally</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">	</span><span style="color:#6a737d">//释放锁</span></span>
<span class="line"><span style="color:#24292e">	lock.</span><span style="color:#6f42c1">unlock</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">}</span></span></code></pre></div><blockquote><p>加锁代码放在try块中还是try块外效果都一样</p></blockquote><h4 id="可重入" tabindex="-1">可重入 <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20intermediate%20level#可重入" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h4><ul><li>可重入是指同一个线程如果首次获得了这把锁，那么因为它是这把锁的拥有者，因此有权利再次获取这把锁</li><li>如果是不可重入锁，那么第二次获得锁时，自己也会被锁挡住</li></ul><h4 id="可打断" tabindex="-1">可打断 <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20intermediate%20level#可打断" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h4><p>如果某个线程处于阻塞状态，可以调用其interrupt方法让其停止阻塞，获得锁失败</p><p><strong>简而言之</strong>就是：处于阻塞状态的线程，被打断了就不用阻塞了，直接停止运行</p><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">static</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">void</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">main</span><span style="color:#e1e4e8">(</span><span style="color:#f97583">String</span><span style="color:#e1e4e8">[] args) {</span></span>
<span class="line"><span style="color:#e1e4e8">		ReentrantLock lock </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">ReentrantLock</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">		Thread t1 </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Thread</span><span style="color:#e1e4e8">(()</span><span style="color:#f97583">-&gt;</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">			</span><span style="color:#f97583">try</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">				</span><span style="color:#6a737d">//加锁，可打断锁</span></span>
<span class="line"><span style="color:#e1e4e8">				lock.</span><span style="color:#b392f0">lockInterruptibly</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">			} </span><span style="color:#f97583">catch</span><span style="color:#e1e4e8"> (InterruptedException </span><span style="color:#ffab70">e</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">				e.</span><span style="color:#b392f0">printStackTrace</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#6a737d">//被打断，返回，不再向下执行</span></span>
<span class="line"><span style="color:#e1e4e8">				</span><span style="color:#f97583">return</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">			}</span><span style="color:#f97583">finally</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">				</span><span style="color:#6a737d">//释放锁</span></span>
<span class="line"><span style="color:#e1e4e8">				lock.</span><span style="color:#b392f0">unlock</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">			}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">		});</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">		lock.</span><span style="color:#b392f0">lock</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">		</span><span style="color:#f97583">try</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">			t1.</span><span style="color:#b392f0">start</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">			Thread.</span><span style="color:#b392f0">sleep</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">1000</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">			</span><span style="color:#6a737d">//打断</span></span>
<span class="line"><span style="color:#e1e4e8">			t1.</span><span style="color:#b392f0">interrupt</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">		} </span><span style="color:#f97583">catch</span><span style="color:#e1e4e8"> (InterruptedException </span><span style="color:#ffab70">e</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">			e.</span><span style="color:#b392f0">printStackTrace</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">		} </span><span style="color:#f97583">finally</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">			lock.</span><span style="color:#b392f0">unlock</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">		}</span></span>
<span class="line"><span style="color:#e1e4e8">	}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">static</span><span style="color:#24292e"> </span><span style="color:#d73a49">void</span><span style="color:#24292e"> </span><span style="color:#6f42c1">main</span><span style="color:#24292e">(</span><span style="color:#d73a49">String</span><span style="color:#24292e">[] args) {</span></span>
<span class="line"><span style="color:#24292e">		ReentrantLock lock </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">ReentrantLock</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">		Thread t1 </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Thread</span><span style="color:#24292e">(()</span><span style="color:#d73a49">-&gt;</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">			</span><span style="color:#d73a49">try</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">				</span><span style="color:#6a737d">//加锁，可打断锁</span></span>
<span class="line"><span style="color:#24292e">				lock.</span><span style="color:#6f42c1">lockInterruptibly</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">			} </span><span style="color:#d73a49">catch</span><span style="color:#24292e"> (InterruptedException </span><span style="color:#e36209">e</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">				e.</span><span style="color:#6f42c1">printStackTrace</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#6a737d">//被打断，返回，不再向下执行</span></span>
<span class="line"><span style="color:#24292e">				</span><span style="color:#d73a49">return</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">			}</span><span style="color:#d73a49">finally</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">				</span><span style="color:#6a737d">//释放锁</span></span>
<span class="line"><span style="color:#24292e">				lock.</span><span style="color:#6f42c1">unlock</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">			}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">		});</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">		lock.</span><span style="color:#6f42c1">lock</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">		</span><span style="color:#d73a49">try</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">			t1.</span><span style="color:#6f42c1">start</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">			Thread.</span><span style="color:#6f42c1">sleep</span><span style="color:#24292e">(</span><span style="color:#005cc5">1000</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">			</span><span style="color:#6a737d">//打断</span></span>
<span class="line"><span style="color:#24292e">			t1.</span><span style="color:#6f42c1">interrupt</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">		} </span><span style="color:#d73a49">catch</span><span style="color:#24292e"> (InterruptedException </span><span style="color:#e36209">e</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">			e.</span><span style="color:#6f42c1">printStackTrace</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">		} </span><span style="color:#d73a49">finally</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">			lock.</span><span style="color:#6f42c1">unlock</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">		}</span></span>
<span class="line"><span style="color:#24292e">	}</span></span></code></pre></div><blockquote><p><code>lock.lock();</code>加锁是不可打断的，因此会发生死锁现象</p></blockquote><h4 id="锁超时" tabindex="-1">锁超时 <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20intermediate%20level#锁超时" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h4><p>使用<strong>lock.tryLock</strong>方法会返回获取锁是否成功。如果成功则返回true，反之则返回false。</p><p>并且tryLock方法可以<strong>指定等待时间</strong>，参数为：tryLock(long timeout, TimeUnit unit), 其中timeout为最长等待时间，TimeUnit为时间单位</p><p><strong>简而言之</strong>就是：获取失败了、获取超时了或者被打断了，不再阻塞，直接停止运行</p><p>不设置等待时间</p><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">static</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">void</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">main</span><span style="color:#e1e4e8">(</span><span style="color:#f97583">String</span><span style="color:#e1e4e8">[] args) {</span></span>
<span class="line"><span style="color:#e1e4e8">		ReentrantLock lock </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">ReentrantLock</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">		Thread t1 </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Thread</span><span style="color:#e1e4e8">(()</span><span style="color:#f97583">-&gt;</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#6a737d">//未设置等待时间，一旦获取失败，直接返回false</span></span>
<span class="line"><span style="color:#e1e4e8">			</span><span style="color:#f97583">if</span><span style="color:#e1e4e8">(</span><span style="color:#f97583">!</span><span style="color:#e1e4e8">lock.</span><span style="color:#b392f0">tryLock</span><span style="color:#e1e4e8">()) {</span></span>
<span class="line"><span style="color:#e1e4e8">				System.out.</span><span style="color:#b392f0">println</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"获取失败"</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#6a737d">//获取失败，不再向下执行，返回</span></span>
<span class="line"><span style="color:#e1e4e8">				</span><span style="color:#f97583">return</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">			}</span></span>
<span class="line"><span style="color:#e1e4e8">			System.out.</span><span style="color:#b392f0">println</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"得到了锁"</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">			lock.</span><span style="color:#b392f0">unlock</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">		});</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">		lock.</span><span style="color:#b392f0">lock</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">		</span><span style="color:#f97583">try</span><span style="color:#e1e4e8">{</span></span>
<span class="line"><span style="color:#e1e4e8">			t1.</span><span style="color:#b392f0">start</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">			Thread.</span><span style="color:#b392f0">sleep</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">3000</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">		} </span><span style="color:#f97583">catch</span><span style="color:#e1e4e8"> (InterruptedException </span><span style="color:#ffab70">e</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">			e.</span><span style="color:#b392f0">printStackTrace</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">		} </span><span style="color:#f97583">finally</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">			lock.</span><span style="color:#b392f0">unlock</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">		}</span></span>
<span class="line"><span style="color:#e1e4e8">	}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">static</span><span style="color:#24292e"> </span><span style="color:#d73a49">void</span><span style="color:#24292e"> </span><span style="color:#6f42c1">main</span><span style="color:#24292e">(</span><span style="color:#d73a49">String</span><span style="color:#24292e">[] args) {</span></span>
<span class="line"><span style="color:#24292e">		ReentrantLock lock </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">ReentrantLock</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">		Thread t1 </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Thread</span><span style="color:#24292e">(()</span><span style="color:#d73a49">-&gt;</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#6a737d">//未设置等待时间，一旦获取失败，直接返回false</span></span>
<span class="line"><span style="color:#24292e">			</span><span style="color:#d73a49">if</span><span style="color:#24292e">(</span><span style="color:#d73a49">!</span><span style="color:#24292e">lock.</span><span style="color:#6f42c1">tryLock</span><span style="color:#24292e">()) {</span></span>
<span class="line"><span style="color:#24292e">				System.out.</span><span style="color:#6f42c1">println</span><span style="color:#24292e">(</span><span style="color:#032f62">"获取失败"</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#6a737d">//获取失败，不再向下执行，返回</span></span>
<span class="line"><span style="color:#24292e">				</span><span style="color:#d73a49">return</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">			}</span></span>
<span class="line"><span style="color:#24292e">			System.out.</span><span style="color:#6f42c1">println</span><span style="color:#24292e">(</span><span style="color:#032f62">"得到了锁"</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">			lock.</span><span style="color:#6f42c1">unlock</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">		});</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">		lock.</span><span style="color:#6f42c1">lock</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">		</span><span style="color:#d73a49">try</span><span style="color:#24292e">{</span></span>
<span class="line"><span style="color:#24292e">			t1.</span><span style="color:#6f42c1">start</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">			Thread.</span><span style="color:#6f42c1">sleep</span><span style="color:#24292e">(</span><span style="color:#005cc5">3000</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">		} </span><span style="color:#d73a49">catch</span><span style="color:#24292e"> (InterruptedException </span><span style="color:#e36209">e</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">			e.</span><span style="color:#6f42c1">printStackTrace</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">		} </span><span style="color:#d73a49">finally</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">			lock.</span><span style="color:#6f42c1">unlock</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">		}</span></span>
<span class="line"><span style="color:#24292e">	}</span></span></code></pre></div><p>设置等待时间（<code>lock.tryLock(2, TimeUnit.SECONDS)</code>当其他线程占锁，等2s后才返回获取失败；2s前无人占锁则获取成功）</p><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8">@</span><span style="color:#f97583">Slf4j</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">topic</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#9ecbff">"c.Test22"</span><span style="color:#e1e4e8">)</span></span>
<span class="line"><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">class</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Test22</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">private</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">static</span><span style="color:#e1e4e8"> ReentrantLock lock </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">ReentrantLock</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">static</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">void</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">main</span><span style="color:#e1e4e8">(</span><span style="color:#f97583">String</span><span style="color:#e1e4e8">[] </span><span style="color:#ffab70">args</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">        Thread t1 </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Thread</span><span style="color:#e1e4e8">(() </span><span style="color:#f97583">-&gt;</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">            log.</span><span style="color:#b392f0">debug</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"尝试获得锁"</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">try</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (</span><span style="color:#f97583">!</span><span style="color:#e1e4e8"> lock.</span><span style="color:#b392f0">tryLock</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">2</span><span style="color:#e1e4e8">, TimeUnit.SECONDS)) {</span></span>
<span class="line"><span style="color:#e1e4e8">                    log.</span><span style="color:#b392f0">debug</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"获取不到锁"</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">                    </span><span style="color:#f97583">return</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">                }</span></span>
<span class="line"><span style="color:#e1e4e8">            } </span><span style="color:#f97583">catch</span><span style="color:#e1e4e8"> (InterruptedException </span><span style="color:#ffab70">e</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">                e.</span><span style="color:#b392f0">printStackTrace</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">                log.</span><span style="color:#b392f0">debug</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"获取不到锁"</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#f97583">return</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">            }</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">try</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">                log.</span><span style="color:#b392f0">debug</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"获得到锁"</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">            } </span><span style="color:#f97583">finally</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">                lock.</span><span style="color:#b392f0">unlock</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">            }</span></span>
<span class="line"><span style="color:#e1e4e8">        }, </span><span style="color:#9ecbff">"t1"</span><span style="color:#e1e4e8">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">        lock.</span><span style="color:#b392f0">lock</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">        log.</span><span style="color:#b392f0">debug</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"获得到锁"</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">        t1.</span><span style="color:#b392f0">start</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#b392f0">sleep</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">1</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">        log.</span><span style="color:#b392f0">debug</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"释放了锁"</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">        lock.</span><span style="color:#b392f0">unlock</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e">@</span><span style="color:#d73a49">Slf4j</span><span style="color:#24292e">(</span><span style="color:#005cc5">topic</span><span style="color:#24292e"> </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#032f62">"c.Test22"</span><span style="color:#24292e">)</span></span>
<span class="line"><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">class</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Test22</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">private</span><span style="color:#24292e"> </span><span style="color:#d73a49">static</span><span style="color:#24292e"> ReentrantLock lock </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">ReentrantLock</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">static</span><span style="color:#24292e"> </span><span style="color:#d73a49">void</span><span style="color:#24292e"> </span><span style="color:#6f42c1">main</span><span style="color:#24292e">(</span><span style="color:#d73a49">String</span><span style="color:#24292e">[] </span><span style="color:#e36209">args</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">        Thread t1 </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Thread</span><span style="color:#24292e">(() </span><span style="color:#d73a49">-&gt;</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">            log.</span><span style="color:#6f42c1">debug</span><span style="color:#24292e">(</span><span style="color:#032f62">"尝试获得锁"</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">try</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (</span><span style="color:#d73a49">!</span><span style="color:#24292e"> lock.</span><span style="color:#6f42c1">tryLock</span><span style="color:#24292e">(</span><span style="color:#005cc5">2</span><span style="color:#24292e">, TimeUnit.SECONDS)) {</span></span>
<span class="line"><span style="color:#24292e">                    log.</span><span style="color:#6f42c1">debug</span><span style="color:#24292e">(</span><span style="color:#032f62">"获取不到锁"</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">                    </span><span style="color:#d73a49">return</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">                }</span></span>
<span class="line"><span style="color:#24292e">            } </span><span style="color:#d73a49">catch</span><span style="color:#24292e"> (InterruptedException </span><span style="color:#e36209">e</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">                e.</span><span style="color:#6f42c1">printStackTrace</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">                log.</span><span style="color:#6f42c1">debug</span><span style="color:#24292e">(</span><span style="color:#032f62">"获取不到锁"</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#d73a49">return</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">            }</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">try</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">                log.</span><span style="color:#6f42c1">debug</span><span style="color:#24292e">(</span><span style="color:#032f62">"获得到锁"</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">            } </span><span style="color:#d73a49">finally</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">                lock.</span><span style="color:#6f42c1">unlock</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">            }</span></span>
<span class="line"><span style="color:#24292e">        }, </span><span style="color:#032f62">"t1"</span><span style="color:#24292e">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">        lock.</span><span style="color:#6f42c1">lock</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">        log.</span><span style="color:#6f42c1">debug</span><span style="color:#24292e">(</span><span style="color:#032f62">"获得到锁"</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">        t1.</span><span style="color:#6f42c1">start</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6f42c1">sleep</span><span style="color:#24292e">(</span><span style="color:#005cc5">1</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">        log.</span><span style="color:#6f42c1">debug</span><span style="color:#24292e">(</span><span style="color:#032f62">"释放了锁"</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">        lock.</span><span style="color:#6f42c1">unlock</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">}</span></span></code></pre></div><h5 id="解决哲学家就餐的死锁问题-不会出现饥饿情况" tabindex="-1">解决哲学家就餐的死锁问题（不会出现饥饿情况） <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20intermediate%20level#解决哲学家就餐的死锁问题-不会出现饥饿情况" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h5><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8">...</span></span>
<span class="line"><span style="color:#e1e4e8">@</span><span style="color:#f97583">Slf4j</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">topic</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#9ecbff">"c.Philosopher"</span><span style="color:#e1e4e8">)</span></span>
<span class="line"><span style="color:#f97583">class</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Philosopher</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">extends</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Thread</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">    Chopstick left;</span></span>
<span class="line"><span style="color:#e1e4e8">    Chopstick right;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">    ...</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">    @</span><span style="color:#f97583">Override</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">void</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">run</span><span style="color:#e1e4e8">() {</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">while</span><span style="color:#e1e4e8"> (</span><span style="color:#79b8ff">true</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#6a737d">//　尝试获得左手筷子</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (left.</span><span style="color:#b392f0">tryLock</span><span style="color:#e1e4e8">()) {</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#f97583">try</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">                    </span><span style="color:#6a737d">// 尝试获得右手筷子</span></span>
<span class="line"><span style="color:#e1e4e8">                    </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (right.</span><span style="color:#b392f0">tryLock</span><span style="color:#e1e4e8">()) {</span></span>
<span class="line"><span style="color:#e1e4e8">                        </span><span style="color:#f97583">try</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">                            </span><span style="color:#b392f0">eat</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">                        } </span><span style="color:#f97583">finally</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">                            right.</span><span style="color:#b392f0">unlock</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">                        }</span></span>
<span class="line"><span style="color:#e1e4e8">                    }</span></span>
<span class="line"><span style="color:#e1e4e8">                } </span><span style="color:#f97583">finally</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">                    left.</span><span style="color:#b392f0">unlock</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">                }</span></span>
<span class="line"><span style="color:#e1e4e8">            }</span></span>
<span class="line"><span style="color:#e1e4e8">        }</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">    ...</span></span>
<span class="line"><span style="color:#e1e4e8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#f97583">class</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Chopstick</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">extends</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">ReentrantLock</span><span style="color:#e1e4e8"> {...}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e">...</span></span>
<span class="line"><span style="color:#24292e">@</span><span style="color:#d73a49">Slf4j</span><span style="color:#24292e">(</span><span style="color:#005cc5">topic</span><span style="color:#24292e"> </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#032f62">"c.Philosopher"</span><span style="color:#24292e">)</span></span>
<span class="line"><span style="color:#d73a49">class</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Philosopher</span><span style="color:#24292e"> </span><span style="color:#d73a49">extends</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Thread</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">    Chopstick left;</span></span>
<span class="line"><span style="color:#24292e">    Chopstick right;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">    ...</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">    @</span><span style="color:#d73a49">Override</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">void</span><span style="color:#24292e"> </span><span style="color:#6f42c1">run</span><span style="color:#24292e">() {</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">while</span><span style="color:#24292e"> (</span><span style="color:#005cc5">true</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#6a737d">//　尝试获得左手筷子</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (left.</span><span style="color:#6f42c1">tryLock</span><span style="color:#24292e">()) {</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#d73a49">try</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">                    </span><span style="color:#6a737d">// 尝试获得右手筷子</span></span>
<span class="line"><span style="color:#24292e">                    </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (right.</span><span style="color:#6f42c1">tryLock</span><span style="color:#24292e">()) {</span></span>
<span class="line"><span style="color:#24292e">                        </span><span style="color:#d73a49">try</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">                            </span><span style="color:#6f42c1">eat</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">                        } </span><span style="color:#d73a49">finally</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">                            right.</span><span style="color:#6f42c1">unlock</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">                        }</span></span>
<span class="line"><span style="color:#24292e">                    }</span></span>
<span class="line"><span style="color:#24292e">                } </span><span style="color:#d73a49">finally</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">                    left.</span><span style="color:#6f42c1">unlock</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">                }</span></span>
<span class="line"><span style="color:#24292e">            }</span></span>
<span class="line"><span style="color:#24292e">        }</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">    ...</span></span>
<span class="line"><span style="color:#24292e">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#d73a49">class</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Chopstick</span><span style="color:#24292e"> </span><span style="color:#d73a49">extends</span><span style="color:#24292e"> </span><span style="color:#6f42c1">ReentrantLock</span><span style="color:#24292e"> {...}</span></span></code></pre></div><h4 id="公平锁" tabindex="-1">公平锁 <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20intermediate%20level#公平锁" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h4><p>在线程获取锁失败，进入阻塞队列时，<strong>先进入</strong>的会在锁被释放后<strong>先获得</strong>锁。这样的获取方式就是<strong>公平</strong>的。</p><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6a737d">//默认是不公平锁，需要在创建时指定为公平锁</span></span>
<span class="line"><span style="color:#e1e4e8">ReentrantLock lock </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">ReentrantLock</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">true</span><span style="color:#e1e4e8">);</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6a737d">//默认是不公平锁，需要在创建时指定为公平锁</span></span>
<span class="line"><span style="color:#24292e">ReentrantLock lock </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">ReentrantLock</span><span style="color:#24292e">(</span><span style="color:#005cc5">true</span><span style="color:#24292e">);</span></span></code></pre></div><h4 id="条件变量" tabindex="-1">条件变量 <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20intermediate%20level#条件变量" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h4><p>synchronized 中也有条件变量，就是我们讲原理时那个 waitSet 休息室，当条件不满足时进入waitSet 等待</p><p>ReentrantLock 的条件变量比 synchronized 强大之处在于，它是支持<strong>多个</strong>条件变量的，这就好比</p><ul><li>synchronized 是那些不满足条件的线程都在一间休息室等消息</li><li>而 ReentrantLock 支持多间休息室，有专门等烟的休息室、专门等早餐的休息室、唤醒时也是按休息室来唤 醒</li></ul><p>使用要点：</p><ul><li>await 前需要<strong>获得锁</strong></li><li>await 执行后，会释放锁，进入 conditionObject 等待</li><li>await 的线程被唤醒（或打断、或超时）取重新竞争 lock 锁</li><li>竞争 lock 锁成功后，从 await 后继续执</li></ul><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8">@</span><span style="color:#f97583">Slf4j</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">topic</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#9ecbff">"c.Test24"</span><span style="color:#e1e4e8">)</span></span>
<span class="line"><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">class</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Test24</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">static</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">final</span><span style="color:#e1e4e8"> Object room </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Object</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">static</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">boolean</span><span style="color:#e1e4e8"> hasCigarette </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">false</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">static</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">boolean</span><span style="color:#e1e4e8"> hasTakeout </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">false</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">static</span><span style="color:#e1e4e8"> ReentrantLock ROOM </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">ReentrantLock</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">// 等待烟的休息室</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">static</span><span style="color:#e1e4e8"> Condition waitCigaretteSet </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> ROOM.</span><span style="color:#b392f0">newCondition</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">// 等外卖的休息室</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">static</span><span style="color:#e1e4e8"> Condition waitTakeoutSet </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> ROOM.</span><span style="color:#b392f0">newCondition</span><span style="color:#e1e4e8">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">static</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">void</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">main</span><span style="color:#e1e4e8">(</span><span style="color:#f97583">String</span><span style="color:#e1e4e8">[] </span><span style="color:#ffab70">args</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Thread</span><span style="color:#e1e4e8">(() </span><span style="color:#f97583">-&gt;</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">            ROOM.</span><span style="color:#b392f0">lock</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">try</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">                log.</span><span style="color:#b392f0">debug</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"有烟没？[{}]"</span><span style="color:#e1e4e8">, hasCigarette);</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#f97583">while</span><span style="color:#e1e4e8"> (</span><span style="color:#f97583">!</span><span style="color:#e1e4e8">hasCigarette) {</span></span>
<span class="line"><span style="color:#e1e4e8">                    log.</span><span style="color:#b392f0">debug</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"没烟，先歇会！"</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">                    </span><span style="color:#f97583">try</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">                        waitCigaretteSet.</span><span style="color:#b392f0">await</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">                    } </span><span style="color:#f97583">catch</span><span style="color:#e1e4e8"> (InterruptedException </span><span style="color:#ffab70">e</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">                        e.</span><span style="color:#b392f0">printStackTrace</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">                    }</span></span>
<span class="line"><span style="color:#e1e4e8">                }</span></span>
<span class="line"><span style="color:#e1e4e8">                log.</span><span style="color:#b392f0">debug</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"可以开始干活了"</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">            } </span><span style="color:#f97583">finally</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">                ROOM.</span><span style="color:#b392f0">unlock</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">            }</span></span>
<span class="line"><span style="color:#e1e4e8">        }, </span><span style="color:#9ecbff">"小南"</span><span style="color:#e1e4e8">).</span><span style="color:#b392f0">start</span><span style="color:#e1e4e8">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Thread</span><span style="color:#e1e4e8">(() </span><span style="color:#f97583">-&gt;</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">            ROOM.</span><span style="color:#b392f0">lock</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">try</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">                log.</span><span style="color:#b392f0">debug</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"外卖送到没？[{}]"</span><span style="color:#e1e4e8">, hasTakeout);</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#f97583">while</span><span style="color:#e1e4e8"> (</span><span style="color:#f97583">!</span><span style="color:#e1e4e8">hasTakeout) {</span></span>
<span class="line"><span style="color:#e1e4e8">                    log.</span><span style="color:#b392f0">debug</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"没外卖，先歇会！"</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">                    </span><span style="color:#f97583">try</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">                        waitTakeoutSet.</span><span style="color:#b392f0">await</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">                    } </span><span style="color:#f97583">catch</span><span style="color:#e1e4e8"> (InterruptedException </span><span style="color:#ffab70">e</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">                        e.</span><span style="color:#b392f0">printStackTrace</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">                    }</span></span>
<span class="line"><span style="color:#e1e4e8">                }</span></span>
<span class="line"><span style="color:#e1e4e8">                log.</span><span style="color:#b392f0">debug</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"可以开始干活了"</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">            } </span><span style="color:#f97583">finally</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">                ROOM.</span><span style="color:#b392f0">unlock</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">            }</span></span>
<span class="line"><span style="color:#e1e4e8">        }, </span><span style="color:#9ecbff">"小女"</span><span style="color:#e1e4e8">).</span><span style="color:#b392f0">start</span><span style="color:#e1e4e8">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#b392f0">sleep</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">1</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Thread</span><span style="color:#e1e4e8">(() </span><span style="color:#f97583">-&gt;</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">            ROOM.</span><span style="color:#b392f0">lock</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">try</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">                hasTakeout </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">true</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">                waitTakeoutSet.</span><span style="color:#b392f0">signal</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">            } </span><span style="color:#f97583">finally</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">                ROOM.</span><span style="color:#b392f0">unlock</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">            }</span></span>
<span class="line"><span style="color:#e1e4e8">        }, </span><span style="color:#9ecbff">"送外卖的"</span><span style="color:#e1e4e8">).</span><span style="color:#b392f0">start</span><span style="color:#e1e4e8">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#b392f0">sleep</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">1</span><span style="color:#e1e4e8">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Thread</span><span style="color:#e1e4e8">(() </span><span style="color:#f97583">-&gt;</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">            ROOM.</span><span style="color:#b392f0">lock</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">try</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">                hasCigarette </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">true</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">                waitCigaretteSet.</span><span style="color:#b392f0">signal</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">            } </span><span style="color:#f97583">finally</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">                ROOM.</span><span style="color:#b392f0">unlock</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">            }</span></span>
<span class="line"><span style="color:#e1e4e8">        }, </span><span style="color:#9ecbff">"送烟的"</span><span style="color:#e1e4e8">).</span><span style="color:#b392f0">start</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e">@</span><span style="color:#d73a49">Slf4j</span><span style="color:#24292e">(</span><span style="color:#005cc5">topic</span><span style="color:#24292e"> </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#032f62">"c.Test24"</span><span style="color:#24292e">)</span></span>
<span class="line"><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">class</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Test24</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">static</span><span style="color:#24292e"> </span><span style="color:#d73a49">final</span><span style="color:#24292e"> Object room </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Object</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">static</span><span style="color:#24292e"> </span><span style="color:#d73a49">boolean</span><span style="color:#24292e"> hasCigarette </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#005cc5">false</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">static</span><span style="color:#24292e"> </span><span style="color:#d73a49">boolean</span><span style="color:#24292e"> hasTakeout </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#005cc5">false</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">static</span><span style="color:#24292e"> ReentrantLock ROOM </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">ReentrantLock</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">// 等待烟的休息室</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">static</span><span style="color:#24292e"> Condition waitCigaretteSet </span><span style="color:#d73a49">=</span><span style="color:#24292e"> ROOM.</span><span style="color:#6f42c1">newCondition</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">// 等外卖的休息室</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">static</span><span style="color:#24292e"> Condition waitTakeoutSet </span><span style="color:#d73a49">=</span><span style="color:#24292e"> ROOM.</span><span style="color:#6f42c1">newCondition</span><span style="color:#24292e">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">static</span><span style="color:#24292e"> </span><span style="color:#d73a49">void</span><span style="color:#24292e"> </span><span style="color:#6f42c1">main</span><span style="color:#24292e">(</span><span style="color:#d73a49">String</span><span style="color:#24292e">[] </span><span style="color:#e36209">args</span><span style="color:#24292e">) {</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Thread</span><span style="color:#24292e">(() </span><span style="color:#d73a49">-&gt;</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">            ROOM.</span><span style="color:#6f42c1">lock</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">try</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">                log.</span><span style="color:#6f42c1">debug</span><span style="color:#24292e">(</span><span style="color:#032f62">"有烟没？[{}]"</span><span style="color:#24292e">, hasCigarette);</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#d73a49">while</span><span style="color:#24292e"> (</span><span style="color:#d73a49">!</span><span style="color:#24292e">hasCigarette) {</span></span>
<span class="line"><span style="color:#24292e">                    log.</span><span style="color:#6f42c1">debug</span><span style="color:#24292e">(</span><span style="color:#032f62">"没烟，先歇会！"</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">                    </span><span style="color:#d73a49">try</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">                        waitCigaretteSet.</span><span style="color:#6f42c1">await</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">                    } </span><span style="color:#d73a49">catch</span><span style="color:#24292e"> (InterruptedException </span><span style="color:#e36209">e</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">                        e.</span><span style="color:#6f42c1">printStackTrace</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">                    }</span></span>
<span class="line"><span style="color:#24292e">                }</span></span>
<span class="line"><span style="color:#24292e">                log.</span><span style="color:#6f42c1">debug</span><span style="color:#24292e">(</span><span style="color:#032f62">"可以开始干活了"</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">            } </span><span style="color:#d73a49">finally</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">                ROOM.</span><span style="color:#6f42c1">unlock</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">            }</span></span>
<span class="line"><span style="color:#24292e">        }, </span><span style="color:#032f62">"小南"</span><span style="color:#24292e">).</span><span style="color:#6f42c1">start</span><span style="color:#24292e">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Thread</span><span style="color:#24292e">(() </span><span style="color:#d73a49">-&gt;</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">            ROOM.</span><span style="color:#6f42c1">lock</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">try</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">                log.</span><span style="color:#6f42c1">debug</span><span style="color:#24292e">(</span><span style="color:#032f62">"外卖送到没？[{}]"</span><span style="color:#24292e">, hasTakeout);</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#d73a49">while</span><span style="color:#24292e"> (</span><span style="color:#d73a49">!</span><span style="color:#24292e">hasTakeout) {</span></span>
<span class="line"><span style="color:#24292e">                    log.</span><span style="color:#6f42c1">debug</span><span style="color:#24292e">(</span><span style="color:#032f62">"没外卖，先歇会！"</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">                    </span><span style="color:#d73a49">try</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">                        waitTakeoutSet.</span><span style="color:#6f42c1">await</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">                    } </span><span style="color:#d73a49">catch</span><span style="color:#24292e"> (InterruptedException </span><span style="color:#e36209">e</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">                        e.</span><span style="color:#6f42c1">printStackTrace</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">                    }</span></span>
<span class="line"><span style="color:#24292e">                }</span></span>
<span class="line"><span style="color:#24292e">                log.</span><span style="color:#6f42c1">debug</span><span style="color:#24292e">(</span><span style="color:#032f62">"可以开始干活了"</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">            } </span><span style="color:#d73a49">finally</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">                ROOM.</span><span style="color:#6f42c1">unlock</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">            }</span></span>
<span class="line"><span style="color:#24292e">        }, </span><span style="color:#032f62">"小女"</span><span style="color:#24292e">).</span><span style="color:#6f42c1">start</span><span style="color:#24292e">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6f42c1">sleep</span><span style="color:#24292e">(</span><span style="color:#005cc5">1</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Thread</span><span style="color:#24292e">(() </span><span style="color:#d73a49">-&gt;</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">            ROOM.</span><span style="color:#6f42c1">lock</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">try</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">                hasTakeout </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#005cc5">true</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">                waitTakeoutSet.</span><span style="color:#6f42c1">signal</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">            } </span><span style="color:#d73a49">finally</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">                ROOM.</span><span style="color:#6f42c1">unlock</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">            }</span></span>
<span class="line"><span style="color:#24292e">        }, </span><span style="color:#032f62">"送外卖的"</span><span style="color:#24292e">).</span><span style="color:#6f42c1">start</span><span style="color:#24292e">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6f42c1">sleep</span><span style="color:#24292e">(</span><span style="color:#005cc5">1</span><span style="color:#24292e">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Thread</span><span style="color:#24292e">(() </span><span style="color:#d73a49">-&gt;</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">            ROOM.</span><span style="color:#6f42c1">lock</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">try</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">                hasCigarette </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#005cc5">true</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">                waitCigaretteSet.</span><span style="color:#6f42c1">signal</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">            } </span><span style="color:#d73a49">finally</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">                ROOM.</span><span style="color:#6f42c1">unlock</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">            }</span></span>
<span class="line"><span style="color:#24292e">        }, </span><span style="color:#032f62">"送烟的"</span><span style="color:#24292e">).</span><span style="color:#6f42c1">start</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">}</span></span></code></pre></div><h4 id="通过lock与aqs实现可重入锁" tabindex="-1">通过Lock与AQS实现可重入锁 <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20intermediate%20level#通过lock与aqs实现可重入锁" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h4><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">class</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">MyLock</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">implements</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Lock</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">   </span><span style="color:#f97583">private</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">static</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">class</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Sync</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">extends</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">AbstractQueuedSynchronizer</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">      @</span><span style="color:#f97583">Override</span></span>
<span class="line"><span style="color:#e1e4e8">      </span><span style="color:#f97583">protected</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">boolean</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">tryAcquire</span><span style="color:#e1e4e8">(</span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> </span><span style="color:#ffab70">arg</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">         </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (</span><span style="color:#b392f0">getExclusiveOwnerThread</span><span style="color:#e1e4e8">() </span><span style="color:#f97583">==</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (</span><span style="color:#b392f0">compareAndSetState</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8">, </span><span style="color:#79b8ff">1</span><span style="color:#e1e4e8">)) {</span></span>
<span class="line"><span style="color:#e1e4e8">               </span><span style="color:#b392f0">setExclusiveOwnerThread</span><span style="color:#e1e4e8">(Thread.</span><span style="color:#b392f0">currentThread</span><span style="color:#e1e4e8">());</span></span>
<span class="line"><span style="color:#e1e4e8">               </span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">true</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">            }</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">false</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">         }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">         </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (</span><span style="color:#b392f0">getExclusiveOwnerThread</span><span style="color:#e1e4e8">() </span><span style="color:#f97583">==</span><span style="color:#e1e4e8"> Thread.</span><span style="color:#b392f0">currentThread</span><span style="color:#e1e4e8">()) {</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> state </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">getState</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#b392f0">compareAndSetState</span><span style="color:#e1e4e8">(state, state </span><span style="color:#f97583">+</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">1</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">true</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">         }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">         </span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">false</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">      }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">      @</span><span style="color:#f97583">Override</span></span>
<span class="line"><span style="color:#e1e4e8">      </span><span style="color:#f97583">protected</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">boolean</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">tryRelease</span><span style="color:#e1e4e8">(</span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> </span><span style="color:#ffab70">arg</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">         </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (</span><span style="color:#b392f0">getState</span><span style="color:#e1e4e8">() </span><span style="color:#f97583">&lt;=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">throw</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">IllegalMonitorStateException</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">         }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">         </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (</span><span style="color:#b392f0">getExclusiveOwnerThread</span><span style="color:#e1e4e8">() </span><span style="color:#f97583">!=</span><span style="color:#e1e4e8"> Thread.</span><span style="color:#b392f0">currentThread</span><span style="color:#e1e4e8">()) {</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">throw</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">IllegalMonitorStateException</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">         }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">         </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> state </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">getState</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">         </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (state </span><span style="color:#f97583">==</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">1</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#b392f0">setExclusiveOwnerThread</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#b392f0">compareAndSetState</span><span style="color:#e1e4e8">(state, </span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">         } </span><span style="color:#f97583">else</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#b392f0">compareAndSetState</span><span style="color:#e1e4e8">(state, state </span><span style="color:#f97583">-</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">1</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">         }</span></span>
<span class="line"><span style="color:#e1e4e8">         </span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">true</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">      }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">      @</span><span style="color:#f97583">Override</span></span>
<span class="line"><span style="color:#e1e4e8">      </span><span style="color:#f97583">protected</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">boolean</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">isHeldExclusively</span><span style="color:#e1e4e8">() {</span></span>
<span class="line"><span style="color:#e1e4e8">         </span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">getState</span><span style="color:#e1e4e8">() </span><span style="color:#f97583">&gt;=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">1</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">      }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">      </span><span style="color:#f97583">public</span><span style="color:#e1e4e8"> Condition </span><span style="color:#b392f0">newCondition</span><span style="color:#e1e4e8">() {</span></span>
<span class="line"><span style="color:#e1e4e8">         </span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">ConditionObject</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">      }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">   }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">   Sync sync </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Sync</span><span style="color:#e1e4e8">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">   @</span><span style="color:#f97583">Override</span></span>
<span class="line"><span style="color:#e1e4e8">   </span><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">void</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">lock</span><span style="color:#e1e4e8">() {</span></span>
<span class="line"><span style="color:#e1e4e8">      sync.</span><span style="color:#b392f0">acquire</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">1</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">   }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">   @</span><span style="color:#f97583">Override</span></span>
<span class="line"><span style="color:#e1e4e8">   </span><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">void</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">lockInterruptibly</span><span style="color:#e1e4e8">() </span><span style="color:#f97583">throws</span><span style="color:#e1e4e8"> InterruptedException {</span></span>
<span class="line"><span style="color:#e1e4e8">      sync.</span><span style="color:#b392f0">acquireInterruptibly</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">1</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">   }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">   @</span><span style="color:#f97583">Override</span></span>
<span class="line"><span style="color:#e1e4e8">   </span><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">boolean</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">tryLock</span><span style="color:#e1e4e8">() {</span></span>
<span class="line"><span style="color:#e1e4e8">      </span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> sync.</span><span style="color:#b392f0">tryAcquire</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">1</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">   }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">   @</span><span style="color:#f97583">Override</span></span>
<span class="line"><span style="color:#e1e4e8">   </span><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">boolean</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">tryLock</span><span style="color:#e1e4e8">(</span><span style="color:#f97583">long</span><span style="color:#e1e4e8"> </span><span style="color:#ffab70">time</span><span style="color:#e1e4e8">, TimeUnit </span><span style="color:#ffab70">unit</span><span style="color:#e1e4e8">) </span><span style="color:#f97583">throws</span><span style="color:#e1e4e8"> InterruptedException {</span></span>
<span class="line"><span style="color:#e1e4e8">      </span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> sync.</span><span style="color:#b392f0">tryAcquireNanos</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">1</span><span style="color:#e1e4e8">, time);</span></span>
<span class="line"><span style="color:#e1e4e8">   }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">   @</span><span style="color:#f97583">Override</span></span>
<span class="line"><span style="color:#e1e4e8">   </span><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">void</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">unlock</span><span style="color:#e1e4e8">() {</span></span>
<span class="line"><span style="color:#e1e4e8">      sync.</span><span style="color:#b392f0">release</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">1</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">   }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">   @</span><span style="color:#f97583">Override</span></span>
<span class="line"><span style="color:#e1e4e8">   </span><span style="color:#f97583">public</span><span style="color:#e1e4e8"> Condition </span><span style="color:#b392f0">newCondition</span><span style="color:#e1e4e8">() {</span></span>
<span class="line"><span style="color:#e1e4e8">      </span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> sync.</span><span style="color:#b392f0">newCondition</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">   }</span></span>
<span class="line"><span style="color:#e1e4e8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#f97583">class</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Main</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">   </span><span style="color:#f97583">static</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> num </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">   </span><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">static</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">void</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">main</span><span style="color:#e1e4e8">(</span><span style="color:#f97583">String</span><span style="color:#e1e4e8">[] </span><span style="color:#ffab70">args</span><span style="color:#e1e4e8">) </span><span style="color:#f97583">throws</span><span style="color:#e1e4e8"> InterruptedException, IOException {</span></span>
<span class="line"><span style="color:#e1e4e8">      MyLock lock </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">MyLock</span><span style="color:#e1e4e8">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">      Object syncLock </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Object</span><span style="color:#e1e4e8">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">      Thread t1 </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Thread</span><span style="color:#e1e4e8">(() </span><span style="color:#f97583">-&gt;</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">         </span><span style="color:#f97583">for</span><span style="color:#e1e4e8"> (</span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> i </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8">; i </span><span style="color:#f97583">&lt;</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">10000</span><span style="color:#e1e4e8">; i</span><span style="color:#f97583">++</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">            lock.</span><span style="color:#b392f0">lock</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">try</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">               lock.</span><span style="color:#b392f0">lock</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">               </span><span style="color:#f97583">try</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">                  lock.</span><span style="color:#b392f0">lock</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">                  </span><span style="color:#f97583">try</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">                     num</span><span style="color:#f97583">++</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">                  } </span><span style="color:#f97583">finally</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">                     lock.</span><span style="color:#b392f0">unlock</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">                  }</span></span>
<span class="line"><span style="color:#e1e4e8">               } </span><span style="color:#f97583">finally</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">                  lock.</span><span style="color:#b392f0">unlock</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">               }</span></span>
<span class="line"><span style="color:#e1e4e8">            } </span><span style="color:#f97583">finally</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">               lock.</span><span style="color:#b392f0">unlock</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">            }</span></span>
<span class="line"><span style="color:#e1e4e8">         }</span></span>
<span class="line"><span style="color:#e1e4e8">      });</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">      Thread t2 </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Thread</span><span style="color:#e1e4e8">(() </span><span style="color:#f97583">-&gt;</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">         </span><span style="color:#f97583">for</span><span style="color:#e1e4e8"> (</span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> i </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8">; i </span><span style="color:#f97583">&lt;</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">10000</span><span style="color:#e1e4e8">; i</span><span style="color:#f97583">++</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">            lock.</span><span style="color:#b392f0">lock</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">try</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">               lock.</span><span style="color:#b392f0">lock</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">               </span><span style="color:#f97583">try</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">                  lock.</span><span style="color:#b392f0">lock</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">                  </span><span style="color:#f97583">try</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">                     num</span><span style="color:#f97583">--</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">                  } </span><span style="color:#f97583">finally</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">                     lock.</span><span style="color:#b392f0">unlock</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">                  }</span></span>
<span class="line"><span style="color:#e1e4e8">               } </span><span style="color:#f97583">finally</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">                  lock.</span><span style="color:#b392f0">unlock</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">               }</span></span>
<span class="line"><span style="color:#e1e4e8">            } </span><span style="color:#f97583">finally</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">               lock.</span><span style="color:#b392f0">unlock</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">            }</span></span>
<span class="line"><span style="color:#e1e4e8">         }</span></span>
<span class="line"><span style="color:#e1e4e8">      });</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">      t1.</span><span style="color:#b392f0">start</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">      t2.</span><span style="color:#b392f0">start</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">      t1.</span><span style="color:#b392f0">join</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">      t2.</span><span style="color:#b392f0">join</span><span style="color:#e1e4e8">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">      </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> x </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">   }</span></span>
<span class="line"><span style="color:#e1e4e8">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">class</span><span style="color:#24292e"> </span><span style="color:#6f42c1">MyLock</span><span style="color:#24292e"> </span><span style="color:#d73a49">implements</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Lock</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">   </span><span style="color:#d73a49">private</span><span style="color:#24292e"> </span><span style="color:#d73a49">static</span><span style="color:#24292e"> </span><span style="color:#d73a49">class</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Sync</span><span style="color:#24292e"> </span><span style="color:#d73a49">extends</span><span style="color:#24292e"> </span><span style="color:#6f42c1">AbstractQueuedSynchronizer</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">      @</span><span style="color:#d73a49">Override</span></span>
<span class="line"><span style="color:#24292e">      </span><span style="color:#d73a49">protected</span><span style="color:#24292e"> </span><span style="color:#d73a49">boolean</span><span style="color:#24292e"> </span><span style="color:#6f42c1">tryAcquire</span><span style="color:#24292e">(</span><span style="color:#d73a49">int</span><span style="color:#24292e"> </span><span style="color:#e36209">arg</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">         </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (</span><span style="color:#6f42c1">getExclusiveOwnerThread</span><span style="color:#24292e">() </span><span style="color:#d73a49">==</span><span style="color:#24292e"> </span><span style="color:#005cc5">null</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (</span><span style="color:#6f42c1">compareAndSetState</span><span style="color:#24292e">(</span><span style="color:#005cc5">0</span><span style="color:#24292e">, </span><span style="color:#005cc5">1</span><span style="color:#24292e">)) {</span></span>
<span class="line"><span style="color:#24292e">               </span><span style="color:#6f42c1">setExclusiveOwnerThread</span><span style="color:#24292e">(Thread.</span><span style="color:#6f42c1">currentThread</span><span style="color:#24292e">());</span></span>
<span class="line"><span style="color:#24292e">               </span><span style="color:#d73a49">return</span><span style="color:#24292e"> </span><span style="color:#005cc5">true</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">            }</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">return</span><span style="color:#24292e"> </span><span style="color:#005cc5">false</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">         }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">         </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (</span><span style="color:#6f42c1">getExclusiveOwnerThread</span><span style="color:#24292e">() </span><span style="color:#d73a49">==</span><span style="color:#24292e"> Thread.</span><span style="color:#6f42c1">currentThread</span><span style="color:#24292e">()) {</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">int</span><span style="color:#24292e"> state </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#6f42c1">getState</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#6f42c1">compareAndSetState</span><span style="color:#24292e">(state, state </span><span style="color:#d73a49">+</span><span style="color:#24292e"> </span><span style="color:#005cc5">1</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">return</span><span style="color:#24292e"> </span><span style="color:#005cc5">true</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">         }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">         </span><span style="color:#d73a49">return</span><span style="color:#24292e"> </span><span style="color:#005cc5">false</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">      }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">      @</span><span style="color:#d73a49">Override</span></span>
<span class="line"><span style="color:#24292e">      </span><span style="color:#d73a49">protected</span><span style="color:#24292e"> </span><span style="color:#d73a49">boolean</span><span style="color:#24292e"> </span><span style="color:#6f42c1">tryRelease</span><span style="color:#24292e">(</span><span style="color:#d73a49">int</span><span style="color:#24292e"> </span><span style="color:#e36209">arg</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">         </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (</span><span style="color:#6f42c1">getState</span><span style="color:#24292e">() </span><span style="color:#d73a49">&lt;=</span><span style="color:#24292e"> </span><span style="color:#005cc5">0</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">throw</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">IllegalMonitorStateException</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">         }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">         </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (</span><span style="color:#6f42c1">getExclusiveOwnerThread</span><span style="color:#24292e">() </span><span style="color:#d73a49">!=</span><span style="color:#24292e"> Thread.</span><span style="color:#6f42c1">currentThread</span><span style="color:#24292e">()) {</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">throw</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">IllegalMonitorStateException</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">         }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">         </span><span style="color:#d73a49">int</span><span style="color:#24292e"> state </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#6f42c1">getState</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">         </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (state </span><span style="color:#d73a49">==</span><span style="color:#24292e"> </span><span style="color:#005cc5">1</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#6f42c1">setExclusiveOwnerThread</span><span style="color:#24292e">(</span><span style="color:#005cc5">null</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#6f42c1">compareAndSetState</span><span style="color:#24292e">(state, </span><span style="color:#005cc5">0</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">         } </span><span style="color:#d73a49">else</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#6f42c1">compareAndSetState</span><span style="color:#24292e">(state, state </span><span style="color:#d73a49">-</span><span style="color:#24292e"> </span><span style="color:#005cc5">1</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">         }</span></span>
<span class="line"><span style="color:#24292e">         </span><span style="color:#d73a49">return</span><span style="color:#24292e"> </span><span style="color:#005cc5">true</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">      }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">      @</span><span style="color:#d73a49">Override</span></span>
<span class="line"><span style="color:#24292e">      </span><span style="color:#d73a49">protected</span><span style="color:#24292e"> </span><span style="color:#d73a49">boolean</span><span style="color:#24292e"> </span><span style="color:#6f42c1">isHeldExclusively</span><span style="color:#24292e">() {</span></span>
<span class="line"><span style="color:#24292e">         </span><span style="color:#d73a49">return</span><span style="color:#24292e"> </span><span style="color:#6f42c1">getState</span><span style="color:#24292e">() </span><span style="color:#d73a49">&gt;=</span><span style="color:#24292e"> </span><span style="color:#005cc5">1</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">      }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">      </span><span style="color:#d73a49">public</span><span style="color:#24292e"> Condition </span><span style="color:#6f42c1">newCondition</span><span style="color:#24292e">() {</span></span>
<span class="line"><span style="color:#24292e">         </span><span style="color:#d73a49">return</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">ConditionObject</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">      }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">   }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">   Sync sync </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Sync</span><span style="color:#24292e">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">   @</span><span style="color:#d73a49">Override</span></span>
<span class="line"><span style="color:#24292e">   </span><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">void</span><span style="color:#24292e"> </span><span style="color:#6f42c1">lock</span><span style="color:#24292e">() {</span></span>
<span class="line"><span style="color:#24292e">      sync.</span><span style="color:#6f42c1">acquire</span><span style="color:#24292e">(</span><span style="color:#005cc5">1</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">   }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">   @</span><span style="color:#d73a49">Override</span></span>
<span class="line"><span style="color:#24292e">   </span><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">void</span><span style="color:#24292e"> </span><span style="color:#6f42c1">lockInterruptibly</span><span style="color:#24292e">() </span><span style="color:#d73a49">throws</span><span style="color:#24292e"> InterruptedException {</span></span>
<span class="line"><span style="color:#24292e">      sync.</span><span style="color:#6f42c1">acquireInterruptibly</span><span style="color:#24292e">(</span><span style="color:#005cc5">1</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">   }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">   @</span><span style="color:#d73a49">Override</span></span>
<span class="line"><span style="color:#24292e">   </span><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">boolean</span><span style="color:#24292e"> </span><span style="color:#6f42c1">tryLock</span><span style="color:#24292e">() {</span></span>
<span class="line"><span style="color:#24292e">      </span><span style="color:#d73a49">return</span><span style="color:#24292e"> sync.</span><span style="color:#6f42c1">tryAcquire</span><span style="color:#24292e">(</span><span style="color:#005cc5">1</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">   }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">   @</span><span style="color:#d73a49">Override</span></span>
<span class="line"><span style="color:#24292e">   </span><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">boolean</span><span style="color:#24292e"> </span><span style="color:#6f42c1">tryLock</span><span style="color:#24292e">(</span><span style="color:#d73a49">long</span><span style="color:#24292e"> </span><span style="color:#e36209">time</span><span style="color:#24292e">, TimeUnit </span><span style="color:#e36209">unit</span><span style="color:#24292e">) </span><span style="color:#d73a49">throws</span><span style="color:#24292e"> InterruptedException {</span></span>
<span class="line"><span style="color:#24292e">      </span><span style="color:#d73a49">return</span><span style="color:#24292e"> sync.</span><span style="color:#6f42c1">tryAcquireNanos</span><span style="color:#24292e">(</span><span style="color:#005cc5">1</span><span style="color:#24292e">, time);</span></span>
<span class="line"><span style="color:#24292e">   }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">   @</span><span style="color:#d73a49">Override</span></span>
<span class="line"><span style="color:#24292e">   </span><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">void</span><span style="color:#24292e"> </span><span style="color:#6f42c1">unlock</span><span style="color:#24292e">() {</span></span>
<span class="line"><span style="color:#24292e">      sync.</span><span style="color:#6f42c1">release</span><span style="color:#24292e">(</span><span style="color:#005cc5">1</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">   }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">   @</span><span style="color:#d73a49">Override</span></span>
<span class="line"><span style="color:#24292e">   </span><span style="color:#d73a49">public</span><span style="color:#24292e"> Condition </span><span style="color:#6f42c1">newCondition</span><span style="color:#24292e">() {</span></span>
<span class="line"><span style="color:#24292e">      </span><span style="color:#d73a49">return</span><span style="color:#24292e"> sync.</span><span style="color:#6f42c1">newCondition</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">   }</span></span>
<span class="line"><span style="color:#24292e">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#d73a49">class</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Main</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">   </span><span style="color:#d73a49">static</span><span style="color:#24292e"> </span><span style="color:#d73a49">int</span><span style="color:#24292e"> num </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#005cc5">0</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">   </span><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">static</span><span style="color:#24292e"> </span><span style="color:#d73a49">void</span><span style="color:#24292e"> </span><span style="color:#6f42c1">main</span><span style="color:#24292e">(</span><span style="color:#d73a49">String</span><span style="color:#24292e">[] </span><span style="color:#e36209">args</span><span style="color:#24292e">) </span><span style="color:#d73a49">throws</span><span style="color:#24292e"> InterruptedException, IOException {</span></span>
<span class="line"><span style="color:#24292e">      MyLock lock </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">MyLock</span><span style="color:#24292e">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">      Object syncLock </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Object</span><span style="color:#24292e">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">      Thread t1 </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Thread</span><span style="color:#24292e">(() </span><span style="color:#d73a49">-&gt;</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">         </span><span style="color:#d73a49">for</span><span style="color:#24292e"> (</span><span style="color:#d73a49">int</span><span style="color:#24292e"> i </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#005cc5">0</span><span style="color:#24292e">; i </span><span style="color:#d73a49">&lt;</span><span style="color:#24292e"> </span><span style="color:#005cc5">10000</span><span style="color:#24292e">; i</span><span style="color:#d73a49">++</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">            lock.</span><span style="color:#6f42c1">lock</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">try</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">               lock.</span><span style="color:#6f42c1">lock</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">               </span><span style="color:#d73a49">try</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">                  lock.</span><span style="color:#6f42c1">lock</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">                  </span><span style="color:#d73a49">try</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">                     num</span><span style="color:#d73a49">++</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">                  } </span><span style="color:#d73a49">finally</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">                     lock.</span><span style="color:#6f42c1">unlock</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">                  }</span></span>
<span class="line"><span style="color:#24292e">               } </span><span style="color:#d73a49">finally</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">                  lock.</span><span style="color:#6f42c1">unlock</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">               }</span></span>
<span class="line"><span style="color:#24292e">            } </span><span style="color:#d73a49">finally</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">               lock.</span><span style="color:#6f42c1">unlock</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">            }</span></span>
<span class="line"><span style="color:#24292e">         }</span></span>
<span class="line"><span style="color:#24292e">      });</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">      Thread t2 </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Thread</span><span style="color:#24292e">(() </span><span style="color:#d73a49">-&gt;</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">         </span><span style="color:#d73a49">for</span><span style="color:#24292e"> (</span><span style="color:#d73a49">int</span><span style="color:#24292e"> i </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#005cc5">0</span><span style="color:#24292e">; i </span><span style="color:#d73a49">&lt;</span><span style="color:#24292e"> </span><span style="color:#005cc5">10000</span><span style="color:#24292e">; i</span><span style="color:#d73a49">++</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">            lock.</span><span style="color:#6f42c1">lock</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">try</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">               lock.</span><span style="color:#6f42c1">lock</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">               </span><span style="color:#d73a49">try</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">                  lock.</span><span style="color:#6f42c1">lock</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">                  </span><span style="color:#d73a49">try</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">                     num</span><span style="color:#d73a49">--</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">                  } </span><span style="color:#d73a49">finally</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">                     lock.</span><span style="color:#6f42c1">unlock</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">                  }</span></span>
<span class="line"><span style="color:#24292e">               } </span><span style="color:#d73a49">finally</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">                  lock.</span><span style="color:#6f42c1">unlock</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">               }</span></span>
<span class="line"><span style="color:#24292e">            } </span><span style="color:#d73a49">finally</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">               lock.</span><span style="color:#6f42c1">unlock</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">            }</span></span>
<span class="line"><span style="color:#24292e">         }</span></span>
<span class="line"><span style="color:#24292e">      });</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">      t1.</span><span style="color:#6f42c1">start</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">      t2.</span><span style="color:#6f42c1">start</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">      t1.</span><span style="color:#6f42c1">join</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">      t2.</span><span style="color:#6f42c1">join</span><span style="color:#24292e">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">      </span><span style="color:#d73a49">int</span><span style="color:#24292e"> x </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#005cc5">0</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">   }</span></span>
<span class="line"><span style="color:#24292e">}</span></span></code></pre></div><h3 id="_13、同步模式之顺序控制" tabindex="-1">13、同步模式之顺序控制 <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20intermediate%20level#_13、同步模式之顺序控制" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h3><h4 id="固定运行顺序" tabindex="-1">固定运行顺序 <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20intermediate%20level#固定运行顺序" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h4><p><strong>Wait/Notify版本</strong></p><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#f97583">static</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">final</span><span style="color:#e1e4e8"> Object LOCK </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Object</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#6a737d">//判断先执行的内容是否执行完毕</span></span>
<span class="line"><span style="color:#f97583">static</span><span style="color:#e1e4e8"> Boolean judge </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">false</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">static</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">void</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">main</span><span style="color:#e1e4e8">(</span><span style="color:#f97583">String</span><span style="color:#e1e4e8">[] args) {</span></span>
<span class="line"><span style="color:#e1e4e8">	</span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Thread</span><span style="color:#e1e4e8">(()</span><span style="color:#f97583">-&gt;</span><span style="color:#e1e4e8">{</span></span>
<span class="line"><span style="color:#e1e4e8">		</span><span style="color:#f97583">synchronized</span><span style="color:#e1e4e8"> (LOCK) {</span></span>
<span class="line"><span style="color:#e1e4e8">			</span><span style="color:#f97583">while</span><span style="color:#e1e4e8"> (</span><span style="color:#f97583">!</span><span style="color:#e1e4e8">judge) {</span></span>
<span class="line"><span style="color:#e1e4e8">				</span><span style="color:#f97583">try</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">					LOCK.</span><span style="color:#b392f0">wait</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">				} </span><span style="color:#f97583">catch</span><span style="color:#e1e4e8"> (InterruptedException </span><span style="color:#ffab70">e</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">					e.</span><span style="color:#b392f0">printStackTrace</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">				}</span></span>
<span class="line"><span style="color:#e1e4e8">			}</span></span>
<span class="line"><span style="color:#e1e4e8">			System.out.</span><span style="color:#b392f0">println</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"2"</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">		}</span></span>
<span class="line"><span style="color:#e1e4e8">	}).</span><span style="color:#b392f0">start</span><span style="color:#e1e4e8">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">	</span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Thread</span><span style="color:#e1e4e8">(()</span><span style="color:#f97583">-&gt;</span><span style="color:#e1e4e8">{</span></span>
<span class="line"><span style="color:#e1e4e8">		</span><span style="color:#f97583">synchronized</span><span style="color:#e1e4e8"> (LOCK) {</span></span>
<span class="line"><span style="color:#e1e4e8">			System.out.</span><span style="color:#b392f0">println</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"1"</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">			judge </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">true</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">               </span><span style="color:#6a737d">//执行完毕，唤醒所有等待线程</span></span>
<span class="line"><span style="color:#e1e4e8">			LOCK.</span><span style="color:#b392f0">notifyAll</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">		}</span></span>
<span class="line"><span style="color:#e1e4e8">	}).</span><span style="color:#b392f0">start</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#d73a49">static</span><span style="color:#24292e"> </span><span style="color:#d73a49">final</span><span style="color:#24292e"> Object LOCK </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Object</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#6a737d">//判断先执行的内容是否执行完毕</span></span>
<span class="line"><span style="color:#d73a49">static</span><span style="color:#24292e"> Boolean judge </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#005cc5">false</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">static</span><span style="color:#24292e"> </span><span style="color:#d73a49">void</span><span style="color:#24292e"> </span><span style="color:#6f42c1">main</span><span style="color:#24292e">(</span><span style="color:#d73a49">String</span><span style="color:#24292e">[] args) {</span></span>
<span class="line"><span style="color:#24292e">	</span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Thread</span><span style="color:#24292e">(()</span><span style="color:#d73a49">-&gt;</span><span style="color:#24292e">{</span></span>
<span class="line"><span style="color:#24292e">		</span><span style="color:#d73a49">synchronized</span><span style="color:#24292e"> (LOCK) {</span></span>
<span class="line"><span style="color:#24292e">			</span><span style="color:#d73a49">while</span><span style="color:#24292e"> (</span><span style="color:#d73a49">!</span><span style="color:#24292e">judge) {</span></span>
<span class="line"><span style="color:#24292e">				</span><span style="color:#d73a49">try</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">					LOCK.</span><span style="color:#6f42c1">wait</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">				} </span><span style="color:#d73a49">catch</span><span style="color:#24292e"> (InterruptedException </span><span style="color:#e36209">e</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">					e.</span><span style="color:#6f42c1">printStackTrace</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">				}</span></span>
<span class="line"><span style="color:#24292e">			}</span></span>
<span class="line"><span style="color:#24292e">			System.out.</span><span style="color:#6f42c1">println</span><span style="color:#24292e">(</span><span style="color:#032f62">"2"</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">		}</span></span>
<span class="line"><span style="color:#24292e">	}).</span><span style="color:#6f42c1">start</span><span style="color:#24292e">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">	</span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Thread</span><span style="color:#24292e">(()</span><span style="color:#d73a49">-&gt;</span><span style="color:#24292e">{</span></span>
<span class="line"><span style="color:#24292e">		</span><span style="color:#d73a49">synchronized</span><span style="color:#24292e"> (LOCK) {</span></span>
<span class="line"><span style="color:#24292e">			System.out.</span><span style="color:#6f42c1">println</span><span style="color:#24292e">(</span><span style="color:#032f62">"1"</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">			judge </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#005cc5">true</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">               </span><span style="color:#6a737d">//执行完毕，唤醒所有等待线程</span></span>
<span class="line"><span style="color:#24292e">			LOCK.</span><span style="color:#6f42c1">notifyAll</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">		}</span></span>
<span class="line"><span style="color:#24292e">	}).</span><span style="color:#6f42c1">start</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">}</span></span></code></pre></div><p><strong>Park Unpark 版</strong></p><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8">Thread t1 </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Thread</span><span style="color:#e1e4e8">(() </span><span style="color:#f97583">-&gt;</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#f97583">try</span><span style="color:#e1e4e8"> { Thread.</span><span style="color:#b392f0">sleep</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">1000</span><span style="color:#e1e4e8">); } </span><span style="color:#f97583">catch</span><span style="color:#e1e4e8"> (InterruptedException </span><span style="color:#ffab70">e</span><span style="color:#e1e4e8">) { }</span></span>
<span class="line"><span style="color:#6a737d">// 当没有『许可』时，当前线程暂停运行；有『许可』时，用掉这个『许可』，当前线程恢复运行</span></span>
<span class="line"><span style="color:#e1e4e8">LockSupport.</span><span style="color:#b392f0">park</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">System.out.</span><span style="color:#b392f0">println</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"1"</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">});</span></span>
<span class="line"><span style="color:#e1e4e8">Thread t2 </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Thread</span><span style="color:#e1e4e8">(() </span><span style="color:#f97583">-&gt;</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">System.out.</span><span style="color:#b392f0">println</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"2"</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#6a737d">// 给线程 t1 发放『许可』（多次连续调用 unpark 只会发放一个『许可』）</span></span>
<span class="line"><span style="color:#e1e4e8">LockSupport.</span><span style="color:#b392f0">unpark</span><span style="color:#e1e4e8">(t1);</span></span>
<span class="line"><span style="color:#e1e4e8">});</span></span>
<span class="line"><span style="color:#e1e4e8">t1.</span><span style="color:#b392f0">start</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">t2.</span><span style="color:#b392f0">start</span><span style="color:#e1e4e8">();</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e">Thread t1 </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Thread</span><span style="color:#24292e">(() </span><span style="color:#d73a49">-&gt;</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#d73a49">try</span><span style="color:#24292e"> { Thread.</span><span style="color:#6f42c1">sleep</span><span style="color:#24292e">(</span><span style="color:#005cc5">1000</span><span style="color:#24292e">); } </span><span style="color:#d73a49">catch</span><span style="color:#24292e"> (InterruptedException </span><span style="color:#e36209">e</span><span style="color:#24292e">) { }</span></span>
<span class="line"><span style="color:#6a737d">// 当没有『许可』时，当前线程暂停运行；有『许可』时，用掉这个『许可』，当前线程恢复运行</span></span>
<span class="line"><span style="color:#24292e">LockSupport.</span><span style="color:#6f42c1">park</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">System.out.</span><span style="color:#6f42c1">println</span><span style="color:#24292e">(</span><span style="color:#032f62">"1"</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">});</span></span>
<span class="line"><span style="color:#24292e">Thread t2 </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Thread</span><span style="color:#24292e">(() </span><span style="color:#d73a49">-&gt;</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">System.out.</span><span style="color:#6f42c1">println</span><span style="color:#24292e">(</span><span style="color:#032f62">"2"</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#6a737d">// 给线程 t1 发放『许可』（多次连续调用 unpark 只会发放一个『许可』）</span></span>
<span class="line"><span style="color:#24292e">LockSupport.</span><span style="color:#6f42c1">unpark</span><span style="color:#24292e">(t1);</span></span>
<span class="line"><span style="color:#24292e">});</span></span>
<span class="line"><span style="color:#24292e">t1.</span><span style="color:#6f42c1">start</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">t2.</span><span style="color:#6f42c1">start</span><span style="color:#24292e">();</span></span></code></pre></div><h4 id="交替输出" tabindex="-1">交替输出 <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20intermediate%20level#交替输出" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h4><p><strong>wait/notify版本</strong></p><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">class</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Test4</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">	</span><span style="color:#f97583">static</span><span style="color:#e1e4e8"> Symbol symbol </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Symbol</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">	</span><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">static</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">void</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">main</span><span style="color:#e1e4e8">(</span><span style="color:#f97583">String</span><span style="color:#e1e4e8">[] </span><span style="color:#ffab70">args</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">		</span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Thread</span><span style="color:#e1e4e8">(()</span><span style="color:#f97583">-&gt;</span><span style="color:#e1e4e8">{</span></span>
<span class="line"><span style="color:#e1e4e8">			symbol.</span><span style="color:#b392f0">run</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"a"</span><span style="color:#e1e4e8">, </span><span style="color:#79b8ff">1</span><span style="color:#e1e4e8">, </span><span style="color:#79b8ff">2</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">		}).</span><span style="color:#b392f0">start</span><span style="color:#e1e4e8">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">		</span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Thread</span><span style="color:#e1e4e8">(()</span><span style="color:#f97583">-&gt;</span><span style="color:#e1e4e8">{</span></span>
<span class="line"><span style="color:#e1e4e8">			symbol.</span><span style="color:#b392f0">run</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"b"</span><span style="color:#e1e4e8">, </span><span style="color:#79b8ff">2</span><span style="color:#e1e4e8">, </span><span style="color:#79b8ff">3</span><span style="color:#e1e4e8">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">		}).</span><span style="color:#b392f0">start</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">		symbol.</span><span style="color:#b392f0">run</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"c"</span><span style="color:#e1e4e8">, </span><span style="color:#79b8ff">3</span><span style="color:#e1e4e8">, </span><span style="color:#79b8ff">1</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">		</span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Thread</span><span style="color:#e1e4e8">(()</span><span style="color:#f97583">-&gt;</span><span style="color:#e1e4e8">{</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">		}).</span><span style="color:#b392f0">start</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">	}</span></span>
<span class="line"><span style="color:#e1e4e8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#f97583">class</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Symbol</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">	</span><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">synchronized</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">void</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">run</span><span style="color:#e1e4e8">(String </span><span style="color:#ffab70">str</span><span style="color:#e1e4e8">, </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> </span><span style="color:#ffab70">flag</span><span style="color:#e1e4e8">, </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> </span><span style="color:#ffab70">nextFlag</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">		</span><span style="color:#f97583">for</span><span style="color:#e1e4e8">(</span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> i</span><span style="color:#f97583">=</span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8">; i</span><span style="color:#f97583">&lt;</span><span style="color:#e1e4e8">loopNumber; i</span><span style="color:#f97583">++</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">			</span><span style="color:#f97583">while</span><span style="color:#e1e4e8">(flag </span><span style="color:#f97583">!=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">this</span><span style="color:#e1e4e8">.flag) {</span></span>
<span class="line"><span style="color:#e1e4e8">				</span><span style="color:#f97583">try</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">					</span><span style="color:#79b8ff">this</span><span style="color:#e1e4e8">.</span><span style="color:#b392f0">wait</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">				} </span><span style="color:#f97583">catch</span><span style="color:#e1e4e8"> (InterruptedException </span><span style="color:#ffab70">e</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">					e.</span><span style="color:#b392f0">printStackTrace</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">				}</span></span>
<span class="line"><span style="color:#e1e4e8">			}</span></span>
<span class="line"><span style="color:#e1e4e8">			System.out.</span><span style="color:#b392f0">println</span><span style="color:#e1e4e8">(str);</span></span>
<span class="line"><span style="color:#e1e4e8">			</span><span style="color:#6a737d">//设置下一个运行的线程标记</span></span>
<span class="line"><span style="color:#e1e4e8">			</span><span style="color:#79b8ff">this</span><span style="color:#e1e4e8">.flag </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> nextFlag;</span></span>
<span class="line"><span style="color:#e1e4e8">			</span><span style="color:#6a737d">//唤醒所有线程</span></span>
<span class="line"><span style="color:#e1e4e8">			</span><span style="color:#79b8ff">this</span><span style="color:#e1e4e8">.</span><span style="color:#b392f0">notifyAll</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">		}</span></span>
<span class="line"><span style="color:#e1e4e8">	}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6a737d">	/**</span></span>
<span class="line"><span style="color:#6a737d">	 * 线程的执行标记， 1-&gt;a 2-&gt;b 3-&gt;c</span></span>
<span class="line"><span style="color:#6a737d">	 */</span></span>
<span class="line"><span style="color:#e1e4e8">	</span><span style="color:#f97583">private</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> flag </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">1</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">	</span><span style="color:#f97583">private</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> loopNumber </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">5</span><span style="color:#e1e4e8">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">	</span><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">getFlag</span><span style="color:#e1e4e8">() {</span></span>
<span class="line"><span style="color:#e1e4e8">		</span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> flag;</span></span>
<span class="line"><span style="color:#e1e4e8">	}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">	</span><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">void</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">setFlag</span><span style="color:#e1e4e8">(</span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> </span><span style="color:#ffab70">flag</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">		</span><span style="color:#79b8ff">this</span><span style="color:#e1e4e8">.flag </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> flag;</span></span>
<span class="line"><span style="color:#e1e4e8">	}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">	</span><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">getLoopNumber</span><span style="color:#e1e4e8">() {</span></span>
<span class="line"><span style="color:#e1e4e8">		</span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> loopNumber;</span></span>
<span class="line"><span style="color:#e1e4e8">	}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">	</span><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">void</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">setLoopNumber</span><span style="color:#e1e4e8">(</span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> </span><span style="color:#ffab70">loopNumber</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">		</span><span style="color:#79b8ff">this</span><span style="color:#e1e4e8">.loopNumber </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> loopNumber;</span></span>
<span class="line"><span style="color:#e1e4e8">	}</span></span>
<span class="line"><span style="color:#e1e4e8">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">class</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Test4</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">	</span><span style="color:#d73a49">static</span><span style="color:#24292e"> Symbol symbol </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Symbol</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">	</span><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">static</span><span style="color:#24292e"> </span><span style="color:#d73a49">void</span><span style="color:#24292e"> </span><span style="color:#6f42c1">main</span><span style="color:#24292e">(</span><span style="color:#d73a49">String</span><span style="color:#24292e">[] </span><span style="color:#e36209">args</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">		</span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Thread</span><span style="color:#24292e">(()</span><span style="color:#d73a49">-&gt;</span><span style="color:#24292e">{</span></span>
<span class="line"><span style="color:#24292e">			symbol.</span><span style="color:#6f42c1">run</span><span style="color:#24292e">(</span><span style="color:#032f62">"a"</span><span style="color:#24292e">, </span><span style="color:#005cc5">1</span><span style="color:#24292e">, </span><span style="color:#005cc5">2</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">		}).</span><span style="color:#6f42c1">start</span><span style="color:#24292e">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">		</span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Thread</span><span style="color:#24292e">(()</span><span style="color:#d73a49">-&gt;</span><span style="color:#24292e">{</span></span>
<span class="line"><span style="color:#24292e">			symbol.</span><span style="color:#6f42c1">run</span><span style="color:#24292e">(</span><span style="color:#032f62">"b"</span><span style="color:#24292e">, </span><span style="color:#005cc5">2</span><span style="color:#24292e">, </span><span style="color:#005cc5">3</span><span style="color:#24292e">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">		}).</span><span style="color:#6f42c1">start</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">		symbol.</span><span style="color:#6f42c1">run</span><span style="color:#24292e">(</span><span style="color:#032f62">"c"</span><span style="color:#24292e">, </span><span style="color:#005cc5">3</span><span style="color:#24292e">, </span><span style="color:#005cc5">1</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">		</span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Thread</span><span style="color:#24292e">(()</span><span style="color:#d73a49">-&gt;</span><span style="color:#24292e">{</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">		}).</span><span style="color:#6f42c1">start</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">	}</span></span>
<span class="line"><span style="color:#24292e">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#d73a49">class</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Symbol</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">	</span><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">synchronized</span><span style="color:#24292e"> </span><span style="color:#d73a49">void</span><span style="color:#24292e"> </span><span style="color:#6f42c1">run</span><span style="color:#24292e">(String </span><span style="color:#e36209">str</span><span style="color:#24292e">, </span><span style="color:#d73a49">int</span><span style="color:#24292e"> </span><span style="color:#e36209">flag</span><span style="color:#24292e">, </span><span style="color:#d73a49">int</span><span style="color:#24292e"> </span><span style="color:#e36209">nextFlag</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">		</span><span style="color:#d73a49">for</span><span style="color:#24292e">(</span><span style="color:#d73a49">int</span><span style="color:#24292e"> i</span><span style="color:#d73a49">=</span><span style="color:#005cc5">0</span><span style="color:#24292e">; i</span><span style="color:#d73a49">&lt;</span><span style="color:#24292e">loopNumber; i</span><span style="color:#d73a49">++</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">			</span><span style="color:#d73a49">while</span><span style="color:#24292e">(flag </span><span style="color:#d73a49">!=</span><span style="color:#24292e"> </span><span style="color:#005cc5">this</span><span style="color:#24292e">.flag) {</span></span>
<span class="line"><span style="color:#24292e">				</span><span style="color:#d73a49">try</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">					</span><span style="color:#005cc5">this</span><span style="color:#24292e">.</span><span style="color:#6f42c1">wait</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">				} </span><span style="color:#d73a49">catch</span><span style="color:#24292e"> (InterruptedException </span><span style="color:#e36209">e</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">					e.</span><span style="color:#6f42c1">printStackTrace</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">				}</span></span>
<span class="line"><span style="color:#24292e">			}</span></span>
<span class="line"><span style="color:#24292e">			System.out.</span><span style="color:#6f42c1">println</span><span style="color:#24292e">(str);</span></span>
<span class="line"><span style="color:#24292e">			</span><span style="color:#6a737d">//设置下一个运行的线程标记</span></span>
<span class="line"><span style="color:#24292e">			</span><span style="color:#005cc5">this</span><span style="color:#24292e">.flag </span><span style="color:#d73a49">=</span><span style="color:#24292e"> nextFlag;</span></span>
<span class="line"><span style="color:#24292e">			</span><span style="color:#6a737d">//唤醒所有线程</span></span>
<span class="line"><span style="color:#24292e">			</span><span style="color:#005cc5">this</span><span style="color:#24292e">.</span><span style="color:#6f42c1">notifyAll</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">		}</span></span>
<span class="line"><span style="color:#24292e">	}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6a737d">	/**</span></span>
<span class="line"><span style="color:#6a737d">	 * 线程的执行标记， 1-&gt;a 2-&gt;b 3-&gt;c</span></span>
<span class="line"><span style="color:#6a737d">	 */</span></span>
<span class="line"><span style="color:#24292e">	</span><span style="color:#d73a49">private</span><span style="color:#24292e"> </span><span style="color:#d73a49">int</span><span style="color:#24292e"> flag </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#005cc5">1</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">	</span><span style="color:#d73a49">private</span><span style="color:#24292e"> </span><span style="color:#d73a49">int</span><span style="color:#24292e"> loopNumber </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#005cc5">5</span><span style="color:#24292e">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">	</span><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">int</span><span style="color:#24292e"> </span><span style="color:#6f42c1">getFlag</span><span style="color:#24292e">() {</span></span>
<span class="line"><span style="color:#24292e">		</span><span style="color:#d73a49">return</span><span style="color:#24292e"> flag;</span></span>
<span class="line"><span style="color:#24292e">	}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">	</span><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">void</span><span style="color:#24292e"> </span><span style="color:#6f42c1">setFlag</span><span style="color:#24292e">(</span><span style="color:#d73a49">int</span><span style="color:#24292e"> </span><span style="color:#e36209">flag</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">		</span><span style="color:#005cc5">this</span><span style="color:#24292e">.flag </span><span style="color:#d73a49">=</span><span style="color:#24292e"> flag;</span></span>
<span class="line"><span style="color:#24292e">	}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">	</span><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">int</span><span style="color:#24292e"> </span><span style="color:#6f42c1">getLoopNumber</span><span style="color:#24292e">() {</span></span>
<span class="line"><span style="color:#24292e">		</span><span style="color:#d73a49">return</span><span style="color:#24292e"> loopNumber;</span></span>
<span class="line"><span style="color:#24292e">	}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">	</span><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">void</span><span style="color:#24292e"> </span><span style="color:#6f42c1">setLoopNumber</span><span style="color:#24292e">(</span><span style="color:#d73a49">int</span><span style="color:#24292e"> </span><span style="color:#e36209">loopNumber</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">		</span><span style="color:#005cc5">this</span><span style="color:#24292e">.loopNumber </span><span style="color:#d73a49">=</span><span style="color:#24292e"> loopNumber;</span></span>
<span class="line"><span style="color:#24292e">	}</span></span>
<span class="line"><span style="color:#24292e">}</span></span></code></pre></div><p><strong>await/signal版本</strong></p><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">class</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Test5</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">	</span><span style="color:#f97583">static</span><span style="color:#e1e4e8"> AwaitSignal awaitSignal </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">AwaitSignal</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">	</span><span style="color:#f97583">static</span><span style="color:#e1e4e8"> Condition conditionA </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> awaitSignal.</span><span style="color:#b392f0">newCondition</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">	</span><span style="color:#f97583">static</span><span style="color:#e1e4e8"> Condition conditionB </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> awaitSignal.</span><span style="color:#b392f0">newCondition</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">	</span><span style="color:#f97583">static</span><span style="color:#e1e4e8"> Condition conditionC </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> awaitSignal.</span><span style="color:#b392f0">newCondition</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">	</span><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">static</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">void</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">main</span><span style="color:#e1e4e8">(</span><span style="color:#f97583">String</span><span style="color:#e1e4e8">[] </span><span style="color:#ffab70">args</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">		</span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Thread</span><span style="color:#e1e4e8">(()</span><span style="color:#f97583">-&gt;</span><span style="color:#e1e4e8">{</span></span>
<span class="line"><span style="color:#e1e4e8">			awaitSignal.</span><span style="color:#b392f0">run</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"a"</span><span style="color:#e1e4e8">, conditionA, conditionB);</span></span>
<span class="line"><span style="color:#e1e4e8">		}).</span><span style="color:#b392f0">start</span><span style="color:#e1e4e8">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">		</span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Thread</span><span style="color:#e1e4e8">(()</span><span style="color:#f97583">-&gt;</span><span style="color:#e1e4e8">{</span></span>
<span class="line"><span style="color:#e1e4e8">			awaitSignal.</span><span style="color:#b392f0">run</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"b"</span><span style="color:#e1e4e8">, conditionB, conditionC);</span></span>
<span class="line"><span style="color:#e1e4e8">		}).</span><span style="color:#b392f0">start</span><span style="color:#e1e4e8">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">		</span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Thread</span><span style="color:#e1e4e8">(()</span><span style="color:#f97583">-&gt;</span><span style="color:#e1e4e8">{</span></span>
<span class="line"><span style="color:#e1e4e8">			awaitSignal.</span><span style="color:#b392f0">run</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"c"</span><span style="color:#e1e4e8">, conditionC, conditionA);</span></span>
<span class="line"><span style="color:#e1e4e8">		}).</span><span style="color:#b392f0">start</span><span style="color:#e1e4e8">();</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">		</span><span style="color:#f97583">try</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">			Thread.</span><span style="color:#b392f0">sleep</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">1000</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">		} </span><span style="color:#f97583">catch</span><span style="color:#e1e4e8"> (InterruptedException </span><span style="color:#ffab70">e</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">			e.</span><span style="color:#b392f0">printStackTrace</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">		}</span></span>
<span class="line"><span style="color:#e1e4e8">		awaitSignal.</span><span style="color:#b392f0">lock</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">		</span><span style="color:#f97583">try</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#6a737d">//唤醒一个等待的线程</span></span>
<span class="line"><span style="color:#e1e4e8">			conditionA.</span><span style="color:#b392f0">signal</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">		}</span><span style="color:#f97583">finally</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">			awaitSignal.</span><span style="color:#b392f0">unlock</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">		}</span></span>
<span class="line"><span style="color:#e1e4e8">	}</span></span>
<span class="line"><span style="color:#e1e4e8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#f97583">class</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">AwaitSignal</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">extends</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">ReentrantLock</span><span style="color:#e1e4e8">{</span></span>
<span class="line"><span style="color:#e1e4e8">	</span><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">void</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">run</span><span style="color:#e1e4e8">(String </span><span style="color:#ffab70">str</span><span style="color:#e1e4e8">, Condition </span><span style="color:#ffab70">thisCondition</span><span style="color:#e1e4e8">, Condition </span><span style="color:#ffab70">nextCondition</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">		</span><span style="color:#f97583">for</span><span style="color:#e1e4e8">(</span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> i</span><span style="color:#f97583">=</span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8">; i</span><span style="color:#f97583">&lt;</span><span style="color:#e1e4e8">loopNumber; i</span><span style="color:#f97583">++</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">			</span><span style="color:#b392f0">lock</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">			</span><span style="color:#f97583">try</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#6a737d">//全部进入等待状态</span></span>
<span class="line"><span style="color:#e1e4e8">				thisCondition.</span><span style="color:#b392f0">await</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">				System.out.</span><span style="color:#b392f0">print</span><span style="color:#e1e4e8">(str);</span></span>
<span class="line"><span style="color:#e1e4e8">				nextCondition.</span><span style="color:#b392f0">signal</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">			} </span><span style="color:#f97583">catch</span><span style="color:#e1e4e8"> (InterruptedException </span><span style="color:#ffab70">e</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">				e.</span><span style="color:#b392f0">printStackTrace</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">			} </span><span style="color:#f97583">finally</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">				</span><span style="color:#b392f0">unlock</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">			}</span></span>
<span class="line"><span style="color:#e1e4e8">		}</span></span>
<span class="line"><span style="color:#e1e4e8">	}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">	</span><span style="color:#f97583">private</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> loopNumber</span><span style="color:#f97583">=</span><span style="color:#79b8ff">5</span><span style="color:#e1e4e8">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">	</span><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">getLoopNumber</span><span style="color:#e1e4e8">() {</span></span>
<span class="line"><span style="color:#e1e4e8">		</span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> loopNumber;</span></span>
<span class="line"><span style="color:#e1e4e8">	}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">	</span><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">void</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">setLoopNumber</span><span style="color:#e1e4e8">(</span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> </span><span style="color:#ffab70">loopNumber</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">		</span><span style="color:#79b8ff">this</span><span style="color:#e1e4e8">.loopNumber </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> loopNumber;</span></span>
<span class="line"><span style="color:#e1e4e8">	}</span></span>
<span class="line"><span style="color:#e1e4e8">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">class</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Test5</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">	</span><span style="color:#d73a49">static</span><span style="color:#24292e"> AwaitSignal awaitSignal </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">AwaitSignal</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">	</span><span style="color:#d73a49">static</span><span style="color:#24292e"> Condition conditionA </span><span style="color:#d73a49">=</span><span style="color:#24292e"> awaitSignal.</span><span style="color:#6f42c1">newCondition</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">	</span><span style="color:#d73a49">static</span><span style="color:#24292e"> Condition conditionB </span><span style="color:#d73a49">=</span><span style="color:#24292e"> awaitSignal.</span><span style="color:#6f42c1">newCondition</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">	</span><span style="color:#d73a49">static</span><span style="color:#24292e"> Condition conditionC </span><span style="color:#d73a49">=</span><span style="color:#24292e"> awaitSignal.</span><span style="color:#6f42c1">newCondition</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">	</span><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">static</span><span style="color:#24292e"> </span><span style="color:#d73a49">void</span><span style="color:#24292e"> </span><span style="color:#6f42c1">main</span><span style="color:#24292e">(</span><span style="color:#d73a49">String</span><span style="color:#24292e">[] </span><span style="color:#e36209">args</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">		</span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Thread</span><span style="color:#24292e">(()</span><span style="color:#d73a49">-&gt;</span><span style="color:#24292e">{</span></span>
<span class="line"><span style="color:#24292e">			awaitSignal.</span><span style="color:#6f42c1">run</span><span style="color:#24292e">(</span><span style="color:#032f62">"a"</span><span style="color:#24292e">, conditionA, conditionB);</span></span>
<span class="line"><span style="color:#24292e">		}).</span><span style="color:#6f42c1">start</span><span style="color:#24292e">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">		</span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Thread</span><span style="color:#24292e">(()</span><span style="color:#d73a49">-&gt;</span><span style="color:#24292e">{</span></span>
<span class="line"><span style="color:#24292e">			awaitSignal.</span><span style="color:#6f42c1">run</span><span style="color:#24292e">(</span><span style="color:#032f62">"b"</span><span style="color:#24292e">, conditionB, conditionC);</span></span>
<span class="line"><span style="color:#24292e">		}).</span><span style="color:#6f42c1">start</span><span style="color:#24292e">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">		</span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Thread</span><span style="color:#24292e">(()</span><span style="color:#d73a49">-&gt;</span><span style="color:#24292e">{</span></span>
<span class="line"><span style="color:#24292e">			awaitSignal.</span><span style="color:#6f42c1">run</span><span style="color:#24292e">(</span><span style="color:#032f62">"c"</span><span style="color:#24292e">, conditionC, conditionA);</span></span>
<span class="line"><span style="color:#24292e">		}).</span><span style="color:#6f42c1">start</span><span style="color:#24292e">();</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">		</span><span style="color:#d73a49">try</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">			Thread.</span><span style="color:#6f42c1">sleep</span><span style="color:#24292e">(</span><span style="color:#005cc5">1000</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">		} </span><span style="color:#d73a49">catch</span><span style="color:#24292e"> (InterruptedException </span><span style="color:#e36209">e</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">			e.</span><span style="color:#6f42c1">printStackTrace</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">		}</span></span>
<span class="line"><span style="color:#24292e">		awaitSignal.</span><span style="color:#6f42c1">lock</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">		</span><span style="color:#d73a49">try</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#6a737d">//唤醒一个等待的线程</span></span>
<span class="line"><span style="color:#24292e">			conditionA.</span><span style="color:#6f42c1">signal</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">		}</span><span style="color:#d73a49">finally</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">			awaitSignal.</span><span style="color:#6f42c1">unlock</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">		}</span></span>
<span class="line"><span style="color:#24292e">	}</span></span>
<span class="line"><span style="color:#24292e">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#d73a49">class</span><span style="color:#24292e"> </span><span style="color:#6f42c1">AwaitSignal</span><span style="color:#24292e"> </span><span style="color:#d73a49">extends</span><span style="color:#24292e"> </span><span style="color:#6f42c1">ReentrantLock</span><span style="color:#24292e">{</span></span>
<span class="line"><span style="color:#24292e">	</span><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">void</span><span style="color:#24292e"> </span><span style="color:#6f42c1">run</span><span style="color:#24292e">(String </span><span style="color:#e36209">str</span><span style="color:#24292e">, Condition </span><span style="color:#e36209">thisCondition</span><span style="color:#24292e">, Condition </span><span style="color:#e36209">nextCondition</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">		</span><span style="color:#d73a49">for</span><span style="color:#24292e">(</span><span style="color:#d73a49">int</span><span style="color:#24292e"> i</span><span style="color:#d73a49">=</span><span style="color:#005cc5">0</span><span style="color:#24292e">; i</span><span style="color:#d73a49">&lt;</span><span style="color:#24292e">loopNumber; i</span><span style="color:#d73a49">++</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">			</span><span style="color:#6f42c1">lock</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">			</span><span style="color:#d73a49">try</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#6a737d">//全部进入等待状态</span></span>
<span class="line"><span style="color:#24292e">				thisCondition.</span><span style="color:#6f42c1">await</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">				System.out.</span><span style="color:#6f42c1">print</span><span style="color:#24292e">(str);</span></span>
<span class="line"><span style="color:#24292e">				nextCondition.</span><span style="color:#6f42c1">signal</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">			} </span><span style="color:#d73a49">catch</span><span style="color:#24292e"> (InterruptedException </span><span style="color:#e36209">e</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">				e.</span><span style="color:#6f42c1">printStackTrace</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">			} </span><span style="color:#d73a49">finally</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">				</span><span style="color:#6f42c1">unlock</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">			}</span></span>
<span class="line"><span style="color:#24292e">		}</span></span>
<span class="line"><span style="color:#24292e">	}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">	</span><span style="color:#d73a49">private</span><span style="color:#24292e"> </span><span style="color:#d73a49">int</span><span style="color:#24292e"> loopNumber</span><span style="color:#d73a49">=</span><span style="color:#005cc5">5</span><span style="color:#24292e">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">	</span><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">int</span><span style="color:#24292e"> </span><span style="color:#6f42c1">getLoopNumber</span><span style="color:#24292e">() {</span></span>
<span class="line"><span style="color:#24292e">		</span><span style="color:#d73a49">return</span><span style="color:#24292e"> loopNumber;</span></span>
<span class="line"><span style="color:#24292e">	}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">	</span><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">void</span><span style="color:#24292e"> </span><span style="color:#6f42c1">setLoopNumber</span><span style="color:#24292e">(</span><span style="color:#d73a49">int</span><span style="color:#24292e"> </span><span style="color:#e36209">loopNumber</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">		</span><span style="color:#005cc5">this</span><span style="color:#24292e">.loopNumber </span><span style="color:#d73a49">=</span><span style="color:#24292e"> loopNumber;</span></span>
<span class="line"><span style="color:#24292e">	}</span></span>
<span class="line"><span style="color:#24292e">}</span></span></code></pre></div><p><strong>Park Unpark 版</strong></p><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8">@</span><span style="color:#f97583">Slf4j</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">topic</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#9ecbff">"c.Test31"</span><span style="color:#e1e4e8">)</span></span>
<span class="line"><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">class</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Test31</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">static</span><span style="color:#e1e4e8"> Thread t1;</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">static</span><span style="color:#e1e4e8"> Thread t2;</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">static</span><span style="color:#e1e4e8"> Thread t3;</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">static</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">void</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">main</span><span style="color:#e1e4e8">(</span><span style="color:#f97583">String</span><span style="color:#e1e4e8">[] </span><span style="color:#ffab70">args</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">        ParkUnpark pu </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">ParkUnpark</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">5</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">        t1 </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Thread</span><span style="color:#e1e4e8">(() </span><span style="color:#f97583">-&gt;</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">            pu.</span><span style="color:#b392f0">print</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"a"</span><span style="color:#e1e4e8">, t2);</span></span>
<span class="line"><span style="color:#e1e4e8">        });</span></span>
<span class="line"><span style="color:#e1e4e8">        t2 </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Thread</span><span style="color:#e1e4e8">(() </span><span style="color:#f97583">-&gt;</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">            pu.</span><span style="color:#b392f0">print</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"b"</span><span style="color:#e1e4e8">, t3);</span></span>
<span class="line"><span style="color:#e1e4e8">        });</span></span>
<span class="line"><span style="color:#e1e4e8">        t3 </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Thread</span><span style="color:#e1e4e8">(() </span><span style="color:#f97583">-&gt;</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">            pu.</span><span style="color:#b392f0">print</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"c"</span><span style="color:#e1e4e8">, t1);</span></span>
<span class="line"><span style="color:#e1e4e8">        });</span></span>
<span class="line"><span style="color:#e1e4e8">        t1.</span><span style="color:#b392f0">start</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">        t2.</span><span style="color:#b392f0">start</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">        t3.</span><span style="color:#b392f0">start</span><span style="color:#e1e4e8">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">        LockSupport.</span><span style="color:#b392f0">unpark</span><span style="color:#e1e4e8">(t1);</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"><span style="color:#e1e4e8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#f97583">class</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">ParkUnpark</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">void</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">print</span><span style="color:#e1e4e8">(String </span><span style="color:#ffab70">str</span><span style="color:#e1e4e8">, Thread </span><span style="color:#ffab70">next</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">for</span><span style="color:#e1e4e8"> (</span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> i </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8">; i </span><span style="color:#f97583">&lt;</span><span style="color:#e1e4e8"> loopNumber; i</span><span style="color:#f97583">++</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">            LockSupport.</span><span style="color:#b392f0">park</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">            System.out.</span><span style="color:#b392f0">print</span><span style="color:#e1e4e8">(str);</span></span>
<span class="line"><span style="color:#e1e4e8">            LockSupport.</span><span style="color:#b392f0">unpark</span><span style="color:#e1e4e8">(next);</span></span>
<span class="line"><span style="color:#e1e4e8">        }</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">private</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> loopNumber;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">ParkUnpark</span><span style="color:#e1e4e8">(</span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> </span><span style="color:#ffab70">loopNumber</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#79b8ff">this</span><span style="color:#e1e4e8">.loopNumber </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> loopNumber;</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"><span style="color:#e1e4e8">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e">@</span><span style="color:#d73a49">Slf4j</span><span style="color:#24292e">(</span><span style="color:#005cc5">topic</span><span style="color:#24292e"> </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#032f62">"c.Test31"</span><span style="color:#24292e">)</span></span>
<span class="line"><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">class</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Test31</span><span style="color:#24292e"> {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">static</span><span style="color:#24292e"> Thread t1;</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">static</span><span style="color:#24292e"> Thread t2;</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">static</span><span style="color:#24292e"> Thread t3;</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">static</span><span style="color:#24292e"> </span><span style="color:#d73a49">void</span><span style="color:#24292e"> </span><span style="color:#6f42c1">main</span><span style="color:#24292e">(</span><span style="color:#d73a49">String</span><span style="color:#24292e">[] </span><span style="color:#e36209">args</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">        ParkUnpark pu </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">ParkUnpark</span><span style="color:#24292e">(</span><span style="color:#005cc5">5</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">        t1 </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Thread</span><span style="color:#24292e">(() </span><span style="color:#d73a49">-&gt;</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">            pu.</span><span style="color:#6f42c1">print</span><span style="color:#24292e">(</span><span style="color:#032f62">"a"</span><span style="color:#24292e">, t2);</span></span>
<span class="line"><span style="color:#24292e">        });</span></span>
<span class="line"><span style="color:#24292e">        t2 </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Thread</span><span style="color:#24292e">(() </span><span style="color:#d73a49">-&gt;</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">            pu.</span><span style="color:#6f42c1">print</span><span style="color:#24292e">(</span><span style="color:#032f62">"b"</span><span style="color:#24292e">, t3);</span></span>
<span class="line"><span style="color:#24292e">        });</span></span>
<span class="line"><span style="color:#24292e">        t3 </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Thread</span><span style="color:#24292e">(() </span><span style="color:#d73a49">-&gt;</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">            pu.</span><span style="color:#6f42c1">print</span><span style="color:#24292e">(</span><span style="color:#032f62">"c"</span><span style="color:#24292e">, t1);</span></span>
<span class="line"><span style="color:#24292e">        });</span></span>
<span class="line"><span style="color:#24292e">        t1.</span><span style="color:#6f42c1">start</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">        t2.</span><span style="color:#6f42c1">start</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">        t3.</span><span style="color:#6f42c1">start</span><span style="color:#24292e">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">        LockSupport.</span><span style="color:#6f42c1">unpark</span><span style="color:#24292e">(t1);</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"><span style="color:#24292e">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#d73a49">class</span><span style="color:#24292e"> </span><span style="color:#6f42c1">ParkUnpark</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">void</span><span style="color:#24292e"> </span><span style="color:#6f42c1">print</span><span style="color:#24292e">(String </span><span style="color:#e36209">str</span><span style="color:#24292e">, Thread </span><span style="color:#e36209">next</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">for</span><span style="color:#24292e"> (</span><span style="color:#d73a49">int</span><span style="color:#24292e"> i </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#005cc5">0</span><span style="color:#24292e">; i </span><span style="color:#d73a49">&lt;</span><span style="color:#24292e"> loopNumber; i</span><span style="color:#d73a49">++</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">            LockSupport.</span><span style="color:#6f42c1">park</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">            System.out.</span><span style="color:#6f42c1">print</span><span style="color:#24292e">(str);</span></span>
<span class="line"><span style="color:#24292e">            LockSupport.</span><span style="color:#6f42c1">unpark</span><span style="color:#24292e">(next);</span></span>
<span class="line"><span style="color:#24292e">        }</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">private</span><span style="color:#24292e"> </span><span style="color:#d73a49">int</span><span style="color:#24292e"> loopNumber;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#6f42c1">ParkUnpark</span><span style="color:#24292e">(</span><span style="color:#d73a49">int</span><span style="color:#24292e"> </span><span style="color:#e36209">loopNumber</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#005cc5">this</span><span style="color:#24292e">.loopNumber </span><span style="color:#d73a49">=</span><span style="color:#24292e"> loopNumber;</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"><span style="color:#24292e">}</span></span></code></pre></div><h3 id="_14、threadlocal" tabindex="-1">14、ThreadLocal <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20intermediate%20level#_14、threadlocal" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h3><h4 id="简介" tabindex="-1">简介 <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20intermediate%20level#简介" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h4><p>ThreadLocal是JDK包提供的，它提供了线程本地变量，也就是如果你创建了一个ThreadLocal变量，那么<strong>访问这个变量的每个线程都会有这个变量的一个本地副本</strong>。当多个线程操作这个变量时，实际操作的是自己本地内存里面的变量，从而避免了线程安全问题</p><h4 id="使用" tabindex="-1">使用 <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20intermediate%20level#使用" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h4><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">class</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">ThreadLocalStudy</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">   </span><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">static</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">void</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">main</span><span style="color:#e1e4e8">(</span><span style="color:#f97583">String</span><span style="color:#e1e4e8">[] </span><span style="color:#ffab70">args</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">      </span><span style="color:#6a737d">// 创建ThreadLocal变量</span></span>
<span class="line"><span style="color:#e1e4e8">      ThreadLocal&lt;</span><span style="color:#f97583">String</span><span style="color:#e1e4e8">&gt; stringThreadLocal </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> ThreadLocal&lt;&gt;();</span></span>
<span class="line"><span style="color:#e1e4e8">      ThreadLocal&lt;</span><span style="color:#f97583">User</span><span style="color:#e1e4e8">&gt; userThreadLocal </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> ThreadLocal&lt;&gt;();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">      </span><span style="color:#6a737d">// 创建两个线程，分别使用上面的两个ThreadLocal变量</span></span>
<span class="line"><span style="color:#e1e4e8">      Thread thread1 </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Thread</span><span style="color:#e1e4e8">(()</span><span style="color:#f97583">-&gt;</span><span style="color:#e1e4e8">{</span></span>
<span class="line"><span style="color:#e1e4e8">         </span><span style="color:#6a737d">// stringThreadLocal第一次赋值</span></span>
<span class="line"><span style="color:#e1e4e8">         stringThreadLocal.</span><span style="color:#b392f0">set</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"thread1 stringThreadLocal first"</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">         </span><span style="color:#6a737d">// stringThreadLocal第二次赋值</span></span>
<span class="line"><span style="color:#e1e4e8">         stringThreadLocal.</span><span style="color:#b392f0">set</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"thread1 stringThreadLocal second"</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">         </span><span style="color:#6a737d">// userThreadLocal赋值</span></span>
<span class="line"><span style="color:#e1e4e8">         userThreadLocal.</span><span style="color:#b392f0">set</span><span style="color:#e1e4e8">(</span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">User</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"Nyima"</span><span style="color:#e1e4e8">, </span><span style="color:#79b8ff">20</span><span style="color:#e1e4e8">));</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">         </span><span style="color:#6a737d">// 取值</span></span>
<span class="line"><span style="color:#e1e4e8">         System.out.</span><span style="color:#b392f0">println</span><span style="color:#e1e4e8">(stringThreadLocal.</span><span style="color:#b392f0">get</span><span style="color:#e1e4e8">());</span></span>
<span class="line"><span style="color:#e1e4e8">         System.out.</span><span style="color:#b392f0">println</span><span style="color:#e1e4e8">(userThreadLocal.</span><span style="color:#b392f0">get</span><span style="color:#e1e4e8">());</span></span>
<span class="line"><span style="color:#e1e4e8">          </span></span>
<span class="line"><span style="color:#e1e4e8">          </span><span style="color:#6a737d">// 移除</span></span>
<span class="line"><span style="color:#e1e4e8">		 userThreadLocal.</span><span style="color:#b392f0">remove</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">		 System.out.</span><span style="color:#b392f0">println</span><span style="color:#e1e4e8">(userThreadLocal.</span><span style="color:#b392f0">get</span><span style="color:#e1e4e8">());</span></span>
<span class="line"><span style="color:#e1e4e8">      });</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">      Thread thread2 </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Thread</span><span style="color:#e1e4e8">(()</span><span style="color:#f97583">-&gt;</span><span style="color:#e1e4e8">{</span></span>
<span class="line"><span style="color:#e1e4e8">         </span><span style="color:#6a737d">// stringThreadLocal第一次赋值</span></span>
<span class="line"><span style="color:#e1e4e8">         stringThreadLocal.</span><span style="color:#b392f0">set</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"thread2 stringThreadLocal first"</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">         </span><span style="color:#6a737d">// stringThreadLocal第二次赋值</span></span>
<span class="line"><span style="color:#e1e4e8">         stringThreadLocal.</span><span style="color:#b392f0">set</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"thread2 stringThreadLocal second"</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">         </span><span style="color:#6a737d">// userThreadLocal赋值</span></span>
<span class="line"><span style="color:#e1e4e8">         userThreadLocal.</span><span style="color:#b392f0">set</span><span style="color:#e1e4e8">(</span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">User</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"Hulu"</span><span style="color:#e1e4e8">, </span><span style="color:#79b8ff">20</span><span style="color:#e1e4e8">));</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">         </span><span style="color:#6a737d">// 取值</span></span>
<span class="line"><span style="color:#e1e4e8">         System.out.</span><span style="color:#b392f0">println</span><span style="color:#e1e4e8">(stringThreadLocal.</span><span style="color:#b392f0">get</span><span style="color:#e1e4e8">());</span></span>
<span class="line"><span style="color:#e1e4e8">         System.out.</span><span style="color:#b392f0">println</span><span style="color:#e1e4e8">(userThreadLocal.</span><span style="color:#b392f0">get</span><span style="color:#e1e4e8">());</span></span>
<span class="line"><span style="color:#e1e4e8">      });</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">      </span><span style="color:#6a737d">// 启动线程</span></span>
<span class="line"><span style="color:#e1e4e8">      thread1.</span><span style="color:#b392f0">start</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">      thread2.</span><span style="color:#b392f0">start</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">   }</span></span>
<span class="line"><span style="color:#e1e4e8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#f97583">class</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">User</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">   String name;</span></span>
<span class="line"><span style="color:#e1e4e8">   </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> age;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">   </span><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">User</span><span style="color:#e1e4e8">(String </span><span style="color:#ffab70">name</span><span style="color:#e1e4e8">, </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> </span><span style="color:#ffab70">age</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">      </span><span style="color:#79b8ff">this</span><span style="color:#e1e4e8">.name </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> name;</span></span>
<span class="line"><span style="color:#e1e4e8">      </span><span style="color:#79b8ff">this</span><span style="color:#e1e4e8">.age </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> age;</span></span>
<span class="line"><span style="color:#e1e4e8">   }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">   @</span><span style="color:#f97583">Override</span></span>
<span class="line"><span style="color:#e1e4e8">   </span><span style="color:#f97583">public</span><span style="color:#e1e4e8"> String </span><span style="color:#b392f0">toString</span><span style="color:#e1e4e8">() {</span></span>
<span class="line"><span style="color:#e1e4e8">      </span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> </span><span style="color:#9ecbff">"User{"</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">+</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#9ecbff">"name='"</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">+</span><span style="color:#e1e4e8"> name </span><span style="color:#f97583">+</span><span style="color:#e1e4e8"> </span><span style="color:#9ecbff">'</span><span style="color:#79b8ff">\'</span><span style="color:#9ecbff">'</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">+</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#9ecbff">", age="</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">+</span><span style="color:#e1e4e8"> age </span><span style="color:#f97583">+</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#9ecbff">'}'</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">   }</span></span>
<span class="line"><span style="color:#e1e4e8">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">class</span><span style="color:#24292e"> </span><span style="color:#6f42c1">ThreadLocalStudy</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">   </span><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">static</span><span style="color:#24292e"> </span><span style="color:#d73a49">void</span><span style="color:#24292e"> </span><span style="color:#6f42c1">main</span><span style="color:#24292e">(</span><span style="color:#d73a49">String</span><span style="color:#24292e">[] </span><span style="color:#e36209">args</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">      </span><span style="color:#6a737d">// 创建ThreadLocal变量</span></span>
<span class="line"><span style="color:#24292e">      ThreadLocal&lt;</span><span style="color:#d73a49">String</span><span style="color:#24292e">&gt; stringThreadLocal </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> ThreadLocal&lt;&gt;();</span></span>
<span class="line"><span style="color:#24292e">      ThreadLocal&lt;</span><span style="color:#d73a49">User</span><span style="color:#24292e">&gt; userThreadLocal </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> ThreadLocal&lt;&gt;();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">      </span><span style="color:#6a737d">// 创建两个线程，分别使用上面的两个ThreadLocal变量</span></span>
<span class="line"><span style="color:#24292e">      Thread thread1 </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Thread</span><span style="color:#24292e">(()</span><span style="color:#d73a49">-&gt;</span><span style="color:#24292e">{</span></span>
<span class="line"><span style="color:#24292e">         </span><span style="color:#6a737d">// stringThreadLocal第一次赋值</span></span>
<span class="line"><span style="color:#24292e">         stringThreadLocal.</span><span style="color:#6f42c1">set</span><span style="color:#24292e">(</span><span style="color:#032f62">"thread1 stringThreadLocal first"</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">         </span><span style="color:#6a737d">// stringThreadLocal第二次赋值</span></span>
<span class="line"><span style="color:#24292e">         stringThreadLocal.</span><span style="color:#6f42c1">set</span><span style="color:#24292e">(</span><span style="color:#032f62">"thread1 stringThreadLocal second"</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">         </span><span style="color:#6a737d">// userThreadLocal赋值</span></span>
<span class="line"><span style="color:#24292e">         userThreadLocal.</span><span style="color:#6f42c1">set</span><span style="color:#24292e">(</span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">User</span><span style="color:#24292e">(</span><span style="color:#032f62">"Nyima"</span><span style="color:#24292e">, </span><span style="color:#005cc5">20</span><span style="color:#24292e">));</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">         </span><span style="color:#6a737d">// 取值</span></span>
<span class="line"><span style="color:#24292e">         System.out.</span><span style="color:#6f42c1">println</span><span style="color:#24292e">(stringThreadLocal.</span><span style="color:#6f42c1">get</span><span style="color:#24292e">());</span></span>
<span class="line"><span style="color:#24292e">         System.out.</span><span style="color:#6f42c1">println</span><span style="color:#24292e">(userThreadLocal.</span><span style="color:#6f42c1">get</span><span style="color:#24292e">());</span></span>
<span class="line"><span style="color:#24292e">          </span></span>
<span class="line"><span style="color:#24292e">          </span><span style="color:#6a737d">// 移除</span></span>
<span class="line"><span style="color:#24292e">		 userThreadLocal.</span><span style="color:#6f42c1">remove</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">		 System.out.</span><span style="color:#6f42c1">println</span><span style="color:#24292e">(userThreadLocal.</span><span style="color:#6f42c1">get</span><span style="color:#24292e">());</span></span>
<span class="line"><span style="color:#24292e">      });</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">      Thread thread2 </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Thread</span><span style="color:#24292e">(()</span><span style="color:#d73a49">-&gt;</span><span style="color:#24292e">{</span></span>
<span class="line"><span style="color:#24292e">         </span><span style="color:#6a737d">// stringThreadLocal第一次赋值</span></span>
<span class="line"><span style="color:#24292e">         stringThreadLocal.</span><span style="color:#6f42c1">set</span><span style="color:#24292e">(</span><span style="color:#032f62">"thread2 stringThreadLocal first"</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">         </span><span style="color:#6a737d">// stringThreadLocal第二次赋值</span></span>
<span class="line"><span style="color:#24292e">         stringThreadLocal.</span><span style="color:#6f42c1">set</span><span style="color:#24292e">(</span><span style="color:#032f62">"thread2 stringThreadLocal second"</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">         </span><span style="color:#6a737d">// userThreadLocal赋值</span></span>
<span class="line"><span style="color:#24292e">         userThreadLocal.</span><span style="color:#6f42c1">set</span><span style="color:#24292e">(</span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">User</span><span style="color:#24292e">(</span><span style="color:#032f62">"Hulu"</span><span style="color:#24292e">, </span><span style="color:#005cc5">20</span><span style="color:#24292e">));</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">         </span><span style="color:#6a737d">// 取值</span></span>
<span class="line"><span style="color:#24292e">         System.out.</span><span style="color:#6f42c1">println</span><span style="color:#24292e">(stringThreadLocal.</span><span style="color:#6f42c1">get</span><span style="color:#24292e">());</span></span>
<span class="line"><span style="color:#24292e">         System.out.</span><span style="color:#6f42c1">println</span><span style="color:#24292e">(userThreadLocal.</span><span style="color:#6f42c1">get</span><span style="color:#24292e">());</span></span>
<span class="line"><span style="color:#24292e">      });</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">      </span><span style="color:#6a737d">// 启动线程</span></span>
<span class="line"><span style="color:#24292e">      thread1.</span><span style="color:#6f42c1">start</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">      thread2.</span><span style="color:#6f42c1">start</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">   }</span></span>
<span class="line"><span style="color:#24292e">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#d73a49">class</span><span style="color:#24292e"> </span><span style="color:#6f42c1">User</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">   String name;</span></span>
<span class="line"><span style="color:#24292e">   </span><span style="color:#d73a49">int</span><span style="color:#24292e"> age;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">   </span><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#6f42c1">User</span><span style="color:#24292e">(String </span><span style="color:#e36209">name</span><span style="color:#24292e">, </span><span style="color:#d73a49">int</span><span style="color:#24292e"> </span><span style="color:#e36209">age</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">      </span><span style="color:#005cc5">this</span><span style="color:#24292e">.name </span><span style="color:#d73a49">=</span><span style="color:#24292e"> name;</span></span>
<span class="line"><span style="color:#24292e">      </span><span style="color:#005cc5">this</span><span style="color:#24292e">.age </span><span style="color:#d73a49">=</span><span style="color:#24292e"> age;</span></span>
<span class="line"><span style="color:#24292e">   }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">   @</span><span style="color:#d73a49">Override</span></span>
<span class="line"><span style="color:#24292e">   </span><span style="color:#d73a49">public</span><span style="color:#24292e"> String </span><span style="color:#6f42c1">toString</span><span style="color:#24292e">() {</span></span>
<span class="line"><span style="color:#24292e">      </span><span style="color:#d73a49">return</span><span style="color:#24292e"> </span><span style="color:#032f62">"User{"</span><span style="color:#24292e"> </span><span style="color:#d73a49">+</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#032f62">"name='"</span><span style="color:#24292e"> </span><span style="color:#d73a49">+</span><span style="color:#24292e"> name </span><span style="color:#d73a49">+</span><span style="color:#24292e"> </span><span style="color:#032f62">'</span><span style="color:#005cc5">\'</span><span style="color:#032f62">'</span><span style="color:#24292e"> </span><span style="color:#d73a49">+</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#032f62">", age="</span><span style="color:#24292e"> </span><span style="color:#d73a49">+</span><span style="color:#24292e"> age </span><span style="color:#d73a49">+</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#032f62">'}'</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">   }</span></span>
<span class="line"><span style="color:#24292e">}</span></span></code></pre></div><p><strong>运行结果</strong></p><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8">thread1 stringThreadLocal second</span></span>
<span class="line"><span style="color:#e1e4e8">thread2 stringThreadLocal second</span></span>
<span class="line"><span style="color:#e1e4e8">User{name</span><span style="color:#f97583">=</span><span style="color:#9ecbff">'Nyima'</span><span style="color:#e1e4e8">, age</span><span style="color:#f97583">=</span><span style="color:#79b8ff">20</span><span style="color:#e1e4e8">}</span></span>
<span class="line"><span style="color:#e1e4e8">User{name</span><span style="color:#f97583">=</span><span style="color:#9ecbff">'Hulu'</span><span style="color:#e1e4e8">, age</span><span style="color:#f97583">=</span><span style="color:#79b8ff">20</span><span style="color:#e1e4e8">}</span></span>
<span class="line"><span style="color:#79b8ff">null</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e">thread1 stringThreadLocal second</span></span>
<span class="line"><span style="color:#24292e">thread2 stringThreadLocal second</span></span>
<span class="line"><span style="color:#24292e">User{name</span><span style="color:#d73a49">=</span><span style="color:#032f62">'Nyima'</span><span style="color:#24292e">, age</span><span style="color:#d73a49">=</span><span style="color:#005cc5">20</span><span style="color:#24292e">}</span></span>
<span class="line"><span style="color:#24292e">User{name</span><span style="color:#d73a49">=</span><span style="color:#032f62">'Hulu'</span><span style="color:#24292e">, age</span><span style="color:#d73a49">=</span><span style="color:#005cc5">20</span><span style="color:#24292e">}</span></span>
<span class="line"><span style="color:#005cc5">null</span></span></code></pre></div><p>从运行结果可以看出</p><ul><li>每个线程中的ThreadLocal变量是每个线程私有的，而不是共享的<ul><li>从线程1和线程2的打印结果可以看出</li></ul></li><li>ThreadLocal其实就相当于其泛型类型的一个变量，只不过是每个线程私有的<ul><li>stringThreadLocal被赋值了两次，保存的是最后一次赋值的结果</li></ul></li><li>ThreadLocal可以进行以下几个操作<ul><li>set 设置值</li><li>get 取出值</li><li>remove 移除值</li></ul></li></ul><h4 id="原理" tabindex="-1">原理 <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20intermediate%20level#原理" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h4><h5 id="thread中的threadlocals" tabindex="-1">Thread中的threadLocals <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20intermediate%20level#thread中的threadlocals" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h5><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">class</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Thread</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">implements</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Runnable</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8"> ...</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8"> ThreadLocal.ThreadLocalMap threadLocals </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8"> </span><span style="color:#6a737d">// 放在后面说</span></span>
<span class="line"><span style="color:#e1e4e8"> ThreadLocal.ThreadLocalMap inheritableThreadLocals </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8"> ...</span></span>
<span class="line"><span style="color:#e1e4e8">}</span></span>
<span class="line"><span style="color:#f97583">static</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">class</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">ThreadLocalMap</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">static</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">class</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Entry</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">extends</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">WeakReference</span><span style="color:#e1e4e8">&lt;ThreadLocal&lt;</span><span style="color:#f97583">?</span><span style="color:#e1e4e8">&gt;&gt; {</span></span>
<span class="line"><span style="color:#6a737d">        /** The value associated with this ThreadLocal. */</span></span>
<span class="line"><span style="color:#e1e4e8">        Object value;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#b392f0">Entry</span><span style="color:#e1e4e8">(ThreadLocal&lt;</span><span style="color:#f97583">?</span><span style="color:#e1e4e8">&gt; </span><span style="color:#ffab70">k</span><span style="color:#e1e4e8">, Object </span><span style="color:#ffab70">v</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#79b8ff">super</span><span style="color:#e1e4e8">(k);</span></span>
<span class="line"><span style="color:#e1e4e8">            value </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> v;</span></span>
<span class="line"><span style="color:#e1e4e8">        }</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">class</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Thread</span><span style="color:#24292e"> </span><span style="color:#d73a49">implements</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Runnable</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e"> ...</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e"> ThreadLocal.ThreadLocalMap threadLocals </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#005cc5">null</span><span style="color:#24292e">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e"> </span><span style="color:#6a737d">// 放在后面说</span></span>
<span class="line"><span style="color:#24292e"> ThreadLocal.ThreadLocalMap inheritableThreadLocals </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#005cc5">null</span><span style="color:#24292e">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e"> ...</span></span>
<span class="line"><span style="color:#24292e">}</span></span>
<span class="line"><span style="color:#d73a49">static</span><span style="color:#24292e"> </span><span style="color:#d73a49">class</span><span style="color:#24292e"> </span><span style="color:#6f42c1">ThreadLocalMap</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">static</span><span style="color:#24292e"> </span><span style="color:#d73a49">class</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Entry</span><span style="color:#24292e"> </span><span style="color:#d73a49">extends</span><span style="color:#24292e"> </span><span style="color:#6f42c1">WeakReference</span><span style="color:#24292e">&lt;ThreadLocal&lt;</span><span style="color:#d73a49">?</span><span style="color:#24292e">&gt;&gt; {</span></span>
<span class="line"><span style="color:#6a737d">        /** The value associated with this ThreadLocal. */</span></span>
<span class="line"><span style="color:#24292e">        Object value;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6f42c1">Entry</span><span style="color:#24292e">(ThreadLocal&lt;</span><span style="color:#d73a49">?</span><span style="color:#24292e">&gt; </span><span style="color:#e36209">k</span><span style="color:#24292e">, Object </span><span style="color:#e36209">v</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#005cc5">super</span><span style="color:#24292e">(k);</span></span>
<span class="line"><span style="color:#24292e">            value </span><span style="color:#d73a49">=</span><span style="color:#24292e"> v;</span></span>
<span class="line"><span style="color:#24292e">        }</span></span>
<span class="line"><span style="color:#24292e">    }</span></span></code></pre></div><p>可以看出Thread类中有一个threadLocals和一个inheritableThreadLocals，它们都是ThreadLocalMap类型的变量，而ThreadLocalMap是一个定制化的Hashmap。在默认情况下，每个线程中的这两个变量都为null。此处先讨论threadLocals，inheritableThreadLocals放在后面讨论</p><h5 id="threadlocal中的方法" tabindex="-1"><strong>ThreadLocal中的方法</strong> <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20intermediate%20level#threadlocal中的方法" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h5><p><strong>set方法</strong></p><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">void</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">set</span><span style="color:#e1e4e8">(T value) {</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">// 获取当前线程</span></span>
<span class="line"><span style="color:#e1e4e8">    Thread t </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> Thread.</span><span style="color:#b392f0">currentThread</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">    </span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">// 获得ThreadLocalMap对象 </span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">// 这里的get会返回Thread类中的threadLocals</span></span>
<span class="line"><span style="color:#e1e4e8">    ThreadLocalMap map </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">getMap</span><span style="color:#e1e4e8">(t);</span></span>
<span class="line"><span style="color:#e1e4e8">    </span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">// 判断map是否已经创建，没创建就创建并放入值，创建了就直接放入</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (map </span><span style="color:#f97583">!=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8">)</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#6a737d">// ThreadLocal自生的引用作为key，传入的值作为value</span></span>
<span class="line"><span style="color:#e1e4e8">        map.</span><span style="color:#b392f0">set</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">this</span><span style="color:#e1e4e8">, value);</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">else</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#b392f0">createMap</span><span style="color:#e1e4e8">(t, value);</span></span>
<span class="line"><span style="color:#e1e4e8">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">void</span><span style="color:#24292e"> </span><span style="color:#6f42c1">set</span><span style="color:#24292e">(T value) {</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">// 获取当前线程</span></span>
<span class="line"><span style="color:#24292e">    Thread t </span><span style="color:#d73a49">=</span><span style="color:#24292e"> Thread.</span><span style="color:#6f42c1">currentThread</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">    </span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">// 获得ThreadLocalMap对象 </span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">// 这里的get会返回Thread类中的threadLocals</span></span>
<span class="line"><span style="color:#24292e">    ThreadLocalMap map </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#6f42c1">getMap</span><span style="color:#24292e">(t);</span></span>
<span class="line"><span style="color:#24292e">    </span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">// 判断map是否已经创建，没创建就创建并放入值，创建了就直接放入</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (map </span><span style="color:#d73a49">!=</span><span style="color:#24292e"> </span><span style="color:#005cc5">null</span><span style="color:#24292e">)</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6a737d">// ThreadLocal自生的引用作为key，传入的值作为value</span></span>
<span class="line"><span style="color:#24292e">        map.</span><span style="color:#6f42c1">set</span><span style="color:#24292e">(</span><span style="color:#005cc5">this</span><span style="color:#24292e">, value);</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">else</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6f42c1">createMap</span><span style="color:#24292e">(t, value);</span></span>
<span class="line"><span style="color:#24292e">}</span></span></code></pre></div><p><strong>如果未创建</strong></p><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#f97583">void</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">createMap</span><span style="color:#e1e4e8">(Thread t, T firstValue) {</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">// 创建的同时设置想放入的值</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">// hreadLocal自生的引用作为key，传入的值作为value</span></span>
<span class="line"><span style="color:#e1e4e8">    t.threadLocals </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">ThreadLocalMap</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">this</span><span style="color:#e1e4e8">, firstValue);</span></span>
<span class="line"><span style="color:#e1e4e8">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#d73a49">void</span><span style="color:#24292e"> </span><span style="color:#6f42c1">createMap</span><span style="color:#24292e">(Thread t, T firstValue) {</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">// 创建的同时设置想放入的值</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">// hreadLocal自生的引用作为key，传入的值作为value</span></span>
<span class="line"><span style="color:#24292e">    t.threadLocals </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">ThreadLocalMap</span><span style="color:#24292e">(</span><span style="color:#005cc5">this</span><span style="color:#24292e">, firstValue);</span></span>
<span class="line"><span style="color:#24292e">}</span></span></code></pre></div><p><strong>get方法</strong></p><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#f97583">public</span><span style="color:#e1e4e8"> T </span><span style="color:#b392f0">get</span><span style="color:#e1e4e8">() {</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">// 获取当前线程</span></span>
<span class="line"><span style="color:#e1e4e8">    Thread t </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> Thread.</span><span style="color:#b392f0">currentThread</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">	</span><span style="color:#6a737d">// 获取当前线程的threadLocals变量</span></span>
<span class="line"><span style="color:#e1e4e8">    ThreadLocalMap map </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">getMap</span><span style="color:#e1e4e8">(t);</span></span>
<span class="line"><span style="color:#e1e4e8">    </span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">// 判断threadLocals是否被初始化了</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (map </span><span style="color:#f97583">!=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#6a737d">// 已经初始化则直接返回</span></span>
<span class="line"><span style="color:#e1e4e8">        ThreadLocalMap.Entry e </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> map.</span><span style="color:#b392f0">getEntry</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">this</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (e </span><span style="color:#f97583">!=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">            @</span><span style="color:#f97583">SuppressWarnings</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"unchecked"</span><span style="color:#e1e4e8">)</span></span>
<span class="line"><span style="color:#e1e4e8">            T result </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> (T)e.value;</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> result;</span></span>
<span class="line"><span style="color:#e1e4e8">        }</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">// 否则就创建threadLocals</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">setInitialValue</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">}</span></span>
<span class="line"><span style="color:#f97583">private</span><span style="color:#e1e4e8"> T </span><span style="color:#b392f0">setInitialValue</span><span style="color:#e1e4e8">() {</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">// 这个方法返回是null</span></span>
<span class="line"><span style="color:#e1e4e8">    T value </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">initialValue</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">    Thread t </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> Thread.</span><span style="color:#b392f0">currentThread</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">    ThreadLocalMap map </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">getMap</span><span style="color:#e1e4e8">(t);</span></span>
<span class="line"><span style="color:#e1e4e8">    </span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">// 无论map创建与否，最终value的值都为null</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (map </span><span style="color:#f97583">!=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8">)</span></span>
<span class="line"><span style="color:#e1e4e8">        map.</span><span style="color:#b392f0">set</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">this</span><span style="color:#e1e4e8">, value);</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">else</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#b392f0">createMap</span><span style="color:#e1e4e8">(t, value);</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> value;</span></span>
<span class="line"><span style="color:#e1e4e8">}</span></span>
<span class="line"><span style="color:#f97583">protected</span><span style="color:#e1e4e8"> T </span><span style="color:#b392f0">initialValue</span><span style="color:#e1e4e8">() {</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#d73a49">public</span><span style="color:#24292e"> T </span><span style="color:#6f42c1">get</span><span style="color:#24292e">() {</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">// 获取当前线程</span></span>
<span class="line"><span style="color:#24292e">    Thread t </span><span style="color:#d73a49">=</span><span style="color:#24292e"> Thread.</span><span style="color:#6f42c1">currentThread</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">	</span><span style="color:#6a737d">// 获取当前线程的threadLocals变量</span></span>
<span class="line"><span style="color:#24292e">    ThreadLocalMap map </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#6f42c1">getMap</span><span style="color:#24292e">(t);</span></span>
<span class="line"><span style="color:#24292e">    </span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">// 判断threadLocals是否被初始化了</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (map </span><span style="color:#d73a49">!=</span><span style="color:#24292e"> </span><span style="color:#005cc5">null</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6a737d">// 已经初始化则直接返回</span></span>
<span class="line"><span style="color:#24292e">        ThreadLocalMap.Entry e </span><span style="color:#d73a49">=</span><span style="color:#24292e"> map.</span><span style="color:#6f42c1">getEntry</span><span style="color:#24292e">(</span><span style="color:#005cc5">this</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (e </span><span style="color:#d73a49">!=</span><span style="color:#24292e"> </span><span style="color:#005cc5">null</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">            @</span><span style="color:#d73a49">SuppressWarnings</span><span style="color:#24292e">(</span><span style="color:#032f62">"unchecked"</span><span style="color:#24292e">)</span></span>
<span class="line"><span style="color:#24292e">            T result </span><span style="color:#d73a49">=</span><span style="color:#24292e"> (T)e.value;</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">return</span><span style="color:#24292e"> result;</span></span>
<span class="line"><span style="color:#24292e">        }</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">// 否则就创建threadLocals</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">return</span><span style="color:#24292e"> </span><span style="color:#6f42c1">setInitialValue</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">}</span></span>
<span class="line"><span style="color:#d73a49">private</span><span style="color:#24292e"> T </span><span style="color:#6f42c1">setInitialValue</span><span style="color:#24292e">() {</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">// 这个方法返回是null</span></span>
<span class="line"><span style="color:#24292e">    T value </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#6f42c1">initialValue</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">    Thread t </span><span style="color:#d73a49">=</span><span style="color:#24292e"> Thread.</span><span style="color:#6f42c1">currentThread</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">    ThreadLocalMap map </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#6f42c1">getMap</span><span style="color:#24292e">(t);</span></span>
<span class="line"><span style="color:#24292e">    </span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">// 无论map创建与否，最终value的值都为null</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (map </span><span style="color:#d73a49">!=</span><span style="color:#24292e"> </span><span style="color:#005cc5">null</span><span style="color:#24292e">)</span></span>
<span class="line"><span style="color:#24292e">        map.</span><span style="color:#6f42c1">set</span><span style="color:#24292e">(</span><span style="color:#005cc5">this</span><span style="color:#24292e">, value);</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">else</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6f42c1">createMap</span><span style="color:#24292e">(t, value);</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">return</span><span style="color:#24292e"> value;</span></span>
<span class="line"><span style="color:#24292e">}</span></span>
<span class="line"><span style="color:#d73a49">protected</span><span style="color:#24292e"> T </span><span style="color:#6f42c1">initialValue</span><span style="color:#24292e">() {</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">return</span><span style="color:#24292e"> </span><span style="color:#005cc5">null</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">}</span></span></code></pre></div><p><strong>remove方法</strong></p><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">void</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">remove</span><span style="color:#e1e4e8">() {</span></span>
<span class="line"><span style="color:#e1e4e8">    ThreadLocalMap m </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">getMap</span><span style="color:#e1e4e8">(Thread.</span><span style="color:#b392f0">currentThread</span><span style="color:#e1e4e8">());</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (m </span><span style="color:#f97583">!=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8">)</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#6a737d">// 如果threadLocals已经被初始化，则移除</span></span>
<span class="line"><span style="color:#e1e4e8">        m.</span><span style="color:#b392f0">remove</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">this</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">void</span><span style="color:#24292e"> </span><span style="color:#6f42c1">remove</span><span style="color:#24292e">() {</span></span>
<span class="line"><span style="color:#24292e">    ThreadLocalMap m </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#6f42c1">getMap</span><span style="color:#24292e">(Thread.</span><span style="color:#6f42c1">currentThread</span><span style="color:#24292e">());</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (m </span><span style="color:#d73a49">!=</span><span style="color:#24292e"> </span><span style="color:#005cc5">null</span><span style="color:#24292e">)</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6a737d">// 如果threadLocals已经被初始化，则移除</span></span>
<span class="line"><span style="color:#24292e">        m.</span><span style="color:#6f42c1">remove</span><span style="color:#24292e">(</span><span style="color:#005cc5">this</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">}</span></span></code></pre></div><h5 id="总结" tabindex="-1"><strong>总结</strong> <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20intermediate%20level#总结" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h5><p>在每个线程内部都有一个名为threadLocals的成员变量，该变量的类型为HashMap，其中<strong>key为我们定义的ThreadLocal变量的this引用，value则为我们使用set方法设置的值</strong>。每个线程的本地变量存放在线程自己的内存变量threadLocals中</p><p>只有当前线程<strong>第一次调用ThreadLocal的set或者get方法时才会创建threadLocals</strong>（inheritableThreadLocals也是一样）。其实每个线程的本地变量不是存放在ThreadLocal实例里面，而是存放在调用线程的threadLocals变量里面</p><h3 id="_15、inheritablethreadlocal" tabindex="-1">15、InheritableThreadLocal <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20intermediate%20level#_15、inheritablethreadlocal" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h3><h4 id="简介-1" tabindex="-1">简介 <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20intermediate%20level#简介-1" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h4><p>从ThreadLocal的源码可以看出，无论是set、get、还是remove，都是相对于当前线程操作的</p><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8">Thread.</span><span style="color:#b392f0">currentThread</span><span style="color:#e1e4e8">()</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e">Thread.</span><span style="color:#6f42c1">currentThread</span><span style="color:#24292e">()</span></span></code></pre></div><p>所以ThreadLocal无法从父线程传向子线程，所以InheritableThreadLocal出现了，<strong>它能够让父线程中ThreadLocal的值传给子线程。</strong></p><p>也就是从main所在的线程，传给thread1或thread2</p><h4 id="使用-1" tabindex="-1">使用 <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20intermediate%20level#使用-1" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h4><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">class</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Demo1</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">   </span><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">static</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">void</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">main</span><span style="color:#e1e4e8">(</span><span style="color:#f97583">String</span><span style="color:#e1e4e8">[] </span><span style="color:#ffab70">args</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">      ThreadLocal&lt;</span><span style="color:#f97583">String</span><span style="color:#e1e4e8">&gt; stringThreadLocal </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> ThreadLocal&lt;&gt;();</span></span>
<span class="line"><span style="color:#e1e4e8">      InheritableThreadLocal&lt;</span><span style="color:#f97583">String</span><span style="color:#e1e4e8">&gt; stringInheritable </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> InheritableThreadLocal&lt;&gt;();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">      </span><span style="color:#6a737d">// 主线程赋对上面两个变量进行赋值</span></span>
<span class="line"><span style="color:#e1e4e8">      stringThreadLocal.</span><span style="color:#b392f0">set</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"this is threadLocal"</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">      stringInheritable.</span><span style="color:#b392f0">set</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"this is inheritableThreadLocal"</span><span style="color:#e1e4e8">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">      </span><span style="color:#6a737d">// 创建线程</span></span>
<span class="line"><span style="color:#e1e4e8">      Thread thread1 </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Thread</span><span style="color:#e1e4e8">(()</span><span style="color:#f97583">-&gt;</span><span style="color:#e1e4e8">{</span></span>
<span class="line"><span style="color:#e1e4e8">         </span><span style="color:#6a737d">// 获得ThreadLocal中存放的值</span></span>
<span class="line"><span style="color:#e1e4e8">         System.out.</span><span style="color:#b392f0">println</span><span style="color:#e1e4e8">(stringThreadLocal.</span><span style="color:#b392f0">get</span><span style="color:#e1e4e8">());</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">         </span><span style="color:#6a737d">// 获得InheritableThreadLocal存放的值</span></span>
<span class="line"><span style="color:#e1e4e8">         System.out.</span><span style="color:#b392f0">println</span><span style="color:#e1e4e8">(stringInheritable.</span><span style="color:#b392f0">get</span><span style="color:#e1e4e8">());</span></span>
<span class="line"><span style="color:#e1e4e8">      });</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">      thread1.</span><span style="color:#b392f0">start</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">   }</span></span>
<span class="line"><span style="color:#e1e4e8">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">class</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Demo1</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">   </span><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">static</span><span style="color:#24292e"> </span><span style="color:#d73a49">void</span><span style="color:#24292e"> </span><span style="color:#6f42c1">main</span><span style="color:#24292e">(</span><span style="color:#d73a49">String</span><span style="color:#24292e">[] </span><span style="color:#e36209">args</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">      ThreadLocal&lt;</span><span style="color:#d73a49">String</span><span style="color:#24292e">&gt; stringThreadLocal </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> ThreadLocal&lt;&gt;();</span></span>
<span class="line"><span style="color:#24292e">      InheritableThreadLocal&lt;</span><span style="color:#d73a49">String</span><span style="color:#24292e">&gt; stringInheritable </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> InheritableThreadLocal&lt;&gt;();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">      </span><span style="color:#6a737d">// 主线程赋对上面两个变量进行赋值</span></span>
<span class="line"><span style="color:#24292e">      stringThreadLocal.</span><span style="color:#6f42c1">set</span><span style="color:#24292e">(</span><span style="color:#032f62">"this is threadLocal"</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">      stringInheritable.</span><span style="color:#6f42c1">set</span><span style="color:#24292e">(</span><span style="color:#032f62">"this is inheritableThreadLocal"</span><span style="color:#24292e">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">      </span><span style="color:#6a737d">// 创建线程</span></span>
<span class="line"><span style="color:#24292e">      Thread thread1 </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Thread</span><span style="color:#24292e">(()</span><span style="color:#d73a49">-&gt;</span><span style="color:#24292e">{</span></span>
<span class="line"><span style="color:#24292e">         </span><span style="color:#6a737d">// 获得ThreadLocal中存放的值</span></span>
<span class="line"><span style="color:#24292e">         System.out.</span><span style="color:#6f42c1">println</span><span style="color:#24292e">(stringThreadLocal.</span><span style="color:#6f42c1">get</span><span style="color:#24292e">());</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">         </span><span style="color:#6a737d">// 获得InheritableThreadLocal存放的值</span></span>
<span class="line"><span style="color:#24292e">         System.out.</span><span style="color:#6f42c1">println</span><span style="color:#24292e">(stringInheritable.</span><span style="color:#6f42c1">get</span><span style="color:#24292e">());</span></span>
<span class="line"><span style="color:#24292e">      });</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">      thread1.</span><span style="color:#6f42c1">start</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">   }</span></span>
<span class="line"><span style="color:#24292e">}</span></span></code></pre></div><p><strong>运行结果</strong></p><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#79b8ff">null</span></span>
<span class="line"><span style="color:#79b8ff">this</span><span style="color:#e1e4e8"> is inheritableThreadLocal</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#005cc5">null</span></span>
<span class="line"><span style="color:#005cc5">this</span><span style="color:#24292e"> is inheritableThreadLocal</span></span></code></pre></div><p>可以看出InheritableThreadLocal的值成功从主线程传入了子线程，而ThreadLocal则没有</p><h4 id="原理-1" tabindex="-1">原理 <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20intermediate%20level#原理-1" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h4><h5 id="inheritablethreadlocal" tabindex="-1">InheritableThreadLocal <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20intermediate%20level#inheritablethreadlocal" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h5><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">class</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">InheritableThreadLocal</span><span style="color:#e1e4e8">&lt;</span><span style="color:#f97583">T</span><span style="color:#e1e4e8">&gt; </span><span style="color:#f97583">extends</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">ThreadLocal</span><span style="color:#e1e4e8">&lt;</span><span style="color:#f97583">T</span><span style="color:#e1e4e8">&gt; {</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">// 传入父线程中的一个值，然后直接返回</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">protected</span><span style="color:#e1e4e8"> T </span><span style="color:#b392f0">childValue</span><span style="color:#e1e4e8">(T </span><span style="color:#ffab70">parentValue</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> parentValue;</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">  	</span><span style="color:#6a737d">// 返回传入线程的inheritableThreadLocals</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">// Thread中有一个inheritableThreadLocals变量</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">// ThreadLocal.ThreadLocalMap inheritableThreadLocals = null;</span></span>
<span class="line"><span style="color:#e1e4e8">    ThreadLocalMap </span><span style="color:#b392f0">getMap</span><span style="color:#e1e4e8">(Thread </span><span style="color:#ffab70">t</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">       </span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> t.inheritableThreadLocals;</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8"> 	</span><span style="color:#6a737d">// 创建一个inheritableThreadLocals</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">void</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">createMap</span><span style="color:#e1e4e8">(Thread </span><span style="color:#ffab70">t</span><span style="color:#e1e4e8">, T </span><span style="color:#ffab70">firstValue</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">        t.inheritableThreadLocals </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">ThreadLocalMap</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">this</span><span style="color:#e1e4e8">, firstValue);</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"><span style="color:#e1e4e8">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">class</span><span style="color:#24292e"> </span><span style="color:#6f42c1">InheritableThreadLocal</span><span style="color:#24292e">&lt;</span><span style="color:#d73a49">T</span><span style="color:#24292e">&gt; </span><span style="color:#d73a49">extends</span><span style="color:#24292e"> </span><span style="color:#6f42c1">ThreadLocal</span><span style="color:#24292e">&lt;</span><span style="color:#d73a49">T</span><span style="color:#24292e">&gt; {</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">// 传入父线程中的一个值，然后直接返回</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">protected</span><span style="color:#24292e"> T </span><span style="color:#6f42c1">childValue</span><span style="color:#24292e">(T </span><span style="color:#e36209">parentValue</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">return</span><span style="color:#24292e"> parentValue;</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">  	</span><span style="color:#6a737d">// 返回传入线程的inheritableThreadLocals</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">// Thread中有一个inheritableThreadLocals变量</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">// ThreadLocal.ThreadLocalMap inheritableThreadLocals = null;</span></span>
<span class="line"><span style="color:#24292e">    ThreadLocalMap </span><span style="color:#6f42c1">getMap</span><span style="color:#24292e">(Thread </span><span style="color:#e36209">t</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">       </span><span style="color:#d73a49">return</span><span style="color:#24292e"> t.inheritableThreadLocals;</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e"> 	</span><span style="color:#6a737d">// 创建一个inheritableThreadLocals</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">void</span><span style="color:#24292e"> </span><span style="color:#6f42c1">createMap</span><span style="color:#24292e">(Thread </span><span style="color:#e36209">t</span><span style="color:#24292e">, T </span><span style="color:#e36209">firstValue</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">        t.inheritableThreadLocals </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">ThreadLocalMap</span><span style="color:#24292e">(</span><span style="color:#005cc5">this</span><span style="color:#24292e">, firstValue);</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"><span style="color:#24292e">}</span></span></code></pre></div><p>由如上代码可知，InheritableThreadLocal继承了ThreadLocal，并重写了三个方法。InheritableThreadLocal重写了<strong>createMap方法</strong>，那么现在当第一次调用set方法时，创建的是当前线程的inheritableThreadLocals变量的实例而不再是threadLocals。当调用<strong>getMap方法</strong>获取当前线程内部的map变量时，获取的是inheritableThreadLocals而不再是threadLocals</p><h5 id="childvalue-t-parentvalue-方法的调用" tabindex="-1">childValue(T parentValue)方法的调用 <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20intermediate%20level#childvalue-t-parentvalue-方法的调用" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h5><p>在主函数运行时，会调用Thread的默认构造函数（<strong>创建主线程</strong>，也就是父线程），所以我们先看看Thread的默认构造函数</p><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Thread</span><span style="color:#e1e4e8">() {</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#b392f0">init</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8">, </span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8">, </span><span style="color:#9ecbff">"Thread-"</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">+</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">nextThreadNum</span><span style="color:#e1e4e8">(), </span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">}</span></span>
<span class="line"><span style="color:#f97583">private</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">void</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">init</span><span style="color:#e1e4e8">(ThreadGroup g, Runnable target, String name,</span></span>
<span class="line"><span style="color:#e1e4e8">                  </span><span style="color:#f97583">long</span><span style="color:#e1e4e8"> stackSize, AccessControlContext acc,</span></span>
<span class="line"><span style="color:#e1e4e8">                  </span><span style="color:#f97583">boolean</span><span style="color:#e1e4e8"> inheritThreadLocals) {</span></span>
<span class="line"><span style="color:#e1e4e8">   	...</span></span>
<span class="line"><span style="color:#e1e4e8">        </span></span>
<span class="line"><span style="color:#e1e4e8">	</span><span style="color:#6a737d">// 获得当前线程的，在这里是主线程</span></span>
<span class="line"><span style="color:#e1e4e8">    Thread parent </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">currentThread</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">   </span></span>
<span class="line"><span style="color:#e1e4e8">    ...</span></span>
<span class="line"><span style="color:#e1e4e8">    </span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">// 如果父线程的inheritableThreadLocals存在</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">// 我们在主线程中调用set和get时，会创建inheritableThreadLocals</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (inheritThreadLocals </span><span style="color:#f97583">&amp;&amp;</span><span style="color:#e1e4e8"> parent.inheritableThreadLocals </span><span style="color:#f97583">!=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8">)</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#6a737d">// 设置子线程的inheritableThreadLocals</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#79b8ff">this</span><span style="color:#e1e4e8">.inheritableThreadLocals </span><span style="color:#f97583">=</span></span>
<span class="line"><span style="color:#e1e4e8">            ThreadLocal.</span><span style="color:#b392f0">createInheritedMap</span><span style="color:#e1e4e8">(parent.inheritableThreadLocals);</span></span>
<span class="line"><span style="color:#e1e4e8">    </span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">/* Stash the specified stack size in case the VM cares */</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#79b8ff">this</span><span style="color:#e1e4e8">.stackSize </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> stackSize;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">/* Set thread ID */</span></span>
<span class="line"><span style="color:#e1e4e8">    tid </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">nextThreadID</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">}</span></span>
<span class="line"><span style="color:#f97583">static</span><span style="color:#e1e4e8"> ThreadLocalMap </span><span style="color:#b392f0">createInheritedMap</span><span style="color:#e1e4e8">(ThreadLocalMap parentMap) {</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">ThreadLocalMap</span><span style="color:#e1e4e8">(parentMap);</span></span>
<span class="line"><span style="color:#e1e4e8">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Thread</span><span style="color:#24292e">() {</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6f42c1">init</span><span style="color:#24292e">(</span><span style="color:#005cc5">null</span><span style="color:#24292e">, </span><span style="color:#005cc5">null</span><span style="color:#24292e">, </span><span style="color:#032f62">"Thread-"</span><span style="color:#24292e"> </span><span style="color:#d73a49">+</span><span style="color:#24292e"> </span><span style="color:#6f42c1">nextThreadNum</span><span style="color:#24292e">(), </span><span style="color:#005cc5">0</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">}</span></span>
<span class="line"><span style="color:#d73a49">private</span><span style="color:#24292e"> </span><span style="color:#d73a49">void</span><span style="color:#24292e"> </span><span style="color:#6f42c1">init</span><span style="color:#24292e">(ThreadGroup g, Runnable target, String name,</span></span>
<span class="line"><span style="color:#24292e">                  </span><span style="color:#d73a49">long</span><span style="color:#24292e"> stackSize, AccessControlContext acc,</span></span>
<span class="line"><span style="color:#24292e">                  </span><span style="color:#d73a49">boolean</span><span style="color:#24292e"> inheritThreadLocals) {</span></span>
<span class="line"><span style="color:#24292e">   	...</span></span>
<span class="line"><span style="color:#24292e">        </span></span>
<span class="line"><span style="color:#24292e">	</span><span style="color:#6a737d">// 获得当前线程的，在这里是主线程</span></span>
<span class="line"><span style="color:#24292e">    Thread parent </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#6f42c1">currentThread</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">   </span></span>
<span class="line"><span style="color:#24292e">    ...</span></span>
<span class="line"><span style="color:#24292e">    </span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">// 如果父线程的inheritableThreadLocals存在</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">// 我们在主线程中调用set和get时，会创建inheritableThreadLocals</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (inheritThreadLocals </span><span style="color:#d73a49">&amp;&amp;</span><span style="color:#24292e"> parent.inheritableThreadLocals </span><span style="color:#d73a49">!=</span><span style="color:#24292e"> </span><span style="color:#005cc5">null</span><span style="color:#24292e">)</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6a737d">// 设置子线程的inheritableThreadLocals</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#005cc5">this</span><span style="color:#24292e">.inheritableThreadLocals </span><span style="color:#d73a49">=</span></span>
<span class="line"><span style="color:#24292e">            ThreadLocal.</span><span style="color:#6f42c1">createInheritedMap</span><span style="color:#24292e">(parent.inheritableThreadLocals);</span></span>
<span class="line"><span style="color:#24292e">    </span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">/* Stash the specified stack size in case the VM cares */</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#005cc5">this</span><span style="color:#24292e">.stackSize </span><span style="color:#d73a49">=</span><span style="color:#24292e"> stackSize;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">/* Set thread ID */</span></span>
<span class="line"><span style="color:#24292e">    tid </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#6f42c1">nextThreadID</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">}</span></span>
<span class="line"><span style="color:#d73a49">static</span><span style="color:#24292e"> ThreadLocalMap </span><span style="color:#6f42c1">createInheritedMap</span><span style="color:#24292e">(ThreadLocalMap parentMap) {</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">return</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">ThreadLocalMap</span><span style="color:#24292e">(parentMap);</span></span>
<span class="line"><span style="color:#24292e">}</span></span></code></pre></div><p>在createInheritedMap内部使用父线程的inheritableThreadLocals变量作为构造函数创建了一个新的ThreadLocalMap变量，然后赋值给了子线程的inheritableThreadLocals变量</p><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#f97583">private</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">ThreadLocalMap</span><span style="color:#e1e4e8">(ThreadLocalMap parentMap) {</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">Entry</span><span style="color:#e1e4e8">[] parentTable </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> parentMap.table;</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> len </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> parentTable.length;</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#b392f0">setThreshold</span><span style="color:#e1e4e8">(len);</span></span>
<span class="line"><span style="color:#e1e4e8">    table </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">Entry</span><span style="color:#e1e4e8">[len];</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">for</span><span style="color:#e1e4e8"> (</span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> j </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8">; j </span><span style="color:#f97583">&lt;</span><span style="color:#e1e4e8"> len; j</span><span style="color:#f97583">++</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">        Entry e </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> parentTable[j];</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (e </span><span style="color:#f97583">!=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">            @</span><span style="color:#f97583">SuppressWarnings</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"unchecked"</span><span style="color:#e1e4e8">)</span></span>
<span class="line"><span style="color:#e1e4e8">            ThreadLocal&lt;</span><span style="color:#f97583">Object</span><span style="color:#e1e4e8">&gt; key </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> (ThreadLocal</span><span style="color:#f97583">&lt;</span><span style="color:#e1e4e8">Object</span><span style="color:#f97583">&gt;</span><span style="color:#e1e4e8">) e.</span><span style="color:#b392f0">get</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (key </span><span style="color:#f97583">!=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#6a737d">// 这里调用了 childValue 方法</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#6a737d">// 该方法会返回parent的值</span></span>
<span class="line"><span style="color:#e1e4e8">                Object value </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> key.</span><span style="color:#b392f0">childValue</span><span style="color:#e1e4e8">(e.value);</span></span>
<span class="line"><span style="color:#e1e4e8">                </span></span>
<span class="line"><span style="color:#e1e4e8">                Entry c </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Entry</span><span style="color:#e1e4e8">(key, value);</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> h </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> key.threadLocalHashCode </span><span style="color:#f97583">&amp;</span><span style="color:#e1e4e8"> (len </span><span style="color:#f97583">-</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">1</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#f97583">while</span><span style="color:#e1e4e8"> (table[h] </span><span style="color:#f97583">!=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8">)</span></span>
<span class="line"><span style="color:#e1e4e8">                    h </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">nextIndex</span><span style="color:#e1e4e8">(h, len);</span></span>
<span class="line"><span style="color:#e1e4e8">                table[h] </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> c;</span></span>
<span class="line"><span style="color:#e1e4e8">                size</span><span style="color:#f97583">++</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">            }</span></span>
<span class="line"><span style="color:#e1e4e8">        }</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"><span style="color:#e1e4e8">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#d73a49">private</span><span style="color:#24292e"> </span><span style="color:#6f42c1">ThreadLocalMap</span><span style="color:#24292e">(ThreadLocalMap parentMap) {</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">Entry</span><span style="color:#24292e">[] parentTable </span><span style="color:#d73a49">=</span><span style="color:#24292e"> parentMap.table;</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">int</span><span style="color:#24292e"> len </span><span style="color:#d73a49">=</span><span style="color:#24292e"> parentTable.length;</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6f42c1">setThreshold</span><span style="color:#24292e">(len);</span></span>
<span class="line"><span style="color:#24292e">    table </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#d73a49">Entry</span><span style="color:#24292e">[len];</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">for</span><span style="color:#24292e"> (</span><span style="color:#d73a49">int</span><span style="color:#24292e"> j </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#005cc5">0</span><span style="color:#24292e">; j </span><span style="color:#d73a49">&lt;</span><span style="color:#24292e"> len; j</span><span style="color:#d73a49">++</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">        Entry e </span><span style="color:#d73a49">=</span><span style="color:#24292e"> parentTable[j];</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (e </span><span style="color:#d73a49">!=</span><span style="color:#24292e"> </span><span style="color:#005cc5">null</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">            @</span><span style="color:#d73a49">SuppressWarnings</span><span style="color:#24292e">(</span><span style="color:#032f62">"unchecked"</span><span style="color:#24292e">)</span></span>
<span class="line"><span style="color:#24292e">            ThreadLocal&lt;</span><span style="color:#d73a49">Object</span><span style="color:#24292e">&gt; key </span><span style="color:#d73a49">=</span><span style="color:#24292e"> (ThreadLocal</span><span style="color:#d73a49">&lt;</span><span style="color:#24292e">Object</span><span style="color:#d73a49">&gt;</span><span style="color:#24292e">) e.</span><span style="color:#6f42c1">get</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (key </span><span style="color:#d73a49">!=</span><span style="color:#24292e"> </span><span style="color:#005cc5">null</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#6a737d">// 这里调用了 childValue 方法</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#6a737d">// 该方法会返回parent的值</span></span>
<span class="line"><span style="color:#24292e">                Object value </span><span style="color:#d73a49">=</span><span style="color:#24292e"> key.</span><span style="color:#6f42c1">childValue</span><span style="color:#24292e">(e.value);</span></span>
<span class="line"><span style="color:#24292e">                </span></span>
<span class="line"><span style="color:#24292e">                Entry c </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Entry</span><span style="color:#24292e">(key, value);</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#d73a49">int</span><span style="color:#24292e"> h </span><span style="color:#d73a49">=</span><span style="color:#24292e"> key.threadLocalHashCode </span><span style="color:#d73a49">&amp;</span><span style="color:#24292e"> (len </span><span style="color:#d73a49">-</span><span style="color:#24292e"> </span><span style="color:#005cc5">1</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#d73a49">while</span><span style="color:#24292e"> (table[h] </span><span style="color:#d73a49">!=</span><span style="color:#24292e"> </span><span style="color:#005cc5">null</span><span style="color:#24292e">)</span></span>
<span class="line"><span style="color:#24292e">                    h </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#6f42c1">nextIndex</span><span style="color:#24292e">(h, len);</span></span>
<span class="line"><span style="color:#24292e">                table[h] </span><span style="color:#d73a49">=</span><span style="color:#24292e"> c;</span></span>
<span class="line"><span style="color:#24292e">                size</span><span style="color:#d73a49">++</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">            }</span></span>
<span class="line"><span style="color:#24292e">        }</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"><span style="color:#24292e">}</span></span></code></pre></div><p>在该构造函数内部把父线程的inheritableThreadLocals成员变量的值复制到新的ThreadLocalMap对象中</p><h5 id="总结-1" tabindex="-1">总结 <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20intermediate%20level#总结-1" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h5><p>InheritableThreadLocal类通过重写getMap和createMap，让本地变量保存到了具体线程的inheritableThreadLocals变量里面，那么线程在通过InheritableThreadLocal类实例的set或者get方法设置变量时，就会创建当前线程的inheritableThreadLocals变量。</p><p><strong>当父线程创建子线程时，构造函数会把父线程中inheritableThreadLocals变量里面的本地变量复制一份保存到子线程的inheritableThreadLocals变量里面。</strong></p><h2 id="四、共享模型之内存" tabindex="-1">四、共享模型之内存 <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20intermediate%20level#四、共享模型之内存" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h2><h3 id="_1、java内存模型-jmm" tabindex="-1">1、JAVA内存模型（JMM） <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20intermediate%20level#_1、java内存模型-jmm" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h3><p>JMM 即 Java Memory Model，它定义了**主存（共享内存）、工作内存（线程私有）**抽象概念，底层对应着 CPU 寄存器、缓存、硬件内存、 CPU 指令优化等。</p><p><strong>JMM体现在以下几个方面</strong></p><ul><li>原子性 - 保证指令不会受到线程上下文切换的影响</li><li>可见性 - 保证指令不会受 cpu 缓存的影响</li><li>有序性 - 保证指令不会受 cpu 指令并行优化的影响</li></ul><h3 id="_2、可见性" tabindex="-1">2、可见性 <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20intermediate%20level#_2、可见性" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h3><h4 id="引例" tabindex="-1">引例 <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20intermediate%20level#引例" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h4><p><strong>退出不了的循环</strong></p><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#f97583">static</span><span style="color:#e1e4e8"> Boolean run </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">true</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">	</span><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">static</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">void</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">main</span><span style="color:#e1e4e8">(</span><span style="color:#f97583">String</span><span style="color:#e1e4e8">[] args) throws InterruptedException {</span></span>
<span class="line"><span style="color:#e1e4e8">		</span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Thread</span><span style="color:#e1e4e8">(()</span><span style="color:#f97583">-&gt;</span><span style="color:#e1e4e8">{</span></span>
<span class="line"><span style="color:#e1e4e8">			</span><span style="color:#f97583">while</span><span style="color:#e1e4e8"> (run) {</span></span>
<span class="line"><span style="color:#e1e4e8">				</span><span style="color:#6a737d">//如果run为真，则一直执行</span></span>
<span class="line"><span style="color:#e1e4e8">			}</span></span>
<span class="line"><span style="color:#e1e4e8">		}).</span><span style="color:#b392f0">start</span><span style="color:#e1e4e8">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">		Thread.</span><span style="color:#b392f0">sleep</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">1000</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">		System.out.</span><span style="color:#b392f0">println</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"改变run的值为false"</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">		run </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">false</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">	}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#d73a49">static</span><span style="color:#24292e"> Boolean run </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#005cc5">true</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">	</span><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">static</span><span style="color:#24292e"> </span><span style="color:#d73a49">void</span><span style="color:#24292e"> </span><span style="color:#6f42c1">main</span><span style="color:#24292e">(</span><span style="color:#d73a49">String</span><span style="color:#24292e">[] args) throws InterruptedException {</span></span>
<span class="line"><span style="color:#24292e">		</span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Thread</span><span style="color:#24292e">(()</span><span style="color:#d73a49">-&gt;</span><span style="color:#24292e">{</span></span>
<span class="line"><span style="color:#24292e">			</span><span style="color:#d73a49">while</span><span style="color:#24292e"> (run) {</span></span>
<span class="line"><span style="color:#24292e">				</span><span style="color:#6a737d">//如果run为真，则一直执行</span></span>
<span class="line"><span style="color:#24292e">			}</span></span>
<span class="line"><span style="color:#24292e">		}).</span><span style="color:#6f42c1">start</span><span style="color:#24292e">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">		Thread.</span><span style="color:#6f42c1">sleep</span><span style="color:#24292e">(</span><span style="color:#005cc5">1000</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">		System.out.</span><span style="color:#6f42c1">println</span><span style="color:#24292e">(</span><span style="color:#032f62">"改变run的值为false"</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">		run </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#005cc5">false</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">	}</span></span></code></pre></div><p><strong>为什么无法退出该循环</strong></p><ul><li>初始状态， t 线程刚开始从<strong>主内存</strong>读取了 run 的值到<strong>工作内存</strong>。</li></ul><figure><img src="https://jsd.cdn.zzko.cn/gh/imLKlauS/blog-picture@main/blogs/20200608145505.png" alt="img" loading="lazy" decoding="async"></figure><ul><li>因为 t 线程要频繁从主内存中读取 run 的值，JIT 编译器会将 run 的值<strong>缓存至自己工作内存</strong>中的高速缓存中， 减少对主存中 run 的访问，提高效率</li></ul><figure><img src="https://jsd.cdn.zzko.cn/gh/imLKlauS/blog-picture@main/blogs/20200608145517.png" alt="img" loading="lazy" decoding="async"></figure><ul><li>1 秒之后，main 线程修改了 run 的值，并同步至主存，而 t 是从自己工作内存中的高速缓存中读取这个变量 的值，结果永远是<strong>旧值</strong></li></ul><figure><img src="https://jsd.cdn.zzko.cn/gh/imLKlauS/blog-picture@main/blogs/20200608145529.png" alt="img" loading="lazy" decoding="async"></figure><p><strong>解决方法</strong></p><ul><li>使用<strong>volatile</strong>易变关键字</li><li>它可以用来修饰<strong>成员变量</strong>和<strong>静态成员变量</strong>（放在主存中的变量），他可以避免线程从自己的工作缓存中查找变量的值，必须到主存中获取它的值，线程操作 volatile 变量都是<strong>直接操作主存</strong></li></ul><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6a737d">//使用易变关键字</span></span>
<span class="line"><span style="color:#f97583">volatile</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">static</span><span style="color:#e1e4e8"> Boolean run </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">true</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">static</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">void</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">main</span><span style="color:#e1e4e8">(</span><span style="color:#f97583">String</span><span style="color:#e1e4e8">[] args) throws InterruptedException {</span></span>
<span class="line"><span style="color:#e1e4e8">	</span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Thread</span><span style="color:#e1e4e8">(()</span><span style="color:#f97583">-&gt;</span><span style="color:#e1e4e8">{</span></span>
<span class="line"><span style="color:#e1e4e8">		</span><span style="color:#f97583">while</span><span style="color:#e1e4e8"> (run) {</span></span>
<span class="line"><span style="color:#e1e4e8">			</span><span style="color:#6a737d">//如果run为真，则一直执行</span></span>
<span class="line"><span style="color:#e1e4e8">		}</span></span>
<span class="line"><span style="color:#e1e4e8">	}).</span><span style="color:#b392f0">start</span><span style="color:#e1e4e8">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">	Thread.</span><span style="color:#b392f0">sleep</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">1000</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">	System.out.</span><span style="color:#b392f0">println</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"改变run的值为false"</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">	run </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">false</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6a737d">//使用易变关键字</span></span>
<span class="line"><span style="color:#d73a49">volatile</span><span style="color:#24292e"> </span><span style="color:#d73a49">static</span><span style="color:#24292e"> Boolean run </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#005cc5">true</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">static</span><span style="color:#24292e"> </span><span style="color:#d73a49">void</span><span style="color:#24292e"> </span><span style="color:#6f42c1">main</span><span style="color:#24292e">(</span><span style="color:#d73a49">String</span><span style="color:#24292e">[] args) throws InterruptedException {</span></span>
<span class="line"><span style="color:#24292e">	</span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Thread</span><span style="color:#24292e">(()</span><span style="color:#d73a49">-&gt;</span><span style="color:#24292e">{</span></span>
<span class="line"><span style="color:#24292e">		</span><span style="color:#d73a49">while</span><span style="color:#24292e"> (run) {</span></span>
<span class="line"><span style="color:#24292e">			</span><span style="color:#6a737d">//如果run为真，则一直执行</span></span>
<span class="line"><span style="color:#24292e">		}</span></span>
<span class="line"><span style="color:#24292e">	}).</span><span style="color:#6f42c1">start</span><span style="color:#24292e">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">	Thread.</span><span style="color:#6f42c1">sleep</span><span style="color:#24292e">(</span><span style="color:#005cc5">1000</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">	System.out.</span><span style="color:#6f42c1">println</span><span style="color:#24292e">(</span><span style="color:#032f62">"改变run的值为false"</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">	run </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#005cc5">false</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">}</span></span></code></pre></div><h4 id="可见性与原子性" tabindex="-1">可见性与原子性 <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20intermediate%20level#可见性与原子性" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h4><p>前面例子体现的实际就是<strong>可见性</strong>，它保证的是在多个线程之间，一个线程对<strong>volatile变量</strong>的修改对另一个线程可见， <strong>不能</strong>保证原子性，仅用在<strong>一个写</strong>线程，<strong>多个读</strong>线程的情况</p><ul><li><p>注意 synchronized 语句块既可以保证代码块的<strong>原子性</strong>，也同时保证代码块内变量的<strong>可见性</strong>。</p></li><li><p>但缺点是 synchronized 是属于<strong>重量级</strong>操作，性能相对更低。</p></li><li><p>如果在前面示例的死循环中加入 System.out.println() 会发现即使不加 volatile 修饰符，线程 t 也能正确看到 对 run 变量的修改了，想一想为什么？</p><ul><li><p>因为使用了<strong>synchronized</strong>关键字</p><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">void</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">println</span><span style="color:#e1e4e8">(String x) {</span></span>
<span class="line"><span style="color:#e1e4e8">		</span><span style="color:#6a737d">//使用了synchronized关键字</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">synchronized</span><span style="color:#e1e4e8"> (</span><span style="color:#79b8ff">this</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#b392f0">print</span><span style="color:#e1e4e8">(x);</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#b392f0">newLine</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">        }</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">void</span><span style="color:#24292e"> </span><span style="color:#6f42c1">println</span><span style="color:#24292e">(String x) {</span></span>
<span class="line"><span style="color:#24292e">		</span><span style="color:#6a737d">//使用了synchronized关键字</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">synchronized</span><span style="color:#24292e"> (</span><span style="color:#005cc5">this</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#6f42c1">print</span><span style="color:#24292e">(x);</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#6f42c1">newLine</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">        }</span></span>
<span class="line"><span style="color:#24292e">    }</span></span></code></pre></div></li></ul></li></ul><h4 id="两阶终止模式优化" tabindex="-1">两阶终止模式优化 <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20intermediate%20level#两阶终止模式优化" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h4><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">class</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Test7</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">	</span><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">static</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">void</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">main</span><span style="color:#e1e4e8">(</span><span style="color:#f97583">String</span><span style="color:#e1e4e8">[] </span><span style="color:#ffab70">args</span><span style="color:#e1e4e8">) </span><span style="color:#f97583">throws</span><span style="color:#e1e4e8"> InterruptedException {</span></span>
<span class="line"><span style="color:#e1e4e8">		Monitor monitor </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Monitor</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">		monitor.</span><span style="color:#b392f0">start</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">		Thread.</span><span style="color:#b392f0">sleep</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">3500</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">		monitor.</span><span style="color:#b392f0">stop</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">	}</span></span>
<span class="line"><span style="color:#e1e4e8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#f97583">class</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Monitor</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">	Thread monitor;</span></span>
<span class="line"><span style="color:#e1e4e8">	</span><span style="color:#6a737d">//设置标记，用于判断是否被终止了</span></span>
<span class="line"><span style="color:#e1e4e8">	</span><span style="color:#f97583">private</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">volatile</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">boolean</span><span style="color:#e1e4e8"> stop </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">false</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#6a737d">	/**</span></span>
<span class="line"><span style="color:#6a737d">	 * 启动监控器线程</span></span>
<span class="line"><span style="color:#6a737d">	 */</span></span>
<span class="line"><span style="color:#e1e4e8">	</span><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">void</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">start</span><span style="color:#e1e4e8">() {</span></span>
<span class="line"><span style="color:#e1e4e8">		</span><span style="color:#6a737d">//设置线控器线程，用于监控线程状态</span></span>
<span class="line"><span style="color:#e1e4e8">		monitor </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Thread</span><span style="color:#e1e4e8">() {</span></span>
<span class="line"><span style="color:#e1e4e8">			@</span><span style="color:#f97583">Override</span></span>
<span class="line"><span style="color:#e1e4e8">			</span><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">void</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">run</span><span style="color:#e1e4e8">() {</span></span>
<span class="line"><span style="color:#e1e4e8">				</span><span style="color:#6a737d">//开始不停的监控</span></span>
<span class="line"><span style="color:#e1e4e8">				</span><span style="color:#f97583">while</span><span style="color:#e1e4e8"> (</span><span style="color:#79b8ff">true</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">					</span><span style="color:#f97583">if</span><span style="color:#e1e4e8">(stop) {</span></span>
<span class="line"><span style="color:#e1e4e8">						System.out.</span><span style="color:#b392f0">println</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"处理后续任务"</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">						</span><span style="color:#f97583">break</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">					}</span></span>
<span class="line"><span style="color:#e1e4e8">					System.out.</span><span style="color:#b392f0">println</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"监控器运行中..."</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">					</span><span style="color:#f97583">try</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">						</span><span style="color:#6a737d">//线程休眠</span></span>
<span class="line"><span style="color:#e1e4e8">						Thread.</span><span style="color:#b392f0">sleep</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">1000</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">					} </span><span style="color:#f97583">catch</span><span style="color:#e1e4e8"> (InterruptedException </span><span style="color:#ffab70">e</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">						System.out.</span><span style="color:#b392f0">println</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"被打断了"</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">					}</span></span>
<span class="line"><span style="color:#e1e4e8">				}</span></span>
<span class="line"><span style="color:#e1e4e8">			}</span></span>
<span class="line"><span style="color:#e1e4e8">		};</span></span>
<span class="line"><span style="color:#e1e4e8">		monitor.</span><span style="color:#b392f0">start</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">	}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6a737d">	/**</span></span>
<span class="line"><span style="color:#6a737d">	 * 	用于停止监控器线程</span></span>
<span class="line"><span style="color:#6a737d">	 */</span></span>
<span class="line"><span style="color:#e1e4e8">	</span><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">void</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">stop</span><span style="color:#e1e4e8">() {</span></span>
<span class="line"><span style="color:#e1e4e8">		</span><span style="color:#6a737d">//打断线程</span></span>
<span class="line"><span style="color:#e1e4e8">		monitor.</span><span style="color:#b392f0">interrupt</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#6a737d">//修改标记</span></span>
<span class="line"><span style="color:#e1e4e8">		stop </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">true</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">	}</span></span>
<span class="line"><span style="color:#e1e4e8">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">class</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Test7</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">	</span><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">static</span><span style="color:#24292e"> </span><span style="color:#d73a49">void</span><span style="color:#24292e"> </span><span style="color:#6f42c1">main</span><span style="color:#24292e">(</span><span style="color:#d73a49">String</span><span style="color:#24292e">[] </span><span style="color:#e36209">args</span><span style="color:#24292e">) </span><span style="color:#d73a49">throws</span><span style="color:#24292e"> InterruptedException {</span></span>
<span class="line"><span style="color:#24292e">		Monitor monitor </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Monitor</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">		monitor.</span><span style="color:#6f42c1">start</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">		Thread.</span><span style="color:#6f42c1">sleep</span><span style="color:#24292e">(</span><span style="color:#005cc5">3500</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">		monitor.</span><span style="color:#6f42c1">stop</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">	}</span></span>
<span class="line"><span style="color:#24292e">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#d73a49">class</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Monitor</span><span style="color:#24292e"> {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">	Thread monitor;</span></span>
<span class="line"><span style="color:#24292e">	</span><span style="color:#6a737d">//设置标记，用于判断是否被终止了</span></span>
<span class="line"><span style="color:#24292e">	</span><span style="color:#d73a49">private</span><span style="color:#24292e"> </span><span style="color:#d73a49">volatile</span><span style="color:#24292e"> </span><span style="color:#d73a49">boolean</span><span style="color:#24292e"> stop </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#005cc5">false</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#6a737d">	/**</span></span>
<span class="line"><span style="color:#6a737d">	 * 启动监控器线程</span></span>
<span class="line"><span style="color:#6a737d">	 */</span></span>
<span class="line"><span style="color:#24292e">	</span><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">void</span><span style="color:#24292e"> </span><span style="color:#6f42c1">start</span><span style="color:#24292e">() {</span></span>
<span class="line"><span style="color:#24292e">		</span><span style="color:#6a737d">//设置线控器线程，用于监控线程状态</span></span>
<span class="line"><span style="color:#24292e">		monitor </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Thread</span><span style="color:#24292e">() {</span></span>
<span class="line"><span style="color:#24292e">			@</span><span style="color:#d73a49">Override</span></span>
<span class="line"><span style="color:#24292e">			</span><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">void</span><span style="color:#24292e"> </span><span style="color:#6f42c1">run</span><span style="color:#24292e">() {</span></span>
<span class="line"><span style="color:#24292e">				</span><span style="color:#6a737d">//开始不停的监控</span></span>
<span class="line"><span style="color:#24292e">				</span><span style="color:#d73a49">while</span><span style="color:#24292e"> (</span><span style="color:#005cc5">true</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">					</span><span style="color:#d73a49">if</span><span style="color:#24292e">(stop) {</span></span>
<span class="line"><span style="color:#24292e">						System.out.</span><span style="color:#6f42c1">println</span><span style="color:#24292e">(</span><span style="color:#032f62">"处理后续任务"</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">						</span><span style="color:#d73a49">break</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">					}</span></span>
<span class="line"><span style="color:#24292e">					System.out.</span><span style="color:#6f42c1">println</span><span style="color:#24292e">(</span><span style="color:#032f62">"监控器运行中..."</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">					</span><span style="color:#d73a49">try</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">						</span><span style="color:#6a737d">//线程休眠</span></span>
<span class="line"><span style="color:#24292e">						Thread.</span><span style="color:#6f42c1">sleep</span><span style="color:#24292e">(</span><span style="color:#005cc5">1000</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">					} </span><span style="color:#d73a49">catch</span><span style="color:#24292e"> (InterruptedException </span><span style="color:#e36209">e</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">						System.out.</span><span style="color:#6f42c1">println</span><span style="color:#24292e">(</span><span style="color:#032f62">"被打断了"</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">					}</span></span>
<span class="line"><span style="color:#24292e">				}</span></span>
<span class="line"><span style="color:#24292e">			}</span></span>
<span class="line"><span style="color:#24292e">		};</span></span>
<span class="line"><span style="color:#24292e">		monitor.</span><span style="color:#6f42c1">start</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">	}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6a737d">	/**</span></span>
<span class="line"><span style="color:#6a737d">	 * 	用于停止监控器线程</span></span>
<span class="line"><span style="color:#6a737d">	 */</span></span>
<span class="line"><span style="color:#24292e">	</span><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">void</span><span style="color:#24292e"> </span><span style="color:#6f42c1">stop</span><span style="color:#24292e">() {</span></span>
<span class="line"><span style="color:#24292e">		</span><span style="color:#6a737d">//打断线程</span></span>
<span class="line"><span style="color:#24292e">		monitor.</span><span style="color:#6f42c1">interrupt</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6a737d">//修改标记</span></span>
<span class="line"><span style="color:#24292e">		stop </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#005cc5">true</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">	}</span></span>
<span class="line"><span style="color:#24292e">}</span></span></code></pre></div><h4 id="同步模式之犹豫模式" tabindex="-1">同步模式之犹豫模式 <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20intermediate%20level#同步模式之犹豫模式" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h4><p><strong>定义</strong></p><p>Balking （犹豫）模式用在一个线程发现另一个线程或本线程<strong>已经做了某一件相同</strong>的事，那么本线程就无需再做 了，<strong>直接结束返回</strong></p><ul><li>用一个标记来判断该任务是否已经被执行过了</li><li>需要避免线程安全问题<ul><li>加锁的代码块要尽量的小，以保证性能</li></ul></li></ul><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8">@</span><span style="color:#f97583">Slf4j</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">topic</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#9ecbff">"c.TwoPhaseTermination"</span><span style="color:#e1e4e8">)</span></span>
<span class="line"><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">class</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Test13</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">static</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">void</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">main</span><span style="color:#e1e4e8">(</span><span style="color:#f97583">String</span><span style="color:#e1e4e8">[] </span><span style="color:#ffab70">args</span><span style="color:#e1e4e8">) </span><span style="color:#f97583">throws</span><span style="color:#e1e4e8"> InterruptedException {</span></span>
<span class="line"><span style="color:#e1e4e8">        TwoPhaseTermination tpt </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">TwoPhaseTermination</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">        tpt.</span><span style="color:#b392f0">start</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">        tpt.</span><span style="color:#b392f0">start</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">        tpt.</span><span style="color:#b392f0">start</span><span style="color:#e1e4e8">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#6a737d">/*Thread.sleep(3500);</span></span>
<span class="line"><span style="color:#6a737d">        log.debug("停止监控");</span></span>
<span class="line"><span style="color:#6a737d">        tpt.stop();*/</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"><span style="color:#e1e4e8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">@</span><span style="color:#f97583">Slf4j</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">topic</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#9ecbff">"c.TwoPhaseTermination"</span><span style="color:#e1e4e8">)</span></span>
<span class="line"><span style="color:#f97583">class</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">TwoPhaseTermination</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">// 监控线程</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">private</span><span style="color:#e1e4e8"> Thread monitorThread;</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">// 停止标记</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">private</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">volatile</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">boolean</span><span style="color:#e1e4e8"> stop </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">false</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">// 判断是否执行过 start 方法</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">private</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">boolean</span><span style="color:#e1e4e8"> starting </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">false</span><span style="color:#e1e4e8">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">// 启动监控线程</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">void</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">start</span><span style="color:#e1e4e8">() {</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">synchronized</span><span style="color:#e1e4e8"> (</span><span style="color:#79b8ff">this</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (starting) { </span><span style="color:#6a737d">// false</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#f97583">return</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">            }</span></span>
<span class="line"><span style="color:#e1e4e8">            starting </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">true</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">        }</span></span>
<span class="line"><span style="color:#e1e4e8">        monitorThread </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Thread</span><span style="color:#e1e4e8">(() </span><span style="color:#f97583">-&gt;</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">while</span><span style="color:#e1e4e8"> (</span><span style="color:#79b8ff">true</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">                Thread current </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> Thread.</span><span style="color:#b392f0">currentThread</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#6a737d">// 是否被打断</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (stop) {</span></span>
<span class="line"><span style="color:#e1e4e8">                    log.</span><span style="color:#b392f0">debug</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"料理后事"</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">                    </span><span style="color:#f97583">break</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">                }</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#f97583">try</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">                    Thread.</span><span style="color:#b392f0">sleep</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">1000</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">                    log.</span><span style="color:#b392f0">debug</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"执行监控记录"</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">                } </span><span style="color:#f97583">catch</span><span style="color:#e1e4e8"> (InterruptedException </span><span style="color:#ffab70">e</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">                }</span></span>
<span class="line"><span style="color:#e1e4e8">            }</span></span>
<span class="line"><span style="color:#e1e4e8">        }, </span><span style="color:#9ecbff">"monitor"</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">        monitorThread.</span><span style="color:#b392f0">start</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">// 停止监控线程</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">void</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">stop</span><span style="color:#e1e4e8">() {</span></span>
<span class="line"><span style="color:#e1e4e8">        stop </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">true</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">        monitorThread.</span><span style="color:#b392f0">interrupt</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"><span style="color:#e1e4e8">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e">@</span><span style="color:#d73a49">Slf4j</span><span style="color:#24292e">(</span><span style="color:#005cc5">topic</span><span style="color:#24292e"> </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#032f62">"c.TwoPhaseTermination"</span><span style="color:#24292e">)</span></span>
<span class="line"><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">class</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Test13</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">static</span><span style="color:#24292e"> </span><span style="color:#d73a49">void</span><span style="color:#24292e"> </span><span style="color:#6f42c1">main</span><span style="color:#24292e">(</span><span style="color:#d73a49">String</span><span style="color:#24292e">[] </span><span style="color:#e36209">args</span><span style="color:#24292e">) </span><span style="color:#d73a49">throws</span><span style="color:#24292e"> InterruptedException {</span></span>
<span class="line"><span style="color:#24292e">        TwoPhaseTermination tpt </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">TwoPhaseTermination</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">        tpt.</span><span style="color:#6f42c1">start</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">        tpt.</span><span style="color:#6f42c1">start</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">        tpt.</span><span style="color:#6f42c1">start</span><span style="color:#24292e">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6a737d">/*Thread.sleep(3500);</span></span>
<span class="line"><span style="color:#6a737d">        log.debug("停止监控");</span></span>
<span class="line"><span style="color:#6a737d">        tpt.stop();*/</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"><span style="color:#24292e">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">@</span><span style="color:#d73a49">Slf4j</span><span style="color:#24292e">(</span><span style="color:#005cc5">topic</span><span style="color:#24292e"> </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#032f62">"c.TwoPhaseTermination"</span><span style="color:#24292e">)</span></span>
<span class="line"><span style="color:#d73a49">class</span><span style="color:#24292e"> </span><span style="color:#6f42c1">TwoPhaseTermination</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">// 监控线程</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">private</span><span style="color:#24292e"> Thread monitorThread;</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">// 停止标记</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">private</span><span style="color:#24292e"> </span><span style="color:#d73a49">volatile</span><span style="color:#24292e"> </span><span style="color:#d73a49">boolean</span><span style="color:#24292e"> stop </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#005cc5">false</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">// 判断是否执行过 start 方法</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">private</span><span style="color:#24292e"> </span><span style="color:#d73a49">boolean</span><span style="color:#24292e"> starting </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#005cc5">false</span><span style="color:#24292e">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">// 启动监控线程</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">void</span><span style="color:#24292e"> </span><span style="color:#6f42c1">start</span><span style="color:#24292e">() {</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">synchronized</span><span style="color:#24292e"> (</span><span style="color:#005cc5">this</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (starting) { </span><span style="color:#6a737d">// false</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#d73a49">return</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">            }</span></span>
<span class="line"><span style="color:#24292e">            starting </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#005cc5">true</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">        }</span></span>
<span class="line"><span style="color:#24292e">        monitorThread </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Thread</span><span style="color:#24292e">(() </span><span style="color:#d73a49">-&gt;</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">while</span><span style="color:#24292e"> (</span><span style="color:#005cc5">true</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">                Thread current </span><span style="color:#d73a49">=</span><span style="color:#24292e"> Thread.</span><span style="color:#6f42c1">currentThread</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#6a737d">// 是否被打断</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (stop) {</span></span>
<span class="line"><span style="color:#24292e">                    log.</span><span style="color:#6f42c1">debug</span><span style="color:#24292e">(</span><span style="color:#032f62">"料理后事"</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">                    </span><span style="color:#d73a49">break</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">                }</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#d73a49">try</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">                    Thread.</span><span style="color:#6f42c1">sleep</span><span style="color:#24292e">(</span><span style="color:#005cc5">1000</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">                    log.</span><span style="color:#6f42c1">debug</span><span style="color:#24292e">(</span><span style="color:#032f62">"执行监控记录"</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">                } </span><span style="color:#d73a49">catch</span><span style="color:#24292e"> (InterruptedException </span><span style="color:#e36209">e</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">                }</span></span>
<span class="line"><span style="color:#24292e">            }</span></span>
<span class="line"><span style="color:#24292e">        }, </span><span style="color:#032f62">"monitor"</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">        monitorThread.</span><span style="color:#6f42c1">start</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">// 停止监控线程</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">void</span><span style="color:#24292e"> </span><span style="color:#6f42c1">stop</span><span style="color:#24292e">() {</span></span>
<span class="line"><span style="color:#24292e">        stop </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#005cc5">true</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">        monitorThread.</span><span style="color:#6f42c1">interrupt</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"><span style="color:#24292e">}</span></span></code></pre></div><blockquote><p>volatile不能保证代码的原子性，synchronized就可以</p></blockquote><h3 id="_3、有序性" tabindex="-1">3、有序性 <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20intermediate%20level#_3、有序性" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h3><h4 id="指令重排" tabindex="-1">指令重排 <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20intermediate%20level#指令重排" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h4><ul><li>JVM 会在<strong>不影响正确性</strong>的前提下，可以<strong>调整</strong>语句的执行<strong>顺序</strong></li></ul><figure><img src="https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/20200608145546.png" alt="img" loading="lazy" decoding="async"></figure><p>这种特性称之为『<strong>指令重排</strong>』，<strong>多线程下『指令重排』会影响正确性</strong>。</p><h4 id="指令重排序优化" tabindex="-1">指令重排序优化 <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20intermediate%20level#指令重排序优化" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h4><ul><li>事实上，现代处理器会设计为一个时钟周期完成一条执行时间长的 CPU 指令。为什么这么做呢？可以想到指令还可以再划分成一个个更小的阶段，例如，每条指令都可以分为： <strong>取指令 - 指令译码 - 执行指令 - 内存访问 - 数据写回</strong> 这5 个阶段</li></ul><figure><img src="https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/20200608145615.png" alt="img" loading="lazy" decoding="async"></figure><ul><li><p>在不改变程序结果的前提下，这些指令的各个阶段可以通过<strong>重排序</strong>和<strong>组合</strong>来实现<strong>指令级并行</strong></p></li><li><p>指令重排的前提是，重排指令<strong>不能影响结果</strong>，例如</p><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8">// 可以重排的例子 </span></span>
<span class="line"><span style="color:#e1e4e8">int a = 10; </span></span>
<span class="line"><span style="color:#e1e4e8">int b = 20; </span></span>
<span class="line"><span style="color:#e1e4e8">System.out.println( a + b );</span></span>
<span class="line"><span style="color:#e1e4e8"></span></span>
<span class="line"><span style="color:#e1e4e8">// 不能重排的例子 </span></span>
<span class="line"><span style="color:#e1e4e8">int a = 10;</span></span>
<span class="line"><span style="color:#e1e4e8">int b = a - 5;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e">// 可以重排的例子 </span></span>
<span class="line"><span style="color:#24292e">int a = 10; </span></span>
<span class="line"><span style="color:#24292e">int b = 20; </span></span>
<span class="line"><span style="color:#24292e">System.out.println( a + b );</span></span>
<span class="line"><span style="color:#24292e"></span></span>
<span class="line"><span style="color:#24292e">// 不能重排的例子 </span></span>
<span class="line"><span style="color:#24292e">int a = 10;</span></span>
<span class="line"><span style="color:#24292e">int b = a - 5;</span></span></code></pre></div></li></ul><h4 id="支持流水线的处理器" tabindex="-1">支持流水线的处理器 <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20intermediate%20level#支持流水线的处理器" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h4><p>现代 CPU 支持多级<strong>指令流水线</strong>，例如支持<strong>同时</strong>执行 <strong>取指令 - 指令译码 - 执行指令 - 内存访问 - 数据写回</strong> 的处理器，就可以称之为五级指令流水线。这时 CPU 可以在一个时钟周期内，同时运行五条指令的不同阶段（相当于一 条执行时间长的复杂指令），IPC = 1，本质上，流水线技术并不能缩短单条指令的执行时间，但它变相地提高了指令地<strong>吞吐率</strong>。</p><figure><img src="https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/20200608145602.png" alt="img" loading="lazy" decoding="async"></figure><p><strong>在多线程环境下，指令重排序可能导致出现意料之外的结果</strong></p><h4 id="解决办法" tabindex="-1">解决办法 <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20intermediate%20level#解决办法" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h4><p><strong>volatile</strong> 修饰的变量，可以<strong>禁用</strong>指令重排</p><ul><li>禁止的是加volatile关键字变量之前的代码被重排序</li></ul><h3 id="_4、内存屏障" tabindex="-1">4、内存屏障 <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20intermediate%20level#_4、内存屏障" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h3><ul><li>可见性<ul><li><strong>写屏障</strong>（sfence）保证在该屏障<strong>之前</strong>的，对共享变量的改动，都同步到主存当中</li><li><strong>读屏障</strong>（lfence）保证在该屏障<strong>之后</strong>，对共享变量的读取，加载的是主存中新数据</li></ul></li><li>有序性<ul><li>写屏障会确保指令重排序时，不会将<strong>写屏障之前</strong>的代码排在写屏障之后</li><li>读屏障会确保指令重排序时，不会将<strong>读屏障之后</strong>的代码排在读屏障之前</li></ul></li></ul><figure><img src="https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230713210757338.png" alt="image-20230713210757338" loading="lazy" decoding="async"></figure><h3 id="_5、volatile-原理" tabindex="-1">5、volatile 原理 <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20intermediate%20level#_5、volatile-原理" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h3><p>volatile的底层实现原理是<strong>内存屏障</strong>，Memory Barrier（Memory Fence）</p><ul><li>对 volatile 变量的写指令后会加入写屏障</li><li>对 volatile 变量的读指令前会加入读屏障</li></ul><h4 id="如何保证可见性" tabindex="-1">如何保证可见性 <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20intermediate%20level#如何保证可见性" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h4><ul><li><p>写屏障（sfence）保证在该屏障之前的，对共享变量的改动，都同步到主存当中，即不光把volatile变量同步到主存中，还会将其上面的变量都同步到主存中，保证了其他变量修改的可见性，其他线程就可以读取到最新的值</p><figure><img src="https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/20200608145630.png" alt="img" loading="lazy" decoding="async"></figure></li><li><p>而读屏障（lfence）保证在该屏障之后，对共享变量的读取，加载的是主存中新数据，即下面的代码都会到主存中读取共享变量的最新值，不会到其工作内存中读取</p><figure><img src="https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/20200608145729.png" alt="img" loading="lazy" decoding="async"></figure><figure><img src="https://jsd.cdn.zzko.cn/gh/imLKlauS/blog-picture@main/blogs/20200608145713.png" alt="img" loading="lazy" decoding="async"></figure></li></ul><h4 id="如何保证有序性" tabindex="-1">如何保证有序性 <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20intermediate%20level#如何保证有序性" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h4><ul><li><p>写屏障会确保指令重排序时，不会将写屏障之前的代码排在写屏障之后</p></li><li><p>读屏障会确保指令重排序时，不会将读屏障之后的代码排在读屏障之前</p></li></ul><p><strong>但是不能解决指令交错问题</strong></p><ul><li>写屏障仅仅是保证之后的读能够读到新的结果，但不能保证读跑到它前面去</li><li>而有序性的保证也只是保证了<strong>本线程内</strong>相关代码不被重排序</li></ul><figure><img src="https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230713212314498.png" alt="image-20230713212314498" loading="lazy" decoding="async"></figure><h4 id="double-checked-locking-问题" tabindex="-1">double-checked locking 问题 <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20intermediate%20level#double-checked-locking-问题" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h4><p>以著名的 double-checked locking 单例模式为例</p><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">final</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">class</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Singleton</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">private</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Singleton</span><span style="color:#e1e4e8">() { }</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">private</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">static</span><span style="color:#e1e4e8"> Singleton INSTANCE </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">static</span><span style="color:#e1e4e8"> Singleton </span><span style="color:#b392f0">getInstance</span><span style="color:#e1e4e8">() {</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">if</span><span style="color:#e1e4e8">(INSTANCE </span><span style="color:#f97583">==</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8">) { </span><span style="color:#6a737d">// t2</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#6a737d">// 首次访问会同步，而之后的使用没有 synchronized</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">synchronized</span><span style="color:#e1e4e8">(Singleton.class) {</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (INSTANCE </span><span style="color:#f97583">==</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8">) { </span><span style="color:#6a737d">// t1</span></span>
<span class="line"><span style="color:#e1e4e8">                    INSTANCE </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Singleton</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">                    }</span></span>
<span class="line"><span style="color:#e1e4e8">                }</span></span>
<span class="line"><span style="color:#e1e4e8">            }</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> INSTANCE;</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"><span style="color:#e1e4e8">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">final</span><span style="color:#24292e"> </span><span style="color:#d73a49">class</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Singleton</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">private</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Singleton</span><span style="color:#24292e">() { }</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">private</span><span style="color:#24292e"> </span><span style="color:#d73a49">static</span><span style="color:#24292e"> Singleton INSTANCE </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#005cc5">null</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">static</span><span style="color:#24292e"> Singleton </span><span style="color:#6f42c1">getInstance</span><span style="color:#24292e">() {</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">if</span><span style="color:#24292e">(INSTANCE </span><span style="color:#d73a49">==</span><span style="color:#24292e"> </span><span style="color:#005cc5">null</span><span style="color:#24292e">) { </span><span style="color:#6a737d">// t2</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#6a737d">// 首次访问会同步，而之后的使用没有 synchronized</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">synchronized</span><span style="color:#24292e">(Singleton.class) {</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (INSTANCE </span><span style="color:#d73a49">==</span><span style="color:#24292e"> </span><span style="color:#005cc5">null</span><span style="color:#24292e">) { </span><span style="color:#6a737d">// t1</span></span>
<span class="line"><span style="color:#24292e">                    INSTANCE </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Singleton</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">                    }</span></span>
<span class="line"><span style="color:#24292e">                }</span></span>
<span class="line"><span style="color:#24292e">            }</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">return</span><span style="color:#24292e"> INSTANCE;</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"><span style="color:#24292e">}</span></span></code></pre></div><p>以上的实现特点是：</p><ul><li>懒惰实例化</li><li>首次使用 getInstance() 才使用 synchronized 加锁，后续使用时无需加锁</li><li>有隐含的，但很关键的一点：第一个 if 使用了 INSTANCE 变量，是在同步块之外</li></ul><p>但在多线程环境下，上面的代码是有问题的，getInstance 方法对应的字节码为：</p><figure><img src="https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230713213521412.png" alt="image-20230713213521412" loading="lazy" decoding="async"></figure><p>其中</p><ul><li>17 表示创建对象，将对象引用入栈 // new Singleton</li><li>20 表示复制一份对象引用 // 引用地址</li><li>21 表示利用一个对象引用，调用构造方法</li><li>24 表示利用一个对象引用，赋值给 static INSTANCE</li></ul><p>也许 jvm 会优化为：先执行 24，再执行 21。如果两个线程 t1，t2 按如下时间序列执行：</p><figure><img src="https://jsd.cdn.zzko.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230713215804212.png" alt="image-20230713215804212" loading="lazy" decoding="async"></figure><blockquote><p>关键在于 0: getstatic 这行代码在 monitor 控制之外，它就像之前举例中不守规则的人，可以越过 monitor 读取INSTANCE 变量的值；这时 t1 还未完全将构造方法执行完毕，如果在构造方法中要执行很多初始化操作，那么 t2 拿到的是将是一个未初始化完毕的单例；对 INSTANCE 使用 volatile 修饰即可，可以禁用指令重排，但要注意在 JDK 5 以上的版本的 volatile 才会真正有效</p><p>synchronized同步的代码块，具有排他性，一次只能被一个线程拥有，所以synchronized保证同一时刻，代码是单线程执行的。</p><p>因为as-if-serial语义的存在，单线程的程序能保证最终结果是有序的，但是不保证不会指令重排。</p><p>所以synchronized保证的有序是执行结果的有序性，而不是防止指令重排的有序性。synchronized确实可以保证共享变量的原子、可见、有序性，前提是共享变量完全交由synchronized来管理，不能留一部分出去，不然就脱离了synchronized的管理了</p></blockquote><h4 id="double-checked-locking-解决" tabindex="-1">double-checked locking 解决 <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20intermediate%20level#double-checked-locking-解决" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h4><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">final</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">class</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Singleton</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">private</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Singleton</span><span style="color:#e1e4e8">() { }</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">private</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">static</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">volatile</span><span style="color:#e1e4e8"> Singleton INSTANCE </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">static</span><span style="color:#e1e4e8"> Singleton </span><span style="color:#b392f0">getInstance</span><span style="color:#e1e4e8">() {</span></span>
<span class="line"><span style="color:#e1e4e8">    	</span><span style="color:#6a737d">// 实例没创建，才会进入内部的 synchronized代码块</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">if</span><span style="color:#e1e4e8">(INSTANCE </span><span style="color:#f97583">==</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8">) { </span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">synchronized</span><span style="color:#e1e4e8">(Singleton.class) {</span><span style="color:#6a737d">// t2</span></span>
<span class="line"><span style="color:#e1e4e8">            	</span><span style="color:#6a737d">// 也许有其它线程已经创建实例，所以再判断一次</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (INSTANCE </span><span style="color:#f97583">==</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8">) { </span><span style="color:#6a737d">// t1</span></span>
<span class="line"><span style="color:#e1e4e8">                    INSTANCE </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Singleton</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">                    }</span></span>
<span class="line"><span style="color:#e1e4e8">                }</span></span>
<span class="line"><span style="color:#e1e4e8">            }</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> INSTANCE;</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"><span style="color:#e1e4e8">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">final</span><span style="color:#24292e"> </span><span style="color:#d73a49">class</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Singleton</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">private</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Singleton</span><span style="color:#24292e">() { }</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">private</span><span style="color:#24292e"> </span><span style="color:#d73a49">static</span><span style="color:#24292e"> </span><span style="color:#d73a49">volatile</span><span style="color:#24292e"> Singleton INSTANCE </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#005cc5">null</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">static</span><span style="color:#24292e"> Singleton </span><span style="color:#6f42c1">getInstance</span><span style="color:#24292e">() {</span></span>
<span class="line"><span style="color:#24292e">    	</span><span style="color:#6a737d">// 实例没创建，才会进入内部的 synchronized代码块</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">if</span><span style="color:#24292e">(INSTANCE </span><span style="color:#d73a49">==</span><span style="color:#24292e"> </span><span style="color:#005cc5">null</span><span style="color:#24292e">) { </span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">synchronized</span><span style="color:#24292e">(Singleton.class) {</span><span style="color:#6a737d">// t2</span></span>
<span class="line"><span style="color:#24292e">            	</span><span style="color:#6a737d">// 也许有其它线程已经创建实例，所以再判断一次</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (INSTANCE </span><span style="color:#d73a49">==</span><span style="color:#24292e"> </span><span style="color:#005cc5">null</span><span style="color:#24292e">) { </span><span style="color:#6a737d">// t1</span></span>
<span class="line"><span style="color:#24292e">                    INSTANCE </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Singleton</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">                    }</span></span>
<span class="line"><span style="color:#24292e">                }</span></span>
<span class="line"><span style="color:#24292e">            }</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">return</span><span style="color:#24292e"> INSTANCE;</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"><span style="color:#24292e">}</span></span></code></pre></div><figure><img src="https://jsd.cdn.zzko.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230713215851770.png" alt="image-20230713215851770" loading="lazy" decoding="async"></figure><h4 id="happens-before" tabindex="-1">happens-before <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20intermediate%20level#happens-before" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h4><p>happens-before 规定了对共享变量的写操作对其它线程的读操作可见，它是可见性与有序性的一套规则总结，抛 开以下 happens-before 规则，JMM 并不能保证一个线程对共享变量的写，对于其它线程对该共享变量的读可见</p><h4 id="实现原理之lock前缀" tabindex="-1">实现原理之Lock前缀 <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20intermediate%20level#实现原理之lock前缀" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h4><p>在X86处理器下通过工具获取JIT编译器生成的汇编指令来查看对volatile进行写操作时</p><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8">instance </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Singleton</span><span style="color:#e1e4e8">();</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e">instance </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Singleton</span><span style="color:#24292e">();</span></span></code></pre></div><p>对应的汇编代码是</p><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8">... lock addl ...</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e">... lock addl ...</span></span></code></pre></div><p>有volatile变量修饰的共享变量进行写操作的时候会多出第二行汇编代码，通过查IA-32架构软件开发者手册可知，<strong>Lock前缀</strong>的指令在多核处理器下会引发了两件事</p><ul><li><p>Lock前缀指令会引起处理器</p><p>缓存回写到内存</p><ul><li>Lock前缀指令导致在执行指令期间，声言处理器的LOCK#信号。在多处理器环境中，LOCK#信号确保在声言该信号期间，处理器可以独占任何共享内存。但是，在最近的处理器里，LOCK #信号一般不锁总线，而是<strong>锁缓存</strong>，毕竟锁总线开销的比较大。使用缓存一致性机制来确保修改的原子性，此操作被称为“缓存锁定”，<strong>缓存一致性机制会阻止同时修改由两个以上处理器缓存的内存区域数据</strong></li></ul></li><li><p>一个处理器的缓存回写到内存会</p><p>导致其他处理器的缓存无效</p><ul><li>在多核处理器系统中进行操作的时候，IA-32和Intel 64处理器能<strong>嗅探其他处理器访问系统内存和它们的内部缓存</strong>。处理器使用嗅探技术保证它的内部缓存、系统内存和其他处理器的缓存的数据在总线上保持一致</li></ul></li></ul><h2 id="五、共享模型之无锁" tabindex="-1">五、共享模型之无锁 <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20intermediate%20level#五、共享模型之无锁" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h2><h3 id="_1、无锁解决线程安全问题" tabindex="-1">1、无锁解决线程安全问题 <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20intermediate%20level#_1、无锁解决线程安全问题" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h3><ul><li><p>使用<strong>原子整数</strong></p><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8">AtomicInteger balance </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">AtomicInteger</span><span style="color:#e1e4e8">();</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e">AtomicInteger balance </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">AtomicInteger</span><span style="color:#24292e">();</span></span></code></pre></div></li></ul><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#f97583">interface</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Account</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">	Integer </span><span style="color:#b392f0">getBalance</span><span style="color:#e1e4e8">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">	</span><span style="color:#f97583">void</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">withdraw</span><span style="color:#e1e4e8">(Integer </span><span style="color:#ffab70">amount</span><span style="color:#e1e4e8">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6a737d">	/**</span></span>
<span class="line"><span style="color:#6a737d">	 * 方法内会启动 1000 个线程，每个线程做 -10 元 的操作     * 如果初始余额为 10000 那么正确的结果应当是 0</span></span>
<span class="line"><span style="color:#6a737d">	 */</span></span>
<span class="line"><span style="color:#e1e4e8">	</span><span style="color:#f97583">static</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">void</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">demo</span><span style="color:#e1e4e8">(Account </span><span style="color:#ffab70">account</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">		List&lt;</span><span style="color:#f97583">Thread</span><span style="color:#e1e4e8">&gt; ts </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> ArrayList&lt;&gt;();</span></span>
<span class="line"><span style="color:#e1e4e8">		</span><span style="color:#f97583">long</span><span style="color:#e1e4e8"> start </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> System.</span><span style="color:#b392f0">nanoTime</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">		</span><span style="color:#f97583">for</span><span style="color:#e1e4e8"> (</span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> i </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8">; i </span><span style="color:#f97583">&lt;</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">1000</span><span style="color:#e1e4e8">; i</span><span style="color:#f97583">++</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">			ts.</span><span style="color:#b392f0">add</span><span style="color:#e1e4e8">(</span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Thread</span><span style="color:#e1e4e8">(() </span><span style="color:#f97583">-&gt;</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">				account.</span><span style="color:#b392f0">withdraw</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">10</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">			}));</span></span>
<span class="line"><span style="color:#e1e4e8">		}</span></span>
<span class="line"><span style="color:#e1e4e8">		ts.</span><span style="color:#b392f0">forEach</span><span style="color:#e1e4e8">(Thread</span><span style="color:#f97583">::</span><span style="color:#e1e4e8">start);</span></span>
<span class="line"><span style="color:#e1e4e8">		ts.</span><span style="color:#b392f0">forEach</span><span style="color:#e1e4e8">(t </span><span style="color:#f97583">-&gt;</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">			</span><span style="color:#f97583">try</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">				t.</span><span style="color:#b392f0">join</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">			} </span><span style="color:#f97583">catch</span><span style="color:#e1e4e8"> (InterruptedException </span><span style="color:#ffab70">e</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">				e.</span><span style="color:#b392f0">printStackTrace</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">			}</span></span>
<span class="line"><span style="color:#e1e4e8">		});</span></span>
<span class="line"><span style="color:#e1e4e8">		</span><span style="color:#f97583">long</span><span style="color:#e1e4e8"> end </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> System.</span><span style="color:#b392f0">nanoTime</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">		System.out.</span><span style="color:#b392f0">println</span><span style="color:#e1e4e8">(account.</span><span style="color:#b392f0">getBalance</span><span style="color:#e1e4e8">() </span><span style="color:#f97583">+</span><span style="color:#e1e4e8"> </span><span style="color:#9ecbff">" cost: "</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">+</span><span style="color:#e1e4e8"> (end </span><span style="color:#f97583">-</span><span style="color:#e1e4e8"> start) </span><span style="color:#f97583">/</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">1000_000</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">+</span><span style="color:#e1e4e8"> </span><span style="color:#9ecbff">" ms"</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">	}</span></span>
<span class="line"><span style="color:#e1e4e8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6a737d">//线程不安全的做法</span></span>
<span class="line"><span style="color:#f97583">class</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">AccountUnsafe</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">implements</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Account</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">	</span><span style="color:#f97583">private</span><span style="color:#e1e4e8"> Integer balance;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">	</span><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">AccountUnsafe</span><span style="color:#e1e4e8">(Integer </span><span style="color:#ffab70">balance</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">		</span><span style="color:#79b8ff">this</span><span style="color:#e1e4e8">.balance </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> balance;</span></span>
<span class="line"><span style="color:#e1e4e8">	}</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">	@</span><span style="color:#f97583">Override</span></span>
<span class="line"><span style="color:#e1e4e8">	</span><span style="color:#f97583">public</span><span style="color:#e1e4e8"> Integer </span><span style="color:#b392f0">getBalance</span><span style="color:#e1e4e8">() {</span></span>
<span class="line"><span style="color:#e1e4e8">		</span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">this</span><span style="color:#e1e4e8">.balance;</span></span>
<span class="line"><span style="color:#e1e4e8">	}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">	@</span><span style="color:#f97583">Override</span></span>
<span class="line"><span style="color:#e1e4e8">	</span><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">synchronized</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">void</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">withdraw</span><span style="color:#e1e4e8">(Integer </span><span style="color:#ffab70">amount</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">		balance </span><span style="color:#f97583">-=</span><span style="color:#e1e4e8"> amount;</span></span>
<span class="line"><span style="color:#e1e4e8">	}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">	</span><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">static</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">void</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">main</span><span style="color:#e1e4e8">(</span><span style="color:#f97583">String</span><span style="color:#e1e4e8">[] </span><span style="color:#ffab70">args</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">		Account.</span><span style="color:#b392f0">demo</span><span style="color:#e1e4e8">(</span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">AccountUnsafe</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">10000</span><span style="color:#e1e4e8">));</span></span>
<span class="line"><span style="color:#e1e4e8">		Account.</span><span style="color:#b392f0">demo</span><span style="color:#e1e4e8">(</span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">AccountCas</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">10000</span><span style="color:#e1e4e8">));</span></span>
<span class="line"><span style="color:#e1e4e8">	}</span></span>
<span class="line"><span style="color:#e1e4e8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6a737d">//线程安全的做法</span></span>
<span class="line"><span style="color:#f97583">class</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">AccountCas</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">implements</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Account</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">	</span><span style="color:#6a737d">//使用原子整数</span></span>
<span class="line"><span style="color:#e1e4e8">	</span><span style="color:#f97583">private</span><span style="color:#e1e4e8"> AtomicInteger balance;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">	</span><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">AccountCas</span><span style="color:#e1e4e8">(</span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> </span><span style="color:#ffab70">balance</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">		</span><span style="color:#79b8ff">this</span><span style="color:#e1e4e8">.balance </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">AtomicInteger</span><span style="color:#e1e4e8">(balance);</span></span>
<span class="line"><span style="color:#e1e4e8">	}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">	@</span><span style="color:#f97583">Override</span></span>
<span class="line"><span style="color:#e1e4e8">	</span><span style="color:#f97583">public</span><span style="color:#e1e4e8"> Integer </span><span style="color:#b392f0">getBalance</span><span style="color:#e1e4e8">() {</span></span>
<span class="line"><span style="color:#e1e4e8">		</span><span style="color:#6a737d">//得到原子整数的值</span></span>
<span class="line"><span style="color:#e1e4e8">		</span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> balance.</span><span style="color:#b392f0">get</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">	}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">	@</span><span style="color:#f97583">Override</span></span>
<span class="line"><span style="color:#e1e4e8">	</span><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">void</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">withdraw</span><span style="color:#e1e4e8">(Integer </span><span style="color:#ffab70">amount</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">			</span><span style="color:#6a737d">// 需要不断尝试，直到成功为止</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">while</span><span style="color:#e1e4e8"> (</span><span style="color:#79b8ff">true</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#6a737d">// 比如拿到了旧值 1000</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> prev </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> balance.</span><span style="color:#b392f0">get</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#6a737d">// 在这个基础上 1000-10 = 990</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> next </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> prev </span><span style="color:#f97583">-</span><span style="color:#e1e4e8"> amount;</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#6a737d">/*</span></span>
<span class="line"><span style="color:#6a737d">            compareAndSet 正是做这个检查，在 set 前，先比较 prev 与当前值</span></span>
<span class="line"><span style="color:#6a737d">            - 不一致了，next 作废，返回 false 表示失败</span></span>
<span class="line"><span style="color:#6a737d">            比如，别的线程已经做了减法，当前值已经被减成了 990</span></span>
<span class="line"><span style="color:#6a737d">            那么本线程的这次 990 就作废了，进入 while 下次循环重试</span></span>
<span class="line"><span style="color:#6a737d">            - 一致，以 next 设置为新值，返回 true 表示成功</span></span>
<span class="line"><span style="color:#6a737d">            */</span></span>
<span class="line"><span style="color:#e1e4e8">			</span><span style="color:#f97583">if</span><span style="color:#e1e4e8">(balance.</span><span style="color:#b392f0">compareAndSet</span><span style="color:#e1e4e8">(prev, next)) {</span></span>
<span class="line"><span style="color:#e1e4e8">				</span><span style="color:#f97583">break</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">			}</span></span>
<span class="line"><span style="color:#e1e4e8">		}</span></span>
<span class="line"><span style="color:#e1e4e8">	}</span></span>
<span class="line"><span style="color:#e1e4e8">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#d73a49">interface</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Account</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">	Integer </span><span style="color:#6f42c1">getBalance</span><span style="color:#24292e">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">	</span><span style="color:#d73a49">void</span><span style="color:#24292e"> </span><span style="color:#6f42c1">withdraw</span><span style="color:#24292e">(Integer </span><span style="color:#e36209">amount</span><span style="color:#24292e">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6a737d">	/**</span></span>
<span class="line"><span style="color:#6a737d">	 * 方法内会启动 1000 个线程，每个线程做 -10 元 的操作     * 如果初始余额为 10000 那么正确的结果应当是 0</span></span>
<span class="line"><span style="color:#6a737d">	 */</span></span>
<span class="line"><span style="color:#24292e">	</span><span style="color:#d73a49">static</span><span style="color:#24292e"> </span><span style="color:#d73a49">void</span><span style="color:#24292e"> </span><span style="color:#6f42c1">demo</span><span style="color:#24292e">(Account </span><span style="color:#e36209">account</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">		List&lt;</span><span style="color:#d73a49">Thread</span><span style="color:#24292e">&gt; ts </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> ArrayList&lt;&gt;();</span></span>
<span class="line"><span style="color:#24292e">		</span><span style="color:#d73a49">long</span><span style="color:#24292e"> start </span><span style="color:#d73a49">=</span><span style="color:#24292e"> System.</span><span style="color:#6f42c1">nanoTime</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">		</span><span style="color:#d73a49">for</span><span style="color:#24292e"> (</span><span style="color:#d73a49">int</span><span style="color:#24292e"> i </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#005cc5">0</span><span style="color:#24292e">; i </span><span style="color:#d73a49">&lt;</span><span style="color:#24292e"> </span><span style="color:#005cc5">1000</span><span style="color:#24292e">; i</span><span style="color:#d73a49">++</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">			ts.</span><span style="color:#6f42c1">add</span><span style="color:#24292e">(</span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Thread</span><span style="color:#24292e">(() </span><span style="color:#d73a49">-&gt;</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">				account.</span><span style="color:#6f42c1">withdraw</span><span style="color:#24292e">(</span><span style="color:#005cc5">10</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">			}));</span></span>
<span class="line"><span style="color:#24292e">		}</span></span>
<span class="line"><span style="color:#24292e">		ts.</span><span style="color:#6f42c1">forEach</span><span style="color:#24292e">(Thread</span><span style="color:#d73a49">::</span><span style="color:#24292e">start);</span></span>
<span class="line"><span style="color:#24292e">		ts.</span><span style="color:#6f42c1">forEach</span><span style="color:#24292e">(t </span><span style="color:#d73a49">-&gt;</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">			</span><span style="color:#d73a49">try</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">				t.</span><span style="color:#6f42c1">join</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">			} </span><span style="color:#d73a49">catch</span><span style="color:#24292e"> (InterruptedException </span><span style="color:#e36209">e</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">				e.</span><span style="color:#6f42c1">printStackTrace</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">			}</span></span>
<span class="line"><span style="color:#24292e">		});</span></span>
<span class="line"><span style="color:#24292e">		</span><span style="color:#d73a49">long</span><span style="color:#24292e"> end </span><span style="color:#d73a49">=</span><span style="color:#24292e"> System.</span><span style="color:#6f42c1">nanoTime</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">		System.out.</span><span style="color:#6f42c1">println</span><span style="color:#24292e">(account.</span><span style="color:#6f42c1">getBalance</span><span style="color:#24292e">() </span><span style="color:#d73a49">+</span><span style="color:#24292e"> </span><span style="color:#032f62">" cost: "</span><span style="color:#24292e"> </span><span style="color:#d73a49">+</span><span style="color:#24292e"> (end </span><span style="color:#d73a49">-</span><span style="color:#24292e"> start) </span><span style="color:#d73a49">/</span><span style="color:#24292e"> </span><span style="color:#005cc5">1000_000</span><span style="color:#24292e"> </span><span style="color:#d73a49">+</span><span style="color:#24292e"> </span><span style="color:#032f62">" ms"</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">	}</span></span>
<span class="line"><span style="color:#24292e">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6a737d">//线程不安全的做法</span></span>
<span class="line"><span style="color:#d73a49">class</span><span style="color:#24292e"> </span><span style="color:#6f42c1">AccountUnsafe</span><span style="color:#24292e"> </span><span style="color:#d73a49">implements</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Account</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">	</span><span style="color:#d73a49">private</span><span style="color:#24292e"> Integer balance;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">	</span><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#6f42c1">AccountUnsafe</span><span style="color:#24292e">(Integer </span><span style="color:#e36209">balance</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">		</span><span style="color:#005cc5">this</span><span style="color:#24292e">.balance </span><span style="color:#d73a49">=</span><span style="color:#24292e"> balance;</span></span>
<span class="line"><span style="color:#24292e">	}</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">	@</span><span style="color:#d73a49">Override</span></span>
<span class="line"><span style="color:#24292e">	</span><span style="color:#d73a49">public</span><span style="color:#24292e"> Integer </span><span style="color:#6f42c1">getBalance</span><span style="color:#24292e">() {</span></span>
<span class="line"><span style="color:#24292e">		</span><span style="color:#d73a49">return</span><span style="color:#24292e"> </span><span style="color:#005cc5">this</span><span style="color:#24292e">.balance;</span></span>
<span class="line"><span style="color:#24292e">	}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">	@</span><span style="color:#d73a49">Override</span></span>
<span class="line"><span style="color:#24292e">	</span><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">synchronized</span><span style="color:#24292e"> </span><span style="color:#d73a49">void</span><span style="color:#24292e"> </span><span style="color:#6f42c1">withdraw</span><span style="color:#24292e">(Integer </span><span style="color:#e36209">amount</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">		balance </span><span style="color:#d73a49">-=</span><span style="color:#24292e"> amount;</span></span>
<span class="line"><span style="color:#24292e">	}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">	</span><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">static</span><span style="color:#24292e"> </span><span style="color:#d73a49">void</span><span style="color:#24292e"> </span><span style="color:#6f42c1">main</span><span style="color:#24292e">(</span><span style="color:#d73a49">String</span><span style="color:#24292e">[] </span><span style="color:#e36209">args</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">		Account.</span><span style="color:#6f42c1">demo</span><span style="color:#24292e">(</span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">AccountUnsafe</span><span style="color:#24292e">(</span><span style="color:#005cc5">10000</span><span style="color:#24292e">));</span></span>
<span class="line"><span style="color:#24292e">		Account.</span><span style="color:#6f42c1">demo</span><span style="color:#24292e">(</span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">AccountCas</span><span style="color:#24292e">(</span><span style="color:#005cc5">10000</span><span style="color:#24292e">));</span></span>
<span class="line"><span style="color:#24292e">	}</span></span>
<span class="line"><span style="color:#24292e">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6a737d">//线程安全的做法</span></span>
<span class="line"><span style="color:#d73a49">class</span><span style="color:#24292e"> </span><span style="color:#6f42c1">AccountCas</span><span style="color:#24292e"> </span><span style="color:#d73a49">implements</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Account</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">	</span><span style="color:#6a737d">//使用原子整数</span></span>
<span class="line"><span style="color:#24292e">	</span><span style="color:#d73a49">private</span><span style="color:#24292e"> AtomicInteger balance;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">	</span><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#6f42c1">AccountCas</span><span style="color:#24292e">(</span><span style="color:#d73a49">int</span><span style="color:#24292e"> </span><span style="color:#e36209">balance</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">		</span><span style="color:#005cc5">this</span><span style="color:#24292e">.balance </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">AtomicInteger</span><span style="color:#24292e">(balance);</span></span>
<span class="line"><span style="color:#24292e">	}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">	@</span><span style="color:#d73a49">Override</span></span>
<span class="line"><span style="color:#24292e">	</span><span style="color:#d73a49">public</span><span style="color:#24292e"> Integer </span><span style="color:#6f42c1">getBalance</span><span style="color:#24292e">() {</span></span>
<span class="line"><span style="color:#24292e">		</span><span style="color:#6a737d">//得到原子整数的值</span></span>
<span class="line"><span style="color:#24292e">		</span><span style="color:#d73a49">return</span><span style="color:#24292e"> balance.</span><span style="color:#6f42c1">get</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">	}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">	@</span><span style="color:#d73a49">Override</span></span>
<span class="line"><span style="color:#24292e">	</span><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">void</span><span style="color:#24292e"> </span><span style="color:#6f42c1">withdraw</span><span style="color:#24292e">(Integer </span><span style="color:#e36209">amount</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">			</span><span style="color:#6a737d">// 需要不断尝试，直到成功为止</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">while</span><span style="color:#24292e"> (</span><span style="color:#005cc5">true</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#6a737d">// 比如拿到了旧值 1000</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">int</span><span style="color:#24292e"> prev </span><span style="color:#d73a49">=</span><span style="color:#24292e"> balance.</span><span style="color:#6f42c1">get</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#6a737d">// 在这个基础上 1000-10 = 990</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">int</span><span style="color:#24292e"> next </span><span style="color:#d73a49">=</span><span style="color:#24292e"> prev </span><span style="color:#d73a49">-</span><span style="color:#24292e"> amount;</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#6a737d">/*</span></span>
<span class="line"><span style="color:#6a737d">            compareAndSet 正是做这个检查，在 set 前，先比较 prev 与当前值</span></span>
<span class="line"><span style="color:#6a737d">            - 不一致了，next 作废，返回 false 表示失败</span></span>
<span class="line"><span style="color:#6a737d">            比如，别的线程已经做了减法，当前值已经被减成了 990</span></span>
<span class="line"><span style="color:#6a737d">            那么本线程的这次 990 就作废了，进入 while 下次循环重试</span></span>
<span class="line"><span style="color:#6a737d">            - 一致，以 next 设置为新值，返回 true 表示成功</span></span>
<span class="line"><span style="color:#6a737d">            */</span></span>
<span class="line"><span style="color:#24292e">			</span><span style="color:#d73a49">if</span><span style="color:#24292e">(balance.</span><span style="color:#6f42c1">compareAndSet</span><span style="color:#24292e">(prev, next)) {</span></span>
<span class="line"><span style="color:#24292e">				</span><span style="color:#d73a49">break</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">			}</span></span>
<span class="line"><span style="color:#24292e">		}</span></span>
<span class="line"><span style="color:#24292e">	}</span></span>
<span class="line"><span style="color:#24292e">}</span></span></code></pre></div><h3 id="_2、cas与volatile" tabindex="-1">2、CAS与volatile <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20intermediate%20level#_2、cas与volatile" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h3><p>前面看到的 AtomicInteger 的解决方法，内部并没有用锁来保护共享变量的线程安全。那么它是如何实现的呢？</p><p>其中的<strong>关键是 compareAndSwap</strong>（比较并设置值），它的<strong>简称就是 CAS</strong> （也有 Compare And Swap 的说法），它必须是<strong>原子操作</strong>。</p><figure><img src="https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/20200608145914.png" alt="img" loading="lazy" decoding="async"></figure><h4 id="工作流程" tabindex="-1"><strong>工作流程</strong> <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20intermediate%20level#工作流程" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h4><ul><li>当一个线程要去修改Account对象中的值时，先获取值pre（调用get方法），然后再将其设置为新的值next（调用cas方法）。在调用cas方法时，会将pre与Account中的余额进行比较。<ul><li>如果<strong>两者相等</strong>，就说明该值还未被其他线程修改，此时便可以进行修改操作。</li><li>如果<strong>两者不相等</strong>，就不设置值，重新获取值pre（调用get方法），然后再将其设置为新的值next（调用cas方法），直到修改成功为止。</li></ul></li></ul><p><strong>注意</strong></p><ul><li>其实 CAS 的底层是 <strong>lock cmpxchg</strong> 指令（X86 架构），在单核 CPU 和多核 CPU 下都能够保证【比较-交换】的<strong>原子性</strong>。</li><li>在多核状态下，某个核执行到带 lock 的指令时，CPU 会让总线锁住，当这个核把此指令执行完毕，再开启总线。这个过程中不会被线程的调度机制所打断，保证了多个线程对内存操作的准确性，是原子的。</li></ul><h4 id="volatile" tabindex="-1">volatile <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20intermediate%20level#volatile" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h4><p>获取共享变量时，为了保证该变量的<strong>可见性</strong>，需要使用 <strong>volatile</strong> 修饰。 它可以用来修饰成员变量和静态成员变量，他可以避免线程从自己的工作缓存中查找变量的值，必须到<strong>主存中获取</strong> 它的值，线程操作 volatile 变量都是直接操作主存。即一个线程对 volatile 变量的修改，对另一个线程可见。</p><p><strong>注意</strong></p><blockquote><p>volatile 仅仅保证了共享变量的可见性，让其它线程能够看到新值，但不能解决指令交错问题（不能保证原子性）</p></blockquote><p><strong>CAS 必须借助 volatile</strong> 才能读取到共享变量的新值来实现【比较并交换】的效果</p><h4 id="为什么无锁效率高" tabindex="-1"><strong>为什么无锁效率高</strong> <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20intermediate%20level#为什么无锁效率高" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h4><ul><li>无锁情况下，即使重试失败，线程始终在高速运行，没有停歇，而 synchronized 会让线程在没有获得锁的时候，发生上下文切换，进入阻塞。打个比喻</li><li>线程就好像高速跑道上的赛车，高速运行时，速度超快，一旦发生上下文切换，就好比赛车要减速、熄火，等被唤醒又得重新打火、启动、加速... 恢复到高速运行，代价比较大</li><li>但无锁情况下，因为线程要保持运行，需要额外 CPU 的支持，CPU 在这里就好比高速跑道，没有额外的跑道，线程想高速运行也无从谈起，虽然不会进入阻塞，但由于没有分到时间片，仍然会进入可运行状态，还是会导致上下文切换。（超过了CPU核心数也就没有了额外的跑道了，运行也运行不了，只能上下文切换，所以<strong>在线程数小于CPU核心数时用CAS是非常合适的</strong>）</li></ul><figure><img src="https://jsd.cdn.zzko.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230714173524349.png" alt="image-20230714173524349" loading="lazy" decoding="async"></figure><h4 id="效率问题" tabindex="-1">效率问题 <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20intermediate%20level#效率问题" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h4><p>一般情况下，使用无锁比使用加锁的<strong>效率更高。</strong></p><figure><img src="https://jsd.cdn.zzko.cn/gh/imLKlauS/blog-picture@main/blogs/20200608145931.png" alt="img" loading="lazy" decoding="async"></figure><p><strong>原因</strong></p><h4 id="cas特点" tabindex="-1">CAS特点 <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20intermediate%20level#cas特点" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h4><p>结合 CAS 和 volatile 可以实现<strong>无锁并发</strong>，适用于<strong>线程数少、多核 CPU</strong> 的场景下。</p><ul><li><p>CAS 是基于<strong>乐观锁</strong>的思想：乐观的估计，不怕别的线程来修改共享变量，就算改了也没关系，我吃亏点再重试呗。</p></li><li><p>synchronized 是基于悲观锁的思想：悲观的估计，得防着其它线程来修改共享变量，我上了锁你们都别想改，我改完了解开锁，你们才有机会。</p></li><li><p>CAS 体现的是</p><p>无锁并发、无阻塞并发</p><p>，请仔细体会这两句话的意思</p><ul><li>因为没有使用 synchronized，所以线程不会陷入阻塞，这是效率提升的因素之一</li><li>但如果竞争激烈，可以想到重试必然频繁发生，反而效率会受影响</li></ul></li></ul><h3 id="_3、原子整数" tabindex="-1">3、原子整数 <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20intermediate%20level#_3、原子整数" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h3><p>J.U.C 并发包提供了</p><ul><li>AtomicBoolean</li><li>AtomicInteger</li><li>AtomicLong</li></ul><p><strong>以 AtomicInteger 为例</strong></p><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8">AtomicInteger i </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">AtomicInteger</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8"> </span></span>
<span class="line"><span style="color:#6a737d">// 获取并自增（i = 0, 结果 i = 1, 返回 0），类似于 i++ System.out.println(i.getAndIncrement());</span></span>
<span class="line"><span style="color:#e1e4e8"> </span></span>
<span class="line"><span style="color:#6a737d">// 自增并获取（i = 1, 结果 i = 2, 返回 2），类似于 ++i System.out.println(i.incrementAndGet());</span></span>
<span class="line"><span style="color:#e1e4e8"> </span></span>
<span class="line"><span style="color:#6a737d">// 自减并获取（i = 2, 结果 i = 1, 返回 1），类似于 --i System.out.println(i.decrementAndGet());</span></span>
<span class="line"><span style="color:#e1e4e8"> </span></span>
<span class="line"><span style="color:#6a737d">// 获取并自减（i = 1, 结果 i = 0, 返回 1），类似于 i--</span></span>
<span class="line"><span style="color:#e1e4e8">System.out.</span><span style="color:#b392f0">println</span><span style="color:#e1e4e8">(i.</span><span style="color:#b392f0">getAndDecrement</span><span style="color:#e1e4e8">());</span></span>
<span class="line"><span style="color:#e1e4e8"> </span></span>
<span class="line"><span style="color:#6a737d">// 获取并加值（i = 0, 结果 i = 5, 返回 0） </span></span>
<span class="line"><span style="color:#e1e4e8">System.out.</span><span style="color:#b392f0">println</span><span style="color:#e1e4e8">(i.</span><span style="color:#b392f0">getAndAdd</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">5</span><span style="color:#e1e4e8">));</span></span>
<span class="line"><span style="color:#e1e4e8"> </span></span>
<span class="line"><span style="color:#6a737d">// 加值并获取（i = 5, 结果 i = 0, 返回 0） </span></span>
<span class="line"><span style="color:#e1e4e8">System.out.</span><span style="color:#b392f0">println</span><span style="color:#e1e4e8">(i.</span><span style="color:#b392f0">addAndGet</span><span style="color:#e1e4e8">(</span><span style="color:#f97583">-</span><span style="color:#79b8ff">5</span><span style="color:#e1e4e8">));</span></span>
<span class="line"><span style="color:#e1e4e8"> </span></span>
<span class="line"><span style="color:#6a737d">// 获取并更新（i = 0, p 为 i 的当前值, 结果 i = -2, 返回 0） </span></span>
<span class="line"><span style="color:#6a737d">// 其中函数中的操作能保证原子，但函数需要无副作用 </span></span>
<span class="line"><span style="color:#e1e4e8">System.out.</span><span style="color:#b392f0">println</span><span style="color:#e1e4e8">(i.</span><span style="color:#b392f0">getAndUpdate</span><span style="color:#e1e4e8">(p </span><span style="color:#f97583">-&gt;</span><span style="color:#e1e4e8"> p </span><span style="color:#f97583">-</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">2</span><span style="color:#e1e4e8">));</span></span>
<span class="line"><span style="color:#e1e4e8"> </span></span>
<span class="line"><span style="color:#6a737d">// 更新并获取（i = -2, p 为 i 的当前值, 结果 i = 0, 返回 0）</span></span>
<span class="line"><span style="color:#6a737d">// 其中函数中的操作能保证原子，但函数需要无副作用 </span></span>
<span class="line"><span style="color:#e1e4e8">System.out.</span><span style="color:#b392f0">println</span><span style="color:#e1e4e8">(i.</span><span style="color:#b392f0">updateAndGet</span><span style="color:#e1e4e8">(p </span><span style="color:#f97583">-&gt;</span><span style="color:#e1e4e8"> p </span><span style="color:#f97583">+</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">2</span><span style="color:#e1e4e8">));</span></span>
<span class="line"><span style="color:#e1e4e8"> </span></span>
<span class="line"><span style="color:#6a737d">// 获取并计算（i = 0, p 为 i 的当前值, x 为参数1, 结果 i = 10, 返回 0） </span></span>
<span class="line"><span style="color:#6a737d">// 其中函数中的操作能保证原子，但函数需要无副作用 // getAndUpdate 如果在 lambda 中引用了外部的局部变量，要保证该局部变量是 final 的 </span></span>
<span class="line"><span style="color:#6a737d">// getAndAccumulate 可以通过 参数1 来引用外部的局部变量，但因为其不在 lambda 中因此不必是 </span></span>
<span class="line"><span style="color:#f97583">final</span><span style="color:#e1e4e8"> System.out.</span><span style="color:#b392f0">println</span><span style="color:#e1e4e8">(i.</span><span style="color:#b392f0">getAndAccumulate</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">10</span><span style="color:#e1e4e8">, (p, x) </span><span style="color:#f97583">-&gt;</span><span style="color:#e1e4e8"> p </span><span style="color:#f97583">+</span><span style="color:#e1e4e8"> x));</span></span>
<span class="line"><span style="color:#e1e4e8"> </span></span>
<span class="line"><span style="color:#6a737d">// 计算并获取（i = 10, p 为 i 的当前值, x 为参数1, 结果 i = 0, 返回 0） </span></span>
<span class="line"><span style="color:#6a737d">// 其中函数中的操作能保证原子，但函数需要无副作用</span></span>
<span class="line"><span style="color:#e1e4e8">System.out.</span><span style="color:#b392f0">println</span><span style="color:#e1e4e8">(i.</span><span style="color:#b392f0">accumulateAndGet</span><span style="color:#e1e4e8">(</span><span style="color:#f97583">-</span><span style="color:#79b8ff">10</span><span style="color:#e1e4e8">, (p, x) </span><span style="color:#f97583">-&gt;</span><span style="color:#e1e4e8"> p </span><span style="color:#f97583">+</span><span style="color:#e1e4e8"> x));</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e">AtomicInteger i </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">AtomicInteger</span><span style="color:#24292e">(</span><span style="color:#005cc5">0</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e"> </span></span>
<span class="line"><span style="color:#6a737d">// 获取并自增（i = 0, 结果 i = 1, 返回 0），类似于 i++ System.out.println(i.getAndIncrement());</span></span>
<span class="line"><span style="color:#24292e"> </span></span>
<span class="line"><span style="color:#6a737d">// 自增并获取（i = 1, 结果 i = 2, 返回 2），类似于 ++i System.out.println(i.incrementAndGet());</span></span>
<span class="line"><span style="color:#24292e"> </span></span>
<span class="line"><span style="color:#6a737d">// 自减并获取（i = 2, 结果 i = 1, 返回 1），类似于 --i System.out.println(i.decrementAndGet());</span></span>
<span class="line"><span style="color:#24292e"> </span></span>
<span class="line"><span style="color:#6a737d">// 获取并自减（i = 1, 结果 i = 0, 返回 1），类似于 i--</span></span>
<span class="line"><span style="color:#24292e">System.out.</span><span style="color:#6f42c1">println</span><span style="color:#24292e">(i.</span><span style="color:#6f42c1">getAndDecrement</span><span style="color:#24292e">());</span></span>
<span class="line"><span style="color:#24292e"> </span></span>
<span class="line"><span style="color:#6a737d">// 获取并加值（i = 0, 结果 i = 5, 返回 0） </span></span>
<span class="line"><span style="color:#24292e">System.out.</span><span style="color:#6f42c1">println</span><span style="color:#24292e">(i.</span><span style="color:#6f42c1">getAndAdd</span><span style="color:#24292e">(</span><span style="color:#005cc5">5</span><span style="color:#24292e">));</span></span>
<span class="line"><span style="color:#24292e"> </span></span>
<span class="line"><span style="color:#6a737d">// 加值并获取（i = 5, 结果 i = 0, 返回 0） </span></span>
<span class="line"><span style="color:#24292e">System.out.</span><span style="color:#6f42c1">println</span><span style="color:#24292e">(i.</span><span style="color:#6f42c1">addAndGet</span><span style="color:#24292e">(</span><span style="color:#d73a49">-</span><span style="color:#005cc5">5</span><span style="color:#24292e">));</span></span>
<span class="line"><span style="color:#24292e"> </span></span>
<span class="line"><span style="color:#6a737d">// 获取并更新（i = 0, p 为 i 的当前值, 结果 i = -2, 返回 0） </span></span>
<span class="line"><span style="color:#6a737d">// 其中函数中的操作能保证原子，但函数需要无副作用 </span></span>
<span class="line"><span style="color:#24292e">System.out.</span><span style="color:#6f42c1">println</span><span style="color:#24292e">(i.</span><span style="color:#6f42c1">getAndUpdate</span><span style="color:#24292e">(p </span><span style="color:#d73a49">-&gt;</span><span style="color:#24292e"> p </span><span style="color:#d73a49">-</span><span style="color:#24292e"> </span><span style="color:#005cc5">2</span><span style="color:#24292e">));</span></span>
<span class="line"><span style="color:#24292e"> </span></span>
<span class="line"><span style="color:#6a737d">// 更新并获取（i = -2, p 为 i 的当前值, 结果 i = 0, 返回 0）</span></span>
<span class="line"><span style="color:#6a737d">// 其中函数中的操作能保证原子，但函数需要无副作用 </span></span>
<span class="line"><span style="color:#24292e">System.out.</span><span style="color:#6f42c1">println</span><span style="color:#24292e">(i.</span><span style="color:#6f42c1">updateAndGet</span><span style="color:#24292e">(p </span><span style="color:#d73a49">-&gt;</span><span style="color:#24292e"> p </span><span style="color:#d73a49">+</span><span style="color:#24292e"> </span><span style="color:#005cc5">2</span><span style="color:#24292e">));</span></span>
<span class="line"><span style="color:#24292e"> </span></span>
<span class="line"><span style="color:#6a737d">// 获取并计算（i = 0, p 为 i 的当前值, x 为参数1, 结果 i = 10, 返回 0） </span></span>
<span class="line"><span style="color:#6a737d">// 其中函数中的操作能保证原子，但函数需要无副作用 // getAndUpdate 如果在 lambda 中引用了外部的局部变量，要保证该局部变量是 final 的 </span></span>
<span class="line"><span style="color:#6a737d">// getAndAccumulate 可以通过 参数1 来引用外部的局部变量，但因为其不在 lambda 中因此不必是 </span></span>
<span class="line"><span style="color:#d73a49">final</span><span style="color:#24292e"> System.out.</span><span style="color:#6f42c1">println</span><span style="color:#24292e">(i.</span><span style="color:#6f42c1">getAndAccumulate</span><span style="color:#24292e">(</span><span style="color:#005cc5">10</span><span style="color:#24292e">, (p, x) </span><span style="color:#d73a49">-&gt;</span><span style="color:#24292e"> p </span><span style="color:#d73a49">+</span><span style="color:#24292e"> x));</span></span>
<span class="line"><span style="color:#24292e"> </span></span>
<span class="line"><span style="color:#6a737d">// 计算并获取（i = 10, p 为 i 的当前值, x 为参数1, 结果 i = 0, 返回 0） </span></span>
<span class="line"><span style="color:#6a737d">// 其中函数中的操作能保证原子，但函数需要无副作用</span></span>
<span class="line"><span style="color:#24292e">System.out.</span><span style="color:#6f42c1">println</span><span style="color:#24292e">(i.</span><span style="color:#6f42c1">accumulateAndGet</span><span style="color:#24292e">(</span><span style="color:#d73a49">-</span><span style="color:#005cc5">10</span><span style="color:#24292e">, (p, x) </span><span style="color:#d73a49">-&gt;</span><span style="color:#24292e"> p </span><span style="color:#d73a49">+</span><span style="color:#24292e"> x));</span></span></code></pre></div><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">static</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">void</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">main</span><span style="color:#e1e4e8">(</span><span style="color:#f97583">String</span><span style="color:#e1e4e8">[] args) {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">        AtomicInteger i </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">AtomicInteger</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">5</span><span style="color:#e1e4e8">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#6a737d">/*System.out.println(i.incrementAndGet()); // ++i   1</span></span>
<span class="line"><span style="color:#6a737d">        System.out.println(i.getAndIncrement()); // i++   2</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6a737d">        System.out.println(i.getAndAdd(5)); // 2 , 7</span></span>
<span class="line"><span style="color:#6a737d">        System.out.println(i.addAndGet(5)); // 12, 12*/</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#6a737d">//             读取到    设置值</span></span>
<span class="line"><span style="color:#6a737d">//        i.updateAndGet(value -&gt; value * 10);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">        System.out.</span><span style="color:#b392f0">println</span><span style="color:#e1e4e8">(</span><span style="color:#b392f0">updateAndGet</span><span style="color:#e1e4e8">(i, p </span><span style="color:#f97583">-&gt;</span><span style="color:#e1e4e8"> p </span><span style="color:#f97583">/</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">2</span><span style="color:#e1e4e8">));</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6a737d">//        i.getAndUpdate()</span></span>
<span class="line"><span style="color:#e1e4e8">        System.out.</span><span style="color:#b392f0">println</span><span style="color:#e1e4e8">(i.</span><span style="color:#b392f0">get</span><span style="color:#e1e4e8">());</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">static</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">updateAndGet</span><span style="color:#e1e4e8">(AtomicInteger i, IntUnaryOperator operator) {</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">while</span><span style="color:#e1e4e8"> (</span><span style="color:#79b8ff">true</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> prev </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> i.</span><span style="color:#b392f0">get</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> next </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> operator.</span><span style="color:#b392f0">applyAsInt</span><span style="color:#e1e4e8">(prev);</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (i.</span><span style="color:#b392f0">compareAndSet</span><span style="color:#e1e4e8">(prev, next)) {</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> next;</span></span>
<span class="line"><span style="color:#e1e4e8">            }</span></span>
<span class="line"><span style="color:#e1e4e8">        }</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">	</span><span style="color:#6a737d">//内部实现</span></span>
<span class="line"><span style="color:#e1e4e8">	</span><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">final</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">updateAndGet</span><span style="color:#e1e4e8">(IntUnaryOperator updateFunction) {</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> prev, next;</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">do</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">            prev </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">get</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">            next </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> updateFunction.</span><span style="color:#b392f0">applyAsInt</span><span style="color:#e1e4e8">(prev);</span></span>
<span class="line"><span style="color:#e1e4e8">        } </span><span style="color:#f97583">while</span><span style="color:#e1e4e8"> (</span><span style="color:#f97583">!</span><span style="color:#b392f0">compareAndSet</span><span style="color:#e1e4e8">(prev, next));</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> next;</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">static</span><span style="color:#24292e"> </span><span style="color:#d73a49">void</span><span style="color:#24292e"> </span><span style="color:#6f42c1">main</span><span style="color:#24292e">(</span><span style="color:#d73a49">String</span><span style="color:#24292e">[] args) {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">        AtomicInteger i </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">AtomicInteger</span><span style="color:#24292e">(</span><span style="color:#005cc5">5</span><span style="color:#24292e">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6a737d">/*System.out.println(i.incrementAndGet()); // ++i   1</span></span>
<span class="line"><span style="color:#6a737d">        System.out.println(i.getAndIncrement()); // i++   2</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6a737d">        System.out.println(i.getAndAdd(5)); // 2 , 7</span></span>
<span class="line"><span style="color:#6a737d">        System.out.println(i.addAndGet(5)); // 12, 12*/</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6a737d">//             读取到    设置值</span></span>
<span class="line"><span style="color:#6a737d">//        i.updateAndGet(value -&gt; value * 10);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">        System.out.</span><span style="color:#6f42c1">println</span><span style="color:#24292e">(</span><span style="color:#6f42c1">updateAndGet</span><span style="color:#24292e">(i, p </span><span style="color:#d73a49">-&gt;</span><span style="color:#24292e"> p </span><span style="color:#d73a49">/</span><span style="color:#24292e"> </span><span style="color:#005cc5">2</span><span style="color:#24292e">));</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6a737d">//        i.getAndUpdate()</span></span>
<span class="line"><span style="color:#24292e">        System.out.</span><span style="color:#6f42c1">println</span><span style="color:#24292e">(i.</span><span style="color:#6f42c1">get</span><span style="color:#24292e">());</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">static</span><span style="color:#24292e"> </span><span style="color:#d73a49">int</span><span style="color:#24292e"> </span><span style="color:#6f42c1">updateAndGet</span><span style="color:#24292e">(AtomicInteger i, IntUnaryOperator operator) {</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">while</span><span style="color:#24292e"> (</span><span style="color:#005cc5">true</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">int</span><span style="color:#24292e"> prev </span><span style="color:#d73a49">=</span><span style="color:#24292e"> i.</span><span style="color:#6f42c1">get</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">int</span><span style="color:#24292e"> next </span><span style="color:#d73a49">=</span><span style="color:#24292e"> operator.</span><span style="color:#6f42c1">applyAsInt</span><span style="color:#24292e">(prev);</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (i.</span><span style="color:#6f42c1">compareAndSet</span><span style="color:#24292e">(prev, next)) {</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#d73a49">return</span><span style="color:#24292e"> next;</span></span>
<span class="line"><span style="color:#24292e">            }</span></span>
<span class="line"><span style="color:#24292e">        }</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">	</span><span style="color:#6a737d">//内部实现</span></span>
<span class="line"><span style="color:#24292e">	</span><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">final</span><span style="color:#24292e"> </span><span style="color:#d73a49">int</span><span style="color:#24292e"> </span><span style="color:#6f42c1">updateAndGet</span><span style="color:#24292e">(IntUnaryOperator updateFunction) {</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">int</span><span style="color:#24292e"> prev, next;</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">do</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">            prev </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#6f42c1">get</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">            next </span><span style="color:#d73a49">=</span><span style="color:#24292e"> updateFunction.</span><span style="color:#6f42c1">applyAsInt</span><span style="color:#24292e">(prev);</span></span>
<span class="line"><span style="color:#24292e">        } </span><span style="color:#d73a49">while</span><span style="color:#24292e"> (</span><span style="color:#d73a49">!</span><span style="color:#6f42c1">compareAndSet</span><span style="color:#24292e">(prev, next));</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">return</span><span style="color:#24292e"> next;</span></span>
<span class="line"><span style="color:#24292e">    }</span></span></code></pre></div><h3 id="_4、原子引用" tabindex="-1">4、原子引用 <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20intermediate%20level#_4、原子引用" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h3><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">interface</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">DecimalAccount</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">	BigDecimal </span><span style="color:#b392f0">getBalance</span><span style="color:#e1e4e8">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">	</span><span style="color:#f97583">void</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">withdraw</span><span style="color:#e1e4e8">(BigDecimal </span><span style="color:#ffab70">amount</span><span style="color:#e1e4e8">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6a737d">	/**</span></span>
<span class="line"><span style="color:#6a737d">	 * 方法内会启动 1000 个线程，每个线程做 -10 元 的操作    </span></span>
<span class="line"><span style="color:#6a737d">     * 如果初始余额为 10000 那么正确的结果应当是 0</span></span>
<span class="line"><span style="color:#6a737d">	 */</span></span>
<span class="line"><span style="color:#e1e4e8">	</span><span style="color:#f97583">static</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">void</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">demo</span><span style="color:#e1e4e8">(DecimalAccountImpl </span><span style="color:#ffab70">account</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">		List&lt;</span><span style="color:#f97583">Thread</span><span style="color:#e1e4e8">&gt; ts </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> ArrayList&lt;&gt;();</span></span>
<span class="line"><span style="color:#e1e4e8">		</span><span style="color:#f97583">long</span><span style="color:#e1e4e8"> start </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> System.</span><span style="color:#b392f0">nanoTime</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">		</span><span style="color:#f97583">for</span><span style="color:#e1e4e8"> (</span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> i </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8">; i </span><span style="color:#f97583">&lt;</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">1000</span><span style="color:#e1e4e8">; i</span><span style="color:#f97583">++</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">			ts.</span><span style="color:#b392f0">add</span><span style="color:#e1e4e8">(</span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Thread</span><span style="color:#e1e4e8">(() </span><span style="color:#f97583">-&gt;</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">				account.</span><span style="color:#b392f0">withdraw</span><span style="color:#e1e4e8">(BigDecimal.TEN);</span></span>
<span class="line"><span style="color:#e1e4e8">			}));</span></span>
<span class="line"><span style="color:#e1e4e8">		}</span></span>
<span class="line"><span style="color:#e1e4e8">		ts.</span><span style="color:#b392f0">forEach</span><span style="color:#e1e4e8">(Thread</span><span style="color:#f97583">::</span><span style="color:#e1e4e8">start);</span></span>
<span class="line"><span style="color:#e1e4e8">		ts.</span><span style="color:#b392f0">forEach</span><span style="color:#e1e4e8">(t </span><span style="color:#f97583">-&gt;</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">			</span><span style="color:#f97583">try</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">				t.</span><span style="color:#b392f0">join</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">			} </span><span style="color:#f97583">catch</span><span style="color:#e1e4e8"> (InterruptedException </span><span style="color:#ffab70">e</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">				e.</span><span style="color:#b392f0">printStackTrace</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">			}</span></span>
<span class="line"><span style="color:#e1e4e8">		});</span></span>
<span class="line"><span style="color:#e1e4e8">		</span><span style="color:#f97583">long</span><span style="color:#e1e4e8"> end </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> System.</span><span style="color:#b392f0">nanoTime</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">		System.out.</span><span style="color:#b392f0">println</span><span style="color:#e1e4e8">(account.</span><span style="color:#b392f0">getBalance</span><span style="color:#e1e4e8">() </span><span style="color:#f97583">+</span><span style="color:#e1e4e8"> </span><span style="color:#9ecbff">" cost: "</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">+</span><span style="color:#e1e4e8"> (end </span><span style="color:#f97583">-</span><span style="color:#e1e4e8"> start) </span><span style="color:#f97583">/</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">1000_000</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">+</span><span style="color:#e1e4e8"> </span><span style="color:#9ecbff">" ms"</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">	}</span></span>
<span class="line"><span style="color:#e1e4e8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#f97583">class</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">DecimalAccountImpl</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">implements</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">DecimalAccount</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">	</span><span style="color:#6a737d">//原子引用，泛型类型为小数类型</span></span>
<span class="line"><span style="color:#e1e4e8">	AtomicReference&lt;</span><span style="color:#f97583">BigDecimal</span><span style="color:#e1e4e8">&gt; balance;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">	</span><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">DecimalAccountImpl</span><span style="color:#e1e4e8">(BigDecimal </span><span style="color:#ffab70">balance</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">		</span><span style="color:#79b8ff">this</span><span style="color:#e1e4e8">.balance </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> AtomicReference&lt;</span><span style="color:#f97583">BigDecimal</span><span style="color:#e1e4e8">&gt;(balance);</span></span>
<span class="line"><span style="color:#e1e4e8">	}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">	@</span><span style="color:#f97583">Override</span></span>
<span class="line"><span style="color:#e1e4e8">	</span><span style="color:#f97583">public</span><span style="color:#e1e4e8"> BigDecimal </span><span style="color:#b392f0">getBalance</span><span style="color:#e1e4e8">() {</span></span>
<span class="line"><span style="color:#e1e4e8">		</span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> balance.</span><span style="color:#b392f0">get</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">	}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">	@</span><span style="color:#f97583">Override</span></span>
<span class="line"><span style="color:#e1e4e8">	</span><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">void</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">withdraw</span><span style="color:#e1e4e8">(BigDecimal </span><span style="color:#ffab70">amount</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">		</span><span style="color:#f97583">while</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">true</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">			BigDecimal pre </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> balance.</span><span style="color:#b392f0">get</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">			BigDecimal next </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> pre.</span><span style="color:#b392f0">subtract</span><span style="color:#e1e4e8">(amount);</span></span>
<span class="line"><span style="color:#e1e4e8">			</span><span style="color:#f97583">if</span><span style="color:#e1e4e8">(balance.</span><span style="color:#b392f0">compareAndSet</span><span style="color:#e1e4e8">(pre, next)) {</span></span>
<span class="line"><span style="color:#e1e4e8">				</span><span style="color:#f97583">break</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">			}</span></span>
<span class="line"><span style="color:#e1e4e8">		}</span></span>
<span class="line"><span style="color:#e1e4e8">	}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">	</span><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">static</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">void</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">main</span><span style="color:#e1e4e8">(</span><span style="color:#f97583">String</span><span style="color:#e1e4e8">[] </span><span style="color:#ffab70">args</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">		DecimalAccount.</span><span style="color:#b392f0">demo</span><span style="color:#e1e4e8">(</span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">DecimalAccountImpl</span><span style="color:#e1e4e8">(</span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">BigDecimal</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"10000"</span><span style="color:#e1e4e8">)));</span></span>
<span class="line"><span style="color:#e1e4e8">	}</span></span>
<span class="line"><span style="color:#e1e4e8">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">interface</span><span style="color:#24292e"> </span><span style="color:#6f42c1">DecimalAccount</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">	BigDecimal </span><span style="color:#6f42c1">getBalance</span><span style="color:#24292e">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">	</span><span style="color:#d73a49">void</span><span style="color:#24292e"> </span><span style="color:#6f42c1">withdraw</span><span style="color:#24292e">(BigDecimal </span><span style="color:#e36209">amount</span><span style="color:#24292e">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6a737d">	/**</span></span>
<span class="line"><span style="color:#6a737d">	 * 方法内会启动 1000 个线程，每个线程做 -10 元 的操作    </span></span>
<span class="line"><span style="color:#6a737d">     * 如果初始余额为 10000 那么正确的结果应当是 0</span></span>
<span class="line"><span style="color:#6a737d">	 */</span></span>
<span class="line"><span style="color:#24292e">	</span><span style="color:#d73a49">static</span><span style="color:#24292e"> </span><span style="color:#d73a49">void</span><span style="color:#24292e"> </span><span style="color:#6f42c1">demo</span><span style="color:#24292e">(DecimalAccountImpl </span><span style="color:#e36209">account</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">		List&lt;</span><span style="color:#d73a49">Thread</span><span style="color:#24292e">&gt; ts </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> ArrayList&lt;&gt;();</span></span>
<span class="line"><span style="color:#24292e">		</span><span style="color:#d73a49">long</span><span style="color:#24292e"> start </span><span style="color:#d73a49">=</span><span style="color:#24292e"> System.</span><span style="color:#6f42c1">nanoTime</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">		</span><span style="color:#d73a49">for</span><span style="color:#24292e"> (</span><span style="color:#d73a49">int</span><span style="color:#24292e"> i </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#005cc5">0</span><span style="color:#24292e">; i </span><span style="color:#d73a49">&lt;</span><span style="color:#24292e"> </span><span style="color:#005cc5">1000</span><span style="color:#24292e">; i</span><span style="color:#d73a49">++</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">			ts.</span><span style="color:#6f42c1">add</span><span style="color:#24292e">(</span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Thread</span><span style="color:#24292e">(() </span><span style="color:#d73a49">-&gt;</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">				account.</span><span style="color:#6f42c1">withdraw</span><span style="color:#24292e">(BigDecimal.TEN);</span></span>
<span class="line"><span style="color:#24292e">			}));</span></span>
<span class="line"><span style="color:#24292e">		}</span></span>
<span class="line"><span style="color:#24292e">		ts.</span><span style="color:#6f42c1">forEach</span><span style="color:#24292e">(Thread</span><span style="color:#d73a49">::</span><span style="color:#24292e">start);</span></span>
<span class="line"><span style="color:#24292e">		ts.</span><span style="color:#6f42c1">forEach</span><span style="color:#24292e">(t </span><span style="color:#d73a49">-&gt;</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">			</span><span style="color:#d73a49">try</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">				t.</span><span style="color:#6f42c1">join</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">			} </span><span style="color:#d73a49">catch</span><span style="color:#24292e"> (InterruptedException </span><span style="color:#e36209">e</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">				e.</span><span style="color:#6f42c1">printStackTrace</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">			}</span></span>
<span class="line"><span style="color:#24292e">		});</span></span>
<span class="line"><span style="color:#24292e">		</span><span style="color:#d73a49">long</span><span style="color:#24292e"> end </span><span style="color:#d73a49">=</span><span style="color:#24292e"> System.</span><span style="color:#6f42c1">nanoTime</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">		System.out.</span><span style="color:#6f42c1">println</span><span style="color:#24292e">(account.</span><span style="color:#6f42c1">getBalance</span><span style="color:#24292e">() </span><span style="color:#d73a49">+</span><span style="color:#24292e"> </span><span style="color:#032f62">" cost: "</span><span style="color:#24292e"> </span><span style="color:#d73a49">+</span><span style="color:#24292e"> (end </span><span style="color:#d73a49">-</span><span style="color:#24292e"> start) </span><span style="color:#d73a49">/</span><span style="color:#24292e"> </span><span style="color:#005cc5">1000_000</span><span style="color:#24292e"> </span><span style="color:#d73a49">+</span><span style="color:#24292e"> </span><span style="color:#032f62">" ms"</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">	}</span></span>
<span class="line"><span style="color:#24292e">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#d73a49">class</span><span style="color:#24292e"> </span><span style="color:#6f42c1">DecimalAccountImpl</span><span style="color:#24292e"> </span><span style="color:#d73a49">implements</span><span style="color:#24292e"> </span><span style="color:#6f42c1">DecimalAccount</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">	</span><span style="color:#6a737d">//原子引用，泛型类型为小数类型</span></span>
<span class="line"><span style="color:#24292e">	AtomicReference&lt;</span><span style="color:#d73a49">BigDecimal</span><span style="color:#24292e">&gt; balance;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">	</span><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#6f42c1">DecimalAccountImpl</span><span style="color:#24292e">(BigDecimal </span><span style="color:#e36209">balance</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">		</span><span style="color:#005cc5">this</span><span style="color:#24292e">.balance </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> AtomicReference&lt;</span><span style="color:#d73a49">BigDecimal</span><span style="color:#24292e">&gt;(balance);</span></span>
<span class="line"><span style="color:#24292e">	}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">	@</span><span style="color:#d73a49">Override</span></span>
<span class="line"><span style="color:#24292e">	</span><span style="color:#d73a49">public</span><span style="color:#24292e"> BigDecimal </span><span style="color:#6f42c1">getBalance</span><span style="color:#24292e">() {</span></span>
<span class="line"><span style="color:#24292e">		</span><span style="color:#d73a49">return</span><span style="color:#24292e"> balance.</span><span style="color:#6f42c1">get</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">	}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">	@</span><span style="color:#d73a49">Override</span></span>
<span class="line"><span style="color:#24292e">	</span><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">void</span><span style="color:#24292e"> </span><span style="color:#6f42c1">withdraw</span><span style="color:#24292e">(BigDecimal </span><span style="color:#e36209">amount</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">		</span><span style="color:#d73a49">while</span><span style="color:#24292e">(</span><span style="color:#005cc5">true</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">			BigDecimal pre </span><span style="color:#d73a49">=</span><span style="color:#24292e"> balance.</span><span style="color:#6f42c1">get</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">			BigDecimal next </span><span style="color:#d73a49">=</span><span style="color:#24292e"> pre.</span><span style="color:#6f42c1">subtract</span><span style="color:#24292e">(amount);</span></span>
<span class="line"><span style="color:#24292e">			</span><span style="color:#d73a49">if</span><span style="color:#24292e">(balance.</span><span style="color:#6f42c1">compareAndSet</span><span style="color:#24292e">(pre, next)) {</span></span>
<span class="line"><span style="color:#24292e">				</span><span style="color:#d73a49">break</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">			}</span></span>
<span class="line"><span style="color:#24292e">		}</span></span>
<span class="line"><span style="color:#24292e">	}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">	</span><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">static</span><span style="color:#24292e"> </span><span style="color:#d73a49">void</span><span style="color:#24292e"> </span><span style="color:#6f42c1">main</span><span style="color:#24292e">(</span><span style="color:#d73a49">String</span><span style="color:#24292e">[] </span><span style="color:#e36209">args</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">		DecimalAccount.</span><span style="color:#6f42c1">demo</span><span style="color:#24292e">(</span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">DecimalAccountImpl</span><span style="color:#24292e">(</span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">BigDecimal</span><span style="color:#24292e">(</span><span style="color:#032f62">"10000"</span><span style="color:#24292e">)));</span></span>
<span class="line"><span style="color:#24292e">	}</span></span>
<span class="line"><span style="color:#24292e">}</span></span></code></pre></div><h3 id="_5、aba问题" tabindex="-1">5、ABA问题 <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20intermediate%20level#_5、aba问题" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h3><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">class</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Demo3</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">	</span><span style="color:#f97583">static</span><span style="color:#e1e4e8"> AtomicReference&lt;</span><span style="color:#f97583">String</span><span style="color:#e1e4e8">&gt; str </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> AtomicReference&lt;&gt;(</span><span style="color:#9ecbff">"A"</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">	</span><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">static</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">void</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">main</span><span style="color:#e1e4e8">(</span><span style="color:#f97583">String</span><span style="color:#e1e4e8">[] </span><span style="color:#ffab70">args</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">		</span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Thread</span><span style="color:#e1e4e8">(() </span><span style="color:#f97583">-&gt;</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">			String pre </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> str.</span><span style="color:#b392f0">get</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">			System.out.</span><span style="color:#b392f0">println</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"change"</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">			</span><span style="color:#f97583">try</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">				</span><span style="color:#b392f0">other</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">			} </span><span style="color:#f97583">catch</span><span style="color:#e1e4e8"> (InterruptedException </span><span style="color:#ffab70">e</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">				e.</span><span style="color:#b392f0">printStackTrace</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">			}</span></span>
<span class="line"><span style="color:#e1e4e8">			</span><span style="color:#f97583">try</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">				Thread.</span><span style="color:#b392f0">sleep</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">1000</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">			} </span><span style="color:#f97583">catch</span><span style="color:#e1e4e8"> (InterruptedException </span><span style="color:#ffab70">e</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">				e.</span><span style="color:#b392f0">printStackTrace</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">			}</span></span>
<span class="line"><span style="color:#e1e4e8">			</span><span style="color:#6a737d">//把str中的A改为C</span></span>
<span class="line"><span style="color:#e1e4e8">			System.out.</span><span style="color:#b392f0">println</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"change A-&gt;C "</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">+</span><span style="color:#e1e4e8"> str.</span><span style="color:#b392f0">compareAndSet</span><span style="color:#e1e4e8">(pre, </span><span style="color:#9ecbff">"C"</span><span style="color:#e1e4e8">));</span></span>
<span class="line"><span style="color:#e1e4e8">		}).</span><span style="color:#b392f0">start</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">	}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">	</span><span style="color:#f97583">static</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">void</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">other</span><span style="color:#e1e4e8">() </span><span style="color:#f97583">throws</span><span style="color:#e1e4e8"> InterruptedException {</span></span>
<span class="line"><span style="color:#e1e4e8">		</span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Thread</span><span style="color:#e1e4e8">(()</span><span style="color:#f97583">-&gt;</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">			System.out.</span><span style="color:#b392f0">println</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"change A-&gt;B "</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">+</span><span style="color:#e1e4e8"> str.</span><span style="color:#b392f0">compareAndSet</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"A"</span><span style="color:#e1e4e8">, </span><span style="color:#9ecbff">"B"</span><span style="color:#e1e4e8">));</span></span>
<span class="line"><span style="color:#e1e4e8">		}).</span><span style="color:#b392f0">start</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">		Thread.</span><span style="color:#b392f0">sleep</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">500</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">		</span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Thread</span><span style="color:#e1e4e8">(()</span><span style="color:#f97583">-&gt;</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">			System.out.</span><span style="color:#b392f0">println</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"change B-&gt;A "</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">+</span><span style="color:#e1e4e8"> str.</span><span style="color:#b392f0">compareAndSet</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"B"</span><span style="color:#e1e4e8">, </span><span style="color:#9ecbff">"A"</span><span style="color:#e1e4e8">));</span></span>
<span class="line"><span style="color:#e1e4e8">		}).</span><span style="color:#b392f0">start</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">	}</span></span>
<span class="line"><span style="color:#e1e4e8">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">class</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Demo3</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">	</span><span style="color:#d73a49">static</span><span style="color:#24292e"> AtomicReference&lt;</span><span style="color:#d73a49">String</span><span style="color:#24292e">&gt; str </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> AtomicReference&lt;&gt;(</span><span style="color:#032f62">"A"</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">	</span><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">static</span><span style="color:#24292e"> </span><span style="color:#d73a49">void</span><span style="color:#24292e"> </span><span style="color:#6f42c1">main</span><span style="color:#24292e">(</span><span style="color:#d73a49">String</span><span style="color:#24292e">[] </span><span style="color:#e36209">args</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">		</span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Thread</span><span style="color:#24292e">(() </span><span style="color:#d73a49">-&gt;</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">			String pre </span><span style="color:#d73a49">=</span><span style="color:#24292e"> str.</span><span style="color:#6f42c1">get</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">			System.out.</span><span style="color:#6f42c1">println</span><span style="color:#24292e">(</span><span style="color:#032f62">"change"</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">			</span><span style="color:#d73a49">try</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">				</span><span style="color:#6f42c1">other</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">			} </span><span style="color:#d73a49">catch</span><span style="color:#24292e"> (InterruptedException </span><span style="color:#e36209">e</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">				e.</span><span style="color:#6f42c1">printStackTrace</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">			}</span></span>
<span class="line"><span style="color:#24292e">			</span><span style="color:#d73a49">try</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">				Thread.</span><span style="color:#6f42c1">sleep</span><span style="color:#24292e">(</span><span style="color:#005cc5">1000</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">			} </span><span style="color:#d73a49">catch</span><span style="color:#24292e"> (InterruptedException </span><span style="color:#e36209">e</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">				e.</span><span style="color:#6f42c1">printStackTrace</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">			}</span></span>
<span class="line"><span style="color:#24292e">			</span><span style="color:#6a737d">//把str中的A改为C</span></span>
<span class="line"><span style="color:#24292e">			System.out.</span><span style="color:#6f42c1">println</span><span style="color:#24292e">(</span><span style="color:#032f62">"change A-&gt;C "</span><span style="color:#24292e"> </span><span style="color:#d73a49">+</span><span style="color:#24292e"> str.</span><span style="color:#6f42c1">compareAndSet</span><span style="color:#24292e">(pre, </span><span style="color:#032f62">"C"</span><span style="color:#24292e">));</span></span>
<span class="line"><span style="color:#24292e">		}).</span><span style="color:#6f42c1">start</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">	}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">	</span><span style="color:#d73a49">static</span><span style="color:#24292e"> </span><span style="color:#d73a49">void</span><span style="color:#24292e"> </span><span style="color:#6f42c1">other</span><span style="color:#24292e">() </span><span style="color:#d73a49">throws</span><span style="color:#24292e"> InterruptedException {</span></span>
<span class="line"><span style="color:#24292e">		</span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Thread</span><span style="color:#24292e">(()</span><span style="color:#d73a49">-&gt;</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">			System.out.</span><span style="color:#6f42c1">println</span><span style="color:#24292e">(</span><span style="color:#032f62">"change A-&gt;B "</span><span style="color:#24292e"> </span><span style="color:#d73a49">+</span><span style="color:#24292e"> str.</span><span style="color:#6f42c1">compareAndSet</span><span style="color:#24292e">(</span><span style="color:#032f62">"A"</span><span style="color:#24292e">, </span><span style="color:#032f62">"B"</span><span style="color:#24292e">));</span></span>
<span class="line"><span style="color:#24292e">		}).</span><span style="color:#6f42c1">start</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">		Thread.</span><span style="color:#6f42c1">sleep</span><span style="color:#24292e">(</span><span style="color:#005cc5">500</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">		</span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Thread</span><span style="color:#24292e">(()</span><span style="color:#d73a49">-&gt;</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">			System.out.</span><span style="color:#6f42c1">println</span><span style="color:#24292e">(</span><span style="color:#032f62">"change B-&gt;A "</span><span style="color:#24292e"> </span><span style="color:#d73a49">+</span><span style="color:#24292e"> str.</span><span style="color:#6f42c1">compareAndSet</span><span style="color:#24292e">(</span><span style="color:#032f62">"B"</span><span style="color:#24292e">, </span><span style="color:#032f62">"A"</span><span style="color:#24292e">));</span></span>
<span class="line"><span style="color:#24292e">		}).</span><span style="color:#6f42c1">start</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">	}</span></span>
<span class="line"><span style="color:#24292e">}</span></span></code></pre></div><figure><img src="https://jsd.cdn.zzko.cn/gh/imLKlauS/blog-picture@main/blogs/20200608145952.png" alt="img" loading="lazy" decoding="async"></figure><p>主线程仅能判断出共享变量的值与初值 A <strong>是否相同</strong>，不能感知到这种从 A 改为 B 又 改回 A 的情况，如果主线程希望： 只要有其它线程【<strong>动过了</strong>】共享变量，那么自己的 <strong>cas 就算失败</strong>，这时，仅比较值是不够的，需要再加一个<strong>版本号</strong></p><h4 id="atomicstampedreference" tabindex="-1"><strong>AtomicStampedReference</strong> <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20intermediate%20level#atomicstampedreference" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h4><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">class</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Demo3</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">	</span><span style="color:#6a737d">//指定版本号</span></span>
<span class="line"><span style="color:#e1e4e8">	</span><span style="color:#f97583">static</span><span style="color:#e1e4e8"> AtomicStampedReference&lt;</span><span style="color:#f97583">String</span><span style="color:#e1e4e8">&gt; str </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> AtomicStampedReference&lt;&gt;(</span><span style="color:#9ecbff">"A"</span><span style="color:#e1e4e8">, </span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">	</span><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">static</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">void</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">main</span><span style="color:#e1e4e8">(</span><span style="color:#f97583">String</span><span style="color:#e1e4e8">[] </span><span style="color:#ffab70">args</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">		</span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Thread</span><span style="color:#e1e4e8">(() </span><span style="color:#f97583">-&gt;</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">			String pre </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> str.</span><span style="color:#b392f0">getReference</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">			</span><span style="color:#6a737d">//获得版本号</span></span>
<span class="line"><span style="color:#e1e4e8">			</span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> stamp </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> str.</span><span style="color:#b392f0">getStamp</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">			System.out.</span><span style="color:#b392f0">println</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"change"</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">			</span><span style="color:#f97583">try</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">				</span><span style="color:#b392f0">other</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">			} </span><span style="color:#f97583">catch</span><span style="color:#e1e4e8"> (InterruptedException </span><span style="color:#ffab70">e</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">				e.</span><span style="color:#b392f0">printStackTrace</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">			}</span></span>
<span class="line"><span style="color:#e1e4e8">			</span><span style="color:#f97583">try</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">				Thread.</span><span style="color:#b392f0">sleep</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">1000</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">			} </span><span style="color:#f97583">catch</span><span style="color:#e1e4e8"> (InterruptedException </span><span style="color:#ffab70">e</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">				e.</span><span style="color:#b392f0">printStackTrace</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">			}</span></span>
<span class="line"><span style="color:#e1e4e8">			</span><span style="color:#6a737d">//把str中的A改为C,并比对版本号，如果版本号相同，就执行替换，并让版本号+1</span></span>
<span class="line"><span style="color:#e1e4e8">			System.out.</span><span style="color:#b392f0">println</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"change A-&gt;C stamp "</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">+</span><span style="color:#e1e4e8"> stamp </span><span style="color:#f97583">+</span><span style="color:#e1e4e8"> str.</span><span style="color:#b392f0">compareAndSet</span><span style="color:#e1e4e8">(pre, </span><span style="color:#9ecbff">"C"</span><span style="color:#e1e4e8">, stamp, stamp</span><span style="color:#f97583">+</span><span style="color:#79b8ff">1</span><span style="color:#e1e4e8">));</span></span>
<span class="line"><span style="color:#e1e4e8">		}).</span><span style="color:#b392f0">start</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">	}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">	</span><span style="color:#f97583">static</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">void</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">other</span><span style="color:#e1e4e8">() </span><span style="color:#f97583">throws</span><span style="color:#e1e4e8"> InterruptedException {</span></span>
<span class="line"><span style="color:#e1e4e8">		</span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Thread</span><span style="color:#e1e4e8">(()</span><span style="color:#f97583">-&gt;</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">			</span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> stamp </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> str.</span><span style="color:#b392f0">getStamp</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">			System.out.</span><span style="color:#b392f0">println</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"change A-&gt;B stamp "</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">+</span><span style="color:#e1e4e8"> stamp </span><span style="color:#f97583">+</span><span style="color:#e1e4e8"> str.</span><span style="color:#b392f0">compareAndSet</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"A"</span><span style="color:#e1e4e8">, </span><span style="color:#9ecbff">"B"</span><span style="color:#e1e4e8">, stamp, stamp</span><span style="color:#f97583">+</span><span style="color:#79b8ff">1</span><span style="color:#e1e4e8">));</span></span>
<span class="line"><span style="color:#e1e4e8">		}).</span><span style="color:#b392f0">start</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">		Thread.</span><span style="color:#b392f0">sleep</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">500</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">		</span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Thread</span><span style="color:#e1e4e8">(()</span><span style="color:#f97583">-&gt;</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">			</span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> stamp </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> str.</span><span style="color:#b392f0">getStamp</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">			System.out.</span><span style="color:#b392f0">println</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"change B-&gt;A stamp "</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">+</span><span style="color:#e1e4e8"> stamp </span><span style="color:#f97583">+</span><span style="color:#e1e4e8">  str.</span><span style="color:#b392f0">compareAndSet</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"B"</span><span style="color:#e1e4e8">, </span><span style="color:#9ecbff">"A"</span><span style="color:#e1e4e8">, stamp, stamp</span><span style="color:#f97583">+</span><span style="color:#79b8ff">1</span><span style="color:#e1e4e8">));</span></span>
<span class="line"><span style="color:#e1e4e8">		}).</span><span style="color:#b392f0">start</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">	}</span></span>
<span class="line"><span style="color:#e1e4e8">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">class</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Demo3</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">	</span><span style="color:#6a737d">//指定版本号</span></span>
<span class="line"><span style="color:#24292e">	</span><span style="color:#d73a49">static</span><span style="color:#24292e"> AtomicStampedReference&lt;</span><span style="color:#d73a49">String</span><span style="color:#24292e">&gt; str </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> AtomicStampedReference&lt;&gt;(</span><span style="color:#032f62">"A"</span><span style="color:#24292e">, </span><span style="color:#005cc5">0</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">	</span><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">static</span><span style="color:#24292e"> </span><span style="color:#d73a49">void</span><span style="color:#24292e"> </span><span style="color:#6f42c1">main</span><span style="color:#24292e">(</span><span style="color:#d73a49">String</span><span style="color:#24292e">[] </span><span style="color:#e36209">args</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">		</span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Thread</span><span style="color:#24292e">(() </span><span style="color:#d73a49">-&gt;</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">			String pre </span><span style="color:#d73a49">=</span><span style="color:#24292e"> str.</span><span style="color:#6f42c1">getReference</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">			</span><span style="color:#6a737d">//获得版本号</span></span>
<span class="line"><span style="color:#24292e">			</span><span style="color:#d73a49">int</span><span style="color:#24292e"> stamp </span><span style="color:#d73a49">=</span><span style="color:#24292e"> str.</span><span style="color:#6f42c1">getStamp</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">			System.out.</span><span style="color:#6f42c1">println</span><span style="color:#24292e">(</span><span style="color:#032f62">"change"</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">			</span><span style="color:#d73a49">try</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">				</span><span style="color:#6f42c1">other</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">			} </span><span style="color:#d73a49">catch</span><span style="color:#24292e"> (InterruptedException </span><span style="color:#e36209">e</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">				e.</span><span style="color:#6f42c1">printStackTrace</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">			}</span></span>
<span class="line"><span style="color:#24292e">			</span><span style="color:#d73a49">try</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">				Thread.</span><span style="color:#6f42c1">sleep</span><span style="color:#24292e">(</span><span style="color:#005cc5">1000</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">			} </span><span style="color:#d73a49">catch</span><span style="color:#24292e"> (InterruptedException </span><span style="color:#e36209">e</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">				e.</span><span style="color:#6f42c1">printStackTrace</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">			}</span></span>
<span class="line"><span style="color:#24292e">			</span><span style="color:#6a737d">//把str中的A改为C,并比对版本号，如果版本号相同，就执行替换，并让版本号+1</span></span>
<span class="line"><span style="color:#24292e">			System.out.</span><span style="color:#6f42c1">println</span><span style="color:#24292e">(</span><span style="color:#032f62">"change A-&gt;C stamp "</span><span style="color:#24292e"> </span><span style="color:#d73a49">+</span><span style="color:#24292e"> stamp </span><span style="color:#d73a49">+</span><span style="color:#24292e"> str.</span><span style="color:#6f42c1">compareAndSet</span><span style="color:#24292e">(pre, </span><span style="color:#032f62">"C"</span><span style="color:#24292e">, stamp, stamp</span><span style="color:#d73a49">+</span><span style="color:#005cc5">1</span><span style="color:#24292e">));</span></span>
<span class="line"><span style="color:#24292e">		}).</span><span style="color:#6f42c1">start</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">	}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">	</span><span style="color:#d73a49">static</span><span style="color:#24292e"> </span><span style="color:#d73a49">void</span><span style="color:#24292e"> </span><span style="color:#6f42c1">other</span><span style="color:#24292e">() </span><span style="color:#d73a49">throws</span><span style="color:#24292e"> InterruptedException {</span></span>
<span class="line"><span style="color:#24292e">		</span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Thread</span><span style="color:#24292e">(()</span><span style="color:#d73a49">-&gt;</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">			</span><span style="color:#d73a49">int</span><span style="color:#24292e"> stamp </span><span style="color:#d73a49">=</span><span style="color:#24292e"> str.</span><span style="color:#6f42c1">getStamp</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">			System.out.</span><span style="color:#6f42c1">println</span><span style="color:#24292e">(</span><span style="color:#032f62">"change A-&gt;B stamp "</span><span style="color:#24292e"> </span><span style="color:#d73a49">+</span><span style="color:#24292e"> stamp </span><span style="color:#d73a49">+</span><span style="color:#24292e"> str.</span><span style="color:#6f42c1">compareAndSet</span><span style="color:#24292e">(</span><span style="color:#032f62">"A"</span><span style="color:#24292e">, </span><span style="color:#032f62">"B"</span><span style="color:#24292e">, stamp, stamp</span><span style="color:#d73a49">+</span><span style="color:#005cc5">1</span><span style="color:#24292e">));</span></span>
<span class="line"><span style="color:#24292e">		}).</span><span style="color:#6f42c1">start</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">		Thread.</span><span style="color:#6f42c1">sleep</span><span style="color:#24292e">(</span><span style="color:#005cc5">500</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">		</span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Thread</span><span style="color:#24292e">(()</span><span style="color:#d73a49">-&gt;</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">			</span><span style="color:#d73a49">int</span><span style="color:#24292e"> stamp </span><span style="color:#d73a49">=</span><span style="color:#24292e"> str.</span><span style="color:#6f42c1">getStamp</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">			System.out.</span><span style="color:#6f42c1">println</span><span style="color:#24292e">(</span><span style="color:#032f62">"change B-&gt;A stamp "</span><span style="color:#24292e"> </span><span style="color:#d73a49">+</span><span style="color:#24292e"> stamp </span><span style="color:#d73a49">+</span><span style="color:#24292e">  str.</span><span style="color:#6f42c1">compareAndSet</span><span style="color:#24292e">(</span><span style="color:#032f62">"B"</span><span style="color:#24292e">, </span><span style="color:#032f62">"A"</span><span style="color:#24292e">, stamp, stamp</span><span style="color:#d73a49">+</span><span style="color:#005cc5">1</span><span style="color:#24292e">));</span></span>
<span class="line"><span style="color:#24292e">		}).</span><span style="color:#6f42c1">start</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">	}</span></span>
<span class="line"><span style="color:#24292e">}</span></span></code></pre></div><figure><img src="https://jsd.cdn.zzko.cn/gh/imLKlauS/blog-picture@main/blogs/20200608150003.png" alt="img" loading="lazy" decoding="async"></figure><h4 id="atomicmarkablereference" tabindex="-1">AtomicMarkableReference <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20intermediate%20level#atomicmarkablereference" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h4><p>AtomicStampedReference 可以给原子引用加上版本号，追踪原子引用整个的变化过程，如： A -&gt; B -&gt; A -&gt; C ，通过AtomicStampedReference，我们可以知道，引用变量中途被更改了几次。 但是有时候，并不关心引用变量更改了几次，只是单纯的关心<strong>是否更改过</strong>，所以就有了 <strong>AtomicMarkableReference</strong></p><figure><img src="https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230714183156551.png" alt="image-20230714183156551" loading="lazy" decoding="async"></figure><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8">@</span><span style="color:#f97583">Slf4j</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">topic</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#9ecbff">"c.Test38"</span><span style="color:#e1e4e8">)</span></span>
<span class="line"><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">class</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Test38</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">static</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">void</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">main</span><span style="color:#e1e4e8">(</span><span style="color:#f97583">String</span><span style="color:#e1e4e8">[] </span><span style="color:#ffab70">args</span><span style="color:#e1e4e8">) </span><span style="color:#f97583">throws</span><span style="color:#e1e4e8"> InterruptedException {</span></span>
<span class="line"><span style="color:#e1e4e8">        GarbageBag bag </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">GarbageBag</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"装满了垃圾"</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#6a737d">// 参数2 mark 可以看作一个标记，表示垃圾袋满了</span></span>
<span class="line"><span style="color:#e1e4e8">        AtomicMarkableReference&lt;</span><span style="color:#f97583">GarbageBag</span><span style="color:#e1e4e8">&gt; ref </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> AtomicMarkableReference&lt;&gt;(bag, </span><span style="color:#79b8ff">true</span><span style="color:#e1e4e8">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">        log.</span><span style="color:#b392f0">debug</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"start..."</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">        GarbageBag prev </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> ref.</span><span style="color:#b392f0">getReference</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">        log.</span><span style="color:#b392f0">debug</span><span style="color:#e1e4e8">(prev.</span><span style="color:#b392f0">toString</span><span style="color:#e1e4e8">());</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Thread</span><span style="color:#e1e4e8">(() </span><span style="color:#f97583">-&gt;</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">            log.</span><span style="color:#b392f0">debug</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"start..."</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">            bag.</span><span style="color:#b392f0">setDesc</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"空垃圾袋"</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">            ref.</span><span style="color:#b392f0">compareAndSet</span><span style="color:#e1e4e8">(bag, bag, </span><span style="color:#79b8ff">true</span><span style="color:#e1e4e8">, </span><span style="color:#79b8ff">false</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">            log.</span><span style="color:#b392f0">debug</span><span style="color:#e1e4e8">(bag.</span><span style="color:#b392f0">toString</span><span style="color:#e1e4e8">());</span></span>
<span class="line"><span style="color:#e1e4e8">        },</span><span style="color:#9ecbff">"保洁阿姨"</span><span style="color:#e1e4e8">).</span><span style="color:#b392f0">start</span><span style="color:#e1e4e8">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#b392f0">sleep</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">1</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">        log.</span><span style="color:#b392f0">debug</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"想换一只新垃圾袋？"</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">boolean</span><span style="color:#e1e4e8"> success </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> ref.</span><span style="color:#b392f0">compareAndSet</span><span style="color:#e1e4e8">(prev, </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">GarbageBag</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"空垃圾袋"</span><span style="color:#e1e4e8">), </span><span style="color:#79b8ff">true</span><span style="color:#e1e4e8">, </span><span style="color:#79b8ff">false</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">        log.</span><span style="color:#b392f0">debug</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"换了么？"</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">+</span><span style="color:#e1e4e8"> success);</span></span>
<span class="line"><span style="color:#e1e4e8">        log.</span><span style="color:#b392f0">debug</span><span style="color:#e1e4e8">(ref.</span><span style="color:#b392f0">getReference</span><span style="color:#e1e4e8">().</span><span style="color:#b392f0">toString</span><span style="color:#e1e4e8">());</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"><span style="color:#e1e4e8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#f97583">class</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">GarbageBag</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">    String desc;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">GarbageBag</span><span style="color:#e1e4e8">(String </span><span style="color:#ffab70">desc</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#79b8ff">this</span><span style="color:#e1e4e8">.desc </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> desc;</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">void</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">setDesc</span><span style="color:#e1e4e8">(String </span><span style="color:#ffab70">desc</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#79b8ff">this</span><span style="color:#e1e4e8">.desc </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> desc;</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">    @</span><span style="color:#f97583">Override</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">public</span><span style="color:#e1e4e8"> String </span><span style="color:#b392f0">toString</span><span style="color:#e1e4e8">() {</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">super</span><span style="color:#e1e4e8">.</span><span style="color:#b392f0">toString</span><span style="color:#e1e4e8">() </span><span style="color:#f97583">+</span><span style="color:#e1e4e8"> </span><span style="color:#9ecbff">" "</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">+</span><span style="color:#e1e4e8"> desc;</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"><span style="color:#e1e4e8">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e">@</span><span style="color:#d73a49">Slf4j</span><span style="color:#24292e">(</span><span style="color:#005cc5">topic</span><span style="color:#24292e"> </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#032f62">"c.Test38"</span><span style="color:#24292e">)</span></span>
<span class="line"><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">class</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Test38</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">static</span><span style="color:#24292e"> </span><span style="color:#d73a49">void</span><span style="color:#24292e"> </span><span style="color:#6f42c1">main</span><span style="color:#24292e">(</span><span style="color:#d73a49">String</span><span style="color:#24292e">[] </span><span style="color:#e36209">args</span><span style="color:#24292e">) </span><span style="color:#d73a49">throws</span><span style="color:#24292e"> InterruptedException {</span></span>
<span class="line"><span style="color:#24292e">        GarbageBag bag </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">GarbageBag</span><span style="color:#24292e">(</span><span style="color:#032f62">"装满了垃圾"</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6a737d">// 参数2 mark 可以看作一个标记，表示垃圾袋满了</span></span>
<span class="line"><span style="color:#24292e">        AtomicMarkableReference&lt;</span><span style="color:#d73a49">GarbageBag</span><span style="color:#24292e">&gt; ref </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> AtomicMarkableReference&lt;&gt;(bag, </span><span style="color:#005cc5">true</span><span style="color:#24292e">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">        log.</span><span style="color:#6f42c1">debug</span><span style="color:#24292e">(</span><span style="color:#032f62">"start..."</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">        GarbageBag prev </span><span style="color:#d73a49">=</span><span style="color:#24292e"> ref.</span><span style="color:#6f42c1">getReference</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">        log.</span><span style="color:#6f42c1">debug</span><span style="color:#24292e">(prev.</span><span style="color:#6f42c1">toString</span><span style="color:#24292e">());</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Thread</span><span style="color:#24292e">(() </span><span style="color:#d73a49">-&gt;</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">            log.</span><span style="color:#6f42c1">debug</span><span style="color:#24292e">(</span><span style="color:#032f62">"start..."</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">            bag.</span><span style="color:#6f42c1">setDesc</span><span style="color:#24292e">(</span><span style="color:#032f62">"空垃圾袋"</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">            ref.</span><span style="color:#6f42c1">compareAndSet</span><span style="color:#24292e">(bag, bag, </span><span style="color:#005cc5">true</span><span style="color:#24292e">, </span><span style="color:#005cc5">false</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">            log.</span><span style="color:#6f42c1">debug</span><span style="color:#24292e">(bag.</span><span style="color:#6f42c1">toString</span><span style="color:#24292e">());</span></span>
<span class="line"><span style="color:#24292e">        },</span><span style="color:#032f62">"保洁阿姨"</span><span style="color:#24292e">).</span><span style="color:#6f42c1">start</span><span style="color:#24292e">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6f42c1">sleep</span><span style="color:#24292e">(</span><span style="color:#005cc5">1</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">        log.</span><span style="color:#6f42c1">debug</span><span style="color:#24292e">(</span><span style="color:#032f62">"想换一只新垃圾袋？"</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">boolean</span><span style="color:#24292e"> success </span><span style="color:#d73a49">=</span><span style="color:#24292e"> ref.</span><span style="color:#6f42c1">compareAndSet</span><span style="color:#24292e">(prev, </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">GarbageBag</span><span style="color:#24292e">(</span><span style="color:#032f62">"空垃圾袋"</span><span style="color:#24292e">), </span><span style="color:#005cc5">true</span><span style="color:#24292e">, </span><span style="color:#005cc5">false</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">        log.</span><span style="color:#6f42c1">debug</span><span style="color:#24292e">(</span><span style="color:#032f62">"换了么？"</span><span style="color:#24292e"> </span><span style="color:#d73a49">+</span><span style="color:#24292e"> success);</span></span>
<span class="line"><span style="color:#24292e">        log.</span><span style="color:#6f42c1">debug</span><span style="color:#24292e">(ref.</span><span style="color:#6f42c1">getReference</span><span style="color:#24292e">().</span><span style="color:#6f42c1">toString</span><span style="color:#24292e">());</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"><span style="color:#24292e">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#d73a49">class</span><span style="color:#24292e"> </span><span style="color:#6f42c1">GarbageBag</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">    String desc;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#6f42c1">GarbageBag</span><span style="color:#24292e">(String </span><span style="color:#e36209">desc</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#005cc5">this</span><span style="color:#24292e">.desc </span><span style="color:#d73a49">=</span><span style="color:#24292e"> desc;</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">void</span><span style="color:#24292e"> </span><span style="color:#6f42c1">setDesc</span><span style="color:#24292e">(String </span><span style="color:#e36209">desc</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#005cc5">this</span><span style="color:#24292e">.desc </span><span style="color:#d73a49">=</span><span style="color:#24292e"> desc;</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">    @</span><span style="color:#d73a49">Override</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">public</span><span style="color:#24292e"> String </span><span style="color:#6f42c1">toString</span><span style="color:#24292e">() {</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">return</span><span style="color:#24292e"> </span><span style="color:#005cc5">super</span><span style="color:#24292e">.</span><span style="color:#6f42c1">toString</span><span style="color:#24292e">() </span><span style="color:#d73a49">+</span><span style="color:#24292e"> </span><span style="color:#032f62">" "</span><span style="color:#24292e"> </span><span style="color:#d73a49">+</span><span style="color:#24292e"> desc;</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"><span style="color:#24292e">}</span></span></code></pre></div><figure><img src="https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230714183338108.png" alt="image-20230714183338108" loading="lazy" decoding="async"></figure><h4 id="两者的区别" tabindex="-1">两者的区别 <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20intermediate%20level#两者的区别" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h4><ul><li><strong>AtomicStampedReference</strong> 需要我们传入<strong>整型变量</strong>作为版本号，来判定是否被更改过</li><li><strong>AtomicMarkableReference</strong>需要我们传入<strong>布尔变量</strong>作为标记，来判断是否被更改过</li></ul><h3 id="_6、原子数组" tabindex="-1">6、原子数组 <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20intermediate%20level#_6、原子数组" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h3><ul><li>AtomicIntegerArray</li><li>AtomicLongArray</li><li>AtomicReferenceArray</li></ul><h4 id="lamba表达式的使用" tabindex="-1">lamba表达式的使用 <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20intermediate%20level#lamba表达式的使用" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h4><ul><li>提供者<ul><li>无参又返回</li><li>()-&gt;返回结果</li></ul></li><li>方法<ul><li>有参有返回</li><li>(参数一…)-&gt;返回结果</li></ul></li><li>消费者<ul><li>有参无返回</li><li>(参数一…)-&gt;void</li></ul></li></ul><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6a737d">/**</span></span>
<span class="line"><span style="color:#6a737d">     参数1，提供数组、可以是线程不安全数组或线程安全数组</span></span>
<span class="line"><span style="color:#6a737d">     参数2，获取数组长度的方法</span></span>
<span class="line"><span style="color:#6a737d">     参数3，自增方法，回传 array, index</span></span>
<span class="line"><span style="color:#6a737d">     参数4，打印数组的方法</span></span>
<span class="line"><span style="color:#6a737d">     */</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">// supplier 提供者 无中生有  ()-&gt;结果</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">// function 函数   一个参数一个结果   (参数)-&gt;结果  ,  BiFunction (参数1,参数2)-&gt;结果</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">// consumer 消费者 一个参数没结果  (参数)-&gt;void,      BiConsumer (参数1,参数2)-&gt;</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">private</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">static</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">&lt;</span><span style="color:#e1e4e8">T</span><span style="color:#f97583">&gt;</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">void</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">demo</span><span style="color:#e1e4e8">(</span></span>
<span class="line"><span style="color:#e1e4e8">            Supplier</span><span style="color:#f97583">&lt;</span><span style="color:#e1e4e8">T</span><span style="color:#f97583">&gt;</span><span style="color:#e1e4e8"> arraySupplier,</span></span>
<span class="line"><span style="color:#e1e4e8">            Function</span><span style="color:#f97583">&lt;</span><span style="color:#e1e4e8">T, Integer</span><span style="color:#f97583">&gt;</span><span style="color:#e1e4e8"> lengthFun,</span></span>
<span class="line"><span style="color:#e1e4e8">            BiConsumer</span><span style="color:#f97583">&lt;</span><span style="color:#e1e4e8">T, Integer</span><span style="color:#f97583">&gt;</span><span style="color:#e1e4e8"> putConsumer,</span></span>
<span class="line"><span style="color:#e1e4e8">            Consumer</span><span style="color:#f97583">&lt;</span><span style="color:#e1e4e8">T</span><span style="color:#f97583">&gt;</span><span style="color:#e1e4e8"> printConsumer ) {</span></span>
<span class="line"><span style="color:#e1e4e8">        List&lt;</span><span style="color:#f97583">Thread</span><span style="color:#e1e4e8">&gt; ts </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> ArrayList&lt;&gt;();</span></span>
<span class="line"><span style="color:#e1e4e8">        T array </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> arraySupplier.</span><span style="color:#b392f0">get</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> length </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> lengthFun.</span><span style="color:#b392f0">apply</span><span style="color:#e1e4e8">(array);</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">for</span><span style="color:#e1e4e8"> (</span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> i </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8">; i </span><span style="color:#f97583">&lt;</span><span style="color:#e1e4e8"> length; i</span><span style="color:#f97583">++</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#6a737d">// 每个线程对数组作 10000 次操作</span></span>
<span class="line"><span style="color:#e1e4e8">            ts.</span><span style="color:#b392f0">add</span><span style="color:#e1e4e8">(</span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Thread</span><span style="color:#e1e4e8">(() </span><span style="color:#f97583">-&gt;</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#f97583">for</span><span style="color:#e1e4e8"> (</span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> j </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8">; j </span><span style="color:#f97583">&lt;</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">10000</span><span style="color:#e1e4e8">; j</span><span style="color:#f97583">++</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">                    putConsumer.</span><span style="color:#b392f0">accept</span><span style="color:#e1e4e8">(array, j</span><span style="color:#f97583">%</span><span style="color:#e1e4e8">length);</span></span>
<span class="line"><span style="color:#e1e4e8">                }</span></span>
<span class="line"><span style="color:#e1e4e8">            }));</span></span>
<span class="line"><span style="color:#e1e4e8">        }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">        ts.</span><span style="color:#b392f0">forEach</span><span style="color:#e1e4e8">(t </span><span style="color:#f97583">-&gt;</span><span style="color:#e1e4e8"> t.</span><span style="color:#b392f0">start</span><span style="color:#e1e4e8">()); </span><span style="color:#6a737d">// 启动所有线程</span></span>
<span class="line"><span style="color:#e1e4e8">        ts.</span><span style="color:#b392f0">forEach</span><span style="color:#e1e4e8">(t </span><span style="color:#f97583">-&gt;</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">try</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">                t.</span><span style="color:#b392f0">join</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">            } </span><span style="color:#f97583">catch</span><span style="color:#e1e4e8"> (InterruptedException </span><span style="color:#ffab70">e</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">                e.</span><span style="color:#b392f0">printStackTrace</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">            }</span></span>
<span class="line"><span style="color:#e1e4e8">        });     </span><span style="color:#6a737d">// 等所有线程结束</span></span>
<span class="line"><span style="color:#e1e4e8">        printConsumer.</span><span style="color:#b392f0">accept</span><span style="color:#e1e4e8">(array);</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6a737d">/**</span></span>
<span class="line"><span style="color:#6a737d">     参数1，提供数组、可以是线程不安全数组或线程安全数组</span></span>
<span class="line"><span style="color:#6a737d">     参数2，获取数组长度的方法</span></span>
<span class="line"><span style="color:#6a737d">     参数3，自增方法，回传 array, index</span></span>
<span class="line"><span style="color:#6a737d">     参数4，打印数组的方法</span></span>
<span class="line"><span style="color:#6a737d">     */</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">// supplier 提供者 无中生有  ()-&gt;结果</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">// function 函数   一个参数一个结果   (参数)-&gt;结果  ,  BiFunction (参数1,参数2)-&gt;结果</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">// consumer 消费者 一个参数没结果  (参数)-&gt;void,      BiConsumer (参数1,参数2)-&gt;</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">private</span><span style="color:#24292e"> </span><span style="color:#d73a49">static</span><span style="color:#24292e"> </span><span style="color:#d73a49">&lt;</span><span style="color:#24292e">T</span><span style="color:#d73a49">&gt;</span><span style="color:#24292e"> </span><span style="color:#d73a49">void</span><span style="color:#24292e"> </span><span style="color:#6f42c1">demo</span><span style="color:#24292e">(</span></span>
<span class="line"><span style="color:#24292e">            Supplier</span><span style="color:#d73a49">&lt;</span><span style="color:#24292e">T</span><span style="color:#d73a49">&gt;</span><span style="color:#24292e"> arraySupplier,</span></span>
<span class="line"><span style="color:#24292e">            Function</span><span style="color:#d73a49">&lt;</span><span style="color:#24292e">T, Integer</span><span style="color:#d73a49">&gt;</span><span style="color:#24292e"> lengthFun,</span></span>
<span class="line"><span style="color:#24292e">            BiConsumer</span><span style="color:#d73a49">&lt;</span><span style="color:#24292e">T, Integer</span><span style="color:#d73a49">&gt;</span><span style="color:#24292e"> putConsumer,</span></span>
<span class="line"><span style="color:#24292e">            Consumer</span><span style="color:#d73a49">&lt;</span><span style="color:#24292e">T</span><span style="color:#d73a49">&gt;</span><span style="color:#24292e"> printConsumer ) {</span></span>
<span class="line"><span style="color:#24292e">        List&lt;</span><span style="color:#d73a49">Thread</span><span style="color:#24292e">&gt; ts </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> ArrayList&lt;&gt;();</span></span>
<span class="line"><span style="color:#24292e">        T array </span><span style="color:#d73a49">=</span><span style="color:#24292e"> arraySupplier.</span><span style="color:#6f42c1">get</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">int</span><span style="color:#24292e"> length </span><span style="color:#d73a49">=</span><span style="color:#24292e"> lengthFun.</span><span style="color:#6f42c1">apply</span><span style="color:#24292e">(array);</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">for</span><span style="color:#24292e"> (</span><span style="color:#d73a49">int</span><span style="color:#24292e"> i </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#005cc5">0</span><span style="color:#24292e">; i </span><span style="color:#d73a49">&lt;</span><span style="color:#24292e"> length; i</span><span style="color:#d73a49">++</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#6a737d">// 每个线程对数组作 10000 次操作</span></span>
<span class="line"><span style="color:#24292e">            ts.</span><span style="color:#6f42c1">add</span><span style="color:#24292e">(</span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Thread</span><span style="color:#24292e">(() </span><span style="color:#d73a49">-&gt;</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#d73a49">for</span><span style="color:#24292e"> (</span><span style="color:#d73a49">int</span><span style="color:#24292e"> j </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#005cc5">0</span><span style="color:#24292e">; j </span><span style="color:#d73a49">&lt;</span><span style="color:#24292e"> </span><span style="color:#005cc5">10000</span><span style="color:#24292e">; j</span><span style="color:#d73a49">++</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">                    putConsumer.</span><span style="color:#6f42c1">accept</span><span style="color:#24292e">(array, j</span><span style="color:#d73a49">%</span><span style="color:#24292e">length);</span></span>
<span class="line"><span style="color:#24292e">                }</span></span>
<span class="line"><span style="color:#24292e">            }));</span></span>
<span class="line"><span style="color:#24292e">        }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">        ts.</span><span style="color:#6f42c1">forEach</span><span style="color:#24292e">(t </span><span style="color:#d73a49">-&gt;</span><span style="color:#24292e"> t.</span><span style="color:#6f42c1">start</span><span style="color:#24292e">()); </span><span style="color:#6a737d">// 启动所有线程</span></span>
<span class="line"><span style="color:#24292e">        ts.</span><span style="color:#6f42c1">forEach</span><span style="color:#24292e">(t </span><span style="color:#d73a49">-&gt;</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">try</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">                t.</span><span style="color:#6f42c1">join</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">            } </span><span style="color:#d73a49">catch</span><span style="color:#24292e"> (InterruptedException </span><span style="color:#e36209">e</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">                e.</span><span style="color:#6f42c1">printStackTrace</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">            }</span></span>
<span class="line"><span style="color:#24292e">        });     </span><span style="color:#6a737d">// 等所有线程结束</span></span>
<span class="line"><span style="color:#24292e">        printConsumer.</span><span style="color:#6f42c1">accept</span><span style="color:#24292e">(array);</span></span>
<span class="line"><span style="color:#24292e">    }</span></span></code></pre></div><p>不安全的数组</p><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#b392f0">demo</span><span style="color:#e1e4e8">(</span></span>
<span class="line"><span style="color:#e1e4e8">                ()</span><span style="color:#f97583">-&gt;new</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">int</span><span style="color:#e1e4e8">[</span><span style="color:#79b8ff">10</span><span style="color:#e1e4e8">],</span></span>
<span class="line"><span style="color:#e1e4e8">                (array)</span><span style="color:#f97583">-&gt;</span><span style="color:#e1e4e8">array.length,</span></span>
<span class="line"><span style="color:#e1e4e8">                (array, index) </span><span style="color:#f97583">-&gt;</span><span style="color:#e1e4e8"> array[index]</span><span style="color:#f97583">++</span><span style="color:#e1e4e8">,</span></span>
<span class="line"><span style="color:#e1e4e8">                array</span><span style="color:#f97583">-&gt;</span><span style="color:#e1e4e8"> System.out.</span><span style="color:#b392f0">println</span><span style="color:#e1e4e8">(Arrays.</span><span style="color:#b392f0">toString</span><span style="color:#e1e4e8">(array))</span></span>
<span class="line"><span style="color:#e1e4e8">        );</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6f42c1">demo</span><span style="color:#24292e">(</span></span>
<span class="line"><span style="color:#24292e">                ()</span><span style="color:#d73a49">-&gt;new</span><span style="color:#24292e"> </span><span style="color:#d73a49">int</span><span style="color:#24292e">[</span><span style="color:#005cc5">10</span><span style="color:#24292e">],</span></span>
<span class="line"><span style="color:#24292e">                (array)</span><span style="color:#d73a49">-&gt;</span><span style="color:#24292e">array.length,</span></span>
<span class="line"><span style="color:#24292e">                (array, index) </span><span style="color:#d73a49">-&gt;</span><span style="color:#24292e"> array[index]</span><span style="color:#d73a49">++</span><span style="color:#24292e">,</span></span>
<span class="line"><span style="color:#24292e">                array</span><span style="color:#d73a49">-&gt;</span><span style="color:#24292e"> System.out.</span><span style="color:#6f42c1">println</span><span style="color:#24292e">(Arrays.</span><span style="color:#6f42c1">toString</span><span style="color:#24292e">(array))</span></span>
<span class="line"><span style="color:#24292e">        );</span></span></code></pre></div><figure><img src="https://jsd.cdn.zzko.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230718150048875.png" alt="image-20230718150048875" loading="lazy" decoding="async"></figure><p>安全的数组</p><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#b392f0">demo</span><span style="color:#e1e4e8">(</span></span>
<span class="line"><span style="color:#e1e4e8">                ()</span><span style="color:#f97583">-&gt;</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">AtomicIntegerArray</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">10</span><span style="color:#e1e4e8">),</span></span>
<span class="line"><span style="color:#e1e4e8">                (array) </span><span style="color:#f97583">-&gt;</span><span style="color:#e1e4e8"> array.</span><span style="color:#b392f0">length</span><span style="color:#e1e4e8">(),</span></span>
<span class="line"><span style="color:#e1e4e8">                (array, index) </span><span style="color:#f97583">-&gt;</span><span style="color:#e1e4e8"> array.</span><span style="color:#b392f0">getAndIncrement</span><span style="color:#e1e4e8">(index),</span></span>
<span class="line"><span style="color:#e1e4e8">                array </span><span style="color:#f97583">-&gt;</span><span style="color:#e1e4e8"> System.out.</span><span style="color:#b392f0">println</span><span style="color:#e1e4e8">(array)</span></span>
<span class="line"><span style="color:#e1e4e8">        );</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6f42c1">demo</span><span style="color:#24292e">(</span></span>
<span class="line"><span style="color:#24292e">                ()</span><span style="color:#d73a49">-&gt;</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">AtomicIntegerArray</span><span style="color:#24292e">(</span><span style="color:#005cc5">10</span><span style="color:#24292e">),</span></span>
<span class="line"><span style="color:#24292e">                (array) </span><span style="color:#d73a49">-&gt;</span><span style="color:#24292e"> array.</span><span style="color:#6f42c1">length</span><span style="color:#24292e">(),</span></span>
<span class="line"><span style="color:#24292e">                (array, index) </span><span style="color:#d73a49">-&gt;</span><span style="color:#24292e"> array.</span><span style="color:#6f42c1">getAndIncrement</span><span style="color:#24292e">(index),</span></span>
<span class="line"><span style="color:#24292e">                array </span><span style="color:#d73a49">-&gt;</span><span style="color:#24292e"> System.out.</span><span style="color:#6f42c1">println</span><span style="color:#24292e">(array)</span></span>
<span class="line"><span style="color:#24292e">        );</span></span></code></pre></div><figure><img src="https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230718150058604.png" alt="image-20230718150058604" loading="lazy" decoding="async"></figure><h3 id="_7、原子更新器" tabindex="-1">7、原子更新器 <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20intermediate%20level#_7、原子更新器" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h3><ul><li>AtomicReferenceFieldUpdater // 域 字段</li><li>AtomicIntegerFieldUpdater</li><li>AtomicLongFieldUpdate</li></ul><p>原子更新器用于帮助我们改变某个对象中的某个属性</p><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">class</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Demo1</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">   </span><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">static</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">void</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">main</span><span style="color:#e1e4e8">(</span><span style="color:#f97583">String</span><span style="color:#e1e4e8">[] </span><span style="color:#ffab70">args</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">      Student student </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Student</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">       </span></span>
<span class="line"><span style="color:#e1e4e8">      </span><span style="color:#6a737d">// 获得原子更新器</span></span>
<span class="line"><span style="color:#e1e4e8">      </span><span style="color:#6a737d">// 泛型</span></span>
<span class="line"><span style="color:#e1e4e8">      </span><span style="color:#6a737d">// 参数1 持有属性的类 参数2 被更新的属性的类</span></span>
<span class="line"><span style="color:#e1e4e8">      </span><span style="color:#6a737d">// newUpdater中的参数：第三个为属性的名称</span></span>
<span class="line"><span style="color:#e1e4e8">      AtomicReferenceFieldUpdater&lt;</span><span style="color:#f97583">Student</span><span style="color:#e1e4e8">, </span><span style="color:#f97583">String</span><span style="color:#e1e4e8">&gt; updater </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> AtomicReferenceFieldUpdater.</span><span style="color:#b392f0">newUpdater</span><span style="color:#e1e4e8">(Student.class, String.class, </span><span style="color:#9ecbff">"name"</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">       </span></span>
<span class="line"><span style="color:#e1e4e8">      </span><span style="color:#6a737d">// 修改</span></span>
<span class="line"><span style="color:#e1e4e8">      updater.</span><span style="color:#b392f0">compareAndSet</span><span style="color:#e1e4e8">(student, </span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8">, </span><span style="color:#9ecbff">"klaus"</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">      System.out.</span><span style="color:#b392f0">println</span><span style="color:#e1e4e8">(student);</span></span>
<span class="line"><span style="color:#e1e4e8">   }</span></span>
<span class="line"><span style="color:#e1e4e8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#f97583">class</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Student</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">   </span><span style="color:#f97583">volatile</span><span style="color:#e1e4e8"> String name;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">   @</span><span style="color:#f97583">Override</span></span>
<span class="line"><span style="color:#e1e4e8">   </span><span style="color:#f97583">public</span><span style="color:#e1e4e8"> String </span><span style="color:#b392f0">toString</span><span style="color:#e1e4e8">() {</span></span>
<span class="line"><span style="color:#e1e4e8">      </span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> </span><span style="color:#9ecbff">"Student{"</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">+</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#9ecbff">"name='"</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">+</span><span style="color:#e1e4e8"> name </span><span style="color:#f97583">+</span><span style="color:#e1e4e8"> </span><span style="color:#9ecbff">'</span><span style="color:#79b8ff">\'</span><span style="color:#9ecbff">'</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">+</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#9ecbff">'}'</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">   }</span></span>
<span class="line"><span style="color:#e1e4e8">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">class</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Demo1</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">   </span><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">static</span><span style="color:#24292e"> </span><span style="color:#d73a49">void</span><span style="color:#24292e"> </span><span style="color:#6f42c1">main</span><span style="color:#24292e">(</span><span style="color:#d73a49">String</span><span style="color:#24292e">[] </span><span style="color:#e36209">args</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">      Student student </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Student</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">       </span></span>
<span class="line"><span style="color:#24292e">      </span><span style="color:#6a737d">// 获得原子更新器</span></span>
<span class="line"><span style="color:#24292e">      </span><span style="color:#6a737d">// 泛型</span></span>
<span class="line"><span style="color:#24292e">      </span><span style="color:#6a737d">// 参数1 持有属性的类 参数2 被更新的属性的类</span></span>
<span class="line"><span style="color:#24292e">      </span><span style="color:#6a737d">// newUpdater中的参数：第三个为属性的名称</span></span>
<span class="line"><span style="color:#24292e">      AtomicReferenceFieldUpdater&lt;</span><span style="color:#d73a49">Student</span><span style="color:#24292e">, </span><span style="color:#d73a49">String</span><span style="color:#24292e">&gt; updater </span><span style="color:#d73a49">=</span><span style="color:#24292e"> AtomicReferenceFieldUpdater.</span><span style="color:#6f42c1">newUpdater</span><span style="color:#24292e">(Student.class, String.class, </span><span style="color:#032f62">"name"</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">       </span></span>
<span class="line"><span style="color:#24292e">      </span><span style="color:#6a737d">// 修改</span></span>
<span class="line"><span style="color:#24292e">      updater.</span><span style="color:#6f42c1">compareAndSet</span><span style="color:#24292e">(student, </span><span style="color:#005cc5">null</span><span style="color:#24292e">, </span><span style="color:#032f62">"klaus"</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">      System.out.</span><span style="color:#6f42c1">println</span><span style="color:#24292e">(student);</span></span>
<span class="line"><span style="color:#24292e">   }</span></span>
<span class="line"><span style="color:#24292e">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#d73a49">class</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Student</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">   </span><span style="color:#d73a49">volatile</span><span style="color:#24292e"> String name;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">   @</span><span style="color:#d73a49">Override</span></span>
<span class="line"><span style="color:#24292e">   </span><span style="color:#d73a49">public</span><span style="color:#24292e"> String </span><span style="color:#6f42c1">toString</span><span style="color:#24292e">() {</span></span>
<span class="line"><span style="color:#24292e">      </span><span style="color:#d73a49">return</span><span style="color:#24292e"> </span><span style="color:#032f62">"Student{"</span><span style="color:#24292e"> </span><span style="color:#d73a49">+</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#032f62">"name='"</span><span style="color:#24292e"> </span><span style="color:#d73a49">+</span><span style="color:#24292e"> name </span><span style="color:#d73a49">+</span><span style="color:#24292e"> </span><span style="color:#032f62">'</span><span style="color:#005cc5">\'</span><span style="color:#032f62">'</span><span style="color:#24292e"> </span><span style="color:#d73a49">+</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#032f62">'}'</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">   }</span></span>
<span class="line"><span style="color:#24292e">}</span></span></code></pre></div><h4 id="原子更新器初始化过程" tabindex="-1">原子更新器初始化过程 <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20intermediate%20level#原子更新器初始化过程" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h4><p>从上面的例子可以看出，原子更新器是通过newUpdater来获取实例的。其中传入了三个参数</p><ul><li>拥有属性的类的Class</li><li>属性的Class</li><li>属性的名称</li></ul><p>大概可以猜出来，<strong>初始化过程用到了反射</strong>，让我们看看源码来验证一下这个猜测。</p><h5 id="newupdater方法" tabindex="-1">newUpdater方法 <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20intermediate%20level#newupdater方法" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h5><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">static</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">&lt;</span><span style="color:#e1e4e8">U,W</span><span style="color:#f97583">&gt;</span><span style="color:#e1e4e8"> AtomicReferenceFieldUpdater</span><span style="color:#f97583">&lt;</span><span style="color:#e1e4e8">U,W</span><span style="color:#f97583">&gt;</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">newUpdater</span><span style="color:#e1e4e8">(Class</span><span style="color:#f97583">&lt;</span><span style="color:#e1e4e8">U</span><span style="color:#f97583">&gt;</span><span style="color:#e1e4e8"> tclass,</span></span>
<span class="line"><span style="color:#e1e4e8">                                                                Class</span><span style="color:#f97583">&lt;</span><span style="color:#e1e4e8">W</span><span style="color:#f97583">&gt;</span><span style="color:#e1e4e8"> vclass,</span></span>
<span class="line"><span style="color:#e1e4e8">                                                                String fieldName) {</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">// 返回了一个AtomicReferenceFieldUpdaterImpl实例</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> AtomicReferenceFieldUpdaterImpl&lt;</span><span style="color:#f97583">U</span><span style="color:#e1e4e8">,</span><span style="color:#f97583">W</span><span style="color:#e1e4e8">&gt;</span></span>
<span class="line"><span style="color:#e1e4e8">        (tclass, vclass, fieldName, Reflection.</span><span style="color:#b392f0">getCallerClass</span><span style="color:#e1e4e8">());</span></span>
<span class="line"><span style="color:#e1e4e8">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">static</span><span style="color:#24292e"> </span><span style="color:#d73a49">&lt;</span><span style="color:#24292e">U,W</span><span style="color:#d73a49">&gt;</span><span style="color:#24292e"> AtomicReferenceFieldUpdater</span><span style="color:#d73a49">&lt;</span><span style="color:#24292e">U,W</span><span style="color:#d73a49">&gt;</span><span style="color:#24292e"> </span><span style="color:#6f42c1">newUpdater</span><span style="color:#24292e">(Class</span><span style="color:#d73a49">&lt;</span><span style="color:#24292e">U</span><span style="color:#d73a49">&gt;</span><span style="color:#24292e"> tclass,</span></span>
<span class="line"><span style="color:#24292e">                                                                Class</span><span style="color:#d73a49">&lt;</span><span style="color:#24292e">W</span><span style="color:#d73a49">&gt;</span><span style="color:#24292e"> vclass,</span></span>
<span class="line"><span style="color:#24292e">                                                                String fieldName) {</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">// 返回了一个AtomicReferenceFieldUpdaterImpl实例</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">return</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> AtomicReferenceFieldUpdaterImpl&lt;</span><span style="color:#d73a49">U</span><span style="color:#24292e">,</span><span style="color:#d73a49">W</span><span style="color:#24292e">&gt;</span></span>
<span class="line"><span style="color:#24292e">        (tclass, vclass, fieldName, Reflection.</span><span style="color:#6f42c1">getCallerClass</span><span style="color:#24292e">());</span></span>
<span class="line"><span style="color:#24292e">}</span></span></code></pre></div><p>从newUpdater方法还并不能看出来具体的初始化过程</p><h4 id="内部实现类" tabindex="-1">内部实现类 <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20intermediate%20level#内部实现类" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h4><figure><img src="https://jsd.cdn.zzko.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230720004338538.png" alt="image-20230720004338538" loading="lazy" decoding="async"></figure><p>AtomicReferenceFieldUpdater为抽象类，该类<strong>内部有一个自己的实现类AtomicReferenceFieldUpdaterImpl</strong></p><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#f97583">private</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">static</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">final</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">class</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">AtomicReferenceFieldUpdaterImpl</span><span style="color:#e1e4e8">&lt;</span><span style="color:#f97583">T</span><span style="color:#e1e4e8">,</span><span style="color:#f97583">V</span><span style="color:#e1e4e8">&gt;</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">extends</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">AtomicReferenceFieldUpdater</span><span style="color:#e1e4e8">&lt;</span><span style="color:#f97583">T</span><span style="color:#e1e4e8">,</span><span style="color:#f97583">V</span><span style="color:#e1e4e8">&gt;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#d73a49">private</span><span style="color:#24292e"> </span><span style="color:#d73a49">static</span><span style="color:#24292e"> </span><span style="color:#d73a49">final</span><span style="color:#24292e"> </span><span style="color:#d73a49">class</span><span style="color:#24292e"> </span><span style="color:#6f42c1">AtomicReferenceFieldUpdaterImpl</span><span style="color:#24292e">&lt;</span><span style="color:#d73a49">T</span><span style="color:#24292e">,</span><span style="color:#d73a49">V</span><span style="color:#24292e">&gt;</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">extends</span><span style="color:#24292e"> </span><span style="color:#6f42c1">AtomicReferenceFieldUpdater</span><span style="color:#24292e">&lt;</span><span style="color:#d73a49">T</span><span style="color:#24292e">,</span><span style="color:#d73a49">V</span><span style="color:#24292e">&gt;</span></span></code></pre></div><figure><img src="https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/20201020145119.png" alt="img" loading="lazy" decoding="async"></figure><p><strong>构造方法</strong></p><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#b392f0">AtomicReferenceFieldUpdaterImpl</span><span style="color:#e1e4e8">(</span><span style="color:#f97583">final</span><span style="color:#e1e4e8"> Class</span><span style="color:#f97583">&lt;</span><span style="color:#e1e4e8">T</span><span style="color:#f97583">&gt;</span><span style="color:#e1e4e8"> tclass,</span></span>
<span class="line"><span style="color:#e1e4e8">                                </span><span style="color:#f97583">final</span><span style="color:#e1e4e8"> Class</span><span style="color:#f97583">&lt;</span><span style="color:#e1e4e8">V</span><span style="color:#f97583">&gt;</span><span style="color:#e1e4e8"> vclass,</span></span>
<span class="line"><span style="color:#e1e4e8">                                </span><span style="color:#f97583">final</span><span style="color:#e1e4e8"> String fieldName,</span></span>
<span class="line"><span style="color:#e1e4e8">                                </span><span style="color:#f97583">final</span><span style="color:#e1e4e8"> Class</span><span style="color:#f97583">&lt;?&gt;</span><span style="color:#e1e4e8"> caller) {</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">// 用于保存要被修改的属性</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">final</span><span style="color:#e1e4e8"> Field field;</span></span>
<span class="line"><span style="color:#e1e4e8">    </span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">// 属性的Class</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">final</span><span style="color:#e1e4e8"> Class&lt;</span><span style="color:#f97583">?</span><span style="color:#e1e4e8">&gt; fieldClass;</span></span>
<span class="line"><span style="color:#e1e4e8">    </span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">// field的修饰符</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">final</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> modifiers;</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">try</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#6a737d">// 反射获得属性</span></span>
<span class="line"><span style="color:#e1e4e8">        field </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> AccessController.</span><span style="color:#b392f0">doPrivileged</span><span style="color:#e1e4e8">(</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> PrivilegedExceptionAction&lt;</span><span style="color:#f97583">Field</span><span style="color:#e1e4e8">&gt;() {</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#f97583">public</span><span style="color:#e1e4e8"> Field </span><span style="color:#b392f0">run</span><span style="color:#e1e4e8">() </span><span style="color:#f97583">throws</span><span style="color:#e1e4e8"> NoSuchFieldException {</span></span>
<span class="line"><span style="color:#e1e4e8">                    </span><span style="color:#6a737d">// tclass为传入的属性的Class，可以通过它来获得属性</span></span>
<span class="line"><span style="color:#e1e4e8">                    </span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> tclass.</span><span style="color:#b392f0">getDeclaredField</span><span style="color:#e1e4e8">(fieldName);</span></span>
<span class="line"><span style="color:#e1e4e8">                }</span></span>
<span class="line"><span style="color:#e1e4e8">            });</span></span>
<span class="line"><span style="color:#e1e4e8">        </span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#6a737d">// 获得属性的修饰符，主要用于判断</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#6a737d">// 1、vclass 与 属性确切的类型是否匹配</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#6a737d">// 2、是否为引用类型</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#6a737d">// 3、被修改的属性是否加了volatile关键字</span></span>
<span class="line"><span style="color:#e1e4e8">        modifiers </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> field.</span><span style="color:#b392f0">getModifiers</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">        sun.reflect.misc.ReflectUtil.</span><span style="color:#b392f0">ensureMemberAccess</span><span style="color:#e1e4e8">(</span></span>
<span class="line"><span style="color:#e1e4e8">            caller, tclass, </span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8">, modifiers);</span></span>
<span class="line"><span style="color:#e1e4e8">        ClassLoader cl </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> tclass.</span><span style="color:#b392f0">getClassLoader</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">        ClassLoader ccl </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> caller.</span><span style="color:#b392f0">getClassLoader</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> ((ccl </span><span style="color:#f97583">!=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8">) </span><span style="color:#f97583">&amp;&amp;</span><span style="color:#e1e4e8"> (ccl </span><span style="color:#f97583">!=</span><span style="color:#e1e4e8"> cl) </span><span style="color:#f97583">&amp;&amp;</span></span>
<span class="line"><span style="color:#e1e4e8">            ((cl </span><span style="color:#f97583">==</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8">) </span><span style="color:#f97583">||</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">!</span><span style="color:#b392f0">isAncestor</span><span style="color:#e1e4e8">(cl, ccl))) {</span></span>
<span class="line"><span style="color:#e1e4e8">            sun.reflect.misc.ReflectUtil.</span><span style="color:#b392f0">checkPackageAccess</span><span style="color:#e1e4e8">(tclass);</span></span>
<span class="line"><span style="color:#e1e4e8">        }</span></span>
<span class="line"><span style="color:#e1e4e8">        </span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#6a737d">// 获得属性类的Class</span></span>
<span class="line"><span style="color:#e1e4e8">        fieldClass </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> field.</span><span style="color:#b392f0">getType</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">    } </span><span style="color:#f97583">catch</span><span style="color:#e1e4e8"> (PrivilegedActionException </span><span style="color:#ffab70">pae</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">throw</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">RuntimeException</span><span style="color:#e1e4e8">(pae.</span><span style="color:#b392f0">getException</span><span style="color:#e1e4e8">());</span></span>
<span class="line"><span style="color:#e1e4e8">    } </span><span style="color:#f97583">catch</span><span style="color:#e1e4e8"> (Exception </span><span style="color:#ffab70">ex</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">throw</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">RuntimeException</span><span style="color:#e1e4e8">(ex);</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (vclass </span><span style="color:#f97583">!=</span><span style="color:#e1e4e8"> fieldClass)</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">throw</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">ClassCastException</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (vclass.</span><span style="color:#b392f0">isPrimitive</span><span style="color:#e1e4e8">())</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">throw</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">IllegalArgumentException</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"Must be reference type"</span><span style="color:#e1e4e8">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (</span><span style="color:#f97583">!</span><span style="color:#e1e4e8">Modifier.</span><span style="color:#b392f0">isVolatile</span><span style="color:#e1e4e8">(modifiers))</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">throw</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">IllegalArgumentException</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"Must be volatile type"</span><span style="color:#e1e4e8">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">// Access to protected field members is restricted to receivers only</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">// of the accessing class, or one of its subclasses, and the</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">// accessing class must in turn be a subclass (or package sibling)</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">// of the protected member's defining class.</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">// If the updater refers to a protected field of a declaring class</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">// outside the current package, the receiver argument will be</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">// narrowed to the type of the accessing class.</span></span>
<span class="line"><span style="color:#e1e4e8"> 	</span><span style="color:#6a737d">// 对类中的属性进行初始化</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#79b8ff">this</span><span style="color:#e1e4e8">.cclass </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> (Modifier.</span><span style="color:#b392f0">isProtected</span><span style="color:#e1e4e8">(modifiers) </span><span style="color:#f97583">&amp;&amp;</span></span>
<span class="line"><span style="color:#e1e4e8">                   tclass.</span><span style="color:#b392f0">isAssignableFrom</span><span style="color:#e1e4e8">(caller) </span><span style="color:#f97583">&amp;&amp;</span></span>
<span class="line"><span style="color:#e1e4e8">                   </span><span style="color:#f97583">!</span><span style="color:#b392f0">isSamePackage</span><span style="color:#e1e4e8">(tclass, caller))</span></span>
<span class="line"><span style="color:#e1e4e8">                  </span><span style="color:#f97583">?</span><span style="color:#e1e4e8"> caller </span><span style="color:#f97583">:</span><span style="color:#e1e4e8"> tclass;</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#79b8ff">this</span><span style="color:#e1e4e8">.tclass </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> tclass;</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#79b8ff">this</span><span style="color:#e1e4e8">.vclass </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> vclass;</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">// 获得偏移量</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#79b8ff">this</span><span style="color:#e1e4e8">.offset </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> U.</span><span style="color:#b392f0">objectFieldOffset</span><span style="color:#e1e4e8">(field);</span></span>
<span class="line"><span style="color:#e1e4e8">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6f42c1">AtomicReferenceFieldUpdaterImpl</span><span style="color:#24292e">(</span><span style="color:#d73a49">final</span><span style="color:#24292e"> Class</span><span style="color:#d73a49">&lt;</span><span style="color:#24292e">T</span><span style="color:#d73a49">&gt;</span><span style="color:#24292e"> tclass,</span></span>
<span class="line"><span style="color:#24292e">                                </span><span style="color:#d73a49">final</span><span style="color:#24292e"> Class</span><span style="color:#d73a49">&lt;</span><span style="color:#24292e">V</span><span style="color:#d73a49">&gt;</span><span style="color:#24292e"> vclass,</span></span>
<span class="line"><span style="color:#24292e">                                </span><span style="color:#d73a49">final</span><span style="color:#24292e"> String fieldName,</span></span>
<span class="line"><span style="color:#24292e">                                </span><span style="color:#d73a49">final</span><span style="color:#24292e"> Class</span><span style="color:#d73a49">&lt;?&gt;</span><span style="color:#24292e"> caller) {</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">// 用于保存要被修改的属性</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">final</span><span style="color:#24292e"> Field field;</span></span>
<span class="line"><span style="color:#24292e">    </span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">// 属性的Class</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">final</span><span style="color:#24292e"> Class&lt;</span><span style="color:#d73a49">?</span><span style="color:#24292e">&gt; fieldClass;</span></span>
<span class="line"><span style="color:#24292e">    </span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">// field的修饰符</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">final</span><span style="color:#24292e"> </span><span style="color:#d73a49">int</span><span style="color:#24292e"> modifiers;</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">try</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6a737d">// 反射获得属性</span></span>
<span class="line"><span style="color:#24292e">        field </span><span style="color:#d73a49">=</span><span style="color:#24292e"> AccessController.</span><span style="color:#6f42c1">doPrivileged</span><span style="color:#24292e">(</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">new</span><span style="color:#24292e"> PrivilegedExceptionAction&lt;</span><span style="color:#d73a49">Field</span><span style="color:#24292e">&gt;() {</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#d73a49">public</span><span style="color:#24292e"> Field </span><span style="color:#6f42c1">run</span><span style="color:#24292e">() </span><span style="color:#d73a49">throws</span><span style="color:#24292e"> NoSuchFieldException {</span></span>
<span class="line"><span style="color:#24292e">                    </span><span style="color:#6a737d">// tclass为传入的属性的Class，可以通过它来获得属性</span></span>
<span class="line"><span style="color:#24292e">                    </span><span style="color:#d73a49">return</span><span style="color:#24292e"> tclass.</span><span style="color:#6f42c1">getDeclaredField</span><span style="color:#24292e">(fieldName);</span></span>
<span class="line"><span style="color:#24292e">                }</span></span>
<span class="line"><span style="color:#24292e">            });</span></span>
<span class="line"><span style="color:#24292e">        </span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6a737d">// 获得属性的修饰符，主要用于判断</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6a737d">// 1、vclass 与 属性确切的类型是否匹配</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6a737d">// 2、是否为引用类型</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6a737d">// 3、被修改的属性是否加了volatile关键字</span></span>
<span class="line"><span style="color:#24292e">        modifiers </span><span style="color:#d73a49">=</span><span style="color:#24292e"> field.</span><span style="color:#6f42c1">getModifiers</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">        sun.reflect.misc.ReflectUtil.</span><span style="color:#6f42c1">ensureMemberAccess</span><span style="color:#24292e">(</span></span>
<span class="line"><span style="color:#24292e">            caller, tclass, </span><span style="color:#005cc5">null</span><span style="color:#24292e">, modifiers);</span></span>
<span class="line"><span style="color:#24292e">        ClassLoader cl </span><span style="color:#d73a49">=</span><span style="color:#24292e"> tclass.</span><span style="color:#6f42c1">getClassLoader</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">        ClassLoader ccl </span><span style="color:#d73a49">=</span><span style="color:#24292e"> caller.</span><span style="color:#6f42c1">getClassLoader</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">if</span><span style="color:#24292e"> ((ccl </span><span style="color:#d73a49">!=</span><span style="color:#24292e"> </span><span style="color:#005cc5">null</span><span style="color:#24292e">) </span><span style="color:#d73a49">&amp;&amp;</span><span style="color:#24292e"> (ccl </span><span style="color:#d73a49">!=</span><span style="color:#24292e"> cl) </span><span style="color:#d73a49">&amp;&amp;</span></span>
<span class="line"><span style="color:#24292e">            ((cl </span><span style="color:#d73a49">==</span><span style="color:#24292e"> </span><span style="color:#005cc5">null</span><span style="color:#24292e">) </span><span style="color:#d73a49">||</span><span style="color:#24292e"> </span><span style="color:#d73a49">!</span><span style="color:#6f42c1">isAncestor</span><span style="color:#24292e">(cl, ccl))) {</span></span>
<span class="line"><span style="color:#24292e">            sun.reflect.misc.ReflectUtil.</span><span style="color:#6f42c1">checkPackageAccess</span><span style="color:#24292e">(tclass);</span></span>
<span class="line"><span style="color:#24292e">        }</span></span>
<span class="line"><span style="color:#24292e">        </span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6a737d">// 获得属性类的Class</span></span>
<span class="line"><span style="color:#24292e">        fieldClass </span><span style="color:#d73a49">=</span><span style="color:#24292e"> field.</span><span style="color:#6f42c1">getType</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">    } </span><span style="color:#d73a49">catch</span><span style="color:#24292e"> (PrivilegedActionException </span><span style="color:#e36209">pae</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">throw</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">RuntimeException</span><span style="color:#24292e">(pae.</span><span style="color:#6f42c1">getException</span><span style="color:#24292e">());</span></span>
<span class="line"><span style="color:#24292e">    } </span><span style="color:#d73a49">catch</span><span style="color:#24292e"> (Exception </span><span style="color:#e36209">ex</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">throw</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">RuntimeException</span><span style="color:#24292e">(ex);</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (vclass </span><span style="color:#d73a49">!=</span><span style="color:#24292e"> fieldClass)</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">throw</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">ClassCastException</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (vclass.</span><span style="color:#6f42c1">isPrimitive</span><span style="color:#24292e">())</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">throw</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">IllegalArgumentException</span><span style="color:#24292e">(</span><span style="color:#032f62">"Must be reference type"</span><span style="color:#24292e">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (</span><span style="color:#d73a49">!</span><span style="color:#24292e">Modifier.</span><span style="color:#6f42c1">isVolatile</span><span style="color:#24292e">(modifiers))</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">throw</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">IllegalArgumentException</span><span style="color:#24292e">(</span><span style="color:#032f62">"Must be volatile type"</span><span style="color:#24292e">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">// Access to protected field members is restricted to receivers only</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">// of the accessing class, or one of its subclasses, and the</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">// accessing class must in turn be a subclass (or package sibling)</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">// of the protected member's defining class.</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">// If the updater refers to a protected field of a declaring class</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">// outside the current package, the receiver argument will be</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">// narrowed to the type of the accessing class.</span></span>
<span class="line"><span style="color:#24292e"> 	</span><span style="color:#6a737d">// 对类中的属性进行初始化</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#005cc5">this</span><span style="color:#24292e">.cclass </span><span style="color:#d73a49">=</span><span style="color:#24292e"> (Modifier.</span><span style="color:#6f42c1">isProtected</span><span style="color:#24292e">(modifiers) </span><span style="color:#d73a49">&amp;&amp;</span></span>
<span class="line"><span style="color:#24292e">                   tclass.</span><span style="color:#6f42c1">isAssignableFrom</span><span style="color:#24292e">(caller) </span><span style="color:#d73a49">&amp;&amp;</span></span>
<span class="line"><span style="color:#24292e">                   </span><span style="color:#d73a49">!</span><span style="color:#6f42c1">isSamePackage</span><span style="color:#24292e">(tclass, caller))</span></span>
<span class="line"><span style="color:#24292e">                  </span><span style="color:#d73a49">?</span><span style="color:#24292e"> caller </span><span style="color:#d73a49">:</span><span style="color:#24292e"> tclass;</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#005cc5">this</span><span style="color:#24292e">.tclass </span><span style="color:#d73a49">=</span><span style="color:#24292e"> tclass;</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#005cc5">this</span><span style="color:#24292e">.vclass </span><span style="color:#d73a49">=</span><span style="color:#24292e"> vclass;</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">// 获得偏移量</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#005cc5">this</span><span style="color:#24292e">.offset </span><span style="color:#d73a49">=</span><span style="color:#24292e"> U.</span><span style="color:#6f42c1">objectFieldOffset</span><span style="color:#24292e">(field);</span></span>
<span class="line"><span style="color:#24292e">}</span></span></code></pre></div><p><strong>可以看出，原子引用更新器确实使用了反射</strong></p><h3 id="_8、longadder原理" tabindex="-1">8、LongAdder原理 <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20intermediate%20level#_8、longadder原理" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h3><p>LongAdder 是并发大师 @author Doug Lea （大哥李）的作品，设计的非常精巧 LongAdder 类有几个关键域</p><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6a737d">// 累加单元数组, 懒惰初始化</span></span>
<span class="line"><span style="color:#f97583">transient</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">volatile</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">Cell</span><span style="color:#e1e4e8">[] cells;</span></span>
<span class="line"><span style="color:#6a737d">// 基础值, 如果没有竞争, 则用 cas 累加这个域</span></span>
<span class="line"><span style="color:#f97583">transient</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">volatile</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">long</span><span style="color:#e1e4e8"> base;</span></span>
<span class="line"><span style="color:#6a737d">// 在 cells 创建或扩容时, 置为 1, 表示加锁</span></span>
<span class="line"><span style="color:#f97583">transient</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">volatile</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> cellsBusy;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6a737d">// 累加单元数组, 懒惰初始化</span></span>
<span class="line"><span style="color:#d73a49">transient</span><span style="color:#24292e"> </span><span style="color:#d73a49">volatile</span><span style="color:#24292e"> </span><span style="color:#d73a49">Cell</span><span style="color:#24292e">[] cells;</span></span>
<span class="line"><span style="color:#6a737d">// 基础值, 如果没有竞争, 则用 cas 累加这个域</span></span>
<span class="line"><span style="color:#d73a49">transient</span><span style="color:#24292e"> </span><span style="color:#d73a49">volatile</span><span style="color:#24292e"> </span><span style="color:#d73a49">long</span><span style="color:#24292e"> base;</span></span>
<span class="line"><span style="color:#6a737d">// 在 cells 创建或扩容时, 置为 1, 表示加锁</span></span>
<span class="line"><span style="color:#d73a49">transient</span><span style="color:#24292e"> </span><span style="color:#d73a49">volatile</span><span style="color:#24292e"> </span><span style="color:#d73a49">int</span><span style="color:#24292e"> cellsBusy;</span></span></code></pre></div><h4 id="原理之cas锁" tabindex="-1">原理之CAS锁 <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20intermediate%20level#原理之cas锁" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h4><p>只用于底层，不能用于生产（不要用于实践！！！）</p><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#f97583">private</span><span style="color:#e1e4e8"> AtomicInteger state </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">AtomicInteger</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">void</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">lock</span><span style="color:#e1e4e8">() {</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#6a737d">//会影响CPU性能</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">while</span><span style="color:#e1e4e8"> (</span><span style="color:#79b8ff">true</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (state.</span><span style="color:#b392f0">compareAndSet</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8">, </span><span style="color:#79b8ff">1</span><span style="color:#e1e4e8">)) {</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#f97583">break</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">            }</span></span>
<span class="line"><span style="color:#e1e4e8">        }</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">void</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">unlock</span><span style="color:#e1e4e8">() {</span></span>
<span class="line"><span style="color:#e1e4e8">        log.</span><span style="color:#b392f0">debug</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"unlock..."</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">        state.</span><span style="color:#b392f0">set</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">static</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">void</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">main</span><span style="color:#e1e4e8">(</span><span style="color:#f97583">String</span><span style="color:#e1e4e8">[] args) {</span></span>
<span class="line"><span style="color:#e1e4e8">        LockCas lock </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">LockCas</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Thread</span><span style="color:#e1e4e8">(() </span><span style="color:#f97583">-&gt;</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">            log.</span><span style="color:#b392f0">debug</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"begin..."</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">            lock.</span><span style="color:#b392f0">lock</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">try</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">                log.</span><span style="color:#b392f0">debug</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"lock..."</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#b392f0">sleep</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">1</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">            } </span><span style="color:#f97583">finally</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">                lock.</span><span style="color:#b392f0">unlock</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">            }</span></span>
<span class="line"><span style="color:#e1e4e8">        }).</span><span style="color:#b392f0">start</span><span style="color:#e1e4e8">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Thread</span><span style="color:#e1e4e8">(() </span><span style="color:#f97583">-&gt;</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">            log.</span><span style="color:#b392f0">debug</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"begin..."</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">            lock.</span><span style="color:#b392f0">lock</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">try</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">                log.</span><span style="color:#b392f0">debug</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"lock..."</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">            } </span><span style="color:#f97583">finally</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">                lock.</span><span style="color:#b392f0">unlock</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">            }</span></span>
<span class="line"><span style="color:#e1e4e8">        }).</span><span style="color:#b392f0">start</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#d73a49">private</span><span style="color:#24292e"> AtomicInteger state </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">AtomicInteger</span><span style="color:#24292e">(</span><span style="color:#005cc5">0</span><span style="color:#24292e">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">void</span><span style="color:#24292e"> </span><span style="color:#6f42c1">lock</span><span style="color:#24292e">() {</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6a737d">//会影响CPU性能</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">while</span><span style="color:#24292e"> (</span><span style="color:#005cc5">true</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (state.</span><span style="color:#6f42c1">compareAndSet</span><span style="color:#24292e">(</span><span style="color:#005cc5">0</span><span style="color:#24292e">, </span><span style="color:#005cc5">1</span><span style="color:#24292e">)) {</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#d73a49">break</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">            }</span></span>
<span class="line"><span style="color:#24292e">        }</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">void</span><span style="color:#24292e"> </span><span style="color:#6f42c1">unlock</span><span style="color:#24292e">() {</span></span>
<span class="line"><span style="color:#24292e">        log.</span><span style="color:#6f42c1">debug</span><span style="color:#24292e">(</span><span style="color:#032f62">"unlock..."</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">        state.</span><span style="color:#6f42c1">set</span><span style="color:#24292e">(</span><span style="color:#005cc5">0</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">static</span><span style="color:#24292e"> </span><span style="color:#d73a49">void</span><span style="color:#24292e"> </span><span style="color:#6f42c1">main</span><span style="color:#24292e">(</span><span style="color:#d73a49">String</span><span style="color:#24292e">[] args) {</span></span>
<span class="line"><span style="color:#24292e">        LockCas lock </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">LockCas</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Thread</span><span style="color:#24292e">(() </span><span style="color:#d73a49">-&gt;</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">            log.</span><span style="color:#6f42c1">debug</span><span style="color:#24292e">(</span><span style="color:#032f62">"begin..."</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">            lock.</span><span style="color:#6f42c1">lock</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">try</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">                log.</span><span style="color:#6f42c1">debug</span><span style="color:#24292e">(</span><span style="color:#032f62">"lock..."</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#6f42c1">sleep</span><span style="color:#24292e">(</span><span style="color:#005cc5">1</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">            } </span><span style="color:#d73a49">finally</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">                lock.</span><span style="color:#6f42c1">unlock</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">            }</span></span>
<span class="line"><span style="color:#24292e">        }).</span><span style="color:#6f42c1">start</span><span style="color:#24292e">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Thread</span><span style="color:#24292e">(() </span><span style="color:#d73a49">-&gt;</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">            log.</span><span style="color:#6f42c1">debug</span><span style="color:#24292e">(</span><span style="color:#032f62">"begin..."</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">            lock.</span><span style="color:#6f42c1">lock</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">try</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">                log.</span><span style="color:#6f42c1">debug</span><span style="color:#24292e">(</span><span style="color:#032f62">"lock..."</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">            } </span><span style="color:#d73a49">finally</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">                lock.</span><span style="color:#6f42c1">unlock</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">            }</span></span>
<span class="line"><span style="color:#24292e">        }).</span><span style="color:#6f42c1">start</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">    }</span></span></code></pre></div><figure><img src="https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230718151828136.png" alt="image-20230718151828136" loading="lazy" decoding="async"></figure><h4 id="原理之伪共享" tabindex="-1">原理之伪共享 <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20intermediate%20level#原理之伪共享" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h4><figure><img src="https://jsd.cdn.zzko.cn/gh/imLKlauS/blog-picture@main/blogs/20200608150037.png" alt="img" loading="lazy" decoding="async"></figure><p>缓存行伪共享得从缓存说起 缓存与内存的速度比较</p><figure><img src="https://jsd.cdn.zzko.cn/gh/imLKlauS/blog-picture@main/blogs/20200608150051.png" alt="img" loading="lazy" decoding="async"></figure><figure><img src="https://jsd.cdn.zzko.cn/gh/imLKlauS/blog-picture@main/blogs/20200608150102.png" alt="img" loading="lazy" decoding="async"></figure><p>因为 CPU 与 内存的速度差异很大，需要靠预读数据至<strong>缓存</strong>来提升效率。 而缓存以<strong>缓存行</strong>为单位，每个缓存行对应着一块内存，一般是 <strong>64 byte</strong>（8 个 long） 缓存的加入会造成数据副本的产生，即同一份数据会缓存在不同核心的缓存行中 CPU 要保证数据的<strong>一致性</strong>，如果某个 CPU 核心<strong>更改</strong>了数据，其它 CPU 核心对应的整个缓存行必须<strong>失效</strong></p><figure><img src="https://jsd.cdn.zzko.cn/gh/imLKlauS/blog-picture@main/blogs/20200608150111.png" alt="img" loading="lazy" decoding="async"></figure><p>因为 Cell 是数组形式，在内存中是连续存储的，一个 Cell 为 24 字节（16 字节的对象头和 8 字节的 value），因 此缓存行可以存下 2 个的 Cell 对象。这样问题来了：</p><ul><li>Core-0 要修改 Cell[0]</li><li>Core-1 要修改 Cell[1]</li></ul><p>无论谁修改成功，都会导致对方 Core 的缓存行失效，</p><p>比如 Core-0 中 Cell[0]=6000, Cell[1]=8000 要累加 Cell[0]=6001, Cell[1]=8000 ，这时会让 Core-1 的缓存行失效</p><p>@sun.misc.Contended 用来解决这个问题，它的原理是在使用此注解的对象或字段的<strong>前后各增加 128 字节大小的 padding</strong>（空白），从而让 CPU 将对象预读至缓存时<strong>占用不同的缓存行</strong>，这样，不会造成对方缓存行的失效</p><figure><img src="https://jsd.cdn.zzko.cn/gh/imLKlauS/blog-picture@main/blogs/20200608150119.png" alt="img" loading="lazy" decoding="async"></figure><p><strong>累加主要调用以下方法</strong></p><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">void</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">add</span><span style="color:#e1e4e8">(</span><span style="color:#f97583">long</span><span style="color:#e1e4e8"> x) {</span></span>
<span class="line"><span style="color:#e1e4e8">	   </span><span style="color:#6a737d">// as 为累加单元数组</span></span>
<span class="line"><span style="color:#e1e4e8">	   </span><span style="color:#6a737d">// b 为基础值</span></span>
<span class="line"><span style="color:#e1e4e8">	   </span><span style="color:#6a737d">// x 为累加值</span></span>
<span class="line"><span style="color:#e1e4e8">       </span><span style="color:#f97583">Cell</span><span style="color:#e1e4e8">[] as; </span><span style="color:#f97583">long</span><span style="color:#e1e4e8"> b, v; </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> m; Cell a;</span></span>
<span class="line"><span style="color:#e1e4e8">       </span><span style="color:#6a737d">// 进入 if 的两个条件</span></span>
<span class="line"><span style="color:#e1e4e8">	   </span><span style="color:#6a737d">// 1. as 有值, 表示已经发生过竞争, 进入 if</span></span>
<span class="line"><span style="color:#e1e4e8">	   </span><span style="color:#6a737d">// 2. cas 给 base 累加时失败了, 表示 base 发生了竞争, 进入 if</span></span>
<span class="line"><span style="color:#e1e4e8">       </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> ((as </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> cells) </span><span style="color:#f97583">!=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">||</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">!</span><span style="color:#b392f0">casBase</span><span style="color:#e1e4e8">(b </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> base, b </span><span style="color:#f97583">+</span><span style="color:#e1e4e8"> x)) {</span></span>
<span class="line"><span style="color:#e1e4e8">           </span><span style="color:#6a737d">// uncontended 表示 cell 没有竞争</span></span>
<span class="line"><span style="color:#e1e4e8">           </span><span style="color:#f97583">boolean</span><span style="color:#e1e4e8"> uncontended </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">true</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">           </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (</span></span>
<span class="line"><span style="color:#e1e4e8">           	   </span><span style="color:#6a737d">// as 还没有创建</span></span>
<span class="line"><span style="color:#e1e4e8">               as </span><span style="color:#f97583">==</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">||</span><span style="color:#e1e4e8"> (m </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> as.length </span><span style="color:#f97583">-</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">1</span><span style="color:#e1e4e8">) </span><span style="color:#f97583">&lt;</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">||</span></span>
<span class="line"><span style="color:#e1e4e8">           	   </span><span style="color:#6a737d">// 当前线程对应的 cell 还没有</span></span>
<span class="line"><span style="color:#e1e4e8">               (a </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> as[</span><span style="color:#b392f0">getProbe</span><span style="color:#e1e4e8">() </span><span style="color:#f97583">&amp;</span><span style="color:#e1e4e8"> m]) </span><span style="color:#f97583">==</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">||</span></span>
<span class="line"><span style="color:#e1e4e8">               </span><span style="color:#6a737d">// cas 给当前线程的 cell 累加失败 uncontended=false ( a 为当前线程的 cell )</span></span>
<span class="line"><span style="color:#e1e4e8">               </span><span style="color:#f97583">!</span><span style="color:#e1e4e8">(uncontended </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> a.</span><span style="color:#b392f0">cas</span><span style="color:#e1e4e8">(v </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> a.value, v </span><span style="color:#f97583">+</span><span style="color:#e1e4e8"> x)))</span></span>
<span class="line"><span style="color:#e1e4e8">               </span></span>
<span class="line"><span style="color:#e1e4e8">               </span><span style="color:#6a737d">// 进入 cell 数组创建、cell 创建的流程</span></span>
<span class="line"><span style="color:#e1e4e8">               </span><span style="color:#b392f0">longAccumulate</span><span style="color:#e1e4e8">(x, </span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8">, uncontended);</span></span>
<span class="line"><span style="color:#e1e4e8">       }</span></span>
<span class="line"><span style="color:#e1e4e8">   }</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">void</span><span style="color:#24292e"> </span><span style="color:#6f42c1">add</span><span style="color:#24292e">(</span><span style="color:#d73a49">long</span><span style="color:#24292e"> x) {</span></span>
<span class="line"><span style="color:#24292e">	   </span><span style="color:#6a737d">// as 为累加单元数组</span></span>
<span class="line"><span style="color:#24292e">	   </span><span style="color:#6a737d">// b 为基础值</span></span>
<span class="line"><span style="color:#24292e">	   </span><span style="color:#6a737d">// x 为累加值</span></span>
<span class="line"><span style="color:#24292e">       </span><span style="color:#d73a49">Cell</span><span style="color:#24292e">[] as; </span><span style="color:#d73a49">long</span><span style="color:#24292e"> b, v; </span><span style="color:#d73a49">int</span><span style="color:#24292e"> m; Cell a;</span></span>
<span class="line"><span style="color:#24292e">       </span><span style="color:#6a737d">// 进入 if 的两个条件</span></span>
<span class="line"><span style="color:#24292e">	   </span><span style="color:#6a737d">// 1. as 有值, 表示已经发生过竞争, 进入 if</span></span>
<span class="line"><span style="color:#24292e">	   </span><span style="color:#6a737d">// 2. cas 给 base 累加时失败了, 表示 base 发生了竞争, 进入 if</span></span>
<span class="line"><span style="color:#24292e">       </span><span style="color:#d73a49">if</span><span style="color:#24292e"> ((as </span><span style="color:#d73a49">=</span><span style="color:#24292e"> cells) </span><span style="color:#d73a49">!=</span><span style="color:#24292e"> </span><span style="color:#005cc5">null</span><span style="color:#24292e"> </span><span style="color:#d73a49">||</span><span style="color:#24292e"> </span><span style="color:#d73a49">!</span><span style="color:#6f42c1">casBase</span><span style="color:#24292e">(b </span><span style="color:#d73a49">=</span><span style="color:#24292e"> base, b </span><span style="color:#d73a49">+</span><span style="color:#24292e"> x)) {</span></span>
<span class="line"><span style="color:#24292e">           </span><span style="color:#6a737d">// uncontended 表示 cell 没有竞争</span></span>
<span class="line"><span style="color:#24292e">           </span><span style="color:#d73a49">boolean</span><span style="color:#24292e"> uncontended </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#005cc5">true</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">           </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (</span></span>
<span class="line"><span style="color:#24292e">           	   </span><span style="color:#6a737d">// as 还没有创建</span></span>
<span class="line"><span style="color:#24292e">               as </span><span style="color:#d73a49">==</span><span style="color:#24292e"> </span><span style="color:#005cc5">null</span><span style="color:#24292e"> </span><span style="color:#d73a49">||</span><span style="color:#24292e"> (m </span><span style="color:#d73a49">=</span><span style="color:#24292e"> as.length </span><span style="color:#d73a49">-</span><span style="color:#24292e"> </span><span style="color:#005cc5">1</span><span style="color:#24292e">) </span><span style="color:#d73a49">&lt;</span><span style="color:#24292e"> </span><span style="color:#005cc5">0</span><span style="color:#24292e"> </span><span style="color:#d73a49">||</span></span>
<span class="line"><span style="color:#24292e">           	   </span><span style="color:#6a737d">// 当前线程对应的 cell 还没有</span></span>
<span class="line"><span style="color:#24292e">               (a </span><span style="color:#d73a49">=</span><span style="color:#24292e"> as[</span><span style="color:#6f42c1">getProbe</span><span style="color:#24292e">() </span><span style="color:#d73a49">&amp;</span><span style="color:#24292e"> m]) </span><span style="color:#d73a49">==</span><span style="color:#24292e"> </span><span style="color:#005cc5">null</span><span style="color:#24292e"> </span><span style="color:#d73a49">||</span></span>
<span class="line"><span style="color:#24292e">               </span><span style="color:#6a737d">// cas 给当前线程的 cell 累加失败 uncontended=false ( a 为当前线程的 cell )</span></span>
<span class="line"><span style="color:#24292e">               </span><span style="color:#d73a49">!</span><span style="color:#24292e">(uncontended </span><span style="color:#d73a49">=</span><span style="color:#24292e"> a.</span><span style="color:#6f42c1">cas</span><span style="color:#24292e">(v </span><span style="color:#d73a49">=</span><span style="color:#24292e"> a.value, v </span><span style="color:#d73a49">+</span><span style="color:#24292e"> x)))</span></span>
<span class="line"><span style="color:#24292e">               </span></span>
<span class="line"><span style="color:#24292e">               </span><span style="color:#6a737d">// 进入 cell 数组创建、cell 创建的流程</span></span>
<span class="line"><span style="color:#24292e">               </span><span style="color:#6f42c1">longAccumulate</span><span style="color:#24292e">(x, </span><span style="color:#005cc5">null</span><span style="color:#24292e">, uncontended);</span></span>
<span class="line"><span style="color:#24292e">       }</span></span>
<span class="line"><span style="color:#24292e">   }</span></span></code></pre></div><p><strong>累加流程图</strong></p><figure><img src="https://jsd.cdn.zzko.cn/gh/imLKlauS/blog-picture@main/blogs/20200608150129.png" alt="img" loading="lazy" decoding="async"></figure><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#f97583">final</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">void</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">longAccumulate</span><span style="color:#e1e4e8">(</span><span style="color:#f97583">long</span><span style="color:#e1e4e8"> x, LongBinaryOperator fn,</span></span>
<span class="line"><span style="color:#e1e4e8">						  </span><span style="color:#f97583">boolean</span><span style="color:#e1e4e8"> wasUncontended) {</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> h;</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">// 当前线程还没有对应的 cell, 需要随机生成一个 h 值用来将当前线程绑定到 cell</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> ((h </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">getProbe</span><span style="color:#e1e4e8">()) </span><span style="color:#f97583">==</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#6a737d">// 初始化 probe</span></span>
<span class="line"><span style="color:#e1e4e8">        ThreadLocalRandom.</span><span style="color:#b392f0">current</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#6a737d">// h 对应新的 probe 值, 用来对应 cell</span></span>
<span class="line"><span style="color:#e1e4e8">        h </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">getProbe</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">        wasUncontended </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">true</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">// collide 为 true 表示需要扩容</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">boolean</span><span style="color:#e1e4e8"> collide </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">false</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">for</span><span style="color:#e1e4e8"> (;;) {</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">Cell</span><span style="color:#e1e4e8">[] as; Cell a; </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> n; </span><span style="color:#f97583">long</span><span style="color:#e1e4e8"> v;</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#6a737d">// 已经有了 cells</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> ((as </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> cells) </span><span style="color:#f97583">!=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">&amp;&amp;</span><span style="color:#e1e4e8"> (n </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> as.length) </span><span style="color:#f97583">&gt;</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#6a737d">// 还没有 cell（新线程未创建cell）</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> ((a </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> as[(n </span><span style="color:#f97583">-</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">1</span><span style="color:#e1e4e8">) </span><span style="color:#f97583">&amp;</span><span style="color:#e1e4e8"> h]) </span><span style="color:#f97583">==</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#6a737d">// 为 cellsBusy 加锁, 创建 cell, cell 的初始累加值为 x</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#6a737d">// 成功则 break, 否则继续 continue 循环</span></span>
<span class="line"><span style="color:#e1e4e8">            }</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#6a737d">// 有竞争, 改变线程对应的 cell 来重试 cas</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">else</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (</span><span style="color:#f97583">!</span><span style="color:#e1e4e8">wasUncontended)</span></span>
<span class="line"><span style="color:#e1e4e8">            	wasUncontended </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">true</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#6a737d">// cas 尝试累加, fn 配合 LongAccumulator 不为 null, 配合 LongAdder 为 null</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">else</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (a.</span><span style="color:#b392f0">cas</span><span style="color:#e1e4e8">(v </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> a.value, ((fn </span><span style="color:#f97583">==</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8">) </span><span style="color:#f97583">?</span><span style="color:#e1e4e8"> v </span><span style="color:#f97583">+</span><span style="color:#e1e4e8"> x </span><span style="color:#f97583">:</span><span style="color:#e1e4e8"> fn.</span><span style="color:#b392f0">applyAsLong</span><span style="color:#e1e4e8">(v, x))))</span></span>
<span class="line"><span style="color:#e1e4e8">            	</span><span style="color:#f97583">break</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#6a737d">// 如果 cells 长度已经超过了最大长度, 或者已经扩容, 改变线程对应的 cell 来重试 cas</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">else</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (n </span><span style="color:#f97583">&gt;=</span><span style="color:#e1e4e8"> NCPU </span><span style="color:#f97583">||</span><span style="color:#e1e4e8"> cells </span><span style="color:#f97583">!=</span><span style="color:#e1e4e8"> as)</span></span>
<span class="line"><span style="color:#e1e4e8">            	collide </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">false</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#6a737d">// 确保 collide 为 false 进入此分支, 就不会进入下面的 else if 进行扩容了</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">else</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (</span><span style="color:#f97583">!</span><span style="color:#e1e4e8">collide)</span></span>
<span class="line"><span style="color:#e1e4e8">                collide </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">true</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#6a737d">// 加锁</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">else</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (cellsBusy </span><span style="color:#f97583">==</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">&amp;&amp;</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">casCellsBusy</span><span style="color:#e1e4e8">()) {</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#6a737d">// 加锁成功, 扩容</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#f97583">continue</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">            }</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#6a737d">// 改变线程对应的 cell</span></span>
<span class="line"><span style="color:#e1e4e8">            h </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">advanceProbe</span><span style="color:#e1e4e8">(h);</span></span>
<span class="line"><span style="color:#e1e4e8">        }</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#6a737d">// 还没有 cells, 尝试给 cellsBusy 加锁</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">else</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (cellsBusy </span><span style="color:#f97583">==</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">&amp;&amp;</span><span style="color:#e1e4e8"> cells </span><span style="color:#f97583">==</span><span style="color:#e1e4e8"> as </span><span style="color:#f97583">&amp;&amp;</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">casCellsBusy</span><span style="color:#e1e4e8">()) {</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#6a737d">// 加锁成功, 初始化 cells, 最开始长度为 2, 并填充一个 cell</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#6a737d">// 成功则 break;</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">boolean</span><span style="color:#e1e4e8"> init </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">false</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#f97583">try</span><span style="color:#e1e4e8"> {                           </span><span style="color:#6a737d">// Initialize table</span></span>
<span class="line"><span style="color:#e1e4e8">                    </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (cells </span><span style="color:#f97583">==</span><span style="color:#e1e4e8"> as) {</span></span>
<span class="line"><span style="color:#e1e4e8">                        </span><span style="color:#f97583">Cell</span><span style="color:#e1e4e8">[] rs </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">Cell</span><span style="color:#e1e4e8">[</span><span style="color:#79b8ff">2</span><span style="color:#e1e4e8">];</span></span>
<span class="line"><span style="color:#e1e4e8">                        </span><span style="color:#6a737d">//数组大小虽然为2，但累加单元Cell对象只创建了一个，要么放到下标							0，要么放到下标1，还有一个是空着的，即不到万不得已就不创建cell对象的，这体现了懒惰初始化</span></span>
<span class="line"><span style="color:#e1e4e8">                        rs[h </span><span style="color:#f97583">&amp;</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">1</span><span style="color:#e1e4e8">] </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Cell</span><span style="color:#e1e4e8">(x);</span></span>
<span class="line"><span style="color:#e1e4e8">                        cells </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> rs;</span></span>
<span class="line"><span style="color:#e1e4e8">                        init </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">true</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">                    }</span></span>
<span class="line"><span style="color:#e1e4e8">                } </span><span style="color:#f97583">finally</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">                    </span><span style="color:#6a737d">//解锁</span></span>
<span class="line"><span style="color:#e1e4e8">                    cellsBusy </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">                }</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (init)</span></span>
<span class="line"><span style="color:#e1e4e8">                    </span><span style="color:#f97583">break</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">        }</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#6a737d">// 上两种情况失败, 尝试给 base 累加</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">else</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (</span><span style="color:#b392f0">casBase</span><span style="color:#e1e4e8">(v </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> base, ((fn </span><span style="color:#f97583">==</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8">) </span><span style="color:#f97583">?</span><span style="color:#e1e4e8"> v </span><span style="color:#f97583">+</span><span style="color:#e1e4e8"> x </span><span style="color:#f97583">:</span><span style="color:#e1e4e8"> fn.</span><span style="color:#b392f0">applyAsLong</span><span style="color:#e1e4e8">(v, x))))</span></span>
<span class="line"><span style="color:#e1e4e8">        	</span><span style="color:#f97583">break</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"><span style="color:#e1e4e8">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#d73a49">final</span><span style="color:#24292e"> </span><span style="color:#d73a49">void</span><span style="color:#24292e"> </span><span style="color:#6f42c1">longAccumulate</span><span style="color:#24292e">(</span><span style="color:#d73a49">long</span><span style="color:#24292e"> x, LongBinaryOperator fn,</span></span>
<span class="line"><span style="color:#24292e">						  </span><span style="color:#d73a49">boolean</span><span style="color:#24292e"> wasUncontended) {</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">int</span><span style="color:#24292e"> h;</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">// 当前线程还没有对应的 cell, 需要随机生成一个 h 值用来将当前线程绑定到 cell</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">if</span><span style="color:#24292e"> ((h </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#6f42c1">getProbe</span><span style="color:#24292e">()) </span><span style="color:#d73a49">==</span><span style="color:#24292e"> </span><span style="color:#005cc5">0</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6a737d">// 初始化 probe</span></span>
<span class="line"><span style="color:#24292e">        ThreadLocalRandom.</span><span style="color:#6f42c1">current</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6a737d">// h 对应新的 probe 值, 用来对应 cell</span></span>
<span class="line"><span style="color:#24292e">        h </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#6f42c1">getProbe</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">        wasUncontended </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#005cc5">true</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">// collide 为 true 表示需要扩容</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">boolean</span><span style="color:#24292e"> collide </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#005cc5">false</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">for</span><span style="color:#24292e"> (;;) {</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">Cell</span><span style="color:#24292e">[] as; Cell a; </span><span style="color:#d73a49">int</span><span style="color:#24292e"> n; </span><span style="color:#d73a49">long</span><span style="color:#24292e"> v;</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6a737d">// 已经有了 cells</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">if</span><span style="color:#24292e"> ((as </span><span style="color:#d73a49">=</span><span style="color:#24292e"> cells) </span><span style="color:#d73a49">!=</span><span style="color:#24292e"> </span><span style="color:#005cc5">null</span><span style="color:#24292e"> </span><span style="color:#d73a49">&amp;&amp;</span><span style="color:#24292e"> (n </span><span style="color:#d73a49">=</span><span style="color:#24292e"> as.length) </span><span style="color:#d73a49">&gt;</span><span style="color:#24292e"> </span><span style="color:#005cc5">0</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#6a737d">// 还没有 cell（新线程未创建cell）</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">if</span><span style="color:#24292e"> ((a </span><span style="color:#d73a49">=</span><span style="color:#24292e"> as[(n </span><span style="color:#d73a49">-</span><span style="color:#24292e"> </span><span style="color:#005cc5">1</span><span style="color:#24292e">) </span><span style="color:#d73a49">&amp;</span><span style="color:#24292e"> h]) </span><span style="color:#d73a49">==</span><span style="color:#24292e"> </span><span style="color:#005cc5">null</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#6a737d">// 为 cellsBusy 加锁, 创建 cell, cell 的初始累加值为 x</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#6a737d">// 成功则 break, 否则继续 continue 循环</span></span>
<span class="line"><span style="color:#24292e">            }</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#6a737d">// 有竞争, 改变线程对应的 cell 来重试 cas</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">else</span><span style="color:#24292e"> </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (</span><span style="color:#d73a49">!</span><span style="color:#24292e">wasUncontended)</span></span>
<span class="line"><span style="color:#24292e">            	wasUncontended </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#005cc5">true</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#6a737d">// cas 尝试累加, fn 配合 LongAccumulator 不为 null, 配合 LongAdder 为 null</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">else</span><span style="color:#24292e"> </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (a.</span><span style="color:#6f42c1">cas</span><span style="color:#24292e">(v </span><span style="color:#d73a49">=</span><span style="color:#24292e"> a.value, ((fn </span><span style="color:#d73a49">==</span><span style="color:#24292e"> </span><span style="color:#005cc5">null</span><span style="color:#24292e">) </span><span style="color:#d73a49">?</span><span style="color:#24292e"> v </span><span style="color:#d73a49">+</span><span style="color:#24292e"> x </span><span style="color:#d73a49">:</span><span style="color:#24292e"> fn.</span><span style="color:#6f42c1">applyAsLong</span><span style="color:#24292e">(v, x))))</span></span>
<span class="line"><span style="color:#24292e">            	</span><span style="color:#d73a49">break</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#6a737d">// 如果 cells 长度已经超过了最大长度, 或者已经扩容, 改变线程对应的 cell 来重试 cas</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">else</span><span style="color:#24292e"> </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (n </span><span style="color:#d73a49">&gt;=</span><span style="color:#24292e"> NCPU </span><span style="color:#d73a49">||</span><span style="color:#24292e"> cells </span><span style="color:#d73a49">!=</span><span style="color:#24292e"> as)</span></span>
<span class="line"><span style="color:#24292e">            	collide </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#005cc5">false</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#6a737d">// 确保 collide 为 false 进入此分支, 就不会进入下面的 else if 进行扩容了</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">else</span><span style="color:#24292e"> </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (</span><span style="color:#d73a49">!</span><span style="color:#24292e">collide)</span></span>
<span class="line"><span style="color:#24292e">                collide </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#005cc5">true</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#6a737d">// 加锁</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">else</span><span style="color:#24292e"> </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (cellsBusy </span><span style="color:#d73a49">==</span><span style="color:#24292e"> </span><span style="color:#005cc5">0</span><span style="color:#24292e"> </span><span style="color:#d73a49">&amp;&amp;</span><span style="color:#24292e"> </span><span style="color:#6f42c1">casCellsBusy</span><span style="color:#24292e">()) {</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#6a737d">// 加锁成功, 扩容</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#d73a49">continue</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">            }</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#6a737d">// 改变线程对应的 cell</span></span>
<span class="line"><span style="color:#24292e">            h </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#6f42c1">advanceProbe</span><span style="color:#24292e">(h);</span></span>
<span class="line"><span style="color:#24292e">        }</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6a737d">// 还没有 cells, 尝试给 cellsBusy 加锁</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">else</span><span style="color:#24292e"> </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (cellsBusy </span><span style="color:#d73a49">==</span><span style="color:#24292e"> </span><span style="color:#005cc5">0</span><span style="color:#24292e"> </span><span style="color:#d73a49">&amp;&amp;</span><span style="color:#24292e"> cells </span><span style="color:#d73a49">==</span><span style="color:#24292e"> as </span><span style="color:#d73a49">&amp;&amp;</span><span style="color:#24292e"> </span><span style="color:#6f42c1">casCellsBusy</span><span style="color:#24292e">()) {</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#6a737d">// 加锁成功, 初始化 cells, 最开始长度为 2, 并填充一个 cell</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#6a737d">// 成功则 break;</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">boolean</span><span style="color:#24292e"> init </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#005cc5">false</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#d73a49">try</span><span style="color:#24292e"> {                           </span><span style="color:#6a737d">// Initialize table</span></span>
<span class="line"><span style="color:#24292e">                    </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (cells </span><span style="color:#d73a49">==</span><span style="color:#24292e"> as) {</span></span>
<span class="line"><span style="color:#24292e">                        </span><span style="color:#d73a49">Cell</span><span style="color:#24292e">[] rs </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#d73a49">Cell</span><span style="color:#24292e">[</span><span style="color:#005cc5">2</span><span style="color:#24292e">];</span></span>
<span class="line"><span style="color:#24292e">                        </span><span style="color:#6a737d">//数组大小虽然为2，但累加单元Cell对象只创建了一个，要么放到下标							0，要么放到下标1，还有一个是空着的，即不到万不得已就不创建cell对象的，这体现了懒惰初始化</span></span>
<span class="line"><span style="color:#24292e">                        rs[h </span><span style="color:#d73a49">&amp;</span><span style="color:#24292e"> </span><span style="color:#005cc5">1</span><span style="color:#24292e">] </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Cell</span><span style="color:#24292e">(x);</span></span>
<span class="line"><span style="color:#24292e">                        cells </span><span style="color:#d73a49">=</span><span style="color:#24292e"> rs;</span></span>
<span class="line"><span style="color:#24292e">                        init </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#005cc5">true</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">                    }</span></span>
<span class="line"><span style="color:#24292e">                } </span><span style="color:#d73a49">finally</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">                    </span><span style="color:#6a737d">//解锁</span></span>
<span class="line"><span style="color:#24292e">                    cellsBusy </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#005cc5">0</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">                }</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (init)</span></span>
<span class="line"><span style="color:#24292e">                    </span><span style="color:#d73a49">break</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">        }</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6a737d">// 上两种情况失败, 尝试给 base 累加</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">else</span><span style="color:#24292e"> </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (</span><span style="color:#6f42c1">casBase</span><span style="color:#24292e">(v </span><span style="color:#d73a49">=</span><span style="color:#24292e"> base, ((fn </span><span style="color:#d73a49">==</span><span style="color:#24292e"> </span><span style="color:#005cc5">null</span><span style="color:#24292e">) </span><span style="color:#d73a49">?</span><span style="color:#24292e"> v </span><span style="color:#d73a49">+</span><span style="color:#24292e"> x </span><span style="color:#d73a49">:</span><span style="color:#24292e"> fn.</span><span style="color:#6f42c1">applyAsLong</span><span style="color:#24292e">(v, x))))</span></span>
<span class="line"><span style="color:#24292e">        	</span><span style="color:#d73a49">break</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"><span style="color:#24292e">}</span></span></code></pre></div><p>longAccumulate 流程图</p><figure><img src="https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230718153818567.png" alt="image-20230718153818567" loading="lazy" decoding="async"></figure><figure><img src="https://jsd.cdn.zzko.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230718153839548.png" alt="image-20230718153839548" loading="lazy" decoding="async"></figure><p>每个线程刚进入 longAccumulate 时，会尝试对应一个 cell 对象（找到一个坑位）</p><figure><img src="https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230718153856889.png" alt="image-20230718153856889" loading="lazy" decoding="async"></figure><p>获取最终结果通过 sum 方法</p><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">long</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">sum</span><span style="color:#e1e4e8">() {</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">Cell</span><span style="color:#e1e4e8">[] as </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> cells; Cell a;</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">long</span><span style="color:#e1e4e8"> sum </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> base;</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (as </span><span style="color:#f97583">!=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">for</span><span style="color:#e1e4e8"> (</span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> i </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8">; i </span><span style="color:#f97583">&lt;</span><span style="color:#e1e4e8"> as.length; </span><span style="color:#f97583">++</span><span style="color:#e1e4e8">i) {</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> ((a </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> as[i]) </span><span style="color:#f97583">!=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8">)</span></span>
<span class="line"><span style="color:#e1e4e8">                    sum </span><span style="color:#f97583">+=</span><span style="color:#e1e4e8"> a.value;</span></span>
<span class="line"><span style="color:#e1e4e8">            }</span></span>
<span class="line"><span style="color:#e1e4e8">        }</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> sum;</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">long</span><span style="color:#24292e"> </span><span style="color:#6f42c1">sum</span><span style="color:#24292e">() {</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">Cell</span><span style="color:#24292e">[] as </span><span style="color:#d73a49">=</span><span style="color:#24292e"> cells; Cell a;</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">long</span><span style="color:#24292e"> sum </span><span style="color:#d73a49">=</span><span style="color:#24292e"> base;</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (as </span><span style="color:#d73a49">!=</span><span style="color:#24292e"> </span><span style="color:#005cc5">null</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">for</span><span style="color:#24292e"> (</span><span style="color:#d73a49">int</span><span style="color:#24292e"> i </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#005cc5">0</span><span style="color:#24292e">; i </span><span style="color:#d73a49">&lt;</span><span style="color:#24292e"> as.length; </span><span style="color:#d73a49">++</span><span style="color:#24292e">i) {</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#d73a49">if</span><span style="color:#24292e"> ((a </span><span style="color:#d73a49">=</span><span style="color:#24292e"> as[i]) </span><span style="color:#d73a49">!=</span><span style="color:#24292e"> </span><span style="color:#005cc5">null</span><span style="color:#24292e">)</span></span>
<span class="line"><span style="color:#24292e">                    sum </span><span style="color:#d73a49">+=</span><span style="color:#24292e"> a.value;</span></span>
<span class="line"><span style="color:#24292e">            }</span></span>
<span class="line"><span style="color:#24292e">        }</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">return</span><span style="color:#24292e"> sum;</span></span>
<span class="line"><span style="color:#24292e">    }</span></span></code></pre></div><h3 id="_9、unsafe" tabindex="-1">9、Unsafe <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20intermediate%20level#_9、unsafe" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h3><p>Unsafe 对象提供了非常底层的，操作内存、线程的方法，Unsafe 对象不能直接调用，只能通过<strong>反射</strong>获得</p><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">class</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">GetUnsafe</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">	</span><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">static</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">void</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">main</span><span style="color:#e1e4e8">(</span><span style="color:#f97583">String</span><span style="color:#e1e4e8">[] </span><span style="color:#ffab70">args</span><span style="color:#e1e4e8">) </span><span style="color:#f97583">throws</span><span style="color:#e1e4e8"> NoSuchMethodException, IllegalAccessException, InvocationTargetException, InstantiationException, NoSuchFieldException {</span></span>
<span class="line"><span style="color:#e1e4e8">		</span><span style="color:#6a737d">// 通过反射获得Unsafe对象</span></span>
<span class="line"><span style="color:#e1e4e8">		Class unsafeClass </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> Unsafe.class;</span></span>
<span class="line"><span style="color:#e1e4e8">		</span><span style="color:#6a737d">// 获得构造函数，Unsafe的构造函数为私有的</span></span>
<span class="line"><span style="color:#e1e4e8">		Constructor constructor </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> unsafeClass.</span><span style="color:#b392f0">getDeclaredConstructor</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">		</span><span style="color:#6a737d">// 设置为允许访问私有内容</span></span>
<span class="line"><span style="color:#e1e4e8">		constructor.</span><span style="color:#b392f0">setAccessible</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">true</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">		</span><span style="color:#6a737d">// 创建Unsafe对象</span></span>
<span class="line"><span style="color:#e1e4e8">		Unsafe unsafe </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> (Unsafe) constructor.</span><span style="color:#b392f0">newInstance</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">		</span></span>
<span class="line"><span style="color:#e1e4e8">		</span><span style="color:#6a737d">// 创建Person对象</span></span>
<span class="line"><span style="color:#e1e4e8">		Person person </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Person</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">		</span><span style="color:#6a737d">// 获得其属性 name 的偏移量</span></span>
<span class="line"><span style="color:#e1e4e8">		Field field </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> Person.class.</span><span style="color:#b392f0">getDeclaredField</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"name"</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">		</span><span style="color:#f97583">long</span><span style="color:#e1e4e8"> offset </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> unsafe.</span><span style="color:#b392f0">objectFieldOffset</span><span style="color:#e1e4e8">(field);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">		</span><span style="color:#6a737d">// 通过unsafe的CAS操作改变值</span></span>
<span class="line"><span style="color:#e1e4e8">		unsafe.</span><span style="color:#b392f0">compareAndSwapObject</span><span style="color:#e1e4e8">(person, offset, </span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8">, </span><span style="color:#9ecbff">"klaus"</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">		System.out.</span><span style="color:#b392f0">println</span><span style="color:#e1e4e8">(person);</span></span>
<span class="line"><span style="color:#e1e4e8">	}</span></span>
<span class="line"><span style="color:#e1e4e8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#f97583">class</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Person</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">// 配合CAS操作，必须用volatile修饰</span></span>
<span class="line"><span style="color:#e1e4e8"> 	</span><span style="color:#f97583">volatile</span><span style="color:#e1e4e8"> String name;</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">	@</span><span style="color:#f97583">Override</span></span>
<span class="line"><span style="color:#e1e4e8">	</span><span style="color:#f97583">public</span><span style="color:#e1e4e8"> String </span><span style="color:#b392f0">toString</span><span style="color:#e1e4e8">() {</span></span>
<span class="line"><span style="color:#e1e4e8">		</span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> </span><span style="color:#9ecbff">"Person{"</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">+</span></span>
<span class="line"><span style="color:#e1e4e8">				</span><span style="color:#9ecbff">"name='"</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">+</span><span style="color:#e1e4e8"> name </span><span style="color:#f97583">+</span><span style="color:#e1e4e8"> </span><span style="color:#9ecbff">'</span><span style="color:#79b8ff">\'</span><span style="color:#9ecbff">'</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">+</span></span>
<span class="line"><span style="color:#e1e4e8">				</span><span style="color:#9ecbff">'}'</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">	}</span></span>
<span class="line"><span style="color:#e1e4e8">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">class</span><span style="color:#24292e"> </span><span style="color:#6f42c1">GetUnsafe</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">	</span><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">static</span><span style="color:#24292e"> </span><span style="color:#d73a49">void</span><span style="color:#24292e"> </span><span style="color:#6f42c1">main</span><span style="color:#24292e">(</span><span style="color:#d73a49">String</span><span style="color:#24292e">[] </span><span style="color:#e36209">args</span><span style="color:#24292e">) </span><span style="color:#d73a49">throws</span><span style="color:#24292e"> NoSuchMethodException, IllegalAccessException, InvocationTargetException, InstantiationException, NoSuchFieldException {</span></span>
<span class="line"><span style="color:#24292e">		</span><span style="color:#6a737d">// 通过反射获得Unsafe对象</span></span>
<span class="line"><span style="color:#24292e">		Class unsafeClass </span><span style="color:#d73a49">=</span><span style="color:#24292e"> Unsafe.class;</span></span>
<span class="line"><span style="color:#24292e">		</span><span style="color:#6a737d">// 获得构造函数，Unsafe的构造函数为私有的</span></span>
<span class="line"><span style="color:#24292e">		Constructor constructor </span><span style="color:#d73a49">=</span><span style="color:#24292e"> unsafeClass.</span><span style="color:#6f42c1">getDeclaredConstructor</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">		</span><span style="color:#6a737d">// 设置为允许访问私有内容</span></span>
<span class="line"><span style="color:#24292e">		constructor.</span><span style="color:#6f42c1">setAccessible</span><span style="color:#24292e">(</span><span style="color:#005cc5">true</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">		</span><span style="color:#6a737d">// 创建Unsafe对象</span></span>
<span class="line"><span style="color:#24292e">		Unsafe unsafe </span><span style="color:#d73a49">=</span><span style="color:#24292e"> (Unsafe) constructor.</span><span style="color:#6f42c1">newInstance</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">		</span></span>
<span class="line"><span style="color:#24292e">		</span><span style="color:#6a737d">// 创建Person对象</span></span>
<span class="line"><span style="color:#24292e">		Person person </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Person</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">		</span><span style="color:#6a737d">// 获得其属性 name 的偏移量</span></span>
<span class="line"><span style="color:#24292e">		Field field </span><span style="color:#d73a49">=</span><span style="color:#24292e"> Person.class.</span><span style="color:#6f42c1">getDeclaredField</span><span style="color:#24292e">(</span><span style="color:#032f62">"name"</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">		</span><span style="color:#d73a49">long</span><span style="color:#24292e"> offset </span><span style="color:#d73a49">=</span><span style="color:#24292e"> unsafe.</span><span style="color:#6f42c1">objectFieldOffset</span><span style="color:#24292e">(field);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">		</span><span style="color:#6a737d">// 通过unsafe的CAS操作改变值</span></span>
<span class="line"><span style="color:#24292e">		unsafe.</span><span style="color:#6f42c1">compareAndSwapObject</span><span style="color:#24292e">(person, offset, </span><span style="color:#005cc5">null</span><span style="color:#24292e">, </span><span style="color:#032f62">"klaus"</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">		System.out.</span><span style="color:#6f42c1">println</span><span style="color:#24292e">(person);</span></span>
<span class="line"><span style="color:#24292e">	}</span></span>
<span class="line"><span style="color:#24292e">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#d73a49">class</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Person</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">// 配合CAS操作，必须用volatile修饰</span></span>
<span class="line"><span style="color:#24292e"> 	</span><span style="color:#d73a49">volatile</span><span style="color:#24292e"> String name;</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">	@</span><span style="color:#d73a49">Override</span></span>
<span class="line"><span style="color:#24292e">	</span><span style="color:#d73a49">public</span><span style="color:#24292e"> String </span><span style="color:#6f42c1">toString</span><span style="color:#24292e">() {</span></span>
<span class="line"><span style="color:#24292e">		</span><span style="color:#d73a49">return</span><span style="color:#24292e"> </span><span style="color:#032f62">"Person{"</span><span style="color:#24292e"> </span><span style="color:#d73a49">+</span></span>
<span class="line"><span style="color:#24292e">				</span><span style="color:#032f62">"name='"</span><span style="color:#24292e"> </span><span style="color:#d73a49">+</span><span style="color:#24292e"> name </span><span style="color:#d73a49">+</span><span style="color:#24292e"> </span><span style="color:#032f62">'</span><span style="color:#005cc5">\'</span><span style="color:#032f62">'</span><span style="color:#24292e"> </span><span style="color:#d73a49">+</span></span>
<span class="line"><span style="color:#24292e">				</span><span style="color:#032f62">'}'</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">	}</span></span>
<span class="line"><span style="color:#24292e">}</span></span></code></pre></div><p>模拟原子整数</p><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">static</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">void</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">main</span><span style="color:#e1e4e8">(</span><span style="color:#f97583">String</span><span style="color:#e1e4e8">[] args) {</span></span>
<span class="line"><span style="color:#e1e4e8">        Account.</span><span style="color:#b392f0">demo</span><span style="color:#e1e4e8">(</span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">MyAtomicInteger</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">10000</span><span style="color:#e1e4e8">));</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"><span style="color:#e1e4e8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#f97583">class</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">MyAtomicInteger</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">implements</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Account</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">private</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">volatile</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> value;</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">private</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">static</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">final</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">long</span><span style="color:#e1e4e8"> valueOffset;</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">private</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">static</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">final</span><span style="color:#e1e4e8"> Unsafe UNSAFE;</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">static</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">        UNSAFE </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> UnsafeAccessor.</span><span style="color:#b392f0">getUnsafe</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">try</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">            valueOffset </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> UNSAFE.</span><span style="color:#b392f0">objectFieldOffset</span><span style="color:#e1e4e8">(MyAtomicInteger.class.</span><span style="color:#b392f0">getDeclaredField</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"value"</span><span style="color:#e1e4e8">));</span></span>
<span class="line"><span style="color:#e1e4e8">        } </span><span style="color:#f97583">catch</span><span style="color:#e1e4e8"> (NoSuchFieldException </span><span style="color:#ffab70">e</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">            e.</span><span style="color:#b392f0">printStackTrace</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">throw</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">RuntimeException</span><span style="color:#e1e4e8">(e);</span></span>
<span class="line"><span style="color:#e1e4e8">        }</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">getValue</span><span style="color:#e1e4e8">() {</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> value;</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">void</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">decrement</span><span style="color:#e1e4e8">(</span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> </span><span style="color:#ffab70">amount</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">while</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">true</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> prev </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">this</span><span style="color:#e1e4e8">.value;</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> next </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> prev </span><span style="color:#f97583">-</span><span style="color:#e1e4e8"> amount;</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (UNSAFE.</span><span style="color:#b392f0">compareAndSwapInt</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">this</span><span style="color:#e1e4e8">, valueOffset, prev, next)) {</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#f97583">break</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">            }</span></span>
<span class="line"><span style="color:#e1e4e8">        }</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">MyAtomicInteger</span><span style="color:#e1e4e8">(</span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> </span><span style="color:#ffab70">value</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#79b8ff">this</span><span style="color:#e1e4e8">.value </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> value;</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">    @</span><span style="color:#f97583">Override</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">public</span><span style="color:#e1e4e8"> Integer </span><span style="color:#b392f0">getBalance</span><span style="color:#e1e4e8">() {</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">getValue</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">    @</span><span style="color:#f97583">Override</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">void</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">withdraw</span><span style="color:#e1e4e8">(Integer </span><span style="color:#ffab70">amount</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#b392f0">decrement</span><span style="color:#e1e4e8">(amount);</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"><span style="color:#e1e4e8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#f97583">interface</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Account</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">// 获取余额</span></span>
<span class="line"><span style="color:#e1e4e8">    Integer </span><span style="color:#b392f0">getBalance</span><span style="color:#e1e4e8">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">// 取款</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">void</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">withdraw</span><span style="color:#e1e4e8">(Integer </span><span style="color:#ffab70">amount</span><span style="color:#e1e4e8">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6a737d">    /**</span></span>
<span class="line"><span style="color:#6a737d">     * 方法内会启动 1000 个线程，每个线程做 -10 元 的操作</span></span>
<span class="line"><span style="color:#6a737d">     * 如果初始余额为 10000 那么正确的结果应当是 0</span></span>
<span class="line"><span style="color:#6a737d">     */</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">static</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">void</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">demo</span><span style="color:#e1e4e8">(Account </span><span style="color:#ffab70">account</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">        List&lt;</span><span style="color:#f97583">Thread</span><span style="color:#e1e4e8">&gt; ts </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> ArrayList&lt;&gt;();</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">for</span><span style="color:#e1e4e8"> (</span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> i </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8">; i </span><span style="color:#f97583">&lt;</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">1000</span><span style="color:#e1e4e8">; i</span><span style="color:#f97583">++</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">            ts.</span><span style="color:#b392f0">add</span><span style="color:#e1e4e8">(</span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Thread</span><span style="color:#e1e4e8">(() </span><span style="color:#f97583">-&gt;</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">                account.</span><span style="color:#b392f0">withdraw</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">10</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">            }));</span></span>
<span class="line"><span style="color:#e1e4e8">        }</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">long</span><span style="color:#e1e4e8"> start </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> System.</span><span style="color:#b392f0">nanoTime</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">        ts.</span><span style="color:#b392f0">forEach</span><span style="color:#e1e4e8">(Thread</span><span style="color:#f97583">::</span><span style="color:#e1e4e8">start);</span></span>
<span class="line"><span style="color:#e1e4e8">        ts.</span><span style="color:#b392f0">forEach</span><span style="color:#e1e4e8">(t </span><span style="color:#f97583">-&gt;</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">try</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">                t.</span><span style="color:#b392f0">join</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">            } </span><span style="color:#f97583">catch</span><span style="color:#e1e4e8"> (InterruptedException </span><span style="color:#ffab70">e</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">                e.</span><span style="color:#b392f0">printStackTrace</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">            }</span></span>
<span class="line"><span style="color:#e1e4e8">        });</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">long</span><span style="color:#e1e4e8"> end </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> System.</span><span style="color:#b392f0">nanoTime</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">        System.out.</span><span style="color:#b392f0">println</span><span style="color:#e1e4e8">(account.</span><span style="color:#b392f0">getBalance</span><span style="color:#e1e4e8">()</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#f97583">+</span><span style="color:#e1e4e8"> </span><span style="color:#9ecbff">" cost: "</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">+</span><span style="color:#e1e4e8"> (end</span><span style="color:#f97583">-</span><span style="color:#e1e4e8">start)</span><span style="color:#f97583">/</span><span style="color:#79b8ff">1000_000</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">+</span><span style="color:#e1e4e8"> </span><span style="color:#9ecbff">" ms"</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"><span style="color:#e1e4e8">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">static</span><span style="color:#24292e"> </span><span style="color:#d73a49">void</span><span style="color:#24292e"> </span><span style="color:#6f42c1">main</span><span style="color:#24292e">(</span><span style="color:#d73a49">String</span><span style="color:#24292e">[] args) {</span></span>
<span class="line"><span style="color:#24292e">        Account.</span><span style="color:#6f42c1">demo</span><span style="color:#24292e">(</span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">MyAtomicInteger</span><span style="color:#24292e">(</span><span style="color:#005cc5">10000</span><span style="color:#24292e">));</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"><span style="color:#24292e">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#d73a49">class</span><span style="color:#24292e"> </span><span style="color:#6f42c1">MyAtomicInteger</span><span style="color:#24292e"> </span><span style="color:#d73a49">implements</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Account</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">private</span><span style="color:#24292e"> </span><span style="color:#d73a49">volatile</span><span style="color:#24292e"> </span><span style="color:#d73a49">int</span><span style="color:#24292e"> value;</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">private</span><span style="color:#24292e"> </span><span style="color:#d73a49">static</span><span style="color:#24292e"> </span><span style="color:#d73a49">final</span><span style="color:#24292e"> </span><span style="color:#d73a49">long</span><span style="color:#24292e"> valueOffset;</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">private</span><span style="color:#24292e"> </span><span style="color:#d73a49">static</span><span style="color:#24292e"> </span><span style="color:#d73a49">final</span><span style="color:#24292e"> Unsafe UNSAFE;</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">static</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">        UNSAFE </span><span style="color:#d73a49">=</span><span style="color:#24292e"> UnsafeAccessor.</span><span style="color:#6f42c1">getUnsafe</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">try</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">            valueOffset </span><span style="color:#d73a49">=</span><span style="color:#24292e"> UNSAFE.</span><span style="color:#6f42c1">objectFieldOffset</span><span style="color:#24292e">(MyAtomicInteger.class.</span><span style="color:#6f42c1">getDeclaredField</span><span style="color:#24292e">(</span><span style="color:#032f62">"value"</span><span style="color:#24292e">));</span></span>
<span class="line"><span style="color:#24292e">        } </span><span style="color:#d73a49">catch</span><span style="color:#24292e"> (NoSuchFieldException </span><span style="color:#e36209">e</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">            e.</span><span style="color:#6f42c1">printStackTrace</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">throw</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">RuntimeException</span><span style="color:#24292e">(e);</span></span>
<span class="line"><span style="color:#24292e">        }</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">int</span><span style="color:#24292e"> </span><span style="color:#6f42c1">getValue</span><span style="color:#24292e">() {</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">return</span><span style="color:#24292e"> value;</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">void</span><span style="color:#24292e"> </span><span style="color:#6f42c1">decrement</span><span style="color:#24292e">(</span><span style="color:#d73a49">int</span><span style="color:#24292e"> </span><span style="color:#e36209">amount</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">while</span><span style="color:#24292e">(</span><span style="color:#005cc5">true</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">int</span><span style="color:#24292e"> prev </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#005cc5">this</span><span style="color:#24292e">.value;</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">int</span><span style="color:#24292e"> next </span><span style="color:#d73a49">=</span><span style="color:#24292e"> prev </span><span style="color:#d73a49">-</span><span style="color:#24292e"> amount;</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (UNSAFE.</span><span style="color:#6f42c1">compareAndSwapInt</span><span style="color:#24292e">(</span><span style="color:#005cc5">this</span><span style="color:#24292e">, valueOffset, prev, next)) {</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#d73a49">break</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">            }</span></span>
<span class="line"><span style="color:#24292e">        }</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#6f42c1">MyAtomicInteger</span><span style="color:#24292e">(</span><span style="color:#d73a49">int</span><span style="color:#24292e"> </span><span style="color:#e36209">value</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#005cc5">this</span><span style="color:#24292e">.value </span><span style="color:#d73a49">=</span><span style="color:#24292e"> value;</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">    @</span><span style="color:#d73a49">Override</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">public</span><span style="color:#24292e"> Integer </span><span style="color:#6f42c1">getBalance</span><span style="color:#24292e">() {</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">return</span><span style="color:#24292e"> </span><span style="color:#6f42c1">getValue</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">    @</span><span style="color:#d73a49">Override</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">void</span><span style="color:#24292e"> </span><span style="color:#6f42c1">withdraw</span><span style="color:#24292e">(Integer </span><span style="color:#e36209">amount</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6f42c1">decrement</span><span style="color:#24292e">(amount);</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"><span style="color:#24292e">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#d73a49">interface</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Account</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">// 获取余额</span></span>
<span class="line"><span style="color:#24292e">    Integer </span><span style="color:#6f42c1">getBalance</span><span style="color:#24292e">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">// 取款</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">void</span><span style="color:#24292e"> </span><span style="color:#6f42c1">withdraw</span><span style="color:#24292e">(Integer </span><span style="color:#e36209">amount</span><span style="color:#24292e">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6a737d">    /**</span></span>
<span class="line"><span style="color:#6a737d">     * 方法内会启动 1000 个线程，每个线程做 -10 元 的操作</span></span>
<span class="line"><span style="color:#6a737d">     * 如果初始余额为 10000 那么正确的结果应当是 0</span></span>
<span class="line"><span style="color:#6a737d">     */</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">static</span><span style="color:#24292e"> </span><span style="color:#d73a49">void</span><span style="color:#24292e"> </span><span style="color:#6f42c1">demo</span><span style="color:#24292e">(Account </span><span style="color:#e36209">account</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">        List&lt;</span><span style="color:#d73a49">Thread</span><span style="color:#24292e">&gt; ts </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> ArrayList&lt;&gt;();</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">for</span><span style="color:#24292e"> (</span><span style="color:#d73a49">int</span><span style="color:#24292e"> i </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#005cc5">0</span><span style="color:#24292e">; i </span><span style="color:#d73a49">&lt;</span><span style="color:#24292e"> </span><span style="color:#005cc5">1000</span><span style="color:#24292e">; i</span><span style="color:#d73a49">++</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">            ts.</span><span style="color:#6f42c1">add</span><span style="color:#24292e">(</span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Thread</span><span style="color:#24292e">(() </span><span style="color:#d73a49">-&gt;</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">                account.</span><span style="color:#6f42c1">withdraw</span><span style="color:#24292e">(</span><span style="color:#005cc5">10</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">            }));</span></span>
<span class="line"><span style="color:#24292e">        }</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">long</span><span style="color:#24292e"> start </span><span style="color:#d73a49">=</span><span style="color:#24292e"> System.</span><span style="color:#6f42c1">nanoTime</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">        ts.</span><span style="color:#6f42c1">forEach</span><span style="color:#24292e">(Thread</span><span style="color:#d73a49">::</span><span style="color:#24292e">start);</span></span>
<span class="line"><span style="color:#24292e">        ts.</span><span style="color:#6f42c1">forEach</span><span style="color:#24292e">(t </span><span style="color:#d73a49">-&gt;</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">try</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">                t.</span><span style="color:#6f42c1">join</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">            } </span><span style="color:#d73a49">catch</span><span style="color:#24292e"> (InterruptedException </span><span style="color:#e36209">e</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">                e.</span><span style="color:#6f42c1">printStackTrace</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">            }</span></span>
<span class="line"><span style="color:#24292e">        });</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">long</span><span style="color:#24292e"> end </span><span style="color:#d73a49">=</span><span style="color:#24292e"> System.</span><span style="color:#6f42c1">nanoTime</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">        System.out.</span><span style="color:#6f42c1">println</span><span style="color:#24292e">(account.</span><span style="color:#6f42c1">getBalance</span><span style="color:#24292e">()</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#d73a49">+</span><span style="color:#24292e"> </span><span style="color:#032f62">" cost: "</span><span style="color:#24292e"> </span><span style="color:#d73a49">+</span><span style="color:#24292e"> (end</span><span style="color:#d73a49">-</span><span style="color:#24292e">start)</span><span style="color:#d73a49">/</span><span style="color:#005cc5">1000_000</span><span style="color:#24292e"> </span><span style="color:#d73a49">+</span><span style="color:#24292e"> </span><span style="color:#032f62">" ms"</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"><span style="color:#24292e">}</span></span></code></pre></div><p>输出：0 cost：125 ms</p><h2 id="六、共享模型之不可变" tabindex="-1">六、共享模型之不可变 <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20intermediate%20level#六、共享模型之不可变" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h2><h3 id="_1、日期转换的问题" tabindex="-1">1、日期转换的问题 <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20intermediate%20level#_1、日期转换的问题" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h3><p>下面的代码在运行时，由于 SimpleDateFormat 不是线程安全的</p><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8">SimpleDateFormat sdf </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">SimpleDateFormat</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"yyyy-MM-dd"</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#f97583">for</span><span style="color:#e1e4e8"> (</span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> i </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8">; i </span><span style="color:#f97583">&lt;</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">10</span><span style="color:#e1e4e8">; i</span><span style="color:#f97583">++</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Thread</span><span style="color:#e1e4e8">(() </span><span style="color:#f97583">-&gt;</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">try</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">        	log.</span><span style="color:#b392f0">debug</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"{}"</span><span style="color:#e1e4e8">, sdf.</span><span style="color:#b392f0">parse</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"1951-04-21"</span><span style="color:#e1e4e8">));</span></span>
<span class="line"><span style="color:#e1e4e8">        } </span><span style="color:#f97583">catch</span><span style="color:#e1e4e8"> (Exception </span><span style="color:#ffab70">e</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">        	log.</span><span style="color:#b392f0">error</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"{}"</span><span style="color:#e1e4e8">, e);	</span></span>
<span class="line"><span style="color:#e1e4e8">        }</span></span>
<span class="line"><span style="color:#e1e4e8">    }).</span><span style="color:#b392f0">start</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e">SimpleDateFormat sdf </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">SimpleDateFormat</span><span style="color:#24292e">(</span><span style="color:#032f62">"yyyy-MM-dd"</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#d73a49">for</span><span style="color:#24292e"> (</span><span style="color:#d73a49">int</span><span style="color:#24292e"> i </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#005cc5">0</span><span style="color:#24292e">; i </span><span style="color:#d73a49">&lt;</span><span style="color:#24292e"> </span><span style="color:#005cc5">10</span><span style="color:#24292e">; i</span><span style="color:#d73a49">++</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Thread</span><span style="color:#24292e">(() </span><span style="color:#d73a49">-&gt;</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">try</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">        	log.</span><span style="color:#6f42c1">debug</span><span style="color:#24292e">(</span><span style="color:#032f62">"{}"</span><span style="color:#24292e">, sdf.</span><span style="color:#6f42c1">parse</span><span style="color:#24292e">(</span><span style="color:#032f62">"1951-04-21"</span><span style="color:#24292e">));</span></span>
<span class="line"><span style="color:#24292e">        } </span><span style="color:#d73a49">catch</span><span style="color:#24292e"> (Exception </span><span style="color:#e36209">e</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">        	log.</span><span style="color:#6f42c1">error</span><span style="color:#24292e">(</span><span style="color:#032f62">"{}"</span><span style="color:#24292e">, e);	</span></span>
<span class="line"><span style="color:#24292e">        }</span></span>
<span class="line"><span style="color:#24292e">    }).</span><span style="color:#6f42c1">start</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">}</span></span></code></pre></div><p>有很大几率出现 java.lang.NumberFormatException 或者出现不正确的日期解析结果</p><p><strong>思路 - 同步锁</strong> 这样虽能解决问题，但带来的是性能上的损失，并不算很好：</p><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8">SimpleDateFormat sdf </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">SimpleDateFormat</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"yyyy-MM-dd"</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#f97583">for</span><span style="color:#e1e4e8"> (</span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> i </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8">; i </span><span style="color:#f97583">&lt;</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">50</span><span style="color:#e1e4e8">; i</span><span style="color:#f97583">++</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Thread</span><span style="color:#e1e4e8">(() </span><span style="color:#f97583">-&gt;</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">synchronized</span><span style="color:#e1e4e8"> (sdf) {</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">try</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">                	log.</span><span style="color:#b392f0">debug</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"{}"</span><span style="color:#e1e4e8">, sdf.</span><span style="color:#b392f0">parse</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"1951-04-21"</span><span style="color:#e1e4e8">));</span></span>
<span class="line"><span style="color:#e1e4e8">                } </span><span style="color:#f97583">catch</span><span style="color:#e1e4e8"> (Exception </span><span style="color:#ffab70">e</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">                	log.</span><span style="color:#b392f0">error</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"{}"</span><span style="color:#e1e4e8">, e);</span></span>
<span class="line"><span style="color:#e1e4e8">                }</span></span>
<span class="line"><span style="color:#e1e4e8">        }</span></span>
<span class="line"><span style="color:#e1e4e8">    }).</span><span style="color:#b392f0">start</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e">SimpleDateFormat sdf </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">SimpleDateFormat</span><span style="color:#24292e">(</span><span style="color:#032f62">"yyyy-MM-dd"</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#d73a49">for</span><span style="color:#24292e"> (</span><span style="color:#d73a49">int</span><span style="color:#24292e"> i </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#005cc5">0</span><span style="color:#24292e">; i </span><span style="color:#d73a49">&lt;</span><span style="color:#24292e"> </span><span style="color:#005cc5">50</span><span style="color:#24292e">; i</span><span style="color:#d73a49">++</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Thread</span><span style="color:#24292e">(() </span><span style="color:#d73a49">-&gt;</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">synchronized</span><span style="color:#24292e"> (sdf) {</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">try</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">                	log.</span><span style="color:#6f42c1">debug</span><span style="color:#24292e">(</span><span style="color:#032f62">"{}"</span><span style="color:#24292e">, sdf.</span><span style="color:#6f42c1">parse</span><span style="color:#24292e">(</span><span style="color:#032f62">"1951-04-21"</span><span style="color:#24292e">));</span></span>
<span class="line"><span style="color:#24292e">                } </span><span style="color:#d73a49">catch</span><span style="color:#24292e"> (Exception </span><span style="color:#e36209">e</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">                	log.</span><span style="color:#6f42c1">error</span><span style="color:#24292e">(</span><span style="color:#032f62">"{}"</span><span style="color:#24292e">, e);</span></span>
<span class="line"><span style="color:#24292e">                }</span></span>
<span class="line"><span style="color:#24292e">        }</span></span>
<span class="line"><span style="color:#24292e">    }).</span><span style="color:#6f42c1">start</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">}</span></span></code></pre></div><p><strong>思路 - 不可变</strong> 如果一个对象在不能够修改其内部状态（属性），那么它就是线程安全的，因为不存在并发修改啊！这样的对象在 Java 中有很多，例如在 Java 8 后，提供了一个新的日期格式化类：</p><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8">DateTimeFormatter dtf </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> DateTimeFormatter.</span><span style="color:#b392f0">ofPattern</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"yyyy-MM-dd"</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#f97583">for</span><span style="color:#e1e4e8"> (</span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> i </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8">; i </span><span style="color:#f97583">&lt;</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">10</span><span style="color:#e1e4e8">; i</span><span style="color:#f97583">++</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Thread</span><span style="color:#e1e4e8">(() </span><span style="color:#f97583">-&gt;</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">        LocalDate date </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> dtf.</span><span style="color:#b392f0">parse</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"2018-10-01"</span><span style="color:#e1e4e8">, LocalDate</span><span style="color:#f97583">::</span><span style="color:#e1e4e8">from);</span></span>
<span class="line"><span style="color:#e1e4e8">        log.</span><span style="color:#b392f0">debug</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"{}"</span><span style="color:#e1e4e8">, date);</span></span>
<span class="line"><span style="color:#e1e4e8">    }).</span><span style="color:#b392f0">start</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e">DateTimeFormatter dtf </span><span style="color:#d73a49">=</span><span style="color:#24292e"> DateTimeFormatter.</span><span style="color:#6f42c1">ofPattern</span><span style="color:#24292e">(</span><span style="color:#032f62">"yyyy-MM-dd"</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#d73a49">for</span><span style="color:#24292e"> (</span><span style="color:#d73a49">int</span><span style="color:#24292e"> i </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#005cc5">0</span><span style="color:#24292e">; i </span><span style="color:#d73a49">&lt;</span><span style="color:#24292e"> </span><span style="color:#005cc5">10</span><span style="color:#24292e">; i</span><span style="color:#d73a49">++</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Thread</span><span style="color:#24292e">(() </span><span style="color:#d73a49">-&gt;</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">        LocalDate date </span><span style="color:#d73a49">=</span><span style="color:#24292e"> dtf.</span><span style="color:#6f42c1">parse</span><span style="color:#24292e">(</span><span style="color:#032f62">"2018-10-01"</span><span style="color:#24292e">, LocalDate</span><span style="color:#d73a49">::</span><span style="color:#24292e">from);</span></span>
<span class="line"><span style="color:#24292e">        log.</span><span style="color:#6f42c1">debug</span><span style="color:#24292e">(</span><span style="color:#032f62">"{}"</span><span style="color:#24292e">, date);</span></span>
<span class="line"><span style="color:#24292e">    }).</span><span style="color:#6f42c1">start</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">}</span></span></code></pre></div><p>可以看 DateTimeFormatter 的文档：</p><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8">@</span><span style="color:#f97583">implSpec</span></span>
<span class="line"><span style="color:#e1e4e8">This </span><span style="color:#f97583">class</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">is</span><span style="color:#e1e4e8"> immutable and thread-safe.</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e">@</span><span style="color:#d73a49">implSpec</span></span>
<span class="line"><span style="color:#24292e">This </span><span style="color:#d73a49">class</span><span style="color:#24292e"> </span><span style="color:#6f42c1">is</span><span style="color:#24292e"> immutable and thread-safe.</span></span></code></pre></div><p>不可变对象，实际是另一种避免竞争的方式。</p><h3 id="_2、不可变设计" tabindex="-1">2、不可变设计 <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20intermediate%20level#_2、不可变设计" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h3><h4 id="string类中不可变的体现" tabindex="-1">String类中不可变的体现 <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20intermediate%20level#string类中不可变的体现" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h4><p>另一个大家更为熟悉的 String 类也是不可变的，以它为例，说明一下不可变设计的要素</p><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">final</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">class</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">String</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">implements</span><span style="color:#e1e4e8"> java.io.</span><span style="color:#b392f0">Serializable</span><span style="color:#e1e4e8">, </span><span style="color:#b392f0">Comparable</span><span style="color:#e1e4e8">&lt;</span><span style="color:#f97583">String</span><span style="color:#e1e4e8">&gt;, </span><span style="color:#b392f0">CharSequence</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#6a737d">    /** The value is used for character storage. */</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">private</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">final</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">char</span><span style="color:#e1e4e8"> value[];</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6a737d">    /** Cache the hash code for the string */</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">private</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> hash; </span><span style="color:#6a737d">// Default to 0</span></span>
<span class="line"><span style="color:#e1e4e8">    </span></span>
<span class="line"><span style="color:#e1e4e8">   </span><span style="color:#6a737d">//....</span></span>
<span class="line"><span style="color:#e1e4e8">  }</span></span>
<span class="line"><span style="color:#e1e4e8">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">final</span><span style="color:#24292e"> </span><span style="color:#d73a49">class</span><span style="color:#24292e"> </span><span style="color:#6f42c1">String</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">implements</span><span style="color:#24292e"> java.io.</span><span style="color:#6f42c1">Serializable</span><span style="color:#24292e">, </span><span style="color:#6f42c1">Comparable</span><span style="color:#24292e">&lt;</span><span style="color:#d73a49">String</span><span style="color:#24292e">&gt;, </span><span style="color:#6f42c1">CharSequence</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#6a737d">    /** The value is used for character storage. */</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">private</span><span style="color:#24292e"> </span><span style="color:#d73a49">final</span><span style="color:#24292e"> </span><span style="color:#d73a49">char</span><span style="color:#24292e"> value[];</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6a737d">    /** Cache the hash code for the string */</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">private</span><span style="color:#24292e"> </span><span style="color:#d73a49">int</span><span style="color:#24292e"> hash; </span><span style="color:#6a737d">// Default to 0</span></span>
<span class="line"><span style="color:#24292e">    </span></span>
<span class="line"><span style="color:#24292e">   </span><span style="color:#6a737d">//....</span></span>
<span class="line"><span style="color:#24292e">  }</span></span>
<span class="line"><span style="color:#24292e">}</span></span></code></pre></div><p><strong>ﬁnal 的使用</strong></p><p>发现该类、类中所有属性都是 <strong>ﬁnal</strong> 的</p><ul><li>属性用 ﬁnal 修饰保证了该属性是只读的，不能修改</li><li>类用 ﬁnal 修饰保证了该类中的方法不能被覆盖，<strong>防止子类无意间破坏不可变性</strong></li></ul><p><strong>保护性拷贝</strong></p><p>但有同学会说，使用字符串时，也有一些跟修改相关的方法啊，比如 substring 等，那么下面就看一看这些方法是 如何实现的，就以 substring 为例</p><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#f97583">public</span><span style="color:#e1e4e8"> String </span><span style="color:#b392f0">substring</span><span style="color:#e1e4e8">(</span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> beginIndex) {</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (beginIndex </span><span style="color:#f97583">&lt;</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">throw</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">StringIndexOutOfBoundsException</span><span style="color:#e1e4e8">(beginIndex);</span></span>
<span class="line"><span style="color:#e1e4e8">        }</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> subLen </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> value.length </span><span style="color:#f97583">-</span><span style="color:#e1e4e8"> beginIndex;</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (subLen </span><span style="color:#f97583">&lt;</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">throw</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">StringIndexOutOfBoundsException</span><span style="color:#e1e4e8">(subLen);</span></span>
<span class="line"><span style="color:#e1e4e8">        }</span></span>
<span class="line"><span style="color:#e1e4e8">    	</span><span style="color:#6a737d">//返回的是一个新的对象</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> (beginIndex </span><span style="color:#f97583">==</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8">) </span><span style="color:#f97583">?</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">this</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">:</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">String</span><span style="color:#e1e4e8">(value, beginIndex, subLen);</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#d73a49">public</span><span style="color:#24292e"> String </span><span style="color:#6f42c1">substring</span><span style="color:#24292e">(</span><span style="color:#d73a49">int</span><span style="color:#24292e"> beginIndex) {</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (beginIndex </span><span style="color:#d73a49">&lt;</span><span style="color:#24292e"> </span><span style="color:#005cc5">0</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">throw</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">StringIndexOutOfBoundsException</span><span style="color:#24292e">(beginIndex);</span></span>
<span class="line"><span style="color:#24292e">        }</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">int</span><span style="color:#24292e"> subLen </span><span style="color:#d73a49">=</span><span style="color:#24292e"> value.length </span><span style="color:#d73a49">-</span><span style="color:#24292e"> beginIndex;</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (subLen </span><span style="color:#d73a49">&lt;</span><span style="color:#24292e"> </span><span style="color:#005cc5">0</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">throw</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">StringIndexOutOfBoundsException</span><span style="color:#24292e">(subLen);</span></span>
<span class="line"><span style="color:#24292e">        }</span></span>
<span class="line"><span style="color:#24292e">    	</span><span style="color:#6a737d">//返回的是一个新的对象</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">return</span><span style="color:#24292e"> (beginIndex </span><span style="color:#d73a49">==</span><span style="color:#24292e"> </span><span style="color:#005cc5">0</span><span style="color:#24292e">) </span><span style="color:#d73a49">?</span><span style="color:#24292e"> </span><span style="color:#005cc5">this</span><span style="color:#24292e"> </span><span style="color:#d73a49">:</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">String</span><span style="color:#24292e">(value, beginIndex, subLen);</span></span>
<span class="line"><span style="color:#24292e">    }</span></span></code></pre></div><p>发现其内部是调用 String 的构造方法<strong>创建了一个新字符串</strong></p><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">String</span><span style="color:#e1e4e8">(</span><span style="color:#f97583">char</span><span style="color:#e1e4e8"> value[], </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> offset, </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> count) {</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (offset </span><span style="color:#f97583">&lt;</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">throw</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">StringIndexOutOfBoundsException</span><span style="color:#e1e4e8">(offset);</span></span>
<span class="line"><span style="color:#e1e4e8">        }</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (count </span><span style="color:#f97583">&lt;=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (count </span><span style="color:#f97583">&lt;</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#f97583">throw</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">StringIndexOutOfBoundsException</span><span style="color:#e1e4e8">(count);</span></span>
<span class="line"><span style="color:#e1e4e8">            }</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (offset </span><span style="color:#f97583">&lt;=</span><span style="color:#e1e4e8"> value.length) {</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#79b8ff">this</span><span style="color:#e1e4e8">.value </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#9ecbff">""</span><span style="color:#e1e4e8">.value;</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#f97583">return</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">            }</span></span>
<span class="line"><span style="color:#e1e4e8">        }</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#6a737d">// Note: offset or count might be near -1&gt;&gt;&gt;1.</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (offset </span><span style="color:#f97583">&gt;</span><span style="color:#e1e4e8"> value.length </span><span style="color:#f97583">-</span><span style="color:#e1e4e8"> count) {</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">throw</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">StringIndexOutOfBoundsException</span><span style="color:#e1e4e8">(offset </span><span style="color:#f97583">+</span><span style="color:#e1e4e8"> count);</span></span>
<span class="line"><span style="color:#e1e4e8">        }</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#79b8ff">this</span><span style="color:#e1e4e8">.value </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> Arrays.</span><span style="color:#b392f0">OfRange</span><span style="color:#e1e4e8">(value, offset, offset</span><span style="color:#f97583">+</span><span style="color:#e1e4e8">count);</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#6f42c1">String</span><span style="color:#24292e">(</span><span style="color:#d73a49">char</span><span style="color:#24292e"> value[], </span><span style="color:#d73a49">int</span><span style="color:#24292e"> offset, </span><span style="color:#d73a49">int</span><span style="color:#24292e"> count) {</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (offset </span><span style="color:#d73a49">&lt;</span><span style="color:#24292e"> </span><span style="color:#005cc5">0</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">throw</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">StringIndexOutOfBoundsException</span><span style="color:#24292e">(offset);</span></span>
<span class="line"><span style="color:#24292e">        }</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (count </span><span style="color:#d73a49">&lt;=</span><span style="color:#24292e"> </span><span style="color:#005cc5">0</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (count </span><span style="color:#d73a49">&lt;</span><span style="color:#24292e"> </span><span style="color:#005cc5">0</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#d73a49">throw</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">StringIndexOutOfBoundsException</span><span style="color:#24292e">(count);</span></span>
<span class="line"><span style="color:#24292e">            }</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (offset </span><span style="color:#d73a49">&lt;=</span><span style="color:#24292e"> value.length) {</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#005cc5">this</span><span style="color:#24292e">.value </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#032f62">""</span><span style="color:#24292e">.value;</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#d73a49">return</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">            }</span></span>
<span class="line"><span style="color:#24292e">        }</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6a737d">// Note: offset or count might be near -1&gt;&gt;&gt;1.</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (offset </span><span style="color:#d73a49">&gt;</span><span style="color:#24292e"> value.length </span><span style="color:#d73a49">-</span><span style="color:#24292e"> count) {</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">throw</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">StringIndexOutOfBoundsException</span><span style="color:#24292e">(offset </span><span style="color:#d73a49">+</span><span style="color:#24292e"> count);</span></span>
<span class="line"><span style="color:#24292e">        }</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#005cc5">this</span><span style="color:#24292e">.value </span><span style="color:#d73a49">=</span><span style="color:#24292e"> Arrays.</span><span style="color:#6f42c1">OfRange</span><span style="color:#24292e">(value, offset, offset</span><span style="color:#d73a49">+</span><span style="color:#24292e">count);</span></span>
<span class="line"><span style="color:#24292e">    }</span></span></code></pre></div><p>构造新字符串对象时，会生成新的 char[] value，对内容进行复制 。这种通过创建副本对象来避免共享的手段称之为【<strong>保护性拷贝</strong>（defensive ）】</p><h3 id="_3、享元模式" tabindex="-1">3、享元模式 <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20intermediate%20level#_3、享元模式" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h3><h4 id="_1-简介" tabindex="-1">1）简介 <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20intermediate%20level#_1-简介" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h4><p><strong>定义</strong> 英文名称：Flyweight pattern. 当需要重用数量有限的同一类对象时</p><blockquote><p>wikipedia： A flyweight is an object that minimizes memory usage by sharing as much data as possible with other similar objects</p></blockquote><p><strong>出自</strong> "Gang of Four" design patterns <strong>归类</strong> Structual patterns</p><h4 id="_2-体现" tabindex="-1">2）体现 <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20intermediate%20level#_2-体现" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h4><h5 id="包装类" tabindex="-1">包装类 <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20intermediate%20level#包装类" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h5><p>在JDK中 Boolean，Byte，Short，Integer，Long，Character 等包装类提供了 valueOf 方法，例如 Long 的 valueOf 会缓存 -128~127 之间的 Long 对象，在这个范围之间会重用对象，大于这个范围，才会新建 Long 对 象：</p><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">static</span><span style="color:#e1e4e8"> Long </span><span style="color:#b392f0">valueOf</span><span style="color:#e1e4e8">(</span><span style="color:#f97583">long</span><span style="color:#e1e4e8"> l) {</span></span>
<span class="line"><span style="color:#f97583">final</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> offset </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">128</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (l </span><span style="color:#f97583">&gt;=</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">-</span><span style="color:#79b8ff">128</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">&amp;&amp;</span><span style="color:#e1e4e8"> l </span><span style="color:#f97583">&lt;=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">127</span><span style="color:#e1e4e8">) { </span><span style="color:#6a737d">// will cache</span></span>
<span class="line"><span style="color:#e1e4e8">	</span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> LongCache.cache[(</span><span style="color:#f97583">int</span><span style="color:#e1e4e8">)l </span><span style="color:#f97583">+</span><span style="color:#e1e4e8"> offset];</span></span>
<span class="line"><span style="color:#e1e4e8">}</span></span>
<span class="line"><span style="color:#e1e4e8">	</span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Long</span><span style="color:#e1e4e8">(l);</span></span>
<span class="line"><span style="color:#e1e4e8">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">static</span><span style="color:#24292e"> Long </span><span style="color:#6f42c1">valueOf</span><span style="color:#24292e">(</span><span style="color:#d73a49">long</span><span style="color:#24292e"> l) {</span></span>
<span class="line"><span style="color:#d73a49">final</span><span style="color:#24292e"> </span><span style="color:#d73a49">int</span><span style="color:#24292e"> offset </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#005cc5">128</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#d73a49">if</span><span style="color:#24292e"> (l </span><span style="color:#d73a49">&gt;=</span><span style="color:#24292e"> </span><span style="color:#d73a49">-</span><span style="color:#005cc5">128</span><span style="color:#24292e"> </span><span style="color:#d73a49">&amp;&amp;</span><span style="color:#24292e"> l </span><span style="color:#d73a49">&lt;=</span><span style="color:#24292e"> </span><span style="color:#005cc5">127</span><span style="color:#24292e">) { </span><span style="color:#6a737d">// will cache</span></span>
<span class="line"><span style="color:#24292e">	</span><span style="color:#d73a49">return</span><span style="color:#24292e"> LongCache.cache[(</span><span style="color:#d73a49">int</span><span style="color:#24292e">)l </span><span style="color:#d73a49">+</span><span style="color:#24292e"> offset];</span></span>
<span class="line"><span style="color:#24292e">}</span></span>
<span class="line"><span style="color:#24292e">	</span><span style="color:#d73a49">return</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Long</span><span style="color:#24292e">(l);</span></span>
<span class="line"><span style="color:#24292e">}</span></span></code></pre></div><blockquote><p>注意：</p><ul><li>Byte, Short, Long 缓存的范围都是 -128~127</li><li>Character 缓存的范围是 0~127</li><li>Integer的默认范围是 -128~127<ul><li>最小值不能变</li><li>但最大值可以通过调整虚拟机参数 <code>-Djava.lang.Integer.IntegerCache.high</code> 来改变</li></ul></li><li>Boolean 缓存了 TRUE 和 FALSE</li></ul></blockquote><h5 id="string-串池" tabindex="-1">String 串池 <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20intermediate%20level#string-串池" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h5><h5 id="bigdecimal-biginteger" tabindex="-1">BigDecimal BigInteger <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20intermediate%20level#bigdecimal-biginteger" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h5><p>底层用的也是保护性拷贝，单个创建操作是线程安全的，但多个操作组合就不一定，非原子性，所以需要用到原子引用类来保证原子操作</p><h4 id="_3-自定义连接池" tabindex="-1">3）自定义连接池 <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20intermediate%20level#_3-自定义连接池" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h4><p>例如：一个线上商城应用，QPS 达到数千，如果每次都重新创建和关闭数据库连接，性能会受到极大影响。 这时 预先创建好一批连接，放入连接池。一次请求到达后，从连接池获取连接，使用完毕后再还回连接池，这样既节约 了连接的创建和关闭时间，也实现了连接的重用，不至于让庞大的连接数压垮数据库。</p><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">static</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">void</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">main</span><span style="color:#e1e4e8">(</span><span style="color:#f97583">String</span><span style="color:#e1e4e8">[] args) {</span></span>
<span class="line"><span style="color:#e1e4e8">        Pool pool </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Pool</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">2</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">for</span><span style="color:#e1e4e8"> (</span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> i </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8">; i </span><span style="color:#f97583">&lt;</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">5</span><span style="color:#e1e4e8">; i</span><span style="color:#f97583">++</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Thread</span><span style="color:#e1e4e8">(() </span><span style="color:#f97583">-&gt;</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">                Connection conn </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> pool.</span><span style="color:#b392f0">borrow</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#f97583">try</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">                    Thread.</span><span style="color:#b392f0">sleep</span><span style="color:#e1e4e8">(</span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Random</span><span style="color:#e1e4e8">().</span><span style="color:#b392f0">nextInt</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">1000</span><span style="color:#e1e4e8">));</span></span>
<span class="line"><span style="color:#e1e4e8">                } </span><span style="color:#f97583">catch</span><span style="color:#e1e4e8"> (InterruptedException </span><span style="color:#ffab70">e</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">                    e.</span><span style="color:#b392f0">printStackTrace</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">                }</span></span>
<span class="line"><span style="color:#e1e4e8">                pool.</span><span style="color:#b392f0">free</span><span style="color:#e1e4e8">(conn);</span></span>
<span class="line"><span style="color:#e1e4e8">            }).</span><span style="color:#b392f0">start</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">        }</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"><span style="color:#e1e4e8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">@</span><span style="color:#f97583">Slf4j</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">topic</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#9ecbff">"c.Pool"</span><span style="color:#e1e4e8">)</span></span>
<span class="line"><span style="color:#f97583">class</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Pool</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">// 1. 连接池大小</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">private</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">final</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> poolSize;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">// 2. 连接对象数组</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">private</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">Connection</span><span style="color:#e1e4e8">[] connections;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">// 3. 连接状态数组 0 表示空闲， 1 表示繁忙</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">private</span><span style="color:#e1e4e8"> AtomicIntegerArray states;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">// 4. 构造方法初始化</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Pool</span><span style="color:#e1e4e8">(</span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> </span><span style="color:#ffab70">poolSize</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#79b8ff">this</span><span style="color:#e1e4e8">.poolSize </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> poolSize;</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#79b8ff">this</span><span style="color:#e1e4e8">.connections </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">Connection</span><span style="color:#e1e4e8">[poolSize];</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#79b8ff">this</span><span style="color:#e1e4e8">.states </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">AtomicIntegerArray</span><span style="color:#e1e4e8">(</span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">int</span><span style="color:#e1e4e8">[poolSize]);</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">for</span><span style="color:#e1e4e8"> (</span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> i </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8">; i </span><span style="color:#f97583">&lt;</span><span style="color:#e1e4e8"> poolSize; i</span><span style="color:#f97583">++</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">            connections[i] </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">MockConnection</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"连接"</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">+</span><span style="color:#e1e4e8"> (i</span><span style="color:#f97583">+</span><span style="color:#79b8ff">1</span><span style="color:#e1e4e8">));</span></span>
<span class="line"><span style="color:#e1e4e8">        }</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">// 5. 借连接</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">public</span><span style="color:#e1e4e8"> Connection </span><span style="color:#b392f0">borrow</span><span style="color:#e1e4e8">() {</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">while</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">true</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">for</span><span style="color:#e1e4e8"> (</span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> i </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8">; i </span><span style="color:#f97583">&lt;</span><span style="color:#e1e4e8"> poolSize; i</span><span style="color:#f97583">++</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#6a737d">// 获取空闲连接</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#f97583">if</span><span style="color:#e1e4e8">(states.</span><span style="color:#b392f0">get</span><span style="color:#e1e4e8">(i) </span><span style="color:#f97583">==</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">                    </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (states.</span><span style="color:#b392f0">compareAndSet</span><span style="color:#e1e4e8">(i, </span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8">, </span><span style="color:#79b8ff">1</span><span style="color:#e1e4e8">)) {</span></span>
<span class="line"><span style="color:#e1e4e8">                        log.</span><span style="color:#b392f0">debug</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"borrow {}"</span><span style="color:#e1e4e8">, connections[i]);</span></span>
<span class="line"><span style="color:#e1e4e8">                        </span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> connections[i];</span></span>
<span class="line"><span style="color:#e1e4e8">                    }</span></span>
<span class="line"><span style="color:#e1e4e8">                }</span></span>
<span class="line"><span style="color:#e1e4e8">            }</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#6a737d">// 如果没有空闲连接，当前线程进入等待</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">synchronized</span><span style="color:#e1e4e8"> (</span><span style="color:#79b8ff">this</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#f97583">try</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">                    log.</span><span style="color:#b392f0">debug</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"wait..."</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">                    </span><span style="color:#79b8ff">this</span><span style="color:#e1e4e8">.</span><span style="color:#b392f0">wait</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">                } </span><span style="color:#f97583">catch</span><span style="color:#e1e4e8"> (InterruptedException </span><span style="color:#ffab70">e</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">                    e.</span><span style="color:#b392f0">printStackTrace</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">                }</span></span>
<span class="line"><span style="color:#e1e4e8">            }</span></span>
<span class="line"><span style="color:#e1e4e8">        }</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">// 6. 归还连接</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">void</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">free</span><span style="color:#e1e4e8">(Connection </span><span style="color:#ffab70">conn</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">for</span><span style="color:#e1e4e8"> (</span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> i </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8">; i </span><span style="color:#f97583">&lt;</span><span style="color:#e1e4e8"> poolSize; i</span><span style="color:#f97583">++</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (connections[i] </span><span style="color:#f97583">==</span><span style="color:#e1e4e8"> conn) {</span></span>
<span class="line"><span style="color:#e1e4e8">                states.</span><span style="color:#b392f0">set</span><span style="color:#e1e4e8">(i, </span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#f97583">synchronized</span><span style="color:#e1e4e8"> (</span><span style="color:#79b8ff">this</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">                    log.</span><span style="color:#b392f0">debug</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"free {}"</span><span style="color:#e1e4e8">, conn);</span></span>
<span class="line"><span style="color:#e1e4e8">                    </span><span style="color:#79b8ff">this</span><span style="color:#e1e4e8">.</span><span style="color:#b392f0">notifyAll</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">                }</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#f97583">break</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">            }</span></span>
<span class="line"><span style="color:#e1e4e8">        }</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"><span style="color:#e1e4e8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#f97583">class</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">MockConnection</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">implements</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Connection</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">private</span><span style="color:#e1e4e8"> String name;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">MockConnection</span><span style="color:#e1e4e8">(String </span><span style="color:#ffab70">name</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#79b8ff">this</span><span style="color:#e1e4e8">.name </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> name;</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"><span style="color:#e1e4e8">    ...</span></span>
<span class="line"><span style="color:#e1e4e8">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">static</span><span style="color:#24292e"> </span><span style="color:#d73a49">void</span><span style="color:#24292e"> </span><span style="color:#6f42c1">main</span><span style="color:#24292e">(</span><span style="color:#d73a49">String</span><span style="color:#24292e">[] args) {</span></span>
<span class="line"><span style="color:#24292e">        Pool pool </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Pool</span><span style="color:#24292e">(</span><span style="color:#005cc5">2</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">for</span><span style="color:#24292e"> (</span><span style="color:#d73a49">int</span><span style="color:#24292e"> i </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#005cc5">0</span><span style="color:#24292e">; i </span><span style="color:#d73a49">&lt;</span><span style="color:#24292e"> </span><span style="color:#005cc5">5</span><span style="color:#24292e">; i</span><span style="color:#d73a49">++</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Thread</span><span style="color:#24292e">(() </span><span style="color:#d73a49">-&gt;</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">                Connection conn </span><span style="color:#d73a49">=</span><span style="color:#24292e"> pool.</span><span style="color:#6f42c1">borrow</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#d73a49">try</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">                    Thread.</span><span style="color:#6f42c1">sleep</span><span style="color:#24292e">(</span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Random</span><span style="color:#24292e">().</span><span style="color:#6f42c1">nextInt</span><span style="color:#24292e">(</span><span style="color:#005cc5">1000</span><span style="color:#24292e">));</span></span>
<span class="line"><span style="color:#24292e">                } </span><span style="color:#d73a49">catch</span><span style="color:#24292e"> (InterruptedException </span><span style="color:#e36209">e</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">                    e.</span><span style="color:#6f42c1">printStackTrace</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">                }</span></span>
<span class="line"><span style="color:#24292e">                pool.</span><span style="color:#6f42c1">free</span><span style="color:#24292e">(conn);</span></span>
<span class="line"><span style="color:#24292e">            }).</span><span style="color:#6f42c1">start</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">        }</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"><span style="color:#24292e">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">@</span><span style="color:#d73a49">Slf4j</span><span style="color:#24292e">(</span><span style="color:#005cc5">topic</span><span style="color:#24292e"> </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#032f62">"c.Pool"</span><span style="color:#24292e">)</span></span>
<span class="line"><span style="color:#d73a49">class</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Pool</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">// 1. 连接池大小</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">private</span><span style="color:#24292e"> </span><span style="color:#d73a49">final</span><span style="color:#24292e"> </span><span style="color:#d73a49">int</span><span style="color:#24292e"> poolSize;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">// 2. 连接对象数组</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">private</span><span style="color:#24292e"> </span><span style="color:#d73a49">Connection</span><span style="color:#24292e">[] connections;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">// 3. 连接状态数组 0 表示空闲， 1 表示繁忙</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">private</span><span style="color:#24292e"> AtomicIntegerArray states;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">// 4. 构造方法初始化</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Pool</span><span style="color:#24292e">(</span><span style="color:#d73a49">int</span><span style="color:#24292e"> </span><span style="color:#e36209">poolSize</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#005cc5">this</span><span style="color:#24292e">.poolSize </span><span style="color:#d73a49">=</span><span style="color:#24292e"> poolSize;</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#005cc5">this</span><span style="color:#24292e">.connections </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#d73a49">Connection</span><span style="color:#24292e">[poolSize];</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#005cc5">this</span><span style="color:#24292e">.states </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">AtomicIntegerArray</span><span style="color:#24292e">(</span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#d73a49">int</span><span style="color:#24292e">[poolSize]);</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">for</span><span style="color:#24292e"> (</span><span style="color:#d73a49">int</span><span style="color:#24292e"> i </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#005cc5">0</span><span style="color:#24292e">; i </span><span style="color:#d73a49">&lt;</span><span style="color:#24292e"> poolSize; i</span><span style="color:#d73a49">++</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">            connections[i] </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">MockConnection</span><span style="color:#24292e">(</span><span style="color:#032f62">"连接"</span><span style="color:#24292e"> </span><span style="color:#d73a49">+</span><span style="color:#24292e"> (i</span><span style="color:#d73a49">+</span><span style="color:#005cc5">1</span><span style="color:#24292e">));</span></span>
<span class="line"><span style="color:#24292e">        }</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">// 5. 借连接</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">public</span><span style="color:#24292e"> Connection </span><span style="color:#6f42c1">borrow</span><span style="color:#24292e">() {</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">while</span><span style="color:#24292e">(</span><span style="color:#005cc5">true</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">for</span><span style="color:#24292e"> (</span><span style="color:#d73a49">int</span><span style="color:#24292e"> i </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#005cc5">0</span><span style="color:#24292e">; i </span><span style="color:#d73a49">&lt;</span><span style="color:#24292e"> poolSize; i</span><span style="color:#d73a49">++</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#6a737d">// 获取空闲连接</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#d73a49">if</span><span style="color:#24292e">(states.</span><span style="color:#6f42c1">get</span><span style="color:#24292e">(i) </span><span style="color:#d73a49">==</span><span style="color:#24292e"> </span><span style="color:#005cc5">0</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">                    </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (states.</span><span style="color:#6f42c1">compareAndSet</span><span style="color:#24292e">(i, </span><span style="color:#005cc5">0</span><span style="color:#24292e">, </span><span style="color:#005cc5">1</span><span style="color:#24292e">)) {</span></span>
<span class="line"><span style="color:#24292e">                        log.</span><span style="color:#6f42c1">debug</span><span style="color:#24292e">(</span><span style="color:#032f62">"borrow {}"</span><span style="color:#24292e">, connections[i]);</span></span>
<span class="line"><span style="color:#24292e">                        </span><span style="color:#d73a49">return</span><span style="color:#24292e"> connections[i];</span></span>
<span class="line"><span style="color:#24292e">                    }</span></span>
<span class="line"><span style="color:#24292e">                }</span></span>
<span class="line"><span style="color:#24292e">            }</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#6a737d">// 如果没有空闲连接，当前线程进入等待</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">synchronized</span><span style="color:#24292e"> (</span><span style="color:#005cc5">this</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#d73a49">try</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">                    log.</span><span style="color:#6f42c1">debug</span><span style="color:#24292e">(</span><span style="color:#032f62">"wait..."</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">                    </span><span style="color:#005cc5">this</span><span style="color:#24292e">.</span><span style="color:#6f42c1">wait</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">                } </span><span style="color:#d73a49">catch</span><span style="color:#24292e"> (InterruptedException </span><span style="color:#e36209">e</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">                    e.</span><span style="color:#6f42c1">printStackTrace</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">                }</span></span>
<span class="line"><span style="color:#24292e">            }</span></span>
<span class="line"><span style="color:#24292e">        }</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">// 6. 归还连接</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">void</span><span style="color:#24292e"> </span><span style="color:#6f42c1">free</span><span style="color:#24292e">(Connection </span><span style="color:#e36209">conn</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">for</span><span style="color:#24292e"> (</span><span style="color:#d73a49">int</span><span style="color:#24292e"> i </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#005cc5">0</span><span style="color:#24292e">; i </span><span style="color:#d73a49">&lt;</span><span style="color:#24292e"> poolSize; i</span><span style="color:#d73a49">++</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (connections[i] </span><span style="color:#d73a49">==</span><span style="color:#24292e"> conn) {</span></span>
<span class="line"><span style="color:#24292e">                states.</span><span style="color:#6f42c1">set</span><span style="color:#24292e">(i, </span><span style="color:#005cc5">0</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#d73a49">synchronized</span><span style="color:#24292e"> (</span><span style="color:#005cc5">this</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">                    log.</span><span style="color:#6f42c1">debug</span><span style="color:#24292e">(</span><span style="color:#032f62">"free {}"</span><span style="color:#24292e">, conn);</span></span>
<span class="line"><span style="color:#24292e">                    </span><span style="color:#005cc5">this</span><span style="color:#24292e">.</span><span style="color:#6f42c1">notifyAll</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">                }</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#d73a49">break</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">            }</span></span>
<span class="line"><span style="color:#24292e">        }</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"><span style="color:#24292e">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#d73a49">class</span><span style="color:#24292e"> </span><span style="color:#6f42c1">MockConnection</span><span style="color:#24292e"> </span><span style="color:#d73a49">implements</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Connection</span><span style="color:#24292e"> {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">private</span><span style="color:#24292e"> String name;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#6f42c1">MockConnection</span><span style="color:#24292e">(String </span><span style="color:#e36209">name</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#005cc5">this</span><span style="color:#24292e">.name </span><span style="color:#d73a49">=</span><span style="color:#24292e"> name;</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"><span style="color:#24292e">    ...</span></span>
<span class="line"><span style="color:#24292e">}</span></span></code></pre></div><figure><img src="https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230718181534942.png" alt="image-20230718181534942" loading="lazy" decoding="async"></figure><p>以上实现没有考虑：</p><ul><li>连接的动态增长与收缩</li><li>连接保活（可用性检测）</li><li>等待超时处理</li><li>分布式 hash</li></ul><p>对于关系型数据库，有比较成熟的连接池实现，例如c3p0, druid等 对于更通用的对象池，可以考虑使用apache commons pool，例如redis连接池可以参考jedis中关于连接池的实现</p><h4 id="_4-final-原理" tabindex="-1">4）final 原理 <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20intermediate%20level#_4-final-原理" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h4><h5 id="设置-final-变量的原理" tabindex="-1">设置 final 变量的原理 <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20intermediate%20level#设置-final-变量的原理" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h5><p>理解了 volatile 原理，再对比 final 的实现就比较简单了</p><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">class</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">TestFinal</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">	</span><span style="color:#f97583">final</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> a </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">20</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">class</span><span style="color:#24292e"> </span><span style="color:#6f42c1">TestFinal</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">	</span><span style="color:#d73a49">final</span><span style="color:#24292e"> </span><span style="color:#d73a49">int</span><span style="color:#24292e"> a </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#005cc5">20</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">}</span></span></code></pre></div><p>字节码</p><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#79b8ff">0</span><span style="color:#f97583">:</span><span style="color:#e1e4e8"> aload_0</span></span>
<span class="line"><span style="color:#79b8ff">1</span><span style="color:#f97583">:</span><span style="color:#e1e4e8"> invokespecial 	#</span><span style="color:#79b8ff">1</span><span style="color:#e1e4e8"> 			</span><span style="color:#6a737d">// Method java/lang/Object."&lt;init&gt;":()V</span></span>
<span class="line"><span style="color:#79b8ff">4</span><span style="color:#f97583">:</span><span style="color:#e1e4e8"> aload_0</span></span>
<span class="line"><span style="color:#79b8ff">5</span><span style="color:#f97583">:</span><span style="color:#e1e4e8"> bipush </span><span style="color:#79b8ff">20</span></span>
<span class="line"><span style="color:#79b8ff">7</span><span style="color:#f97583">:</span><span style="color:#e1e4e8"> putfield 	#</span><span style="color:#79b8ff">2</span><span style="color:#e1e4e8"> 				</span><span style="color:#6a737d">// Field a:I</span></span>
<span class="line"><span style="color:#e1e4e8">	</span><span style="color:#f97583">&lt;--</span><span style="color:#e1e4e8"> 写屏障</span></span>
<span class="line"><span style="color:#79b8ff">10</span><span style="color:#f97583">:</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">return</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#005cc5">0</span><span style="color:#d73a49">:</span><span style="color:#24292e"> aload_0</span></span>
<span class="line"><span style="color:#005cc5">1</span><span style="color:#d73a49">:</span><span style="color:#24292e"> invokespecial 	#</span><span style="color:#005cc5">1</span><span style="color:#24292e"> 			</span><span style="color:#6a737d">// Method java/lang/Object."&lt;init&gt;":()V</span></span>
<span class="line"><span style="color:#005cc5">4</span><span style="color:#d73a49">:</span><span style="color:#24292e"> aload_0</span></span>
<span class="line"><span style="color:#005cc5">5</span><span style="color:#d73a49">:</span><span style="color:#24292e"> bipush </span><span style="color:#005cc5">20</span></span>
<span class="line"><span style="color:#005cc5">7</span><span style="color:#d73a49">:</span><span style="color:#24292e"> putfield 	#</span><span style="color:#005cc5">2</span><span style="color:#24292e"> 				</span><span style="color:#6a737d">// Field a:I</span></span>
<span class="line"><span style="color:#24292e">	</span><span style="color:#d73a49">&lt;--</span><span style="color:#24292e"> 写屏障</span></span>
<span class="line"><span style="color:#005cc5">10</span><span style="color:#d73a49">:</span><span style="color:#24292e"> </span><span style="color:#d73a49">return</span></span></code></pre></div><p>发现 final 变量的赋值也会通过 putfield 指令来完成，同样在这条指令之后也会加入写屏障，保证在其它线程读到 它的值时不会出现为 0 的情况</p><h5 id="获取-final-变量的原理" tabindex="-1">获取 final 变量的原理 <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20intermediate%20level#获取-final-变量的原理" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h5><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">class</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">TestFinal</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">static</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> A </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">10</span><span style="color:#e1e4e8">;</span><span style="color:#6a737d">//加final：直接把值复制到其他类的栈帧中    不加final：GETSTATIC</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">static</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> B </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> Short.MAX_VALUE</span><span style="color:#f97583">+</span><span style="color:#79b8ff">1</span><span style="color:#e1e4e8">;</span><span style="color:#6a737d">//加final：LDC 32768  不加final：GETSTATIC</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">final</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> a </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">20</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">final</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> b </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> Integer.MAX_VALUE;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">final</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">void</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">test1</span><span style="color:#e1e4e8">() {</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">final</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> c </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">30</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Thread</span><span style="color:#e1e4e8">(()</span><span style="color:#f97583">-&gt;</span><span style="color:#e1e4e8">{</span></span>
<span class="line"><span style="color:#e1e4e8">            System.out.</span><span style="color:#b392f0">println</span><span style="color:#e1e4e8">(c);</span></span>
<span class="line"><span style="color:#e1e4e8">        }).</span><span style="color:#b392f0">start</span><span style="color:#e1e4e8">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">final</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> d </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">30</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">class</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Task</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">implements</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Runnable</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">            @</span><span style="color:#f97583">Override</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">void</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">run</span><span style="color:#e1e4e8">() {</span></span>
<span class="line"><span style="color:#e1e4e8">                System.out.</span><span style="color:#b392f0">println</span><span style="color:#e1e4e8">(d);</span></span>
<span class="line"><span style="color:#e1e4e8">            }</span></span>
<span class="line"><span style="color:#e1e4e8">        }</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Thread</span><span style="color:#e1e4e8">(</span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Task</span><span style="color:#e1e4e8">()).</span><span style="color:#b392f0">start</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#f97583">class</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">UseFinal1</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">void</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">test</span><span style="color:#e1e4e8">() {</span></span>
<span class="line"><span style="color:#e1e4e8">        System.out.</span><span style="color:#b392f0">println</span><span style="color:#e1e4e8">(TestFinal.A);</span></span>
<span class="line"><span style="color:#e1e4e8">        System.out.</span><span style="color:#b392f0">println</span><span style="color:#e1e4e8">(TestFinal.B);</span></span>
<span class="line"><span style="color:#e1e4e8">        System.out.</span><span style="color:#b392f0">println</span><span style="color:#e1e4e8">(</span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">TestFinal</span><span style="color:#e1e4e8">().a);</span></span>
<span class="line"><span style="color:#e1e4e8">        System.out.</span><span style="color:#b392f0">println</span><span style="color:#e1e4e8">(</span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">TestFinal</span><span style="color:#e1e4e8">().b);</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">TestFinal</span><span style="color:#e1e4e8">().</span><span style="color:#b392f0">test1</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"><span style="color:#e1e4e8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#f97583">class</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">UseFinal2</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">void</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">test</span><span style="color:#e1e4e8">() {</span></span>
<span class="line"><span style="color:#e1e4e8">        System.out.</span><span style="color:#b392f0">println</span><span style="color:#e1e4e8">(TestFinal.A);</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"><span style="color:#e1e4e8">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">class</span><span style="color:#24292e"> </span><span style="color:#6f42c1">TestFinal</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">static</span><span style="color:#24292e"> </span><span style="color:#d73a49">int</span><span style="color:#24292e"> A </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#005cc5">10</span><span style="color:#24292e">;</span><span style="color:#6a737d">//加final：直接把值复制到其他类的栈帧中    不加final：GETSTATIC</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">static</span><span style="color:#24292e"> </span><span style="color:#d73a49">int</span><span style="color:#24292e"> B </span><span style="color:#d73a49">=</span><span style="color:#24292e"> Short.MAX_VALUE</span><span style="color:#d73a49">+</span><span style="color:#005cc5">1</span><span style="color:#24292e">;</span><span style="color:#6a737d">//加final：LDC 32768  不加final：GETSTATIC</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">final</span><span style="color:#24292e"> </span><span style="color:#d73a49">int</span><span style="color:#24292e"> a </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#005cc5">20</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">final</span><span style="color:#24292e"> </span><span style="color:#d73a49">int</span><span style="color:#24292e"> b </span><span style="color:#d73a49">=</span><span style="color:#24292e"> Integer.MAX_VALUE;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">final</span><span style="color:#24292e"> </span><span style="color:#d73a49">void</span><span style="color:#24292e"> </span><span style="color:#6f42c1">test1</span><span style="color:#24292e">() {</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">final</span><span style="color:#24292e"> </span><span style="color:#d73a49">int</span><span style="color:#24292e"> c </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#005cc5">30</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Thread</span><span style="color:#24292e">(()</span><span style="color:#d73a49">-&gt;</span><span style="color:#24292e">{</span></span>
<span class="line"><span style="color:#24292e">            System.out.</span><span style="color:#6f42c1">println</span><span style="color:#24292e">(c);</span></span>
<span class="line"><span style="color:#24292e">        }).</span><span style="color:#6f42c1">start</span><span style="color:#24292e">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">final</span><span style="color:#24292e"> </span><span style="color:#d73a49">int</span><span style="color:#24292e"> d </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#005cc5">30</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">class</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Task</span><span style="color:#24292e"> </span><span style="color:#d73a49">implements</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Runnable</span><span style="color:#24292e"> {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">            @</span><span style="color:#d73a49">Override</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">void</span><span style="color:#24292e"> </span><span style="color:#6f42c1">run</span><span style="color:#24292e">() {</span></span>
<span class="line"><span style="color:#24292e">                System.out.</span><span style="color:#6f42c1">println</span><span style="color:#24292e">(d);</span></span>
<span class="line"><span style="color:#24292e">            }</span></span>
<span class="line"><span style="color:#24292e">        }</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Thread</span><span style="color:#24292e">(</span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Task</span><span style="color:#24292e">()).</span><span style="color:#6f42c1">start</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#d73a49">class</span><span style="color:#24292e"> </span><span style="color:#6f42c1">UseFinal1</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">void</span><span style="color:#24292e"> </span><span style="color:#6f42c1">test</span><span style="color:#24292e">() {</span></span>
<span class="line"><span style="color:#24292e">        System.out.</span><span style="color:#6f42c1">println</span><span style="color:#24292e">(TestFinal.A);</span></span>
<span class="line"><span style="color:#24292e">        System.out.</span><span style="color:#6f42c1">println</span><span style="color:#24292e">(TestFinal.B);</span></span>
<span class="line"><span style="color:#24292e">        System.out.</span><span style="color:#6f42c1">println</span><span style="color:#24292e">(</span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">TestFinal</span><span style="color:#24292e">().a);</span></span>
<span class="line"><span style="color:#24292e">        System.out.</span><span style="color:#6f42c1">println</span><span style="color:#24292e">(</span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">TestFinal</span><span style="color:#24292e">().b);</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">TestFinal</span><span style="color:#24292e">().</span><span style="color:#6f42c1">test1</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"><span style="color:#24292e">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#d73a49">class</span><span style="color:#24292e"> </span><span style="color:#6f42c1">UseFinal2</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">void</span><span style="color:#24292e"> </span><span style="color:#6f42c1">test</span><span style="color:#24292e">() {</span></span>
<span class="line"><span style="color:#24292e">        System.out.</span><span style="color:#6f42c1">println</span><span style="color:#24292e">(TestFinal.A);</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"><span style="color:#24292e">}</span></span></code></pre></div><p>观察加与不加final的字节码变化</p><p>不加final：GETSTATIC共享内存操作，性能较低； 加final：直接复制值到其他类的栈帧中，非共享操作</p><h4 id="_5-无状态" tabindex="-1">5）无状态 <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20intermediate%20level#_5-无状态" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h4><p>在 web 阶段学习时，设计 Servlet 时为了保证其线程安全，都会有这样的建议，不要为 Servlet 设置成员变量，这 种没有任何成员变量的类是线程安全的</p><blockquote><p>因为成员变量保存的数据也可以称为状态信息，因此没有成员变量就称之为【无状态】</p></blockquote><!--]--><!--[--><!--]--><!--]--><!----><!----></article><!--]--><!--[--><!--[--><!--[--><div class="yun-sponsor-container flex-center flex-col" m="t-6"><button class="sponsor-button yun-icon-btn shadow hover:shadow-md" title="多少都是支持！" text="red-400"><div i-ri-heart-line></div></button><div m="y-4" class="qrcode-container qrcode flex-center flex-col"><div class="sponsor-description" mb="4" text="sm">这是关于赞助的一些描述</div><div class="flex justify-around"><!--[--><a class="flex-center flex-col animate-iteration-1 animate-fade-in" href="https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/alipay.jpg" target="_blank" style="color:#00a3ee"><img class="sponsor-method-img" border="~ rounded" p="1" loading="lazy" src="https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/alipay.jpg" title="支付宝"><div text="xl" m="2" class="i-ri-alipay-line"></div></a><a class="flex-center flex-col animate-iteration-1 animate-fade-in" href="https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/wechat.png" target="_blank" style="color:#2dc100"><img class="sponsor-method-img" border="~ rounded" p="1" loading="lazy" src="https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/wechat.png" title="微信支付"><div text="xl" m="2" class="i-ri-wechat-pay-line"></div></a><!--]--></div></div></div><ul class="post-copyright" m="y-4"><li class="post-copyright-author"><strong>本文作者：</strong><span>imklaus</span></li><li class="post-copyright-link"><strong>本文链接：</strong><a href="https://imlklaus.github.io/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20intermediate%20level" target="_blank" title="本文链接">https://imlklaus.github.io/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20intermediate%20level</a></li><li class="post-copyright-license"><strong>版权声明：</strong><span>本博客所有文章除特别声明外，均默认采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" target="_blank" rel="noopener" title="CC BY-NC-SA 4.0 ">CC BY-NC-SA</a> 许可协议。</span></li></ul><!--]--><!--]--><!--]--></div><!--]--><!----></div><!--[--><!--]--><!--[--><div class="post-nav"><div class="post-nav-item"><a href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20advanced%20chapter" class="post-nav-prev" title="深入学习Java并发编程-高级篇"><div class="icon" i-ri-arrow-left-s-line></div><span class="title truncate" text="sm">深入学习Java并发编程-高级篇</span></a></div><div class="post-nav-item"><a href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20beginner%20level" class="post-nav-next" title="深入学习Java并发编程-初级篇"><span class="title truncate" text="sm">深入学习Java并发编程-初级篇</span><div class="icon" i-ri-arrow-right-s-line></div></a></div></div><!--]--><!--[--><!--]--><!--[--><div class="yun-card flex-center comment sm:p-6 lg:px-12 xl:px-16" flex="col" min-h="100px" bg="$va-c-bg-light" w="full" p="4"><!----><!----><!--[--><!----><!--]--><!----></div><!--]--><!--[--><!--]--><footer class="va-footer p-4 text-$va-c-text-light" text="center sm"><!----><div class="copyright flex justify-center items-center gap-2" p="1"><span>©<!----> 2023</span><a class="animate-pulse inline-flex" href="https://imlklaus.github.io/" target="_blank" title="回到首页"><div class="i-ri-heart-line"></div></a><span>imklaus</span></div><div class="powered" m="2"><span>由 <a href="https://github.com/YunYouJun/valaxy" target="_blank" rel="noopener">Valaxy</a> v0.14.61 驱动</span> | <span>主题 - <a href="https://github.com/YunYouJun/valaxy/tree/main/packages/valaxy-theme-yun" title="valaxy-theme-yun" target="_blank">Yun</a> v0.14.61</span></div><div><div class="test" id="htmer_time"><span></span></div></div><!--[--><!--]--></footer><!--[--><!--]--></div><!--]--><!--[--><!--[--><button class="xl:hidden toc-btn shadow fixed yun-icon-btn z-350" opacity="75" right="2" bottom="19"><div i-ri-file-list-line></div></button><!----><!--  --><aside class="va-card yun-aside" m="l-4" text="center" overflow="auto"><div class="aside-container" flex="~ col"><h2 m="t-6 b-2" font="serif black">文章目录</h2><div style="display:none" data-v-22b646a4><div class="content" data-v-22b646a4><div class="outline-title" data-v-22b646a4>On this page</div><div class="outline-marker" data-v-22b646a4></div><nav aria-labelledby="doc-outline-aria-label" data-v-22b646a4><span id="doc-outline-aria-label" class="visually-hidden" data-v-22b646a4>Table of Contents for current page</span><ul class="root va-toc relative z-1 css-i18n-toc" data-v-22b646a4 data-v-67cacb06><!--[--><!--]--></ul></nav></div></div><div class="flex-grow"></div><div class="custom-container"><!--[--><!--]--></div></div></aside><!--]--><!--]--></div></main><a href="#" class="back-to-top yun-icon-btn"><div w="8" h="8" i-ri-arrow-up-s-line></div><svg class="progress-circle-container" viewBox="0 0 100 100"><circle stroke-dasharray="301.59289474462014 301.59289474462014" stroke-dashoffset="301.59289474462014" class="progress-circle" cx="50" cy="50" r="48" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg></a><!--]--><!--]--></div><script>window.__INITIAL_STATE__='{"pinia":{"app":{"isSidebarOpen":false,"isRightSidebarOpen":false},"site":{}}}'</script><script type="application/ld+json" id="schema-org-graph" data-hid="3437552">{
  "@context": "https://schema.org",
  "@graph": [
    {
      "@id": "https://imlklaus.github.io/#identity",
      "@type": "Person",
      "name": "imklaus",
      "url": "https://imlklaus.github.io/",
      "image": {
        "@id": "https://imlklaus.github.io/#/schema/image/11067b0"
      },
      "sameAs": [
        "/atom.xml",
        "https://github.com/imLKlauS",
        "https://music.163.com/#/user/home?id=102158629",
        "https://space.bilibili.com/19430480",
        "https://t.me/elpsycn",
        "q1064779584@163.com",
        "https://www.travellings.cn/go.html"
      ]
    },
    {
      "@id": "https://imlklaus.github.io/#website",
      "@type": "WebSite",
      "dateModified": "2023-10-03T04:41:59.556Z",
      "datePublished": "2023-07-07T22:52:11.000Z",
      "inLanguage": "zh-CN",
      "name": "深入学习Java并发编程-中级篇",
      "url": "https://imlklaus.github.io/",
      "publisher": {
        "@id": "https://imlklaus.github.io/#identity"
      }
    },
    {
      "@id": "https://imlklaus.github.io/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20intermediate%20level/#webpage",
      "@type": "WebPage",
      "description": true,
      "name": "深入学习Java并发编程-中级篇",
      "url": "https://imlklaus.github.io/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20intermediate%20level",
      "about": {
        "@id": "https://imlklaus.github.io/#identity"
      },
      "isPartOf": {
        "@id": "https://imlklaus.github.io/#website"
      },
      "potentialAction": [
        {
          "@type": "ReadAction",
          "target": [
            "https://imlklaus.github.io/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20intermediate%20level"
          ]
        }
      ]
    },
    {
      "@id": "https://imlklaus.github.io/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20intermediate%20level/#article",
      "description": true,
      "headline": "深入学习Java并发编程-中级篇",
      "inLanguage": "zh-CN",
      "thumbnailUrl": "https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/wallhaven-57o9j5_1920x1080.png",
      "@type": [
        "Article",
        "BlogPosting"
      ],
      "author": {
        "@id": "https://imlklaus.github.io/#/schema/person/45376ff"
      },
      "image": {
        "@id": "https://imlklaus.github.io/#/schema/image/2362e00"
      },
      "isPartOf": {
        "@id": "https://imlklaus.github.io/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20intermediate%20level/#webpage"
      },
      "mainEntityOfPage": {
        "@id": "https://imlklaus.github.io/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20intermediate%20level/#webpage"
      },
      "publisher": {
        "@id": "https://imlklaus.github.io/#identity"
      }
    },
    {
      "@id": "https://imlklaus.github.io/#/schema/person/45376ff",
      "@type": "Person",
      "name": "imklaus",
      "url": "https://valaxy.site"
    },
    {
      "@id": "https://imlklaus.github.io/#/schema/image/11067b0",
      "@type": "ImageObject",
      "contentUrl": "https://imlklaus.github.io/images/avatar.jpg",
      "inLanguage": "zh-CN",
      "url": "https://imlklaus.github.io/images/avatar.jpg"
    },
    {
      "@id": "https://imlklaus.github.io/#/schema/image/2362e00",
      "@type": "ImageObject",
      "contentUrl": "https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/wallhaven-57o9j5_1920x1080.png",
      "inLanguage": "zh-CN",
      "url": "https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/wallhaven-57o9j5_1920x1080.png"
    }
  ]
}</script><link rel="stylesheet" href="/assets/index-e381b313.css"></body></html>