<!DOCTYPE html><html lang="en" data-critters-container><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><link rel="icon" href="https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230825001534253.png"><script>const prefersDark=window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches,colorSchemeSetting=localStorage.getItem("vueuse-color-scheme")||"auto";("dark"===colorSchemeSetting||prefersDark&&"light"!==colorSchemeSetting)&&document.documentElement.classList.toggle("dark",!0)</script><script>const locale=localStorage.getItem("valaxy-locale")||"zh-CN";document.documentElement.setAttribute("lang",locale)</script><script type="module" async crossorigin src="/assets/app-c31cbd14.js"></script><style>@charset "UTF-8";.back-to-top{position:fixed;right:-1.5rem;bottom:1rem;z-index:var(--yun-z-go-up-btn);opacity:0;pointer-events:none;color:var(--va-c-primary);transform:translate(0) rotate(270deg);transition:transform var(--va-transition-duration),opacity var(--va-transition-duration-fast)!important}.progress-circle{transition:.3s stroke-dashoffset;transform:rotate(-90deg);transform-origin:50% 50%}.progress-circle-container{position:absolute}.links-of-author{display:flex;flex-wrap:wrap;justify-content:center}.links-of-author .icon{width:1.5rem;height:1.5rem}.links-of-author-item{line-height:1;font-size:.9rem}.site-nav{display:flex;justify-content:center;overflow:hidden;line-height:1.5;white-space:nowrap;text-align:center;margin-top:1rem}.site-link-item{display:flex;padding:0 15px;align-items:center;border-left:1px solid var(--va-c-gray);flex-direction:column;color:var(--va-c-text)}.site-link-item:first-child,.site-link-item:last-child{line-height:1;padding:0}.site-link-item:first-child{border-left:none;border-right:1px solid var(--va-c-gray)}.site-link-item:last-child{border-left:1px solid var(--va-c-gray)}.site-link-item:nth-child(2){border:none}.site-link-item .count{color:var(--va-c-text);font-family:var(--va-font-sans);display:block;text-align:center;font-size:1rem}.site-link-item .icon{width:1.5rem;height:1.5rem}.site-link-item .icon:hover{color:var(--va-c-primary-light)}.site-author-avatar{display:inline-block;line-height:0;position:relative}.site-author-avatar img{height:96px;width:96px;max-width:100%;margin:0;padding:4px;background-color:#fff;box-shadow:0 0 10px #0003;transition:.4s}.site-author-avatar img:hover{box-shadow:0 0 30px rgba(var(--va-c-primary-rgb),.2)}.site-author-status{position:absolute;height:1.8rem;width:1.8rem;bottom:0;right:0;line-height:1.8rem;border-radius:50%;box-shadow:0 1px 2px #0003;background-color:var(--va-c-bg-light);border:1px solid rgba(255,255,255,.1)}.site-name{color:var(--va-c-text);font-family:var(--va-font-serif);font-weight:900}.site-subtitle{color:var(--va-c-gray);display:block}.sidebar{width:calc(100vw - 64px);max-width:var(--va-sidebar-width);background-image:var(--yun-sidebar-bg-img);background-position:bottom 1rem center;transform:translate(-100%);transition:box-shadow var(--va-transition-duration),background-color var(--va-transition-duration),opacity .25s,transform var(--va-transition-duration) cubic-bezier(.19,1,.22,1)!important}.spinner[data-v-65225486]{width:60px;height:60px;border:1px solid var(--va-c-primary);margin:100px auto;animation:rotateplane-65225486 1.2s infinite ease-in-out}@keyframes rotateplane-65225486{0%{transform:perspective(120px) rotateX(0) rotateY(0)}50%{transform:perspective(120px) rotateX(-180.1deg) rotateY(0)}to{transform:perspective(120px) rotateX(-180deg) rotateY(-180deg)}}.yun-search-btn{position:fixed;top:.6rem;right:.8rem;color:var(--va-c-primary);z-index:var(--yun-z-search-btn)}.yun-bg{position:fixed;width:100%;height:100%;z-index:-1;background-image:var(--yun-bg-img);background-size:cover;background-position:center;background-repeat:no-repeat;background-attachment:fixed;animation-name:bg-fade-in;animation-duration:2s;opacity:var(--yun-bg-img-opacity,1)}@supports (-webkit-touch-callout:none){.yun-bg{background-attachment:scroll}}@keyframes bg-fade-in{0%{opacity:0}to{opacity:var(--yun-bg-img-opacity,1)}}canvas.fireworks{position:fixed;left:0;top:0;z-index:1;pointer-events:none}*,:after,:before{box-sizing:border-box;border-width:0;border-style:solid;border-color:var(--un-default-border-color,#e5e7eb)}html{line-height:1.5;-webkit-text-size-adjust:100%;text-size-adjust:100%;-moz-tab-size:4;tab-size:4;font-family:ui-sans-serif,system-ui,-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica Neue,Arial,Noto Sans,sans-serif,"Apple Color Emoji","Segoe UI Emoji",Segoe UI Symbol,"Noto Color Emoji"}body{margin:0;line-height:inherit}hr{height:0;color:inherit;border-top-width:1px}h1,h2,h3,h4,h5{font-size:inherit;font-weight:inherit}a{color:inherit;text-decoration:inherit}strong{font-weight:bolder}code,pre{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,Liberation Mono,Courier New,monospace;font-size:1em}table{text-indent:0;border-color:inherit;border-collapse:collapse}button{font-family:inherit;font-feature-settings:inherit;font-variation-settings:inherit;font-size:100%;font-weight:inherit;line-height:inherit;color:inherit;margin:0;padding:0}button{text-transform:none}[type=button],button{-webkit-appearance:button;background-image:none}blockquote,figure,h1,h2,h3,h4,h5,hr,p,pre{margin:0}ol,ul{list-style:none;margin:0;padding:0}button{cursor:pointer}canvas,img,svg{display:block;vertical-align:middle}img{max-width:100%;height:auto}body{counter-reset:katexEqnNo mmlEqnNo}html{-webkit-tap-highlight-color:transparent;font-family:var(--va-font-sans)}a{color:var(--va-c-link);font-weight:500}*{outline:0}hr{margin:1rem}button{background-color:transparent}#app,body,html{margin:0;padding:0;line-height:2}body{background-color:var(--va-c-bg)}a{cursor:pointer}html:not(.dark) .vp-code-dark{display:none}@media screen and (max-width:640px){.markdown-body div[class*=language-]{margin:0 var(--va-code-mobile-margin-x,-1rem)}}@media (width >= 640px){.markdown-body div[class*=language-]{border-radius:6px;margin:16px 0}}@media (width <= 639px){.markdown-body li div[class*=language-]{border-radius:6px 0 0 6px}}.markdown-body code{font-size:.85em}.markdown-body div[class*=language-]{overflow-y:hidden;position:relative;background-color:var(--va-code-block-bg);overflow-x:auto}.markdown-body [class*=language-] code,.markdown-body [class*=language-] pre{direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;-moz-tab-size:4;tab-size:4;-webkit-hyphens:none;hyphens:none}.markdown-body [class*=language-] pre{position:relative;z-index:1;margin:0;padding:20px 0;background:0 0;overflow-x:auto}.markdown-body [class*=language-] code{display:block;padding:0 24px;width:fit-content;min-width:100%;line-height:var(--va-code-line-height);font-size:var(--va-code-font-size);color:var(--va-code-block-color);transition:color .5s}.markdown-body [class*=language-]>button.copy{direction:ltr;position:absolute;top:12px;right:12px;z-index:3;border:1px solid var(--va-code-copy-code-border-color);border-radius:4px;width:40px;height:40px;background-color:var(--va-code-copy-code-bg);opacity:0;cursor:pointer;background-image:var(--va-icon-copy);background-position:50%;background-size:20px;background-repeat:no-repeat;transition:border-color .25s,background-color .25s,opacity .25s}.markdown-body [class*=language-]:hover>button.copy,.markdown-body [class*=language-]>button.copy:focus{opacity:1}.markdown-body [class*=language-]>button.copy:hover{border-color:var(--va-code-copy-code-hover-border-color);background-color:var(--va-code-copy-code-hover-bg)}.markdown-body [class*=language-]>span.lang{position:absolute;top:2px;right:8px;z-index:2;font-size:12px;font-weight:500;color:var(--va-code-lang-color);transition:color .4s,opacity .4s}.markdown-body [class*=language-]:hover>button.copy+span.lang,.markdown-body [class*=language-]>button.copy:focus+span.lang{opacity:0}.markdown-body [class*=language-]>button.collapse{display:none;position:absolute;z-index:10;bottom:0;left:0;width:100%;height:24px;opacity:1;cursor:pointer;background-image:linear-gradient(-180deg,rgba(0,0,0,0) 0,var(--va-c-bg-dark) 100%)}.markdown-body [class*=language-]>button.collapse:before{display:block;content:"";width:100%;height:100%;background-image:var(--va-icon-collapse);background-position:50%;background-size:16px;background-repeat:no-repeat}.vt-hamburger{display:flex;justify-content:center;align-items:center}.vt-hamburger:hover .vt-hamburger-top{transform:translate(-5.5px)}.vt-hamburger:hover .vt-hamburger-middle{transform:translate(0)}.vt-hamburger:hover .vt-hamburger-bottom{transform:translate(-11px)}.vt-hamburger-container{position:relative;width:22px;height:20px;overflow:hidden}.vt-hamburger-bottom,.vt-hamburger-middle,.vt-hamburger-top{left:0;position:absolute;width:22px;height:2px;background-color:var(--va-c-primary);transition:top .25s,background-color .5s,transform .25s}.vt-hamburger-top{top:0;transform:translate(0)}.vt-hamburger-middle{top:9px;transform:translate(-11px)}.vt-hamburger-bottom{top:18px;transform:translate(-5.5px)}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5{position:relative;font-weight:600;outline:0}.markdown-body figure{text-align:center}.markdown-body .header-anchor{position:absolute;top:0;left:0;margin-left:-.87em;font-weight:500;-webkit-user-select:none;user-select:none;opacity:0;text-decoration:none;transition:color .25s,opacity .25s}.markdown-body .header-anchor:before{content:var(--va-header-anchor-symbol, "#")}.markdown-body .header-anchor:before:hover{text-decoration:none}.markdown-body h1 .header-anchor:focus,.markdown-body h1:hover .header-anchor,.markdown-body h2 .header-anchor:focus,.markdown-body h2:hover .header-anchor,.markdown-body h3 .header-anchor:focus,.markdown-body h3:hover .header-anchor,.markdown-body h4 .header-anchor:focus,.markdown-body h4:hover .header-anchor,.markdown-body h5 .header-anchor:focus,.markdown-body h5:hover .header-anchor{opacity:1}@media (width >= 768px){.markdown-body h1{letter-spacing:-.02em;line-height:40px;font-size:32px}}:root{--va-c-border:#c2c2c4;--va-c-divider:#e2e2e3;--va-c-gutter:#e2e2e3}:root{--va-c-gray-1:#dddde3;--va-c-gray-2:#e4e4e9;--va-c-gray-3:#ebebef;--va-c-gray-soft:rgba(142, 150, 170, .14);--va-c-indigo-1:#3451b2;--va-c-indigo-2:#3a5ccc;--va-c-indigo-3:#5672cd;--va-c-indigo-soft:rgba(100, 108, 255, .14);--va-c-green-1:#18794e;--va-c-green-2:#299764;--va-c-green-3:#30a46c;--va-c-green-soft:rgba(16, 185, 129, .14);--va-c-yellow-1:#915930;--va-c-yellow-2:#946300;--va-c-yellow-3:#9f6a00;--va-c-yellow-soft:rgba(234, 179, 8, .14);--va-c-red-1:#b8272c;--va-c-red-2:#d5393e;--va-c-red-3:#e0575b;--va-c-red-soft:rgba(244, 63, 94, .14);--va-c-sponsor:#db2777}:root{--va-c-default-1:var(--va-c-gray-1);--va-c-default-2:var(--va-c-gray-2);--va-c-default-3:var(--va-c-gray-3);--va-c-default-soft:var(--va-c-gray-soft);--va-c-brand-1:var(--va-c-indigo-1);--va-c-brand-2:var(--va-c-indigo-2);--va-c-brand-3:var(--va-c-indigo-3);--va-c-brand-soft:var(--va-c-indigo-soft);--va-c-brand:var(--va-c-brand-1);--va-c-tip-1:var(--va-c-brand-1);--va-c-tip-2:var(--va-c-brand-2);--va-c-tip-3:var(--va-c-brand-3);--va-c-tip-soft:var(--va-c-brand-soft);--va-c-warning-1:var(--va-c-yellow-1);--va-c-warning-2:var(--va-c-yellow-2);--va-c-warning-3:var(--va-c-yellow-3);--va-c-warning-soft:var(--va-c-yellow-soft);--va-c-danger-1:var(--va-c-red-1);--va-c-danger-2:var(--va-c-red-2);--va-c-danger-3:var(--va-c-red-3);--va-c-danger-soft:var(--va-c-red-soft)}:root{--va-aside-width:256px;--va-sidebar-width:300px;--va-border-width:1px;--va-font-serif:"Noto Serif SC",DM Serif Display,STZhongsong,STKaiti,KaiTi,Roboto,serif;--va-font-sans:DM Sans,Inter,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Oxygen,Ubuntu,Cantarell,"Fira Sans","Droid Sans","Helvetica Neue",sans-serif;--va-font-mono:DM Mono,Menlo,Monaco,Consolas,"Courier New",monospace;--va-transition-duration-fast:.2s;--va-transition-duration:.4s;--va-transition-duration-slow:.6s;--va-transition:all var(--va-transition-duration-fast) ease-in-out}:root{--va-c-white:#fff;--va-c-black:#1a1a1a;--va-c-gray:#8e8e8e;--va-c-danger:#db2828;--va-c-warning:#f2711c;--va-c-text-light-1:#213547;--va-c-text-light-2:rgba(60, 60, 60, .7);--va-c-text-light-3:rgba(60, 60, 60, .33);--va-c-text-light-4:rgba(60, 60, 60, .18);--va-c-text-dark-1:rgba(255, 255, 255, .87);--va-c-text-dark-2:rgba(235, 235, 235, .6);--va-c-text-dark-3:rgba(235, 235, 235, .38);--va-c-text-dark-4:rgba(235, 235, 235, .18);--va-c-primary-light:#d796ff;--va-c-primary-lighter:#f4e2ff;--va-c-primary-dark:#b030ff;--va-c-primary:#BA49FF}:root{color-scheme:light;--va-c-brand:#BA49FF;--va-border-color:#222;--va-c-bg:white;--va-c-bg-light:white;--va-c-bg-dark:#fafafa;--va-c-bg-opacity:rgba(255, 255, 255, .8);--va-c-bg-soft:#f9f9f9;--va-c-bg-alt:#f9f9f9;--va-c-bg-mute:#f1f1f1;--va-c-text:#333;--va-c-text-light:#555;--va-c-text-lighter:#666;--va-c-text-dark:#111;--va-c-primary-rgb:186,73,255;--va-c-link:var(--va-c-primary-dark);--va-c-divider:rgba(60, 60, 60, .2)}:root{--va-c-text-1:rgba(60, 60, 67);--va-c-text-2:rgba(60, 60, 67, .78);--va-c-text-3:rgba(60, 60, 67, .56)}:root{--va-code-line-height:1.7;--va-code-font-size:.875em;--va-code-block-color:var(--va-c-text-2);--va-code-block-bg:var(--va-c-bg-alt);--va-code-block-divider-color:var(--va-c-gutter);--va-code-lang-color:var(--va-c-text-3);--va-code-line-highlight-color:var(--va-c-default-soft);--va-code-line-number-color:var(--va-c-text-3);--va-code-line-diff-add-color:var(--va-c-green-soft);--va-code-line-diff-add-symbol-color:var(--va-c-green-1);--va-code-line-diff-remove-color:var(--va-c-red-soft);--va-code-line-diff-remove-symbol-color:var(--va-c-red-1);--va-code-line-warning-color:var(--va-c-yellow-soft);--va-code-line-error-color:var(--va-c-red-soft);--va-code-copy-code-border-color:var(--va-c-divider);--va-code-copy-code-bg:var(--va-c-bg-soft);--va-code-copy-code-hover-border-color:var(--va-c-divider);--va-code-copy-code-hover-bg:var(--va-c-bg);--va-code-copy-code-active-text:var(--va-c-text-2);--va-code-copy-copied-text-content:"Copied";--va-code-tab-divider:var(--va-code-block-divider-color);--va-code-tab-text-color:var(--va-c-text-2);--va-code-tab-bg:var(--va-code-block-bg);--va-code-tab-hover-text-color:var(--va-c-text-1);--va-code-tab-active-text-color:var(--va-c-text-1);--va-code-tab-active-bar-color:var(--va-c-brand-1)}:root{--va-icon-copy:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' height='20' width='20' stroke='rgba(128,128,128,1)' stroke-width='2' class='h-6 w-6' viewBox='0 0 24 24'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' d='M9 5H7a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2h-2M9 5a2 2 0 0 0 2 2h2a2 2 0 0 0 2-2M9 5a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2'/%3E%3C/svg%3E");--va-icon-copied:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' height='20' width='20' stroke='rgba(128,128,128,1)' stroke-width='2' class='h-6 w-6' viewBox='0 0 24 24'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' d='M9 5H7a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2h-2M9 5a2 2 0 0 0 2 2h2a2 2 0 0 0 2-2M9 5a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2m-6 9 2 2 4-4'/%3E%3C/svg%3E");--va-icon-collapse:url("data:image/svg+xml,%3Csvg%20xmlns='http://www.w3.org/2000/svg'%20width='32'%20height='32' stroke='rgba(128,128,128,1)' viewBox='0%200%2024%2024'%3E%3Cpath%20fill='currentColor'%20d='m12%2016.175l3.9-3.875q.275-.275.688-.288t.712.288q.275.275.275.7t-.275.7l-4.6%204.6q-.15.15-.325.213t-.375.062q-.2%200-.375-.063T11.3%2018.3l-4.6-4.6q-.275-.275-.288-.687T6.7%2012.3q.275-.275.7-.275t.7.275l3.9%203.875Zm0-6L15.9%206.3q.275-.275.688-.287t.712.287q.275.275.275.7t-.275.7l-4.6%204.6q-.15.15-.325.213t-.375.062q-.2%200-.375-.062T11.3%2012.3L6.7%207.7q-.275-.275-.288-.688T6.7%206.3q.275-.275.7-.275t.7.275l3.9%203.875Z'/%3E%3C/svg%3E")}:root{--va-header-anchor-symbol:"#"}.post-category{color:var(--va-c-text)}.post-tag{white-space:nowrap;color:var(--yun-tag-color)}.post-tag:hover{color:var(--va-c-primary)}html{overflow-y:scroll}.yun-main{transition:padding-left var(--va-transition-duration)}:root{--smc-font-sans:Raleway,-apple-system,"PingFang SC","Microsoft YaHei",Arial,sans-serif;--smc-font-serif:"Songti SC","Noto Serif SC",STZhongsong,STKaiti,KaiTi,Roboto,serif;--smc-font-mono:Menlo,Monaco,Consolas,"Courier New",monospace}:root{--smc-c-primary-light:#e1afff;--smc-c-primary-lighter:#fefcff;--smc-c-primary:#BA49FF;--smc-theme-name:yun;--smc-line-height:1.8;--smc-c-primary-rgb:186,73,255;--smc-c-text:#24292e;--smc-c-text-light:#555;--smc-c-text-lighter:#666;--smc-header-bottom-color:#eaecef;--smc-border-color:var(--smc-c-primary-light);--smc-code-bg-color:#f6f8fa;--smc-link-color:#a716ff}.markdown-body{-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%;background:var(--smc-bg-color);color:var(--smc-c-text);font-family:var(--smc-font-sans);font-size:1rem;line-height:var(--smc-line-height);overflow-wrap:break-word}.markdown-body *{box-sizing:border-box}.markdown-body a{background-color:transparent}.markdown-body a:active,.markdown-body a:hover{outline-width:0}.markdown-body hr{background-color:var(--smc-c-primary,#333);height:2px;margin:1.5rem 0}.markdown-body blockquote{margin:1rem 0;padding:0 1rem;border-left:.25em solid var(--smc-border-color)}.markdown-body code,.markdown-body pre{font-family:Source Code Pro,Consolas,Monaco,SFMono-Regular,Ubuntu Mono,Menlo,monospace}.markdown-body code{padding:3px 6px;font-size:.85rem;color:var(--smc-c-text-light);background:var(--smc-code-bg-color);border-radius:3px}.markdown-body pre{margin-top:0;margin-bottom:0;overflow-wrap:normal;padding:1rem;overflow:auto;background-color:var(--smc-code-bg-color);border-radius:3px}.markdown-body pre>code{font-size:.85rem;white-space:pre}.markdown-body pre code{display:block;padding:0;margin:0;overflow:visible;line-height:inherit;word-break:normal;background-color:transparent;border:0}.markdown-body img{display:block;margin:1rem auto;max-width:92%;max-height:600px;border-radius:.2rem;transition:.4s;--tw-shadow:0 1px 3px 0 rgb(0 0 0/.1),0 1px 2px -1px rgb(0 0 0/.1);--tw-shadow-colored:0 1px 3px 0 var(--tw-shadow-color),0 1px 2px -1px var(--tw-shadow-color);-webkit-box-shadow:var(--tw-ring-offset-shadow,0 0 transparent),var(--tw-ring-shadow,0 0 transparent),var(--tw-shadow);box-shadow:var(--tw-ring-offset-shadow,0 0 transparent),var(--tw-ring-shadow,0 0 transparent),var(--tw-shadow)}.markdown-body img:hover{--tw-shadow:0 4px 6px -1px rgb(0 0 0/.1),0 2px 4px -2px rgb(0 0 0/.1);--tw-shadow-colored:0 4px 6px -1px var(--tw-shadow-color),0 2px 4px -2px var(--tw-shadow-color)}.markdown-body img:before{content:"「 LOADING ERROR 」"}@media screen and (min-width:1600px){.markdown-body img{max-width:800px}}.markdown-body a{color:var(--smc-c-primary);text-decoration:none;border-bottom:1px solid transparent;transition:all .2s ease-in-out}.markdown-body a:hover{color:var(--smc-link-color);border-bottom:1px solid var(--smc-link-color)}.markdown-body ol,.markdown-body ul{padding-left:2em}.markdown-body ul ul{margin-top:0;margin-bottom:0}.markdown-body li{overflow-wrap:break-all;margin-top:.25em}.markdown-body li>p{margin-top:16px}.markdown-body table{width:100%;overflow:auto;border-spacing:0;border-collapse:collapse}.markdown-body table td,.markdown-body table th{padding:6px 13px;border:1px solid var(--smc-c-primary-light,#999)}.markdown-body table thead th{font-weight:600}.markdown-body table>tbody>tr:hover{background-color:rgba(var(--smc-c-primary-rgb),.1)}.markdown-body strong{font-family:var(--smc-font-serif);font-weight:900}.markdown-body p{margin-top:1rem;margin-bottom:1rem;overflow-x:auto;overflow-y:hidden}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5{margin-top:1.5rem;margin-bottom:1rem;font-weight:300;line-height:1.5}.markdown-body h1{font-size:2.5rem;border-bottom:1px solid var(--smc-header-bottom-color)}.markdown-body h2{font-size:2.2rem;border-bottom:1px solid var(--smc-header-bottom-color)}.markdown-body h3{font-size:1.9rem}.markdown-body h4{font-size:1.6rem}.markdown-body h5{font-size:1.3rem}@media screen and (max-width:768px){.markdown-body h1{font-size:2rem}.markdown-body h2{font-size:1.8rem}.markdown-body h3{font-size:1.6rem}.markdown-body h4{font-size:1.4rem}.markdown-body h5{font-size:1.2rem}}.yun-icon-btn{background-color:transparent;cursor:pointer;display:inline-flex;align-items:center;justify-content:center;border:none;width:3rem;height:3rem;border-radius:50%;transition:background-color var(--va-transition-duration)}.yun-icon-btn div{font-size:1.2rem}.yun-icon-btn:hover{background-color:rgba(var(--va-c-primary-rgb),.08)}.yun-icon-btn:active{background-color:rgba(var(--va-c-primary-rgb),.16)}.markdown-body{--smc-font-family:var(--va-font-sans);--c-toc-link:var(--va-c-text-light)}.markdown-body{word-wrap:break-word}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5{font-family:var(--va-font-serif);font-weight:900}.markdown-body ul{list-style:initial}.markdown-body ul li>p{margin-bottom:0}.markdown-body ol li{list-style:decimal}.markdown-body img{margin:.5rem auto;height:auto}.markdown-body p{overflow:unset}.markdown-body hr{opacity:.6;height:2px;border-top-width:0;background-color:var(--va-c-text)}:root{--va-custom-block-font-size:14px;--va-custom-block-code-font-size:13px;--va-custom-block-info-border:transparent;--va-custom-block-info-text:var(--va-c-text-1);--va-custom-block-info-bg:var(--va-c-default-soft);--va-custom-block-info-code-bg:var(--va-c-default-soft);--va-custom-block-tip-border:transparent;--va-custom-block-tip-text:var(--va-c-text-1);--va-custom-block-tip-bg:var(--va-c-brand-soft);--va-custom-block-tip-code-bg:var(--va-c-brand-soft);--va-custom-block-warning-border:transparent;--va-custom-block-warning-text:var(--va-c-text-1);--va-custom-block-warning-bg:var(--va-c-warning-soft);--va-custom-block-warning-code-bg:var(--va-c-warning-soft);--va-custom-block-danger-border:transparent;--va-custom-block-danger-text:var(--va-c-text-1);--va-custom-block-danger-bg:var(--va-c-danger-soft);--va-custom-block-danger-code-bg:var(--va-c-danger-soft);--va-custom-block-details-border:var(--va-custom-block-info-border);--va-custom-block-details-text:var(--va-custom-block-info-text);--va-custom-block-details-bg:var(--va-custom-block-info-bg);--va-custom-block-details-code-bg:var(--va-custom-block-info-code-bg)}:root{--yun-post-card-max-width:900px;--yun-c-cloud:white;--yun-z-toc-btn:7;--yun-z-cloud:7;--yun-z-go-down:9;--yun-z-backdrop:9;--yun-z-sidebar:10;--yun-z-fireworks:11;--yun-z-menu-btn:20;--yun-z-go-up-btn:20;--yun-z-search-popup:30;--yun-z-search-btn:31;--va-z-overlay:var(--yun-z-backdrop)}:root{--yun-bg-img:url(/assets/bg-img-73ffcfc5.jpg);--yun-sidebar-bg-color:var(--va-c-bg-light);--yun-sidebar-bg-img:url(/assets/sidebar-bg-img-b7854581.webp)}:root{--va-font-serif:""Noto Serif SC", STZhongsong, STKaiti, KaiTi, Roboto,  serif";--va-font-sans:Inter,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Oxygen,Ubuntu,Cantarell,"Fira Sans","Droid Sans","Helvetica Neue",sans-serif;--va-font-mono:'Menlo, Monaco, Consolas, "Courier New", monospace';--va-c-bg-light:rgba(112, 195, 236, .508);--yun-sidebar-bg-img:url(https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230824230550413.png);--yun-sidebar-bg-color:rgba(255, 255, 255, 0)}*,:after,:before{--un-rotate:0;--un-rotate-x:0;--un-rotate-y:0;--un-rotate-z:0;--un-scale-x:1;--un-scale-y:1;--un-scale-z:1;--un-skew-x:0;--un-skew-y:0;--un-translate-x:0;--un-translate-y:0;--un-translate-z:0;--un-scroll-snap-strictness:proximity;--un-border-spacing-x:0;--un-border-spacing-y:0;--un-ring-offset-shadow:0 0 rgb(0 0 0 / 0);--un-ring-shadow:0 0 rgb(0 0 0 / 0);--un-shadow:0 0 rgb(0 0 0 / 0);--un-ring-offset-width:0px;--un-ring-offset-color:#fff;--un-ring-width:0px;--un-ring-color:rgb(147 197 253 / .5)}.i-ri-alipay-line{--un-icon:url("data:image/svg+xml;utf8,%3Csvg viewBox='0 0 24 24' width='1.2em' height='1.2em' xmlns='http://www.w3.org/2000/svg' %3E%3Cpath fill='currentColor' d='M18.408 16.79c-2.173-.95-3.72-1.646-4.64-2.086c-1.4 1.696-2.872 2.72-5.08 2.72S5 16.064 5.176 14.392c.12-1.096.872-2.888 4.128-2.576c1.72.16 2.504.48 3.912.944c.36-.664.664-1.4.888-2.176H7.88v-.616h3.072V8.864H7.2v-.68h3.752V6.592s.032-.248.312-.248H12.8v1.848h4v.68h-4v1.104h3.264a12.41 12.41 0 0 1-1.32 3.32c.51.182 2.097.676 4.76 1.482a8 8 0 1 0-1.096 2.012ZM12 22C6.477 22 2 17.523 2 12S6.477 2 12 2s10 4.477 10 10s-4.477 10-10 10Zm-3.568-5.632c1.44 0 2.824-.872 3.96-2.352c-1.608-.776-2.944-1.16-4.44-1.16c-1.304 0-1.984.8-2.104 1.416c-.12.616.248 2.096 2.584 2.096Z'/%3E%3C/svg%3E");-webkit-mask:var(--un-icon) no-repeat;mask:var(--un-icon) no-repeat;-webkit-mask-size:100% 100%;mask-size:100% 100%;background-color:currentColor;color:inherit;width:1.2em;height:1.2em}[i-ri-archive-line=""]{--un-icon:url("data:image/svg+xml;utf8,%3Csvg viewBox='0 0 24 24' width='1.2em' height='1.2em' xmlns='http://www.w3.org/2000/svg' %3E%3Cpath fill='currentColor' d='M3 10H2V4.003C2 3.449 2.455 3 2.992 3h18.016A.99.99 0 0 1 22 4.003V10h-1v10.002a.996.996 0 0 1-.993.998H3.993A.996.996 0 0 1 3 20.002V10Zm16 0H5v9h14v-9ZM4 5v3h16V5H4Zm5 7h6v2H9v-2Z'/%3E%3C/svg%3E");-webkit-mask:var(--un-icon) no-repeat;mask:var(--un-icon) no-repeat;-webkit-mask-size:100% 100%;mask-size:100% 100%;background-color:currentColor;color:inherit;width:1.2em;height:1.2em}[i-ri-arrow-left-s-line=""]{--un-icon:url("data:image/svg+xml;utf8,%3Csvg viewBox='0 0 24 24' width='1.2em' height='1.2em' xmlns='http://www.w3.org/2000/svg' %3E%3Cpath fill='currentColor' d='m10.828 12l4.95 4.95l-1.414 1.415L8 12l6.364-6.364l1.414 1.414l-4.95 4.95Z'/%3E%3C/svg%3E");-webkit-mask:var(--un-icon) no-repeat;mask:var(--un-icon) no-repeat;-webkit-mask-size:100% 100%;mask-size:100% 100%;background-color:currentColor;color:inherit;width:1.2em;height:1.2em}[i-ri-arrow-right-s-line=""]{--un-icon:url("data:image/svg+xml;utf8,%3Csvg viewBox='0 0 24 24' width='1.2em' height='1.2em' xmlns='http://www.w3.org/2000/svg' %3E%3Cpath fill='currentColor' d='m13.171 12l-4.95-4.95l1.415-1.413L16 12l-6.364 6.364l-1.414-1.415l4.95-4.95Z'/%3E%3C/svg%3E");-webkit-mask:var(--un-icon) no-repeat;mask:var(--un-icon) no-repeat;-webkit-mask-size:100% 100%;mask-size:100% 100%;background-color:currentColor;color:inherit;width:1.2em;height:1.2em}[i-ri-arrow-up-s-line=""]{--un-icon:url("data:image/svg+xml;utf8,%3Csvg viewBox='0 0 24 24' width='1.2em' height='1.2em' xmlns='http://www.w3.org/2000/svg' %3E%3Cpath fill='currentColor' d='m12 10.828l-4.95 4.95l-1.414-1.414L12 8l6.364 6.364l-1.415 1.414l-4.95-4.95Z'/%3E%3C/svg%3E");-webkit-mask:var(--un-icon) no-repeat;mask:var(--un-icon) no-repeat;-webkit-mask-size:100% 100%;mask-size:100% 100%;background-color:currentColor;color:inherit;width:1.2em;height:1.2em}.i-ri-bilibili-line{--un-icon:url("data:image/svg+xml;utf8,%3Csvg viewBox='0 0 24 24' width='1.2em' height='1.2em' xmlns='http://www.w3.org/2000/svg' %3E%3Cpath fill='currentColor' d='M7.172 2.757L10.414 6h3.171l3.243-3.242a1 1 0 1 1 1.415 1.414L16.414 6H18.5A3.5 3.5 0 0 1 22 9.5v8a3.5 3.5 0 0 1-3.5 3.5h-13A3.5 3.5 0 0 1 2 17.5v-8A3.5 3.5 0 0 1 5.5 6h2.085L5.757 4.171a1 1 0 0 1 1.415-1.414ZM18.5 8h-13a1.5 1.5 0 0 0-1.493 1.355L4 9.5v8a1.5 1.5 0 0 0 1.356 1.493L5.5 19h13a1.5 1.5 0 0 0 1.493-1.356L20 17.5v-8A1.5 1.5 0 0 0 18.5 8ZM8 11a1 1 0 0 1 1 1v2a1 1 0 1 1-2 0v-2a1 1 0 0 1 1-1Zm8 0a1 1 0 0 1 1 1v2a1 1 0 1 1-2 0v-2a1 1 0 0 1 1-1Z'/%3E%3C/svg%3E");-webkit-mask:var(--un-icon) no-repeat;mask:var(--un-icon) no-repeat;-webkit-mask-size:100% 100%;mask-size:100% 100%;background-color:currentColor;color:inherit;width:1.2em;height:1.2em}[i-ri-calendar-2-line=""]{--un-icon:url("data:image/svg+xml;utf8,%3Csvg viewBox='0 0 24 24' width='1.2em' height='1.2em' xmlns='http://www.w3.org/2000/svg' %3E%3Cpath fill='currentColor' d='M9 1v2h6V1h2v2h4a1 1 0 0 1 1 1v16a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V4a1 1 0 0 1 1-1h4V1h2Zm11 10H4v8h16v-8ZM8 13v2H6v-2h2Zm5 0v2h-2v-2h2Zm5 0v2h-2v-2h2ZM7 5H4v4h16V5h-3v2h-2V5H9v2H7V5Z'/%3E%3C/svg%3E");-webkit-mask:var(--un-icon) no-repeat;mask:var(--un-icon) no-repeat;-webkit-mask-size:100% 100%;mask-size:100% 100%;background-color:currentColor;color:inherit;width:1.2em;height:1.2em}[i-ri-calendar-line=""]{--un-icon:url("data:image/svg+xml;utf8,%3Csvg viewBox='0 0 24 24' width='1.2em' height='1.2em' xmlns='http://www.w3.org/2000/svg' %3E%3Cpath fill='currentColor' d='M9 1v2h6V1h2v2h4a1 1 0 0 1 1 1v16a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V4a1 1 0 0 1 1-1h4V1h2Zm11 10H4v8h16v-8ZM7 5H4v4h16V5h-3v2h-2V5H9v2H7V5Z'/%3E%3C/svg%3E");-webkit-mask:var(--un-icon) no-repeat;mask:var(--un-icon) no-repeat;-webkit-mask-size:100% 100%;mask-size:100% 100%;background-color:currentColor;color:inherit;width:1.2em;height:1.2em}[i-ri-chat-4-line=""]{--un-icon:url("data:image/svg+xml;utf8,%3Csvg viewBox='0 0 24 24' width='1.2em' height='1.2em' xmlns='http://www.w3.org/2000/svg' %3E%3Cpath fill='currentColor' d='M5.763 17H20V5H4v13.385L5.763 17Zm.692 2L2 22.5V4a1 1 0 0 1 1-1h18a1 1 0 0 1 1 1v14a1 1 0 0 1-1 1H6.455Z'/%3E%3C/svg%3E");-webkit-mask:var(--un-icon) no-repeat;mask:var(--un-icon) no-repeat;-webkit-mask-size:100% 100%;mask-size:100% 100%;background-color:currentColor;color:inherit;width:1.2em;height:1.2em}.i-ri-clipboard-line{--un-icon:url("data:image/svg+xml;utf8,%3Csvg viewBox='0 0 24 24' width='1.2em' height='1.2em' xmlns='http://www.w3.org/2000/svg' %3E%3Cpath fill='currentColor' d='M7 4V2h10v2h3.007c.548 0 .993.445.993.993v16.014a.994.994 0 0 1-.993.993H3.993A.993.993 0 0 1 3 21.007V4.993C3 4.445 3.445 4 3.993 4H7Zm0 2H5v14h14V6h-2v2H7V6Zm2-2v2h6V4H9Z'/%3E%3C/svg%3E");-webkit-mask:var(--un-icon) no-repeat;mask:var(--un-icon) no-repeat;-webkit-mask-size:100% 100%;mask-size:100% 100%;background-color:currentColor;color:inherit;width:1.2em;height:1.2em}[i-ri-eye-line=""]{--un-icon:url("data:image/svg+xml;utf8,%3Csvg viewBox='0 0 24 24' width='1.2em' height='1.2em' xmlns='http://www.w3.org/2000/svg' %3E%3Cpath fill='currentColor' d='M12 3c5.392 0 9.878 3.88 10.819 9c-.94 5.12-5.427 9-10.819 9c-5.392 0-9.878-3.88-10.818-9C2.122 6.88 6.608 3 12 3Zm0 16a9.005 9.005 0 0 0 8.778-7a9.005 9.005 0 0 0-17.555 0A9.005 9.005 0 0 0 12 19Zm0-2.5a4.5 4.5 0 1 1 0-9a4.5 4.5 0 0 1 0 9Zm0-2a2.5 2.5 0 1 0 0-5a2.5 2.5 0 0 0 0 5Z'/%3E%3C/svg%3E");-webkit-mask:var(--un-icon) no-repeat;mask:var(--un-icon) no-repeat;-webkit-mask-size:100% 100%;mask-size:100% 100%;background-color:currentColor;color:inherit;width:1.2em;height:1.2em}[i-ri-file-list-line=""]{--un-icon:url("data:image/svg+xml;utf8,%3Csvg viewBox='0 0 24 24' width='1.2em' height='1.2em' xmlns='http://www.w3.org/2000/svg' %3E%3Cpath fill='currentColor' d='M20 22H4a1 1 0 0 1-1-1V3a1 1 0 0 1 1-1h16a1 1 0 0 1 1 1v18a1 1 0 0 1-1 1Zm-1-2V4H5v16h14ZM8 7h8v2H8V7Zm0 4h8v2H8v-2Zm0 4h8v2H8v-2Z'/%3E%3C/svg%3E");-webkit-mask:var(--un-icon) no-repeat;mask:var(--un-icon) no-repeat;-webkit-mask-size:100% 100%;mask-size:100% 100%;background-color:currentColor;color:inherit;width:1.2em;height:1.2em}[i-ri-file-word-line=""]{--un-icon:url("data:image/svg+xml;utf8,%3Csvg viewBox='0 0 24 24' width='1.2em' height='1.2em' xmlns='http://www.w3.org/2000/svg' %3E%3Cpath fill='currentColor' d='M16 8v8h-2l-2-2l-2 2H8V8h2v5l2-2l2 2V8h1V4H5v16h14V8h-3ZM3 2.992C3 2.444 3.447 2 3.998 2H16l5 5v13.992A1 1 0 0 1 20.007 22H3.993A1 1 0 0 1 3 21.008V2.992Z'/%3E%3C/svg%3E");-webkit-mask:var(--un-icon) no-repeat;mask:var(--un-icon) no-repeat;-webkit-mask-size:100% 100%;mask-size:100% 100%;background-color:currentColor;color:inherit;width:1.2em;height:1.2em}[i-ri-folder-2-line=""]{--un-icon:url("data:image/svg+xml;utf8,%3Csvg viewBox='0 0 24 24' width='1.2em' height='1.2em' xmlns='http://www.w3.org/2000/svg' %3E%3Cpath fill='currentColor' d='M12.414 5H21a1 1 0 0 1 1 1v14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V4a1 1 0 0 1 1-1h7.414l2 2ZM20 11H4v8h16v-8Zm0-2V7h-8.414l-2-2H4v4h16Z'/%3E%3C/svg%3E");-webkit-mask:var(--un-icon) no-repeat;mask:var(--un-icon) no-repeat;-webkit-mask-size:100% 100%;mask-size:100% 100%;background-color:currentColor;color:inherit;width:1.2em;height:1.2em}.i-ri-gallery-line{--un-icon:url("data:image/svg+xml;utf8,%3Csvg viewBox='0 0 24 24' width='1.2em' height='1.2em' xmlns='http://www.w3.org/2000/svg' %3E%3Cpath fill='currentColor' d='M20 13c-1.678 0-3.249.46-4.593 1.259A14.984 14.984 0 0 1 18.147 19H20v-6Zm-3.996 6C14.044 14.302 9.408 11 4 11v8h12.004ZM4 9c3.83 0 7.323 1.435 9.974 3.796A10.949 10.949 0 0 1 20 11V3h1.008c.548 0 .992.445.992.993v16.014a1 1 0 0 1-.992.993H2.992A.993.993 0 0 1 2 20.007V3.993A1 1 0 0 1 2.992 3H6V1h2v4H4v4Zm14-8v4h-8V3h6V1h2Zm-1.5 9a1.5 1.5 0 1 1 0-3a1.5 1.5 0 0 1 0 3Z'/%3E%3C/svg%3E");-webkit-mask:var(--un-icon) no-repeat;mask:var(--un-icon) no-repeat;-webkit-mask-size:100% 100%;mask-size:100% 100%;background-color:currentColor;color:inherit;width:1.2em;height:1.2em}.i-ri-github-line{--un-icon:url("data:image/svg+xml;utf8,%3Csvg viewBox='0 0 24 24' width='1.2em' height='1.2em' xmlns='http://www.w3.org/2000/svg' %3E%3Cpath fill='currentColor' d='M5.884 18.653c-.3-.2-.558-.456-.86-.816a50.59 50.59 0 0 1-.466-.579c-.463-.575-.755-.841-1.056-.95a1 1 0 1 1 .675-1.882c.752.27 1.261.735 1.947 1.588c-.094-.117.34.427.433.539c.19.227.33.365.44.438c.204.137.588.196 1.15.14c.024-.382.094-.753.202-1.096c-2.968-.725-4.648-2.64-4.648-6.396c0-1.238.37-2.355 1.058-3.291c-.218-.894-.185-1.975.302-3.192a1 1 0 0 1 .63-.583c.081-.024.127-.034.208-.047c.803-.123 1.937.17 3.415 1.097a11.731 11.731 0 0 1 2.687-.308c.912 0 1.819.103 2.684.308c1.477-.933 2.614-1.227 3.422-1.097c.085.014.158.032.218.051a1 1 0 0 1 .616.58c.487 1.215.52 2.296.302 3.19c.691.936 1.058 2.045 1.058 3.292c0 3.758-1.674 5.666-4.642 6.393c.125.415.19.878.19 1.38c0 .664-.002 1.299-.007 2.01c0 .19-.002.394-.005.706a1 1 0 0 1-.018 1.957c-1.14.228-1.984-.532-1.984-1.524l.002-.447l.005-.705c.005-.707.008-1.338.008-1.997c0-.697-.184-1.152-.426-1.361c-.661-.57-.326-1.654.541-1.751c2.966-.334 4.336-1.483 4.336-4.66c0-.955-.312-1.745-.913-2.405a1 1 0 0 1-.189-1.044c.166-.415.236-.957.095-1.614l-.01.002c-.491.14-1.11.44-1.858.95a1 1 0 0 1-.833.135a9.626 9.626 0 0 0-2.592-.35c-.89 0-1.772.12-2.592.35a1 1 0 0 1-.829-.133c-.753-.507-1.374-.807-1.87-.947c-.143.653-.072 1.194.093 1.607a1 1 0 0 1-.189 1.044c-.597.656-.913 1.459-.913 2.404c0 3.172 1.371 4.33 4.322 4.66c.865.098 1.202 1.178.545 1.749c-.193.167-.43.732-.43 1.364v3.149c0 .986-.834 1.726-1.96 1.529a1 1 0 0 1-.04-1.963v-.99c-.91.062-1.661-.087-2.254-.484Z'/%3E%3C/svg%3E");-webkit-mask:var(--un-icon) no-repeat;mask:var(--un-icon) no-repeat;-webkit-mask-size:100% 100%;mask-size:100% 100%;background-color:currentColor;color:inherit;width:1.2em;height:1.2em}.i-ri-heart-line,[i-ri-heart-line=""]{--un-icon:url("data:image/svg+xml;utf8,%3Csvg viewBox='0 0 24 24' width='1.2em' height='1.2em' xmlns='http://www.w3.org/2000/svg' %3E%3Cpath fill='currentColor' d='M12.001 4.529a5.998 5.998 0 0 1 8.242.228a6 6 0 0 1 .236 8.236l-8.48 8.492l-8.478-8.492a6 6 0 0 1 8.48-8.464Zm6.826 1.641a3.998 3.998 0 0 0-5.49-.153l-1.335 1.198l-1.336-1.197a4 4 0 0 0-5.686 5.605L12 18.654l7.02-7.03a4 4 0 0 0-.193-5.454Z'/%3E%3C/svg%3E");-webkit-mask:var(--un-icon) no-repeat;mask:var(--un-icon) no-repeat;-webkit-mask-size:100% 100%;mask-size:100% 100%;background-color:currentColor;color:inherit;width:1.2em;height:1.2em}[i-ri-home-4-line=""]{--un-icon:url("data:image/svg+xml;utf8,%3Csvg viewBox='0 0 24 24' width='1.2em' height='1.2em' xmlns='http://www.w3.org/2000/svg' %3E%3Cpath fill='currentColor' d='M19 21H5a1 1 0 0 1-1-1v-9H1l10.327-9.388a1 1 0 0 1 1.346 0L23 11h-3v9a1 1 0 0 1-1 1Zm-6-2h5V9.158l-6-5.455l-6 5.455V19h5v-6h2v6Z'/%3E%3C/svg%3E");-webkit-mask:var(--un-icon) no-repeat;mask:var(--un-icon) no-repeat;-webkit-mask-size:100% 100%;mask-size:100% 100%;background-color:currentColor;color:inherit;width:1.2em;height:1.2em}.i-ri-keynote-line{--un-icon:url("data:image/svg+xml;utf8,%3Csvg viewBox='0 0 24 24' width='1.2em' height='1.2em' xmlns='http://www.w3.org/2000/svg' %3E%3Cpath fill='currentColor' d='M4.44 10h15.12l-1.2-6H5.64l-1.2 6ZM13 12v8h4v2H7v-2h4v-8H2.992c-.548 0-.906-.43-.797-.977l1.61-8.046C3.913 2.437 4.445 2 5 2h13.998c.553 0 1.087.43 1.197.977l1.609 8.046c.108.54-.26.977-.797.977H13Z'/%3E%3C/svg%3E");-webkit-mask:var(--un-icon) no-repeat;mask:var(--un-icon) no-repeat;-webkit-mask-size:100% 100%;mask-size:100% 100%;background-color:currentColor;color:inherit;width:1.2em;height:1.2em}.i-ri-mail-line{--un-icon:url("data:image/svg+xml;utf8,%3Csvg viewBox='0 0 24 24' width='1.2em' height='1.2em' xmlns='http://www.w3.org/2000/svg' %3E%3Cpath fill='currentColor' d='M3 3h18a1 1 0 0 1 1 1v16a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V4a1 1 0 0 1 1-1Zm17 4.238l-7.928 7.1L4 7.216V19h16V7.238ZM4.511 5l7.55 6.662L19.502 5H4.511Z'/%3E%3C/svg%3E");-webkit-mask:var(--un-icon) no-repeat;mask:var(--un-icon) no-repeat;-webkit-mask-size:100% 100%;mask-size:100% 100%;background-color:currentColor;color:inherit;width:1.2em;height:1.2em}.i-ri-netease-cloud-music-line{--un-icon:url("data:image/svg+xml;utf8,%3Csvg viewBox='0 0 24 24' width='1.2em' height='1.2em' xmlns='http://www.w3.org/2000/svg' %3E%3Cpath fill='currentColor' d='M10.422 11.375c-.294 1.028.012 2.065.784 2.653c1.061.81 2.565.3 2.874-.995c.08-.337.103-.722.027-1.056c-.23-1.001-.521-1.988-.792-2.996c-1.33.154-2.543 1.172-2.893 2.394Zm5.548-.287c.273 1.012.285 2.017-.127 3c-1.128 2.69-4.722 3.14-6.573.826c-1.302-1.627-1.28-3.961.06-5.734c.78-1.032 1.804-1.707 3.048-2.054l.379-.104c-.084-.415-.188-.816-.243-1.224c-.176-1.317.512-2.503 1.744-3.04c1.226-.535 2.708-.216 3.53.76c.406.479.395 1.08-.025 1.464c-.412.377-.997.346-1.435-.09c-.247-.246-.51-.44-.877-.436c-.525.006-.987.418-.945.937c.037.468.172.93.3 1.386c.022.078.216.135.338.153c1.333.197 2.504.731 3.472 1.676c2.558 2.493 2.861 6.531.672 9.44c-1.529 2.032-3.61 3.169-6.127 3.409c-4.621.44-8.664-2.53-9.7-7.058C2.516 10.255 4.84 5.831 8.796 4.25c.586-.234 1.143-.031 1.371.498c.232.537-.019 1.086-.61 1.35c-2.368 1.06-3.817 2.855-4.215 5.423c-.533 3.434 1.656 6.777 5 7.722c2.723.769 5.658-.167 7.308-2.33c1.586-2.08 1.4-5.1-.427-6.874A3.978 3.978 0 0 0 15.4 9.026c.198.716.389 1.388.57 2.062Z'/%3E%3C/svg%3E");-webkit-mask:var(--un-icon) no-repeat;mask:var(--un-icon) no-repeat;-webkit-mask-size:100% 100%;mask-size:100% 100%;background-color:currentColor;color:inherit;width:1.2em;height:1.2em}.i-ri-open-arm-line{--un-icon:url("data:image/svg+xml;utf8,%3Csvg viewBox='0 0 24 24' width='1.2em' height='1.2em' xmlns='http://www.w3.org/2000/svg' %3E%3Cpath fill='currentColor' d='M18.001 17v5h-2v-5c0-4.451 2.644-8.285 6.447-10.016l.828 1.82A9.002 9.002 0 0 0 18.001 17Zm-10 0v5h-2v-5A9.002 9.002 0 0 0 .727 8.805l.827-1.821A11.002 11.002 0 0 1 8.001 17Zm4-5a5 5 0 1 1 0-10a5 5 0 0 1 0 10Zm0-2a3 3 0 1 0 0-6a3 3 0 0 0 0 6Z'/%3E%3C/svg%3E");-webkit-mask:var(--un-icon) no-repeat;mask:var(--un-icon) no-repeat;-webkit-mask-size:100% 100%;mask-size:100% 100%;background-color:currentColor;color:inherit;width:1.2em;height:1.2em}[i-ri-price-tag-3-line=""]{--un-icon:url("data:image/svg+xml;utf8,%3Csvg viewBox='0 0 24 24' width='1.2em' height='1.2em' xmlns='http://www.w3.org/2000/svg' %3E%3Cpath fill='currentColor' d='m10.904 2.1l9.9 1.414l1.414 9.9l-9.193 9.192a1 1 0 0 1-1.414 0l-9.9-9.9a1 1 0 0 1 0-1.413L10.905 2.1Zm.707 2.121L3.833 12l8.485 8.485l7.779-7.778l-1.061-7.425l-7.425-1.06Zm2.122 6.364a2 2 0 1 1 2.828-2.828a2 2 0 0 1-2.828 2.828Z'/%3E%3C/svg%3E");-webkit-mask:var(--un-icon) no-repeat;mask:var(--un-icon) no-repeat;-webkit-mask-size:100% 100%;mask-size:100% 100%;background-color:currentColor;color:inherit;width:1.2em;height:1.2em}[i-ri-pushpin-line=""]{--un-icon:url("data:image/svg+xml;utf8,%3Csvg viewBox='0 0 24 24' width='1.2em' height='1.2em' xmlns='http://www.w3.org/2000/svg' %3E%3Cpath fill='currentColor' d='m13.827 1.69l8.486 8.485l-1.415 1.414l-.707-.707l-4.242 4.243l-.707 3.535l-1.415 1.415l-4.242-4.243l-4.95 4.95l-1.414-1.414l4.95-4.95l-4.243-4.243l1.414-1.414l3.536-.707L13.12 3.81l-.707-.707l1.414-1.414Zm.707 3.535l-4.67 4.671l-2.822.565l6.5 6.5l.564-2.822l4.671-4.67l-4.243-4.244Z'/%3E%3C/svg%3E");-webkit-mask:var(--un-icon) no-repeat;mask:var(--un-icon) no-repeat;-webkit-mask-size:100% 100%;mask-size:100% 100%;background-color:currentColor;color:inherit;width:1.2em;height:1.2em}.i-ri-rss-line{--un-icon:url("data:image/svg+xml;utf8,%3Csvg viewBox='0 0 24 24' width='1.2em' height='1.2em' xmlns='http://www.w3.org/2000/svg' %3E%3Cpath fill='currentColor' d='M3 17a4 4 0 0 1 4 4H3v-4Zm0-7c6.075 0 11 4.925 11 11h-2a9 9 0 0 0-9-9v-2Zm0-7c9.941 0 18 8.059 18 18h-2c0-8.837-7.163-16-16-16V3Z'/%3E%3C/svg%3E");-webkit-mask:var(--un-icon) no-repeat;mask:var(--un-icon) no-repeat;-webkit-mask-size:100% 100%;mask-size:100% 100%;background-color:currentColor;color:inherit;width:1.2em;height:1.2em}[i-ri-search-line=""]{--un-icon:url("data:image/svg+xml;utf8,%3Csvg viewBox='0 0 24 24' width='1.2em' height='1.2em' xmlns='http://www.w3.org/2000/svg' %3E%3Cpath fill='currentColor' d='m18.031 16.617l4.283 4.282l-1.415 1.415l-4.282-4.283A8.96 8.96 0 0 1 11 20c-4.968 0-9-4.032-9-9s4.032-9 9-9s9 4.032 9 9a8.96 8.96 0 0 1-1.969 5.617Zm-2.006-.742A6.977 6.977 0 0 0 18 11c0-3.867-3.133-7-7-7s-7 3.133-7 7s3.133 7 7 7a6.977 6.977 0 0 0 4.875-1.975l.15-.15Z'/%3E%3C/svg%3E");-webkit-mask:var(--un-icon) no-repeat;mask:var(--un-icon) no-repeat;-webkit-mask-size:100% 100%;mask-size:100% 100%;background-color:currentColor;color:inherit;width:1.2em;height:1.2em}.i-ri-telegram-line{--un-icon:url("data:image/svg+xml;utf8,%3Csvg viewBox='0 0 24 24' width='1.2em' height='1.2em' xmlns='http://www.w3.org/2000/svg' %3E%3Cpath fill='currentColor' d='M12.001 20a8 8 0 1 0 0-16a8 8 0 0 0 0 16Zm0 2c-5.523 0-10-4.477-10-10s4.477-10 10-10s10 4.477 10 10s-4.477 10-10 10Zm-3.11-8.83l-2.498-.779c-.54-.165-.543-.537.121-.804l9.733-3.76c.564-.23.886.061.703.79l-1.658 7.82c-.116.557-.451.69-.916.433l-2.551-1.888l-1.189 1.148c-.122.118-.221.219-.409.244c-.187.026-.341-.03-.454-.34l-.87-2.871l-.012.008Z'/%3E%3C/svg%3E");-webkit-mask:var(--un-icon) no-repeat;mask:var(--un-icon) no-repeat;-webkit-mask-size:100% 100%;mask-size:100% 100%;background-color:currentColor;color:inherit;width:1.2em;height:1.2em}[i-ri-timer-line=""]{--un-icon:url("data:image/svg+xml;utf8,%3Csvg viewBox='0 0 24 24' width='1.2em' height='1.2em' xmlns='http://www.w3.org/2000/svg' %3E%3Cpath fill='currentColor' d='m17.618 5.968l1.453-1.453l1.414 1.414l-1.453 1.453A9 9 0 1 1 12 4c2.125 0 4.078.736 5.618 1.968ZM12 20a7 7 0 1 0 0-14a7 7 0 0 0 0 14ZM11 8h2v6h-2V8ZM8 1h8v2H8V1Z'/%3E%3C/svg%3E");-webkit-mask:var(--un-icon) no-repeat;mask:var(--un-icon) no-repeat;-webkit-mask-size:100% 100%;mask-size:100% 100%;background-color:currentColor;color:inherit;width:1.2em;height:1.2em}.i-ri-train-line{--un-icon:url("data:image/svg+xml;utf8,%3Csvg viewBox='0 0 24 24' width='1.2em' height='1.2em' xmlns='http://www.w3.org/2000/svg' %3E%3Cpath fill='currentColor' d='m17.2 20l1.8 1.5v.5H5v-.5L6.8 20H5a2 2 0 0 1-2-2V7a4 4 0 0 1 4-4h10a4 4 0 0 1 4 4v11a2 2 0 0 1-2 2h-1.8ZM7 5a2 2 0 0 0-2 2v11h14V7a2 2 0 0 0-2-2H7Zm5 12a2 2 0 1 1 0-4a2 2 0 0 1 0 4ZM6 7h12v4H6V7Z'/%3E%3C/svg%3E");-webkit-mask:var(--un-icon) no-repeat;mask:var(--un-icon) no-repeat;-webkit-mask-size:100% 100%;mask-size:100% 100%;background-color:currentColor;color:inherit;width:1.2em;height:1.2em}[i-ri-translate=""]{--un-icon:url("data:image/svg+xml;utf8,%3Csvg viewBox='0 0 24 24' width='1.2em' height='1.2em' xmlns='http://www.w3.org/2000/svg' %3E%3Cpath fill='currentColor' d='M5 15v2a2 2 0 0 0 1.85 1.994L7 19h3v2H7a4 4 0 0 1-4-4v-2h2Zm13-5l4.4 11h-2.155l-1.201-3h-4.09l-1.199 3h-2.154L16 10h2Zm-1 2.885L15.753 16h2.492L17 12.885ZM8 2v2h4v7H8v3H6v-3H2V4h4V2h2Zm9 1a4 4 0 0 1 4 4v2h-2V7a2 2 0 0 0-2-2h-3V3h3ZM6 6H4v3h2V6Zm4 0H8v3h2V6Z'/%3E%3C/svg%3E");-webkit-mask:var(--un-icon) no-repeat;mask:var(--un-icon) no-repeat;-webkit-mask-size:100% 100%;mask-size:100% 100%;background-color:currentColor;color:inherit;width:1.2em;height:1.2em}.i-ri-wechat-pay-line{--un-icon:url("data:image/svg+xml;utf8,%3Csvg viewBox='0 0 24 24' width='1.2em' height='1.2em' xmlns='http://www.w3.org/2000/svg' %3E%3Cpath fill='currentColor' d='m19.146 8.993l-9.799 5.608l-.07.046a.647.647 0 0 1-.3.069a.655.655 0 0 1-.58-.345l-.046-.092l-1.831-3.95c-.023-.046-.023-.092-.023-.138c0-.183.139-.321.324-.321c.07 0 .139.023.209.069l2.155 1.515c.162.092.347.161.556.161a.938.938 0 0 0 .348-.069l8.274-3.648C16.935 6.273 14.635 5.2 12.001 5.2c-4.421 0-7.9 3.023-7.9 6.6c0 1.366.5 2.673 1.431 3.781c.049.058.12.137.215.235a4 4 0 0 1 1.1 3.102l-.024.298l.715-.437a4 4 0 0 1 2.706-.536c.211.033.385.059.52.077c.406.053.819.08 1.237.08c4.42 0 7.9-3.022 7.9-6.6c0-.996-.27-1.95-.755-2.807ZM6.193 21.943a1 1 0 0 1-1.527-.931l.189-2.26a2 2 0 0 0-.55-1.551a6.935 6.935 0 0 1-.303-.332C2.806 15.447 2.1 13.695 2.1 11.8c0-4.75 4.432-8.6 9.9-8.6c5.467 0 9.9 3.85 9.9 8.6s-4.433 8.6-9.9 8.6c-.51 0-1.01-.033-1.5-.098c-.152-.02-.342-.048-.568-.084a2 2 0 0 0-1.353.269l-2.387 1.456Z'/%3E%3C/svg%3E");-webkit-mask:var(--un-icon) no-repeat;mask:var(--un-icon) no-repeat;-webkit-mask-size:100% 100%;mask-size:100% 100%;background-color:currentColor;color:inherit;width:1.2em;height:1.2em}[i~=ri-sun-line]{--un-icon:url("data:image/svg+xml;utf8,%3Csvg viewBox='0 0 24 24' width='1.2em' height='1.2em' xmlns='http://www.w3.org/2000/svg' %3E%3Cpath fill='currentColor' d='M12 18a6 6 0 1 1 0-12a6 6 0 0 1 0 12Zm0-2a4 4 0 1 0 0-8a4 4 0 0 0 0 8ZM11 1h2v3h-2V1Zm0 19h2v3h-2v-3ZM3.515 4.929l1.414-1.414L7.05 5.636L5.636 7.05L3.515 4.93ZM16.95 18.364l1.414-1.414l2.121 2.121l-1.414 1.414l-2.121-2.121Zm2.121-14.85l1.414 1.415l-2.121 2.121l-1.414-1.414l2.121-2.121ZM5.636 16.95l1.414 1.414l-2.121 2.121l-1.414-1.414l2.121-2.121ZM23 11v2h-3v-2h3ZM4 11v2H1v-2h3Z'/%3E%3C/svg%3E");-webkit-mask:var(--un-icon) no-repeat;mask:var(--un-icon) no-repeat;-webkit-mask-size:100% 100%;mask-size:100% 100%;background-color:currentColor;color:inherit;width:1.2em;height:1.2em}.yun-card{margin:auto;--un-shadow:var(--un-shadow-inset) 0 1px 3px 0 var(--un-shadow-color, rgb(0 0 0 / .1)),var(--un-shadow-inset) 0 1px 2px -1px var(--un-shadow-color, rgb(0 0 0 / .1));box-shadow:var(--un-ring-offset-shadow),var(--un-ring-shadow),var(--un-shadow);transition-property:color,background-color,border-color,outline-color,text-decoration-color,fill,stroke,opacity,box-shadow,transform,filter,backdrop-filter;transition-timing-function:cubic-bezier(.4,0,.2,1);transition-duration:.15s;transition-duration:var(--va-transition-duration)}.flex-center{display:flex;align-items:center;justify-content:center}.inline-flex-center{display:inline-flex;align-items:center;justify-content:center}.va-card{background-color:var(--va-c-bg-light);--un-shadow:var(--un-shadow-inset) 0 1px 3px 0 var(--un-shadow-color, rgb(0 0 0 / .1)),var(--un-shadow-inset) 0 1px 2px -1px var(--un-shadow-color, rgb(0 0 0 / .1));box-shadow:var(--un-ring-offset-shadow),var(--un-ring-shadow),var(--un-shadow)}.va-card:hover,.yun-card:hover{--un-shadow:var(--un-shadow-inset) 0 10px 15px -3px var(--un-shadow-color, rgb(0 0 0 / .1)),var(--un-shadow-inset) 0 4px 6px -4px var(--un-shadow-color, rgb(0 0 0 / .1));box-shadow:var(--un-ring-offset-shadow),var(--un-ring-shadow),var(--un-shadow)}@media (max-width:767.9px){.yun-main{padding-left:0}}[absolute=""]{position:absolute}.fixed{position:fixed}.relative{position:relative}.inset-y-0{top:0;bottom:0}[bottom-0=""]{bottom:0}.left-0,[left-0=""]{left:0}.left-0\.8rem{left:.8rem}[right-0=""]{right:0}[top-0=""]{top:0}.top-0\.6rem{top:.6rem}[bottom~="19"]{bottom:4.75rem}[right~="2"]{right:.5rem}.z-1{z-index:1}[z-10=""]{z-index:10}.z-350{z-index:350}[z~="$yun-z-menu-btn"]{z-index:var(--yun-z-menu-btn)}[z~="$yun-z-sidebar"]{z-index:var(--yun-z-sidebar)}[m~="0"]{margin:0}[m~="2"]{margin:.5rem}[mx-1=""],[m~=x-1]{margin-left:.25rem;margin-right:.25rem}[m~=y-4]{margin-top:1rem;margin-bottom:1rem}[my~="1"]{margin-top:.25rem;margin-bottom:.25rem}[mx~="2"],[m~=x-2]{margin-left:.5rem;margin-right:.5rem}[m~=y-2]{margin-top:.5rem;margin-bottom:.5rem}[mb~="4"],[m~=b-4]{margin-bottom:1rem}.mb-2,[m~=b-2]{margin-bottom:.5rem}[ml-1=""],[m~=l-1]{margin-left:.25rem}[m~=t-4]{margin-top:1rem}[mt-6=""],[m~=t-6]{margin-top:1.5rem}[m~=l-4]{margin-left:1rem}[m~=t-0]{margin-top:0}[m~=t-16]{margin-top:4rem}[mt~="2"]{margin-top:.5rem}.block{display:block}.inline-block{display:inline-block}.h-8,[h~="8"]{height:2rem}[h~="5"]{height:1.25rem}.w-8,[w~="8"]{width:2rem}[w~=full]{width:100%}[h~="64"]{height:16rem}[h~="7"]{height:1.75rem}[min-h~="100px"]{min-height:100px}.flex,[flex=""],[flex~="~"]{display:flex}.inline-flex,[inline-flex=""]{display:inline-flex}[flex~="1"]{flex:1 1 0%}.flex-grow,[flex~=grow]{flex-grow:1}.flex-col,[flex~=col]{flex-direction:column}[flex~=wrap]{flex-wrap:wrap}.transform{transform:translate(var(--un-translate-x)) translateY(var(--un-translate-y)) translateZ(var(--un-translate-z)) rotate(var(--un-rotate)) rotateX(var(--un-rotate-x)) rotateY(var(--un-rotate-y)) rotate(var(--un-rotate-z)) skew(var(--un-skew-x)) skewY(var(--un-skew-y)) scaleX(var(--un-scale-x)) scaleY(var(--un-scale-y)) scaleZ(var(--un-scale-z))}@keyframes fade-in{0%{opacity:0}to{opacity:1}}@keyframes pulse{0%,to{opacity:1}50%{opacity:.5}}.animate-fade-in{animation:fade-in 1s linear 1}.animate-pulse{animation:pulse 2s cubic-bezier(.4,0,.6,1) infinite}.animate-iteration-1{animation-iteration-count:1}[cursor~=pointer]{cursor:pointer}.select-none{-webkit-user-select:none;user-select:none}.items-center,[items-center=""],[items~=center]{align-items:center}[justify~=end]{justify-content:flex-end}.justify-center,[justify~=center]{justify-content:center}.justify-around{justify-content:space-around}.gap-2{gap:.5rem}[gap~="1"]{gap:.25rem}[overflow~=auto]{overflow:auto}.overflow-y-auto{overflow-y:auto}.truncate{overflow:hidden;text-overflow:ellipsis;white-space:nowrap}[border=""],[border~="~"]{border-width:1px}.border-\$va-c-divider{border-color:var(--va-c-divider)}.hover\:border-blue-500:hover{--un-border-opacity:1;border-color:rgb(59 130 246 / var(--un-border-opacity))}.rounded,[border~=rounded]{border-radius:.25rem}.rounded-full,[rounded-full=""]{border-radius:9999px}[bg~="$va-c-bg-light"]{background-color:var(--va-c-bg-light)}[bg~="$va-c-bg"]{background-color:var(--va-c-bg)}[bg~="$yun-sidebar-bg-color"]{background-color:var(--yun-sidebar-bg-color)}[bg~=contain]{background-size:contain}[bg~=no-repeat]{background-repeat:no-repeat}[stroke-width~="2"]{stroke-width:2px}.object-cover{object-fit:cover}.p-4,[p~="4"]{padding:1rem}[p~="1"]{padding:.25rem}[p~="2"]{padding:.5rem}[px-2=""]{padding-left:.5rem;padding-right:.5rem}[p~=x-4]{padding-left:1rem;padding-right:1rem}[py~="1"]{padding-top:.25rem;padding-bottom:.25rem}[p~=b-8]{padding-bottom:2rem}[p~=l-4]{padding-left:1rem}[text~=center]{text-align:center}[text~="2xl"]{font-size:1.5rem;line-height:2rem}[text-xl=""],[text~=xl]{font-size:1.25rem;line-height:1.75rem}.text-xs,[text~=xs]{font-size:.75rem;line-height:1rem}[text~=sm]{font-size:.875rem;line-height:1.25rem}[font~=black]{font-weight:900}.leading-4{line-height:1rem}.leading-6{line-height:1.5rem}.leading-none{line-height:1}[color~="$va-c-warning"]{color:var(--va-c-warning)}.text-\$va-c-text-light{color:var(--va-c-text-light)}[text~=red-400]{--un-text-opacity:1;color:rgb(248 113 113 / var(--un-text-opacity))}.hover\:text-blue-500:hover{--un-text-opacity:1;color:rgb(59 130 246 / var(--un-text-opacity))}[op~="20"]{opacity:.2}.shadow{--un-shadow:var(--un-shadow-inset) 0 1px 3px 0 var(--un-shadow-color, rgb(0 0 0 / .1)),var(--un-shadow-inset) 0 1px 2px -1px var(--un-shadow-color, rgb(0 0 0 / .1));box-shadow:var(--un-ring-offset-shadow),var(--un-ring-shadow),var(--un-shadow)}.hover\:shadow-md:hover{--un-shadow:var(--un-shadow-inset) 0 4px 6px -1px var(--un-shadow-color, rgb(0 0 0 / .1)),var(--un-shadow-inset) 0 2px 4px -2px var(--un-shadow-color, rgb(0 0 0 / .1));box-shadow:var(--un-ring-offset-shadow),var(--un-ring-shadow),var(--un-shadow)}.transition{transition-property:color,background-color,border-color,outline-color,text-decoration-color,fill,stroke,opacity,box-shadow,transform,filter,backdrop-filter;transition-timing-function:cubic-bezier(.4,0,.2,1);transition-duration:.15s}[font~=serif]{font-family:var(--va-font-serif)}@media (max-width:767.9px){.lt-md\:ml-0{margin-left:0}[p~="lt-md:0"]{padding:0}}@media (min-width:640px){.sm\:p-6{padding:1.5rem}.sm\:px-6{padding-left:1.5rem;padding-right:1.5rem}}@media (min-width:768px){.md\:hidden{display:none}.md\:translate-x-0{--un-translate-x:0;transform:translate(var(--un-translate-x)) translateY(var(--un-translate-y)) translateZ(var(--un-translate-z)) rotate(var(--un-rotate)) rotateX(var(--un-rotate-x)) rotateY(var(--un-rotate-y)) rotate(var(--un-rotate-z)) skew(var(--un-skew-x)) skewY(var(--un-skew-y)) scaleX(var(--un-scale-x)) scaleY(var(--un-scale-y)) scaleZ(var(--un-scale-z))}.md\:pl-\$va-sidebar-width{padding-left:var(--va-sidebar-width)}}@media (min-width:1024px){.lg\:px-12{padding-left:3rem;padding-right:3rem}}@media (min-width:1280px){.xl\:hidden{display:none}.xl\:px-16{padding-left:4rem;padding-right:4rem}}.va-toc[data-v-a7bc02d9]{text-align:left}.content[data-v-a7bc02d9]{position:relative;padding-left:16px;font-size:14px;text-align:left}.outline-marker[data-v-a7bc02d9]{position:absolute;top:32px;left:-2px;z-index:0;opacity:0;width:4px;height:18px;background-color:var(--va-c-brand);transition:top .25s cubic-bezier(0,1,.5,1),background-color .5s,opacity .25s;border-top-right-radius:2px;border-bottom-right-radius:2px}.outline-title[data-v-a7bc02d9]{letter-spacing:.4px;line-height:28px;font-size:14px;font-weight:600}.visually-hidden[data-v-a7bc02d9]{position:absolute;width:1px;height:1px;white-space:nowrap;clip:rect(0 0 0 0);clip-path:inset(50%);overflow:hidden}.yun-aside{position:fixed;right:0;top:0;bottom:0;width:var(--va-sidebar-width,300px);transform:translate(100%);transition:box-shadow var(--va-transition-duration),background-color var(--va-transition-duration),opacity .25s,transform var(--va-transition-duration) cubic-bezier(.19,1,.22,1)}@media screen and (min-width:1280px){.yun-aside{transform:translate(0)}}.toc-btn{color:var(--va-c-primary);background-color:#fff;z-index:var(--yun-z-toc-btn)}.col{color:#fcff49}:root{--waline-font-size:1rem;--waline-white:#fff;--waline-light-grey:#999;--waline-dark-grey:#666;--waline-theme-color:#27ae60;--waline-active-color:#2ecc71;--waline-color:#444;--waline-bgcolor:#fff;--waline-bgcolor-light:#f8f8f8;--waline-bgcolor-hover:#f0f0f0;--waline-border-color:#ddd;--waline-disable-bgcolor:#f8f8f8;--waline-disable-color:#000;--waline-code-bgcolor:#282c34;--waline-bq-color:#f0f0f0;--waline-avatar-size:3.25rem;--waline-m-avatar-size:calc(var(--waline-avatar-size) * 9 / 13);--waline-badge-color:#3498db;--waline-badge-font-size:.75em;--waline-info-bgcolor:#f8f8f8;--waline-info-color:#999;--waline-info-font-size:.625em;--waline-border:1px solid var(--waline-border-color);--waline-avatar-radius:50%;--waline-box-shadow:none}:root{--waline-theme-color:var(--va-c-primary);--waline-active-color:var(--va-c-primary-light)}.post-nav{display:flex;justify-content:space-between;align-items:center}.post-nav-item{display:inline-flex;justify-content:center;align-items:center;color:var(--va-c-primary);outline:0;font-size:1.5rem;font-weight:700;text-transform:uppercase;height:3rem;transition:.4s}.post-nav-item:hover{background-color:rgba(var(--va-c-primary-rgb),.1);box-shadow:0 0 15px #0000001a}.post-nav-next{padding:0 .1rem 0 .6rem}.post-nav-next{display:inline-flex;align-items:center;height:3rem;font-size:1rem}.post-nav-next .title,.post-nav-prev .title{overflow:hidden;max-width:10rem}.post-nav-next .icon,.post-nav-prev .icon{width:1.2rem;height:1.2rem}@media screen and (min-width:1024px){.post-nav-next .title,.post-nav-prev .title{max-width:18rem}}@media screen and (min-width:1280px){.content{max-width:calc(100vw - 2 * var(--va-sidebar-width) - 1rem - 8px)}}.link-item{display:inline-flex}:root{--page-btn-bg-color:rgba(255, 255, 255, .5);--page-btn-hover-bg-color:var(--va-c-primary-lighter);--page-btn-active-bg-color:var(--va-c-primary-light)}.post-top-icon{position:absolute;top:1rem;right:1rem;font-size:1.2rem}@-webkit-keyframes lg-right-end{0%{left:0}50%{left:-30px}to{left:0}}@-webkit-keyframes lg-left-end{0%{left:0}50%{left:30px}to{left:0}}:root{--banner-line-color:black;--banner-char-color:black;--banner-char-bg-color:rgba(255, 255, 255, .5);--banner-char-hover-color:white}.post-copyright{font-size:.9rem;padding:.5rem 1rem;border-left:4px solid #ff5252;background-color:var(--va-c-bg-dark);list-style:none;word-break:break-all;position:relative;overflow:hidden}.post-copyright:after{pointer-events:none;position:absolute;color:#fff;background:url("data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 496 512'%3E%3Cpath fill='gray' d='M245.8 214.9l-33.2 17.3c-9.4-19.6-25.2-20-27.4-20-22.2 0-33.3 14.6-33.3 43.9 0 23.5 9.2 43.8 33.3 43.8 14.4 0 24.6-7 30.5-21.3l30.6 15.5a73.2 73.2 0 01-65.1 39c-22.6 0-74-10.3-74-77 0-58.7 43-77 72.6-77 30.8-.1 52.7 11.9 66 35.8zm143 0l-32.7 17.3c-9.5-19.8-25.7-20-27.9-20-22.1 0-33.2 14.6-33.2 43.9 0 23.5 9.2 43.8 33.2 43.8 14.5 0 24.7-7 30.5-21.3l31 15.5c-2 3.8-21.3 39-65 39-22.7 0-74-9.9-74-77 0-58.7 43-77 72.6-77C354 179 376 191 389 214.8zM247.7 8C104.7 8 0 123 0 256c0 138.4 113.6 248 247.6 248C377.5 504 496 403 496 256 496 118 389.4 8 247.6 8zm.8 450.8c-112.5 0-203.7-93-203.7-202.8 0-105.5 85.5-203.3 203.8-203.3A201.7 201.7 0 01451.3 256c0 121.7-99.7 202.9-202.9 202.9z'/%3E%3C/svg%3E");content:" ";height:10rem;width:10rem;right:-2rem;top:-2rem;opacity:.1}.sponsor-button{background-color:#ffffff1a}.sponsor-button div{transform:scale(1.1);transition:transform var(--va-transition-duration) ease-in-out}.sponsor-button:hover{background-color:#ffffffe6}.sponsor-button:hover div{transform:scale(1.2)}.qrcode-container{overflow:hidden;height:0;transition:height var(--va-transition-duration) ease-in-out}.sponsor-description{color:var(--va-c-gray)}.sponsor-method-img{width:12rem;max-width:90%;aspect-ratio:1}</style><link rel="preload" href="/assets/index-463b4b4e.css" as="style"><link rel="modulepreload" crossorigin href="/js/posts/Concurrent_Programming_Compilation_Version-Lock_Free.5b06e1a0.js"><title>并发编程整理版-无锁 - imklaus's Blog</title><link rel="icon" href="https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230825001534253.png" type="image/png"><meta name="theme-color" content="#ffffff"><meta name="msapplication-TileColor" content="#ffffff"><meta name="generator" content="Valaxy 0.15.14"><meta property="og:locale:alternate" content="en"><meta name="description" content><meta property="og:description" content><meta property="og:locale" content="zh-CN"><meta property="og:site_name" content="imklaus's Blog "><meta property="og:title" content="并发编程整理版-无锁"><meta property="og:image" content="https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/wallhaven-3zqqdy_1920x1080.png"><meta property="og:type" content="website"><meta property="og:url" content="https://imlklaus.github.io/"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@900&amp;display=swap"><link rel="stylesheet" href="https://unpkg.com/aplayer/dist/APlayer.min.css"><link rel="preload" as="font" crossorigin="anonymous" href="/assets/KaTeX_AMS-Regular-0cdd387c.woff2"><link rel="preload" as="font" crossorigin="anonymous" href="/assets/KaTeX_Caligraphic-Bold-de7701e4.woff2"><link rel="preload" as="font" crossorigin="anonymous" href="/assets/KaTeX_Caligraphic-Regular-5d53e70a.woff2"><link rel="preload" as="font" crossorigin="anonymous" href="/assets/KaTeX_Fraktur-Bold-74444efd.woff2"><link rel="preload" as="font" crossorigin="anonymous" href="/assets/KaTeX_Fraktur-Regular-51814d27.woff2"><link rel="preload" as="font" crossorigin="anonymous" href="/assets/KaTeX_Main-Bold-0f60d1b8.woff2"><link rel="preload" as="font" crossorigin="anonymous" href="/assets/KaTeX_Main-BoldItalic-99cd42a3.woff2"><link rel="preload" as="font" crossorigin="anonymous" href="/assets/KaTeX_Main-Italic-97479ca6.woff2"><link rel="preload" as="font" crossorigin="anonymous" href="/assets/KaTeX_Main-Regular-c2342cd8.woff2"><link rel="preload" as="font" crossorigin="anonymous" href="/assets/KaTeX_Math-BoldItalic-dc47344d.woff2"><link rel="preload" as="font" crossorigin="anonymous" href="/assets/KaTeX_Math-Italic-7af58c5e.woff2"><link rel="preload" as="font" crossorigin="anonymous" href="/assets/KaTeX_SansSerif-Bold-e99ae511.woff2"><link rel="preload" as="font" crossorigin="anonymous" href="/assets/KaTeX_SansSerif-Italic-00b26ac8.woff2"><link rel="preload" as="font" crossorigin="anonymous" href="/assets/KaTeX_SansSerif-Regular-68e8c73e.woff2"><link rel="preload" as="font" crossorigin="anonymous" href="/assets/KaTeX_Script-Regular-036d4e95.woff2"><link rel="preload" as="font" crossorigin="anonymous" href="/assets/KaTeX_Size1-Regular-6b47c401.woff2"><link rel="preload" as="font" crossorigin="anonymous" href="/assets/KaTeX_Size2-Regular-d04c5421.woff2"><link rel="preload" as="font" crossorigin="anonymous" href="data:font/woff2;base64,d09GMgABAAAAAA4oAA4AAAAAHbQAAA3TAAEAAAAAAAAAAAAAAAAAAAAAAAAAAAAABmAAgRQIDgmcDBEICo1oijYBNgIkA14LMgAEIAWJAAeBHAyBHBvbGiMRdnO0IkRRkiYDgr9KsJ1NUAf2kILNxgUmgqIgq1P89vcbIcmsQbRps3vCcXdYOKSWEPEKgZgQkprQQsxIXUgq0DqpGKmIvrgkeVGtEQD9DzAO29fM9jYhxZEsL2FeURH2JN4MIcTdO049NCVdxQ/w9NrSYFEBKTDKpLKfNkCGDc1RwjZLQcm3vqJ2UW9Xfa3tgAHz6ivp6vgC2yD4/6352ndnN0X0TL7seypkjZlMsjmZnf0Mm5Q+JykRWQBKCVCVPbARPXWyQtb5VgLB6Biq7/Uixcj2WGqdI8tGSgkuRG+t910GKP2D7AQH0DB9FMDW/obJZ8giFI3Wg8Cvevz0M+5m0rTh7XDBlvo9Y4vm13EXmfttwI4mBo1EG15fxJhUiCLbiiyCf/ZA6MFAhg3pGIZGdGIVjtPn6UcMk9A/UUr9PhoNsCENw1APAq0gpH73e+M+0ueyHbabc3vkbcdtzcf/fiy+NxQEjf9ud/ELBHAXJ0nk4z+MXH2Ev/kWyV4k7SkvpPc9Qr38F6RPWnM9cN6DJ0AdD1BhtgABtmoRoFCvPsBAumNm6soZG2Gk5GyVTo2sJncSyp0jQTYoR6WDvTwaaEcHsxHfvuWhHA3a6bN7twRKtcGok6NsCi7jYRrM2jExsUFMxMQYuJbMhuWNOumEJy9hi29Dmg5zMp/A5+hhPG19j1vBrq8JTLr8ki5VLPmG/PynJHVul440bxg5xuymHUFPBshC+nA9I1FmwbRBTNHAcik3Oae0cxKoI3MOriM42UrPe51nsaGxJ+WfXubAsP84aabUlQSJ1IiE0iPETLUU4CATgfXSCSpuRFRmCGbO+wSpAnzaeaCYW1VNEysRtuXCEL1kUFUbbtMv3Tilt/1c11jt3Q5bbMa84cpWipp8Elw3MZhOHsOlwwVUQM3lAR35JiFQbaYCRnMF2lxAWoOg2gyoIV4PouX8HytNIfLhqpJtXB4vjiViUI8IJ7bkC4ikkQvKksnOTKICwnqWSZ9YS5f0WCxmpgjbIq7EJcM4aI2nmhLNY2JIUgOjXZFWBHb+x5oh6cwb0Tv1ackHdKi0I9OO2wE9aogIOn540CCCziyhN+IaejtgAONKznHlHyutPrHGwCx9S6B8kfS4Mfi4Eyv7OU730bT1SCBjt834cXsf43zVjPUqqJjgrjeGnBxSG4aYAKFuVbeCfkDIjAqMb6yLNIbCuvXhMH2/+k2vkNpkORhR59N1CkzoOENvneIosjYmuTxlhUzaGEJQ/iWqx4dmwpmKjrwTiTGTCVozNAYqk/zXOndWxuWSmJkQpJw3pK5KX6QrLt5LATMqpmPAQhkhK6PUjzHUn7E0gHE0kPE0iKkolgkUx9SZmVAdDgpffdyJKg3k7VmzYGCwVXGz/tXmkOIp+vcWs+EMuhhvN0h9uhfzWJziBQmCREGSIFmQIkgVpAnSBRmC//6hkLZwaVhwxlrJSOdqlFtOYxlau9F2QN5Y98xmIAsiM1HVp2VFX+DHHGg6Ecjh3vmqtidX3qHI2qycTk/iwxSt5UzTmEP92ZBnEWTk4Mx8Mpl78ZDokxg/KWb+Q0QkvdKVmq3TMW+RXEgrsziSAfNXFMhDc60N5N9jQzjfO0kBKpUZl0ZmwJ41j/B9Hz6wmRaJB84niNmQrzp9eSlQCDDzazGDdVi3P36VZQ+Jy4f9UBNp+3zTjqI4abaFAm+GShVaXlsGdF3FYzZcDI6cori4kMxUECl9IjJZpzkvitAoxKue+90pDMvcKRxLl53TmOKCmV/xRolNKSqqUxc6LStOETmFOiLZZptlZepcKiAzteG8PEdpnQpbOMNcMsR4RR2Bs0cKFEvSmIjAFcnarqwUL4lDhHmnVkwu1IwshbiCcgvOheZuYyOteufZZwlcTlLgnZ3o/WcYdzZHW/WGaqaVfmTZ1aWCceJjkbZqsfbkOtcFlUZM/jy+hXHDbaUobWqqXaeWobbLO99yG5N3U4wxco0rQGGcOLASFMXeJoham8M+/x6O2WywK2l4HGbq1CoUyC/IZikQhdq3SiuNrvAEj0AVu9x2x3lp/xWzahaxidezFVtdcb5uEnzyl0ZmYiuKI0exvCd4Xc9CV1KB0db00z92wDPde0kukbvZIWN6jUWFTmPIC/Y4UPCm8UfDTFZpZNon1qLFTkBhxzB+FjQRA2Q/YRJT8pQigslMaUpFyAG8TMlXigiqmAZX4xgijKjRlGpLE0GdplRfCaJo0JQaSxNBk6ZmMzcya0FmrcisDdn0Q3HI2sWSppYigmlM1XT/kLQZSNpMJG0WkjYbSZuDpM1F0uYhFc1HxU4m1QJjDK6iL0S5uSj5rgXc3RejEigtcRBtqYPQsiTskmO5vosV+q4VGIKbOkDg0jtRrq+Em1YloaTFar3EGr1EUC8R0kus1Uus00usL97ABr2BjXoDm/QGNhuWtMVBKOwg/i78lT7hBsAvDmwHc/ao3vmUbBmhjeYySZNWvGkfZAgISDSaDo1SVpzGDsAEkF8B+gEapViUoZgUWXcRIGFZNm6gWbAKk0bp0k1MHG9fLYtV4iS2SmLEQFARzRcnf9PUS0LVn05/J9MiRRBU3v2IrvW974v4N00L7ZMk0wXP1409CHo/an8zTRHD3eSJ6m8D4YMkZNl3M79sqeuAsr/m3f+8/yl7A50aiAEJgeBeMWzu7ui9UfUBCe2TIqZIoOd/3/udRBOQidQZUERzb2/VwZN1H/Sju82ew2H2Wfr6qvfVf3hqwDvAIpkQVFy4B9Pe9e4/XvPeceu7h3dvO56iJPf0+A6cqA2ip18ER+iFgggiuOkvj24bby0N9j2UHIkgqIt+sVgfodC4YghLSMjSZbH0VR/6dMDrYJeKHilKTemt6v6kvzvn3/RrdWtr0GoN/xL+Sex/cPYLUpepx9cz/D46UPU5KXgAQa+NDps1v6J3xP1i2HtaDB0M9aX2deA7SYff//+gUCovMmIK/qfsFcOk+4Y5ZN97XlG6zebqtMbKgeRFi51vnxTQYBUik2rS/Cn6PC8ADR8FGxsRPB82dzfND90gIcshOcYUkfjherBz53odpm6TP8txlwOZ71xmfHHOvq053qFF/MRlS3jP0ELudrf2OeN8DHvp6ZceLe8qKYvWz/7yp0u4dKPfli3CYq0O13Ih71mylJ80tOi10On8wi+F4+LWgDPeJ30msSQt9/vkmHq9/Lvo2b461mP801v3W4xTcs6CbvF9UDdrSt+A8OUbpSh55qAUFXWznBBfdeJ8a4d7ugT5tvxUza3h9m4H7ptTqiG4z0g5dc0X29OcGlhpGFMpQo9ytTS+NViZpNdvU4kWx+LKxNY10kQ1yqGXrhe4/1nvP7E+nd5A92TtaRplbHSqoIdOqtRWti+fkB5/n1+/VvCmz12pG1kpQWsfi1ftlBobm0bpngs16CHkbIwdLnParxtTV3QYRlfJ0KFskH7pdN/YDn+yRuSd7sNH3aO0DYPggk6uWuXrfOc+fa3VTxFVvKaNxHsiHmsXyCLIE5yuOeN3/Jdf8HBL/5M6shjyhxHx9BjB1O0+4NLOnjLLSxwO7ukN4jMbOIcD879KLSi6Pk61Oqm2377n8079PXEEQ7cy7OKEC9nbpet118fxweTafpt69x/Bt8UqGzNQt7aelpc44dn5cqhwf71+qKp/Zf/+a0zcizOUWpl/iBcSXip0pplkatCchoH5c5aUM8I7/dWxAej8WicPL1URFZ9BDJelUwEwTkGqUhgSlydVes95YdXvhh9Gfz/aeFWvgVb4tuLbcv4+wLdutVZv/cUonwBD/6eDlE0aSiKK/uoH3+J1wDE/jMVqY2ysGufN84oIXB0sPzy8ollX/LegY74DgJXJR57sn+VGza0x3DnuIgABFM15LmajjjsNlYj+JEZGbuRYcAMOWxFkPN2w6Wd46xo4gVWQR/X4lyI/R6K/YK0110GzudPRW7Y+UOBGTfNNzHeYT0fiH0taunBpq9HEW8OKSaBGj21L0MqenEmNRWBAWDWAk4CpNoEZJ2tTaPFgbQYj8HxtFilErs3BTRwT8uO1NXQaWfIotchmPkAF5mMBAliEmZiOGVgCG9LgRzpscMAOOwowlT3JhusdazXGSC/hxR3UlmWVwWHpOIKheqONvjyhSiTHIkVUco5bnji8m//zL7PKaT1Vl5I6UE609f+gkr6MZKVyKc7zJRmCahLsdlyA5fdQkRSan9LgnnLEyGSkaKJCJog0wAgvepWBt80+1yKln1bMVtCljfNWDueKLsWwaEbBSfSPTEmVRsUcYYMnEjcjeyCZzBXK9E9BYBXLKjOSpUDR+nEV3TFSUdQaz+ot98QxgXwx0GQ+EEUAKB2qZPkQQ0GqFD8UPFMqyaCHM24BZmSGic9EYMagKizOw9Hz50DMrDLrqqLkTAhplMictiCAx5S3BIUQdeJeLnBy2CNtMfz6cV4u8XKoFZQesbf9YZiIERiHjaNodDW6LgcirX/mPnJIkBGDUpTBhSa0EIr38D5hCIszhCM8URGBqImoWjpvpt1ebu/v3Gl3qJfMnNM+9V+kiRFyROTPHQWOcs1dNW94/ukKMPZBvDi55i5CttdeJz84DLngLqjcdwEZ87bFFR8CIG35OAkDVN6VRDZ7aq67NteYqZ2lpT8oYB2CytoBd6VuAx4WgiAsnuj3WohG+LugzXiQRDeM3XYXlULv4dp5VFYC"><link rel="preload" as="font" crossorigin="anonymous" href="/assets/KaTeX_Size4-Regular-a4af7d41.woff2"><link rel="preload" as="font" crossorigin="anonymous" href="/assets/KaTeX_Typewriter-Regular-71d517d6.woff2"><link rel="preload" as="font" crossorigin="anonymous" href="data:font/woff2;base64,d09GMgABAAAAAAkcAAsAAAAAEogAAAjNAAEAAAAAAAAAAAAAAAAAAAAAAAAAAAAABmAAgSQRCAqcLJZKCzoAATYCJANwBCAFgkoHIBupDgDm53Gzej8JpU0wqygVVyoWwphIsuuw60jpmBY6ppTa7mk7jtx57UQ0V2ulvfmteSIQji061T2HvfDEECASKizU5VUQXFjFRtgYTVg+woiYDVezOThR4tAvr/YYgOO/RZ+BAABzYtMA8Kl8Neg3UIDCoCkOyWBuLcCvSHycH78QvhFxmUCK03A0RwGSvXBAHgR8UB8DMvocJYAgbiZiJnqmYGbXjG3mz7P8nHhe8Uvxr0j+fzwPABAjWT1E83IJHh/x87G/jv1l7JtYR+y+WF2MKAai/qfDtfIRt7hBikI8D1IpipXqWqYSDgDBfwE7qDLw5EEALqFRDMKAsApNwchXAJgFL/WETMbKcDVSifR6QkjwkDaRTEugqlBtKVcL6Smi1dHlIqUmuii6Pic1JTIlFTX3uRenMNpiCiKOCZBm2ges0b/ScigDVgcb2MEHfloel7e1z208KrZUeQFjK0dIkbl6FOFczRhFE6zaRklPlz52tOXcKtmpdqisgHnbxRatg66vsZNHaWMPQ/eZmH6jaavlNASsipbKwVZSYrRm1mywI0670UEdhLy+yuscolSZJHKwg5IyNzRJQbKRZiicwnYiChjO1vSbKCBpkAgCjGIb6KCvA5GL0VHeUDwAQEHkSC2ToBJhKN9KAneim2ekLf1vENf3mjT3vAS295XY2MMgzRpSqTVWpt4ang+ksXynRUQPlkFOu+b6Yw0jBp8krbXbYbjc5mn6KpsNWKtqtcNz0D8xTTQKzthbZYAxLev3NkFgyYWsngBjGo8jg6a9Y3rKR9Pfqun10RvJi9X9foZGvrltMkJgWR7dhI7SSITEaBWIQQTMUSOJkTi5nlqpZUfNKcYD1Do/ZdkbR8UeVpKLSbMVgKLX0flzQYqCrLpll+/vus2IM9+lbdTgWWRLQJqvaq7eHKulgL2ssp7LrpxR2DBI/ja1zXvi7cS1E0Gr0uhy7PUGwPmdkkdjEYOjpGnQRXowC/GBq51eymLRXrsXsTzXX37VlXzeVxoI6m8Gy67oBnzsB6DoQYY7GHM2fbT4oS9zON45lPnwbmww2BL0G89EnfaVPi5eJ3NZFtjc277Wb9M1A+UWG2WZyrj6PMKmLHRoH04iZLuivlsHTmm9/qYJ1r2Z90DtuKYduK6SdNZ3dRRxHAoE+l4HGM6MyIe+0se+zHEfsP4s2sqqnVdSTE/8lCVYMRVsuBVEJOvT3fa1Xr4X2iDZflVFmxyDmpu1r8b9IsVzXUB9w1/l9ccf7WCszaI1ATtUx7oRztk1dtbBcciudJAi83Vv2yaTg9uON6toxLlIM2GVxClo2eVBt5gcOHRwHLIpptC92TeKRi3MjtBkTAOaoU+6P1q364+kdgt/+xh2fRvlOf2p5xR4ut7P4s0sPwY63OguajQWuYqMjUWaA9100ya6yHdHr/BMyxN9QmGa2zjPnbZr17KTy9weKwqXYtqjcMunRkgE9kP+Refvml14hAZw8WFQGmZnnaEi0eLUQTCc+tLSphVyaUH6lAJoXjF1MDiaFSOexNCRKYW8TOkhKzDEDjPDvHHI3c5hXbQLhujhUuPmBYd+N/EaktFsDqoDo4/G0yx70s3SSuXJDIvjMNsIQ7TDqb+/sv8NHGl6BvDAMOnsCpv9PQcP9tS6N294zEnwtNdt2tfTXSz7JGwAqALmbKpr90BaeqA9tlvduWP4/xa0thZcJMNDC6XqrFuy2xGF7YaiQkN7UfhEbMaNkOxQHezh7YVFBsP9TcoybgmzhaExmpxb/78Naf89LmVWthVvvSWh3rZUWtlMFStWENDf5uqEd2LiP/M/fvWEWUntjnTynpI2ainnLdjPUIvL2uGFJvoUQy0taZvPePLqxy0lK6mUo8yp6B+WtdyyTHivdrgLZrhbvAOlWMbQEJtJZ7JuXgRLC+hwe/kb90WvW4U4/PGGRUmLk995J1loWLRhQwVCKkve4JOS8YJASY+P8KQNe/vahGNU8TJRe/eCaaG7ozsrt6Ixu623v/ck0rvlG2EYBoAh6abIxoZ9UeHoNQAiMPKv/8pIi+47EAMHcfLh7dyX8q0Po+Iap94fFob+4fr/DXr96x+j1x2dhZ0dBfRqardjBIZ+M+S6Lo6ojE+4HKF7Kz7zG+eCOkwQ98UfOirDqrckKPVz3sR8srT/gsev3H0p3Rq7wkD1JLE/XZ+2Ze5pV5eqPiqqmBkc1PQYDBvlk5MdqQff21UyInvyhyjMsHXV33tD3zaQ7Us/NKfX44qLQ/8ffOtzXIjnymRNXampDWkGDR5yOyThG2/9UXC6liWEEz0hX+uR1Xg780i4eNOSig3Fk2pSkPpBqrrmx3/+TbB2ya9ePfrGJx98H8rvjKsRQoSh/G0s8cO6bhwwUI8vUz1c21B04cscrjVV1q8zzCVJkmv/T8y21/bLszJpxeqptculJZpleUyKrPX/X3QZBL+rl+hTWuR/2At7LhYVX9BBsULaqi9LWh+6xMDLW6V65dy2gsMbszemQ96XMDvrSfRM60ceo5R/oGDXB0KrxJsTACBhbV48S4Cd5IeyAVdU5Yg+2nPGKS+XAwmOljrwpIdMmdJPexI9ndnIXUIVgety83YzRdXD6E6YvF0gVGJRMhpOyQW6xGM0Zbq7zw8AoAcWAYa7cSOsARF+Fm8DBAAYgDUq07ZSWvm3UIoAAIAfde39SB7Hz+K/xR9vAkMBg0YE8PKEChkH47+9MDggitAdAEObxnBmZAFu5C4eyMxqN/2c3ZUK2qJ+tDUvrTR/BGHDbqZplsDNZVVQjIaim4XA6TE4YLCfEdweIwAKaArx8aN1JETYMNMDEWGYZdRjMJDAB4T7+EEiwAdiBKCBlRQCfnwjEgohbttG2AYb3yS+7tWIDW1rd/6mMedAM+yEHbAvWge0XgNevwdW20Cmdfb6NXBYqm+DtZHUyUW88R/abjA/OxeYpIa9sNmNGMqHbMgd2CAZPzVuOfQFg5H275pWwx73mQMODQAAAA=="></head><body><div id="app" data-server-rendered="true"><!--[--><!--[--><canvas class="fireworks"></canvas><!--[--><div class="yun-bg"></div><!--]--><!--[--><button class="yun-search-btn popup-trigger yun-icon-btn" title="搜索"><div i-ri-search-line></div></button><!----><!--]--><div class="yun-page-loading" absolute left-0 right-0 bottom-0 top-0 flex justify="center" items-center z-10 bg="$va-c-bg" data-v-65225486><div class="spinner" data-v-65225486></div></div><!--]--><!--[--><!--[--><!-- eslint-disable-next-line vue/component-name-in-template-casing --><meting-js id="308168565" server="netease" type="playlist" fixed="true"></meting-js><!--]--><!--]--><!----><!--[--><!--[--><!----><button type="button" class="vt-hamburger menu-btn sidebar-toggle yun-icon-btn leading-4 fixed left-0.8rem top-0.6rem md:hidden" aria-label="mobile navigation" aria-expanded="false" inline-flex cursor="pointer" z="$yun-z-menu-btn"><span class="vt-hamburger-container"><span class="vt-hamburger-top"></span><span class="vt-hamburger-middle"></span><span class="vt-hamburger-bottom"></span></span></button><aside class="md:translate-x-0 va-card transition sidebar fixed inset-y-0 left-0 overflow-y-auto" text="center" bg="$yun-sidebar-bg-color contain no-repeat" z="$yun-z-sidebar"><!----><div class><!--[--><div class="sidebar-panel" p="2"><div class="site-info" m="t-6"><a href="/about" class="site-author-avatar"><img class="rounded-full" src="/images/avatar.jpg" alt="avatar"><span class="site-author-status" title="The moonlight is beautiful.">💛</span></a><div class="site-author-name leading-6" m="t-0 b-4"><a href="/about" class>imklaus</a></div><a href="/about/site" class="site-name">imklaus's Blog</a><h4 class="site-subtitle block" text="xs">The Winner Takes It All.</h4><!----></div><nav class="site-nav" text-xl mt-6><a href="/" class="site-link-item yun-icon-btn" title="首页"><div i-ri-home-4-line></div></a><a href="/archives/" class="site-link-item" title="归档"><div class="icon" i-ri-archive-line></div><span class="count">25</span></a><a href="/categories/" class="site-link-item" title="分类"><div class="icon" i-ri-folder-2-line></div><span class="count">2</span></a><a href="/tags/" class="site-link-item" title="标签"><div class="icon" i-ri-price-tag-3-line></div><span class="count">72</span></a><a href="/slides/" class="site-link-item yun-icon-btn" title="menu.slides"><!--[--><div class="i-ri-keynote-line"></div><!--]--></a></nav><hr m="t-4 b-2" op="20"><div class="links-of-author"><!--[--><a class="links-of-author-item yun-icon-btn" rel="noopener" href="/atom.xml" title="RSS" target="_blank" style="color:orange"><div class="i-ri-rss-line icon"></div></a><a class="links-of-author-item yun-icon-btn" rel="noopener" href="https://github.com/imLKlauS" title="GitHub" target="_blank" style="color:#6e5494"><div class="i-ri-github-line icon"></div></a><a class="links-of-author-item yun-icon-btn" rel="noopener" href="https://music.163.com/#/user/home?id=102158629" title="冷门歌手" target="_blank" style="color:#c20c0c"><div class="i-ri-netease-cloud-music-line icon"></div></a><a class="links-of-author-item yun-icon-btn" rel="noopener" href="https://space.bilibili.com/19430480" title="哔哩哔哩" target="_blank" style="color:#ff8eb3"><div class="i-ri-bilibili-line icon"></div></a><a class="links-of-author-item yun-icon-btn" rel="noopener" href="https://t.me/elpsycn" title="Telegram Channel" target="_blank" style="color:#08c"><div class="i-ri-telegram-line icon"></div></a><a class="links-of-author-item yun-icon-btn" rel="noopener" href="q1064779584@163.com" title="E-Mail" target="_blank" style="color:#8e71c1"><div class="i-ri-mail-line icon"></div></a><a class="links-of-author-item yun-icon-btn" rel="noopener" href="https://www.travellings.cn/go.html" title="Travelling" target="_blank" style="color:var(--va-c-text)"><div class="i-ri-train-line icon"></div></a><!--]--></div><hr m="y-2" op="20"><div class="links flex-center"><!--[--><a href="/comment/" class="link-item yun-icon-btn" inline-flex title="留言板" style="color:#737de5"><!--[--><div class="i-ri-clipboard-line icon w-8 h-8"></div><!--]--></a><a href="/albums/" class="link-item yun-icon-btn" inline-flex title="相册" style="color:#43abee"><!--[--><div class="i-ri-gallery-line icon w-8 h-8"></div><!--]--></a><a href="/links/" class="link-item yun-icon-btn" inline-flex title="友链" style="color:#4bbea4"><!--[--><div class="i-ri-open-arm-line icon w-8 h-8"></div><!--]--></a><a href="/music/" class="link-item yun-icon-btn" inline-flex title="听歌" style="color:#1e90ff"><!--[--><div class="i-ri-netease-cloud-music-line icon w-8 h-8"></div><!--]--></a><!--]--></div><br></div><div><button class="yun-icon-btn" title="切换深色模式" style="color:#f1cb64"><div i="ri-sun-line dark:ri-moon-line"></div></button><button class="yun-icon-btn" title="切换语言" style="color:var(--va-c-text)"><div i-ri-translate class="transition transform"></div></button></div><!--]--></div></aside><!--]--><main class="yun-main md:pl-$va-sidebar-width lt-md:ml-0" flex="~"><div w="full" flex="~"><!--[--><div class="content" flex="~ col grow" w="full" p="l-4 lt-md:0"><div class="yun-card flex-center rounded relative" flex="col" min-h="100px" bg="$va-c-bg-light" m="0" style><img width="640" height="360" class="object-cover select-none" h="64 md:sm" w="full" src="https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/wallhaven-3zqqdy_1920x1080.png"><!----><!--[--><!--[--><header class="post-header mb-2" m="t-16 sm:t-6" cover="https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/wallhaven-3zqqdy_1920x1080.png"><h1 class="post-title flex-center" p="2" text="2xl center" font="serif black" style=""><!----><span inline-flex class="leading-none">并发编程整理版-无锁</span></h1></header><!--]--><!--[--><!--[--><!--[--><!--[--><!----><!----><div class="post-top-icon" color="$va-c-warning"><div i-ri-pushpin-line></div></div><div class="post-meta" flex="~ col" justify="center" items="center" text="sm" py="1"><div class="post-time flex items-center"><span class="inline-flex-center" title="发表于2023-08-24T18:49:36.000Z"><div class="inline-block" i-ri-calendar-line></div><time m="l-1">2023-08-24</time></span><span class="inline-flex-center" title="更新于2023-11-25T16:53:42.456Z"><span m="x-2">-</span><div i-ri-calendar-2-line></div><time m="l-1">2023-11-25</time></span></div><div class="post-counter flex items-center" mt="2"><span class="inline-flex-center" title="本文字数"><div class="inline-block" i-ri-file-word-line></div><time m="l-1">13.8k</time></span><span class="inline-flex-center" title="阅读时长"><span m="x-2">-</span><div i-ri-timer-line></div><time m="l-1">71m</time></span></div></div><!--[--><!--]--><!--]--><div flex="~" text="sm" my="1" h="5"><div inline-flex justify="center" items="center" mx="2" title="阅读次数"><div inline-flex i-ri-eye-line></div><span ml-1 inline-flex class="waline-pageview-count" data-path="/posts/concurrent_programming_compilation_version-lock_free"></span></div><div inline-flex justify="center" items="center" mx="2" title="评论数"><div inline-flex i-ri-chat-4-line></div><span ml-1 inline-flex class="waline-comment-count" data-path="/posts/concurrent_programming_compilation_version-lock_free"></span></div></div><div class="inline-flex" text="sm" py="1"><a href="/categories?category=Java" class="transition post-category inline-flex-center text-xs border-$va-c-divider hover:text-blue-500 hover:border-blue-500" px-2 h="7" border rounded-full bg="hover:blue-500 hover:opacity-10"><div m="x-1" inline-flex i-ri-folder-2-line></div><span>Java</span></a><span mx="2"></span><div class="post-tags inline-flex" items="center" gap="1" flex="wrap 1" justify="end"><!--[--><a href="/tags/?tag=CAS" class="transition post-tag inline-flex-center text-xs border-$va-c-divider hover:text-blue-500 hover:border-blue-500" px-2 h="7" rounded-full border bg="hover:blue-500 hover:opacity-10"><!-- <div m="r-1" i-ri-price-tag-3-line /> --><span>CAS</span></a><a href="/tags/?tag=Atomic" class="transition post-tag inline-flex-center text-xs border-$va-c-divider hover:text-blue-500 hover:border-blue-500" px-2 h="7" rounded-full border bg="hover:blue-500 hover:opacity-10"><!-- <div m="r-1" i-ri-price-tag-3-line /> --><span>Atomic</span></a><a href="/tags/?tag=volatile" class="transition post-tag inline-flex-center text-xs border-$va-c-divider hover:text-blue-500 hover:border-blue-500" px-2 h="7" rounded-full border bg="hover:blue-500 hover:opacity-10"><!-- <div m="r-1" i-ri-price-tag-3-line /> --><span>volatile</span></a><a href="/tags/?tag=LongAdder" class="transition post-tag inline-flex-center text-xs border-$va-c-divider hover:text-blue-500 hover:border-blue-500" px-2 h="7" rounded-full border bg="hover:blue-500 hover:opacity-10"><!-- <div m="r-1" i-ri-price-tag-3-line /> --><span>LongAdder</span></a><a href="/tags/?tag=Unsafe" class="transition post-tag inline-flex-center text-xs border-$va-c-divider hover:text-blue-500 hover:border-blue-500" px-2 h="7" rounded-full border bg="hover:blue-500 hover:opacity-10"><!-- <div m="r-1" i-ri-price-tag-3-line /> --><span>Unsafe</span></a><a href="/tags/?tag=final" class="transition post-tag inline-flex-center text-xs border-$va-c-divider hover:text-blue-500 hover:border-blue-500" px-2 h="7" rounded-full border bg="hover:blue-500 hover:opacity-10"><!-- <div m="r-1" i-ri-price-tag-3-line /> --><span>final</span></a><a href="/tags/?tag=ThreadLocal" class="transition post-tag inline-flex-center text-xs border-$va-c-divider hover:text-blue-500 hover:border-blue-500" px-2 h="7" rounded-full border bg="hover:blue-500 hover:opacity-10"><!-- <div m="r-1" i-ri-price-tag-3-line /> --><span>ThreadLocal</span></a><!--]--></div></div><!--]--><!--]--><!--]--><div p="x-4 b-8" class="sm:px-6 lg:px-12 xl:px-16" w="full"><!--[--><template><article class="markdown-body"><!--[--><!----><!----><!--[--><h1 id="并发编程整理版" tabindex="-1">并发编程整理版 <a aria-current="page" href="/posts/concurrent_programming_compilation_version-lock_free#并发编程整理版" class="router-link-active router-link-exact-active header-anchor" aria-label="Permalink to &quot;并发编程整理版&quot;"><!--[-->​<!--]--></a></h1><p>参考视频：<a target="_blank" rel="noreferrer" href="https://www.bilibili.com/video/BV16J411h7Rd"><!--[-->https://www.bilibili.com/video/BV16J411h7Rd<!--]--><!----></a></p><p>笔记的整体结构依据视频编写，并随着学习的深入补充了很多知识</p><h2 id="无锁" tabindex="-1">无锁 <a aria-current="page" href="/posts/concurrent_programming_compilation_version-lock_free#无锁" class="router-link-active router-link-exact-active header-anchor" aria-label="Permalink to &quot;无锁&quot;"><!--[-->​<!--]--></a></h2><h3 id="cas" tabindex="-1">CAS <a aria-current="page" href="/posts/concurrent_programming_compilation_version-lock_free#cas" class="router-link-active router-link-exact-active header-anchor" aria-label="Permalink to &quot;CAS&quot;"><!--[-->​<!--]--></a></h3><h4 id="例子" tabindex="-1">例子 <a aria-current="page" href="/posts/concurrent_programming_compilation_version-lock_free#例子" class="router-link-active router-link-exact-active header-anchor" aria-label="Permalink to &quot;例子&quot;"><!--[-->​<!--]--></a></h4><div style="max-height:300px" class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#f97583">interface</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Account</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">	Integer </span><span style="color:#b392f0">getBalance</span><span style="color:#e1e4e8">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">	</span><span style="color:#f97583">void</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">withdraw</span><span style="color:#e1e4e8">(Integer </span><span style="color:#ffab70">amount</span><span style="color:#e1e4e8">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6a737d">	/**</span></span>
<span class="line"><span style="color:#6a737d">	 * 方法内会启动 1000 个线程，每个线程做 -10 元 的操作     </span></span>
<span class="line"><span style="color:#6a737d">	 * 如果初始余额为 10000 那么正确的结果应当是 0</span></span>
<span class="line"><span style="color:#6a737d">	 */</span></span>
<span class="line"><span style="color:#e1e4e8">	</span><span style="color:#f97583">static</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">void</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">demo</span><span style="color:#e1e4e8">(Account </span><span style="color:#ffab70">account</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">		List&lt;</span><span style="color:#f97583">Thread</span><span style="color:#e1e4e8">&gt; ts </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> ArrayList&lt;&gt;();</span></span>
<span class="line"><span style="color:#e1e4e8">		</span><span style="color:#f97583">long</span><span style="color:#e1e4e8"> start </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> System.</span><span style="color:#b392f0">nanoTime</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">		</span><span style="color:#f97583">for</span><span style="color:#e1e4e8"> (</span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> i </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8">; i </span><span style="color:#f97583">&lt;</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">1000</span><span style="color:#e1e4e8">; i</span><span style="color:#f97583">++</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">			ts.</span><span style="color:#b392f0">add</span><span style="color:#e1e4e8">(</span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Thread</span><span style="color:#e1e4e8">(() </span><span style="color:#f97583">-&gt;</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">				account.</span><span style="color:#b392f0">withdraw</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">10</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">			}));</span></span>
<span class="line"><span style="color:#e1e4e8">		}</span></span>
<span class="line"><span style="color:#e1e4e8">		ts.</span><span style="color:#b392f0">forEach</span><span style="color:#e1e4e8">(Thread</span><span style="color:#f97583">::</span><span style="color:#e1e4e8">start);</span></span>
<span class="line"><span style="color:#e1e4e8">		ts.</span><span style="color:#b392f0">forEach</span><span style="color:#e1e4e8">(t </span><span style="color:#f97583">-&gt;</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">			</span><span style="color:#f97583">try</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">				t.</span><span style="color:#b392f0">join</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">			} </span><span style="color:#f97583">catch</span><span style="color:#e1e4e8"> (InterruptedException </span><span style="color:#ffab70">e</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">				e.</span><span style="color:#b392f0">printStackTrace</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">			}</span></span>
<span class="line"><span style="color:#e1e4e8">		});</span></span>
<span class="line"><span style="color:#e1e4e8">		</span><span style="color:#f97583">long</span><span style="color:#e1e4e8"> end </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> System.</span><span style="color:#b392f0">nanoTime</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">		System.out.</span><span style="color:#b392f0">println</span><span style="color:#e1e4e8">(account.</span><span style="color:#b392f0">getBalance</span><span style="color:#e1e4e8">() </span><span style="color:#f97583">+</span><span style="color:#e1e4e8"> </span><span style="color:#9ecbff">" cost: "</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">+</span><span style="color:#e1e4e8"> (end </span><span style="color:#f97583">-</span><span style="color:#e1e4e8"> start) </span><span style="color:#f97583">/</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">1000_000</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">+</span><span style="color:#e1e4e8"> </span><span style="color:#9ecbff">" ms"</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">	}</span></span>
<span class="line"><span style="color:#e1e4e8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6a737d">//线程不安全的做法</span></span>
<span class="line"><span style="color:#f97583">class</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">AccountUnsafe</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">implements</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Account</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">	</span><span style="color:#f97583">private</span><span style="color:#e1e4e8"> Integer balance;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">	</span><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">AccountUnsafe</span><span style="color:#e1e4e8">(Integer </span><span style="color:#ffab70">balance</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">		</span><span style="color:#79b8ff">this</span><span style="color:#e1e4e8">.balance </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> balance;</span></span>
<span class="line"><span style="color:#e1e4e8">	}</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">	@</span><span style="color:#f97583">Override</span></span>
<span class="line"><span style="color:#e1e4e8">	</span><span style="color:#f97583">public</span><span style="color:#e1e4e8"> Integer </span><span style="color:#b392f0">getBalance</span><span style="color:#e1e4e8">() {</span></span>
<span class="line"><span style="color:#e1e4e8">		</span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">this</span><span style="color:#e1e4e8">.balance;</span></span>
<span class="line"><span style="color:#e1e4e8">	}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">	@</span><span style="color:#f97583">Override</span></span>
<span class="line"><span style="color:#e1e4e8">	</span><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">synchronized</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">void</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">withdraw</span><span style="color:#e1e4e8">(Integer </span><span style="color:#ffab70">amount</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">		balance </span><span style="color:#f97583">-=</span><span style="color:#e1e4e8"> amount;</span></span>
<span class="line"><span style="color:#e1e4e8">	}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">	</span><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">static</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">void</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">main</span><span style="color:#e1e4e8">(</span><span style="color:#f97583">String</span><span style="color:#e1e4e8">[] </span><span style="color:#ffab70">args</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">		Account.</span><span style="color:#b392f0">demo</span><span style="color:#e1e4e8">(</span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">AccountUnsafe</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">10000</span><span style="color:#e1e4e8">));</span></span>
<span class="line"><span style="color:#e1e4e8">		Account.</span><span style="color:#b392f0">demo</span><span style="color:#e1e4e8">(</span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">AccountCas</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">10000</span><span style="color:#e1e4e8">));</span></span>
<span class="line"><span style="color:#e1e4e8">	}</span></span>
<span class="line"><span style="color:#e1e4e8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6a737d">//线程安全的做法</span></span>
<span class="line"><span style="color:#f97583">class</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">AccountCas</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">implements</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Account</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">	</span><span style="color:#6a737d">//使用原子整数</span></span>
<span class="line"><span style="color:#e1e4e8">	</span><span style="color:#f97583">private</span><span style="color:#e1e4e8"> AtomicInteger balance;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">	</span><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">AccountCas</span><span style="color:#e1e4e8">(</span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> </span><span style="color:#ffab70">balance</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">		</span><span style="color:#79b8ff">this</span><span style="color:#e1e4e8">.balance </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">AtomicInteger</span><span style="color:#e1e4e8">(balance);</span></span>
<span class="line"><span style="color:#e1e4e8">	}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">	@</span><span style="color:#f97583">Override</span></span>
<span class="line"><span style="color:#e1e4e8">	</span><span style="color:#f97583">public</span><span style="color:#e1e4e8"> Integer </span><span style="color:#b392f0">getBalance</span><span style="color:#e1e4e8">() {</span></span>
<span class="line"><span style="color:#e1e4e8">		</span><span style="color:#6a737d">//得到原子整数的值</span></span>
<span class="line"><span style="color:#e1e4e8">		</span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> balance.</span><span style="color:#b392f0">get</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">	}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">	@</span><span style="color:#f97583">Override</span></span>
<span class="line"><span style="color:#e1e4e8">	</span><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">void</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">withdraw</span><span style="color:#e1e4e8">(Integer </span><span style="color:#ffab70">amount</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">			</span><span style="color:#6a737d">// 需要不断尝试，直到成功为止</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">while</span><span style="color:#e1e4e8"> (</span><span style="color:#79b8ff">true</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#6a737d">// 比如拿到了旧值 1000</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> prev </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> balance.</span><span style="color:#b392f0">get</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#6a737d">// 在这个基础上 1000-10 = 990</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> next </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> prev </span><span style="color:#f97583">-</span><span style="color:#e1e4e8"> amount;</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#6a737d">/*</span></span>
<span class="line"><span style="color:#6a737d">            compareAndSet 正是做这个检查，在 set 前，先比较 prev 与当前值</span></span>
<span class="line"><span style="color:#6a737d">            - 不一致了，next 作废，返回 false 表示失败</span></span>
<span class="line"><span style="color:#6a737d">            比如，别的线程已经做了减法，当前值已经被减成了 990</span></span>
<span class="line"><span style="color:#6a737d">            那么本线程的这次 990 就作废了，进入 while 下次循环重试</span></span>
<span class="line"><span style="color:#6a737d">            - 一致，以 next 设置为新值，返回 true 表示成功</span></span>
<span class="line"><span style="color:#6a737d">            */</span></span>
<span class="line"><span style="color:#e1e4e8">			</span><span style="color:#f97583">if</span><span style="color:#e1e4e8">(balance.</span><span style="color:#b392f0">compareAndSet</span><span style="color:#e1e4e8">(prev, next)) {</span></span>
<span class="line"><span style="color:#e1e4e8">				</span><span style="color:#f97583">break</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">			}</span></span>
<span class="line"><span style="color:#e1e4e8">		}</span></span>
<span class="line"><span style="color:#e1e4e8">	}</span></span>
<span class="line"><span style="color:#e1e4e8">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#d73a49">interface</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Account</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">	Integer </span><span style="color:#6f42c1">getBalance</span><span style="color:#24292e">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">	</span><span style="color:#d73a49">void</span><span style="color:#24292e"> </span><span style="color:#6f42c1">withdraw</span><span style="color:#24292e">(Integer </span><span style="color:#e36209">amount</span><span style="color:#24292e">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6a737d">	/**</span></span>
<span class="line"><span style="color:#6a737d">	 * 方法内会启动 1000 个线程，每个线程做 -10 元 的操作     </span></span>
<span class="line"><span style="color:#6a737d">	 * 如果初始余额为 10000 那么正确的结果应当是 0</span></span>
<span class="line"><span style="color:#6a737d">	 */</span></span>
<span class="line"><span style="color:#24292e">	</span><span style="color:#d73a49">static</span><span style="color:#24292e"> </span><span style="color:#d73a49">void</span><span style="color:#24292e"> </span><span style="color:#6f42c1">demo</span><span style="color:#24292e">(Account </span><span style="color:#e36209">account</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">		List&lt;</span><span style="color:#d73a49">Thread</span><span style="color:#24292e">&gt; ts </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> ArrayList&lt;&gt;();</span></span>
<span class="line"><span style="color:#24292e">		</span><span style="color:#d73a49">long</span><span style="color:#24292e"> start </span><span style="color:#d73a49">=</span><span style="color:#24292e"> System.</span><span style="color:#6f42c1">nanoTime</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">		</span><span style="color:#d73a49">for</span><span style="color:#24292e"> (</span><span style="color:#d73a49">int</span><span style="color:#24292e"> i </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#005cc5">0</span><span style="color:#24292e">; i </span><span style="color:#d73a49">&lt;</span><span style="color:#24292e"> </span><span style="color:#005cc5">1000</span><span style="color:#24292e">; i</span><span style="color:#d73a49">++</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">			ts.</span><span style="color:#6f42c1">add</span><span style="color:#24292e">(</span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Thread</span><span style="color:#24292e">(() </span><span style="color:#d73a49">-&gt;</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">				account.</span><span style="color:#6f42c1">withdraw</span><span style="color:#24292e">(</span><span style="color:#005cc5">10</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">			}));</span></span>
<span class="line"><span style="color:#24292e">		}</span></span>
<span class="line"><span style="color:#24292e">		ts.</span><span style="color:#6f42c1">forEach</span><span style="color:#24292e">(Thread</span><span style="color:#d73a49">::</span><span style="color:#24292e">start);</span></span>
<span class="line"><span style="color:#24292e">		ts.</span><span style="color:#6f42c1">forEach</span><span style="color:#24292e">(t </span><span style="color:#d73a49">-&gt;</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">			</span><span style="color:#d73a49">try</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">				t.</span><span style="color:#6f42c1">join</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">			} </span><span style="color:#d73a49">catch</span><span style="color:#24292e"> (InterruptedException </span><span style="color:#e36209">e</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">				e.</span><span style="color:#6f42c1">printStackTrace</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">			}</span></span>
<span class="line"><span style="color:#24292e">		});</span></span>
<span class="line"><span style="color:#24292e">		</span><span style="color:#d73a49">long</span><span style="color:#24292e"> end </span><span style="color:#d73a49">=</span><span style="color:#24292e"> System.</span><span style="color:#6f42c1">nanoTime</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">		System.out.</span><span style="color:#6f42c1">println</span><span style="color:#24292e">(account.</span><span style="color:#6f42c1">getBalance</span><span style="color:#24292e">() </span><span style="color:#d73a49">+</span><span style="color:#24292e"> </span><span style="color:#032f62">" cost: "</span><span style="color:#24292e"> </span><span style="color:#d73a49">+</span><span style="color:#24292e"> (end </span><span style="color:#d73a49">-</span><span style="color:#24292e"> start) </span><span style="color:#d73a49">/</span><span style="color:#24292e"> </span><span style="color:#005cc5">1000_000</span><span style="color:#24292e"> </span><span style="color:#d73a49">+</span><span style="color:#24292e"> </span><span style="color:#032f62">" ms"</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">	}</span></span>
<span class="line"><span style="color:#24292e">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6a737d">//线程不安全的做法</span></span>
<span class="line"><span style="color:#d73a49">class</span><span style="color:#24292e"> </span><span style="color:#6f42c1">AccountUnsafe</span><span style="color:#24292e"> </span><span style="color:#d73a49">implements</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Account</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">	</span><span style="color:#d73a49">private</span><span style="color:#24292e"> Integer balance;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">	</span><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#6f42c1">AccountUnsafe</span><span style="color:#24292e">(Integer </span><span style="color:#e36209">balance</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">		</span><span style="color:#005cc5">this</span><span style="color:#24292e">.balance </span><span style="color:#d73a49">=</span><span style="color:#24292e"> balance;</span></span>
<span class="line"><span style="color:#24292e">	}</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">	@</span><span style="color:#d73a49">Override</span></span>
<span class="line"><span style="color:#24292e">	</span><span style="color:#d73a49">public</span><span style="color:#24292e"> Integer </span><span style="color:#6f42c1">getBalance</span><span style="color:#24292e">() {</span></span>
<span class="line"><span style="color:#24292e">		</span><span style="color:#d73a49">return</span><span style="color:#24292e"> </span><span style="color:#005cc5">this</span><span style="color:#24292e">.balance;</span></span>
<span class="line"><span style="color:#24292e">	}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">	@</span><span style="color:#d73a49">Override</span></span>
<span class="line"><span style="color:#24292e">	</span><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">synchronized</span><span style="color:#24292e"> </span><span style="color:#d73a49">void</span><span style="color:#24292e"> </span><span style="color:#6f42c1">withdraw</span><span style="color:#24292e">(Integer </span><span style="color:#e36209">amount</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">		balance </span><span style="color:#d73a49">-=</span><span style="color:#24292e"> amount;</span></span>
<span class="line"><span style="color:#24292e">	}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">	</span><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">static</span><span style="color:#24292e"> </span><span style="color:#d73a49">void</span><span style="color:#24292e"> </span><span style="color:#6f42c1">main</span><span style="color:#24292e">(</span><span style="color:#d73a49">String</span><span style="color:#24292e">[] </span><span style="color:#e36209">args</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">		Account.</span><span style="color:#6f42c1">demo</span><span style="color:#24292e">(</span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">AccountUnsafe</span><span style="color:#24292e">(</span><span style="color:#005cc5">10000</span><span style="color:#24292e">));</span></span>
<span class="line"><span style="color:#24292e">		Account.</span><span style="color:#6f42c1">demo</span><span style="color:#24292e">(</span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">AccountCas</span><span style="color:#24292e">(</span><span style="color:#005cc5">10000</span><span style="color:#24292e">));</span></span>
<span class="line"><span style="color:#24292e">	}</span></span>
<span class="line"><span style="color:#24292e">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6a737d">//线程安全的做法</span></span>
<span class="line"><span style="color:#d73a49">class</span><span style="color:#24292e"> </span><span style="color:#6f42c1">AccountCas</span><span style="color:#24292e"> </span><span style="color:#d73a49">implements</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Account</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">	</span><span style="color:#6a737d">//使用原子整数</span></span>
<span class="line"><span style="color:#24292e">	</span><span style="color:#d73a49">private</span><span style="color:#24292e"> AtomicInteger balance;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">	</span><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#6f42c1">AccountCas</span><span style="color:#24292e">(</span><span style="color:#d73a49">int</span><span style="color:#24292e"> </span><span style="color:#e36209">balance</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">		</span><span style="color:#005cc5">this</span><span style="color:#24292e">.balance </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">AtomicInteger</span><span style="color:#24292e">(balance);</span></span>
<span class="line"><span style="color:#24292e">	}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">	@</span><span style="color:#d73a49">Override</span></span>
<span class="line"><span style="color:#24292e">	</span><span style="color:#d73a49">public</span><span style="color:#24292e"> Integer </span><span style="color:#6f42c1">getBalance</span><span style="color:#24292e">() {</span></span>
<span class="line"><span style="color:#24292e">		</span><span style="color:#6a737d">//得到原子整数的值</span></span>
<span class="line"><span style="color:#24292e">		</span><span style="color:#d73a49">return</span><span style="color:#24292e"> balance.</span><span style="color:#6f42c1">get</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">	}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">	@</span><span style="color:#d73a49">Override</span></span>
<span class="line"><span style="color:#24292e">	</span><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">void</span><span style="color:#24292e"> </span><span style="color:#6f42c1">withdraw</span><span style="color:#24292e">(Integer </span><span style="color:#e36209">amount</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">			</span><span style="color:#6a737d">// 需要不断尝试，直到成功为止</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">while</span><span style="color:#24292e"> (</span><span style="color:#005cc5">true</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#6a737d">// 比如拿到了旧值 1000</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">int</span><span style="color:#24292e"> prev </span><span style="color:#d73a49">=</span><span style="color:#24292e"> balance.</span><span style="color:#6f42c1">get</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#6a737d">// 在这个基础上 1000-10 = 990</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">int</span><span style="color:#24292e"> next </span><span style="color:#d73a49">=</span><span style="color:#24292e"> prev </span><span style="color:#d73a49">-</span><span style="color:#24292e"> amount;</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#6a737d">/*</span></span>
<span class="line"><span style="color:#6a737d">            compareAndSet 正是做这个检查，在 set 前，先比较 prev 与当前值</span></span>
<span class="line"><span style="color:#6a737d">            - 不一致了，next 作废，返回 false 表示失败</span></span>
<span class="line"><span style="color:#6a737d">            比如，别的线程已经做了减法，当前值已经被减成了 990</span></span>
<span class="line"><span style="color:#6a737d">            那么本线程的这次 990 就作废了，进入 while 下次循环重试</span></span>
<span class="line"><span style="color:#6a737d">            - 一致，以 next 设置为新值，返回 true 表示成功</span></span>
<span class="line"><span style="color:#6a737d">            */</span></span>
<span class="line"><span style="color:#24292e">			</span><span style="color:#d73a49">if</span><span style="color:#24292e">(balance.</span><span style="color:#6f42c1">compareAndSet</span><span style="color:#24292e">(prev, next)) {</span></span>
<span class="line"><span style="color:#24292e">				</span><span style="color:#d73a49">break</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">			}</span></span>
<span class="line"><span style="color:#24292e">		}</span></span>
<span class="line"><span style="color:#24292e">	}</span></span>
<span class="line"><span style="color:#24292e">}</span></span></code></pre><button class="collapse"></button></div><p>前面看到的 AtomicInteger 通过无锁解决线程安全问题，内部并没有用锁来保护共享变量的线程安全。那么它是如何实现的呢？其中的<strong>关键是 compareAndSet</strong>（比较并设置值），它的<strong>简称就是 CAS</strong> （也有 Compare And Swap 的说法），它必须是<strong>原子操作</strong>。</p><figure><img alt="img" class="lazy" data-src="https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/20200608145914.png"></figure><p><strong>工作流程</strong></p><ul><li>当一个线程要去修改Account对象中的值时，先获取值pre（调用get方法），然后再将其设置为新的值next（调用cas方法）。在调用cas方法时，会将pre与Account中的余额进行比较。<ul><li>如果<strong>两者相等</strong>，就说明该值还未被其他线程修改，此时便可以进行修改操作。</li><li>如果<strong>两者不相等</strong>，就不设置值，重新获取值pre（调用get方法），然后再将其设置为新的值next（调用cas方法），直到修改成功为止。</li></ul></li></ul><hr><h4 id="原理" tabindex="-1">原理 <a aria-current="page" href="/posts/concurrent_programming_compilation_version-lock_free#原理" class="router-link-active router-link-exact-active header-anchor" aria-label="Permalink to &quot;原理&quot;"><!--[-->​<!--]--></a></h4><p>无锁编程：Lock Free</p><p>CAS 的全称是 Compare-And-Swap，是 <strong>CPU 并发原语</strong></p><ul><li>CAS 并发原语体现在 Java 语言中就是 sun.misc.Unsafe 类的各个方法，调用 UnSafe 类中的 CAS 方法，JVM 会实现出 CAS 汇编指令，这是一种完全依赖于硬件的功能，实现了原子操作</li><li>CAS 是一种系统原语，原语属于操作系统范畴，是由若干条指令组成 ，用于完成某个功能的一个过程，并且原语的执行必须是连续的，执行过程中不允许被中断，所以 CAS 是一条 CPU 的原子指令，不会造成数据不一致的问题，是线程安全的</li></ul><p>底层原理：CAS 的底层是 <code>lock cmpxchg</code> 指令（X86 架构），在单核和多核 CPU 下都能够保证比较交换的原子性</p><ul><li><p>程序是在单核处理器上运行，会省略 lock 前缀，单处理器自身会维护处理器内的顺序一致性，不需要 lock 前缀的内存屏障效果</p></li><li><p>程序是在多核处理器上运行，会为 cmpxchg 指令加上 lock 前缀。当某个核执行到带 lock 的指令时，CPU 会执行<strong>总线锁定或缓存锁定</strong>，将修改的变量写入到主存，这个过程不会被线程的调度机制所打断，保证了多个线程对内存操作的原子性</p></li></ul><p>作用：比较当前工作内存中的值和主物理内存中的值，如果相同则执行规定操作，否则继续比较直到主内存和工作内存的值一致为止</p><hr><h4 id="前提" tabindex="-1">前提 <a aria-current="page" href="/posts/concurrent_programming_compilation_version-lock_free#前提" class="router-link-active router-link-exact-active header-anchor" aria-label="Permalink to &quot;前提&quot;"><!--[-->​<!--]--></a></h4><p><strong>CAS 必须借助 volatile</strong> 才能读取到共享变量的新值来实现【比较并交换】的效果</p><hr><h4 id="效率高" tabindex="-1"><strong>效率高</strong> <a aria-current="page" href="/posts/concurrent_programming_compilation_version-lock_free#效率高" class="router-link-active router-link-exact-active header-anchor" aria-label="Permalink to &quot;**效率高**&quot;"><!--[-->​<!--]--></a></h4><ul><li>无锁情况下，即使重试失败，线程始终在高速运行，没有停歇，而 synchronized 会让线程在没有获得锁的时候，发生上下文切换，进入阻塞。</li><li>打个比喻，线程就好像高速跑道上的赛车，高速运行时，速度超快，一旦发生上下文切换，就好比赛车要减速、熄火，等被唤醒又得重新打火、启动、加速... 恢复到高速运行，代价比较大</li><li>但无锁情况下，因为线程要保持运行，需要额外 CPU 的支持，CPU 在这里就好比高速跑道，没有额外的跑道，线程想高速运行也无从谈起，虽然不会进入阻塞，但由于没有分到时间片，仍然会进入不可运行状态，还是会导致上下文切换。（超过了CPU核心数也就没有了额外的跑道了，运行也运行不了，只能上下文切换，所以<strong>在线程数小于CPU核心数时用CAS是非常合适的</strong>）</li></ul><hr><h4 id="优缺点" tabindex="-1">优缺点 <a aria-current="page" href="/posts/concurrent_programming_compilation_version-lock_free#优缺点" class="router-link-active router-link-exact-active header-anchor" aria-label="Permalink to &quot;优缺点&quot;"><!--[-->​<!--]--></a></h4><p>CAS 特点:</p><ul><li>CAS 体现的是<strong>无锁并发、无阻塞并发</strong>，线程不会陷入阻塞，线程不需要频繁切换状态（上下文切换，系统调用）</li><li>CAS 是基于乐观锁的思想</li></ul><p>CAS 缺点：</p><ul><li>执行的是循环操作，如果比较不成功一直在循环，最差的情况某个线程一直取到的值和预期值都不一样，就会无限循环导致饥饿，<strong>使用 CAS 线程数不要超过 CPU 的核心数</strong>，采用分段 CAS 和自动迁移机制</li><li>只能保证一个共享变量的原子操作<ul><li>对于一个共享变量执行操作时，可以通过循环 CAS 的方式来保证原子操作</li><li>对于多个共享变量操作时，循环 CAS 就无法保证操作的原子性，这个时候<strong>只能用锁来保证原子性</strong></li></ul></li><li>引出来 ABA 问题</li></ul><hr><h4 id="乐观锁" tabindex="-1">乐观锁 <a aria-current="page" href="/posts/concurrent_programming_compilation_version-lock_free#乐观锁" class="router-link-active router-link-exact-active header-anchor" aria-label="Permalink to &quot;乐观锁&quot;"><!--[-->​<!--]--></a></h4><p>CAS 与 synchronized 总结：</p><ul><li>synchronized 是从悲观的角度出发：总是假设最坏的情况，每次去拿数据的时候都认为别人会修改，所以每次在拿数据的时候都会上锁，这样别人想拿这个数据就会阻塞（共享资源每次只给一个线程使用，其它线程阻塞，用完后再把资源转让给其它线程），因此 synchronized 也称之为悲观锁，ReentrantLock 也是一种悲观锁，性能较差</li><li>CAS 是从乐观的角度出发：总是假设最好的情况，每次去拿数据的时候都认为别人不会修改，所以不会上锁，但是在更新的时候会判断一下在此期间别人有没有去更新这个数据。<strong>如果别人修改过，则获取现在最新的值，如果别人没修改过，直接修改共享数据的值</strong>，CAS 这种机制也称之为乐观锁，综合性能较好</li></ul><hr><h3 id="atomic" tabindex="-1">Atomic <a aria-current="page" href="/posts/concurrent_programming_compilation_version-lock_free#atomic" class="router-link-active router-link-exact-active header-anchor" aria-label="Permalink to &quot;Atomic&quot;"><!--[-->​<!--]--></a></h3><h4 id="常用api" tabindex="-1">常用API <a aria-current="page" href="/posts/concurrent_programming_compilation_version-lock_free#常用api" class="router-link-active router-link-exact-active header-anchor" aria-label="Permalink to &quot;常用API&quot;"><!--[-->​<!--]--></a></h4><p>常见原子类：AtomicInteger、AtomicBoolean、AtomicLong</p><p>构造方法：</p><ul><li><code>public AtomicInteger()</code>：初始化一个默认值为 0 的原子型 Integer</li><li><code>public AtomicInteger(int initialValue)</code>：初始化一个指定值的原子型 Integer</li></ul><p>常用API：</p><table><thead><tr><th>方法</th><th>作用</th></tr></thead><tbody><tr><td>public final int get()</td><td>获取 AtomicInteger 的值</td></tr><tr><td>public final int getAndIncrement()</td><td>以原子方式将当前值加 1，返回的是自增前的值</td></tr><tr><td>public final int incrementAndGet()</td><td>以原子方式将当前值加 1，返回的是自增后的值</td></tr><tr><td>public final int getAndSet(int value)</td><td>以原子方式设置为 newValue 的值，返回旧值</td></tr><tr><td>public final int addAndGet(int data)</td><td>以原子方式将输入的数值与实例中的值相加并返回<br>实例：AtomicInteger 里的 value</td></tr></tbody></table><hr><h4 id="原理分析" tabindex="-1">原理分析 <a aria-current="page" href="/posts/concurrent_programming_compilation_version-lock_free#原理分析" class="router-link-active router-link-exact-active header-anchor" aria-label="Permalink to &quot;原理分析&quot;"><!--[-->​<!--]--></a></h4><p><strong>AtomicInteger 原理</strong>：自旋锁 + CAS 算法</p><p>CAS 算法：有 3 个操作数（内存值 V， 旧的预期值 A，要修改的值 B）</p><ul><li>当旧的预期值 A == 内存值 V 此时可以修改，将 V 改为 B</li><li>当旧的预期值 A != 内存值 V 此时不能修改，并重新获取现在的最新值，重新获取的动作就是自旋</li></ul><p>分析 getAndSet 方法：</p><ul><li><p>AtomicInteger：</p><div style="max-height:300px" class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">final</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">getAndSet</span><span style="color:#e1e4e8">(</span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> newValue) {</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">/**</span></span>
<span class="line"><span style="color:#6a737d">    * this: 		当前对象</span></span>
<span class="line"><span style="color:#6a737d">    * valueOffset:	内存偏移量，内存地址</span></span>
<span class="line"><span style="color:#6a737d">    */</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> unsafe.</span><span style="color:#b392f0">getAndSetInt</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">this</span><span style="color:#e1e4e8">, valueOffset, newValue);</span></span>
<span class="line"><span style="color:#e1e4e8">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">final</span><span style="color:#24292e"> </span><span style="color:#d73a49">int</span><span style="color:#24292e"> </span><span style="color:#6f42c1">getAndSet</span><span style="color:#24292e">(</span><span style="color:#d73a49">int</span><span style="color:#24292e"> newValue) {</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">/**</span></span>
<span class="line"><span style="color:#6a737d">    * this: 		当前对象</span></span>
<span class="line"><span style="color:#6a737d">    * valueOffset:	内存偏移量，内存地址</span></span>
<span class="line"><span style="color:#6a737d">    */</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">return</span><span style="color:#24292e"> unsafe.</span><span style="color:#6f42c1">getAndSetInt</span><span style="color:#24292e">(</span><span style="color:#005cc5">this</span><span style="color:#24292e">, valueOffset, newValue);</span></span>
<span class="line"><span style="color:#24292e">}</span></span></code></pre><button class="collapse"></button></div><p>valueOffset：偏移量表示该变量值相对于当前对象地址的偏移，Unsafe 就是根据内存偏移地址获取数据</p><div style="max-height:300px" class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8">valueOffset </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> unsafe.objectFieldOffset</span></span>
<span class="line"><span style="color:#e1e4e8">                (AtomicInteger.class.</span><span style="color:#b392f0">getDeclaredField</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"value"</span><span style="color:#e1e4e8">));</span></span>
<span class="line"><span style="color:#6a737d">//调用本地方法   --&gt;</span></span>
<span class="line"><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">native</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">long</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">objectFieldOffset</span><span style="color:#e1e4e8">(Field var1);</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e">valueOffset </span><span style="color:#d73a49">=</span><span style="color:#24292e"> unsafe.objectFieldOffset</span></span>
<span class="line"><span style="color:#24292e">                (AtomicInteger.class.</span><span style="color:#6f42c1">getDeclaredField</span><span style="color:#24292e">(</span><span style="color:#032f62">"value"</span><span style="color:#24292e">));</span></span>
<span class="line"><span style="color:#6a737d">//调用本地方法   --&gt;</span></span>
<span class="line"><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">native</span><span style="color:#24292e"> </span><span style="color:#d73a49">long</span><span style="color:#24292e"> </span><span style="color:#6f42c1">objectFieldOffset</span><span style="color:#24292e">(Field var1);</span></span></code></pre><button class="collapse"></button></div></li><li><p>unsafe 类：</p><div style="max-height:300px" class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6a737d">// val1: AtomicInteger对象本身，var2: 该对象值得引用地址，var4: 需要变动的数</span></span>
<span class="line"><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">final</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">getAndSetInt</span><span style="color:#e1e4e8">(Object var1, </span><span style="color:#f97583">long</span><span style="color:#e1e4e8"> var2, </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> var4) {</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> var5;</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">do</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#6a737d">// var5: 用 var1 和 var2 找到的内存中的真实值</span></span>
<span class="line"><span style="color:#e1e4e8">        var5 </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">this</span><span style="color:#e1e4e8">.</span><span style="color:#b392f0">getIntVolatile</span><span style="color:#e1e4e8">(var1, var2);</span></span>
<span class="line"><span style="color:#e1e4e8">    } </span><span style="color:#f97583">while</span><span style="color:#e1e4e8">(</span><span style="color:#f97583">!</span><span style="color:#79b8ff">this</span><span style="color:#e1e4e8">.</span><span style="color:#b392f0">compareAndSwapInt</span><span style="color:#e1e4e8">(var1, var2, var5, var4));</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> var5;</span></span>
<span class="line"><span style="color:#e1e4e8">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6a737d">// val1: AtomicInteger对象本身，var2: 该对象值得引用地址，var4: 需要变动的数</span></span>
<span class="line"><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">final</span><span style="color:#24292e"> </span><span style="color:#d73a49">int</span><span style="color:#24292e"> </span><span style="color:#6f42c1">getAndSetInt</span><span style="color:#24292e">(Object var1, </span><span style="color:#d73a49">long</span><span style="color:#24292e"> var2, </span><span style="color:#d73a49">int</span><span style="color:#24292e"> var4) {</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">int</span><span style="color:#24292e"> var5;</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">do</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6a737d">// var5: 用 var1 和 var2 找到的内存中的真实值</span></span>
<span class="line"><span style="color:#24292e">        var5 </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#005cc5">this</span><span style="color:#24292e">.</span><span style="color:#6f42c1">getIntVolatile</span><span style="color:#24292e">(var1, var2);</span></span>
<span class="line"><span style="color:#24292e">    } </span><span style="color:#d73a49">while</span><span style="color:#24292e">(</span><span style="color:#d73a49">!</span><span style="color:#005cc5">this</span><span style="color:#24292e">.</span><span style="color:#6f42c1">compareAndSwapInt</span><span style="color:#24292e">(var1, var2, var5, var4));</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">return</span><span style="color:#24292e"> var5;</span></span>
<span class="line"><span style="color:#24292e">}</span></span></code></pre><button class="collapse"></button></div><p>var5：从主内存中拷贝到工作内存中的值（每次都要从主内存拿到最新的值到本地内存），然后执行 <code>compareAndSwapInt()</code> 再和主内存的值进行比较，假设方法返回 false，那么就一直执行 while 方法，直到期望的值和真实值一样，修改数据</p></li><li><p>变量 value 用 volatile 修饰，保证了多线程之间的内存可见性，避免线程从工作缓存中获取失效的变量</p><div style="max-height:300px" class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#f97583">private</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">volatile</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> value</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#d73a49">private</span><span style="color:#24292e"> </span><span style="color:#d73a49">volatile</span><span style="color:#24292e"> </span><span style="color:#d73a49">int</span><span style="color:#24292e"> value</span></span></code></pre><button class="collapse"></button></div><p><strong>CAS 必须借助 volatile 才能读取到共享变量的最新值来实现比较并交换的效果</strong></p></li></ul><p>分析 getAndUpdate 方法：</p><ul><li><p>getAndUpdate：</p><div style="max-height:300px" class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">final</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">getAndUpdate</span><span style="color:#e1e4e8">(IntUnaryOperator updateFunction) {</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> prev, next;</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">do</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">        prev </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">get</span><span style="color:#e1e4e8">();	</span><span style="color:#6a737d">//当前值，cas的期望值</span></span>
<span class="line"><span style="color:#e1e4e8">        next </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> updateFunction.</span><span style="color:#b392f0">applyAsInt</span><span style="color:#e1e4e8">(prev);</span><span style="color:#6a737d">//期望值更新到该值</span></span>
<span class="line"><span style="color:#e1e4e8">    } </span><span style="color:#f97583">while</span><span style="color:#e1e4e8"> (</span><span style="color:#f97583">!</span><span style="color:#b392f0">compareAndSet</span><span style="color:#e1e4e8">(prev, next));</span><span style="color:#6a737d">//自旋</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> prev;</span></span>
<span class="line"><span style="color:#e1e4e8">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">final</span><span style="color:#24292e"> </span><span style="color:#d73a49">int</span><span style="color:#24292e"> </span><span style="color:#6f42c1">getAndUpdate</span><span style="color:#24292e">(IntUnaryOperator updateFunction) {</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">int</span><span style="color:#24292e"> prev, next;</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">do</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">        prev </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#6f42c1">get</span><span style="color:#24292e">();	</span><span style="color:#6a737d">//当前值，cas的期望值</span></span>
<span class="line"><span style="color:#24292e">        next </span><span style="color:#d73a49">=</span><span style="color:#24292e"> updateFunction.</span><span style="color:#6f42c1">applyAsInt</span><span style="color:#24292e">(prev);</span><span style="color:#6a737d">//期望值更新到该值</span></span>
<span class="line"><span style="color:#24292e">    } </span><span style="color:#d73a49">while</span><span style="color:#24292e"> (</span><span style="color:#d73a49">!</span><span style="color:#6f42c1">compareAndSet</span><span style="color:#24292e">(prev, next));</span><span style="color:#6a737d">//自旋</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">return</span><span style="color:#24292e"> prev;</span></span>
<span class="line"><span style="color:#24292e">}</span></span></code></pre><button class="collapse"></button></div><p>模仿：</p><div style="max-height:300px" class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">static</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">void</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">main</span><span style="color:#e1e4e8">(</span><span style="color:#f97583">String</span><span style="color:#e1e4e8">[] args) {</span></span>
<span class="line"><span style="color:#e1e4e8">    AtomicInteger i </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">AtomicInteger</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">5</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">    System.out.</span><span style="color:#b392f0">println</span><span style="color:#e1e4e8">(</span><span style="color:#b392f0">updateAndGet</span><span style="color:#e1e4e8">(i, p </span><span style="color:#f97583">-&gt;</span><span style="color:#e1e4e8"> p </span><span style="color:#f97583">/</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">2</span><span style="color:#e1e4e8">));</span></span>
<span class="line"><span style="color:#e1e4e8">}</span></span>
<span class="line"><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">static</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">updateAndGet</span><span style="color:#e1e4e8">(AtomicInteger i, IntUnaryOperator operator) {</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">while</span><span style="color:#e1e4e8"> (</span><span style="color:#79b8ff">true</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> prev </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> i.</span><span style="color:#b392f0">get</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> next </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> operator.</span><span style="color:#b392f0">applyAsInt</span><span style="color:#e1e4e8">(prev);</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (i.</span><span style="color:#b392f0">compareAndSet</span><span style="color:#e1e4e8">(prev, next)) {</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> next;</span></span>
<span class="line"><span style="color:#e1e4e8">            }</span></span>
<span class="line"><span style="color:#e1e4e8">        }</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">static</span><span style="color:#24292e"> </span><span style="color:#d73a49">void</span><span style="color:#24292e"> </span><span style="color:#6f42c1">main</span><span style="color:#24292e">(</span><span style="color:#d73a49">String</span><span style="color:#24292e">[] args) {</span></span>
<span class="line"><span style="color:#24292e">    AtomicInteger i </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">AtomicInteger</span><span style="color:#24292e">(</span><span style="color:#005cc5">5</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">    System.out.</span><span style="color:#6f42c1">println</span><span style="color:#24292e">(</span><span style="color:#6f42c1">updateAndGet</span><span style="color:#24292e">(i, p </span><span style="color:#d73a49">-&gt;</span><span style="color:#24292e"> p </span><span style="color:#d73a49">/</span><span style="color:#24292e"> </span><span style="color:#005cc5">2</span><span style="color:#24292e">));</span></span>
<span class="line"><span style="color:#24292e">}</span></span>
<span class="line"><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">static</span><span style="color:#24292e"> </span><span style="color:#d73a49">int</span><span style="color:#24292e"> </span><span style="color:#6f42c1">updateAndGet</span><span style="color:#24292e">(AtomicInteger i, IntUnaryOperator operator) {</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">while</span><span style="color:#24292e"> (</span><span style="color:#005cc5">true</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">int</span><span style="color:#24292e"> prev </span><span style="color:#d73a49">=</span><span style="color:#24292e"> i.</span><span style="color:#6f42c1">get</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">int</span><span style="color:#24292e"> next </span><span style="color:#d73a49">=</span><span style="color:#24292e"> operator.</span><span style="color:#6f42c1">applyAsInt</span><span style="color:#24292e">(prev);</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (i.</span><span style="color:#6f42c1">compareAndSet</span><span style="color:#24292e">(prev, next)) {</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#d73a49">return</span><span style="color:#24292e"> next;</span></span>
<span class="line"><span style="color:#24292e">            }</span></span>
<span class="line"><span style="color:#24292e">        }</span></span>
<span class="line"><span style="color:#24292e">    }</span></span></code></pre><button class="collapse"></button></div><p>函数式接口：可以自定义操作逻辑</p><div style="max-height:300px" class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8">AtomicInteger a </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">AtomicInteger</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">a.</span><span style="color:#b392f0">getAndUpdate</span><span style="color:#e1e4e8">(i </span><span style="color:#f97583">-&gt;</span><span style="color:#e1e4e8"> i </span><span style="color:#f97583">+</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">10</span><span style="color:#e1e4e8">);</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e">AtomicInteger a </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">AtomicInteger</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">a.</span><span style="color:#6f42c1">getAndUpdate</span><span style="color:#24292e">(i </span><span style="color:#d73a49">-&gt;</span><span style="color:#24292e"> i </span><span style="color:#d73a49">+</span><span style="color:#24292e"> </span><span style="color:#005cc5">10</span><span style="color:#24292e">);</span></span></code></pre><button class="collapse"></button></div></li><li><p>compareAndSet：</p><div style="max-height:300px" class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">final</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">boolean</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">compareAndSet</span><span style="color:#e1e4e8">(</span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> expect, </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> update) {</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">/**</span></span>
<span class="line"><span style="color:#6a737d">    * this: 		当前对象</span></span>
<span class="line"><span style="color:#6a737d">    * valueOffset:	内存偏移量，内存地址</span></span>
<span class="line"><span style="color:#6a737d">    * expect:		期望的值</span></span>
<span class="line"><span style="color:#6a737d">    * update: 		更新的值</span></span>
<span class="line"><span style="color:#6a737d">    */</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> unsafe.</span><span style="color:#b392f0">compareAndSwapInt</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">this</span><span style="color:#e1e4e8">, valueOffset, expect, update);</span></span>
<span class="line"><span style="color:#e1e4e8">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">final</span><span style="color:#24292e"> </span><span style="color:#d73a49">boolean</span><span style="color:#24292e"> </span><span style="color:#6f42c1">compareAndSet</span><span style="color:#24292e">(</span><span style="color:#d73a49">int</span><span style="color:#24292e"> expect, </span><span style="color:#d73a49">int</span><span style="color:#24292e"> update) {</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">/**</span></span>
<span class="line"><span style="color:#6a737d">    * this: 		当前对象</span></span>
<span class="line"><span style="color:#6a737d">    * valueOffset:	内存偏移量，内存地址</span></span>
<span class="line"><span style="color:#6a737d">    * expect:		期望的值</span></span>
<span class="line"><span style="color:#6a737d">    * update: 		更新的值</span></span>
<span class="line"><span style="color:#6a737d">    */</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">return</span><span style="color:#24292e"> unsafe.</span><span style="color:#6f42c1">compareAndSwapInt</span><span style="color:#24292e">(</span><span style="color:#005cc5">this</span><span style="color:#24292e">, valueOffset, expect, update);</span></span>
<span class="line"><span style="color:#24292e">}</span></span></code></pre><button class="collapse"></button></div></li></ul><hr><h4 id="原子引用" tabindex="-1">原子引用 <a aria-current="page" href="/posts/concurrent_programming_compilation_version-lock_free#原子引用" class="router-link-active router-link-exact-active header-anchor" aria-label="Permalink to &quot;原子引用&quot;"><!--[-->​<!--]--></a></h4><p>原子引用：对 Object 进行原子操作，提供一种读和写都是原子性的对象引用变量</p><p>原子引用类：AtomicReference、AtomicStampedReference、AtomicMarkableReference</p><p>AtomicReference 类：</p><ul><li><p>构造方法：</p><ul><li><p><code>public AtomicReference(V initialValue)</code>：初始化一个指定值的原子引用</p></li><li><p><code>public AtomicReference()</code>：初始化一个默认值为 null 的原子引用</p></li></ul></li><li><p>常用 API：</p><ul><li><code>public final boolean compareAndSet(V expectedValue, V newValue)</code>：CAS 操作</li><li><code>public final void set(V newValue)</code>：将值设置为 newValue</li><li><code>public final V get()</code>：返回当前值</li></ul></li></ul><div style="max-height:300px" class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">class</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">AtomicReferenceDemo</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">static</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">void</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">main</span><span style="color:#e1e4e8">(</span><span style="color:#f97583">String</span><span style="color:#e1e4e8">[] </span><span style="color:#ffab70">args</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">        Student s1 </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Student</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">33</span><span style="color:#e1e4e8">, </span><span style="color:#9ecbff">"z3"</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">        </span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#6a737d">// 创建原子引用包装类</span></span>
<span class="line"><span style="color:#e1e4e8">        AtomicReference&lt;</span><span style="color:#f97583">Student</span><span style="color:#e1e4e8">&gt; atomicReference </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> AtomicReference&lt;&gt;();</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#6a737d">// 设置主内存共享变量为s1</span></span>
<span class="line"><span style="color:#e1e4e8">        atomicReference.</span><span style="color:#b392f0">set</span><span style="color:#e1e4e8">(s1);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#6a737d">// 比较并交换，如果现在主物理内存的值为 z3，那么交换成 l4</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">while</span><span style="color:#e1e4e8"> (</span><span style="color:#79b8ff">true</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">            Student s2 </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Student</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">44</span><span style="color:#e1e4e8">, </span><span style="color:#9ecbff">"l4"</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (atomicReference.</span><span style="color:#b392f0">compareAndSet</span><span style="color:#e1e4e8">(s1, s2)) {</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#f97583">break</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">            }</span></span>
<span class="line"><span style="color:#e1e4e8">        }</span></span>
<span class="line"><span style="color:#e1e4e8">        System.out.</span><span style="color:#b392f0">println</span><span style="color:#e1e4e8">(atomicReference.</span><span style="color:#b392f0">get</span><span style="color:#e1e4e8">());</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"><span style="color:#e1e4e8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#f97583">class</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Student</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">private</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> id;</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">private</span><span style="color:#e1e4e8"> String name;</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">//。。。。</span></span>
<span class="line"><span style="color:#e1e4e8">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">class</span><span style="color:#24292e"> </span><span style="color:#6f42c1">AtomicReferenceDemo</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">static</span><span style="color:#24292e"> </span><span style="color:#d73a49">void</span><span style="color:#24292e"> </span><span style="color:#6f42c1">main</span><span style="color:#24292e">(</span><span style="color:#d73a49">String</span><span style="color:#24292e">[] </span><span style="color:#e36209">args</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">        Student s1 </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Student</span><span style="color:#24292e">(</span><span style="color:#005cc5">33</span><span style="color:#24292e">, </span><span style="color:#032f62">"z3"</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">        </span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6a737d">// 创建原子引用包装类</span></span>
<span class="line"><span style="color:#24292e">        AtomicReference&lt;</span><span style="color:#d73a49">Student</span><span style="color:#24292e">&gt; atomicReference </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> AtomicReference&lt;&gt;();</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6a737d">// 设置主内存共享变量为s1</span></span>
<span class="line"><span style="color:#24292e">        atomicReference.</span><span style="color:#6f42c1">set</span><span style="color:#24292e">(s1);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6a737d">// 比较并交换，如果现在主物理内存的值为 z3，那么交换成 l4</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">while</span><span style="color:#24292e"> (</span><span style="color:#005cc5">true</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">            Student s2 </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Student</span><span style="color:#24292e">(</span><span style="color:#005cc5">44</span><span style="color:#24292e">, </span><span style="color:#032f62">"l4"</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (atomicReference.</span><span style="color:#6f42c1">compareAndSet</span><span style="color:#24292e">(s1, s2)) {</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#d73a49">break</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">            }</span></span>
<span class="line"><span style="color:#24292e">        }</span></span>
<span class="line"><span style="color:#24292e">        System.out.</span><span style="color:#6f42c1">println</span><span style="color:#24292e">(atomicReference.</span><span style="color:#6f42c1">get</span><span style="color:#24292e">());</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"><span style="color:#24292e">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#d73a49">class</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Student</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">private</span><span style="color:#24292e"> </span><span style="color:#d73a49">int</span><span style="color:#24292e"> id;</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">private</span><span style="color:#24292e"> String name;</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">//。。。。</span></span>
<span class="line"><span style="color:#24292e">}</span></span></code></pre><button class="collapse"></button></div><hr><h4 id="原子数组" tabindex="-1">原子数组 <a aria-current="page" href="/posts/concurrent_programming_compilation_version-lock_free#原子数组" class="router-link-active router-link-exact-active header-anchor" aria-label="Permalink to &quot;原子数组&quot;"><!--[-->​<!--]--></a></h4><p>原子数组类：AtomicIntegerArray、AtomicLongArray、AtomicReferenceArray</p><p>AtomicIntegerArray 类方法：</p><div style="max-height:300px" class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6a737d">/**</span></span>
<span class="line"><span style="color:#6a737d">*   i		the index</span></span>
<span class="line"><span style="color:#6a737d">* expect 	the expected value</span></span>
<span class="line"><span style="color:#6a737d">* update 	the new value</span></span>
<span class="line"><span style="color:#6a737d">*/</span></span>
<span class="line"><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">final</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">boolean</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">compareAndSet</span><span style="color:#e1e4e8">(</span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> i, </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> expect, </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> update) {</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">compareAndSetRaw</span><span style="color:#e1e4e8">(</span><span style="color:#b392f0">checkedByteOffset</span><span style="color:#e1e4e8">(i), expect, update);</span></span>
<span class="line"><span style="color:#e1e4e8">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6a737d">/**</span></span>
<span class="line"><span style="color:#6a737d">*   i		the index</span></span>
<span class="line"><span style="color:#6a737d">* expect 	the expected value</span></span>
<span class="line"><span style="color:#6a737d">* update 	the new value</span></span>
<span class="line"><span style="color:#6a737d">*/</span></span>
<span class="line"><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">final</span><span style="color:#24292e"> </span><span style="color:#d73a49">boolean</span><span style="color:#24292e"> </span><span style="color:#6f42c1">compareAndSet</span><span style="color:#24292e">(</span><span style="color:#d73a49">int</span><span style="color:#24292e"> i, </span><span style="color:#d73a49">int</span><span style="color:#24292e"> expect, </span><span style="color:#d73a49">int</span><span style="color:#24292e"> update) {</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">return</span><span style="color:#24292e"> </span><span style="color:#6f42c1">compareAndSetRaw</span><span style="color:#24292e">(</span><span style="color:#6f42c1">checkedByteOffset</span><span style="color:#24292e">(i), expect, update);</span></span>
<span class="line"><span style="color:#24292e">}</span></span></code></pre><button class="collapse"></button></div><hr><h4 id="原子更新器" tabindex="-1">原子更新器 <a aria-current="page" href="/posts/concurrent_programming_compilation_version-lock_free#原子更新器" class="router-link-active router-link-exact-active header-anchor" aria-label="Permalink to &quot;原子更新器&quot;"><!--[-->​<!--]--></a></h4><p>原子更新器类：AtomicReferenceFieldUpdater、AtomicIntegerFieldUpdater、AtomicLongFieldUpdater</p><p>利用字段更新器，可以针对对象的某个域（Field）进行原子操作，只能配合 volatile 修饰的字段使用，否则会出现异常 <code>IllegalArgumentException: Must be volatile type</code></p><p>常用 API：</p><ul><li><code>static &lt;U&gt; AtomicIntegerFieldUpdater&lt;U&gt; newUpdater(Class&lt;U&gt; c, String fieldName)</code>：静态方法</li><li><code>abstract boolean compareAndSet(T obj, int expect, int update)</code>：CAS</li></ul><div style="max-height:300px" class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">class</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">UpdateDemo</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">private</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">volatile</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> field;</span></span>
<span class="line"><span style="color:#e1e4e8">    </span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">static</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">void</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">main</span><span style="color:#e1e4e8">(</span><span style="color:#f97583">String</span><span style="color:#e1e4e8">[] </span><span style="color:#ffab70">args</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">        AtomicIntegerFieldUpdater fieldUpdater </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> AtomicIntegerFieldUpdater</span></span>
<span class="line"><span style="color:#e1e4e8">            		.</span><span style="color:#b392f0">newUpdater</span><span style="color:#e1e4e8">(UpdateDemo.class, </span><span style="color:#9ecbff">"field"</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">        UpdateDemo updateDemo </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">UpdateDemo</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">        fieldUpdater.</span><span style="color:#b392f0">compareAndSet</span><span style="color:#e1e4e8">(updateDemo, </span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8">, </span><span style="color:#79b8ff">10</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">        System.out.</span><span style="color:#b392f0">println</span><span style="color:#e1e4e8">(updateDemo.field);</span><span style="color:#6a737d">//10</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"><span style="color:#e1e4e8">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">class</span><span style="color:#24292e"> </span><span style="color:#6f42c1">UpdateDemo</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">private</span><span style="color:#24292e"> </span><span style="color:#d73a49">volatile</span><span style="color:#24292e"> </span><span style="color:#d73a49">int</span><span style="color:#24292e"> field;</span></span>
<span class="line"><span style="color:#24292e">    </span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">static</span><span style="color:#24292e"> </span><span style="color:#d73a49">void</span><span style="color:#24292e"> </span><span style="color:#6f42c1">main</span><span style="color:#24292e">(</span><span style="color:#d73a49">String</span><span style="color:#24292e">[] </span><span style="color:#e36209">args</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">        AtomicIntegerFieldUpdater fieldUpdater </span><span style="color:#d73a49">=</span><span style="color:#24292e"> AtomicIntegerFieldUpdater</span></span>
<span class="line"><span style="color:#24292e">            		.</span><span style="color:#6f42c1">newUpdater</span><span style="color:#24292e">(UpdateDemo.class, </span><span style="color:#032f62">"field"</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">        UpdateDemo updateDemo </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">UpdateDemo</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">        fieldUpdater.</span><span style="color:#6f42c1">compareAndSet</span><span style="color:#24292e">(updateDemo, </span><span style="color:#005cc5">0</span><span style="color:#24292e">, </span><span style="color:#005cc5">10</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">        System.out.</span><span style="color:#6f42c1">println</span><span style="color:#24292e">(updateDemo.field);</span><span style="color:#6a737d">//10</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"><span style="color:#24292e">}</span></span></code></pre><button class="collapse"></button></div><hr><h4 id="原子累加器" tabindex="-1">原子累加器 <a aria-current="page" href="/posts/concurrent_programming_compilation_version-lock_free#原子累加器" class="router-link-active router-link-exact-active header-anchor" aria-label="Permalink to &quot;原子累加器&quot;"><!--[-->​<!--]--></a></h4><p>原子累加器类：LongAdder、DoubleAdder、LongAccumulator、DoubleAccumulator</p><p>LongAdder 和 LongAccumulator 区别：</p><p>相同点：</p><ul><li>LongAdder 与 LongAccumulator 类都是使用非阻塞算法 CAS 实现的</li><li>LongAdder 类是 LongAccumulator 类的一个特例，只是 LongAccumulator 提供了更强大的功能，可以自定义累加规则，当accumulatorFunction 为 null 时就等价于 LongAdder</li></ul><p>不同点：</p><ul><li><p>调用 casBase 时，LongAccumulator 使用 function.applyAsLong(b = base, x) 来计算，LongAdder 使用 casBase(b = base, b + x)</p></li><li><p>LongAccumulator 类功能更加强大，构造方法参数中</p><ul><li>accumulatorFunction 是一个双目运算器接口，可以指定累加规则，比如累加或者相乘，其根据输入的两个参数返回一个计算值，LongAdder 内置累加规则</li><li>identity 则是 LongAccumulator 累加器的初始值，LongAccumulator 可以为累加器提供非0的初始值，而 LongAdder 只能提供默认的 0</li></ul></li></ul><hr><h3 id="adder" tabindex="-1">Adder <a aria-current="page" href="/posts/concurrent_programming_compilation_version-lock_free#adder" class="router-link-active router-link-exact-active header-anchor" aria-label="Permalink to &quot;Adder&quot;"><!--[-->​<!--]--></a></h3><h4 id="优化机制" tabindex="-1">优化机制 <a aria-current="page" href="/posts/concurrent_programming_compilation_version-lock_free#优化机制" class="router-link-active router-link-exact-active header-anchor" aria-label="Permalink to &quot;优化机制&quot;"><!--[-->​<!--]--></a></h4><p>LongAdder 是 Java8 提供的类，跟 AtomicLong 有相同的效果，但对 CAS 机制进行了优化，尝试使用分段 CAS 以及自动分段迁移的方式来大幅度提升多线程高并发执行 CAS 操作的性能</p><p>CAS 底层实现是在一个循环中不断地尝试修改目标值，直到修改成功。如果竞争不激烈修改成功率很高，否则失败率很高，失败后这些重复的原子性操作会耗费性能（导致大量线程<strong>空循环，自旋转</strong>）</p><p>优化核心思想：数据分离，将 AtomicLong 的<strong>单点的更新压力分担到各个节点，空间换时间</strong>，在低并发的时候直接更新，可以保障和 AtomicLong 的性能基本一致，而在高并发的时候通过分散减少竞争，提高了性能</p><p><strong>分段 CAS 机制</strong>：</p><ul><li>在发生竞争时，创建 Cell 数组用于将不同线程的操作离散（通过 hash 等算法映射）到不同的节点上</li><li>设置多个累加单元（会根据需要扩容，最大为 CPU 核数），Therad-0 累加 Cell[0]，而 Thread-1 累加 Cell[1] 等，最后将结果汇总</li><li>在累加时操作的不同的 Cell 变量，因此减少了 CAS 重试失败，从而提高性能</li></ul><p><strong>自动分段迁移机制</strong>：某个 Cell 的 value 执行 CAS 失败，就会自动寻找另一个 Cell 分段内的 value 值进行 CAS 操作</p><hr><h4 id="伪共享" tabindex="-1">伪共享 <a aria-current="page" href="/posts/concurrent_programming_compilation_version-lock_free#伪共享" class="router-link-active router-link-exact-active header-anchor" aria-label="Permalink to &quot;伪共享&quot;"><!--[-->​<!--]--></a></h4><p>Cell 为累加单元：数组访问索引是通过 Thread 里的 threadLocalRandomProbe 域取模实现的，这个域是 ThreadLocalRandom 更新的</p><div style="max-height:300px" class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6a737d">// Striped64.Cell</span></span>
<span class="line"><span style="color:#e1e4e8">@</span><span style="color:#f97583">sun</span><span style="color:#e1e4e8">.misc.Contended </span><span style="color:#f97583">static</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">final</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">class</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Cell</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">volatile</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">long</span><span style="color:#e1e4e8"> value;</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#b392f0">Cell</span><span style="color:#e1e4e8">(</span><span style="color:#f97583">long</span><span style="color:#e1e4e8"> </span><span style="color:#ffab70">x</span><span style="color:#e1e4e8">) { value </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> x; }</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">// 用 cas 方式进行累加, prev 表示旧值, next 表示新值</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">final</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">boolean</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">cas</span><span style="color:#e1e4e8">(</span><span style="color:#f97583">long</span><span style="color:#e1e4e8"> </span><span style="color:#ffab70">prev</span><span style="color:#e1e4e8">, </span><span style="color:#f97583">long</span><span style="color:#e1e4e8"> </span><span style="color:#ffab70">next</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">    	</span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> UNSAFE.</span><span style="color:#b392f0">compareAndSwapLong</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">this</span><span style="color:#e1e4e8">, valueOffset, prev, next);</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">// 省略不重要代码</span></span>
<span class="line"><span style="color:#e1e4e8">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6a737d">// Striped64.Cell</span></span>
<span class="line"><span style="color:#24292e">@</span><span style="color:#d73a49">sun</span><span style="color:#24292e">.misc.Contended </span><span style="color:#d73a49">static</span><span style="color:#24292e"> </span><span style="color:#d73a49">final</span><span style="color:#24292e"> </span><span style="color:#d73a49">class</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Cell</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">volatile</span><span style="color:#24292e"> </span><span style="color:#d73a49">long</span><span style="color:#24292e"> value;</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6f42c1">Cell</span><span style="color:#24292e">(</span><span style="color:#d73a49">long</span><span style="color:#24292e"> </span><span style="color:#e36209">x</span><span style="color:#24292e">) { value </span><span style="color:#d73a49">=</span><span style="color:#24292e"> x; }</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">// 用 cas 方式进行累加, prev 表示旧值, next 表示新值</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">final</span><span style="color:#24292e"> </span><span style="color:#d73a49">boolean</span><span style="color:#24292e"> </span><span style="color:#6f42c1">cas</span><span style="color:#24292e">(</span><span style="color:#d73a49">long</span><span style="color:#24292e"> </span><span style="color:#e36209">prev</span><span style="color:#24292e">, </span><span style="color:#d73a49">long</span><span style="color:#24292e"> </span><span style="color:#e36209">next</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">    	</span><span style="color:#d73a49">return</span><span style="color:#24292e"> UNSAFE.</span><span style="color:#6f42c1">compareAndSwapLong</span><span style="color:#24292e">(</span><span style="color:#005cc5">this</span><span style="color:#24292e">, valueOffset, prev, next);</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">// 省略不重要代码</span></span>
<span class="line"><span style="color:#24292e">}</span></span></code></pre><button class="collapse"></button></div><p>Cell 是数组形式，<strong>在内存中是连续存储的</strong>，64 位系统中，一个 Cell 为 24 字节（16 字节的对象头和 8 字节的 value），每一个 cache line 为 64 字节，因此缓存行可以存下 2 个的 Cell 对象，当 Core-0 要修改 Cell[0]、Core-1 要修改 Cell[1]，<strong>无论谁修改成功都会导致当前缓存行失效</strong>，从而导致对方的数据失效，需要重新去主存获取，影响效率</p><img src="https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/20200608150111.png" alt="img" style="zoom:67%"><p>@sun.misc.Contended：防止缓存行伪共享，在使用此注解的对象或字段的前后各增加 128 字节大小的 padding，使用 2 倍于大多数硬件缓存行让 CPU 将对象预读至缓存时<strong>占用不同的缓存行</strong>，这样就不会造成对方缓存行的失效</p><img src="https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/20200608150119.png" alt="img" style="zoom:67%"><hr><h4 id="源码解析" tabindex="-1">源码解析 <a aria-current="page" href="/posts/concurrent_programming_compilation_version-lock_free#源码解析" class="router-link-active router-link-exact-active header-anchor" aria-label="Permalink to &quot;源码解析&quot;"><!--[-->​<!--]--></a></h4><p>Striped64 类成员属性：</p><div style="max-height:300px" class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6a737d">// 表示当前计算机CPU数量</span></span>
<span class="line"><span style="color:#f97583">static</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">final</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> NCPU </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> Runtime.</span><span style="color:#b392f0">getRuntime</span><span style="color:#e1e4e8">().</span><span style="color:#b392f0">availableProcessors</span><span style="color:#e1e4e8">()</span></span>
<span class="line"><span style="color:#6a737d">// 累加单元数组, 懒惰初始化</span></span>
<span class="line"><span style="color:#f97583">transient</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">volatile</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">Cell</span><span style="color:#e1e4e8">[] cells;</span></span>
<span class="line"><span style="color:#6a737d">// 基础值, 如果没有竞争, 则用 cas 累加这个域，当 cells 扩容时，也会将数据写到 base 中</span></span>
<span class="line"><span style="color:#f97583">transient</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">volatile</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">long</span><span style="color:#e1e4e8"> base;</span></span>
<span class="line"><span style="color:#6a737d">// 在 cells 初始化或扩容时只能有一个线程执行, 通过 CAS 更新 cellsBusy 置为 1 来实现一个锁</span></span>
<span class="line"><span style="color:#f97583">transient</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">volatile</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> cellsBusy;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6a737d">// 表示当前计算机CPU数量</span></span>
<span class="line"><span style="color:#d73a49">static</span><span style="color:#24292e"> </span><span style="color:#d73a49">final</span><span style="color:#24292e"> </span><span style="color:#d73a49">int</span><span style="color:#24292e"> NCPU </span><span style="color:#d73a49">=</span><span style="color:#24292e"> Runtime.</span><span style="color:#6f42c1">getRuntime</span><span style="color:#24292e">().</span><span style="color:#6f42c1">availableProcessors</span><span style="color:#24292e">()</span></span>
<span class="line"><span style="color:#6a737d">// 累加单元数组, 懒惰初始化</span></span>
<span class="line"><span style="color:#d73a49">transient</span><span style="color:#24292e"> </span><span style="color:#d73a49">volatile</span><span style="color:#24292e"> </span><span style="color:#d73a49">Cell</span><span style="color:#24292e">[] cells;</span></span>
<span class="line"><span style="color:#6a737d">// 基础值, 如果没有竞争, 则用 cas 累加这个域，当 cells 扩容时，也会将数据写到 base 中</span></span>
<span class="line"><span style="color:#d73a49">transient</span><span style="color:#24292e"> </span><span style="color:#d73a49">volatile</span><span style="color:#24292e"> </span><span style="color:#d73a49">long</span><span style="color:#24292e"> base;</span></span>
<span class="line"><span style="color:#6a737d">// 在 cells 初始化或扩容时只能有一个线程执行, 通过 CAS 更新 cellsBusy 置为 1 来实现一个锁</span></span>
<span class="line"><span style="color:#d73a49">transient</span><span style="color:#24292e"> </span><span style="color:#d73a49">volatile</span><span style="color:#24292e"> </span><span style="color:#d73a49">int</span><span style="color:#24292e"> cellsBusy;</span></span></code></pre><button class="collapse"></button></div><p>工作流程：</p><ul><li><p>cells 占用内存是相对比较大的，是惰性加载的，在无竞争或者其他线程正在初始化 cells 数组的情况下，直接更新 base 域</p></li><li><p>在第一次发生竞争时（casBase 失败）会创建一个大小为 2 的 cells 数组，将当前累加的值包装为 Cell 对象，放入映射的槽位上</p></li><li><p>分段累加的过程中，如果当前线程对应的 cells 槽位为空，就会新建 Cell 填充，如果出现竞争，就会重新计算线程对应的槽位，继续自旋尝试修改</p></li><li><p>分段迁移后还出现竞争就会扩容 cells 数组长度为原来的两倍，然后 rehash，<strong>数组长度总是 2 的 n 次幂</strong>，默认最大为 CPU 核数，但是可以超过，如果核数是 6 核，数组最长是 8</p></li></ul><p>方法分析：</p><ul><li><p>LongAdder#add：累加方法</p><div style="max-height:300px" class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">void</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">add</span><span style="color:#e1e4e8">(</span><span style="color:#f97583">long</span><span style="color:#e1e4e8"> x) {</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">// as 为累加单元数组的引用，b 为基础值，v 表示期望值</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">// m 表示 cells 数组的长度 - 1，a 表示当前线程命中的 cell 单元格</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">Cell</span><span style="color:#e1e4e8">[] as; </span><span style="color:#f97583">long</span><span style="color:#e1e4e8"> b, v; </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> m; Cell a;</span></span>
<span class="line"><span style="color:#e1e4e8">    </span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">// cells 不为空说明 cells 已经被初始化，线程发生了竞争，去更新对应的 cell 槽位</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">// 进入 || 后的逻辑去更新 base 域，更新失败表示发生竞争进入条件</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> ((as </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> cells) </span><span style="color:#f97583">!=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">||</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">!</span><span style="color:#b392f0">casBase</span><span style="color:#e1e4e8">(b </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> base, b </span><span style="color:#f97583">+</span><span style="color:#e1e4e8"> x)) {</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#6a737d">// uncontended 为 true 表示 cell 没有竞争</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">boolean</span><span style="color:#e1e4e8"> uncontended </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">true</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">        </span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#6a737d">// 条件一: true 说明 cells 未初始化，多线程写 base 发生竞争需要进行初始化 cells 数组</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#6a737d">//		  fasle 说明 cells 已经初始化，进行下一个条件寻找自己的 cell 去累加</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#6a737d">// 条件二: getProbe() 获取 hash 值，&amp; m 的逻辑和 HashMap 的逻辑相同，保证散列的均匀性</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#6a737d">// 		  true 说明当前线程对应下标的 cell 为空，需要创建 cell</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#6a737d">//        false 说明当前线程对应的 cell 不为空，进行下一个条件【将 x 值累加到对应的 cell 中】</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#6a737d">// 条件三: 有取反符号，false 说明 cas 成功，直接返回，true 说明失败，当前线程对应的 cell 有竞争</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (as </span><span style="color:#f97583">==</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">||</span><span style="color:#e1e4e8"> (m </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> as.length </span><span style="color:#f97583">-</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">1</span><span style="color:#e1e4e8">) </span><span style="color:#f97583">&lt;</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">||</span></span>
<span class="line"><span style="color:#e1e4e8">            (a </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> as[</span><span style="color:#b392f0">getProbe</span><span style="color:#e1e4e8">() </span><span style="color:#f97583">&amp;</span><span style="color:#e1e4e8"> m]) </span><span style="color:#f97583">==</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">||</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">!</span><span style="color:#e1e4e8">(uncontended </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> a.</span><span style="color:#b392f0">cas</span><span style="color:#e1e4e8">(v </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> a.value, v </span><span style="color:#f97583">+</span><span style="color:#e1e4e8"> x)))</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#b392f0">longAccumulate</span><span style="color:#e1e4e8">(x, </span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8">, uncontended);</span></span>
<span class="line"><span style="color:#e1e4e8">        	</span><span style="color:#6a737d">// 【uncontended 在对应的 cell 上累加失败的时候才为 false，其余情况均为 true】</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"><span style="color:#e1e4e8">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">void</span><span style="color:#24292e"> </span><span style="color:#6f42c1">add</span><span style="color:#24292e">(</span><span style="color:#d73a49">long</span><span style="color:#24292e"> x) {</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">// as 为累加单元数组的引用，b 为基础值，v 表示期望值</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">// m 表示 cells 数组的长度 - 1，a 表示当前线程命中的 cell 单元格</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">Cell</span><span style="color:#24292e">[] as; </span><span style="color:#d73a49">long</span><span style="color:#24292e"> b, v; </span><span style="color:#d73a49">int</span><span style="color:#24292e"> m; Cell a;</span></span>
<span class="line"><span style="color:#24292e">    </span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">// cells 不为空说明 cells 已经被初始化，线程发生了竞争，去更新对应的 cell 槽位</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">// 进入 || 后的逻辑去更新 base 域，更新失败表示发生竞争进入条件</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">if</span><span style="color:#24292e"> ((as </span><span style="color:#d73a49">=</span><span style="color:#24292e"> cells) </span><span style="color:#d73a49">!=</span><span style="color:#24292e"> </span><span style="color:#005cc5">null</span><span style="color:#24292e"> </span><span style="color:#d73a49">||</span><span style="color:#24292e"> </span><span style="color:#d73a49">!</span><span style="color:#6f42c1">casBase</span><span style="color:#24292e">(b </span><span style="color:#d73a49">=</span><span style="color:#24292e"> base, b </span><span style="color:#d73a49">+</span><span style="color:#24292e"> x)) {</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6a737d">// uncontended 为 true 表示 cell 没有竞争</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">boolean</span><span style="color:#24292e"> uncontended </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#005cc5">true</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">        </span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6a737d">// 条件一: true 说明 cells 未初始化，多线程写 base 发生竞争需要进行初始化 cells 数组</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6a737d">//		  fasle 说明 cells 已经初始化，进行下一个条件寻找自己的 cell 去累加</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6a737d">// 条件二: getProbe() 获取 hash 值，&amp; m 的逻辑和 HashMap 的逻辑相同，保证散列的均匀性</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6a737d">// 		  true 说明当前线程对应下标的 cell 为空，需要创建 cell</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6a737d">//        false 说明当前线程对应的 cell 不为空，进行下一个条件【将 x 值累加到对应的 cell 中】</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6a737d">// 条件三: 有取反符号，false 说明 cas 成功，直接返回，true 说明失败，当前线程对应的 cell 有竞争</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (as </span><span style="color:#d73a49">==</span><span style="color:#24292e"> </span><span style="color:#005cc5">null</span><span style="color:#24292e"> </span><span style="color:#d73a49">||</span><span style="color:#24292e"> (m </span><span style="color:#d73a49">=</span><span style="color:#24292e"> as.length </span><span style="color:#d73a49">-</span><span style="color:#24292e"> </span><span style="color:#005cc5">1</span><span style="color:#24292e">) </span><span style="color:#d73a49">&lt;</span><span style="color:#24292e"> </span><span style="color:#005cc5">0</span><span style="color:#24292e"> </span><span style="color:#d73a49">||</span></span>
<span class="line"><span style="color:#24292e">            (a </span><span style="color:#d73a49">=</span><span style="color:#24292e"> as[</span><span style="color:#6f42c1">getProbe</span><span style="color:#24292e">() </span><span style="color:#d73a49">&amp;</span><span style="color:#24292e"> m]) </span><span style="color:#d73a49">==</span><span style="color:#24292e"> </span><span style="color:#005cc5">null</span><span style="color:#24292e"> </span><span style="color:#d73a49">||</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">!</span><span style="color:#24292e">(uncontended </span><span style="color:#d73a49">=</span><span style="color:#24292e"> a.</span><span style="color:#6f42c1">cas</span><span style="color:#24292e">(v </span><span style="color:#d73a49">=</span><span style="color:#24292e"> a.value, v </span><span style="color:#d73a49">+</span><span style="color:#24292e"> x)))</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#6f42c1">longAccumulate</span><span style="color:#24292e">(x, </span><span style="color:#005cc5">null</span><span style="color:#24292e">, uncontended);</span></span>
<span class="line"><span style="color:#24292e">        	</span><span style="color:#6a737d">// 【uncontended 在对应的 cell 上累加失败的时候才为 false，其余情况均为 true】</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"><span style="color:#24292e">}</span></span></code></pre><button class="collapse"></button></div></li><li><p>Striped64#longAccumulate：cell 数组创建</p><div style="max-height:300px" class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6a737d">// 							x  			null 			false | true</span></span>
<span class="line"><span style="color:#f97583">final</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">void</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">longAccumulate</span><span style="color:#e1e4e8">(</span><span style="color:#f97583">long</span><span style="color:#e1e4e8"> x, LongBinaryOperator fn, </span><span style="color:#f97583">boolean</span><span style="color:#e1e4e8"> wasUncontended) {</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> h;</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">// 当前线程还没有对应的 cell, 需要随机生成一个 hash 值用来将当前线程绑定到 cell</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> ((h </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">getProbe</span><span style="color:#e1e4e8">()) </span><span style="color:#f97583">==</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#6a737d">// 初始化 probe，获取 hash 值</span></span>
<span class="line"><span style="color:#e1e4e8">        ThreadLocalRandom.</span><span style="color:#b392f0">current</span><span style="color:#e1e4e8">(); </span></span>
<span class="line"><span style="color:#e1e4e8">        h </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">getProbe</span><span style="color:#e1e4e8">();	</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#6a737d">// 默认情况下 当前线程肯定是写入到了 cells[0] 位置，不把它当做一次真正的竞争</span></span>
<span class="line"><span style="color:#e1e4e8">        wasUncontended </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">true</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">// 表示【扩容意向】，false 一定不会扩容，true 可能会扩容</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">boolean</span><span style="color:#e1e4e8"> collide </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">false</span><span style="color:#e1e4e8">; </span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">//自旋</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">for</span><span style="color:#e1e4e8"> (;;) {</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#6a737d">// as 表示cells引用，a 表示当前线程命中的 cell，n 表示 cells 数组长度，v 表示 期望值</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">Cell</span><span style="color:#e1e4e8">[] as; Cell a; </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> n; </span><span style="color:#f97583">long</span><span style="color:#e1e4e8"> v;</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#6a737d">// 【CASE1】: 表示 cells 已经初始化了，当前线程应该将数据写入到对应的 cell 中</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> ((as </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> cells) </span><span style="color:#f97583">!=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">&amp;&amp;</span><span style="color:#e1e4e8"> (n </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> as.length) </span><span style="color:#f97583">&gt;</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#6a737d">// CASE1.1: true 表示当前线程对应的索引下标的 Cell 为 null，需要创建 new Cell</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> ((a </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> as[(n </span><span style="color:#f97583">-</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">1</span><span style="color:#e1e4e8">) </span><span style="color:#f97583">&amp;</span><span style="color:#e1e4e8"> h]) </span><span style="color:#f97583">==</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#6a737d">// 判断 cellsBusy 是否被锁</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (cellsBusy </span><span style="color:#f97583">==</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8">) {   </span></span>
<span class="line"><span style="color:#e1e4e8">                    </span><span style="color:#6a737d">// 创建 cell, 初始累加值为 x</span></span>
<span class="line"><span style="color:#e1e4e8">                    Cell r </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Cell</span><span style="color:#e1e4e8">(x);  </span></span>
<span class="line"><span style="color:#e1e4e8">                    </span><span style="color:#6a737d">// 加锁</span></span>
<span class="line"><span style="color:#e1e4e8">                    </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (cellsBusy </span><span style="color:#f97583">==</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">&amp;&amp;</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">casCellsBusy</span><span style="color:#e1e4e8">()) {</span></span>
<span class="line"><span style="color:#e1e4e8">                        </span><span style="color:#6a737d">// 创建成功标记，进入【创建 cell 逻辑】</span></span>
<span class="line"><span style="color:#e1e4e8">                        </span><span style="color:#f97583">boolean</span><span style="color:#e1e4e8"> created </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">false</span><span style="color:#e1e4e8">;	</span></span>
<span class="line"><span style="color:#e1e4e8">                        </span><span style="color:#f97583">try</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">                            </span><span style="color:#f97583">Cell</span><span style="color:#e1e4e8">[] rs; </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> m, j;</span></span>
<span class="line"><span style="color:#e1e4e8">                            </span><span style="color:#6a737d">// 把当前 cells 数组赋值给 rs，并且不为 null</span></span>
<span class="line"><span style="color:#e1e4e8">                            </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> ((rs </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> cells) </span><span style="color:#f97583">!=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">&amp;&amp;</span></span>
<span class="line"><span style="color:#e1e4e8">                                (m </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> rs.length) </span><span style="color:#f97583">&gt;</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">&amp;&amp;</span></span>
<span class="line"><span style="color:#e1e4e8">                                </span><span style="color:#6a737d">// 再次判断防止其它线程初始化过该位置，当前线程再次初始化该位置会造成数据丢失</span></span>
<span class="line"><span style="color:#e1e4e8">                                </span><span style="color:#6a737d">// 因为这里是线程安全的判断，进行的逻辑不会被其他线程影响</span></span>
<span class="line"><span style="color:#e1e4e8">                                rs[j </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> (m </span><span style="color:#f97583">-</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">1</span><span style="color:#e1e4e8">) </span><span style="color:#f97583">&amp;</span><span style="color:#e1e4e8"> h] </span><span style="color:#f97583">==</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">                                </span><span style="color:#6a737d">// 把新创建的 cell 填充至当前位置</span></span>
<span class="line"><span style="color:#e1e4e8">                                rs[j] </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> r;</span></span>
<span class="line"><span style="color:#e1e4e8">                                created </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">true</span><span style="color:#e1e4e8">;	</span><span style="color:#6a737d">// 表示创建完成</span></span>
<span class="line"><span style="color:#e1e4e8">                            }</span></span>
<span class="line"><span style="color:#e1e4e8">                        } </span><span style="color:#f97583">finally</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">                            cellsBusy </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8">;		</span><span style="color:#6a737d">// 解锁</span></span>
<span class="line"><span style="color:#e1e4e8">                        }</span></span>
<span class="line"><span style="color:#e1e4e8">                        </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (created)			</span><span style="color:#6a737d">// true 表示创建完成，可以推出循环了</span></span>
<span class="line"><span style="color:#e1e4e8">                            </span><span style="color:#f97583">break</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">                        </span><span style="color:#f97583">continue</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">                    }</span></span>
<span class="line"><span style="color:#e1e4e8">                }</span></span>
<span class="line"><span style="color:#e1e4e8">                collide </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">false</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">            }</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#6a737d">// CASE1.2: 条件成立说明线程对应的 cell 有竞争, 改变线程对应的 cell 来重试 cas</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">else</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (</span><span style="color:#f97583">!</span><span style="color:#e1e4e8">wasUncontended)</span></span>
<span class="line"><span style="color:#e1e4e8">                wasUncontended </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">true</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#6a737d">// CASE 1.3: 当前线程 rehash 过，如果新命中的 cell 不为空，就尝试累加，false 说明新命中也有竞争</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">else</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (a.</span><span style="color:#b392f0">cas</span><span style="color:#e1e4e8">(v </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> a.value, ((fn </span><span style="color:#f97583">==</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8">) </span><span style="color:#f97583">?</span><span style="color:#e1e4e8"> v </span><span style="color:#f97583">+</span><span style="color:#e1e4e8"> x </span><span style="color:#f97583">:</span><span style="color:#e1e4e8"> fn.</span><span style="color:#b392f0">applyAsLong</span><span style="color:#e1e4e8">(v, x))))</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#f97583">break</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#6a737d">// CASE 1.4: cells 长度已经超过了最大长度 CPU 内核的数量或者已经扩容</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">else</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (n </span><span style="color:#f97583">&gt;=</span><span style="color:#e1e4e8"> NCPU </span><span style="color:#f97583">||</span><span style="color:#e1e4e8"> cells </span><span style="color:#f97583">!=</span><span style="color:#e1e4e8"> as)</span></span>
<span class="line"><span style="color:#e1e4e8">                collide </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">false</span><span style="color:#e1e4e8">; 		</span><span style="color:#6a737d">// 扩容意向改为false，【表示不能扩容了】</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#6a737d">// CASE 1.5: 更改扩容意向，如果 n &gt;= NCPU，这里就永远不会执行到，case1.4 永远先于 1.5 执行</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">else</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (</span><span style="color:#f97583">!</span><span style="color:#e1e4e8">collide)</span></span>
<span class="line"><span style="color:#e1e4e8">                collide </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">true</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#6a737d">// CASE 1.6: 【扩容逻辑】，进行加锁</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">else</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (cellsBusy </span><span style="color:#f97583">==</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">&amp;&amp;</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">casCellsBusy</span><span style="color:#e1e4e8">()) {</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#f97583">try</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">                    </span><span style="color:#6a737d">// 线程安全的检查，防止期间被其他线程扩容了</span></span>
<span class="line"><span style="color:#e1e4e8">                    </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (cells </span><span style="color:#f97583">==</span><span style="color:#e1e4e8"> as) {     </span></span>
<span class="line"><span style="color:#e1e4e8">                        </span><span style="color:#6a737d">// 扩容为以前的 2 倍</span></span>
<span class="line"><span style="color:#e1e4e8">                        </span><span style="color:#f97583">Cell</span><span style="color:#e1e4e8">[] rs </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">Cell</span><span style="color:#e1e4e8">[n </span><span style="color:#f97583">&lt;&lt;</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">1</span><span style="color:#e1e4e8">];</span></span>
<span class="line"><span style="color:#e1e4e8">                        </span><span style="color:#6a737d">// 遍历移动值</span></span>
<span class="line"><span style="color:#e1e4e8">                        </span><span style="color:#f97583">for</span><span style="color:#e1e4e8"> (</span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> i </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8">; i </span><span style="color:#f97583">&lt;</span><span style="color:#e1e4e8"> n; </span><span style="color:#f97583">++</span><span style="color:#e1e4e8">i)</span></span>
<span class="line"><span style="color:#e1e4e8">                            rs[i] </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> as[i];</span></span>
<span class="line"><span style="color:#e1e4e8">                        </span><span style="color:#6a737d">// 把扩容后的引用给 cells</span></span>
<span class="line"><span style="color:#e1e4e8">                        cells </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> rs;</span></span>
<span class="line"><span style="color:#e1e4e8">                    }</span></span>
<span class="line"><span style="color:#e1e4e8">                } </span><span style="color:#f97583">finally</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">                    cellsBusy </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8">;	</span><span style="color:#6a737d">// 解锁</span></span>
<span class="line"><span style="color:#e1e4e8">                }</span></span>
<span class="line"><span style="color:#e1e4e8">                collide </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">false</span><span style="color:#e1e4e8">;	</span><span style="color:#6a737d">// 扩容意向改为 false，表示不扩容了</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#f97583">continue</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">            }</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#6a737d">// 重置当前线程 Hash 值，这就是【分段迁移机制】</span></span>
<span class="line"><span style="color:#e1e4e8">            h </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">advanceProbe</span><span style="color:#e1e4e8">(h);</span></span>
<span class="line"><span style="color:#e1e4e8">        }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#6a737d">// 【CASE2】: 运行到这说明 cells 还未初始化，as 为null</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#6a737d">// 判断是否没有加锁，没有加锁就用 CAS 加锁</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#6a737d">// 条件二判断是否其它线程在当前线程给 as 赋值之后修改了 cells，这里不是线程安全的判断</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">else</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (cellsBusy </span><span style="color:#f97583">==</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">&amp;&amp;</span><span style="color:#e1e4e8"> cells </span><span style="color:#f97583">==</span><span style="color:#e1e4e8"> as </span><span style="color:#f97583">&amp;&amp;</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">casCellsBusy</span><span style="color:#e1e4e8">()) {</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#6a737d">// 初始化标志，开始 【初始化 cells 数组】</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">boolean</span><span style="color:#e1e4e8"> init </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">false</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">try</span><span style="color:#e1e4e8"> { </span></span>
<span class="line"><span style="color:#e1e4e8">               	</span><span style="color:#6a737d">// 再次判断 cells == as 防止其它线程已经提前初始化了，当前线程再次初始化导致丢失数据</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#6a737d">// 因为这里是【线程安全的，重新检查，经典 DCL】</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (cells </span><span style="color:#f97583">==</span><span style="color:#e1e4e8"> as) {</span></span>
<span class="line"><span style="color:#e1e4e8">                    </span><span style="color:#f97583">Cell</span><span style="color:#e1e4e8">[] rs </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">Cell</span><span style="color:#e1e4e8">[</span><span style="color:#79b8ff">2</span><span style="color:#e1e4e8">];	</span><span style="color:#6a737d">// 初始化数组大小为2</span></span>
<span class="line"><span style="color:#e1e4e8">                    rs[h </span><span style="color:#f97583">&amp;</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">1</span><span style="color:#e1e4e8">] </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Cell</span><span style="color:#e1e4e8">(x);	</span><span style="color:#6a737d">// 填充线程对应的cell</span></span>
<span class="line"><span style="color:#e1e4e8">                    cells </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> rs;</span></span>
<span class="line"><span style="color:#e1e4e8">                    init </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">true</span><span style="color:#e1e4e8">;				</span><span style="color:#6a737d">// 初始化成功，标记置为 true</span></span>
<span class="line"><span style="color:#e1e4e8">                }</span></span>
<span class="line"><span style="color:#e1e4e8">            } </span><span style="color:#f97583">finally</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">                cellsBusy </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8">;					</span><span style="color:#6a737d">// 解锁</span></span>
<span class="line"><span style="color:#e1e4e8">            }</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (init)</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#f97583">break</span><span style="color:#e1e4e8">;							</span><span style="color:#6a737d">// 初始化成功直接跳出自旋</span></span>
<span class="line"><span style="color:#e1e4e8">        }</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#6a737d">// 【CASE3】: 运行到这说明其他线程在初始化 cells，当前线程将值累加到 base，累加成功直接结束自旋</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">else</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (</span><span style="color:#b392f0">casBase</span><span style="color:#e1e4e8">(v </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> base, ((fn </span><span style="color:#f97583">==</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8">) </span><span style="color:#f97583">?</span><span style="color:#e1e4e8"> v </span><span style="color:#f97583">+</span><span style="color:#e1e4e8"> x </span><span style="color:#f97583">:</span></span>
<span class="line"><span style="color:#e1e4e8">                                    fn.</span><span style="color:#b392f0">applyAsLong</span><span style="color:#e1e4e8">(v, x))))</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">break</span><span style="color:#e1e4e8">; </span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"><span style="color:#e1e4e8">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6a737d">// 							x  			null 			false | true</span></span>
<span class="line"><span style="color:#d73a49">final</span><span style="color:#24292e"> </span><span style="color:#d73a49">void</span><span style="color:#24292e"> </span><span style="color:#6f42c1">longAccumulate</span><span style="color:#24292e">(</span><span style="color:#d73a49">long</span><span style="color:#24292e"> x, LongBinaryOperator fn, </span><span style="color:#d73a49">boolean</span><span style="color:#24292e"> wasUncontended) {</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">int</span><span style="color:#24292e"> h;</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">// 当前线程还没有对应的 cell, 需要随机生成一个 hash 值用来将当前线程绑定到 cell</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">if</span><span style="color:#24292e"> ((h </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#6f42c1">getProbe</span><span style="color:#24292e">()) </span><span style="color:#d73a49">==</span><span style="color:#24292e"> </span><span style="color:#005cc5">0</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6a737d">// 初始化 probe，获取 hash 值</span></span>
<span class="line"><span style="color:#24292e">        ThreadLocalRandom.</span><span style="color:#6f42c1">current</span><span style="color:#24292e">(); </span></span>
<span class="line"><span style="color:#24292e">        h </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#6f42c1">getProbe</span><span style="color:#24292e">();	</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6a737d">// 默认情况下 当前线程肯定是写入到了 cells[0] 位置，不把它当做一次真正的竞争</span></span>
<span class="line"><span style="color:#24292e">        wasUncontended </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#005cc5">true</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">// 表示【扩容意向】，false 一定不会扩容，true 可能会扩容</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">boolean</span><span style="color:#24292e"> collide </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#005cc5">false</span><span style="color:#24292e">; </span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">//自旋</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">for</span><span style="color:#24292e"> (;;) {</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6a737d">// as 表示cells引用，a 表示当前线程命中的 cell，n 表示 cells 数组长度，v 表示 期望值</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">Cell</span><span style="color:#24292e">[] as; Cell a; </span><span style="color:#d73a49">int</span><span style="color:#24292e"> n; </span><span style="color:#d73a49">long</span><span style="color:#24292e"> v;</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6a737d">// 【CASE1】: 表示 cells 已经初始化了，当前线程应该将数据写入到对应的 cell 中</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">if</span><span style="color:#24292e"> ((as </span><span style="color:#d73a49">=</span><span style="color:#24292e"> cells) </span><span style="color:#d73a49">!=</span><span style="color:#24292e"> </span><span style="color:#005cc5">null</span><span style="color:#24292e"> </span><span style="color:#d73a49">&amp;&amp;</span><span style="color:#24292e"> (n </span><span style="color:#d73a49">=</span><span style="color:#24292e"> as.length) </span><span style="color:#d73a49">&gt;</span><span style="color:#24292e"> </span><span style="color:#005cc5">0</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#6a737d">// CASE1.1: true 表示当前线程对应的索引下标的 Cell 为 null，需要创建 new Cell</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">if</span><span style="color:#24292e"> ((a </span><span style="color:#d73a49">=</span><span style="color:#24292e"> as[(n </span><span style="color:#d73a49">-</span><span style="color:#24292e"> </span><span style="color:#005cc5">1</span><span style="color:#24292e">) </span><span style="color:#d73a49">&amp;</span><span style="color:#24292e"> h]) </span><span style="color:#d73a49">==</span><span style="color:#24292e"> </span><span style="color:#005cc5">null</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#6a737d">// 判断 cellsBusy 是否被锁</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (cellsBusy </span><span style="color:#d73a49">==</span><span style="color:#24292e"> </span><span style="color:#005cc5">0</span><span style="color:#24292e">) {   </span></span>
<span class="line"><span style="color:#24292e">                    </span><span style="color:#6a737d">// 创建 cell, 初始累加值为 x</span></span>
<span class="line"><span style="color:#24292e">                    Cell r </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Cell</span><span style="color:#24292e">(x);  </span></span>
<span class="line"><span style="color:#24292e">                    </span><span style="color:#6a737d">// 加锁</span></span>
<span class="line"><span style="color:#24292e">                    </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (cellsBusy </span><span style="color:#d73a49">==</span><span style="color:#24292e"> </span><span style="color:#005cc5">0</span><span style="color:#24292e"> </span><span style="color:#d73a49">&amp;&amp;</span><span style="color:#24292e"> </span><span style="color:#6f42c1">casCellsBusy</span><span style="color:#24292e">()) {</span></span>
<span class="line"><span style="color:#24292e">                        </span><span style="color:#6a737d">// 创建成功标记，进入【创建 cell 逻辑】</span></span>
<span class="line"><span style="color:#24292e">                        </span><span style="color:#d73a49">boolean</span><span style="color:#24292e"> created </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#005cc5">false</span><span style="color:#24292e">;	</span></span>
<span class="line"><span style="color:#24292e">                        </span><span style="color:#d73a49">try</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">                            </span><span style="color:#d73a49">Cell</span><span style="color:#24292e">[] rs; </span><span style="color:#d73a49">int</span><span style="color:#24292e"> m, j;</span></span>
<span class="line"><span style="color:#24292e">                            </span><span style="color:#6a737d">// 把当前 cells 数组赋值给 rs，并且不为 null</span></span>
<span class="line"><span style="color:#24292e">                            </span><span style="color:#d73a49">if</span><span style="color:#24292e"> ((rs </span><span style="color:#d73a49">=</span><span style="color:#24292e"> cells) </span><span style="color:#d73a49">!=</span><span style="color:#24292e"> </span><span style="color:#005cc5">null</span><span style="color:#24292e"> </span><span style="color:#d73a49">&amp;&amp;</span></span>
<span class="line"><span style="color:#24292e">                                (m </span><span style="color:#d73a49">=</span><span style="color:#24292e"> rs.length) </span><span style="color:#d73a49">&gt;</span><span style="color:#24292e"> </span><span style="color:#005cc5">0</span><span style="color:#24292e"> </span><span style="color:#d73a49">&amp;&amp;</span></span>
<span class="line"><span style="color:#24292e">                                </span><span style="color:#6a737d">// 再次判断防止其它线程初始化过该位置，当前线程再次初始化该位置会造成数据丢失</span></span>
<span class="line"><span style="color:#24292e">                                </span><span style="color:#6a737d">// 因为这里是线程安全的判断，进行的逻辑不会被其他线程影响</span></span>
<span class="line"><span style="color:#24292e">                                rs[j </span><span style="color:#d73a49">=</span><span style="color:#24292e"> (m </span><span style="color:#d73a49">-</span><span style="color:#24292e"> </span><span style="color:#005cc5">1</span><span style="color:#24292e">) </span><span style="color:#d73a49">&amp;</span><span style="color:#24292e"> h] </span><span style="color:#d73a49">==</span><span style="color:#24292e"> </span><span style="color:#005cc5">null</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">                                </span><span style="color:#6a737d">// 把新创建的 cell 填充至当前位置</span></span>
<span class="line"><span style="color:#24292e">                                rs[j] </span><span style="color:#d73a49">=</span><span style="color:#24292e"> r;</span></span>
<span class="line"><span style="color:#24292e">                                created </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#005cc5">true</span><span style="color:#24292e">;	</span><span style="color:#6a737d">// 表示创建完成</span></span>
<span class="line"><span style="color:#24292e">                            }</span></span>
<span class="line"><span style="color:#24292e">                        } </span><span style="color:#d73a49">finally</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">                            cellsBusy </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#005cc5">0</span><span style="color:#24292e">;		</span><span style="color:#6a737d">// 解锁</span></span>
<span class="line"><span style="color:#24292e">                        }</span></span>
<span class="line"><span style="color:#24292e">                        </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (created)			</span><span style="color:#6a737d">// true 表示创建完成，可以推出循环了</span></span>
<span class="line"><span style="color:#24292e">                            </span><span style="color:#d73a49">break</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">                        </span><span style="color:#d73a49">continue</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">                    }</span></span>
<span class="line"><span style="color:#24292e">                }</span></span>
<span class="line"><span style="color:#24292e">                collide </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#005cc5">false</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">            }</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#6a737d">// CASE1.2: 条件成立说明线程对应的 cell 有竞争, 改变线程对应的 cell 来重试 cas</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">else</span><span style="color:#24292e"> </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (</span><span style="color:#d73a49">!</span><span style="color:#24292e">wasUncontended)</span></span>
<span class="line"><span style="color:#24292e">                wasUncontended </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#005cc5">true</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#6a737d">// CASE 1.3: 当前线程 rehash 过，如果新命中的 cell 不为空，就尝试累加，false 说明新命中也有竞争</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">else</span><span style="color:#24292e"> </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (a.</span><span style="color:#6f42c1">cas</span><span style="color:#24292e">(v </span><span style="color:#d73a49">=</span><span style="color:#24292e"> a.value, ((fn </span><span style="color:#d73a49">==</span><span style="color:#24292e"> </span><span style="color:#005cc5">null</span><span style="color:#24292e">) </span><span style="color:#d73a49">?</span><span style="color:#24292e"> v </span><span style="color:#d73a49">+</span><span style="color:#24292e"> x </span><span style="color:#d73a49">:</span><span style="color:#24292e"> fn.</span><span style="color:#6f42c1">applyAsLong</span><span style="color:#24292e">(v, x))))</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#d73a49">break</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#6a737d">// CASE 1.4: cells 长度已经超过了最大长度 CPU 内核的数量或者已经扩容</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">else</span><span style="color:#24292e"> </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (n </span><span style="color:#d73a49">&gt;=</span><span style="color:#24292e"> NCPU </span><span style="color:#d73a49">||</span><span style="color:#24292e"> cells </span><span style="color:#d73a49">!=</span><span style="color:#24292e"> as)</span></span>
<span class="line"><span style="color:#24292e">                collide </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#005cc5">false</span><span style="color:#24292e">; 		</span><span style="color:#6a737d">// 扩容意向改为false，【表示不能扩容了】</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#6a737d">// CASE 1.5: 更改扩容意向，如果 n &gt;= NCPU，这里就永远不会执行到，case1.4 永远先于 1.5 执行</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">else</span><span style="color:#24292e"> </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (</span><span style="color:#d73a49">!</span><span style="color:#24292e">collide)</span></span>
<span class="line"><span style="color:#24292e">                collide </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#005cc5">true</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#6a737d">// CASE 1.6: 【扩容逻辑】，进行加锁</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">else</span><span style="color:#24292e"> </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (cellsBusy </span><span style="color:#d73a49">==</span><span style="color:#24292e"> </span><span style="color:#005cc5">0</span><span style="color:#24292e"> </span><span style="color:#d73a49">&amp;&amp;</span><span style="color:#24292e"> </span><span style="color:#6f42c1">casCellsBusy</span><span style="color:#24292e">()) {</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#d73a49">try</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">                    </span><span style="color:#6a737d">// 线程安全的检查，防止期间被其他线程扩容了</span></span>
<span class="line"><span style="color:#24292e">                    </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (cells </span><span style="color:#d73a49">==</span><span style="color:#24292e"> as) {     </span></span>
<span class="line"><span style="color:#24292e">                        </span><span style="color:#6a737d">// 扩容为以前的 2 倍</span></span>
<span class="line"><span style="color:#24292e">                        </span><span style="color:#d73a49">Cell</span><span style="color:#24292e">[] rs </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#d73a49">Cell</span><span style="color:#24292e">[n </span><span style="color:#d73a49">&lt;&lt;</span><span style="color:#24292e"> </span><span style="color:#005cc5">1</span><span style="color:#24292e">];</span></span>
<span class="line"><span style="color:#24292e">                        </span><span style="color:#6a737d">// 遍历移动值</span></span>
<span class="line"><span style="color:#24292e">                        </span><span style="color:#d73a49">for</span><span style="color:#24292e"> (</span><span style="color:#d73a49">int</span><span style="color:#24292e"> i </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#005cc5">0</span><span style="color:#24292e">; i </span><span style="color:#d73a49">&lt;</span><span style="color:#24292e"> n; </span><span style="color:#d73a49">++</span><span style="color:#24292e">i)</span></span>
<span class="line"><span style="color:#24292e">                            rs[i] </span><span style="color:#d73a49">=</span><span style="color:#24292e"> as[i];</span></span>
<span class="line"><span style="color:#24292e">                        </span><span style="color:#6a737d">// 把扩容后的引用给 cells</span></span>
<span class="line"><span style="color:#24292e">                        cells </span><span style="color:#d73a49">=</span><span style="color:#24292e"> rs;</span></span>
<span class="line"><span style="color:#24292e">                    }</span></span>
<span class="line"><span style="color:#24292e">                } </span><span style="color:#d73a49">finally</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">                    cellsBusy </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#005cc5">0</span><span style="color:#24292e">;	</span><span style="color:#6a737d">// 解锁</span></span>
<span class="line"><span style="color:#24292e">                }</span></span>
<span class="line"><span style="color:#24292e">                collide </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#005cc5">false</span><span style="color:#24292e">;	</span><span style="color:#6a737d">// 扩容意向改为 false，表示不扩容了</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#d73a49">continue</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">            }</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#6a737d">// 重置当前线程 Hash 值，这就是【分段迁移机制】</span></span>
<span class="line"><span style="color:#24292e">            h </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#6f42c1">advanceProbe</span><span style="color:#24292e">(h);</span></span>
<span class="line"><span style="color:#24292e">        }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6a737d">// 【CASE2】: 运行到这说明 cells 还未初始化，as 为null</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6a737d">// 判断是否没有加锁，没有加锁就用 CAS 加锁</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6a737d">// 条件二判断是否其它线程在当前线程给 as 赋值之后修改了 cells，这里不是线程安全的判断</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">else</span><span style="color:#24292e"> </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (cellsBusy </span><span style="color:#d73a49">==</span><span style="color:#24292e"> </span><span style="color:#005cc5">0</span><span style="color:#24292e"> </span><span style="color:#d73a49">&amp;&amp;</span><span style="color:#24292e"> cells </span><span style="color:#d73a49">==</span><span style="color:#24292e"> as </span><span style="color:#d73a49">&amp;&amp;</span><span style="color:#24292e"> </span><span style="color:#6f42c1">casCellsBusy</span><span style="color:#24292e">()) {</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#6a737d">// 初始化标志，开始 【初始化 cells 数组】</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">boolean</span><span style="color:#24292e"> init </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#005cc5">false</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">try</span><span style="color:#24292e"> { </span></span>
<span class="line"><span style="color:#24292e">               	</span><span style="color:#6a737d">// 再次判断 cells == as 防止其它线程已经提前初始化了，当前线程再次初始化导致丢失数据</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#6a737d">// 因为这里是【线程安全的，重新检查，经典 DCL】</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (cells </span><span style="color:#d73a49">==</span><span style="color:#24292e"> as) {</span></span>
<span class="line"><span style="color:#24292e">                    </span><span style="color:#d73a49">Cell</span><span style="color:#24292e">[] rs </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#d73a49">Cell</span><span style="color:#24292e">[</span><span style="color:#005cc5">2</span><span style="color:#24292e">];	</span><span style="color:#6a737d">// 初始化数组大小为2</span></span>
<span class="line"><span style="color:#24292e">                    rs[h </span><span style="color:#d73a49">&amp;</span><span style="color:#24292e"> </span><span style="color:#005cc5">1</span><span style="color:#24292e">] </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Cell</span><span style="color:#24292e">(x);	</span><span style="color:#6a737d">// 填充线程对应的cell</span></span>
<span class="line"><span style="color:#24292e">                    cells </span><span style="color:#d73a49">=</span><span style="color:#24292e"> rs;</span></span>
<span class="line"><span style="color:#24292e">                    init </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#005cc5">true</span><span style="color:#24292e">;				</span><span style="color:#6a737d">// 初始化成功，标记置为 true</span></span>
<span class="line"><span style="color:#24292e">                }</span></span>
<span class="line"><span style="color:#24292e">            } </span><span style="color:#d73a49">finally</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">                cellsBusy </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#005cc5">0</span><span style="color:#24292e">;					</span><span style="color:#6a737d">// 解锁</span></span>
<span class="line"><span style="color:#24292e">            }</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (init)</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#d73a49">break</span><span style="color:#24292e">;							</span><span style="color:#6a737d">// 初始化成功直接跳出自旋</span></span>
<span class="line"><span style="color:#24292e">        }</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6a737d">// 【CASE3】: 运行到这说明其他线程在初始化 cells，当前线程将值累加到 base，累加成功直接结束自旋</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">else</span><span style="color:#24292e"> </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (</span><span style="color:#6f42c1">casBase</span><span style="color:#24292e">(v </span><span style="color:#d73a49">=</span><span style="color:#24292e"> base, ((fn </span><span style="color:#d73a49">==</span><span style="color:#24292e"> </span><span style="color:#005cc5">null</span><span style="color:#24292e">) </span><span style="color:#d73a49">?</span><span style="color:#24292e"> v </span><span style="color:#d73a49">+</span><span style="color:#24292e"> x </span><span style="color:#d73a49">:</span></span>
<span class="line"><span style="color:#24292e">                                    fn.</span><span style="color:#6f42c1">applyAsLong</span><span style="color:#24292e">(v, x))))</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">break</span><span style="color:#24292e">; </span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"><span style="color:#24292e">}</span></span></code></pre><button class="collapse"></button></div></li><li><p>sum：获取最终结果通过 sum 整合，<strong>保证最终一致性，不保证强一致性</strong></p><div style="max-height:300px" class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">long</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">sum</span><span style="color:#e1e4e8">() {</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">Cell</span><span style="color:#e1e4e8">[] as </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> cells; Cell a;</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">long</span><span style="color:#e1e4e8"> sum </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> base;</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (as </span><span style="color:#f97583">!=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#6a737d">// 遍历 累加</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">for</span><span style="color:#e1e4e8"> (</span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> i </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8">; i </span><span style="color:#f97583">&lt;</span><span style="color:#e1e4e8"> as.length; </span><span style="color:#f97583">++</span><span style="color:#e1e4e8">i) {</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> ((a </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> as[i]) </span><span style="color:#f97583">!=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8">)</span></span>
<span class="line"><span style="color:#e1e4e8">                sum </span><span style="color:#f97583">+=</span><span style="color:#e1e4e8"> a.value;</span></span>
<span class="line"><span style="color:#e1e4e8">        }</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> sum;</span></span>
<span class="line"><span style="color:#e1e4e8">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">long</span><span style="color:#24292e"> </span><span style="color:#6f42c1">sum</span><span style="color:#24292e">() {</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">Cell</span><span style="color:#24292e">[] as </span><span style="color:#d73a49">=</span><span style="color:#24292e"> cells; Cell a;</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">long</span><span style="color:#24292e"> sum </span><span style="color:#d73a49">=</span><span style="color:#24292e"> base;</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (as </span><span style="color:#d73a49">!=</span><span style="color:#24292e"> </span><span style="color:#005cc5">null</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6a737d">// 遍历 累加</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">for</span><span style="color:#24292e"> (</span><span style="color:#d73a49">int</span><span style="color:#24292e"> i </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#005cc5">0</span><span style="color:#24292e">; i </span><span style="color:#d73a49">&lt;</span><span style="color:#24292e"> as.length; </span><span style="color:#d73a49">++</span><span style="color:#24292e">i) {</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">if</span><span style="color:#24292e"> ((a </span><span style="color:#d73a49">=</span><span style="color:#24292e"> as[i]) </span><span style="color:#d73a49">!=</span><span style="color:#24292e"> </span><span style="color:#005cc5">null</span><span style="color:#24292e">)</span></span>
<span class="line"><span style="color:#24292e">                sum </span><span style="color:#d73a49">+=</span><span style="color:#24292e"> a.value;</span></span>
<span class="line"><span style="color:#24292e">        }</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">return</span><span style="color:#24292e"> sum;</span></span>
<span class="line"><span style="color:#24292e">}</span></span></code></pre><button class="collapse"></button></div></li></ul><hr><h3 id="aba" tabindex="-1">ABA <a aria-current="page" href="/posts/concurrent_programming_compilation_version-lock_free#aba" class="router-link-active router-link-exact-active header-anchor" aria-label="Permalink to &quot;ABA&quot;"><!--[-->​<!--]--></a></h3><p>ABA 问题：当进行获取主内存值时，该内存值在写入主内存时已经被修改了 N 次，但是最终又改成原来的值</p><p>其他线程先把 A 改成 B 又改回 A，主线程<strong>仅能判断出共享变量的值与最初值 A 是否相同</strong>，不能感知到这种从 A 改为 B 又 改回 A 的情况，这时 CAS 虽然成功，但是过程存在问题</p><h4 id="atomicstampedreference" tabindex="-1"><strong>AtomicStampedReference</strong> <a aria-current="page" href="/posts/concurrent_programming_compilation_version-lock_free#atomicstampedreference" class="router-link-active router-link-exact-active header-anchor" aria-label="Permalink to &quot;**AtomicStampedReference**&quot;"><!--[-->​<!--]--></a></h4><ul><li><p>构造方法：</p><ul><li><code>public AtomicStampedReference(V initialRef, int initialStamp)</code>：初始值和初始版本号</li></ul></li><li><p>常用API：</p><ul><li><code>public boolean compareAndSet(V expectedReference, V newReference, int expectedStamp, int newStamp)</code>：<strong>期望引用和期望版本号都一致</strong>才进行 CAS 修改数据</li><li><code>public void set(V newReference, int newStamp)</code>：设置值和版本号</li><li><code>public V getReference()</code>：返回引用的值</li><li><code>public int getStamp()</code>：返回当前版本号</li></ul></li></ul><div style="max-height:300px" class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">static</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">void</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">main</span><span style="color:#e1e4e8">(</span><span style="color:#f97583">String</span><span style="color:#e1e4e8">[] args) {</span></span>
<span class="line"><span style="color:#e1e4e8">    AtomicStampedReference&lt;</span><span style="color:#f97583">Integer</span><span style="color:#e1e4e8">&gt; atomicReference </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> AtomicStampedReference&lt;&gt;(</span><span style="color:#79b8ff">100</span><span style="color:#e1e4e8">,</span><span style="color:#79b8ff">1</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> startStamp </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> atomicReference.</span><span style="color:#b392f0">getStamp</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Thread</span><span style="color:#e1e4e8">(() </span><span style="color:#f97583">-&gt;</span><span style="color:#e1e4e8">{</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> stamp </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> atomicReference.</span><span style="color:#b392f0">getStamp</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">        atomicReference.</span><span style="color:#b392f0">compareAndSet</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">100</span><span style="color:#e1e4e8">, </span><span style="color:#79b8ff">101</span><span style="color:#e1e4e8">, stamp, stamp </span><span style="color:#f97583">+</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">1</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">        stamp </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> atomicReference.</span><span style="color:#b392f0">getStamp</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">        atomicReference.</span><span style="color:#b392f0">compareAndSet</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">101</span><span style="color:#e1e4e8">, </span><span style="color:#79b8ff">100</span><span style="color:#e1e4e8">, stamp, stamp </span><span style="color:#f97583">+</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">1</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">    },</span><span style="color:#9ecbff">"t1"</span><span style="color:#e1e4e8">).</span><span style="color:#b392f0">start</span><span style="color:#e1e4e8">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Thread</span><span style="color:#e1e4e8">(() </span><span style="color:#f97583">-&gt;</span><span style="color:#e1e4e8">{</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">try</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">            Thread.</span><span style="color:#b392f0">sleep</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">1000</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">        } </span><span style="color:#f97583">catch</span><span style="color:#e1e4e8"> (InterruptedException </span><span style="color:#ffab70">e</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">            e.</span><span style="color:#b392f0">printStackTrace</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">        }</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (</span><span style="color:#f97583">!</span><span style="color:#e1e4e8">atomicReference.</span><span style="color:#b392f0">compareAndSet</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">100</span><span style="color:#e1e4e8">, </span><span style="color:#79b8ff">200</span><span style="color:#e1e4e8">, startStamp, startStamp </span><span style="color:#f97583">+</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">1</span><span style="color:#e1e4e8">)) {</span></span>
<span class="line"><span style="color:#e1e4e8">            System.out.</span><span style="color:#b392f0">println</span><span style="color:#e1e4e8">(atomicReference.</span><span style="color:#b392f0">getReference</span><span style="color:#e1e4e8">());</span><span style="color:#6a737d">//100</span></span>
<span class="line"><span style="color:#e1e4e8">            System.out.</span><span style="color:#b392f0">println</span><span style="color:#e1e4e8">(Thread.</span><span style="color:#b392f0">currentThread</span><span style="color:#e1e4e8">().</span><span style="color:#b392f0">getName</span><span style="color:#e1e4e8">() </span><span style="color:#f97583">+</span><span style="color:#e1e4e8"> </span><span style="color:#9ecbff">"线程修改失败"</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">        }</span></span>
<span class="line"><span style="color:#e1e4e8">    },</span><span style="color:#9ecbff">"t2"</span><span style="color:#e1e4e8">).</span><span style="color:#b392f0">start</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">static</span><span style="color:#24292e"> </span><span style="color:#d73a49">void</span><span style="color:#24292e"> </span><span style="color:#6f42c1">main</span><span style="color:#24292e">(</span><span style="color:#d73a49">String</span><span style="color:#24292e">[] args) {</span></span>
<span class="line"><span style="color:#24292e">    AtomicStampedReference&lt;</span><span style="color:#d73a49">Integer</span><span style="color:#24292e">&gt; atomicReference </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> AtomicStampedReference&lt;&gt;(</span><span style="color:#005cc5">100</span><span style="color:#24292e">,</span><span style="color:#005cc5">1</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">int</span><span style="color:#24292e"> startStamp </span><span style="color:#d73a49">=</span><span style="color:#24292e"> atomicReference.</span><span style="color:#6f42c1">getStamp</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Thread</span><span style="color:#24292e">(() </span><span style="color:#d73a49">-&gt;</span><span style="color:#24292e">{</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">int</span><span style="color:#24292e"> stamp </span><span style="color:#d73a49">=</span><span style="color:#24292e"> atomicReference.</span><span style="color:#6f42c1">getStamp</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">        atomicReference.</span><span style="color:#6f42c1">compareAndSet</span><span style="color:#24292e">(</span><span style="color:#005cc5">100</span><span style="color:#24292e">, </span><span style="color:#005cc5">101</span><span style="color:#24292e">, stamp, stamp </span><span style="color:#d73a49">+</span><span style="color:#24292e"> </span><span style="color:#005cc5">1</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">        stamp </span><span style="color:#d73a49">=</span><span style="color:#24292e"> atomicReference.</span><span style="color:#6f42c1">getStamp</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">        atomicReference.</span><span style="color:#6f42c1">compareAndSet</span><span style="color:#24292e">(</span><span style="color:#005cc5">101</span><span style="color:#24292e">, </span><span style="color:#005cc5">100</span><span style="color:#24292e">, stamp, stamp </span><span style="color:#d73a49">+</span><span style="color:#24292e"> </span><span style="color:#005cc5">1</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">    },</span><span style="color:#032f62">"t1"</span><span style="color:#24292e">).</span><span style="color:#6f42c1">start</span><span style="color:#24292e">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Thread</span><span style="color:#24292e">(() </span><span style="color:#d73a49">-&gt;</span><span style="color:#24292e">{</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">try</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">            Thread.</span><span style="color:#6f42c1">sleep</span><span style="color:#24292e">(</span><span style="color:#005cc5">1000</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">        } </span><span style="color:#d73a49">catch</span><span style="color:#24292e"> (InterruptedException </span><span style="color:#e36209">e</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">            e.</span><span style="color:#6f42c1">printStackTrace</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">        }</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (</span><span style="color:#d73a49">!</span><span style="color:#24292e">atomicReference.</span><span style="color:#6f42c1">compareAndSet</span><span style="color:#24292e">(</span><span style="color:#005cc5">100</span><span style="color:#24292e">, </span><span style="color:#005cc5">200</span><span style="color:#24292e">, startStamp, startStamp </span><span style="color:#d73a49">+</span><span style="color:#24292e"> </span><span style="color:#005cc5">1</span><span style="color:#24292e">)) {</span></span>
<span class="line"><span style="color:#24292e">            System.out.</span><span style="color:#6f42c1">println</span><span style="color:#24292e">(atomicReference.</span><span style="color:#6f42c1">getReference</span><span style="color:#24292e">());</span><span style="color:#6a737d">//100</span></span>
<span class="line"><span style="color:#24292e">            System.out.</span><span style="color:#6f42c1">println</span><span style="color:#24292e">(Thread.</span><span style="color:#6f42c1">currentThread</span><span style="color:#24292e">().</span><span style="color:#6f42c1">getName</span><span style="color:#24292e">() </span><span style="color:#d73a49">+</span><span style="color:#24292e"> </span><span style="color:#032f62">"线程修改失败"</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">        }</span></span>
<span class="line"><span style="color:#24292e">    },</span><span style="color:#032f62">"t2"</span><span style="color:#24292e">).</span><span style="color:#6f42c1">start</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">}</span></span></code></pre><button class="collapse"></button></div><hr><h4 id="atomicmarkablereference" tabindex="-1">AtomicMarkableReference <a aria-current="page" href="/posts/concurrent_programming_compilation_version-lock_free#atomicmarkablereference" class="router-link-active router-link-exact-active header-anchor" aria-label="Permalink to &quot;AtomicMarkableReference&quot;"><!--[-->​<!--]--></a></h4><p>AtomicStampedReference 可以给原子引用加上版本号，追踪原子引用整个的变化过程，如： A -&gt; B -&gt; A -&gt; C ，通过AtomicStampedReference，我们可以知道，引用变量中途被更改了几次。 但是有时候，并不关心引用变量更改了几次，只是单纯的关心<strong>是否更改过</strong>，所以就有了 <strong>AtomicMarkableReference</strong></p><figure><img alt="image-20230714183156551" class="lazy" data-src="https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230714183156551.png"></figure><div style="max-height:300px" class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8">@</span><span style="color:#f97583">Slf4j</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">topic</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#9ecbff">"c.Test38"</span><span style="color:#e1e4e8">)</span></span>
<span class="line"><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">class</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Test38</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">static</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">void</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">main</span><span style="color:#e1e4e8">(</span><span style="color:#f97583">String</span><span style="color:#e1e4e8">[] </span><span style="color:#ffab70">args</span><span style="color:#e1e4e8">) </span><span style="color:#f97583">throws</span><span style="color:#e1e4e8"> InterruptedException {</span></span>
<span class="line"><span style="color:#e1e4e8">        GarbageBag bag </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">GarbageBag</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"装满了垃圾"</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#6a737d">// 参数2 mark 可以看作一个标记，表示垃圾袋满了</span></span>
<span class="line"><span style="color:#e1e4e8">        AtomicMarkableReference&lt;</span><span style="color:#f97583">GarbageBag</span><span style="color:#e1e4e8">&gt; ref </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> AtomicMarkableReference&lt;&gt;(bag, </span><span style="color:#79b8ff">true</span><span style="color:#e1e4e8">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">        log.</span><span style="color:#b392f0">debug</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"start..."</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">        GarbageBag prev </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> ref.</span><span style="color:#b392f0">getReference</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">        log.</span><span style="color:#b392f0">debug</span><span style="color:#e1e4e8">(prev.</span><span style="color:#b392f0">toString</span><span style="color:#e1e4e8">());</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Thread</span><span style="color:#e1e4e8">(() </span><span style="color:#f97583">-&gt;</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">            log.</span><span style="color:#b392f0">debug</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"start..."</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">            bag.</span><span style="color:#b392f0">setDesc</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"空垃圾袋"</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">            ref.</span><span style="color:#b392f0">compareAndSet</span><span style="color:#e1e4e8">(bag, bag, </span><span style="color:#79b8ff">true</span><span style="color:#e1e4e8">, </span><span style="color:#79b8ff">false</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">            log.</span><span style="color:#b392f0">debug</span><span style="color:#e1e4e8">(bag.</span><span style="color:#b392f0">toString</span><span style="color:#e1e4e8">());</span></span>
<span class="line"><span style="color:#e1e4e8">        },</span><span style="color:#9ecbff">"保洁阿姨"</span><span style="color:#e1e4e8">).</span><span style="color:#b392f0">start</span><span style="color:#e1e4e8">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#b392f0">sleep</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">1</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">        log.</span><span style="color:#b392f0">debug</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"想换一只新垃圾袋？"</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">boolean</span><span style="color:#e1e4e8"> success </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> ref.</span><span style="color:#b392f0">compareAndSet</span><span style="color:#e1e4e8">(prev, </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">GarbageBag</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"空垃圾袋"</span><span style="color:#e1e4e8">), </span><span style="color:#79b8ff">true</span><span style="color:#e1e4e8">, </span><span style="color:#79b8ff">false</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">        log.</span><span style="color:#b392f0">debug</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"换了么？"</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">+</span><span style="color:#e1e4e8"> success);</span></span>
<span class="line"><span style="color:#e1e4e8">        log.</span><span style="color:#b392f0">debug</span><span style="color:#e1e4e8">(ref.</span><span style="color:#b392f0">getReference</span><span style="color:#e1e4e8">().</span><span style="color:#b392f0">toString</span><span style="color:#e1e4e8">());</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"><span style="color:#e1e4e8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#f97583">class</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">GarbageBag</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">    String desc;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">GarbageBag</span><span style="color:#e1e4e8">(String </span><span style="color:#ffab70">desc</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#79b8ff">this</span><span style="color:#e1e4e8">.desc </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> desc;</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">void</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">setDesc</span><span style="color:#e1e4e8">(String </span><span style="color:#ffab70">desc</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#79b8ff">this</span><span style="color:#e1e4e8">.desc </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> desc;</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">    @</span><span style="color:#f97583">Override</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">public</span><span style="color:#e1e4e8"> String </span><span style="color:#b392f0">toString</span><span style="color:#e1e4e8">() {</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">super</span><span style="color:#e1e4e8">.</span><span style="color:#b392f0">toString</span><span style="color:#e1e4e8">() </span><span style="color:#f97583">+</span><span style="color:#e1e4e8"> </span><span style="color:#9ecbff">" "</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">+</span><span style="color:#e1e4e8"> desc;</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"><span style="color:#e1e4e8">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e">@</span><span style="color:#d73a49">Slf4j</span><span style="color:#24292e">(</span><span style="color:#005cc5">topic</span><span style="color:#24292e"> </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#032f62">"c.Test38"</span><span style="color:#24292e">)</span></span>
<span class="line"><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">class</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Test38</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">static</span><span style="color:#24292e"> </span><span style="color:#d73a49">void</span><span style="color:#24292e"> </span><span style="color:#6f42c1">main</span><span style="color:#24292e">(</span><span style="color:#d73a49">String</span><span style="color:#24292e">[] </span><span style="color:#e36209">args</span><span style="color:#24292e">) </span><span style="color:#d73a49">throws</span><span style="color:#24292e"> InterruptedException {</span></span>
<span class="line"><span style="color:#24292e">        GarbageBag bag </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">GarbageBag</span><span style="color:#24292e">(</span><span style="color:#032f62">"装满了垃圾"</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6a737d">// 参数2 mark 可以看作一个标记，表示垃圾袋满了</span></span>
<span class="line"><span style="color:#24292e">        AtomicMarkableReference&lt;</span><span style="color:#d73a49">GarbageBag</span><span style="color:#24292e">&gt; ref </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> AtomicMarkableReference&lt;&gt;(bag, </span><span style="color:#005cc5">true</span><span style="color:#24292e">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">        log.</span><span style="color:#6f42c1">debug</span><span style="color:#24292e">(</span><span style="color:#032f62">"start..."</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">        GarbageBag prev </span><span style="color:#d73a49">=</span><span style="color:#24292e"> ref.</span><span style="color:#6f42c1">getReference</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">        log.</span><span style="color:#6f42c1">debug</span><span style="color:#24292e">(prev.</span><span style="color:#6f42c1">toString</span><span style="color:#24292e">());</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Thread</span><span style="color:#24292e">(() </span><span style="color:#d73a49">-&gt;</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">            log.</span><span style="color:#6f42c1">debug</span><span style="color:#24292e">(</span><span style="color:#032f62">"start..."</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">            bag.</span><span style="color:#6f42c1">setDesc</span><span style="color:#24292e">(</span><span style="color:#032f62">"空垃圾袋"</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">            ref.</span><span style="color:#6f42c1">compareAndSet</span><span style="color:#24292e">(bag, bag, </span><span style="color:#005cc5">true</span><span style="color:#24292e">, </span><span style="color:#005cc5">false</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">            log.</span><span style="color:#6f42c1">debug</span><span style="color:#24292e">(bag.</span><span style="color:#6f42c1">toString</span><span style="color:#24292e">());</span></span>
<span class="line"><span style="color:#24292e">        },</span><span style="color:#032f62">"保洁阿姨"</span><span style="color:#24292e">).</span><span style="color:#6f42c1">start</span><span style="color:#24292e">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6f42c1">sleep</span><span style="color:#24292e">(</span><span style="color:#005cc5">1</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">        log.</span><span style="color:#6f42c1">debug</span><span style="color:#24292e">(</span><span style="color:#032f62">"想换一只新垃圾袋？"</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">boolean</span><span style="color:#24292e"> success </span><span style="color:#d73a49">=</span><span style="color:#24292e"> ref.</span><span style="color:#6f42c1">compareAndSet</span><span style="color:#24292e">(prev, </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">GarbageBag</span><span style="color:#24292e">(</span><span style="color:#032f62">"空垃圾袋"</span><span style="color:#24292e">), </span><span style="color:#005cc5">true</span><span style="color:#24292e">, </span><span style="color:#005cc5">false</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">        log.</span><span style="color:#6f42c1">debug</span><span style="color:#24292e">(</span><span style="color:#032f62">"换了么？"</span><span style="color:#24292e"> </span><span style="color:#d73a49">+</span><span style="color:#24292e"> success);</span></span>
<span class="line"><span style="color:#24292e">        log.</span><span style="color:#6f42c1">debug</span><span style="color:#24292e">(ref.</span><span style="color:#6f42c1">getReference</span><span style="color:#24292e">().</span><span style="color:#6f42c1">toString</span><span style="color:#24292e">());</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"><span style="color:#24292e">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#d73a49">class</span><span style="color:#24292e"> </span><span style="color:#6f42c1">GarbageBag</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">    String desc;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#6f42c1">GarbageBag</span><span style="color:#24292e">(String </span><span style="color:#e36209">desc</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#005cc5">this</span><span style="color:#24292e">.desc </span><span style="color:#d73a49">=</span><span style="color:#24292e"> desc;</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">void</span><span style="color:#24292e"> </span><span style="color:#6f42c1">setDesc</span><span style="color:#24292e">(String </span><span style="color:#e36209">desc</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#005cc5">this</span><span style="color:#24292e">.desc </span><span style="color:#d73a49">=</span><span style="color:#24292e"> desc;</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">    @</span><span style="color:#d73a49">Override</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">public</span><span style="color:#24292e"> String </span><span style="color:#6f42c1">toString</span><span style="color:#24292e">() {</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">return</span><span style="color:#24292e"> </span><span style="color:#005cc5">super</span><span style="color:#24292e">.</span><span style="color:#6f42c1">toString</span><span style="color:#24292e">() </span><span style="color:#d73a49">+</span><span style="color:#24292e"> </span><span style="color:#032f62">" "</span><span style="color:#24292e"> </span><span style="color:#d73a49">+</span><span style="color:#24292e"> desc;</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"><span style="color:#24292e">}</span></span></code></pre><button class="collapse"></button></div><figure><img alt="image-20230714183338108" class="lazy" data-src="https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230714183338108.png"></figure><hr><h4 id="两者的区别" tabindex="-1">两者的区别 <a aria-current="page" href="/posts/concurrent_programming_compilation_version-lock_free#两者的区别" class="router-link-active router-link-exact-active header-anchor" aria-label="Permalink to &quot;两者的区别&quot;"><!--[-->​<!--]--></a></h4><ul><li><strong>AtomicStampedReference</strong> 需要我们传入<strong>整型变量</strong>作为版本号，来判定是否被更改过</li><li><strong>AtomicMarkableReference</strong>需要我们传入<strong>布尔变量</strong>作为标记，来判断是否被更改过</li></ul><hr><h3 id="unsafe" tabindex="-1">Unsafe <a aria-current="page" href="/posts/concurrent_programming_compilation_version-lock_free#unsafe" class="router-link-active router-link-exact-active header-anchor" aria-label="Permalink to &quot;Unsafe&quot;"><!--[-->​<!--]--></a></h3><p>Unsafe 是 CAS 的核心类，由于 Java 无法直接访问底层系统，需要通过本地（Native）方法来访问</p><p>Unsafe 类存在 sun.misc 包，其中所有方法都是 native 修饰的，都是直接调用<strong>操作系统底层资源</strong>执行相应的任务，基于该类可以直接操作特定的内存数据，其内部方法操作类似 C 的指针</p><p>模拟实现原子整数：</p><div style="max-height:300px" class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">static</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">void</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">main</span><span style="color:#e1e4e8">(</span><span style="color:#f97583">String</span><span style="color:#e1e4e8">[] args) {</span></span>
<span class="line"><span style="color:#e1e4e8">    MyAtomicInteger atomicInteger </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">MyAtomicInteger</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">10</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (atomicInteger.</span><span style="color:#b392f0">compareAndSwap</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">20</span><span style="color:#e1e4e8">)) {</span></span>
<span class="line"><span style="color:#e1e4e8">        System.out.</span><span style="color:#b392f0">println</span><span style="color:#e1e4e8">(atomicInteger.</span><span style="color:#b392f0">getValue</span><span style="color:#e1e4e8">());</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"><span style="color:#e1e4e8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#f97583">class</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">MyAtomicInteger</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">private</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">static</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">final</span><span style="color:#e1e4e8"> Unsafe UNSAFE;</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">private</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">static</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">final</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">long</span><span style="color:#e1e4e8"> VALUE_OFFSET;</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">private</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">volatile</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> value;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">static</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">try</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#6a737d">//Unsafe unsafe = Unsafe.getUnsafe()这样会报错，需要反射获取</span></span>
<span class="line"><span style="color:#e1e4e8">            Field theUnsafe </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> Unsafe.class.</span><span style="color:#b392f0">getDeclaredField</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"theUnsafe"</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">            theUnsafe.</span><span style="color:#b392f0">setAccessible</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">true</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">            UNSAFE </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> (Unsafe) theUnsafe.</span><span style="color:#b392f0">get</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#6a737d">// 获取 value 属性的内存地址，value 属性指向该地址，直接设置该地址的值可以修改 value 的值</span></span>
<span class="line"><span style="color:#e1e4e8">            VALUE_OFFSET </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> UNSAFE.</span><span style="color:#b392f0">objectFieldOffset</span><span style="color:#e1e4e8">(</span></span>
<span class="line"><span style="color:#e1e4e8">                		   MyAtomicInteger.class.</span><span style="color:#b392f0">getDeclaredField</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"value"</span><span style="color:#e1e4e8">));</span></span>
<span class="line"><span style="color:#e1e4e8">        } </span><span style="color:#f97583">catch</span><span style="color:#e1e4e8"> (NoSuchFieldException | IllegalAccessException </span><span style="color:#ffab70">e</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">            e.</span><span style="color:#b392f0">printStackTrace</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">throw</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">RuntimeException</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">        }</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">MyAtomicInteger</span><span style="color:#e1e4e8">(</span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> </span><span style="color:#ffab70">value</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#79b8ff">this</span><span style="color:#e1e4e8">.value </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> value;</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">getValue</span><span style="color:#e1e4e8">() {</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> value;</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">boolean</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">compareAndSwap</span><span style="color:#e1e4e8">(</span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> </span><span style="color:#ffab70">update</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">while</span><span style="color:#e1e4e8"> (</span><span style="color:#79b8ff">true</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> prev </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">this</span><span style="color:#e1e4e8">.value;</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> next </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> update;</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#6a737d">//							当前对象  内存偏移量    期望值 更新值</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (UNSAFE.</span><span style="color:#b392f0">compareAndSwapInt</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">this</span><span style="color:#e1e4e8">, VALUE_OFFSET, prev, update)) {</span></span>
<span class="line"><span style="color:#e1e4e8">                System.out.</span><span style="color:#b392f0">println</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"CAS成功"</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">true</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">            }</span></span>
<span class="line"><span style="color:#e1e4e8">        }</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"><span style="color:#e1e4e8">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">static</span><span style="color:#24292e"> </span><span style="color:#d73a49">void</span><span style="color:#24292e"> </span><span style="color:#6f42c1">main</span><span style="color:#24292e">(</span><span style="color:#d73a49">String</span><span style="color:#24292e">[] args) {</span></span>
<span class="line"><span style="color:#24292e">    MyAtomicInteger atomicInteger </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">MyAtomicInteger</span><span style="color:#24292e">(</span><span style="color:#005cc5">10</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (atomicInteger.</span><span style="color:#6f42c1">compareAndSwap</span><span style="color:#24292e">(</span><span style="color:#005cc5">20</span><span style="color:#24292e">)) {</span></span>
<span class="line"><span style="color:#24292e">        System.out.</span><span style="color:#6f42c1">println</span><span style="color:#24292e">(atomicInteger.</span><span style="color:#6f42c1">getValue</span><span style="color:#24292e">());</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"><span style="color:#24292e">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#d73a49">class</span><span style="color:#24292e"> </span><span style="color:#6f42c1">MyAtomicInteger</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">private</span><span style="color:#24292e"> </span><span style="color:#d73a49">static</span><span style="color:#24292e"> </span><span style="color:#d73a49">final</span><span style="color:#24292e"> Unsafe UNSAFE;</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">private</span><span style="color:#24292e"> </span><span style="color:#d73a49">static</span><span style="color:#24292e"> </span><span style="color:#d73a49">final</span><span style="color:#24292e"> </span><span style="color:#d73a49">long</span><span style="color:#24292e"> VALUE_OFFSET;</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">private</span><span style="color:#24292e"> </span><span style="color:#d73a49">volatile</span><span style="color:#24292e"> </span><span style="color:#d73a49">int</span><span style="color:#24292e"> value;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">static</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">try</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#6a737d">//Unsafe unsafe = Unsafe.getUnsafe()这样会报错，需要反射获取</span></span>
<span class="line"><span style="color:#24292e">            Field theUnsafe </span><span style="color:#d73a49">=</span><span style="color:#24292e"> Unsafe.class.</span><span style="color:#6f42c1">getDeclaredField</span><span style="color:#24292e">(</span><span style="color:#032f62">"theUnsafe"</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">            theUnsafe.</span><span style="color:#6f42c1">setAccessible</span><span style="color:#24292e">(</span><span style="color:#005cc5">true</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">            UNSAFE </span><span style="color:#d73a49">=</span><span style="color:#24292e"> (Unsafe) theUnsafe.</span><span style="color:#6f42c1">get</span><span style="color:#24292e">(</span><span style="color:#005cc5">null</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#6a737d">// 获取 value 属性的内存地址，value 属性指向该地址，直接设置该地址的值可以修改 value 的值</span></span>
<span class="line"><span style="color:#24292e">            VALUE_OFFSET </span><span style="color:#d73a49">=</span><span style="color:#24292e"> UNSAFE.</span><span style="color:#6f42c1">objectFieldOffset</span><span style="color:#24292e">(</span></span>
<span class="line"><span style="color:#24292e">                		   MyAtomicInteger.class.</span><span style="color:#6f42c1">getDeclaredField</span><span style="color:#24292e">(</span><span style="color:#032f62">"value"</span><span style="color:#24292e">));</span></span>
<span class="line"><span style="color:#24292e">        } </span><span style="color:#d73a49">catch</span><span style="color:#24292e"> (NoSuchFieldException | IllegalAccessException </span><span style="color:#e36209">e</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">            e.</span><span style="color:#6f42c1">printStackTrace</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">throw</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">RuntimeException</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">        }</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#6f42c1">MyAtomicInteger</span><span style="color:#24292e">(</span><span style="color:#d73a49">int</span><span style="color:#24292e"> </span><span style="color:#e36209">value</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#005cc5">this</span><span style="color:#24292e">.value </span><span style="color:#d73a49">=</span><span style="color:#24292e"> value;</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">int</span><span style="color:#24292e"> </span><span style="color:#6f42c1">getValue</span><span style="color:#24292e">() {</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">return</span><span style="color:#24292e"> value;</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">boolean</span><span style="color:#24292e"> </span><span style="color:#6f42c1">compareAndSwap</span><span style="color:#24292e">(</span><span style="color:#d73a49">int</span><span style="color:#24292e"> </span><span style="color:#e36209">update</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">while</span><span style="color:#24292e"> (</span><span style="color:#005cc5">true</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">int</span><span style="color:#24292e"> prev </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#005cc5">this</span><span style="color:#24292e">.value;</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">int</span><span style="color:#24292e"> next </span><span style="color:#d73a49">=</span><span style="color:#24292e"> update;</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#6a737d">//							当前对象  内存偏移量    期望值 更新值</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (UNSAFE.</span><span style="color:#6f42c1">compareAndSwapInt</span><span style="color:#24292e">(</span><span style="color:#005cc5">this</span><span style="color:#24292e">, VALUE_OFFSET, prev, update)) {</span></span>
<span class="line"><span style="color:#24292e">                System.out.</span><span style="color:#6f42c1">println</span><span style="color:#24292e">(</span><span style="color:#032f62">"CAS成功"</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#d73a49">return</span><span style="color:#24292e"> </span><span style="color:#005cc5">true</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">            }</span></span>
<span class="line"><span style="color:#24292e">        }</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"><span style="color:#24292e">}</span></span></code></pre><button class="collapse"></button></div><hr><h3 id="final" tabindex="-1">final <a aria-current="page" href="/posts/concurrent_programming_compilation_version-lock_free#final" class="router-link-active router-link-exact-active header-anchor" aria-label="Permalink to &quot;final&quot;"><!--[-->​<!--]--></a></h3><h4 id="原理-1" tabindex="-1">原理 <a aria-current="page" href="/posts/concurrent_programming_compilation_version-lock_free#原理-1" class="router-link-active router-link-exact-active header-anchor" aria-label="Permalink to &quot;原理&quot;"><!--[-->​<!--]--></a></h4><div style="max-height:300px" class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">class</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">TestFinal</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">	</span><span style="color:#f97583">final</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> a </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">20</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">class</span><span style="color:#24292e"> </span><span style="color:#6f42c1">TestFinal</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">	</span><span style="color:#d73a49">final</span><span style="color:#24292e"> </span><span style="color:#d73a49">int</span><span style="color:#24292e"> a </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#005cc5">20</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">}</span></span></code></pre><button class="collapse"></button></div><p>字节码：</p><div style="max-height:300px" class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#79b8ff">0</span><span style="color:#f97583">:</span><span style="color:#e1e4e8"> aload_0</span></span>
<span class="line"><span style="color:#79b8ff">1</span><span style="color:#f97583">:</span><span style="color:#e1e4e8"> invokespecial #</span><span style="color:#79b8ff">1</span><span style="color:#e1e4e8"> </span><span style="color:#6a737d">// Method java/lang/Object."&lt;init&gt;":()V</span></span>
<span class="line"><span style="color:#79b8ff">4</span><span style="color:#f97583">:</span><span style="color:#e1e4e8"> aload_0</span></span>
<span class="line"><span style="color:#79b8ff">5</span><span style="color:#f97583">:</span><span style="color:#e1e4e8"> bipush </span><span style="color:#79b8ff">20</span><span style="color:#e1e4e8">		</span><span style="color:#6a737d">// 将值直接放入栈中</span></span>
<span class="line"><span style="color:#79b8ff">7</span><span style="color:#f97583">:</span><span style="color:#e1e4e8"> putfield #</span><span style="color:#79b8ff">2</span><span style="color:#e1e4e8"> 		</span><span style="color:#6a737d">// Field a:I</span></span>
<span class="line"><span style="color:#f97583">&lt;--</span><span style="color:#e1e4e8"> 写屏障</span></span>
<span class="line"><span style="color:#79b8ff">10</span><span style="color:#f97583">:</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">return</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#005cc5">0</span><span style="color:#d73a49">:</span><span style="color:#24292e"> aload_0</span></span>
<span class="line"><span style="color:#005cc5">1</span><span style="color:#d73a49">:</span><span style="color:#24292e"> invokespecial #</span><span style="color:#005cc5">1</span><span style="color:#24292e"> </span><span style="color:#6a737d">// Method java/lang/Object."&lt;init&gt;":()V</span></span>
<span class="line"><span style="color:#005cc5">4</span><span style="color:#d73a49">:</span><span style="color:#24292e"> aload_0</span></span>
<span class="line"><span style="color:#005cc5">5</span><span style="color:#d73a49">:</span><span style="color:#24292e"> bipush </span><span style="color:#005cc5">20</span><span style="color:#24292e">		</span><span style="color:#6a737d">// 将值直接放入栈中</span></span>
<span class="line"><span style="color:#005cc5">7</span><span style="color:#d73a49">:</span><span style="color:#24292e"> putfield #</span><span style="color:#005cc5">2</span><span style="color:#24292e"> 		</span><span style="color:#6a737d">// Field a:I</span></span>
<span class="line"><span style="color:#d73a49">&lt;--</span><span style="color:#24292e"> 写屏障</span></span>
<span class="line"><span style="color:#005cc5">10</span><span style="color:#d73a49">:</span><span style="color:#24292e"> </span><span style="color:#d73a49">return</span></span></code></pre><button class="collapse"></button></div><p>final 变量的赋值通过 putfield 指令来完成，在这条指令之后也会加入写屏障，保证在其它线程读到它的值时不会出现为 0 的情况</p><p>其他线程访问 final 修饰的变量<strong>会复制一份放入栈中</strong>，效率更高</p><hr><h4 id="不可变" tabindex="-1">不可变 <a aria-current="page" href="/posts/concurrent_programming_compilation_version-lock_free#不可变" class="router-link-active router-link-exact-active header-anchor" aria-label="Permalink to &quot;不可变&quot;"><!--[-->​<!--]--></a></h4><p>不可变：如果一个对象不能够修改其内部状态（属性），那么就是不可变对象</p><p>不可变对象线程安全的，不存在并发修改和可见性问题，是另一种避免竞争的方式</p><p>String 类也是不可变的，该类和类中所有属性都是 final 的</p><ul><li><p>类用 final 修饰保证了该类中的方法不能被覆盖，防止子类无意间破坏不可变性</p></li><li><p>无写入方法（set）确保外部不能对内部属性进行修改</p></li><li><p>属性用 final 修饰保证了该属性是只读的，不能修改</p><div style="max-height:300px" class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">final</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">class</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">String</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">implements</span><span style="color:#e1e4e8"> java.io.</span><span style="color:#b392f0">Serializable</span><span style="color:#e1e4e8">, </span><span style="color:#b392f0">Comparable</span><span style="color:#e1e4e8">&lt;</span><span style="color:#f97583">String</span><span style="color:#e1e4e8">&gt;, </span><span style="color:#b392f0">CharSequence</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#6a737d">    /** The value is used for character storage. */</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">private</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">final</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">char</span><span style="color:#e1e4e8"> value[];</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">//....</span></span>
<span class="line"><span style="color:#e1e4e8">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">final</span><span style="color:#24292e"> </span><span style="color:#d73a49">class</span><span style="color:#24292e"> </span><span style="color:#6f42c1">String</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">implements</span><span style="color:#24292e"> java.io.</span><span style="color:#6f42c1">Serializable</span><span style="color:#24292e">, </span><span style="color:#6f42c1">Comparable</span><span style="color:#24292e">&lt;</span><span style="color:#d73a49">String</span><span style="color:#24292e">&gt;, </span><span style="color:#6f42c1">CharSequence</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#6a737d">    /** The value is used for character storage. */</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">private</span><span style="color:#24292e"> </span><span style="color:#d73a49">final</span><span style="color:#24292e"> </span><span style="color:#d73a49">char</span><span style="color:#24292e"> value[];</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">//....</span></span>
<span class="line"><span style="color:#24292e">}</span></span></code></pre><button class="collapse"></button></div></li><li><p>更改 String 类数据时，会构造新字符串对象，生成新的 char[] value，通过<strong>创建副本对象来避免共享的方式称之为保护性拷贝</strong></p></li></ul><hr><h3 id="state" tabindex="-1">State <a aria-current="page" href="/posts/concurrent_programming_compilation_version-lock_free#state" class="router-link-active router-link-exact-active header-anchor" aria-label="Permalink to &quot;State&quot;"><!--[-->​<!--]--></a></h3><p>无状态：成员变量保存的数据也可以称为状态信息，无状态就是没有成员变量</p><p>Servlet 为了保证其线程安全，一般不为 Servlet 设置成员变量，这种没有任何成员变量的类是线程安全的</p><hr><h3 id="local" tabindex="-1">Local <a aria-current="page" href="/posts/concurrent_programming_compilation_version-lock_free#local" class="router-link-active router-link-exact-active header-anchor" aria-label="Permalink to &quot;Local&quot;"><!--[-->​<!--]--></a></h3><h4 id="基本介绍" tabindex="-1">基本介绍 <a aria-current="page" href="/posts/concurrent_programming_compilation_version-lock_free#基本介绍" class="router-link-active router-link-exact-active header-anchor" aria-label="Permalink to &quot;基本介绍&quot;"><!--[-->​<!--]--></a></h4><p>ThreadLocal 类用来提供线程内部的局部变量，这种变量在多线程环境下访问（通过 get 和 set 方法访问）时能保证各个线程的变量相对独立于其他线程内的变量，分配在堆内的 <strong>TLAB</strong> 中</p><p>ThreadLocal 实例通常来说都是 <code>private static</code> 类型的，属于一个线程的本地变量，用于关联线程和线程上下文。每个线程都会在 ThreadLocal 中保存一份该线程独有的数据，所以是线程安全的</p><p>ThreadLocal 作用：</p><ul><li><p>线程并发：应用在多线程并发的场景下</p></li><li><p>传递数据：通过 ThreadLocal 实现在同一线程不同函数或组件中传递公共变量，减少传递复杂度</p></li><li><p>线程隔离：每个线程的变量都是独立的，不会互相影响</p></li></ul><p>对比 synchronized：</p><table><thead><tr><th></th><th>synchronized</th><th>ThreadLocal</th></tr></thead><tbody><tr><td>原理</td><td>同步机制采用<strong>以时间换空间</strong>的方式，只提供了一份变量，让不同的线程排队访问</td><td>ThreadLocal 采用<strong>以空间换时间</strong>的方式，为每个线程都提供了一份变量的副本，从而实现同时访问而互不干扰</td></tr><tr><td>侧重点</td><td>多个线程之间访问资源的同步</td><td>多线程中让每个线程之间的数据相互隔离</td></tr></tbody></table><hr><h4 id="基本使用" tabindex="-1">基本使用 <a aria-current="page" href="/posts/concurrent_programming_compilation_version-lock_free#基本使用" class="router-link-active router-link-exact-active header-anchor" aria-label="Permalink to &quot;基本使用&quot;"><!--[-->​<!--]--></a></h4><h5 id="常用方法" tabindex="-1">常用方法 <a aria-current="page" href="/posts/concurrent_programming_compilation_version-lock_free#常用方法" class="router-link-active router-link-exact-active header-anchor" aria-label="Permalink to &quot;常用方法&quot;"><!--[-->​<!--]--></a></h5><table><thead><tr><th>方法</th><th>描述</th></tr></thead><tbody><tr><td>ThreadLocal&lt;&gt;()</td><td>创建 ThreadLocal 对象</td></tr><tr><td>protected T initialValue()</td><td>返回当前线程局部变量的初始值</td></tr><tr><td>public void set( T value)</td><td>设置当前线程绑定的局部变量</td></tr><tr><td>public T get()</td><td>获取当前线程绑定的局部变量</td></tr><tr><td>public void remove()</td><td>移除当前线程绑定的局部变量</td></tr></tbody></table><div style="max-height:300px" class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">class</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">MyDemo</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">private</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">static</span><span style="color:#e1e4e8"> ThreadLocal&lt;</span><span style="color:#f97583">String</span><span style="color:#e1e4e8">&gt; tl </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> ThreadLocal&lt;&gt;();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">private</span><span style="color:#e1e4e8"> String content;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">private</span><span style="color:#e1e4e8"> String </span><span style="color:#b392f0">getContent</span><span style="color:#e1e4e8">() {</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#6a737d">// 获取当前线程绑定的变量</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> tl.</span><span style="color:#b392f0">get</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">private</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">void</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">setContent</span><span style="color:#e1e4e8">(String </span><span style="color:#ffab70">content</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#6a737d">// 变量content绑定到当前线程</span></span>
<span class="line"><span style="color:#e1e4e8">        tl.</span><span style="color:#b392f0">set</span><span style="color:#e1e4e8">(content);</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">static</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">void</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">main</span><span style="color:#e1e4e8">(</span><span style="color:#f97583">String</span><span style="color:#e1e4e8">[] </span><span style="color:#ffab70">args</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">        MyDemo demo </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">MyDemo</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">for</span><span style="color:#e1e4e8"> (</span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> i </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8">; i </span><span style="color:#f97583">&lt;</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">5</span><span style="color:#e1e4e8">; i</span><span style="color:#f97583">++</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">            Thread thread </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Thread</span><span style="color:#e1e4e8">(</span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Runnable</span><span style="color:#e1e4e8">() {</span></span>
<span class="line"><span style="color:#e1e4e8">                @</span><span style="color:#f97583">Override</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">void</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">run</span><span style="color:#e1e4e8">() {</span></span>
<span class="line"><span style="color:#e1e4e8">                    </span><span style="color:#6a737d">// 设置数据</span></span>
<span class="line"><span style="color:#e1e4e8">                    demo.</span><span style="color:#b392f0">setContent</span><span style="color:#e1e4e8">(Thread.</span><span style="color:#b392f0">currentThread</span><span style="color:#e1e4e8">().</span><span style="color:#b392f0">getName</span><span style="color:#e1e4e8">() </span><span style="color:#f97583">+</span><span style="color:#e1e4e8"> </span><span style="color:#9ecbff">"的数据"</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">                    System.out.</span><span style="color:#b392f0">println</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"-----------------------"</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">                    System.out.</span><span style="color:#b392f0">println</span><span style="color:#e1e4e8">(Thread.</span><span style="color:#b392f0">currentThread</span><span style="color:#e1e4e8">().</span><span style="color:#b392f0">getName</span><span style="color:#e1e4e8">() </span><span style="color:#f97583">+</span><span style="color:#e1e4e8"> </span><span style="color:#9ecbff">"---&gt;"</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">+</span><span style="color:#e1e4e8"> demo.</span><span style="color:#b392f0">getContent</span><span style="color:#e1e4e8">());</span></span>
<span class="line"><span style="color:#e1e4e8">                }</span></span>
<span class="line"><span style="color:#e1e4e8">            });</span></span>
<span class="line"><span style="color:#e1e4e8">            thread.</span><span style="color:#b392f0">setName</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"线程"</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">+</span><span style="color:#e1e4e8"> i);</span></span>
<span class="line"><span style="color:#e1e4e8">            thread.</span><span style="color:#b392f0">start</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">        }</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"><span style="color:#e1e4e8">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">class</span><span style="color:#24292e"> </span><span style="color:#6f42c1">MyDemo</span><span style="color:#24292e"> {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">private</span><span style="color:#24292e"> </span><span style="color:#d73a49">static</span><span style="color:#24292e"> ThreadLocal&lt;</span><span style="color:#d73a49">String</span><span style="color:#24292e">&gt; tl </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> ThreadLocal&lt;&gt;();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">private</span><span style="color:#24292e"> String content;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">private</span><span style="color:#24292e"> String </span><span style="color:#6f42c1">getContent</span><span style="color:#24292e">() {</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6a737d">// 获取当前线程绑定的变量</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">return</span><span style="color:#24292e"> tl.</span><span style="color:#6f42c1">get</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">private</span><span style="color:#24292e"> </span><span style="color:#d73a49">void</span><span style="color:#24292e"> </span><span style="color:#6f42c1">setContent</span><span style="color:#24292e">(String </span><span style="color:#e36209">content</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6a737d">// 变量content绑定到当前线程</span></span>
<span class="line"><span style="color:#24292e">        tl.</span><span style="color:#6f42c1">set</span><span style="color:#24292e">(content);</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">static</span><span style="color:#24292e"> </span><span style="color:#d73a49">void</span><span style="color:#24292e"> </span><span style="color:#6f42c1">main</span><span style="color:#24292e">(</span><span style="color:#d73a49">String</span><span style="color:#24292e">[] </span><span style="color:#e36209">args</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">        MyDemo demo </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">MyDemo</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">for</span><span style="color:#24292e"> (</span><span style="color:#d73a49">int</span><span style="color:#24292e"> i </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#005cc5">0</span><span style="color:#24292e">; i </span><span style="color:#d73a49">&lt;</span><span style="color:#24292e"> </span><span style="color:#005cc5">5</span><span style="color:#24292e">; i</span><span style="color:#d73a49">++</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">            Thread thread </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Thread</span><span style="color:#24292e">(</span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Runnable</span><span style="color:#24292e">() {</span></span>
<span class="line"><span style="color:#24292e">                @</span><span style="color:#d73a49">Override</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">void</span><span style="color:#24292e"> </span><span style="color:#6f42c1">run</span><span style="color:#24292e">() {</span></span>
<span class="line"><span style="color:#24292e">                    </span><span style="color:#6a737d">// 设置数据</span></span>
<span class="line"><span style="color:#24292e">                    demo.</span><span style="color:#6f42c1">setContent</span><span style="color:#24292e">(Thread.</span><span style="color:#6f42c1">currentThread</span><span style="color:#24292e">().</span><span style="color:#6f42c1">getName</span><span style="color:#24292e">() </span><span style="color:#d73a49">+</span><span style="color:#24292e"> </span><span style="color:#032f62">"的数据"</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">                    System.out.</span><span style="color:#6f42c1">println</span><span style="color:#24292e">(</span><span style="color:#032f62">"-----------------------"</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">                    System.out.</span><span style="color:#6f42c1">println</span><span style="color:#24292e">(Thread.</span><span style="color:#6f42c1">currentThread</span><span style="color:#24292e">().</span><span style="color:#6f42c1">getName</span><span style="color:#24292e">() </span><span style="color:#d73a49">+</span><span style="color:#24292e"> </span><span style="color:#032f62">"---&gt;"</span><span style="color:#24292e"> </span><span style="color:#d73a49">+</span><span style="color:#24292e"> demo.</span><span style="color:#6f42c1">getContent</span><span style="color:#24292e">());</span></span>
<span class="line"><span style="color:#24292e">                }</span></span>
<span class="line"><span style="color:#24292e">            });</span></span>
<span class="line"><span style="color:#24292e">            thread.</span><span style="color:#6f42c1">setName</span><span style="color:#24292e">(</span><span style="color:#032f62">"线程"</span><span style="color:#24292e"> </span><span style="color:#d73a49">+</span><span style="color:#24292e"> i);</span></span>
<span class="line"><span style="color:#24292e">            thread.</span><span style="color:#6f42c1">start</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">        }</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"><span style="color:#24292e">}</span></span></code></pre><button class="collapse"></button></div><hr><h5 id="应用场景" tabindex="-1">应用场景 <a aria-current="page" href="/posts/concurrent_programming_compilation_version-lock_free#应用场景" class="router-link-active router-link-exact-active header-anchor" aria-label="Permalink to &quot;应用场景&quot;"><!--[-->​<!--]--></a></h5><p>ThreadLocal 适用于下面两种场景：</p><ul><li>每个线程需要有自己单独的实例</li><li>实例需要在多个方法中共享，但不希望被多线程共享</li></ul><p>ThreadLocal 方案有两个突出的优势：</p><ol><li>传递数据：保存每个线程绑定的数据，在需要的地方可以直接获取，避免参数直接传递带来的代码耦合问题</li><li>线程隔离：各线程之间的数据相互隔离却又具备并发性，避免同步方式带来的性能损失</li></ol><p>ThreadLocal 用于数据连接的事务管理：</p><div style="max-height:300px" class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">class</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">JdbcUtils</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">// ThreadLocal对象，将connection绑定在当前线程中</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">private</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">static</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">final</span><span style="color:#e1e4e8"> ThreadLocal&lt;</span><span style="color:#f97583">Connection</span><span style="color:#e1e4e8">&gt; tl </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">ThreadLocal</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">// c3p0 数据库连接池对象属性</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">private</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">static</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">final</span><span style="color:#e1e4e8"> ComboPooledDataSource ds </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">ComboPooledDataSource</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">// 获取连接</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">static</span><span style="color:#e1e4e8"> Connection </span><span style="color:#b392f0">getConnection</span><span style="color:#e1e4e8">() </span><span style="color:#f97583">throws</span><span style="color:#e1e4e8"> SQLException {</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#6a737d">//取出当前线程绑定的connection对象</span></span>
<span class="line"><span style="color:#e1e4e8">        Connection conn </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> tl.</span><span style="color:#b392f0">get</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (conn </span><span style="color:#f97583">==</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#6a737d">//如果没有，则从连接池中取出</span></span>
<span class="line"><span style="color:#e1e4e8">            conn </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> ds.</span><span style="color:#b392f0">getConnection</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#6a737d">//再将connection对象绑定到当前线程中，非常重要的操作</span></span>
<span class="line"><span style="color:#e1e4e8">            tl.</span><span style="color:#b392f0">set</span><span style="color:#e1e4e8">(conn);</span></span>
<span class="line"><span style="color:#e1e4e8">        }</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> conn;</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"><span style="color:#e1e4e8">	</span><span style="color:#6a737d">// ...</span></span>
<span class="line"><span style="color:#e1e4e8">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">class</span><span style="color:#24292e"> </span><span style="color:#6f42c1">JdbcUtils</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">// ThreadLocal对象，将connection绑定在当前线程中</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">private</span><span style="color:#24292e"> </span><span style="color:#d73a49">static</span><span style="color:#24292e"> </span><span style="color:#d73a49">final</span><span style="color:#24292e"> ThreadLocal&lt;</span><span style="color:#d73a49">Connection</span><span style="color:#24292e">&gt; tl </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">ThreadLocal</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">// c3p0 数据库连接池对象属性</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">private</span><span style="color:#24292e"> </span><span style="color:#d73a49">static</span><span style="color:#24292e"> </span><span style="color:#d73a49">final</span><span style="color:#24292e"> ComboPooledDataSource ds </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">ComboPooledDataSource</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">// 获取连接</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">static</span><span style="color:#24292e"> Connection </span><span style="color:#6f42c1">getConnection</span><span style="color:#24292e">() </span><span style="color:#d73a49">throws</span><span style="color:#24292e"> SQLException {</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6a737d">//取出当前线程绑定的connection对象</span></span>
<span class="line"><span style="color:#24292e">        Connection conn </span><span style="color:#d73a49">=</span><span style="color:#24292e"> tl.</span><span style="color:#6f42c1">get</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (conn </span><span style="color:#d73a49">==</span><span style="color:#24292e"> </span><span style="color:#005cc5">null</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#6a737d">//如果没有，则从连接池中取出</span></span>
<span class="line"><span style="color:#24292e">            conn </span><span style="color:#d73a49">=</span><span style="color:#24292e"> ds.</span><span style="color:#6f42c1">getConnection</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#6a737d">//再将connection对象绑定到当前线程中，非常重要的操作</span></span>
<span class="line"><span style="color:#24292e">            tl.</span><span style="color:#6f42c1">set</span><span style="color:#24292e">(conn);</span></span>
<span class="line"><span style="color:#24292e">        }</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">return</span><span style="color:#24292e"> conn;</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"><span style="color:#24292e">	</span><span style="color:#6a737d">// ...</span></span>
<span class="line"><span style="color:#24292e">}</span></span></code></pre><button class="collapse"></button></div><p>用 ThreadLocal 使 SimpleDateFormat 从独享变量变成单个线程变量：</p><div style="max-height:300px" class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">class</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">ThreadLocalDateUtil</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">private</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">static</span><span style="color:#e1e4e8"> ThreadLocal&lt;</span><span style="color:#f97583">DateFormat</span><span style="color:#e1e4e8">&gt; threadLocal </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> ThreadLocal&lt;</span><span style="color:#f97583">DateFormat</span><span style="color:#e1e4e8">&gt;() {</span></span>
<span class="line"><span style="color:#e1e4e8">        @</span><span style="color:#f97583">Override</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">protected</span><span style="color:#e1e4e8"> DateFormat </span><span style="color:#b392f0">initialValue</span><span style="color:#e1e4e8">() {</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">SimpleDateFormat</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"yyyy-MM-dd HH:mm:ss"</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">        }</span></span>
<span class="line"><span style="color:#e1e4e8">    };</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">static</span><span style="color:#e1e4e8"> Date </span><span style="color:#b392f0">parse</span><span style="color:#e1e4e8">(String </span><span style="color:#ffab70">dateStr</span><span style="color:#e1e4e8">) </span><span style="color:#f97583">throws</span><span style="color:#e1e4e8"> ParseException {</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> threadLocal.</span><span style="color:#b392f0">get</span><span style="color:#e1e4e8">().</span><span style="color:#b392f0">parse</span><span style="color:#e1e4e8">(dateStr);</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">static</span><span style="color:#e1e4e8"> String </span><span style="color:#b392f0">format</span><span style="color:#e1e4e8">(Date </span><span style="color:#ffab70">date</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> threadLocal.</span><span style="color:#b392f0">get</span><span style="color:#e1e4e8">().</span><span style="color:#b392f0">format</span><span style="color:#e1e4e8">(date);</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"><span style="color:#e1e4e8">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">class</span><span style="color:#24292e"> </span><span style="color:#6f42c1">ThreadLocalDateUtil</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">private</span><span style="color:#24292e"> </span><span style="color:#d73a49">static</span><span style="color:#24292e"> ThreadLocal&lt;</span><span style="color:#d73a49">DateFormat</span><span style="color:#24292e">&gt; threadLocal </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> ThreadLocal&lt;</span><span style="color:#d73a49">DateFormat</span><span style="color:#24292e">&gt;() {</span></span>
<span class="line"><span style="color:#24292e">        @</span><span style="color:#d73a49">Override</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">protected</span><span style="color:#24292e"> DateFormat </span><span style="color:#6f42c1">initialValue</span><span style="color:#24292e">() {</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">return</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">SimpleDateFormat</span><span style="color:#24292e">(</span><span style="color:#032f62">"yyyy-MM-dd HH:mm:ss"</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">        }</span></span>
<span class="line"><span style="color:#24292e">    };</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">static</span><span style="color:#24292e"> Date </span><span style="color:#6f42c1">parse</span><span style="color:#24292e">(String </span><span style="color:#e36209">dateStr</span><span style="color:#24292e">) </span><span style="color:#d73a49">throws</span><span style="color:#24292e"> ParseException {</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">return</span><span style="color:#24292e"> threadLocal.</span><span style="color:#6f42c1">get</span><span style="color:#24292e">().</span><span style="color:#6f42c1">parse</span><span style="color:#24292e">(dateStr);</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">static</span><span style="color:#24292e"> String </span><span style="color:#6f42c1">format</span><span style="color:#24292e">(Date </span><span style="color:#e36209">date</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">return</span><span style="color:#24292e"> threadLocal.</span><span style="color:#6f42c1">get</span><span style="color:#24292e">().</span><span style="color:#6f42c1">format</span><span style="color:#24292e">(date);</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"><span style="color:#24292e">}</span></span></code></pre><button class="collapse"></button></div><hr><h4 id="实现原理" tabindex="-1">实现原理 <a aria-current="page" href="/posts/concurrent_programming_compilation_version-lock_free#实现原理" class="router-link-active router-link-exact-active header-anchor" aria-label="Permalink to &quot;实现原理&quot;"><!--[-->​<!--]--></a></h4><h5 id="底层结构" tabindex="-1">底层结构 <a aria-current="page" href="/posts/concurrent_programming_compilation_version-lock_free#底层结构" class="router-link-active router-link-exact-active header-anchor" aria-label="Permalink to &quot;底层结构&quot;"><!--[-->​<!--]--></a></h5><p>JDK8 以前：每个 ThreadLocal 都创建一个 Map，然后用线程作为 Map 的 key，要存储的局部变量作为 Map 的 value，达到各个线程的局部变量隔离的效果。这种结构会造成 Map 结构过大和内存泄露，因为 Thread 停止后无法通过 key 删除对应的数据</p><img src="https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230824171552294.png" alt="image-20230824171552294" style="zoom:80%"><p>JDK8 以后：每个 Thread 维护一个 ThreadLocalMap，这个 Map 的 key 是 ThreadLocal 实例本身，value 是真正要存储的值</p><ul><li><strong>每个 Thread 线程内部都有一个 Map (ThreadLocalMap)</strong></li><li>Map 里面存储 ThreadLocal 对象（key）和线程的私有变量（value）</li><li>Thread 内部的 Map 是由 ThreadLocal 维护的，由 ThreadLocal 负责向 map 获取和设置线程的变量值</li><li>对于不同的线程，每次获取副本值时，别的线程并不能获取到当前线程的副本值，形成副本的隔离，互不干扰</li></ul><img src="https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230824171625312.png" alt="image-20230824171625312" style="zoom:80%"><p>JDK8 前后对比：</p><ul><li>每个 Map 存储的 Entry 数量会变少，因为之前的存储数量由 Thread 的数量决定，现在由 ThreadLocal 的数量决定，在实际编程当中，往往 ThreadLocal 的数量要少于 Thread 的数量</li><li>当 Thread 销毁之后，对应的 ThreadLocalMap 也会随之销毁，能减少内存的使用，<strong>防止内存泄露</strong></li></ul><hr><h5 id="成员变量" tabindex="-1">成员变量 <a aria-current="page" href="/posts/concurrent_programming_compilation_version-lock_free#成员变量" class="router-link-active router-link-exact-active header-anchor" aria-label="Permalink to &quot;成员变量&quot;"><!--[-->​<!--]--></a></h5><ul><li><p>Thread 类的相关属性：<strong>每一个线程持有一个 ThreadLocalMap 对象</strong>，存放由 ThreadLocal 和数据组成的 Entry 键值对</p><div style="max-height:300px" class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8">ThreadLocal.ThreadLocalMap threadLocals </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">null</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e">ThreadLocal.ThreadLocalMap threadLocals </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#005cc5">null</span></span></code></pre><button class="collapse"></button></div></li><li><p>计算 ThreadLocal 对象的哈希值：</p><div style="max-height:300px" class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#f97583">private</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">final</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> threadLocalHashCode </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">nextHashCode</span><span style="color:#e1e4e8">()</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#d73a49">private</span><span style="color:#24292e"> </span><span style="color:#d73a49">final</span><span style="color:#24292e"> </span><span style="color:#d73a49">int</span><span style="color:#24292e"> threadLocalHashCode </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#6f42c1">nextHashCode</span><span style="color:#24292e">()</span></span></code></pre><button class="collapse"></button></div><p>使用 <code>threadLocalHashCode &amp; (table.length - 1)</code> 计算当前 entry 需要存放的位置</p></li><li><p>每创建一个 ThreadLocal 对象就会使用 nextHashCode 分配一个 hash 值给这个对象：</p><div style="max-height:300px" class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#f97583">private</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">static</span><span style="color:#e1e4e8"> AtomicInteger nextHashCode </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">AtomicInteger</span><span style="color:#e1e4e8">()</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#d73a49">private</span><span style="color:#24292e"> </span><span style="color:#d73a49">static</span><span style="color:#24292e"> AtomicInteger nextHashCode </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">AtomicInteger</span><span style="color:#24292e">()</span></span></code></pre><button class="collapse"></button></div></li><li><p>斐波那契数也叫黄金分割数，hash 的<strong>增量</strong>就是这个数字，带来的好处是 hash 分布非常均匀：</p><div style="max-height:300px" class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#f97583">private</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">static</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">final</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> HASH_INCREMENT </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">0x61c88647</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#d73a49">private</span><span style="color:#24292e"> </span><span style="color:#d73a49">static</span><span style="color:#24292e"> </span><span style="color:#d73a49">final</span><span style="color:#24292e"> </span><span style="color:#d73a49">int</span><span style="color:#24292e"> HASH_INCREMENT </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#005cc5">0x61c88647</span></span></code></pre><button class="collapse"></button></div></li></ul><hr><h5 id="成员方法" tabindex="-1">成员方法 <a aria-current="page" href="/posts/concurrent_programming_compilation_version-lock_free#成员方法" class="router-link-active router-link-exact-active header-anchor" aria-label="Permalink to &quot;成员方法&quot;"><!--[-->​<!--]--></a></h5><p>方法都是线程安全的，因为 ThreadLocal 属于一个线程的，ThreadLocal 中的方法，逻辑都是获取当前线程维护的 ThreadLocalMap 对象，然后进行数据的增删改查，没有指定初始值的 threadlcoal 对象默认赋值为 null</p><ul><li><p>initialValue()：返回该线程局部变量的初始值</p><ul><li>延迟调用的方法，在执行 get 方法时才执行</li><li>该方法缺省（默认）实现直接返回一个 null</li><li>如果想要一个初始值，可以重写此方法， 该方法是一个 <code>protected</code> 的方法，为了让子类覆盖而设计的</li></ul><div style="max-height:300px" class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#f97583">protected</span><span style="color:#e1e4e8"> T </span><span style="color:#b392f0">initialValue</span><span style="color:#e1e4e8">() {</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#d73a49">protected</span><span style="color:#24292e"> T </span><span style="color:#6f42c1">initialValue</span><span style="color:#24292e">() {</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">return</span><span style="color:#24292e"> </span><span style="color:#005cc5">null</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">}</span></span></code></pre><button class="collapse"></button></div></li><li><p>nextHashCode()：计算哈希值，ThreadLocal 的散列方式称之为<strong>斐波那契散列</strong>，每次获取哈希值都会加上 HASH_INCREMENT，这样做可以尽量避免 hash 冲突，让哈希值能均匀的分布在 2 的 n 次方的数组中</p><div style="max-height:300px" class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#f97583">private</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">static</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">nextHashCode</span><span style="color:#e1e4e8">() {</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">// 哈希值自增一个 HASH_INCREMENT 数值</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> nextHashCode.</span><span style="color:#b392f0">getAndAdd</span><span style="color:#e1e4e8">(HASH_INCREMENT);</span></span>
<span class="line"><span style="color:#e1e4e8">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#d73a49">private</span><span style="color:#24292e"> </span><span style="color:#d73a49">static</span><span style="color:#24292e"> </span><span style="color:#d73a49">int</span><span style="color:#24292e"> </span><span style="color:#6f42c1">nextHashCode</span><span style="color:#24292e">() {</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">// 哈希值自增一个 HASH_INCREMENT 数值</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">return</span><span style="color:#24292e"> nextHashCode.</span><span style="color:#6f42c1">getAndAdd</span><span style="color:#24292e">(HASH_INCREMENT);</span></span>
<span class="line"><span style="color:#24292e">}</span></span></code></pre><button class="collapse"></button></div></li><li><p>set()：修改当前线程与当前 threadlocal 对象相关联的线程局部变量</p><div style="max-height:300px" class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">void</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">set</span><span style="color:#e1e4e8">(T value) {</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">// 获取当前线程对象</span></span>
<span class="line"><span style="color:#e1e4e8">    Thread t </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> Thread.</span><span style="color:#b392f0">currentThread</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">// 获取此线程对象中维护的 ThreadLocalMap 对象</span></span>
<span class="line"><span style="color:#e1e4e8">    ThreadLocalMap map </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">getMap</span><span style="color:#e1e4e8">(t);</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">// 判断 map 是否存在</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (map </span><span style="color:#f97583">!=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8">)</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#6a737d">// 调用 threadLocalMap.set 方法进行重写或者添加</span></span>
<span class="line"><span style="color:#e1e4e8">        map.</span><span style="color:#b392f0">set</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">this</span><span style="color:#e1e4e8">, value);</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">else</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#6a737d">// map 为空，调用 createMap 进行 ThreadLocalMap 对象的初始化。参数1是当前线程，参数2是局部变量</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#b392f0">createMap</span><span style="color:#e1e4e8">(t, value);</span></span>
<span class="line"><span style="color:#e1e4e8">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">void</span><span style="color:#24292e"> </span><span style="color:#6f42c1">set</span><span style="color:#24292e">(T value) {</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">// 获取当前线程对象</span></span>
<span class="line"><span style="color:#24292e">    Thread t </span><span style="color:#d73a49">=</span><span style="color:#24292e"> Thread.</span><span style="color:#6f42c1">currentThread</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">// 获取此线程对象中维护的 ThreadLocalMap 对象</span></span>
<span class="line"><span style="color:#24292e">    ThreadLocalMap map </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#6f42c1">getMap</span><span style="color:#24292e">(t);</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">// 判断 map 是否存在</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (map </span><span style="color:#d73a49">!=</span><span style="color:#24292e"> </span><span style="color:#005cc5">null</span><span style="color:#24292e">)</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6a737d">// 调用 threadLocalMap.set 方法进行重写或者添加</span></span>
<span class="line"><span style="color:#24292e">        map.</span><span style="color:#6f42c1">set</span><span style="color:#24292e">(</span><span style="color:#005cc5">this</span><span style="color:#24292e">, value);</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">else</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6a737d">// map 为空，调用 createMap 进行 ThreadLocalMap 对象的初始化。参数1是当前线程，参数2是局部变量</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6f42c1">createMap</span><span style="color:#24292e">(t, value);</span></span>
<span class="line"><span style="color:#24292e">}</span></span></code></pre><button class="collapse"></button></div><div style="max-height:300px" class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6a737d">// 获取当前线程 Thread 对应维护的 ThreadLocalMap </span></span>
<span class="line"><span style="color:#e1e4e8">ThreadLocalMap </span><span style="color:#b392f0">getMap</span><span style="color:#e1e4e8">(Thread t) {</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> t.threadLocals;</span></span>
<span class="line"><span style="color:#e1e4e8">}</span></span>
<span class="line"><span style="color:#6a737d">// 创建当前线程Thread对应维护的ThreadLocalMap </span></span>
<span class="line"><span style="color:#f97583">void</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">createMap</span><span style="color:#e1e4e8">(Thread t, T firstValue) {</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">// 【这里的 this 是调用此方法的 threadLocal】，创建一个新的 Map 并设置第一个数据</span></span>
<span class="line"><span style="color:#e1e4e8">    t.threadLocals </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">ThreadLocalMap</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">this</span><span style="color:#e1e4e8">, firstValue);</span></span>
<span class="line"><span style="color:#e1e4e8">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6a737d">// 获取当前线程 Thread 对应维护的 ThreadLocalMap </span></span>
<span class="line"><span style="color:#24292e">ThreadLocalMap </span><span style="color:#6f42c1">getMap</span><span style="color:#24292e">(Thread t) {</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">return</span><span style="color:#24292e"> t.threadLocals;</span></span>
<span class="line"><span style="color:#24292e">}</span></span>
<span class="line"><span style="color:#6a737d">// 创建当前线程Thread对应维护的ThreadLocalMap </span></span>
<span class="line"><span style="color:#d73a49">void</span><span style="color:#24292e"> </span><span style="color:#6f42c1">createMap</span><span style="color:#24292e">(Thread t, T firstValue) {</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">// 【这里的 this 是调用此方法的 threadLocal】，创建一个新的 Map 并设置第一个数据</span></span>
<span class="line"><span style="color:#24292e">    t.threadLocals </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">ThreadLocalMap</span><span style="color:#24292e">(</span><span style="color:#005cc5">this</span><span style="color:#24292e">, firstValue);</span></span>
<span class="line"><span style="color:#24292e">}</span></span></code></pre><button class="collapse"></button></div></li><li><p>get()：获取当前线程与当前 ThreadLocal 对象相关联的线程局部变量</p><div style="max-height:300px" class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#f97583">public</span><span style="color:#e1e4e8"> T </span><span style="color:#b392f0">get</span><span style="color:#e1e4e8">() {</span></span>
<span class="line"><span style="color:#e1e4e8">    Thread t </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> Thread.</span><span style="color:#b392f0">currentThread</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">    ThreadLocalMap map </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">getMap</span><span style="color:#e1e4e8">(t);</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">// 如果此map存在</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (map </span><span style="color:#f97583">!=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#6a737d">// 以当前的 ThreadLocal 为 key，调用 getEntry 获取对应的存储实体 e</span></span>
<span class="line"><span style="color:#e1e4e8">        ThreadLocalMap.Entry e </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> map.</span><span style="color:#b392f0">getEntry</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">this</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#6a737d">// 对 e 进行判空 </span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (e </span><span style="color:#f97583">!=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#6a737d">// 获取存储实体 e 对应的 value值</span></span>
<span class="line"><span style="color:#e1e4e8">            T result </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> (T)e.value;</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> result;</span></span>
<span class="line"><span style="color:#e1e4e8">        }</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">/*有两种情况有执行当前代码</span></span>
<span class="line"><span style="color:#6a737d">      第一种情况: map 不存在，表示此线程没有维护的 ThreadLocalMap 对象</span></span>
<span class="line"><span style="color:#6a737d">      第二种情况: map 存在, 但是【没有与当前 ThreadLocal 关联的 entry】，就会设置为默认值 */</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">// 初始化当前线程与当前 threadLocal 对象相关联的 value</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">setInitialValue</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#d73a49">public</span><span style="color:#24292e"> T </span><span style="color:#6f42c1">get</span><span style="color:#24292e">() {</span></span>
<span class="line"><span style="color:#24292e">    Thread t </span><span style="color:#d73a49">=</span><span style="color:#24292e"> Thread.</span><span style="color:#6f42c1">currentThread</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">    ThreadLocalMap map </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#6f42c1">getMap</span><span style="color:#24292e">(t);</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">// 如果此map存在</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (map </span><span style="color:#d73a49">!=</span><span style="color:#24292e"> </span><span style="color:#005cc5">null</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6a737d">// 以当前的 ThreadLocal 为 key，调用 getEntry 获取对应的存储实体 e</span></span>
<span class="line"><span style="color:#24292e">        ThreadLocalMap.Entry e </span><span style="color:#d73a49">=</span><span style="color:#24292e"> map.</span><span style="color:#6f42c1">getEntry</span><span style="color:#24292e">(</span><span style="color:#005cc5">this</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6a737d">// 对 e 进行判空 </span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (e </span><span style="color:#d73a49">!=</span><span style="color:#24292e"> </span><span style="color:#005cc5">null</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#6a737d">// 获取存储实体 e 对应的 value值</span></span>
<span class="line"><span style="color:#24292e">            T result </span><span style="color:#d73a49">=</span><span style="color:#24292e"> (T)e.value;</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">return</span><span style="color:#24292e"> result;</span></span>
<span class="line"><span style="color:#24292e">        }</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">/*有两种情况有执行当前代码</span></span>
<span class="line"><span style="color:#6a737d">      第一种情况: map 不存在，表示此线程没有维护的 ThreadLocalMap 对象</span></span>
<span class="line"><span style="color:#6a737d">      第二种情况: map 存在, 但是【没有与当前 ThreadLocal 关联的 entry】，就会设置为默认值 */</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">// 初始化当前线程与当前 threadLocal 对象相关联的 value</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">return</span><span style="color:#24292e"> </span><span style="color:#6f42c1">setInitialValue</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">}</span></span></code></pre><button class="collapse"></button></div><div style="max-height:300px" class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#f97583">private</span><span style="color:#e1e4e8"> T </span><span style="color:#b392f0">setInitialValue</span><span style="color:#e1e4e8">() {</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">// 调用initialValue获取初始化的值，此方法可以被子类重写, 如果不重写默认返回 null</span></span>
<span class="line"><span style="color:#e1e4e8">    T value </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">initialValue</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">    Thread t </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> Thread.</span><span style="color:#b392f0">currentThread</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">    ThreadLocalMap map </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">getMap</span><span style="color:#e1e4e8">(t);</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">// 判断 map 是否初始化过</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (map </span><span style="color:#f97583">!=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8">)</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#6a737d">// 存在则调用 map.set 设置此实体 entry，value 是默认的值</span></span>
<span class="line"><span style="color:#e1e4e8">        map.</span><span style="color:#b392f0">set</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">this</span><span style="color:#e1e4e8">, value);</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">else</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#6a737d">// 调用 createMap 进行 ThreadLocalMap 对象的初始化中</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#b392f0">createMap</span><span style="color:#e1e4e8">(t, value);</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">// 返回线程与当前 threadLocal 关联的局部变量</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> value;</span></span>
<span class="line"><span style="color:#e1e4e8">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#d73a49">private</span><span style="color:#24292e"> T </span><span style="color:#6f42c1">setInitialValue</span><span style="color:#24292e">() {</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">// 调用initialValue获取初始化的值，此方法可以被子类重写, 如果不重写默认返回 null</span></span>
<span class="line"><span style="color:#24292e">    T value </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#6f42c1">initialValue</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">    Thread t </span><span style="color:#d73a49">=</span><span style="color:#24292e"> Thread.</span><span style="color:#6f42c1">currentThread</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">    ThreadLocalMap map </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#6f42c1">getMap</span><span style="color:#24292e">(t);</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">// 判断 map 是否初始化过</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (map </span><span style="color:#d73a49">!=</span><span style="color:#24292e"> </span><span style="color:#005cc5">null</span><span style="color:#24292e">)</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6a737d">// 存在则调用 map.set 设置此实体 entry，value 是默认的值</span></span>
<span class="line"><span style="color:#24292e">        map.</span><span style="color:#6f42c1">set</span><span style="color:#24292e">(</span><span style="color:#005cc5">this</span><span style="color:#24292e">, value);</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">else</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6a737d">// 调用 createMap 进行 ThreadLocalMap 对象的初始化中</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6f42c1">createMap</span><span style="color:#24292e">(t, value);</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">// 返回线程与当前 threadLocal 关联的局部变量</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">return</span><span style="color:#24292e"> value;</span></span>
<span class="line"><span style="color:#24292e">}</span></span></code></pre><button class="collapse"></button></div></li><li><p>remove()：移除当前线程与当前 threadLocal 对象相关联的线程局部变量</p><div style="max-height:300px" class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">void</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">remove</span><span style="color:#e1e4e8">() {</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">// 获取当前线程对象中维护的 ThreadLocalMap 对象</span></span>
<span class="line"><span style="color:#e1e4e8">    ThreadLocalMap m </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">getMap</span><span style="color:#e1e4e8">(Thread.</span><span style="color:#b392f0">currentThread</span><span style="color:#e1e4e8">());</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (m </span><span style="color:#f97583">!=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8">)</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#6a737d">// map 存在则调用 map.remove，this时当前ThreadLocal，以this为key删除对应的实体</span></span>
<span class="line"><span style="color:#e1e4e8">        m.</span><span style="color:#b392f0">remove</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">this</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">void</span><span style="color:#24292e"> </span><span style="color:#6f42c1">remove</span><span style="color:#24292e">() {</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">// 获取当前线程对象中维护的 ThreadLocalMap 对象</span></span>
<span class="line"><span style="color:#24292e">    ThreadLocalMap m </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#6f42c1">getMap</span><span style="color:#24292e">(Thread.</span><span style="color:#6f42c1">currentThread</span><span style="color:#24292e">());</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (m </span><span style="color:#d73a49">!=</span><span style="color:#24292e"> </span><span style="color:#005cc5">null</span><span style="color:#24292e">)</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6a737d">// map 存在则调用 map.remove，this时当前ThreadLocal，以this为key删除对应的实体</span></span>
<span class="line"><span style="color:#24292e">        m.</span><span style="color:#6f42c1">remove</span><span style="color:#24292e">(</span><span style="color:#005cc5">this</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">}</span></span></code></pre><button class="collapse"></button></div></li></ul><hr><h4 id="localmap" tabindex="-1">LocalMap <a aria-current="page" href="/posts/concurrent_programming_compilation_version-lock_free#localmap" class="router-link-active router-link-exact-active header-anchor" aria-label="Permalink to &quot;LocalMap&quot;"><!--[-->​<!--]--></a></h4><h5 id="成员属性" tabindex="-1">成员属性 <a aria-current="page" href="/posts/concurrent_programming_compilation_version-lock_free#成员属性" class="router-link-active router-link-exact-active header-anchor" aria-label="Permalink to &quot;成员属性&quot;"><!--[-->​<!--]--></a></h5><p>ThreadLocalMap 是 ThreadLocal 的内部类，没有实现 Map 接口，用独立的方式实现了 Map 的功能，其内部 Entry 也是独立实现</p><div style="max-height:300px" class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6a737d">// 初始化当前 map 内部散列表数组的初始长度 16</span></span>
<span class="line"><span style="color:#f97583">private</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">static</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">final</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> INITIAL_CAPACITY </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">16</span><span style="color:#e1e4e8">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6a737d">// 存放数据的table，数组长度必须是2的整次幂。</span></span>
<span class="line"><span style="color:#f97583">private</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">Entry</span><span style="color:#e1e4e8">[] table;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6a737d">// 数组里面 entrys 的个数，可以用于判断 table 当前使用量是否超过阈值</span></span>
<span class="line"><span style="color:#f97583">private</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> size </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6a737d">// 进行扩容的阈值，表使用量大于它的时候进行扩容。</span></span>
<span class="line"><span style="color:#f97583">private</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> threshold;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6a737d">// 初始化当前 map 内部散列表数组的初始长度 16</span></span>
<span class="line"><span style="color:#d73a49">private</span><span style="color:#24292e"> </span><span style="color:#d73a49">static</span><span style="color:#24292e"> </span><span style="color:#d73a49">final</span><span style="color:#24292e"> </span><span style="color:#d73a49">int</span><span style="color:#24292e"> INITIAL_CAPACITY </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#005cc5">16</span><span style="color:#24292e">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6a737d">// 存放数据的table，数组长度必须是2的整次幂。</span></span>
<span class="line"><span style="color:#d73a49">private</span><span style="color:#24292e"> </span><span style="color:#d73a49">Entry</span><span style="color:#24292e">[] table;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6a737d">// 数组里面 entrys 的个数，可以用于判断 table 当前使用量是否超过阈值</span></span>
<span class="line"><span style="color:#d73a49">private</span><span style="color:#24292e"> </span><span style="color:#d73a49">int</span><span style="color:#24292e"> size </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#005cc5">0</span><span style="color:#24292e">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6a737d">// 进行扩容的阈值，表使用量大于它的时候进行扩容。</span></span>
<span class="line"><span style="color:#d73a49">private</span><span style="color:#24292e"> </span><span style="color:#d73a49">int</span><span style="color:#24292e"> threshold;</span></span></code></pre><button class="collapse"></button></div><p>存储结构 Entry：</p><ul><li>Entry 继承 WeakReference，key 是弱引用，目的是将 ThreadLocal 对象的生命周期和线程生命周期解绑</li><li>Entry 限制只能用 ThreadLocal 作为 key，key 为 null (entry.get() == null) 意味着 key 不再被引用，entry 也可以从 table 中清除</li></ul><div style="max-height:300px" class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#f97583">static</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">class</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Entry</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">extends</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">WeakReference</span><span style="color:#e1e4e8">&lt;ThreadLocal&lt;</span><span style="color:#f97583">?</span><span style="color:#e1e4e8">&gt;&gt; {</span></span>
<span class="line"><span style="color:#e1e4e8">    Object value;</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#b392f0">Entry</span><span style="color:#e1e4e8">(ThreadLocal&lt;</span><span style="color:#f97583">?</span><span style="color:#e1e4e8">&gt; </span><span style="color:#ffab70">k</span><span style="color:#e1e4e8">, Object </span><span style="color:#ffab70">v</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#6a737d">// this.referent = referent = key;</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#79b8ff">super</span><span style="color:#e1e4e8">(k);</span></span>
<span class="line"><span style="color:#e1e4e8">        value </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> v;</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"><span style="color:#e1e4e8">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#d73a49">static</span><span style="color:#24292e"> </span><span style="color:#d73a49">class</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Entry</span><span style="color:#24292e"> </span><span style="color:#d73a49">extends</span><span style="color:#24292e"> </span><span style="color:#6f42c1">WeakReference</span><span style="color:#24292e">&lt;ThreadLocal&lt;</span><span style="color:#d73a49">?</span><span style="color:#24292e">&gt;&gt; {</span></span>
<span class="line"><span style="color:#24292e">    Object value;</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6f42c1">Entry</span><span style="color:#24292e">(ThreadLocal&lt;</span><span style="color:#d73a49">?</span><span style="color:#24292e">&gt; </span><span style="color:#e36209">k</span><span style="color:#24292e">, Object </span><span style="color:#e36209">v</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6a737d">// this.referent = referent = key;</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#005cc5">super</span><span style="color:#24292e">(k);</span></span>
<span class="line"><span style="color:#24292e">        value </span><span style="color:#d73a49">=</span><span style="color:#24292e"> v;</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"><span style="color:#24292e">}</span></span></code></pre><button class="collapse"></button></div><p>构造方法：延迟初始化的，线程第一次存储 threadLocal - value 时才会创建 threadLocalMap 对象</p><div style="max-height:300px" class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#b392f0">ThreadLocalMap</span><span style="color:#e1e4e8">(ThreadLocal</span><span style="color:#f97583">&lt;?&gt;</span><span style="color:#e1e4e8"> firstKey, Object firstValue) {</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">// 初始化table，创建一个长度为16的Entry数组</span></span>
<span class="line"><span style="color:#e1e4e8">    table </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">Entry</span><span style="color:#e1e4e8">[INITIAL_CAPACITY];</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">// 【寻址算法】计算索引</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> i </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> firstKey.threadLocalHashCode </span><span style="color:#f97583">&amp;</span><span style="color:#e1e4e8"> (INITIAL_CAPACITY </span><span style="color:#f97583">-</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">1</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">// 创建 entry 对象，存放到指定位置的 slot 中</span></span>
<span class="line"><span style="color:#e1e4e8">    table[i] </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Entry</span><span style="color:#e1e4e8">(firstKey, firstValue);</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">// 数据总量是 1</span></span>
<span class="line"><span style="color:#e1e4e8">    size </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">1</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">// 将阈值设置为 （当前数组长度 * 2）/ 3。</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#b392f0">setThreshold</span><span style="color:#e1e4e8">(INITIAL_CAPACITY);</span></span>
<span class="line"><span style="color:#e1e4e8">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6f42c1">ThreadLocalMap</span><span style="color:#24292e">(ThreadLocal</span><span style="color:#d73a49">&lt;?&gt;</span><span style="color:#24292e"> firstKey, Object firstValue) {</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">// 初始化table，创建一个长度为16的Entry数组</span></span>
<span class="line"><span style="color:#24292e">    table </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#d73a49">Entry</span><span style="color:#24292e">[INITIAL_CAPACITY];</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">// 【寻址算法】计算索引</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">int</span><span style="color:#24292e"> i </span><span style="color:#d73a49">=</span><span style="color:#24292e"> firstKey.threadLocalHashCode </span><span style="color:#d73a49">&amp;</span><span style="color:#24292e"> (INITIAL_CAPACITY </span><span style="color:#d73a49">-</span><span style="color:#24292e"> </span><span style="color:#005cc5">1</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">// 创建 entry 对象，存放到指定位置的 slot 中</span></span>
<span class="line"><span style="color:#24292e">    table[i] </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Entry</span><span style="color:#24292e">(firstKey, firstValue);</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">// 数据总量是 1</span></span>
<span class="line"><span style="color:#24292e">    size </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#005cc5">1</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">// 将阈值设置为 （当前数组长度 * 2）/ 3。</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6f42c1">setThreshold</span><span style="color:#24292e">(INITIAL_CAPACITY);</span></span>
<span class="line"><span style="color:#24292e">}</span></span></code></pre><button class="collapse"></button></div><hr><h5 id="成员方法-1" tabindex="-1">成员方法 <a aria-current="page" href="/posts/concurrent_programming_compilation_version-lock_free#成员方法-1" class="router-link-active router-link-exact-active header-anchor" aria-label="Permalink to &quot;成员方法&quot;"><!--[-->​<!--]--></a></h5><ul><li><p>set()：添加数据，ThreadLocalMap 使用<strong>线性探测法来解决哈希冲突</strong></p><ul><li><p>该方法会一直探测下一个地址，直到有空的地址后插入，若插入后 Map 数量超过阈值，数组会扩容为原来的 2 倍</p><p>假设当前 table 长度为16，计算出来 key 的 hash 值为 14，如果 table[14] 上已经有值，并且其 key 与当前 key 不一致，那么就发生了 hash 冲突，这个时候将 14 加 1 得到 15，取 table[15] 进行判断，如果还是冲突会回到 0，取 table[0]，以此类推，直到可以插入，可以把 Entry[] table 看成一个<strong>环形数组</strong></p></li><li><p>线性探测法会出现<strong>堆积问题</strong>，可以采取平方探测法解决</p></li><li><p>在探测过程中 ThreadLocal 会复用 key 为 null 的脏 Entry 对象，并进行垃圾清理，防止出现内存泄漏</p></li></ul><div style="max-height:300px" class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#f97583">private</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">void</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">set</span><span style="color:#e1e4e8">(ThreadLocal</span><span style="color:#f97583">&lt;?&gt;</span><span style="color:#e1e4e8"> key, Object value) {</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">// 获取散列表</span></span>
<span class="line"><span style="color:#e1e4e8">    ThreadLocal.ThreadLocalMap.</span><span style="color:#f97583">Entry</span><span style="color:#e1e4e8">[] tab </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> table;</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> len </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> tab.length;</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">// 哈希寻址</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> i </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> key.threadLocalHashCode </span><span style="color:#f97583">&amp;</span><span style="color:#e1e4e8"> (len</span><span style="color:#f97583">-</span><span style="color:#79b8ff">1</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">// 使用线性探测法向后查找元素，碰到 entry 为空时停止探测</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">for</span><span style="color:#e1e4e8"> (ThreadLocal.ThreadLocalMap.Entry e </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> tab[i]; e </span><span style="color:#f97583">!=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8">; e </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> tab[i </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">nextIndex</span><span style="color:#e1e4e8">(i, len)]) {</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#6a737d">// 获取当前元素 key</span></span>
<span class="line"><span style="color:#e1e4e8">        ThreadLocal&lt;</span><span style="color:#f97583">?</span><span style="color:#e1e4e8">&gt; k </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> e.</span><span style="color:#b392f0">get</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#6a737d">// ThreadLocal 对应的 key 存在，【直接覆盖之前的值】</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (k </span><span style="color:#f97583">==</span><span style="color:#e1e4e8"> key) {</span></span>
<span class="line"><span style="color:#e1e4e8">            e.value </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> value;</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">return</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">        }</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#6a737d">// 【这两个条件谁先成立不一定，所以 replaceStaleEntry 中还需要判断 k == key 的情况】</span></span>
<span class="line"><span style="color:#e1e4e8">        </span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#6a737d">// key 为 null，但是值不为 null，说明之前的 ThreadLocal 对象已经被回收了，当前是【过期数据】</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (k </span><span style="color:#f97583">==</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#6a737d">// 【碰到一个过期的 slot，当前数据复用该槽位，替换过期数据】</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#6a737d">// 这个方法还进行了垃圾清理动作，防止内存泄漏</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#b392f0">replaceStaleEntry</span><span style="color:#e1e4e8">(key, value, i);</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">return</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">        }</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"><span style="color:#e1e4e8">	</span><span style="color:#6a737d">// 逻辑到这说明碰到 slot == null 的位置，则在空元素的位置创建一个新的 Entry</span></span>
<span class="line"><span style="color:#e1e4e8">    tab[i] </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Entry</span><span style="color:#e1e4e8">(key, value);</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">// 数量 + 1</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> sz </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">++</span><span style="color:#e1e4e8">size;</span></span>
<span class="line"><span style="color:#e1e4e8">    </span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">// 【做一次启发式清理】，如果没有清除任何 entry 并且【当前使用量达到了负载因子所定义，那么进行 rehash</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (</span><span style="color:#f97583">!</span><span style="color:#b392f0">cleanSomeSlots</span><span style="color:#e1e4e8">(i, sz) </span><span style="color:#f97583">&amp;&amp;</span><span style="color:#e1e4e8"> sz </span><span style="color:#f97583">&gt;=</span><span style="color:#e1e4e8"> threshold)</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#6a737d">// 扩容</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#b392f0">rehash</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#d73a49">private</span><span style="color:#24292e"> </span><span style="color:#d73a49">void</span><span style="color:#24292e"> </span><span style="color:#6f42c1">set</span><span style="color:#24292e">(ThreadLocal</span><span style="color:#d73a49">&lt;?&gt;</span><span style="color:#24292e"> key, Object value) {</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">// 获取散列表</span></span>
<span class="line"><span style="color:#24292e">    ThreadLocal.ThreadLocalMap.</span><span style="color:#d73a49">Entry</span><span style="color:#24292e">[] tab </span><span style="color:#d73a49">=</span><span style="color:#24292e"> table;</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">int</span><span style="color:#24292e"> len </span><span style="color:#d73a49">=</span><span style="color:#24292e"> tab.length;</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">// 哈希寻址</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">int</span><span style="color:#24292e"> i </span><span style="color:#d73a49">=</span><span style="color:#24292e"> key.threadLocalHashCode </span><span style="color:#d73a49">&amp;</span><span style="color:#24292e"> (len</span><span style="color:#d73a49">-</span><span style="color:#005cc5">1</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">// 使用线性探测法向后查找元素，碰到 entry 为空时停止探测</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">for</span><span style="color:#24292e"> (ThreadLocal.ThreadLocalMap.Entry e </span><span style="color:#d73a49">=</span><span style="color:#24292e"> tab[i]; e </span><span style="color:#d73a49">!=</span><span style="color:#24292e"> </span><span style="color:#005cc5">null</span><span style="color:#24292e">; e </span><span style="color:#d73a49">=</span><span style="color:#24292e"> tab[i </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#6f42c1">nextIndex</span><span style="color:#24292e">(i, len)]) {</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6a737d">// 获取当前元素 key</span></span>
<span class="line"><span style="color:#24292e">        ThreadLocal&lt;</span><span style="color:#d73a49">?</span><span style="color:#24292e">&gt; k </span><span style="color:#d73a49">=</span><span style="color:#24292e"> e.</span><span style="color:#6f42c1">get</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6a737d">// ThreadLocal 对应的 key 存在，【直接覆盖之前的值】</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (k </span><span style="color:#d73a49">==</span><span style="color:#24292e"> key) {</span></span>
<span class="line"><span style="color:#24292e">            e.value </span><span style="color:#d73a49">=</span><span style="color:#24292e"> value;</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">return</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">        }</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6a737d">// 【这两个条件谁先成立不一定，所以 replaceStaleEntry 中还需要判断 k == key 的情况】</span></span>
<span class="line"><span style="color:#24292e">        </span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6a737d">// key 为 null，但是值不为 null，说明之前的 ThreadLocal 对象已经被回收了，当前是【过期数据】</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (k </span><span style="color:#d73a49">==</span><span style="color:#24292e"> </span><span style="color:#005cc5">null</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#6a737d">// 【碰到一个过期的 slot，当前数据复用该槽位，替换过期数据】</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#6a737d">// 这个方法还进行了垃圾清理动作，防止内存泄漏</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#6f42c1">replaceStaleEntry</span><span style="color:#24292e">(key, value, i);</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">return</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">        }</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"><span style="color:#24292e">	</span><span style="color:#6a737d">// 逻辑到这说明碰到 slot == null 的位置，则在空元素的位置创建一个新的 Entry</span></span>
<span class="line"><span style="color:#24292e">    tab[i] </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Entry</span><span style="color:#24292e">(key, value);</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">// 数量 + 1</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">int</span><span style="color:#24292e"> sz </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#d73a49">++</span><span style="color:#24292e">size;</span></span>
<span class="line"><span style="color:#24292e">    </span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">// 【做一次启发式清理】，如果没有清除任何 entry 并且【当前使用量达到了负载因子所定义，那么进行 rehash</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (</span><span style="color:#d73a49">!</span><span style="color:#6f42c1">cleanSomeSlots</span><span style="color:#24292e">(i, sz) </span><span style="color:#d73a49">&amp;&amp;</span><span style="color:#24292e"> sz </span><span style="color:#d73a49">&gt;=</span><span style="color:#24292e"> threshold)</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6a737d">// 扩容</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6f42c1">rehash</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">}</span></span></code></pre><button class="collapse"></button></div><div style="max-height:300px" class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6a737d">// 获取【环形数组】的下一个索引</span></span>
<span class="line"><span style="color:#f97583">private</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">static</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">nextIndex</span><span style="color:#e1e4e8">(</span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> i, </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> len) {</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">// 索引越界后从 0 开始继续获取</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> ((i </span><span style="color:#f97583">+</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">1</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">&lt;</span><span style="color:#e1e4e8"> len) </span><span style="color:#f97583">?</span><span style="color:#e1e4e8"> i </span><span style="color:#f97583">+</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">1</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">:</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6a737d">// 获取【环形数组】的下一个索引</span></span>
<span class="line"><span style="color:#d73a49">private</span><span style="color:#24292e"> </span><span style="color:#d73a49">static</span><span style="color:#24292e"> </span><span style="color:#d73a49">int</span><span style="color:#24292e"> </span><span style="color:#6f42c1">nextIndex</span><span style="color:#24292e">(</span><span style="color:#d73a49">int</span><span style="color:#24292e"> i, </span><span style="color:#d73a49">int</span><span style="color:#24292e"> len) {</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">// 索引越界后从 0 开始继续获取</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">return</span><span style="color:#24292e"> ((i </span><span style="color:#d73a49">+</span><span style="color:#24292e"> </span><span style="color:#005cc5">1</span><span style="color:#24292e"> </span><span style="color:#d73a49">&lt;</span><span style="color:#24292e"> len) </span><span style="color:#d73a49">?</span><span style="color:#24292e"> i </span><span style="color:#d73a49">+</span><span style="color:#24292e"> </span><span style="color:#005cc5">1</span><span style="color:#24292e"> </span><span style="color:#d73a49">:</span><span style="color:#24292e"> </span><span style="color:#005cc5">0</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">}</span></span></code></pre><button class="collapse"></button></div><div style="max-height:300px" class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6a737d">// 在指定位置插入指定的数据</span></span>
<span class="line"><span style="color:#f97583">private</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">void</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">replaceStaleEntry</span><span style="color:#e1e4e8">(ThreadLocal</span><span style="color:#f97583">&lt;?&gt;</span><span style="color:#e1e4e8"> key, Object value, </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> staleSlot) {</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">// 获取散列表</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">Entry</span><span style="color:#e1e4e8">[] tab </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> table;</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> len </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> tab.length;</span></span>
<span class="line"><span style="color:#e1e4e8">    Entry e;</span></span>
<span class="line"><span style="color:#e1e4e8">	</span><span style="color:#6a737d">// 探测式清理的开始下标，默认从当前 staleSlot 开始</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> slotToExpunge </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> staleSlot;</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">// 以当前 staleSlot 开始【向前迭代查找】，找到索引靠前过期数据，找到以后替换 slotToExpunge 值</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">// 【保证在一个区间段内，从最前面的过期数据开始清理】</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">for</span><span style="color:#e1e4e8"> (</span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> i </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">prevIndex</span><span style="color:#e1e4e8">(staleSlot, len); (e </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> tab[i]) </span><span style="color:#f97583">!=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8">; i </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">prevIndex</span><span style="color:#e1e4e8">(i, len))</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (e.</span><span style="color:#b392f0">get</span><span style="color:#e1e4e8">() </span><span style="color:#f97583">==</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8">)</span></span>
<span class="line"><span style="color:#e1e4e8">            slotToExpunge </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> i;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">	</span><span style="color:#6a737d">// 以 staleSlot 【向后去查找】，直到碰到 null 为止，还是线性探测</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">for</span><span style="color:#e1e4e8"> (</span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> i </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">nextIndex</span><span style="color:#e1e4e8">(staleSlot, len); (e </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> tab[i]) </span><span style="color:#f97583">!=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8">; i </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">nextIndex</span><span style="color:#e1e4e8">(i, len)) {</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#6a737d">// 获取当前节点的 key</span></span>
<span class="line"><span style="color:#e1e4e8">        ThreadLocal&lt;</span><span style="color:#f97583">?</span><span style="color:#e1e4e8">&gt; k </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> e.</span><span style="color:#b392f0">get</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">		</span><span style="color:#6a737d">// 条件成立说明是【替换逻辑】</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (k </span><span style="color:#f97583">==</span><span style="color:#e1e4e8"> key) {</span></span>
<span class="line"><span style="color:#e1e4e8">            e.value </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> value;</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#6a737d">// 因为本来要在 staleSlot 索引处插入该数据，现在找到了i索引处的key与数据一致</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#6a737d">// 但是 i 位置距离正确的位置更远，因为是向后查找，所以还是要在 staleSlot 位置插入当前 entry</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#6a737d">// 然后将 table[staleSlot] 这个过期数据放到当前循环到的 table[i] 这个位置，</span></span>
<span class="line"><span style="color:#e1e4e8">            tab[i] </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> tab[staleSlot];</span></span>
<span class="line"><span style="color:#e1e4e8">            tab[staleSlot] </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> e;</span></span>
<span class="line"><span style="color:#e1e4e8">			</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#6a737d">// 条件成立说明向前查找过期数据并未找到过期的 entry，但 staleSlot 位置已经不是过期数据了，i 位置才是</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (slotToExpunge </span><span style="color:#f97583">==</span><span style="color:#e1e4e8"> staleSlot)</span></span>
<span class="line"><span style="color:#e1e4e8">                slotToExpunge </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> i;</span></span>
<span class="line"><span style="color:#e1e4e8">            </span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#6a737d">// 【清理过期数据，expungeStaleEntry 探测式清理，cleanSomeSlots 启发式清理】</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#b392f0">cleanSomeSlots</span><span style="color:#e1e4e8">(</span><span style="color:#b392f0">expungeStaleEntry</span><span style="color:#e1e4e8">(slotToExpunge), len);</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">return</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">        }</span></span>
<span class="line"><span style="color:#e1e4e8">		</span><span style="color:#6a737d">// 条件成立说明当前遍历的 entry 是一个过期数据，并且该位置前面也没有过期数据</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (k </span><span style="color:#f97583">==</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">&amp;&amp;</span><span style="color:#e1e4e8"> slotToExpunge </span><span style="color:#f97583">==</span><span style="color:#e1e4e8"> staleSlot)</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#6a737d">// 探测式清理过期数据的开始下标修改为当前循环的 index，因为 staleSlot 会放入要添加的数据</span></span>
<span class="line"><span style="color:#e1e4e8">            slotToExpunge </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> i;</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"><span style="color:#e1e4e8">	</span><span style="color:#6a737d">// 向后查找过程中并未发现 k == key 的 entry，说明当前是一个【取代过期数据逻辑】</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">// 删除原有的数据引用，防止内存泄露</span></span>
<span class="line"><span style="color:#e1e4e8">    tab[staleSlot].value </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">// staleSlot 位置添加数据，【上面的所有逻辑都不会更改 staleSlot 的值】</span></span>
<span class="line"><span style="color:#e1e4e8">    tab[staleSlot] </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Entry</span><span style="color:#e1e4e8">(key, value);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">// 条件成立说明除了 staleSlot 以外，还发现其它的过期 slot，所以要【开启清理数据的逻辑】</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (slotToExpunge </span><span style="color:#f97583">!=</span><span style="color:#e1e4e8"> staleSlot)</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#b392f0">cleanSomeSlots</span><span style="color:#e1e4e8">(</span><span style="color:#b392f0">expungeStaleEntry</span><span style="color:#e1e4e8">(slotToExpunge), len);</span></span>
<span class="line"><span style="color:#e1e4e8">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6a737d">// 在指定位置插入指定的数据</span></span>
<span class="line"><span style="color:#d73a49">private</span><span style="color:#24292e"> </span><span style="color:#d73a49">void</span><span style="color:#24292e"> </span><span style="color:#6f42c1">replaceStaleEntry</span><span style="color:#24292e">(ThreadLocal</span><span style="color:#d73a49">&lt;?&gt;</span><span style="color:#24292e"> key, Object value, </span><span style="color:#d73a49">int</span><span style="color:#24292e"> staleSlot) {</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">// 获取散列表</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">Entry</span><span style="color:#24292e">[] tab </span><span style="color:#d73a49">=</span><span style="color:#24292e"> table;</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">int</span><span style="color:#24292e"> len </span><span style="color:#d73a49">=</span><span style="color:#24292e"> tab.length;</span></span>
<span class="line"><span style="color:#24292e">    Entry e;</span></span>
<span class="line"><span style="color:#24292e">	</span><span style="color:#6a737d">// 探测式清理的开始下标，默认从当前 staleSlot 开始</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">int</span><span style="color:#24292e"> slotToExpunge </span><span style="color:#d73a49">=</span><span style="color:#24292e"> staleSlot;</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">// 以当前 staleSlot 开始【向前迭代查找】，找到索引靠前过期数据，找到以后替换 slotToExpunge 值</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">// 【保证在一个区间段内，从最前面的过期数据开始清理】</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">for</span><span style="color:#24292e"> (</span><span style="color:#d73a49">int</span><span style="color:#24292e"> i </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#6f42c1">prevIndex</span><span style="color:#24292e">(staleSlot, len); (e </span><span style="color:#d73a49">=</span><span style="color:#24292e"> tab[i]) </span><span style="color:#d73a49">!=</span><span style="color:#24292e"> </span><span style="color:#005cc5">null</span><span style="color:#24292e">; i </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#6f42c1">prevIndex</span><span style="color:#24292e">(i, len))</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (e.</span><span style="color:#6f42c1">get</span><span style="color:#24292e">() </span><span style="color:#d73a49">==</span><span style="color:#24292e"> </span><span style="color:#005cc5">null</span><span style="color:#24292e">)</span></span>
<span class="line"><span style="color:#24292e">            slotToExpunge </span><span style="color:#d73a49">=</span><span style="color:#24292e"> i;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">	</span><span style="color:#6a737d">// 以 staleSlot 【向后去查找】，直到碰到 null 为止，还是线性探测</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">for</span><span style="color:#24292e"> (</span><span style="color:#d73a49">int</span><span style="color:#24292e"> i </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#6f42c1">nextIndex</span><span style="color:#24292e">(staleSlot, len); (e </span><span style="color:#d73a49">=</span><span style="color:#24292e"> tab[i]) </span><span style="color:#d73a49">!=</span><span style="color:#24292e"> </span><span style="color:#005cc5">null</span><span style="color:#24292e">; i </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#6f42c1">nextIndex</span><span style="color:#24292e">(i, len)) {</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6a737d">// 获取当前节点的 key</span></span>
<span class="line"><span style="color:#24292e">        ThreadLocal&lt;</span><span style="color:#d73a49">?</span><span style="color:#24292e">&gt; k </span><span style="color:#d73a49">=</span><span style="color:#24292e"> e.</span><span style="color:#6f42c1">get</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">		</span><span style="color:#6a737d">// 条件成立说明是【替换逻辑】</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (k </span><span style="color:#d73a49">==</span><span style="color:#24292e"> key) {</span></span>
<span class="line"><span style="color:#24292e">            e.value </span><span style="color:#d73a49">=</span><span style="color:#24292e"> value;</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#6a737d">// 因为本来要在 staleSlot 索引处插入该数据，现在找到了i索引处的key与数据一致</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#6a737d">// 但是 i 位置距离正确的位置更远，因为是向后查找，所以还是要在 staleSlot 位置插入当前 entry</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#6a737d">// 然后将 table[staleSlot] 这个过期数据放到当前循环到的 table[i] 这个位置，</span></span>
<span class="line"><span style="color:#24292e">            tab[i] </span><span style="color:#d73a49">=</span><span style="color:#24292e"> tab[staleSlot];</span></span>
<span class="line"><span style="color:#24292e">            tab[staleSlot] </span><span style="color:#d73a49">=</span><span style="color:#24292e"> e;</span></span>
<span class="line"><span style="color:#24292e">			</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#6a737d">// 条件成立说明向前查找过期数据并未找到过期的 entry，但 staleSlot 位置已经不是过期数据了，i 位置才是</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (slotToExpunge </span><span style="color:#d73a49">==</span><span style="color:#24292e"> staleSlot)</span></span>
<span class="line"><span style="color:#24292e">                slotToExpunge </span><span style="color:#d73a49">=</span><span style="color:#24292e"> i;</span></span>
<span class="line"><span style="color:#24292e">            </span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#6a737d">// 【清理过期数据，expungeStaleEntry 探测式清理，cleanSomeSlots 启发式清理】</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#6f42c1">cleanSomeSlots</span><span style="color:#24292e">(</span><span style="color:#6f42c1">expungeStaleEntry</span><span style="color:#24292e">(slotToExpunge), len);</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">return</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">        }</span></span>
<span class="line"><span style="color:#24292e">		</span><span style="color:#6a737d">// 条件成立说明当前遍历的 entry 是一个过期数据，并且该位置前面也没有过期数据</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (k </span><span style="color:#d73a49">==</span><span style="color:#24292e"> </span><span style="color:#005cc5">null</span><span style="color:#24292e"> </span><span style="color:#d73a49">&amp;&amp;</span><span style="color:#24292e"> slotToExpunge </span><span style="color:#d73a49">==</span><span style="color:#24292e"> staleSlot)</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#6a737d">// 探测式清理过期数据的开始下标修改为当前循环的 index，因为 staleSlot 会放入要添加的数据</span></span>
<span class="line"><span style="color:#24292e">            slotToExpunge </span><span style="color:#d73a49">=</span><span style="color:#24292e"> i;</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"><span style="color:#24292e">	</span><span style="color:#6a737d">// 向后查找过程中并未发现 k == key 的 entry，说明当前是一个【取代过期数据逻辑】</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">// 删除原有的数据引用，防止内存泄露</span></span>
<span class="line"><span style="color:#24292e">    tab[staleSlot].value </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#005cc5">null</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">// staleSlot 位置添加数据，【上面的所有逻辑都不会更改 staleSlot 的值】</span></span>
<span class="line"><span style="color:#24292e">    tab[staleSlot] </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Entry</span><span style="color:#24292e">(key, value);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">// 条件成立说明除了 staleSlot 以外，还发现其它的过期 slot，所以要【开启清理数据的逻辑】</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (slotToExpunge </span><span style="color:#d73a49">!=</span><span style="color:#24292e"> staleSlot)</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6f42c1">cleanSomeSlots</span><span style="color:#24292e">(</span><span style="color:#6f42c1">expungeStaleEntry</span><span style="color:#24292e">(slotToExpunge), len);</span></span>
<span class="line"><span style="color:#24292e">}</span></span></code></pre><button class="collapse"></button></div><figure><img alt="image-20230824171823217" class="lazy" data-src="https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230824171823217.png"></figure><div style="max-height:300px" class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#f97583">private</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">static</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">prevIndex</span><span style="color:#e1e4e8">(</span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> i, </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> len) {</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">// 形成一个环绕式的访问，头索引越界后置为尾索引</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> ((i </span><span style="color:#f97583">-</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">1</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">&gt;=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8">) </span><span style="color:#f97583">?</span><span style="color:#e1e4e8"> i </span><span style="color:#f97583">-</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">1</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">:</span><span style="color:#e1e4e8"> len </span><span style="color:#f97583">-</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">1</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#d73a49">private</span><span style="color:#24292e"> </span><span style="color:#d73a49">static</span><span style="color:#24292e"> </span><span style="color:#d73a49">int</span><span style="color:#24292e"> </span><span style="color:#6f42c1">prevIndex</span><span style="color:#24292e">(</span><span style="color:#d73a49">int</span><span style="color:#24292e"> i, </span><span style="color:#d73a49">int</span><span style="color:#24292e"> len) {</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">// 形成一个环绕式的访问，头索引越界后置为尾索引</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">return</span><span style="color:#24292e"> ((i </span><span style="color:#d73a49">-</span><span style="color:#24292e"> </span><span style="color:#005cc5">1</span><span style="color:#24292e"> </span><span style="color:#d73a49">&gt;=</span><span style="color:#24292e"> </span><span style="color:#005cc5">0</span><span style="color:#24292e">) </span><span style="color:#d73a49">?</span><span style="color:#24292e"> i </span><span style="color:#d73a49">-</span><span style="color:#24292e"> </span><span style="color:#005cc5">1</span><span style="color:#24292e"> </span><span style="color:#d73a49">:</span><span style="color:#24292e"> len </span><span style="color:#d73a49">-</span><span style="color:#24292e"> </span><span style="color:#005cc5">1</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">}</span></span></code></pre><button class="collapse"></button></div></li><li><p>getEntry()：ThreadLocal 的 get 方法以当前的 ThreadLocal 为 key，调用 getEntry 获取对应的存储实体 e</p><div style="max-height:300px" class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#f97583">private</span><span style="color:#e1e4e8"> Entry </span><span style="color:#b392f0">getEntry</span><span style="color:#e1e4e8">(ThreadLocal</span><span style="color:#f97583">&lt;?&gt;</span><span style="color:#e1e4e8"> key) {</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">// 哈希寻址</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> i </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> key.threadLocalHashCode </span><span style="color:#f97583">&amp;</span><span style="color:#e1e4e8"> (table.length </span><span style="color:#f97583">-</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">1</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">// 访问散列表中指定指定位置的 slot </span></span>
<span class="line"><span style="color:#e1e4e8">    Entry e </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> table[i];</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">// 条件成立，说明 slot 有值并且 key 就是要寻找的 key，直接返回</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (e </span><span style="color:#f97583">!=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">&amp;&amp;</span><span style="color:#e1e4e8"> e.</span><span style="color:#b392f0">get</span><span style="color:#e1e4e8">() </span><span style="color:#f97583">==</span><span style="color:#e1e4e8"> key)</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> e;</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">else</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#6a737d">// 进行线性探测</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">getEntryAfterMiss</span><span style="color:#e1e4e8">(key, i, e);</span></span>
<span class="line"><span style="color:#e1e4e8">}</span></span>
<span class="line"><span style="color:#6a737d">// 线性探测寻址</span></span>
<span class="line"><span style="color:#f97583">private</span><span style="color:#e1e4e8"> Entry </span><span style="color:#b392f0">getEntryAfterMiss</span><span style="color:#e1e4e8">(ThreadLocal</span><span style="color:#f97583">&lt;?&gt;</span><span style="color:#e1e4e8"> key, </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> i, Entry e) {</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">// 获取散列表</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">Entry</span><span style="color:#e1e4e8">[] tab </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> table;</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> len </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> tab.length;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">// 开始遍历，碰到 slot == null 的情况，搜索结束</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">while</span><span style="color:#e1e4e8"> (e </span><span style="color:#f97583">!=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">		</span><span style="color:#6a737d">// 获取当前 slot 中 entry 对象的 key</span></span>
<span class="line"><span style="color:#e1e4e8">        ThreadLocal&lt;</span><span style="color:#f97583">?</span><span style="color:#e1e4e8">&gt; k </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> e.</span><span style="color:#b392f0">get</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#6a737d">// 条件成立说明找到了，直接返回</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (k </span><span style="color:#f97583">==</span><span style="color:#e1e4e8"> key)</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> e;</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (k </span><span style="color:#f97583">==</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8">)</span></span>
<span class="line"><span style="color:#e1e4e8">             </span><span style="color:#6a737d">// 过期数据，【探测式过期数据回收】</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#b392f0">expungeStaleEntry</span><span style="color:#e1e4e8">(i);</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">else</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#6a737d">// 更新 index 继续向后走</span></span>
<span class="line"><span style="color:#e1e4e8">            i </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">nextIndex</span><span style="color:#e1e4e8">(i, len);</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#6a737d">// 获取下一个槽位中的 entry</span></span>
<span class="line"><span style="color:#e1e4e8">        e </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> tab[i];</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">// 说明当前区段没有找到相应数据</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">// 【因为存放数据是线性的向后寻找槽位，都是紧挨着的，不可能越过一个 空槽位 在后面放】，可以减少遍历的次数</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#d73a49">private</span><span style="color:#24292e"> Entry </span><span style="color:#6f42c1">getEntry</span><span style="color:#24292e">(ThreadLocal</span><span style="color:#d73a49">&lt;?&gt;</span><span style="color:#24292e"> key) {</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">// 哈希寻址</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">int</span><span style="color:#24292e"> i </span><span style="color:#d73a49">=</span><span style="color:#24292e"> key.threadLocalHashCode </span><span style="color:#d73a49">&amp;</span><span style="color:#24292e"> (table.length </span><span style="color:#d73a49">-</span><span style="color:#24292e"> </span><span style="color:#005cc5">1</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">// 访问散列表中指定指定位置的 slot </span></span>
<span class="line"><span style="color:#24292e">    Entry e </span><span style="color:#d73a49">=</span><span style="color:#24292e"> table[i];</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">// 条件成立，说明 slot 有值并且 key 就是要寻找的 key，直接返回</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (e </span><span style="color:#d73a49">!=</span><span style="color:#24292e"> </span><span style="color:#005cc5">null</span><span style="color:#24292e"> </span><span style="color:#d73a49">&amp;&amp;</span><span style="color:#24292e"> e.</span><span style="color:#6f42c1">get</span><span style="color:#24292e">() </span><span style="color:#d73a49">==</span><span style="color:#24292e"> key)</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">return</span><span style="color:#24292e"> e;</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">else</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6a737d">// 进行线性探测</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">return</span><span style="color:#24292e"> </span><span style="color:#6f42c1">getEntryAfterMiss</span><span style="color:#24292e">(key, i, e);</span></span>
<span class="line"><span style="color:#24292e">}</span></span>
<span class="line"><span style="color:#6a737d">// 线性探测寻址</span></span>
<span class="line"><span style="color:#d73a49">private</span><span style="color:#24292e"> Entry </span><span style="color:#6f42c1">getEntryAfterMiss</span><span style="color:#24292e">(ThreadLocal</span><span style="color:#d73a49">&lt;?&gt;</span><span style="color:#24292e"> key, </span><span style="color:#d73a49">int</span><span style="color:#24292e"> i, Entry e) {</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">// 获取散列表</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">Entry</span><span style="color:#24292e">[] tab </span><span style="color:#d73a49">=</span><span style="color:#24292e"> table;</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">int</span><span style="color:#24292e"> len </span><span style="color:#d73a49">=</span><span style="color:#24292e"> tab.length;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">// 开始遍历，碰到 slot == null 的情况，搜索结束</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">while</span><span style="color:#24292e"> (e </span><span style="color:#d73a49">!=</span><span style="color:#24292e"> </span><span style="color:#005cc5">null</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">		</span><span style="color:#6a737d">// 获取当前 slot 中 entry 对象的 key</span></span>
<span class="line"><span style="color:#24292e">        ThreadLocal&lt;</span><span style="color:#d73a49">?</span><span style="color:#24292e">&gt; k </span><span style="color:#d73a49">=</span><span style="color:#24292e"> e.</span><span style="color:#6f42c1">get</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6a737d">// 条件成立说明找到了，直接返回</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (k </span><span style="color:#d73a49">==</span><span style="color:#24292e"> key)</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">return</span><span style="color:#24292e"> e;</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (k </span><span style="color:#d73a49">==</span><span style="color:#24292e"> </span><span style="color:#005cc5">null</span><span style="color:#24292e">)</span></span>
<span class="line"><span style="color:#24292e">             </span><span style="color:#6a737d">// 过期数据，【探测式过期数据回收】</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#6f42c1">expungeStaleEntry</span><span style="color:#24292e">(i);</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">else</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#6a737d">// 更新 index 继续向后走</span></span>
<span class="line"><span style="color:#24292e">            i </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#6f42c1">nextIndex</span><span style="color:#24292e">(i, len);</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6a737d">// 获取下一个槽位中的 entry</span></span>
<span class="line"><span style="color:#24292e">        e </span><span style="color:#d73a49">=</span><span style="color:#24292e"> tab[i];</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">// 说明当前区段没有找到相应数据</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">// 【因为存放数据是线性的向后寻找槽位，都是紧挨着的，不可能越过一个 空槽位 在后面放】，可以减少遍历的次数</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">return</span><span style="color:#24292e"> </span><span style="color:#005cc5">null</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">}</span></span></code></pre><button class="collapse"></button></div></li><li><p>rehash()：触发一次全量清理，如果数组长度大于等于长度的 <code>2/3 * 3/4 = 1/2</code>，则进行 resize</p><div style="max-height:300px" class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#f97583">private</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">void</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">rehash</span><span style="color:#e1e4e8">() {</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">// 清除当前散列表内的【所有】过期的数据</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#b392f0">expungeStaleEntries</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">    </span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">// threshold = len * 2 / 3，就是 2/3 * (1 - 1/4)</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (size </span><span style="color:#f97583">&gt;=</span><span style="color:#e1e4e8"> threshold </span><span style="color:#f97583">-</span><span style="color:#e1e4e8"> threshold </span><span style="color:#f97583">/</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">4</span><span style="color:#e1e4e8">)</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#b392f0">resize</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#d73a49">private</span><span style="color:#24292e"> </span><span style="color:#d73a49">void</span><span style="color:#24292e"> </span><span style="color:#6f42c1">rehash</span><span style="color:#24292e">() {</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">// 清除当前散列表内的【所有】过期的数据</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6f42c1">expungeStaleEntries</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">    </span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">// threshold = len * 2 / 3，就是 2/3 * (1 - 1/4)</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (size </span><span style="color:#d73a49">&gt;=</span><span style="color:#24292e"> threshold </span><span style="color:#d73a49">-</span><span style="color:#24292e"> threshold </span><span style="color:#d73a49">/</span><span style="color:#24292e"> </span><span style="color:#005cc5">4</span><span style="color:#24292e">)</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6f42c1">resize</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">}</span></span></code></pre><button class="collapse"></button></div><div style="max-height:300px" class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#f97583">private</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">void</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">expungeStaleEntries</span><span style="color:#e1e4e8">() {</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">Entry</span><span style="color:#e1e4e8">[] tab </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> table;</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> len </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> tab.length;</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">// 【遍历所有的槽位，清理过期数据】</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">for</span><span style="color:#e1e4e8"> (</span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> j </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8">; j </span><span style="color:#f97583">&lt;</span><span style="color:#e1e4e8"> len; j</span><span style="color:#f97583">++</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">        Entry e </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> tab[j];</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (e </span><span style="color:#f97583">!=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">&amp;&amp;</span><span style="color:#e1e4e8"> e.</span><span style="color:#b392f0">get</span><span style="color:#e1e4e8">() </span><span style="color:#f97583">==</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8">)</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#b392f0">expungeStaleEntry</span><span style="color:#e1e4e8">(j);</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"><span style="color:#e1e4e8">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#d73a49">private</span><span style="color:#24292e"> </span><span style="color:#d73a49">void</span><span style="color:#24292e"> </span><span style="color:#6f42c1">expungeStaleEntries</span><span style="color:#24292e">() {</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">Entry</span><span style="color:#24292e">[] tab </span><span style="color:#d73a49">=</span><span style="color:#24292e"> table;</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">int</span><span style="color:#24292e"> len </span><span style="color:#d73a49">=</span><span style="color:#24292e"> tab.length;</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">// 【遍历所有的槽位，清理过期数据】</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">for</span><span style="color:#24292e"> (</span><span style="color:#d73a49">int</span><span style="color:#24292e"> j </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#005cc5">0</span><span style="color:#24292e">; j </span><span style="color:#d73a49">&lt;</span><span style="color:#24292e"> len; j</span><span style="color:#d73a49">++</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">        Entry e </span><span style="color:#d73a49">=</span><span style="color:#24292e"> tab[j];</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (e </span><span style="color:#d73a49">!=</span><span style="color:#24292e"> </span><span style="color:#005cc5">null</span><span style="color:#24292e"> </span><span style="color:#d73a49">&amp;&amp;</span><span style="color:#24292e"> e.</span><span style="color:#6f42c1">get</span><span style="color:#24292e">() </span><span style="color:#d73a49">==</span><span style="color:#24292e"> </span><span style="color:#005cc5">null</span><span style="color:#24292e">)</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#6f42c1">expungeStaleEntry</span><span style="color:#24292e">(j);</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"><span style="color:#24292e">}</span></span></code></pre><button class="collapse"></button></div><p>Entry <strong>数组扩容为原来的 2 倍</strong> ，重新计算 key 的散列值，如果遇到 key 为 null 的情况，会将其 value 也置为 null，帮助 GC</p><div style="max-height:300px" class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#f97583">private</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">void</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">resize</span><span style="color:#e1e4e8">() {</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">Entry</span><span style="color:#e1e4e8">[] oldTab </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> table;</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> oldLen </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> oldTab.length;</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">// 新数组的长度是老数组的二倍</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> newLen </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> oldLen </span><span style="color:#f97583">*</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">2</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">Entry</span><span style="color:#e1e4e8">[] newTab </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">Entry</span><span style="color:#e1e4e8">[newLen];</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">// 统计新table中的entry数量</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> count </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">	</span><span style="color:#6a737d">// 遍历老表，进行【数据迁移】</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">for</span><span style="color:#e1e4e8"> (</span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> j </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8">; j </span><span style="color:#f97583">&lt;</span><span style="color:#e1e4e8"> oldLen; </span><span style="color:#f97583">++</span><span style="color:#e1e4e8">j) {</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#6a737d">// 访问老表的指定位置的 entry</span></span>
<span class="line"><span style="color:#e1e4e8">        Entry e </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> oldTab[j];</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#6a737d">// 条件成立说明老表中该位置有数据，可能是过期数据也可能不是</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (e </span><span style="color:#f97583">!=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">            ThreadLocal&lt;</span><span style="color:#f97583">?</span><span style="color:#e1e4e8">&gt; k </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> e.</span><span style="color:#b392f0">get</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#6a737d">// 过期数据</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (k </span><span style="color:#f97583">==</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">                e.value </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8">; </span><span style="color:#6a737d">// Help the GC</span></span>
<span class="line"><span style="color:#e1e4e8">            } </span><span style="color:#f97583">else</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#6a737d">// 非过期数据，在新表中进行哈希寻址</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> h </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> k.threadLocalHashCode </span><span style="color:#f97583">&amp;</span><span style="color:#e1e4e8"> (newLen </span><span style="color:#f97583">-</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">1</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#6a737d">// 【线程探测】</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#f97583">while</span><span style="color:#e1e4e8"> (newTab[h] </span><span style="color:#f97583">!=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8">)</span></span>
<span class="line"><span style="color:#e1e4e8">                    h </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">nextIndex</span><span style="color:#e1e4e8">(h, newLen);</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#6a737d">// 将数据存放到新表合适的 slot 中</span></span>
<span class="line"><span style="color:#e1e4e8">                newTab[h] </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> e;</span></span>
<span class="line"><span style="color:#e1e4e8">                count</span><span style="color:#f97583">++</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">            }</span></span>
<span class="line"><span style="color:#e1e4e8">        }</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"><span style="color:#e1e4e8">	</span><span style="color:#6a737d">// 设置下一次触发扩容的指标：threshold = len * 2 / 3;</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#b392f0">setThreshold</span><span style="color:#e1e4e8">(newLen);</span></span>
<span class="line"><span style="color:#e1e4e8">    size </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> count;</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">// 将扩容后的新表赋值给 threadLocalMap 内部散列表数组引用</span></span>
<span class="line"><span style="color:#e1e4e8">    table </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> newTab;</span></span>
<span class="line"><span style="color:#e1e4e8">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#d73a49">private</span><span style="color:#24292e"> </span><span style="color:#d73a49">void</span><span style="color:#24292e"> </span><span style="color:#6f42c1">resize</span><span style="color:#24292e">() {</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">Entry</span><span style="color:#24292e">[] oldTab </span><span style="color:#d73a49">=</span><span style="color:#24292e"> table;</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">int</span><span style="color:#24292e"> oldLen </span><span style="color:#d73a49">=</span><span style="color:#24292e"> oldTab.length;</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">// 新数组的长度是老数组的二倍</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">int</span><span style="color:#24292e"> newLen </span><span style="color:#d73a49">=</span><span style="color:#24292e"> oldLen </span><span style="color:#d73a49">*</span><span style="color:#24292e"> </span><span style="color:#005cc5">2</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">Entry</span><span style="color:#24292e">[] newTab </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#d73a49">Entry</span><span style="color:#24292e">[newLen];</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">// 统计新table中的entry数量</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">int</span><span style="color:#24292e"> count </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#005cc5">0</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">	</span><span style="color:#6a737d">// 遍历老表，进行【数据迁移】</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">for</span><span style="color:#24292e"> (</span><span style="color:#d73a49">int</span><span style="color:#24292e"> j </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#005cc5">0</span><span style="color:#24292e">; j </span><span style="color:#d73a49">&lt;</span><span style="color:#24292e"> oldLen; </span><span style="color:#d73a49">++</span><span style="color:#24292e">j) {</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6a737d">// 访问老表的指定位置的 entry</span></span>
<span class="line"><span style="color:#24292e">        Entry e </span><span style="color:#d73a49">=</span><span style="color:#24292e"> oldTab[j];</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6a737d">// 条件成立说明老表中该位置有数据，可能是过期数据也可能不是</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (e </span><span style="color:#d73a49">!=</span><span style="color:#24292e"> </span><span style="color:#005cc5">null</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">            ThreadLocal&lt;</span><span style="color:#d73a49">?</span><span style="color:#24292e">&gt; k </span><span style="color:#d73a49">=</span><span style="color:#24292e"> e.</span><span style="color:#6f42c1">get</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#6a737d">// 过期数据</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (k </span><span style="color:#d73a49">==</span><span style="color:#24292e"> </span><span style="color:#005cc5">null</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">                e.value </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#005cc5">null</span><span style="color:#24292e">; </span><span style="color:#6a737d">// Help the GC</span></span>
<span class="line"><span style="color:#24292e">            } </span><span style="color:#d73a49">else</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#6a737d">// 非过期数据，在新表中进行哈希寻址</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#d73a49">int</span><span style="color:#24292e"> h </span><span style="color:#d73a49">=</span><span style="color:#24292e"> k.threadLocalHashCode </span><span style="color:#d73a49">&amp;</span><span style="color:#24292e"> (newLen </span><span style="color:#d73a49">-</span><span style="color:#24292e"> </span><span style="color:#005cc5">1</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#6a737d">// 【线程探测】</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#d73a49">while</span><span style="color:#24292e"> (newTab[h] </span><span style="color:#d73a49">!=</span><span style="color:#24292e"> </span><span style="color:#005cc5">null</span><span style="color:#24292e">)</span></span>
<span class="line"><span style="color:#24292e">                    h </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#6f42c1">nextIndex</span><span style="color:#24292e">(h, newLen);</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#6a737d">// 将数据存放到新表合适的 slot 中</span></span>
<span class="line"><span style="color:#24292e">                newTab[h] </span><span style="color:#d73a49">=</span><span style="color:#24292e"> e;</span></span>
<span class="line"><span style="color:#24292e">                count</span><span style="color:#d73a49">++</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">            }</span></span>
<span class="line"><span style="color:#24292e">        }</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"><span style="color:#24292e">	</span><span style="color:#6a737d">// 设置下一次触发扩容的指标：threshold = len * 2 / 3;</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6f42c1">setThreshold</span><span style="color:#24292e">(newLen);</span></span>
<span class="line"><span style="color:#24292e">    size </span><span style="color:#d73a49">=</span><span style="color:#24292e"> count;</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">// 将扩容后的新表赋值给 threadLocalMap 内部散列表数组引用</span></span>
<span class="line"><span style="color:#24292e">    table </span><span style="color:#d73a49">=</span><span style="color:#24292e"> newTab;</span></span>
<span class="line"><span style="color:#24292e">}</span></span></code></pre><button class="collapse"></button></div></li><li><p>remove()：删除 Entry</p><div style="max-height:300px" class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#f97583">private</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">void</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">remove</span><span style="color:#e1e4e8">(ThreadLocal</span><span style="color:#f97583">&lt;?&gt;</span><span style="color:#e1e4e8"> key) {</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">Entry</span><span style="color:#e1e4e8">[] tab </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> table;</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> len </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> tab.length;</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">// 哈希寻址</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> i </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> key.threadLocalHashCode </span><span style="color:#f97583">&amp;</span><span style="color:#e1e4e8"> (len</span><span style="color:#f97583">-</span><span style="color:#79b8ff">1</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">for</span><span style="color:#e1e4e8"> (Entry e </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> tab[i]; e </span><span style="color:#f97583">!=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8">; e </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> tab[i </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">nextIndex</span><span style="color:#e1e4e8">(i, len)]) {</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#6a737d">// 找到了对应的 key</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (e.</span><span style="color:#b392f0">get</span><span style="color:#e1e4e8">() </span><span style="color:#f97583">==</span><span style="color:#e1e4e8"> key) {</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#6a737d">// 设置 key 为 null</span></span>
<span class="line"><span style="color:#e1e4e8">            e.</span><span style="color:#b392f0">clear</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#6a737d">// 探测式清理</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#b392f0">expungeStaleEntry</span><span style="color:#e1e4e8">(i);</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">return</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">        }</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"><span style="color:#e1e4e8">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#d73a49">private</span><span style="color:#24292e"> </span><span style="color:#d73a49">void</span><span style="color:#24292e"> </span><span style="color:#6f42c1">remove</span><span style="color:#24292e">(ThreadLocal</span><span style="color:#d73a49">&lt;?&gt;</span><span style="color:#24292e"> key) {</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">Entry</span><span style="color:#24292e">[] tab </span><span style="color:#d73a49">=</span><span style="color:#24292e"> table;</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">int</span><span style="color:#24292e"> len </span><span style="color:#d73a49">=</span><span style="color:#24292e"> tab.length;</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">// 哈希寻址</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">int</span><span style="color:#24292e"> i </span><span style="color:#d73a49">=</span><span style="color:#24292e"> key.threadLocalHashCode </span><span style="color:#d73a49">&amp;</span><span style="color:#24292e"> (len</span><span style="color:#d73a49">-</span><span style="color:#005cc5">1</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">for</span><span style="color:#24292e"> (Entry e </span><span style="color:#d73a49">=</span><span style="color:#24292e"> tab[i]; e </span><span style="color:#d73a49">!=</span><span style="color:#24292e"> </span><span style="color:#005cc5">null</span><span style="color:#24292e">; e </span><span style="color:#d73a49">=</span><span style="color:#24292e"> tab[i </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#6f42c1">nextIndex</span><span style="color:#24292e">(i, len)]) {</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6a737d">// 找到了对应的 key</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (e.</span><span style="color:#6f42c1">get</span><span style="color:#24292e">() </span><span style="color:#d73a49">==</span><span style="color:#24292e"> key) {</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#6a737d">// 设置 key 为 null</span></span>
<span class="line"><span style="color:#24292e">            e.</span><span style="color:#6f42c1">clear</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#6a737d">// 探测式清理</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#6f42c1">expungeStaleEntry</span><span style="color:#24292e">(i);</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">return</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">        }</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"><span style="color:#24292e">}</span></span></code></pre><button class="collapse"></button></div></li></ul><hr><h5 id="清理方法" tabindex="-1">清理方法 <a aria-current="page" href="/posts/concurrent_programming_compilation_version-lock_free#清理方法" class="router-link-active router-link-exact-active header-anchor" aria-label="Permalink to &quot;清理方法&quot;"><!--[-->​<!--]--></a></h5><ul><li><p>探测式清理：沿着开始位置向后探测清理过期数据，沿途中碰到未过期数据则将此数据 rehash 在 table 数组中的定位，重定位后的元素理论上更接近 <code>i = entry.key &amp; (table.length - 1)</code>，让<strong>数据的排列更紧凑</strong>，会优化整个散列表查询性能</p><div style="max-height:300px" class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6a737d">// table[staleSlot] 是一个过期数据，以这个位置开始继续向后查找过期数据</span></span>
<span class="line"><span style="color:#f97583">private</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">expungeStaleEntry</span><span style="color:#e1e4e8">(</span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> staleSlot) {</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">// 获取散列表和数组长度</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">Entry</span><span style="color:#e1e4e8">[] tab </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> table;</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> len </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> tab.length;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">// help gc，先把当前过期的 entry 置空，在取消对 entry 的引用</span></span>
<span class="line"><span style="color:#e1e4e8">    tab[staleSlot].value </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">    tab[staleSlot] </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">// 数量-1</span></span>
<span class="line"><span style="color:#e1e4e8">    size</span><span style="color:#f97583">--</span><span style="color:#e1e4e8">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">    Entry e;</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> i;</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">// 从 staleSlot 开始向后遍历，直到碰到 slot == null 结束，【区间内清理过期数据】</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">for</span><span style="color:#e1e4e8"> (i </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">nextIndex</span><span style="color:#e1e4e8">(staleSlot, len); (e </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> tab[i]) </span><span style="color:#f97583">!=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8">; i </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">nextIndex</span><span style="color:#e1e4e8">(i, len)) {</span></span>
<span class="line"><span style="color:#e1e4e8">        ThreadLocal&lt;</span><span style="color:#f97583">?</span><span style="color:#e1e4e8">&gt; k </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> e.</span><span style="color:#b392f0">get</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#6a737d">// 当前 entry 是过期数据</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (k </span><span style="color:#f97583">==</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#6a737d">// help gc</span></span>
<span class="line"><span style="color:#e1e4e8">            e.value </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">            tab[i] </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">            size</span><span style="color:#f97583">--</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">        } </span><span style="color:#f97583">else</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#6a737d">// 当前 entry 不是过期数据的逻辑，【rehash】</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#6a737d">// 重新计算当前 entry 对应的 index</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> h </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> k.threadLocalHashCode </span><span style="color:#f97583">&amp;</span><span style="color:#e1e4e8"> (len </span><span style="color:#f97583">-</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">1</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#6a737d">// 条件成立说明当前 entry 存储时发生过 hash 冲突，向后偏移过了</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (h </span><span style="color:#f97583">!=</span><span style="color:#e1e4e8"> i) {</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#6a737d">// 当前位置置空</span></span>
<span class="line"><span style="color:#e1e4e8">                tab[i] </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#6a737d">// 以正确位置 h 开始，向后查找第一个可以存放 entry 的位置</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#f97583">while</span><span style="color:#e1e4e8"> (tab[h] </span><span style="color:#f97583">!=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8">)</span></span>
<span class="line"><span style="color:#e1e4e8">                    h </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">nextIndex</span><span style="color:#e1e4e8">(h, len);</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#6a737d">// 将当前元素放入到【距离正确位置更近的位置，有可能就是正确位置】</span></span>
<span class="line"><span style="color:#e1e4e8">                tab[h] </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> e;</span></span>
<span class="line"><span style="color:#e1e4e8">            }</span></span>
<span class="line"><span style="color:#e1e4e8">        }</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">// 返回 slot = null 的槽位索引，图例是 7，这个索引代表【索引前面的区间已经清理完成垃圾了】</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> i;</span></span>
<span class="line"><span style="color:#e1e4e8">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6a737d">// table[staleSlot] 是一个过期数据，以这个位置开始继续向后查找过期数据</span></span>
<span class="line"><span style="color:#d73a49">private</span><span style="color:#24292e"> </span><span style="color:#d73a49">int</span><span style="color:#24292e"> </span><span style="color:#6f42c1">expungeStaleEntry</span><span style="color:#24292e">(</span><span style="color:#d73a49">int</span><span style="color:#24292e"> staleSlot) {</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">// 获取散列表和数组长度</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">Entry</span><span style="color:#24292e">[] tab </span><span style="color:#d73a49">=</span><span style="color:#24292e"> table;</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">int</span><span style="color:#24292e"> len </span><span style="color:#d73a49">=</span><span style="color:#24292e"> tab.length;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">// help gc，先把当前过期的 entry 置空，在取消对 entry 的引用</span></span>
<span class="line"><span style="color:#24292e">    tab[staleSlot].value </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#005cc5">null</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">    tab[staleSlot] </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#005cc5">null</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">// 数量-1</span></span>
<span class="line"><span style="color:#24292e">    size</span><span style="color:#d73a49">--</span><span style="color:#24292e">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">    Entry e;</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">int</span><span style="color:#24292e"> i;</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">// 从 staleSlot 开始向后遍历，直到碰到 slot == null 结束，【区间内清理过期数据】</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">for</span><span style="color:#24292e"> (i </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#6f42c1">nextIndex</span><span style="color:#24292e">(staleSlot, len); (e </span><span style="color:#d73a49">=</span><span style="color:#24292e"> tab[i]) </span><span style="color:#d73a49">!=</span><span style="color:#24292e"> </span><span style="color:#005cc5">null</span><span style="color:#24292e">; i </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#6f42c1">nextIndex</span><span style="color:#24292e">(i, len)) {</span></span>
<span class="line"><span style="color:#24292e">        ThreadLocal&lt;</span><span style="color:#d73a49">?</span><span style="color:#24292e">&gt; k </span><span style="color:#d73a49">=</span><span style="color:#24292e"> e.</span><span style="color:#6f42c1">get</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6a737d">// 当前 entry 是过期数据</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (k </span><span style="color:#d73a49">==</span><span style="color:#24292e"> </span><span style="color:#005cc5">null</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#6a737d">// help gc</span></span>
<span class="line"><span style="color:#24292e">            e.value </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#005cc5">null</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">            tab[i] </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#005cc5">null</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">            size</span><span style="color:#d73a49">--</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">        } </span><span style="color:#d73a49">else</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#6a737d">// 当前 entry 不是过期数据的逻辑，【rehash】</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#6a737d">// 重新计算当前 entry 对应的 index</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">int</span><span style="color:#24292e"> h </span><span style="color:#d73a49">=</span><span style="color:#24292e"> k.threadLocalHashCode </span><span style="color:#d73a49">&amp;</span><span style="color:#24292e"> (len </span><span style="color:#d73a49">-</span><span style="color:#24292e"> </span><span style="color:#005cc5">1</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#6a737d">// 条件成立说明当前 entry 存储时发生过 hash 冲突，向后偏移过了</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (h </span><span style="color:#d73a49">!=</span><span style="color:#24292e"> i) {</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#6a737d">// 当前位置置空</span></span>
<span class="line"><span style="color:#24292e">                tab[i] </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#005cc5">null</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#6a737d">// 以正确位置 h 开始，向后查找第一个可以存放 entry 的位置</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#d73a49">while</span><span style="color:#24292e"> (tab[h] </span><span style="color:#d73a49">!=</span><span style="color:#24292e"> </span><span style="color:#005cc5">null</span><span style="color:#24292e">)</span></span>
<span class="line"><span style="color:#24292e">                    h </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#6f42c1">nextIndex</span><span style="color:#24292e">(h, len);</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#6a737d">// 将当前元素放入到【距离正确位置更近的位置，有可能就是正确位置】</span></span>
<span class="line"><span style="color:#24292e">                tab[h] </span><span style="color:#d73a49">=</span><span style="color:#24292e"> e;</span></span>
<span class="line"><span style="color:#24292e">            }</span></span>
<span class="line"><span style="color:#24292e">        }</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">// 返回 slot = null 的槽位索引，图例是 7，这个索引代表【索引前面的区间已经清理完成垃圾了】</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">return</span><span style="color:#24292e"> i;</span></span>
<span class="line"><span style="color:#24292e">}</span></span></code></pre><button class="collapse"></button></div><img src="https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230824171939245.png" alt="image-20230824171939245" style="zoom:80%"><img src="https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230824172017188.png" alt="image-20230824172017188" style="zoom:80%"></li><li><p>启发式清理：向后循环扫描过期数据，发现过期数据调用探测式清理方法，如果连续几次的循环都没有发现过期数据，就停止扫描</p><div style="max-height:300px" class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6a737d">//  i 表示启发式清理工作开始位置，一般是空 slot，n 一般传递的是 table.length </span></span>
<span class="line"><span style="color:#f97583">private</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">boolean</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">cleanSomeSlots</span><span style="color:#e1e4e8">(</span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> i, </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> n) {</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">// 表示启发式清理工作是否清除了过期数据</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">boolean</span><span style="color:#e1e4e8"> removed </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">false</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">// 获取当前 map 的散列表引用</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">Entry</span><span style="color:#e1e4e8">[] tab </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> table;</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> len </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> tab.length;</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">do</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#6a737d">// 获取下一个索引，因为探测式返回的 slot 为 null</span></span>
<span class="line"><span style="color:#e1e4e8">        i </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">nextIndex</span><span style="color:#e1e4e8">(i, len);</span></span>
<span class="line"><span style="color:#e1e4e8">        Entry e </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> tab[i];</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#6a737d">// 条件成立说明是过期的数据，key 被 gc 了</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (e </span><span style="color:#f97583">!=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">&amp;&amp;</span><span style="color:#e1e4e8"> e.</span><span style="color:#b392f0">get</span><span style="color:#e1e4e8">() </span><span style="color:#f97583">==</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#6a737d">// 【发现过期数据重置 n 为数组的长度】</span></span>
<span class="line"><span style="color:#e1e4e8">            n </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> len;</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#6a737d">// 表示清理过过期数据</span></span>
<span class="line"><span style="color:#e1e4e8">            removed </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">true</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#6a737d">// 以当前过期的 slot 为开始节点 做一次探测式清理工作</span></span>
<span class="line"><span style="color:#e1e4e8">            i </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">expungeStaleEntry</span><span style="color:#e1e4e8">(i);</span></span>
<span class="line"><span style="color:#e1e4e8">        }</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#6a737d">// 假设 table 长度为 16</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#6a737d">// 16 &gt;&gt;&gt; 1 ==&gt; 8，8 &gt;&gt;&gt; 1 ==&gt; 4，4 &gt;&gt;&gt; 1 ==&gt; 2，2 &gt;&gt;&gt; 1 ==&gt; 1，1 &gt;&gt;&gt; 1 ==&gt; 0</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#6a737d">// 连续经过这么多次循环【没有扫描到过期数据】，就停止循环，扫描到空 slot 不算，因为不是过期数据</span></span>
<span class="line"><span style="color:#e1e4e8">    } </span><span style="color:#f97583">while</span><span style="color:#e1e4e8"> ((n </span><span style="color:#f97583">&gt;&gt;&gt;=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">1</span><span style="color:#e1e4e8">) </span><span style="color:#f97583">!=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">    </span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">// 返回清除标记</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> removed;</span></span>
<span class="line"><span style="color:#e1e4e8">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6a737d">//  i 表示启发式清理工作开始位置，一般是空 slot，n 一般传递的是 table.length </span></span>
<span class="line"><span style="color:#d73a49">private</span><span style="color:#24292e"> </span><span style="color:#d73a49">boolean</span><span style="color:#24292e"> </span><span style="color:#6f42c1">cleanSomeSlots</span><span style="color:#24292e">(</span><span style="color:#d73a49">int</span><span style="color:#24292e"> i, </span><span style="color:#d73a49">int</span><span style="color:#24292e"> n) {</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">// 表示启发式清理工作是否清除了过期数据</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">boolean</span><span style="color:#24292e"> removed </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#005cc5">false</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">// 获取当前 map 的散列表引用</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">Entry</span><span style="color:#24292e">[] tab </span><span style="color:#d73a49">=</span><span style="color:#24292e"> table;</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">int</span><span style="color:#24292e"> len </span><span style="color:#d73a49">=</span><span style="color:#24292e"> tab.length;</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">do</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6a737d">// 获取下一个索引，因为探测式返回的 slot 为 null</span></span>
<span class="line"><span style="color:#24292e">        i </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#6f42c1">nextIndex</span><span style="color:#24292e">(i, len);</span></span>
<span class="line"><span style="color:#24292e">        Entry e </span><span style="color:#d73a49">=</span><span style="color:#24292e"> tab[i];</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6a737d">// 条件成立说明是过期的数据，key 被 gc 了</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (e </span><span style="color:#d73a49">!=</span><span style="color:#24292e"> </span><span style="color:#005cc5">null</span><span style="color:#24292e"> </span><span style="color:#d73a49">&amp;&amp;</span><span style="color:#24292e"> e.</span><span style="color:#6f42c1">get</span><span style="color:#24292e">() </span><span style="color:#d73a49">==</span><span style="color:#24292e"> </span><span style="color:#005cc5">null</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#6a737d">// 【发现过期数据重置 n 为数组的长度】</span></span>
<span class="line"><span style="color:#24292e">            n </span><span style="color:#d73a49">=</span><span style="color:#24292e"> len;</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#6a737d">// 表示清理过过期数据</span></span>
<span class="line"><span style="color:#24292e">            removed </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#005cc5">true</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#6a737d">// 以当前过期的 slot 为开始节点 做一次探测式清理工作</span></span>
<span class="line"><span style="color:#24292e">            i </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#6f42c1">expungeStaleEntry</span><span style="color:#24292e">(i);</span></span>
<span class="line"><span style="color:#24292e">        }</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6a737d">// 假设 table 长度为 16</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6a737d">// 16 &gt;&gt;&gt; 1 ==&gt; 8，8 &gt;&gt;&gt; 1 ==&gt; 4，4 &gt;&gt;&gt; 1 ==&gt; 2，2 &gt;&gt;&gt; 1 ==&gt; 1，1 &gt;&gt;&gt; 1 ==&gt; 0</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6a737d">// 连续经过这么多次循环【没有扫描到过期数据】，就停止循环，扫描到空 slot 不算，因为不是过期数据</span></span>
<span class="line"><span style="color:#24292e">    } </span><span style="color:#d73a49">while</span><span style="color:#24292e"> ((n </span><span style="color:#d73a49">&gt;&gt;&gt;=</span><span style="color:#24292e"> </span><span style="color:#005cc5">1</span><span style="color:#24292e">) </span><span style="color:#d73a49">!=</span><span style="color:#24292e"> </span><span style="color:#005cc5">0</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">    </span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">// 返回清除标记</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">return</span><span style="color:#24292e"> removed;</span></span>
<span class="line"><span style="color:#24292e">}</span></span></code></pre><button class="collapse"></button></div></li></ul><p>参考视频：<a target="_blank" rel="noreferrer" href="https://space.bilibili.com/457326371/"><!--[-->https://space.bilibili.com/457326371/<!--]--><!----></a></p><hr><h4 id="内存泄漏" tabindex="-1">内存泄漏 <a aria-current="page" href="/posts/concurrent_programming_compilation_version-lock_free#内存泄漏" class="router-link-active router-link-exact-active header-anchor" aria-label="Permalink to &quot;内存泄漏&quot;"><!--[-->​<!--]--></a></h4><p>Memory leak：内存泄漏是指程序中动态分配的堆内存由于某种原因未释放或无法释放，造成系统内存的浪费，导致程序运行速度减慢甚至系统崩溃等严重后果，内存泄漏的堆积终将导致内存溢出</p><ul><li><p>如果 key 使用强引用：使用完 ThreadLocal ，threadLocal Ref 被回收，但是 threadLocalMap 的 Entry 强引用了 threadLocal，造成 threadLocal 无法被回收，无法完全避免内存泄漏</p><img src="https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230824172101315.png" alt="image-20230824172101315" style="zoom:80%"></li><li><p>如果 key 使用弱引用：使用完 ThreadLocal ，threadLocal Ref 被回收，ThreadLocalMap 只持有 ThreadLocal 的弱引用，所以threadlocal 也可以被回收，此时 Entry 中的 key = null。但没有手动删除这个 Entry 或者 CurrentThread 依然运行，依然存在强引用链，value 不会被回收，而这块 value 永远不会被访问到，也会导致 value 内存泄漏</p><img src="https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230824172141253.png" alt="image-20230824172141253" style="zoom:80%"></li><li><p>两个主要原因：</p><ul><li>没有手动删除这个 Entry</li><li>CurrentThread 依然运行</li></ul></li></ul><p>根本原因：ThreadLocalMap 是 Thread的一个属性，<strong>生命周期跟 Thread 一样长</strong>，如果没有手动删除对应 Entry 就会导致内存泄漏</p><p>解决方法：使用完 ThreadLocal 中存储的内容后将它 remove 掉就可以</p><p>ThreadLocal 内部解决方法：在 ThreadLocalMap 中的 set/getEntry 方法中，通过线性探测法对 key 进行判断，如果 key 为 null（ThreadLocal 为 null）会对 Entry 进行垃圾回收。所以<strong>使用弱引用比强引用多一层保障</strong>，就算不调用 remove，也有机会进行 GC</p><hr><h4 id="补充-内存释放时机" tabindex="-1">补充：内存释放时机 <a aria-current="page" href="/posts/concurrent_programming_compilation_version-lock_free#补充-内存释放时机" class="router-link-active router-link-exact-active header-anchor" aria-label="Permalink to &quot;补充：内存释放时机&quot;"><!--[-->​<!--]--></a></h4><ul><li>被动 GC 释放 key<ul><li>仅是让 key 的内存释放，关联 value 的内存并不会释放</li></ul></li><li>懒惰被动释放 value<ul><li>get key 时，发现是 null key，则释放其 value 内存</li><li>set key 时，会使用启发式扫描，清除临近的 null key 的 value 内存，启发次数与元素个数，是否发现 null key 有关</li></ul></li><li>主动 remove 释放 key，value<ul><li>会同时释放 key，value 的内存，也会清除临近的 null key 的 value 内存</li><li>推荐使用它，因为一般使用 ThreadLocal 时都把它作为静态变量（即强引用），因此无法被动依靠 GC 回收</li></ul></li></ul><blockquote><ul><li>threadLocal是弱引用作为key来存储的，当下面线程1一直处于运行状态，不断的插入元素，这样键值就会越来越多，这时只能等GC垃圾回收了，如果threadLocal设计成强引用就不能被垃圾回收了（即使别的地方都没有引用threadLocal，只要threadLocalMap使用强引用引用资源，那被引用的资源就得不到释放），所以弱引用引用资源将来没人引用了就会被回收，但值是强引用的，GC仅是让key的内存释放，后续还要根据 key 是否为 null来进一步释放值的内存</li><li>GC垃圾回收时，把未被引用的threadLocal（a）清理掉，变为null，值还在；当新的threadLocal（c）去get这个key为Null的位置时，此时值就会被垃圾回收掉，变为Null；当get一个空闲位置时，map就会把当前新的threadLocal（d）作为key，但值为Null</li></ul><figure><img alt="image-20230421195247137" class="lazy" data-src="https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230421195247137.png"></figure><ul><li>当在被垃圾回收掉key的位置set（8）时，不光清理掉当前位置的值（清理并存储），还会把相邻位置也一起清理掉（9,10 的 k v），但离得比较远的位置就不会去清理（14）</li></ul><figure><img alt="image-20230421195536553" class="lazy" data-src="https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230421195536553.png"></figure><ul><li>一般情况是没有其他地方引用threadLocal就会被垃圾回收，key=Null，get，set发现Nullkey才会进一步清理value</li><li>实际情况是用静态变量来引用threadLocal对象，即静态变量跟这个对象为强引用，所以静态变量一直强引用使用对象，垃圾回收不了，即使threadLocal是弱引用，但是静态变量对threadLocal一直保持强引用状态，所以懒惰被动释放 value的两种方式是行不通的</li><li>使用remove主动清理直接将map的键值清理掉，前两种方式清理（get set）会产生内存泄露，需要用remove来及时清理；假设长时间运行的线程池资源（含threadLocal关联静态资源）没有即使清理的话，就会积累越来越多的键值资源，还有其他的静态变量强引用key，GC也没办法把它们回收，久而久之就会造成内存泄漏</li></ul><figure><img alt="image-20230421200401064" class="lazy" data-src="https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230421200401064.png"></figure></blockquote><hr><h4 id="变量传递" tabindex="-1">变量传递 <a aria-current="page" href="/posts/concurrent_programming_compilation_version-lock_free#变量传递" class="router-link-active router-link-exact-active header-anchor" aria-label="Permalink to &quot;变量传递&quot;"><!--[-->​<!--]--></a></h4><h5 id="基本使用-1" tabindex="-1">基本使用 <a aria-current="page" href="/posts/concurrent_programming_compilation_version-lock_free#基本使用-1" class="router-link-active router-link-exact-active header-anchor" aria-label="Permalink to &quot;基本使用&quot;"><!--[-->​<!--]--></a></h5><p>父子线程：创建子线程的线程是父线程，比如实例中的 main 线程就是父线程</p><p>ThreadLocal 中存储的是线程的局部变量，如果想<strong>实现线程间局部变量传递</strong>可以使用 InheritableThreadLocal 类</p><div style="max-height:300px" class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">static</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">void</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">main</span><span style="color:#e1e4e8">(</span><span style="color:#f97583">String</span><span style="color:#e1e4e8">[] args) {</span></span>
<span class="line"><span style="color:#e1e4e8">    ThreadLocal&lt;</span><span style="color:#f97583">String</span><span style="color:#e1e4e8">&gt; threadLocal </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> InheritableThreadLocal&lt;&gt;();</span></span>
<span class="line"><span style="color:#e1e4e8">    threadLocal.</span><span style="color:#b392f0">set</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"父线程设置的值"</span><span style="color:#e1e4e8">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Thread</span><span style="color:#e1e4e8">(() </span><span style="color:#f97583">-&gt;</span><span style="color:#e1e4e8"> System.out.</span><span style="color:#b392f0">println</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"子线程输出："</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">+</span><span style="color:#e1e4e8"> threadLocal.</span><span style="color:#b392f0">get</span><span style="color:#e1e4e8">())).</span><span style="color:#b392f0">start</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">}</span></span>
<span class="line"><span style="color:#6a737d">// 子线程输出：父线程设置的值</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">static</span><span style="color:#24292e"> </span><span style="color:#d73a49">void</span><span style="color:#24292e"> </span><span style="color:#6f42c1">main</span><span style="color:#24292e">(</span><span style="color:#d73a49">String</span><span style="color:#24292e">[] args) {</span></span>
<span class="line"><span style="color:#24292e">    ThreadLocal&lt;</span><span style="color:#d73a49">String</span><span style="color:#24292e">&gt; threadLocal </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> InheritableThreadLocal&lt;&gt;();</span></span>
<span class="line"><span style="color:#24292e">    threadLocal.</span><span style="color:#6f42c1">set</span><span style="color:#24292e">(</span><span style="color:#032f62">"父线程设置的值"</span><span style="color:#24292e">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Thread</span><span style="color:#24292e">(() </span><span style="color:#d73a49">-&gt;</span><span style="color:#24292e"> System.out.</span><span style="color:#6f42c1">println</span><span style="color:#24292e">(</span><span style="color:#032f62">"子线程输出："</span><span style="color:#24292e"> </span><span style="color:#d73a49">+</span><span style="color:#24292e"> threadLocal.</span><span style="color:#6f42c1">get</span><span style="color:#24292e">())).</span><span style="color:#6f42c1">start</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">}</span></span>
<span class="line"><span style="color:#6a737d">// 子线程输出：父线程设置的值</span></span></code></pre><button class="collapse"></button></div><hr><h5 id="实现原理-1" tabindex="-1">实现原理 <a aria-current="page" href="/posts/concurrent_programming_compilation_version-lock_free#实现原理-1" class="router-link-active router-link-exact-active header-anchor" aria-label="Permalink to &quot;实现原理&quot;"><!--[-->​<!--]--></a></h5><p>InheritableThreadLocal 源码：</p><div style="max-height:300px" class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">class</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">InheritableThreadLocal</span><span style="color:#e1e4e8">&lt;</span><span style="color:#f97583">T</span><span style="color:#e1e4e8">&gt; </span><span style="color:#f97583">extends</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">ThreadLocal</span><span style="color:#e1e4e8">&lt;</span><span style="color:#f97583">T</span><span style="color:#e1e4e8">&gt; {</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">protected</span><span style="color:#e1e4e8"> T </span><span style="color:#b392f0">childValue</span><span style="color:#e1e4e8">(T </span><span style="color:#ffab70">parentValue</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> parentValue;</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"><span style="color:#e1e4e8">    ThreadLocalMap </span><span style="color:#b392f0">getMap</span><span style="color:#e1e4e8">(Thread </span><span style="color:#ffab70">t</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">       </span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> t.inheritableThreadLocals;</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">void</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">createMap</span><span style="color:#e1e4e8">(Thread </span><span style="color:#ffab70">t</span><span style="color:#e1e4e8">, T </span><span style="color:#ffab70">firstValue</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">        t.inheritableThreadLocals </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">ThreadLocalMap</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">this</span><span style="color:#e1e4e8">, firstValue);</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"><span style="color:#e1e4e8">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">class</span><span style="color:#24292e"> </span><span style="color:#6f42c1">InheritableThreadLocal</span><span style="color:#24292e">&lt;</span><span style="color:#d73a49">T</span><span style="color:#24292e">&gt; </span><span style="color:#d73a49">extends</span><span style="color:#24292e"> </span><span style="color:#6f42c1">ThreadLocal</span><span style="color:#24292e">&lt;</span><span style="color:#d73a49">T</span><span style="color:#24292e">&gt; {</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">protected</span><span style="color:#24292e"> T </span><span style="color:#6f42c1">childValue</span><span style="color:#24292e">(T </span><span style="color:#e36209">parentValue</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">return</span><span style="color:#24292e"> parentValue;</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"><span style="color:#24292e">    ThreadLocalMap </span><span style="color:#6f42c1">getMap</span><span style="color:#24292e">(Thread </span><span style="color:#e36209">t</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">       </span><span style="color:#d73a49">return</span><span style="color:#24292e"> t.inheritableThreadLocals;</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">void</span><span style="color:#24292e"> </span><span style="color:#6f42c1">createMap</span><span style="color:#24292e">(Thread </span><span style="color:#e36209">t</span><span style="color:#24292e">, T </span><span style="color:#e36209">firstValue</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">        t.inheritableThreadLocals </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">ThreadLocalMap</span><span style="color:#24292e">(</span><span style="color:#005cc5">this</span><span style="color:#24292e">, firstValue);</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"><span style="color:#24292e">}</span></span></code></pre><button class="collapse"></button></div><p>实现父子线程间的局部变量共享需要追溯到 Thread 对象的构造方法：</p><div style="max-height:300px" class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#f97583">private</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">void</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">init</span><span style="color:#e1e4e8">(ThreadGroup g, Runnable target, String name, </span><span style="color:#f97583">long</span><span style="color:#e1e4e8"> stackSize, AccessControlContext acc,</span></span>
<span class="line"><span style="color:#e1e4e8">                  </span><span style="color:#6a737d">// 该参数默认是 true</span></span>
<span class="line"><span style="color:#e1e4e8">                  </span><span style="color:#f97583">boolean</span><span style="color:#e1e4e8"> inheritThreadLocals) {</span></span>
<span class="line"><span style="color:#e1e4e8">  	</span><span style="color:#6a737d">// ...</span></span>
<span class="line"><span style="color:#e1e4e8">    Thread parent </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">currentThread</span><span style="color:#e1e4e8">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">// 判断父线程（创建子线程的线程）的 inheritableThreadLocals 属性不为 null</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (inheritThreadLocals </span><span style="color:#f97583">&amp;&amp;</span><span style="color:#e1e4e8"> parent.inheritableThreadLocals </span><span style="color:#f97583">!=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#6a737d">// 复制父线程的 inheritableThreadLocals 属性，实现父子线程局部变量共享</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#79b8ff">this</span><span style="color:#e1e4e8">.inheritableThreadLocals </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> ThreadLocal.</span><span style="color:#b392f0">createInheritedMap</span><span style="color:#e1e4e8">(parent.inheritableThreadLocals); </span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">// ..</span></span>
<span class="line"><span style="color:#e1e4e8">}</span></span>
<span class="line"><span style="color:#6a737d">// 【本质上还是创建 ThreadLocalMap，只是把父类中的可继承数据设置进去了】</span></span>
<span class="line"><span style="color:#f97583">static</span><span style="color:#e1e4e8"> ThreadLocalMap </span><span style="color:#b392f0">createInheritedMap</span><span style="color:#e1e4e8">(ThreadLocalMap parentMap) {</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">ThreadLocalMap</span><span style="color:#e1e4e8">(parentMap);</span></span>
<span class="line"><span style="color:#e1e4e8">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#d73a49">private</span><span style="color:#24292e"> </span><span style="color:#d73a49">void</span><span style="color:#24292e"> </span><span style="color:#6f42c1">init</span><span style="color:#24292e">(ThreadGroup g, Runnable target, String name, </span><span style="color:#d73a49">long</span><span style="color:#24292e"> stackSize, AccessControlContext acc,</span></span>
<span class="line"><span style="color:#24292e">                  </span><span style="color:#6a737d">// 该参数默认是 true</span></span>
<span class="line"><span style="color:#24292e">                  </span><span style="color:#d73a49">boolean</span><span style="color:#24292e"> inheritThreadLocals) {</span></span>
<span class="line"><span style="color:#24292e">  	</span><span style="color:#6a737d">// ...</span></span>
<span class="line"><span style="color:#24292e">    Thread parent </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#6f42c1">currentThread</span><span style="color:#24292e">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">// 判断父线程（创建子线程的线程）的 inheritableThreadLocals 属性不为 null</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (inheritThreadLocals </span><span style="color:#d73a49">&amp;&amp;</span><span style="color:#24292e"> parent.inheritableThreadLocals </span><span style="color:#d73a49">!=</span><span style="color:#24292e"> </span><span style="color:#005cc5">null</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6a737d">// 复制父线程的 inheritableThreadLocals 属性，实现父子线程局部变量共享</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#005cc5">this</span><span style="color:#24292e">.inheritableThreadLocals </span><span style="color:#d73a49">=</span><span style="color:#24292e"> ThreadLocal.</span><span style="color:#6f42c1">createInheritedMap</span><span style="color:#24292e">(parent.inheritableThreadLocals); </span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">// ..</span></span>
<span class="line"><span style="color:#24292e">}</span></span>
<span class="line"><span style="color:#6a737d">// 【本质上还是创建 ThreadLocalMap，只是把父类中的可继承数据设置进去了】</span></span>
<span class="line"><span style="color:#d73a49">static</span><span style="color:#24292e"> ThreadLocalMap </span><span style="color:#6f42c1">createInheritedMap</span><span style="color:#24292e">(ThreadLocalMap parentMap) {</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">return</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">ThreadLocalMap</span><span style="color:#24292e">(parentMap);</span></span>
<span class="line"><span style="color:#24292e">}</span></span></code></pre><button class="collapse"></button></div><div style="max-height:300px" class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#f97583">private</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">ThreadLocalMap</span><span style="color:#e1e4e8">(ThreadLocalMap parentMap) {</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">// 获取父线程的哈希表</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">Entry</span><span style="color:#e1e4e8">[] parentTable </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> parentMap.table;</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> len </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> parentTable.length;</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#b392f0">setThreshold</span><span style="color:#e1e4e8">(len);</span></span>
<span class="line"><span style="color:#e1e4e8">    table </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">Entry</span><span style="color:#e1e4e8">[len];</span></span>
<span class="line"><span style="color:#e1e4e8">	</span><span style="color:#6a737d">// 【逐个复制父线程 ThreadLocalMap 中的数据】</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">for</span><span style="color:#e1e4e8"> (</span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> j </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8">; j </span><span style="color:#f97583">&lt;</span><span style="color:#e1e4e8"> len; j</span><span style="color:#f97583">++</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">        Entry e </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> parentTable[j];</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (e </span><span style="color:#f97583">!=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">            ThreadLocal&lt;</span><span style="color:#f97583">Object</span><span style="color:#e1e4e8">&gt; key </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> (ThreadLocal</span><span style="color:#f97583">&lt;</span><span style="color:#e1e4e8">Object</span><span style="color:#f97583">&gt;</span><span style="color:#e1e4e8">) e.</span><span style="color:#b392f0">get</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (key </span><span style="color:#f97583">!=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#6a737d">// 调用的是 InheritableThreadLocal#childValue(T parentValue)</span></span>
<span class="line"><span style="color:#e1e4e8">                Object value </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> key.</span><span style="color:#b392f0">childValue</span><span style="color:#e1e4e8">(e.value);</span></span>
<span class="line"><span style="color:#e1e4e8">                Entry c </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Entry</span><span style="color:#e1e4e8">(key, value);</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> h </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> key.threadLocalHashCode </span><span style="color:#f97583">&amp;</span><span style="color:#e1e4e8"> (len </span><span style="color:#f97583">-</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">1</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#6a737d">// 线性探测</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#f97583">while</span><span style="color:#e1e4e8"> (table[h] </span><span style="color:#f97583">!=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8">)</span></span>
<span class="line"><span style="color:#e1e4e8">                    h </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">nextIndex</span><span style="color:#e1e4e8">(h, len);</span></span>
<span class="line"><span style="color:#e1e4e8">                table[h] </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> c;</span></span>
<span class="line"><span style="color:#e1e4e8">                size</span><span style="color:#f97583">++</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">            }</span></span>
<span class="line"><span style="color:#e1e4e8">        }</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"><span style="color:#e1e4e8">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#d73a49">private</span><span style="color:#24292e"> </span><span style="color:#6f42c1">ThreadLocalMap</span><span style="color:#24292e">(ThreadLocalMap parentMap) {</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">// 获取父线程的哈希表</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">Entry</span><span style="color:#24292e">[] parentTable </span><span style="color:#d73a49">=</span><span style="color:#24292e"> parentMap.table;</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">int</span><span style="color:#24292e"> len </span><span style="color:#d73a49">=</span><span style="color:#24292e"> parentTable.length;</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6f42c1">setThreshold</span><span style="color:#24292e">(len);</span></span>
<span class="line"><span style="color:#24292e">    table </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#d73a49">Entry</span><span style="color:#24292e">[len];</span></span>
<span class="line"><span style="color:#24292e">	</span><span style="color:#6a737d">// 【逐个复制父线程 ThreadLocalMap 中的数据】</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">for</span><span style="color:#24292e"> (</span><span style="color:#d73a49">int</span><span style="color:#24292e"> j </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#005cc5">0</span><span style="color:#24292e">; j </span><span style="color:#d73a49">&lt;</span><span style="color:#24292e"> len; j</span><span style="color:#d73a49">++</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">        Entry e </span><span style="color:#d73a49">=</span><span style="color:#24292e"> parentTable[j];</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (e </span><span style="color:#d73a49">!=</span><span style="color:#24292e"> </span><span style="color:#005cc5">null</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">            ThreadLocal&lt;</span><span style="color:#d73a49">Object</span><span style="color:#24292e">&gt; key </span><span style="color:#d73a49">=</span><span style="color:#24292e"> (ThreadLocal</span><span style="color:#d73a49">&lt;</span><span style="color:#24292e">Object</span><span style="color:#d73a49">&gt;</span><span style="color:#24292e">) e.</span><span style="color:#6f42c1">get</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (key </span><span style="color:#d73a49">!=</span><span style="color:#24292e"> </span><span style="color:#005cc5">null</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#6a737d">// 调用的是 InheritableThreadLocal#childValue(T parentValue)</span></span>
<span class="line"><span style="color:#24292e">                Object value </span><span style="color:#d73a49">=</span><span style="color:#24292e"> key.</span><span style="color:#6f42c1">childValue</span><span style="color:#24292e">(e.value);</span></span>
<span class="line"><span style="color:#24292e">                Entry c </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Entry</span><span style="color:#24292e">(key, value);</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#d73a49">int</span><span style="color:#24292e"> h </span><span style="color:#d73a49">=</span><span style="color:#24292e"> key.threadLocalHashCode </span><span style="color:#d73a49">&amp;</span><span style="color:#24292e"> (len </span><span style="color:#d73a49">-</span><span style="color:#24292e"> </span><span style="color:#005cc5">1</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#6a737d">// 线性探测</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#d73a49">while</span><span style="color:#24292e"> (table[h] </span><span style="color:#d73a49">!=</span><span style="color:#24292e"> </span><span style="color:#005cc5">null</span><span style="color:#24292e">)</span></span>
<span class="line"><span style="color:#24292e">                    h </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#6f42c1">nextIndex</span><span style="color:#24292e">(h, len);</span></span>
<span class="line"><span style="color:#24292e">                table[h] </span><span style="color:#d73a49">=</span><span style="color:#24292e"> c;</span></span>
<span class="line"><span style="color:#24292e">                size</span><span style="color:#d73a49">++</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">            }</span></span>
<span class="line"><span style="color:#24292e">        }</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"><span style="color:#24292e">}</span></span></code></pre><button class="collapse"></button></div><p>参考文章：<a target="_blank" rel="noreferrer" href="https://blog.csdn.net/feichitianxia/article/details/110495764"><!--[-->https://blog.csdn.net/feichitianxia/article/details/110495764<!--]--><!----></a></p><hr><!--]--><!--[--><!--]--><!--]--><!----><!----></article></template><!--]--><!--[--><!--[--><!--[--><div class="yun-sponsor-container flex-center flex-col" m="t-6"><button class="sponsor-button yun-icon-btn shadow hover:shadow-md" title="打赏" text="red-400"><div i-ri-heart-line></div></button><div m="y-4" class="qrcode-container qrcode flex-center flex-col"><div class="sponsor-description" mb="4" text="sm">多少都是支持！</div><div class="flex justify-around"><!--[--><a class="flex-center flex-col animate-iteration-1 animate-fade-in" href="https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/alipay.jpg" target="_blank" style="color:#00a3ee"><img class="sponsor-method-img" border="~ rounded" p="1" loading="lazy" src="https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/alipay.jpg" title="支付宝"><div text="xl" m="2" class="i-ri-alipay-line"></div></a><a class="flex-center flex-col animate-iteration-1 animate-fade-in" href="https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/wechat.png" target="_blank" style="color:#2dc100"><img class="sponsor-method-img" border="~ rounded" p="1" loading="lazy" src="https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/wechat.png" title="微信支付"><div text="xl" m="2" class="i-ri-wechat-pay-line"></div></a><!--]--></div></div></div><ul class="post-copyright" m="y-4"><li class="post-copyright-author"><strong>本文作者：</strong><span>imklaus</span></li><li class="post-copyright-link"><strong>本文链接：</strong><a href="https://imlklaus.github.io/posts/concurrent_programming_compilation_version-lock_free" target="_blank" title="本文链接">https://imlklaus.github.io/posts/concurrent_programming_compilation_version-lock_free</a></li><li class="post-copyright-license"><strong>版权声明：</strong><span>本博客所有文章除特别声明外，均默认采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" target="_blank" rel="noopener" title="CC BY-NC-SA 4.0 ">CC BY-NC-SA</a> 许可协议。</span></li></ul><!--]--><!--]--><!--]--></div><!--]--><!----></div><!--[--><!--]--><!--[--><div class="post-nav"><div class="post-nav-item"><a href="/posts/concurrent_programming_compilation_version-threadpool" class="post-nav-prev" title="并发编程整理版-线程池"><div class="icon" i-ri-arrow-left-s-line></div><span class="title truncate" text="sm">并发编程整理版-线程池</span></a></div><div class="post-nav-item"><a href="/posts/concurrent_programming_compilation_version-memory" class="post-nav-next" title="并发编程整理版-内存"><span class="title truncate" text="sm">并发编程整理版-内存</span><div class="icon" i-ri-arrow-right-s-line></div></a></div></div><!--]--><!--[--><!--]--><!--[--><div class="yun-card flex-center rounded comment sm:p-6 lg:px-12 xl:px-16" flex="col" min-h="100px" bg="$va-c-bg-light" w="full" p="4"><!----><!----><!--[--><!----><!--]--><!----></div><!--]--><!--[--><!--]--><footer class="va-footer p-4 text-$va-c-text-light" text="center sm"><!----><div class="copyright flex justify-center items-center gap-2" p="1"><span>©<!----> 2023</span><a class="animate-pulse inline-flex" href="https://imlklaus.github.io/" target="_blank" title="回到首页"><div class="i-ri-heart-line"></div></a><span>imklaus</span></div><div class="powered" m="2"><span>由 <a href="https://github.com/YunYouJun/valaxy" target="_blank" rel="noopener">Valaxy</a> v0.15.14 驱动</span> | <span>主题 - <a href="https://github.com/YunYouJun/valaxy/tree/main/packages/valaxy-theme-yun" title="valaxy-theme-yun" target="_blank">Yun</a> v0.15.14</span></div><!--[--><!-- 自定义页脚内容 --><div>本站总访问量 <span id="busuanzi_value_site_pv"></span> 次</div><div>本站访客数 <span id="busuanzi_value_site_uv"></span> 人次</div><div class="vc-site-live-time col" mt="2"><!--[--><span>本站已勉强运行</span><!--]--><span mx-1>0 天</span><span mx-1>0 小时</span><span mx-1>0 分</span><span mx-1>0 秒</span><!--[--><span>(っ•̀ω•́)っ✎⁾⁾</span><!--]--></div><!--]--></footer><!--[--><!--]--></div><!--]--><!--[--><!--[--><button class="xl:hidden toc-btn shadow fixed yun-icon-btn z-350" opacity="75" right="2" bottom="19"><div i-ri-file-list-line></div></button><!----><!--  --><aside class="va-card yun-aside" m="l-4" text="center" overflow="auto"><div class="aside-container" flex="~ col"><h2 m="t-6 b-2" font="serif black">文章目录</h2><div style="display:none" data-v-a7bc02d9><div class="content" data-v-a7bc02d9><div class="outline-title" data-v-a7bc02d9>On this page</div><div class="outline-marker" data-v-a7bc02d9></div><nav aria-labelledby="doc-outline-aria-label" data-v-a7bc02d9><span id="doc-outline-aria-label" class="visually-hidden" data-v-a7bc02d9>Table of Contents for current page</span><ul class="root va-toc relative z-1 css-i18n-toc" data-v-a7bc02d9 data-v-fcbd55c7><!--[--><!--]--></ul></nav></div></div><div class="flex-grow"></div><div class="custom-container"><!--[--><!--]--></div></div></aside><!--]--><!--]--></div></main><a href="#" class="back-to-top yun-icon-btn"><div w="8" h="8" i-ri-arrow-up-s-line></div><svg class="progress-circle-container" viewBox="0 0 100 100"><circle stroke-dasharray="301.59289474462014 301.59289474462014" stroke-dashoffset="301.59289474462014" class="progress-circle" cx="50" cy="50" r="48" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg></a><!--]--><!--]--></div><script>window.__INITIAL_STATE__='{"pinia":{"app":{"showLoading":true,"isSidebarOpen":false,"isRightSidebarOpen":false},"site":{}}}'</script><link rel="stylesheet" href="/assets/index-463b4b4e.css"></body></html>