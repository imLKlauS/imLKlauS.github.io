<!DOCTYPE html><html lang="en" data-critters-container><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><link rel="icon" href="https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230825001534253.png"><script>const prefersDark=window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches,colorSchemeSetting=localStorage.getItem("vueuse-color-scheme")||"auto";("dark"===colorSchemeSetting||prefersDark&&"light"!==colorSchemeSetting)&&document.documentElement.classList.toggle("dark",!0)</script><script>const locale=localStorage.getItem("valaxy-locale")||"zh-CN";document.documentElement.setAttribute("lang",locale)</script><script type="module" async crossorigin src="/assets/app-eda06591.js"></script><link rel="modulepreload" crossorigin href="/js/animejs/animejs.82133372.js"><link rel="modulepreload" crossorigin href="/assets/app-eda06591.js"><link rel="modulepreload" crossorigin href="/js/@vueuse/@vueuse.592447f3.js"><style>@charset "UTF-8";.back-to-top{position:fixed;right:-1.5rem;bottom:1rem;z-index:var(--yun-z-go-up-btn);opacity:0;pointer-events:none;color:var(--va-c-primary);transform:translate(0) rotate(270deg);transition:transform var(--va-transition-duration),opacity var(--va-transition-duration-fast)!important}.progress-circle{transition:.3s stroke-dashoffset;transform:rotate(-90deg);transform-origin:50% 50%}.progress-circle-container{position:absolute}.links-of-author{display:flex;flex-wrap:wrap;justify-content:center}.links-of-author .icon{width:1.5rem;height:1.5rem}.links-of-author-item{line-height:1;font-size:.9rem}.site-nav{display:flex;justify-content:center;overflow:hidden;line-height:1.5;white-space:nowrap;text-align:center;margin-top:1rem}.site-link-item{display:flex;padding:0 15px;align-items:center;border-left:1px solid var(--va-c-gray);flex-direction:column;color:var(--va-c-text)}.site-link-item:first-child,.site-link-item:last-child{line-height:1;padding:0}.site-link-item:first-child{border-left:none;border-right:1px solid var(--va-c-gray)}.site-link-item:last-child{border-left:1px solid var(--va-c-gray)}.site-link-item:nth-child(2){border:none}.site-link-item .count{color:var(--va-c-text);font-family:var(--va-font-sans);display:block;text-align:center;font-size:1rem}.site-link-item .icon{width:1.5rem;height:1.5rem}.site-link-item .icon:hover{color:var(--va-c-primary-light)}.site-author-avatar{display:inline-block;line-height:0;position:relative}.site-author-avatar img{height:96px;width:96px;max-width:100%;margin:0;padding:4px;background-color:#fff;box-shadow:0 0 10px #0003;transition:.4s}.site-author-avatar img:hover{box-shadow:0 0 30px rgba(var(--va-c-primary-rgb),.2)}.site-author-status{position:absolute;height:1.8rem;width:1.8rem;bottom:0;right:0;line-height:1.8rem;border-radius:50%;box-shadow:0 1px 2px #0003;background-color:var(--va-c-bg-light);border:1px solid rgba(255,255,255,.1)}.site-name{color:var(--va-c-text);font-family:var(--va-font-serif);font-weight:900}.site-subtitle{color:var(--va-c-gray);display:block}.sidebar{width:calc(100vw - 64px);max-width:var(--va-sidebar-width);background-image:var(--yun-sidebar-bg-img);background-position:bottom 1rem center;transform:translate(-100%);transition:box-shadow var(--va-transition-duration),background-color var(--va-transition-duration),opacity .25s,transform var(--va-transition-duration) cubic-bezier(.19,1,.22,1)!important}.yun-search-btn{position:fixed;top:.6rem;right:.8rem;color:var(--va-c-primary);z-index:var(--yun-z-search-btn)}.yun-bg{position:fixed;width:100%;height:100%;z-index:-1;background-image:var(--yun-bg-img);background-size:cover;background-position:center;background-repeat:no-repeat;background-attachment:fixed;animation-name:bgFadeIn;animation-duration:2s;opacity:var(--yun-bg-img-opacity,1)}@supports (-webkit-touch-callout:none){.yun-bg{background-attachment:scroll}}@keyframes bgFadeIn{0%{opacity:0}to{opacity:var(--yun-bg-img-opacity,1)}}canvas.fireworks{position:fixed;left:0;top:0;z-index:1;pointer-events:none}*,:after,:before{box-sizing:border-box;border-width:0;border-style:solid;border-color:var(--un-default-border-color,#e5e7eb)}html{line-height:1.5;-webkit-text-size-adjust:100%;text-size-adjust:100%;-moz-tab-size:4;tab-size:4;font-family:ui-sans-serif,system-ui,-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica Neue,Arial,Noto Sans,sans-serif,"Apple Color Emoji","Segoe UI Emoji",Segoe UI Symbol,"Noto Color Emoji"}body{margin:0;line-height:inherit}hr{height:0;color:inherit;border-top-width:1px}h1,h2,h3,h4,h5{font-size:inherit;font-weight:inherit}a{color:inherit;text-decoration:inherit}strong{font-weight:bolder}code,pre{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,Liberation Mono,Courier New,monospace;font-size:1em}table{text-indent:0;border-color:inherit;border-collapse:collapse}button{font-family:inherit;font-feature-settings:inherit;font-variation-settings:inherit;font-size:100%;font-weight:inherit;line-height:inherit;color:inherit;margin:0;padding:0}button{text-transform:none}[type=button],button{-webkit-appearance:button;background-image:none}blockquote,figure,h1,h2,h3,h4,h5,hr,p,pre{margin:0}ol,ul{list-style:none;margin:0;padding:0}button{cursor:pointer}canvas,img,svg{display:block;vertical-align:middle}img{max-width:100%;height:auto}body{counter-reset:katexEqnNo mmlEqnNo}html{-webkit-tap-highlight-color:transparent}a{color:var(--va-c-link);font-weight:500}*{outline:0}hr{opacity:.2;margin:1rem}button{background-color:transparent}#app,body,html{margin:0;padding:0;line-height:2}body{background-color:var(--va-c-bg)}a{cursor:pointer}html:not(.dark) .vp-code-dark{display:none}@media screen and (max-width:640px){.markdown-body div[class*=language-]{margin:0 var(--va-code-mobile-margin-x,-1rem)}}@media (min-width:640px){.markdown-body div[class*=language-]{border-radius:6px;margin:16px 0}}@media (max-width:639px){.markdown-body li div[class*=language-]{border-radius:6px 0 0 6px}}.markdown-body code{font-size:.85em}.markdown-body div[class*=language-]{position:relative;background-color:var(--va-code-block-bg);overflow-x:auto}.markdown-body div[class*=language-] code{padding:0 24px;line-height:var(--va-code-line-height);font-size:var(--va-code-font-size);color:var(--va-code-block-color);transition:color .5s;width:fit-content;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none}.markdown-body div[class*=language-] pre{position:relative;z-index:1;margin:0;padding:1rem 0;background:0 0;overflow-x:auto}.markdown-body div[class*=language-] pre code{display:block}.markdown-body [class*=language-]>button.copy{direction:ltr;position:absolute;top:12px;right:12px;z-index:3;border:1px solid var(--va-code-copy-code-border-color);border-radius:4px;width:40px;height:40px;background-color:var(--va-code-copy-code-bg);opacity:0;cursor:pointer;background-image:var(--va-icon-copy);background-position:50%;background-size:20px;background-repeat:no-repeat;transition:border-color .25s,background-color .25s,opacity .25s}.markdown-body [class*=language-]:hover>button.copy,.markdown-body [class*=language-]>button.copy:focus{opacity:1}.markdown-body [class*=language-]>button.copy:hover{border-color:var(--va-code-copy-code-hover-border-color);background-color:var(--va-code-copy-code-hover-bg)}.markdown-body [class*=language-]>span.lang{position:absolute;top:2px;right:8px;z-index:2;font-size:12px;font-weight:500;color:var(--va-code-lang-color);transition:color .4s,opacity .4s}.markdown-body [class*=language-]:hover>button.copy+span.lang,.markdown-body [class*=language-]>button.copy:focus+span.lang{opacity:0}:root{--va-c-text-warning:#544500}.vt-hamburger{display:flex;justify-content:center;align-items:center}.vt-hamburger:hover .vt-hamburger-top{transform:translate(-5.5px)}.vt-hamburger:hover .vt-hamburger-middle{transform:translate(0)}.vt-hamburger:hover .vt-hamburger-bottom{transform:translate(-11px)}.vt-hamburger-container{position:relative;width:22px;height:20px;overflow:hidden}.vt-hamburger-bottom,.vt-hamburger-middle,.vt-hamburger-top{left:0;position:absolute;width:22px;height:2px;background-color:var(--va-c-primary);transition:top .25s,background-color .5s,transform .25s}.vt-hamburger-top{top:0;transform:translate(0)}.vt-hamburger-middle{top:9px;transform:translate(-11px)}.vt-hamburger-bottom{top:18px;transform:translate(-5.5px)}h2:focus .header-anchor,h2:hover .header-anchor,h3:focus .header-anchor,h3:hover .header-anchor,h4:focus .header-anchor,h4:hover .header-anchor,h5:focus .header-anchor,h5:hover .header-anchor{visibility:visible;opacity:1}a.header-anchor{float:left;margin-top:.125em;margin-left:-.87em;padding-right:.23em;font-size:.85em;visibility:hidden;opacity:0;transition:opacity var(--va-transition-duration)}a.header-anchor:before{content:none}a.header-anchor:focus,a.header-anchor:hover{text-decoration:none}.markdown-body figure{text-align:center}:root{--va-aside-width:256px;--va-sidebar-width:300px;--va-border-width:1px;--va-font-serif:"Noto Serif SC",STZhongsong,STKaiti,KaiTi,Roboto,serif;--va-font-sans:Inter,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Oxygen,Ubuntu,Cantarell,"Fira Sans","Droid Sans","Helvetica Neue",sans-serif;--va-font-mono:Menlo,Monaco,Consolas,"Courier New",monospace;--va-transition-duration-fast:.2s;--va-transition-duration:.4s;--va-transition-duration-slow:.6s;--va-transition:all var(--va-transition-duration-fast) ease-in-out}:root{--va-c-white:#ffffff;--va-c-black:#1a1a1a;--va-c-gray:#8e8e8e;--va-c-danger:#db2828;--va-c-warning:#f2711c;--va-c-text-light-1:#213547;--va-c-text-light-2:rgba(60, 60, 60, .7);--va-c-text-light-3:rgba(60, 60, 60, .33);--va-c-text-light-4:rgba(60, 60, 60, .18);--va-c-text-dark-1:rgba(255, 255, 255, .87);--va-c-text-dark-2:rgba(235, 235, 235, .6);--va-c-text-dark-3:rgba(235, 235, 235, .38);--va-c-text-dark-4:rgba(235, 235, 235, .18);--va-c-primary-light:#8ad9e0;--va-c-primary-lighter:#c6edf0;--va-c-primary-dark:#39c0cb;--va-c-primary:#4dc6d0}:root{color-scheme:light;--va-c-brand:#4dc6d0;--va-border-color:#222;--va-c-bg:white;--va-c-bg-light:white;--va-c-bg-dark:#fafafa;--va-c-bg-opacity:rgba(255, 255, 255, .8);--va-c-bg-soft:#f9f9f9;--va-c-bg-alt:#f9f9f9;--va-c-bg-mute:#f1f1f1;--va-c-text:#333;--va-c-text-light:#555;--va-c-text-lighter:#666;--va-c-text-dark:#111;--va-c-primary-rgb:77,198,208;--va-c-link:var(--va-c-primary-dark);--va-c-divider:rgba(60, 60, 60, .2)}:root{--va-c-text-1:rgba(60, 60, 67);--va-c-text-2:rgba(60, 60, 67, .78);--va-c-text-3:rgba(60, 60, 67, .56)}:root{--va-code-line-height:1.7;--va-code-font-size:.875em;--va-code-block-color:var(--va-c-text-2);--va-code-block-bg:var(--va-c-bg-alt);--va-code-block-divider-color:var(--va-c-gutter);--va-code-lang-color:var(--va-c-text-3);--va-code-line-highlight-color:rgba(0, 0, 0, .5);--va-code-line-number-color:var(--va-c-text-dark-3);--va-code-copy-code-border-color:var(--va-c-divider);--va-code-copy-code-bg:var(--va-c-bg-soft);--va-code-copy-code-hover-border-color:var(--va-c-divider);--va-code-copy-code-hover-bg:var(--va-c-bg);--va-code-copy-code-active-text:var(--va-c-text-2);--va-code-copy-copied-text-content:"Copied"}:root{--va-icon-copy:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' height='20' width='20' stroke='rgba(128,128,128,1)' stroke-width='2' class='h-6 w-6' viewBox='0 0 24 24'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' d='M9 5H7a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2h-2M9 5a2 2 0 0 0 2 2h2a2 2 0 0 0 2-2M9 5a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2'/%3E%3C/svg%3E");--va-icon-copied:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' height='20' width='20' stroke='rgba(128,128,128,1)' stroke-width='2' class='h-6 w-6' viewBox='0 0 24 24'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' d='M9 5H7a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2h-2M9 5a2 2 0 0 0 2 2h2a2 2 0 0 0 2-2M9 5a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2m-6 9 2 2 4-4'/%3E%3C/svg%3E")}.post-category{color:var(--va-c-text)}.post-tag{white-space:nowrap;color:var(--yun-tag-color)}.post-tag:hover{color:var(--va-c-primary)}html{overflow-y:scroll}.yun-main{padding-left:var(--va-sidebar-width);transition:padding-left var(--va-transition-duration);box-sizing:border-box}.yun-icon-btn{background-color:transparent;cursor:pointer;display:inline-flex;align-items:center;justify-content:center;border:none;width:3rem;height:3rem;border-radius:50%;transition:background-color var(--va-transition-duration)}.yun-icon-btn div{font-size:1.2rem}.yun-icon-btn:hover{background-color:rgba(var(--va-c-primary-rgb),.08)}.yun-icon-btn:active{background-color:rgba(var(--va-c-primary-rgb),.16)}:root{--smc-font-sans:Raleway,-apple-system,"PingFang SC","Microsoft YaHei",Arial,sans-serif;--smc-font-serif:"Songti SC","Noto Serif SC",STZhongsong,STKaiti,KaiTi,Roboto,serif;--smc-font-mono:Menlo,Monaco,Consolas,"Courier New",monospace}:root{--smc-c-primary-light:#9ee0e5;--smc-c-primary-lighter:#daf3f5;--smc-c-primary:#4dc6d0;--smc-theme-name:yun;--smc-line-height:1.8;--smc-c-primary-rgb:77,198,208;--smc-c-text:#24292e;--smc-c-text-light:#555;--smc-c-text-lighter:#666;--smc-header-bottom-color:#eaecef;--smc-border-color:var(--smc-c-primary-light);--smc-code-bg-color:#f6f8fa;--smc-link-color:#31afb9}.markdown-body{-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%;background:var(--smc-bg-color);color:var(--smc-c-text);font-family:var(--smc-font-sans);font-size:1rem;line-height:var(--smc-line-height);overflow-wrap:break-word}.markdown-body *{box-sizing:border-box}.markdown-body a{background-color:transparent}.markdown-body a:active,.markdown-body a:hover{outline-width:0}.markdown-body blockquote{margin:1rem 0;padding:0 1rem;border-left:.25em solid var(--smc-border-color)}.markdown-body code,.markdown-body pre{font-family:Source Code Pro,Consolas,Monaco,SFMono-Regular,Ubuntu Mono,Menlo,monospace}.markdown-body code{padding:3px 6px;font-size:.85rem;color:var(--smc-c-text-light);background:var(--smc-code-bg-color);border-radius:3px}.markdown-body pre{margin-top:0;margin-bottom:0;overflow-wrap:normal;padding:1rem;overflow:auto;background-color:var(--smc-code-bg-color);border-radius:3px}.markdown-body pre>code{font-size:.85rem;white-space:pre}.markdown-body pre code{display:block;padding:0;margin:0;overflow:visible;line-height:inherit;word-break:normal;background-color:transparent;border:0}.markdown-body img{display:block;margin:1rem auto;max-width:92%;max-height:600px;border-radius:.2rem;transition:.4s;--tw-shadow:0 1px 3px 0 rgb(0 0 0/.1),0 1px 2px -1px rgb(0 0 0/.1);--tw-shadow-colored:0 1px 3px 0 var(--tw-shadow-color),0 1px 2px -1px var(--tw-shadow-color);-webkit-box-shadow:var(--tw-ring-offset-shadow,0 0 transparent),var(--tw-ring-shadow,0 0 transparent),var(--tw-shadow);box-shadow:var(--tw-ring-offset-shadow,0 0 transparent),var(--tw-ring-shadow,0 0 transparent),var(--tw-shadow)}.markdown-body img:hover{--tw-shadow:0 4px 6px -1px rgb(0 0 0/.1),0 2px 4px -2px rgb(0 0 0/.1);--tw-shadow-colored:0 4px 6px -1px var(--tw-shadow-color),0 2px 4px -2px var(--tw-shadow-color)}.markdown-body img:before{content:"「 LOADING ERROR 」"}@media screen and (min-width:1600px){.markdown-body img{max-width:800px}}.markdown-body a{color:var(--smc-c-primary);text-decoration:none;border-bottom:1px solid transparent;transition:all .2s ease-in-out}.markdown-body a:hover{color:var(--smc-link-color);border-bottom:1px solid var(--smc-link-color)}.markdown-body ol,.markdown-body ul{padding-left:2em}.markdown-body ul ol,.markdown-body ul ul{margin-top:0;margin-bottom:0}.markdown-body ul ol{list-style-type:lower-roman}.markdown-body li{overflow-wrap:break-all;margin-top:.25em}.markdown-body li>p{margin-top:16px}.markdown-body table{width:100%;overflow:auto;border-spacing:0;border-collapse:collapse}.markdown-body table td,.markdown-body table th{padding:6px 13px;border:1px solid var(--smc-c-primary-light,#999)}.markdown-body table thead th{font-weight:600}.markdown-body table>tbody>tr:hover{background-color:rgba(var(--smc-c-primary-rgb),.1)}.markdown-body strong{font-family:var(--smc-font-serif);font-weight:900}.markdown-body p{margin-top:1rem;margin-bottom:1rem;overflow-x:auto;overflow-y:hidden}.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5{margin-top:1.5rem;margin-bottom:1rem;font-weight:300;line-height:1.5}.markdown-body h2{font-size:2.2rem;border-bottom:1px solid var(--smc-header-bottom-color)}.markdown-body h3{font-size:1.9rem}.markdown-body h4{font-size:1.6rem}.markdown-body h5{font-size:1.3rem}@media screen and (max-width:768px){.markdown-body h2{font-size:1.8rem}.markdown-body h3{font-size:1.6rem}.markdown-body h4{font-size:1.4rem}.markdown-body h5{font-size:1.2rem}}.markdown-body{--smc-font-family:var(--va-font-sans);--c-toc-link:var(--va-c-text-light)}.markdown-body{word-wrap:break-word}.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5{font-family:var(--va-font-serif);font-weight:900}.markdown-body ul{list-style:initial}.markdown-body ul li>p{margin-bottom:0}.markdown-body ol li{list-style:decimal}.markdown-body img{margin:.5rem auto;height:auto}.markdown-body p{overflow:unset}:root{--yun-post-card-max-width:900px;--yun-c-cloud:white;--yun-z-toc-btn:7;--yun-z-cloud:7;--yun-z-go-down:9;--yun-z-backdrop:9;--yun-z-sidebar:10;--yun-z-fireworks:11;--yun-z-menu-btn:20;--yun-z-go-up-btn:20;--yun-z-search-popup:30;--yun-z-search-btn:31;--va-z-overlay:var(--yun-z-backdrop)}:root{--yun-bg-img:url(/assets/bg-img-73ffcfc5.jpg);--yun-sidebar-bg-color:var(--va-c-bg-light);--yun-sidebar-bg-img:url(/assets/sidebar-bg-img-b7854581.webp)}:root{--va-c-bg-light:rgba(255, 255, 255, .8);--yun-sidebar-bg-img:url(https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230825004631944.png);--yun-sidebar-bg-color:rgba(255, 255, 255, 0)}*,:after,:before{--un-rotate:0;--un-rotate-x:0;--un-rotate-y:0;--un-rotate-z:0;--un-scale-x:1;--un-scale-y:1;--un-scale-z:1;--un-skew-x:0;--un-skew-y:0;--un-translate-x:0;--un-translate-y:0;--un-translate-z:0;--un-scroll-snap-strictness:proximity;--un-border-spacing-x:0;--un-border-spacing-y:0;--un-ring-offset-shadow:0 0 rgba(0,0,0,0);--un-ring-shadow:0 0 rgba(0,0,0,0);--un-shadow:0 0 rgba(0,0,0,0);--un-ring-offset-width:0px;--un-ring-offset-color:#fff;--un-ring-width:0px;--un-ring-color:rgba(147,197,253,.5)}.i-ri-alipay-line{--un-icon:url("data:image/svg+xml;utf8,%3Csvg viewBox='0 0 24 24' width='1.2em' height='1.2em' xmlns='http://www.w3.org/2000/svg' %3E%3Cpath fill='currentColor' d='M18.408 16.79c-2.173-.95-3.72-1.646-4.64-2.086c-1.4 1.696-2.872 2.72-5.08 2.72S5 16.064 5.176 14.392c.12-1.096.872-2.888 4.128-2.576c1.72.16 2.504.48 3.912.944c.36-.664.664-1.4.888-2.176H7.88v-.616h3.072V8.864H7.2v-.68h3.752V6.592s.032-.248.312-.248H12.8v1.848h4v.68h-4v1.104h3.264a12.41 12.41 0 0 1-1.32 3.32c.51.182 2.097.676 4.76 1.482a8 8 0 1 0-1.096 2.012ZM12 22C6.477 22 2 17.523 2 12S6.477 2 12 2s10 4.477 10 10s-4.477 10-10 10Zm-3.568-5.632c1.44 0 2.824-.872 3.96-2.352c-1.608-.776-2.944-1.16-4.44-1.16c-1.304 0-1.984.8-2.104 1.416c-.12.616.248 2.096 2.584 2.096Z'/%3E%3C/svg%3E");-webkit-mask:var(--un-icon) no-repeat;mask:var(--un-icon) no-repeat;-webkit-mask-size:100% 100%;mask-size:100% 100%;background-color:currentColor;color:inherit;width:1.2em;height:1.2em}[i-ri-archive-line=""]{--un-icon:url("data:image/svg+xml;utf8,%3Csvg viewBox='0 0 24 24' width='1.2em' height='1.2em' xmlns='http://www.w3.org/2000/svg' %3E%3Cpath fill='currentColor' d='M3 10H2V4.003C2 3.449 2.455 3 2.992 3h18.016A.99.99 0 0 1 22 4.003V10h-1v10.002a.996.996 0 0 1-.993.998H3.993A.996.996 0 0 1 3 20.002V10Zm16 0H5v9h14v-9ZM4 5v3h16V5H4Zm5 7h6v2H9v-2Z'/%3E%3C/svg%3E");-webkit-mask:var(--un-icon) no-repeat;mask:var(--un-icon) no-repeat;-webkit-mask-size:100% 100%;mask-size:100% 100%;background-color:currentColor;color:inherit;width:1.2em;height:1.2em}[i-ri-arrow-left-s-line=""]{--un-icon:url("data:image/svg+xml;utf8,%3Csvg viewBox='0 0 24 24' width='1.2em' height='1.2em' xmlns='http://www.w3.org/2000/svg' %3E%3Cpath fill='currentColor' d='m10.828 12l4.95 4.95l-1.414 1.415L8 12l6.364-6.364l1.414 1.414l-4.95 4.95Z'/%3E%3C/svg%3E");-webkit-mask:var(--un-icon) no-repeat;mask:var(--un-icon) no-repeat;-webkit-mask-size:100% 100%;mask-size:100% 100%;background-color:currentColor;color:inherit;width:1.2em;height:1.2em}[i-ri-arrow-right-s-line=""]{--un-icon:url("data:image/svg+xml;utf8,%3Csvg viewBox='0 0 24 24' width='1.2em' height='1.2em' xmlns='http://www.w3.org/2000/svg' %3E%3Cpath fill='currentColor' d='m13.171 12l-4.95-4.95l1.415-1.413L16 12l-6.364 6.364l-1.414-1.415l4.95-4.95Z'/%3E%3C/svg%3E");-webkit-mask:var(--un-icon) no-repeat;mask:var(--un-icon) no-repeat;-webkit-mask-size:100% 100%;mask-size:100% 100%;background-color:currentColor;color:inherit;width:1.2em;height:1.2em}[i-ri-arrow-up-s-line=""]{--un-icon:url("data:image/svg+xml;utf8,%3Csvg viewBox='0 0 24 24' width='1.2em' height='1.2em' xmlns='http://www.w3.org/2000/svg' %3E%3Cpath fill='currentColor' d='m12 10.828l-4.95 4.95l-1.414-1.414L12 8l6.364 6.364l-1.415 1.414l-4.95-4.95Z'/%3E%3C/svg%3E");-webkit-mask:var(--un-icon) no-repeat;mask:var(--un-icon) no-repeat;-webkit-mask-size:100% 100%;mask-size:100% 100%;background-color:currentColor;color:inherit;width:1.2em;height:1.2em}.i-ri-bilibili-line{--un-icon:url("data:image/svg+xml;utf8,%3Csvg viewBox='0 0 24 24' width='1.2em' height='1.2em' xmlns='http://www.w3.org/2000/svg' %3E%3Cpath fill='currentColor' d='M7.172 2.757L10.414 6h3.171l3.243-3.242a1 1 0 1 1 1.415 1.414L16.414 6H18.5A3.5 3.5 0 0 1 22 9.5v8a3.5 3.5 0 0 1-3.5 3.5h-13A3.5 3.5 0 0 1 2 17.5v-8A3.5 3.5 0 0 1 5.5 6h2.085L5.757 4.171a1 1 0 0 1 1.415-1.414ZM18.5 8h-13a1.5 1.5 0 0 0-1.493 1.355L4 9.5v8a1.5 1.5 0 0 0 1.356 1.493L5.5 19h13a1.5 1.5 0 0 0 1.493-1.356L20 17.5v-8A1.5 1.5 0 0 0 18.5 8ZM8 11a1 1 0 0 1 1 1v2a1 1 0 1 1-2 0v-2a1 1 0 0 1 1-1Zm8 0a1 1 0 0 1 1 1v2a1 1 0 1 1-2 0v-2a1 1 0 0 1 1-1Z'/%3E%3C/svg%3E");-webkit-mask:var(--un-icon) no-repeat;mask:var(--un-icon) no-repeat;-webkit-mask-size:100% 100%;mask-size:100% 100%;background-color:currentColor;color:inherit;width:1.2em;height:1.2em}[i-ri-calendar-2-line=""]{--un-icon:url("data:image/svg+xml;utf8,%3Csvg viewBox='0 0 24 24' width='1.2em' height='1.2em' xmlns='http://www.w3.org/2000/svg' %3E%3Cpath fill='currentColor' d='M9 1v2h6V1h2v2h4a1 1 0 0 1 1 1v16a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V4a1 1 0 0 1 1-1h4V1h2Zm11 10H4v8h16v-8ZM8 13v2H6v-2h2Zm5 0v2h-2v-2h2Zm5 0v2h-2v-2h2ZM7 5H4v4h16V5h-3v2h-2V5H9v2H7V5Z'/%3E%3C/svg%3E");-webkit-mask:var(--un-icon) no-repeat;mask:var(--un-icon) no-repeat;-webkit-mask-size:100% 100%;mask-size:100% 100%;background-color:currentColor;color:inherit;width:1.2em;height:1.2em}[i-ri-calendar-line=""]{--un-icon:url("data:image/svg+xml;utf8,%3Csvg viewBox='0 0 24 24' width='1.2em' height='1.2em' xmlns='http://www.w3.org/2000/svg' %3E%3Cpath fill='currentColor' d='M9 1v2h6V1h2v2h4a1 1 0 0 1 1 1v16a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V4a1 1 0 0 1 1-1h4V1h2Zm11 10H4v8h16v-8ZM7 5H4v4h16V5h-3v2h-2V5H9v2H7V5Z'/%3E%3C/svg%3E");-webkit-mask:var(--un-icon) no-repeat;mask:var(--un-icon) no-repeat;-webkit-mask-size:100% 100%;mask-size:100% 100%;background-color:currentColor;color:inherit;width:1.2em;height:1.2em}[i-ri-chat-4-line=""]{--un-icon:url("data:image/svg+xml;utf8,%3Csvg viewBox='0 0 24 24' width='1.2em' height='1.2em' xmlns='http://www.w3.org/2000/svg' %3E%3Cpath fill='currentColor' d='M5.763 17H20V5H4v13.385L5.763 17Zm.692 2L2 22.5V4a1 1 0 0 1 1-1h18a1 1 0 0 1 1 1v14a1 1 0 0 1-1 1H6.455Z'/%3E%3C/svg%3E");-webkit-mask:var(--un-icon) no-repeat;mask:var(--un-icon) no-repeat;-webkit-mask-size:100% 100%;mask-size:100% 100%;background-color:currentColor;color:inherit;width:1.2em;height:1.2em}.i-ri-clipboard-line{--un-icon:url("data:image/svg+xml;utf8,%3Csvg viewBox='0 0 24 24' width='1.2em' height='1.2em' xmlns='http://www.w3.org/2000/svg' %3E%3Cpath fill='currentColor' d='M7 4V2h10v2h3.007c.548 0 .993.445.993.993v16.014a.994.994 0 0 1-.993.993H3.993A.993.993 0 0 1 3 21.007V4.993C3 4.445 3.445 4 3.993 4H7Zm0 2H5v14h14V6h-2v2H7V6Zm2-2v2h6V4H9Z'/%3E%3C/svg%3E");-webkit-mask:var(--un-icon) no-repeat;mask:var(--un-icon) no-repeat;-webkit-mask-size:100% 100%;mask-size:100% 100%;background-color:currentColor;color:inherit;width:1.2em;height:1.2em}[i-ri-eye-line=""]{--un-icon:url("data:image/svg+xml;utf8,%3Csvg viewBox='0 0 24 24' width='1.2em' height='1.2em' xmlns='http://www.w3.org/2000/svg' %3E%3Cpath fill='currentColor' d='M12 3c5.392 0 9.878 3.88 10.819 9c-.94 5.12-5.427 9-10.819 9c-5.392 0-9.878-3.88-10.818-9C2.122 6.88 6.608 3 12 3Zm0 16a9.005 9.005 0 0 0 8.778-7a9.005 9.005 0 0 0-17.555 0A9.005 9.005 0 0 0 12 19Zm0-2.5a4.5 4.5 0 1 1 0-9a4.5 4.5 0 0 1 0 9Zm0-2a2.5 2.5 0 1 0 0-5a2.5 2.5 0 0 0 0 5Z'/%3E%3C/svg%3E");-webkit-mask:var(--un-icon) no-repeat;mask:var(--un-icon) no-repeat;-webkit-mask-size:100% 100%;mask-size:100% 100%;background-color:currentColor;color:inherit;width:1.2em;height:1.2em}[i-ri-file-list-line=""]{--un-icon:url("data:image/svg+xml;utf8,%3Csvg viewBox='0 0 24 24' width='1.2em' height='1.2em' xmlns='http://www.w3.org/2000/svg' %3E%3Cpath fill='currentColor' d='M20 22H4a1 1 0 0 1-1-1V3a1 1 0 0 1 1-1h16a1 1 0 0 1 1 1v18a1 1 0 0 1-1 1Zm-1-2V4H5v16h14ZM8 7h8v2H8V7Zm0 4h8v2H8v-2Zm0 4h8v2H8v-2Z'/%3E%3C/svg%3E");-webkit-mask:var(--un-icon) no-repeat;mask:var(--un-icon) no-repeat;-webkit-mask-size:100% 100%;mask-size:100% 100%;background-color:currentColor;color:inherit;width:1.2em;height:1.2em}[i-ri-file-word-line=""]{--un-icon:url("data:image/svg+xml;utf8,%3Csvg viewBox='0 0 24 24' width='1.2em' height='1.2em' xmlns='http://www.w3.org/2000/svg' %3E%3Cpath fill='currentColor' d='M16 8v8h-2l-2-2l-2 2H8V8h2v5l2-2l2 2V8h1V4H5v16h14V8h-3ZM3 2.992C3 2.444 3.447 2 3.998 2H16l5 5v13.992A1 1 0 0 1 20.007 22H3.993A1 1 0 0 1 3 21.008V2.992Z'/%3E%3C/svg%3E");-webkit-mask:var(--un-icon) no-repeat;mask:var(--un-icon) no-repeat;-webkit-mask-size:100% 100%;mask-size:100% 100%;background-color:currentColor;color:inherit;width:1.2em;height:1.2em}[i-ri-folder-2-line=""]{--un-icon:url("data:image/svg+xml;utf8,%3Csvg viewBox='0 0 24 24' width='1.2em' height='1.2em' xmlns='http://www.w3.org/2000/svg' %3E%3Cpath fill='currentColor' d='M12.414 5H21a1 1 0 0 1 1 1v14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V4a1 1 0 0 1 1-1h7.414l2 2ZM20 11H4v8h16v-8Zm0-2V7h-8.414l-2-2H4v4h16Z'/%3E%3C/svg%3E");-webkit-mask:var(--un-icon) no-repeat;mask:var(--un-icon) no-repeat;-webkit-mask-size:100% 100%;mask-size:100% 100%;background-color:currentColor;color:inherit;width:1.2em;height:1.2em}.i-ri-gallery-line{--un-icon:url("data:image/svg+xml;utf8,%3Csvg viewBox='0 0 24 24' width='1.2em' height='1.2em' xmlns='http://www.w3.org/2000/svg' %3E%3Cpath fill='currentColor' d='M20 13c-1.678 0-3.249.46-4.593 1.259A14.984 14.984 0 0 1 18.147 19H20v-6Zm-3.996 6C14.044 14.302 9.408 11 4 11v8h12.004ZM4 9c3.83 0 7.323 1.435 9.974 3.796A10.949 10.949 0 0 1 20 11V3h1.008c.548 0 .992.445.992.993v16.014a1 1 0 0 1-.992.993H2.992A.993.993 0 0 1 2 20.007V3.993A1 1 0 0 1 2.992 3H6V1h2v4H4v4Zm14-8v4h-8V3h6V1h2Zm-1.5 9a1.5 1.5 0 1 1 0-3a1.5 1.5 0 0 1 0 3Z'/%3E%3C/svg%3E");-webkit-mask:var(--un-icon) no-repeat;mask:var(--un-icon) no-repeat;-webkit-mask-size:100% 100%;mask-size:100% 100%;background-color:currentColor;color:inherit;width:1.2em;height:1.2em}.i-ri-github-line{--un-icon:url("data:image/svg+xml;utf8,%3Csvg viewBox='0 0 24 24' width='1.2em' height='1.2em' xmlns='http://www.w3.org/2000/svg' %3E%3Cpath fill='currentColor' d='M5.884 18.653c-.3-.2-.558-.456-.86-.816a50.59 50.59 0 0 1-.466-.579c-.463-.575-.755-.841-1.056-.95a1 1 0 1 1 .675-1.882c.752.27 1.261.735 1.947 1.588c-.094-.117.34.427.433.539c.19.227.33.365.44.438c.204.137.588.196 1.15.14c.024-.382.094-.753.202-1.096c-2.968-.725-4.648-2.64-4.648-6.396c0-1.238.37-2.355 1.058-3.291c-.218-.894-.185-1.975.302-3.192a1 1 0 0 1 .63-.583c.081-.024.127-.034.208-.047c.803-.123 1.937.17 3.415 1.097a11.731 11.731 0 0 1 2.687-.308c.912 0 1.819.103 2.684.308c1.477-.933 2.614-1.227 3.422-1.097c.085.014.158.032.218.051a1 1 0 0 1 .616.58c.487 1.215.52 2.296.302 3.19c.691.936 1.058 2.045 1.058 3.292c0 3.758-1.674 5.666-4.642 6.393c.125.415.19.878.19 1.38c0 .664-.002 1.299-.007 2.01c0 .19-.002.394-.005.706a1 1 0 0 1-.018 1.957c-1.14.228-1.984-.532-1.984-1.524l.002-.447l.005-.705c.005-.707.008-1.338.008-1.997c0-.697-.184-1.152-.426-1.361c-.661-.57-.326-1.654.541-1.751c2.966-.334 4.336-1.483 4.336-4.66c0-.955-.312-1.745-.913-2.405a1 1 0 0 1-.189-1.044c.166-.415.236-.957.095-1.614l-.01.002c-.491.14-1.11.44-1.858.95a1 1 0 0 1-.833.135a9.626 9.626 0 0 0-2.592-.35c-.89 0-1.772.12-2.592.35a1 1 0 0 1-.829-.133c-.753-.507-1.374-.807-1.87-.947c-.143.653-.072 1.194.093 1.607a1 1 0 0 1-.189 1.044c-.597.656-.913 1.459-.913 2.404c0 3.172 1.371 4.33 4.322 4.66c.865.098 1.202 1.178.545 1.749c-.193.167-.43.732-.43 1.364v3.149c0 .986-.834 1.726-1.96 1.529a1 1 0 0 1-.04-1.963v-.99c-.91.062-1.661-.087-2.254-.484Z'/%3E%3C/svg%3E");-webkit-mask:var(--un-icon) no-repeat;mask:var(--un-icon) no-repeat;-webkit-mask-size:100% 100%;mask-size:100% 100%;background-color:currentColor;color:inherit;width:1.2em;height:1.2em}.i-ri-heart-line,[i-ri-heart-line=""]{--un-icon:url("data:image/svg+xml;utf8,%3Csvg viewBox='0 0 24 24' width='1.2em' height='1.2em' xmlns='http://www.w3.org/2000/svg' %3E%3Cpath fill='currentColor' d='M12.001 4.529a5.998 5.998 0 0 1 8.242.228a6 6 0 0 1 .236 8.236l-8.48 8.492l-8.478-8.492a6 6 0 0 1 8.48-8.464Zm6.826 1.641a3.998 3.998 0 0 0-5.49-.153l-1.335 1.198l-1.336-1.197a4 4 0 0 0-5.686 5.605L12 18.654l7.02-7.03a4 4 0 0 0-.193-5.454Z'/%3E%3C/svg%3E");-webkit-mask:var(--un-icon) no-repeat;mask:var(--un-icon) no-repeat;-webkit-mask-size:100% 100%;mask-size:100% 100%;background-color:currentColor;color:inherit;width:1.2em;height:1.2em}[i-ri-home-4-line=""]{--un-icon:url("data:image/svg+xml;utf8,%3Csvg viewBox='0 0 24 24' width='1.2em' height='1.2em' xmlns='http://www.w3.org/2000/svg' %3E%3Cpath fill='currentColor' d='M19 21H5a1 1 0 0 1-1-1v-9H1l10.327-9.388a1 1 0 0 1 1.346 0L23 11h-3v9a1 1 0 0 1-1 1Zm-6-2h5V9.158l-6-5.455l-6 5.455V19h5v-6h2v6Z'/%3E%3C/svg%3E");-webkit-mask:var(--un-icon) no-repeat;mask:var(--un-icon) no-repeat;-webkit-mask-size:100% 100%;mask-size:100% 100%;background-color:currentColor;color:inherit;width:1.2em;height:1.2em}.i-ri-keynote-line{--un-icon:url("data:image/svg+xml;utf8,%3Csvg viewBox='0 0 24 24' width='1.2em' height='1.2em' xmlns='http://www.w3.org/2000/svg' %3E%3Cpath fill='currentColor' d='M4.44 10h15.12l-1.2-6H5.64l-1.2 6ZM13 12v8h4v2H7v-2h4v-8H2.992c-.548 0-.906-.43-.797-.977l1.61-8.046C3.913 2.437 4.445 2 5 2h13.998c.553 0 1.087.43 1.197.977l1.609 8.046c.108.54-.26.977-.797.977H13Z'/%3E%3C/svg%3E");-webkit-mask:var(--un-icon) no-repeat;mask:var(--un-icon) no-repeat;-webkit-mask-size:100% 100%;mask-size:100% 100%;background-color:currentColor;color:inherit;width:1.2em;height:1.2em}.i-ri-mail-line{--un-icon:url("data:image/svg+xml;utf8,%3Csvg viewBox='0 0 24 24' width='1.2em' height='1.2em' xmlns='http://www.w3.org/2000/svg' %3E%3Cpath fill='currentColor' d='M3 3h18a1 1 0 0 1 1 1v16a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V4a1 1 0 0 1 1-1Zm17 4.238l-7.928 7.1L4 7.216V19h16V7.238ZM4.511 5l7.55 6.662L19.502 5H4.511Z'/%3E%3C/svg%3E");-webkit-mask:var(--un-icon) no-repeat;mask:var(--un-icon) no-repeat;-webkit-mask-size:100% 100%;mask-size:100% 100%;background-color:currentColor;color:inherit;width:1.2em;height:1.2em}.i-ri-netease-cloud-music-line{--un-icon:url("data:image/svg+xml;utf8,%3Csvg viewBox='0 0 24 24' width='1.2em' height='1.2em' xmlns='http://www.w3.org/2000/svg' %3E%3Cpath fill='currentColor' d='M10.422 11.375c-.294 1.028.012 2.065.784 2.653c1.061.81 2.565.3 2.874-.995c.08-.337.103-.722.027-1.056c-.23-1.001-.521-1.988-.792-2.996c-1.33.154-2.543 1.172-2.893 2.394Zm5.548-.287c.273 1.012.285 2.017-.127 3c-1.128 2.69-4.722 3.14-6.573.826c-1.302-1.627-1.28-3.961.06-5.734c.78-1.032 1.804-1.707 3.048-2.054l.379-.104c-.084-.415-.188-.816-.243-1.224c-.176-1.317.512-2.503 1.744-3.04c1.226-.535 2.708-.216 3.53.76c.406.479.395 1.08-.025 1.464c-.412.377-.997.346-1.435-.09c-.247-.246-.51-.44-.877-.436c-.525.006-.987.418-.945.937c.037.468.172.93.3 1.386c.022.078.216.135.338.153c1.333.197 2.504.731 3.472 1.676c2.558 2.493 2.861 6.531.672 9.44c-1.529 2.032-3.61 3.169-6.127 3.409c-4.621.44-8.664-2.53-9.7-7.058C2.516 10.255 4.84 5.831 8.796 4.25c.586-.234 1.143-.031 1.371.498c.232.537-.019 1.086-.61 1.35c-2.368 1.06-3.817 2.855-4.215 5.423c-.533 3.434 1.656 6.777 5 7.722c2.723.769 5.658-.167 7.308-2.33c1.586-2.08 1.4-5.1-.427-6.874A3.978 3.978 0 0 0 15.4 9.026c.198.716.389 1.388.57 2.062Z'/%3E%3C/svg%3E");-webkit-mask:var(--un-icon) no-repeat;mask:var(--un-icon) no-repeat;-webkit-mask-size:100% 100%;mask-size:100% 100%;background-color:currentColor;color:inherit;width:1.2em;height:1.2em}.i-ri-open-arm-line{--un-icon:url("data:image/svg+xml;utf8,%3Csvg viewBox='0 0 24 24' width='1.2em' height='1.2em' xmlns='http://www.w3.org/2000/svg' %3E%3Cpath fill='currentColor' d='M18.001 17v5h-2v-5c0-4.451 2.644-8.285 6.447-10.016l.828 1.82A9.002 9.002 0 0 0 18.001 17Zm-10 0v5h-2v-5A9.002 9.002 0 0 0 .727 8.805l.827-1.821A11.002 11.002 0 0 1 8.001 17Zm4-5a5 5 0 1 1 0-10a5 5 0 0 1 0 10Zm0-2a3 3 0 1 0 0-6a3 3 0 0 0 0 6Z'/%3E%3C/svg%3E");-webkit-mask:var(--un-icon) no-repeat;mask:var(--un-icon) no-repeat;-webkit-mask-size:100% 100%;mask-size:100% 100%;background-color:currentColor;color:inherit;width:1.2em;height:1.2em}[i-ri-price-tag-3-line=""]{--un-icon:url("data:image/svg+xml;utf8,%3Csvg viewBox='0 0 24 24' width='1.2em' height='1.2em' xmlns='http://www.w3.org/2000/svg' %3E%3Cpath fill='currentColor' d='m10.904 2.1l9.9 1.414l1.414 9.9l-9.193 9.192a1 1 0 0 1-1.414 0l-9.9-9.9a1 1 0 0 1 0-1.413L10.905 2.1Zm.707 2.121L3.833 12l8.485 8.485l7.779-7.778l-1.061-7.425l-7.425-1.06Zm2.122 6.364a2 2 0 1 1 2.828-2.828a2 2 0 0 1-2.828 2.828Z'/%3E%3C/svg%3E");-webkit-mask:var(--un-icon) no-repeat;mask:var(--un-icon) no-repeat;-webkit-mask-size:100% 100%;mask-size:100% 100%;background-color:currentColor;color:inherit;width:1.2em;height:1.2em}[i-ri-pushpin-line=""]{--un-icon:url("data:image/svg+xml;utf8,%3Csvg viewBox='0 0 24 24' width='1.2em' height='1.2em' xmlns='http://www.w3.org/2000/svg' %3E%3Cpath fill='currentColor' d='m13.827 1.69l8.486 8.485l-1.415 1.414l-.707-.707l-4.242 4.243l-.707 3.535l-1.415 1.415l-4.242-4.243l-4.95 4.95l-1.414-1.414l4.95-4.95l-4.243-4.243l1.414-1.414l3.536-.707L13.12 3.81l-.707-.707l1.414-1.414Zm.707 3.535l-4.67 4.671l-2.822.565l6.5 6.5l.564-2.822l4.671-4.67l-4.243-4.244Z'/%3E%3C/svg%3E");-webkit-mask:var(--un-icon) no-repeat;mask:var(--un-icon) no-repeat;-webkit-mask-size:100% 100%;mask-size:100% 100%;background-color:currentColor;color:inherit;width:1.2em;height:1.2em}.i-ri-rss-line{--un-icon:url("data:image/svg+xml;utf8,%3Csvg viewBox='0 0 24 24' width='1.2em' height='1.2em' xmlns='http://www.w3.org/2000/svg' %3E%3Cpath fill='currentColor' d='M3 17a4 4 0 0 1 4 4H3v-4Zm0-7c6.075 0 11 4.925 11 11h-2a9 9 0 0 0-9-9v-2Zm0-7c9.941 0 18 8.059 18 18h-2c0-8.837-7.163-16-16-16V3Z'/%3E%3C/svg%3E");-webkit-mask:var(--un-icon) no-repeat;mask:var(--un-icon) no-repeat;-webkit-mask-size:100% 100%;mask-size:100% 100%;background-color:currentColor;color:inherit;width:1.2em;height:1.2em}[i-ri-search-line=""]{--un-icon:url("data:image/svg+xml;utf8,%3Csvg viewBox='0 0 24 24' width='1.2em' height='1.2em' xmlns='http://www.w3.org/2000/svg' %3E%3Cpath fill='currentColor' d='m18.031 16.617l4.283 4.282l-1.415 1.415l-4.282-4.283A8.96 8.96 0 0 1 11 20c-4.968 0-9-4.032-9-9s4.032-9 9-9s9 4.032 9 9a8.96 8.96 0 0 1-1.969 5.617Zm-2.006-.742A6.977 6.977 0 0 0 18 11c0-3.867-3.133-7-7-7s-7 3.133-7 7s3.133 7 7 7a6.977 6.977 0 0 0 4.875-1.975l.15-.15Z'/%3E%3C/svg%3E");-webkit-mask:var(--un-icon) no-repeat;mask:var(--un-icon) no-repeat;-webkit-mask-size:100% 100%;mask-size:100% 100%;background-color:currentColor;color:inherit;width:1.2em;height:1.2em}.i-ri-telegram-line{--un-icon:url("data:image/svg+xml;utf8,%3Csvg viewBox='0 0 24 24' width='1.2em' height='1.2em' xmlns='http://www.w3.org/2000/svg' %3E%3Cpath fill='currentColor' d='M12.001 20a8 8 0 1 0 0-16a8 8 0 0 0 0 16Zm0 2c-5.523 0-10-4.477-10-10s4.477-10 10-10s10 4.477 10 10s-4.477 10-10 10Zm-3.11-8.83l-2.498-.779c-.54-.165-.543-.537.121-.804l9.733-3.76c.564-.23.886.061.703.79l-1.658 7.82c-.116.557-.451.69-.916.433l-2.551-1.888l-1.189 1.148c-.122.118-.221.219-.409.244c-.187.026-.341-.03-.454-.34l-.87-2.871l-.012.008Z'/%3E%3C/svg%3E");-webkit-mask:var(--un-icon) no-repeat;mask:var(--un-icon) no-repeat;-webkit-mask-size:100% 100%;mask-size:100% 100%;background-color:currentColor;color:inherit;width:1.2em;height:1.2em}[i-ri-timer-line=""]{--un-icon:url("data:image/svg+xml;utf8,%3Csvg viewBox='0 0 24 24' width='1.2em' height='1.2em' xmlns='http://www.w3.org/2000/svg' %3E%3Cpath fill='currentColor' d='m17.618 5.968l1.453-1.453l1.414 1.414l-1.453 1.453A9 9 0 1 1 12 4c2.125 0 4.078.736 5.618 1.968ZM12 20a7 7 0 1 0 0-14a7 7 0 0 0 0 14ZM11 8h2v6h-2V8ZM8 1h8v2H8V1Z'/%3E%3C/svg%3E");-webkit-mask:var(--un-icon) no-repeat;mask:var(--un-icon) no-repeat;-webkit-mask-size:100% 100%;mask-size:100% 100%;background-color:currentColor;color:inherit;width:1.2em;height:1.2em}.i-ri-train-line{--un-icon:url("data:image/svg+xml;utf8,%3Csvg viewBox='0 0 24 24' width='1.2em' height='1.2em' xmlns='http://www.w3.org/2000/svg' %3E%3Cpath fill='currentColor' d='m17.2 20l1.8 1.5v.5H5v-.5L6.8 20H5a2 2 0 0 1-2-2V7a4 4 0 0 1 4-4h10a4 4 0 0 1 4 4v11a2 2 0 0 1-2 2h-1.8ZM7 5a2 2 0 0 0-2 2v11h14V7a2 2 0 0 0-2-2H7Zm5 12a2 2 0 1 1 0-4a2 2 0 0 1 0 4ZM6 7h12v4H6V7Z'/%3E%3C/svg%3E");-webkit-mask:var(--un-icon) no-repeat;mask:var(--un-icon) no-repeat;-webkit-mask-size:100% 100%;mask-size:100% 100%;background-color:currentColor;color:inherit;width:1.2em;height:1.2em}[i-ri-translate=""]{--un-icon:url("data:image/svg+xml;utf8,%3Csvg viewBox='0 0 24 24' width='1.2em' height='1.2em' xmlns='http://www.w3.org/2000/svg' %3E%3Cpath fill='currentColor' d='M5 15v2a2 2 0 0 0 1.85 1.994L7 19h3v2H7a4 4 0 0 1-4-4v-2h2Zm13-5l4.4 11h-2.155l-1.201-3h-4.09l-1.199 3h-2.154L16 10h2Zm-1 2.885L15.753 16h2.492L17 12.885ZM8 2v2h4v7H8v3H6v-3H2V4h4V2h2Zm9 1a4 4 0 0 1 4 4v2h-2V7a2 2 0 0 0-2-2h-3V3h3ZM6 6H4v3h2V6Zm4 0H8v3h2V6Z'/%3E%3C/svg%3E");-webkit-mask:var(--un-icon) no-repeat;mask:var(--un-icon) no-repeat;-webkit-mask-size:100% 100%;mask-size:100% 100%;background-color:currentColor;color:inherit;width:1.2em;height:1.2em}.i-ri-wechat-pay-line{--un-icon:url("data:image/svg+xml;utf8,%3Csvg viewBox='0 0 24 24' width='1.2em' height='1.2em' xmlns='http://www.w3.org/2000/svg' %3E%3Cpath fill='currentColor' d='m19.146 8.993l-9.799 5.608l-.07.046a.647.647 0 0 1-.3.069a.655.655 0 0 1-.58-.345l-.046-.092l-1.831-3.95c-.023-.046-.023-.092-.023-.138c0-.183.139-.321.324-.321c.07 0 .139.023.209.069l2.155 1.515c.162.092.347.161.556.161a.938.938 0 0 0 .348-.069l8.274-3.648C16.935 6.273 14.635 5.2 12.001 5.2c-4.421 0-7.9 3.023-7.9 6.6c0 1.366.5 2.673 1.431 3.781c.049.058.12.137.215.235a4 4 0 0 1 1.1 3.102l-.024.298l.715-.437a4 4 0 0 1 2.706-.536c.211.033.385.059.52.077c.406.053.819.08 1.237.08c4.42 0 7.9-3.022 7.9-6.6c0-.996-.27-1.95-.755-2.807ZM6.193 21.943a1 1 0 0 1-1.527-.931l.189-2.26a2 2 0 0 0-.55-1.551a6.935 6.935 0 0 1-.303-.332C2.806 15.447 2.1 13.695 2.1 11.8c0-4.75 4.432-8.6 9.9-8.6c5.467 0 9.9 3.85 9.9 8.6s-4.433 8.6-9.9 8.6c-.51 0-1.01-.033-1.5-.098c-.152-.02-.342-.048-.568-.084a2 2 0 0 0-1.353.269l-2.387 1.456Z'/%3E%3C/svg%3E");-webkit-mask:var(--un-icon) no-repeat;mask:var(--un-icon) no-repeat;-webkit-mask-size:100% 100%;mask-size:100% 100%;background-color:currentColor;color:inherit;width:1.2em;height:1.2em}[i~=ri-sun-line]{--un-icon:url("data:image/svg+xml;utf8,%3Csvg viewBox='0 0 24 24' width='1.2em' height='1.2em' xmlns='http://www.w3.org/2000/svg' %3E%3Cpath fill='currentColor' d='M12 18a6 6 0 1 1 0-12a6 6 0 0 1 0 12Zm0-2a4 4 0 1 0 0-8a4 4 0 0 0 0 8ZM11 1h2v3h-2V1Zm0 19h2v3h-2v-3ZM3.515 4.929l1.414-1.414L7.05 5.636L5.636 7.05L3.515 4.93ZM16.95 18.364l1.414-1.414l2.121 2.121l-1.414 1.414l-2.121-2.121Zm2.121-14.85l1.414 1.415l-2.121 2.121l-1.414-1.414l2.121-2.121ZM5.636 16.95l1.414 1.414l-2.121 2.121l-1.414-1.414l2.121-2.121ZM23 11v2h-3v-2h3ZM4 11v2H1v-2h3Z'/%3E%3C/svg%3E");-webkit-mask:var(--un-icon) no-repeat;mask:var(--un-icon) no-repeat;-webkit-mask-size:100% 100%;mask-size:100% 100%;background-color:currentColor;color:inherit;width:1.2em;height:1.2em}.yun-card{margin:auto;--un-shadow:var(--un-shadow-inset) 0 1px 3px 0 var(--un-shadow-color, rgba(0,0,0,.1)),var(--un-shadow-inset) 0 1px 2px -1px var(--un-shadow-color, rgba(0,0,0,.1));box-shadow:var(--un-ring-offset-shadow),var(--un-ring-shadow),var(--un-shadow);transition-property:color,background-color,border-color,outline-color,text-decoration-color,fill,stroke,opacity,box-shadow,transform,filter,backdrop-filter;transition-timing-function:cubic-bezier(.4,0,.2,1);transition-duration:.15s;transition-duration:var(--va-transition-duration)}.flex-center{display:flex;align-items:center;justify-content:center}.inline-flex-center{display:inline-flex;align-items:center;justify-content:center}.va-card{background-color:var(--va-c-bg-light);--un-shadow:var(--un-shadow-inset) 0 1px 3px 0 var(--un-shadow-color, rgba(0,0,0,.1)),var(--un-shadow-inset) 0 1px 2px -1px var(--un-shadow-color, rgba(0,0,0,.1));box-shadow:var(--un-ring-offset-shadow),var(--un-ring-shadow),var(--un-shadow)}.va-card:hover,.yun-card:hover{--un-shadow:var(--un-shadow-inset) 0 10px 15px -3px var(--un-shadow-color, rgba(0,0,0,.1)),var(--un-shadow-inset) 0 4px 6px -4px var(--un-shadow-color, rgba(0,0,0,.1));box-shadow:var(--un-ring-offset-shadow),var(--un-ring-shadow),var(--un-shadow)}@media (max-width:767.9px){.yun-main{padding-left:0}}.fixed{position:fixed}.relative{position:relative}.inset-y-0{top:0;bottom:0}.left-0{left:0}.left-0\.8rem{left:.8rem}.top-0\.6rem{top:.6rem}[bottom~="19"]{bottom:4.75rem}[right~="2"]{right:.5rem}.z-1{z-index:1}.z-350{z-index:350}[z~="$yun-z-menu-btn"]{z-index:var(--yun-z-menu-btn)}[z~="$yun-z-sidebar"]{z-index:var(--yun-z-sidebar)}[m~="0"]{margin:0}[m~="2"]{margin:.5rem}[m~=y-4]{margin-top:1rem;margin-bottom:1rem}[my~="1"]{margin-top:.25rem;margin-bottom:.25rem}[m~=x-1]{margin-left:.25rem;margin-right:.25rem}[mx~="2"],[m~=x-2]{margin-left:.5rem;margin-right:.5rem}[m~=y-2]{margin-top:.5rem;margin-bottom:.5rem}[mb~="4"],[m~=b-4]{margin-bottom:1rem}.mb-2,[m~=b-2]{margin-bottom:.5rem}[ml-1=""],[m~=l-1]{margin-left:.25rem}[m~=t-4]{margin-top:1rem}[mt-6=""],[m~=t-6]{margin-top:1.5rem}[m~=l-4]{margin-left:1rem}[m~=r-1]{margin-right:.25rem}[m~=t-0]{margin-top:0}[m~=t-16]{margin-top:4rem}[mt~="2"]{margin-top:.5rem}.block{display:block}.inline-block{display:inline-block}.h-8,[h~="8"]{height:2rem}[h~="5"]{height:1.25rem}.w-8,[w~="8"]{width:2rem}[w~=full]{width:100%}[h~="64"]{height:16rem}[min-h~="100px"]{min-height:100px}.flex,[flex~="~"]{display:flex}.inline-flex,[inline-flex=""]{display:inline-flex}.flex-grow,[flex~=grow]{flex-grow:1}.flex-col,[flex~=col]{flex-direction:column}.transform{transform:translate(var(--un-translate-x)) translateY(var(--un-translate-y)) translateZ(var(--un-translate-z)) rotate(var(--un-rotate)) rotateX(var(--un-rotate-x)) rotateY(var(--un-rotate-y)) rotate(var(--un-rotate-z)) skew(var(--un-skew-x)) skewY(var(--un-skew-y)) scaleX(var(--un-scale-x)) scaleY(var(--un-scale-y)) scaleZ(var(--un-scale-z))}@keyframes fade-in{0%{opacity:0}to{opacity:1}}@keyframes pulse{0%,to{opacity:1}50%{opacity:.5}}.animate-fade-in{animation:fade-in 1s linear 1}.animate-pulse{animation:pulse 2s cubic-bezier(.4,0,.6,1) infinite}.animate-iteration-1{animation-iteration-count:1}[cursor~=pointer]{cursor:pointer}.select-none{-webkit-user-select:none;user-select:none}.items-center,[items~=center]{align-items:center}.justify-center,[justify~=center]{justify-content:center}.justify-around{justify-content:space-around}.gap-2{gap:.5rem}[overflow~=auto]{overflow:auto}.overflow-y-auto{overflow-y:auto}.truncate{overflow:hidden;text-overflow:ellipsis;white-space:nowrap}[border~="~"]{border-width:1px}[border~=rounded]{border-radius:.25rem}.rounded-full{border-radius:9999px}[bg~="$va-c-bg-light"]{background-color:var(--va-c-bg-light)}[bg~="$yun-sidebar-bg-color"]{background-color:var(--yun-sidebar-bg-color)}[bg~=contain]{background-size:contain}[bg~=no-repeat]{background-repeat:no-repeat}[stroke-width~="2"]{stroke-width:2px}.object-cover{object-fit:cover}.p-4,[p~="4"]{padding:1rem}[p~="1"]{padding:.25rem}[p~="2"]{padding:.5rem}[p~=x-4]{padding-left:1rem;padding-right:1rem}[py~="1"]{padding-top:.25rem;padding-bottom:.25rem}[p~=b-8]{padding-bottom:2rem}[p~=l-4]{padding-left:1rem}[text~=center]{text-align:center}[text~="2xl"]{font-size:1.5rem;line-height:2rem}[text-xl=""],[text~=xl]{font-size:1.25rem;line-height:1.75rem}[text~=xs]{font-size:.75rem;line-height:1rem}[text~=sm]{font-size:.875rem;line-height:1.25rem}[font~=black]{font-weight:900}.leading-4{line-height:1rem}.leading-6{line-height:1.5rem}.leading-none{line-height:1}[color~="$va-c-warning"]{color:var(--va-c-warning)}.text-\$va-c-text-light{color:var(--va-c-text-light)}[text~=red-400]{--un-text-opacity:1;color:rgba(248,113,113,var(--un-text-opacity))}.shadow{--un-shadow:var(--un-shadow-inset) 0 1px 3px 0 var(--un-shadow-color, rgba(0,0,0,.1)),var(--un-shadow-inset) 0 1px 2px -1px var(--un-shadow-color, rgba(0,0,0,.1));box-shadow:var(--un-ring-offset-shadow),var(--un-ring-shadow),var(--un-shadow)}.hover\:shadow-md:hover{--un-shadow:var(--un-shadow-inset) 0 4px 6px -1px var(--un-shadow-color, rgba(0,0,0,.1)),var(--un-shadow-inset) 0 2px 4px -2px var(--un-shadow-color, rgba(0,0,0,.1));box-shadow:var(--un-ring-offset-shadow),var(--un-ring-shadow),var(--un-shadow)}.transition{transition-property:color,background-color,border-color,outline-color,text-decoration-color,fill,stroke,opacity,box-shadow,transform,filter,backdrop-filter;transition-timing-function:cubic-bezier(.4,0,.2,1);transition-duration:.15s}[font~=serif]{font-family:var(--va-font-serif)}@media (max-width:767.9px){.lt-md\:ml-0{margin-left:0}[p~="lt-md:0"]{padding:0}}@media (min-width:640px){.sm\:p-6{padding:1.5rem}.sm\:px-6{padding-left:1.5rem;padding-right:1.5rem}}@media (min-width:768px){.md\:hidden{display:none}.md\:translate-x-0{--un-translate-x:0;transform:translate(var(--un-translate-x)) translateY(var(--un-translate-y)) translateZ(var(--un-translate-z)) rotate(var(--un-rotate)) rotateX(var(--un-rotate-x)) rotateY(var(--un-rotate-y)) rotate(var(--un-rotate-z)) skew(var(--un-skew-x)) skewY(var(--un-skew-y)) scaleX(var(--un-scale-x)) scaleY(var(--un-scale-y)) scaleZ(var(--un-scale-z))}}@media (min-width:1024px){.lg\:px-12{padding-left:3rem;padding-right:3rem}}@media (min-width:1280px){.xl\:hidden{display:none}.xl\:px-16{padding-left:4rem;padding-right:4rem}}.va-toc[data-v-22b646a4]{text-align:left}.content[data-v-22b646a4]{position:relative;padding-left:16px;font-size:14px;text-align:left}.outline-marker[data-v-22b646a4]{position:absolute;top:32px;left:-2px;z-index:0;opacity:0;width:4px;height:18px;background-color:var(--va-c-brand);transition:top .25s cubic-bezier(0,1,.5,1),background-color .5s,opacity .25s;border-top-right-radius:2px;border-bottom-right-radius:2px}.outline-title[data-v-22b646a4]{letter-spacing:.4px;line-height:28px;font-size:14px;font-weight:600}.visually-hidden[data-v-22b646a4]{position:absolute;width:1px;height:1px;white-space:nowrap;clip:rect(0 0 0 0);clip-path:inset(50%);overflow:hidden}.yun-aside{position:fixed;right:0;top:0;bottom:0;width:var(--va-sidebar-width,300px);transform:translate(100%);transition:box-shadow var(--va-transition-duration),background-color var(--va-transition-duration),opacity .25s,transform var(--va-transition-duration) cubic-bezier(.19,1,.22,1)}@media screen and (min-width:1280px){.yun-aside{transform:translate(0)}}.toc-btn{color:var(--va-c-primary);background-color:#fff;z-index:var(--yun-z-toc-btn)}.post-nav{display:flex;justify-content:space-between;align-items:center}.post-nav-item{display:inline-flex;justify-content:center;align-items:center;color:var(--va-c-primary);outline:0;font-size:1.5rem;font-weight:700;text-transform:uppercase;height:3rem;transition:.4s}.post-nav-item:hover{background-color:rgba(var(--va-c-primary-rgb),.1);box-shadow:0 0 15px #0000001a}.post-nav-prev{padding:0 .6rem 0 .1rem}.post-nav-next{padding:0 .1rem 0 .6rem}.post-nav-next,.post-nav-prev{display:inline-flex;align-items:center;height:3rem;font-size:1rem}.post-nav-next .title,.post-nav-prev .title{overflow:hidden;max-width:10rem}.post-nav-next .icon,.post-nav-prev .icon{width:1.2rem;height:1.2rem}@media screen and (min-width:1024px){.post-nav-next .title,.post-nav-prev .title{max-width:18rem}}@media screen and (min-width:1280px){.content{max-width:calc(100vw - 2 * var(--va-sidebar-width) - 1rem - 8px)}}.link-item{display:inline-flex}:root{--page-btn-bg-color:rgba(255, 255, 255, .5);--page-btn-hover-bg-color:var(--va-c-primary-lighter);--page-btn-active-bg-color:var(--va-c-primary-light)}.post-top-icon{position:absolute;top:1rem;right:1rem;font-size:1.2rem}@-webkit-keyframes lg-right-end{0%{left:0}50%{left:-30px}to{left:0}}@-webkit-keyframes lg-left-end{0%{left:0}50%{left:30px}to{left:0}}:root{--banner-line-color:black;--banner-char-color:black;--banner-char-bg-color:rgba(255, 255, 255, .5);--banner-char-hover-color:white}.post-copyright{font-size:.9rem;padding:.5rem 1rem;border-left:4px solid #ff5252;background-color:var(--va-c-bg-dark);list-style:none;word-break:break-all;position:relative;overflow:hidden}.post-copyright:after{pointer-events:none;position:absolute;color:#fff;background:url("data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 496 512'%3E%3Cpath fill='gray' d='M245.8 214.9l-33.2 17.3c-9.4-19.6-25.2-20-27.4-20-22.2 0-33.3 14.6-33.3 43.9 0 23.5 9.2 43.8 33.3 43.8 14.4 0 24.6-7 30.5-21.3l30.6 15.5a73.2 73.2 0 01-65.1 39c-22.6 0-74-10.3-74-77 0-58.7 43-77 72.6-77 30.8-.1 52.7 11.9 66 35.8zm143 0l-32.7 17.3c-9.5-19.8-25.7-20-27.9-20-22.1 0-33.2 14.6-33.2 43.9 0 23.5 9.2 43.8 33.2 43.8 14.5 0 24.7-7 30.5-21.3l31 15.5c-2 3.8-21.3 39-65 39-22.7 0-74-9.9-74-77 0-58.7 43-77 72.6-77C354 179 376 191 389 214.8zM247.7 8C104.7 8 0 123 0 256c0 138.4 113.6 248 247.6 248C377.5 504 496 403 496 256 496 118 389.4 8 247.6 8zm.8 450.8c-112.5 0-203.7-93-203.7-202.8 0-105.5 85.5-203.3 203.8-203.3A201.7 201.7 0 01451.3 256c0 121.7-99.7 202.9-202.9 202.9z'/%3E%3C/svg%3E");content:" ";height:10rem;width:10rem;right:-2rem;top:-2rem;opacity:.1}.sponsor-button{background-color:#ffffff1a}.sponsor-button div{transform:scale(1.1);transition:transform var(--va-transition-duration) ease-in-out}.sponsor-button:hover{background-color:#ffffffe6}.sponsor-button:hover div{transform:scale(1.2)}.qrcode-container{overflow:hidden;height:0;transition:height var(--va-transition-duration) ease-in-out}.sponsor-description{color:var(--va-c-gray)}.sponsor-method-img{width:12rem;max-width:90%;aspect-ratio:1}:root{--waline-font-size:1rem;--waline-white:#fff;--waline-light-grey:#999;--waline-dark-grey:#666;--waline-theme-color:#27ae60;--waline-active-color:#2ecc71;--waline-color:#444;--waline-bgcolor:#fff;--waline-bgcolor-light:#f8f8f8;--waline-bgcolor-hover:#f0f0f0;--waline-border-color:#ddd;--waline-disable-bgcolor:#f8f8f8;--waline-disable-color:#000;--waline-code-bgcolor:#282c34;--waline-bq-color:#f0f0f0;--waline-avatar-size:3.25rem;--waline-m-avatar-size:calc(var(--waline-avatar-size) * 9 / 13);--waline-badge-color:#3498db;--waline-badge-font-size:.75em;--waline-info-bgcolor:#f8f8f8;--waline-info-color:#999;--waline-info-font-size:.625em;--waline-border:1px solid var(--waline-border-color);--waline-avatar-radius:50%;--waline-box-shadow:none}:root{--waline-theme-color:var(--va-c-primary);--waline-active-color:var(--va-c-primary-light)}</style><link rel="preload" href="/assets/index-e381b313.css" as="style"><link rel="modulepreload" crossorigin href="/js/posts/Flash killing.afa6fc3d.js"><title>秒杀 - imklaus's Blog</title><link rel="icon" href="https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230825001534253.png" type="image/png"><meta name="theme-color" content="#ffffff"><meta name="msapplication-TileColor" content="#ffffff"><meta name="generator" content="Valaxy 0.14.61"><meta name="description" content><meta property="og:description" content><meta property="og:locale" content="zh-CN"><meta property="og:site_name" content="imklaus's Blog "><meta property="og:title" content="秒杀"><meta property="og:image" content="https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/wallhaven-2em38y_1920x1080.png"><meta property="og:url" content="https://imlklaus.github.io/"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@900&amp;display=swap"><link rel="preload" as="font" crossorigin="anonymous" href="/assets/KaTeX_AMS-Regular-0cdd387c.woff2"><link rel="preload" as="font" crossorigin="anonymous" href="/assets/KaTeX_Caligraphic-Bold-de7701e4.woff2"><link rel="preload" as="font" crossorigin="anonymous" href="/assets/KaTeX_Caligraphic-Regular-5d53e70a.woff2"><link rel="preload" as="font" crossorigin="anonymous" href="/assets/KaTeX_Fraktur-Bold-74444efd.woff2"><link rel="preload" as="font" crossorigin="anonymous" href="/assets/KaTeX_Fraktur-Regular-51814d27.woff2"><link rel="preload" as="font" crossorigin="anonymous" href="/assets/KaTeX_Main-Bold-0f60d1b8.woff2"><link rel="preload" as="font" crossorigin="anonymous" href="/assets/KaTeX_Main-BoldItalic-99cd42a3.woff2"><link rel="preload" as="font" crossorigin="anonymous" href="/assets/KaTeX_Main-Italic-97479ca6.woff2"><link rel="preload" as="font" crossorigin="anonymous" href="/assets/KaTeX_Main-Regular-c2342cd8.woff2"><link rel="preload" as="font" crossorigin="anonymous" href="/assets/KaTeX_Math-BoldItalic-dc47344d.woff2"><link rel="preload" as="font" crossorigin="anonymous" href="/assets/KaTeX_Math-Italic-7af58c5e.woff2"><link rel="preload" as="font" crossorigin="anonymous" href="/assets/KaTeX_SansSerif-Bold-e99ae511.woff2"><link rel="preload" as="font" crossorigin="anonymous" href="/assets/KaTeX_SansSerif-Italic-00b26ac8.woff2"><link rel="preload" as="font" crossorigin="anonymous" href="/assets/KaTeX_SansSerif-Regular-68e8c73e.woff2"><link rel="preload" as="font" crossorigin="anonymous" href="/assets/KaTeX_Script-Regular-036d4e95.woff2"><link rel="preload" as="font" crossorigin="anonymous" href="/assets/KaTeX_Size1-Regular-6b47c401.woff2"><link rel="preload" as="font" crossorigin="anonymous" href="/assets/KaTeX_Size2-Regular-d04c5421.woff2"><link rel="preload" as="font" crossorigin="anonymous" href="data:font/woff2;base64,d09GMgABAAAAAA4oAA4AAAAAHbQAAA3TAAEAAAAAAAAAAAAAAAAAAAAAAAAAAAAABmAAgRQIDgmcDBEICo1oijYBNgIkA14LMgAEIAWJAAeBHAyBHBvbGiMRdnO0IkRRkiYDgr9KsJ1NUAf2kILNxgUmgqIgq1P89vcbIcmsQbRps3vCcXdYOKSWEPEKgZgQkprQQsxIXUgq0DqpGKmIvrgkeVGtEQD9DzAO29fM9jYhxZEsL2FeURH2JN4MIcTdO049NCVdxQ/w9NrSYFEBKTDKpLKfNkCGDc1RwjZLQcm3vqJ2UW9Xfa3tgAHz6ivp6vgC2yD4/6352ndnN0X0TL7seypkjZlMsjmZnf0Mm5Q+JykRWQBKCVCVPbARPXWyQtb5VgLB6Biq7/Uixcj2WGqdI8tGSgkuRG+t910GKP2D7AQH0DB9FMDW/obJZ8giFI3Wg8Cvevz0M+5m0rTh7XDBlvo9Y4vm13EXmfttwI4mBo1EG15fxJhUiCLbiiyCf/ZA6MFAhg3pGIZGdGIVjtPn6UcMk9A/UUr9PhoNsCENw1APAq0gpH73e+M+0ueyHbabc3vkbcdtzcf/fiy+NxQEjf9ud/ELBHAXJ0nk4z+MXH2Ev/kWyV4k7SkvpPc9Qr38F6RPWnM9cN6DJ0AdD1BhtgABtmoRoFCvPsBAumNm6soZG2Gk5GyVTo2sJncSyp0jQTYoR6WDvTwaaEcHsxHfvuWhHA3a6bN7twRKtcGok6NsCi7jYRrM2jExsUFMxMQYuJbMhuWNOumEJy9hi29Dmg5zMp/A5+hhPG19j1vBrq8JTLr8ki5VLPmG/PynJHVul440bxg5xuymHUFPBshC+nA9I1FmwbRBTNHAcik3Oae0cxKoI3MOriM42UrPe51nsaGxJ+WfXubAsP84aabUlQSJ1IiE0iPETLUU4CATgfXSCSpuRFRmCGbO+wSpAnzaeaCYW1VNEysRtuXCEL1kUFUbbtMv3Tilt/1c11jt3Q5bbMa84cpWipp8Elw3MZhOHsOlwwVUQM3lAR35JiFQbaYCRnMF2lxAWoOg2gyoIV4PouX8HytNIfLhqpJtXB4vjiViUI8IJ7bkC4ikkQvKksnOTKICwnqWSZ9YS5f0WCxmpgjbIq7EJcM4aI2nmhLNY2JIUgOjXZFWBHb+x5oh6cwb0Tv1ackHdKi0I9OO2wE9aogIOn540CCCziyhN+IaejtgAONKznHlHyutPrHGwCx9S6B8kfS4Mfi4Eyv7OU730bT1SCBjt834cXsf43zVjPUqqJjgrjeGnBxSG4aYAKFuVbeCfkDIjAqMb6yLNIbCuvXhMH2/+k2vkNpkORhR59N1CkzoOENvneIosjYmuTxlhUzaGEJQ/iWqx4dmwpmKjrwTiTGTCVozNAYqk/zXOndWxuWSmJkQpJw3pK5KX6QrLt5LATMqpmPAQhkhK6PUjzHUn7E0gHE0kPE0iKkolgkUx9SZmVAdDgpffdyJKg3k7VmzYGCwVXGz/tXmkOIp+vcWs+EMuhhvN0h9uhfzWJziBQmCREGSIFmQIkgVpAnSBRmC//6hkLZwaVhwxlrJSOdqlFtOYxlau9F2QN5Y98xmIAsiM1HVp2VFX+DHHGg6Ecjh3vmqtidX3qHI2qycTk/iwxSt5UzTmEP92ZBnEWTk4Mx8Mpl78ZDokxg/KWb+Q0QkvdKVmq3TMW+RXEgrsziSAfNXFMhDc60N5N9jQzjfO0kBKpUZl0ZmwJ41j/B9Hz6wmRaJB84niNmQrzp9eSlQCDDzazGDdVi3P36VZQ+Jy4f9UBNp+3zTjqI4abaFAm+GShVaXlsGdF3FYzZcDI6cori4kMxUECl9IjJZpzkvitAoxKue+90pDMvcKRxLl53TmOKCmV/xRolNKSqqUxc6LStOETmFOiLZZptlZepcKiAzteG8PEdpnQpbOMNcMsR4RR2Bs0cKFEvSmIjAFcnarqwUL4lDhHmnVkwu1IwshbiCcgvOheZuYyOteufZZwlcTlLgnZ3o/WcYdzZHW/WGaqaVfmTZ1aWCceJjkbZqsfbkOtcFlUZM/jy+hXHDbaUobWqqXaeWobbLO99yG5N3U4wxco0rQGGcOLASFMXeJoham8M+/x6O2WywK2l4HGbq1CoUyC/IZikQhdq3SiuNrvAEj0AVu9x2x3lp/xWzahaxidezFVtdcb5uEnzyl0ZmYiuKI0exvCd4Xc9CV1KB0db00z92wDPde0kukbvZIWN6jUWFTmPIC/Y4UPCm8UfDTFZpZNon1qLFTkBhxzB+FjQRA2Q/YRJT8pQigslMaUpFyAG8TMlXigiqmAZX4xgijKjRlGpLE0GdplRfCaJo0JQaSxNBk6ZmMzcya0FmrcisDdn0Q3HI2sWSppYigmlM1XT/kLQZSNpMJG0WkjYbSZuDpM1F0uYhFc1HxU4m1QJjDK6iL0S5uSj5rgXc3RejEigtcRBtqYPQsiTskmO5vosV+q4VGIKbOkDg0jtRrq+Em1YloaTFar3EGr1EUC8R0kus1Uus00usL97ABr2BjXoDm/QGNhuWtMVBKOwg/i78lT7hBsAvDmwHc/ao3vmUbBmhjeYySZNWvGkfZAgISDSaDo1SVpzGDsAEkF8B+gEapViUoZgUWXcRIGFZNm6gWbAKk0bp0k1MHG9fLYtV4iS2SmLEQFARzRcnf9PUS0LVn05/J9MiRRBU3v2IrvW974v4N00L7ZMk0wXP1409CHo/an8zTRHD3eSJ6m8D4YMkZNl3M79sqeuAsr/m3f+8/yl7A50aiAEJgeBeMWzu7ui9UfUBCe2TIqZIoOd/3/udRBOQidQZUERzb2/VwZN1H/Sju82ew2H2Wfr6qvfVf3hqwDvAIpkQVFy4B9Pe9e4/XvPeceu7h3dvO56iJPf0+A6cqA2ip18ER+iFgggiuOkvj24bby0N9j2UHIkgqIt+sVgfodC4YghLSMjSZbH0VR/6dMDrYJeKHilKTemt6v6kvzvn3/RrdWtr0GoN/xL+Sex/cPYLUpepx9cz/D46UPU5KXgAQa+NDps1v6J3xP1i2HtaDB0M9aX2deA7SYff//+gUCovMmIK/qfsFcOk+4Y5ZN97XlG6zebqtMbKgeRFi51vnxTQYBUik2rS/Cn6PC8ADR8FGxsRPB82dzfND90gIcshOcYUkfjherBz53odpm6TP8txlwOZ71xmfHHOvq053qFF/MRlS3jP0ELudrf2OeN8DHvp6ZceLe8qKYvWz/7yp0u4dKPfli3CYq0O13Ih71mylJ80tOi10On8wi+F4+LWgDPeJ30msSQt9/vkmHq9/Lvo2b461mP801v3W4xTcs6CbvF9UDdrSt+A8OUbpSh55qAUFXWznBBfdeJ8a4d7ugT5tvxUza3h9m4H7ptTqiG4z0g5dc0X29OcGlhpGFMpQo9ytTS+NViZpNdvU4kWx+LKxNY10kQ1yqGXrhe4/1nvP7E+nd5A92TtaRplbHSqoIdOqtRWti+fkB5/n1+/VvCmz12pG1kpQWsfi1ftlBobm0bpngs16CHkbIwdLnParxtTV3QYRlfJ0KFskH7pdN/YDn+yRuSd7sNH3aO0DYPggk6uWuXrfOc+fa3VTxFVvKaNxHsiHmsXyCLIE5yuOeN3/Jdf8HBL/5M6shjyhxHx9BjB1O0+4NLOnjLLSxwO7ukN4jMbOIcD879KLSi6Pk61Oqm2377n8079PXEEQ7cy7OKEC9nbpet118fxweTafpt69x/Bt8UqGzNQt7aelpc44dn5cqhwf71+qKp/Zf/+a0zcizOUWpl/iBcSXip0pplkatCchoH5c5aUM8I7/dWxAej8WicPL1URFZ9BDJelUwEwTkGqUhgSlydVes95YdXvhh9Gfz/aeFWvgVb4tuLbcv4+wLdutVZv/cUonwBD/6eDlE0aSiKK/uoH3+J1wDE/jMVqY2ysGufN84oIXB0sPzy8ollX/LegY74DgJXJR57sn+VGza0x3DnuIgABFM15LmajjjsNlYj+JEZGbuRYcAMOWxFkPN2w6Wd46xo4gVWQR/X4lyI/R6K/YK0110GzudPRW7Y+UOBGTfNNzHeYT0fiH0taunBpq9HEW8OKSaBGj21L0MqenEmNRWBAWDWAk4CpNoEZJ2tTaPFgbQYj8HxtFilErs3BTRwT8uO1NXQaWfIotchmPkAF5mMBAliEmZiOGVgCG9LgRzpscMAOOwowlT3JhusdazXGSC/hxR3UlmWVwWHpOIKheqONvjyhSiTHIkVUco5bnji8m//zL7PKaT1Vl5I6UE609f+gkr6MZKVyKc7zJRmCahLsdlyA5fdQkRSan9LgnnLEyGSkaKJCJog0wAgvepWBt80+1yKln1bMVtCljfNWDueKLsWwaEbBSfSPTEmVRsUcYYMnEjcjeyCZzBXK9E9BYBXLKjOSpUDR+nEV3TFSUdQaz+ot98QxgXwx0GQ+EEUAKB2qZPkQQ0GqFD8UPFMqyaCHM24BZmSGic9EYMagKizOw9Hz50DMrDLrqqLkTAhplMictiCAx5S3BIUQdeJeLnBy2CNtMfz6cV4u8XKoFZQesbf9YZiIERiHjaNodDW6LgcirX/mPnJIkBGDUpTBhSa0EIr38D5hCIszhCM8URGBqImoWjpvpt1ebu/v3Gl3qJfMnNM+9V+kiRFyROTPHQWOcs1dNW94/ukKMPZBvDi55i5CttdeJz84DLngLqjcdwEZ87bFFR8CIG35OAkDVN6VRDZ7aq67NteYqZ2lpT8oYB2CytoBd6VuAx4WgiAsnuj3WohG+LugzXiQRDeM3XYXlULv4dp5VFYC"><link rel="preload" as="font" crossorigin="anonymous" href="/assets/KaTeX_Size4-Regular-a4af7d41.woff2"><link rel="preload" as="font" crossorigin="anonymous" href="/assets/KaTeX_Typewriter-Regular-71d517d6.woff2"><link rel="preload" as="font" crossorigin="anonymous" href="data:font/woff2;base64,d09GMgABAAAAAAkcAAsAAAAAEogAAAjNAAEAAAAAAAAAAAAAAAAAAAAAAAAAAAAABmAAgSQRCAqcLJZKCzoAATYCJANwBCAFgkoHIBupDgDm53Gzej8JpU0wqygVVyoWwphIsuuw60jpmBY6ppTa7mk7jtx57UQ0V2ulvfmteSIQji061T2HvfDEECASKizU5VUQXFjFRtgYTVg+woiYDVezOThR4tAvr/YYgOO/RZ+BAABzYtMA8Kl8Neg3UIDCoCkOyWBuLcCvSHycH78QvhFxmUCK03A0RwGSvXBAHgR8UB8DMvocJYAgbiZiJnqmYGbXjG3mz7P8nHhe8Uvxr0j+fzwPABAjWT1E83IJHh/x87G/jv1l7JtYR+y+WF2MKAai/qfDtfIRt7hBikI8D1IpipXqWqYSDgDBfwE7qDLw5EEALqFRDMKAsApNwchXAJgFL/WETMbKcDVSifR6QkjwkDaRTEugqlBtKVcL6Smi1dHlIqUmuii6Pic1JTIlFTX3uRenMNpiCiKOCZBm2ges0b/ScigDVgcb2MEHfloel7e1z208KrZUeQFjK0dIkbl6FOFczRhFE6zaRklPlz52tOXcKtmpdqisgHnbxRatg66vsZNHaWMPQ/eZmH6jaavlNASsipbKwVZSYrRm1mywI0670UEdhLy+yuscolSZJHKwg5IyNzRJQbKRZiicwnYiChjO1vSbKCBpkAgCjGIb6KCvA5GL0VHeUDwAQEHkSC2ToBJhKN9KAneim2ekLf1vENf3mjT3vAS295XY2MMgzRpSqTVWpt4ang+ksXynRUQPlkFOu+b6Yw0jBp8krbXbYbjc5mn6KpsNWKtqtcNz0D8xTTQKzthbZYAxLev3NkFgyYWsngBjGo8jg6a9Y3rKR9Pfqun10RvJi9X9foZGvrltMkJgWR7dhI7SSITEaBWIQQTMUSOJkTi5nlqpZUfNKcYD1Do/ZdkbR8UeVpKLSbMVgKLX0flzQYqCrLpll+/vus2IM9+lbdTgWWRLQJqvaq7eHKulgL2ssp7LrpxR2DBI/ja1zXvi7cS1E0Gr0uhy7PUGwPmdkkdjEYOjpGnQRXowC/GBq51eymLRXrsXsTzXX37VlXzeVxoI6m8Gy67oBnzsB6DoQYY7GHM2fbT4oS9zON45lPnwbmww2BL0G89EnfaVPi5eJ3NZFtjc277Wb9M1A+UWG2WZyrj6PMKmLHRoH04iZLuivlsHTmm9/qYJ1r2Z90DtuKYduK6SdNZ3dRRxHAoE+l4HGM6MyIe+0se+zHEfsP4s2sqqnVdSTE/8lCVYMRVsuBVEJOvT3fa1Xr4X2iDZflVFmxyDmpu1r8b9IsVzXUB9w1/l9ccf7WCszaI1ATtUx7oRztk1dtbBcciudJAi83Vv2yaTg9uON6toxLlIM2GVxClo2eVBt5gcOHRwHLIpptC92TeKRi3MjtBkTAOaoU+6P1q364+kdgt/+xh2fRvlOf2p5xR4ut7P4s0sPwY63OguajQWuYqMjUWaA9100ya6yHdHr/BMyxN9QmGa2zjPnbZr17KTy9weKwqXYtqjcMunRkgE9kP+Refvml14hAZw8WFQGmZnnaEi0eLUQTCc+tLSphVyaUH6lAJoXjF1MDiaFSOexNCRKYW8TOkhKzDEDjPDvHHI3c5hXbQLhujhUuPmBYd+N/EaktFsDqoDo4/G0yx70s3SSuXJDIvjMNsIQ7TDqb+/sv8NHGl6BvDAMOnsCpv9PQcP9tS6N294zEnwtNdt2tfTXSz7JGwAqALmbKpr90BaeqA9tlvduWP4/xa0thZcJMNDC6XqrFuy2xGF7YaiQkN7UfhEbMaNkOxQHezh7YVFBsP9TcoybgmzhaExmpxb/78Naf89LmVWthVvvSWh3rZUWtlMFStWENDf5uqEd2LiP/M/fvWEWUntjnTynpI2ainnLdjPUIvL2uGFJvoUQy0taZvPePLqxy0lK6mUo8yp6B+WtdyyTHivdrgLZrhbvAOlWMbQEJtJZ7JuXgRLC+hwe/kb90WvW4U4/PGGRUmLk995J1loWLRhQwVCKkve4JOS8YJASY+P8KQNe/vahGNU8TJRe/eCaaG7ozsrt6Ixu623v/ck0rvlG2EYBoAh6abIxoZ9UeHoNQAiMPKv/8pIi+47EAMHcfLh7dyX8q0Po+Iap94fFob+4fr/DXr96x+j1x2dhZ0dBfRqardjBIZ+M+S6Lo6ojE+4HKF7Kz7zG+eCOkwQ98UfOirDqrckKPVz3sR8srT/gsev3H0p3Rq7wkD1JLE/XZ+2Ze5pV5eqPiqqmBkc1PQYDBvlk5MdqQff21UyInvyhyjMsHXV33tD3zaQ7Us/NKfX44qLQ/8ffOtzXIjnymRNXampDWkGDR5yOyThG2/9UXC6liWEEz0hX+uR1Xg780i4eNOSig3Fk2pSkPpBqrrmx3/+TbB2ya9ePfrGJx98H8rvjKsRQoSh/G0s8cO6bhwwUI8vUz1c21B04cscrjVV1q8zzCVJkmv/T8y21/bLszJpxeqptculJZpleUyKrPX/X3QZBL+rl+hTWuR/2At7LhYVX9BBsULaqi9LWh+6xMDLW6V65dy2gsMbszemQ96XMDvrSfRM60ceo5R/oGDXB0KrxJsTACBhbV48S4Cd5IeyAVdU5Yg+2nPGKS+XAwmOljrwpIdMmdJPexI9ndnIXUIVgety83YzRdXD6E6YvF0gVGJRMhpOyQW6xGM0Zbq7zw8AoAcWAYa7cSOsARF+Fm8DBAAYgDUq07ZSWvm3UIoAAIAfde39SB7Hz+K/xR9vAkMBg0YE8PKEChkH47+9MDggitAdAEObxnBmZAFu5C4eyMxqN/2c3ZUK2qJ+tDUvrTR/BGHDbqZplsDNZVVQjIaim4XA6TE4YLCfEdweIwAKaArx8aN1JETYMNMDEWGYZdRjMJDAB4T7+EEiwAdiBKCBlRQCfnwjEgohbttG2AYb3yS+7tWIDW1rd/6mMedAM+yEHbAvWge0XgNevwdW20Cmdfb6NXBYqm+DtZHUyUW88R/abjA/OxeYpIa9sNmNGMqHbMgd2CAZPzVuOfQFg5H275pWwx73mQMODQAAAA=="></head><body><div id="app" data-server-rendered="true"><!--[--><!--[--><canvas class="fireworks"></canvas><!--[--><div class="yun-bg"></div><!--]--><!--[--><button class="yun-search-btn popup-trigger yun-icon-btn" title="搜索"><div i-ri-search-line></div></button><!----><!--]--><!--]--><!--[--><!--]--><!----><!--[--><!--[--><!----><button type="button" class="vt-hamburger menu-btn sidebar-toggle yun-icon-btn leading-4 fixed left-0.8rem top-0.6rem md:hidden" aria-label="mobile navigation" aria-expanded="false" inline-flex cursor="pointer" z="$yun-z-menu-btn"><span class="vt-hamburger-container"><span class="vt-hamburger-top"></span><span class="vt-hamburger-middle"></span><span class="vt-hamburger-bottom"></span></span></button><aside class="md:translate-x-0 va-card transition sidebar fixed inset-y-0 left-0 overflow-y-auto" text="center" bg="$yun-sidebar-bg-color contain no-repeat" z="$yun-z-sidebar"><!----><div class><!--[--><div class="sidebar-panel" p="2"><div class="site-info" m="t-6"><a href="/about" class="site-author-avatar"><img class="rounded-full" src="/images/avatar.jpg" alt="avatar"><span class="site-author-status" title="The moonlight is beautiful.">💛</span></a><div class="site-author-name leading-6" m="t-0 b-4"><a href="/about" class>imklaus</a></div><a href="/about/site" class="site-name">imklaus's Blog</a><h4 class="site-subtitle block" text="xs">The Winner Takes It All.</h4><!----></div><nav class="site-nav" text-xl mt-6><a href="/" class="site-link-item yun-icon-btn" title="首页"><div i-ri-home-4-line></div></a><a href="/archives/" class="site-link-item" title="归档"><div class="icon" i-ri-archive-line></div><span class="count">27</span></a><a href="/categories/" class="site-link-item" title="分类"><div class="icon" i-ri-folder-2-line></div><span class="count">2</span></a><a href="/tags/" class="site-link-item" title="标签"><div class="icon" i-ri-price-tag-3-line></div><span class="count">76</span></a><a href="/slides/" class="site-link-item yun-icon-btn" title="幻灯片"><!--[--><div class="i-ri-keynote-line"></div><!--]--></a></nav><hr m="t-4 b-2"><div class="links-of-author"><!--[--><a class="links-of-author-item yun-icon-btn" rel="noopener" href="/atom.xml" title="RSS" target="_blank" style="color:orange"><div class="i-ri-rss-line icon"></div></a><a class="links-of-author-item yun-icon-btn" rel="noopener" href="https://github.com/imLKlauS" title="GitHub" target="_blank" style="color:#6e5494"><div class="i-ri-github-line icon"></div></a><a class="links-of-author-item yun-icon-btn" rel="noopener" href="https://music.163.com/#/user/home?id=102158629" title="冷门歌手" target="_blank" style="color:#c20c0c"><div class="i-ri-netease-cloud-music-line icon"></div></a><a class="links-of-author-item yun-icon-btn" rel="noopener" href="https://space.bilibili.com/19430480" title="哔哩哔哩" target="_blank" style="color:#ff8eb3"><div class="i-ri-bilibili-line icon"></div></a><a class="links-of-author-item yun-icon-btn" rel="noopener" href="https://t.me/elpsycn" title="Telegram Channel" target="_blank" style="color:#08c"><div class="i-ri-telegram-line icon"></div></a><a class="links-of-author-item yun-icon-btn" rel="noopener" href="q1064779584@163.com" title="E-Mail" target="_blank" style="color:#8e71c1"><div class="i-ri-mail-line icon"></div></a><a class="links-of-author-item yun-icon-btn" rel="noopener" href="https://www.travellings.cn/go.html" title="Travelling" target="_blank" style="color:var(--va-c-text)"><div class="i-ri-train-line icon"></div></a><!--]--></div><hr m="y-2"><div class="links flex-center"><!--[--><a href="/comment/" class="link-item yun-icon-btn" inline-flex title="留言板" style="color:#737de5"><!--[--><div class="i-ri-clipboard-line icon w-8 h-8"></div><!--]--></a><a href="/albums/" class="link-item yun-icon-btn" inline-flex title="相册" style="color:#43abee"><!--[--><div class="i-ri-gallery-line icon w-8 h-8"></div><!--]--></a><a href="/links/" class="link-item yun-icon-btn" inline-flex title="友链" style="color:#4bbea4"><!--[--><div class="i-ri-open-arm-line icon w-8 h-8"></div><!--]--></a><a href="/music/" class="link-item yun-icon-btn" inline-flex title="听歌" style="color:#1e90ff"><!--[--><div class="i-ri-netease-cloud-music-line icon w-8 h-8"></div><!--]--></a><!--]--></div><br></div><div><button class="yun-icon-btn" title="切换深色模式" style="color:#f1cb64"><div i="ri-sun-line dark:ri-moon-line"></div></button><button class="yun-icon-btn" title="切换语言" style="color:var(--va-c-text)"><div i-ri-translate class="transition transform"></div></button></div><!--]--></div></aside><!--]--><main class="yun-main lt-md:ml-0" flex="~"><div w="full" flex="~"><!--[--><div class="content" flex="~ col grow" w="full" p="l-4 lt-md:0"><div class="yun-card flex-center relative" flex="col" min-h="100px" bg="$va-c-bg-light" m="0" style><img width="640" height="360" class="object-cover select-none" h="64 md:sm" w="full" src="https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/wallhaven-2em38y_1920x1080.png"><!----><!--[--><!--[--><header class="post-header mb-2" m="t-16 sm:t-6" cover="https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/wallhaven-2em38y_1920x1080.png"><h1 class="post-title flex-center" p="2" text="2xl center" font="serif black" style=""><!----><span inline-flex class="leading-none">秒杀</span></h1></header><!--]--><!--[--><!--[--><!--[--><!--[--><!----><!----><div class="post-top-icon" color="$va-c-warning"><div i-ri-pushpin-line></div></div><div class="post-meta" flex="~ col" justify="center" items="center" text="sm" py="1"><div class="post-time flex items-center"><span class="inline-flex-center" title="发表于2023-04-27T13:43:29.000Z"><div class="inline-block" i-ri-calendar-line></div><time m="l-1">2023-04-27</time></span><span class="inline-flex-center" title="更新于2023-10-03T04:41:59.571Z"><span m="x-2">-</span><div i-ri-calendar-2-line></div><time m="l-1">2023-10-03</time></span></div><div class="post-counter flex items-center" mt="2"><span class="inline-flex-center" title="本文字数"><div class="inline-block" i-ri-file-word-line></div><time m="l-1">14.9k</time></span><span class="inline-flex-center" title="阅读时长"><span m="x-2">-</span><div i-ri-timer-line></div><time m="l-1">81m</time></span></div></div><!--[--><!--]--><!--]--><div flex="~" text="sm" my="1" h="5"><div inline-flex justify="center" items="center" mx="2" title="阅读次数"><div inline-flex i-ri-eye-line></div><span ml-1 inline-flex class="waline-pageview-count" data-path="/posts/flash%20killing"></span></div><div inline-flex justify="center" items="center" mx="2" title="评论数"><div inline-flex i-ri-chat-4-line></div><span ml-1 inline-flex class="waline-comment-count" data-path="/posts/flash%20killing"></span></div></div><div class="inline-flex" text="sm" py="1"><a href="/categories/?category=Java" class="post-category inline-flex-center"><div m="x-1" inline-flex i-ri-folder-2-line></div><span>Java</span></a><span mx="2">-</span><!--[--><a href="/tags/?tag=Spring+Boot" class="post-tag inline-flex-center" m="x-1"><div m="r-1" i-ri-price-tag-3-line></div><span>Spring Boot</span></a><a href="/tags/?tag=Spring+Cloud" class="post-tag inline-flex-center" m="x-1"><div m="r-1" i-ri-price-tag-3-line></div><span>Spring Cloud</span></a><a href="/tags/?tag=token" class="post-tag inline-flex-center" m="x-1"><div m="r-1" i-ri-price-tag-3-line></div><span>token</span></a><a href="/tags/?tag=Redis" class="post-tag inline-flex-center" m="x-1"><div m="r-1" i-ri-price-tag-3-line></div><span>Redis</span></a><a href="/tags/?tag=Redisson" class="post-tag inline-flex-center" m="x-1"><div m="r-1" i-ri-price-tag-3-line></div><span>Redisson</span></a><a href="/tags/?tag=Schedule" class="post-tag inline-flex-center" m="x-1"><div m="r-1" i-ri-price-tag-3-line></div><span>Schedule</span></a><a href="/tags/?tag=RabbitMQ" class="post-tag inline-flex-center" m="x-1"><div m="r-1" i-ri-price-tag-3-line></div><span>RabbitMQ</span></a><!--]--></div><!--]--><!--]--><!--]--><div p="x-4 b-8" class="sm:px-6 lg:px-12 xl:px-16" w="full"><!--[--><article class="markdown-body"><!--[--><!----><!--[--><ul><li>秒杀系统笔记：<ul><li>1）如何设计一个秒杀系统？ 2）秒杀系统项目实战</li></ul></li></ul><!-- more --><h2 id="如何设计一个秒杀系统" tabindex="-1">如何设计一个秒杀系统？ <a aria-current="page" href="/posts/flash%20killing#如何设计一个秒杀系统" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h2><ul><li><p>高并发下如何设计秒杀系统？这是一个高频面试题。这个问题看似简单，但是里面的水很深，它考查的是高并发场景下，从前端到后端多方面的知识。</p></li><li><p>秒杀一般出现在商城的促销活动中，指定了一定数量（比如：10个）的商品（比如：手机），以极低的价格（比如：0.1元），让大量用户参与活动，但只有极少数用户能够购买成功。这类活动商家绝大部分是不赚钱的，说白了是找个噱头宣传自己。</p></li><li><p>虽说秒杀只是一个促销活动，但对技术要求不低。下面给大家总结一下设计秒杀系统需要注意的9个细节。</p></li></ul><figure><img src="https://jsd.cdn.zzko.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230429153744600.png" alt="image-20230429153744600" loading="lazy" decoding="async"></figure><h3 id="_1-瞬时高并发" tabindex="-1">1 瞬时高并发 <a aria-current="page" href="/posts/flash%20killing#_1-瞬时高并发" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h3><ul><li><p>一般在秒杀时间点（比如：12点）前几分钟，用户并发量才真正突增，达到秒杀时间点时，并发量会达到顶峰。</p></li><li><p>但由于这类活动是大量用户抢少量商品的场景，必定会出现狼多肉少的情况，所以其实绝大部分用户秒杀会失败，只有极少部分用户能够成功。</p></li><li><p>正常情况下，大部分用户会收到商品已经抢完的提醒，收到该提醒后，他们大概率不会在那个活动页面停留了，如此一来，用户并发量又会急剧下降。所以这个峰值持续的时间其实是非常短的，这样就会出现瞬时高并发的情况，下面用一张图直观的感受一下流量的变化：</p></li></ul><figure><img src="https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230429154129604.png" alt="image-20230429154129604" loading="lazy" decoding="async"></figure><ul><li>像这种瞬时高并发的场景，传统的系统很难应对，我们需要设计一套全新的系统。可以从以下几个方面入手：<ol><li>页面静态化</li><li>CDN加速</li><li>缓存</li><li>mq异步处理</li><li>限流</li><li>分布式锁</li></ol></li></ul><h3 id="_2-页面静态化" tabindex="-1">2 页面静态化 <a aria-current="page" href="/posts/flash%20killing#_2-页面静态化" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h3><ul><li><p>活动页面是用户流量的第一入口，所以是并发量最大的地方。</p></li><li><p>如果这些流量都能直接访问服务端，恐怕服务端会因为承受不住这么大的压力，而直接挂掉。</p></li></ul><figure><img src="https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230429154425207.png" alt="image-20230429154425207" loading="lazy" decoding="async"></figure><ul><li>活动页面绝大多数内容是固定的，比如：商品名称、商品描述、图片等。为了减少不必要的服务端请求，通常情况下，会对活动页面做<code>静态化</code>处理。用户浏览商品等常规操作，并不会请求到服务端。只有到了秒杀时间点，并且用户主动点了秒杀按钮才允许访问服务端。</li></ul><figure><img src="https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230429154505896.png" alt="image-20230429154505896" loading="lazy" decoding="async"></figure><ul><li><p>这样能过滤大部分无效请求。</p></li><li><p>但只做页面静态化还不够，因为用户分布在全国各地，有些人在北京，有些人在成都，有些人在深圳，地域相差很远，网速各不相同。</p></li><li><p>如何才能让用户最快访问到活动页面呢？</p><ul><li>这就需要使用CDN，它的全称是Content Delivery Network，即内容分发网络。</li></ul></li></ul><figure><img src="https://jsd.cdn.zzko.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230429154557367.png" alt="image-20230429154557367" loading="lazy" decoding="async"></figure><blockquote><p>使用户就近获取所需内容，降低网络拥塞，提高用户访问响应速度和命中率。</p></blockquote><h3 id="_3-秒杀按钮" tabindex="-1">3 秒杀按钮 <a aria-current="page" href="/posts/flash%20killing#_3-秒杀按钮" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h3><ul><li><p>大部分用户怕错过秒杀时间点，一般会提前进入活动页面。此时看到的秒杀按钮是置灰，不可点击的。只有到了秒杀时间点那一时刻，秒杀按钮才会自动点亮，变成可点击的。</p></li><li><p>但此时很多用户已经迫不及待了，通过不停刷新页面，争取在第一时间看到秒杀按钮的点亮。</p></li><li><p>从前面得知，该活动页面是静态的。那么我们在静态页面中如何控制秒杀按钮，只在秒杀时间点时才点亮呢？</p><ul><li>没错，使用js文件控制。</li></ul></li><li><p>为了性能考虑，一般会将css、js和图片等静态资源文件提前缓存到CDN上，让用户能够就近访问秒杀页面。</p></li><li><p>看到这里，有些聪明的小伙伴，可能会问：CDN上的js文件是如何更新的？</p><ul><li>秒杀开始之前，js标志为false，还有另外一个随机参数。</li></ul></li></ul><figure><img src="https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230429154759471.png" alt="image-20230429154759471" loading="lazy" decoding="async"></figure><ul><li>当秒杀开始的时候系统会生成一个新的js文件，此时标志为true，并且随机参数生成一个新值，然后同步给CDN。由于有了这个随机参数，CDN不会缓存数据，每次都能从CDN中获取最新的js代码。</li></ul><figure><img src="https://jsd.cdn.zzko.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230429154818790.png" alt="image-20230429154818790" loading="lazy" decoding="async"></figure><blockquote><p>此外，前端还可以加一个定时器，控制比如：10秒之内，只允许发起一次请求。如果用户点击了一次秒杀按钮，则在10秒之内置灰，不允许再次点击，等到过了时间限制，又允许重新点击该按钮。</p></blockquote><h3 id="_4-读多写少" tabindex="-1">4 读多写少 <a aria-current="page" href="/posts/flash%20killing#_4-读多写少" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h3><ul><li><p>在秒杀的过程中，系统一般会先查一下库存是否足够，如果足够才允许下单，写数据库。如果不够，则直接返回该商品已经抢完。</p></li><li><p>由于大量用户抢少量商品，只有极少部分用户能够抢成功，所以绝大部分用户在秒杀时，库存其实是不足的，系统会直接返回该商品已经抢完。</p></li><li><p>这是非常典型的：读多写少 的场景。</p></li></ul><figure><img src="https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230429155156269.png" alt="image-20230429155156269" loading="lazy" decoding="async"></figure><ul><li><p>如果有数十万的请求过来，同时通过数据库查缓存是否足够，此时数据库可能会挂掉。因为数据库的连接资源非常有限，比如：mysql，无法同时支持这么多的连接。</p></li><li><p>而应该改用缓存，比如：redis。</p></li><li><p>即便用了redis，也需要部署多个节点。</p></li></ul><figure><img src="https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230429155327734.png" alt="image-20230429155327734" loading="lazy" decoding="async"></figure><h3 id="_5-缓存问题" tabindex="-1">5 缓存问题 <a aria-current="page" href="/posts/flash%20killing#_5-缓存问题" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h3><ul><li><p>通常情况下，我们需要在redis中保存商品信息，里面包含：商品id、商品名称、规格属性、库存等信息，同时数据库中也要有相关信息，毕竟缓存并不完全可靠。</p></li><li><p>用户在点击秒杀按钮，请求秒杀接口的过程中，需要传入的商品id参数，然后服务端需要校验该商品是否合法。</p></li><li><p>大致流程如下图所示：</p></li></ul><figure><img src="https://jsd.cdn.zzko.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230429155407944.png" alt="image-20230429155407944" loading="lazy" decoding="async"></figure><blockquote><ul><li><p>根据商品id，先从缓存中查询商品，如果商品存在，则参与秒杀。如果不存在，则需要从数据库中查询商品，如果存在，则将商品信息放入缓存，然后参与秒杀。如果商品不存在，则直接提示失败。</p></li><li><p>这个过程表面上看起来是OK的，但是如果深入分析一下会发现一些问题。</p></li></ul></blockquote><h4 id="_5-1-缓存击穿" tabindex="-1">5.1 缓存击穿 <a aria-current="page" href="/posts/flash%20killing#_5-1-缓存击穿" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h4><ul><li><p>比如商品A第一次秒杀时，缓存中是没有数据的，但数据库中有。虽说上面有如果从数据库中查到数据，则放入缓存的逻辑。</p></li><li><p>然而，在高并发下，同一时刻会有大量的请求，都在秒杀同一件商品，这些请求同时去查缓存中没有数据，然后又同时访问数据库。结果悲剧了，数据库可能扛不住压力，直接挂掉。</p></li><li><p>如何解决这个问题呢？</p><ul><li>这就需要加锁，最好使用分布式锁。</li></ul></li></ul><figure><img src="https://jsd.cdn.zzko.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230429155613279.png" alt="image-20230429155613279" loading="lazy" decoding="async"></figure><blockquote><ul><li>当然，针对这种情况，最好在项目启动之前，先把缓存进行预热。即事先把所有的商品，同步到缓存中，这样商品基本都能直接从缓存中获取到，就不会出现缓存击穿的问题了。</li><li>是不是上面加锁这一步可以不需要了？<ul><li>表面上看起来，确实可以不需要。但如果缓存中设置的过期时间不对，缓存提前过期了，或者缓存被不小心删除了，如果不加速同样可能出现缓存击穿。</li><li>其实这里加锁，相当于买了一份保险。</li></ul></li></ul></blockquote><h4 id="_5-2-缓存穿透" tabindex="-1">5.2 缓存穿透 <a aria-current="page" href="/posts/flash%20killing#_5-2-缓存穿透" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h4><ul><li><p>如果有大量的请求传入的商品id，在缓存中和数据库中都不存在，这些请求不就每次都会穿透过缓存，而直接访问数据库了。</p></li><li><p>由于前面已经加了锁，所以即使这里的并发量很大，也不会导致数据库直接挂掉。</p></li><li><p>但很显然这些请求的处理性能并不好，有没有更好的解决方案？</p><ul><li>这时可以想到布隆过滤器。</li></ul></li></ul><figure><img src="https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230429160015188.png" alt="image-20230429160015188" loading="lazy" decoding="async"></figure><ul><li><p>系统根据商品id，先从布隆过滤器中查询该id是否存在，如果存在则允许从缓存中查询数据，如果不存在，则直接返回失败。</p></li><li><p>虽说该方案可以解决缓存穿透问题，但是又会引出另外一个问题：布隆过滤器中的数据如何跟缓存中的数据保持一致？</p></li><li><p>这就要求，如果缓存中数据有更新，则要及时同步到布隆过滤器中。如果数据同步失败了，还需要增加重试机制，而且跨数据源，能保证数据的实时一致性吗？</p><ul><li>显然是不行的。</li></ul></li><li><p>所以布隆过滤器绝大部分使用在缓存数据更新很少的场景中。</p></li><li><p>如果缓存数据更新非常频繁，又该如何处理呢？</p></li><li><p>这时，就需要把不存在的商品id也缓存起来。</p></li></ul><figure><img src="https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230429160205059.png" alt="image-20230429160205059" loading="lazy" decoding="async"></figure><blockquote><p>下次，再有该商品id的请求过来，则也能从缓存中查到数据，只不过该数据比较特殊，表示商品不存在。需要特别注意的是，这种特殊缓存设置的超时时间应该尽量短一点。</p></blockquote><h3 id="_6-库存问题" tabindex="-1">6 库存问题 <a aria-current="page" href="/posts/flash%20killing#_6-库存问题" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h3><ul><li><p>对于库存问题看似简单，实则里面还是有些东西。</p></li><li><p>真正的秒杀商品的场景，不是说扣完库存，就完事了，如果用户在一段时间内，还没完成支付，扣减的库存是要加回去的。</p></li><li><p>所以，在这里引出了一个预扣库存的概念，预扣库存的主要流程如下：</p></li></ul><figure><img src="https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230429160545360.png" alt="image-20230429160545360" loading="lazy" decoding="async"></figure><blockquote><p>扣减库存中除了上面说到的预扣库存和回退库存之外，还需要特别注意的是库存不足和库存超卖问题。</p></blockquote><h4 id="_6-1-数据库扣减库存" tabindex="-1">6.1 数据库扣减库存 <a aria-current="page" href="/posts/flash%20killing#_6-1-数据库扣减库存" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h4><ul><li>使用数据库扣减库存，是最简单的实现方案了，假设扣减库存的sql如下：</li></ul><div class="language-sql"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#f97583">update</span><span style="color:#e1e4e8"> product </span><span style="color:#f97583">set</span><span style="color:#e1e4e8"> stock</span><span style="color:#f97583">=</span><span style="color:#e1e4e8">stock</span><span style="color:#f97583">-</span><span style="color:#79b8ff">1</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">where</span><span style="color:#e1e4e8"> id</span><span style="color:#f97583">=</span><span style="color:#79b8ff">123</span><span style="color:#e1e4e8">;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#d73a49">update</span><span style="color:#24292e"> product </span><span style="color:#d73a49">set</span><span style="color:#24292e"> stock</span><span style="color:#d73a49">=</span><span style="color:#24292e">stock</span><span style="color:#d73a49">-</span><span style="color:#005cc5">1</span><span style="color:#24292e"> </span><span style="color:#d73a49">where</span><span style="color:#24292e"> id</span><span style="color:#d73a49">=</span><span style="color:#005cc5">123</span><span style="color:#24292e">;</span></span></code></pre></div><ul><li><p>这种写法对于扣减库存是没有问题的，但如何控制库存不足的情况下，不让用户操作呢？</p><ul><li><p>这就需要在update之前，先查一下库存是否足够了。</p></li><li><p>伪代码如下：</p></li></ul><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#f97583">int</span><span style="color:#e1e4e8"> stock </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> mapper.</span><span style="color:#b392f0">getStockById</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">123</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#f97583">if</span><span style="color:#e1e4e8">(stock </span><span style="color:#f97583">&gt;</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">  </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> count </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> mapper.</span><span style="color:#b392f0">updateStock</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">123</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">  </span><span style="color:#f97583">if</span><span style="color:#e1e4e8">(count </span><span style="color:#f97583">&gt;</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#b392f0">addOrder</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">123</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">  }</span></span>
<span class="line"><span style="color:#e1e4e8">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#d73a49">int</span><span style="color:#24292e"> stock </span><span style="color:#d73a49">=</span><span style="color:#24292e"> mapper.</span><span style="color:#6f42c1">getStockById</span><span style="color:#24292e">(</span><span style="color:#005cc5">123</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#d73a49">if</span><span style="color:#24292e">(stock </span><span style="color:#d73a49">&gt;</span><span style="color:#24292e"> </span><span style="color:#005cc5">0</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">  </span><span style="color:#d73a49">int</span><span style="color:#24292e"> count </span><span style="color:#d73a49">=</span><span style="color:#24292e"> mapper.</span><span style="color:#6f42c1">updateStock</span><span style="color:#24292e">(</span><span style="color:#005cc5">123</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">  </span><span style="color:#d73a49">if</span><span style="color:#24292e">(count </span><span style="color:#d73a49">&gt;</span><span style="color:#24292e"> </span><span style="color:#005cc5">0</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6f42c1">addOrder</span><span style="color:#24292e">(</span><span style="color:#005cc5">123</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">  }</span></span>
<span class="line"><span style="color:#24292e">}</span></span></code></pre></div></li><li><p>大家有没有发现这段代码的问题？</p><ul><li><p>没错，查询操作和更新操作不是原子性的，会导致在并发的场景下，出现库存超卖的情况。</p></li><li><p>有人可能会说，这样好办，加把锁，不就搞定了，比如使用synchronized关键字。</p></li><li><p>确实，可以，但是性能不够好。</p></li><li><p>还有更优雅的处理方案，即基于数据库的乐观锁，这样会少一次数据库查询，而且能够天然的保证数据操作的原子性。</p></li><li><p>只需将上面的sql稍微调整一下：</p></li></ul><div class="language-sql"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#f97583">update</span><span style="color:#e1e4e8"> product </span><span style="color:#f97583">set</span><span style="color:#e1e4e8"> stock</span><span style="color:#f97583">=</span><span style="color:#e1e4e8">stock</span><span style="color:#f97583">-</span><span style="color:#79b8ff">1</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">where</span><span style="color:#e1e4e8"> id</span><span style="color:#f97583">=</span><span style="color:#e1e4e8">product </span><span style="color:#f97583">and</span><span style="color:#e1e4e8"> stock </span><span style="color:#f97583">&gt;</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8">;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#d73a49">update</span><span style="color:#24292e"> product </span><span style="color:#d73a49">set</span><span style="color:#24292e"> stock</span><span style="color:#d73a49">=</span><span style="color:#24292e">stock</span><span style="color:#d73a49">-</span><span style="color:#005cc5">1</span><span style="color:#24292e"> </span><span style="color:#d73a49">where</span><span style="color:#24292e"> id</span><span style="color:#d73a49">=</span><span style="color:#24292e">product </span><span style="color:#d73a49">and</span><span style="color:#24292e"> stock </span><span style="color:#d73a49">&gt;</span><span style="color:#24292e"> </span><span style="color:#005cc5">0</span><span style="color:#24292e">;</span></span></code></pre></div></li></ul><blockquote><ul><li><p>在sql最后加上：stock &gt; 0，就能保证不会出现超卖的情况。</p></li><li><p>但需要频繁访问数据库，我们都知道数据库连接是非常昂贵的资源。在高并发的场景下，可能会造成系统雪崩。而且，容易出现多个请求，同时竞争行锁的情况，造成相互等待，从而出现死锁的问题。</p></li></ul></blockquote><h4 id="_6-2-redis扣减库存" tabindex="-1">6.2 redis扣减库存 <a aria-current="page" href="/posts/flash%20killing#_6-2-redis扣减库存" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h4><ul><li>redis的<code>incr</code>方法是原子性的，可以用该方法扣减库存。 伪代码如下：</li></ul><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#f97583">boolean</span><span style="color:#e1e4e8"> exist </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> redisClient.</span><span style="color:#b392f0">query</span><span style="color:#e1e4e8">(productId,userId);</span></span>
<span class="line"><span style="color:#e1e4e8">  </span><span style="color:#f97583">if</span><span style="color:#e1e4e8">(exist) {</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">-</span><span style="color:#79b8ff">1</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">  }</span></span>
<span class="line"><span style="color:#e1e4e8">  </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> stock </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> redisClient.</span><span style="color:#b392f0">queryStock</span><span style="color:#e1e4e8">(productId);</span></span>
<span class="line"><span style="color:#e1e4e8">  </span><span style="color:#f97583">if</span><span style="color:#e1e4e8">(stock </span><span style="color:#f97583">&lt;=</span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">  }</span></span>
<span class="line"><span style="color:#e1e4e8">  redisClient.</span><span style="color:#b392f0">incrby</span><span style="color:#e1e4e8">(productId, </span><span style="color:#f97583">-</span><span style="color:#79b8ff">1</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">  redisClient.</span><span style="color:#b392f0">add</span><span style="color:#e1e4e8">(productId,userId);</span></span>
<span class="line"><span style="color:#e1e4e8">  </span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">1</span><span style="color:#e1e4e8">;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#d73a49">boolean</span><span style="color:#24292e"> exist </span><span style="color:#d73a49">=</span><span style="color:#24292e"> redisClient.</span><span style="color:#6f42c1">query</span><span style="color:#24292e">(productId,userId);</span></span>
<span class="line"><span style="color:#24292e">  </span><span style="color:#d73a49">if</span><span style="color:#24292e">(exist) {</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">return</span><span style="color:#24292e"> </span><span style="color:#d73a49">-</span><span style="color:#005cc5">1</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">  }</span></span>
<span class="line"><span style="color:#24292e">  </span><span style="color:#d73a49">int</span><span style="color:#24292e"> stock </span><span style="color:#d73a49">=</span><span style="color:#24292e"> redisClient.</span><span style="color:#6f42c1">queryStock</span><span style="color:#24292e">(productId);</span></span>
<span class="line"><span style="color:#24292e">  </span><span style="color:#d73a49">if</span><span style="color:#24292e">(stock </span><span style="color:#d73a49">&lt;=</span><span style="color:#005cc5">0</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">return</span><span style="color:#24292e"> </span><span style="color:#005cc5">0</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">  }</span></span>
<span class="line"><span style="color:#24292e">  redisClient.</span><span style="color:#6f42c1">incrby</span><span style="color:#24292e">(productId, </span><span style="color:#d73a49">-</span><span style="color:#005cc5">1</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">  redisClient.</span><span style="color:#6f42c1">add</span><span style="color:#24292e">(productId,userId);</span></span>
<span class="line"><span style="color:#24292e">  </span><span style="color:#d73a49">return</span><span style="color:#24292e"> </span><span style="color:#005cc5">1</span><span style="color:#24292e">;</span></span></code></pre></div><ul><li>代码流程如下：</li></ul><ol><li><p>先判断该用户有没有秒杀过该商品，如果已经秒杀过，则直接返回-1。</p></li><li><p>查询库存，如果库存小于等于0，则直接返回0，表示库存不足。</p></li><li><p>如果库存充足，则扣减库存，然后将本次秒杀记录保存起来。然后返回1，表示成功。</p></li></ol><ul><li><p>估计很多小伙伴，一开始都会按这样的思路写代码。但如果仔细想想会发现，这段代码有问题。</p></li><li><p>有什么问题呢？</p><ul><li>如果在高并发下，有多个请求同时查询库存，当时都大于0。由于查询库存和更新库存非原则操作，则会出现库存为负数的情况，即<code>库存超卖</code>。</li></ul></li><li><p>当然有人可能会说，加个<code>synchronized</code>不就解决问题？</p></li><li><p>调整后代码如下：</p></li></ul><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#f97583">boolean</span><span style="color:#e1e4e8"> exist </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> redisClient.</span><span style="color:#b392f0">query</span><span style="color:#e1e4e8">(productId,userId);</span></span>
<span class="line"><span style="color:#e1e4e8">   </span><span style="color:#f97583">if</span><span style="color:#e1e4e8">(exist) {</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">-</span><span style="color:#79b8ff">1</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">   }</span></span>
<span class="line"><span style="color:#e1e4e8">   </span><span style="color:#f97583">synchronized</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">this</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">       </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> stock </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> redisClient.</span><span style="color:#b392f0">queryStock</span><span style="color:#e1e4e8">(productId);</span></span>
<span class="line"><span style="color:#e1e4e8">       </span><span style="color:#f97583">if</span><span style="color:#e1e4e8">(stock </span><span style="color:#f97583">&lt;=</span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">         </span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">       }</span></span>
<span class="line"><span style="color:#e1e4e8">       redisClient.</span><span style="color:#b392f0">incrby</span><span style="color:#e1e4e8">(productId, </span><span style="color:#f97583">-</span><span style="color:#79b8ff">1</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">       redisClient.</span><span style="color:#b392f0">add</span><span style="color:#e1e4e8">(productId,userId);</span></span>
<span class="line"><span style="color:#e1e4e8">   }</span></span>
<span class="line"><span style="color:#f97583">return</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">1</span><span style="color:#e1e4e8">;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#d73a49">boolean</span><span style="color:#24292e"> exist </span><span style="color:#d73a49">=</span><span style="color:#24292e"> redisClient.</span><span style="color:#6f42c1">query</span><span style="color:#24292e">(productId,userId);</span></span>
<span class="line"><span style="color:#24292e">   </span><span style="color:#d73a49">if</span><span style="color:#24292e">(exist) {</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">return</span><span style="color:#24292e"> </span><span style="color:#d73a49">-</span><span style="color:#005cc5">1</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">   }</span></span>
<span class="line"><span style="color:#24292e">   </span><span style="color:#d73a49">synchronized</span><span style="color:#24292e">(</span><span style="color:#005cc5">this</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">       </span><span style="color:#d73a49">int</span><span style="color:#24292e"> stock </span><span style="color:#d73a49">=</span><span style="color:#24292e"> redisClient.</span><span style="color:#6f42c1">queryStock</span><span style="color:#24292e">(productId);</span></span>
<span class="line"><span style="color:#24292e">       </span><span style="color:#d73a49">if</span><span style="color:#24292e">(stock </span><span style="color:#d73a49">&lt;=</span><span style="color:#005cc5">0</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">         </span><span style="color:#d73a49">return</span><span style="color:#24292e"> </span><span style="color:#005cc5">0</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">       }</span></span>
<span class="line"><span style="color:#24292e">       redisClient.</span><span style="color:#6f42c1">incrby</span><span style="color:#24292e">(productId, </span><span style="color:#d73a49">-</span><span style="color:#005cc5">1</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">       redisClient.</span><span style="color:#6f42c1">add</span><span style="color:#24292e">(productId,userId);</span></span>
<span class="line"><span style="color:#24292e">   }</span></span>
<span class="line"><span style="color:#d73a49">return</span><span style="color:#24292e"> </span><span style="color:#005cc5">1</span><span style="color:#24292e">;</span></span></code></pre></div><ul><li><p>加<code>synchronized</code>确实能解决库存为负数问题，但是这样会导致接口性能急剧下降，每次查询都需要竞争同一把锁，显然不太合理。</p></li><li><p>为了解决上面的问题，代码优化如下：</p></li></ul><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#f97583">boolean</span><span style="color:#e1e4e8"> exist </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> redisClient.</span><span style="color:#b392f0">query</span><span style="color:#e1e4e8">(productId,userId);</span></span>
<span class="line"><span style="color:#f97583">if</span><span style="color:#e1e4e8">(exist) {</span></span>
<span class="line"><span style="color:#e1e4e8">  </span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">-</span><span style="color:#79b8ff">1</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">}</span></span>
<span class="line"><span style="color:#f97583">if</span><span style="color:#e1e4e8">(redisClient.</span><span style="color:#b392f0">incrby</span><span style="color:#e1e4e8">(productId, </span><span style="color:#f97583">-</span><span style="color:#79b8ff">1</span><span style="color:#e1e4e8">)</span><span style="color:#f97583">&lt;</span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">  </span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">}</span></span>
<span class="line"><span style="color:#e1e4e8">redisClient.</span><span style="color:#b392f0">add</span><span style="color:#e1e4e8">(productId,userId);</span></span>
<span class="line"><span style="color:#f97583">return</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">1</span><span style="color:#e1e4e8">;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#d73a49">boolean</span><span style="color:#24292e"> exist </span><span style="color:#d73a49">=</span><span style="color:#24292e"> redisClient.</span><span style="color:#6f42c1">query</span><span style="color:#24292e">(productId,userId);</span></span>
<span class="line"><span style="color:#d73a49">if</span><span style="color:#24292e">(exist) {</span></span>
<span class="line"><span style="color:#24292e">  </span><span style="color:#d73a49">return</span><span style="color:#24292e"> </span><span style="color:#d73a49">-</span><span style="color:#005cc5">1</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">}</span></span>
<span class="line"><span style="color:#d73a49">if</span><span style="color:#24292e">(redisClient.</span><span style="color:#6f42c1">incrby</span><span style="color:#24292e">(productId, </span><span style="color:#d73a49">-</span><span style="color:#005cc5">1</span><span style="color:#24292e">)</span><span style="color:#d73a49">&lt;</span><span style="color:#005cc5">0</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">  </span><span style="color:#d73a49">return</span><span style="color:#24292e"> </span><span style="color:#005cc5">0</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">}</span></span>
<span class="line"><span style="color:#24292e">redisClient.</span><span style="color:#6f42c1">add</span><span style="color:#24292e">(productId,userId);</span></span>
<span class="line"><span style="color:#d73a49">return</span><span style="color:#24292e"> </span><span style="color:#005cc5">1</span><span style="color:#24292e">;</span></span></code></pre></div><ul><li>该代码主要流程如下：</li></ul><ol><li><p>先判断该用户有没有秒杀过该商品，如果已经秒杀过，则直接返回-1。</p></li><li><p>扣减库存，判断返回值是否小于0，如果小于0，则直接返回0，表示库存不足。</p></li><li><p>如果扣减库存后，返回值大于或等于0，则将本次秒杀记录保存起来。然后返回1，表示成功。</p></li></ol><blockquote><ul><li><p>该方案咋一看，好像没问题。</p><ul><li>但如果在高并发场景中，有多个请求同时扣减库存，大多数请求的incrby操作之后，结果都会小于0。</li></ul></li><li><p>虽说，库存出现负数，不会出现超卖的问题。但由于这里是预减库存，如果负数值负的太多的话，后面万一要回退库存时，就会导致库存不准。</p></li><li><p>那么，有没有更好的方案呢？</p></li></ul></blockquote><h4 id="_6-3-lua脚本扣减库存" tabindex="-1">6.3 lua脚本扣减库存 <a aria-current="page" href="/posts/flash%20killing#_6-3-lua脚本扣减库存" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h4><ul><li><p>我们都知道lua脚本，是能够保证原子性的，它跟redis一起配合使用，能够完美解决上面的问题。</p></li><li><p>lua脚本有段非常经典的代码：</p></li></ul><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8">StringBuilder lua </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">StringBuilder</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">  lua.</span><span style="color:#b392f0">append</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"if (redis.call('exists', KEYS[1]) == 1) then"</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">  lua.</span><span style="color:#b392f0">append</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"    local stock = tonumber(redis.call('get', KEYS[1]));"</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">  lua.</span><span style="color:#b392f0">append</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"    if (stock == -1) then"</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">  lua.</span><span style="color:#b392f0">append</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"        return 1;"</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">  lua.</span><span style="color:#b392f0">append</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"    end;"</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">  lua.</span><span style="color:#b392f0">append</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"    if (stock &gt; 0) then"</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">  lua.</span><span style="color:#b392f0">append</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"        redis.call('incrby', KEYS[1], -1);"</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">  lua.</span><span style="color:#b392f0">append</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"        return stock;"</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">  lua.</span><span style="color:#b392f0">append</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"    end;"</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">  lua.</span><span style="color:#b392f0">append</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"    return 0;"</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">  lua.</span><span style="color:#b392f0">append</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"end;"</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">  lua.</span><span style="color:#b392f0">append</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"return -1;"</span><span style="color:#e1e4e8">);</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e">StringBuilder lua </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">StringBuilder</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">  lua.</span><span style="color:#6f42c1">append</span><span style="color:#24292e">(</span><span style="color:#032f62">"if (redis.call('exists', KEYS[1]) == 1) then"</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">  lua.</span><span style="color:#6f42c1">append</span><span style="color:#24292e">(</span><span style="color:#032f62">"    local stock = tonumber(redis.call('get', KEYS[1]));"</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">  lua.</span><span style="color:#6f42c1">append</span><span style="color:#24292e">(</span><span style="color:#032f62">"    if (stock == -1) then"</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">  lua.</span><span style="color:#6f42c1">append</span><span style="color:#24292e">(</span><span style="color:#032f62">"        return 1;"</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">  lua.</span><span style="color:#6f42c1">append</span><span style="color:#24292e">(</span><span style="color:#032f62">"    end;"</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">  lua.</span><span style="color:#6f42c1">append</span><span style="color:#24292e">(</span><span style="color:#032f62">"    if (stock &gt; 0) then"</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">  lua.</span><span style="color:#6f42c1">append</span><span style="color:#24292e">(</span><span style="color:#032f62">"        redis.call('incrby', KEYS[1], -1);"</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">  lua.</span><span style="color:#6f42c1">append</span><span style="color:#24292e">(</span><span style="color:#032f62">"        return stock;"</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">  lua.</span><span style="color:#6f42c1">append</span><span style="color:#24292e">(</span><span style="color:#032f62">"    end;"</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">  lua.</span><span style="color:#6f42c1">append</span><span style="color:#24292e">(</span><span style="color:#032f62">"    return 0;"</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">  lua.</span><span style="color:#6f42c1">append</span><span style="color:#24292e">(</span><span style="color:#032f62">"end;"</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">  lua.</span><span style="color:#6f42c1">append</span><span style="color:#24292e">(</span><span style="color:#032f62">"return -1;"</span><span style="color:#24292e">);</span></span></code></pre></div><ul><li>该代码的主要流程如下：</li></ul><ol><li><p>先判断商品id是否存在，如果不存在则直接返回。</p></li><li><p>获取该商品id的库存，判断库存如果是-1，则直接返回，表示不限制库存。</p></li><li><p>如果库存大于0，则扣减库存。</p></li><li><p>如果库存等于0，是直接返回，表示库存不足。</p></li></ol><h3 id="_7-分布式锁" tabindex="-1">7 分布式锁 <a aria-current="page" href="/posts/flash%20killing#_7-分布式锁" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h3><ul><li><p>之前我提到过，在秒杀的时候，需要先从缓存中查商品是否存在，如果不存在，则会从数据库中查商品。如果数据库中有，则将该商品放入缓存中，然后返回。如果数据库中没有，则直接返回失败。</p></li><li><p>大家试想一下，如果在高并发下，有大量的请求都去查一个缓存中不存在的商品，这些请求都会直接打到数据库。数据库由于承受不住压力，而直接挂掉。</p></li><li><p>那么如何解决这个问题呢？</p><ul><li>这就需要用redis分布式锁了。</li></ul></li></ul><h4 id="_7-1-setnx加锁" tabindex="-1">7.1 setNx加锁 <a aria-current="page" href="/posts/flash%20killing#_7-1-setnx加锁" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h4><ul><li>使用redis的分布式锁，首先想到的是setNx命令。</li></ul><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (jedis.</span><span style="color:#b392f0">setnx</span><span style="color:#e1e4e8">(lockKey, val) </span><span style="color:#f97583">==</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">1</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">   jedis.</span><span style="color:#b392f0">expire</span><span style="color:#e1e4e8">(lockKey, timeout);</span></span>
<span class="line"><span style="color:#e1e4e8">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#d73a49">if</span><span style="color:#24292e"> (jedis.</span><span style="color:#6f42c1">setnx</span><span style="color:#24292e">(lockKey, val) </span><span style="color:#d73a49">==</span><span style="color:#24292e"> </span><span style="color:#005cc5">1</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">   jedis.</span><span style="color:#6f42c1">expire</span><span style="color:#24292e">(lockKey, timeout);</span></span>
<span class="line"><span style="color:#24292e">}</span></span></code></pre></div><ul><li><p>用该命令其实可以加锁，但和后面的设置超时时间是分开的，并非原子操作。</p></li><li><p>假如加锁成功了，但是设置超时时间失败了，该lockKey就变成永不失效的了。在高并发场景中，该问题会导致非常严重的后果。</p></li><li><p>那么，有没有保证原子性的加锁命令呢？</p></li></ul><h4 id="_7-2-set加锁" tabindex="-1">7.2 set加锁 <a aria-current="page" href="/posts/flash%20killing#_7-2-set加锁" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h4><ul><li>使用redis的set命令，它可以指定多个参数。</li></ul><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8">String result </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> jedis.</span><span style="color:#b392f0">set</span><span style="color:#e1e4e8">(lockKey, requestId, </span><span style="color:#9ecbff">"NX"</span><span style="color:#e1e4e8">, </span><span style="color:#9ecbff">"PX"</span><span style="color:#e1e4e8">, expireTime);</span></span>
<span class="line"><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (</span><span style="color:#9ecbff">"OK"</span><span style="color:#e1e4e8">.</span><span style="color:#b392f0">equals</span><span style="color:#e1e4e8">(result)) {</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">true</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">}</span></span>
<span class="line"><span style="color:#f97583">return</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">false</span><span style="color:#e1e4e8">;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e">String result </span><span style="color:#d73a49">=</span><span style="color:#24292e"> jedis.</span><span style="color:#6f42c1">set</span><span style="color:#24292e">(lockKey, requestId, </span><span style="color:#032f62">"NX"</span><span style="color:#24292e">, </span><span style="color:#032f62">"PX"</span><span style="color:#24292e">, expireTime);</span></span>
<span class="line"><span style="color:#d73a49">if</span><span style="color:#24292e"> (</span><span style="color:#032f62">"OK"</span><span style="color:#24292e">.</span><span style="color:#6f42c1">equals</span><span style="color:#24292e">(result)) {</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">return</span><span style="color:#24292e"> </span><span style="color:#005cc5">true</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">}</span></span>
<span class="line"><span style="color:#d73a49">return</span><span style="color:#24292e"> </span><span style="color:#005cc5">false</span><span style="color:#24292e">;</span></span></code></pre></div><p>其中：</p><ul><li><p>lockKey：锁的标识</p></li><li><p>requestId：请求id</p></li><li><p>NX：只在键不存在时，才对键进行设置操作。</p></li><li><p>PX：设置键的过期时间为 millisecond 毫秒。</p></li><li><p>expireTime：过期时间 由于该命令只有一步，所以它是原子操作。</p></li></ul><h4 id="_7-3-释放锁" tabindex="-1">7.3 释放锁 <a aria-current="page" href="/posts/flash%20killing#_7-3-释放锁" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h4><ul><li><p>接下来，有些朋友可能会问：在加锁时，既然已经有了lockKey锁标识，为什么要需要记录requestId呢？</p><ul><li>答：requestId是在释放锁的时候用的。</li></ul></li><li><p>在释放锁的时候，只能释放自己加的锁，不允许释放别人加的锁。</p></li><li><p>这里为什么要用requestId，用userId不行吗？</p><ul><li>答：如果用userId的话，假设本次请求流程走完了，准备删除锁。此时，巧合锁到了过期时间失效了。而另外一个请求，巧合使用的相同userId加锁，会成功。而本次请求删除锁的时候，删除的其实是别人的锁了。</li></ul></li><li><p>当然使用lua脚本也能避免该问题：</p></li></ul><div class="language-shell"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#f97583">if</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">redis.call(</span><span style="color:#b392f0">'get'</span><span style="color:#b392f0">,</span><span style="color:#e1e4e8"> </span><span style="color:#9ecbff">KEYS[</span><span style="color:#79b8ff">1</span><span style="color:#9ecbff">]</span><span style="color:#e1e4e8">) == ARGV[</span><span style="color:#79b8ff">1</span><span style="color:#e1e4e8">] </span><span style="color:#f97583">then</span><span style="color:#e1e4e8"> </span></span>
<span class="line"><span style="color:#e1e4e8"> </span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> </span><span style="color:#9ecbff">redis.call</span><span style="color:#e1e4e8">(</span><span style="color:#b392f0">'del'</span><span style="color:#b392f0">,</span><span style="color:#e1e4e8"> </span><span style="color:#9ecbff">KEYS[</span><span style="color:#79b8ff">1</span><span style="color:#9ecbff">]</span><span style="color:#e1e4e8">) </span></span>
<span class="line"><span style="color:#f97583">else</span><span style="color:#e1e4e8"> </span></span>
<span class="line"><span style="color:#e1e4e8">  </span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8"> </span></span>
<span class="line"><span style="color:#f97583">end</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#d73a49">if</span><span style="color:#24292e"> </span><span style="color:#6f42c1">redis.call(</span><span style="color:#6f42c1">'get'</span><span style="color:#6f42c1">,</span><span style="color:#24292e"> </span><span style="color:#032f62">KEYS[</span><span style="color:#005cc5">1</span><span style="color:#032f62">]</span><span style="color:#24292e">) == ARGV[</span><span style="color:#005cc5">1</span><span style="color:#24292e">] </span><span style="color:#d73a49">then</span><span style="color:#24292e"> </span></span>
<span class="line"><span style="color:#24292e"> </span><span style="color:#d73a49">return</span><span style="color:#24292e"> </span><span style="color:#032f62">redis.call</span><span style="color:#24292e">(</span><span style="color:#6f42c1">'del'</span><span style="color:#6f42c1">,</span><span style="color:#24292e"> </span><span style="color:#032f62">KEYS[</span><span style="color:#005cc5">1</span><span style="color:#032f62">]</span><span style="color:#24292e">) </span></span>
<span class="line"><span style="color:#d73a49">else</span><span style="color:#24292e"> </span></span>
<span class="line"><span style="color:#24292e">  </span><span style="color:#d73a49">return</span><span style="color:#24292e"> </span><span style="color:#005cc5">0</span><span style="color:#24292e"> </span></span>
<span class="line"><span style="color:#d73a49">end</span></span></code></pre></div><blockquote><p>它能保证查询锁是否存在和删除锁是原子操作。</p></blockquote><h4 id="_7-4-自旋锁" tabindex="-1">7.4 自旋锁 <a aria-current="page" href="/posts/flash%20killing#_7-4-自旋锁" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h4><ul><li><p>上面的加锁方法看起来好像没有问题，但如果你仔细想想，如果有1万的请求同时去竞争那把锁，可能只有一个请求是成功的，其余的9999个请求都会失败。</p></li><li><p>在秒杀场景下，会有什么问题？</p><ul><li>答：每1万个请求，有1个成功。再1万个请求，有1个成功。如此下去，直到库存不足。这就变成均匀分布的秒杀了，跟我们想象中的不一样。</li></ul></li><li><p>如何解决这个问题呢？</p><ul><li>答：使用自旋锁。</li></ul></li></ul><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#f97583">try</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">  Long start </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> System.</span><span style="color:#b392f0">currentTimeMillis</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">  </span><span style="color:#f97583">while</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">true</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">      String result </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> jedis.</span><span style="color:#b392f0">set</span><span style="color:#e1e4e8">(lockKey, requestId, </span><span style="color:#9ecbff">"NX"</span><span style="color:#e1e4e8">, </span><span style="color:#9ecbff">"PX"</span><span style="color:#e1e4e8">, expireTime);</span></span>
<span class="line"><span style="color:#e1e4e8">     </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (</span><span style="color:#9ecbff">"OK"</span><span style="color:#e1e4e8">.</span><span style="color:#b392f0">equals</span><span style="color:#e1e4e8">(result)) {</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">true</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">     }</span></span>
<span class="line"><span style="color:#e1e4e8">     </span></span>
<span class="line"><span style="color:#e1e4e8">     </span><span style="color:#f97583">long</span><span style="color:#e1e4e8"> time </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> System.</span><span style="color:#b392f0">currentTimeMillis</span><span style="color:#e1e4e8">() </span><span style="color:#f97583">-</span><span style="color:#e1e4e8"> start;</span></span>
<span class="line"><span style="color:#e1e4e8">      </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (time</span><span style="color:#f97583">&gt;=</span><span style="color:#e1e4e8">timeout) {</span></span>
<span class="line"><span style="color:#e1e4e8">          </span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">false</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">      }</span></span>
<span class="line"><span style="color:#e1e4e8">      </span><span style="color:#f97583">try</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">          Thread.</span><span style="color:#b392f0">sleep</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">50</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">      } </span><span style="color:#f97583">catch</span><span style="color:#e1e4e8"> (InterruptedException </span><span style="color:#ffab70">e</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">          e.</span><span style="color:#b392f0">printStackTrace</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">      }</span></span>
<span class="line"><span style="color:#e1e4e8">  }</span></span>
<span class="line"><span style="color:#e1e4e8">} </span><span style="color:#f97583">finally</span><span style="color:#e1e4e8">{</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#b392f0">unlock</span><span style="color:#e1e4e8">(lockKey,requestId);</span></span>
<span class="line"><span style="color:#e1e4e8">}  </span></span>
<span class="line"><span style="color:#f97583">return</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">false</span><span style="color:#e1e4e8">;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#d73a49">try</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">  Long start </span><span style="color:#d73a49">=</span><span style="color:#24292e"> System.</span><span style="color:#6f42c1">currentTimeMillis</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">  </span><span style="color:#d73a49">while</span><span style="color:#24292e">(</span><span style="color:#005cc5">true</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">      String result </span><span style="color:#d73a49">=</span><span style="color:#24292e"> jedis.</span><span style="color:#6f42c1">set</span><span style="color:#24292e">(lockKey, requestId, </span><span style="color:#032f62">"NX"</span><span style="color:#24292e">, </span><span style="color:#032f62">"PX"</span><span style="color:#24292e">, expireTime);</span></span>
<span class="line"><span style="color:#24292e">     </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (</span><span style="color:#032f62">"OK"</span><span style="color:#24292e">.</span><span style="color:#6f42c1">equals</span><span style="color:#24292e">(result)) {</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">return</span><span style="color:#24292e"> </span><span style="color:#005cc5">true</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">     }</span></span>
<span class="line"><span style="color:#24292e">     </span></span>
<span class="line"><span style="color:#24292e">     </span><span style="color:#d73a49">long</span><span style="color:#24292e"> time </span><span style="color:#d73a49">=</span><span style="color:#24292e"> System.</span><span style="color:#6f42c1">currentTimeMillis</span><span style="color:#24292e">() </span><span style="color:#d73a49">-</span><span style="color:#24292e"> start;</span></span>
<span class="line"><span style="color:#24292e">      </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (time</span><span style="color:#d73a49">&gt;=</span><span style="color:#24292e">timeout) {</span></span>
<span class="line"><span style="color:#24292e">          </span><span style="color:#d73a49">return</span><span style="color:#24292e"> </span><span style="color:#005cc5">false</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">      }</span></span>
<span class="line"><span style="color:#24292e">      </span><span style="color:#d73a49">try</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">          Thread.</span><span style="color:#6f42c1">sleep</span><span style="color:#24292e">(</span><span style="color:#005cc5">50</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">      } </span><span style="color:#d73a49">catch</span><span style="color:#24292e"> (InterruptedException </span><span style="color:#e36209">e</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">          e.</span><span style="color:#6f42c1">printStackTrace</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">      }</span></span>
<span class="line"><span style="color:#24292e">  }</span></span>
<span class="line"><span style="color:#24292e">} </span><span style="color:#d73a49">finally</span><span style="color:#24292e">{</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6f42c1">unlock</span><span style="color:#24292e">(lockKey,requestId);</span></span>
<span class="line"><span style="color:#24292e">}  </span></span>
<span class="line"><span style="color:#d73a49">return</span><span style="color:#24292e"> </span><span style="color:#005cc5">false</span><span style="color:#24292e">;</span></span></code></pre></div><blockquote><p>在规定的时间，比如500毫秒内，自旋不断尝试加锁，如果成功则直接返回。如果失败，则休眠50毫秒，再发起新一轮的尝试。如果到了超时时间，还未加锁成功，则直接返回失败。</p></blockquote><h4 id="_7-5-redisson" tabindex="-1">7.5 redisson <a aria-current="page" href="/posts/flash%20killing#_7-5-redisson" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h4><ul><li><p>除了上面的问题之外，使用redis分布式锁，还有锁竞争问题、续期问题、锁重入问题、多个redis实例加锁问题等。</p></li><li><p><a target="_blank" rel="noreferrer" href="https://imlklaus.github.io/posts/%E7%BC%93%E5%AD%98+%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81%E5%9C%A8java%E9%A1%B9%E7%9B%AE%E4%B8%AD%E7%9A%84%E5%BA%94%E7%94%A8#_3%E3%80%81redisson-%E5%AE%8C%E6%88%90%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81"><!--[-->Redisson分布式锁的使用<!--]--><!----></a></p></li></ul><h3 id="_8-mq异步处理" tabindex="-1">8 mq异步处理 <a aria-current="page" href="/posts/flash%20killing#_8-mq异步处理" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h3><ul><li>我们都知道在真实的秒杀场景中，有三个核心流程：</li></ul><figure><img src="https://jsd.cdn.zzko.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230429164405754.png" alt="image-20230429164405754" loading="lazy" decoding="async"></figure><ul><li><p>而这三个核心流程中，真正并发量大的是秒杀功能，下单和支付功能实际并发量很小。所以，我们在设计秒杀系统时，有必要把下单和支付功能从秒杀的主流程中拆分出来，特别是下单功能要做成mq异步处理的。而支付功能，比如支付宝支付，是业务场景本身保证的异步。</p></li><li><p>于是，秒杀后下单的流程变成如下：</p></li></ul><figure><img src="https://jsd.cdn.zzko.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230429164509701.png" alt="image-20230429164509701" loading="lazy" decoding="async"></figure><ul><li>如果使用mq，需要关注以下几个问题：</li></ul><h4 id="_8-1-消息丢失问题" tabindex="-1">8.1 消息丢失问题 <a aria-current="page" href="/posts/flash%20killing#_8-1-消息丢失问题" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h4><ul><li><p>秒杀成功了，往mq发送下单消息的时候，有可能会失败。原因有很多，比如：网络问题、broker挂了、mq服务端磁盘问题等。这些情况，都可能会造成消息丢失。</p></li><li><p>那么，如何防止消息丢失呢？</p><ul><li>答：加一张消息发送表。</li></ul></li></ul><figure><img src="https://jsd.cdn.zzko.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230429164617994.png" alt="image-20230429164617994" loading="lazy" decoding="async"></figure><ul><li><p>在生产者发送mq消息之前，先把该条消息写入消息发送表，初始状态是待处理，然后再发送mq消息。消费者消费消息时，处理完业务逻辑之后，再回调生产者的一个接口，修改消息状态为已处理。</p></li><li><p>如果生产者把消息写入消息发送表之后，再发送mq消息到mq服务端的过程中失败了，造成了消息丢失。</p></li><li><p>这时候，要如何处理呢？</p><ul><li>答：使用job，增加重试机制。</li></ul></li></ul><figure><img src="https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230429164724585.png" alt="image-20230429164724585" loading="lazy" decoding="async"></figure><blockquote><p>用job每隔一段时间去查询消息发送表中状态为待处理的数据，然后重新发送mq消息。</p></blockquote><h4 id="_8-2-重复消费问题" tabindex="-1">8.2 重复消费问题 <a aria-current="page" href="/posts/flash%20killing#_8-2-重复消费问题" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h4><ul><li><p>本来消费者消费消息时，在ack应答的时候，如果网络超时，本身就可能会消费重复的消息。但由于消息发送者增加了重试机制，会导致消费者重复消息的概率增大。</p></li><li><p>那么，如何解决重复消息问题呢？</p><ul><li>答：加一张消息处理表。</li></ul></li></ul><figure><img src="https://jsd.cdn.zzko.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230429164817906.png" alt="image-20230429164817906" loading="lazy" decoding="async"></figure><blockquote><ul><li><p>消费者读到消息之后，先判断一下消息处理表，是否存在该消息，如果存在，表示是重复消费，则直接返回。如果不存在，则进行下单操作，接着将该消息写入消息处理表中，再返回。</p></li><li><p>有个比较关键的点是：下单和写消息处理表，要放在同一个事务中，保证原子操作。</p></li></ul></blockquote><h4 id="_8-3-垃圾消息问题" tabindex="-1">8.3 垃圾消息问题 <a aria-current="page" href="/posts/flash%20killing#_8-3-垃圾消息问题" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h4><ul><li><p>这套方案表面上看起来没有问题，但如果出现了消息消费失败的情况。比如：由于某些原因，消息消费者下单一直失败，一直不能回调状态变更接口，这样job会不停的重试发消息。最后，会产生大量的垃圾消息。</p></li><li><p>那么，如何解决这个问题呢？</p></li></ul><figure><img src="https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230429164937078.png" alt="image-20230429164937078" loading="lazy" decoding="async"></figure><blockquote><ul><li><p>每次在job重试时，需要先判断一下消息发送表中该消息的发送次数是否达到最大限制，如果达到了，则直接返回。如果没有达到，则将次数加1，然后发送消息。</p></li><li><p>这样如果出现异常，只会产生少量的垃圾消息，不会影响到正常的业务。</p></li></ul></blockquote><h4 id="_8-4-延迟消费问题" tabindex="-1">8.4 延迟消费问题 <a aria-current="page" href="/posts/flash%20killing#_8-4-延迟消费问题" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h4><ul><li><p>通常情况下，如果用户秒杀成功了，下单之后，在15分钟之内还未完成支付的话，该订单会被自动取消，回退库存。</p></li><li><p>那么，在15分钟内未完成支付，订单被自动取消的功能，要如何实现呢？</p><ul><li><p>我们首先想到的可能是job，因为它比较简单。</p></li><li><p>但job有个问题，需要每隔一段时间处理一次，实时性不太好。</p></li></ul></li><li><p>还有更好的方案？</p><ul><li>答：使用延迟队列。</li></ul></li><li><p>我们都知道rocketmq，自带了延迟队列的功能。</p></li></ul><figure><img src="https://jsd.cdn.zzko.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230429165104965.png" alt="image-20230429165104965" loading="lazy" decoding="async"></figure><ul><li><p>下单时消息生产者会先生成订单，此时状态为待支付，然后会向延迟队列中发一条消息。达到了延迟时间，消息消费者读取消息之后，会查询该订单的状态是否为待支付。如果是待支付状态，则会更新订单状态为取消状态。如果不是待支付状态，说明该订单已经支付过了，则直接返回。</p></li><li><p>还有个关键点，用户完成支付之后，会修改订单状态为已支付。</p></li></ul><figure><img src="https://jsd.cdn.zzko.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230429165137323.png" alt="image-20230429165137323" loading="lazy" decoding="async"></figure><h3 id="_9-如何限流" tabindex="-1">9 如何限流？ <a aria-current="page" href="/posts/flash%20killing#_9-如何限流" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h3><ul><li><p>通过秒杀活动，如果我们运气爆棚，可能会用非常低的价格买到不错的商品（这种概率堪比买福利彩票中大奖）。</p></li><li><p>但有些高手，并不会像我们一样老老实实，通过秒杀页面点击秒杀按钮，抢购商品。他们可能在自己的服务器上，模拟正常用户登录系统，跳过秒杀页面，直接调用秒杀接口。</p></li><li><p>如果是我们手动操作，一般情况下，一秒钟只能点击一次秒杀按钮。</p></li></ul><figure><img src="https://jsd.cdn.zzko.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230429165212649.png" alt="image-20230429165212649" loading="lazy" decoding="async"></figure><ul><li>但是如果是服务器，一秒钟可以请求成上千接口。</li></ul><figure><img src="https://jsd.cdn.zzko.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230429165302898.png" alt="image-20230429165302898" loading="lazy" decoding="async"></figure><blockquote><ul><li><p>这种差距实在太明显了，如果不做任何限制，绝大部分商品可能是被机器抢到，而非正常的用户，有点不太公平。</p></li><li><p>所以，我们有必要识别这些非法请求，做一些限制。那么，我们该如何现在这些非法请求呢？</p></li><li><p>目前有两种常用的限流方式：</p><ul><li>1基于nginx限流</li><li>2基于redis限流</li></ul></li></ul></blockquote><h4 id="_9-1-对同一用户限流" tabindex="-1">9.1 对同一用户限流 <a aria-current="page" href="/posts/flash%20killing#_9-1-对同一用户限流" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h4><ul><li>为了防止某个用户，请求接口次数过于频繁，可以只针对该用户做限制。</li></ul><figure><img src="https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230429165408344.png" alt="image-20230429165408344" loading="lazy" decoding="async"></figure><blockquote><p>限制同一个用户id，比如每分钟只能请求5次接口。</p></blockquote><h4 id="_9-2-对同一ip限流" tabindex="-1">9.2 对同一ip限流 <a aria-current="page" href="/posts/flash%20killing#_9-2-对同一ip限流" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h4><ul><li><p>有时候只对某个用户限流是不够的，有些高手可以模拟多个用户请求，这种nginx就没法识别了。</p></li><li><p>这时需要加同一ip限流功能。</p></li></ul><figure><img src="https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230429165439488.png" alt="image-20230429165439488" loading="lazy" decoding="async"></figure><blockquote><ul><li><p>限制同一个ip，比如每分钟只能请求5次接口。</p></li><li><p>但这种限流方式可能会有误杀的情况，比如同一个公司或网吧的出口ip是相同的，如果里面有多个正常用户同时发起请求，有些用户可能会被限制住。</p></li></ul></blockquote><h4 id="_9-3-对接口限流" tabindex="-1">9.3 对接口限流 <a aria-current="page" href="/posts/flash%20killing#_9-3-对接口限流" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h4><ul><li><p>别以为限制了用户和ip就万事大吉，有些高手甚至可以使用代理，每次都请求都换一个ip。</p></li><li><p>这时可以限制请求的接口总次数。</p></li></ul><figure><img src="https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230429165519105.png" alt="image-20230429165519105" loading="lazy" decoding="async"></figure><blockquote><p>在高并发场景下，这种限制对于系统的稳定性是非常有必要的。但可能由于有些非法请求次数太多，达到了该接口的请求上限，而影响其他的正常用户访问该接口。看起来有点得不偿失。</p></blockquote><h4 id="_9-4-加验证码" tabindex="-1">9.4 加验证码 <a aria-current="page" href="/posts/flash%20killing#_9-4-加验证码" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h4><ul><li>相对于上面三种方式，加验证码的方式可能更精准一些，同样能限制用户的访问频次，但好处是不会存在误杀的情况。</li></ul><figure><img src="https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230429165554440.png" alt="image-20230429165554440" loading="lazy" decoding="async"></figure><blockquote><ul><li><p>通常情况下，用户在请求之前，需要先输入验证码。用户发起请求之后，服务端会去校验该验证码是否正确。只有正确才允许进行下一步操作，否则直接返回，并且提示验证码错误。</p></li><li><p>此外，验证码一般是一次性的，同一个验证码只允许使用一次，不允许重复使用。</p></li><li><p>普通验证码，由于生成的数字或者图案比较简单，可能会被破解。优点是生成速度比较快，缺点是有安全隐患。</p></li><li><p>还有一个验证码叫做：移动滑块，它生成速度比较慢，但比较安全，是目前各大互联网公司的首选。</p></li></ul></blockquote><h4 id="_9-5-提高业务门槛" tabindex="-1">9.5 提高业务门槛 <a aria-current="page" href="/posts/flash%20killing#_9-5-提高业务门槛" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h4><blockquote><ul><li><p>上面说的加验证码虽然可以限制非法用户请求，但是有些影响用户体验。用户点击秒杀按钮前，还要先输入验证码，流程显得有点繁琐，秒杀功能的流程不是应该越简单越好吗？</p></li><li><p>其实，有时候达到某个目的，不一定非要通过技术手段，通过业务手段也一样。</p></li><li><p>12306刚开始的时候，全国人民都在同一时刻抢火车票，由于并发量太大，系统经常挂。后来，重构优化之后，将购买周期放长了，可以提前20天购买火车票，并且可以在9点、10、11点、12点等整点购买火车票。调整业务之后（当然技术也有很多调整），将之前集中的请求，分散开了，一下子降低了用户并发量。</p></li><li><p>回到这里，我们通过提高业务门槛，比如只有会员才能参与秒杀活动，普通注册用户没有权限。或者，只有等级到达3级以上的普通用户，才有资格参加该活动。</p></li><li><p>这样简单的提高一点门槛，即使是黄牛党也束手无策，他们总不可能为了参加一次秒杀活动，还另外花钱充值会员吧？</p></li></ul></blockquote><h2 id="秒杀系统项目实战" tabindex="-1">秒杀系统项目实战 <a aria-current="page" href="/posts/flash%20killing#秒杀系统项目实战" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h2><h3 id="_1-秒杀业务概要" tabindex="-1">1 秒杀业务概要 <a aria-current="page" href="/posts/flash%20killing#_1-秒杀业务概要" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h3><ul><li><p>秒杀具有瞬间高并发的特点，针对这一特点，必须要做到限流 + 异步 + 缓存（页面静态化） + 独立部署</p></li><li><p>限流方式：</p><ol><li>前端限流，一些高并发的网站直接在前端页面开始限流，列如：小米的验证码</li><li>nginx限流，直接负载部分请求到错误的静态页面，令牌算法、漏斗算法</li><li>网关限流、限流的过滤器</li><li>代码中使用分布式信号量</li><li>rabbitmq限流（能者多劳 channel.basicQos(1)）保证发挥服务器的所用性能</li></ol></li><li><p>秒杀架构图</p></li></ul><figure><img src="https://jsd.cdn.zzko.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230429224850779.png" alt="image-20230429224850779" loading="lazy" decoding="async"></figure><h3 id="_2-秒杀流程" tabindex="-1">2 秒杀流程 <a aria-current="page" href="/posts/flash%20killing#_2-秒杀流程" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h3><ul><li><p>参考京东秒杀流程</p></li><li><p>见秒杀流程图</p></li><li><p><strong>秒杀方式一</strong></p></li></ul><figure><img src="https://jsd.cdn.zzko.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230430003804352.png" alt="image-20230430003804352" loading="lazy" decoding="async"></figure><ul><li><strong>秒杀方式二</strong></li></ul><figure><img src="https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230430003907398.png" alt="image-20230430003907398" loading="lazy" decoding="async"></figure><h3 id="_3-秒杀核心业务" tabindex="-1">3 秒杀核心业务 <a aria-current="page" href="/posts/flash%20killing#_3-秒杀核心业务" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h3><h4 id="_3-1-后台添加秒杀商品" tabindex="-1">3.1 后台添加秒杀商品 <a aria-current="page" href="/posts/flash%20killing#_3-1-后台添加秒杀商品" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h4><figure><img src="https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230430133519183.png" alt="image-20230430133519183" loading="lazy" decoding="async"></figure><ul><li>关联商品</li></ul><figure><img src="https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230430133622474.png" alt="image-20230430133622474" loading="lazy" decoding="async"></figure><ul><li>分页查询关联商品</li></ul><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8">@</span><span style="color:#f97583">Service</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"seckillSkuRelationService"</span><span style="color:#e1e4e8">)</span></span>
<span class="line"><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">class</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">SeckillSkuRelationServiceImpl</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">extends</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">ServiceImpl</span><span style="color:#e1e4e8">&lt;</span><span style="color:#f97583">SeckillSkuRelationDao</span><span style="color:#e1e4e8">, </span><span style="color:#f97583">SeckillSkuRelationEntity</span><span style="color:#e1e4e8">&gt; </span><span style="color:#f97583">implements</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">SeckillSkuRelationService</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">    @</span><span style="color:#f97583">Override</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">public</span><span style="color:#e1e4e8"> PageUtils </span><span style="color:#b392f0">queryPage</span><span style="color:#e1e4e8">(Map&lt;</span><span style="color:#f97583">String</span><span style="color:#e1e4e8">, </span><span style="color:#f97583">Object</span><span style="color:#e1e4e8">&gt; </span><span style="color:#ffab70">params</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">        QueryWrapper&lt;</span><span style="color:#f97583">SeckillSkuRelationEntity</span><span style="color:#e1e4e8">&gt; queryWrapper </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> QueryWrapper&lt;</span><span style="color:#f97583">SeckillSkuRelationEntity</span><span style="color:#e1e4e8">&gt;();</span></span>
<span class="line"><span style="color:#e1e4e8">        String promotionSessionId </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> (String) params.</span><span style="color:#b392f0">get</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"promotionSessionId"</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">        String key </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> (String) params.</span><span style="color:#b392f0">get</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"key"</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (</span><span style="color:#f97583">!</span><span style="color:#e1e4e8">StringUtils.</span><span style="color:#b392f0">isEmpty</span><span style="color:#e1e4e8">(key)){</span></span>
<span class="line"><span style="color:#e1e4e8">            queryWrapper.</span><span style="color:#b392f0">eq</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"sku_id"</span><span style="color:#e1e4e8">, key).</span><span style="color:#b392f0">or</span><span style="color:#e1e4e8">().</span><span style="color:#b392f0">eq</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"seckill_price"</span><span style="color:#e1e4e8">, key);</span></span>
<span class="line"><span style="color:#e1e4e8">        }</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (</span><span style="color:#f97583">!</span><span style="color:#e1e4e8">StringUtils.</span><span style="color:#b392f0">isEmpty</span><span style="color:#e1e4e8">(promotionSessionId)){</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#6a737d">//根据场次id进行查询</span></span>
<span class="line"><span style="color:#e1e4e8">            queryWrapper.</span><span style="color:#b392f0">eq</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"promotion_session_id"</span><span style="color:#e1e4e8">, promotionSessionId);</span></span>
<span class="line"><span style="color:#e1e4e8">        }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">        IPage&lt;</span><span style="color:#f97583">SeckillSkuRelationEntity</span><span style="color:#e1e4e8">&gt; page </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">this</span><span style="color:#e1e4e8">.</span><span style="color:#b392f0">page</span><span style="color:#e1e4e8">(</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> Query&lt;</span><span style="color:#f97583">SeckillSkuRelationEntity</span><span style="color:#e1e4e8">&gt;().</span><span style="color:#b392f0">getPage</span><span style="color:#e1e4e8">(params),</span></span>
<span class="line"><span style="color:#e1e4e8">                queryWrapper</span></span>
<span class="line"><span style="color:#e1e4e8">        );</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">PageUtils</span><span style="color:#e1e4e8">(page);</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e">@</span><span style="color:#d73a49">Service</span><span style="color:#24292e">(</span><span style="color:#032f62">"seckillSkuRelationService"</span><span style="color:#24292e">)</span></span>
<span class="line"><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">class</span><span style="color:#24292e"> </span><span style="color:#6f42c1">SeckillSkuRelationServiceImpl</span><span style="color:#24292e"> </span><span style="color:#d73a49">extends</span><span style="color:#24292e"> </span><span style="color:#6f42c1">ServiceImpl</span><span style="color:#24292e">&lt;</span><span style="color:#d73a49">SeckillSkuRelationDao</span><span style="color:#24292e">, </span><span style="color:#d73a49">SeckillSkuRelationEntity</span><span style="color:#24292e">&gt; </span><span style="color:#d73a49">implements</span><span style="color:#24292e"> </span><span style="color:#6f42c1">SeckillSkuRelationService</span><span style="color:#24292e"> {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">    @</span><span style="color:#d73a49">Override</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">public</span><span style="color:#24292e"> PageUtils </span><span style="color:#6f42c1">queryPage</span><span style="color:#24292e">(Map&lt;</span><span style="color:#d73a49">String</span><span style="color:#24292e">, </span><span style="color:#d73a49">Object</span><span style="color:#24292e">&gt; </span><span style="color:#e36209">params</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">        QueryWrapper&lt;</span><span style="color:#d73a49">SeckillSkuRelationEntity</span><span style="color:#24292e">&gt; queryWrapper </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> QueryWrapper&lt;</span><span style="color:#d73a49">SeckillSkuRelationEntity</span><span style="color:#24292e">&gt;();</span></span>
<span class="line"><span style="color:#24292e">        String promotionSessionId </span><span style="color:#d73a49">=</span><span style="color:#24292e"> (String) params.</span><span style="color:#6f42c1">get</span><span style="color:#24292e">(</span><span style="color:#032f62">"promotionSessionId"</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">        String key </span><span style="color:#d73a49">=</span><span style="color:#24292e"> (String) params.</span><span style="color:#6f42c1">get</span><span style="color:#24292e">(</span><span style="color:#032f62">"key"</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (</span><span style="color:#d73a49">!</span><span style="color:#24292e">StringUtils.</span><span style="color:#6f42c1">isEmpty</span><span style="color:#24292e">(key)){</span></span>
<span class="line"><span style="color:#24292e">            queryWrapper.</span><span style="color:#6f42c1">eq</span><span style="color:#24292e">(</span><span style="color:#032f62">"sku_id"</span><span style="color:#24292e">, key).</span><span style="color:#6f42c1">or</span><span style="color:#24292e">().</span><span style="color:#6f42c1">eq</span><span style="color:#24292e">(</span><span style="color:#032f62">"seckill_price"</span><span style="color:#24292e">, key);</span></span>
<span class="line"><span style="color:#24292e">        }</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (</span><span style="color:#d73a49">!</span><span style="color:#24292e">StringUtils.</span><span style="color:#6f42c1">isEmpty</span><span style="color:#24292e">(promotionSessionId)){</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#6a737d">//根据场次id进行查询</span></span>
<span class="line"><span style="color:#24292e">            queryWrapper.</span><span style="color:#6f42c1">eq</span><span style="color:#24292e">(</span><span style="color:#032f62">"promotion_session_id"</span><span style="color:#24292e">, promotionSessionId);</span></span>
<span class="line"><span style="color:#24292e">        }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">        IPage&lt;</span><span style="color:#d73a49">SeckillSkuRelationEntity</span><span style="color:#24292e">&gt; page </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#005cc5">this</span><span style="color:#24292e">.</span><span style="color:#6f42c1">page</span><span style="color:#24292e">(</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#d73a49">new</span><span style="color:#24292e"> Query&lt;</span><span style="color:#d73a49">SeckillSkuRelationEntity</span><span style="color:#24292e">&gt;().</span><span style="color:#6f42c1">getPage</span><span style="color:#24292e">(params),</span></span>
<span class="line"><span style="color:#24292e">                queryWrapper</span></span>
<span class="line"><span style="color:#24292e">        );</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">return</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">PageUtils</span><span style="color:#24292e">(page);</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">}</span></span></code></pre></div><figure><img src="https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230430134014948.png" alt="image-20230430134014948" loading="lazy" decoding="async"></figure><figure><img src="https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230430134032296.png" alt="image-20230430134032296" loading="lazy" decoding="async"></figure><figure><img src="https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230430134056247.png" alt="image-20230430134056247" loading="lazy" decoding="async"></figure><figure><img src="https://jsd.cdn.zzko.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230430134613785.png" alt="image-20230430134613785" loading="lazy" decoding="async"></figure><figure><img src="https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230430134650173.png" alt="image-20230430134650173" loading="lazy" decoding="async"></figure><h4 id="定时任务" tabindex="-1">定时任务 <a aria-current="page" href="/posts/flash%20killing#定时任务" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h4><h5 id="_1-cron表达式" tabindex="-1">1.cron表达式 <a aria-current="page" href="/posts/flash%20killing#_1-cron表达式" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h5><p>语法：秒 分 时 日 月 周 年（Spring不支持）</p><p><a target="_blank" rel="noreferrer" href="http://www.quartz-scheduler.org/documentation/quartz-2.3.0/tutorials/crontrigger.html"><!--[-->http://www.quartz-scheduler.org/documentation/quartz-2.3.0/tutorials/crontrigger.html<!--]--><!----></a></p><figure><img src="https://jsd.cdn.zzko.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230430135420949.png" alt="image-20230430135420949" loading="lazy" decoding="async"></figure><p>特殊字符：</p><ul><li><em>（ “所有值”）-用于选择字段中的所有值。例如，分钟字段中的“ ”表示“每分钟”</em>。</li><li>？（ “无特定值”）-当您需要在允许使用字符的两个字段之一中指定某个内容而在另一个不允许的字段中指定某些内容时很有用。例如，如果我希望在某个月的某个特定日期（例如，第10天）触发触发器，但不在乎一周中的哪一天发生，则将“ 10”设置为月字段，以及“？” 在“星期几”字段中。请参阅下面的示例以进行澄清。</li><li>--用于指定范围。例如，小时字段中的“ 10-12”表示“小时10、11和12”。</li><li>， -用于指定其他值。例如，“星期几”字段中的“ MON，WED，FRI”表示“星期一，星期三和星期五的日子”。</li><li>/ -用于指定增量。例如，秒字段中的“ 0/15”表示“秒0、15、30和45”。秒字段中的“ 5/15”表示“秒5、20、35和50”。您还可以在“ ”字符后指定“ /” -在这种情况下，“ ”等效于在“ /”之前使用“ 0”。每月日期字段中的“ 1/3”表示“从该月的第一天开始每三天触发一次”。</li><li>L（ “最后一个”）-在允许使用的两个字段中都有不同的含义。例如，“月”字段中的值“ L”表示“月的最后一天”，即非January年的1月31日，2月28日。如果单独用于星期几字段，则仅表示“ 7”或“ SAT”。但是，如果在星期几字段中使用另一个值，则表示“该月的最后xxx天”，例如“ 6L”表示“该月的最后一个星期五”。您还可以指定与该月最后一天的偏移量，例如“ L-3”，这表示日历月的倒数第三天。 使用“ L”选项时，不要指定列表或值的范围很重要，因为这样会导致混淆/意外结果。</li><li>W（ “工作日”）-用于指定最接近给定日期的工作日（星期一至星期五）。例如，如果您要指定“ 15W”作为“月日”字段的值，则含义是： “离月15日最近的工作日”。因此，如果15号是星期六，则触发器将在14号星期五触发。如果15日是星期日，则触发器将在16日星期一触发。如果15号是星期二，那么它将在15号星期二触发。但是，如果您将“ 1W”指定为月份的值，并且第一个是星期六，则触发器将在第3个星期一触发，因为它不会“跳过”一个月日的边界。仅当月份中的某天是一天，而不是范围或天数列表时，才可以指定“ W”字符。</li></ul><blockquote><p>“ L”和“ W”字符也可以在“月日”字段中组合以产生“ LW”，这表示“每月的最后一个工作日” 。</p></blockquote><ul><li>＃ -用于指定每月的第“ XXX”天。例如，“星期几”字段中的值“ 6＃3”表示“该月的第三个星期五”（第6天=星期五，“＃3” =该月的第三个星期五）。其他示例：“ 2＃1” =该月的第一个星期一，“ 4＃5” =该月的第五个星期三。请注意，如果您指定“＃5”，并且该月的指定星期几中没有5个，则该月将不会触发。</li></ul><blockquote><p>法定字符以及月份和星期几的名称不区分大小写。MON 与mon相同。</p></blockquote><h5 id="_2-cron-示例" tabindex="-1">2.cron 示例 <a aria-current="page" href="/posts/flash%20killing#_2-cron-示例" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h5><table><thead><tr><th><strong>Expression</strong></th><th><strong>Meaning</strong></th></tr></thead><tbody><tr><td><code>0 0 12 * * ?</code></td><td>Fire at 12pm (noon) every day</td></tr><tr><td><code>0 15 10 ? * *</code></td><td>Fire at 10:15am every day</td></tr><tr><td><code>0 15 10 * * ?</code></td><td>Fire at 10:15am every day</td></tr><tr><td><code>0 15 10 * * ? *</code></td><td>Fire at 10:15am every day</td></tr><tr><td><code>0 15 10 * * ? 2005</code></td><td>Fire at 10:15am every day during the year 2005</td></tr><tr><td><code>0 * 14 * * ?</code></td><td>Fire every minute starting at 2pm and ending at 2:59pm, every day</td></tr><tr><td><code>0 0/5 14 * * ?</code></td><td>Fire every 5 minutes starting at 2pm and ending at 2:55pm, every day</td></tr><tr><td><code>0 0/5 14,18 * * ?</code></td><td>Fire every 5 minutes starting at 2pm and ending at 2:55pm, AND fire every 5 minutes starting at 6pm and ending at 6:55pm, every day</td></tr><tr><td><code>0 0-5 14 * * ?</code></td><td>Fire every minute starting at 2pm and ending at 2:05pm, every day</td></tr><tr><td><code>0 10,44 14 ? 3 WED</code></td><td>Fire at 2:10pm and at 2:44pm every Wednesday in the month of March.</td></tr><tr><td><code>0 15 10 ? * MON-FRI</code></td><td>Fire at 10:15am every Monday, Tuesday, Wednesday, Thursday and Friday</td></tr><tr><td><code>0 15 10 15 * ?</code></td><td>Fire at 10:15am on the 15th day of every month</td></tr><tr><td><code>0 15 10 L * ?</code></td><td>Fire at 10:15am on the last day of every month</td></tr><tr><td><code>0 15 10 L-2 * ?</code></td><td>Fire at 10:15am on the 2nd-to-last last day of every month</td></tr><tr><td><code>0 15 10 ? * 6L</code></td><td>Fire at 10:15am on the last Friday of every month</td></tr><tr><td><code>0 15 10 ? * 6L</code></td><td>Fire at 10:15am on the last Friday of every month</td></tr><tr><td><code>0 15 10 ? * 6L 2002-2005</code></td><td>Fire at 10:15am on every last friday of every month during the years 2002, 2003, 2004 and 2005</td></tr><tr><td><code>0 15 10 ? * 6#3</code></td><td>Fire at 10:15am on the third Friday of every month</td></tr><tr><td><code>0 0 12 1/5 * ?</code></td><td>Fire at 12pm (noon) every 5 days every month, starting on the first day of the month.</td></tr><tr><td><code>0 11 11 11 11 ?</code></td><td>Fire every November 11th at 11:11am.</td></tr></tbody></table><h5 id="_3-springboot整合定时任务" tabindex="-1">3.SpringBoot整合定时任务 <a aria-current="page" href="/posts/flash%20killing#_3-springboot整合定时任务" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h5><p>定时任务相关注解:</p><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8">@</span><span style="color:#f97583">EnableAsync</span><span style="color:#e1e4e8"> </span><span style="color:#6a737d">// 启用Spring异步任务支持</span></span>
<span class="line"><span style="color:#e1e4e8">@</span><span style="color:#f97583">EnableScheduling</span><span style="color:#e1e4e8"> </span><span style="color:#6a737d">// 启用Spring的计划任务执行功能</span></span>
<span class="line"><span style="color:#e1e4e8">@</span><span style="color:#f97583">Async</span><span style="color:#e1e4e8"> 异步</span></span>
<span class="line"><span style="color:#e1e4e8">@</span><span style="color:#f97583">Scheduled</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">cron</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#9ecbff">"* * * * * ?"</span><span style="color:#e1e4e8">)</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e">@</span><span style="color:#d73a49">EnableAsync</span><span style="color:#24292e"> </span><span style="color:#6a737d">// 启用Spring异步任务支持</span></span>
<span class="line"><span style="color:#24292e">@</span><span style="color:#d73a49">EnableScheduling</span><span style="color:#24292e"> </span><span style="color:#6a737d">// 启用Spring的计划任务执行功能</span></span>
<span class="line"><span style="color:#24292e">@</span><span style="color:#d73a49">Async</span><span style="color:#24292e"> 异步</span></span>
<span class="line"><span style="color:#24292e">@</span><span style="color:#d73a49">Scheduled</span><span style="color:#24292e">(</span><span style="color:#005cc5">cron</span><span style="color:#24292e"> </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#032f62">"* * * * * ?"</span><span style="color:#24292e">)</span></span></code></pre></div><p>代码：</p><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6a737d">/**</span></span>
<span class="line"><span style="color:#6a737d"> *</span></span>
<span class="line"><span style="color:#6a737d"> * 定时任务</span></span>
<span class="line"><span style="color:#6a737d"> *      1、@EnableScheduling 开启定时任务</span></span>
<span class="line"><span style="color:#6a737d"> *      2、Scheduled 开启一个定时任务</span></span>
<span class="line"><span style="color:#6a737d"> *      3、自动配置类 TaskSchedulingAutoConfiguration 属性绑定在TaskExecutionProperties</span></span>
<span class="line"><span style="color:#6a737d"> *</span></span>
<span class="line"><span style="color:#6a737d"> * 异步任务</span></span>
<span class="line"><span style="color:#6a737d"> *      1、@EnableAsync 开启异步任务功能</span></span>
<span class="line"><span style="color:#6a737d"> *      2、@Async 给希望异步执行的方法上标注</span></span>
<span class="line"><span style="color:#6a737d"> *      3、自动配置类 TaskExecutionAutoConfiguration</span></span>
<span class="line"><span style="color:#6a737d"> *</span></span>
<span class="line"><span style="color:#6a737d"> */</span></span>
<span class="line"><span style="color:#e1e4e8">@</span><span style="color:#f97583">Slf4j</span></span>
<span class="line"><span style="color:#e1e4e8">@</span><span style="color:#f97583">Component</span></span>
<span class="line"><span style="color:#e1e4e8">@</span><span style="color:#f97583">EnableAsync</span><span style="color:#e1e4e8"> </span><span style="color:#6a737d">// 启用Spring异步任务支持</span></span>
<span class="line"><span style="color:#e1e4e8">@</span><span style="color:#f97583">EnableScheduling</span><span style="color:#e1e4e8"> </span><span style="color:#6a737d">// 启用Spring的计划任务执行功能</span></span>
<span class="line"><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">class</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">HelloSchedule</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6a737d">    /**</span></span>
<span class="line"><span style="color:#6a737d">     * 1、Spring中6位组成，不允许第7位的年</span></span>
<span class="line"><span style="color:#6a737d">     * 2、在周几的位置，1-7代表周一到周日：MON-SUN</span></span>
<span class="line"><span style="color:#6a737d">     * 3、定时任务应该阻塞，默认是阻塞的</span></span>
<span class="line"><span style="color:#6a737d">     *      1、可以让业务以异步的方式运行，自己提交到线程池</span></span>
<span class="line"><span style="color:#6a737d">     *          CompletableFuture.runAsync(() -&gt; {</span></span>
<span class="line"><span style="color:#6a737d">     *              xxxService.hello();</span></span>
<span class="line"><span style="color:#6a737d">     *          })</span></span>
<span class="line"><span style="color:#6a737d">     *      2、支持定时任务线程池，设置 TaskSchedulingProperties</span></span>
<span class="line"><span style="color:#6a737d">     *          spring.task.scheduling.pool.size=5</span></span>
<span class="line"><span style="color:#6a737d">     *      3、让定时任务异步执行</span></span>
<span class="line"><span style="color:#6a737d">     *          异步执行</span></span>
<span class="line"><span style="color:#6a737d">     *     解决：使用异步 + 定时任务来完成定时任务不阻塞的功能</span></span>
<span class="line"><span style="color:#6a737d">     */</span></span>
<span class="line"><span style="color:#6a737d">//    @Async 异步</span></span>
<span class="line"><span style="color:#6a737d">//    @Scheduled(cron = "* * * * * ?")</span></span>
<span class="line"><span style="color:#6a737d">//    public void hello() {</span></span>
<span class="line"><span style="color:#6a737d">//        log.info("hello...");</span></span>
<span class="line"><span style="color:#6a737d">//    }</span></span>
<span class="line"><span style="color:#e1e4e8">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6a737d">/**</span></span>
<span class="line"><span style="color:#6a737d"> *</span></span>
<span class="line"><span style="color:#6a737d"> * 定时任务</span></span>
<span class="line"><span style="color:#6a737d"> *      1、@EnableScheduling 开启定时任务</span></span>
<span class="line"><span style="color:#6a737d"> *      2、Scheduled 开启一个定时任务</span></span>
<span class="line"><span style="color:#6a737d"> *      3、自动配置类 TaskSchedulingAutoConfiguration 属性绑定在TaskExecutionProperties</span></span>
<span class="line"><span style="color:#6a737d"> *</span></span>
<span class="line"><span style="color:#6a737d"> * 异步任务</span></span>
<span class="line"><span style="color:#6a737d"> *      1、@EnableAsync 开启异步任务功能</span></span>
<span class="line"><span style="color:#6a737d"> *      2、@Async 给希望异步执行的方法上标注</span></span>
<span class="line"><span style="color:#6a737d"> *      3、自动配置类 TaskExecutionAutoConfiguration</span></span>
<span class="line"><span style="color:#6a737d"> *</span></span>
<span class="line"><span style="color:#6a737d"> */</span></span>
<span class="line"><span style="color:#24292e">@</span><span style="color:#d73a49">Slf4j</span></span>
<span class="line"><span style="color:#24292e">@</span><span style="color:#d73a49">Component</span></span>
<span class="line"><span style="color:#24292e">@</span><span style="color:#d73a49">EnableAsync</span><span style="color:#24292e"> </span><span style="color:#6a737d">// 启用Spring异步任务支持</span></span>
<span class="line"><span style="color:#24292e">@</span><span style="color:#d73a49">EnableScheduling</span><span style="color:#24292e"> </span><span style="color:#6a737d">// 启用Spring的计划任务执行功能</span></span>
<span class="line"><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">class</span><span style="color:#24292e"> </span><span style="color:#6f42c1">HelloSchedule</span><span style="color:#24292e"> {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6a737d">    /**</span></span>
<span class="line"><span style="color:#6a737d">     * 1、Spring中6位组成，不允许第7位的年</span></span>
<span class="line"><span style="color:#6a737d">     * 2、在周几的位置，1-7代表周一到周日：MON-SUN</span></span>
<span class="line"><span style="color:#6a737d">     * 3、定时任务应该阻塞，默认是阻塞的</span></span>
<span class="line"><span style="color:#6a737d">     *      1、可以让业务以异步的方式运行，自己提交到线程池</span></span>
<span class="line"><span style="color:#6a737d">     *          CompletableFuture.runAsync(() -&gt; {</span></span>
<span class="line"><span style="color:#6a737d">     *              xxxService.hello();</span></span>
<span class="line"><span style="color:#6a737d">     *          })</span></span>
<span class="line"><span style="color:#6a737d">     *      2、支持定时任务线程池，设置 TaskSchedulingProperties</span></span>
<span class="line"><span style="color:#6a737d">     *          spring.task.scheduling.pool.size=5</span></span>
<span class="line"><span style="color:#6a737d">     *      3、让定时任务异步执行</span></span>
<span class="line"><span style="color:#6a737d">     *          异步执行</span></span>
<span class="line"><span style="color:#6a737d">     *     解决：使用异步 + 定时任务来完成定时任务不阻塞的功能</span></span>
<span class="line"><span style="color:#6a737d">     */</span></span>
<span class="line"><span style="color:#6a737d">//    @Async 异步</span></span>
<span class="line"><span style="color:#6a737d">//    @Scheduled(cron = "* * * * * ?")</span></span>
<span class="line"><span style="color:#6a737d">//    public void hello() {</span></span>
<span class="line"><span style="color:#6a737d">//        log.info("hello...");</span></span>
<span class="line"><span style="color:#6a737d">//    }</span></span>
<span class="line"><span style="color:#24292e">}</span></span></code></pre></div><div class="language-properties"><button title="Copy Code" class="copy"></button><span class="lang">properties</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#f97583">spring.task.execution.pool.core-size</span><span style="color:#e1e4e8">=5</span></span>
<span class="line"><span style="color:#f97583">spring.task.execution.pool.max-size</span><span style="color:#e1e4e8">=50</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#d73a49">spring.task.execution.pool.core-size</span><span style="color:#24292e">=5</span></span>
<span class="line"><span style="color:#d73a49">spring.task.execution.pool.max-size</span><span style="color:#24292e">=50</span></span></code></pre></div><h4 id="_3-2-秒杀商品上架" tabindex="-1">3.2 秒杀商品上架 <a aria-current="page" href="/posts/flash%20killing#_3-2-秒杀商品上架" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h4><ul><li>定时上架秒杀商品</li></ul><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6a737d">/**</span></span>
<span class="line"><span style="color:#6a737d"> *  * 秒杀商品的定时上架；</span></span>
<span class="line"><span style="color:#6a737d"> *  *      每天晚上3点；上架最近三天需要秒杀的商品</span></span>
<span class="line"><span style="color:#6a737d"> *  *      当天00:00:00 - 23:59:59</span></span>
<span class="line"><span style="color:#6a737d"> *  *      明天天00:00:00 - 23:59:59</span></span>
<span class="line"><span style="color:#6a737d"> *  *      后天00:00:00 - 23:59:59</span></span>
<span class="line"><span style="color:#6a737d"> * </span><span style="color:#f97583">@author</span><span style="color:#6a737d"> Klaus</span></span>
<span class="line"><span style="color:#6a737d"> * @date 2022/9/27</span></span>
<span class="line"><span style="color:#6a737d"> */</span></span>
<span class="line"><span style="color:#e1e4e8">@</span><span style="color:#f97583">Slf4j</span></span>
<span class="line"><span style="color:#e1e4e8">@</span><span style="color:#f97583">Service</span></span>
<span class="line"><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">class</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">SeckillSkuScheduled</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">    @</span><span style="color:#f97583">Autowired</span></span>
<span class="line"><span style="color:#e1e4e8">    SeckillService seckillService;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">    @</span><span style="color:#f97583">Scheduled</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">cron</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#9ecbff">"0 0 1/1 * * ? "</span><span style="color:#e1e4e8">)</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">void</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">uploadSeckillSkuLatest3Days</span><span style="color:#e1e4e8">(){</span></span>
<span class="line"><span style="color:#e1e4e8">         seckillService.</span><span style="color:#b392f0">uploadSeckillSkuLatest3Days</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"><span style="color:#e1e4e8">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6a737d">/**</span></span>
<span class="line"><span style="color:#6a737d"> *  * 秒杀商品的定时上架；</span></span>
<span class="line"><span style="color:#6a737d"> *  *      每天晚上3点；上架最近三天需要秒杀的商品</span></span>
<span class="line"><span style="color:#6a737d"> *  *      当天00:00:00 - 23:59:59</span></span>
<span class="line"><span style="color:#6a737d"> *  *      明天天00:00:00 - 23:59:59</span></span>
<span class="line"><span style="color:#6a737d"> *  *      后天00:00:00 - 23:59:59</span></span>
<span class="line"><span style="color:#6a737d"> * </span><span style="color:#d73a49">@author</span><span style="color:#6a737d"> Klaus</span></span>
<span class="line"><span style="color:#6a737d"> * @date 2022/9/27</span></span>
<span class="line"><span style="color:#6a737d"> */</span></span>
<span class="line"><span style="color:#24292e">@</span><span style="color:#d73a49">Slf4j</span></span>
<span class="line"><span style="color:#24292e">@</span><span style="color:#d73a49">Service</span></span>
<span class="line"><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">class</span><span style="color:#24292e"> </span><span style="color:#6f42c1">SeckillSkuScheduled</span><span style="color:#24292e"> {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">    @</span><span style="color:#d73a49">Autowired</span></span>
<span class="line"><span style="color:#24292e">    SeckillService seckillService;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">    @</span><span style="color:#d73a49">Scheduled</span><span style="color:#24292e">(</span><span style="color:#005cc5">cron</span><span style="color:#24292e"> </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#032f62">"0 0 1/1 * * ? "</span><span style="color:#24292e">)</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">void</span><span style="color:#24292e"> </span><span style="color:#6f42c1">uploadSeckillSkuLatest3Days</span><span style="color:#24292e">(){</span></span>
<span class="line"><span style="color:#24292e">         seckillService.</span><span style="color:#6f42c1">uploadSeckillSkuLatest3Days</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"><span style="color:#24292e">}</span></span></code></pre></div><ul><li>远程获取近三天秒杀商品</li></ul><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8">@</span><span style="color:#f97583">FeignClient</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"gulimall-coupon"</span><span style="color:#e1e4e8">)</span></span>
<span class="line"><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">interface</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">CouponFeignService</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">    @</span><span style="color:#f97583">GetMapping</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"/coupon/seckillsession/latest3DaySession"</span><span style="color:#e1e4e8">)</span></span>
<span class="line"><span style="color:#e1e4e8">    R </span><span style="color:#b392f0">getLatest3DaySession</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e">@</span><span style="color:#d73a49">FeignClient</span><span style="color:#24292e">(</span><span style="color:#032f62">"gulimall-coupon"</span><span style="color:#24292e">)</span></span>
<span class="line"><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">interface</span><span style="color:#24292e"> </span><span style="color:#6f42c1">CouponFeignService</span><span style="color:#24292e"> {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">    @</span><span style="color:#d73a49">GetMapping</span><span style="color:#24292e">(</span><span style="color:#032f62">"/coupon/seckillsession/latest3DaySession"</span><span style="color:#24292e">)</span></span>
<span class="line"><span style="color:#24292e">    R </span><span style="color:#6f42c1">getLatest3DaySession</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">}</span></span></code></pre></div><ul><li>获取最近3天的秒杀活动场次接口</li><li><code>org.klaus.zgg01mall.coupon.controller.SeckillSessionController#getLatest3DaySession</code></li></ul><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6a737d">/**</span></span>
<span class="line"><span style="color:#6a737d"> * 获取最近3天的秒杀活动场次</span></span>
<span class="line"><span style="color:#6a737d"> * </span><span style="color:#f97583">@return</span></span>
<span class="line"><span style="color:#6a737d"> */</span></span>
<span class="line"><span style="color:#e1e4e8">@</span><span style="color:#f97583">GetMapping</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"/latest3DaySession"</span><span style="color:#e1e4e8">)</span></span>
<span class="line"><span style="color:#f97583">public</span><span style="color:#e1e4e8"> R </span><span style="color:#b392f0">getLatest3DaySession</span><span style="color:#e1e4e8">(){</span></span>
<span class="line"><span style="color:#e1e4e8">    List&lt;</span><span style="color:#f97583">SeckillSessionEntity</span><span style="color:#e1e4e8">&gt; sessionEntities </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> seckillSessionService.</span><span style="color:#b392f0">getLatest3DaySession</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> R.</span><span style="color:#b392f0">ok</span><span style="color:#e1e4e8">().</span><span style="color:#b392f0">setData</span><span style="color:#e1e4e8">(sessionEntities);</span></span>
<span class="line"><span style="color:#e1e4e8">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6a737d">/**</span></span>
<span class="line"><span style="color:#6a737d"> * 获取最近3天的秒杀活动场次</span></span>
<span class="line"><span style="color:#6a737d"> * </span><span style="color:#d73a49">@return</span></span>
<span class="line"><span style="color:#6a737d"> */</span></span>
<span class="line"><span style="color:#24292e">@</span><span style="color:#d73a49">GetMapping</span><span style="color:#24292e">(</span><span style="color:#032f62">"/latest3DaySession"</span><span style="color:#24292e">)</span></span>
<span class="line"><span style="color:#d73a49">public</span><span style="color:#24292e"> R </span><span style="color:#6f42c1">getLatest3DaySession</span><span style="color:#24292e">(){</span></span>
<span class="line"><span style="color:#24292e">    List&lt;</span><span style="color:#d73a49">SeckillSessionEntity</span><span style="color:#24292e">&gt; sessionEntities </span><span style="color:#d73a49">=</span><span style="color:#24292e"> seckillSessionService.</span><span style="color:#6f42c1">getLatest3DaySession</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">return</span><span style="color:#24292e"> R.</span><span style="color:#6f42c1">ok</span><span style="color:#24292e">().</span><span style="color:#6f42c1">setData</span><span style="color:#24292e">(sessionEntities);</span></span>
<span class="line"><span style="color:#24292e">}</span></span></code></pre></div><ul><li>获取最近3天的秒杀活动场次方法实现及时间日期处理</li></ul><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8">@</span><span style="color:#f97583">Autowired</span></span>
<span class="line"><span style="color:#e1e4e8">    SeckillSkuRelationService seckillSkuRelationService;</span></span>
<span class="line"><span style="color:#6a737d">	/**</span></span>
<span class="line"><span style="color:#6a737d">     * 获取最近3天的秒杀活动场次</span></span>
<span class="line"><span style="color:#6a737d">     *</span></span>
<span class="line"><span style="color:#6a737d">     * </span><span style="color:#f97583">@return</span></span>
<span class="line"><span style="color:#6a737d">     */</span></span>
<span class="line"><span style="color:#e1e4e8">    @</span><span style="color:#f97583">Override</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">public</span><span style="color:#e1e4e8"> List</span><span style="color:#f97583">&lt;</span><span style="color:#e1e4e8">SeckillSessionEntity</span><span style="color:#f97583">&gt;</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">getLatest3DaySession</span><span style="color:#e1e4e8">() {</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#6a737d">//获取最近三天信息</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">        List&lt;</span><span style="color:#f97583">SeckillSessionEntity</span><span style="color:#e1e4e8">&gt; list </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">this</span><span style="color:#e1e4e8">.</span><span style="color:#b392f0">list</span><span style="color:#e1e4e8">(</span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> QueryWrapper&lt;</span><span style="color:#f97583">SeckillSessionEntity</span><span style="color:#e1e4e8">&gt;	().</span><span style="color:#b392f0">between</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"start_time"</span><span style="color:#e1e4e8">, </span><span style="color:#b392f0">startTime</span><span style="color:#e1e4e8">(), </span><span style="color:#b392f0">endTime</span><span style="color:#e1e4e8">()));</span></span>
<span class="line"><span style="color:#e1e4e8">        </span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"><span style="color:#e1e4e8">	</span><span style="color:#f97583">private</span><span style="color:#e1e4e8"> String </span><span style="color:#b392f0">startTime</span><span style="color:#e1e4e8">() {</span></span>
<span class="line"><span style="color:#e1e4e8">        LocalDate now </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> LocalDate.</span><span style="color:#b392f0">now</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">        LocalTime min </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> LocalTime.MIN;</span></span>
<span class="line"><span style="color:#e1e4e8">        LocalDateTime start </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> LocalDateTime.</span><span style="color:#b392f0">of</span><span style="color:#e1e4e8">(now, min);</span></span>
<span class="line"><span style="color:#e1e4e8">        String format </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> start.</span><span style="color:#b392f0">format</span><span style="color:#e1e4e8">(DateTimeFormatter.</span><span style="color:#b392f0">ofPattern</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"yyyy-MM-dd HH:mm:ss"</span><span style="color:#e1e4e8">));</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> format;</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">private</span><span style="color:#e1e4e8"> String </span><span style="color:#b392f0">endTime</span><span style="color:#e1e4e8">() {</span></span>
<span class="line"><span style="color:#e1e4e8">        LocalDate now </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> LocalDate.</span><span style="color:#b392f0">now</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">        LocalDate localDate </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> now.</span><span style="color:#b392f0">plusDays</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">2</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">        LocalTime max </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> LocalTime.MAX;</span></span>
<span class="line"><span style="color:#e1e4e8">        LocalDateTime end </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> LocalDateTime.</span><span style="color:#b392f0">of</span><span style="color:#e1e4e8">(localDate, max);</span></span>
<span class="line"><span style="color:#e1e4e8">        String format </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> end.</span><span style="color:#b392f0">format</span><span style="color:#e1e4e8">(DateTimeFormatter.</span><span style="color:#b392f0">ofPattern</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"yyyy-MM-dd HH:mm:ss"</span><span style="color:#e1e4e8">));</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> format;</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e">@</span><span style="color:#d73a49">Autowired</span></span>
<span class="line"><span style="color:#24292e">    SeckillSkuRelationService seckillSkuRelationService;</span></span>
<span class="line"><span style="color:#6a737d">	/**</span></span>
<span class="line"><span style="color:#6a737d">     * 获取最近3天的秒杀活动场次</span></span>
<span class="line"><span style="color:#6a737d">     *</span></span>
<span class="line"><span style="color:#6a737d">     * </span><span style="color:#d73a49">@return</span></span>
<span class="line"><span style="color:#6a737d">     */</span></span>
<span class="line"><span style="color:#24292e">    @</span><span style="color:#d73a49">Override</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">public</span><span style="color:#24292e"> List</span><span style="color:#d73a49">&lt;</span><span style="color:#24292e">SeckillSessionEntity</span><span style="color:#d73a49">&gt;</span><span style="color:#24292e"> </span><span style="color:#6f42c1">getLatest3DaySession</span><span style="color:#24292e">() {</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6a737d">//获取最近三天信息</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">        List&lt;</span><span style="color:#d73a49">SeckillSessionEntity</span><span style="color:#24292e">&gt; list </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#005cc5">this</span><span style="color:#24292e">.</span><span style="color:#6f42c1">list</span><span style="color:#24292e">(</span><span style="color:#d73a49">new</span><span style="color:#24292e"> QueryWrapper&lt;</span><span style="color:#d73a49">SeckillSessionEntity</span><span style="color:#24292e">&gt;	().</span><span style="color:#6f42c1">between</span><span style="color:#24292e">(</span><span style="color:#032f62">"start_time"</span><span style="color:#24292e">, </span><span style="color:#6f42c1">startTime</span><span style="color:#24292e">(), </span><span style="color:#6f42c1">endTime</span><span style="color:#24292e">()));</span></span>
<span class="line"><span style="color:#24292e">        </span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">return</span><span style="color:#24292e"> </span><span style="color:#005cc5">null</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"><span style="color:#24292e">	</span><span style="color:#d73a49">private</span><span style="color:#24292e"> String </span><span style="color:#6f42c1">startTime</span><span style="color:#24292e">() {</span></span>
<span class="line"><span style="color:#24292e">        LocalDate now </span><span style="color:#d73a49">=</span><span style="color:#24292e"> LocalDate.</span><span style="color:#6f42c1">now</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">        LocalTime min </span><span style="color:#d73a49">=</span><span style="color:#24292e"> LocalTime.MIN;</span></span>
<span class="line"><span style="color:#24292e">        LocalDateTime start </span><span style="color:#d73a49">=</span><span style="color:#24292e"> LocalDateTime.</span><span style="color:#6f42c1">of</span><span style="color:#24292e">(now, min);</span></span>
<span class="line"><span style="color:#24292e">        String format </span><span style="color:#d73a49">=</span><span style="color:#24292e"> start.</span><span style="color:#6f42c1">format</span><span style="color:#24292e">(DateTimeFormatter.</span><span style="color:#6f42c1">ofPattern</span><span style="color:#24292e">(</span><span style="color:#032f62">"yyyy-MM-dd HH:mm:ss"</span><span style="color:#24292e">));</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">return</span><span style="color:#24292e"> format;</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">private</span><span style="color:#24292e"> String </span><span style="color:#6f42c1">endTime</span><span style="color:#24292e">() {</span></span>
<span class="line"><span style="color:#24292e">        LocalDate now </span><span style="color:#d73a49">=</span><span style="color:#24292e"> LocalDate.</span><span style="color:#6f42c1">now</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">        LocalDate localDate </span><span style="color:#d73a49">=</span><span style="color:#24292e"> now.</span><span style="color:#6f42c1">plusDays</span><span style="color:#24292e">(</span><span style="color:#005cc5">2</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">        LocalTime max </span><span style="color:#d73a49">=</span><span style="color:#24292e"> LocalTime.MAX;</span></span>
<span class="line"><span style="color:#24292e">        LocalDateTime end </span><span style="color:#d73a49">=</span><span style="color:#24292e"> LocalDateTime.</span><span style="color:#6f42c1">of</span><span style="color:#24292e">(localDate, max);</span></span>
<span class="line"><span style="color:#24292e">        String format </span><span style="color:#d73a49">=</span><span style="color:#24292e"> end.</span><span style="color:#6f42c1">format</span><span style="color:#24292e">(DateTimeFormatter.</span><span style="color:#6f42c1">ofPattern</span><span style="color:#24292e">(</span><span style="color:#032f62">"yyyy-MM-dd HH:mm:ss"</span><span style="color:#24292e">));</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">return</span><span style="color:#24292e"> format;</span></span>
<span class="line"><span style="color:#24292e">    }</span></span></code></pre></div><ul><li>秒杀活动场次添加商品关联（不记入数据库）</li></ul><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6a737d">/**</span></span>
<span class="line"><span style="color:#6a737d"> * 秒杀活动场次</span></span>
<span class="line"><span style="color:#6a737d"> * </span></span>
<span class="line"><span style="color:#6a737d"> * </span><span style="color:#f97583">@author</span><span style="color:#6a737d"> klaus</span></span>
<span class="line"><span style="color:#6a737d"> * @email klaus@gmail.com</span></span>
<span class="line"><span style="color:#6a737d"> * @date 2022-08-22 13:18:54</span></span>
<span class="line"><span style="color:#6a737d"> */</span></span>
<span class="line"><span style="color:#e1e4e8">@</span><span style="color:#f97583">Data</span></span>
<span class="line"><span style="color:#e1e4e8">@</span><span style="color:#f97583">TableName</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"sms_seckill_session"</span><span style="color:#e1e4e8">)</span></span>
<span class="line"><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">class</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">SeckillSessionEntity</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">implements</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Serializable</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">	......</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6a737d">   /**</span></span>
<span class="line"><span style="color:#6a737d">    * 所有秒杀活动商品关联</span></span>
<span class="line"><span style="color:#6a737d">    */</span></span>
<span class="line"><span style="color:#e1e4e8">   @</span><span style="color:#f97583">TableField</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">exist</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">false</span><span style="color:#e1e4e8">)</span></span>
<span class="line"><span style="color:#e1e4e8">   </span><span style="color:#f97583">private</span><span style="color:#e1e4e8"> List&lt;</span><span style="color:#f97583">SeckillSkuRelationEntity</span><span style="color:#e1e4e8">&gt; relationSkus;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6a737d">/**</span></span>
<span class="line"><span style="color:#6a737d"> * 秒杀活动场次</span></span>
<span class="line"><span style="color:#6a737d"> * </span></span>
<span class="line"><span style="color:#6a737d"> * </span><span style="color:#d73a49">@author</span><span style="color:#6a737d"> klaus</span></span>
<span class="line"><span style="color:#6a737d"> * @email klaus@gmail.com</span></span>
<span class="line"><span style="color:#6a737d"> * @date 2022-08-22 13:18:54</span></span>
<span class="line"><span style="color:#6a737d"> */</span></span>
<span class="line"><span style="color:#24292e">@</span><span style="color:#d73a49">Data</span></span>
<span class="line"><span style="color:#24292e">@</span><span style="color:#d73a49">TableName</span><span style="color:#24292e">(</span><span style="color:#032f62">"sms_seckill_session"</span><span style="color:#24292e">)</span></span>
<span class="line"><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">class</span><span style="color:#24292e"> </span><span style="color:#6f42c1">SeckillSessionEntity</span><span style="color:#24292e"> </span><span style="color:#d73a49">implements</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Serializable</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">	......</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6a737d">   /**</span></span>
<span class="line"><span style="color:#6a737d">    * 所有秒杀活动商品关联</span></span>
<span class="line"><span style="color:#6a737d">    */</span></span>
<span class="line"><span style="color:#24292e">   @</span><span style="color:#d73a49">TableField</span><span style="color:#24292e">(</span><span style="color:#005cc5">exist</span><span style="color:#24292e"> </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#005cc5">false</span><span style="color:#24292e">)</span></span>
<span class="line"><span style="color:#24292e">   </span><span style="color:#d73a49">private</span><span style="color:#24292e"> List&lt;</span><span style="color:#d73a49">SeckillSkuRelationEntity</span><span style="color:#24292e">&gt; relationSkus;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">}</span></span></code></pre></div><ul><li>完善获取最近3天的秒杀活动场次方法实现</li><li><code>org.klaus.zgg01mall.coupon.service.impl.SeckillSessionServiceImpl#getLatest3DaySession</code></li></ul><figure><img src="https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230430142137405.png" alt="image-20230430142137405" loading="lazy" decoding="async"></figure><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6a737d">/**</span></span>
<span class="line"><span style="color:#6a737d"> * 获取最近3天的秒杀活动场次</span></span>
<span class="line"><span style="color:#6a737d"> *</span></span>
<span class="line"><span style="color:#6a737d"> * </span><span style="color:#f97583">@return</span></span>
<span class="line"><span style="color:#6a737d"> */</span></span>
<span class="line"><span style="color:#e1e4e8">@</span><span style="color:#f97583">Override</span></span>
<span class="line"><span style="color:#f97583">public</span><span style="color:#e1e4e8"> List</span><span style="color:#f97583">&lt;</span><span style="color:#e1e4e8">SeckillSessionEntity</span><span style="color:#f97583">&gt;</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">getLatest3DaySession</span><span style="color:#e1e4e8">() {</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">//获取最近三天信息</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">    List&lt;</span><span style="color:#f97583">SeckillSessionEntity</span><span style="color:#e1e4e8">&gt; list </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">this</span><span style="color:#e1e4e8">.</span><span style="color:#b392f0">list</span><span style="color:#e1e4e8">(</span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> QueryWrapper&lt;</span><span style="color:#f97583">SeckillSessionEntity</span><span style="color:#e1e4e8">&gt;().</span><span style="color:#b392f0">between</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"start_time"</span><span style="color:#e1e4e8">, </span><span style="color:#b392f0">startTime</span><span style="color:#e1e4e8">(), </span><span style="color:#b392f0">endTime</span><span style="color:#e1e4e8">()));</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (list </span><span style="color:#f97583">!=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">&amp;&amp;</span><span style="color:#e1e4e8"> list.</span><span style="color:#b392f0">size</span><span style="color:#e1e4e8">() </span><span style="color:#f97583">&gt;</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">        List&lt;</span><span style="color:#f97583">SeckillSessionEntity</span><span style="color:#e1e4e8">&gt; collect </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> list.</span><span style="color:#b392f0">stream</span><span style="color:#e1e4e8">().</span><span style="color:#b392f0">map</span><span style="color:#e1e4e8">(session </span><span style="color:#f97583">-&gt;</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#6a737d">//获取秒杀场次id</span></span>
<span class="line"><span style="color:#e1e4e8">            Long id </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> session.</span><span style="color:#b392f0">getId</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#6a737d">//根据秒杀场次id获取秒杀关联商品集合</span></span>
<span class="line"><span style="color:#e1e4e8">            List&lt;</span><span style="color:#f97583">SeckillSkuRelationEntity</span><span style="color:#e1e4e8">&gt; skuRelationEntities </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> seckillSkuRelationService.</span><span style="color:#b392f0">list</span><span style="color:#e1e4e8">(</span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> QueryWrapper&lt;</span><span style="color:#f97583">SeckillSkuRelationEntity</span><span style="color:#e1e4e8">&gt;().</span><span style="color:#b392f0">eq</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"promotion_session_id"</span><span style="color:#e1e4e8">, id));</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (skuRelationEntities </span><span style="color:#f97583">!=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">&amp;&amp;</span><span style="color:#e1e4e8"> skuRelationEntities.</span><span style="color:#b392f0">size</span><span style="color:#e1e4e8">() </span><span style="color:#f97583">&gt;</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">                session.</span><span style="color:#b392f0">setRelationSkus</span><span style="color:#e1e4e8">(skuRelationEntities);</span></span>
<span class="line"><span style="color:#e1e4e8">            }</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> session;</span></span>
<span class="line"><span style="color:#e1e4e8">        }).</span><span style="color:#b392f0">collect</span><span style="color:#e1e4e8">(Collectors.</span><span style="color:#b392f0">toList</span><span style="color:#e1e4e8">());</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> collect;</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6a737d">/**</span></span>
<span class="line"><span style="color:#6a737d"> * 获取最近3天的秒杀活动场次</span></span>
<span class="line"><span style="color:#6a737d"> *</span></span>
<span class="line"><span style="color:#6a737d"> * </span><span style="color:#d73a49">@return</span></span>
<span class="line"><span style="color:#6a737d"> */</span></span>
<span class="line"><span style="color:#24292e">@</span><span style="color:#d73a49">Override</span></span>
<span class="line"><span style="color:#d73a49">public</span><span style="color:#24292e"> List</span><span style="color:#d73a49">&lt;</span><span style="color:#24292e">SeckillSessionEntity</span><span style="color:#d73a49">&gt;</span><span style="color:#24292e"> </span><span style="color:#6f42c1">getLatest3DaySession</span><span style="color:#24292e">() {</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">//获取最近三天信息</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">    List&lt;</span><span style="color:#d73a49">SeckillSessionEntity</span><span style="color:#24292e">&gt; list </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#005cc5">this</span><span style="color:#24292e">.</span><span style="color:#6f42c1">list</span><span style="color:#24292e">(</span><span style="color:#d73a49">new</span><span style="color:#24292e"> QueryWrapper&lt;</span><span style="color:#d73a49">SeckillSessionEntity</span><span style="color:#24292e">&gt;().</span><span style="color:#6f42c1">between</span><span style="color:#24292e">(</span><span style="color:#032f62">"start_time"</span><span style="color:#24292e">, </span><span style="color:#6f42c1">startTime</span><span style="color:#24292e">(), </span><span style="color:#6f42c1">endTime</span><span style="color:#24292e">()));</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (list </span><span style="color:#d73a49">!=</span><span style="color:#24292e"> </span><span style="color:#005cc5">null</span><span style="color:#24292e"> </span><span style="color:#d73a49">&amp;&amp;</span><span style="color:#24292e"> list.</span><span style="color:#6f42c1">size</span><span style="color:#24292e">() </span><span style="color:#d73a49">&gt;</span><span style="color:#24292e"> </span><span style="color:#005cc5">0</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">        List&lt;</span><span style="color:#d73a49">SeckillSessionEntity</span><span style="color:#24292e">&gt; collect </span><span style="color:#d73a49">=</span><span style="color:#24292e"> list.</span><span style="color:#6f42c1">stream</span><span style="color:#24292e">().</span><span style="color:#6f42c1">map</span><span style="color:#24292e">(session </span><span style="color:#d73a49">-&gt;</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#6a737d">//获取秒杀场次id</span></span>
<span class="line"><span style="color:#24292e">            Long id </span><span style="color:#d73a49">=</span><span style="color:#24292e"> session.</span><span style="color:#6f42c1">getId</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#6a737d">//根据秒杀场次id获取秒杀关联商品集合</span></span>
<span class="line"><span style="color:#24292e">            List&lt;</span><span style="color:#d73a49">SeckillSkuRelationEntity</span><span style="color:#24292e">&gt; skuRelationEntities </span><span style="color:#d73a49">=</span><span style="color:#24292e"> seckillSkuRelationService.</span><span style="color:#6f42c1">list</span><span style="color:#24292e">(</span><span style="color:#d73a49">new</span><span style="color:#24292e"> QueryWrapper&lt;</span><span style="color:#d73a49">SeckillSkuRelationEntity</span><span style="color:#24292e">&gt;().</span><span style="color:#6f42c1">eq</span><span style="color:#24292e">(</span><span style="color:#032f62">"promotion_session_id"</span><span style="color:#24292e">, id));</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (skuRelationEntities </span><span style="color:#d73a49">!=</span><span style="color:#24292e"> </span><span style="color:#005cc5">null</span><span style="color:#24292e"> </span><span style="color:#d73a49">&amp;&amp;</span><span style="color:#24292e"> skuRelationEntities.</span><span style="color:#6f42c1">size</span><span style="color:#24292e">() </span><span style="color:#d73a49">&gt;</span><span style="color:#24292e"> </span><span style="color:#005cc5">0</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">                session.</span><span style="color:#6f42c1">setRelationSkus</span><span style="color:#24292e">(skuRelationEntities);</span></span>
<span class="line"><span style="color:#24292e">            }</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">return</span><span style="color:#24292e"> session;</span></span>
<span class="line"><span style="color:#24292e">        }).</span><span style="color:#6f42c1">collect</span><span style="color:#24292e">(Collectors.</span><span style="color:#6f42c1">toList</span><span style="color:#24292e">());</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">return</span><span style="color:#24292e"> collect;</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">return</span><span style="color:#24292e"> </span><span style="color:#005cc5">null</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">}</span></span></code></pre></div><ul><li>添加数据传输vo</li></ul><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6a737d">/**</span></span>
<span class="line"><span style="color:#6a737d"> * </span><span style="color:#f97583">@author</span><span style="color:#6a737d"> Klaus</span></span>
<span class="line"><span style="color:#6a737d"> * @date 2022/9/28</span></span>
<span class="line"><span style="color:#6a737d"> */</span></span>
<span class="line"><span style="color:#e1e4e8">@</span><span style="color:#f97583">Data</span></span>
<span class="line"><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">class</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">SeckillSessionWithSkus</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">private</span><span style="color:#e1e4e8"> Long id;</span></span>
<span class="line"><span style="color:#6a737d">    /**</span></span>
<span class="line"><span style="color:#6a737d">     * 场次名称</span></span>
<span class="line"><span style="color:#6a737d">     */</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">private</span><span style="color:#e1e4e8"> String name;</span></span>
<span class="line"><span style="color:#6a737d">    /**</span></span>
<span class="line"><span style="color:#6a737d">     * 每日开始时间</span></span>
<span class="line"><span style="color:#6a737d">     */</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">private</span><span style="color:#e1e4e8"> Date startTime;</span></span>
<span class="line"><span style="color:#6a737d">    /**</span></span>
<span class="line"><span style="color:#6a737d">     * 每日结束时间</span></span>
<span class="line"><span style="color:#6a737d">     */</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">private</span><span style="color:#e1e4e8"> Date endTime;</span></span>
<span class="line"><span style="color:#6a737d">    /**</span></span>
<span class="line"><span style="color:#6a737d">     * 启用状态</span></span>
<span class="line"><span style="color:#6a737d">     */</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">private</span><span style="color:#e1e4e8"> Integer status;</span></span>
<span class="line"><span style="color:#6a737d">    /**</span></span>
<span class="line"><span style="color:#6a737d">     * 创建时间</span></span>
<span class="line"><span style="color:#6a737d">     */</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">private</span><span style="color:#e1e4e8"> Date createTime;</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">private</span><span style="color:#e1e4e8"> List&lt;</span><span style="color:#f97583">SeckillSkuVo</span><span style="color:#e1e4e8">&gt; relationSkus;</span></span>
<span class="line"><span style="color:#e1e4e8">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6a737d">/**</span></span>
<span class="line"><span style="color:#6a737d"> * </span><span style="color:#d73a49">@author</span><span style="color:#6a737d"> Klaus</span></span>
<span class="line"><span style="color:#6a737d"> * @date 2022/9/28</span></span>
<span class="line"><span style="color:#6a737d"> */</span></span>
<span class="line"><span style="color:#24292e">@</span><span style="color:#d73a49">Data</span></span>
<span class="line"><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">class</span><span style="color:#24292e"> </span><span style="color:#6f42c1">SeckillSessionWithSkus</span><span style="color:#24292e"> {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">private</span><span style="color:#24292e"> Long id;</span></span>
<span class="line"><span style="color:#6a737d">    /**</span></span>
<span class="line"><span style="color:#6a737d">     * 场次名称</span></span>
<span class="line"><span style="color:#6a737d">     */</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">private</span><span style="color:#24292e"> String name;</span></span>
<span class="line"><span style="color:#6a737d">    /**</span></span>
<span class="line"><span style="color:#6a737d">     * 每日开始时间</span></span>
<span class="line"><span style="color:#6a737d">     */</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">private</span><span style="color:#24292e"> Date startTime;</span></span>
<span class="line"><span style="color:#6a737d">    /**</span></span>
<span class="line"><span style="color:#6a737d">     * 每日结束时间</span></span>
<span class="line"><span style="color:#6a737d">     */</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">private</span><span style="color:#24292e"> Date endTime;</span></span>
<span class="line"><span style="color:#6a737d">    /**</span></span>
<span class="line"><span style="color:#6a737d">     * 启用状态</span></span>
<span class="line"><span style="color:#6a737d">     */</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">private</span><span style="color:#24292e"> Integer status;</span></span>
<span class="line"><span style="color:#6a737d">    /**</span></span>
<span class="line"><span style="color:#6a737d">     * 创建时间</span></span>
<span class="line"><span style="color:#6a737d">     */</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">private</span><span style="color:#24292e"> Date createTime;</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">private</span><span style="color:#24292e"> List&lt;</span><span style="color:#d73a49">SeckillSkuVo</span><span style="color:#24292e">&gt; relationSkus;</span></span>
<span class="line"><span style="color:#24292e">}</span></span></code></pre></div><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6a737d">/**</span></span>
<span class="line"><span style="color:#6a737d"> * </span><span style="color:#f97583">@author</span><span style="color:#6a737d"> Klaus</span></span>
<span class="line"><span style="color:#6a737d"> * @date 2022/9/28</span></span>
<span class="line"><span style="color:#6a737d"> */</span></span>
<span class="line"><span style="color:#e1e4e8">@</span><span style="color:#f97583">Data</span></span>
<span class="line"><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">class</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">SeckillSkuVo</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">private</span><span style="color:#e1e4e8"> Long id;</span></span>
<span class="line"><span style="color:#6a737d">    /**</span></span>
<span class="line"><span style="color:#6a737d">     * 活动id</span></span>
<span class="line"><span style="color:#6a737d">     */</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">private</span><span style="color:#e1e4e8"> Long promotionId;</span></span>
<span class="line"><span style="color:#6a737d">    /**</span></span>
<span class="line"><span style="color:#6a737d">     * 活动场次id</span></span>
<span class="line"><span style="color:#6a737d">     */</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">private</span><span style="color:#e1e4e8"> Long promotionSessionId;</span></span>
<span class="line"><span style="color:#6a737d">    /**</span></span>
<span class="line"><span style="color:#6a737d">     * 商品id</span></span>
<span class="line"><span style="color:#6a737d">     */</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">private</span><span style="color:#e1e4e8"> Long skuId;</span></span>
<span class="line"><span style="color:#6a737d">    /**</span></span>
<span class="line"><span style="color:#6a737d">     * 秒杀价格</span></span>
<span class="line"><span style="color:#6a737d">     */</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">private</span><span style="color:#e1e4e8"> BigDecimal seckillPrice;</span></span>
<span class="line"><span style="color:#6a737d">    /**</span></span>
<span class="line"><span style="color:#6a737d">     * 秒杀总量</span></span>
<span class="line"><span style="color:#6a737d">     */</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">private</span><span style="color:#e1e4e8"> BigDecimal seckillCount;</span></span>
<span class="line"><span style="color:#6a737d">    /**</span></span>
<span class="line"><span style="color:#6a737d">     * 每人限购数量</span></span>
<span class="line"><span style="color:#6a737d">     */</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">private</span><span style="color:#e1e4e8"> BigDecimal seckillLimit;</span></span>
<span class="line"><span style="color:#6a737d">    /**</span></span>
<span class="line"><span style="color:#6a737d">     * 排序</span></span>
<span class="line"><span style="color:#6a737d">     */</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">private</span><span style="color:#e1e4e8"> Integer seckillSort;</span></span>
<span class="line"><span style="color:#e1e4e8">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6a737d">/**</span></span>
<span class="line"><span style="color:#6a737d"> * </span><span style="color:#d73a49">@author</span><span style="color:#6a737d"> Klaus</span></span>
<span class="line"><span style="color:#6a737d"> * @date 2022/9/28</span></span>
<span class="line"><span style="color:#6a737d"> */</span></span>
<span class="line"><span style="color:#24292e">@</span><span style="color:#d73a49">Data</span></span>
<span class="line"><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">class</span><span style="color:#24292e"> </span><span style="color:#6f42c1">SeckillSkuVo</span><span style="color:#24292e"> {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">private</span><span style="color:#24292e"> Long id;</span></span>
<span class="line"><span style="color:#6a737d">    /**</span></span>
<span class="line"><span style="color:#6a737d">     * 活动id</span></span>
<span class="line"><span style="color:#6a737d">     */</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">private</span><span style="color:#24292e"> Long promotionId;</span></span>
<span class="line"><span style="color:#6a737d">    /**</span></span>
<span class="line"><span style="color:#6a737d">     * 活动场次id</span></span>
<span class="line"><span style="color:#6a737d">     */</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">private</span><span style="color:#24292e"> Long promotionSessionId;</span></span>
<span class="line"><span style="color:#6a737d">    /**</span></span>
<span class="line"><span style="color:#6a737d">     * 商品id</span></span>
<span class="line"><span style="color:#6a737d">     */</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">private</span><span style="color:#24292e"> Long skuId;</span></span>
<span class="line"><span style="color:#6a737d">    /**</span></span>
<span class="line"><span style="color:#6a737d">     * 秒杀价格</span></span>
<span class="line"><span style="color:#6a737d">     */</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">private</span><span style="color:#24292e"> BigDecimal seckillPrice;</span></span>
<span class="line"><span style="color:#6a737d">    /**</span></span>
<span class="line"><span style="color:#6a737d">     * 秒杀总量</span></span>
<span class="line"><span style="color:#6a737d">     */</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">private</span><span style="color:#24292e"> BigDecimal seckillCount;</span></span>
<span class="line"><span style="color:#6a737d">    /**</span></span>
<span class="line"><span style="color:#6a737d">     * 每人限购数量</span></span>
<span class="line"><span style="color:#6a737d">     */</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">private</span><span style="color:#24292e"> BigDecimal seckillLimit;</span></span>
<span class="line"><span style="color:#6a737d">    /**</span></span>
<span class="line"><span style="color:#6a737d">     * 排序</span></span>
<span class="line"><span style="color:#6a737d">     */</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">private</span><span style="color:#24292e"> Integer seckillSort;</span></span>
<span class="line"><span style="color:#24292e">}</span></span></code></pre></div><ul><li>秒杀商品定时上架流程</li></ul><figure><img src="https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230430004237857.png" alt="image-20230430004237857" loading="lazy" decoding="async"></figure><ul><li>秒杀服务远程调用扫描最近三天需要参与秒杀的活动方法实现</li><li><code>org.klaus.zgg01mall.seckill.service.impl.SeckillServiceImpl#uploadSeckillSkuLatest3Days</code></li></ul><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8">@</span><span style="color:#f97583">Override</span></span>
<span class="line"><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">void</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">uploadSeckillSkuLatest3Days</span><span style="color:#e1e4e8">() {</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">//1、扫描最近三天需要参与秒杀的活动</span></span>
<span class="line"><span style="color:#e1e4e8">    R r </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> couponFeignService.</span><span style="color:#b392f0">getLatest3DaySession</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (r.</span><span style="color:#b392f0">getCode</span><span style="color:#e1e4e8">() </span><span style="color:#f97583">==</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#6a737d">//远程调用成功，上架商品</span></span>
<span class="line"><span style="color:#e1e4e8">        List&lt;</span><span style="color:#f97583">SeckillSessionWithSkus</span><span style="color:#e1e4e8">&gt; sessionData </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> r.</span><span style="color:#b392f0">getData</span><span style="color:#e1e4e8">(</span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> TypeReference&lt;List&lt;</span><span style="color:#f97583">SeckillSessionWithSkus</span><span style="color:#e1e4e8">&gt;&gt;() {</span></span>
<span class="line"><span style="color:#e1e4e8">        });</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (sessionData </span><span style="color:#f97583">!=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">&amp;&amp;</span><span style="color:#e1e4e8"> sessionData.</span><span style="color:#b392f0">size</span><span style="color:#e1e4e8">() </span><span style="color:#f97583">&gt;</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#6a737d">//缓存到redis</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#6a737d">//1、缓存活动信息</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#b392f0">saveSessionInfos</span><span style="color:#e1e4e8">(sessionData);</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#6a737d">//2、缓存活动的关联商品信息</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#b392f0">saveSessionSkuInfos</span><span style="color:#e1e4e8">(sessionData);</span></span>
<span class="line"><span style="color:#e1e4e8">        }</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"><span style="color:#e1e4e8">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e">@</span><span style="color:#d73a49">Override</span></span>
<span class="line"><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">void</span><span style="color:#24292e"> </span><span style="color:#6f42c1">uploadSeckillSkuLatest3Days</span><span style="color:#24292e">() {</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">//1、扫描最近三天需要参与秒杀的活动</span></span>
<span class="line"><span style="color:#24292e">    R r </span><span style="color:#d73a49">=</span><span style="color:#24292e"> couponFeignService.</span><span style="color:#6f42c1">getLatest3DaySession</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (r.</span><span style="color:#6f42c1">getCode</span><span style="color:#24292e">() </span><span style="color:#d73a49">==</span><span style="color:#24292e"> </span><span style="color:#005cc5">0</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6a737d">//远程调用成功，上架商品</span></span>
<span class="line"><span style="color:#24292e">        List&lt;</span><span style="color:#d73a49">SeckillSessionWithSkus</span><span style="color:#24292e">&gt; sessionData </span><span style="color:#d73a49">=</span><span style="color:#24292e"> r.</span><span style="color:#6f42c1">getData</span><span style="color:#24292e">(</span><span style="color:#d73a49">new</span><span style="color:#24292e"> TypeReference&lt;List&lt;</span><span style="color:#d73a49">SeckillSessionWithSkus</span><span style="color:#24292e">&gt;&gt;() {</span></span>
<span class="line"><span style="color:#24292e">        });</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (sessionData </span><span style="color:#d73a49">!=</span><span style="color:#24292e"> </span><span style="color:#005cc5">null</span><span style="color:#24292e"> </span><span style="color:#d73a49">&amp;&amp;</span><span style="color:#24292e"> sessionData.</span><span style="color:#6f42c1">size</span><span style="color:#24292e">() </span><span style="color:#d73a49">&gt;</span><span style="color:#24292e"> </span><span style="color:#005cc5">0</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#6a737d">//缓存到redis</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#6a737d">//1、缓存活动信息</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#6f42c1">saveSessionInfos</span><span style="color:#24292e">(sessionData);</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#6a737d">//2、缓存活动的关联商品信息</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#6f42c1">saveSessionSkuInfos</span><span style="color:#24292e">(sessionData);</span></span>
<span class="line"><span style="color:#24292e">        }</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"><span style="color:#24292e">}</span></span></code></pre></div><h5 id="_1、缓存活动信息方法" tabindex="-1">1、缓存活动信息方法 <a aria-current="page" href="/posts/flash%20killing#_1、缓存活动信息方法" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h5><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#f97583">private</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">final</span><span style="color:#e1e4e8"> String SESSIONS_CACHE_PREFOX </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#9ecbff">"seckill:sessions:"</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">	</span><span style="color:#f97583">private</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">void</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">saveSessionInfos</span><span style="color:#e1e4e8">(List</span><span style="color:#f97583">&lt;</span><span style="color:#e1e4e8">SeckillSessionWithSkus</span><span style="color:#f97583">&gt;</span><span style="color:#e1e4e8"> sessions) {</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (sessions </span><span style="color:#f97583">!=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">&amp;&amp;</span><span style="color:#e1e4e8"> sessions.</span><span style="color:#b392f0">size</span><span style="color:#e1e4e8">() </span><span style="color:#f97583">&gt;</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">            sessions.</span><span style="color:#b392f0">stream</span><span style="color:#e1e4e8">().</span><span style="color:#b392f0">forEach</span><span style="color:#e1e4e8">(session </span><span style="color:#f97583">-&gt;</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#f97583">long</span><span style="color:#e1e4e8"> startTime </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> session.</span><span style="color:#b392f0">getStartTime</span><span style="color:#e1e4e8">().</span><span style="color:#b392f0">getTime</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#f97583">long</span><span style="color:#e1e4e8"> endTime </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> session.</span><span style="color:#b392f0">getEndTime</span><span style="color:#e1e4e8">().</span><span style="color:#b392f0">getTime</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">                String key </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> SESSIONS_CACHE_PREFOX </span><span style="color:#f97583">+</span><span style="color:#e1e4e8"> startTime </span><span style="color:#f97583">+</span><span style="color:#e1e4e8"> </span><span style="color:#9ecbff">"_"</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">+</span><span style="color:#e1e4e8"> endTime;</span></span>
<span class="line"><span style="color:#e1e4e8">                    </span><span style="color:#6a737d">//key不存在进行缓存操作</span></span>
<span class="line"><span style="color:#e1e4e8">                    List&lt;</span><span style="color:#f97583">String</span><span style="color:#e1e4e8">&gt; skuIds </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> session.</span><span style="color:#b392f0">getRelationSkus</span><span style="color:#e1e4e8">().</span><span style="color:#b392f0">stream</span><span style="color:#e1e4e8">().</span><span style="color:#b392f0">map</span><span style="color:#e1e4e8">(item </span><span style="color:#f97583">-&gt;</span><span style="color:#e1e4e8"> item.</span><span style="color:#b392f0">getPromotionSessionId</span><span style="color:#e1e4e8">().</span><span style="color:#b392f0">toString</span><span style="color:#e1e4e8">() </span><span style="color:#f97583">+</span><span style="color:#e1e4e8"> </span><span style="color:#9ecbff">"_"</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">+</span><span style="color:#e1e4e8"> item.</span><span style="color:#b392f0">getSkuId</span><span style="color:#e1e4e8">().</span><span style="color:#b392f0">toString</span><span style="color:#e1e4e8">()).</span><span style="color:#b392f0">collect</span><span style="color:#e1e4e8">(Collectors.</span><span style="color:#b392f0">toList</span><span style="color:#e1e4e8">());</span></span>
<span class="line"><span style="color:#e1e4e8">                    </span><span style="color:#6a737d">//缓存所有活动信息</span></span>
<span class="line"><span style="color:#e1e4e8">                    redisTemplate.</span><span style="color:#b392f0">opsForList</span><span style="color:#e1e4e8">().</span><span style="color:#b392f0">leftPushAll</span><span style="color:#e1e4e8">(key, skuIds);</span></span>
<span class="line"><span style="color:#e1e4e8">            });</span></span>
<span class="line"><span style="color:#e1e4e8">        }</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#d73a49">private</span><span style="color:#24292e"> </span><span style="color:#d73a49">final</span><span style="color:#24292e"> String SESSIONS_CACHE_PREFOX </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#032f62">"seckill:sessions:"</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">	</span><span style="color:#d73a49">private</span><span style="color:#24292e"> </span><span style="color:#d73a49">void</span><span style="color:#24292e"> </span><span style="color:#6f42c1">saveSessionInfos</span><span style="color:#24292e">(List</span><span style="color:#d73a49">&lt;</span><span style="color:#24292e">SeckillSessionWithSkus</span><span style="color:#d73a49">&gt;</span><span style="color:#24292e"> sessions) {</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (sessions </span><span style="color:#d73a49">!=</span><span style="color:#24292e"> </span><span style="color:#005cc5">null</span><span style="color:#24292e"> </span><span style="color:#d73a49">&amp;&amp;</span><span style="color:#24292e"> sessions.</span><span style="color:#6f42c1">size</span><span style="color:#24292e">() </span><span style="color:#d73a49">&gt;</span><span style="color:#24292e"> </span><span style="color:#005cc5">0</span><span style="color:#24292e">) {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">            sessions.</span><span style="color:#6f42c1">stream</span><span style="color:#24292e">().</span><span style="color:#6f42c1">forEach</span><span style="color:#24292e">(session </span><span style="color:#d73a49">-&gt;</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#d73a49">long</span><span style="color:#24292e"> startTime </span><span style="color:#d73a49">=</span><span style="color:#24292e"> session.</span><span style="color:#6f42c1">getStartTime</span><span style="color:#24292e">().</span><span style="color:#6f42c1">getTime</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#d73a49">long</span><span style="color:#24292e"> endTime </span><span style="color:#d73a49">=</span><span style="color:#24292e"> session.</span><span style="color:#6f42c1">getEndTime</span><span style="color:#24292e">().</span><span style="color:#6f42c1">getTime</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">                String key </span><span style="color:#d73a49">=</span><span style="color:#24292e"> SESSIONS_CACHE_PREFOX </span><span style="color:#d73a49">+</span><span style="color:#24292e"> startTime </span><span style="color:#d73a49">+</span><span style="color:#24292e"> </span><span style="color:#032f62">"_"</span><span style="color:#24292e"> </span><span style="color:#d73a49">+</span><span style="color:#24292e"> endTime;</span></span>
<span class="line"><span style="color:#24292e">                    </span><span style="color:#6a737d">//key不存在进行缓存操作</span></span>
<span class="line"><span style="color:#24292e">                    List&lt;</span><span style="color:#d73a49">String</span><span style="color:#24292e">&gt; skuIds </span><span style="color:#d73a49">=</span><span style="color:#24292e"> session.</span><span style="color:#6f42c1">getRelationSkus</span><span style="color:#24292e">().</span><span style="color:#6f42c1">stream</span><span style="color:#24292e">().</span><span style="color:#6f42c1">map</span><span style="color:#24292e">(item </span><span style="color:#d73a49">-&gt;</span><span style="color:#24292e"> item.</span><span style="color:#6f42c1">getPromotionSessionId</span><span style="color:#24292e">().</span><span style="color:#6f42c1">toString</span><span style="color:#24292e">() </span><span style="color:#d73a49">+</span><span style="color:#24292e"> </span><span style="color:#032f62">"_"</span><span style="color:#24292e"> </span><span style="color:#d73a49">+</span><span style="color:#24292e"> item.</span><span style="color:#6f42c1">getSkuId</span><span style="color:#24292e">().</span><span style="color:#6f42c1">toString</span><span style="color:#24292e">()).</span><span style="color:#6f42c1">collect</span><span style="color:#24292e">(Collectors.</span><span style="color:#6f42c1">toList</span><span style="color:#24292e">());</span></span>
<span class="line"><span style="color:#24292e">                    </span><span style="color:#6a737d">//缓存所有活动信息</span></span>
<span class="line"><span style="color:#24292e">                    redisTemplate.</span><span style="color:#6f42c1">opsForList</span><span style="color:#24292e">().</span><span style="color:#6f42c1">leftPushAll</span><span style="color:#24292e">(key, skuIds);</span></span>
<span class="line"><span style="color:#24292e">            });</span></span>
<span class="line"><span style="color:#24292e">        }</span></span>
<span class="line"><span style="color:#24292e">    }</span></span></code></pre></div><ul><li>sku的详细信息及秒杀活动场次信息数据传输to</li></ul><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6a737d">/**</span></span>
<span class="line"><span style="color:#6a737d"> * </span><span style="color:#f97583">@author</span><span style="color:#6a737d"> Klaus</span></span>
<span class="line"><span style="color:#6a737d"> * @date 2022/9/28</span></span>
<span class="line"><span style="color:#6a737d"> */</span></span>
<span class="line"><span style="color:#e1e4e8">@</span><span style="color:#f97583">Data</span></span>
<span class="line"><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">class</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">SeckillSkuRedisTo</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6a737d">    /**</span></span>
<span class="line"><span style="color:#6a737d">     * 活动id</span></span>
<span class="line"><span style="color:#6a737d">     */</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">private</span><span style="color:#e1e4e8"> Long promotionId;</span></span>
<span class="line"><span style="color:#6a737d">    /**</span></span>
<span class="line"><span style="color:#6a737d">     * 活动场次id</span></span>
<span class="line"><span style="color:#6a737d">     */</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">private</span><span style="color:#e1e4e8"> Long promotionSessionId;</span></span>
<span class="line"><span style="color:#6a737d">    /**</span></span>
<span class="line"><span style="color:#6a737d">     * 商品id</span></span>
<span class="line"><span style="color:#6a737d">     */</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">private</span><span style="color:#e1e4e8"> Long skuId;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6a737d">    /**</span></span>
<span class="line"><span style="color:#6a737d">     * 商品秒杀随机码</span></span>
<span class="line"><span style="color:#6a737d">     */</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">private</span><span style="color:#e1e4e8"> String randomCode;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6a737d">    /**</span></span>
<span class="line"><span style="color:#6a737d">     * 秒杀价格</span></span>
<span class="line"><span style="color:#6a737d">     */</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">private</span><span style="color:#e1e4e8"> BigDecimal seckillPrice;</span></span>
<span class="line"><span style="color:#6a737d">    /**</span></span>
<span class="line"><span style="color:#6a737d">     * 秒杀总量</span></span>
<span class="line"><span style="color:#6a737d">     */</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">private</span><span style="color:#e1e4e8"> BigDecimal seckillCount;</span></span>
<span class="line"><span style="color:#6a737d">    /**</span></span>
<span class="line"><span style="color:#6a737d">     * 每人限购数量</span></span>
<span class="line"><span style="color:#6a737d">     */</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">private</span><span style="color:#e1e4e8"> BigDecimal seckillLimit;</span></span>
<span class="line"><span style="color:#6a737d">    /**</span></span>
<span class="line"><span style="color:#6a737d">     * 排序</span></span>
<span class="line"><span style="color:#6a737d">     */</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">private</span><span style="color:#e1e4e8"> Integer seckillSort;</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#6a737d">    /**</span></span>
<span class="line"><span style="color:#6a737d">     * 当前商品秒杀的开始时间</span></span>
<span class="line"><span style="color:#6a737d">     */</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">private</span><span style="color:#e1e4e8"> Long startTime;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6a737d">    /**</span></span>
<span class="line"><span style="color:#6a737d">     * 当前商品秒杀的结束时间</span></span>
<span class="line"><span style="color:#6a737d">     */</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">private</span><span style="color:#e1e4e8"> Long endTime;</span></span>
<span class="line"><span style="color:#6a737d">    /**</span></span>
<span class="line"><span style="color:#6a737d">     * sku的详细信息</span></span>
<span class="line"><span style="color:#6a737d">     */</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">private</span><span style="color:#e1e4e8"> SkuInfoVo skuInfoVo;</span></span>
<span class="line"><span style="color:#e1e4e8">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6a737d">/**</span></span>
<span class="line"><span style="color:#6a737d"> * </span><span style="color:#d73a49">@author</span><span style="color:#6a737d"> Klaus</span></span>
<span class="line"><span style="color:#6a737d"> * @date 2022/9/28</span></span>
<span class="line"><span style="color:#6a737d"> */</span></span>
<span class="line"><span style="color:#24292e">@</span><span style="color:#d73a49">Data</span></span>
<span class="line"><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">class</span><span style="color:#24292e"> </span><span style="color:#6f42c1">SeckillSkuRedisTo</span><span style="color:#24292e"> {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6a737d">    /**</span></span>
<span class="line"><span style="color:#6a737d">     * 活动id</span></span>
<span class="line"><span style="color:#6a737d">     */</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">private</span><span style="color:#24292e"> Long promotionId;</span></span>
<span class="line"><span style="color:#6a737d">    /**</span></span>
<span class="line"><span style="color:#6a737d">     * 活动场次id</span></span>
<span class="line"><span style="color:#6a737d">     */</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">private</span><span style="color:#24292e"> Long promotionSessionId;</span></span>
<span class="line"><span style="color:#6a737d">    /**</span></span>
<span class="line"><span style="color:#6a737d">     * 商品id</span></span>
<span class="line"><span style="color:#6a737d">     */</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">private</span><span style="color:#24292e"> Long skuId;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6a737d">    /**</span></span>
<span class="line"><span style="color:#6a737d">     * 商品秒杀随机码</span></span>
<span class="line"><span style="color:#6a737d">     */</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">private</span><span style="color:#24292e"> String randomCode;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6a737d">    /**</span></span>
<span class="line"><span style="color:#6a737d">     * 秒杀价格</span></span>
<span class="line"><span style="color:#6a737d">     */</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">private</span><span style="color:#24292e"> BigDecimal seckillPrice;</span></span>
<span class="line"><span style="color:#6a737d">    /**</span></span>
<span class="line"><span style="color:#6a737d">     * 秒杀总量</span></span>
<span class="line"><span style="color:#6a737d">     */</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">private</span><span style="color:#24292e"> BigDecimal seckillCount;</span></span>
<span class="line"><span style="color:#6a737d">    /**</span></span>
<span class="line"><span style="color:#6a737d">     * 每人限购数量</span></span>
<span class="line"><span style="color:#6a737d">     */</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">private</span><span style="color:#24292e"> BigDecimal seckillLimit;</span></span>
<span class="line"><span style="color:#6a737d">    /**</span></span>
<span class="line"><span style="color:#6a737d">     * 排序</span></span>
<span class="line"><span style="color:#6a737d">     */</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">private</span><span style="color:#24292e"> Integer seckillSort;</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#6a737d">    /**</span></span>
<span class="line"><span style="color:#6a737d">     * 当前商品秒杀的开始时间</span></span>
<span class="line"><span style="color:#6a737d">     */</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">private</span><span style="color:#24292e"> Long startTime;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6a737d">    /**</span></span>
<span class="line"><span style="color:#6a737d">     * 当前商品秒杀的结束时间</span></span>
<span class="line"><span style="color:#6a737d">     */</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">private</span><span style="color:#24292e"> Long endTime;</span></span>
<span class="line"><span style="color:#6a737d">    /**</span></span>
<span class="line"><span style="color:#6a737d">     * sku的详细信息</span></span>
<span class="line"><span style="color:#6a737d">     */</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">private</span><span style="color:#24292e"> SkuInfoVo skuInfoVo;</span></span>
<span class="line"><span style="color:#24292e">}</span></span></code></pre></div><ul><li>sku的详细信息数据传输vo</li></ul><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6a737d">/**</span></span>
<span class="line"><span style="color:#6a737d"> * </span><span style="color:#f97583">@author</span><span style="color:#6a737d"> Klaus</span></span>
<span class="line"><span style="color:#6a737d"> * @date 2022/9/28</span></span>
<span class="line"><span style="color:#6a737d"> */</span></span>
<span class="line"><span style="color:#e1e4e8">@</span><span style="color:#f97583">Data</span></span>
<span class="line"><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">class</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">SkuInfoVo</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">private</span><span style="color:#e1e4e8"> Long skuId;</span></span>
<span class="line"><span style="color:#6a737d">    /**</span></span>
<span class="line"><span style="color:#6a737d">     * spuId</span></span>
<span class="line"><span style="color:#6a737d">     */</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">private</span><span style="color:#e1e4e8"> Long spuId;</span></span>
<span class="line"><span style="color:#6a737d">    /**</span></span>
<span class="line"><span style="color:#6a737d">     * sku名称</span></span>
<span class="line"><span style="color:#6a737d">     */</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">private</span><span style="color:#e1e4e8"> String skuName;</span></span>
<span class="line"><span style="color:#6a737d">    /**</span></span>
<span class="line"><span style="color:#6a737d">     * sku介绍描述</span></span>
<span class="line"><span style="color:#6a737d">     */</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">private</span><span style="color:#e1e4e8"> String skuDesc;</span></span>
<span class="line"><span style="color:#6a737d">    /**</span></span>
<span class="line"><span style="color:#6a737d">     * 所属分类id</span></span>
<span class="line"><span style="color:#6a737d">     */</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">private</span><span style="color:#e1e4e8"> Long catalogId;</span></span>
<span class="line"><span style="color:#6a737d">    /**</span></span>
<span class="line"><span style="color:#6a737d">     * 品牌id</span></span>
<span class="line"><span style="color:#6a737d">     */</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">private</span><span style="color:#e1e4e8"> Long brandId;</span></span>
<span class="line"><span style="color:#6a737d">    /**</span></span>
<span class="line"><span style="color:#6a737d">     * 默认图片</span></span>
<span class="line"><span style="color:#6a737d">     */</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">private</span><span style="color:#e1e4e8"> String skuDefaultImg;</span></span>
<span class="line"><span style="color:#6a737d">    /**</span></span>
<span class="line"><span style="color:#6a737d">     * 标题</span></span>
<span class="line"><span style="color:#6a737d">     */</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">private</span><span style="color:#e1e4e8"> String skuTitle;</span></span>
<span class="line"><span style="color:#6a737d">    /**</span></span>
<span class="line"><span style="color:#6a737d">     * 副标题</span></span>
<span class="line"><span style="color:#6a737d">     */</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">private</span><span style="color:#e1e4e8"> String skuSubtitle;</span></span>
<span class="line"><span style="color:#6a737d">    /**</span></span>
<span class="line"><span style="color:#6a737d">     * 价格</span></span>
<span class="line"><span style="color:#6a737d">     */</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">private</span><span style="color:#e1e4e8"> BigDecimal price;</span></span>
<span class="line"><span style="color:#6a737d">    /**</span></span>
<span class="line"><span style="color:#6a737d">     * 销量</span></span>
<span class="line"><span style="color:#6a737d">     */</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">private</span><span style="color:#e1e4e8"> Long saleCount;</span></span>
<span class="line"><span style="color:#e1e4e8">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6a737d">/**</span></span>
<span class="line"><span style="color:#6a737d"> * </span><span style="color:#d73a49">@author</span><span style="color:#6a737d"> Klaus</span></span>
<span class="line"><span style="color:#6a737d"> * @date 2022/9/28</span></span>
<span class="line"><span style="color:#6a737d"> */</span></span>
<span class="line"><span style="color:#24292e">@</span><span style="color:#d73a49">Data</span></span>
<span class="line"><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">class</span><span style="color:#24292e"> </span><span style="color:#6f42c1">SkuInfoVo</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">private</span><span style="color:#24292e"> Long skuId;</span></span>
<span class="line"><span style="color:#6a737d">    /**</span></span>
<span class="line"><span style="color:#6a737d">     * spuId</span></span>
<span class="line"><span style="color:#6a737d">     */</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">private</span><span style="color:#24292e"> Long spuId;</span></span>
<span class="line"><span style="color:#6a737d">    /**</span></span>
<span class="line"><span style="color:#6a737d">     * sku名称</span></span>
<span class="line"><span style="color:#6a737d">     */</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">private</span><span style="color:#24292e"> String skuName;</span></span>
<span class="line"><span style="color:#6a737d">    /**</span></span>
<span class="line"><span style="color:#6a737d">     * sku介绍描述</span></span>
<span class="line"><span style="color:#6a737d">     */</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">private</span><span style="color:#24292e"> String skuDesc;</span></span>
<span class="line"><span style="color:#6a737d">    /**</span></span>
<span class="line"><span style="color:#6a737d">     * 所属分类id</span></span>
<span class="line"><span style="color:#6a737d">     */</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">private</span><span style="color:#24292e"> Long catalogId;</span></span>
<span class="line"><span style="color:#6a737d">    /**</span></span>
<span class="line"><span style="color:#6a737d">     * 品牌id</span></span>
<span class="line"><span style="color:#6a737d">     */</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">private</span><span style="color:#24292e"> Long brandId;</span></span>
<span class="line"><span style="color:#6a737d">    /**</span></span>
<span class="line"><span style="color:#6a737d">     * 默认图片</span></span>
<span class="line"><span style="color:#6a737d">     */</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">private</span><span style="color:#24292e"> String skuDefaultImg;</span></span>
<span class="line"><span style="color:#6a737d">    /**</span></span>
<span class="line"><span style="color:#6a737d">     * 标题</span></span>
<span class="line"><span style="color:#6a737d">     */</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">private</span><span style="color:#24292e"> String skuTitle;</span></span>
<span class="line"><span style="color:#6a737d">    /**</span></span>
<span class="line"><span style="color:#6a737d">     * 副标题</span></span>
<span class="line"><span style="color:#6a737d">     */</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">private</span><span style="color:#24292e"> String skuSubtitle;</span></span>
<span class="line"><span style="color:#6a737d">    /**</span></span>
<span class="line"><span style="color:#6a737d">     * 价格</span></span>
<span class="line"><span style="color:#6a737d">     */</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">private</span><span style="color:#24292e"> BigDecimal price;</span></span>
<span class="line"><span style="color:#6a737d">    /**</span></span>
<span class="line"><span style="color:#6a737d">     * 销量</span></span>
<span class="line"><span style="color:#6a737d">     */</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">private</span><span style="color:#24292e"> Long saleCount;</span></span>
<span class="line"><span style="color:#24292e">}</span></span></code></pre></div><ul><li>远程获取sku详细信息</li></ul><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8">@</span><span style="color:#f97583">FeignClient</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"gulimall-product"</span><span style="color:#e1e4e8">)</span></span>
<span class="line"><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">interface</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">ProductFeignService</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">    @</span><span style="color:#f97583">RequestMapping</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"/product/skuinfo/info/{skuId}"</span><span style="color:#e1e4e8">)</span></span>
<span class="line"><span style="color:#e1e4e8">    R </span><span style="color:#b392f0">getSkuInfo</span><span style="color:#e1e4e8">(@</span><span style="color:#f97583">PathVariable</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"skuId"</span><span style="color:#e1e4e8">) Long </span><span style="color:#ffab70">skuId</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e">@</span><span style="color:#d73a49">FeignClient</span><span style="color:#24292e">(</span><span style="color:#032f62">"gulimall-product"</span><span style="color:#24292e">)</span></span>
<span class="line"><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">interface</span><span style="color:#24292e"> </span><span style="color:#6f42c1">ProductFeignService</span><span style="color:#24292e"> {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">    @</span><span style="color:#d73a49">RequestMapping</span><span style="color:#24292e">(</span><span style="color:#032f62">"/product/skuinfo/info/{skuId}"</span><span style="color:#24292e">)</span></span>
<span class="line"><span style="color:#24292e">    R </span><span style="color:#6f42c1">getSkuInfo</span><span style="color:#24292e">(@</span><span style="color:#d73a49">PathVariable</span><span style="color:#24292e">(</span><span style="color:#032f62">"skuId"</span><span style="color:#24292e">) Long </span><span style="color:#e36209">skuId</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">}</span></span></code></pre></div><ul><li>获取sku详细信息接口</li></ul><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6a737d">/**</span></span>
<span class="line"><span style="color:#6a737d">   * 信息</span></span>
<span class="line"><span style="color:#6a737d">   */</span></span>
<span class="line"><span style="color:#e1e4e8">  @</span><span style="color:#f97583">RequestMapping</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"/info/{skuId}"</span><span style="color:#e1e4e8">)</span></span>
<span class="line"><span style="color:#e1e4e8">  </span><span style="color:#6a737d">//@RequiresPermissions("product:skuinfo:info")</span></span>
<span class="line"><span style="color:#e1e4e8">  </span><span style="color:#f97583">public</span><span style="color:#e1e4e8"> R </span><span style="color:#b392f0">info</span><span style="color:#e1e4e8">(@</span><span style="color:#f97583">PathVariable</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"skuId"</span><span style="color:#e1e4e8">) Long skuId){</span></span>
<span class="line"><span style="color:#e1e4e8">SkuInfoEntity skuInfo </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> skuInfoService.</span><span style="color:#b392f0">getById</span><span style="color:#e1e4e8">(skuId);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">      </span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> R.</span><span style="color:#b392f0">ok</span><span style="color:#e1e4e8">().</span><span style="color:#b392f0">put</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"skuInfo"</span><span style="color:#e1e4e8">, skuInfo);</span></span>
<span class="line"><span style="color:#e1e4e8">  }</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6a737d">/**</span></span>
<span class="line"><span style="color:#6a737d">   * 信息</span></span>
<span class="line"><span style="color:#6a737d">   */</span></span>
<span class="line"><span style="color:#24292e">  @</span><span style="color:#d73a49">RequestMapping</span><span style="color:#24292e">(</span><span style="color:#032f62">"/info/{skuId}"</span><span style="color:#24292e">)</span></span>
<span class="line"><span style="color:#24292e">  </span><span style="color:#6a737d">//@RequiresPermissions("product:skuinfo:info")</span></span>
<span class="line"><span style="color:#24292e">  </span><span style="color:#d73a49">public</span><span style="color:#24292e"> R </span><span style="color:#6f42c1">info</span><span style="color:#24292e">(@</span><span style="color:#d73a49">PathVariable</span><span style="color:#24292e">(</span><span style="color:#032f62">"skuId"</span><span style="color:#24292e">) Long skuId){</span></span>
<span class="line"><span style="color:#24292e">SkuInfoEntity skuInfo </span><span style="color:#d73a49">=</span><span style="color:#24292e"> skuInfoService.</span><span style="color:#6f42c1">getById</span><span style="color:#24292e">(skuId);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">      </span><span style="color:#d73a49">return</span><span style="color:#24292e"> R.</span><span style="color:#6f42c1">ok</span><span style="color:#24292e">().</span><span style="color:#6f42c1">put</span><span style="color:#24292e">(</span><span style="color:#032f62">"skuInfo"</span><span style="color:#24292e">, skuInfo);</span></span>
<span class="line"><span style="color:#24292e">  }</span></span></code></pre></div><h5 id="_2、缓存活动的关联商品信息" tabindex="-1">2、缓存活动的关联商品信息 <a aria-current="page" href="/posts/flash%20killing#_2、缓存活动的关联商品信息" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h5><ul><li>引入redisson依赖使用分布式信号量</li></ul><div class="language-xml"><button title="Copy Code" class="copy"></button><span class="lang">xml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6a737d">&lt;!--以后使用redisson作为所有分布式锁，分布式对象等功能框架 --&gt;</span></span>
<span class="line"><span style="color:#e1e4e8">&lt;</span><span style="color:#85e89d">dependency</span><span style="color:#e1e4e8">&gt;</span></span>
<span class="line"><span style="color:#e1e4e8">    &lt;</span><span style="color:#85e89d">groupId</span><span style="color:#e1e4e8">&gt;org.redisson&lt;/</span><span style="color:#85e89d">groupId</span><span style="color:#e1e4e8">&gt;</span></span>
<span class="line"><span style="color:#e1e4e8">    &lt;</span><span style="color:#85e89d">artifactId</span><span style="color:#e1e4e8">&gt;redisson&lt;/</span><span style="color:#85e89d">artifactId</span><span style="color:#e1e4e8">&gt;</span></span>
<span class="line"><span style="color:#e1e4e8">    &lt;</span><span style="color:#85e89d">version</span><span style="color:#e1e4e8">&gt;3.12.0&lt;/</span><span style="color:#85e89d">version</span><span style="color:#e1e4e8">&gt;</span></span>
<span class="line"><span style="color:#e1e4e8">&lt;/</span><span style="color:#85e89d">dependency</span><span style="color:#e1e4e8">&gt;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6a737d">&lt;!--以后使用redisson作为所有分布式锁，分布式对象等功能框架 --&gt;</span></span>
<span class="line"><span style="color:#24292e">&lt;</span><span style="color:#22863a">dependency</span><span style="color:#24292e">&gt;</span></span>
<span class="line"><span style="color:#24292e">    &lt;</span><span style="color:#22863a">groupId</span><span style="color:#24292e">&gt;org.redisson&lt;/</span><span style="color:#22863a">groupId</span><span style="color:#24292e">&gt;</span></span>
<span class="line"><span style="color:#24292e">    &lt;</span><span style="color:#22863a">artifactId</span><span style="color:#24292e">&gt;redisson&lt;/</span><span style="color:#22863a">artifactId</span><span style="color:#24292e">&gt;</span></span>
<span class="line"><span style="color:#24292e">    &lt;</span><span style="color:#22863a">version</span><span style="color:#24292e">&gt;3.12.0&lt;/</span><span style="color:#22863a">version</span><span style="color:#24292e">&gt;</span></span>
<span class="line"><span style="color:#24292e">&lt;/</span><span style="color:#22863a">dependency</span><span style="color:#24292e">&gt;</span></span></code></pre></div><ul><li>相关配置</li></ul><div class="language-properties"><button title="Copy Code" class="copy"></button><span class="lang">properties</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#f97583">spring.redis.host</span><span style="color:#e1e4e8">=192.168.10.103</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#d73a49">spring.redis.host</span><span style="color:#24292e">=192.168.10.103</span></span></code></pre></div><ul><li>配置类</li></ul><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6a737d">/**</span></span>
<span class="line"><span style="color:#6a737d"> * </span><span style="color:#f97583">@author</span><span style="color:#6a737d"> Klaus</span></span>
<span class="line"><span style="color:#6a737d"> * @date 2022/9/7</span></span>
<span class="line"><span style="color:#6a737d"> */</span></span>
<span class="line"><span style="color:#e1e4e8">@</span><span style="color:#f97583">Configuration</span></span>
<span class="line"><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">class</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">MyRedissonConfig</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6a737d">    /**</span></span>
<span class="line"><span style="color:#6a737d">     * 所有对Redisson的使用都是通过RedissonClient对象</span></span>
<span class="line"><span style="color:#6a737d">     * </span><span style="color:#f97583">@return</span></span>
<span class="line"><span style="color:#6a737d">     * </span><span style="color:#f97583">@throws</span><span style="color:#6a737d"> </span><span style="color:#b392f0">IOException</span></span>
<span class="line"><span style="color:#6a737d">     */</span></span>
<span class="line"><span style="color:#e1e4e8">    @</span><span style="color:#f97583">Bean</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">destroyMethod</span><span style="color:#f97583">=</span><span style="color:#9ecbff">"shutdown"</span><span style="color:#e1e4e8">)</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">public</span><span style="color:#e1e4e8"> RedissonClient </span><span style="color:#b392f0">redisson</span><span style="color:#e1e4e8">() </span><span style="color:#f97583">throws</span><span style="color:#e1e4e8"> IOException {</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#6a737d">//1、创建配置</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#6a737d">//Redis url should start with redis:// or rediss://</span></span>
<span class="line"><span style="color:#e1e4e8">        Config config </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Config</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">        config.</span><span style="color:#b392f0">useSingleServer</span><span style="color:#e1e4e8">().</span><span style="color:#b392f0">setAddress</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"redis://192.168.10.103:6379"</span><span style="color:#e1e4e8">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#6a737d">//2、根据config创建出Redisson实例</span></span>
<span class="line"><span style="color:#e1e4e8">        RedissonClient redissonClient </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> Redisson.</span><span style="color:#b392f0">create</span><span style="color:#e1e4e8">(config);</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> redissonClient;</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"><span style="color:#e1e4e8">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6a737d">/**</span></span>
<span class="line"><span style="color:#6a737d"> * </span><span style="color:#d73a49">@author</span><span style="color:#6a737d"> Klaus</span></span>
<span class="line"><span style="color:#6a737d"> * @date 2022/9/7</span></span>
<span class="line"><span style="color:#6a737d"> */</span></span>
<span class="line"><span style="color:#24292e">@</span><span style="color:#d73a49">Configuration</span></span>
<span class="line"><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">class</span><span style="color:#24292e"> </span><span style="color:#6f42c1">MyRedissonConfig</span><span style="color:#24292e"> {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6a737d">    /**</span></span>
<span class="line"><span style="color:#6a737d">     * 所有对Redisson的使用都是通过RedissonClient对象</span></span>
<span class="line"><span style="color:#6a737d">     * </span><span style="color:#d73a49">@return</span></span>
<span class="line"><span style="color:#6a737d">     * </span><span style="color:#d73a49">@throws</span><span style="color:#6a737d"> </span><span style="color:#6f42c1">IOException</span></span>
<span class="line"><span style="color:#6a737d">     */</span></span>
<span class="line"><span style="color:#24292e">    @</span><span style="color:#d73a49">Bean</span><span style="color:#24292e">(</span><span style="color:#005cc5">destroyMethod</span><span style="color:#d73a49">=</span><span style="color:#032f62">"shutdown"</span><span style="color:#24292e">)</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">public</span><span style="color:#24292e"> RedissonClient </span><span style="color:#6f42c1">redisson</span><span style="color:#24292e">() </span><span style="color:#d73a49">throws</span><span style="color:#24292e"> IOException {</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6a737d">//1、创建配置</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6a737d">//Redis url should start with redis:// or rediss://</span></span>
<span class="line"><span style="color:#24292e">        Config config </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Config</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">        config.</span><span style="color:#6f42c1">useSingleServer</span><span style="color:#24292e">().</span><span style="color:#6f42c1">setAddress</span><span style="color:#24292e">(</span><span style="color:#032f62">"redis://192.168.10.103:6379"</span><span style="color:#24292e">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6a737d">//2、根据config创建出Redisson实例</span></span>
<span class="line"><span style="color:#24292e">        RedissonClient redissonClient </span><span style="color:#d73a49">=</span><span style="color:#24292e"> Redisson.</span><span style="color:#6f42c1">create</span><span style="color:#24292e">(config);</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">return</span><span style="color:#24292e"> redissonClient;</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"><span style="color:#24292e">}</span></span></code></pre></div><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#f97583">private</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">final</span><span style="color:#e1e4e8"> String SKUKILL_CACHE_PREFOX </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#9ecbff">"seckill:skus:"</span><span style="color:#e1e4e8">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#f97583">private</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">final</span><span style="color:#e1e4e8"> String SKU_STOCK_SEMAPHORE </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#9ecbff">"seckill:stock:"</span><span style="color:#e1e4e8">;</span><span style="color:#6a737d">//+商品随机码</span></span>
<span class="line"><span style="color:#f97583">private</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">void</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">saveSessionSkuInfos</span><span style="color:#e1e4e8">(List</span><span style="color:#f97583">&lt;</span><span style="color:#e1e4e8">SeckillSessionWithSkus</span><span style="color:#f97583">&gt;</span><span style="color:#e1e4e8"> sessions) {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">//准备hash操作</span></span>
<span class="line"><span style="color:#e1e4e8">    BoundHashOperations&lt;</span><span style="color:#f97583">String</span><span style="color:#e1e4e8">, </span><span style="color:#f97583">Object</span><span style="color:#e1e4e8">, </span><span style="color:#f97583">Object</span><span style="color:#e1e4e8">&gt; ops </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> redisTemplate.</span><span style="color:#b392f0">boundHashOps</span><span style="color:#e1e4e8">(SKUKILL_CACHE_PREFOX);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (sessions </span><span style="color:#f97583">!=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">&amp;&amp;</span><span style="color:#e1e4e8"> sessions.</span><span style="color:#b392f0">size</span><span style="color:#e1e4e8">() </span><span style="color:#f97583">&gt;</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">        sessions.</span><span style="color:#b392f0">stream</span><span style="color:#e1e4e8">().</span><span style="color:#b392f0">forEach</span><span style="color:#e1e4e8">(session </span><span style="color:#f97583">-&gt;</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">            String token </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> UUID.</span><span style="color:#b392f0">randomUUID</span><span style="color:#e1e4e8">().</span><span style="color:#b392f0">toString</span><span style="color:#e1e4e8">().</span><span style="color:#b392f0">replace</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"-"</span><span style="color:#e1e4e8">, </span><span style="color:#9ecbff">""</span><span style="color:#e1e4e8">);</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">            session.</span><span style="color:#b392f0">getRelationSkus</span><span style="color:#e1e4e8">().</span><span style="color:#b392f0">stream</span><span style="color:#e1e4e8">().</span><span style="color:#b392f0">forEach</span><span style="color:#e1e4e8">(seckillSkuVo </span><span style="color:#f97583">-&gt;</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">                    </span><span style="color:#6a737d">//key不存在进行缓存商品</span></span>
<span class="line"><span style="color:#e1e4e8">                    SeckillSkuRedisTo redisTo </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">SeckillSkuRedisTo</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">                    </span><span style="color:#6a737d">//1、sku的基本数据</span></span>
<span class="line"><span style="color:#e1e4e8">                    R r </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> productFeignService.</span><span style="color:#b392f0">getSkuInfo</span><span style="color:#e1e4e8">(seckillSkuVo.</span><span style="color:#b392f0">getSkuId</span><span style="color:#e1e4e8">());</span></span>
<span class="line"><span style="color:#e1e4e8">                    </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (r.</span><span style="color:#b392f0">getCode</span><span style="color:#e1e4e8">() </span><span style="color:#f97583">==</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">                        </span><span style="color:#6a737d">//远程调用成功</span></span>
<span class="line"><span style="color:#e1e4e8">                        SkuInfoVo skuInfo </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> r.</span><span style="color:#b392f0">getData</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"skuInfo"</span><span style="color:#e1e4e8">, </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> TypeReference&lt;</span><span style="color:#f97583">SkuInfoVo</span><span style="color:#e1e4e8">&gt;() {</span></span>
<span class="line"><span style="color:#e1e4e8">                        });</span></span>
<span class="line"><span style="color:#e1e4e8">                        redisTo.</span><span style="color:#b392f0">setSkuInfoVo</span><span style="color:#e1e4e8">(skuInfo);</span></span>
<span class="line"><span style="color:#e1e4e8">                    }</span></span>
<span class="line"><span style="color:#e1e4e8">                    </span><span style="color:#6a737d">//2、sku的秒杀信息</span></span>
<span class="line"><span style="color:#e1e4e8">                    BeanUtils.</span><span style="color:#b392f0">copyProperties</span><span style="color:#e1e4e8">(seckillSkuVo, redisTo);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">                    </span><span style="color:#6a737d">//3、设置上当前商品的秒杀时间信息</span></span>
<span class="line"><span style="color:#e1e4e8">                    redisTo.</span><span style="color:#b392f0">setStartTime</span><span style="color:#e1e4e8">(session.</span><span style="color:#b392f0">getStartTime</span><span style="color:#e1e4e8">().</span><span style="color:#b392f0">getTime</span><span style="color:#e1e4e8">());</span></span>
<span class="line"><span style="color:#e1e4e8">                    redisTo.</span><span style="color:#b392f0">setEndTime</span><span style="color:#e1e4e8">(session.</span><span style="color:#b392f0">getEndTime</span><span style="color:#e1e4e8">().</span><span style="color:#b392f0">getTime</span><span style="color:#e1e4e8">());</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">                    </span><span style="color:#6a737d">//4、随机码   seckill?skuId=1&amp;key=fewqfwrgvrw</span></span>
<span class="line"><span style="color:#e1e4e8">                    redisTo.</span><span style="color:#b392f0">setRandomCode</span><span style="color:#e1e4e8">(token);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">                    String jsonString </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> JSON.</span><span style="color:#b392f0">toJSONString</span><span style="color:#e1e4e8">(redisTo);</span></span>
<span class="line"><span style="color:#e1e4e8">                    ops.</span><span style="color:#b392f0">put</span><span style="color:#e1e4e8">(seckillSkuVo.</span><span style="color:#b392f0">getPromotionSessionId</span><span style="color:#e1e4e8">().</span><span style="color:#b392f0">toString</span><span style="color:#e1e4e8">() </span><span style="color:#f97583">+</span><span style="color:#e1e4e8"> </span><span style="color:#9ecbff">"_"</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">+</span><span style="color:#e1e4e8"> seckillSkuVo.</span><span style="color:#b392f0">getSkuId</span><span style="color:#e1e4e8">().</span><span style="color:#b392f0">toString</span><span style="color:#e1e4e8">(), jsonString);</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">                    </span><span style="color:#6a737d">//秒杀请求进来先获取信号量，获取不到就无法执行数据库的所有方法了</span></span>
<span class="line"><span style="color:#e1e4e8">                    </span><span style="color:#6a737d">//如果当前这个场次的商品的库存信息已经上架就不需要上架</span></span>
<span class="line"><span style="color:#e1e4e8">                    </span><span style="color:#6a737d">//5、使用库存作为分布式的信号量 -&gt; 限流；</span></span>
<span class="line"><span style="color:#e1e4e8">                    RSemaphore semaphore </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> redissonClient.</span><span style="color:#b392f0">getSemaphore</span><span style="color:#e1e4e8">(SKU_STOCK_SEMAPHORE </span><span style="color:#f97583">+</span><span style="color:#e1e4e8"> token);</span></span>
<span class="line"><span style="color:#e1e4e8">                    </span><span style="color:#6a737d">//商品可以秒杀的数量作为信号量</span></span>
<span class="line"><span style="color:#e1e4e8">                    semaphore.</span><span style="color:#b392f0">trySetPermits</span><span style="color:#e1e4e8">(seckillSkuVo.</span><span style="color:#b392f0">getSeckillCount</span><span style="color:#e1e4e8">().</span><span style="color:#b392f0">intValue</span><span style="color:#e1e4e8">());</span></span>
<span class="line"><span style="color:#e1e4e8">                </span></span>
<span class="line"><span style="color:#e1e4e8">            });</span></span>
<span class="line"><span style="color:#e1e4e8">        });</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"><span style="color:#e1e4e8">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#d73a49">private</span><span style="color:#24292e"> </span><span style="color:#d73a49">final</span><span style="color:#24292e"> String SKUKILL_CACHE_PREFOX </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#032f62">"seckill:skus:"</span><span style="color:#24292e">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#d73a49">private</span><span style="color:#24292e"> </span><span style="color:#d73a49">final</span><span style="color:#24292e"> String SKU_STOCK_SEMAPHORE </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#032f62">"seckill:stock:"</span><span style="color:#24292e">;</span><span style="color:#6a737d">//+商品随机码</span></span>
<span class="line"><span style="color:#d73a49">private</span><span style="color:#24292e"> </span><span style="color:#d73a49">void</span><span style="color:#24292e"> </span><span style="color:#6f42c1">saveSessionSkuInfos</span><span style="color:#24292e">(List</span><span style="color:#d73a49">&lt;</span><span style="color:#24292e">SeckillSessionWithSkus</span><span style="color:#d73a49">&gt;</span><span style="color:#24292e"> sessions) {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">//准备hash操作</span></span>
<span class="line"><span style="color:#24292e">    BoundHashOperations&lt;</span><span style="color:#d73a49">String</span><span style="color:#24292e">, </span><span style="color:#d73a49">Object</span><span style="color:#24292e">, </span><span style="color:#d73a49">Object</span><span style="color:#24292e">&gt; ops </span><span style="color:#d73a49">=</span><span style="color:#24292e"> redisTemplate.</span><span style="color:#6f42c1">boundHashOps</span><span style="color:#24292e">(SKUKILL_CACHE_PREFOX);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (sessions </span><span style="color:#d73a49">!=</span><span style="color:#24292e"> </span><span style="color:#005cc5">null</span><span style="color:#24292e"> </span><span style="color:#d73a49">&amp;&amp;</span><span style="color:#24292e"> sessions.</span><span style="color:#6f42c1">size</span><span style="color:#24292e">() </span><span style="color:#d73a49">&gt;</span><span style="color:#24292e"> </span><span style="color:#005cc5">0</span><span style="color:#24292e">) {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">        sessions.</span><span style="color:#6f42c1">stream</span><span style="color:#24292e">().</span><span style="color:#6f42c1">forEach</span><span style="color:#24292e">(session </span><span style="color:#d73a49">-&gt;</span><span style="color:#24292e"> {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">            String token </span><span style="color:#d73a49">=</span><span style="color:#24292e"> UUID.</span><span style="color:#6f42c1">randomUUID</span><span style="color:#24292e">().</span><span style="color:#6f42c1">toString</span><span style="color:#24292e">().</span><span style="color:#6f42c1">replace</span><span style="color:#24292e">(</span><span style="color:#032f62">"-"</span><span style="color:#24292e">, </span><span style="color:#032f62">""</span><span style="color:#24292e">);</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">            session.</span><span style="color:#6f42c1">getRelationSkus</span><span style="color:#24292e">().</span><span style="color:#6f42c1">stream</span><span style="color:#24292e">().</span><span style="color:#6f42c1">forEach</span><span style="color:#24292e">(seckillSkuVo </span><span style="color:#d73a49">-&gt;</span><span style="color:#24292e"> {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">                    </span><span style="color:#6a737d">//key不存在进行缓存商品</span></span>
<span class="line"><span style="color:#24292e">                    SeckillSkuRedisTo redisTo </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">SeckillSkuRedisTo</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">                    </span><span style="color:#6a737d">//1、sku的基本数据</span></span>
<span class="line"><span style="color:#24292e">                    R r </span><span style="color:#d73a49">=</span><span style="color:#24292e"> productFeignService.</span><span style="color:#6f42c1">getSkuInfo</span><span style="color:#24292e">(seckillSkuVo.</span><span style="color:#6f42c1">getSkuId</span><span style="color:#24292e">());</span></span>
<span class="line"><span style="color:#24292e">                    </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (r.</span><span style="color:#6f42c1">getCode</span><span style="color:#24292e">() </span><span style="color:#d73a49">==</span><span style="color:#24292e"> </span><span style="color:#005cc5">0</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">                        </span><span style="color:#6a737d">//远程调用成功</span></span>
<span class="line"><span style="color:#24292e">                        SkuInfoVo skuInfo </span><span style="color:#d73a49">=</span><span style="color:#24292e"> r.</span><span style="color:#6f42c1">getData</span><span style="color:#24292e">(</span><span style="color:#032f62">"skuInfo"</span><span style="color:#24292e">, </span><span style="color:#d73a49">new</span><span style="color:#24292e"> TypeReference&lt;</span><span style="color:#d73a49">SkuInfoVo</span><span style="color:#24292e">&gt;() {</span></span>
<span class="line"><span style="color:#24292e">                        });</span></span>
<span class="line"><span style="color:#24292e">                        redisTo.</span><span style="color:#6f42c1">setSkuInfoVo</span><span style="color:#24292e">(skuInfo);</span></span>
<span class="line"><span style="color:#24292e">                    }</span></span>
<span class="line"><span style="color:#24292e">                    </span><span style="color:#6a737d">//2、sku的秒杀信息</span></span>
<span class="line"><span style="color:#24292e">                    BeanUtils.</span><span style="color:#6f42c1">copyProperties</span><span style="color:#24292e">(seckillSkuVo, redisTo);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">                    </span><span style="color:#6a737d">//3、设置上当前商品的秒杀时间信息</span></span>
<span class="line"><span style="color:#24292e">                    redisTo.</span><span style="color:#6f42c1">setStartTime</span><span style="color:#24292e">(session.</span><span style="color:#6f42c1">getStartTime</span><span style="color:#24292e">().</span><span style="color:#6f42c1">getTime</span><span style="color:#24292e">());</span></span>
<span class="line"><span style="color:#24292e">                    redisTo.</span><span style="color:#6f42c1">setEndTime</span><span style="color:#24292e">(session.</span><span style="color:#6f42c1">getEndTime</span><span style="color:#24292e">().</span><span style="color:#6f42c1">getTime</span><span style="color:#24292e">());</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">                    </span><span style="color:#6a737d">//4、随机码   seckill?skuId=1&amp;key=fewqfwrgvrw</span></span>
<span class="line"><span style="color:#24292e">                    redisTo.</span><span style="color:#6f42c1">setRandomCode</span><span style="color:#24292e">(token);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">                    String jsonString </span><span style="color:#d73a49">=</span><span style="color:#24292e"> JSON.</span><span style="color:#6f42c1">toJSONString</span><span style="color:#24292e">(redisTo);</span></span>
<span class="line"><span style="color:#24292e">                    ops.</span><span style="color:#6f42c1">put</span><span style="color:#24292e">(seckillSkuVo.</span><span style="color:#6f42c1">getPromotionSessionId</span><span style="color:#24292e">().</span><span style="color:#6f42c1">toString</span><span style="color:#24292e">() </span><span style="color:#d73a49">+</span><span style="color:#24292e"> </span><span style="color:#032f62">"_"</span><span style="color:#24292e"> </span><span style="color:#d73a49">+</span><span style="color:#24292e"> seckillSkuVo.</span><span style="color:#6f42c1">getSkuId</span><span style="color:#24292e">().</span><span style="color:#6f42c1">toString</span><span style="color:#24292e">(), jsonString);</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">                    </span><span style="color:#6a737d">//秒杀请求进来先获取信号量，获取不到就无法执行数据库的所有方法了</span></span>
<span class="line"><span style="color:#24292e">                    </span><span style="color:#6a737d">//如果当前这个场次的商品的库存信息已经上架就不需要上架</span></span>
<span class="line"><span style="color:#24292e">                    </span><span style="color:#6a737d">//5、使用库存作为分布式的信号量 -&gt; 限流；</span></span>
<span class="line"><span style="color:#24292e">                    RSemaphore semaphore </span><span style="color:#d73a49">=</span><span style="color:#24292e"> redissonClient.</span><span style="color:#6f42c1">getSemaphore</span><span style="color:#24292e">(SKU_STOCK_SEMAPHORE </span><span style="color:#d73a49">+</span><span style="color:#24292e"> token);</span></span>
<span class="line"><span style="color:#24292e">                    </span><span style="color:#6a737d">//商品可以秒杀的数量作为信号量</span></span>
<span class="line"><span style="color:#24292e">                    semaphore.</span><span style="color:#6f42c1">trySetPermits</span><span style="color:#24292e">(seckillSkuVo.</span><span style="color:#6f42c1">getSeckillCount</span><span style="color:#24292e">().</span><span style="color:#6f42c1">intValue</span><span style="color:#24292e">());</span></span>
<span class="line"><span style="color:#24292e">                </span></span>
<span class="line"><span style="color:#24292e">            });</span></span>
<span class="line"><span style="color:#24292e">        });</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"><span style="color:#24292e">}</span></span></code></pre></div><ul><li>修改上架时间</li></ul><figure><img src="https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230430145943910.png" alt="image-20230430145943910" loading="lazy" decoding="async"></figure><figure><img src="https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230430150003699.png" alt="image-20230430150003699" loading="lazy" decoding="async"></figure><ul><li>未做幂等性处理出现重复上架情况</li></ul><figure><img src="https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230430150132974.png" alt="image-20230430150132974" loading="lazy" decoding="async"></figure><ul><li>活动信息收集的是我们的skuId不是活动记录id</li></ul><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8">List&lt;</span><span style="color:#f97583">String</span><span style="color:#e1e4e8">&gt; skuIds </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> session.</span><span style="color:#b392f0">getRelationSkus</span><span style="color:#e1e4e8">().</span><span style="color:#b392f0">stream</span><span style="color:#e1e4e8">().</span><span style="color:#b392f0">map</span><span style="color:#e1e4e8">(item </span><span style="color:#f97583">-&gt;</span><span style="color:#e1e4e8"> item.</span><span style="color:#b392f0">getSkuId</span><span style="color:#e1e4e8">().</span><span style="color:#b392f0">toString</span><span style="color:#e1e4e8">()).</span><span style="color:#b392f0">collect</span><span style="color:#e1e4e8">(Collectors.</span><span style="color:#b392f0">toList</span><span style="color:#e1e4e8">());</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e">List&lt;</span><span style="color:#d73a49">String</span><span style="color:#24292e">&gt; skuIds </span><span style="color:#d73a49">=</span><span style="color:#24292e"> session.</span><span style="color:#6f42c1">getRelationSkus</span><span style="color:#24292e">().</span><span style="color:#6f42c1">stream</span><span style="color:#24292e">().</span><span style="color:#6f42c1">map</span><span style="color:#24292e">(item </span><span style="color:#d73a49">-&gt;</span><span style="color:#24292e"> item.</span><span style="color:#6f42c1">getSkuId</span><span style="color:#24292e">().</span><span style="color:#6f42c1">toString</span><span style="color:#24292e">()).</span><span style="color:#6f42c1">collect</span><span style="color:#24292e">(Collectors.</span><span style="color:#6f42c1">toList</span><span style="color:#24292e">());</span></span></code></pre></div><figure><img src="https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230430150728958.png" alt="image-20230430150728958" loading="lazy" decoding="async"></figure><ul><li>活动的关联商品信息key也为skuId</li></ul><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8">ops.</span><span style="color:#b392f0">put</span><span style="color:#e1e4e8">(seckillSkuVo.</span><span style="color:#b392f0">getSkuId</span><span style="color:#e1e4e8">().</span><span style="color:#b392f0">toString</span><span style="color:#e1e4e8">(), jsonString);</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e">ops.</span><span style="color:#6f42c1">put</span><span style="color:#24292e">(seckillSkuVo.</span><span style="color:#6f42c1">getSkuId</span><span style="color:#24292e">().</span><span style="color:#6f42c1">toString</span><span style="color:#24292e">(), jsonString);</span></span></code></pre></div><h4 id="分布式定时任务" tabindex="-1">分布式定时任务 <a aria-current="page" href="/posts/flash%20killing#分布式定时任务" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h4><h5 id="_1-定时任务的问题" tabindex="-1">1.定时任务的问题 <a aria-current="page" href="/posts/flash%20killing#_1-定时任务的问题" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h5><figure><img src="https://jsd.cdn.zzko.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230429224924881.png" alt="image-20230429224924881" loading="lazy" decoding="async"></figure><ul><li><p>1）、同时执行导致的重复</p><ul><li>由于同样的服务会部署多个节点，多个节点的定时任务代码可能同时启动。将同样的事情做了多次使用分布式锁。</li></ul></li><li><p>2）、任务拆分并发执行</p><ul><li>使用 ElasticJob</li></ul></li></ul><h5 id="_2-扩展-分布式调整" tabindex="-1">2.扩展 - 分布式调整 <a aria-current="page" href="/posts/flash%20killing#_2-扩展-分布式调整" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h5><p><a target="_blank" rel="noreferrer" href="http://elasticjob.io/docs/elastic-job-cloud/00-overview/"><!--[-->http://elasticjob.io/docs/elastic-job-cloud/00-overview/<!--]--><!----></a></p><h4 id="_3-3-幂等性保证" tabindex="-1">3.3 幂等性保证 <a aria-current="page" href="/posts/flash%20killing#_3-3-幂等性保证" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h4><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6a737d">/**</span></span>
<span class="line"><span style="color:#6a737d"> *  * 秒杀商品的定时上架；</span></span>
<span class="line"><span style="color:#6a737d"> *  *      每天晚上3点；上架最近三天需要秒杀的商品</span></span>
<span class="line"><span style="color:#6a737d"> *  *      当天00:00:00 - 23:59:59</span></span>
<span class="line"><span style="color:#6a737d"> *  *      明天天00:00:00 - 23:59:59</span></span>
<span class="line"><span style="color:#6a737d"> *  *      后天00:00:00 - 23:59:59</span></span>
<span class="line"><span style="color:#6a737d"> * </span><span style="color:#f97583">@author</span><span style="color:#6a737d"> Klaus</span></span>
<span class="line"><span style="color:#6a737d"> * @date 2022/9/27</span></span>
<span class="line"><span style="color:#6a737d"> */</span></span>
<span class="line"><span style="color:#e1e4e8">@</span><span style="color:#f97583">Slf4j</span></span>
<span class="line"><span style="color:#e1e4e8">@</span><span style="color:#f97583">Service</span></span>
<span class="line"><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">class</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">SeckillSkuScheduled</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">    @</span><span style="color:#f97583">Autowired</span></span>
<span class="line"><span style="color:#e1e4e8">    SeckillService seckillService;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">    @</span><span style="color:#f97583">Autowired</span></span>
<span class="line"><span style="color:#e1e4e8">    RedissonClient redissonClient;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">private</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">final</span><span style="color:#e1e4e8"> String UPLOAD_LOCK </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#9ecbff">"seckill:upload:lock"</span><span style="color:#e1e4e8">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6a737d">    /**</span></span>
<span class="line"><span style="color:#6a737d">     * todo 幂等性处理</span></span>
<span class="line"><span style="color:#6a737d">     */</span></span>
<span class="line"><span style="color:#6a737d">//     @Scheduled(cron = "*/5 * * * * ? ")</span></span>
<span class="line"><span style="color:#e1e4e8">    @</span><span style="color:#f97583">Scheduled</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">cron</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#9ecbff">"0 0 1/1 * * ? "</span><span style="color:#e1e4e8">)</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">void</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">uploadSeckillSkuLatest3Days</span><span style="color:#e1e4e8">(){</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#6a737d">//1、重复上架无需处理</span></span>
<span class="line"><span style="color:#e1e4e8">        log.</span><span style="color:#b392f0">info</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"上架秒杀的商品信息..."</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#6a737d">//分布式锁。锁的业务执行完成，状态已经更新完成，释放锁以后，其他人获取到就会拿到最新的状态</span></span>
<span class="line"><span style="color:#e1e4e8">        RLock lock </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> redissonClient.</span><span style="color:#b392f0">getLock</span><span style="color:#e1e4e8">(UPLOAD_LOCK);</span></span>
<span class="line"><span style="color:#e1e4e8">        lock.</span><span style="color:#b392f0">lock</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">10</span><span style="color:#e1e4e8">, TimeUnit.SECONDS);</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">try</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">            seckillService.</span><span style="color:#b392f0">uploadSeckillSkuLatest3Days</span><span style="color:#e1e4e8">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">        } </span><span style="color:#f97583">finally</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">            lock.</span><span style="color:#b392f0">unlock</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">        }</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"><span style="color:#e1e4e8">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6a737d">/**</span></span>
<span class="line"><span style="color:#6a737d"> *  * 秒杀商品的定时上架；</span></span>
<span class="line"><span style="color:#6a737d"> *  *      每天晚上3点；上架最近三天需要秒杀的商品</span></span>
<span class="line"><span style="color:#6a737d"> *  *      当天00:00:00 - 23:59:59</span></span>
<span class="line"><span style="color:#6a737d"> *  *      明天天00:00:00 - 23:59:59</span></span>
<span class="line"><span style="color:#6a737d"> *  *      后天00:00:00 - 23:59:59</span></span>
<span class="line"><span style="color:#6a737d"> * </span><span style="color:#d73a49">@author</span><span style="color:#6a737d"> Klaus</span></span>
<span class="line"><span style="color:#6a737d"> * @date 2022/9/27</span></span>
<span class="line"><span style="color:#6a737d"> */</span></span>
<span class="line"><span style="color:#24292e">@</span><span style="color:#d73a49">Slf4j</span></span>
<span class="line"><span style="color:#24292e">@</span><span style="color:#d73a49">Service</span></span>
<span class="line"><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">class</span><span style="color:#24292e"> </span><span style="color:#6f42c1">SeckillSkuScheduled</span><span style="color:#24292e"> {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">    @</span><span style="color:#d73a49">Autowired</span></span>
<span class="line"><span style="color:#24292e">    SeckillService seckillService;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">    @</span><span style="color:#d73a49">Autowired</span></span>
<span class="line"><span style="color:#24292e">    RedissonClient redissonClient;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">private</span><span style="color:#24292e"> </span><span style="color:#d73a49">final</span><span style="color:#24292e"> String UPLOAD_LOCK </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#032f62">"seckill:upload:lock"</span><span style="color:#24292e">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6a737d">    /**</span></span>
<span class="line"><span style="color:#6a737d">     * todo 幂等性处理</span></span>
<span class="line"><span style="color:#6a737d">     */</span></span>
<span class="line"><span style="color:#6a737d">//     @Scheduled(cron = "*/5 * * * * ? ")</span></span>
<span class="line"><span style="color:#24292e">    @</span><span style="color:#d73a49">Scheduled</span><span style="color:#24292e">(</span><span style="color:#005cc5">cron</span><span style="color:#24292e"> </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#032f62">"0 0 1/1 * * ? "</span><span style="color:#24292e">)</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">void</span><span style="color:#24292e"> </span><span style="color:#6f42c1">uploadSeckillSkuLatest3Days</span><span style="color:#24292e">(){</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6a737d">//1、重复上架无需处理</span></span>
<span class="line"><span style="color:#24292e">        log.</span><span style="color:#6f42c1">info</span><span style="color:#24292e">(</span><span style="color:#032f62">"上架秒杀的商品信息..."</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6a737d">//分布式锁。锁的业务执行完成，状态已经更新完成，释放锁以后，其他人获取到就会拿到最新的状态</span></span>
<span class="line"><span style="color:#24292e">        RLock lock </span><span style="color:#d73a49">=</span><span style="color:#24292e"> redissonClient.</span><span style="color:#6f42c1">getLock</span><span style="color:#24292e">(UPLOAD_LOCK);</span></span>
<span class="line"><span style="color:#24292e">        lock.</span><span style="color:#6f42c1">lock</span><span style="color:#24292e">(</span><span style="color:#005cc5">10</span><span style="color:#24292e">, TimeUnit.SECONDS);</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">try</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">            seckillService.</span><span style="color:#6f42c1">uploadSeckillSkuLatest3Days</span><span style="color:#24292e">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">        } </span><span style="color:#d73a49">finally</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">            lock.</span><span style="color:#6f42c1">unlock</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">        }</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"><span style="color:#24292e">}</span></span></code></pre></div><ul><li>完善缓存活动信息方法</li></ul><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#f97583">private</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">void</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">saveSessionInfos</span><span style="color:#e1e4e8">(List</span><span style="color:#f97583">&lt;</span><span style="color:#e1e4e8">SeckillSessionWithSkus</span><span style="color:#f97583">&gt;</span><span style="color:#e1e4e8"> sessions) {</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (sessions </span><span style="color:#f97583">!=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">&amp;&amp;</span><span style="color:#e1e4e8"> sessions.</span><span style="color:#b392f0">size</span><span style="color:#e1e4e8">() </span><span style="color:#f97583">&gt;</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">        sessions.</span><span style="color:#b392f0">stream</span><span style="color:#e1e4e8">().</span><span style="color:#b392f0">forEach</span><span style="color:#e1e4e8">(session </span><span style="color:#f97583">-&gt;</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">long</span><span style="color:#e1e4e8"> startTime </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> session.</span><span style="color:#b392f0">getStartTime</span><span style="color:#e1e4e8">().</span><span style="color:#b392f0">getTime</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">long</span><span style="color:#e1e4e8"> endTime </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> session.</span><span style="color:#b392f0">getEndTime</span><span style="color:#e1e4e8">().</span><span style="color:#b392f0">getTime</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">            String key </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> SESSIONS_CACHE_PREFOX </span><span style="color:#f97583">+</span><span style="color:#e1e4e8"> startTime </span><span style="color:#f97583">+</span><span style="color:#e1e4e8"> </span><span style="color:#9ecbff">"_"</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">+</span><span style="color:#e1e4e8"> endTime;</span></span>
<span class="line"><span style="color:#e1e4e8">            Boolean hasKey </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> redisTemplate.</span><span style="color:#b392f0">hasKey</span><span style="color:#e1e4e8">(key);</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (</span><span style="color:#f97583">!</span><span style="color:#e1e4e8">hasKey) {</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#6a737d">//key不存在进行缓存操作</span></span>
<span class="line"><span style="color:#e1e4e8">                List&lt;</span><span style="color:#f97583">String</span><span style="color:#e1e4e8">&gt; skuIds </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> session.</span><span style="color:#b392f0">getRelationSkus</span><span style="color:#e1e4e8">().</span><span style="color:#b392f0">stream</span><span style="color:#e1e4e8">().</span><span style="color:#b392f0">map</span><span style="color:#e1e4e8">(item </span><span style="color:#f97583">-&gt;</span><span style="color:#e1e4e8"> item.</span><span style="color:#b392f0">getPromotionSessionId</span><span style="color:#e1e4e8">().</span><span style="color:#b392f0">toString</span><span style="color:#e1e4e8">() </span><span style="color:#f97583">+</span><span style="color:#e1e4e8"> </span><span style="color:#9ecbff">"_"</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">+</span><span style="color:#e1e4e8"> item.</span><span style="color:#b392f0">getSkuId</span><span style="color:#e1e4e8">().</span><span style="color:#b392f0">toString</span><span style="color:#e1e4e8">()).</span><span style="color:#b392f0">collect</span><span style="color:#e1e4e8">(Collectors.</span><span style="color:#b392f0">toList</span><span style="color:#e1e4e8">());</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#6a737d">//缓存所有活动信息</span></span>
<span class="line"><span style="color:#e1e4e8">                redisTemplate.</span><span style="color:#b392f0">opsForList</span><span style="color:#e1e4e8">().</span><span style="color:#b392f0">leftPushAll</span><span style="color:#e1e4e8">(key, skuIds);</span></span>
<span class="line"><span style="color:#e1e4e8">            }</span></span>
<span class="line"><span style="color:#e1e4e8">        });</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"><span style="color:#e1e4e8">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#d73a49">private</span><span style="color:#24292e"> </span><span style="color:#d73a49">void</span><span style="color:#24292e"> </span><span style="color:#6f42c1">saveSessionInfos</span><span style="color:#24292e">(List</span><span style="color:#d73a49">&lt;</span><span style="color:#24292e">SeckillSessionWithSkus</span><span style="color:#d73a49">&gt;</span><span style="color:#24292e"> sessions) {</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (sessions </span><span style="color:#d73a49">!=</span><span style="color:#24292e"> </span><span style="color:#005cc5">null</span><span style="color:#24292e"> </span><span style="color:#d73a49">&amp;&amp;</span><span style="color:#24292e"> sessions.</span><span style="color:#6f42c1">size</span><span style="color:#24292e">() </span><span style="color:#d73a49">&gt;</span><span style="color:#24292e"> </span><span style="color:#005cc5">0</span><span style="color:#24292e">) {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">        sessions.</span><span style="color:#6f42c1">stream</span><span style="color:#24292e">().</span><span style="color:#6f42c1">forEach</span><span style="color:#24292e">(session </span><span style="color:#d73a49">-&gt;</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">long</span><span style="color:#24292e"> startTime </span><span style="color:#d73a49">=</span><span style="color:#24292e"> session.</span><span style="color:#6f42c1">getStartTime</span><span style="color:#24292e">().</span><span style="color:#6f42c1">getTime</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">long</span><span style="color:#24292e"> endTime </span><span style="color:#d73a49">=</span><span style="color:#24292e"> session.</span><span style="color:#6f42c1">getEndTime</span><span style="color:#24292e">().</span><span style="color:#6f42c1">getTime</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">            String key </span><span style="color:#d73a49">=</span><span style="color:#24292e"> SESSIONS_CACHE_PREFOX </span><span style="color:#d73a49">+</span><span style="color:#24292e"> startTime </span><span style="color:#d73a49">+</span><span style="color:#24292e"> </span><span style="color:#032f62">"_"</span><span style="color:#24292e"> </span><span style="color:#d73a49">+</span><span style="color:#24292e"> endTime;</span></span>
<span class="line"><span style="color:#24292e">            Boolean hasKey </span><span style="color:#d73a49">=</span><span style="color:#24292e"> redisTemplate.</span><span style="color:#6f42c1">hasKey</span><span style="color:#24292e">(key);</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (</span><span style="color:#d73a49">!</span><span style="color:#24292e">hasKey) {</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#6a737d">//key不存在进行缓存操作</span></span>
<span class="line"><span style="color:#24292e">                List&lt;</span><span style="color:#d73a49">String</span><span style="color:#24292e">&gt; skuIds </span><span style="color:#d73a49">=</span><span style="color:#24292e"> session.</span><span style="color:#6f42c1">getRelationSkus</span><span style="color:#24292e">().</span><span style="color:#6f42c1">stream</span><span style="color:#24292e">().</span><span style="color:#6f42c1">map</span><span style="color:#24292e">(item </span><span style="color:#d73a49">-&gt;</span><span style="color:#24292e"> item.</span><span style="color:#6f42c1">getPromotionSessionId</span><span style="color:#24292e">().</span><span style="color:#6f42c1">toString</span><span style="color:#24292e">() </span><span style="color:#d73a49">+</span><span style="color:#24292e"> </span><span style="color:#032f62">"_"</span><span style="color:#24292e"> </span><span style="color:#d73a49">+</span><span style="color:#24292e"> item.</span><span style="color:#6f42c1">getSkuId</span><span style="color:#24292e">().</span><span style="color:#6f42c1">toString</span><span style="color:#24292e">()).</span><span style="color:#6f42c1">collect</span><span style="color:#24292e">(Collectors.</span><span style="color:#6f42c1">toList</span><span style="color:#24292e">());</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#6a737d">//缓存所有活动信息</span></span>
<span class="line"><span style="color:#24292e">                redisTemplate.</span><span style="color:#6f42c1">opsForList</span><span style="color:#24292e">().</span><span style="color:#6f42c1">leftPushAll</span><span style="color:#24292e">(key, skuIds);</span></span>
<span class="line"><span style="color:#24292e">            }</span></span>
<span class="line"><span style="color:#24292e">        });</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"><span style="color:#24292e">}</span></span></code></pre></div><ul><li>完善缓存活动的关联商品信息</li></ul><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#f97583">private</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">void</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">saveSessionSkuInfos</span><span style="color:#e1e4e8">(List</span><span style="color:#f97583">&lt;</span><span style="color:#e1e4e8">SeckillSessionWithSkus</span><span style="color:#f97583">&gt;</span><span style="color:#e1e4e8"> sessions) {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">//准备hash操作</span></span>
<span class="line"><span style="color:#e1e4e8">    BoundHashOperations&lt;</span><span style="color:#f97583">String</span><span style="color:#e1e4e8">, </span><span style="color:#f97583">Object</span><span style="color:#e1e4e8">, </span><span style="color:#f97583">Object</span><span style="color:#e1e4e8">&gt; ops </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> redisTemplate.</span><span style="color:#b392f0">boundHashOps</span><span style="color:#e1e4e8">(SKUKILL_CACHE_PREFOX);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (sessions </span><span style="color:#f97583">!=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">&amp;&amp;</span><span style="color:#e1e4e8"> sessions.</span><span style="color:#b392f0">size</span><span style="color:#e1e4e8">() </span><span style="color:#f97583">&gt;</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">        sessions.</span><span style="color:#b392f0">stream</span><span style="color:#e1e4e8">().</span><span style="color:#b392f0">forEach</span><span style="color:#e1e4e8">(session </span><span style="color:#f97583">-&gt;</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">            String token </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> UUID.</span><span style="color:#b392f0">randomUUID</span><span style="color:#e1e4e8">().</span><span style="color:#b392f0">toString</span><span style="color:#e1e4e8">().</span><span style="color:#b392f0">replace</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"-"</span><span style="color:#e1e4e8">, </span><span style="color:#9ecbff">""</span><span style="color:#e1e4e8">);</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">            session.</span><span style="color:#b392f0">getRelationSkus</span><span style="color:#e1e4e8">().</span><span style="color:#b392f0">stream</span><span style="color:#e1e4e8">().</span><span style="color:#b392f0">forEach</span><span style="color:#e1e4e8">(seckillSkuVo </span><span style="color:#f97583">-&gt;</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (</span><span style="color:#f97583">!</span><span style="color:#e1e4e8">ops.</span><span style="color:#b392f0">hasKey</span><span style="color:#e1e4e8">(seckillSkuVo.</span><span style="color:#b392f0">getPromotionSessionId</span><span style="color:#e1e4e8">().</span><span style="color:#b392f0">toString</span><span style="color:#e1e4e8">() </span><span style="color:#f97583">+</span><span style="color:#e1e4e8"> </span><span style="color:#9ecbff">"_"</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">+</span><span style="color:#e1e4e8"> seckillSkuVo.</span><span style="color:#b392f0">getSkuId</span><span style="color:#e1e4e8">().</span><span style="color:#b392f0">toString</span><span style="color:#e1e4e8">())) {</span></span>
<span class="line"><span style="color:#e1e4e8">                    </span><span style="color:#6a737d">//key不存在进行缓存商品</span></span>
<span class="line"><span style="color:#e1e4e8">                    SeckillSkuRedisTo redisTo </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">SeckillSkuRedisTo</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">                    </span><span style="color:#6a737d">//1、sku的基本数据</span></span>
<span class="line"><span style="color:#e1e4e8">                    R r </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> productFeignService.</span><span style="color:#b392f0">getSkuInfo</span><span style="color:#e1e4e8">(seckillSkuVo.</span><span style="color:#b392f0">getSkuId</span><span style="color:#e1e4e8">());</span></span>
<span class="line"><span style="color:#e1e4e8">                    </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (r.</span><span style="color:#b392f0">getCode</span><span style="color:#e1e4e8">() </span><span style="color:#f97583">==</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">                        </span><span style="color:#6a737d">//远程调用成功</span></span>
<span class="line"><span style="color:#e1e4e8">                        SkuInfoVo skuInfo </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> r.</span><span style="color:#b392f0">getData</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"skuInfo"</span><span style="color:#e1e4e8">, </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> TypeReference&lt;</span><span style="color:#f97583">SkuInfoVo</span><span style="color:#e1e4e8">&gt;() {</span></span>
<span class="line"><span style="color:#e1e4e8">                        });</span></span>
<span class="line"><span style="color:#e1e4e8">                        redisTo.</span><span style="color:#b392f0">setSkuInfoVo</span><span style="color:#e1e4e8">(skuInfo);</span></span>
<span class="line"><span style="color:#e1e4e8">                    }</span></span>
<span class="line"><span style="color:#e1e4e8">                    </span><span style="color:#6a737d">//2、sku的秒杀信息 vo-&gt;to</span></span>
<span class="line"><span style="color:#e1e4e8">                    BeanUtils.</span><span style="color:#b392f0">copyProperties</span><span style="color:#e1e4e8">(seckillSkuVo, redisTo);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">                    </span><span style="color:#6a737d">//3、设置上当前商品的秒杀时间信息</span></span>
<span class="line"><span style="color:#e1e4e8">                    redisTo.</span><span style="color:#b392f0">setStartTime</span><span style="color:#e1e4e8">(session.</span><span style="color:#b392f0">getStartTime</span><span style="color:#e1e4e8">().</span><span style="color:#b392f0">getTime</span><span style="color:#e1e4e8">());</span></span>
<span class="line"><span style="color:#e1e4e8">                    redisTo.</span><span style="color:#b392f0">setEndTime</span><span style="color:#e1e4e8">(session.</span><span style="color:#b392f0">getEndTime</span><span style="color:#e1e4e8">().</span><span style="color:#b392f0">getTime</span><span style="color:#e1e4e8">());</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">                    </span><span style="color:#6a737d">//4、随机码   seckill?skuId=1&amp;key=fewqfwrgvrw</span></span>
<span class="line"><span style="color:#e1e4e8">                    redisTo.</span><span style="color:#b392f0">setRandomCode</span><span style="color:#e1e4e8">(token);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">                    String jsonString </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> JSON.</span><span style="color:#b392f0">toJSONString</span><span style="color:#e1e4e8">(redisTo);</span></span>
<span class="line"><span style="color:#e1e4e8">                    ops.</span><span style="color:#b392f0">put</span><span style="color:#e1e4e8">(seckillSkuVo.</span><span style="color:#b392f0">getPromotionSessionId</span><span style="color:#e1e4e8">().</span><span style="color:#b392f0">toString</span><span style="color:#e1e4e8">() </span><span style="color:#f97583">+</span><span style="color:#e1e4e8"> </span><span style="color:#9ecbff">"_"</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">+</span><span style="color:#e1e4e8"> seckillSkuVo.</span><span style="color:#b392f0">getSkuId</span><span style="color:#e1e4e8">().</span><span style="color:#b392f0">toString</span><span style="color:#e1e4e8">(), jsonString);</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">                    </span><span style="color:#6a737d">//秒杀请求进来先获取信号量，获取不到就无法执行数据库的所有方法了</span></span>
<span class="line"><span style="color:#e1e4e8">                    </span><span style="color:#6a737d">//如果当前这个场次的商品的库存信息已经上架就不需要上架</span></span>
<span class="line"><span style="color:#e1e4e8">                    </span><span style="color:#6a737d">//5、使用库存作为分布式的信号量 -&gt; 限流；</span></span>
<span class="line"><span style="color:#e1e4e8">                    RSemaphore semaphore </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> redissonClient.</span><span style="color:#b392f0">getSemaphore</span><span style="color:#e1e4e8">(SKU_STOCK_SEMAPHORE </span><span style="color:#f97583">+</span><span style="color:#e1e4e8"> token);</span></span>
<span class="line"><span style="color:#e1e4e8">                    </span><span style="color:#6a737d">//商品可以秒杀的数量作为信号量</span></span>
<span class="line"><span style="color:#e1e4e8">                    semaphore.</span><span style="color:#b392f0">trySetPermits</span><span style="color:#e1e4e8">(seckillSkuVo.</span><span style="color:#b392f0">getSeckillCount</span><span style="color:#e1e4e8">().</span><span style="color:#b392f0">intValue</span><span style="color:#e1e4e8">());</span></span>
<span class="line"><span style="color:#e1e4e8">                }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">            });</span></span>
<span class="line"><span style="color:#e1e4e8">        });</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"><span style="color:#e1e4e8">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#d73a49">private</span><span style="color:#24292e"> </span><span style="color:#d73a49">void</span><span style="color:#24292e"> </span><span style="color:#6f42c1">saveSessionSkuInfos</span><span style="color:#24292e">(List</span><span style="color:#d73a49">&lt;</span><span style="color:#24292e">SeckillSessionWithSkus</span><span style="color:#d73a49">&gt;</span><span style="color:#24292e"> sessions) {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">//准备hash操作</span></span>
<span class="line"><span style="color:#24292e">    BoundHashOperations&lt;</span><span style="color:#d73a49">String</span><span style="color:#24292e">, </span><span style="color:#d73a49">Object</span><span style="color:#24292e">, </span><span style="color:#d73a49">Object</span><span style="color:#24292e">&gt; ops </span><span style="color:#d73a49">=</span><span style="color:#24292e"> redisTemplate.</span><span style="color:#6f42c1">boundHashOps</span><span style="color:#24292e">(SKUKILL_CACHE_PREFOX);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (sessions </span><span style="color:#d73a49">!=</span><span style="color:#24292e"> </span><span style="color:#005cc5">null</span><span style="color:#24292e"> </span><span style="color:#d73a49">&amp;&amp;</span><span style="color:#24292e"> sessions.</span><span style="color:#6f42c1">size</span><span style="color:#24292e">() </span><span style="color:#d73a49">&gt;</span><span style="color:#24292e"> </span><span style="color:#005cc5">0</span><span style="color:#24292e">) {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">        sessions.</span><span style="color:#6f42c1">stream</span><span style="color:#24292e">().</span><span style="color:#6f42c1">forEach</span><span style="color:#24292e">(session </span><span style="color:#d73a49">-&gt;</span><span style="color:#24292e"> {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">            String token </span><span style="color:#d73a49">=</span><span style="color:#24292e"> UUID.</span><span style="color:#6f42c1">randomUUID</span><span style="color:#24292e">().</span><span style="color:#6f42c1">toString</span><span style="color:#24292e">().</span><span style="color:#6f42c1">replace</span><span style="color:#24292e">(</span><span style="color:#032f62">"-"</span><span style="color:#24292e">, </span><span style="color:#032f62">""</span><span style="color:#24292e">);</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">            session.</span><span style="color:#6f42c1">getRelationSkus</span><span style="color:#24292e">().</span><span style="color:#6f42c1">stream</span><span style="color:#24292e">().</span><span style="color:#6f42c1">forEach</span><span style="color:#24292e">(seckillSkuVo </span><span style="color:#d73a49">-&gt;</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (</span><span style="color:#d73a49">!</span><span style="color:#24292e">ops.</span><span style="color:#6f42c1">hasKey</span><span style="color:#24292e">(seckillSkuVo.</span><span style="color:#6f42c1">getPromotionSessionId</span><span style="color:#24292e">().</span><span style="color:#6f42c1">toString</span><span style="color:#24292e">() </span><span style="color:#d73a49">+</span><span style="color:#24292e"> </span><span style="color:#032f62">"_"</span><span style="color:#24292e"> </span><span style="color:#d73a49">+</span><span style="color:#24292e"> seckillSkuVo.</span><span style="color:#6f42c1">getSkuId</span><span style="color:#24292e">().</span><span style="color:#6f42c1">toString</span><span style="color:#24292e">())) {</span></span>
<span class="line"><span style="color:#24292e">                    </span><span style="color:#6a737d">//key不存在进行缓存商品</span></span>
<span class="line"><span style="color:#24292e">                    SeckillSkuRedisTo redisTo </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">SeckillSkuRedisTo</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">                    </span><span style="color:#6a737d">//1、sku的基本数据</span></span>
<span class="line"><span style="color:#24292e">                    R r </span><span style="color:#d73a49">=</span><span style="color:#24292e"> productFeignService.</span><span style="color:#6f42c1">getSkuInfo</span><span style="color:#24292e">(seckillSkuVo.</span><span style="color:#6f42c1">getSkuId</span><span style="color:#24292e">());</span></span>
<span class="line"><span style="color:#24292e">                    </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (r.</span><span style="color:#6f42c1">getCode</span><span style="color:#24292e">() </span><span style="color:#d73a49">==</span><span style="color:#24292e"> </span><span style="color:#005cc5">0</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">                        </span><span style="color:#6a737d">//远程调用成功</span></span>
<span class="line"><span style="color:#24292e">                        SkuInfoVo skuInfo </span><span style="color:#d73a49">=</span><span style="color:#24292e"> r.</span><span style="color:#6f42c1">getData</span><span style="color:#24292e">(</span><span style="color:#032f62">"skuInfo"</span><span style="color:#24292e">, </span><span style="color:#d73a49">new</span><span style="color:#24292e"> TypeReference&lt;</span><span style="color:#d73a49">SkuInfoVo</span><span style="color:#24292e">&gt;() {</span></span>
<span class="line"><span style="color:#24292e">                        });</span></span>
<span class="line"><span style="color:#24292e">                        redisTo.</span><span style="color:#6f42c1">setSkuInfoVo</span><span style="color:#24292e">(skuInfo);</span></span>
<span class="line"><span style="color:#24292e">                    }</span></span>
<span class="line"><span style="color:#24292e">                    </span><span style="color:#6a737d">//2、sku的秒杀信息 vo-&gt;to</span></span>
<span class="line"><span style="color:#24292e">                    BeanUtils.</span><span style="color:#6f42c1">copyProperties</span><span style="color:#24292e">(seckillSkuVo, redisTo);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">                    </span><span style="color:#6a737d">//3、设置上当前商品的秒杀时间信息</span></span>
<span class="line"><span style="color:#24292e">                    redisTo.</span><span style="color:#6f42c1">setStartTime</span><span style="color:#24292e">(session.</span><span style="color:#6f42c1">getStartTime</span><span style="color:#24292e">().</span><span style="color:#6f42c1">getTime</span><span style="color:#24292e">());</span></span>
<span class="line"><span style="color:#24292e">                    redisTo.</span><span style="color:#6f42c1">setEndTime</span><span style="color:#24292e">(session.</span><span style="color:#6f42c1">getEndTime</span><span style="color:#24292e">().</span><span style="color:#6f42c1">getTime</span><span style="color:#24292e">());</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">                    </span><span style="color:#6a737d">//4、随机码   seckill?skuId=1&amp;key=fewqfwrgvrw</span></span>
<span class="line"><span style="color:#24292e">                    redisTo.</span><span style="color:#6f42c1">setRandomCode</span><span style="color:#24292e">(token);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">                    String jsonString </span><span style="color:#d73a49">=</span><span style="color:#24292e"> JSON.</span><span style="color:#6f42c1">toJSONString</span><span style="color:#24292e">(redisTo);</span></span>
<span class="line"><span style="color:#24292e">                    ops.</span><span style="color:#6f42c1">put</span><span style="color:#24292e">(seckillSkuVo.</span><span style="color:#6f42c1">getPromotionSessionId</span><span style="color:#24292e">().</span><span style="color:#6f42c1">toString</span><span style="color:#24292e">() </span><span style="color:#d73a49">+</span><span style="color:#24292e"> </span><span style="color:#032f62">"_"</span><span style="color:#24292e"> </span><span style="color:#d73a49">+</span><span style="color:#24292e"> seckillSkuVo.</span><span style="color:#6f42c1">getSkuId</span><span style="color:#24292e">().</span><span style="color:#6f42c1">toString</span><span style="color:#24292e">(), jsonString);</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">                    </span><span style="color:#6a737d">//秒杀请求进来先获取信号量，获取不到就无法执行数据库的所有方法了</span></span>
<span class="line"><span style="color:#24292e">                    </span><span style="color:#6a737d">//如果当前这个场次的商品的库存信息已经上架就不需要上架</span></span>
<span class="line"><span style="color:#24292e">                    </span><span style="color:#6a737d">//5、使用库存作为分布式的信号量 -&gt; 限流；</span></span>
<span class="line"><span style="color:#24292e">                    RSemaphore semaphore </span><span style="color:#d73a49">=</span><span style="color:#24292e"> redissonClient.</span><span style="color:#6f42c1">getSemaphore</span><span style="color:#24292e">(SKU_STOCK_SEMAPHORE </span><span style="color:#d73a49">+</span><span style="color:#24292e"> token);</span></span>
<span class="line"><span style="color:#24292e">                    </span><span style="color:#6a737d">//商品可以秒杀的数量作为信号量</span></span>
<span class="line"><span style="color:#24292e">                    semaphore.</span><span style="color:#6f42c1">trySetPermits</span><span style="color:#24292e">(seckillSkuVo.</span><span style="color:#6f42c1">getSeckillCount</span><span style="color:#24292e">().</span><span style="color:#6f42c1">intValue</span><span style="color:#24292e">());</span></span>
<span class="line"><span style="color:#24292e">                }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">            });</span></span>
<span class="line"><span style="color:#24292e">        });</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"><span style="color:#24292e">}</span></span></code></pre></div><h4 id="_3-4-查询秒杀商品-页面渲染" tabindex="-1">3.4 查询秒杀商品+页面渲染 <a aria-current="page" href="/posts/flash%20killing#_3-4-查询秒杀商品-页面渲染" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h4><ul><li>返回当前时间可以参与的秒杀商品信息接口</li></ul><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8">@</span><span style="color:#f97583">Controller</span></span>
<span class="line"><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">class</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">SeckillController</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">    @</span><span style="color:#f97583">Autowired</span></span>
<span class="line"><span style="color:#e1e4e8">    SeckillService seckillService;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6a737d">    /**</span></span>
<span class="line"><span style="color:#6a737d">     * 返回当前时间可以参与的秒杀商品信息</span></span>
<span class="line"><span style="color:#6a737d">     * </span><span style="color:#f97583">@return</span></span>
<span class="line"><span style="color:#6a737d">     */</span></span>
<span class="line"><span style="color:#e1e4e8">    @</span><span style="color:#f97583">ResponseBody</span></span>
<span class="line"><span style="color:#e1e4e8">    @</span><span style="color:#f97583">GetMapping</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"/currentSeckillSkus"</span><span style="color:#e1e4e8">)</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">public</span><span style="color:#e1e4e8"> R </span><span style="color:#b392f0">getCurrentSeckillSkus</span><span style="color:#e1e4e8">(){</span></span>
<span class="line"><span style="color:#e1e4e8">        List&lt;</span><span style="color:#f97583">SeckillSkuRedisTo</span><span style="color:#e1e4e8">&gt; tos </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> seckillService.</span><span style="color:#b392f0">getCurrentSeckillSkus</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> R.</span><span style="color:#b392f0">ok</span><span style="color:#e1e4e8">().</span><span style="color:#b392f0">setData</span><span style="color:#e1e4e8">(tos);</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e">@</span><span style="color:#d73a49">Controller</span></span>
<span class="line"><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">class</span><span style="color:#24292e"> </span><span style="color:#6f42c1">SeckillController</span><span style="color:#24292e"> {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">    @</span><span style="color:#d73a49">Autowired</span></span>
<span class="line"><span style="color:#24292e">    SeckillService seckillService;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6a737d">    /**</span></span>
<span class="line"><span style="color:#6a737d">     * 返回当前时间可以参与的秒杀商品信息</span></span>
<span class="line"><span style="color:#6a737d">     * </span><span style="color:#d73a49">@return</span></span>
<span class="line"><span style="color:#6a737d">     */</span></span>
<span class="line"><span style="color:#24292e">    @</span><span style="color:#d73a49">ResponseBody</span></span>
<span class="line"><span style="color:#24292e">    @</span><span style="color:#d73a49">GetMapping</span><span style="color:#24292e">(</span><span style="color:#032f62">"/currentSeckillSkus"</span><span style="color:#24292e">)</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">public</span><span style="color:#24292e"> R </span><span style="color:#6f42c1">getCurrentSeckillSkus</span><span style="color:#24292e">(){</span></span>
<span class="line"><span style="color:#24292e">        List&lt;</span><span style="color:#d73a49">SeckillSkuRedisTo</span><span style="color:#24292e">&gt; tos </span><span style="color:#d73a49">=</span><span style="color:#24292e"> seckillService.</span><span style="color:#6f42c1">getCurrentSeckillSkus</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">return</span><span style="color:#24292e"> R.</span><span style="color:#6f42c1">ok</span><span style="color:#24292e">().</span><span style="color:#6f42c1">setData</span><span style="color:#24292e">(tos);</span></span>
<span class="line"><span style="color:#24292e">    }</span></span></code></pre></div><ul><li>返回当前时间可以参与的秒杀商品信息方法实现</li></ul><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6a737d">/**</span></span>
<span class="line"><span style="color:#6a737d">     * 返回当前时间可以参与的秒杀商品信息</span></span>
<span class="line"><span style="color:#6a737d">     */</span></span>
<span class="line"><span style="color:#e1e4e8">    @</span><span style="color:#f97583">Override</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">public</span><span style="color:#e1e4e8"> List</span><span style="color:#f97583">&lt;</span><span style="color:#e1e4e8">SeckillSkuRedisTo</span><span style="color:#f97583">&gt;</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">getCurrentSeckillSkus</span><span style="color:#e1e4e8">() {</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#6a737d">//1、确定当前时间属于哪个秒杀场次</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">long</span><span style="color:#e1e4e8"> time </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> System.</span><span style="color:#b392f0">currentTimeMillis</span><span style="color:#e1e4e8">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">        Set&lt;</span><span style="color:#f97583">String</span><span style="color:#e1e4e8">&gt; keys </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> redisTemplate.</span><span style="color:#b392f0">keys</span><span style="color:#e1e4e8">(SESSIONS_CACHE_PREFOX </span><span style="color:#f97583">+</span><span style="color:#e1e4e8"> </span><span style="color:#9ecbff">"*"</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">for</span><span style="color:#e1e4e8"> (String key </span><span style="color:#f97583">:</span><span style="color:#e1e4e8"> keys) {</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#6a737d">//seckill:sessions:1664301600000_1664305200000-&gt;1664301600000_1664305200000</span></span>
<span class="line"><span style="color:#e1e4e8">            String replace </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> key.</span><span style="color:#b392f0">replace</span><span style="color:#e1e4e8">(SESSIONS_CACHE_PREFOX, </span><span style="color:#9ecbff">""</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#6a737d">//[1664301600000 _ 1664305200000]</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#6a737d">//        0             1</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">String</span><span style="color:#e1e4e8">[] s </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> replace.</span><span style="color:#b392f0">split</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"_"</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">            Long start </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> Long.</span><span style="color:#b392f0">parseLong</span><span style="color:#e1e4e8">(s[</span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8">]);</span></span>
<span class="line"><span style="color:#e1e4e8">            Long end </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> Long.</span><span style="color:#b392f0">parseLong</span><span style="color:#e1e4e8">(s[</span><span style="color:#79b8ff">1</span><span style="color:#e1e4e8">]);</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (time </span><span style="color:#f97583">&gt;=</span><span style="color:#e1e4e8"> start </span><span style="color:#f97583">&amp;&amp;</span><span style="color:#e1e4e8"> time </span><span style="color:#f97583">&lt;=</span><span style="color:#e1e4e8"> end) {</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#6a737d">//当前时间在秒杀时间范围内</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#6a737d">//2、获取这个秒杀场次需要的所有商品信息</span></span>
<span class="line"><span style="color:#e1e4e8">                List&lt;</span><span style="color:#f97583">String</span><span style="color:#e1e4e8">&gt; range </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> redisTemplate.</span><span style="color:#b392f0">opsForList</span><span style="color:#e1e4e8">().</span><span style="color:#b392f0">range</span><span style="color:#e1e4e8">(key, </span><span style="color:#f97583">-</span><span style="color:#79b8ff">100</span><span style="color:#e1e4e8">, </span><span style="color:#79b8ff">100</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">                BoundHashOperations&lt;</span><span style="color:#f97583">String</span><span style="color:#e1e4e8">, </span><span style="color:#f97583">String</span><span style="color:#e1e4e8">, </span><span style="color:#f97583">String</span><span style="color:#e1e4e8">&gt; hashOps </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> redisTemplate.</span><span style="color:#b392f0">boundHashOps</span><span style="color:#e1e4e8">(SKUKILL_CACHE_PREFOX);</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#f97583">assert</span><span style="color:#e1e4e8"> range </span><span style="color:#f97583">!=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">                List&lt;</span><span style="color:#f97583">String</span><span style="color:#e1e4e8">&gt; list </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> hashOps.</span><span style="color:#b392f0">multiGet</span><span style="color:#e1e4e8">(range);</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (list </span><span style="color:#f97583">!=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">&amp;&amp;</span><span style="color:#e1e4e8"> list.</span><span style="color:#b392f0">size</span><span style="color:#e1e4e8">() </span><span style="color:#f97583">&gt;</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">                    List&lt;</span><span style="color:#f97583">SeckillSkuRedisTo</span><span style="color:#e1e4e8">&gt; collect </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> list.</span><span style="color:#b392f0">stream</span><span style="color:#e1e4e8">().</span><span style="color:#b392f0">map</span><span style="color:#e1e4e8">(item </span><span style="color:#f97583">-&gt;</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">                        SeckillSkuRedisTo skuRedisTo </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> JSON.</span><span style="color:#b392f0">parseObject</span><span style="color:#e1e4e8">((String) item, SeckillSkuRedisTo.class);</span></span>
<span class="line"><span style="color:#6a737d">//                        skuRedisTo.setRandomCode(null);当前秒杀开始就需要随机码</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">                        </span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> skuRedisTo;</span></span>
<span class="line"><span style="color:#e1e4e8">                    }).</span><span style="color:#b392f0">collect</span><span style="color:#e1e4e8">(Collectors.</span><span style="color:#b392f0">toList</span><span style="color:#e1e4e8">());</span></span>
<span class="line"><span style="color:#e1e4e8">                    </span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> collect;</span></span>
<span class="line"><span style="color:#e1e4e8">                }</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#f97583">break</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">            }</span></span>
<span class="line"><span style="color:#e1e4e8">        }</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6a737d">/**</span></span>
<span class="line"><span style="color:#6a737d">     * 返回当前时间可以参与的秒杀商品信息</span></span>
<span class="line"><span style="color:#6a737d">     */</span></span>
<span class="line"><span style="color:#24292e">    @</span><span style="color:#d73a49">Override</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">public</span><span style="color:#24292e"> List</span><span style="color:#d73a49">&lt;</span><span style="color:#24292e">SeckillSkuRedisTo</span><span style="color:#d73a49">&gt;</span><span style="color:#24292e"> </span><span style="color:#6f42c1">getCurrentSeckillSkus</span><span style="color:#24292e">() {</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6a737d">//1、确定当前时间属于哪个秒杀场次</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">long</span><span style="color:#24292e"> time </span><span style="color:#d73a49">=</span><span style="color:#24292e"> System.</span><span style="color:#6f42c1">currentTimeMillis</span><span style="color:#24292e">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">        Set&lt;</span><span style="color:#d73a49">String</span><span style="color:#24292e">&gt; keys </span><span style="color:#d73a49">=</span><span style="color:#24292e"> redisTemplate.</span><span style="color:#6f42c1">keys</span><span style="color:#24292e">(SESSIONS_CACHE_PREFOX </span><span style="color:#d73a49">+</span><span style="color:#24292e"> </span><span style="color:#032f62">"*"</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">for</span><span style="color:#24292e"> (String key </span><span style="color:#d73a49">:</span><span style="color:#24292e"> keys) {</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#6a737d">//seckill:sessions:1664301600000_1664305200000-&gt;1664301600000_1664305200000</span></span>
<span class="line"><span style="color:#24292e">            String replace </span><span style="color:#d73a49">=</span><span style="color:#24292e"> key.</span><span style="color:#6f42c1">replace</span><span style="color:#24292e">(SESSIONS_CACHE_PREFOX, </span><span style="color:#032f62">""</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#6a737d">//[1664301600000 _ 1664305200000]</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#6a737d">//        0             1</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">String</span><span style="color:#24292e">[] s </span><span style="color:#d73a49">=</span><span style="color:#24292e"> replace.</span><span style="color:#6f42c1">split</span><span style="color:#24292e">(</span><span style="color:#032f62">"_"</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">            Long start </span><span style="color:#d73a49">=</span><span style="color:#24292e"> Long.</span><span style="color:#6f42c1">parseLong</span><span style="color:#24292e">(s[</span><span style="color:#005cc5">0</span><span style="color:#24292e">]);</span></span>
<span class="line"><span style="color:#24292e">            Long end </span><span style="color:#d73a49">=</span><span style="color:#24292e"> Long.</span><span style="color:#6f42c1">parseLong</span><span style="color:#24292e">(s[</span><span style="color:#005cc5">1</span><span style="color:#24292e">]);</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (time </span><span style="color:#d73a49">&gt;=</span><span style="color:#24292e"> start </span><span style="color:#d73a49">&amp;&amp;</span><span style="color:#24292e"> time </span><span style="color:#d73a49">&lt;=</span><span style="color:#24292e"> end) {</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#6a737d">//当前时间在秒杀时间范围内</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#6a737d">//2、获取这个秒杀场次需要的所有商品信息</span></span>
<span class="line"><span style="color:#24292e">                List&lt;</span><span style="color:#d73a49">String</span><span style="color:#24292e">&gt; range </span><span style="color:#d73a49">=</span><span style="color:#24292e"> redisTemplate.</span><span style="color:#6f42c1">opsForList</span><span style="color:#24292e">().</span><span style="color:#6f42c1">range</span><span style="color:#24292e">(key, </span><span style="color:#d73a49">-</span><span style="color:#005cc5">100</span><span style="color:#24292e">, </span><span style="color:#005cc5">100</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">                BoundHashOperations&lt;</span><span style="color:#d73a49">String</span><span style="color:#24292e">, </span><span style="color:#d73a49">String</span><span style="color:#24292e">, </span><span style="color:#d73a49">String</span><span style="color:#24292e">&gt; hashOps </span><span style="color:#d73a49">=</span><span style="color:#24292e"> redisTemplate.</span><span style="color:#6f42c1">boundHashOps</span><span style="color:#24292e">(SKUKILL_CACHE_PREFOX);</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#d73a49">assert</span><span style="color:#24292e"> range </span><span style="color:#d73a49">!=</span><span style="color:#24292e"> </span><span style="color:#005cc5">null</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">                List&lt;</span><span style="color:#d73a49">String</span><span style="color:#24292e">&gt; list </span><span style="color:#d73a49">=</span><span style="color:#24292e"> hashOps.</span><span style="color:#6f42c1">multiGet</span><span style="color:#24292e">(range);</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (list </span><span style="color:#d73a49">!=</span><span style="color:#24292e"> </span><span style="color:#005cc5">null</span><span style="color:#24292e"> </span><span style="color:#d73a49">&amp;&amp;</span><span style="color:#24292e"> list.</span><span style="color:#6f42c1">size</span><span style="color:#24292e">() </span><span style="color:#d73a49">&gt;</span><span style="color:#24292e"> </span><span style="color:#005cc5">0</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">                    List&lt;</span><span style="color:#d73a49">SeckillSkuRedisTo</span><span style="color:#24292e">&gt; collect </span><span style="color:#d73a49">=</span><span style="color:#24292e"> list.</span><span style="color:#6f42c1">stream</span><span style="color:#24292e">().</span><span style="color:#6f42c1">map</span><span style="color:#24292e">(item </span><span style="color:#d73a49">-&gt;</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">                        SeckillSkuRedisTo skuRedisTo </span><span style="color:#d73a49">=</span><span style="color:#24292e"> JSON.</span><span style="color:#6f42c1">parseObject</span><span style="color:#24292e">((String) item, SeckillSkuRedisTo.class);</span></span>
<span class="line"><span style="color:#6a737d">//                        skuRedisTo.setRandomCode(null);当前秒杀开始就需要随机码</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">                        </span><span style="color:#d73a49">return</span><span style="color:#24292e"> skuRedisTo;</span></span>
<span class="line"><span style="color:#24292e">                    }).</span><span style="color:#6f42c1">collect</span><span style="color:#24292e">(Collectors.</span><span style="color:#6f42c1">toList</span><span style="color:#24292e">());</span></span>
<span class="line"><span style="color:#24292e">                    </span><span style="color:#d73a49">return</span><span style="color:#24292e"> collect;</span></span>
<span class="line"><span style="color:#24292e">                }</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#d73a49">break</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">            }</span></span>
<span class="line"><span style="color:#24292e">        }</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">return</span><span style="color:#24292e"> </span><span style="color:#005cc5">null</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">    }</span></span></code></pre></div><figure><img src="https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230430152815352.png" alt="image-20230430152815352" loading="lazy" decoding="async"></figure><figure><img src="https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230428202232121.png" alt="image-20230428202232121" loading="lazy" decoding="async"></figure><ul><li>商品服务远程查询秒杀信息</li><li>远程接口</li></ul><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8">@</span><span style="color:#f97583">FeignClient</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">value</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#9ecbff">"gulimall-seckill"</span><span style="color:#e1e4e8">, </span><span style="color:#79b8ff">fallback</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> SeckillFeignServiceFallBack.class )</span></span>
<span class="line"><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">interface</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">SeckillFeignService</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">    @</span><span style="color:#f97583">GetMapping</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"/sku/seckill/{skuId}"</span><span style="color:#e1e4e8">)</span></span>
<span class="line"><span style="color:#e1e4e8">    R </span><span style="color:#b392f0">getSkuSeckillInfo</span><span style="color:#e1e4e8">(@</span><span style="color:#f97583">PathVariable</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"skuId"</span><span style="color:#e1e4e8">)Long </span><span style="color:#ffab70">skuId</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e">@</span><span style="color:#d73a49">FeignClient</span><span style="color:#24292e">(</span><span style="color:#005cc5">value</span><span style="color:#24292e"> </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#032f62">"gulimall-seckill"</span><span style="color:#24292e">, </span><span style="color:#005cc5">fallback</span><span style="color:#24292e"> </span><span style="color:#d73a49">=</span><span style="color:#24292e"> SeckillFeignServiceFallBack.class )</span></span>
<span class="line"><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">interface</span><span style="color:#24292e"> </span><span style="color:#6f42c1">SeckillFeignService</span><span style="color:#24292e"> {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">    @</span><span style="color:#d73a49">GetMapping</span><span style="color:#24292e">(</span><span style="color:#032f62">"/sku/seckill/{skuId}"</span><span style="color:#24292e">)</span></span>
<span class="line"><span style="color:#24292e">    R </span><span style="color:#6f42c1">getSkuSeckillInfo</span><span style="color:#24292e">(@</span><span style="color:#d73a49">PathVariable</span><span style="color:#24292e">(</span><span style="color:#032f62">"skuId"</span><span style="color:#24292e">)Long </span><span style="color:#e36209">skuId</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">}</span></span></code></pre></div><ul><li>获取秒杀信息接口</li></ul><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8">@</span><span style="color:#f97583">ResponseBody</span></span>
<span class="line"><span style="color:#e1e4e8">@</span><span style="color:#f97583">GetMapping</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"/sku/seckill/{skuId}"</span><span style="color:#e1e4e8">)</span></span>
<span class="line"><span style="color:#f97583">public</span><span style="color:#e1e4e8"> R </span><span style="color:#b392f0">getSkuSeckillInfo</span><span style="color:#e1e4e8">(@</span><span style="color:#f97583">PathVariable</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"skuId"</span><span style="color:#e1e4e8">)Long skuId){</span></span>
<span class="line"><span style="color:#e1e4e8">    SeckillSkuRedisTo to </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> seckillService.</span><span style="color:#b392f0">getSkuSeckillInfo</span><span style="color:#e1e4e8">(skuId);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> R.</span><span style="color:#b392f0">ok</span><span style="color:#e1e4e8">().</span><span style="color:#b392f0">setData</span><span style="color:#e1e4e8">(to);</span></span>
<span class="line"><span style="color:#e1e4e8">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e">@</span><span style="color:#d73a49">ResponseBody</span></span>
<span class="line"><span style="color:#24292e">@</span><span style="color:#d73a49">GetMapping</span><span style="color:#24292e">(</span><span style="color:#032f62">"/sku/seckill/{skuId}"</span><span style="color:#24292e">)</span></span>
<span class="line"><span style="color:#d73a49">public</span><span style="color:#24292e"> R </span><span style="color:#6f42c1">getSkuSeckillInfo</span><span style="color:#24292e">(@</span><span style="color:#d73a49">PathVariable</span><span style="color:#24292e">(</span><span style="color:#032f62">"skuId"</span><span style="color:#24292e">)Long skuId){</span></span>
<span class="line"><span style="color:#24292e">    SeckillSkuRedisTo to </span><span style="color:#d73a49">=</span><span style="color:#24292e"> seckillService.</span><span style="color:#6f42c1">getSkuSeckillInfo</span><span style="color:#24292e">(skuId);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">return</span><span style="color:#24292e"> R.</span><span style="color:#6f42c1">ok</span><span style="color:#24292e">().</span><span style="color:#6f42c1">setData</span><span style="color:#24292e">(to);</span></span>
<span class="line"><span style="color:#24292e">}</span></span></code></pre></div><ul><li>获取秒杀信息方法实现（正则匹配BUG已修复）</li></ul><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8">@</span><span style="color:#f97583">Override</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">public</span><span style="color:#e1e4e8"> SeckillSkuRedisTo </span><span style="color:#b392f0">getSkuSeckillInfo</span><span style="color:#e1e4e8">(Long skuId) {</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#6a737d">//1、找到所有需要参与秒杀的商品的key</span></span>
<span class="line"><span style="color:#e1e4e8">        BoundHashOperations&lt;</span><span style="color:#f97583">String</span><span style="color:#e1e4e8">, </span><span style="color:#f97583">String</span><span style="color:#e1e4e8">, </span><span style="color:#f97583">String</span><span style="color:#e1e4e8">&gt; hashOps </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> redisTemplate.</span><span style="color:#b392f0">boundHashOps</span><span style="color:#e1e4e8">(SKUKILL_CACHE_PREFOX);</span></span>
<span class="line"><span style="color:#e1e4e8">        Set&lt;</span><span style="color:#f97583">String</span><span style="color:#e1e4e8">&gt; keys </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> hashOps.</span><span style="color:#b392f0">keys</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (keys </span><span style="color:#f97583">!=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">&amp;&amp;</span><span style="color:#e1e4e8"> keys.</span><span style="color:#b392f0">size</span><span style="color:#e1e4e8">() </span><span style="color:#f97583">&gt;</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#6a737d">//todo 正则匹配2位数</span></span>
<span class="line"><span style="color:#e1e4e8">            String regx </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#9ecbff">"</span><span style="color:#79b8ff">\\</span><span style="color:#9ecbff">d</span><span style="color:#79b8ff">\\</span><span style="color:#9ecbff">d_"</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">+</span><span style="color:#e1e4e8"> skuId;</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#6a737d">//创建匹配模式</span></span>
<span class="line"><span style="color:#6a737d">//            Pattern pattern = Pattern.compile("\\d_");//匹配一个或多个数字字符</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#6a737d">//2.选择匹配对象</span></span>
<span class="line"><span style="color:#6a737d">//            Matcher matcher = pattern.matcher(skuId.toString());</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">for</span><span style="color:#e1e4e8"> (String key </span><span style="color:#f97583">:</span><span style="color:#e1e4e8"> keys) {</span></span>
<span class="line"><span style="color:#e1e4e8">                log.</span><span style="color:#b392f0">info</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"test:{}"</span><span style="color:#e1e4e8">,  Pattern.</span><span style="color:#b392f0">matches</span><span style="color:#e1e4e8">(regx, key));</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#6a737d">// 6_4</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (Pattern.</span><span style="color:#b392f0">matches</span><span style="color:#e1e4e8">(regx, key)) {</span></span>
<span class="line"><span style="color:#6a737d">//                if (regx.matches(key)) {</span></span>
<span class="line"><span style="color:#6a737d">//                if (matcher.find()) {</span></span>
<span class="line"><span style="color:#e1e4e8">                    String json </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> hashOps.</span><span style="color:#b392f0">get</span><span style="color:#e1e4e8">(key);</span></span>
<span class="line"><span style="color:#e1e4e8">                    SeckillSkuRedisTo skuRedisTo </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> JSON.</span><span style="color:#b392f0">parseObject</span><span style="color:#e1e4e8">(json, SeckillSkuRedisTo.class);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">                    </span><span style="color:#6a737d">//处理随机码</span></span>
<span class="line"><span style="color:#e1e4e8">                    </span><span style="color:#f97583">long</span><span style="color:#e1e4e8"> current </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> System.</span><span style="color:#b392f0">currentTimeMillis</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">                    </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (current </span><span style="color:#f97583">&gt;=</span><span style="color:#e1e4e8"> skuRedisTo.</span><span style="color:#b392f0">getStartTime</span><span style="color:#e1e4e8">() </span><span style="color:#f97583">&amp;&amp;</span><span style="color:#e1e4e8"> current </span><span style="color:#f97583">&lt;=</span><span style="color:#e1e4e8"> skuRedisTo.</span><span style="color:#b392f0">getEndTime</span><span style="color:#e1e4e8">()) {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">                    } </span><span style="color:#f97583">else</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">                        </span><span style="color:#6a737d">//在时间范围外直接置空</span></span>
<span class="line"><span style="color:#e1e4e8">                        skuRedisTo.</span><span style="color:#b392f0">setRandomCode</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">                    }</span></span>
<span class="line"><span style="color:#e1e4e8">                    </span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> skuRedisTo;</span></span>
<span class="line"><span style="color:#e1e4e8">                }</span></span>
<span class="line"><span style="color:#e1e4e8">            }</span></span>
<span class="line"><span style="color:#e1e4e8">        }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e">@</span><span style="color:#d73a49">Override</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">public</span><span style="color:#24292e"> SeckillSkuRedisTo </span><span style="color:#6f42c1">getSkuSeckillInfo</span><span style="color:#24292e">(Long skuId) {</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6a737d">//1、找到所有需要参与秒杀的商品的key</span></span>
<span class="line"><span style="color:#24292e">        BoundHashOperations&lt;</span><span style="color:#d73a49">String</span><span style="color:#24292e">, </span><span style="color:#d73a49">String</span><span style="color:#24292e">, </span><span style="color:#d73a49">String</span><span style="color:#24292e">&gt; hashOps </span><span style="color:#d73a49">=</span><span style="color:#24292e"> redisTemplate.</span><span style="color:#6f42c1">boundHashOps</span><span style="color:#24292e">(SKUKILL_CACHE_PREFOX);</span></span>
<span class="line"><span style="color:#24292e">        Set&lt;</span><span style="color:#d73a49">String</span><span style="color:#24292e">&gt; keys </span><span style="color:#d73a49">=</span><span style="color:#24292e"> hashOps.</span><span style="color:#6f42c1">keys</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (keys </span><span style="color:#d73a49">!=</span><span style="color:#24292e"> </span><span style="color:#005cc5">null</span><span style="color:#24292e"> </span><span style="color:#d73a49">&amp;&amp;</span><span style="color:#24292e"> keys.</span><span style="color:#6f42c1">size</span><span style="color:#24292e">() </span><span style="color:#d73a49">&gt;</span><span style="color:#24292e"> </span><span style="color:#005cc5">0</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#6a737d">//todo 正则匹配2位数</span></span>
<span class="line"><span style="color:#24292e">            String regx </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#032f62">"</span><span style="color:#005cc5">\\</span><span style="color:#032f62">d</span><span style="color:#005cc5">\\</span><span style="color:#032f62">d_"</span><span style="color:#24292e"> </span><span style="color:#d73a49">+</span><span style="color:#24292e"> skuId;</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#6a737d">//创建匹配模式</span></span>
<span class="line"><span style="color:#6a737d">//            Pattern pattern = Pattern.compile("\\d_");//匹配一个或多个数字字符</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#6a737d">//2.选择匹配对象</span></span>
<span class="line"><span style="color:#6a737d">//            Matcher matcher = pattern.matcher(skuId.toString());</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">for</span><span style="color:#24292e"> (String key </span><span style="color:#d73a49">:</span><span style="color:#24292e"> keys) {</span></span>
<span class="line"><span style="color:#24292e">                log.</span><span style="color:#6f42c1">info</span><span style="color:#24292e">(</span><span style="color:#032f62">"test:{}"</span><span style="color:#24292e">,  Pattern.</span><span style="color:#6f42c1">matches</span><span style="color:#24292e">(regx, key));</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#6a737d">// 6_4</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (Pattern.</span><span style="color:#6f42c1">matches</span><span style="color:#24292e">(regx, key)) {</span></span>
<span class="line"><span style="color:#6a737d">//                if (regx.matches(key)) {</span></span>
<span class="line"><span style="color:#6a737d">//                if (matcher.find()) {</span></span>
<span class="line"><span style="color:#24292e">                    String json </span><span style="color:#d73a49">=</span><span style="color:#24292e"> hashOps.</span><span style="color:#6f42c1">get</span><span style="color:#24292e">(key);</span></span>
<span class="line"><span style="color:#24292e">                    SeckillSkuRedisTo skuRedisTo </span><span style="color:#d73a49">=</span><span style="color:#24292e"> JSON.</span><span style="color:#6f42c1">parseObject</span><span style="color:#24292e">(json, SeckillSkuRedisTo.class);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">                    </span><span style="color:#6a737d">//处理随机码</span></span>
<span class="line"><span style="color:#24292e">                    </span><span style="color:#d73a49">long</span><span style="color:#24292e"> current </span><span style="color:#d73a49">=</span><span style="color:#24292e"> System.</span><span style="color:#6f42c1">currentTimeMillis</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">                    </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (current </span><span style="color:#d73a49">&gt;=</span><span style="color:#24292e"> skuRedisTo.</span><span style="color:#6f42c1">getStartTime</span><span style="color:#24292e">() </span><span style="color:#d73a49">&amp;&amp;</span><span style="color:#24292e"> current </span><span style="color:#d73a49">&lt;=</span><span style="color:#24292e"> skuRedisTo.</span><span style="color:#6f42c1">getEndTime</span><span style="color:#24292e">()) {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">                    } </span><span style="color:#d73a49">else</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">                        </span><span style="color:#6a737d">//在时间范围外直接置空</span></span>
<span class="line"><span style="color:#24292e">                        skuRedisTo.</span><span style="color:#6f42c1">setRandomCode</span><span style="color:#24292e">(</span><span style="color:#005cc5">null</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">                    }</span></span>
<span class="line"><span style="color:#24292e">                    </span><span style="color:#d73a49">return</span><span style="color:#24292e"> skuRedisTo;</span></span>
<span class="line"><span style="color:#24292e">                }</span></span>
<span class="line"><span style="color:#24292e">            }</span></span>
<span class="line"><span style="color:#24292e">        }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">return</span><span style="color:#24292e"> </span><span style="color:#005cc5">null</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">    }</span></span></code></pre></div><ul><li>sku详情页获取商品（秒杀）详情接口</li></ul><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6a737d">/**</span></span>
<span class="line"><span style="color:#6a737d"> * 展示当前sku的详情</span></span>
<span class="line"><span style="color:#6a737d"> * </span><span style="color:#f97583">@param</span><span style="color:#6a737d"> </span><span style="color:#ffab70">skuId</span></span>
<span class="line"><span style="color:#6a737d"> * </span><span style="color:#f97583">@return</span></span>
<span class="line"><span style="color:#6a737d"> */</span></span>
<span class="line"><span style="color:#e1e4e8">@</span><span style="color:#f97583">GetMapping</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"/{skuId}.html"</span><span style="color:#e1e4e8">)</span></span>
<span class="line"><span style="color:#f97583">public</span><span style="color:#e1e4e8"> String </span><span style="color:#b392f0">skuItem</span><span style="color:#e1e4e8">(@</span><span style="color:#f97583">PathVariable</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"skuId"</span><span style="color:#e1e4e8">)Long skuId, Model model) throws ExecutionException, InterruptedException {</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">    System.out.</span><span style="color:#b392f0">println</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"准备查询"</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">+</span><span style="color:#e1e4e8"> skuId </span><span style="color:#f97583">+</span><span style="color:#e1e4e8"> </span><span style="color:#9ecbff">"详情"</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">    SkuItemVo vo </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> skuInfoService.</span><span style="color:#b392f0">item</span><span style="color:#e1e4e8">(skuId);</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">//页面渲染</span></span>
<span class="line"><span style="color:#e1e4e8">    model.</span><span style="color:#b392f0">addAttribute</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"item"</span><span style="color:#e1e4e8">, vo);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> </span><span style="color:#9ecbff">"item"</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6a737d">/**</span></span>
<span class="line"><span style="color:#6a737d"> * 展示当前sku的详情</span></span>
<span class="line"><span style="color:#6a737d"> * </span><span style="color:#d73a49">@param</span><span style="color:#6a737d"> </span><span style="color:#e36209">skuId</span></span>
<span class="line"><span style="color:#6a737d"> * </span><span style="color:#d73a49">@return</span></span>
<span class="line"><span style="color:#6a737d"> */</span></span>
<span class="line"><span style="color:#24292e">@</span><span style="color:#d73a49">GetMapping</span><span style="color:#24292e">(</span><span style="color:#032f62">"/{skuId}.html"</span><span style="color:#24292e">)</span></span>
<span class="line"><span style="color:#d73a49">public</span><span style="color:#24292e"> String </span><span style="color:#6f42c1">skuItem</span><span style="color:#24292e">(@</span><span style="color:#d73a49">PathVariable</span><span style="color:#24292e">(</span><span style="color:#032f62">"skuId"</span><span style="color:#24292e">)Long skuId, Model model) throws ExecutionException, InterruptedException {</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">    System.out.</span><span style="color:#6f42c1">println</span><span style="color:#24292e">(</span><span style="color:#032f62">"准备查询"</span><span style="color:#24292e"> </span><span style="color:#d73a49">+</span><span style="color:#24292e"> skuId </span><span style="color:#d73a49">+</span><span style="color:#24292e"> </span><span style="color:#032f62">"详情"</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">    SkuItemVo vo </span><span style="color:#d73a49">=</span><span style="color:#24292e"> skuInfoService.</span><span style="color:#6f42c1">item</span><span style="color:#24292e">(skuId);</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">//页面渲染</span></span>
<span class="line"><span style="color:#24292e">    model.</span><span style="color:#6f42c1">addAttribute</span><span style="color:#24292e">(</span><span style="color:#032f62">"item"</span><span style="color:#24292e">, vo);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">return</span><span style="color:#24292e"> </span><span style="color:#032f62">"item"</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">}</span></span></code></pre></div><ul><li><p>获取商品（秒杀）详情方法实现</p><ul><li>秒杀详情数据传输vo</li></ul><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6a737d">/**</span></span>
<span class="line"><span style="color:#6a737d"> * </span><span style="color:#f97583">@author</span><span style="color:#6a737d"> Klaus</span></span>
<span class="line"><span style="color:#6a737d"> * @date 2022/9/28</span></span>
<span class="line"><span style="color:#6a737d"> */</span></span>
<span class="line"><span style="color:#e1e4e8">@</span><span style="color:#f97583">Data</span></span>
<span class="line"><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">class</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">SeckillInfoVo</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6a737d">    /**</span></span>
<span class="line"><span style="color:#6a737d">     * 活动id</span></span>
<span class="line"><span style="color:#6a737d">     */</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">private</span><span style="color:#e1e4e8"> Long promotionId;</span></span>
<span class="line"><span style="color:#6a737d">    /**</span></span>
<span class="line"><span style="color:#6a737d">     * 活动场次id</span></span>
<span class="line"><span style="color:#6a737d">     */</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">private</span><span style="color:#e1e4e8"> Long promotionSessionId;</span></span>
<span class="line"><span style="color:#6a737d">    /**</span></span>
<span class="line"><span style="color:#6a737d">     * 商品id</span></span>
<span class="line"><span style="color:#6a737d">     */</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">private</span><span style="color:#e1e4e8"> Long skuId;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6a737d">    /**</span></span>
<span class="line"><span style="color:#6a737d">     * 商品秒杀随机码</span></span>
<span class="line"><span style="color:#6a737d">     */</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">private</span><span style="color:#e1e4e8"> String randomCode;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6a737d">    /**</span></span>
<span class="line"><span style="color:#6a737d">     * 秒杀价格</span></span>
<span class="line"><span style="color:#6a737d">     */</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">private</span><span style="color:#e1e4e8"> BigDecimal seckillPrice;</span></span>
<span class="line"><span style="color:#6a737d">    /**</span></span>
<span class="line"><span style="color:#6a737d">     * 秒杀总量</span></span>
<span class="line"><span style="color:#6a737d">     */</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">private</span><span style="color:#e1e4e8"> BigDecimal seckillCount;</span></span>
<span class="line"><span style="color:#6a737d">    /**</span></span>
<span class="line"><span style="color:#6a737d">     * 每人限购数量</span></span>
<span class="line"><span style="color:#6a737d">     */</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">private</span><span style="color:#e1e4e8"> BigDecimal seckillLimit;</span></span>
<span class="line"><span style="color:#6a737d">    /**</span></span>
<span class="line"><span style="color:#6a737d">     * 排序</span></span>
<span class="line"><span style="color:#6a737d">     */</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">private</span><span style="color:#e1e4e8"> Integer seckillSort;</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#6a737d">    /**</span></span>
<span class="line"><span style="color:#6a737d">     * 当前商品秒杀的开始时间</span></span>
<span class="line"><span style="color:#6a737d">     */</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">private</span><span style="color:#e1e4e8"> Long startTime;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6a737d">    /**</span></span>
<span class="line"><span style="color:#6a737d">     * 当前商品秒杀的结束时间</span></span>
<span class="line"><span style="color:#6a737d">     */</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">private</span><span style="color:#e1e4e8"> Long endTime;</span></span>
<span class="line"><span style="color:#e1e4e8">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6a737d">/**</span></span>
<span class="line"><span style="color:#6a737d"> * </span><span style="color:#d73a49">@author</span><span style="color:#6a737d"> Klaus</span></span>
<span class="line"><span style="color:#6a737d"> * @date 2022/9/28</span></span>
<span class="line"><span style="color:#6a737d"> */</span></span>
<span class="line"><span style="color:#24292e">@</span><span style="color:#d73a49">Data</span></span>
<span class="line"><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">class</span><span style="color:#24292e"> </span><span style="color:#6f42c1">SeckillInfoVo</span><span style="color:#24292e"> {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6a737d">    /**</span></span>
<span class="line"><span style="color:#6a737d">     * 活动id</span></span>
<span class="line"><span style="color:#6a737d">     */</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">private</span><span style="color:#24292e"> Long promotionId;</span></span>
<span class="line"><span style="color:#6a737d">    /**</span></span>
<span class="line"><span style="color:#6a737d">     * 活动场次id</span></span>
<span class="line"><span style="color:#6a737d">     */</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">private</span><span style="color:#24292e"> Long promotionSessionId;</span></span>
<span class="line"><span style="color:#6a737d">    /**</span></span>
<span class="line"><span style="color:#6a737d">     * 商品id</span></span>
<span class="line"><span style="color:#6a737d">     */</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">private</span><span style="color:#24292e"> Long skuId;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6a737d">    /**</span></span>
<span class="line"><span style="color:#6a737d">     * 商品秒杀随机码</span></span>
<span class="line"><span style="color:#6a737d">     */</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">private</span><span style="color:#24292e"> String randomCode;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6a737d">    /**</span></span>
<span class="line"><span style="color:#6a737d">     * 秒杀价格</span></span>
<span class="line"><span style="color:#6a737d">     */</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">private</span><span style="color:#24292e"> BigDecimal seckillPrice;</span></span>
<span class="line"><span style="color:#6a737d">    /**</span></span>
<span class="line"><span style="color:#6a737d">     * 秒杀总量</span></span>
<span class="line"><span style="color:#6a737d">     */</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">private</span><span style="color:#24292e"> BigDecimal seckillCount;</span></span>
<span class="line"><span style="color:#6a737d">    /**</span></span>
<span class="line"><span style="color:#6a737d">     * 每人限购数量</span></span>
<span class="line"><span style="color:#6a737d">     */</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">private</span><span style="color:#24292e"> BigDecimal seckillLimit;</span></span>
<span class="line"><span style="color:#6a737d">    /**</span></span>
<span class="line"><span style="color:#6a737d">     * 排序</span></span>
<span class="line"><span style="color:#6a737d">     */</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">private</span><span style="color:#24292e"> Integer seckillSort;</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#6a737d">    /**</span></span>
<span class="line"><span style="color:#6a737d">     * 当前商品秒杀的开始时间</span></span>
<span class="line"><span style="color:#6a737d">     */</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">private</span><span style="color:#24292e"> Long startTime;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6a737d">    /**</span></span>
<span class="line"><span style="color:#6a737d">     * 当前商品秒杀的结束时间</span></span>
<span class="line"><span style="color:#6a737d">     */</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">private</span><span style="color:#24292e"> Long endTime;</span></span>
<span class="line"><span style="color:#24292e">}</span></span></code></pre></div></li></ul><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8">@</span><span style="color:#f97583">Resource</span></span>
<span class="line"><span style="color:#e1e4e8">    SeckillFeignService seckillFeignService;</span></span>
<span class="line"><span style="color:#e1e4e8">	@</span><span style="color:#f97583">Override</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">public</span><span style="color:#e1e4e8"> SkuItemVo </span><span style="color:#b392f0">item</span><span style="color:#e1e4e8">(Long skuId) throws ExecutionException, InterruptedException {</span></span>
<span class="line"><span style="color:#e1e4e8">        SkuItemVo skuItemVo </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">SkuItemVo</span><span style="color:#e1e4e8">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">        ......</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">        CompletableFuture&lt;</span><span style="color:#f97583">Void</span><span style="color:#e1e4e8">&gt; seckillFuture </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> CompletableFuture.</span><span style="color:#b392f0">runAsync</span><span style="color:#e1e4e8">(() </span><span style="color:#f97583">-&gt;</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#6a737d">// 秒杀信息</span></span>
<span class="line"><span style="color:#e1e4e8">            R r </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> seckillFeignService.</span><span style="color:#b392f0">getSkuSeckillInfo</span><span style="color:#e1e4e8">(skuId);</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (r.</span><span style="color:#b392f0">getCode</span><span style="color:#e1e4e8">() </span><span style="color:#f97583">==</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#6a737d">//远程调用成功</span></span>
<span class="line"><span style="color:#e1e4e8">                SeckillInfoVo data </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> r.</span><span style="color:#b392f0">getData</span><span style="color:#e1e4e8">(</span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> TypeReference&lt;</span><span style="color:#f97583">SeckillInfoVo</span><span style="color:#e1e4e8">&gt;() {</span></span>
<span class="line"><span style="color:#e1e4e8">                });</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (data </span><span style="color:#f97583">!=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">                    skuItemVo.</span><span style="color:#b392f0">setSeckillInfo</span><span style="color:#e1e4e8">(data);</span></span>
<span class="line"><span style="color:#e1e4e8">                }</span></span>
<span class="line"><span style="color:#e1e4e8">            }</span></span>
<span class="line"><span style="color:#e1e4e8">        }, productThreadPoolExecutor);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#6a737d">//等待所有的任务都完成</span></span>
<span class="line"><span style="color:#e1e4e8">        CompletableFuture.</span><span style="color:#b392f0">allOf</span><span style="color:#e1e4e8">(saleAttrFuture, descFuture, baseAttrFuture, imageFuture, seckillFuture).</span><span style="color:#b392f0">get</span><span style="color:#e1e4e8">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> skuItemVo;</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e">@</span><span style="color:#d73a49">Resource</span></span>
<span class="line"><span style="color:#24292e">    SeckillFeignService seckillFeignService;</span></span>
<span class="line"><span style="color:#24292e">	@</span><span style="color:#d73a49">Override</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">public</span><span style="color:#24292e"> SkuItemVo </span><span style="color:#6f42c1">item</span><span style="color:#24292e">(Long skuId) throws ExecutionException, InterruptedException {</span></span>
<span class="line"><span style="color:#24292e">        SkuItemVo skuItemVo </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">SkuItemVo</span><span style="color:#24292e">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">        ......</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">        CompletableFuture&lt;</span><span style="color:#d73a49">Void</span><span style="color:#24292e">&gt; seckillFuture </span><span style="color:#d73a49">=</span><span style="color:#24292e"> CompletableFuture.</span><span style="color:#6f42c1">runAsync</span><span style="color:#24292e">(() </span><span style="color:#d73a49">-&gt;</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#6a737d">// 秒杀信息</span></span>
<span class="line"><span style="color:#24292e">            R r </span><span style="color:#d73a49">=</span><span style="color:#24292e"> seckillFeignService.</span><span style="color:#6f42c1">getSkuSeckillInfo</span><span style="color:#24292e">(skuId);</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (r.</span><span style="color:#6f42c1">getCode</span><span style="color:#24292e">() </span><span style="color:#d73a49">==</span><span style="color:#24292e"> </span><span style="color:#005cc5">0</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#6a737d">//远程调用成功</span></span>
<span class="line"><span style="color:#24292e">                SeckillInfoVo data </span><span style="color:#d73a49">=</span><span style="color:#24292e"> r.</span><span style="color:#6f42c1">getData</span><span style="color:#24292e">(</span><span style="color:#d73a49">new</span><span style="color:#24292e"> TypeReference&lt;</span><span style="color:#d73a49">SeckillInfoVo</span><span style="color:#24292e">&gt;() {</span></span>
<span class="line"><span style="color:#24292e">                });</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (data </span><span style="color:#d73a49">!=</span><span style="color:#24292e"> </span><span style="color:#005cc5">null</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">                    skuItemVo.</span><span style="color:#6f42c1">setSeckillInfo</span><span style="color:#24292e">(data);</span></span>
<span class="line"><span style="color:#24292e">                }</span></span>
<span class="line"><span style="color:#24292e">            }</span></span>
<span class="line"><span style="color:#24292e">        }, productThreadPoolExecutor);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6a737d">//等待所有的任务都完成</span></span>
<span class="line"><span style="color:#24292e">        CompletableFuture.</span><span style="color:#6f42c1">allOf</span><span style="color:#24292e">(saleAttrFuture, descFuture, baseAttrFuture, imageFuture, seckillFuture).</span><span style="color:#6f42c1">get</span><span style="color:#24292e">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">return</span><span style="color:#24292e"> skuItemVo;</span></span>
<span class="line"><span style="color:#24292e">    }</span></span></code></pre></div><figure><img src="https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230428202310827.png" alt="image-20230428202310827" loading="lazy" decoding="async"></figure><figure><img src="https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230428202403297.png" alt="image-20230428202403297" loading="lazy" decoding="async"></figure><h4 id="_3-5-秒杀系统设计" tabindex="-1">3.5 秒杀系统设计 <a aria-current="page" href="/posts/flash%20killing#_3-5-秒杀系统设计" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h4><figure><img src="https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230429225031339.png" alt="image-20230429225031339" loading="lazy" decoding="async"></figure><figure><img src="https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230429225211015.png" alt="image-20230429225211015" loading="lazy" decoding="async"></figure><h4 id="_3-6-登录检查" tabindex="-1">3.6 登录检查 <a aria-current="page" href="/posts/flash%20killing#_3-6-登录检查" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h4><ul><li>引入Spring Session依赖</li></ul><div class="language-xml"><button title="Copy Code" class="copy"></button><span class="lang">xml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8">&lt;</span><span style="color:#85e89d">dependency</span><span style="color:#e1e4e8">&gt;</span></span>
<span class="line"><span style="color:#e1e4e8">    &lt;</span><span style="color:#85e89d">groupId</span><span style="color:#e1e4e8">&gt;org.springframework.session&lt;/</span><span style="color:#85e89d">groupId</span><span style="color:#e1e4e8">&gt;</span></span>
<span class="line"><span style="color:#e1e4e8">    &lt;</span><span style="color:#85e89d">artifactId</span><span style="color:#e1e4e8">&gt;spring-session-data-redis&lt;/</span><span style="color:#85e89d">artifactId</span><span style="color:#e1e4e8">&gt;</span></span>
<span class="line"><span style="color:#e1e4e8">&lt;/</span><span style="color:#85e89d">dependency</span><span style="color:#e1e4e8">&gt;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e">&lt;</span><span style="color:#22863a">dependency</span><span style="color:#24292e">&gt;</span></span>
<span class="line"><span style="color:#24292e">    &lt;</span><span style="color:#22863a">groupId</span><span style="color:#24292e">&gt;org.springframework.session&lt;/</span><span style="color:#22863a">groupId</span><span style="color:#24292e">&gt;</span></span>
<span class="line"><span style="color:#24292e">    &lt;</span><span style="color:#22863a">artifactId</span><span style="color:#24292e">&gt;spring-session-data-redis&lt;/</span><span style="color:#22863a">artifactId</span><span style="color:#24292e">&gt;</span></span>
<span class="line"><span style="color:#24292e">&lt;/</span><span style="color:#22863a">dependency</span><span style="color:#24292e">&gt;</span></span></code></pre></div><ul><li>Session配置类</li></ul><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8">@</span><span style="color:#f97583">EnableRedisHttpSession</span></span>
<span class="line"><span style="color:#e1e4e8">@</span><span style="color:#f97583">Configuration</span></span>
<span class="line"><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">class</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">GulimallSessionConfig</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">    @</span><span style="color:#f97583">Bean</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">public</span><span style="color:#e1e4e8"> CookieSerializer </span><span style="color:#b392f0">cookieSerializer</span><span style="color:#e1e4e8">(){</span></span>
<span class="line"><span style="color:#e1e4e8">        DefaultCookieSerializer cookieSerializer </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">DefaultCookieSerializer</span><span style="color:#e1e4e8">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">        cookieSerializer.</span><span style="color:#b392f0">setDomainName</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"gulimall.com"</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">        cookieSerializer.</span><span style="color:#b392f0">setCookieName</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"KLAUSSESSION"</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> cookieSerializer;</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">    @</span><span style="color:#f97583">Bean</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">public</span><span style="color:#e1e4e8"> RedisSerializer&lt;</span><span style="color:#f97583">Object</span><span style="color:#e1e4e8">&gt; </span><span style="color:#b392f0">springSessionDefaultRedisSerializer</span><span style="color:#e1e4e8">() {</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">GenericJackson2JsonRedisSerializer</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"><span style="color:#e1e4e8">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e">@</span><span style="color:#d73a49">EnableRedisHttpSession</span></span>
<span class="line"><span style="color:#24292e">@</span><span style="color:#d73a49">Configuration</span></span>
<span class="line"><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">class</span><span style="color:#24292e"> </span><span style="color:#6f42c1">GulimallSessionConfig</span><span style="color:#24292e"> {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">    @</span><span style="color:#d73a49">Bean</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">public</span><span style="color:#24292e"> CookieSerializer </span><span style="color:#6f42c1">cookieSerializer</span><span style="color:#24292e">(){</span></span>
<span class="line"><span style="color:#24292e">        DefaultCookieSerializer cookieSerializer </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">DefaultCookieSerializer</span><span style="color:#24292e">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">        cookieSerializer.</span><span style="color:#6f42c1">setDomainName</span><span style="color:#24292e">(</span><span style="color:#032f62">"gulimall.com"</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">        cookieSerializer.</span><span style="color:#6f42c1">setCookieName</span><span style="color:#24292e">(</span><span style="color:#032f62">"KLAUSSESSION"</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">return</span><span style="color:#24292e"> cookieSerializer;</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">    @</span><span style="color:#d73a49">Bean</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">public</span><span style="color:#24292e"> RedisSerializer&lt;</span><span style="color:#d73a49">Object</span><span style="color:#24292e">&gt; </span><span style="color:#6f42c1">springSessionDefaultRedisSerializer</span><span style="color:#24292e">() {</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">return</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">GenericJackson2JsonRedisSerializer</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"><span style="color:#24292e">}</span></span></code></pre></div><ul><li>相关配置</li></ul><div class="language-properties"><button title="Copy Code" class="copy"></button><span class="lang">properties</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#f97583">spring.session.store-type</span><span style="color:#e1e4e8">=REDIS</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#d73a49">spring.session.store-type</span><span style="color:#24292e">=REDIS</span></span></code></pre></div><ul><li>添加登录拦截器</li></ul><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8">@</span><span style="color:#f97583">Component</span></span>
<span class="line"><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">class</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">LoginUserInterceptor</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">implements</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">HandlerInterceptor</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">static</span><span style="color:#e1e4e8"> ThreadLocal&lt;</span><span style="color:#f97583">MemberRespVo</span><span style="color:#e1e4e8">&gt; loginUser </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> ThreadLocal&lt;&gt;();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">    @</span><span style="color:#f97583">Override</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">boolean</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">preHandle</span><span style="color:#e1e4e8">(HttpServletRequest </span><span style="color:#ffab70">request</span><span style="color:#e1e4e8">, HttpServletResponse </span><span style="color:#ffab70">response</span><span style="color:#e1e4e8">, Object </span><span style="color:#ffab70">handler</span><span style="color:#e1e4e8">) </span><span style="color:#f97583">throws</span><span style="color:#e1e4e8"> Exception {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#6a737d">///order/order/status/{orderSn}</span></span>
<span class="line"><span style="color:#e1e4e8">        String uri </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> request.</span><span style="color:#b392f0">getRequestURI</span><span style="color:#e1e4e8">();</span><span style="color:#6a737d">//  /order/order/status/</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#6a737d">//                  路径匹配器</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">boolean</span><span style="color:#e1e4e8"> match </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">AntPathMatcher</span><span style="color:#e1e4e8">().</span><span style="color:#b392f0">match</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"/kill"</span><span style="color:#e1e4e8">, uri);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (match){</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#6a737d">//路径匹配进行登录拦截</span></span>
<span class="line"><span style="color:#e1e4e8">            MemberRespVo attribute </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> (MemberRespVo) request.</span><span style="color:#b392f0">getSession</span><span style="color:#e1e4e8">().</span><span style="color:#b392f0">getAttribute</span><span style="color:#e1e4e8">(AuthServerConstant.LOGIN_USER);</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#6a737d">//判断用户是否登录</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (attribute </span><span style="color:#f97583">!=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8">){</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#6a737d">//登录了</span></span>
<span class="line"><span style="color:#e1e4e8">                loginUser.</span><span style="color:#b392f0">set</span><span style="color:#e1e4e8">(attribute);</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">true</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">            }</span><span style="color:#f97583">else</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#6a737d">//未登录就去登录</span></span>
<span class="line"><span style="color:#e1e4e8">                request.</span><span style="color:#b392f0">getSession</span><span style="color:#e1e4e8">().</span><span style="color:#b392f0">setAttribute</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"msg"</span><span style="color:#e1e4e8">, </span><span style="color:#9ecbff">"请先进行登录"</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">                response.</span><span style="color:#b392f0">sendRedirect</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"http://auth.gulimall.com/login.html"</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">false</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">            }</span></span>
<span class="line"><span style="color:#e1e4e8">        }</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">true</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"><span style="color:#e1e4e8">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e">@</span><span style="color:#d73a49">Component</span></span>
<span class="line"><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">class</span><span style="color:#24292e"> </span><span style="color:#6f42c1">LoginUserInterceptor</span><span style="color:#24292e"> </span><span style="color:#d73a49">implements</span><span style="color:#24292e"> </span><span style="color:#6f42c1">HandlerInterceptor</span><span style="color:#24292e"> {</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">static</span><span style="color:#24292e"> ThreadLocal&lt;</span><span style="color:#d73a49">MemberRespVo</span><span style="color:#24292e">&gt; loginUser </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> ThreadLocal&lt;&gt;();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">    @</span><span style="color:#d73a49">Override</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">boolean</span><span style="color:#24292e"> </span><span style="color:#6f42c1">preHandle</span><span style="color:#24292e">(HttpServletRequest </span><span style="color:#e36209">request</span><span style="color:#24292e">, HttpServletResponse </span><span style="color:#e36209">response</span><span style="color:#24292e">, Object </span><span style="color:#e36209">handler</span><span style="color:#24292e">) </span><span style="color:#d73a49">throws</span><span style="color:#24292e"> Exception {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6a737d">///order/order/status/{orderSn}</span></span>
<span class="line"><span style="color:#24292e">        String uri </span><span style="color:#d73a49">=</span><span style="color:#24292e"> request.</span><span style="color:#6f42c1">getRequestURI</span><span style="color:#24292e">();</span><span style="color:#6a737d">//  /order/order/status/</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6a737d">//                  路径匹配器</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">boolean</span><span style="color:#24292e"> match </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">AntPathMatcher</span><span style="color:#24292e">().</span><span style="color:#6f42c1">match</span><span style="color:#24292e">(</span><span style="color:#032f62">"/kill"</span><span style="color:#24292e">, uri);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (match){</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#6a737d">//路径匹配进行登录拦截</span></span>
<span class="line"><span style="color:#24292e">            MemberRespVo attribute </span><span style="color:#d73a49">=</span><span style="color:#24292e"> (MemberRespVo) request.</span><span style="color:#6f42c1">getSession</span><span style="color:#24292e">().</span><span style="color:#6f42c1">getAttribute</span><span style="color:#24292e">(AuthServerConstant.LOGIN_USER);</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#6a737d">//判断用户是否登录</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (attribute </span><span style="color:#d73a49">!=</span><span style="color:#24292e"> </span><span style="color:#005cc5">null</span><span style="color:#24292e">){</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#6a737d">//登录了</span></span>
<span class="line"><span style="color:#24292e">                loginUser.</span><span style="color:#6f42c1">set</span><span style="color:#24292e">(attribute);</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#d73a49">return</span><span style="color:#24292e"> </span><span style="color:#005cc5">true</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">            }</span><span style="color:#d73a49">else</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#6a737d">//未登录就去登录</span></span>
<span class="line"><span style="color:#24292e">                request.</span><span style="color:#6f42c1">getSession</span><span style="color:#24292e">().</span><span style="color:#6f42c1">setAttribute</span><span style="color:#24292e">(</span><span style="color:#032f62">"msg"</span><span style="color:#24292e">, </span><span style="color:#032f62">"请先进行登录"</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">                response.</span><span style="color:#6f42c1">sendRedirect</span><span style="color:#24292e">(</span><span style="color:#032f62">"http://auth.gulimall.com/login.html"</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#d73a49">return</span><span style="color:#24292e"> </span><span style="color:#005cc5">false</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">            }</span></span>
<span class="line"><span style="color:#24292e">        }</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">return</span><span style="color:#24292e"> </span><span style="color:#005cc5">true</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"><span style="color:#24292e">}</span></span></code></pre></div><ul><li>拦截器注册</li></ul><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8">@</span><span style="color:#f97583">Configuration</span></span>
<span class="line"><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">class</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">SeckillWebConfig</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">implements</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">WebMvcConfigurer</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">    @</span><span style="color:#f97583">Autowired</span></span>
<span class="line"><span style="color:#e1e4e8">    LoginUserInterceptor loginUserInterceptor;</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">    @</span><span style="color:#f97583">Override</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">void</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">addInterceptors</span><span style="color:#e1e4e8">(InterceptorRegistry </span><span style="color:#ffab70">registry</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">        registry.</span><span style="color:#b392f0">addInterceptor</span><span style="color:#e1e4e8">(loginUserInterceptor).</span><span style="color:#b392f0">addPathPatterns</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"/**"</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"><span style="color:#e1e4e8">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e">@</span><span style="color:#d73a49">Configuration</span></span>
<span class="line"><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">class</span><span style="color:#24292e"> </span><span style="color:#6f42c1">SeckillWebConfig</span><span style="color:#24292e"> </span><span style="color:#d73a49">implements</span><span style="color:#24292e"> </span><span style="color:#6f42c1">WebMvcConfigurer</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">    @</span><span style="color:#d73a49">Autowired</span></span>
<span class="line"><span style="color:#24292e">    LoginUserInterceptor loginUserInterceptor;</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">    @</span><span style="color:#d73a49">Override</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">void</span><span style="color:#24292e"> </span><span style="color:#6f42c1">addInterceptors</span><span style="color:#24292e">(InterceptorRegistry </span><span style="color:#e36209">registry</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">        registry.</span><span style="color:#6f42c1">addInterceptor</span><span style="color:#24292e">(loginUserInterceptor).</span><span style="color:#6f42c1">addPathPatterns</span><span style="color:#24292e">(</span><span style="color:#032f62">"/**"</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"><span style="color:#24292e">}</span></span></code></pre></div><ul><li>秒杀抢购未登录提示</li></ul><figure><img src="https://jsd.cdn.zzko.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230430155945442.png" alt="image-20230430155945442" loading="lazy" decoding="async"></figure><ul><li>未登录跳转到登录页</li></ul><figure><img src="https://jsd.cdn.zzko.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230430160017370.png" alt="image-20230430160017370" loading="lazy" decoding="async"></figure><h4 id="_3-7-秒杀流程" tabindex="-1">3.7 秒杀流程 <a aria-current="page" href="/posts/flash%20killing#_3-7-秒杀流程" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h4><figure><img src="https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230430003907398.png" alt="image-20230430003907398" loading="lazy" decoding="async"></figure><ul><li>秒杀成功页接口</li></ul><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8">@</span><span style="color:#f97583">GetMapping</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"/kill"</span><span style="color:#e1e4e8">)</span></span>
<span class="line"><span style="color:#f97583">public</span><span style="color:#e1e4e8"> String </span><span style="color:#b392f0">secKill</span><span style="color:#e1e4e8">(@</span><span style="color:#f97583">RequestParam</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"killId"</span><span style="color:#e1e4e8">) String killId,</span></span>
<span class="line"><span style="color:#e1e4e8">                      @</span><span style="color:#f97583">RequestParam</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"key"</span><span style="color:#e1e4e8">) String key,</span></span>
<span class="line"><span style="color:#e1e4e8">                      @</span><span style="color:#f97583">RequestParam</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"num"</span><span style="color:#e1e4e8">) Integer num,</span></span>
<span class="line"><span style="color:#e1e4e8">                      Model model){</span></span>
<span class="line"><span style="color:#e1e4e8">    String orderSn </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> seckillService.</span><span style="color:#b392f0">kill</span><span style="color:#e1e4e8">(killId, key, num);</span></span>
<span class="line"><span style="color:#e1e4e8">    </span></span>
<span class="line"><span style="color:#e1e4e8">    model.</span><span style="color:#b392f0">addAttribute</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"orderSn"</span><span style="color:#e1e4e8">, orderSn);</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">//1、判断是否登录</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> </span><span style="color:#9ecbff">"success"</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e">@</span><span style="color:#d73a49">GetMapping</span><span style="color:#24292e">(</span><span style="color:#032f62">"/kill"</span><span style="color:#24292e">)</span></span>
<span class="line"><span style="color:#d73a49">public</span><span style="color:#24292e"> String </span><span style="color:#6f42c1">secKill</span><span style="color:#24292e">(@</span><span style="color:#d73a49">RequestParam</span><span style="color:#24292e">(</span><span style="color:#032f62">"killId"</span><span style="color:#24292e">) String killId,</span></span>
<span class="line"><span style="color:#24292e">                      @</span><span style="color:#d73a49">RequestParam</span><span style="color:#24292e">(</span><span style="color:#032f62">"key"</span><span style="color:#24292e">) String key,</span></span>
<span class="line"><span style="color:#24292e">                      @</span><span style="color:#d73a49">RequestParam</span><span style="color:#24292e">(</span><span style="color:#032f62">"num"</span><span style="color:#24292e">) Integer num,</span></span>
<span class="line"><span style="color:#24292e">                      Model model){</span></span>
<span class="line"><span style="color:#24292e">    String orderSn </span><span style="color:#d73a49">=</span><span style="color:#24292e"> seckillService.</span><span style="color:#6f42c1">kill</span><span style="color:#24292e">(killId, key, num);</span></span>
<span class="line"><span style="color:#24292e">    </span></span>
<span class="line"><span style="color:#24292e">    model.</span><span style="color:#6f42c1">addAttribute</span><span style="color:#24292e">(</span><span style="color:#032f62">"orderSn"</span><span style="color:#24292e">, orderSn);</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">//1、判断是否登录</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">return</span><span style="color:#24292e"> </span><span style="color:#032f62">"success"</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">}</span></span></code></pre></div><ul><li>秒杀订单信息数据传输公共to<code>org.klaus.common.to.mq.SeckillOrderTo</code></li></ul><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6a737d">/**</span></span>
<span class="line"><span style="color:#6a737d"> * </span><span style="color:#f97583">@author</span><span style="color:#6a737d"> Klaus</span></span>
<span class="line"><span style="color:#6a737d"> * @date 2022/9/29</span></span>
<span class="line"><span style="color:#6a737d"> */</span></span>
<span class="line"><span style="color:#e1e4e8">@</span><span style="color:#f97583">Data</span></span>
<span class="line"><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">class</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">SeckillOrderTo</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">private</span><span style="color:#e1e4e8"> String orderSn;</span><span style="color:#6a737d">//订单号</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">private</span><span style="color:#e1e4e8"> Long promotionSessionId;</span><span style="color:#6a737d">//活动场次id</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">private</span><span style="color:#e1e4e8"> Long skuId;</span><span style="color:#6a737d">//商品id</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">private</span><span style="color:#e1e4e8"> BigDecimal seckillPrice;</span><span style="color:#6a737d">//秒杀价</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">private</span><span style="color:#e1e4e8"> Integer num;</span><span style="color:#6a737d">//购买数量</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">private</span><span style="color:#e1e4e8"> Long memberId;</span><span style="color:#6a737d">//会员id</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6a737d">//    private List&lt;String&gt; skuAttrs;//商品属性集</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6a737d">/**</span></span>
<span class="line"><span style="color:#6a737d"> * </span><span style="color:#d73a49">@author</span><span style="color:#6a737d"> Klaus</span></span>
<span class="line"><span style="color:#6a737d"> * @date 2022/9/29</span></span>
<span class="line"><span style="color:#6a737d"> */</span></span>
<span class="line"><span style="color:#24292e">@</span><span style="color:#d73a49">Data</span></span>
<span class="line"><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">class</span><span style="color:#24292e"> </span><span style="color:#6f42c1">SeckillOrderTo</span><span style="color:#24292e"> {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">private</span><span style="color:#24292e"> String orderSn;</span><span style="color:#6a737d">//订单号</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">private</span><span style="color:#24292e"> Long promotionSessionId;</span><span style="color:#6a737d">//活动场次id</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">private</span><span style="color:#24292e"> Long skuId;</span><span style="color:#6a737d">//商品id</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">private</span><span style="color:#24292e"> BigDecimal seckillPrice;</span><span style="color:#6a737d">//秒杀价</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">private</span><span style="color:#24292e"> Integer num;</span><span style="color:#6a737d">//购买数量</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">private</span><span style="color:#24292e"> Long memberId;</span><span style="color:#6a737d">//会员id</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6a737d">//    private List&lt;String&gt; skuAttrs;//商品属性集</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">}</span></span></code></pre></div><ul><li>秒杀方法实现</li></ul><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8">@</span><span style="color:#f97583">Override</span></span>
<span class="line"><span style="color:#f97583">public</span><span style="color:#e1e4e8"> String </span><span style="color:#b392f0">kill</span><span style="color:#e1e4e8">(String killId, String key, Integer num) {</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">long</span><span style="color:#e1e4e8"> s1 </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> System.</span><span style="color:#b392f0">currentTimeMillis</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">//获取当前登录的信息</span></span>
<span class="line"><span style="color:#e1e4e8">    MemberRespVo respVo </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> LoginUserInterceptor.loginUser.</span><span style="color:#b392f0">get</span><span style="color:#e1e4e8">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">//获取当前秒杀商品的详细信息</span></span>
<span class="line"><span style="color:#e1e4e8">    BoundHashOperations&lt;</span><span style="color:#f97583">String</span><span style="color:#e1e4e8">, </span><span style="color:#f97583">String</span><span style="color:#e1e4e8">, </span><span style="color:#f97583">String</span><span style="color:#e1e4e8">&gt; hashOps </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> redisTemplate.</span><span style="color:#b392f0">boundHashOps</span><span style="color:#e1e4e8">(SKUKILL_CACHE_PREFOX);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">    String json </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> hashOps.</span><span style="color:#b392f0">get</span><span style="color:#e1e4e8">(killId);</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (StringUtils.</span><span style="color:#b392f0">isEmpty</span><span style="color:#e1e4e8">(json)) {</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">    } </span><span style="color:#f97583">else</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">        SeckillSkuRedisTo redis </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> JSON.</span><span style="color:#b392f0">parseObject</span><span style="color:#e1e4e8">(json, SeckillSkuRedisTo.class);</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#6a737d">//1、校验合法性</span></span>
<span class="line"><span style="color:#e1e4e8">        Long startTime </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> redis.</span><span style="color:#b392f0">getStartTime</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">        Long endTime </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> redis.</span><span style="color:#b392f0">getEndTime</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">long</span><span style="color:#e1e4e8"> current </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> System.</span><span style="color:#b392f0">currentTimeMillis</span><span style="color:#e1e4e8">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#6a737d">//过期时间</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">long</span><span style="color:#e1e4e8"> ttl </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> endTime </span><span style="color:#f97583">-</span><span style="color:#e1e4e8"> current;</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (current </span><span style="color:#f97583">&gt;=</span><span style="color:#e1e4e8"> startTime </span><span style="color:#f97583">&amp;&amp;</span><span style="color:#e1e4e8"> current </span><span style="color:#f97583">&lt;=</span><span style="color:#e1e4e8"> endTime) {</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#6a737d">//2、校验随机码和商品id</span></span>
<span class="line"><span style="color:#e1e4e8">            String randomCode </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> redis.</span><span style="color:#b392f0">getRandomCode</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#6a737d">//   1_49</span></span>
<span class="line"><span style="color:#e1e4e8">            String seckillSkuId </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> redis.</span><span style="color:#b392f0">getPromotionSessionId</span><span style="color:#e1e4e8">() </span><span style="color:#f97583">+</span><span style="color:#e1e4e8"> </span><span style="color:#9ecbff">"_"</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">+</span><span style="color:#e1e4e8"> redis.</span><span style="color:#b392f0">getSkuId</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (randomCode.</span><span style="color:#b392f0">equals</span><span style="color:#e1e4e8">(key) </span><span style="color:#f97583">&amp;&amp;</span><span style="color:#e1e4e8"> killId.</span><span style="color:#b392f0">equals</span><span style="color:#e1e4e8">(seckillSkuId)) {</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#6a737d">//3、验证购物数量是否合理</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (num </span><span style="color:#f97583">&lt;=</span><span style="color:#e1e4e8"> redis.</span><span style="color:#b392f0">getSeckillLimit</span><span style="color:#e1e4e8">().</span><span style="color:#b392f0">intValue</span><span style="color:#e1e4e8">()) {</span></span>
<span class="line"><span style="color:#e1e4e8">                    </span><span style="color:#6a737d">//4、验证这个人是否已经购买过。幂等性；如果秒杀成功，就去占位，userId_sessionId_skuId</span></span>
<span class="line"><span style="color:#e1e4e8">                    String redisKey </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> respVo.</span><span style="color:#b392f0">getId</span><span style="color:#e1e4e8">() </span><span style="color:#f97583">+</span><span style="color:#e1e4e8"> </span><span style="color:#9ecbff">"_"</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">+</span><span style="color:#e1e4e8"> seckillSkuId;</span></span>
<span class="line"><span style="color:#e1e4e8">                    </span><span style="color:#6a737d">//自动过期                     SEINX 原子性</span></span>
<span class="line"><span style="color:#e1e4e8">                    Boolean aBoolean </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> redisTemplate.</span><span style="color:#b392f0">opsForValue</span><span style="color:#e1e4e8">().</span><span style="color:#b392f0">setIfAbsent</span><span style="color:#e1e4e8">(redisKey, num.</span><span style="color:#b392f0">toString</span><span style="color:#e1e4e8">(), ttl, TimeUnit.MILLISECONDS);</span></span>
<span class="line"><span style="color:#e1e4e8">                    </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (aBoolean) {</span></span>
<span class="line"><span style="color:#e1e4e8">                        </span><span style="color:#6a737d">//占位成功说明从来没有买过</span></span>
<span class="line"><span style="color:#e1e4e8">                        RSemaphore semaphore </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> redissonClient.</span><span style="color:#b392f0">getSemaphore</span><span style="color:#e1e4e8">(SKU_STOCK_SEMAPHORE </span><span style="color:#f97583">+</span><span style="color:#e1e4e8"> randomCode);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">                        </span><span style="color:#6a737d">//120 ms -&gt;  20ms</span></span>
<span class="line"><span style="color:#e1e4e8">                        </span><span style="color:#f97583">boolean</span><span style="color:#e1e4e8"> b </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> semaphore.</span><span style="color:#b392f0">tryAcquire</span><span style="color:#e1e4e8">(num);</span></span>
<span class="line"><span style="color:#e1e4e8">                        </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (b) {</span></span>
<span class="line"><span style="color:#e1e4e8">                            </span><span style="color:#6a737d">//秒杀成功；</span></span>
<span class="line"><span style="color:#e1e4e8">                            </span><span style="color:#6a737d">//快速下单，发送MQ消息 10ms</span></span>
<span class="line"><span style="color:#e1e4e8">                            </span><span style="color:#6a737d">//创建随机订单号</span></span>
<span class="line"><span style="color:#e1e4e8">                            String timeId </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> IdWorker.</span><span style="color:#b392f0">getTimeId</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">                            SeckillOrderTo orderTo </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">SeckillOrderTo</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">                            orderTo.</span><span style="color:#b392f0">setOrderSn</span><span style="color:#e1e4e8">(timeId);</span></span>
<span class="line"><span style="color:#e1e4e8">                            orderTo.</span><span style="color:#b392f0">setMemberId</span><span style="color:#e1e4e8">(respVo.</span><span style="color:#b392f0">getId</span><span style="color:#e1e4e8">());</span></span>
<span class="line"><span style="color:#e1e4e8">                            orderTo.</span><span style="color:#b392f0">setNum</span><span style="color:#e1e4e8">(num);</span></span>
<span class="line"><span style="color:#e1e4e8">                            orderTo.</span><span style="color:#b392f0">setPromotionSessionId</span><span style="color:#e1e4e8">(redis.</span><span style="color:#b392f0">getPromotionSessionId</span><span style="color:#e1e4e8">());</span></span>
<span class="line"><span style="color:#e1e4e8">                            orderTo.</span><span style="color:#b392f0">setSkuId</span><span style="color:#e1e4e8">(redis.</span><span style="color:#b392f0">getSkuId</span><span style="color:#e1e4e8">());</span></span>
<span class="line"><span style="color:#e1e4e8">                            orderTo.</span><span style="color:#b392f0">setSeckillPrice</span><span style="color:#e1e4e8">(redis.</span><span style="color:#b392f0">getSeckillPrice</span><span style="color:#e1e4e8">());</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">                            </span><span style="color:#6a737d">//String exchange, String routingKey, Object message, MessagePostProcessor messagePostProcessor</span></span>
<span class="line"><span style="color:#e1e4e8">                            rabbitTemplate.</span><span style="color:#b392f0">convertAndSend</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"order-event-exchange"</span><span style="color:#e1e4e8">, </span><span style="color:#9ecbff">"order.seckill.order"</span><span style="color:#e1e4e8">, orderTo);</span></span>
<span class="line"><span style="color:#e1e4e8">                            </span><span style="color:#f97583">long</span><span style="color:#e1e4e8"> s2 </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> System.</span><span style="color:#b392f0">currentTimeMillis</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">                            log.</span><span style="color:#b392f0">info</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"耗时...{}"</span><span style="color:#e1e4e8">, (s2 </span><span style="color:#f97583">-</span><span style="color:#e1e4e8"> s1));</span></span>
<span class="line"><span style="color:#e1e4e8">                            </span><span style="color:#6a737d">//返回订单号</span></span>
<span class="line"><span style="color:#e1e4e8">                            </span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> timeId;</span></span>
<span class="line"><span style="color:#e1e4e8">                        }</span></span>
<span class="line"><span style="color:#e1e4e8">                        </span><span style="color:#6a737d">//信号量为0时，虽然data为空，但缓存还会存一份</span></span>
<span class="line"><span style="color:#e1e4e8">                        redisTemplate.</span><span style="color:#b392f0">opsForValue</span><span style="color:#e1e4e8">().</span><span style="color:#b392f0">get</span><span style="color:#e1e4e8">(redisKey);</span></span>
<span class="line"><span style="color:#e1e4e8">                        </span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">                    } </span><span style="color:#f97583">else</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">                        </span><span style="color:#6a737d">//说明已经买过了</span></span>
<span class="line"><span style="color:#e1e4e8">                        </span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">                    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">                }</span></span>
<span class="line"><span style="color:#e1e4e8">            } </span><span style="color:#f97583">else</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">            }</span></span>
<span class="line"><span style="color:#e1e4e8">        } </span><span style="color:#f97583">else</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">        }</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e">@</span><span style="color:#d73a49">Override</span></span>
<span class="line"><span style="color:#d73a49">public</span><span style="color:#24292e"> String </span><span style="color:#6f42c1">kill</span><span style="color:#24292e">(String killId, String key, Integer num) {</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">long</span><span style="color:#24292e"> s1 </span><span style="color:#d73a49">=</span><span style="color:#24292e"> System.</span><span style="color:#6f42c1">currentTimeMillis</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">//获取当前登录的信息</span></span>
<span class="line"><span style="color:#24292e">    MemberRespVo respVo </span><span style="color:#d73a49">=</span><span style="color:#24292e"> LoginUserInterceptor.loginUser.</span><span style="color:#6f42c1">get</span><span style="color:#24292e">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">//获取当前秒杀商品的详细信息</span></span>
<span class="line"><span style="color:#24292e">    BoundHashOperations&lt;</span><span style="color:#d73a49">String</span><span style="color:#24292e">, </span><span style="color:#d73a49">String</span><span style="color:#24292e">, </span><span style="color:#d73a49">String</span><span style="color:#24292e">&gt; hashOps </span><span style="color:#d73a49">=</span><span style="color:#24292e"> redisTemplate.</span><span style="color:#6f42c1">boundHashOps</span><span style="color:#24292e">(SKUKILL_CACHE_PREFOX);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">    String json </span><span style="color:#d73a49">=</span><span style="color:#24292e"> hashOps.</span><span style="color:#6f42c1">get</span><span style="color:#24292e">(killId);</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (StringUtils.</span><span style="color:#6f42c1">isEmpty</span><span style="color:#24292e">(json)) {</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">return</span><span style="color:#24292e"> </span><span style="color:#005cc5">null</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">    } </span><span style="color:#d73a49">else</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">        SeckillSkuRedisTo redis </span><span style="color:#d73a49">=</span><span style="color:#24292e"> JSON.</span><span style="color:#6f42c1">parseObject</span><span style="color:#24292e">(json, SeckillSkuRedisTo.class);</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6a737d">//1、校验合法性</span></span>
<span class="line"><span style="color:#24292e">        Long startTime </span><span style="color:#d73a49">=</span><span style="color:#24292e"> redis.</span><span style="color:#6f42c1">getStartTime</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">        Long endTime </span><span style="color:#d73a49">=</span><span style="color:#24292e"> redis.</span><span style="color:#6f42c1">getEndTime</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">long</span><span style="color:#24292e"> current </span><span style="color:#d73a49">=</span><span style="color:#24292e"> System.</span><span style="color:#6f42c1">currentTimeMillis</span><span style="color:#24292e">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6a737d">//过期时间</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">long</span><span style="color:#24292e"> ttl </span><span style="color:#d73a49">=</span><span style="color:#24292e"> endTime </span><span style="color:#d73a49">-</span><span style="color:#24292e"> current;</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (current </span><span style="color:#d73a49">&gt;=</span><span style="color:#24292e"> startTime </span><span style="color:#d73a49">&amp;&amp;</span><span style="color:#24292e"> current </span><span style="color:#d73a49">&lt;=</span><span style="color:#24292e"> endTime) {</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#6a737d">//2、校验随机码和商品id</span></span>
<span class="line"><span style="color:#24292e">            String randomCode </span><span style="color:#d73a49">=</span><span style="color:#24292e"> redis.</span><span style="color:#6f42c1">getRandomCode</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#6a737d">//   1_49</span></span>
<span class="line"><span style="color:#24292e">            String seckillSkuId </span><span style="color:#d73a49">=</span><span style="color:#24292e"> redis.</span><span style="color:#6f42c1">getPromotionSessionId</span><span style="color:#24292e">() </span><span style="color:#d73a49">+</span><span style="color:#24292e"> </span><span style="color:#032f62">"_"</span><span style="color:#24292e"> </span><span style="color:#d73a49">+</span><span style="color:#24292e"> redis.</span><span style="color:#6f42c1">getSkuId</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (randomCode.</span><span style="color:#6f42c1">equals</span><span style="color:#24292e">(key) </span><span style="color:#d73a49">&amp;&amp;</span><span style="color:#24292e"> killId.</span><span style="color:#6f42c1">equals</span><span style="color:#24292e">(seckillSkuId)) {</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#6a737d">//3、验证购物数量是否合理</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (num </span><span style="color:#d73a49">&lt;=</span><span style="color:#24292e"> redis.</span><span style="color:#6f42c1">getSeckillLimit</span><span style="color:#24292e">().</span><span style="color:#6f42c1">intValue</span><span style="color:#24292e">()) {</span></span>
<span class="line"><span style="color:#24292e">                    </span><span style="color:#6a737d">//4、验证这个人是否已经购买过。幂等性；如果秒杀成功，就去占位，userId_sessionId_skuId</span></span>
<span class="line"><span style="color:#24292e">                    String redisKey </span><span style="color:#d73a49">=</span><span style="color:#24292e"> respVo.</span><span style="color:#6f42c1">getId</span><span style="color:#24292e">() </span><span style="color:#d73a49">+</span><span style="color:#24292e"> </span><span style="color:#032f62">"_"</span><span style="color:#24292e"> </span><span style="color:#d73a49">+</span><span style="color:#24292e"> seckillSkuId;</span></span>
<span class="line"><span style="color:#24292e">                    </span><span style="color:#6a737d">//自动过期                     SEINX 原子性</span></span>
<span class="line"><span style="color:#24292e">                    Boolean aBoolean </span><span style="color:#d73a49">=</span><span style="color:#24292e"> redisTemplate.</span><span style="color:#6f42c1">opsForValue</span><span style="color:#24292e">().</span><span style="color:#6f42c1">setIfAbsent</span><span style="color:#24292e">(redisKey, num.</span><span style="color:#6f42c1">toString</span><span style="color:#24292e">(), ttl, TimeUnit.MILLISECONDS);</span></span>
<span class="line"><span style="color:#24292e">                    </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (aBoolean) {</span></span>
<span class="line"><span style="color:#24292e">                        </span><span style="color:#6a737d">//占位成功说明从来没有买过</span></span>
<span class="line"><span style="color:#24292e">                        RSemaphore semaphore </span><span style="color:#d73a49">=</span><span style="color:#24292e"> redissonClient.</span><span style="color:#6f42c1">getSemaphore</span><span style="color:#24292e">(SKU_STOCK_SEMAPHORE </span><span style="color:#d73a49">+</span><span style="color:#24292e"> randomCode);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">                        </span><span style="color:#6a737d">//120 ms -&gt;  20ms</span></span>
<span class="line"><span style="color:#24292e">                        </span><span style="color:#d73a49">boolean</span><span style="color:#24292e"> b </span><span style="color:#d73a49">=</span><span style="color:#24292e"> semaphore.</span><span style="color:#6f42c1">tryAcquire</span><span style="color:#24292e">(num);</span></span>
<span class="line"><span style="color:#24292e">                        </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (b) {</span></span>
<span class="line"><span style="color:#24292e">                            </span><span style="color:#6a737d">//秒杀成功；</span></span>
<span class="line"><span style="color:#24292e">                            </span><span style="color:#6a737d">//快速下单，发送MQ消息 10ms</span></span>
<span class="line"><span style="color:#24292e">                            </span><span style="color:#6a737d">//创建随机订单号</span></span>
<span class="line"><span style="color:#24292e">                            String timeId </span><span style="color:#d73a49">=</span><span style="color:#24292e"> IdWorker.</span><span style="color:#6f42c1">getTimeId</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">                            SeckillOrderTo orderTo </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">SeckillOrderTo</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">                            orderTo.</span><span style="color:#6f42c1">setOrderSn</span><span style="color:#24292e">(timeId);</span></span>
<span class="line"><span style="color:#24292e">                            orderTo.</span><span style="color:#6f42c1">setMemberId</span><span style="color:#24292e">(respVo.</span><span style="color:#6f42c1">getId</span><span style="color:#24292e">());</span></span>
<span class="line"><span style="color:#24292e">                            orderTo.</span><span style="color:#6f42c1">setNum</span><span style="color:#24292e">(num);</span></span>
<span class="line"><span style="color:#24292e">                            orderTo.</span><span style="color:#6f42c1">setPromotionSessionId</span><span style="color:#24292e">(redis.</span><span style="color:#6f42c1">getPromotionSessionId</span><span style="color:#24292e">());</span></span>
<span class="line"><span style="color:#24292e">                            orderTo.</span><span style="color:#6f42c1">setSkuId</span><span style="color:#24292e">(redis.</span><span style="color:#6f42c1">getSkuId</span><span style="color:#24292e">());</span></span>
<span class="line"><span style="color:#24292e">                            orderTo.</span><span style="color:#6f42c1">setSeckillPrice</span><span style="color:#24292e">(redis.</span><span style="color:#6f42c1">getSeckillPrice</span><span style="color:#24292e">());</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">                            </span><span style="color:#6a737d">//String exchange, String routingKey, Object message, MessagePostProcessor messagePostProcessor</span></span>
<span class="line"><span style="color:#24292e">                            rabbitTemplate.</span><span style="color:#6f42c1">convertAndSend</span><span style="color:#24292e">(</span><span style="color:#032f62">"order-event-exchange"</span><span style="color:#24292e">, </span><span style="color:#032f62">"order.seckill.order"</span><span style="color:#24292e">, orderTo);</span></span>
<span class="line"><span style="color:#24292e">                            </span><span style="color:#d73a49">long</span><span style="color:#24292e"> s2 </span><span style="color:#d73a49">=</span><span style="color:#24292e"> System.</span><span style="color:#6f42c1">currentTimeMillis</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">                            log.</span><span style="color:#6f42c1">info</span><span style="color:#24292e">(</span><span style="color:#032f62">"耗时...{}"</span><span style="color:#24292e">, (s2 </span><span style="color:#d73a49">-</span><span style="color:#24292e"> s1));</span></span>
<span class="line"><span style="color:#24292e">                            </span><span style="color:#6a737d">//返回订单号</span></span>
<span class="line"><span style="color:#24292e">                            </span><span style="color:#d73a49">return</span><span style="color:#24292e"> timeId;</span></span>
<span class="line"><span style="color:#24292e">                        }</span></span>
<span class="line"><span style="color:#24292e">                        </span><span style="color:#6a737d">//信号量为0时，虽然data为空，但缓存还会存一份</span></span>
<span class="line"><span style="color:#24292e">                        redisTemplate.</span><span style="color:#6f42c1">opsForValue</span><span style="color:#24292e">().</span><span style="color:#6f42c1">get</span><span style="color:#24292e">(redisKey);</span></span>
<span class="line"><span style="color:#24292e">                        </span><span style="color:#d73a49">return</span><span style="color:#24292e"> </span><span style="color:#005cc5">null</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">                    } </span><span style="color:#d73a49">else</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">                        </span><span style="color:#6a737d">//说明已经买过了</span></span>
<span class="line"><span style="color:#24292e">                        </span><span style="color:#d73a49">return</span><span style="color:#24292e"> </span><span style="color:#005cc5">null</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">                    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">                }</span></span>
<span class="line"><span style="color:#24292e">            } </span><span style="color:#d73a49">else</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#d73a49">return</span><span style="color:#24292e"> </span><span style="color:#005cc5">null</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">            }</span></span>
<span class="line"><span style="color:#24292e">        } </span><span style="color:#d73a49">else</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">return</span><span style="color:#24292e"> </span><span style="color:#005cc5">null</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">        }</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">return</span><span style="color:#24292e"> </span><span style="color:#005cc5">null</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">}</span></span></code></pre></div><h4 id="_3-8-秒杀效果-秒杀页面" tabindex="-1">3.8 秒杀效果+秒杀页面 <a aria-current="page" href="/posts/flash%20killing#_3-8-秒杀效果-秒杀页面" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h4><figure><img src="https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230430161527281.png" alt="image-20230430161527281" loading="lazy" decoding="async"></figure><ul><li>引入RabbitMQ依赖</li></ul><div class="language-xml"><button title="Copy Code" class="copy"></button><span class="lang">xml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8">&lt;</span><span style="color:#85e89d">dependency</span><span style="color:#e1e4e8">&gt;</span></span>
<span class="line"><span style="color:#e1e4e8">    &lt;</span><span style="color:#85e89d">groupId</span><span style="color:#e1e4e8">&gt;org.springframework.boot&lt;/</span><span style="color:#85e89d">groupId</span><span style="color:#e1e4e8">&gt;</span></span>
<span class="line"><span style="color:#e1e4e8">    &lt;</span><span style="color:#85e89d">artifactId</span><span style="color:#e1e4e8">&gt;spring-boot-starter-amqp&lt;/</span><span style="color:#85e89d">artifactId</span><span style="color:#e1e4e8">&gt;</span></span>
<span class="line"><span style="color:#e1e4e8">&lt;/</span><span style="color:#85e89d">dependency</span><span style="color:#e1e4e8">&gt;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e">&lt;</span><span style="color:#22863a">dependency</span><span style="color:#24292e">&gt;</span></span>
<span class="line"><span style="color:#24292e">    &lt;</span><span style="color:#22863a">groupId</span><span style="color:#24292e">&gt;org.springframework.boot&lt;/</span><span style="color:#22863a">groupId</span><span style="color:#24292e">&gt;</span></span>
<span class="line"><span style="color:#24292e">    &lt;</span><span style="color:#22863a">artifactId</span><span style="color:#24292e">&gt;spring-boot-starter-amqp&lt;/</span><span style="color:#22863a">artifactId</span><span style="color:#24292e">&gt;</span></span>
<span class="line"><span style="color:#24292e">&lt;/</span><span style="color:#22863a">dependency</span><span style="color:#24292e">&gt;</span></span></code></pre></div><ul><li>相关配置</li></ul><div class="language-properties"><button title="Copy Code" class="copy"></button><span class="lang">properties</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#f97583">spring.rabbitmq.virtual-host</span><span style="color:#e1e4e8">=/</span></span>
<span class="line"><span style="color:#f97583">spring.rabbitmq.host</span><span style="color:#e1e4e8">=192.168.10.103</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#d73a49">spring.rabbitmq.virtual-host</span><span style="color:#24292e">=/</span></span>
<span class="line"><span style="color:#d73a49">spring.rabbitmq.host</span><span style="color:#24292e">=192.168.10.103</span></span></code></pre></div><ul><li>配置RabbitMQ的Json序列化</li></ul><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6a737d">/**</span></span>
<span class="line"><span style="color:#6a737d"> * </span><span style="color:#f97583">@author</span><span style="color:#6a737d"> Klaus</span></span>
<span class="line"><span style="color:#6a737d"> * @date 2022/9/20</span></span>
<span class="line"><span style="color:#6a737d"> */</span></span>
<span class="line"><span style="color:#e1e4e8">@</span><span style="color:#f97583">Configuration</span></span>
<span class="line"><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">class</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">MyRabbitConfig</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">    @</span><span style="color:#f97583">Autowired</span></span>
<span class="line"><span style="color:#e1e4e8">    RabbitTemplate rabbitTemplate;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6a737d">    /**</span></span>
<span class="line"><span style="color:#6a737d">     * 使用JSON序列化机制，进行消息转换</span></span>
<span class="line"><span style="color:#6a737d">     * </span><span style="color:#f97583">@return</span></span>
<span class="line"><span style="color:#6a737d">     */</span></span>
<span class="line"><span style="color:#e1e4e8">    @</span><span style="color:#f97583">Bean</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">public</span><span style="color:#e1e4e8"> MessageConverter </span><span style="color:#b392f0">messageConverter</span><span style="color:#e1e4e8">(){</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Jackson2JsonMessageConverter</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6a737d">/**</span></span>
<span class="line"><span style="color:#6a737d"> * </span><span style="color:#d73a49">@author</span><span style="color:#6a737d"> Klaus</span></span>
<span class="line"><span style="color:#6a737d"> * @date 2022/9/20</span></span>
<span class="line"><span style="color:#6a737d"> */</span></span>
<span class="line"><span style="color:#24292e">@</span><span style="color:#d73a49">Configuration</span></span>
<span class="line"><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">class</span><span style="color:#24292e"> </span><span style="color:#6f42c1">MyRabbitConfig</span><span style="color:#24292e"> {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">    @</span><span style="color:#d73a49">Autowired</span></span>
<span class="line"><span style="color:#24292e">    RabbitTemplate rabbitTemplate;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6a737d">    /**</span></span>
<span class="line"><span style="color:#6a737d">     * 使用JSON序列化机制，进行消息转换</span></span>
<span class="line"><span style="color:#6a737d">     * </span><span style="color:#d73a49">@return</span></span>
<span class="line"><span style="color:#6a737d">     */</span></span>
<span class="line"><span style="color:#24292e">    @</span><span style="color:#d73a49">Bean</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">public</span><span style="color:#24292e"> MessageConverter </span><span style="color:#6f42c1">messageConverter</span><span style="color:#24292e">(){</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">return</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Jackson2JsonMessageConverter</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">}</span></span></code></pre></div><ul><li>发送秒杀成功消息给订单服务</li></ul><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6a737d">//String exchange, String routingKey, Object message, MessagePostProcessor messagePostProcessor</span></span>
<span class="line"><span style="color:#e1e4e8">rabbitTemplate.</span><span style="color:#b392f0">convertAndSend</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"order-event-exchange"</span><span style="color:#e1e4e8">, </span><span style="color:#9ecbff">"order.seckill.order"</span><span style="color:#e1e4e8">, orderTo);</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6a737d">//String exchange, String routingKey, Object message, MessagePostProcessor messagePostProcessor</span></span>
<span class="line"><span style="color:#24292e">rabbitTemplate.</span><span style="color:#6f42c1">convertAndSend</span><span style="color:#24292e">(</span><span style="color:#032f62">"order-event-exchange"</span><span style="color:#24292e">, </span><span style="color:#032f62">"order.seckill.order"</span><span style="color:#24292e">, orderTo);</span></span></code></pre></div><ul><li>订单服务创建秒杀订单消息队列</li></ul><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8">@</span><span style="color:#f97583">Configuration</span></span>
<span class="line"><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">class</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">MyMQConfig</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">    </span></span>
<span class="line"><span style="color:#e1e4e8">    ......</span></span>
<span class="line"><span style="color:#e1e4e8">    </span></span>
<span class="line"><span style="color:#e1e4e8">    @</span><span style="color:#f97583">Bean</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">public</span><span style="color:#e1e4e8"> Exchange </span><span style="color:#b392f0">orderEventExchange</span><span style="color:#e1e4e8">(){</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#6a737d">//String name, boolean durable, boolean autoDelete, Map&lt;String, Object&gt; arguments</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">TopicExchange</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"order-event-exchange"</span><span style="color:#e1e4e8">, </span><span style="color:#79b8ff">true</span><span style="color:#e1e4e8">, </span><span style="color:#79b8ff">false</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"><span style="color:#e1e4e8">    </span></span>
<span class="line"><span style="color:#e1e4e8">    ......</span></span>
<span class="line"><span style="color:#e1e4e8">    </span></span>
<span class="line"><span style="color:#6a737d">    /**</span></span>
<span class="line"><span style="color:#6a737d">     * 秒杀削峰队列</span></span>
<span class="line"><span style="color:#6a737d">     * </span><span style="color:#f97583">@return</span></span>
<span class="line"><span style="color:#6a737d">     */</span></span>
<span class="line"><span style="color:#e1e4e8">    @</span><span style="color:#f97583">Bean</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">public</span><span style="color:#e1e4e8"> Queue </span><span style="color:#b392f0">orderSeckillOrderQueue</span><span style="color:#e1e4e8">(){</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Queue</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"order.seckill.order.queue"</span><span style="color:#e1e4e8">, </span><span style="color:#79b8ff">true</span><span style="color:#e1e4e8">, </span><span style="color:#79b8ff">false</span><span style="color:#e1e4e8">, </span><span style="color:#79b8ff">false</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">    @</span><span style="color:#f97583">Bean</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">public</span><span style="color:#e1e4e8"> Binding </span><span style="color:#b392f0">orderSeckillOrderBinding</span><span style="color:#e1e4e8">(){</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Binding</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"order.seckill.order.queue"</span><span style="color:#e1e4e8">,</span></span>
<span class="line"><span style="color:#e1e4e8">                Binding.DestinationType.QUEUE,</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#9ecbff">"order-event-exchange"</span><span style="color:#e1e4e8">,</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#9ecbff">"order.seckill.order"</span><span style="color:#e1e4e8">, </span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"><span style="color:#e1e4e8">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e">@</span><span style="color:#d73a49">Configuration</span></span>
<span class="line"><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">class</span><span style="color:#24292e"> </span><span style="color:#6f42c1">MyMQConfig</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">    </span></span>
<span class="line"><span style="color:#24292e">    ......</span></span>
<span class="line"><span style="color:#24292e">    </span></span>
<span class="line"><span style="color:#24292e">    @</span><span style="color:#d73a49">Bean</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">public</span><span style="color:#24292e"> Exchange </span><span style="color:#6f42c1">orderEventExchange</span><span style="color:#24292e">(){</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6a737d">//String name, boolean durable, boolean autoDelete, Map&lt;String, Object&gt; arguments</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">return</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">TopicExchange</span><span style="color:#24292e">(</span><span style="color:#032f62">"order-event-exchange"</span><span style="color:#24292e">, </span><span style="color:#005cc5">true</span><span style="color:#24292e">, </span><span style="color:#005cc5">false</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"><span style="color:#24292e">    </span></span>
<span class="line"><span style="color:#24292e">    ......</span></span>
<span class="line"><span style="color:#24292e">    </span></span>
<span class="line"><span style="color:#6a737d">    /**</span></span>
<span class="line"><span style="color:#6a737d">     * 秒杀削峰队列</span></span>
<span class="line"><span style="color:#6a737d">     * </span><span style="color:#d73a49">@return</span></span>
<span class="line"><span style="color:#6a737d">     */</span></span>
<span class="line"><span style="color:#24292e">    @</span><span style="color:#d73a49">Bean</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">public</span><span style="color:#24292e"> Queue </span><span style="color:#6f42c1">orderSeckillOrderQueue</span><span style="color:#24292e">(){</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">return</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Queue</span><span style="color:#24292e">(</span><span style="color:#032f62">"order.seckill.order.queue"</span><span style="color:#24292e">, </span><span style="color:#005cc5">true</span><span style="color:#24292e">, </span><span style="color:#005cc5">false</span><span style="color:#24292e">, </span><span style="color:#005cc5">false</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">    @</span><span style="color:#d73a49">Bean</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">public</span><span style="color:#24292e"> Binding </span><span style="color:#6f42c1">orderSeckillOrderBinding</span><span style="color:#24292e">(){</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">return</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Binding</span><span style="color:#24292e">(</span><span style="color:#032f62">"order.seckill.order.queue"</span><span style="color:#24292e">,</span></span>
<span class="line"><span style="color:#24292e">                Binding.DestinationType.QUEUE,</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#032f62">"order-event-exchange"</span><span style="color:#24292e">,</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#032f62">"order.seckill.order"</span><span style="color:#24292e">, </span><span style="color:#005cc5">null</span><span style="color:#24292e">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"><span style="color:#24292e">}</span></span></code></pre></div><ul><li>削峰队列监听器<code>org.klaus.zgg01mall.order.listener.OrderSeckillListener</code></li></ul><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6a737d">/**</span></span>
<span class="line"><span style="color:#6a737d"> * 削峰队列监听器</span></span>
<span class="line"><span style="color:#6a737d"> * </span><span style="color:#f97583">@author</span><span style="color:#6a737d"> Klaus</span></span>
<span class="line"><span style="color:#6a737d"> * @date 2023/4/28</span></span>
<span class="line"><span style="color:#6a737d"> */</span></span>
<span class="line"><span style="color:#e1e4e8">@</span><span style="color:#f97583">Slf4j</span></span>
<span class="line"><span style="color:#e1e4e8">@</span><span style="color:#f97583">RabbitListener</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">queues</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#9ecbff">"order.seckill.order.queue"</span><span style="color:#e1e4e8">)</span></span>
<span class="line"><span style="color:#e1e4e8">@</span><span style="color:#f97583">Component</span></span>
<span class="line"><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">class</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">OrderSeckillListener</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">    @</span><span style="color:#f97583">Autowired</span></span>
<span class="line"><span style="color:#e1e4e8">    OrderService orderService;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">    @</span><span style="color:#f97583">RabbitHandler</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">void</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">listener</span><span style="color:#e1e4e8">(SeckillOrderTo </span><span style="color:#ffab70">seckillOrder</span><span style="color:#e1e4e8">, Channel </span><span style="color:#ffab70">channel</span><span style="color:#e1e4e8">, Message </span><span style="color:#ffab70">message</span><span style="color:#e1e4e8">) </span><span style="color:#f97583">throws</span><span style="color:#e1e4e8"> IOException {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">try</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">            log.</span><span style="color:#b392f0">info</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"准备创建秒杀单的详细信息...."</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">            orderService.</span><span style="color:#b392f0">createSeckillOrder</span><span style="color:#e1e4e8">(seckillOrder);</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#6a737d">//手动调用支付宝收单</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#6a737d">//签收订单</span></span>
<span class="line"><span style="color:#e1e4e8">            channel.</span><span style="color:#b392f0">basicAck</span><span style="color:#e1e4e8">(message.</span><span style="color:#b392f0">getMessageProperties</span><span style="color:#e1e4e8">().</span><span style="color:#b392f0">getDeliveryTag</span><span style="color:#e1e4e8">(), </span><span style="color:#79b8ff">false</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">        } </span><span style="color:#f97583">catch</span><span style="color:#e1e4e8"> (Exception </span><span style="color:#ffab70">e</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">            channel.</span><span style="color:#b392f0">basicReject</span><span style="color:#e1e4e8">(message.</span><span style="color:#b392f0">getMessageProperties</span><span style="color:#e1e4e8">().</span><span style="color:#b392f0">getDeliveryTag</span><span style="color:#e1e4e8">(), </span><span style="color:#79b8ff">true</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">        }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"><span style="color:#e1e4e8">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6a737d">/**</span></span>
<span class="line"><span style="color:#6a737d"> * 削峰队列监听器</span></span>
<span class="line"><span style="color:#6a737d"> * </span><span style="color:#d73a49">@author</span><span style="color:#6a737d"> Klaus</span></span>
<span class="line"><span style="color:#6a737d"> * @date 2023/4/28</span></span>
<span class="line"><span style="color:#6a737d"> */</span></span>
<span class="line"><span style="color:#24292e">@</span><span style="color:#d73a49">Slf4j</span></span>
<span class="line"><span style="color:#24292e">@</span><span style="color:#d73a49">RabbitListener</span><span style="color:#24292e">(</span><span style="color:#005cc5">queues</span><span style="color:#24292e"> </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#032f62">"order.seckill.order.queue"</span><span style="color:#24292e">)</span></span>
<span class="line"><span style="color:#24292e">@</span><span style="color:#d73a49">Component</span></span>
<span class="line"><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">class</span><span style="color:#24292e"> </span><span style="color:#6f42c1">OrderSeckillListener</span><span style="color:#24292e"> {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">    @</span><span style="color:#d73a49">Autowired</span></span>
<span class="line"><span style="color:#24292e">    OrderService orderService;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">    @</span><span style="color:#d73a49">RabbitHandler</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">void</span><span style="color:#24292e"> </span><span style="color:#6f42c1">listener</span><span style="color:#24292e">(SeckillOrderTo </span><span style="color:#e36209">seckillOrder</span><span style="color:#24292e">, Channel </span><span style="color:#e36209">channel</span><span style="color:#24292e">, Message </span><span style="color:#e36209">message</span><span style="color:#24292e">) </span><span style="color:#d73a49">throws</span><span style="color:#24292e"> IOException {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">try</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">            log.</span><span style="color:#6f42c1">info</span><span style="color:#24292e">(</span><span style="color:#032f62">"准备创建秒杀单的详细信息...."</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">            orderService.</span><span style="color:#6f42c1">createSeckillOrder</span><span style="color:#24292e">(seckillOrder);</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#6a737d">//手动调用支付宝收单</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#6a737d">//签收订单</span></span>
<span class="line"><span style="color:#24292e">            channel.</span><span style="color:#6f42c1">basicAck</span><span style="color:#24292e">(message.</span><span style="color:#6f42c1">getMessageProperties</span><span style="color:#24292e">().</span><span style="color:#6f42c1">getDeliveryTag</span><span style="color:#24292e">(), </span><span style="color:#005cc5">false</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">        } </span><span style="color:#d73a49">catch</span><span style="color:#24292e"> (Exception </span><span style="color:#e36209">e</span><span style="color:#24292e">) {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">            channel.</span><span style="color:#6f42c1">basicReject</span><span style="color:#24292e">(message.</span><span style="color:#6f42c1">getMessageProperties</span><span style="color:#24292e">().</span><span style="color:#6f42c1">getDeliveryTag</span><span style="color:#24292e">(), </span><span style="color:#005cc5">true</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">        }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"><span style="color:#24292e">}</span></span></code></pre></div><ul><li>创建秒杀订单方法实现<code>org.klaus.zgg01mall.order.service.impl.OrderServiceImpl#createSeckillOrder</code></li></ul><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8">@</span><span style="color:#f97583">Override</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">void</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">createSeckillOrder</span><span style="color:#e1e4e8">(SeckillOrderTo seckillOrder) {</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#6a737d">//todo 保存订单信息</span></span>
<span class="line"><span style="color:#e1e4e8">        OrderEntity orderEntity </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">OrderEntity</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">        orderEntity.</span><span style="color:#b392f0">setOrderSn</span><span style="color:#e1e4e8">(seckillOrder.</span><span style="color:#b392f0">getOrderSn</span><span style="color:#e1e4e8">());</span></span>
<span class="line"><span style="color:#e1e4e8">        orderEntity.</span><span style="color:#b392f0">setMemberId</span><span style="color:#e1e4e8">(seckillOrder.</span><span style="color:#b392f0">getMemberId</span><span style="color:#e1e4e8">());</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">        orderEntity.</span><span style="color:#b392f0">setStatus</span><span style="color:#e1e4e8">(OrderStatusEnum.CREATE_NEW.</span><span style="color:#b392f0">getCode</span><span style="color:#e1e4e8">());</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">        BigDecimal amount </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> seckillOrder.</span><span style="color:#b392f0">getSeckillPrice</span><span style="color:#e1e4e8">().</span><span style="color:#b392f0">multiply</span><span style="color:#e1e4e8">(</span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">BigDecimal</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">""</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">+</span><span style="color:#e1e4e8"> seckillOrder.</span><span style="color:#b392f0">getNum</span><span style="color:#e1e4e8">()));</span></span>
<span class="line"><span style="color:#e1e4e8">        orderEntity.</span><span style="color:#b392f0">setPayAmount</span><span style="color:#e1e4e8">(amount);</span></span>
<span class="line"><span style="color:#e1e4e8">        orderEntity.</span><span style="color:#b392f0">setTotalAmount</span><span style="color:#e1e4e8">(amount);</span><span style="color:#6a737d">//todo</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#6a737d">//保存订单</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#79b8ff">this</span><span style="color:#e1e4e8">.</span><span style="color:#b392f0">save</span><span style="color:#e1e4e8">(orderEntity);</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#6a737d">//todo 保存订单项信息</span></span>
<span class="line"><span style="color:#e1e4e8">        OrderItemEntity itemEntity </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">OrderItemEntity</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">        itemEntity.</span><span style="color:#b392f0">setOrderSn</span><span style="color:#e1e4e8">(seckillOrder.</span><span style="color:#b392f0">getOrderSn</span><span style="color:#e1e4e8">());</span></span>
<span class="line"><span style="color:#e1e4e8">        itemEntity.</span><span style="color:#b392f0">setRealAmount</span><span style="color:#e1e4e8">(amount);</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#6a737d">//todo 获取当前sku的详细信息进行设置 seckillservice-&gt; productFeignService.getSpuInfoBySkuId()</span></span>
<span class="line"><span style="color:#e1e4e8">        R r </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> productFeignService.</span><span style="color:#b392f0">getSpuInfoBySkuId</span><span style="color:#e1e4e8">(seckillOrder.</span><span style="color:#b392f0">getSkuId</span><span style="color:#e1e4e8">());</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (r.</span><span style="color:#b392f0">getCode</span><span style="color:#e1e4e8">() </span><span style="color:#f97583">==</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">            SpuInfoVo data </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> r.</span><span style="color:#b392f0">getData</span><span style="color:#e1e4e8">(</span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> TypeReference&lt;</span><span style="color:#f97583">SpuInfoVo</span><span style="color:#e1e4e8">&gt;() {</span></span>
<span class="line"><span style="color:#e1e4e8">            });</span></span>
<span class="line"><span style="color:#e1e4e8">            itemEntity.</span><span style="color:#b392f0">setSpuId</span><span style="color:#e1e4e8">(data.</span><span style="color:#b392f0">getId</span><span style="color:#e1e4e8">());</span></span>
<span class="line"><span style="color:#e1e4e8">            itemEntity.</span><span style="color:#b392f0">setSpuName</span><span style="color:#e1e4e8">(data.</span><span style="color:#b392f0">getSpuName</span><span style="color:#e1e4e8">());</span></span>
<span class="line"><span style="color:#e1e4e8">            itemEntity.</span><span style="color:#b392f0">setSpuBrand</span><span style="color:#e1e4e8">(data.</span><span style="color:#b392f0">getBrandId</span><span style="color:#e1e4e8">().</span><span style="color:#b392f0">toString</span><span style="color:#e1e4e8">());</span></span>
<span class="line"><span style="color:#e1e4e8">            itemEntity.</span><span style="color:#b392f0">setCategoryId</span><span style="color:#e1e4e8">(data.</span><span style="color:#b392f0">getCatalogId</span><span style="color:#e1e4e8">());</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">        }</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#6a737d">//1、找到所有需要参与秒杀的商品信息</span></span>
<span class="line"><span style="color:#e1e4e8">        R info </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> seckillFeignService.</span><span style="color:#b392f0">getSkuSeckillInfo</span><span style="color:#e1e4e8">(seckillOrder.</span><span style="color:#b392f0">getSkuId</span><span style="color:#e1e4e8">());</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (info.</span><span style="color:#b392f0">getCode</span><span style="color:#e1e4e8">() </span><span style="color:#f97583">==</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8">){</span></span>
<span class="line"><span style="color:#e1e4e8">            SeckillSkuRedisTo data </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> info.</span><span style="color:#b392f0">getData</span><span style="color:#e1e4e8">(</span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> TypeReference&lt;</span><span style="color:#f97583">SeckillSkuRedisTo</span><span style="color:#e1e4e8">&gt;() {</span></span>
<span class="line"><span style="color:#e1e4e8">            });</span></span>
<span class="line"><span style="color:#e1e4e8">            itemEntity.</span><span style="color:#b392f0">setSkuName</span><span style="color:#e1e4e8">(data.</span><span style="color:#b392f0">getSkuInfoVo</span><span style="color:#e1e4e8">().</span><span style="color:#b392f0">getSkuTitle</span><span style="color:#e1e4e8">());</span></span>
<span class="line"><span style="color:#e1e4e8">            itemEntity.</span><span style="color:#b392f0">setSkuPic</span><span style="color:#e1e4e8">(data.</span><span style="color:#b392f0">getSkuInfoVo</span><span style="color:#e1e4e8">().</span><span style="color:#b392f0">getSkuDefaultImg</span><span style="color:#e1e4e8">());</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#6a737d">//todo 销售属性组合</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">        }</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">        itemEntity.</span><span style="color:#b392f0">setSkuId</span><span style="color:#e1e4e8">(seckillOrder.</span><span style="color:#b392f0">getSkuId</span><span style="color:#e1e4e8">());</span></span>
<span class="line"><span style="color:#e1e4e8">        itemEntity.</span><span style="color:#b392f0">setSkuQuantity</span><span style="color:#e1e4e8">(seckillOrder.</span><span style="color:#b392f0">getNum</span><span style="color:#e1e4e8">());</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#6a737d">//保存订单项</span></span>
<span class="line"><span style="color:#e1e4e8">        orderItemService.</span><span style="color:#b392f0">save</span><span style="color:#e1e4e8">(itemEntity);</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"><span style="color:#6a737d">/**</span></span>
<span class="line"><span style="color:#6a737d">     * 保存订单数据</span></span>
<span class="line"><span style="color:#6a737d">     * </span><span style="color:#f97583">@param</span><span style="color:#6a737d"> </span><span style="color:#ffab70">order</span></span>
<span class="line"><span style="color:#6a737d">     */</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">private</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">void</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">saveOrder</span><span style="color:#e1e4e8">(OrderCreateTo order) {</span></span>
<span class="line"><span style="color:#e1e4e8">        OrderEntity orderEntity </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> order.</span><span style="color:#b392f0">getOrder</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">        orderEntity.</span><span style="color:#b392f0">setModifyTime</span><span style="color:#e1e4e8">(</span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Date</span><span style="color:#e1e4e8">());</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#6a737d">//插入订单</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#79b8ff">this</span><span style="color:#e1e4e8">.</span><span style="color:#b392f0">save</span><span style="color:#e1e4e8">(orderEntity);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">        List&lt;</span><span style="color:#f97583">OrderItemEntity</span><span style="color:#e1e4e8">&gt; orderItems </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> order.</span><span style="color:#b392f0">getOrderItems</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#6a737d">//seata不支持批量保存...且在高并发环境此业务不适用Seata</span></span>
<span class="line"><span style="color:#e1e4e8">        orderItemService.</span><span style="color:#b392f0">saveBatch</span><span style="color:#e1e4e8">(orderItems);</span></span>
<span class="line"><span style="color:#6a737d">//        for (OrderItemEntity orderItem : orderItems) {</span></span>
<span class="line"><span style="color:#6a737d">//            orderItemService.save(orderItem);</span></span>
<span class="line"><span style="color:#6a737d">//        }</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e">@</span><span style="color:#d73a49">Override</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">void</span><span style="color:#24292e"> </span><span style="color:#6f42c1">createSeckillOrder</span><span style="color:#24292e">(SeckillOrderTo seckillOrder) {</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6a737d">//todo 保存订单信息</span></span>
<span class="line"><span style="color:#24292e">        OrderEntity orderEntity </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">OrderEntity</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">        orderEntity.</span><span style="color:#6f42c1">setOrderSn</span><span style="color:#24292e">(seckillOrder.</span><span style="color:#6f42c1">getOrderSn</span><span style="color:#24292e">());</span></span>
<span class="line"><span style="color:#24292e">        orderEntity.</span><span style="color:#6f42c1">setMemberId</span><span style="color:#24292e">(seckillOrder.</span><span style="color:#6f42c1">getMemberId</span><span style="color:#24292e">());</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">        orderEntity.</span><span style="color:#6f42c1">setStatus</span><span style="color:#24292e">(OrderStatusEnum.CREATE_NEW.</span><span style="color:#6f42c1">getCode</span><span style="color:#24292e">());</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">        BigDecimal amount </span><span style="color:#d73a49">=</span><span style="color:#24292e"> seckillOrder.</span><span style="color:#6f42c1">getSeckillPrice</span><span style="color:#24292e">().</span><span style="color:#6f42c1">multiply</span><span style="color:#24292e">(</span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">BigDecimal</span><span style="color:#24292e">(</span><span style="color:#032f62">""</span><span style="color:#24292e"> </span><span style="color:#d73a49">+</span><span style="color:#24292e"> seckillOrder.</span><span style="color:#6f42c1">getNum</span><span style="color:#24292e">()));</span></span>
<span class="line"><span style="color:#24292e">        orderEntity.</span><span style="color:#6f42c1">setPayAmount</span><span style="color:#24292e">(amount);</span></span>
<span class="line"><span style="color:#24292e">        orderEntity.</span><span style="color:#6f42c1">setTotalAmount</span><span style="color:#24292e">(amount);</span><span style="color:#6a737d">//todo</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6a737d">//保存订单</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#005cc5">this</span><span style="color:#24292e">.</span><span style="color:#6f42c1">save</span><span style="color:#24292e">(orderEntity);</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6a737d">//todo 保存订单项信息</span></span>
<span class="line"><span style="color:#24292e">        OrderItemEntity itemEntity </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">OrderItemEntity</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">        itemEntity.</span><span style="color:#6f42c1">setOrderSn</span><span style="color:#24292e">(seckillOrder.</span><span style="color:#6f42c1">getOrderSn</span><span style="color:#24292e">());</span></span>
<span class="line"><span style="color:#24292e">        itemEntity.</span><span style="color:#6f42c1">setRealAmount</span><span style="color:#24292e">(amount);</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6a737d">//todo 获取当前sku的详细信息进行设置 seckillservice-&gt; productFeignService.getSpuInfoBySkuId()</span></span>
<span class="line"><span style="color:#24292e">        R r </span><span style="color:#d73a49">=</span><span style="color:#24292e"> productFeignService.</span><span style="color:#6f42c1">getSpuInfoBySkuId</span><span style="color:#24292e">(seckillOrder.</span><span style="color:#6f42c1">getSkuId</span><span style="color:#24292e">());</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (r.</span><span style="color:#6f42c1">getCode</span><span style="color:#24292e">() </span><span style="color:#d73a49">==</span><span style="color:#24292e"> </span><span style="color:#005cc5">0</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">            SpuInfoVo data </span><span style="color:#d73a49">=</span><span style="color:#24292e"> r.</span><span style="color:#6f42c1">getData</span><span style="color:#24292e">(</span><span style="color:#d73a49">new</span><span style="color:#24292e"> TypeReference&lt;</span><span style="color:#d73a49">SpuInfoVo</span><span style="color:#24292e">&gt;() {</span></span>
<span class="line"><span style="color:#24292e">            });</span></span>
<span class="line"><span style="color:#24292e">            itemEntity.</span><span style="color:#6f42c1">setSpuId</span><span style="color:#24292e">(data.</span><span style="color:#6f42c1">getId</span><span style="color:#24292e">());</span></span>
<span class="line"><span style="color:#24292e">            itemEntity.</span><span style="color:#6f42c1">setSpuName</span><span style="color:#24292e">(data.</span><span style="color:#6f42c1">getSpuName</span><span style="color:#24292e">());</span></span>
<span class="line"><span style="color:#24292e">            itemEntity.</span><span style="color:#6f42c1">setSpuBrand</span><span style="color:#24292e">(data.</span><span style="color:#6f42c1">getBrandId</span><span style="color:#24292e">().</span><span style="color:#6f42c1">toString</span><span style="color:#24292e">());</span></span>
<span class="line"><span style="color:#24292e">            itemEntity.</span><span style="color:#6f42c1">setCategoryId</span><span style="color:#24292e">(data.</span><span style="color:#6f42c1">getCatalogId</span><span style="color:#24292e">());</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">        }</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6a737d">//1、找到所有需要参与秒杀的商品信息</span></span>
<span class="line"><span style="color:#24292e">        R info </span><span style="color:#d73a49">=</span><span style="color:#24292e"> seckillFeignService.</span><span style="color:#6f42c1">getSkuSeckillInfo</span><span style="color:#24292e">(seckillOrder.</span><span style="color:#6f42c1">getSkuId</span><span style="color:#24292e">());</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (info.</span><span style="color:#6f42c1">getCode</span><span style="color:#24292e">() </span><span style="color:#d73a49">==</span><span style="color:#24292e"> </span><span style="color:#005cc5">0</span><span style="color:#24292e">){</span></span>
<span class="line"><span style="color:#24292e">            SeckillSkuRedisTo data </span><span style="color:#d73a49">=</span><span style="color:#24292e"> info.</span><span style="color:#6f42c1">getData</span><span style="color:#24292e">(</span><span style="color:#d73a49">new</span><span style="color:#24292e"> TypeReference&lt;</span><span style="color:#d73a49">SeckillSkuRedisTo</span><span style="color:#24292e">&gt;() {</span></span>
<span class="line"><span style="color:#24292e">            });</span></span>
<span class="line"><span style="color:#24292e">            itemEntity.</span><span style="color:#6f42c1">setSkuName</span><span style="color:#24292e">(data.</span><span style="color:#6f42c1">getSkuInfoVo</span><span style="color:#24292e">().</span><span style="color:#6f42c1">getSkuTitle</span><span style="color:#24292e">());</span></span>
<span class="line"><span style="color:#24292e">            itemEntity.</span><span style="color:#6f42c1">setSkuPic</span><span style="color:#24292e">(data.</span><span style="color:#6f42c1">getSkuInfoVo</span><span style="color:#24292e">().</span><span style="color:#6f42c1">getSkuDefaultImg</span><span style="color:#24292e">());</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#6a737d">//todo 销售属性组合</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">        }</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">        itemEntity.</span><span style="color:#6f42c1">setSkuId</span><span style="color:#24292e">(seckillOrder.</span><span style="color:#6f42c1">getSkuId</span><span style="color:#24292e">());</span></span>
<span class="line"><span style="color:#24292e">        itemEntity.</span><span style="color:#6f42c1">setSkuQuantity</span><span style="color:#24292e">(seckillOrder.</span><span style="color:#6f42c1">getNum</span><span style="color:#24292e">());</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6a737d">//保存订单项</span></span>
<span class="line"><span style="color:#24292e">        orderItemService.</span><span style="color:#6f42c1">save</span><span style="color:#24292e">(itemEntity);</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"><span style="color:#6a737d">/**</span></span>
<span class="line"><span style="color:#6a737d">     * 保存订单数据</span></span>
<span class="line"><span style="color:#6a737d">     * </span><span style="color:#d73a49">@param</span><span style="color:#6a737d"> </span><span style="color:#e36209">order</span></span>
<span class="line"><span style="color:#6a737d">     */</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">private</span><span style="color:#24292e"> </span><span style="color:#d73a49">void</span><span style="color:#24292e"> </span><span style="color:#6f42c1">saveOrder</span><span style="color:#24292e">(OrderCreateTo order) {</span></span>
<span class="line"><span style="color:#24292e">        OrderEntity orderEntity </span><span style="color:#d73a49">=</span><span style="color:#24292e"> order.</span><span style="color:#6f42c1">getOrder</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">        orderEntity.</span><span style="color:#6f42c1">setModifyTime</span><span style="color:#24292e">(</span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Date</span><span style="color:#24292e">());</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6a737d">//插入订单</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#005cc5">this</span><span style="color:#24292e">.</span><span style="color:#6f42c1">save</span><span style="color:#24292e">(orderEntity);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">        List&lt;</span><span style="color:#d73a49">OrderItemEntity</span><span style="color:#24292e">&gt; orderItems </span><span style="color:#d73a49">=</span><span style="color:#24292e"> order.</span><span style="color:#6f42c1">getOrderItems</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6a737d">//seata不支持批量保存...且在高并发环境此业务不适用Seata</span></span>
<span class="line"><span style="color:#24292e">        orderItemService.</span><span style="color:#6f42c1">saveBatch</span><span style="color:#24292e">(orderItems);</span></span>
<span class="line"><span style="color:#6a737d">//        for (OrderItemEntity orderItem : orderItems) {</span></span>
<span class="line"><span style="color:#6a737d">//            orderItemService.save(orderItem);</span></span>
<span class="line"><span style="color:#6a737d">//        }</span></span>
<span class="line"><span style="color:#24292e">    }</span></span></code></pre></div><ul><li>准备秒杀（已登录）</li></ul><figure><img src="https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230428202310827.png" alt="image-20230428202310827" loading="lazy" decoding="async"></figure><ul><li>秒杀成功页</li></ul><figure><img src="https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230428203902875.png" alt="image-20230428203902875" loading="lazy" decoding="async"></figure><ul><li>去支付</li></ul><figure><img src="https://jsd.cdn.zzko.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230428204012516.png" alt="image-20230428204012516" loading="lazy" decoding="async"></figure><figure><img src="https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230428204042723.png" alt="image-20230428204042723" loading="lazy" decoding="async"></figure><ul><li>支付成功</li></ul><figure><img src="https://jsd.cdn.zzko.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230428204055365.png" alt="image-20230428204055365" loading="lazy" decoding="async"></figure><ul><li>页面跳转同步通知页面路径 需<a target="_blank" rel="noreferrer" href="http://xn--79sp5fckt6rwxd161acp1b"><!--[-->http://格式的完整路径<!--]--><!----></a>，不能加?id=123这类自定义参数，必须外网可以正常访问（配置内网穿透）</li></ul><figure><img src="https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230428204105232.png" alt="image-20230428204105232" loading="lazy" decoding="async"></figure><ul><li>同步通知，支付成功，一般跳转到成功页</li></ul><figure><img src="https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230428204113061.png" alt="image-20230428204113061" loading="lazy" decoding="async"></figure><blockquote><p>未开发秒杀订单超时/未付款/已取消</p></blockquote><ul><li>秒杀失败页面返回（秒杀占位key：userId_sessionId_skuId未过期，已被别人抢购了）</li></ul><p><a target="_blank" rel="noreferrer" href="http://seckill.gulimall.com/kill?killId=20_61&amp;key=83e8d796d84d4048b3c93608b30f8493&amp;num=1"><!--[-->seckill.gulimall.com/kill?killId=20_61&amp;key=83e8d796d84d4048b3c93608b30f8493&amp;num=1<!--]--><!----></a></p><figure><img src="https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230428202441771.png" alt="image-20230428202441771" loading="lazy" decoding="async"></figure><figure><img src="https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230428202629284.png" alt="image-20230428202629284" loading="lazy" decoding="async"></figure><ul><li><p>信号量限制抢购数量</p></li><li><p>信号量每秒杀成功一次，信号量减一，seckill_count -&gt; seckill_count - 1</p></li></ul><figure><img src="https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230428202717075.png" alt="image-20230428202717075" loading="lazy" decoding="async"></figure><ul><li>秒杀锁的过期是为long ttl = endTime - current;</li></ul><figure><img src="https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230428203528296.png" alt="image-20230428203528296" loading="lazy" decoding="async"></figure><h3 id="_4-秒杀-高并发-系统关注的问题" tabindex="-1">4 秒杀（高并发）系统关注的问题 <a aria-current="page" href="/posts/flash%20killing#_4-秒杀-高并发-系统关注的问题" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h3><h4 id="_4-1-服务单一职责-独立部署" tabindex="-1">4.1 服务单一职责+独立部署 <a aria-current="page" href="/posts/flash%20killing#_4-1-服务单一职责-独立部署" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h4><ul><li>秒杀服务即使自己扛不住压力，挂掉，不要影响别人</li></ul><h4 id="_4-2-秒杀链接加密" tabindex="-1">4.2 秒杀链接加密 <a aria-current="page" href="/posts/flash%20killing#_4-2-秒杀链接加密" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h4><ul><li>防止恶意攻击模拟秒杀请求，1000次/s攻击 防止连接暴露，自己工作人员，提前秒杀商品</li></ul><h4 id="_4-3-库存预热-快速扣减" tabindex="-1">4.3 库存预热 + 快速扣减 <a aria-current="page" href="/posts/flash%20killing#_4-3-库存预热-快速扣减" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h4><ul><li>提前把数据加载缓存中</li></ul><h4 id="_4-4-动静分离" tabindex="-1">4.4 动静分离 <a aria-current="page" href="/posts/flash%20killing#_4-4-动静分离" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h4><ul><li><p>nginx做好动静分离，保证秒杀和商品详情页的动态请求才打到后端的服务集群</p></li><li><p>使用 CDN 网络，分担服务器压力</p></li></ul><h4 id="_4-5-恶意请求拦截" tabindex="-1">4.5 恶意请求拦截 <a aria-current="page" href="/posts/flash%20killing#_4-5-恶意请求拦截" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h4><ul><li>识别非法攻击的请求并进行拦截 ，网关层</li></ul><h4 id="_4-6-流量错峰" tabindex="-1">4.6 流量错峰 <a aria-current="page" href="/posts/flash%20killing#_4-6-流量错峰" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h4><ul><li>使用各种手段，将流量分担到更大宽度的时间点，比如验证码，加入购物车</li></ul><h4 id="_4-7-限流-熔断-降级" tabindex="-1">4.7 限流 &amp; 熔断 &amp; 降级 <a aria-current="page" href="/posts/flash%20killing#_4-7-限流-熔断-降级" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h4><ul><li><p>前端限流 + 后端限流</p></li><li><p>限制次数，限制总量，快速失败降级运行，熔断隔离防止雪崩</p></li></ul><h4 id="_4-8-队列消峰" tabindex="-1">4.8 队列消峰 <a aria-current="page" href="/posts/flash%20killing#_4-8-队列消峰" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h4><ul><li>1万个请求，每个1000件被秒杀，双11所有秒杀成功的请求，进入队列，慢慢创建订单，扣减库存即可</li></ul><h3 id="_5-限流-熔断-降级" tabindex="-1">5 限流 &amp; 熔断 &amp; 降级 <a aria-current="page" href="/posts/flash%20killing#_5-限流-熔断-降级" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h3><!--]--><!--[--><!--]--><!--]--><!----><!----></article><!--]--><!--[--><!--[--><!--[--><div class="yun-sponsor-container flex-center flex-col" m="t-6"><button class="sponsor-button yun-icon-btn shadow hover:shadow-md" title="多少都是支持！" text="red-400"><div i-ri-heart-line></div></button><div m="y-4" class="qrcode-container qrcode flex-center flex-col"><div class="sponsor-description" mb="4" text="sm">这是关于赞助的一些描述</div><div class="flex justify-around"><!--[--><a class="flex-center flex-col animate-iteration-1 animate-fade-in" href="https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/alipay.jpg" target="_blank" style="color:#00a3ee"><img class="sponsor-method-img" border="~ rounded" p="1" loading="lazy" src="https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/alipay.jpg" title="支付宝"><div text="xl" m="2" class="i-ri-alipay-line"></div></a><a class="flex-center flex-col animate-iteration-1 animate-fade-in" href="https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/wechat.png" target="_blank" style="color:#2dc100"><img class="sponsor-method-img" border="~ rounded" p="1" loading="lazy" src="https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/wechat.png" title="微信支付"><div text="xl" m="2" class="i-ri-wechat-pay-line"></div></a><!--]--></div></div></div><ul class="post-copyright" m="y-4"><li class="post-copyright-author"><strong>本文作者：</strong><span>imklaus</span></li><li class="post-copyright-link"><strong>本文链接：</strong><a href="https://imlklaus.github.io/posts/flash%20killing" target="_blank" title="本文链接">https://imlklaus.github.io/posts/flash%20killing</a></li><li class="post-copyright-license"><strong>版权声明：</strong><span>本博客所有文章除特别声明外，均默认采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" target="_blank" rel="noopener" title="CC BY-NC-SA 4.0 ">CC BY-NC-SA</a> 许可协议。</span></li></ul><!--]--><!--]--><!--]--></div><!--]--><!----></div><!--[--><!--]--><!--[--><div class="post-nav"><div class="post-nav-item"><a href="/posts/idempotence%20of%20interfaces" class="post-nav-prev" title="接口幂等性"><div class="icon" i-ri-arrow-left-s-line></div><span class="title truncate" text="sm">接口幂等性</span></a></div><div class="post-nav-item"><a href="/posts/spring-cloud%20-%20component" class="post-nav-next" title="Spring Cloud组件"><span class="title truncate" text="sm">Spring Cloud组件</span><div class="icon" i-ri-arrow-right-s-line></div></a></div></div><!--]--><!--[--><!--]--><!--[--><div class="yun-card flex-center comment sm:p-6 lg:px-12 xl:px-16" flex="col" min-h="100px" bg="$va-c-bg-light" w="full" p="4"><!----><!----><!--[--><!----><!--]--><!----></div><!--]--><!--[--><!--]--><footer class="va-footer p-4 text-$va-c-text-light" text="center sm"><!----><div class="copyright flex justify-center items-center gap-2" p="1"><span>©<!----> 2023</span><a class="animate-pulse inline-flex" href="https://imlklaus.github.io/" target="_blank" title="回到首页"><div class="i-ri-heart-line"></div></a><span>imklaus</span></div><div class="powered" m="2"><span>由 <a href="https://github.com/YunYouJun/valaxy" target="_blank" rel="noopener">Valaxy</a> v0.14.61 驱动</span> | <span>主题 - <a href="https://github.com/YunYouJun/valaxy/tree/main/packages/valaxy-theme-yun" title="valaxy-theme-yun" target="_blank">Yun</a> v0.14.61</span></div><div><div class="test" id="htmer_time"><span></span></div></div><!--[--><!--]--></footer><!--[--><!--]--></div><!--]--><!--[--><!--[--><button class="xl:hidden toc-btn shadow fixed yun-icon-btn z-350" opacity="75" right="2" bottom="19"><div i-ri-file-list-line></div></button><!----><!--  --><aside class="va-card yun-aside" m="l-4" text="center" overflow="auto"><div class="aside-container" flex="~ col"><h2 m="t-6 b-2" font="serif black">文章目录</h2><div style="display:none" data-v-22b646a4><div class="content" data-v-22b646a4><div class="outline-title" data-v-22b646a4>On this page</div><div class="outline-marker" data-v-22b646a4></div><nav aria-labelledby="doc-outline-aria-label" data-v-22b646a4><span id="doc-outline-aria-label" class="visually-hidden" data-v-22b646a4>Table of Contents for current page</span><ul class="root va-toc relative z-1 css-i18n-toc" data-v-22b646a4 data-v-67cacb06><!--[--><!--]--></ul></nav></div></div><div class="flex-grow"></div><div class="custom-container"><!--[--><!--]--></div></div></aside><!--]--><!--]--></div></main><a href="#" class="back-to-top yun-icon-btn"><div w="8" h="8" i-ri-arrow-up-s-line></div><svg class="progress-circle-container" viewBox="0 0 100 100"><circle stroke-dasharray="301.59289474462014 301.59289474462014" stroke-dashoffset="301.59289474462014" class="progress-circle" cx="50" cy="50" r="48" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg></a><!--]--><!--]--></div><script>window.__INITIAL_STATE__='{"pinia":{"app":{"isSidebarOpen":false,"isRightSidebarOpen":false},"site":{}}}'</script><script type="application/ld+json" id="schema-org-graph" data-hid="3437552">{
  "@context": "https://schema.org",
  "@graph": [
    {
      "@id": "https://imlklaus.github.io/#identity",
      "@type": "Person",
      "name": "imklaus",
      "url": "https://imlklaus.github.io/",
      "image": {
        "@id": "https://imlklaus.github.io/#/schema/image/11067b0"
      },
      "sameAs": [
        "/atom.xml",
        "https://github.com/imLKlauS",
        "https://music.163.com/#/user/home?id=102158629",
        "https://space.bilibili.com/19430480",
        "https://t.me/elpsycn",
        "q1064779584@163.com",
        "https://www.travellings.cn/go.html"
      ]
    },
    {
      "@id": "https://imlklaus.github.io/#website",
      "@type": "WebSite",
      "dateModified": "2023-10-03T04:41:59.571Z",
      "datePublished": "2023-04-27T13:43:29.000Z",
      "inLanguage": "zh-CN",
      "name": "秒杀",
      "url": "https://imlklaus.github.io/",
      "publisher": {
        "@id": "https://imlklaus.github.io/#identity"
      }
    },
    {
      "@id": "https://imlklaus.github.io/posts/flash%20killing/#webpage",
      "@type": "WebPage",
      "description": true,
      "name": "秒杀",
      "url": "https://imlklaus.github.io/posts/flash%20killing",
      "about": {
        "@id": "https://imlklaus.github.io/#identity"
      },
      "isPartOf": {
        "@id": "https://imlklaus.github.io/#website"
      },
      "potentialAction": [
        {
          "@type": "ReadAction",
          "target": [
            "https://imlklaus.github.io/posts/flash%20killing"
          ]
        }
      ]
    },
    {
      "@id": "https://imlklaus.github.io/posts/flash%20killing/#article",
      "description": true,
      "headline": "秒杀",
      "inLanguage": "zh-CN",
      "thumbnailUrl": "https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/wallhaven-2em38y_1920x1080.png",
      "@type": [
        "Article",
        "BlogPosting"
      ],
      "author": {
        "@id": "https://imlklaus.github.io/#/schema/person/45376ff"
      },
      "image": {
        "@id": "https://imlklaus.github.io/#/schema/image/c93cc72"
      },
      "isPartOf": {
        "@id": "https://imlklaus.github.io/posts/flash%20killing/#webpage"
      },
      "mainEntityOfPage": {
        "@id": "https://imlklaus.github.io/posts/flash%20killing/#webpage"
      },
      "publisher": {
        "@id": "https://imlklaus.github.io/#identity"
      }
    },
    {
      "@id": "https://imlklaus.github.io/#/schema/person/45376ff",
      "@type": "Person",
      "name": "imklaus",
      "url": "https://valaxy.site"
    },
    {
      "@id": "https://imlklaus.github.io/#/schema/image/11067b0",
      "@type": "ImageObject",
      "contentUrl": "https://imlklaus.github.io/images/avatar.jpg",
      "inLanguage": "zh-CN",
      "url": "https://imlklaus.github.io/images/avatar.jpg"
    },
    {
      "@id": "https://imlklaus.github.io/#/schema/image/c93cc72",
      "@type": "ImageObject",
      "contentUrl": "https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/wallhaven-2em38y_1920x1080.png",
      "inLanguage": "zh-CN",
      "url": "https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/wallhaven-2em38y_1920x1080.png"
    }
  ]
}</script><link rel="stylesheet" href="/assets/index-e381b313.css"></body></html>