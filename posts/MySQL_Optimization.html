<!DOCTYPE html><html lang="en" data-beasties-container><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><link rel="icon" href="/favicon/dinosaur-egg.png"><script>!function(){const e=window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches,t=localStorage.getItem("vueuse-color-scheme")||"auto";("dark"===t||e&&"light"!==t)&&document.documentElement.classList.toggle("dark",!0)}()</script><style type="text/css">:root{color-scheme:light dark;--va-c-bg:#fff}html{background-color:var(--va-c-bg)}.yun-cloud{display:flex;width:100%;z-index:var(--yun-z-cloud);box-sizing:border-box}.yun-cloud .waves{display:flex;position:relative;width:100%;height:40px}.yun-cloud .parallax>use{animation:move-forever 25s cubic-bezier(.55,.5,.45,.5) infinite}.yun-cloud .parallax>use:first-child{opacity:.7;animation-delay:-2s;animation-duration:7s}.yun-cloud .parallax>use:nth-child(2){opacity:.5;animation-delay:-3s;animation-duration:10s}.yun-cloud .parallax>use:nth-child(3){opacity:.3;animation-delay:-4s;animation-duration:13s}.yun-cloud .parallax>use:nth-child(4){animation-delay:-5s;animation-duration:20s}@keyframes move-forever{0%{transform:translate3d(-90px,0,0)}to{transform:translate3d(85px,0,0)}}.yun-footer{letter-spacing:.05rem;line-height:1.8}.yun-footer-gradient{position:absolute;bottom:0;left:0;right:0;width:100%;height:300px;z-index:999;pointer-events:none;background:linear-gradient(to right,rgb(var(--gradient-from)/.2) 0,rgb(var(--gradient-to)/.2));-webkit-mask-image:linear-gradient(#fff0,#000 70%);mask-image:linear-gradient(#fff0,#000 70%);animation:fade-in 2s}.col{color:#4169e1}.va-toc[data-v-7dda16e2]{text-align:left}.content[data-v-7dda16e2]{position:relative;padding-left:16px;font-size:14px;text-align:left}.outline-marker[data-v-7dda16e2]{position:absolute;top:32px;left:-2px;z-index:0;opacity:0;width:4px;height:18px;background-color:var(--va-c-brand);transition:top .25s cubic-bezier(0,1,.5,1),background-color .5s,opacity .25s;border-top-right-radius:2px;border-bottom-right-radius:2px}.outline-title[data-v-7dda16e2]{letter-spacing:.4px;line-height:28px;font-size:14px;font-weight:600}.visually-hidden[data-v-7dda16e2]{position:absolute;width:1px;height:1px;white-space:nowrap;clip:rect(0 0 0 0);clip-path:inset(50%);overflow:hidden}.yun-aside{width:0;transform:translate(100%);transition:all .2s cubic-bezier(.77,0,.17,1.02);max-height:calc(100vh - var(--yun-margin-top))}@media screen and (min-width:1280px){.yun-aside{transform:translate(0)}}.toc-btn{color:var(--va-c-primary);z-index:var(--yun-z-toc-btn)}.back-to-top{position:fixed;right:-1.5rem;bottom:1rem;z-index:var(--yun-z-go-up-btn);opacity:0;pointer-events:none;color:var(--va-c-primary);transform:translate(0) rotate(270deg);transition:all var(--va-transition-duration),opacity var(--va-transition-duration-fast)!important}.progress-circle{transition:.3s stroke-dashoffset;transform:rotate(-90deg);transform-origin:50% 50%}.progress-circle-container{position:absolute}.spinner[data-v-6a52d49b]{width:60px;height:60px;border:1px solid var(--va-c-primary);margin:100px auto;animation:rotateplane-6a52d49b 1.2s infinite ease-in-out}@keyframes rotateplane-6a52d49b{0%{transform:perspective(120px) rotateX(0) rotateY(0)}50%{transform:perspective(120px) rotateX(-180.1deg) rotateY(0)}to{transform:perspective(120px) rotateX(-180deg) rotateY(-180deg)}}.yun-bg{position:fixed;width:100%;height:100%;z-index:-1;top:0;left:0;background-image:var(--yun-bg-img);background-size:cover;background-position:center;background-repeat:no-repeat;background-attachment:fixed;animation-name:bg-fade-in;animation-duration:2s;opacity:var(--yun-bg-img-opacity, 1)}@supports (-webkit-touch-callout:none){.yun-bg{background-attachment:scroll}}@keyframes bg-fade-in{0%{opacity:0}to{opacity:var(--yun-bg-img-opacity, 1)}}canvas.fireworks{position:fixed;left:0;top:0;z-index:1;pointer-events:none}.yun-page-header-gradient{position:absolute;top:0;left:0;right:0;width:100%;height:500px;z-index:var(--yun-z-page-gradient);pointer-events:none;background:linear-gradient(to right,rgb(var(--gradient-from)/.2) 0,rgb(var(--gradient-to)/.2));-webkit-mask-image:linear-gradient(#000,#fff0 70%);mask-image:linear-gradient(#000,#fff0 70%);animation:fade-in 2s}:root{--vp-code-block-bg:var(--va-c-bg-alt);--vp-code-tab-divider:var(--va-c-gutter)}@media screen and (max-width:640px){.markdown-body div[class*=language-]{margin:0 var(--va-code-mobile-margin-x,-1rem)}}@media (width >= 640px){.markdown-body div[class*=language-]{border-radius:6px;margin:16px 0}}@media (width <= 639.9px){.markdown-body li div[class*=language-]{border-radius:6px 0 0 6px}}.markdown-body code{font-size:.85em}.markdown-body div[class*=language-]{overflow:auto hidden;position:relative;background-color:var(--va-code-block-bg)}.markdown-body [class*=language-] code,.markdown-body [class*=language-] pre{direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;-moz-tab-size:4;tab-size:4;-webkit-hyphens:none;hyphens:none}.markdown-body [class*=language-] pre{position:relative;z-index:1;margin:0;padding:20px 0;background:0 0;overflow-x:auto}.markdown-body [class*=language-] code{display:block;padding:0 24px;width:fit-content;min-width:100%;line-height:var(--va-code-line-height);font-size:var(--va-code-font-size);color:var(--va-code-block-color);transition:color .5s}.markdown-body [class*=language-]>button.copy{direction:ltr;position:absolute;top:12px;right:12px;z-index:3;border:1px solid var(--va-code-copy-code-border-color);border-radius:4px;width:40px;height:40px;background-color:var(--va-code-copy-code-bg);opacity:0;cursor:pointer;background-image:var(--va-icon-copy);background-position:50%;background-size:20px;background-repeat:no-repeat;transition:border-color .25s,background-color .25s,opacity .25s}.markdown-body [class*=language-]:hover>button.copy,.markdown-body [class*=language-]>button.copy:focus{opacity:1}.markdown-body [class*=language-]>button.copy:hover{border-color:var(--va-code-copy-code-hover-border-color);background-color:var(--va-code-copy-code-hover-bg)}.markdown-body [class*=language-]>span.lang{position:absolute;top:2px;right:8px;z-index:2;font-size:12px;font-weight:500;color:var(--va-code-lang-color);transition:color .4s,opacity .4s}.markdown-body [class*=language-]:hover>button.copy+span.lang,.markdown-body [class*=language-]>button.copy:focus+span.lang{opacity:0}.markdown-body [class*=language-]>button.collapse{display:none;position:absolute;z-index:10;bottom:0;left:0;width:100%;height:24px;opacity:1;cursor:pointer;background-image:linear-gradient(-180deg,rgba(0,0,0,0) 0,var(--va-c-bg-dark) 100%)}.markdown-body [class*=language-]>button.collapse:before{display:block;content:"";width:100%;height:100%;background-image:var(--va-icon-collapse);background-position:50%;background-size:16px;background-repeat:no-repeat}.markdown-body h2,.markdown-body h3,.markdown-body h4{position:relative;font-weight:600;outline:0}.markdown-body figure{text-align:center}.markdown-body .end .line{height:1px}.markdown-body .header-anchor{position:absolute;top:0;left:0;margin-left:-.87em;font-weight:500;-webkit-user-select:none;user-select:none;opacity:0;text-decoration:none;transition:color .25s,opacity .25s}.markdown-body .header-anchor:before{content:var(--va-header-anchor-symbol, "#")}.markdown-body .header-anchor:before:hover{text-decoration:none}.markdown-body h2 .header-anchor:focus,.markdown-body h2:hover .header-anchor,.markdown-body h3 .header-anchor:focus,.markdown-body h3:hover .header-anchor,.markdown-body h4 .header-anchor:focus,.markdown-body h4:hover .header-anchor{opacity:1}html{transition:background-color .6s}:root{--p-overlay-popover-shadow:0px 4px 6px -1px rgb(0 0 0 / .1),0px 2px 4px -2px rgb(0 0 0 / .1);--p-overlay-popover-border-radius:4px;--p-tooltip-max-width:12.5rem;--p-tooltip-gutter:.25rem;--p-tooltip-shadow:var(--p-overlay-popover-shadow);--p-tooltip-padding:.25rem .75rem;--p-tooltip-border-radius:var(--p-overlay-popover-border-radius);--p-tooltip-background:var(--va-c-bg);--p-tooltip-color:var(--va-c-text)}*,:after,:before{box-sizing:border-box;border-width:0;border-style:solid;border-color:var(--un-default-border-color,#e5e7eb)}html{line-height:1.5;-webkit-text-size-adjust:100%;-moz-tab-size:4;tab-size:4;font-family:ui-sans-serif,system-ui,sans-serif,"Apple Color Emoji","Segoe UI Emoji",Segoe UI Symbol,"Noto Color Emoji";font-feature-settings:normal;font-variation-settings:normal;-webkit-tap-highlight-color:transparent}body{margin:0;line-height:inherit}hr{height:0;color:inherit;border-top-width:1px}h1,h2,h3,h4{font-size:inherit;font-weight:inherit}a{color:inherit;text-decoration:inherit}strong{font-weight:bolder}code,pre{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,Liberation Mono,Courier New,monospace;font-feature-settings:normal;font-variation-settings:normal;font-size:1em}table{text-indent:0;border-color:inherit;border-collapse:collapse}button{font-family:inherit;font-feature-settings:inherit;font-variation-settings:inherit;font-size:100%;font-weight:inherit;line-height:inherit;color:inherit;margin:0;padding:0}button{text-transform:none}button{-webkit-appearance:button;background-image:none}figure,h1,h2,h3,h4,hr,p,pre{margin:0}ol,ul{list-style:none;margin:0;padding:0}button{cursor:pointer}canvas,img,svg{display:block;vertical-align:middle}img{max-width:100%;height:auto}body{counter-reset:katexEqnNo mmlEqnNo}:root{--va-c-border:#c2c2c4;--va-c-divider:#e2e2e3;--va-c-gutter:#e2e2e3}:root{--va-c-gray-1:#dddde3;--va-c-gray-2:#e4e4e9;--va-c-gray-3:#ebebef;--va-c-gray-soft:rgba(142, 150, 170, .14);--va-c-indigo-1:#3451b2;--va-c-indigo-2:#3a5ccc;--va-c-indigo-3:#5672cd;--va-c-indigo-soft:rgba(100, 108, 255, .14);--va-c-green-1:#18794e;--va-c-green-2:#299764;--va-c-green-3:#30a46c;--va-c-green-soft:rgba(16, 185, 129, .14);--va-c-yellow-1:#915930;--va-c-yellow-2:#946300;--va-c-yellow-3:#9f6a00;--va-c-yellow-soft:rgba(234, 179, 8, .14);--va-c-red-1:#b8272c;--va-c-red-2:#d5393e;--va-c-red-3:#e0575b;--va-c-red-soft:rgba(244, 63, 94, .14);--va-c-sponsor:#db2777}:root{--va-c-default-1:var(--va-c-gray-1);--va-c-default-2:var(--va-c-gray-2);--va-c-default-3:var(--va-c-gray-3);--va-c-default-soft:var(--va-c-gray-soft);--va-c-brand-1:var(--va-c-indigo-1);--va-c-brand-2:var(--va-c-indigo-2);--va-c-brand-3:var(--va-c-indigo-3);--va-c-brand-soft:var(--va-c-indigo-soft);--va-c-brand:var(--va-c-brand-1);--va-c-tip-1:var(--va-c-brand-1);--va-c-tip-2:var(--va-c-brand-2);--va-c-tip-3:var(--va-c-brand-3);--va-c-tip-soft:var(--va-c-brand-soft);--va-c-warning-1:var(--va-c-yellow-1);--va-c-warning-2:var(--va-c-yellow-2);--va-c-warning-3:var(--va-c-yellow-3);--va-c-warning-soft:var(--va-c-yellow-soft);--va-c-danger-1:var(--va-c-red-1);--va-c-danger-2:var(--va-c-red-2);--va-c-danger-3:var(--va-c-red-3);--va-c-danger-soft:var(--va-c-red-soft)}:root{--va-aside-width:256px;--va-sidebar-width:300px;--va-border-width:1px;--va-font-serif:"Noto Serif SC",DM Serif Display,STZhongsong,STKaiti,KaiTi,Roboto,serif;--va-font-sans:DM Sans,Inter,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Oxygen,Ubuntu,Cantarell,"Fira Sans","Droid Sans","Helvetica Neue",sans-serif;--va-font-mono:DM Mono,Menlo,Monaco,Consolas,"Courier New",monospace;--va-transition-duration-fast:.2s;--va-transition-duration:.4s;--va-transition-duration-slow:.6s;--va-transition:all var(--va-transition-duration-fast) ease-in-out}:root{--va-c-white:#fff;--va-c-black:#1a1a1a;--va-c-gray:#8e8e8e;--va-c-danger:#db2828;--va-c-warning:#f2711c;--va-c-text-light-1:#213547;--va-c-text-light-2:rgba(60, 60, 60, .7);--va-c-text-light-3:rgba(60, 60, 60, .33);--va-c-text-light-4:rgba(60, 60, 60, .18);--va-c-text-dark-1:rgba(255, 255, 255, .87);--va-c-text-dark-2:rgba(235, 235, 235, .6);--va-c-text-dark-3:rgba(235, 235, 235, .38);--va-c-text-dark-4:rgba(235, 235, 235, .18);--va-c-primary-light:rgb(192.9, 91.2, 255);--va-c-primary-lighter:rgb(199.8, 109.4, 255);--va-c-primary-dark:rgb(173.5648351648, 40.2, 255);--va-c-primary:#BA49FF}:root{color-scheme:light;--va-c-brand:#BA49FF;--va-border-color:#222;--va-c-text:#333;--va-c-text-light:#555;--va-c-text-lighter:#666;--va-c-text-dark:#111;--va-c-primary-rgb:186,73,255;--va-c-link:var(--va-c-primary-dark)}:root{--va-c-text-1:rgba(60, 60, 67);--va-c-text-2:rgba(60, 60, 67, .78);--va-c-text-3:rgba(60, 60, 67, .56)}:root{--va-c-bg:#ffffff;--va-c-bg-light:#ffffff;--va-c-bg-dark:#fafafa;--va-c-bg-opacity:rgba(255, 255, 255, .8);--va-c-bg-soft:#f9f9f9;--va-c-bg-alt:#f9f9f9;--va-c-bg-mute:#f1f1f1}:root{--va-code-line-height:1.7;--va-code-font-size:.875em;--va-code-block-color:var(--va-c-text-2);--va-code-block-bg:var(--va-c-bg-alt);--va-code-block-divider-color:var(--va-c-gutter);--va-code-lang-color:var(--va-c-text-3);--va-code-line-highlight-color:var(--va-c-default-soft);--va-code-line-number-color:var(--va-c-text-3);--va-code-line-diff-add-color:var(--va-c-green-soft);--va-code-line-diff-add-symbol-color:var(--va-c-green-1);--va-code-line-diff-remove-color:var(--va-c-red-soft);--va-code-line-diff-remove-symbol-color:var(--va-c-red-1);--va-code-line-warning-color:var(--va-c-yellow-soft);--va-code-line-error-color:var(--va-c-red-soft);--va-code-copy-code-border-color:var(--va-c-divider);--va-code-copy-code-bg:var(--va-c-bg-soft);--va-code-copy-code-hover-border-color:var(--va-c-divider);--va-code-copy-code-hover-bg:var(--va-c-bg);--va-code-copy-code-active-text:var(--va-c-text-2);--va-code-copy-copied-text-content:"Copied";--va-code-tab-divider:var(--va-code-block-divider-color);--va-code-tab-text-color:var(--va-c-text-2);--va-code-tab-bg:var(--va-code-block-bg);--va-code-tab-hover-text-color:var(--va-c-text-1);--va-code-tab-active-text-color:var(--va-c-text-1);--va-code-tab-active-bar-color:var(--va-c-brand-1)}:root{--va-icon-copy:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' height='20' width='20' stroke='rgba(128,128,128,1)' stroke-width='2' class='h-6 w-6' viewBox='0 0 24 24'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' d='M9 5H7a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2h-2M9 5a2 2 0 0 0 2 2h2a2 2 0 0 0 2-2M9 5a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2'/%3E%3C/svg%3E");--va-icon-copied:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' height='20' width='20' stroke='rgba(128,128,128,1)' stroke-width='2' class='h-6 w-6' viewBox='0 0 24 24'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' d='M9 5H7a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2h-2M9 5a2 2 0 0 0 2 2h2a2 2 0 0 0 2-2M9 5a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2m-6 9 2 2 4-4'/%3E%3C/svg%3E");--va-icon-collapse:url("data:image/svg+xml,%3Csvg%20xmlns='http://www.w3.org/2000/svg'%20width='32'%20height='32' stroke='rgba(128,128,128,1)' viewBox='0%200%2024%2024'%3E%3Cpath%20fill='currentColor'%20d='m12%2016.175l3.9-3.875q.275-.275.688-.288t.712.288q.275.275.275.7t-.275.7l-4.6%204.6q-.15.15-.325.213t-.375.062q-.2%200-.375-.063T11.3%2018.3l-4.6-4.6q-.275-.275-.288-.687T6.7%2012.3q.275-.275.7-.275t.7.275l3.9%203.875Zm0-6L15.9%206.3q.275-.275.688-.287t.712.287q.275.275.275.7t-.275.7l-4.6%204.6q-.15.15-.325.213t-.375.062q-.2%200-.375-.062T11.3%2012.3L6.7%207.7q-.275-.275-.288-.688T6.7%206.3q.275-.275.7-.275t.7.275l3.9%203.875Z'/%3E%3C/svg%3E")}:root{--va-header-anchor-symbol:"#"}html{-webkit-tap-highlight-color:transparent;font-family:var(--va-font-sans)}a{color:var(--va-c-link);font-weight:500}*{outline:0}hr{margin:1rem}button{background-color:transparent}#app,body,html{margin:0;padding:0;line-height:2}html{background-color:var(--va-c-bg)}a{cursor:pointer}:root{--yun-margin-top:68px;--yun-home-hero-image-filter:blur(48px);--yun-home-hero-name-background:-webkit-linear-gradient(120deg, var(--va-c-text) 30%, black);--yun-home-hero-image-background-image:linear-gradient(-45deg, #bd34fe 50%, #47caff 50%);--yun-nav-height:50px}:root{--yun-post-card-max-width:900px;--yun-c-cloud:white;--yun-z-select:6;--yun-z-cloud:7;--yun-z-go-down:9;--yun-z-backdrop:9;--yun-z-sidebar:10;--yun-z-fireworks:11;--yun-z-toc-btn:11;--yun-z-go-up-btn:20;--yun-z-fullscreen-menu:21;--yun-z-nav-menu:22;--yun-z-menu-btn:22;--yun-z-search-popup:30;--yun-z-search-btn:31;--yun-z-overlay:32;--yun-z-aside:33;--yun-z-left-sidebar:34;--yun-z-left-sidebar-menu:35;--yun-z-page-gradient:35;--yun-z-dock:999999;--va-z-overlay:var(--yun-z-backdrop)}:root{--yun-bg-img:url(/assets/bg-img.kXdNMxcF.jpg);--yun-sidebar-bg-color:var(--va-c-bg-light);--yun-sidebar-bg-img:url(/assets/sidebar-bg-img.mp54gEws.webp)}@media screen and (width <= 768px){:root{--rect-margin:16px}}@media screen and (width > 768px){:root{--rect-margin:48px}}.post-category{color:var(--va-c-text)}.post-tag{white-space:nowrap;color:var(--yun-tag-color)}.post-tag:hover{color:var(--va-c-primary)}html{overflow-y:scroll}:root{--smc-font-sans:Raleway,-apple-system,"PingFang SC","Microsoft YaHei",Arial,sans-serif;--smc-font-serif:"Songti SC","Noto Serif SC",STZhongsong,STKaiti,KaiTi,Roboto,serif;--smc-font-mono:Menlo,Monaco,Consolas,"Courier New",monospace}:root{--smc-c-primary-light:rgb(224.6703296703, 175, 255);--smc-c-primary-lighter:rgb(253.6730769231, 251.5, 255);--smc-c-primary:#BA49FF;--smc-theme-name:yun;--smc-line-height:1.8;--smc-c-primary-rgb:186,73,255;--smc-c-text:#24292e;--smc-c-text-light:#555;--smc-c-text-lighter:#666;--smc-header-bottom-color:#eaecef;--smc-border-color:var(--smc-c-primary-light);--smc-code-bg-color:#f6f8fa;--smc-link-color:rgb(166.6648351648, 22, 255)}.markdown-body{-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%;background:var(--smc-bg-color);color:var(--smc-c-text);font-family:var(--smc-font-sans);font-size:1rem;line-height:var(--smc-line-height);overflow-wrap:break-word}.markdown-body *{box-sizing:border-box}.markdown-body a{background-color:transparent}.markdown-body a:active,.markdown-body a:hover{outline-width:0}.markdown-body hr{background-color:var(--smc-c-primary,#333);height:2px;margin:1.5rem 0}.markdown-body code,.markdown-body pre{font-family:Source Code Pro,Consolas,Monaco,SFMono-Regular,Ubuntu Mono,Menlo,monospace}.markdown-body code{padding:3px 6px;font-size:.85rem;color:var(--smc-c-text-light);background:var(--smc-code-bg-color);border-radius:3px}.markdown-body pre{margin-top:0;margin-bottom:0;overflow-wrap:normal;padding:1rem;overflow:auto;background-color:var(--smc-code-bg-color);border-radius:3px}.markdown-body pre>code{font-size:.85rem;white-space:pre}.markdown-body pre code{display:block;padding:0;margin:0;overflow:visible;line-height:inherit;word-break:normal;background-color:transparent;border:0}.markdown-body img{display:block;margin:1rem auto;max-width:92%;max-height:600px;border-radius:.2rem;transition:.4s;--tw-shadow:0 1px 3px 0 rgb(0 0 0/.1),0 1px 2px -1px rgb(0 0 0/.1);--tw-shadow-colored:0 1px 3px 0 var(--tw-shadow-color),0 1px 2px -1px var(--tw-shadow-color);-webkit-box-shadow:var(--tw-ring-offset-shadow,0 0 transparent),var(--tw-ring-shadow,0 0 transparent),var(--tw-shadow);box-shadow:var(--tw-ring-offset-shadow,0 0 transparent),var(--tw-ring-shadow,0 0 transparent),var(--tw-shadow)}.markdown-body img:hover{--tw-shadow:0 4px 6px -1px rgb(0 0 0/.1),0 2px 4px -2px rgb(0 0 0/.1);--tw-shadow-colored:0 4px 6px -1px var(--tw-shadow-color),0 2px 4px -2px var(--tw-shadow-color)}.markdown-body img:before{content:"「 LOADING ERROR 」"}@media screen and (min-width:1600px){.markdown-body img{max-width:800px}}.markdown-body a{color:var(--smc-c-primary);text-decoration:none;border-bottom:1px solid transparent;transition:all .2s ease-in-out}.markdown-body a:hover{color:var(--smc-link-color);border-bottom:1px solid var(--smc-link-color)}.markdown-body a:not([href]){color:inherit;text-decoration:none}.markdown-body ol,.markdown-body ul{padding-left:2em}.markdown-body ol ul,.markdown-body ul ul{margin-top:0;margin-bottom:0}.markdown-body li{overflow-wrap:break-all;margin-top:.25em}.markdown-body li>p{margin-top:16px}.markdown-body table{width:100%;overflow:auto;border-spacing:0;border-collapse:collapse}.markdown-body table td,.markdown-body table th{padding:6px 13px;border:1px solid var(--smc-c-primary-light,#999)}.markdown-body table thead th{font-weight:600}.markdown-body table>tbody>tr:hover{background-color:rgba(var(--smc-c-primary-rgb),.1)}.markdown-body strong{font-family:var(--smc-font-serif);font-weight:900}.markdown-body p{margin-top:1rem;margin-bottom:1rem;overflow-x:auto;overflow-y:hidden}.markdown-body h2,.markdown-body h3,.markdown-body h4{margin-top:1.5rem;margin-bottom:1rem;font-weight:300;line-height:1.5}.markdown-body h2{font-size:2.2rem;border-bottom:1px solid var(--smc-header-bottom-color)}.markdown-body h3{font-size:1.9rem}.markdown-body h4{font-size:1.6rem}@media screen and (max-width:768px){.markdown-body h2{font-size:1.8rem}.markdown-body h3{font-size:1.6rem}.markdown-body h4{font-size:1.4rem}}.yun-icon-btn{background-color:transparent;cursor:pointer;display:inline-flex;align-items:center;justify-content:center;border:none;width:3rem;height:3rem;border-radius:50%;transition:background-color var(--va-transition-duration)}.yun-icon-btn div{font-size:1.2rem}.yun-icon-btn:hover{background-color:rgba(var(--va-c-primary-rgb),.08)}.yun-icon-btn:active{background-color:rgba(var(--va-c-primary-rgb),.16)}.markdown-body{--smc-font-family:var(--va-font-sans);--c-toc-link:var(--va-c-text-light)}.markdown-body{word-wrap:break-word}.markdown-body a{color:var(--va-c-link)}.markdown-body h2,.markdown-body h3,.markdown-body h4{font-family:var(--va-font-serif);font-weight:900}.markdown-body ul{list-style:initial}.markdown-body ul li>p{margin-bottom:0}.markdown-body ol li{list-style:decimal}.markdown-body img{margin:.5rem auto;height:auto;max-width:min(92%,800px)}.markdown-body p{overflow:unset}.markdown-body hr{opacity:.6;height:2px;border-top-width:0;background-color:var(--va-c-text)}html:not(.dark) .vp-code span{color:var(--shiki-light,inherit)}:root{--va-custom-block-font-size:14px;--va-custom-block-code-font-size:13px;--va-custom-block-info-border:transparent;--va-custom-block-info-text:var(--va-c-text-1);--va-custom-block-info-bg:var(--va-c-default-soft);--va-custom-block-info-code-bg:var(--va-c-default-soft);--va-custom-block-tip-border:transparent;--va-custom-block-tip-text:var(--va-c-text-1);--va-custom-block-tip-bg:var(--va-c-brand-soft);--va-custom-block-tip-code-bg:var(--va-c-brand-soft);--va-custom-block-warning-border:transparent;--va-custom-block-warning-text:var(--va-c-text-1);--va-custom-block-warning-bg:var(--va-c-warning-soft);--va-custom-block-warning-code-bg:var(--va-c-warning-soft);--va-custom-block-danger-border:transparent;--va-custom-block-danger-text:var(--va-c-text-1);--va-custom-block-danger-bg:var(--va-c-danger-soft);--va-custom-block-danger-code-bg:var(--va-c-danger-soft);--va-custom-block-details-border:var(--va-custom-block-info-border);--va-custom-block-details-text:var(--va-custom-block-info-text);--va-custom-block-details-bg:var(--va-custom-block-info-bg);--va-custom-block-details-code-bg:var(--va-custom-block-info-code-bg)}:root{--va-font-serif:""Noto Serif SC", STZhongsong, STKaiti, KaiTi, Roboto,  serif";--va-c-bg-light:rgba(255, 255, 255, .8)}*,:after,:before{--un-rotate:0;--un-rotate-x:0;--un-rotate-y:0;--un-rotate-z:0;--un-scale-x:1;--un-scale-y:1;--un-scale-z:1;--un-skew-x:0;--un-skew-y:0;--un-translate-x:0;--un-translate-y:0;--un-translate-z:0;--un-pan-x: ;--un-pan-y: ;--un-pinch-zoom: ;--un-scroll-snap-strictness:proximity;--un-ordinal: ;--un-slashed-zero: ;--un-numeric-figure: ;--un-numeric-spacing: ;--un-numeric-fraction: ;--un-border-spacing-x:0;--un-border-spacing-y:0;--un-ring-offset-shadow:0 0 rgb(0 0 0 / 0);--un-ring-shadow:0 0 rgb(0 0 0 / 0);--un-shadow-inset: ;--un-shadow:0 0 rgb(0 0 0 / 0);--un-ring-inset: ;--un-ring-offset-width:0px;--un-ring-offset-color:#fff;--un-ring-width:0px;--un-ring-color:rgb(147 197 253 / .5);--un-blur: ;--un-brightness: ;--un-contrast: ;--un-drop-shadow: ;--un-grayscale: ;--un-hue-rotate: ;--un-invert: ;--un-saturate: ;--un-sepia: ;--un-backdrop-blur: ;--un-backdrop-brightness: ;--un-backdrop-contrast: ;--un-backdrop-grayscale: ;--un-backdrop-hue-rotate: ;--un-backdrop-invert: ;--un-backdrop-opacity: ;--un-backdrop-saturate: ;--un-backdrop-sepia: }[i-ri-arrow-left-s-line=""]{--un-icon:url("data:image/svg+xml;utf8,%3Csvg viewBox='0 0 24 24' width='1.2em' height='1.2em' xmlns='http://www.w3.org/2000/svg' %3E%3Cpath fill='currentColor' d='m10.828 12l4.95 4.95l-1.414 1.415L8 12l6.364-6.364l1.414 1.414z'/%3E%3C/svg%3E");-webkit-mask:var(--un-icon) no-repeat;mask:var(--un-icon) no-repeat;-webkit-mask-size:100% 100%;mask-size:100% 100%;background-color:currentColor;color:inherit;width:1.2em;height:1.2em}[i-ri-arrow-right-s-line=""]{--un-icon:url("data:image/svg+xml;utf8,%3Csvg viewBox='0 0 24 24' width='1.2em' height='1.2em' xmlns='http://www.w3.org/2000/svg' %3E%3Cpath fill='currentColor' d='m13.172 12l-4.95-4.95l1.414-1.413L16 12l-6.364 6.364l-1.414-1.415z'/%3E%3C/svg%3E");-webkit-mask:var(--un-icon) no-repeat;mask:var(--un-icon) no-repeat;-webkit-mask-size:100% 100%;mask-size:100% 100%;background-color:currentColor;color:inherit;width:1.2em;height:1.2em}[i-ri-arrow-up-s-line=""]{--un-icon:url("data:image/svg+xml;utf8,%3Csvg viewBox='0 0 24 24' width='1.2em' height='1.2em' xmlns='http://www.w3.org/2000/svg' %3E%3Cpath fill='currentColor' d='m12 10.828l-4.95 4.95l-1.414-1.414L12 8l6.364 6.364l-1.414 1.414z'/%3E%3C/svg%3E");-webkit-mask:var(--un-icon) no-repeat;mask:var(--un-icon) no-repeat;-webkit-mask-size:100% 100%;mask-size:100% 100%;background-color:currentColor;color:inherit;width:1.2em;height:1.2em}[i-ri-calendar-2-line=""]{--un-icon:url("data:image/svg+xml;utf8,%3Csvg viewBox='0 0 24 24' width='1.2em' height='1.2em' xmlns='http://www.w3.org/2000/svg' %3E%3Cpath fill='currentColor' d='M9 1v2h6V1h2v2h4a1 1 0 0 1 1 1v16a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V4a1 1 0 0 1 1-1h4V1zm11 10H4v8h16zM8 13v2H6v-2zm5 0v2h-2v-2zm5 0v2h-2v-2zM7 5H4v4h16V5h-3v2h-2V5H9v2H7z'/%3E%3C/svg%3E");-webkit-mask:var(--un-icon) no-repeat;mask:var(--un-icon) no-repeat;-webkit-mask-size:100% 100%;mask-size:100% 100%;background-color:currentColor;color:inherit;width:1.2em;height:1.2em}[i-ri-calendar-line=""]{--un-icon:url("data:image/svg+xml;utf8,%3Csvg viewBox='0 0 24 24' width='1.2em' height='1.2em' xmlns='http://www.w3.org/2000/svg' %3E%3Cpath fill='currentColor' d='M9 1v2h6V1h2v2h4a1 1 0 0 1 1 1v16a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V4a1 1 0 0 1 1-1h4V1zm11 10H4v8h16zM7 5H4v4h16V5h-3v2h-2V5H9v2H7z'/%3E%3C/svg%3E");-webkit-mask:var(--un-icon) no-repeat;mask:var(--un-icon) no-repeat;-webkit-mask-size:100% 100%;mask-size:100% 100%;background-color:currentColor;color:inherit;width:1.2em;height:1.2em}[i-ri-chat-4-line=""]{--un-icon:url("data:image/svg+xml;utf8,%3Csvg viewBox='0 0 24 24' width='1.2em' height='1.2em' xmlns='http://www.w3.org/2000/svg' %3E%3Cpath fill='currentColor' d='M5.763 17H20V5H4v13.385zm.692 2L2 22.5V4a1 1 0 0 1 1-1h18a1 1 0 0 1 1 1v14a1 1 0 0 1-1 1z'/%3E%3C/svg%3E");-webkit-mask:var(--un-icon) no-repeat;mask:var(--un-icon) no-repeat;-webkit-mask-size:100% 100%;mask-size:100% 100%;background-color:currentColor;color:inherit;width:1.2em;height:1.2em}[i-ri-eye-line=""]{--un-icon:url("data:image/svg+xml;utf8,%3Csvg viewBox='0 0 24 24' width='1.2em' height='1.2em' xmlns='http://www.w3.org/2000/svg' %3E%3Cpath fill='currentColor' d='M12 3c5.392 0 9.878 3.88 10.819 9c-.94 5.12-5.427 9-10.819 9s-9.878-3.88-10.818-9C2.122 6.88 6.608 3 12 3m0 16a9.005 9.005 0 0 0 8.778-7a9.005 9.005 0 0 0-17.555 0A9.005 9.005 0 0 0 12 19m0-2.5a4.5 4.5 0 1 1 0-9a4.5 4.5 0 0 1 0 9m0-2a2.5 2.5 0 1 0 0-5a2.5 2.5 0 0 0 0 5'/%3E%3C/svg%3E");-webkit-mask:var(--un-icon) no-repeat;mask:var(--un-icon) no-repeat;-webkit-mask-size:100% 100%;mask-size:100% 100%;background-color:currentColor;color:inherit;width:1.2em;height:1.2em}[i-ri-file-list-line=""]{--un-icon:url("data:image/svg+xml;utf8,%3Csvg viewBox='0 0 24 24' width='1.2em' height='1.2em' xmlns='http://www.w3.org/2000/svg' %3E%3Cpath fill='currentColor' d='M20 22H4a1 1 0 0 1-1-1V3a1 1 0 0 1 1-1h16a1 1 0 0 1 1 1v18a1 1 0 0 1-1 1m-1-2V4H5v16zM8 7h8v2H8zm0 4h8v2H8zm0 4h8v2H8z'/%3E%3C/svg%3E");-webkit-mask:var(--un-icon) no-repeat;mask:var(--un-icon) no-repeat;-webkit-mask-size:100% 100%;mask-size:100% 100%;background-color:currentColor;color:inherit;width:1.2em;height:1.2em}[i-ri-file-word-line=""]{--un-icon:url("data:image/svg+xml;utf8,%3Csvg viewBox='0 0 24 24' width='1.2em' height='1.2em' xmlns='http://www.w3.org/2000/svg' %3E%3Cpath fill='currentColor' d='M16 8v8h-2l-2-2l-2 2H8V8h2v5l2-2l2 2V8h1V4H5v16h14V8zM3 2.992C3 2.444 3.447 2 3.999 2H16l5 5v13.993A1 1 0 0 1 20.007 22H3.993A1 1 0 0 1 3 21.008z'/%3E%3C/svg%3E");-webkit-mask:var(--un-icon) no-repeat;mask:var(--un-icon) no-repeat;-webkit-mask-size:100% 100%;mask-size:100% 100%;background-color:currentColor;color:inherit;width:1.2em;height:1.2em}[i-ri-folder-2-line=""]{--un-icon:url("data:image/svg+xml;utf8,%3Csvg viewBox='0 0 24 24' width='1.2em' height='1.2em' xmlns='http://www.w3.org/2000/svg' %3E%3Cpath fill='currentColor' d='M12.414 5H21a1 1 0 0 1 1 1v14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V4a1 1 0 0 1 1-1h7.414zM20 11H4v8h16zm0-2V7h-8.414l-2-2H4v4z'/%3E%3C/svg%3E");-webkit-mask:var(--un-icon) no-repeat;mask:var(--un-icon) no-repeat;-webkit-mask-size:100% 100%;mask-size:100% 100%;background-color:currentColor;color:inherit;width:1.2em;height:1.2em}.i-ri-heart-line{--un-icon:url("data:image/svg+xml;utf8,%3Csvg viewBox='0 0 24 24' width='1.2em' height='1.2em' xmlns='http://www.w3.org/2000/svg' %3E%3Cpath fill='currentColor' d='M12.001 4.529a6 6 0 0 1 8.242.228a6 6 0 0 1 .236 8.236l-8.48 8.492l-8.478-8.492a6 6 0 0 1 8.48-8.464m6.826 1.641a4 4 0 0 0-5.49-.153l-1.335 1.198l-1.336-1.197a4 4 0 0 0-5.686 5.605L12 18.654l7.02-7.03a4 4 0 0 0-.193-5.454'/%3E%3C/svg%3E");-webkit-mask:var(--un-icon) no-repeat;mask:var(--un-icon) no-repeat;-webkit-mask-size:100% 100%;mask-size:100% 100%;background-color:currentColor;color:inherit;width:1.2em;height:1.2em}[i-ri-pushpin-line=""]{--un-icon:url("data:image/svg+xml;utf8,%3Csvg viewBox='0 0 24 24' width='1.2em' height='1.2em' xmlns='http://www.w3.org/2000/svg' %3E%3Cpath fill='currentColor' d='m13.827 1.69l8.486 8.485l-1.415 1.414l-.707-.707l-4.242 4.243l-.707 3.536l-1.415 1.414l-4.242-4.243l-4.95 4.95l-1.414-1.414l4.95-4.95l-4.243-4.243l1.414-1.414l3.536-.707l4.242-4.243l-.707-.707zm.707 3.536l-4.67 4.67l-2.822.565l6.5 6.5l.564-2.822l4.671-4.67z'/%3E%3C/svg%3E");-webkit-mask:var(--un-icon) no-repeat;mask:var(--un-icon) no-repeat;-webkit-mask-size:100% 100%;mask-size:100% 100%;background-color:currentColor;color:inherit;width:1.2em;height:1.2em}[i-ri-timer-line=""]{--un-icon:url("data:image/svg+xml;utf8,%3Csvg viewBox='0 0 24 24' width='1.2em' height='1.2em' xmlns='http://www.w3.org/2000/svg' %3E%3Cpath fill='currentColor' d='m17.618 5.968l1.453-1.453l1.414 1.414l-1.453 1.453A9 9 0 1 1 12 4c2.125 0 4.078.736 5.618 1.968M12 20a7 7 0 1 0 0-14a7 7 0 0 0 0 14M11 8h2v6h-2zM8 1h8v2H8z'/%3E%3C/svg%3E");-webkit-mask:var(--un-icon) no-repeat;mask:var(--un-icon) no-repeat;-webkit-mask-size:100% 100%;mask-size:100% 100%;background-color:currentColor;color:inherit;width:1.2em;height:1.2em}.flex-center,[flex~=center]{display:flex;align-items:center;justify-content:center}.inline-flex-center{display:inline-flex;align-items:center;justify-content:center}.va-card{background-color:var(--va-c-bg-light);--un-shadow:var(--un-shadow-inset) 0 1px 3px 0 var(--un-shadow-color, rgb(0 0 0 / .1)),var(--un-shadow-inset) 0 1px 2px -1px var(--un-shadow-color, rgb(0 0 0 / .1));box-shadow:var(--un-ring-offset-shadow),var(--un-ring-shadow),var(--un-shadow)}.yun-card{--un-shadow:var(--un-shadow-inset) 0 1px 3px 0 var(--un-shadow-color, rgb(0 0 0 / .1)),var(--un-shadow-inset) 0 1px 2px -1px var(--un-shadow-color, rgb(0 0 0 / .1));box-shadow:var(--un-ring-offset-shadow),var(--un-ring-shadow),var(--un-shadow);transition-property:color,background-color,border-color,text-decoration-color,fill,stroke,opacity,box-shadow,transform,filter,backdrop-filter;transition-timing-function:cubic-bezier(.4,0,.2,1);transition-duration:.15s;transition-duration:var(--va-transition-duration)}.va-card:hover,.yun-card:hover{--un-shadow:var(--un-shadow-inset) 0 10px 15px -3px var(--un-shadow-color, rgb(0 0 0 / .1)),var(--un-shadow-inset) 0 4px 6px -4px var(--un-shadow-color, rgb(0 0 0 / .1));box-shadow:var(--un-ring-offset-shadow),var(--un-ring-shadow),var(--un-shadow)}.absolute,[absolute=""]{position:absolute}.fixed{position:fixed}.relative{position:relative}.sticky{position:sticky}[bottom-0=""]{bottom:0}.left-0,[left-0=""]{left:0}.right-0,[right-0=""]{right:0}.top--10{top:-2.5rem}.top-0,[top-0=""]{top:0}[bottom~="19"]{bottom:4.75rem}[right~="4"]{right:1rem}.z-1{z-index:1}[z-10=""]{z-index:10}.z-20{z-index:20}[m~="0"]{margin:0}[m~="2"]{margin:.5rem}.m-auto{margin:auto}[mx-1=""],[m~=x-1]{margin-left:.25rem;margin-right:.25rem}[m~=y-4]{margin-top:1rem;margin-bottom:1rem}[m~=y-2]{margin-top:.5rem;margin-bottom:.5rem}[m~="!y-2"]{margin-top:.5rem!important;margin-bottom:.5rem!important}[mx~="2"]{margin-left:.5rem;margin-right:.5rem}.mb-4{margin-bottom:1rem}[m~=b-2]{margin-bottom:.5rem}.ml-1,[ml-1=""]{margin-left:.25rem}.mt-4{margin-top:1rem}.mt-12{margin-top:3rem}.mt-14{margin-top:3.5rem}.mt-2,[mt~="2"]{margin-top:.5rem}[m~=t-6]{margin-top:1.5rem}.mt-8{margin-top:2rem}.inline-block{display:inline-block}.size-8{width:2rem;height:2rem}[h~="5"]{height:1.25rem}.min-h-sm{min-height:24rem}.w-full,[w~=full]{width:100%}[h~="64"]{height:16rem}[h~="7"]{height:1.75rem}[min-h~="100px"]{min-height:100px}.flex,[flex=""],[flex~="~"]{display:flex}.inline-flex,[inline-flex=""]{display:inline-flex}[flex~="1"]{flex:1 1 0%}.flex-grow,[flex~=grow]{flex-grow:1}.flex-col,[flex~=col]{flex-direction:column}[flex~=wrap]{flex-wrap:wrap}@keyframes fade-in{0%{opacity:0}to{opacity:1}}@keyframes pulse{0%,to{opacity:1}50%{opacity:.5}}.animate-pulse{animation:pulse 2s cubic-bezier(.4,0,.6,1) infinite}.items-start{align-items:flex-start}.items-center,[items-center=""],[items~=center]{align-items:center}[justify~=end]{justify-content:flex-end}.justify-center,[justify~=center]{justify-content:center}.gap-1,[gap~="1"]{gap:.25rem}.gap-2{gap:.5rem}.gap-2\!{gap:.5rem!important}.gap-4{gap:1rem}[overflow~=auto]{overflow:auto}.truncate{overflow:hidden;text-overflow:ellipsis;white-space:nowrap}.whitespace-nowrap{white-space:nowrap}[border=""]{border-width:1px}.border-\$va-c-divider{border-color:var(--va-c-divider)}.rounded{border-radius:.25rem}[rounded-full=""]{border-radius:9999px}[bg~="$va-c-bg-light"]{background-color:var(--va-c-bg-light)}.bg-\$va-c-bg-soft{background-color:var(--va-c-bg-soft)}[bg~=white]{--un-bg-opacity:1;background-color:rgb(255 255 255 / var(--un-bg-opacity))}[bg~="$va-c-bg"]{background-color:var(--va-c-bg)}[hover~=bg-blue-500]:hover{--un-bg-opacity:1;background-color:rgb(59 130 246 / var(--un-bg-opacity))}[stroke-width~="2"]{stroke-width:2px}[p~="1"]{padding:.25rem}[p~="2"]{padding:.5rem}[p~="4"]{padding:1rem}.px-4,[p~=x-4]{padding-left:1rem;padding-right:1rem}[px-2=""]{padding-left:.5rem;padding-right:.5rem}.py-4{padding-top:1rem;padding-bottom:1rem}[py~="1"]{padding-top:.25rem;padding-bottom:.25rem}[pb-2=""]{padding-bottom:.5rem}.pt-0{padding-top:0}[p~=b-8]{padding-bottom:2rem}[text~=center]{text-align:center}[text~="2xl"]{font-size:1.5rem;line-height:2rem}[text~=sm]{font-size:.875rem;line-height:1.25rem}.text-xs{font-size:.75rem;line-height:1rem}.text-\$va-c-text-light{color:var(--va-c-text-light)}[hover~=text-white]:hover{--un-text-opacity:1;color:rgb(255 255 255 / var(--un-text-opacity))}[color~="$va-c-warning"]{color:var(--va-c-warning)}[font~=black]{font-weight:900}[font~=bold]{font-weight:700}.leading-none{line-height:1}.op-60{opacity:.6}.op-80{opacity:.8}.shadow-md{--un-shadow:var(--un-shadow-inset) 0 4px 6px -1px var(--un-shadow-color, rgb(0 0 0 / .1)),var(--un-shadow-inset) 0 2px 4px -2px var(--un-shadow-color, rgb(0 0 0 / .1));box-shadow:var(--un-ring-offset-shadow),var(--un-ring-shadow),var(--un-shadow)}.transition{transition-property:color,background-color,border-color,text-decoration-color,fill,stroke,opacity,box-shadow,transform,filter,backdrop-filter;transition-timing-function:cubic-bezier(.4,0,.2,1);transition-duration:.15s}[font~=serif]{font-family:var(--va-font-serif)}@media (max-width:767.9px){.lt-md\:w-full{width:100%}[p~="lt-md:0"]{padding:0}}@media (min-width:640px){.sm\:p-6{padding:1.5rem}.sm\:px-6{padding-left:1.5rem;padding-right:1.5rem}}@media (min-width:768px){.md\:mt-24{margin-top:6rem}.md\:w-3xl{width:48rem}}@media (min-width:1024px){.lg\:top-\$yun-margin-top{top:var(--yun-margin-top)}.lg\:w-2xl{width:42rem}.lg\:px-12{padding-left:3rem;padding-right:3rem}}@media (min-width:1280px){.xl\:hidden{display:none}.xl\:w-2xl{width:42rem}.xl\:px-16{padding-left:4rem;padding-right:4rem}}@media (min-width:1536px){.\32xl\:w-4xl{width:56rem}}.post-copyright{font-size:.9rem;padding:.5rem 1rem;border-left:4px solid var(--va-c-primary);background-color:var(--va-c-bg-dark);list-style:none;word-break:break-all;position:relative;overflow:hidden}.post-copyright:after{pointer-events:none;position:absolute;color:#fff;background:url("data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 496 512'%3E%3Cpath fill='gray' d='M245.8 214.9l-33.2 17.3c-9.4-19.6-25.2-20-27.4-20-22.2 0-33.3 14.6-33.3 43.9 0 23.5 9.2 43.8 33.3 43.8 14.4 0 24.6-7 30.5-21.3l30.6 15.5a73.2 73.2 0 01-65.1 39c-22.6 0-74-10.3-74-77 0-58.7 43-77 72.6-77 30.8-.1 52.7 11.9 66 35.8zm143 0l-32.7 17.3c-9.5-19.8-25.7-20-27.9-20-22.1 0-33.2 14.6-33.2 43.9 0 23.5 9.2 43.8 33.2 43.8 14.5 0 24.7-7 30.5-21.3l31 15.5c-2 3.8-21.3 39-65 39-22.7 0-74-9.9-74-77 0-58.7 43-77 72.6-77C354 179 376 191 389 214.8zM247.7 8C104.7 8 0 123 0 256c0 138.4 113.6 248 247.6 248C377.5 504 496 403 496 256 496 118 389.4 8 247.6 8zm.8 450.8c-112.5 0-203.7-93-203.7-202.8 0-105.5 85.5-203.3 203.8-203.3A201.7 201.7 0 01451.3 256c0 121.7-99.7 202.9-202.9 202.9z'/%3E%3C/svg%3E");content:" ";height:10rem;width:10rem;right:-2rem;top:-2rem;opacity:.1}</style><script>const locale=localStorage.getItem("valaxy-locale")||"zh-CN";document.documentElement.setAttribute("lang",locale)</script><script type="module" async crossorigin src="/assets/app._n2H9crI.js"></script><link rel="modulepreload" crossorigin href="/assets/framework.BHkQnU1p.js"><link rel="modulepreload" crossorigin href="/assets/chunks/vue-router.BdFSYZuY.js"><link rel="modulepreload" crossorigin href="/assets/chunks/dayjs.CORIJbU0.js"><link rel="modulepreload" crossorigin href="/assets/chunks/vue-i18n.CvY6KzGi.js"><link rel="modulepreload" crossorigin href="/assets/chunks/nprogress.BHm3HSQC.js"><link rel="modulepreload" crossorigin href="/assets/chunks/pinia.BY9HMtis.js"><link rel="modulepreload" crossorigin href="/assets/chunks/@vueuse/motion.CUAOwWQQ.js"><link rel="stylesheet" crossorigin href="/assets/app.4dS15k4m.css" onload='this.rel="stylesheet"'><noscript><link rel="stylesheet" crossorigin href="/assets/app.4dS15k4m.css"></noscript><link rel="modulepreload" crossorigin href="/assets/post.KAicZOof.js"><link rel="stylesheet" href="/assets/post.DDxwAI70.css" onload='this.rel="stylesheet"'><noscript><link rel="stylesheet" href="/assets/post.DDxwAI70.css"></noscript><link rel="modulepreload" crossorigin href="/assets/MySQL_Optimization.D42ANwfp.js"><title>MySQL - 优化 - imklaus's Blog</title><meta property="og:locale:alternate" content="en"><meta property="og:description" content="The Winner Takes It All."><meta property="og:locale" content="zh-CN"><meta property="og:site_name" content="imklaus's Blog "><meta property="og:title" content="MySQL - 优化"><meta property="og:image" content="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/freecompress-Sakura.png"><meta property="og:type" content="website"><meta property="og:url" content="https://www.imlklaus.cn/"><link rel="icon" href="/favicon/dinosaur-egg.png" type="image/png"><meta name="description" content="The Winner Takes It All."><meta name="generator" content="Valaxy 0.22.17"><script id="check-mac-os" async>document.documentElement.classList.toggle("mac",/Mac|iPhone|iPod|iPad/i.test(navigator.platform))</script><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@900&amp;display=swap"><meta name="theme-color" content="#fff"><meta name="msapplication-TileColor" content="#fff"><link rel="preload" as="font" crossorigin="anonymous" href="/assets/KaTeX_AMS-Regular.BQhdFMY1.woff2"><link rel="preload" as="font" crossorigin="anonymous" href="/assets/KaTeX_Caligraphic-Bold.Dq_IR9rO.woff2"><link rel="preload" as="font" crossorigin="anonymous" href="/assets/KaTeX_Caligraphic-Regular.Di6jR-x-.woff2"><link rel="preload" as="font" crossorigin="anonymous" href="/assets/KaTeX_Fraktur-Bold.CL6g_b3V.woff2"><link rel="preload" as="font" crossorigin="anonymous" href="/assets/KaTeX_Fraktur-Regular.CTYiF6lA.woff2"><link rel="preload" as="font" crossorigin="anonymous" href="/assets/KaTeX_Main-Bold.Cx986IdX.woff2"><link rel="preload" as="font" crossorigin="anonymous" href="/assets/KaTeX_Main-BoldItalic.DxDJ3AOS.woff2"><link rel="preload" as="font" crossorigin="anonymous" href="/assets/KaTeX_Main-Italic.NWA7e6Wa.woff2"><link rel="preload" as="font" crossorigin="anonymous" href="/assets/KaTeX_Main-Regular.B22Nviop.woff2"><link rel="preload" as="font" crossorigin="anonymous" href="/assets/KaTeX_Math-BoldItalic.CZnvNsCZ.woff2"><link rel="preload" as="font" crossorigin="anonymous" href="/assets/KaTeX_Math-Italic.t53AETM-.woff2"><link rel="preload" as="font" crossorigin="anonymous" href="/assets/KaTeX_SansSerif-Bold.D1sUS0GD.woff2"><link rel="preload" as="font" crossorigin="anonymous" href="/assets/KaTeX_SansSerif-Italic.C3H0VqGB.woff2"><link rel="preload" as="font" crossorigin="anonymous" href="/assets/KaTeX_SansSerif-Regular.DDBCnlJ7.woff2"><link rel="preload" as="font" crossorigin="anonymous" href="/assets/KaTeX_Script-Regular.D3wIWfF6.woff2"><link rel="preload" as="font" crossorigin="anonymous" href="/assets/KaTeX_Size1-Regular.mCD8mA8B.woff2"><link rel="preload" as="font" crossorigin="anonymous" href="/assets/KaTeX_Size2-Regular.Dy4dx90m.woff2"><link rel="preload" as="font" crossorigin="anonymous" href="data:font/woff2;base64,d09GMgABAAAAAA4oAA4AAAAAHbQAAA3TAAEAAAAAAAAAAAAAAAAAAAAAAAAAAAAABmAAgRQIDgmcDBEICo1oijYBNgIkA14LMgAEIAWJAAeBHAyBHBvbGiMRdnO0IkRRkiYDgr9KsJ1NUAf2kILNxgUmgqIgq1P89vcbIcmsQbRps3vCcXdYOKSWEPEKgZgQkprQQsxIXUgq0DqpGKmIvrgkeVGtEQD9DzAO29fM9jYhxZEsL2FeURH2JN4MIcTdO049NCVdxQ/w9NrSYFEBKTDKpLKfNkCGDc1RwjZLQcm3vqJ2UW9Xfa3tgAHz6ivp6vgC2yD4/6352ndnN0X0TL7seypkjZlMsjmZnf0Mm5Q+JykRWQBKCVCVPbARPXWyQtb5VgLB6Biq7/Uixcj2WGqdI8tGSgkuRG+t910GKP2D7AQH0DB9FMDW/obJZ8giFI3Wg8Cvevz0M+5m0rTh7XDBlvo9Y4vm13EXmfttwI4mBo1EG15fxJhUiCLbiiyCf/ZA6MFAhg3pGIZGdGIVjtPn6UcMk9A/UUr9PhoNsCENw1APAq0gpH73e+M+0ueyHbabc3vkbcdtzcf/fiy+NxQEjf9ud/ELBHAXJ0nk4z+MXH2Ev/kWyV4k7SkvpPc9Qr38F6RPWnM9cN6DJ0AdD1BhtgABtmoRoFCvPsBAumNm6soZG2Gk5GyVTo2sJncSyp0jQTYoR6WDvTwaaEcHsxHfvuWhHA3a6bN7twRKtcGok6NsCi7jYRrM2jExsUFMxMQYuJbMhuWNOumEJy9hi29Dmg5zMp/A5+hhPG19j1vBrq8JTLr8ki5VLPmG/PynJHVul440bxg5xuymHUFPBshC+nA9I1FmwbRBTNHAcik3Oae0cxKoI3MOriM42UrPe51nsaGxJ+WfXubAsP84aabUlQSJ1IiE0iPETLUU4CATgfXSCSpuRFRmCGbO+wSpAnzaeaCYW1VNEysRtuXCEL1kUFUbbtMv3Tilt/1c11jt3Q5bbMa84cpWipp8Elw3MZhOHsOlwwVUQM3lAR35JiFQbaYCRnMF2lxAWoOg2gyoIV4PouX8HytNIfLhqpJtXB4vjiViUI8IJ7bkC4ikkQvKksnOTKICwnqWSZ9YS5f0WCxmpgjbIq7EJcM4aI2nmhLNY2JIUgOjXZFWBHb+x5oh6cwb0Tv1ackHdKi0I9OO2wE9aogIOn540CCCziyhN+IaejtgAONKznHlHyutPrHGwCx9S6B8kfS4Mfi4Eyv7OU730bT1SCBjt834cXsf43zVjPUqqJjgrjeGnBxSG4aYAKFuVbeCfkDIjAqMb6yLNIbCuvXhMH2/+k2vkNpkORhR59N1CkzoOENvneIosjYmuTxlhUzaGEJQ/iWqx4dmwpmKjrwTiTGTCVozNAYqk/zXOndWxuWSmJkQpJw3pK5KX6QrLt5LATMqpmPAQhkhK6PUjzHUn7E0gHE0kPE0iKkolgkUx9SZmVAdDgpffdyJKg3k7VmzYGCwVXGz/tXmkOIp+vcWs+EMuhhvN0h9uhfzWJziBQmCREGSIFmQIkgVpAnSBRmC//6hkLZwaVhwxlrJSOdqlFtOYxlau9F2QN5Y98xmIAsiM1HVp2VFX+DHHGg6Ecjh3vmqtidX3qHI2qycTk/iwxSt5UzTmEP92ZBnEWTk4Mx8Mpl78ZDokxg/KWb+Q0QkvdKVmq3TMW+RXEgrsziSAfNXFMhDc60N5N9jQzjfO0kBKpUZl0ZmwJ41j/B9Hz6wmRaJB84niNmQrzp9eSlQCDDzazGDdVi3P36VZQ+Jy4f9UBNp+3zTjqI4abaFAm+GShVaXlsGdF3FYzZcDI6cori4kMxUECl9IjJZpzkvitAoxKue+90pDMvcKRxLl53TmOKCmV/xRolNKSqqUxc6LStOETmFOiLZZptlZepcKiAzteG8PEdpnQpbOMNcMsR4RR2Bs0cKFEvSmIjAFcnarqwUL4lDhHmnVkwu1IwshbiCcgvOheZuYyOteufZZwlcTlLgnZ3o/WcYdzZHW/WGaqaVfmTZ1aWCceJjkbZqsfbkOtcFlUZM/jy+hXHDbaUobWqqXaeWobbLO99yG5N3U4wxco0rQGGcOLASFMXeJoham8M+/x6O2WywK2l4HGbq1CoUyC/IZikQhdq3SiuNrvAEj0AVu9x2x3lp/xWzahaxidezFVtdcb5uEnzyl0ZmYiuKI0exvCd4Xc9CV1KB0db00z92wDPde0kukbvZIWN6jUWFTmPIC/Y4UPCm8UfDTFZpZNon1qLFTkBhxzB+FjQRA2Q/YRJT8pQigslMaUpFyAG8TMlXigiqmAZX4xgijKjRlGpLE0GdplRfCaJo0JQaSxNBk6ZmMzcya0FmrcisDdn0Q3HI2sWSppYigmlM1XT/kLQZSNpMJG0WkjYbSZuDpM1F0uYhFc1HxU4m1QJjDK6iL0S5uSj5rgXc3RejEigtcRBtqYPQsiTskmO5vosV+q4VGIKbOkDg0jtRrq+Em1YloaTFar3EGr1EUC8R0kus1Uus00usL97ABr2BjXoDm/QGNhuWtMVBKOwg/i78lT7hBsAvDmwHc/ao3vmUbBmhjeYySZNWvGkfZAgISDSaDo1SVpzGDsAEkF8B+gEapViUoZgUWXcRIGFZNm6gWbAKk0bp0k1MHG9fLYtV4iS2SmLEQFARzRcnf9PUS0LVn05/J9MiRRBU3v2IrvW974v4N00L7ZMk0wXP1409CHo/an8zTRHD3eSJ6m8D4YMkZNl3M79sqeuAsr/m3f+8/yl7A50aiAEJgeBeMWzu7ui9UfUBCe2TIqZIoOd/3/udRBOQidQZUERzb2/VwZN1H/Sju82ew2H2Wfr6qvfVf3hqwDvAIpkQVFy4B9Pe9e4/XvPeceu7h3dvO56iJPf0+A6cqA2ip18ER+iFgggiuOkvj24bby0N9j2UHIkgqIt+sVgfodC4YghLSMjSZbH0VR/6dMDrYJeKHilKTemt6v6kvzvn3/RrdWtr0GoN/xL+Sex/cPYLUpepx9cz/D46UPU5KXgAQa+NDps1v6J3xP1i2HtaDB0M9aX2deA7SYff//+gUCovMmIK/qfsFcOk+4Y5ZN97XlG6zebqtMbKgeRFi51vnxTQYBUik2rS/Cn6PC8ADR8FGxsRPB82dzfND90gIcshOcYUkfjherBz53odpm6TP8txlwOZ71xmfHHOvq053qFF/MRlS3jP0ELudrf2OeN8DHvp6ZceLe8qKYvWz/7yp0u4dKPfli3CYq0O13Ih71mylJ80tOi10On8wi+F4+LWgDPeJ30msSQt9/vkmHq9/Lvo2b461mP801v3W4xTcs6CbvF9UDdrSt+A8OUbpSh55qAUFXWznBBfdeJ8a4d7ugT5tvxUza3h9m4H7ptTqiG4z0g5dc0X29OcGlhpGFMpQo9ytTS+NViZpNdvU4kWx+LKxNY10kQ1yqGXrhe4/1nvP7E+nd5A92TtaRplbHSqoIdOqtRWti+fkB5/n1+/VvCmz12pG1kpQWsfi1ftlBobm0bpngs16CHkbIwdLnParxtTV3QYRlfJ0KFskH7pdN/YDn+yRuSd7sNH3aO0DYPggk6uWuXrfOc+fa3VTxFVvKaNxHsiHmsXyCLIE5yuOeN3/Jdf8HBL/5M6shjyhxHx9BjB1O0+4NLOnjLLSxwO7ukN4jMbOIcD879KLSi6Pk61Oqm2377n8079PXEEQ7cy7OKEC9nbpet118fxweTafpt69x/Bt8UqGzNQt7aelpc44dn5cqhwf71+qKp/Zf/+a0zcizOUWpl/iBcSXip0pplkatCchoH5c5aUM8I7/dWxAej8WicPL1URFZ9BDJelUwEwTkGqUhgSlydVes95YdXvhh9Gfz/aeFWvgVb4tuLbcv4+wLdutVZv/cUonwBD/6eDlE0aSiKK/uoH3+J1wDE/jMVqY2ysGufN84oIXB0sPzy8ollX/LegY74DgJXJR57sn+VGza0x3DnuIgABFM15LmajjjsNlYj+JEZGbuRYcAMOWxFkPN2w6Wd46xo4gVWQR/X4lyI/R6K/YK0110GzudPRW7Y+UOBGTfNNzHeYT0fiH0taunBpq9HEW8OKSaBGj21L0MqenEmNRWBAWDWAk4CpNoEZJ2tTaPFgbQYj8HxtFilErs3BTRwT8uO1NXQaWfIotchmPkAF5mMBAliEmZiOGVgCG9LgRzpscMAOOwowlT3JhusdazXGSC/hxR3UlmWVwWHpOIKheqONvjyhSiTHIkVUco5bnji8m//zL7PKaT1Vl5I6UE609f+gkr6MZKVyKc7zJRmCahLsdlyA5fdQkRSan9LgnnLEyGSkaKJCJog0wAgvepWBt80+1yKln1bMVtCljfNWDueKLsWwaEbBSfSPTEmVRsUcYYMnEjcjeyCZzBXK9E9BYBXLKjOSpUDR+nEV3TFSUdQaz+ot98QxgXwx0GQ+EEUAKB2qZPkQQ0GqFD8UPFMqyaCHM24BZmSGic9EYMagKizOw9Hz50DMrDLrqqLkTAhplMictiCAx5S3BIUQdeJeLnBy2CNtMfz6cV4u8XKoFZQesbf9YZiIERiHjaNodDW6LgcirX/mPnJIkBGDUpTBhSa0EIr38D5hCIszhCM8URGBqImoWjpvpt1ebu/v3Gl3qJfMnNM+9V+kiRFyROTPHQWOcs1dNW94/ukKMPZBvDi55i5CttdeJz84DLngLqjcdwEZ87bFFR8CIG35OAkDVN6VRDZ7aq67NteYqZ2lpT8oYB2CytoBd6VuAx4WgiAsnuj3WohG+LugzXiQRDeM3XYXlULv4dp5VFYC"><link rel="preload" as="font" crossorigin="anonymous" href="/assets/KaTeX_Size4-Regular.Dl5lxZxV.woff2"><link rel="preload" as="font" crossorigin="anonymous" href="/assets/KaTeX_Typewriter-Regular.CO6r4hn1.woff2"></head><body><div id="app" data-server-rendered="true"><!--[--><!--[--><!--[--><!----><!----><div class="yun-page-header-gradient" style="--gradient-from:161 196 253;--gradient-to:194 233 251"></div><!----><!----><!----><canvas class="fireworks"></canvas><!--[--><div class="yun-bg"></div><!--]--><div class="yun-page-loading" absolute left-0 right-0 bottom-0 top-0 flex justify="center" items-center z-10 bg="$va-c-bg" data-v-6a52d49b><div class="spinner" data-v-6a52d49b></div></div><a href="#" class="back-to-top yun-icon-btn bg-$va-c-bg-soft shadow-md"><div class="size-8" i-ri-arrow-up-s-line></div><svg class="progress-circle-container" viewBox="0 0 100 100"><circle stroke-dasharray="301.59289474462014 301.59289474462014" stroke-dashoffset="301.59289474462014" stroke="currentColor" stroke-width="2" stroke-linecap="round" class="progress-circle" cx="50" cy="50" r="48" fill="none"/></svg></a><!-- TODO --><!-- <YunDock /> --><!--]--><!--[--><!--]--><!----><!--]--><!--[--><div flex="~" class="w-full m-auto justify-center items-start gap-4 mt-12 md:mt-24"><!--[--><!----><main class="yun-main lt-md:w-full" flex="~ center"><!--[--><div class="content w-full md:w-3xl lg:w-2xl xl:w-2xl 2xl:w-4xl" flex="~ col grow" p="lt-md:0"><div class="yun-card flex-center rounded relative" flex="col" min-h="100px" bg="$va-c-bg-light" m="0" style><img width="640" height="360" class="object-cover select-none" h="64 md:sm" w="full" src="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/freecompress-Sakura.png" loading="lazy"><!----><!--[--><div class="mt-8 mb-4"><!--[--><header class="post-header" cover="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/freecompress-Sakura.png"><h1 p="2" text="2xl center" font="serif black" style="" class="post-title flex-center"><!----><span inline-flex class="leading-none">MySQL - 优化</span></h1></header><!--]--></div><!--[--><!--[--><!--[--><!----><!----><div class="post-top-icon" color="$va-c-warning"><div i-ri-pushpin-line></div></div><div flex="~ center" text="sm" class="flex-col gap-2! post-meta gap-4"><div class="post-time flex items-center gap-4"><span class="posted-time inline-flex-center gap-1" title="发表于2025-03-19 00:38:32"><div class="inline-block" i-ri-calendar-line></div><time class="op-80">2025-03-19</time></span><span class="edited-time inline-flex-center gap-1" title="更新于2025-03-20 01:57:18"><div i-ri-calendar-2-line></div><time class="op-80">2025-03-20</time></span></div><div class="inline-flex-center gap-4"><div class="inline-flex-center post-counter gap-4"><span class="word-count inline-flex-center gap-1" title="本文字数"><div class="inline-block" i-ri-file-word-line></div><span class="op-80">17.8k</span></span><span class="reading-time inline-flex-center gap-1" title="阅读时长"><div i-ri-timer-line></div><time class="op-80">82m</time></span></div><div class="inline-flex gap-4" text="sm" h="5"><div inline-flex justify="center" items="center" title="阅读次数"><div inline-flex i-ri-eye-line></div><span ml-1 inline-flex class="waline-pageview-count op-80" data-path="/posts/MySQL_Optimization"></span></div><div inline-flex justify="center" items="center" title="评论数"><div inline-flex i-ri-chat-4-line></div><span ml-1 inline-flex class="waline-comment-count op-80" data-path="/posts/MySQL_Optimization"></span></div></div></div></div><!--]--><div class="inline-flex mt-2" text="sm" py="1"><a href="/categories?category=MySQL/%E4%BC%98%E5%8C%96%E7%AF%87" class="transition post-category inline-flex-center text-xs border-$va-c-divider" px-2 h="7" border rounded-full hover="bg-blue-500 text-white"><div m="x-1" inline-flex i-ri-folder-2-line></div><span>MySQL / 优化篇</span></a><span mx="2"></span><div class="post-tags inline-flex" items="center" gap="1" flex="wrap 1" justify="end"><!--[--><a href="/tags/?tag=SQL" class="transition post-tag inline-flex-center text-xs border-$va-c-divider" px-2 h="7" rounded-full border hover="bg-blue-500 text-white"><span>SQL</span></a><!--]--></div></div><!--]--><!--]--><div p="x-4 b-8" class="sm:px-6 lg:px-12 xl:px-16" w="full"><!--[--><!--]--><!--[--><!-- <Transition appear> --><article class="markdown-body"><!--[--><!----><!----><!--[--><!--]--><!--[--><p>目录指引：</p><nav class="table-of-contents"><ul><li><a href="#表优化">表优化</a><ul><li><a href="#分区表">分区表</a></li><li><a href="#临时表">临时表</a></li></ul></li><li><a href="#优化步骤">优化步骤</a><ul><li><a href="#执行频率">执行频率</a></li><li><a href="#定位低效">定位低效</a></li><li><a href="#explain">EXPLAIN</a></li><li><a href="#profiles">PROFILES</a></li><li><a href="#trace">TRACE</a></li></ul></li><li><a href="#索引优化">索引优化</a><ul><li><a href="#创建索引">创建索引</a></li><li><a href="#避免失效">避免失效</a></li><li><a href="#底层原理">底层原理</a></li><li><a href="#查看索引">查看索引</a></li></ul></li><li><a href="#sql-优化">SQL 优化</a><ul><li><a href="#自增主键">自增主键</a></li><li><a href="#覆盖索引">覆盖索引</a></li><li><a href="#减少访问">减少访问</a></li><li><a href="#数据插入">数据插入</a></li><li><a href="#分组排序">分组排序</a></li><li><a href="#联合查询">联合查询</a></li><li><a href="#嵌套查询">嵌套查询</a></li><li><a href="#分页查询">分页查询</a></li><li><a href="#使用提示">使用提示</a></li><li><a href="#统计计数">统计计数</a></li></ul></li><li><a href="#缓冲优化">缓冲优化</a><ul><li><a href="#优化原则">优化原则</a></li><li><a href="#缓冲内存">缓冲内存</a></li><li><a href="#内存管理">内存管理</a></li><li><a href="#参数优化">参数优化</a></li></ul></li><li><a href="#内存优化">内存优化</a><ul><li><a href="#change">Change</a></li><li><a href="#net">Net</a></li><li><a href="#read">Read</a></li><li><a href="#key-1">Key</a></li></ul></li><li><a href="#存储优化">存储优化</a><ul><li><a href="#数据存储">数据存储</a></li><li><a href="#数据删除">数据删除</a></li><li><a href="#重建数据">重建数据</a></li><li><a href="#原地置换">原地置换</a></li></ul></li><li><a href="#并发优化">并发优化</a></li></ul></nav><h2 id="表优化" tabindex="-1">表优化 <a class="header-anchor" href="#表优化" aria-label="Permalink to &quot;表优化&quot;">​</a></h2><h3 id="分区表" tabindex="-1">分区表 <a class="header-anchor" href="#分区表" aria-label="Permalink to &quot;分区表&quot;">​</a></h3><h4 id="基本介绍" tabindex="-1">基本介绍 <a class="header-anchor" href="#基本介绍" aria-label="Permalink to &quot;基本介绍&quot;">​</a></h4><p>分区表是将大表的数据按分区字段分成许多小的子集，建立一个以 ftime 年份为分区的表：</p><div style="max-height:300px" class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code v-pre><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">CREATE</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> TABLE</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> `</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">t</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">` (</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">    `ftime`</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> datetime</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> NOT NULL</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">    `c`</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">11</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">DEFAULT</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> NULL</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">,</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">    KEY</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> (</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">`ftime`</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">) ENGINE</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">InnoDB </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">DEFAULT</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> CHARSET</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">latin1</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">PARTITION</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> BY</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> RANGE</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> (</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">YEAR</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(ftime))</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">PARTITION</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> p_2017 </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">VALUES</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> LESS THAN (</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">2017</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">) ENGINE </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> InnoDB,</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> PARTITION</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> p_2018 </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">VALUES</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> LESS THAN (</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">2018</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">) ENGINE </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> InnoDB,</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> PARTITION</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> p_2019 </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">VALUES</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> LESS THAN (</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">2019</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">) ENGINE </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> InnoDB,</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> PARTITION</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> p_others </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">VALUES</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> LESS THAN MAXVALUE ENGINE </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> InnoDB);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">INSERT INTO</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> t </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">VALUES</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">'2017-4-1'</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">,</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">),(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">'2018-4-1'</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">,</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">);</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">-- 这两行记录分别落在 p_2018 和 p_2019 这两个分区上</span></span></code></pre><button class="collapse"></button></div><p>这个表包含了一个.frm 文件和 4 个.ibd 文件，每个分区对应一个.ibd 文件</p><ul><li>对于引擎层来说，这是 4 个表，针对每个分区表的操作不会相互影响</li><li>对于 Server 层来说，这是 1 个表</li></ul><hr><h4 id="分区策略" tabindex="-1">分区策略 <a class="header-anchor" href="#分区策略" aria-label="Permalink to &quot;分区策略&quot;">​</a></h4><p>打开表行为：第一次访问一个分区表时，MySQL 需要<strong>把所有的分区都访问一遍</strong>，如果分区表的数量很多，超过了 open_files_limit 参数（默认值 1024），那么就会在访问这个表时打开所有的文件，导致打开表文件的个数超过了上限而报错</p><p>通用分区策略：MyISAM 分区表使用的分区策略，每次访问分区都由 Server 层控制，在文件管理、表管理的实现上很粗糙，因此有比较严重的性能问题</p><p>本地分区策略：从 MySQL 5.7.9 开始，InnoDB 引擎内部自己管理打开分区的行为，InnoDB 引擎打开文件超过 innodb_open_files 时就会<strong>关掉一些之前打开的文件</strong>，所以即使分区个数大于 open_files_limit，也不会报错</p><p>从 MySQL 8.0 版本开始，就不允许创建 MyISAM 分区表，只允许创建已经实现了本地分区策略的引擎，目前只有 InnoDB 和 NDB 这两个引擎支持了本地分区策略</p><hr><h4 id="server-层" tabindex="-1">Server 层 <a class="header-anchor" href="#server-层" aria-label="Permalink to &quot;Server 层&quot;">​</a></h4><p>从 Server 层看一个分区表就只是一个表</p><ul><li><p>Session A：</p><div style="max-height:300px" class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code v-pre><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">SELECT</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> *</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> FROM</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> t </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">WHERE</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> ftime </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF"> '2018-4-1'</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">;</span></span></code></pre><button class="collapse"></button></div></li><li><p>Session B：</p><div style="max-height:300px" class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code v-pre><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">ALTER</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> TABLE</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> t </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">TRUNCATE</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> PARTITION</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> p_2017; </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">-- blocked</span></span></code></pre><button class="collapse"></button></div></li></ul><p>现象：Session B 只操作 p_2017 分区，但是由于 Session A 持有整个表 t 的 MDL 读锁，就导致 B 的 ALTER 语句获取 MDL 写锁阻塞</p><p>分区表的特点：</p><ul><li>第一次访问的时候需要访问所有分区</li><li>在 Server 层认为这是同一张表，因此<strong>所有分区共用同一个 MDL 锁</strong></li><li>在引擎层认为这是不同的表，因此 MDL 锁之后的执行过程，会根据分区表规则，只访问需要的分区</li></ul><hr><h4 id="应用场景" tabindex="-1">应用场景 <a class="header-anchor" href="#应用场景" aria-label="Permalink to &quot;应用场景&quot;">​</a></h4><p>分区表的优点：</p><ul><li><p>对业务透明，相对于用户分表来说，使用分区表的业务代码更简洁</p></li><li><p>分区表可以很方便的清理历史数据。按照时间分区的分区表，就可以直接通过 <code>alter table t drop partition</code> 这个语法直接删除分区文件，从而删掉过期的历史数据，与使用 drop 语句删除数据相比，优势是速度快、对系统影响小</p></li></ul><p>使用分区表，不建议创建太多的分区，注意事项：</p><ul><li>分区并不是越细越好，单表或者单分区的数据一千万行，只要没有特别大的索引，对于现在的硬件能力来说都已经是小表</li><li>分区不要提前预留太多，在使用之前预先创建即可。比如是按月分区，每年年底时再把下一年度的 12 个新分区创建上即可，并且对于没有数据的历史分区，要及时的 drop 掉</li></ul><p>参考文档：<a href="https://time.geekbang.org/column/article/82560" target="_blank" rel="noreferrer">https://time.geekbang.org/column/article/82560</a></p><hr><h3 id="临时表" tabindex="-1">临时表 <a class="header-anchor" href="#临时表" aria-label="Permalink to &quot;临时表&quot;">​</a></h3><h4 id="基本介绍-1" tabindex="-1">基本介绍 <a class="header-anchor" href="#基本介绍-1" aria-label="Permalink to &quot;基本介绍&quot;">​</a></h4><p>临时表分为内部临时表和用户临时表</p><ul><li><p>内部临时表：系统执行 SQL 语句优化时产生的表，例如 Join 连接查询、去重查询等</p></li><li><p>用户临时表：用户主动创建的临时表</p><div style="max-height:300px" class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code v-pre><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">CREATE</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> TEMPORARY </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">TABLE</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> temp_t </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">like</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> table_1;</span></span></code></pre><button class="collapse"></button></div></li></ul><p>临时表可以是内存表，也可以是磁盘表（多表操作 → 嵌套查询章节提及）</p><ul><li>内存表指的是使用 Memory 引擎的表，建立哈希索引，建表语法是 <code>create table … engine=memory</code>，这种表的数据都保存在内存里，系统重启时会被清空，但是表结构还在</li><li>磁盘表是使用 InnoDB 引擎或者 MyISAM 引擎的临时表，建立 B+ 树索引，写数据的时候是写到磁盘上的</li></ul><p>临时表的特点：</p><ul><li>一个临时表只能被创建它的 session 访问，对其他线程不可见，所以不同 session 的临时表是<strong>可以重名</strong>的</li><li>临时表可以与普通表同名，会话内有同名的临时表和普通表时，执行 show create 语句以及增删改查语句访问的都是临时表</li><li>show tables 命令不显示临时表</li><li>数据库发生异常重启不需要担心数据删除问题，临时表会<strong>自动回收</strong></li></ul><hr><h4 id="重名原理" tabindex="-1">重名原理 <a class="header-anchor" href="#重名原理" aria-label="Permalink to &quot;重名原理&quot;">​</a></h4><p>执行创建临时表的 SQL：</p><div style="max-height:300px" class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code v-pre><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">create</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> temporary </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">table</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> temp_t(id </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">int</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> primary key</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">)engine</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">innodb;</span></span></code></pre><button class="collapse"></button></div><p>MySQL 给 InnoDB 表创建一个 frm 文件保存表结构定义，在 ibd 保存表数据。frm 文件放在临时文件目录下，文件名的后缀是 .frm，<strong>前缀是</strong> <code>#sql{进程 id}_{线程 id}_ 序列号</code>，使用 <code>select @@tmpdir</code> 命令，来显示实例的临时文件目录</p><p>MySQL 维护数据表，除了物理磁盘上的文件外，内存里也有一套机制区别不同的表，每个表都对应一个 table_def_key</p><ul><li>一个普通表的 table_def_key 的值是由 <code>库名 + 表名</code> 得到的，所以如果在同一个库下创建两个同名的普通表，创建第二个表的过程中就会发现 table_def_key 已经存在了</li><li>对于临时表，table_def_key 在 <code>库名 + 表名</code> 基础上，又加入了 <code>server_id + thread_id</code>，所以不同线程之间，临时表可以重名</li></ul><p>实现原理：每个线程都维护了自己的临时表链表，每次 session 内操作表时，先遍历链表，检查是否有这个名字的临时表，如果有就<strong>优先操作临时表</strong>，如果没有再操作普通表；在 session 结束时对链表里的每个临时表，执行 <code>DROP TEMPORARY TABLE + 表名</code> 操作</p><p>执行 rename table 语句无法修改临时表，因为会按照 <code>库名 / 表名.frm</code> 的规则去磁盘找文件，但是临时表文件名的规则是 <code>#sql{进程 id}_{线程 id}_ 序列号.frm</code>，因此会报找不到文件名的错误</p><hr><h4 id="主备复制" tabindex="-1">主备复制 <a class="header-anchor" href="#主备复制" aria-label="Permalink to &quot;主备复制&quot;">​</a></h4><p>创建临时表的语句会传到备库执行，因此备库的同步线程就会创建这个临时表。主库在线程退出时会自动删除临时表，但备库同步线程是持续在运行的并不会退出，所以这时就需要在主库上再写一个 DROP TEMPORARY TABLE 传给备库执行</p><p>binlog 日志写入规则：</p><ul><li>binlog_format=row，跟临时表有关的语句就不会记录到 binlog</li><li>binlog_format=statment/mixed，binlog 中才会记录临时表的操作，也就会记录 <code>DROP TEMPORARY TABLE</code> 这条命令</li></ul><p>主库上不同的线程创建同名的临时表是不冲突的，但是备库只有一个执行线程，所以 MySQL 在记录 binlog 时会把主库执行这个语句的线程 id 写到 binlog 中，在备库的应用线程就可以获取执行每个语句的主库线程 id，并利用这个线程 id 来构造临时表的 table_def_key</p><ul><li>session A 的临时表 t1，在备库的 table_def_key 就是：<code>库名 + t1 +“M 的 serverid" + "session A 的 thread_id”</code></li><li>session B 的临时表 t1，在备库的 table_def_key 就是 ：<code>库名 + t1 +"M 的 serverid" + "session B 的 thread_id"</code></li></ul><p>MySQL 在记录 binlog 的时不论是 create table 还是 alter table 语句都是原样记录，但是如果执行 drop table，系统记录 binlog 就会被服务端改写</p><div style="max-height:300px" class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code v-pre><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">DROP</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> TABLE</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF"> `t_normal`</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D"> /* generated by server */</span></span></code></pre><button class="collapse"></button></div><hr><h4 id="跨库查询" tabindex="-1">跨库查询 <a class="header-anchor" href="#跨库查询" aria-label="Permalink to &quot;跨库查询&quot;">​</a></h4><p>分库分表系统的跨库查询使用临时表不用担心线程之间的重名冲突，分库分表就是要把一个逻辑上的大表分散到不同的数据库实例上</p><p>比如将一个大表 ht，按照字段 f，拆分成 1024 个分表，分布到 32 个数据库实例上，一般情况下都有一个中间层 proxy 解析 SQL 语句，通过分库规则通过分表规则（比如 N%1024）确定将这条语句路由到哪个分表做查询</p><div style="max-height:300px" class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code v-pre><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">select</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> v </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">from</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> ht </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">where</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> f</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">N;</span></span></code></pre><button class="collapse"></button></div><p>如果这个表上还有另外一个索引 k，并且查询语句：</p><div style="max-height:300px" class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code v-pre><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">select</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> v </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">from</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> ht </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">where</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> k </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">&gt;=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> M </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">order by</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> t_modified </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">desc</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> limit</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> 100</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">;</span></span></code></pre><button class="collapse"></button></div><p>查询条件里面没有用到分区字段 f，只能<strong>到所有的分区</strong>中去查找满足条件的所有行，然后统一做 order by 操作，两种方式：</p><ul><li>在 proxy 层的进程代码中实现排序，拿到分库的数据以后，直接在内存中参与计算，但是对 proxy 端的压力比较大，很容易出现内存不够用和 CPU 瓶颈问题</li><li>把各个分库拿到的数据，汇总到一个 MySQL 实例的一个表中，然后在这个汇总实例上做逻辑操作，执行流程：<ul><li>在汇总库上创建一个临时表 temp_ht，表里包含三个字段 v、k、t_modified</li><li>在各个分库执行：<code>select v,k,t_modified from ht_x where k &gt;= M order by t_modified desc limit 100</code></li><li>把分库执行的结果插入到 temp_ht 表中</li><li>在临时表上执行：<code>select v from temp_ht order by t_modified desc limit 100</code></li></ul></li></ul><hr><h2 id="优化步骤" tabindex="-1">优化步骤 <a class="header-anchor" href="#优化步骤" aria-label="Permalink to &quot;优化步骤&quot;">​</a></h2><h3 id="执行频率" tabindex="-1">执行频率 <a class="header-anchor" href="#执行频率" aria-label="Permalink to &quot;执行频率&quot;">​</a></h3><p>MySQL 客户端连接成功后，查询服务器状态信息：</p><div style="max-height:300px" class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code v-pre><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">SHOW [SESSION|GLOBAL] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">STATUS</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> LIKE</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF"> ''</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">-- SESSION: 显示当前会话连接的统计结果，默认参数</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">-- GLOBAL: 显示自数据库上次启动至今的统计结果</span></span></code></pre><button class="collapse"></button></div><ul><li><p>查看 SQL 执行频率：</p><div style="max-height:300px" class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code v-pre><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">SHOW </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">STATUS</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> LIKE</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF"> 'Com_____'</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">;</span></span></code></pre><button class="collapse"></button></div><p>Com_xxx 表示每种语句执行的次数</p><figure><img src="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20250320000337300.png" alt="image-20250320000337300" loading="lazy" decoding="async" class="lazy"></figure></li><li><p>查询 SQL 语句影响的行数：</p><div style="max-height:300px" class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code v-pre><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">SHOW </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">STATUS</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> LIKE</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF"> 'Innodb_rows_%'</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">;</span></span></code></pre><button class="collapse"></button></div><figure><img src="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20250320004820682.png" alt="image-20250320004820682" loading="lazy" decoding="async" class="lazy"></figure></li></ul><p>Com_xxxx：这些参数对于所有存储引擎的表操作都会进行累计</p><p>Innodb_xxxx：这几个参数只是针对 InnoDB 存储引擎的，累加的算法也略有不同</p><table><thead><tr><th style="text-align:left">参数</th><th>含义</th></tr></thead><tbody><tr><td style="text-align:left">Com_select</td><td>执行 SELECT 操作的次数，一次查询只累加 1</td></tr><tr><td style="text-align:left">Com_insert</td><td>执行 INSERT 操作的次数，对于批量插入的 INSERT 操作，只累加一次</td></tr><tr><td style="text-align:left">Com_update</td><td>执行 UPDATE 操作的次数</td></tr><tr><td style="text-align:left">Com_delete</td><td>执行 DELETE 操作的次数</td></tr><tr><td style="text-align:left">Innodb_rows_read</td><td>执行 SELECT 查询返回的行数</td></tr><tr><td style="text-align:left">Innodb_rows_inserted</td><td>执行 INSERT 操作插入的行数</td></tr><tr><td style="text-align:left">Innodb_rows_updated</td><td>执行 UPDATE 操作更新的行数</td></tr><tr><td style="text-align:left">Innodb_rows_deleted</td><td>执行 DELETE 操作删除的行数</td></tr><tr><td style="text-align:left">Connections</td><td>试图连接 MySQL 服务器的次数</td></tr><tr><td style="text-align:left">Uptime</td><td>服务器工作时间</td></tr><tr><td style="text-align:left">Slow_queries</td><td>慢查询的次数</td></tr></tbody></table><hr><h3 id="定位低效" tabindex="-1">定位低效 <a class="header-anchor" href="#定位低效" aria-label="Permalink to &quot;定位低效&quot;">​</a></h3><p>SQL 执行慢有两种情况：</p><ul><li>偶尔慢：DB 在刷新脏页（学完事务就懂了）<ul><li>redo log 写满了</li><li>内存不够用，要从 LRU 链表中淘汰</li><li>MySQL 认为系统空闲的时候</li><li>MySQL 关闭时</li></ul></li><li>一直慢的原因：索引没有设计好、SQL 语句没写好、MySQL 选错了索引</li></ul><p>通过以下两种方式定位执行效率较低的 SQL 语句</p><ul><li><p>慢日志查询： 慢查询日志在查询结束以后才记录，执行效率出现问题时查询日志并不能定位问题</p><p>配置文件修改：修改 .cnf 文件 <code>vim /etc/mysql/my.cnf</code>，重启 MySQL 服务器</p><div style="max-height:300px" class="language-sh vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code v-pre><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">slow_query_log</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">ON</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">slow_query_log_file</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">/usr/local/mysql/var/localhost-slow.log</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">long_query_time</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">1</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">	#记录超过long_query_time秒的SQL语句的日志</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">log-queries-not-using-indexes</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> 1</span></span></code></pre><button class="collapse"></button></div><p>使用命令配置：</p><div style="max-height:300px" class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code v-pre><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">mysql</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">&gt;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> SET</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> slow_query_log</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=ON</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">mysql</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">&gt;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> SET</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> GLOBAL</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> slow_query_log</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=ON</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">;</span></span></code></pre><button class="collapse"></button></div><p>查看是否配置成功：</p><div style="max-height:300px" class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code v-pre><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">SHOW VARIABLES </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">LIKE</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF"> '%query%'</span></span></code></pre><button class="collapse"></button></div></li><li><p>SHOW PROCESSLIST：<strong>实时查看</strong>当前 MySQL 在进行的连接线程，包括线程的状态、是否锁表、SQL 的执行情况，同时对一些锁表操作进行优化</p><figure><img src="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20250320004906769.png" alt="image-20250320004906769" loading="lazy" decoding="async" class="lazy"></figure></li></ul><hr><h3 id="explain" tabindex="-1">EXPLAIN <a class="header-anchor" href="#explain" aria-label="Permalink to &quot;EXPLAIN&quot;">​</a></h3><h4 id="执行计划" tabindex="-1">执行计划 <a class="header-anchor" href="#执行计划" aria-label="Permalink to &quot;执行计划&quot;">​</a></h4><p>通过 EXPLAIN 命令获取执行 SQL 语句的信息，包括在 SELECT 语句执行过程中如何连接和连接的顺序，执行计划在优化器优化完成后、执行器之前生成，然后执行器会调用存储引擎检索数据</p><p>查询 SQL 语句的执行计划：</p><div style="max-height:300px" class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code v-pre><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">EXPLAIN </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">SELECT</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> *</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> FROM</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> table_1 </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">WHERE</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> id </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> 1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">;</span></span></code></pre><button class="collapse"></button></div><figure><img src="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20250320004929861.png" alt="image-20250320004929861" loading="lazy" decoding="async" class="lazy"></figure><table><thead><tr><th>字段</th><th>含义</th></tr></thead><tbody><tr><td>id</td><td>SELECT 的序列号</td></tr><tr><td>select_type</td><td>表示 SELECT 的类型</td></tr><tr><td>table</td><td>访问数据库中表名称，有时可能是简称或者临时表名称（&lt;table_name&gt;）</td></tr><tr><td>type</td><td>表示表的连接类型</td></tr><tr><td>possible_keys</td><td>表示查询时，可能使用的索引</td></tr><tr><td>key</td><td>表示实际使用的索引</td></tr><tr><td>key_len</td><td>索引字段的长度</td></tr><tr><td>ref</td><td>表示与索引列进行等值匹配的对象，常数、某个列、函数等，type 必须在（range, const] 之间，左闭右开</td></tr><tr><td>rows</td><td>扫描出的行数，表示 MySQL 根据表统计信息及索引选用情况，<strong>估算</strong>的找到所需的记录扫描的行数</td></tr><tr><td>filtered</td><td>条件过滤的行百分比，单表查询没意义，用于连接查询中对驱动表的扇出进行过滤，查询优化器预测所有扇出值满足剩余查询条件的百分比，相乘以后表示多表查询中还要对被驱动执行查询的次数</td></tr><tr><td>extra</td><td>执行情况的说明和描述</td></tr></tbody></table><p>MySQL <strong>执行计划的局限</strong>：</p><ul><li>只是计划，不是执行 SQL 语句，可以随着底层优化器输入的更改而更改</li><li>EXPLAIN 不会告诉显示关于触发器、存储过程的信息对查询的影响情况， 不考虑各种 Cache</li><li>EXPLAIN 不能显示 MySQL 在执行查询时的动态，因为执行计划在执行<strong>查询之前生成</strong></li><li>EXPALIN 只能解释 SELECT 操作，其他操作要重写为 SELECT 后查看执行计划</li><li>EXPLAIN PLAN 显示的是在解释语句时数据库将如何运行 SQL 语句，由于执行环境和 EXPLAIN PLAN 环境的不同，此计划可能与 SQL 语句<strong>实际的执行计划不同</strong>，部分统计信息是估算的，并非精确值</li></ul><p>SHOW WARINGS：在使用 EXPALIN 命令后执行该语句，可以查询与执行计划相关的拓展信息，展示出 Level、Code、Message 三个字段，当 Code 为 1003 时，Message 字段展示的信息类似于将查询语句重写后的信息，但是不是等价，不能执行复制过来运行</p><p>环境准备：</p><figure><img src="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20250320004958531.png" alt="image-20250320004958531" loading="lazy" decoding="async" class="lazy"></figure><hr><h4 id="id" tabindex="-1">id <a class="header-anchor" href="#id" aria-label="Permalink to &quot;id&quot;">​</a></h4><p>id 代表 SQL 执行的顺序的标识，每个 SELECT 关键字对应一个唯一 id，所以在同一个 SELECT 关键字中的表的 id 都是相同的。SELECT 后的 FROM 可以跟随多个表，每个表都会对应一条记录，这些记录的 id 都是相同的，</p><ul><li><p>id 相同时，执行顺序由上至下。连接查询的执行计划，记录的 id 值都是相同的，出现在前面的表为驱动表，后面为被驱动表</p><div style="max-height:300px" class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code v-pre><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">EXPLAIN </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">SELECT</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> *</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> FROM</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> t_role r, t_user u, user_role ur </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">WHERE</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> r</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">id</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> ur</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">role_id</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> AND</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> u</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">id</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> ur</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">user_id</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> ;</span></span></code></pre><button class="collapse"></button></div><figure><img src="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20250320005020698.png" alt="image-20250320005020698" loading="lazy" decoding="async" class="lazy"></figure></li><li><p>id 不同时，id 值越大优先级越高，越先被执行</p><div style="max-height:300px" class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code v-pre><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">EXPLAIN </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">SELECT</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> *</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> FROM</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> t_role </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">WHERE</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> id </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">SELECT</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> role_id </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">FROM</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> user_role </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">WHERE</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> user_id </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">SELECT</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> id </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">FROM</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> t_user </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">WHERE</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> username </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF"> 'stu1'</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">))</span></span></code></pre><button class="collapse"></button></div><figure><img src="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20250320005039682.png" alt="image-20250320005039682" loading="lazy" decoding="async" class="lazy"></figure></li><li><p>id 有相同也有不同时，id 相同的可以认为是一组，从上往下顺序执行；在所有的组中，id 的值越大的组，优先级越高，越先执行</p><div style="max-height:300px" class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code v-pre><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">EXPLAIN </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">SELECT</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> *</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> FROM</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> t_role r , (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">SELECT</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> *</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> FROM</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> user_role ur </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">WHERE</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> ur.</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">`user_id`</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> =</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF"> '2'</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">) a </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">WHERE</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> r</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">id</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> a</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">role_id</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> ;</span></span></code></pre><button class="collapse"></button></div><figure><img src="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20250320005057427.png" alt="image-20250320005057427" loading="lazy" decoding="async" class="lazy"></figure></li><li><p>id 为 NULL 时代表的是临时表</p></li></ul><hr><h4 id="select" tabindex="-1">select <a class="header-anchor" href="#select" aria-label="Permalink to &quot;select&quot;">​</a></h4><p>表示查询中每个 select 子句的类型（简单 OR 复杂）</p><table><thead><tr><th>select_type</th><th>含义</th></tr></thead><tbody><tr><td>SIMPLE</td><td>简单的 SELECT 查询，查询中不包含子查询或者 UNION</td></tr><tr><td>PRIMARY</td><td>查询中若包含任何复杂的子查询，最外层（也就是最左侧）查询标记为该标识</td></tr><tr><td>UNION</td><td>对于 UNION 或者 UNION ALL 的复杂查询，除了最左侧的查询，其余的小查询都是 UNION</td></tr><tr><td>UNION RESULT</td><td>UNION 需要使用临时表进行去重，临时表的是 UNION RESULT</td></tr><tr><td>DEPENDENT UNION</td><td>对于 UNION 或者 UNION ALL 的复杂查询，如果各个小查询都依赖外层查询，是相关子查询，除了最左侧的小查询为 DEPENDENT SUBQUERY，其余都是 DEPENDENT UNION</td></tr><tr><td>SUBQUERY</td><td>子查询不是相关子查询，该子查询第一个 SELECT 代表的查询就是这种类型，会进行物化（该子查询只需要执行一次）</td></tr><tr><td>DEPENDENT SUBQUERY</td><td>子查询是相关子查询，该子查询第一个 SELECT 代表的查询就是这种类型，不会物化（该子查询需要执行多次）</td></tr><tr><td>DERIVED</td><td>在 FROM 列表中包含的子查询，被标记为 DERIVED（衍生），也就是生成物化派生表的这个子查询</td></tr><tr><td>MATERIALIZED</td><td>将子查询物化后与与外层进行连接查询，生成物化表的子查询</td></tr></tbody></table><p>子查询为 DERIVED：<code>SELECT * FROM (SELECT key1 FROM t1) AS derived_1 WHERE key1 &gt; 10</code></p><p>子查询为 MATERIALIZED：<code>SELECT * FROM t1 WHERE key1 IN (SELECT key1 FROM t2)</code></p><hr><h4 id="type" tabindex="-1">type <a class="header-anchor" href="#type" aria-label="Permalink to &quot;type&quot;">​</a></h4><p>对表的访问方式，表示 MySQL 在表中找到所需行的方式，又称访问类型</p><table><thead><tr><th>type</th><th>含义</th></tr></thead><tbody><tr><td>ALL</td><td>全表扫描，如果是 InnoDB 引擎是扫描聚簇索引</td></tr><tr><td>index</td><td>可以使用覆盖索引，但需要扫描全部索引</td></tr><tr><td>range</td><td>索引范围扫描，常见于 between、&lt;、&gt; 等的查询</td></tr><tr><td>index_subquery</td><td>子查询可以普通索引，则子查询的 type 为 index_subquery</td></tr><tr><td>unique_subquery</td><td>子查询可以使用主键或唯一二级索引，则子查询的 type 为 index_subquery</td></tr><tr><td>index_merge</td><td>索引合并</td></tr><tr><td>ref_or_null</td><td>非唯一性索引（普通二级索引）并且可以存储 NULL，进行等值匹配</td></tr><tr><td>ref</td><td>非唯一性索引与常量等值匹配</td></tr><tr><td>eq_ref</td><td>唯一性索引（主键或不存储 NULL 的唯一二级索引）进行等值匹配，如果二级索引是联合索引，那么所有联合的列都要进行等值匹配</td></tr><tr><td>const</td><td>通过主键或者唯一二级索引与常量进行等值匹配</td></tr><tr><td>system</td><td>system 是 const 类型的特例，当查询的表只有一条记录的情况下，使用 system</td></tr><tr><td>NULL</td><td>MySQL 在优化过程中分解语句，执行时甚至不用访问表或索引</td></tr></tbody></table><p>从上到下，性能从差到好，一般来说需要保证查询至少达到 range 级别， 最好达到 ref</p><hr><h4 id="key" tabindex="-1">key <a class="header-anchor" href="#key" aria-label="Permalink to &quot;key&quot;">​</a></h4><p>possible_keys：</p><ul><li>指出 MySQL 能使用哪个索引在表中找到记录，查询涉及到的字段上若存在索引，则该索引将被列出，但不一定被查询使用</li><li>如果该列是 NULL，则没有相关的索引</li></ul><p>key：</p><ul><li>显示 MySQL 在查询中实际使用的索引，若没有使用索引，显示为 NULL</li><li>查询中若使用了<strong>覆盖索引</strong>，则该索引可能出现在 key 列表，不出现在 possible_keys</li></ul><p>key_len：</p><ul><li>表示索引中使用的字节数，可通过该列计算查询中使用的索引的长度</li><li>key_len 显示的值为索引字段的最大可能长度，并非实际使用长度，即 key_len 是根据表定义计算而得，不是通过表内检索出的</li><li>在不损失精确性的前提下，长度越短越好</li></ul><hr><h4 id="extra" tabindex="-1">Extra <a class="header-anchor" href="#extra" aria-label="Permalink to &quot;Extra&quot;">​</a></h4><p>其他的额外的执行计划信息，在该列展示：</p><ul><li>No tables used：查询语句中使用 FROM dual 或者没有 FROM 语句</li><li>Impossible WHERE：查询语句中的 WHERE 子句条件永远为 FALSE，会导致没有符合条件的行</li><li>Using index：该值表示相应的 SELECT 操作中使用了<strong>覆盖索引</strong>（Covering Index）</li><li>Using index condition：第一种情况是搜索条件中虽然出现了索引列，但是部分条件无法形成扫描区间（<strong>索引失效</strong>），会根据可用索引的条件先搜索一遍再匹配无法使用索引的条件，回表查询数据；第二种是使用了<strong>索引条件下推</strong>优化</li><li>Using where：搜索的数据需要在 Server 层判断，无法使用索引下推</li><li>Using join buffer：连接查询被驱动表无法利用索引，需要连接缓冲区来存储中间结果</li><li>Using filesort：无法利用索引完成排序（优化方向），需要对数据使用外部排序算法，将取得的数据在内存或磁盘中进行排序</li><li>Using temporary：表示 MySQL 需要使用临时表来存储结果集，常见于<strong>排序、去重（UNION）、分组</strong>等场景</li><li>Select tables optimized away：说明仅通过使用索引，优化器可能仅从聚合函数结果中返回一行</li><li>No tables used：Query 语句中使用 from dual 或不含任何 from 子句</li></ul><p>参考文章：<a href="https://www.cnblogs.com/ggjucheng/archive/2012/11/11/2765237.html" target="_blank" rel="noreferrer">https://www.cnblogs.com/ggjucheng/archive/2012/11/11/2765237.html</a></p><hr><h3 id="profiles" tabindex="-1">PROFILES <a class="header-anchor" href="#profiles" aria-label="Permalink to &quot;PROFILES&quot;">​</a></h3><p>SHOW PROFILES 能够在做 SQL 优化时分析当前会话中语句执行的<strong>资源消耗</strong>情况</p><ul><li><p>通过 have_profiling 参数，能够看到当前 MySQL 是否支持 profile： <img src="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20250320005117798.png" alt="image-20250320005117798"></p></li><li><p>默认 profiling 是关闭的，可以通过 set 语句在 Session 级别开启 profiling：</p><figure><img src="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20250320005143789.png" alt="image-20250320005143789" loading="lazy" decoding="async" class="lazy"></figure><div style="max-height:300px" class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code v-pre><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">SET</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> profiling</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">; #开启profiling 开关；</span></span></code></pre><button class="collapse"></button></div></li><li><p>执行 SHOW PROFILES 指令， 来查看 SQL 语句执行的耗时:</p><div style="max-height:300px" class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code v-pre><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">SHOW PROFILES;</span></span></code></pre><button class="collapse"></button></div><figure><img src="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20250320005201687.png" alt="image-20250320005201687" loading="lazy" decoding="async" class="lazy"></figure></li><li><p>查看到该 SQL 执行过程中每个线程的状态和消耗的时间：</p><div style="max-height:300px" class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code v-pre><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">SHOW </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">PROFILE</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> FOR</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> QUERY query_id;</span></span></code></pre><button class="collapse"></button></div><figure><img src="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20250320005215913.png" alt="image-20250320005215913" loading="lazy" decoding="async" class="lazy"></figure></li><li><p>在获取到最消耗时间的线程状态后，MySQL 支持选择 all、cpu、block io 、context switch、page faults 等类型查看 MySQL 在使用什么资源上耗费了过高的时间。例如，选择查看 CPU 的耗费时间：</p><figure><img src="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20250320005233044.png" alt="image-20250320005233044" loading="lazy" decoding="async" class="lazy"></figure><ul><li>Status：SQL 语句执行的状态</li><li>Durationsql：执行过程中每一个步骤的耗时</li><li>CPU_user：当前用户占有的 CPU</li><li>CPU_system：系统占有的 CPU</li></ul></li></ul><hr><h3 id="trace" tabindex="-1">TRACE <a class="header-anchor" href="#trace" aria-label="Permalink to &quot;TRACE&quot;">​</a></h3><p>MySQL 提供了对 SQL 的跟踪， 通过 trace 文件可以查看优化器<strong>生成执行计划的过程</strong></p><ul><li><p>打开 trace 功能，设置格式为 JSON，并设置 trace 的最大使用内存，避免解析过程中因默认内存过小而不能够完整展示</p><div style="max-height:300px" class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code v-pre><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">SET</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> optimizer_trace</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">"enabled=on"</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">,end_markers_in_json</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=ON</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">;	</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">-- 会话内有效</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">SET</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> optimizer_trace_max_mem_size</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">1000000</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">;</span></span></code></pre><button class="collapse"></button></div></li><li><p>执行 SQL 语句：</p><div style="max-height:300px" class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code v-pre><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">SELECT</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> *</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> FROM</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> tb_item </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">WHERE</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> id </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">&lt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> 4</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">;</span></span></code></pre><button class="collapse"></button></div></li><li><p>检查 information_schema.optimizer_trace：</p><div style="max-height:300px" class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code v-pre><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">SELECT</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> *</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> FROM</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> information_schema</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">optimizer_trace</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> \G; </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">-- \G代表竖列展示</span></span></code></pre><button class="collapse"></button></div><p>执行信息主要有三个阶段：prepare 阶段、optimize 阶段（成本分析）、execute 阶段（执行）</p></li></ul><hr><h2 id="索引优化" tabindex="-1">索引优化 <a class="header-anchor" href="#索引优化" aria-label="Permalink to &quot;索引优化&quot;">​</a></h2><h3 id="创建索引" tabindex="-1">创建索引 <a class="header-anchor" href="#创建索引" aria-label="Permalink to &quot;创建索引&quot;">​</a></h3><p>索引是数据库优化最重要的手段之一，通过索引通常可以帮助用户解决大多数的 MySQL 的性能优化问题</p><div style="max-height:300px" class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code v-pre><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">CREATE</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> TABLE</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> `</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">tb_seller</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">` (</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">	`sellerid`</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> varchar</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> (</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">100</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">),</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">	`name`</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> varchar</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> (</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">100</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">),</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">	`nickname`</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> varchar</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> (</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">50</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">),</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">	`password`</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> varchar</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> (</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">60</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">),</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">	`status`</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> varchar</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> (</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">),</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">	`address`</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> varchar</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> (</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">100</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">),</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">	`createtime`</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> datetime</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">,</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">    PRIMARY KEY</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">`sellerid`</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">)ENGINE</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">INNODB </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">DEFAULT</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> CHARSET</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">utf8mb4;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">INSERT INTO</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF"> `tb_seller`</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> (</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">`sellerid`</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">`name`</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">`nickname`</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">`password`</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">`status`</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">`address`</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">`createtime`</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">values</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">'xiaomi'</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">,</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">'小米科技'</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">,</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">'小米官方旗舰店'</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">,</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">'e10adc3949ba59abbe56e057f20f883e'</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">,</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">'1'</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">,</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">'西安市'</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">,</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">'2088-01-01 12:00:00'</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">CREATE</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> INDEX</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> idx_seller_name_sta_addr</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> ON</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> tb_seller(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">status</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">address</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">); # 联合索引</span></span></code></pre><button class="collapse"></button></div><figure><img src="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20250320005254944.png" alt="image-20250320005254944" loading="lazy" decoding="async" class="lazy"></figure><hr><h3 id="避免失效" tabindex="-1">避免失效 <a class="header-anchor" href="#避免失效" aria-label="Permalink to &quot;避免失效&quot;">​</a></h3><h4 id="语句错误" tabindex="-1">语句错误 <a class="header-anchor" href="#语句错误" aria-label="Permalink to &quot;语句错误&quot;">​</a></h4><ul><li><p>全值匹配：对索引中所有列都指定具体值，这种情况索引生效，执行效率高</p><div style="max-height:300px" class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code v-pre><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">EXPLAIN </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">SELECT</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> *</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> FROM</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> tb_seller </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">WHERE</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> name=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">'小米科技'</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> AND</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> status=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">'1'</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> AND</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> address=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">'西安市'</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">;</span></span></code></pre><button class="collapse"></button></div><figure><img src="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20250320005322275.png" alt="image-20250320005322275" loading="lazy" decoding="async" class="lazy"></figure></li><li><p><strong>最左前缀法则</strong>：联合索引遵守最左前缀法则</p><p>匹配最左前缀法则，走索引：</p><div style="max-height:300px" class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code v-pre><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">EXPLAIN </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">SELECT</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> *</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> FROM</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> tb_seller </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">WHERE</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> name=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">'小米科技'</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">EXPLAIN </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">SELECT</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> *</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> FROM</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> tb_seller </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">WHERE</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> name=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">'小米科技'</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> AND</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> status=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">'1'</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">;</span></span></code></pre><button class="collapse"></button></div><figure><img src="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20250320005339410.png" alt="image-20250320005339410" loading="lazy" decoding="async" class="lazy"></figure><p>违法最左前缀法则 ， 索引失效：</p><div style="max-height:300px" class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code v-pre><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">EXPLAIN </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">SELECT</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> *</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> FROM</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> tb_seller </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">WHERE</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> status=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">'1'</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">EXPLAIN </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">SELECT</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> *</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> FROM</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> tb_seller </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">WHERE</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> status=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">'1'</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> AND</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> address=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">'西安市'</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">;</span></span></code></pre><button class="collapse"></button></div><figure><img src="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20250320005359201.png" alt="image-20250320005359201" loading="lazy" decoding="async" class="lazy"></figure><p>如果符合最左法则，但是出现跳跃某一列，只有最左列索引生效：</p><div style="max-height:300px" class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code v-pre><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">EXPLAIN </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">SELECT</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> *</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> FROM</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> tb_seller </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">WHERE</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> name=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">'小米科技'</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> AND</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> address=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">'西安市'</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">;</span></span></code></pre><button class="collapse"></button></div><figure><img src="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20250320005413395.png" alt="image-20250320005413395" loading="lazy" decoding="async" class="lazy"></figure><p>虽然索引列失效，但是系统会<strong>使用了索引下推进行了优化</strong></p></li><li><p><strong>范围查询</strong>右边的列，不能使用索引：</p><div style="max-height:300px" class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code v-pre><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">EXPLAIN </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">SELECT</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> *</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> FROM</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> tb_seller </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">WHERE</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> name=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">'小米科技'</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> AND</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> status&gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">'1'</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> AND</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> address=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">'西安市'</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">;</span></span></code></pre><button class="collapse"></button></div><p>根据前面的两个字段 name ， status 查询是走索引的， 但是最后一个条件 address 没有用到索引，使用了索引下推</p><figure><img src="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20250320005428460.png" alt="image-20250320005428460" loading="lazy" decoding="async" class="lazy"></figure></li><li><p>在索引列上<strong>函数或者运算（+ - 数值）操作</strong>， 索引将失效：会破坏索引值的有序性</p><div style="max-height:300px" class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code v-pre><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">EXPLAIN </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">SELECT</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> *</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> FROM</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> tb_seller </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">WHERE</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> SUBSTRING</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">,</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">3</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">,</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF"> '科技'</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">;</span></span></code></pre><button class="collapse"></button></div><figure><img src="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20250320005505822.png" alt="image-20250320005505822" loading="lazy" decoding="async" class="lazy"></figure></li><li><p><strong>字符串不加单引号</strong>，造成索引失效：隐式类型转换，当字符串和数字比较时会<strong>把字符串转化为数字</strong></p><p>没有对字符串加单引号，查询优化器会调用 CAST 函数将 status 转换为 int 进行比较，造成索引失效</p><div style="max-height:300px" class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code v-pre><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">EXPLAIN </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">SELECT</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> *</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> FROM</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> tb_seller </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">WHERE</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> name=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">'小米科技'</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> AND</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> status</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> 1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">;</span></span></code></pre><button class="collapse"></button></div><figure><img src="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20250320005522191.png" alt="image-20250320005522191" loading="lazy" decoding="async" class="lazy"></figure><p>如果 status 是 int 类型，SQL 为 <code>SELECT * FROM tb_seller WHERE status = '1'</code> 并不会造成索引失效，因为会将 <code>'1'</code> 转换为 <code>1</code>，并<strong>不会对索引列产生操作</strong></p></li><li><p>多表连接查询时，如果两张表的<strong>字符集不同</strong>，会造成索引失效，因为会进行类型转换</p><p>解决方法：CONVERT 函数是加在输入参数上、修改表的字符集</p></li><li><p><strong>用 OR 分割条件，索引失效</strong>，导致全表查询：</p><p>OR 前的条件中的列有索引而后面的列中没有索引或 OR 前后两个列是同一个复合索引，都造成索引失效</p><div style="max-height:300px" class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code v-pre><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">EXPLAIN </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">SELECT</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> *</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> FROM</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> tb_seller </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">WHERE</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> name=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">'阿里巴巴'</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> OR</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> createtime </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF"> '2088-01-01 12:00:00'</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">EXPLAIN </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">SELECT</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> *</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> FROM</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> tb_seller </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">WHERE</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> name=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">'小米科技'</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> OR</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> status=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">'1'</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">;</span></span></code></pre><button class="collapse"></button></div><figure><img src="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20250320005541388.png" alt="image-20250320005541388" loading="lazy" decoding="async" class="lazy"></figure><p><strong>AND 分割的条件不影响</strong>：</p><div style="max-height:300px" class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code v-pre><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">EXPLAIN </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">SELECT</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> *</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> FROM</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> tb_seller </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">WHERE</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> name=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">'阿里巴巴'</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> AND</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> createtime </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF"> '2088-01-01 12:00:00'</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">;</span></span></code></pre><button class="collapse"></button></div><figure><img src="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20250320005600331.png" alt="image-20250320005600331" loading="lazy" decoding="async" class="lazy"></figure></li><li><p><strong>以 % 开头的 LIKE 模糊查询</strong>，索引失效：</p><p>如果是尾部模糊匹配，索引不会失效；如果是头部模糊匹配，索引失效</p><div style="max-height:300px" class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code v-pre><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">EXPLAIN </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">SELECT</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> *</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> FROM</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> tb_seller </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">WHERE</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> name</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> like</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF"> '%科技%'</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">;</span></span></code></pre><button class="collapse"></button></div><figure><img src="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20250320005627032.png" alt="image-20250320005627032" loading="lazy" decoding="async" class="lazy"></figure><p>解决方案：通过覆盖索引来解决</p><div style="max-height:300px" class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code v-pre><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">EXPLAIN </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">SELECT</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> sellerid,</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">,</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">status</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> FROM</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> tb_seller </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">WHERE</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> name</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> like</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF"> '%科技%'</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">;</span></span></code></pre><button class="collapse"></button></div><figure><img src="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20250320005641628.png" alt="image-20250320005641628" loading="lazy" decoding="async" class="lazy"></figure><p>原因：在覆盖索引的这棵 B+ 数上只需要进行 like 的匹配，或者是基于覆盖索引查询再进行 WHERE 的判断就可以获得结果</p></li></ul><hr><h4 id="系统优化" tabindex="-1">系统优化 <a class="header-anchor" href="#系统优化" aria-label="Permalink to &quot;系统优化&quot;">​</a></h4><p>系统优化为全表扫描：</p><ul><li><p>如果 MySQL 评估使用索引比全表更慢，则不使用索引，索引失效：</p><div style="max-height:300px" class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code v-pre><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">CREATE</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> INDEX</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> idx_address</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> ON</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> tb_seller(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">address</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">EXPLAIN </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">SELECT</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> *</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> FROM</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> tb_seller </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">WHERE</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> address=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">'西安市'</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">EXPLAIN </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">SELECT</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> *</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> FROM</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> tb_seller </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">WHERE</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> address=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">'北京市'</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">;</span></span></code></pre><button class="collapse"></button></div><p>北京市的键值占 9/10（区分度低），所以优化为全表扫描，type = ALL</p><figure><img src="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20250320005656396.png" alt="image-20250320005656396" loading="lazy" decoding="async" class="lazy"></figure></li><li><p>IS NULL、IS NOT NULL <strong>有时</strong>索引失效：</p><div style="max-height:300px" class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code v-pre><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">EXPLAIN </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">SELECT</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> *</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> FROM</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> tb_seller </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">WHERE</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> name</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> IS</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> NULL</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">EXPLAIN </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">SELECT</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> *</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> FROM</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> tb_seller </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">WHERE</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> name</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> IS NOT NULL</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">;</span></span></code></pre><button class="collapse"></button></div><p>NOT NULL 失效的原因是 name 列全部不是 null，优化为全表扫描，当 NULL 过多时，IS NULL 失效</p><figure><img src="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20250320005712759.png" alt="image-20250320005712759" loading="lazy" decoding="async" class="lazy"></figure></li><li><p>IN 肯定会走索引，但是当 IN 的取值范围较大时会导致索引失效，走全表扫描：</p><div style="max-height:300px" class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code v-pre><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">EXPLAIN </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">SELECT</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> *</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> FROM</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> tb_seller </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">WHERE</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> sellerId </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">IN</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> (</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">'alibaba'</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">,</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">'huawei'</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">);</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">-- 都走索引</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">EXPLAIN </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">SELECT</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> *</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> FROM</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> tb_seller </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">WHERE</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> sellerId </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">NOT</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> IN</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> (</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">'alibaba'</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">,</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">'huawei'</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">);</span></span></code></pre><button class="collapse"></button></div></li><li><p><a href="https://time.geekbang.org/column/article/74687" target="_blank" rel="noreferrer">MySQL 实战 45 讲</a>该章节最后提出了一种慢查询场景，获取到数据以后 Server 层还会做判断</p></li></ul><hr><h3 id="底层原理" tabindex="-1">底层原理 <a class="header-anchor" href="#底层原理" aria-label="Permalink to &quot;底层原理&quot;">​</a></h3><p>索引失效一般是针对联合索引，联合索引一般由几个字段组成，排序方式是先按照第一个字段进行排序，然后排序第二个，依此类推，图示（a, b）索引，<strong>a 相等的情况下 b 是有序的</strong></p><figure><img src="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20250320005742061.png" alt="image-20250320005742061" loading="lazy" decoding="async" class="lazy"></figure><ul><li><p>最左前缀法则：当不匹配前面的字段的时候，后面的字段都是无序的。这种无序不仅体现在叶子节点，也会<strong>导致查询时扫描的非叶子节点也是无序的</strong>，因为索引树相当于忽略的第一个字段，就无法使用二分查找</p></li><li><p>范围查询右边的列，不能使用索引，比如语句： <code>WHERE a &gt; 1 AND b = 1</code>，在 a 大于 1 的时候，b 是无序的，a &gt; 1 是扫描时有序的，但是找到以后进行寻找 b 时，索引树就不是有序的了</p><figure><img src="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20250320005804788.png" alt="image-20250320005804788" loading="lazy" decoding="async" class="lazy"></figure></li><li><p>以 % 开头的 LIKE 模糊查询，索引失效，比如语句：<code>WHERE a LIKE '%d'</code>，前面的不确定，导致不符合最左匹配，直接去索引中搜索以 d 结尾的节点，所以没有顺序 <img src="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20250320005815689.png" alt="image-20250320005815689"></p></li></ul><p>参考文章：<a href="https://mp.weixin.qq.com/s/B_M09dzLe9w7cT46rdGIeQ" target="_blank" rel="noreferrer">https://mp.weixin.qq.com/s/B_M09dzLe9w7cT46rdGIeQ</a></p><hr><h3 id="查看索引" tabindex="-1">查看索引 <a class="header-anchor" href="#查看索引" aria-label="Permalink to &quot;查看索引&quot;">​</a></h3><div style="max-height:300px" class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code v-pre><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">SHOW </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">STATUS</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> LIKE</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF"> 'Handler_read%'</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">;	</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">SHOW </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">GLOBAL</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> STATUS</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> LIKE</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF"> 'Handler_read%'</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">;</span></span></code></pre><button class="collapse"></button></div><figure><img src="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20250320005841861.png" alt="image-20250320005841861" loading="lazy" decoding="async" class="lazy"></figure><ul><li><p>Handler_read_first：索引中第一条被读的次数，如果较高，表示服务器正执行大量全索引扫描（这个值越低越好）</p></li><li><p>Handler_read_key：如果索引正在工作，这个值代表一个行被索引值读的次数，值越低表示索引不经常使用（这个值越高越好）</p></li><li><p>Handler_read_next：按照键顺序读下一行的请求数，如果范围约束或执行索引扫描来查询索引列，值增加</p></li><li><p>Handler_read_prev：按照键顺序读前一行的请求数，该读方法主要用于优化 ORDER BY … DESC</p></li><li><p>Handler_read_rnd：根据固定位置读一行的请求数，如果执行大量查询并对结果进行排序则该值较高，可能是使用了大量需要 MySQL 扫描整个表的查询或连接，这个值较高意味着运行效率低，应该建立索引来解决</p></li><li><p>Handler_read_rnd_next：在数据文件中读下一行的请求数，如果正进行大量的表扫描，该值较高，说明表索引不正确或写入的查询没有利用索引</p></li></ul><hr><h2 id="sql-优化" tabindex="-1">SQL 优化 <a class="header-anchor" href="#sql-优化" aria-label="Permalink to &quot;SQL 优化&quot;">​</a></h2><h3 id="自增主键" tabindex="-1">自增主键 <a class="header-anchor" href="#自增主键" aria-label="Permalink to &quot;自增主键&quot;">​</a></h3><h4 id="自增机制" tabindex="-1">自增机制 <a class="header-anchor" href="#自增机制" aria-label="Permalink to &quot;自增机制&quot;">​</a></h4><p>自增主键可以让主键索引尽量地保持在数据页中递增顺序插入，不自增需要寻找其他页插入，导致随机 IO 和页分裂的情况</p><p>表的结构定义存放在后缀名为.frm 的文件中，但是并不会保存自增值，不同的引擎对于自增值的保存策略不同：</p><ul><li>MyISAM 引擎的自增值保存在数据文件中</li><li>InnoDB 引擎的自增值保存在了内存里，每次打开表都会去找自增值的最大值 max(id)，然后将 max(id)+1 作为当前的自增值；8.0 版本后，才有了自增值持久化的能力，将自增值的变更记录在了 redo log 中，重启的时候依靠 redo log 恢复重启之前的值</li></ul><p>在插入一行数据的时候，自增值的行为如下：</p><ul><li>如果插入数据时 id 字段指定为 0、null 或未指定值，那么就把这个表当前的 AUTO_INCREMENT 值填到自增字段</li><li>如果插入数据时 id 字段指定了具体的值，比如某次要插入的值是 X，当前的自增值是 Y<ul><li>如果 X&lt;Y，那么这个表的自增值不变</li><li>如果 X≥Y，就需要把当前自增值修改为新的自增值</li></ul></li></ul><p>参数说明：auto_increment_offset 和 auto_increment_increment 分别表示自增的初始值和步长，默认值都是 1</p><p>语句执行失败也不回退自增 id，所以保证了自增 id 是递增的，但不保证是连续的（不能回退，所以有些回滚事务的自增 id 就不会重新使用，导致出现不连续）</p><hr><h4 id="自增-id" tabindex="-1">自增 ID <a class="header-anchor" href="#自增-id" aria-label="Permalink to &quot;自增 ID&quot;">​</a></h4><p>MySQL 不同的自增 id 在达到上限后的表现不同：</p><ul><li><p>表的自增 id 如果是 int 类型，达到上限 2^32-1 后，再申请时值就不会改变，进而导致继续插入数据时报主键冲突的错误</p></li><li><p>row_id 长度为 6 个字节，达到上限后则会归 0 再重新递增，如果出现相同的 row_id，后写的数据会覆盖之前的数据，造成旧数据丢失，影响的是数据可靠性，所以应该在 InnoDB 表中主动创建自增主键报主键冲突，插入失败影响的是可用性，而一般情况下，<strong>可靠性优先于可用性</strong></p></li><li><p>Xid 长度 8 字节，由 Server 层维护，只需要不在同一个 binlog 文件中出现重复值即可，虽然理论上会出现重复值，但是概率极小</p></li><li><p>InnoDB 的 max_trx_id 递增值每次 MySQL 重启都会被保存起来，重启也不会重置为 0，所以会导致一直增加到达上限，然后从 0 开始，这时原事务 0 修改的数据对当前事务就是可见的，产生脏读的现象</p><p>只读事务不分配 trx_id，所以 trx_id 的增加速度变慢了</p></li><li><p>thread_id 长度 4 个字节，到达上限后就会重置为 0，MySQL 设计了一个唯一数组的逻辑，给新线程分配 thread_id 时做判断，保证不会出现两个相同的 thread_id：</p><div style="max-height:300px" class="language-c++ vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c++</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code v-pre><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">do</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">	new_id </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> thread_id_counter</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">++</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">} </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">while</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">!</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">thread_ids.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">insert_unique</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(new_id).second);</span></span></code></pre><button class="collapse"></button></div></li></ul><p>参考文章：<a href="https://time.geekbang.org/column/article/83183" target="_blank" rel="noreferrer">https://time.geekbang.org/column/article/83183</a></p><hr><h3 id="覆盖索引" tabindex="-1">覆盖索引 <a class="header-anchor" href="#覆盖索引" aria-label="Permalink to &quot;覆盖索引&quot;">​</a></h3><p>复合索引叶子节点不仅保存了复合索引的值，还有主键索引，所以使用覆盖索引的时候，加上主键也会用到索引</p><p>尽量使用覆盖索引，避免 SELECT *：</p><div style="max-height:300px" class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code v-pre><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">EXPLAIN </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">SELECT</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">,</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">status</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">,</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">address</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> FROM</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> tb_seller </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">WHERE</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> name=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">'小米科技'</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> AND</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> status=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">'1'</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> AND</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> address=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">'西安市'</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">;</span></span></code></pre><button class="collapse"></button></div><figure><img src="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20250320005911035.png" alt="image-20250320005911035" loading="lazy" decoding="async" class="lazy"></figure><p>如果查询列，超出索引列，也会降低性能：</p><div style="max-height:300px" class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code v-pre><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">EXPLAIN </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">SELECT</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">,</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">status</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">,</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">address</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">,</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">password</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> FROM</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> tb_seller </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">WHERE</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> name=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">'小米科技'</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> AND</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> status=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">'1'</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> AND</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> address=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">'西安市'</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">;</span></span></code></pre><button class="collapse"></button></div><figure><img src="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20250320005923175.png" alt="image-20250320005923175" loading="lazy" decoding="async" class="lazy"></figure><hr><h3 id="减少访问" tabindex="-1">减少访问 <a class="header-anchor" href="#减少访问" aria-label="Permalink to &quot;减少访问&quot;">​</a></h3><p>避免对数据进行重复检索：能够一次连接就获取到结果的，就不用两次连接，这样可以大大减少对数据库无用的重复请求</p><ul><li><p>查询数据：</p><div style="max-height:300px" class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code v-pre><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">SELECT</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> id,</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">name</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> FROM</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> tb_book;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">SELECT</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> id,</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">status</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> FROM</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> tb_book; </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">-- 向数据库提交两次请求，数据库就要做两次查询操作</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">-- &gt; 优化为:</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">SELECT</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> id,</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">,statu </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">FROM</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> tb_book;</span></span></code></pre><button class="collapse"></button></div></li><li><p>插入数据：</p><div style="max-height:300px" class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code v-pre><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">INSERT INTO</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> tb_test </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">VALUES</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">,</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">'Tom'</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">INSERT INTO</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> tb_test </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">VALUES</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">,</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">'Cat'</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">INSERT INTO</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> tb_test </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">VALUES</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">3</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">,</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">'Jerry'</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">);	</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">-- 连接三次数据库</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">-- &gt;优化为</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">INSERT INTO</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> tb_test </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">VALUES</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">,</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">'Tom'</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">),(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">,</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">'Cat'</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">)，(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">3</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">,</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">'Jerry'</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">);	</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">-- 连接一次</span></span></code></pre><button class="collapse"></button></div></li><li><p>在事务中进行数据插入：</p><div style="max-height:300px" class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code v-pre><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">start transaction</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">INSERT INTO</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> tb_test </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">VALUES</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">,</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">'Tom'</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">INSERT INTO</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> tb_test </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">VALUES</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">,</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">'Cat'</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">INSERT INTO</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> tb_test </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">VALUES</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">3</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">,</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">'Jerry'</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">commit</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">;	</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">-- 手动提交，分段提交</span></span></code></pre><button class="collapse"></button></div></li><li><p>数据有序插入：</p><div style="max-height:300px" class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code v-pre><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">INSERT INTO</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> tb_test </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">VALUES</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">,</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">'Tom'</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">INSERT INTO</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> tb_test </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">VALUES</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">,</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">'Cat'</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">INSERT INTO</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> tb_test </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">VALUES</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">3</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">,</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">'Jerry'</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">);</span></span></code></pre><button class="collapse"></button></div></li></ul><p>增加 cache 层：在应用中增加缓存层来达到减轻数据库负担的目的。可以部分数据从数据库中抽取出来放到应用端以文本方式存储，或者使用框架（Mybatis）提供的一级缓存 / 二级缓存，或者使用 Redis 数据库来缓存数据</p><hr><h3 id="数据插入" tabindex="-1">数据插入 <a class="header-anchor" href="#数据插入" aria-label="Permalink to &quot;数据插入&quot;">​</a></h3><p>当使用 load 命令导入数据的时候，适当的设置可以提高导入的效率：</p><figure><img src="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20250320005951328.png" alt="image-20250320005951328" loading="lazy" decoding="async" class="lazy"></figure><div style="max-height:300px" class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code v-pre><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">LOAD</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> DATA</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> LOCAL</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> INFILE </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF"> '/home/klaus/sql1.log'</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> INTO</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> TABLE</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF"> `tb_user_1`</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> FIELD TERMINATED </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">BY</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF"> ','</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> LINES TERMINATED </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">BY</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF"> '\n'</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">; </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">-- 文件格式如上图</span></span></code></pre><button class="collapse"></button></div><p>对于 InnoDB 类型的表，有以下几种方式可以提高导入的效率：</p><ol><li><p><strong>主键顺序插入</strong>：因为 InnoDB 类型的表是按照主键的顺序保存的，所以将导入的数据按照主键的顺序排列，可以有效的提高导入数据的效率，如果 InnoDB 表没有主键，那么系统会自动默认创建一个内部列作为主键</p><p>主键是否连续对性能影响不大，只要是递增的就可以，比如雪花算法产生的 ID 不是连续的，但是是递增的，因为递增可以让主键索引尽量地保持顺序插入，<strong>避免了页分裂</strong>，因此索引更紧凑</p><ul><li>插入 ID 顺序排列数据：</li></ul><figure><img src="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20250320010010521.png" alt="image-20250320010010521" loading="lazy" decoding="async" class="lazy"></figure><ul><li>插入 ID 无序排列数据：</li></ul><figure><img src="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20250320010026345.png" alt="image-20250320010026345" loading="lazy" decoding="async" class="lazy"></figure></li><li><p><strong>关闭唯一性校验</strong>：在导入数据前执行 <code>SET UNIQUE_CHECKS=0</code>，关闭唯一性校验；导入结束后执行 <code>SET UNIQUE_CHECKS=1</code>，恢复唯一性校验，可以提高导入的效率。</p><figure><img src="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20250320010102015.png" alt="image-20250320010102015" loading="lazy" decoding="async" class="lazy"></figure></li><li><p><strong>手动提交事务</strong>：如果应用使用自动提交的方式，建议在导入前执行<code>SET AUTOCOMMIT=0</code>，关闭自动提交；导入结束后再打开自动提交，可以提高导入的效率。</p><p>事务需要控制大小，事务太大可能会影响执行的效率。MySQL 有 innodb_log_buffer_size 配置项，超过这个值的日志会写入磁盘数据，效率会下降，所以在事务大小达到配置项数据级前进行事务提交可以提高效率</p><figure><img src="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20250320010116411.png" alt="image-20250320010116411" loading="lazy" decoding="async" class="lazy"></figure></li></ol><hr><h3 id="分组排序" tabindex="-1">分组排序 <a class="header-anchor" href="#分组排序" aria-label="Permalink to &quot;分组排序&quot;">​</a></h3><h4 id="order" tabindex="-1">ORDER <a class="header-anchor" href="#order" aria-label="Permalink to &quot;ORDER&quot;">​</a></h4><p>数据准备：</p><div style="max-height:300px" class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code v-pre><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">CREATE</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> TABLE</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> `</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">emp</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">` (</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">  `id`</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> INT</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">11</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">NOT NULL</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> AUTO_INCREMENT,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">  `name`</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> VARCHAR</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">100</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">NOT NULL</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">  `age`</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> INT</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">3</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">NOT NULL</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">  `salary`</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> INT</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">11</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">DEFAULT</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> NULL</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">,</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">  PRIMARY KEY</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> (</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">`id`</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">) ENGINE</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">INNODB </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">DEFAULT</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> CHARSET</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">utf8mb4;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">INSERT INTO</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF"> `emp`</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> (</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">`id`</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">`name`</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">`age`</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">`salary`</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">VALUES</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">'1'</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">,</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">'Tom'</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">,</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">'25'</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">,</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">'2300'</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">);</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">-- ...</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">CREATE</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> INDEX</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> idx_emp_age_salary</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> ON</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> emp(age, salary);</span></span></code></pre><button class="collapse"></button></div><ul><li><p>第一种是通过对返回数据进行排序，所有不通过索引直接返回结果的排序都叫 FileSort 排序，会在内存中重新排序</p><div style="max-height:300px" class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code v-pre><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">EXPLAIN </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">SELECT</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> *</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> FROM</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> emp </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">ORDER BY</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> age </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">DESC</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">;	</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">-- 年龄降序</span></span></code></pre><button class="collapse"></button></div><figure><img src="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20250320010133855.png" alt="image-20250320010133855" loading="lazy" decoding="async" class="lazy"></figure></li><li><p>第二种通过有序索引顺序扫描直接返回<strong>有序数据</strong>，这种情况为 Using index，不需要额外排序，操作效率高</p><div style="max-height:300px" class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code v-pre><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">EXPLAIN </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">SELECT</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> id, age, salary </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">FROM</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> emp </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">ORDER BY</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> age </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">DESC</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">;</span></span></code></pre><button class="collapse"></button></div><figure><img src="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20250320010145655.png" alt="image-20250320010145655" loading="lazy" decoding="async" class="lazy"></figure></li><li><p>多字段排序：</p><div style="max-height:300px" class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code v-pre><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">EXPLAIN </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">SELECT</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> id,age,salary </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">FROM</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> emp </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">ORDER BY</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> age </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">DESC</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">, salary </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">DESC</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">EXPLAIN </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">SELECT</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> id,age,salary </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">FROM</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> emp </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">ORDER BY</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> salary </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">DESC</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">, age </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">DESC</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">EXPLAIN </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">SELECT</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> id,age,salary </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">FROM</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> emp </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">ORDER BY</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> age </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">DESC</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">, salary </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">ASC</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">;</span></span></code></pre><button class="collapse"></button></div><figure><img src="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20250320010212699.png" alt="image-20250320010212699" loading="lazy" decoding="async" class="lazy"></figure><p>尽量减少额外的排序，通过索引直接返回有序数据。<strong>需要满足 Order by 使用相同的索引、Order By 的顺序和索引顺序相同、Order by 的字段都是升序或都是降序</strong>，否则需要额外的操作，就会出现 FileSort</p></li><li><p>ORDER BY RAND() 命令用来进行随机排序，会使用了临时内存表，临时内存表排序的时使用 rowid 排序方法</p></li></ul><p>优化方式：创建合适的索引能够减少 Filesort 的出现，但是某些情况下条件限制不能让 Filesort 消失，就要加快 Filesort 的排序操作</p><p>内存临时表，MySQL 有两种 Filesort 排序算法：</p><ul><li><p>rowid 排序：首先根据条件取出排序字段和信息，然后在<strong>排序区 sort buffer（Server 层）<strong>中排序，如果 sort buffer 不够，则在临时表 temporary table 中存储排序结果。完成排序后再根据行指针</strong>回表读取记录</strong>，该操作可能会导致大量随机 I/O 操作</p><p>说明：对于临时内存表，回表过程只是简单地根据数据行的位置，直接访问内存得到数据，不会导致多访问磁盘，优先选择该方式</p></li><li><p>全字段排序：一次性取出满足条件的所有数据，需要回表，然后在排序区 sort buffer 中排序后直接输出结果集。排序时内存开销较大，但是排序效率比两次扫描算法高</p></li></ul><p>具体的选择方式：</p><ul><li><p>MySQL 通过比较系统变量 max_length_for_sort_data 的大小和 Query 语句取出的字段的大小，来判定使用哪种排序算法。如果前者大，则说明 sort buffer 空间足够，使用第二种优化之后的算法，否则使用第一种。</p></li><li><p>可以适当提高 sort_buffer_size 和 max_length_for_sort_data 系统变量，来增大排序区的大小，提高排序的效率</p><div style="max-height:300px" class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code v-pre><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">SET</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> @@max_length_for_sort_data </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> 10000</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">; 		</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">-- 设置全局变量</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">SET</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> max_length_for_sort_data </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> 10240</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">; 			</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">-- 设置会话变量</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">SHOW VARIABLES </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">LIKE</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF"> 'max_length_for_sort_data'</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">;	</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">-- 默认1024</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">SHOW VARIABLES </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">LIKE</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF"> 'sort_buffer_size'</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">;			</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">-- 默认262114</span></span></code></pre><button class="collapse"></button></div></li></ul><p>磁盘临时表：排序使用优先队列（堆）的方式</p><hr><h4 id="group" tabindex="-1">GROUP <a class="header-anchor" href="#group" aria-label="Permalink to &quot;GROUP&quot;">​</a></h4><p>GROUP BY 也会进行排序操作，与 ORDER BY 相比，GROUP BY 主要只是多了排序之后的分组操作，所以在 GROUP BY 的实现过程中，与 ORDER BY 一样也可以利用到索引</p><ul><li><p>分组查询：</p><div style="max-height:300px" class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code v-pre><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">DROP</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> INDEX</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> idx_emp_age_salary </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">ON</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> emp;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">EXPLAIN </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">SELECT</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> age,</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">COUNT</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">FROM</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> emp </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">GROUP BY</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> age;</span></span></code></pre><button class="collapse"></button></div><figure><img src="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20250320010253430.png" alt="image-20250320010253430" loading="lazy" decoding="async" class="lazy"></figure><p>Using temporary：表示 MySQL 需要使用临时表（不是 sort buffer）来存储结果集，常见于排序和分组查询</p></li><li><p>查询包含 GROUP BY 但是用户想要避免排序结果的消耗， 则可以执行 ORDER BY NULL 禁止排序：</p><div style="max-height:300px" class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code v-pre><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">EXPLAIN </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">SELECT</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> age,</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">COUNT</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">FROM</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> emp </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">GROUP BY</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> age </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">ORDER BY</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> NULL</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">;</span></span></code></pre><button class="collapse"></button></div><figure><img src="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20250320010330441.png" alt="image-20250320010330441" loading="lazy" decoding="async" class="lazy"></figure></li><li><p>创建索引：索引本身有序，不需要临时表，也不需要再额外排序</p><div style="max-height:300px" class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code v-pre><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">CREATE</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> INDEX</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> idx_emp_age_salary</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> ON</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> emp(age, salary);</span></span></code></pre><button class="collapse"></button></div><figure><img src="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20250320010353642.png" alt loading="lazy" decoding="async" class="lazy"></figure></li><li><p>数据量很大时，使用 SQL_BIG_RESULT 提示优化器直接使用直接用磁盘临时表</p></li></ul><hr><h3 id="联合查询" tabindex="-1">联合查询 <a class="header-anchor" href="#联合查询" aria-label="Permalink to &quot;联合查询&quot;">​</a></h3><p>对于包含 OR 的查询子句，如果要利用索引，则 OR 之间的<strong>每个条件列都必须用到索引，而且不能使用到条件之间的复合索引</strong>，如果没有索引，则应该考虑增加索引</p><ul><li><p>执行查询语句：</p><div style="max-height:300px" class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code v-pre><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">EXPLAIN </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">SELECT</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> *</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> FROM</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> emp </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">WHERE</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> id </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> 1</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> OR</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> age </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> 30</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">;	</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">-- 两个索引，并且不是复合索引</span></span></code></pre><button class="collapse"></button></div><figure><img src="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20250320010443299.png" alt="image-20250320010443299" loading="lazy" decoding="async" class="lazy"></figure><div style="max-height:300px" class="language-sh vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code v-pre><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">Extra:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF"> Using</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF"> sort_union</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">idx_emp_age_salary,PRIMARY</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">); </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">Using</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF"> where</span></span></code></pre><button class="collapse"></button></div></li><li><p>使用 UNION 替换 OR，求并集：</p><p>注意：该优化只针对多个索引列有效，如果有列没有被索引，查询效率可能会因为没有选择 OR 而降低</p><div style="max-height:300px" class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code v-pre><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">EXPLAIN </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">SELECT</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> *</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> FROM</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> emp </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">WHERE</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> id </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> 1</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> UNION</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> SELECT</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> *</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> FROM</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> emp </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">WHERE</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> age </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> 30</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">;</span></span></code></pre><button class="collapse"></button></div><figure><img src="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20250320010458558.png" alt="image-20250320010458558" loading="lazy" decoding="async" class="lazy"></figure></li><li><p>UNION 要优于 OR 的原因：</p><ul><li>UNION 语句的 type 值为 ref，OR 语句的 type 值为 range</li><li>UNION 语句的 ref 值为 const，OR 语句的 ref 值为 null，const 表示是常量值引用，非常快</li></ul></li></ul><hr><h3 id="嵌套查询" tabindex="-1">嵌套查询 <a class="header-anchor" href="#嵌套查询" aria-label="Permalink to &quot;嵌套查询&quot;">​</a></h3><p>MySQL 4.1 版本之后，开始支持 SQL 的子查询</p><ul><li>可以使用 SELECT 语句来创建一个单列的查询结果，然后把结果作为过滤条件用在另一个查询中</li><li>使用子查询可以一次性的完成逻辑上需要多个步骤才能完成的 SQL 操作，同时也可以避免事务或者表锁死</li><li>在有些情况下，<strong>子查询是可以被更高效的连接（JOIN）替代</strong></li></ul><p>例如查找有角色的所有的用户信息：</p><ul><li><p>执行计划：</p><div style="max-height:300px" class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code v-pre><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">EXPLAIN </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">SELECT</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> *</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> FROM</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> t_user </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">WHERE</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> id </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">IN</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">SELECT</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> user_id </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">FROM</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> user_role);</span></span></code></pre><button class="collapse"></button></div><figure><img src="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20250320010514932.png" alt="image-20250320010514932" loading="lazy" decoding="async" class="lazy"></figure></li><li><p>优化后：</p><div style="max-height:300px" class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code v-pre><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">EXPLAIN </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">SELECT</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> *</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> FROM</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> t_user u , user_role ur </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">WHERE</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> u</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">id</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> ur</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">user_id</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">;</span></span></code></pre><button class="collapse"></button></div><figure><img src="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20250320010528940.png" alt="image-20250320010528940" loading="lazy" decoding="async" class="lazy"></figure><p>连接查询之所以效率更高 ，是因为<strong>不需要在内存中创建临时表</strong>来完成逻辑上需要两个步骤的查询工作</p></li></ul><hr><h3 id="分页查询" tabindex="-1">分页查询 <a class="header-anchor" href="#分页查询" aria-label="Permalink to &quot;分页查询&quot;">​</a></h3><p>一般分页查询时，通过创建覆盖索引能够比较好地提高性能</p><p>一个常见的问题是 <code>LIMIT 200000,10</code>，此时需要 MySQL 扫描前 200010 记录，仅仅返回 200000 - 200010 之间的记录，其他记录丢弃，查询排序的代价非常大</p><ul><li><p>分页查询：</p><div style="max-height:300px" class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code v-pre><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">EXPLAIN </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">SELECT</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> *</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> FROM</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> tb_user_1 </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">LIMIT</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> 200000</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">,</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">10</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">;</span></span></code></pre><button class="collapse"></button></div><figure><img src="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20250320010546706.png" alt="image-20250320010546706" loading="lazy" decoding="async" class="lazy"></figure></li><li><p>优化方式一：内连接查询，在索引列 id 上完成排序分页操作，最后根据主键关联回原表查询所需要的其他列内容</p><div style="max-height:300px" class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code v-pre><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">EXPLAIN </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">SELECT</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> *</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> FROM</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> tb_user_1 t,(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">SELECT</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> id </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">FROM</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> tb_user_1 </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">ORDER BY</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> id </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">LIMIT</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> 200000</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">,</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">10</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">) a </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">WHERE</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> t</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">id</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> a</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">id</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">;</span></span></code></pre><button class="collapse"></button></div><figure><img src="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20250320010600495.png" alt="image-20250320010600495" loading="lazy" decoding="async" class="lazy"></figure></li><li><p>优化方式二：方案适用于主键自增的表，可以把 LIMIT 查询转换成某个位置的查询</p><div style="max-height:300px" class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code v-pre><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">EXPLAIN </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">SELECT</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> *</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> FROM</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> tb_user_1 </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">WHERE</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> id </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">&gt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> 200000</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> LIMIT</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> 10</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">;			</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">-- 写法 1</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">EXPLAIN </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">SELECT</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> *</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> FROM</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> tb_user_1 </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">WHERE</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> id </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">BETWEEN</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> 200000</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> and</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> 200010</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">;	</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">-- 写法 2</span></span></code></pre><button class="collapse"></button></div><figure><img src="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20250320010614388.png" alt="image-20250320010614388" loading="lazy" decoding="async" class="lazy"></figure></li></ul><hr><h3 id="使用提示" tabindex="-1">使用提示 <a class="header-anchor" href="#使用提示" aria-label="Permalink to &quot;使用提示&quot;">​</a></h3><p>SQL 提示，是优化数据库的一个重要手段，就是在 SQL 语句中加入一些提示来达到优化操作的目的</p><ul><li><p>USE INDEX：在查询语句中表名的后面添加 USE INDEX 来提供 MySQL 去参考的索引列表，可以让 MySQL 不再考虑其他可用的索引</p><div style="max-height:300px" class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code v-pre><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">CREATE</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> INDEX</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> idx_seller_name</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> ON</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> tb_seller(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">EXPLAIN </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">SELECT</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> *</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> FROM</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> tb_seller </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">USE</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> INDEX</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(idx_seller_name) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">WHERE</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> name=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">'小米科技'</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">;</span></span></code></pre><button class="collapse"></button></div><figure><img src="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20250320010640115.png" alt="image-20250320010640115" loading="lazy" decoding="async" class="lazy"></figure></li><li><p>IGNORE INDEX：让 MySQL 忽略一个或者多个索引，则可以使用 IGNORE INDEX 作为提示</p><div style="max-height:300px" class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code v-pre><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">EXPLAIN </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">SELECT</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> *</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> FROM</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> tb_seller </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">IGNORE</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> INDEX</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(idx_seller_name) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">WHERE</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> name</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> =</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF"> '小米科技'</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">;</span></span></code></pre><button class="collapse"></button></div><figure><img src="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20250320010653006.png" alt="image-20250320010653006" loading="lazy" decoding="async" class="lazy"></figure></li><li><p>FORCE INDEX：强制 MySQL 使用一个特定的索引</p><div style="max-height:300px" class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code v-pre><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">EXPLAIN </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">SELECT</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> *</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> FROM</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> tb_seller </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">FORCE</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> INDEX</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(idx_seller_name_sta_addr) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">WHERE</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> NAME=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">'小米科技'</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">;</span></span></code></pre><button class="collapse"></button></div><figure><img src="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20250320010722329.png" alt="image-20250320010722329" loading="lazy" decoding="async" class="lazy"></figure></li></ul><hr><h3 id="统计计数" tabindex="-1">统计计数 <a class="header-anchor" href="#统计计数" aria-label="Permalink to &quot;统计计数&quot;">​</a></h3><p>在不同的 MySQL 引擎中，count(*) 有不同的实现方式：</p><ul><li>MyISAM 引擎把一个表的总行数存在了磁盘上，因此执行 count(*) 的时候会直接返回这个数，效率很高，但不支持事务</li><li>show table status 命令通过采样估算可以快速获取，但是不准确</li><li>InnoDB 表执行 count(*) 会遍历全表，虽然结果准确，但会导致性能问题</li></ul><p>解决方案：</p><ul><li><p>计数保存在 Redis 中，但是更新 MySQL 和 Redis 的操作不是原子的，会存在数据一致性的问题</p></li><li><p>计数直接放到数据库里单独的一张计数表中，利用事务解决计数精确问题：</p><figure><img src="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20250320010755840.png" alt="image-20250320010755840" loading="lazy" decoding="async" class="lazy"></figure><p>会话 B 的读操作在 T3 执行的，这时更新事务还没有提交，所以计数值加 1 这个操作对会话 B 还不可见，因此会话 B 查询的计数值和最近 100 条记录，返回的结果逻辑上就是一致的</p><p>并发系统性能的角度考虑，应该先插入操作记录再更新计数表，因为更新计数表涉及到行锁的竞争，<strong>先插入再更新能最大程度地减少事务之间的锁等待，提升并发度</strong></p></li></ul><p>count 函数的按照效率排序：<code>count(字段) &lt; count(主键id) &lt; count(1) ≈ count(*)</code>，所以建议尽量使用 count(*)</p><ul><li>count(主键 id)：InnoDB 引擎会遍历整张表，把每一行的 id 值都取出来返回给 Server 层，Server 判断 id 不为空就按行累加</li><li>count(1)：InnoDB 引擎遍历整张表但不取值，Server 层对于返回的每一行，放一个数字 1 进去，判断不为空就按行累加</li><li>count(字段)：如果这个字段是定义为 not null 的话，一行行地从记录里面读出这个字段，判断不能为 null，按行累加；如果这个字段定义允许为 null，那么执行的时候，判断到有可能是 null，还要把值取出来再判断一下，不是 null 才累加</li><li>count(*)：不取值，按行累加</li></ul><p>参考文章：<a href="https://time.geekbang.org/column/article/72775" target="_blank" rel="noreferrer">https://time.geekbang.org/column/article/72775</a></p><hr><h2 id="缓冲优化" tabindex="-1">缓冲优化 <a class="header-anchor" href="#缓冲优化" aria-label="Permalink to &quot;缓冲优化&quot;">​</a></h2><h3 id="优化原则" tabindex="-1">优化原则 <a class="header-anchor" href="#优化原则" aria-label="Permalink to &quot;优化原则&quot;">​</a></h3><p>三个原则：</p><ul><li>将尽量多的内存分配给 MySQL 做缓存，但也要给操作系统和其他程序预留足够内存</li><li>MyISAM 存储引擎的数据文件读取依赖于操作系统自身的 IO 缓存，如果有 MyISAM 表，就要预留更多的内存给操作系统做 IO 缓存</li><li>排序区、连接区等缓存是分配给每个数据库会话（Session）专用的，值的设置要根据最大连接数合理分配，如果设置太大，不但浪费资源，而且在并发数较高时会导致物理内存耗尽</li></ul><hr><h3 id="缓冲内存" tabindex="-1">缓冲内存 <a class="header-anchor" href="#缓冲内存" aria-label="Permalink to &quot;缓冲内存&quot;">​</a></h3><p>Buffer Pool 本质上是 InnoDB 向操作系统申请的一段连续的内存空间。InnoDB 的数据是按数据页为单位来读写，每个数据页的大小默认是 16KB。数据是存放在磁盘中，每次读写数据都需要进行磁盘 IO 将数据读入内存进行操作，效率会很低，所以提供了 Buffer Pool 来暂存这些数据页，缓存中的这些页又叫缓冲页</p><p>工作原理：</p><ul><li>从数据库读取数据时，会首先从缓存中读取，如果缓存中没有，则从磁盘读取后放入 Buffer Pool</li><li>向数据库写入数据时，会写入缓存，缓存中修改的数据会<strong>定期刷新</strong>到磁盘，这一过程称为刷脏</li></ul><p>Buffer Pool 中每个缓冲页都有对应的控制信息，包括表空间编号、页号、偏移量、链表信息等，控制信息存放在占用的内存称为控制块，控制块与缓冲页是一一对应的，但并不是物理上相连的，都在缓冲池中</p><p>MySQL 提供了缓冲页的快速查找方式：<strong>哈希表</strong>，使用表空间号和页号作为 Key，缓冲页控制块的地址作为 Value 创建一个哈希表，获取数据页时根据 Key 进行哈希寻址：</p><ul><li>如果不存在对应的缓存页，就从 free 链表中选一个空闲缓冲页，把磁盘中的对应页加载到该位置</li><li>如果存在对应的缓存页，直接获取使用，提高查询数据的效率</li></ul><p>当内存数据页跟磁盘数据页内容不一致时，称这个内存页为脏页；内存数据写入磁盘后，内存和磁盘上的数据页一致，称为干净页</p><hr><h3 id="内存管理" tabindex="-1">内存管理 <a class="header-anchor" href="#内存管理" aria-label="Permalink to &quot;内存管理&quot;">​</a></h3><h4 id="free-链表" tabindex="-1">Free 链表 <a class="header-anchor" href="#free-链表" aria-label="Permalink to &quot;Free 链表&quot;">​</a></h4><p>MySQL 启动时完成对 Buffer Pool 的初始化，先向操作系统申请连续的内存空间，然后将内存划分为若干对控制块和缓冲页。为了区分空闲和已占用的数据页，将所有空闲缓冲页对应的<strong>控制块作为一个节点</strong>放入一个链表中，就是 Free 链表（<strong>空闲链表</strong>）</p><figure><img src="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20250320010821319.png" alt="image-20250320010821319" loading="lazy" decoding="async" class="lazy"></figure><p>基节点：是一块单独申请的内存空间（占 40 字节），并不在 Buffer Pool 的那一大片连续内存空间里</p><p>磁盘加载页的流程：</p><ul><li>从 Free 链表中取出一个空闲的缓冲页</li><li>把缓冲页对应的控制块的信息填上（页所在的表空间、页号之类的信息）</li><li>把缓冲页对应的 Free 链表节点（控制块）从链表中移除，表示该缓冲页已经被使用</li></ul><p>参考文章：<a href="https://blog.csdn.net/li1325169021/article/details/121124440" target="_blank" rel="noreferrer">https://blog.csdn.net/li1325169021/article/details/121124440</a></p><hr><h4 id="flush-链表" tabindex="-1">Flush 链表 <a class="header-anchor" href="#flush-链表" aria-label="Permalink to &quot;Flush 链表&quot;">​</a></h4><p>Flush 链表是一个用来<strong>存储脏页</strong>的链表，对于已经修改过的缓冲脏页，第一次修改后加入到<strong>链表头部</strong>，以后每次修改都不会重新加入，只修改部分控制信息，出于性能考虑并不是直接更新到磁盘，而是在未来的某个时间进行刷脏</p><figure><img src="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20250320010834310.png" alt="image-20250320010834310" loading="lazy" decoding="async" class="lazy"></figure><p><strong>后台有专门的线程每隔一段时间把脏页刷新到磁盘</strong>：</p><ul><li>从 Flush 链表中刷新一部分页面到磁盘：<ul><li><strong>后台线程定时</strong>从 Flush 链表刷脏，根据系统的繁忙程度来决定刷新速率，这种方式称为 BUF_FLUSH_LIST</li><li>线程刷脏的比较慢，导致用户线程加载一个新的数据页时发现没有空闲缓冲页，此时会尝试从 LRU 链表尾部寻找缓冲页直接释放，如果该页面是已经修改过的脏页就<strong>同步刷新</strong>到磁盘，速度较慢，这种方式称为 BUF_FLUSH_SINGLE_PAGE</li></ul></li><li>从 LRU 链表的冷数据中刷新一部分页面到磁盘，即：BUF_FLUSH_LRU<ul><li>后台线程会定时从 LRU 链表的尾部开始扫描一些页面，扫描的页面数量可以通过系统变量 <code>innodb_lru_scan_depth</code> 指定，如果在 LRU 链表中发现脏页，则把它们刷新到磁盘，这种方式称为 BUF_FLUSH_LRU</li><li>控制块里会存储该缓冲页是否被修改的信息，所以可以很容易的获取到某个缓冲页是否是脏页</li></ul></li></ul><p>参考文章：<a href="https://blog.csdn.net/li1325169021/article/details/121125765" target="_blank" rel="noreferrer">https://blog.csdn.net/li1325169021/article/details/121125765</a></p><hr><h4 id="lru-链表" tabindex="-1">LRU 链表 <a class="header-anchor" href="#lru-链表" aria-label="Permalink to &quot;LRU 链表&quot;">​</a></h4><p>Buffer Pool 需要保证缓存的命中率，所以 MySQL 创建了一个 LRU 链表，当访问某个页时：</p><ul><li>如果该页不在 Buffer Pool 中，把该页从磁盘加载进来后会将该缓冲页对应的控制块作为节点放入 <strong>LRU 链表的头部</strong>，保证热点数据在链表头</li><li>如果该页在 Buffer Pool 中，则直接把该页对应的控制块移动到 LRU 链表的头部，所以 LRU 链表尾部就是最近最少使用的缓冲页</li></ul><p>MySQL 基于局部性原理提供了预读功能：</p><ul><li>线性预读：系统变量 <code>innodb_read_ahead_threshold</code>，如果顺序访问某个区（extent：16 KB 的页，连续 64 个形成一个区，一个区默认 1MB 大小）的页面数超过了该系统变量值，就会触发一次<strong>异步读取</strong>下一个区中全部的页面到 Buffer Pool 中</li><li>随机预读：如果某个区 13 个连续的页面都被加载到 Buffer Pool，无论这些页面是否是顺序读取，都会触发一次<strong>异步读取</strong>本区所有的其他页面到 Buffer Pool 中</li></ul><p>预读会造成加载太多用不到的数据页，造成那些使用频率很高的数据页被挤到 LRU 链表尾部，所以 InnoDB 将 LRU 链表分成两段，<strong>冷热数据隔离</strong>：</p><ul><li>一部分存储使用频率很高的数据页，这部分链表也叫热数据，young 区，靠近链表头部的区域</li><li>一部分存储使用频率不高的冷数据，old 区，靠近链表尾部，默认占 37%，可以通过系统变量 <code>innodb_old_blocks_pct</code> 指定</li></ul><p>当磁盘上的某数据页被初次加载到 Buffer Pool 中会被放入 old 区，淘汰时优先淘汰 old 区</p><ul><li>当对 old 区的数据进行访问时，会在控制块记录下访问时间，等待后续的访问时间与第一次访问的时间是否在某个时间间隔内，通过系统变量 <code>innodb_old_blocks_time</code> 指定时间间隔，默认 1000ms，成立就<strong>移动到 young 区的链表头部</strong></li><li><code>innodb_old_blocks_time</code> 为 0 时，每次访问一个页面都会放入 young 区的头部</li></ul><hr><h3 id="参数优化" tabindex="-1">参数优化 <a class="header-anchor" href="#参数优化" aria-label="Permalink to &quot;参数优化&quot;">​</a></h3><p>InnoDB 用一块内存区做 IO 缓存池，该缓存池不仅用来缓存 InnoDB 的索引块，也用来缓存 InnoDB 的数据块，可以通过下面的指令查看 Buffer Pool 的状态信息：</p><div style="max-height:300px" class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code v-pre><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">SHOW ENGINE INNODB </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">STATUS</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">\G</span></span></code></pre><button class="collapse"></button></div><p><code>Buffer pool hit rate</code> 字段代表<strong>内存命中率</strong>，表示 Buffer Pool 对查询的加速效果</p><p>核心参数：</p><ul><li><p><code>innodb_buffer_pool_size</code>：该变量决定了 Innodb 存储引擎表数据和索引数据的最大缓存区大小，默认 128M</p><div style="max-height:300px" class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code v-pre><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">SHOW VARIABLES </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">LIKE</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF"> 'innodb_buffer_pool_size'</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">;</span></span></code></pre><button class="collapse"></button></div><p>在保证操作系统及其他程序有足够内存可用的情况下，<code>innodb_buffer_pool_size</code> 的值越大，缓存命中率越高，建议设置成可用物理内存的 60%~80%</p><div style="max-height:300px" class="language-sh vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code v-pre><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">innodb_buffer_pool_size</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">512M</span></span></code></pre><button class="collapse"></button></div></li><li><p><code>innodb_log_buffer_size</code>：该值决定了 Innodb 日志缓冲区的大小，保存要写入磁盘上的日志文件数据</p><p>对于可能产生大量更新记录的大事务，增加该值的大小，可以避免 Innodb 在事务提交前就执行不必要的日志写入磁盘操作，影响执行效率，通过配置文件修改：</p><div style="max-height:300px" class="language-sh vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code v-pre><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">innodb_log_buffer_size</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">10M</span></span></code></pre><button class="collapse"></button></div></li></ul><p>在多线程下，访问 Buffer Pool 中的各种链表都需要加锁，所以将 Buffer Pool 拆成若干个小实例，<strong>每个线程对应一个实例</strong>，独立管理内存空间和各种链表（类似 ThreadLocal），多线程访问各自实例互不影响，提高了并发能力</p><p>MySQL 5.7.5 之前 <code>innodb_buffer_pool_size</code> 只支持在系统启动时修改，现在已经支持运行时修改 Buffer Pool 的大小，但是每次调整参数都会重新向操作系统申请一块连续的内存空间，<strong>将旧的缓冲池的内容拷贝到新空间</strong>非常耗时，所以 MySQL 开始以一个 chunk 为单位向操作系统申请内存，所以一个 Buffer Pool 实例可以由多个 chunk 组成</p><ul><li>在系统启动时设置系统变量 <code>innodb_buffer_pool_instance</code> 可以指定 Buffer Pool 实例的个数，但是当 Buffer Pool 小于 1GB 时，设置多个实例时无效的</li><li>指定系统变量 <code>innodb_buffer_pool_chunk_size</code> 来改变 chunk 的大小，只能在启动时修改，运行中不能修改，而且该变量并不包含缓冲页的控制块的内存大小</li><li><code>innodb_buffer_pool_size</code> 必须是 <code>innodb_buffer_pool_chunk_size × innodb_buffer_pool_instance</code> 的倍数，默认值是 <code>128M × 16 = 2G</code>，Buffer Pool 必须是 2G 的整数倍，如果指定 5G，会自动调整成 6G</li><li>如果启动时 <code>chunk × instances</code> &gt; <code>pool_size</code>，那么 chunk 的值会自动设置为 <code>pool_size ÷ instances</code></li></ul><hr><h2 id="内存优化" tabindex="-1">内存优化 <a class="header-anchor" href="#内存优化" aria-label="Permalink to &quot;内存优化&quot;">​</a></h2><h3 id="change" tabindex="-1">Change <a class="header-anchor" href="#change" aria-label="Permalink to &quot;Change&quot;">​</a></h3><p>InnoDB 管理的 Buffer Pool 中有一块内存叫 Change Buffer 用来对<strong>增删改操作</strong>提供缓存，可以通过参数来动态设置，设置为 50 时表示 Change Buffer 的大小最多占用 Buffer Pool 的 50%</p><ul><li>唯一索引的更新不能使用 Change Buffer，需要将数据页读入内存，判断没有冲突在写入</li><li>普通索引可以使用 Change Buffer，<strong>直接写入 Buffer 就结束</strong>，不用校验唯一性</li></ul><p>Change Buffer 并不是数据页，只是对操作的缓存，所以需要将 Change Buffer 中的操作应用到旧数据页，得到新的数据页（脏页）的过程称为 Merge</p><ul><li>触发时机：访问数据页时会触发 Merge、后台有定时线程进行 Merge、在数据库正常关闭（shutdown）的过程中也会触发</li><li>工作流程：首先从磁盘读入数据页到内存（因为 Buffer Pool 中不一定存在对应的数据页），从 Change Buffer 中找到对应的操作应用到数据页，得到新的数据页即为脏页，然后写入 redo log，等待刷脏即可</li></ul><p>说明：Change Buffer 中的记录，在事务提交时也会写入 redo log，所以是可以保证不丢失的</p><p>业务场景：</p><ul><li><p>对于<strong>写多读少</strong>的业务来说，页面在写完以后马上被访问到的概率比较小，此时 Change Buffer 的使用效果最好，常见的就是账单类、日志类的系统</p></li><li><p>一个业务的更新模式是写入后马上做查询，那么即使满足了条件，将更新先记录在 Change Buffer，但之后由于马上要访问这个数据页，会立即触发 Merge 过程，这样随机访问 IO 的次数不会减少，并且增加了 Change Buffer 的维护代价</p></li></ul><p>补充：Change Buffer 的前身是 Insert Buffer，只能对 Insert 操作优化，后来增加了 Update/Delete 的支持，改为 Change Buffer</p><hr><h3 id="net" tabindex="-1">Net <a class="header-anchor" href="#net" aria-label="Permalink to &quot;Net&quot;">​</a></h3><p>Server 层针对优化<strong>查询</strong>的内存为 Net Buffer，内存的大小是由参数 <code>net_buffer_length</code>定义，默认 16k，实现流程：</p><ul><li>获取一行数据写入 Net Buffer，重复获取直到 Net Buffer 写满，调用网络接口发出去</li><li>若发送成功就清空 Net Buffer，然后继续取下一行；若发送函数返回 EAGAIN 或 WSAEWOULDBLOCK，表示本地网络栈 <code>socket send buffer</code> 写满了，<strong>进入等待</strong>，直到网络栈重新可写再继续发送</li></ul><p>MySQL 采用的是边读边发的逻辑，因此对于数据量很大的查询来说，不会在 Server 端保存完整的结果集，如果客户端读结果不及时，会堵住 MySQL 的查询过程，但是<strong>不会把内存打爆导致 OOM</strong></p><figure><img src="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20250320011014398.png" alt="image-20250320011014398" loading="lazy" decoding="async" class="lazy"></figure><p>SHOW PROCESSLIST 获取线程信息后，处于 Sending to client 状态代表服务器端的网络栈写满，等待客户端接收数据</p><p>假设有一个业务的逻辑比较复杂，每读一行数据以后要处理很久的逻辑，就会导致客户端要过很久才会去取下一行数据，导致 MySQL 的阻塞，一直处于 Sending to client 的状态</p><p>解决方法：如果一个查询的返回结果很是很多，建议使用 mysql_store_result 这个接口，直接把查询结果保存到本地内存</p><p>参考文章：<a href="https://blog.csdn.net/qq_33589510/article/details/117673449" target="_blank" rel="noreferrer">https://blog.csdn.net/qq_33589510/article/details/117673449</a></p><hr><h3 id="read" tabindex="-1">Read <a class="header-anchor" href="#read" aria-label="Permalink to &quot;Read&quot;">​</a></h3><p>read_rnd_buffer 是 MySQL 的随机读缓冲区，当按任意顺序读取记录行时将分配一个随机读取缓冲区，进行排序查询时，MySQL 会首先扫描一遍该缓冲，以避免磁盘搜索，提高查询速度，大小是由 read_rnd_buffer_size 参数控制的</p><p>Multi-Range Read 优化，<strong>将随机 IO 转化为顺序 IO</strong> 以降低查询过程中 IO 开销，因为大多数的数据都是按照主键递增顺序插入得到，所以按照主键的递增顺序查询的话，对磁盘的读比较接近顺序读，能够提升读性能</p><p>二级索引为 a，聚簇索引为 id，优化回表流程：</p><ul><li>根据索引 a，定位到满足条件的记录，将 id 值放入 read_rnd_buffer 中</li><li>将 read_rnd_buffer 中的 id 进行<strong>递增排序</strong></li><li>排序后的 id 数组，依次回表到主键 id 索引中查记录，并作为结果返回</li></ul><p>说明：如果步骤 1 中 read_rnd_buffer 放满了，就会先执行步骤 2 和 3，然后清空 read_rnd_buffer，之后继续找索引 a 的下个记录</p><p>使用 MRR 优化需要设进行设置：</p><div style="max-height:300px" class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code v-pre><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">SET</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> optimizer_switch</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">'mrr_cost_based=off'</span></span></code></pre><button class="collapse"></button></div><hr><h3 id="key-1" tabindex="-1">Key <a class="header-anchor" href="#key-1" aria-label="Permalink to &quot;Key&quot;">​</a></h3><p>MyISAM 存储引擎使用 key_buffer 缓存索引块，加速 MyISAM 索引的读写速度。对于 MyISAM 表的数据块没有特别的缓存机制，完全依赖于操作系统的 IO 缓存</p><ul><li><p>key_buffer_size：该变量决定 MyISAM 索引块缓存区的大小，直接影响到 MyISAM 表的存取效率</p><div style="max-height:300px" class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code v-pre><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">SHOW VARIABLES </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">LIKE</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF"> 'key_buffer_size'</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">;	</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">-- 单位是字节</span></span></code></pre><button class="collapse"></button></div><p>在 MySQL 配置文件中设置该值，建议至少将1/4可用内存分配给 key_buffer_size：</p><div style="max-height:300px" class="language-sh vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code v-pre><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">vim</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF"> /etc/mysql/my.cnf</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">key_buffer_size</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">1024M</span></span></code></pre><button class="collapse"></button></div></li><li><p>read_buffer_size：如果需要经常顺序扫描 MyISAM 表，可以通过增大 read_buffer_size 的值来改善性能。但 read_buffer_size 是每个 Session 独占的，如果默认值设置太大，并发环境就会造成内存浪费</p></li><li><p>read_rnd_buffer_size：对于需要做排序的 MyISAM 表的查询，如带有 ORDER BY 子句的语句，适当增加该的值，可以改善此类的 SQL 的性能，但是 read_rnd_buffer_size 是每个 Session 独占的，如果默认值设置太大，就会造成内存浪费</p></li></ul><hr><h2 id="存储优化" tabindex="-1">存储优化 <a class="header-anchor" href="#存储优化" aria-label="Permalink to &quot;存储优化&quot;">​</a></h2><h3 id="数据存储" tabindex="-1">数据存储 <a class="header-anchor" href="#数据存储" aria-label="Permalink to &quot;数据存储&quot;">​</a></h3><p>系统表空间是用来放系统信息的，比如数据字典什么的，对应的磁盘文件是 ibdata，数据表空间是一个个的表数据文件，对应的磁盘文件就是表名.ibd</p><p>表数据既可以存在共享表空间里，也可以是单独的文件，这个行为是由参数 innodb_file_per_table 控制的：</p><ul><li>OFF：表示表的数据放在系统共享表空间，也就是跟数据字典放在一起</li><li>ON ：表示每个 InnoDB 表数据存储在一个以 .ibd 为后缀的文件中（默认）</li></ul><p>一个表单独存储为一个文件更容易管理，在不需要这个表时通过 drop table 命令，系统就会直接删除这个文件；如果是放在共享表空间中，即使表删掉了，空间也是不会回收的</p><hr><h3 id="数据删除" tabindex="-1">数据删除 <a class="header-anchor" href="#数据删除" aria-label="Permalink to &quot;数据删除&quot;">​</a></h3><p>MySQL 的数据删除就是移除掉某个记录后，该位置就被标记为<strong>可复用</strong>，如果有符合范围条件的数据可以插入到这里。符合范围条件的意思是假设删除记录 R4，之后要再插入一个 ID 在 300 和 600 之间的记录时，就会复用这个位置</p><figure><img src="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20250320011040214.png" alt="image-20250320011040214" loading="lazy" decoding="async" class="lazy"></figure><p>InnoDB 的数据是按页存储的如果删掉了一个数据页上的所有记录，整个数据页就可以被复用了，如果相邻的两个数据页利用率都很小，系统就会把这两个页上的数据合到其中一个页上，另外一个数据页就被标记为可复用</p><p>删除命令其实只是把记录的位置，或者<strong>数据页标记为了可复用，但磁盘文件的大小是不会变的</strong>，这些可以复用还没有被使用的空间，看起来就像是空洞，造成数据库的稀疏，因此需要进行紧凑处理</p><hr><h3 id="重建数据" tabindex="-1">重建数据 <a class="header-anchor" href="#重建数据" aria-label="Permalink to &quot;重建数据&quot;">​</a></h3><p>重建表就是按照主键 ID 递增的顺序，把数据一行一行地从旧表中读出来再插入到新表中，让数据更加紧凑。重建表时 MySQL 会自动完成转存数据、交换表名、删除旧表的操作，线上操作会阻塞大量的线程增删改查的操作</p><p>重建命令：</p><div style="max-height:300px" class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code v-pre><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">ALTER</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> TABLE</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> A ENGINE</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">InnoDB</span></span></code></pre><button class="collapse"></button></div><p>工作流程：新建临时表 tmp_table B（在 Server 层创建的），把表 A 中的数据导入到表 B 中，操作完成后用表 B 替换表 A，完成重建</p><p>重建表的步骤需要 DDL 不是 Online 的，因为在导入数据的过程有新的数据要写入到表 A 的话，就会造成数据丢失</p><p>MySQL 5.6 版本开始引入的 <strong>Online DDL</strong>，重建表的命令默认执行此步骤：</p><ul><li>建立一个临时文件 tmp_file（InnoDB 创建），扫描表 A 主键的所有数据页</li><li>用数据页中表 A 的记录生成 B+ 树，存储到临时文件中</li><li>生成临时文件的过程中，将所有对 A 的操作记录在一个日志文件（row log）中，对应的是图中 state2 的状态</li><li>临时文件生成后，将日志文件中的操作应用到临时文件，得到一个逻辑数据上与表 A 相同的数据文件，对应的就是图中 state3</li><li>用临时文件替换表 A 的数据文件</li></ul><figure><img src="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20250320011052781.png" alt="image-20250320011052781" loading="lazy" decoding="async" class="lazy"></figure><p>Online DDL 操作会先获取 MDL 写锁，再退化成 MDL 读锁。但 MDL 写锁持有时间比较短，所以可以称为 Online； 而 MDL 读锁，不阻止数据增删查改，但会阻止其它线程修改表结构（可以对比 <code>ANALYZE TABLE t</code> 命令）</p><p>问题：重建表可以收缩表空间，但是执行指令后整体占用空间增大</p><p>原因：在重建表后 InnoDB 不会把整张表占满，每个页留了 1/16 给后续的更新使用。表在未整理之前页已经占用 15/16 以上，收缩之后需要保持数据占用空间在 15/16，所以文件占用空间更大才能保持</p><p>注意：临时文件也要占用空间，如果空间不足会重建失败</p><hr><h3 id="原地置换" tabindex="-1">原地置换 <a class="header-anchor" href="#原地置换" aria-label="Permalink to &quot;原地置换&quot;">​</a></h3><p>DDL 中的临时表 tmp_table 是在 Server 层创建的，Online DDL 中的临时文件 tmp_file 是 InnoDB 在内部创建出来的，整个 DDL 过程都在 InnoDB 内部完成，对于 Server 层来说，没有把数据挪动到临时表，是一个原地操作，这就是 inplace</p><p>两者的关系：</p><ul><li>DDL 过程如果是 Online 的，就一定是 inplace 的</li><li>inplace 的 DDL，有可能不是 Online 的，截止到 MySQL 8.0，全文索引（FULLTEXT）和空间索引（SPATIAL）属于这种情况</li></ul><hr><h2 id="并发优化" tabindex="-1">并发优化 <a class="header-anchor" href="#并发优化" aria-label="Permalink to &quot;并发优化&quot;">​</a></h2><p>MySQL Server 是多线程结构，包括后台线程和客户服务线程。多线程可以有效利用服务器资源，提高数据库的并发性能。在 MySQL 中，控制并发连接和线程的主要参数：</p><ul><li><p>max_connections：控制允许连接到 MySQL 数据库的最大连接数，默认值是 151</p><p>如果状态变量 connection_errors_max_connections 不为零，并且一直增长，则说明不断有连接请求因数据库连接数已达到允许最大值而失败，这时可以考虑增大 max_connections 的值</p><p>MySQL 最大可支持的连接数取决于很多因素，包括操作系统平台的线程库的质量、内存大小、每个连接的负荷、CPU的处理速度、期望的响应时间等。在 Linux 平台下，性能好的服务器，可以支持 500-1000 个连接，需要根据服务器性能进行评估设定</p></li><li><p>innodb_thread_concurrency：并发线程数，代表系统内同时运行的线程数量（已经被移除）</p></li><li><p>back_log：控制 MySQL 监听 TCP 端口时的积压请求栈的大小</p><p>如果 Mysql 的连接数达到 max_connections 时，新来的请求将会被存在堆栈中，以等待某一连接释放资源，该堆栈的数量即 back_log。如果等待连接的数量超过 back_log，将不被授予连接资源直接报错</p><p>5.6.6 版本之前默认值为 50，之后的版本默认为 <code>50 + (max_connections/5)</code>，但最大不超过900，如果需要数据库在较短的时间内处理大量连接请求， 可以考虑适当增大 back_log 的值</p></li><li><p>table_open_cache：控制所有 SQL 语句执行线程可打开表缓存的数量</p><p>在执行 SQL 语句时，每个执行线程至少要打开1个表缓存，该参数的值应该根据设置的最大连接数以及每个连接执行关联查询中涉及的表的最大数量来设定：<code>max_connections * N</code></p></li><li><p>thread_cache_size：可控制 MySQL 缓存客户服务线程的数量</p><p>为了加快连接数据库的速度，MySQL 会缓存一定数量的客户服务线程以备重用，池化思想</p></li><li><p>innodb_lock_wait_timeout：设置 InnoDB 事务等待行锁的时间，默认值是 50ms</p><p>对于需要快速反馈的业务系统，可以将行锁的等待时间调小，以避免事务被长时间挂起； 对于后台运行的批量处理程序来说，可以将行锁的等待时间调大，以避免发生大的回滚操作</p></li></ul><!--]--><!--]--><!----><!--[--><div m="y-4" class="end flex justify-center items-center"><hr class="line inline-flex" w="full" m="!y-2"><span p="x-4" font="bold" class="whitespace-nowrap">To Be Continued.</span><hr class="line inline-flex" w="full" m="!y-2"></div><!--]--></article><!-- </Transition> --><!--]--><!--[--><!--[--><!--v-if--><ul class="post-copyright" m="y-4"><li class="post-copyright-author"><strong>本文作者：</strong><span>imklaus</span></li><li class="post-copyright-link"><strong>本文链接：</strong><a href="https://www.imlklaus.cn/posts/MySQL_Optimization" target="_blank" title="本文链接">https://www.imlklaus.cn/posts/MySQL_Optimization</a></li><li class="post-copyright-license"><strong>版权声明：</strong><span>本博客所有文章除特别声明外，均默认采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" target="_blank" rel="noopener" title="CC BY-NC-SA 4.0 ">CC BY-NC-SA</a> 许可协议。</span></li></ul><!--]--><!--]--></div><!--]--><!----></div><!--[--><!--]--><!--[--><div class="post-nav"><div class="post-nav-item"><a href="/posts/MySQL_Log" class="post-nav-prev" title="MySQL - 日志"><div class="icon" i-ri-arrow-left-s-line></div><span class="title truncate" text="sm">MySQL - 日志</span></a></div><div class="post-nav-item"><a href="/posts/MySQL_Master_Slave" class="post-nav-next" title="MySQL - 主从"><span class="title truncate" text="sm">MySQL - 主从</span><div class="icon" i-ri-arrow-right-s-line></div></a></div></div><!--]--><!--[--><!--]--><!--[--><div class="yun-card flex-center rounded comment yun-comment sm:p-6 lg:px-12 xl:px-16" flex="col" min-h="100px" bg="$va-c-bg-light" w="full" p="4"><!----><!----><!--[--><!----><!--]--><!----></div><!--]--><!--[--><!-- eslint-disable-next-line vue/no-lone-template empty --><template class="mt-4"></template><!--]--><!--[--><!--]--><!--[--><!--]--></div><!--]--></main><!--[--><button class="xl:hidden toc-btn shadow-md fixed yun-icon-btn z-20 bg-$va-c-bg-soft" opacity="75" right="4" bottom="19"><div i-ri-file-list-line></div></button><!----><aside flex="~ col" class="va-card yun-aside sticky top-0 lg:top-$yun-margin-top min-h-sm" text="center" overflow="auto"><div style="display:none" class="w-full" flex="~ col" pb-2><!--[--><h2 m="t-6 b-2" font="serif black">文章目录</h2><div style="display:none" data-v-7dda16e2><div class="content" data-v-7dda16e2><div class="outline-title" data-v-7dda16e2>本页</div><div class="outline-marker" data-v-7dda16e2></div><nav aria-labelledby="doc-outline-aria-label" data-v-7dda16e2><span id="doc-outline-aria-label" class="visually-hidden" data-v-7dda16e2>Table of Contents for current page</span><ul class="root va-toc relative z-1 css-i18n-toc" data-v-7dda16e2 data-v-4dec0668><!--[--><!--]--></ul></nav></div></div><!--]--><div class="flex-grow"></div><!----></div></aside><!--]--><!--]--></div><footer flex="~ col" class="relative yun-footer va-footer px-4 py-4 pt-0 text-$va-c-text-light w-full mt-14" bg="white dark:$va-c-bg-soft" text="center sm"><div class="yun-cloud absolute top--10 left-0 right-0"><svg class="waves" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M-160 44c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z" fill="var(--yun-c-cloud)"/></defs><g class="parallax"><use xlink:href="#gentle-wave" x="48" y="0"/><use xlink:href="#gentle-wave" x="48" y="3"/><use xlink:href="#gentle-wave" x="48" y="5"/><use xlink:href="#gentle-wave" x="48" y="7"/></g></svg></div><div class="beian" m="y-2"><a href="https://beian.miit.gov.cn/" target="_blank" rel="noopener">粤ICP备2025395704号</a></div><div class="copyright flex justify-center items-center gap-2" p="1"><span>©<!--[--> 2023 -<!--]--> 2025</span><a class="animate-pulse inline-flex" href="https://www.imlklaus.cn/" target="_blank" title="回到首页"><div class="i-ri-heart-line"></div></a><span>imklaus</span></div><div class="powered" m="2"><span>由 <a href="https://github.com/YunYouJun/valaxy" target="_blank" rel="noopener">Valaxy</a> <span class="op-60">v0.22.17</span> 驱动</span><span mx-1>|</span><span><span>主题</span><span mx-1>-</span><a href="https://github.com/YunYouJun/valaxy/tree/main/packages/valaxy-theme-yun" title="valaxy-theme-yun" target="_blank">Yun</a><span class="ml-1 op-60">v0.22.17</span></span></div><!--[--><!-- 自定义页脚内容 --><!-- <div>本站总访问量 <span id="busuanzi_value_site_pv" /> 次</div>
    <div>本站访客数 <span id="busuanzi_value_site_uv" /> 人次</div> --><!-- <div class="support flex justify-center items-center">
    本网站由
    <a class="inline-flex items-center" h="8" m="x-2" href="https://www.upyun.com" title="又拍云">
      <div class="upyun-logo" />
    </a>
    提供 CDN 加速
  </div> --><div class="vc-site-live-time col" mt="2"><!--[--><span>本站已勉强运行</span><!--]--><span mx-1>0 天</span><span mx-1>0 小时</span><span mx-1>0 分</span><span mx-1>0 秒</span><!--[--><span>(っ•̀ω•́)っ✎⁾⁾</span><!--]--></div><!--]--><div class="yun-footer-gradient" style="--gradient-from:161 196 253;--gradient-to:194 233 251"></div></footer><!--]--><!--]--></div><script>window.__INITIAL_STATE__='{"pinia":{"yun-app":{},"app":{"isMobile":false,"showLoading":true},"site":{},"routerStore":{}}}'</script></body></html>