<!DOCTYPE html><html lang="en" data-beasties-container><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><link rel="icon" href="/favicon/dinosaur-egg.png"><script>!function(){const e=window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches,t=localStorage.getItem("vueuse-color-scheme")||"auto";("dark"===t||e&&"light"!==t)&&document.documentElement.classList.toggle("dark",!0)}()</script><style type="text/css">:root{color-scheme:light dark;--va-c-bg:#fff}html{background-color:var(--va-c-bg)}.yun-cloud{display:flex;width:100%;z-index:var(--yun-z-cloud);box-sizing:border-box}.yun-cloud .waves{display:flex;position:relative;width:100%;height:40px}.yun-cloud .parallax>use{animation:move-forever 25s cubic-bezier(.55,.5,.45,.5) infinite}.yun-cloud .parallax>use:first-child{opacity:.7;animation-delay:-2s;animation-duration:7s}.yun-cloud .parallax>use:nth-child(2){opacity:.5;animation-delay:-3s;animation-duration:10s}.yun-cloud .parallax>use:nth-child(3){opacity:.3;animation-delay:-4s;animation-duration:13s}.yun-cloud .parallax>use:nth-child(4){animation-delay:-5s;animation-duration:20s}@keyframes move-forever{0%{transform:translate3d(-90px,0,0)}to{transform:translate3d(85px,0,0)}}.yun-footer{letter-spacing:.05rem;line-height:1.8}.yun-footer-gradient{position:absolute;bottom:0;left:0;right:0;width:100%;height:300px;z-index:999;pointer-events:none;background:linear-gradient(to right,rgb(var(--gradient-from)/.2) 0,rgb(var(--gradient-to)/.2));-webkit-mask-image:linear-gradient(#fff0,#000 70%);mask-image:linear-gradient(#fff0,#000 70%);animation:fade-in 2s}.va-toc[data-v-2cefcb73]{text-align:left}.content[data-v-2cefcb73]{position:relative;padding-left:16px;font-size:14px;text-align:left}.outline-marker[data-v-2cefcb73]{position:absolute;top:32px;left:-2px;z-index:0;opacity:0;width:4px;height:18px;background-color:var(--va-c-brand);transition:top .25s cubic-bezier(0,1,.5,1),background-color .5s,opacity .25s;border-top-right-radius:2px;border-bottom-right-radius:2px}.outline-title[data-v-2cefcb73]{letter-spacing:.4px;line-height:28px;font-size:14px;font-weight:600}.visually-hidden[data-v-2cefcb73]{position:absolute;width:1px;height:1px;white-space:nowrap;clip:rect(0 0 0 0);clip-path:inset(50%);overflow:hidden}.yun-aside{width:0;transform:translate(100%);transition:all .2s cubic-bezier(.77,0,.17,1.02);max-height:calc(100vh - var(--yun-margin-top))}@media screen and (min-width:1280px){.yun-aside{transform:translate(0)}}.toc-btn{color:var(--va-c-primary);z-index:var(--yun-z-toc-btn)}.back-to-top{position:fixed;right:-1.5rem;bottom:1rem;z-index:var(--yun-z-go-up-btn);opacity:0;pointer-events:none;color:var(--va-c-primary);transform:translate(0) rotate(270deg);transition:all var(--va-transition-duration),opacity var(--va-transition-duration-fast)!important}.progress-circle{transition:.3s stroke-dashoffset;transform:rotate(-90deg);transform-origin:50% 50%}.progress-circle-container{position:absolute}.spinner[data-v-e7dc65c9]{width:60px;height:60px;border:1px solid var(--va-c-primary);margin:100px auto;animation:rotateplane-e7dc65c9 1.2s infinite ease-in-out}@keyframes rotateplane-e7dc65c9{0%{transform:perspective(120px) rotateX(0) rotateY(0)}50%{transform:perspective(120px) rotateX(-180.1deg) rotateY(0)}to{transform:perspective(120px) rotateX(-180deg) rotateY(-180deg)}}.yun-bg{position:fixed;width:100%;height:100%;z-index:-1;top:0;left:0;background-image:var(--yun-bg-img);background-size:cover;background-position:center;background-repeat:no-repeat;background-attachment:fixed;animation-name:bg-fade-in;animation-duration:2s;opacity:var(--yun-bg-img-opacity, 1)}@supports (-webkit-touch-callout:none){.yun-bg{background-attachment:scroll}}@keyframes bg-fade-in{0%{opacity:0}to{opacity:var(--yun-bg-img-opacity, 1)}}canvas.fireworks{position:fixed;left:0;top:0;z-index:1;pointer-events:none}.yun-page-header-gradient{position:absolute;top:0;left:0;right:0;width:100%;height:500px;z-index:var(--yun-z-page-gradient);pointer-events:none;background:linear-gradient(to right,rgb(var(--gradient-from)/.2) 0,rgb(var(--gradient-to)/.2));-webkit-mask-image:linear-gradient(#000,#fff0 70%);mask-image:linear-gradient(#000,#fff0 70%);animation:fade-in 2s}:root{--p-overlay-popover-shadow:0px 4px 6px -1px rgb(0 0 0 / .1),0px 2px 4px -2px rgb(0 0 0 / .1);--p-overlay-popover-border-radius:4px;--p-tooltip-max-width:12.5rem;--p-tooltip-gutter:.25rem;--p-tooltip-shadow:var(--p-overlay-popover-shadow);--p-tooltip-padding:.25rem .75rem;--p-tooltip-border-radius:var(--p-overlay-popover-border-radius);--p-tooltip-background:var(--va-c-bg);--p-tooltip-color:var(--va-c-text)}*,:after,:before{box-sizing:border-box;border-width:0;border-style:solid;border-color:var(--un-default-border-color,#e5e7eb)}html{line-height:1.5;-webkit-text-size-adjust:100%;-moz-tab-size:4;tab-size:4;font-family:ui-sans-serif,system-ui,sans-serif,"Apple Color Emoji","Segoe UI Emoji",Segoe UI Symbol,"Noto Color Emoji";font-feature-settings:normal;font-variation-settings:normal;-webkit-tap-highlight-color:transparent}body{margin:0;line-height:inherit}a{color:inherit;text-decoration:inherit}code,pre{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,Liberation Mono,Courier New,monospace;font-feature-settings:normal;font-variation-settings:normal;font-size:1em}button{font-family:inherit;font-feature-settings:inherit;font-variation-settings:inherit;font-size:100%;font-weight:inherit;line-height:inherit;color:inherit;margin:0;padding:0}button{text-transform:none}button{-webkit-appearance:button;background-image:none}blockquote,figure,h1,h2,h3,h4,hr,p,pre{margin:0}ol,ul{list-style:none;margin:0;padding:0}button{cursor:pointer}body{counter-reset:katexEqnNo mmlEqnNo}:root{--va-c-border:#c2c2c4;--va-c-divider:#e2e2e3;--va-c-gutter:#e2e2e3}:root{--va-c-gray-1:#dddde3;--va-c-gray-2:#e4e4e9;--va-c-gray-3:#ebebef;--va-c-gray-soft:rgba(142, 150, 170, .14);--va-c-indigo-1:#3451b2;--va-c-indigo-2:#3a5ccc;--va-c-indigo-3:#5672cd;--va-c-indigo-soft:rgba(100, 108, 255, .14);--va-c-green-1:#18794e;--va-c-green-2:#299764;--va-c-green-3:#30a46c;--va-c-green-soft:rgba(16, 185, 129, .14);--va-c-yellow-1:#915930;--va-c-yellow-2:#946300;--va-c-yellow-3:#9f6a00;--va-c-yellow-soft:rgba(234, 179, 8, .14);--va-c-red-1:#b8272c;--va-c-red-2:#d5393e;--va-c-red-3:#e0575b;--va-c-red-soft:rgba(244, 63, 94, .14);--va-c-sponsor:#db2777}:root{--va-c-default-1:var(--va-c-gray-1);--va-c-default-2:var(--va-c-gray-2);--va-c-default-3:var(--va-c-gray-3);--va-c-default-soft:var(--va-c-gray-soft);--va-c-brand-1:var(--va-c-indigo-1);--va-c-brand-2:var(--va-c-indigo-2);--va-c-brand-3:var(--va-c-indigo-3);--va-c-brand-soft:var(--va-c-indigo-soft);--va-c-brand:var(--va-c-brand-1);--va-c-tip-1:var(--va-c-brand-1);--va-c-tip-2:var(--va-c-brand-2);--va-c-tip-3:var(--va-c-brand-3);--va-c-tip-soft:var(--va-c-brand-soft);--va-c-warning-1:var(--va-c-yellow-1);--va-c-warning-2:var(--va-c-yellow-2);--va-c-warning-3:var(--va-c-yellow-3);--va-c-warning-soft:var(--va-c-yellow-soft);--va-c-danger-1:var(--va-c-red-1);--va-c-danger-2:var(--va-c-red-2);--va-c-danger-3:var(--va-c-red-3);--va-c-danger-soft:var(--va-c-red-soft)}:root{--va-aside-width:256px;--va-sidebar-width:300px;--va-border-width:1px;--va-font-serif:"Noto Serif SC",DM Serif Display,STZhongsong,STKaiti,KaiTi,Roboto,serif;--va-font-sans:DM Sans,Inter,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Oxygen,Ubuntu,Cantarell,"Fira Sans","Droid Sans","Helvetica Neue",sans-serif;--va-font-mono:DM Mono,Menlo,Monaco,Consolas,"Courier New",monospace;--va-transition-duration-fast:.2s;--va-transition-duration:.4s;--va-transition-duration-slow:.6s;--va-transition:all var(--va-transition-duration-fast) ease-in-out}:root{--va-c-white:#fff;--va-c-black:#1a1a1a;--va-c-gray:#8e8e8e;--va-c-danger:#db2828;--va-c-warning:#f2711c;--va-c-text-light-1:#213547;--va-c-text-light-2:rgba(60, 60, 60, .7);--va-c-text-light-3:rgba(60, 60, 60, .33);--va-c-text-light-4:rgba(60, 60, 60, .18);--va-c-text-dark-1:rgba(255, 255, 255, .87);--va-c-text-dark-2:rgba(235, 235, 235, .6);--va-c-text-dark-3:rgba(235, 235, 235, .38);--va-c-text-dark-4:rgba(235, 235, 235, .18);--va-c-primary-light:rgb(192.9, 91.2, 255);--va-c-primary-lighter:rgb(199.8, 109.4, 255);--va-c-primary-dark:rgb(173.5648351648, 40.2, 255);--va-c-primary:#BA49FF}:root{color-scheme:light;--va-c-brand:#BA49FF;--va-border-color:#222;--va-c-text:#333;--va-c-text-light:#555;--va-c-text-lighter:#666;--va-c-text-dark:#111;--va-c-primary-rgb:186,73,255;--va-c-link:var(--va-c-primary-dark)}:root{--va-c-text-1:rgba(60, 60, 67);--va-c-text-2:rgba(60, 60, 67, .78);--va-c-text-3:rgba(60, 60, 67, .56)}:root{--va-c-bg:#ffffff;--va-c-bg-light:#ffffff;--va-c-bg-dark:#fafafa;--va-c-bg-opacity:rgba(255, 255, 255, .8);--va-c-bg-soft:#f9f9f9;--va-c-bg-alt:#f9f9f9;--va-c-bg-mute:#f1f1f1}:root{--va-code-line-height:1.7;--va-code-font-size:.875em;--va-code-block-color:var(--va-c-text-2);--va-code-block-bg:var(--va-c-bg-alt);--va-code-block-divider-color:var(--va-c-gutter);--va-code-lang-color:var(--va-c-text-3);--va-code-line-highlight-color:var(--va-c-default-soft);--va-code-line-number-color:var(--va-c-text-3);--va-code-line-diff-add-color:var(--va-c-green-soft);--va-code-line-diff-add-symbol-color:var(--va-c-green-1);--va-code-line-diff-remove-color:var(--va-c-red-soft);--va-code-line-diff-remove-symbol-color:var(--va-c-red-1);--va-code-line-warning-color:var(--va-c-yellow-soft);--va-code-line-error-color:var(--va-c-red-soft);--va-code-copy-code-border-color:var(--va-c-divider);--va-code-copy-code-bg:var(--va-c-bg-soft);--va-code-copy-code-hover-border-color:var(--va-c-divider);--va-code-copy-code-hover-bg:var(--va-c-bg);--va-code-copy-code-active-text:var(--va-c-text-2);--va-code-copy-copied-text-content:"Copied";--va-code-tab-divider:var(--va-code-block-divider-color);--va-code-tab-text-color:var(--va-c-text-2);--va-code-tab-bg:var(--va-code-block-bg);--va-code-tab-hover-text-color:var(--va-c-text-1);--va-code-tab-active-text-color:var(--va-c-text-1);--va-code-tab-active-bar-color:var(--va-c-brand-1)}:root{--va-icon-copy:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' height='20' width='20' stroke='rgba(128,128,128,1)' stroke-width='2' class='h-6 w-6' viewBox='0 0 24 24'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' d='M9 5H7a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2h-2M9 5a2 2 0 0 0 2 2h2a2 2 0 0 0 2-2M9 5a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2'/%3E%3C/svg%3E");--va-icon-copied:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' height='20' width='20' stroke='rgba(128,128,128,1)' stroke-width='2' class='h-6 w-6' viewBox='0 0 24 24'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' d='M9 5H7a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2h-2M9 5a2 2 0 0 0 2 2h2a2 2 0 0 0 2-2M9 5a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2m-6 9 2 2 4-4'/%3E%3C/svg%3E");--va-icon-collapse:url("data:image/svg+xml,%3Csvg%20xmlns='http://www.w3.org/2000/svg'%20width='32'%20height='32' stroke='rgba(128,128,128,1)' viewBox='0%200%2024%2024'%3E%3Cpath%20fill='currentColor'%20d='m12%2016.175l3.9-3.875q.275-.275.688-.288t.712.288q.275.275.275.7t-.275.7l-4.6%204.6q-.15.15-.325.213t-.375.062q-.2%200-.375-.063T11.3%2018.3l-4.6-4.6q-.275-.275-.288-.687T6.7%2012.3q.275-.275.7-.275t.7.275l3.9%203.875Zm0-6L15.9%206.3q.275-.275.688-.287t.712.287q.275.275.275.7t-.275.7l-4.6%204.6q-.15.15-.325.213t-.375.062q-.2%200-.375-.062T11.3%2012.3L6.7%207.7q-.275-.275-.288-.688T6.7%206.3q.275-.275.7-.275t.7.275l3.9%203.875Z'/%3E%3C/svg%3E")}:root{--va-header-anchor-symbol:"#"}html{-webkit-tap-highlight-color:transparent;font-family:var(--va-font-sans)}a{color:var(--va-c-link);font-weight:500}*{outline:0}hr{margin:1rem}button{background-color:transparent}#app,body,html{margin:0;padding:0;line-height:2}html{background-color:var(--va-c-bg)}a{cursor:pointer}:root{--yun-margin-top:68px;--yun-home-hero-image-filter:blur(48px);--yun-home-hero-name-background:-webkit-linear-gradient(120deg, var(--va-c-text) 30%, black);--yun-home-hero-image-background-image:linear-gradient(-45deg, #bd34fe 50%, #47caff 50%);--yun-nav-height:50px}:root{--yun-post-card-max-width:900px;--yun-c-cloud:white;--yun-z-select:6;--yun-z-cloud:7;--yun-z-go-down:9;--yun-z-backdrop:9;--yun-z-sidebar:10;--yun-z-fireworks:11;--yun-z-toc-btn:11;--yun-z-go-up-btn:20;--yun-z-fullscreen-menu:21;--yun-z-nav-menu:22;--yun-z-menu-btn:22;--yun-z-search-popup:30;--yun-z-search-btn:31;--yun-z-overlay:32;--yun-z-aside:33;--yun-z-left-sidebar:34;--yun-z-left-sidebar-menu:35;--yun-z-page-gradient:35;--yun-z-dock:999999;--va-z-overlay:var(--yun-z-backdrop)}:root{--yun-bg-img:url(/assets/bg-img.kXdNMxcF.jpg);--yun-sidebar-bg-color:var(--va-c-bg-light);--yun-sidebar-bg-img:url(/assets/sidebar-bg-img.mp54gEws.webp)}@media screen and (max-width:768px){:root{--rect-margin:16px}}@media screen and not (max-width:768px){:root{--rect-margin:48px}}.post-category{color:var(--va-c-text)}.post-tag{white-space:nowrap;color:var(--yun-tag-color)}.post-tag:hover{color:var(--va-c-primary)}html{overflow-y:scroll}:root{--smc-font-sans:Raleway,-apple-system,"PingFang SC","Microsoft YaHei",Arial,sans-serif;--smc-font-serif:"Songti SC","Noto Serif SC",STZhongsong,STKaiti,KaiTi,Roboto,serif;--smc-font-mono:Menlo,Monaco,Consolas,"Courier New",monospace}:root{--smc-c-primary-light:rgb(224.6703296703, 175, 255);--smc-c-primary-lighter:rgb(253.6730769231, 251.5, 255);--smc-c-primary:#BA49FF;--smc-theme-name:yun;--smc-line-height:1.8;--smc-c-primary-rgb:186,73,255;--smc-c-text:#24292e;--smc-c-text-light:#555;--smc-c-text-lighter:#666;--smc-header-bottom-color:#eaecef;--smc-border-color:var(--smc-c-primary-light);--smc-code-bg-color:#f6f8fa;--smc-link-color:rgb(166.6648351648, 22, 255)}.markdown-body{-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%;background:var(--smc-bg-color);color:var(--smc-c-text);font-family:var(--smc-font-sans);font-size:1rem;line-height:var(--smc-line-height);overflow-wrap:break-word}.markdown-body *{box-sizing:border-box}.markdown-body a{background-color:transparent}.markdown-body a:active,.markdown-body a:hover{outline-width:0}.markdown-body hr{background-color:var(--smc-c-primary,#333);height:2px;margin:1.5rem 0}.markdown-body blockquote{margin:1rem 0;padding:0 1rem;border-left:.25em solid var(--smc-border-color)}.markdown-body code,.markdown-body pre{font-family:Source Code Pro,Consolas,Monaco,SFMono-Regular,Ubuntu Mono,Menlo,monospace}.markdown-body code{padding:3px 6px;font-size:.85rem;color:var(--smc-c-text-light);background:var(--smc-code-bg-color);border-radius:3px}.markdown-body pre{margin-top:0;margin-bottom:0;overflow-wrap:normal;padding:1rem;overflow:auto;background-color:var(--smc-code-bg-color);border-radius:3px}.markdown-body pre>code{font-size:.85rem;white-space:pre}.markdown-body pre code{display:block;padding:0;margin:0;overflow:visible;line-height:inherit;word-break:normal;background-color:transparent;border:0}.markdown-body img{display:block;margin:1rem auto;max-width:92%;max-height:600px;border-radius:.2rem;transition:.4s;--tw-shadow:0 1px 3px 0 rgb(0 0 0/.1),0 1px 2px -1px rgb(0 0 0/.1);--tw-shadow-colored:0 1px 3px 0 var(--tw-shadow-color),0 1px 2px -1px var(--tw-shadow-color);-webkit-box-shadow:var(--tw-ring-offset-shadow,0 0 transparent),var(--tw-ring-shadow,0 0 transparent),var(--tw-shadow);box-shadow:var(--tw-ring-offset-shadow,0 0 transparent),var(--tw-ring-shadow,0 0 transparent),var(--tw-shadow)}.markdown-body img:hover{--tw-shadow:0 4px 6px -1px rgb(0 0 0/.1),0 2px 4px -2px rgb(0 0 0/.1);--tw-shadow-colored:0 4px 6px -1px var(--tw-shadow-color),0 2px 4px -2px var(--tw-shadow-color)}.markdown-body img:before{content:"「 LOADING ERROR 」"}@media screen and (min-width:1600px){.markdown-body img{max-width:800px}}.markdown-body a{color:var(--smc-c-primary);text-decoration:none;border-bottom:1px solid transparent;transition:all .2s ease-in-out}.markdown-body a:hover{color:var(--smc-link-color);border-bottom:1px solid var(--smc-link-color)}.markdown-body a:not([href]){color:inherit;text-decoration:none}.markdown-body ol,.markdown-body ul{padding-left:2em}.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:0;margin-bottom:0}.markdown-body ul ul ol{list-style-type:lower-alpha}.markdown-body ul ol{list-style-type:lower-roman}.markdown-body li{overflow-wrap:break-all;margin-top:.25em}.markdown-body li>p{margin-top:16px}.markdown-body table{width:100%;overflow:auto;border-spacing:0;border-collapse:collapse}.markdown-body table td,.markdown-body table th{padding:6px 13px;border:1px solid var(--smc-c-primary-light,#999)}.markdown-body table thead th{font-weight:600}.markdown-body table>tbody>tr:hover{background-color:rgba(var(--smc-c-primary-rgb),.1)}.markdown-body strong{font-family:var(--smc-font-serif);font-weight:900}.markdown-body p{margin-top:1rem;margin-bottom:1rem;overflow-x:auto;overflow-y:hidden}.markdown-body h2,.markdown-body h3,.markdown-body h4{margin-top:1.5rem;margin-bottom:1rem;font-weight:300;line-height:1.5}.markdown-body h2{font-size:2.2rem;border-bottom:1px solid var(--smc-header-bottom-color)}.markdown-body h3{font-size:1.9rem}.markdown-body h4{font-size:1.6rem}@media screen and (max-width:768px){.markdown-body h2{font-size:1.8rem}.markdown-body h3{font-size:1.6rem}.markdown-body h4{font-size:1.4rem}}.yun-icon-btn{background-color:transparent;cursor:pointer;display:inline-flex;align-items:center;justify-content:center;border:none;width:3rem;height:3rem;border-radius:50%;transition:background-color var(--va-transition-duration)}.yun-icon-btn div{font-size:1.2rem}.yun-icon-btn:hover{background-color:rgba(var(--va-c-primary-rgb),.08)}.yun-icon-btn:active{background-color:rgba(var(--va-c-primary-rgb),.16)}.markdown-body{--smc-font-sans:var(--va-font-sans);--smc-font-serif:var(--va-font-serif);--smc-font-mono:var(--va-font-mono);--c-toc-link:var(--va-c-text-light)}.markdown-body{word-wrap:break-word}.markdown-body a{color:var(--va-c-link)}.markdown-body h2,.markdown-body h3,.markdown-body h4{font-family:var(--va-font-serif);font-weight:900}.markdown-body ul{list-style:initial}.markdown-body ul li>p{margin-bottom:0}.markdown-body ol>li{list-style:decimal}.markdown-body img{margin:.5rem auto;height:auto;max-width:min(92%,800px)}.markdown-body p{overflow:unset}.markdown-body hr{opacity:.6;height:2px;border-top-width:0;background-color:var(--va-c-text)}@media(max-width:767.9px){.markdown-body{padding:.5rem}}@media screen and (max-width:640px){.markdown-body div[class*=language-]{position:relative;margin:16px -24px 0;height:auto}}html:not(.dark) .vp-code span{color:var(--shiki-light,inherit)}:root{--va-custom-block-font-size:14px;--va-custom-block-code-font-size:13px;--va-custom-block-info-border:transparent;--va-custom-block-info-text:var(--va-c-text-1);--va-custom-block-info-bg:var(--va-c-default-soft);--va-custom-block-info-code-bg:var(--va-c-default-soft);--va-custom-block-tip-border:transparent;--va-custom-block-tip-text:var(--va-c-text-1);--va-custom-block-tip-bg:var(--va-c-brand-soft);--va-custom-block-tip-code-bg:var(--va-c-brand-soft);--va-custom-block-warning-border:transparent;--va-custom-block-warning-text:var(--va-c-text-1);--va-custom-block-warning-bg:var(--va-c-warning-soft);--va-custom-block-warning-code-bg:var(--va-c-warning-soft);--va-custom-block-danger-border:transparent;--va-custom-block-danger-text:var(--va-c-text-1);--va-custom-block-danger-bg:var(--va-c-danger-soft);--va-custom-block-danger-code-bg:var(--va-c-danger-soft);--va-custom-block-details-border:var(--va-custom-block-info-border);--va-custom-block-details-text:var(--va-custom-block-info-text);--va-custom-block-details-bg:var(--va-custom-block-info-bg);--va-custom-block-details-code-bg:var(--va-custom-block-info-code-bg)}:root{--vp-code-block-bg:var(--va-c-bg-alt);--vp-code-tab-divider:var(--va-c-gutter)}@media screen and (max-width:640px){.markdown-body div[class*=language-]{margin:0 var(--va-code-mobile-margin-x,-1rem)}}@media(min-width:640px){.markdown-body div[class*=language-]{border-radius:6px;margin:16px 0}}@media(max-width:639.9px){.markdown-body li div[class*=language-]{border-radius:6px 0 0 6px}}.markdown-body code{font-size:.85em}.markdown-body div[class*=language-]{overflow:auto hidden;position:relative;background-color:var(--va-code-block-bg)}.markdown-body [class*=language-] code,.markdown-body [class*=language-] pre{direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;tab-size:4;-webkit-hyphens:none;hyphens:none}.markdown-body [class*=language-] pre{position:relative;z-index:1;margin:0;padding:20px 0;background:0 0;overflow-x:auto}.markdown-body [class*=language-] code{display:block;padding:0 24px;width:fit-content;min-width:100%;line-height:var(--va-code-line-height);font-size:var(--va-code-font-size);color:var(--va-code-block-color);transition:color .5s}.markdown-body [class*=language-]>button.copy{direction:ltr;position:absolute;top:12px;right:12px;z-index:3;border:1px solid var(--va-code-copy-code-border-color);border-radius:4px;width:40px;height:40px;background-color:var(--va-code-copy-code-bg);opacity:0;cursor:pointer;background-image:var(--va-icon-copy);background-position:50%;background-size:20px;background-repeat:no-repeat;transition:border-color .25s,background-color .25s,opacity .25s}.markdown-body [class*=language-]:hover>button.copy,.markdown-body [class*=language-]>button.copy:focus{opacity:1}.markdown-body [class*=language-]>button.copy:hover{border-color:var(--va-code-copy-code-hover-border-color);background-color:var(--va-code-copy-code-hover-bg)}.markdown-body [class*=language-]>span.lang{position:absolute;top:2px;right:8px;z-index:2;font-size:12px;font-weight:500;color:var(--va-code-lang-color);transition:color .4s,opacity .4s}.markdown-body [class*=language-]:hover>button.copy+span.lang,.markdown-body [class*=language-]>button.copy:focus+span.lang{opacity:0}.markdown-body [class*=language-]>button.code-block-unfold-btn{display:none;position:absolute;z-index:10;bottom:0;left:0;width:100%;height:24px;opacity:1;cursor:pointer;background-image:linear-gradient(-180deg,rgba(0,0,0,0) 0,var(--va-c-bg-dark) 100%)}.markdown-body [class*=language-]>button.code-block-unfold-btn:before{display:block;content:"";width:100%;height:100%;background-image:var(--va-icon-collapse);background-position:50%;background-size:16px;background-repeat:no-repeat}.markdown-body h2,.markdown-body h3,.markdown-body h4{position:relative;font-weight:600;outline:0}.markdown-body figure{text-align:center}.markdown-body .end .line{height:1px}.markdown-body .header-anchor{position:absolute;top:0;left:0;margin-left:-.87em;font-weight:500;-webkit-user-select:none;user-select:none;opacity:0;text-decoration:none;transition:color .25s,opacity .25s}.markdown-body .header-anchor:before{content:var(--va-header-anchor-symbol, "#")}.markdown-body .header-anchor:before:hover{text-decoration:none}.markdown-body h2 .header-anchor:focus,.markdown-body h2:hover .header-anchor,.markdown-body h3 .header-anchor:focus,.markdown-body h3:hover .header-anchor,.markdown-body h4 .header-anchor:focus,.markdown-body h4:hover .header-anchor{opacity:1}html{transition:background-color .6s}:root{--va-font-serif:""Noto Serif SC", STZhongsong, STKaiti, KaiTi, Roboto,  serif";--va-c-bg-light:rgba(255, 255, 255, .8)}@supports ((-webkit-hyphens:none) and (not (margin-trim:inline))) or ((-moz-orient:inline) and (not (color:rgb(from red r g b)))){*,:after,:before{--un-scale-x:1;--un-scale-y:1;--un-scale-z:1;--un-leading:initial;--un-bg-opacity:100%;--un-ease:initial;--un-translate-x:initial;--un-translate-y:initial;--un-translate-z:initial;--un-rotate-x:rotateX(0);--un-rotate-y:rotateY(0);--un-rotate-z:rotateZ(0);--un-skew-x:skewX(0);--un-skew-y:skewY(0);--un-text-opacity:100%;--un-border-opacity:100%;--un-from-opacity:100%;--un-to-opacity:100%;--un-border-bottom-opacity:100%}}@property --un-text-opacity{syntax:"<percentage>";inherits:falseinitial-value:100%}@property --un-leading{syntax:"*"inherits:false}@property --un-outline-style{syntax:"*";inherits:falseinitial-value:solid}@property --un-border-opacity{syntax:"<percentage>";inherits:falseinitial-value:100%}@property --un-border-bottom-opacity{syntax:"<percentage>";inherits:falseinitial-value:100%}@property --un-bg-opacity{syntax:"<percentage>";inherits:falseinitial-value:100%}@property --un-inset-ring-color{syntax:"*"inherits:false}@property --un-inset-ring-shadow{syntax:"*";inherits:falseinitial-value:0 0 #0000}@property --un-inset-shadow{syntax:"*";inherits:falseinitial-value:0 0 #0000}@property --un-inset-shadow-color{syntax:"*"inherits:false}@property --un-ring-color{syntax:"*"inherits:false}@property --un-ring-inset{syntax:"*"inherits:false}@property --un-ring-offset-color{syntax:"*"inherits:false}@property --un-ring-offset-shadow{syntax:"*";inherits:falseinitial-value:0 0 #0000}@property --un-ring-offset-width{syntax:"<length>";inherits:falseinitial-value:0px}@property --un-ring-shadow{syntax:"*";inherits:falseinitial-value:0 0 #0000}@property --un-shadow{syntax:"*";inherits:falseinitial-value:0 0 #0000}@property --un-shadow-color{syntax:"*"inherits:false}@property --un-translate-x{syntax:"*";inherits:falseinitial-value:0}@property --un-translate-y{syntax:"*";inherits:falseinitial-value:0}@property --un-translate-z{syntax:"*";inherits:falseinitial-value:0}@property --un-rotate-x{syntax:"*";inherits:falseinitial-value:rotateX(0)}@property --un-rotate-y{syntax:"*";inherits:falseinitial-value:rotateY(0)}@property --un-rotate-z{syntax:"*";inherits:falseinitial-value:rotateZ(0)}@property --un-skew-x{syntax:"*";inherits:falseinitial-value:skewX(0)}@property --un-skew-y{syntax:"*";inherits:falseinitial-value:skewY(0)}@property --un-scale-x{syntax:"*";inherits:falseinitial-value:1}@property --un-scale-y{syntax:"*";inherits:falseinitial-value:1}@property --un-scale-z{syntax:"*";inherits:falseinitial-value:1}@property --un-ease{syntax:"*"inherits:false}@property --un-from-opacity{syntax:"<percentage>";inherits:falseinitial-value:100%}@property --un-gradient-from{syntax:"<color>";inherits:falseinitial-value:#0000}@property --un-gradient-from-position{syntax:"<length-percentage>";inherits:falseinitial-value:0%}@property --un-gradient-position{syntax:"*"inherits:false}@property --un-gradient-stops{syntax:"*"inherits:false}@property --un-gradient-to{syntax:"<color>";inherits:falseinitial-value:#0000}@property --un-gradient-to-position{syntax:"<length-percentage>";inherits:falseinitial-value:100%}@property --un-gradient-via{syntax:"<color>";inherits:falseinitial-value:#0000}@property --un-gradient-via-position{syntax:"<length-percentage>";inherits:falseinitial-value:50%}@property --un-gradient-via-stops{syntax:"*"inherits:false}@property --un-to-opacity{syntax:"<percentage>";inherits:falseinitial-value:100%}@property --un-blur{syntax:"*"inherits:false}@property --un-brightness{syntax:"*"inherits:false}@property --un-contrast{syntax:"*"inherits:false}@property --un-drop-shadow{syntax:"*"inherits:false}@property --un-grayscale{syntax:"*"inherits:false}@property --un-hue-rotate{syntax:"*"inherits:false}@property --un-invert{syntax:"*"inherits:false}@property --un-saturate{syntax:"*"inherits:false}@property --un-sepia{syntax:"*"inherits:false}:root{--spacing:.25rem;--default-transition-timingFunction:cubic-bezier(.4, 0, .2, 1);--default-transition-duration:.15s;--container-4xl:56rem;--leading-none:1;--container-2xl:42rem;--colors-white:#fff;--ease-in:cubic-bezier(.4, 0, 1, 1);--container-3xl:48rem;--radius-DEFAULT:.25rem;--ease-in-out:cubic-bezier(.4, 0, .2, 1);--fontWeight-bold:700;--container-sm:24rem;--radius-lg:.5rem;--colors-black:#000;--leading-loose:2;--fontWeight-black:900;--fontWeight-medium:500;--container-md:28rem;--ease-DEFAULT:cubic-bezier(.4, 0, .2, 1);--fontWeight-light:300;--colors-gray-DEFAULT:oklch(70.7% .022 261.325);--colors-red-DEFAULT:oklch(70.4% .191 22.216);--colors-gray-100:oklch(96.7% .003 264.542);--colors-blue-500:oklch(62.3% .214 259.815);--colors-dark-DEFAULT:oklch(25.2% 0 0);--text-2xl-fontSize:1.5rem;--text-2xl-lineHeight:2rem;--text-sm-fontSize:.875rem;--text-sm-lineHeight:1.25rem;--text-xs-fontSize:.75rem;--text-xs-lineHeight:1rem;--text-xl-fontSize:1.25rem;--text-xl-lineHeight:1.75rem;--text-lg-fontSize:1.125rem;--text-lg-lineHeight:1.75rem;--text-base-fontSize:1rem;--text-base-lineHeight:1.5rem;--radius-none:0;--colors-dark-300:oklch(29.72% 0 0);--colors-red-400:oklch(70.4% .191 22.216);--text-4xl-fontSize:2.25rem;--text-4xl-lineHeight:2.5rem;--colors-gray-600:oklch(44.6% .03 256.802);--font-sans:ui-sans-serif,system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";--font-mono:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;--default-font-family:var(--font-sans);--default-monoFont-family:var(--font-mono)}*,:after,:before{box-sizing:border-box;margin:0;padding:0;border:0 solid}html{line-height:1.5;-webkit-text-size-adjust:100%;tab-size:4;font-family:var( --default-font-family, ui-sans-serif, system-ui, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji" );font-feature-settings:var(--default-font-featureSettings,normal);font-variation-settings:var(--default-font-variationSettings,normal);-webkit-tap-highlight-color:transparent}hr{height:0;color:inherit;border-top-width:1px}h1,h2,h3,h4{font-size:inherit;font-weight:inherit}a{color:inherit;-webkit-text-decoration:inherit;text-decoration:inherit}strong{font-weight:bolder}code,pre{font-family:var( --default-monoFont-family, ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace );font-feature-settings:var(--default-monoFont-featureSettings,normal);font-variation-settings:var(--default-monoFont-variationSettings,normal);font-size:1em}table{text-indent:0;border-color:inherit;border-collapse:collapse}ol,ul{list-style:none}canvas,img,svg{display:block;vertical-align:middle}img{max-width:100%;height:auto}button{font:inherit;font-feature-settings:inherit;font-variation-settings:inherit;letter-spacing:inherit;color:inherit;border-radius:0;background-color:transparent;opacity:1}button{appearance:button}.i-ri-alipay-line{--un-icon:url("data:image/svg+xml;utf8,%3Csvg viewBox='0 0 24 24' width='1.2em' height='1.2em' xmlns='http://www.w3.org/2000/svg' %3E%3Cpath fill='currentColor' d='M18.408 16.79q-3.26-1.425-4.64-2.086c-1.4 1.696-2.872 2.72-5.08 2.72S5 16.064 5.176 14.392c.12-1.096.872-2.888 4.128-2.576c1.72.16 2.504.48 3.912.944c.36-.664.664-1.4.888-2.176H7.88v-.616h3.072V8.864H7.2v-.68h3.752V6.592s.032-.248.312-.248H12.8v1.848h4v.68h-4v1.104h3.264a12.4 12.4 0 0 1-1.32 3.32q.765.273 4.76 1.483a8 8 0 1 0-1.096 2.012M12 22C6.477 22 2 17.523 2 12S6.477 2 12 2s10 4.477 10 10s-4.477 10-10 10m-3.568-5.632c1.44 0 2.824-.872 3.96-2.352c-1.608-.776-2.944-1.16-4.44-1.16c-1.304 0-1.984.8-2.104 1.416s.248 2.096 2.584 2.096'/%3E%3C/svg%3E");-webkit-mask:var(--un-icon) no-repeat;mask:var(--un-icon) no-repeat;-webkit-mask-size:100% 100%;mask-size:100% 100%;background-color:currentColor;color:inherit;width:1.2em;height:1.2em}[i-ri-arrow-left-s-line=""]{--un-icon:url("data:image/svg+xml;utf8,%3Csvg viewBox='0 0 24 24' width='1.2em' height='1.2em' xmlns='http://www.w3.org/2000/svg' %3E%3Cpath fill='currentColor' d='m10.828 12l4.95 4.95l-1.414 1.415L8 12l6.364-6.364l1.414 1.414z'/%3E%3C/svg%3E");-webkit-mask:var(--un-icon) no-repeat;mask:var(--un-icon) no-repeat;-webkit-mask-size:100% 100%;mask-size:100% 100%;background-color:currentColor;color:inherit;width:1.2em;height:1.2em}[i-ri-arrow-right-s-line=""]{--un-icon:url("data:image/svg+xml;utf8,%3Csvg viewBox='0 0 24 24' width='1.2em' height='1.2em' xmlns='http://www.w3.org/2000/svg' %3E%3Cpath fill='currentColor' d='m13.172 12l-4.95-4.95l1.414-1.413L16 12l-6.364 6.364l-1.414-1.415z'/%3E%3C/svg%3E");-webkit-mask:var(--un-icon) no-repeat;mask:var(--un-icon) no-repeat;-webkit-mask-size:100% 100%;mask-size:100% 100%;background-color:currentColor;color:inherit;width:1.2em;height:1.2em}[i-ri-arrow-up-s-line=""]{--un-icon:url("data:image/svg+xml;utf8,%3Csvg viewBox='0 0 24 24' width='1.2em' height='1.2em' xmlns='http://www.w3.org/2000/svg' %3E%3Cpath fill='currentColor' d='m12 10.828l-4.95 4.95l-1.414-1.414L12 8l6.364 6.364l-1.414 1.414z'/%3E%3C/svg%3E");-webkit-mask:var(--un-icon) no-repeat;mask:var(--un-icon) no-repeat;-webkit-mask-size:100% 100%;mask-size:100% 100%;background-color:currentColor;color:inherit;width:1.2em;height:1.2em}.i-ri-bluesky-fill{--un-icon:url("data:image/svg+xml;utf8,%3Csvg viewBox='0 0 24 24' width='1.2em' height='1.2em' xmlns='http://www.w3.org/2000/svg' %3E%3Cpath fill='currentColor' d='M12 11.388c-.906-1.761-3.372-5.044-5.665-6.662c-2.197-1.55-3.034-1.283-3.583-1.033C2.116 3.978 2 4.955 2 5.528c0 .575.315 4.709.52 5.4c.68 2.28 3.094 3.05 5.32 2.803c-3.26.483-6.157 1.67-2.36 5.898c4.178 4.325 5.726-.927 6.52-3.59c.794 2.663 1.708 7.726 6.444 3.59c3.556-3.59.977-5.415-2.283-5.898c2.225.247 4.64-.523 5.319-2.803c.205-.69.52-4.825.52-5.399c0-.575-.116-1.55-.752-1.838c-.549-.248-1.386-.517-3.583 1.033c-2.293 1.621-4.76 4.904-5.665 6.664'/%3E%3C/svg%3E");-webkit-mask:var(--un-icon) no-repeat;mask:var(--un-icon) no-repeat;-webkit-mask-size:100% 100%;mask-size:100% 100%;background-color:currentColor;color:inherit;width:1.2em;height:1.2em}[i-ri-calendar-line=""]{--un-icon:url("data:image/svg+xml;utf8,%3Csvg viewBox='0 0 24 24' width='1.2em' height='1.2em' xmlns='http://www.w3.org/2000/svg' %3E%3Cpath fill='currentColor' d='M9 1v2h6V1h2v2h4a1 1 0 0 1 1 1v16a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V4a1 1 0 0 1 1-1h4V1zm11 10H4v8h16zM7 5H4v4h16V5h-3v2h-2V5H9v2H7z'/%3E%3C/svg%3E");-webkit-mask:var(--un-icon) no-repeat;mask:var(--un-icon) no-repeat;-webkit-mask-size:100% 100%;mask-size:100% 100%;background-color:currentColor;color:inherit;width:1.2em;height:1.2em}[i-ri-chat-4-line=""]{--un-icon:url("data:image/svg+xml;utf8,%3Csvg viewBox='0 0 24 24' width='1.2em' height='1.2em' xmlns='http://www.w3.org/2000/svg' %3E%3Cpath fill='currentColor' d='M5.763 17H20V5H4v13.385zm.692 2L2 22.5V4a1 1 0 0 1 1-1h18a1 1 0 0 1 1 1v14a1 1 0 0 1-1 1z'/%3E%3C/svg%3E");-webkit-mask:var(--un-icon) no-repeat;mask:var(--un-icon) no-repeat;-webkit-mask-size:100% 100%;mask-size:100% 100%;background-color:currentColor;color:inherit;width:1.2em;height:1.2em}[i-ri-file-list-line=""]{--un-icon:url("data:image/svg+xml;utf8,%3Csvg viewBox='0 0 24 24' width='1.2em' height='1.2em' xmlns='http://www.w3.org/2000/svg' %3E%3Cpath fill='currentColor' d='M20 22H4a1 1 0 0 1-1-1V3a1 1 0 0 1 1-1h16a1 1 0 0 1 1 1v18a1 1 0 0 1-1 1m-1-2V4H5v16zM8 7h8v2H8zm0 4h8v2H8zm0 4h8v2H8z'/%3E%3C/svg%3E");-webkit-mask:var(--un-icon) no-repeat;mask:var(--un-icon) no-repeat;-webkit-mask-size:100% 100%;mask-size:100% 100%;background-color:currentColor;color:inherit;width:1.2em;height:1.2em}[i-ri-file-word-line=""]{--un-icon:url("data:image/svg+xml;utf8,%3Csvg viewBox='0 0 24 24' width='1.2em' height='1.2em' xmlns='http://www.w3.org/2000/svg' %3E%3Cpath fill='currentColor' d='M16 8v8h-2l-2-2l-2 2H8V8h2v5l2-2l2 2V8h1V4H5v16h14V8zM3 2.992C3 2.444 3.447 2 3.999 2H16l5 5v13.993A1 1 0 0 1 20.007 22H3.993A1 1 0 0 1 3 21.008z'/%3E%3C/svg%3E");-webkit-mask:var(--un-icon) no-repeat;mask:var(--un-icon) no-repeat;-webkit-mask-size:100% 100%;mask-size:100% 100%;background-color:currentColor;color:inherit;width:1.2em;height:1.2em}[i-ri-folder-2-line=""]{--un-icon:url("data:image/svg+xml;utf8,%3Csvg viewBox='0 0 24 24' width='1.2em' height='1.2em' xmlns='http://www.w3.org/2000/svg' %3E%3Cpath fill='currentColor' d='M12.414 5H21a1 1 0 0 1 1 1v14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V4a1 1 0 0 1 1-1h7.414zM20 11H4v8h16zm0-2V7h-8.414l-2-2H4v4z'/%3E%3C/svg%3E");-webkit-mask:var(--un-icon) no-repeat;mask:var(--un-icon) no-repeat;-webkit-mask-size:100% 100%;mask-size:100% 100%;background-color:currentColor;color:inherit;width:1.2em;height:1.2em}[i-ri-heart-fill=""]{--un-icon:url("data:image/svg+xml;utf8,%3Csvg viewBox='0 0 24 24' width='1.2em' height='1.2em' xmlns='http://www.w3.org/2000/svg' %3E%3Cpath fill='currentColor' d='M12.001 4.529a6 6 0 0 1 8.242.228a6 6 0 0 1 .236 8.236l-8.48 8.492l-8.478-8.492a6 6 0 0 1 8.48-8.464'/%3E%3C/svg%3E");-webkit-mask:var(--un-icon) no-repeat;mask:var(--un-icon) no-repeat;-webkit-mask-size:100% 100%;mask-size:100% 100%;background-color:currentColor;color:inherit;width:1.2em;height:1.2em}[i-ri-pushpin-line=""]{--un-icon:url("data:image/svg+xml;utf8,%3Csvg viewBox='0 0 24 24' width='1.2em' height='1.2em' xmlns='http://www.w3.org/2000/svg' %3E%3Cpath fill='currentColor' d='m13.827 1.69l8.486 8.485l-1.415 1.414l-.707-.707l-4.242 4.243l-.707 3.536l-1.415 1.414l-4.242-4.243l-4.95 4.95l-1.414-1.414l4.95-4.95l-4.243-4.243l1.414-1.414l3.536-.707l4.242-4.243l-.707-.707zm.707 3.536l-4.67 4.67l-2.822.565l6.5 6.5l.564-2.822l4.671-4.67z'/%3E%3C/svg%3E");-webkit-mask:var(--un-icon) no-repeat;mask:var(--un-icon) no-repeat;-webkit-mask-size:100% 100%;mask-size:100% 100%;background-color:currentColor;color:inherit;width:1.2em;height:1.2em}.i-ri-qq-line{--un-icon:url("data:image/svg+xml;utf8,%3Csvg viewBox='0 0 24 24' width='1.2em' height='1.2em' xmlns='http://www.w3.org/2000/svg' %3E%3Cpath fill='currentColor' d='m17.536 12.514l-.696-1.796c0-.021.01-.375.01-.558C16.85 7.088 15.447 4 12 4s-4.848 3.088-4.848 6.16c0 .183.009.537.01.557l-.696 1.797c-.19.515-.38 1.05-.517 1.51c-.657 2.189-.444 3.095-.282 3.115c.348.043 1.354-1.648 1.354-1.648c0 .98.487 2.258 1.542 3.18c-.394.127-.878.32-1.188.557c-.28.214-.245.431-.194.52c.22.385 3.79.245 4.82.125c1.03.12 4.599.26 4.82-.126c.05-.088.085-.305-.194-.519c-.311-.237-.795-.43-1.19-.556c1.055-.923 1.542-2.202 1.542-3.181c0 0 1.007 1.691 1.355 1.648c.162-.02.378-.928-.283-3.116a27 27 0 0 0-.516-1.509m1.021 8.227c-.373.652-.833.892-1.438 1.057a5 5 0 0 1-.794.138c-.44.045-.986.065-1.613.064a33 33 0 0 1-2.71-.116c-.692.065-1.785.114-2.71.116a16 16 0 0 1-1.614-.064a5 5 0 0 1-.793-.138c-.605-.164-1.065-.405-1.44-1.059a2.27 2.27 0 0 1-.239-1.652c-.592-.132-1.001-.482-1.279-.911a2.4 2.4 0 0 1-.309-.71a4 4 0 0 1-.116-1.106c.013-.785.187-1.762.532-2.912c.14-.466.327-1.008.567-1.655l.554-1.43l-.002-.203C5.153 5.605 7.589 2 12 2c4.413 0 6.848 3.605 6.848 8.16l-.001.203l.553 1.43l.01.026c.225.606.413 1.153.556 1.626c.348 1.15.522 2.128.535 2.916q.012.61-.118 1.108c-.066.246-.161.48-.31.708c-.276.427-.684.776-1.277.91c.13.554.055 1.14-.24 1.654'/%3E%3C/svg%3E");-webkit-mask:var(--un-icon) no-repeat;mask:var(--un-icon) no-repeat;-webkit-mask-size:100% 100%;mask-size:100% 100%;background-color:currentColor;color:inherit;width:1.2em;height:1.2em}[i-ri-timer-line=""]{--un-icon:url("data:image/svg+xml;utf8,%3Csvg viewBox='0 0 24 24' width='1.2em' height='1.2em' xmlns='http://www.w3.org/2000/svg' %3E%3Cpath fill='currentColor' d='m17.618 5.968l1.453-1.453l1.414 1.414l-1.453 1.453A9 9 0 1 1 12 4c2.125 0 4.078.736 5.618 1.968M12 20a7 7 0 1 0 0-14a7 7 0 0 0 0 14M11 8h2v6h-2zM8 1h8v2H8z'/%3E%3C/svg%3E");-webkit-mask:var(--un-icon) no-repeat;mask:var(--un-icon) no-repeat;-webkit-mask-size:100% 100%;mask-size:100% 100%;background-color:currentColor;color:inherit;width:1.2em;height:1.2em}.i-ri-wechat-pay-line{--un-icon:url("data:image/svg+xml;utf8,%3Csvg viewBox='0 0 24 24' width='1.2em' height='1.2em' xmlns='http://www.w3.org/2000/svg' %3E%3Cpath fill='currentColor' d='m19.146 8.993l-9.799 5.608l-.07.045a.65.65 0 0 1-.3.07a.66.66 0 0 1-.58-.345l-.046-.092l-1.831-3.95c-.023-.046-.023-.092-.023-.138c0-.184.139-.321.324-.321q.105 0 .209.069l2.155 1.515c.162.092.347.161.556.161a.9.9 0 0 0 .348-.069l8.274-3.649C16.935 6.273 14.635 5.2 12.001 5.2c-4.421 0-7.9 3.022-7.9 6.6c0 1.365.5 2.673 1.431 3.78q.073.088.215.236a4 4 0 0 1 1.1 3.102l-.024.297l.715-.436a4 4 0 0 1 2.706-.536q.317.05.52.076q.61.081 1.237.081c4.42 0 7.9-3.022 7.9-6.6c0-.996-.27-1.95-.755-2.807M6.193 21.943a1 1 0 0 1-1.527-.932l.189-2.259a2 2 0 0 0-.55-1.551a7 7 0 0 1-.303-.333C2.806 15.447 2.1 13.695 2.1 11.8c0-4.75 4.432-8.6 9.9-8.6c5.467 0 9.9 3.85 9.9 8.6s-4.433 8.6-9.9 8.6q-.765-.001-1.5-.098q-.229-.03-.568-.084a2 2 0 0 0-1.353.268z'/%3E%3C/svg%3E");-webkit-mask:var(--un-icon) no-repeat;mask:var(--un-icon) no-repeat;-webkit-mask-size:100% 100%;mask-size:100% 100%;background-color:currentColor;color:inherit;width:1.2em;height:1.2em}.va-card{background-color:color-mix(in oklab,var(--va-c-bg-light) var(--un-bg-opacity),transparent);--un-shadow:0 1px 3px 0 var(--un-shadow-color, rgb(0 0 0 / .1)),0 1px 2px -1px var(--un-shadow-color, rgb(0 0 0 / .1));box-shadow:var(--un-inset-shadow),var(--un-inset-ring-shadow),var(--un-ring-offset-shadow),var(--un-ring-shadow),var(--un-shadow)}.flex-center,[flex~=center]{display:flex;align-items:center;justify-content:center}.inline-flex-center{display:inline-flex;align-items:center;justify-content:center}.yun-card{--un-shadow:0 1px 3px 0 var(--un-shadow-color, rgb(0 0 0 / .1)),0 1px 2px -1px var(--un-shadow-color, rgb(0 0 0 / .1));box-shadow:var(--un-inset-shadow),var(--un-inset-ring-shadow),var(--un-ring-offset-shadow),var(--un-ring-shadow),var(--un-shadow);transition-property:all;transition-timing-function:var(--un-ease,var(--default-transition-timingFunction));transition-duration:var(--un-duration, var(--default-transition-duration));transition-duration:var(--va-transition-duration)}.va-card:hover{--un-shadow:0 10px 15px -3px var(--un-shadow-color, rgb(0 0 0 / .1)),0 4px 6px -4px var(--un-shadow-color, rgb(0 0 0 / .1));box-shadow:var(--un-inset-shadow),var(--un-inset-ring-shadow),var(--un-ring-offset-shadow),var(--un-ring-shadow),var(--un-shadow)}.yun-card:hover{--un-shadow:0 25px 50px -12px var(--un-shadow-color, rgb(0 0 0 / .25));box-shadow:var(--un-inset-shadow),var(--un-inset-ring-shadow),var(--un-ring-offset-shadow),var(--un-ring-shadow),var(--un-shadow)}[text~="2xl"]{font-size:var(--text-2xl-fontSize);line-height:var(--un-leading, var(--text-2xl-lineHeight))}[text~=sm]{font-size:var(--text-sm-fontSize);line-height:var(--un-leading, var(--text-sm-lineHeight))}[text~=xl]{font-size:var(--text-xl-fontSize);line-height:var(--un-leading, var(--text-xl-lineHeight))}.text-xs{font-size:var(--text-xs-fontSize);line-height:var(--un-leading, var(--text-xs-lineHeight))}.text-\$va-c-text-light{color:color-mix(in oklab,var(--va-c-text-light) var(--un-text-opacity),transparent)}[text~=red-400]{color:color-mix(in srgb,var(--colors-red-400) var(--un-text-opacity),transparent)}[hover~=text-white]:hover{color:color-mix(in srgb,var(--colors-white) var(--un-text-opacity),transparent)}[color~="$va-c-warning"]{color:color-mix(in oklab,var(--va-c-warning) var(--un-text-opacity),transparent)}.leading-none{--un-leading:var(--leading-none);line-height:var(--leading-none)}[font~=black]{--un-font-weight:var(--fontWeight-black);font-weight:var(--fontWeight-black)}[font~=bold]{--un-font-weight:var(--fontWeight-bold);font-weight:var(--fontWeight-bold)}[m~="0"]{margin:calc(var(--spacing) * 0)}[m~="2"]{margin:calc(var(--spacing) * 2)}.m-auto{margin:auto}[mx-1=""],[m~=x-1]{margin-inline:calc(var(--spacing) * 1)}[m~=y-4]{margin-block:calc(var(--spacing) * 4)}[m~=y-2]{margin-block:calc(var(--spacing) * 2)}[m~="!y-2"]{margin-block:calc(var(--spacing) * 2)!important}[mx~="2"]{margin-inline:calc(var(--spacing) * 2)}.mb-4,[mb~="4"]{margin-bottom:calc(var(--spacing) * 4)}[m~=b-2]{margin-bottom:calc(var(--spacing) * 2)}.ml-1,[ml-1=""]{margin-left:calc(var(--spacing) * 1)}.mt-4{margin-top:calc(var(--spacing) * 4)}.mt-12{margin-top:calc(var(--spacing) * 12)}.mt-14{margin-top:calc(var(--spacing) * 14)}.mt-2{margin-top:calc(var(--spacing) * 2)}.mt-2px{margin-top:2px}[m~=t-6]{margin-top:calc(var(--spacing) * 6)}.mt-8{margin-top:calc(var(--spacing) * 8)}[p~="1"]{padding:calc(var(--spacing) * 1)}[p~="2"]{padding:calc(var(--spacing) * 2)}[p~="4"]{padding:calc(var(--spacing) * 4)}.px-4,[p~=x-4]{padding-inline:calc(var(--spacing) * 4)}[px-2=""]{padding-inline:calc(var(--spacing) * 2)}.py-4{padding-block:calc(var(--spacing) * 4)}[py~="1"]{padding-block:calc(var(--spacing) * 1)}[pb-2=""]{padding-bottom:calc(var(--spacing) * 2)}.pt-0{padding-top:calc(var(--spacing) * 0)}[p~=b-8]{padding-bottom:calc(var(--spacing) * 8)}[text~=center]{text-align:center}[border=""],[border~="~"]{border-width:1px}.border-\$va-c-divider{border-color:color-mix(in oklab,var(--va-c-divider) var(--un-border-opacity),transparent)}[border~=rounded]{border-radius:var(--radius-DEFAULT)}.rounded-2{border-radius:.5rem}[rounded-full=""]{border-radius:calc(infinity * 1px)}[bg~="$va-c-bg-light"]{background-color:color-mix(in oklab,var(--va-c-bg-light) var(--un-bg-opacity),transparent)}.bg-\$va-c-bg-soft{background-color:color-mix(in oklab,var(--va-c-bg-soft) var(--un-bg-opacity),transparent)}[bg~=white]{background-color:color-mix(in srgb,var(--colors-white) var(--un-bg-opacity),transparent)}[bg~="$va-c-bg"]{background-color:color-mix(in oklab,var(--va-c-bg) var(--un-bg-opacity),transparent)}[hover~=bg-blue-500]:hover{background-color:color-mix(in srgb,var(--colors-blue-500) var(--un-bg-opacity),transparent)}.op-60{opacity:60%}.op-80{opacity:80%}.flex,[flex=""],[flex~="~"]{display:flex}.inline-flex,[inline-flex=""]{display:inline-flex}[flex~="1"]{flex:1 1 0%}.flex-grow,[flex~=grow]{flex-grow:1}.flex-col,[flex~=col]{flex-direction:column}[flex~=wrap]{flex-wrap:wrap}.gap-1,[gap~="1"]{gap:calc(var(--spacing) * 1)}.gap-2{gap:calc(var(--spacing) * 2)}.gap-2\!{gap:calc(var(--spacing) * 2)!important}.gap-4{gap:calc(var(--spacing) * 4)}.size-8{width:calc(var(--spacing) * 8);height:calc(var(--spacing) * 8)}[h~="5"]{height:calc(var(--spacing) * 5)}.max-h-300px{max-height:300px}.min-h-sm{min-height:var(--container-sm)}.w-full,[w~=full]{width:100%}[h~="64"]{height:calc(var(--spacing) * 64)}[h~="7"]{height:calc(var(--spacing) * 7)}[min-h~="100px"]{min-height:100px}.inline-block{display:inline-block}.whitespace-nowrap{white-space:nowrap}.truncate{overflow:hidden;text-overflow:ellipsis;white-space:nowrap}.shadow{--un-shadow:0 1px 3px 0 var(--un-shadow-color, rgb(0 0 0 / .1)),0 1px 2px -1px var(--un-shadow-color, rgb(0 0 0 / .1));box-shadow:var(--un-inset-shadow),var(--un-inset-ring-shadow),var(--un-ring-offset-shadow),var(--un-ring-shadow),var(--un-shadow)}.shadow-md{--un-shadow:0 4px 6px -1px var(--un-shadow-color, rgb(0 0 0 / .1)),0 2px 4px -2px var(--un-shadow-color, rgb(0 0 0 / .1));box-shadow:var(--un-inset-shadow),var(--un-inset-ring-shadow),var(--un-ring-offset-shadow),var(--un-ring-shadow),var(--un-shadow)}.hover\:shadow-md:hover{--un-shadow:0 4px 6px -1px var(--un-shadow-color, rgb(0 0 0 / .1)),0 2px 4px -2px var(--un-shadow-color, rgb(0 0 0 / .1));box-shadow:var(--un-inset-shadow),var(--un-inset-ring-shadow),var(--un-ring-offset-shadow),var(--un-ring-shadow),var(--un-shadow)}.transition{transition-property:color,background-color,border-color,text-decoration-color,fill,stroke,--un-gradient-from,--un-gradient-via,--un-gradient-to,opacity,box-shadow,transform,translate,scale,rotate,filter,-webkit-backdrop-filter,backdrop-filter;transition-timing-function:var(--un-ease,var(--default-transition-timingFunction));transition-duration:var(--un-duration, var(--default-transition-duration))}.items-start{align-items:flex-start}.items-center,[items-center=""],[items~=center]{align-items:center}[start~="2"]{inset-inline-start:calc(var(--spacing) * 2)}[start~="3"]{inset-inline-start:calc(var(--spacing) * 3)}[start~="4"]{inset-inline-start:calc(var(--spacing) * 4)}[start~="5"]{inset-inline-start:calc(var(--spacing) * 5)}[bottom-0=""]{bottom:calc(var(--spacing) * 0)}.left-0,[left-0=""]{left:calc(var(--spacing) * 0)}.right-0,[right-0=""]{right:calc(var(--spacing) * 0)}.top--10{top:calc(var(--spacing) * -10)}.top-0,[top-0=""]{top:calc(var(--spacing) * 0)}[bottom~="19"]{bottom:calc(var(--spacing) * 19)}[right~="4"]{right:calc(var(--spacing) * 4)}[justify~=end]{justify-content:flex-end}.justify-center,[justify~=center]{justify-content:center}.justify-around{justify-content:space-around}.absolute,[absolute=""]{position:absolute}.fixed{position:fixed}.relative{position:relative}.sticky{position:sticky}.z-1{z-index:1}[z-10=""]{z-index:10}.z-20{z-index:20}[overflow~=auto]{overflow:auto}[stroke-width~="2"]{stroke-width:2px}@keyframes fade-in{0%{opacity:0}to{opacity:1}}@keyframes pulse{0%,to{opacity:1}50%{opacity:.5}}.animate-fade-in{animation:fade-in 1s linear 1}.animate-pulse{animation:pulse 2s cubic-bezier(.4,0,.6,1) infinite}.animate-iteration-1{animation-iteration-count:1}[font~=serif]{font-family:var(--va-font-serif)}@supports (color:color-mix(in lab,red,red)){[text~=red-400]{color:color-mix(in oklab,var(--colors-red-400) var(--un-text-opacity),transparent)}[hover~=text-white]:hover{color:color-mix(in oklab,var(--colors-white) var(--un-text-opacity),transparent)}[bg~=white]{background-color:color-mix(in oklab,var(--colors-white) var(--un-bg-opacity),transparent)}[hover~=bg-blue-500]:hover{background-color:color-mix(in oklab,var(--colors-blue-500) var(--un-bg-opacity),transparent)}}@media (max-width:calc(48rem - .1px)){[p~="lt-md:0"]{padding:calc(var(--spacing) * 0)}.lt-md\:w-full{width:100%}}@media(min-width:40rem){.sm\:p-6{padding:calc(var(--spacing) * 6)}.sm\:px-6{padding-inline:calc(var(--spacing) * 6)}}@media(min-width:48rem){.md\:mt-24{margin-top:calc(var(--spacing) * 24)}.md\:w-3xl{width:var(--container-3xl)}}@media(min-width:64rem){.lg\:px-12{padding-inline:calc(var(--spacing) * 12)}.lg\:w-2xl{width:var(--container-2xl)}.lg\:top-\$yun-margin-top{top:var(--yun-margin-top)}}@media(min-width:80rem){.xl\:px-16{padding-inline:calc(var(--spacing) * 16)}.xl\:w-2xl{width:var(--container-2xl)}.xl\:hidden{display:none}}@media(min-width:96rem){.\32xl\:w-4xl{width:var(--container-4xl)}}</style><script>const locale=localStorage.getItem("valaxy-locale")||"zh-CN";document.documentElement.setAttribute("lang",locale)</script><script type="module" async crossorigin src="/assets/app.CcfNILCs.js"></script><link rel="modulepreload" crossorigin href="/assets/framework.GzYmdVjK.js"><link rel="modulepreload" crossorigin href="/assets/chunks/@vueuse/motion.D4J2SB46.js"><link rel="modulepreload" crossorigin href="/assets/chunks/vue-router.RvvYB2Hz.js"><link rel="modulepreload" crossorigin href="/assets/chunks/dayjs.Dto65haK.js"><link rel="modulepreload" crossorigin href="/assets/chunks/vue-i18n.BvWwj3SI.js"><link rel="modulepreload" crossorigin href="/assets/chunks/pinia.BcfqlbOB.js"><link rel="modulepreload" crossorigin href="/assets/chunks/nprogress.W5IEJXTh.js"><link rel="preload" crossorigin href="/assets/app.COGfhiw0.css" onload='this.rel="stylesheet"' as="style"><noscript><link rel="stylesheet" crossorigin href="/assets/app.COGfhiw0.css"></noscript><link rel="preload" crossorigin href="/assets/group-icons.Bm1YPxXM.css" onload='this.rel="stylesheet"' as="style"><noscript><link rel="stylesheet" crossorigin href="/assets/group-icons.Bm1YPxXM.css"></noscript><link rel="modulepreload" crossorigin href="/assets/post.Cxj_ABQz.js"><link rel="preload" href="/assets/group-icons.Bm1YPxXM.css" onload='this.rel="stylesheet"' as="style"><noscript><link rel="stylesheet" href="/assets/group-icons.Bm1YPxXM.css"></noscript><link rel="modulepreload" crossorigin href="/assets/Java_Interview_Topics-Framework.F89-MH-x.js"><title>Java面试专题 - 框架篇 - imklaus's Blog</title><script id="check-mac-os" async>document.documentElement.classList.toggle("mac",/Mac|iPhone|iPod|iPad/i.test(navigator.platform))</script><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@900&amp;display=swap"><meta property="og:locale:alternate" content="en"><meta name="description" content="The Winner Takes It All."><meta property="og:description" content="The Winner Takes It All."><meta property="og:locale" content="zh-CN"><meta property="og:site_name" content="imklaus's Blog "><meta property="og:title" content="Java面试专题 - 框架篇"><meta property="og:image" content="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/black_saber.png"><meta property="og:type" content="website"><meta property="og:url" content="https://www.imlklaus.cn/"><link rel="icon" href="/favicon/dinosaur-egg.png" type="image/png"><meta name="generator" content="Valaxy 0.26.10"><meta name="theme-color" content="#fff"><meta name="msapplication-TileColor" content="#fff"><meta name="twitter:card" content="summary_large_image"><link rel="preload" as="font" crossorigin="anonymous" href="/assets/KaTeX_AMS-Regular.BQhdFMY1.woff2"><link rel="preload" as="font" crossorigin="anonymous" href="/assets/KaTeX_Caligraphic-Bold.Dq_IR9rO.woff2"><link rel="preload" as="font" crossorigin="anonymous" href="/assets/KaTeX_Caligraphic-Regular.Di6jR-x-.woff2"><link rel="preload" as="font" crossorigin="anonymous" href="/assets/KaTeX_Fraktur-Bold.CL6g_b3V.woff2"><link rel="preload" as="font" crossorigin="anonymous" href="/assets/KaTeX_Fraktur-Regular.CTYiF6lA.woff2"><link rel="preload" as="font" crossorigin="anonymous" href="/assets/KaTeX_Main-Bold.Cx986IdX.woff2"><link rel="preload" as="font" crossorigin="anonymous" href="/assets/KaTeX_Main-BoldItalic.DxDJ3AOS.woff2"><link rel="preload" as="font" crossorigin="anonymous" href="/assets/KaTeX_Main-Italic.NWA7e6Wa.woff2"><link rel="preload" as="font" crossorigin="anonymous" href="/assets/KaTeX_Main-Regular.B22Nviop.woff2"><link rel="preload" as="font" crossorigin="anonymous" href="/assets/KaTeX_Math-BoldItalic.CZnvNsCZ.woff2"><link rel="preload" as="font" crossorigin="anonymous" href="/assets/KaTeX_Math-Italic.t53AETM-.woff2"><link rel="preload" as="font" crossorigin="anonymous" href="/assets/KaTeX_SansSerif-Bold.D1sUS0GD.woff2"><link rel="preload" as="font" crossorigin="anonymous" href="/assets/KaTeX_SansSerif-Italic.C3H0VqGB.woff2"><link rel="preload" as="font" crossorigin="anonymous" href="/assets/KaTeX_SansSerif-Regular.DDBCnlJ7.woff2"><link rel="preload" as="font" crossorigin="anonymous" href="/assets/KaTeX_Script-Regular.D3wIWfF6.woff2"><link rel="preload" as="font" crossorigin="anonymous" href="/assets/KaTeX_Size1-Regular.mCD8mA8B.woff2"><link rel="preload" as="font" crossorigin="anonymous" href="/assets/KaTeX_Size2-Regular.Dy4dx90m.woff2"><link rel="preload" as="font" crossorigin="anonymous" href="data:font/woff2;base64,d09GMgABAAAAAA4oAA4AAAAAHbQAAA3TAAEAAAAAAAAAAAAAAAAAAAAAAAAAAAAABmAAgRQIDgmcDBEICo1oijYBNgIkA14LMgAEIAWJAAeBHAyBHBvbGiMRdnO0IkRRkiYDgr9KsJ1NUAf2kILNxgUmgqIgq1P89vcbIcmsQbRps3vCcXdYOKSWEPEKgZgQkprQQsxIXUgq0DqpGKmIvrgkeVGtEQD9DzAO29fM9jYhxZEsL2FeURH2JN4MIcTdO049NCVdxQ/w9NrSYFEBKTDKpLKfNkCGDc1RwjZLQcm3vqJ2UW9Xfa3tgAHz6ivp6vgC2yD4/6352ndnN0X0TL7seypkjZlMsjmZnf0Mm5Q+JykRWQBKCVCVPbARPXWyQtb5VgLB6Biq7/Uixcj2WGqdI8tGSgkuRG+t910GKP2D7AQH0DB9FMDW/obJZ8giFI3Wg8Cvevz0M+5m0rTh7XDBlvo9Y4vm13EXmfttwI4mBo1EG15fxJhUiCLbiiyCf/ZA6MFAhg3pGIZGdGIVjtPn6UcMk9A/UUr9PhoNsCENw1APAq0gpH73e+M+0ueyHbabc3vkbcdtzcf/fiy+NxQEjf9ud/ELBHAXJ0nk4z+MXH2Ev/kWyV4k7SkvpPc9Qr38F6RPWnM9cN6DJ0AdD1BhtgABtmoRoFCvPsBAumNm6soZG2Gk5GyVTo2sJncSyp0jQTYoR6WDvTwaaEcHsxHfvuWhHA3a6bN7twRKtcGok6NsCi7jYRrM2jExsUFMxMQYuJbMhuWNOumEJy9hi29Dmg5zMp/A5+hhPG19j1vBrq8JTLr8ki5VLPmG/PynJHVul440bxg5xuymHUFPBshC+nA9I1FmwbRBTNHAcik3Oae0cxKoI3MOriM42UrPe51nsaGxJ+WfXubAsP84aabUlQSJ1IiE0iPETLUU4CATgfXSCSpuRFRmCGbO+wSpAnzaeaCYW1VNEysRtuXCEL1kUFUbbtMv3Tilt/1c11jt3Q5bbMa84cpWipp8Elw3MZhOHsOlwwVUQM3lAR35JiFQbaYCRnMF2lxAWoOg2gyoIV4PouX8HytNIfLhqpJtXB4vjiViUI8IJ7bkC4ikkQvKksnOTKICwnqWSZ9YS5f0WCxmpgjbIq7EJcM4aI2nmhLNY2JIUgOjXZFWBHb+x5oh6cwb0Tv1ackHdKi0I9OO2wE9aogIOn540CCCziyhN+IaejtgAONKznHlHyutPrHGwCx9S6B8kfS4Mfi4Eyv7OU730bT1SCBjt834cXsf43zVjPUqqJjgrjeGnBxSG4aYAKFuVbeCfkDIjAqMb6yLNIbCuvXhMH2/+k2vkNpkORhR59N1CkzoOENvneIosjYmuTxlhUzaGEJQ/iWqx4dmwpmKjrwTiTGTCVozNAYqk/zXOndWxuWSmJkQpJw3pK5KX6QrLt5LATMqpmPAQhkhK6PUjzHUn7E0gHE0kPE0iKkolgkUx9SZmVAdDgpffdyJKg3k7VmzYGCwVXGz/tXmkOIp+vcWs+EMuhhvN0h9uhfzWJziBQmCREGSIFmQIkgVpAnSBRmC//6hkLZwaVhwxlrJSOdqlFtOYxlau9F2QN5Y98xmIAsiM1HVp2VFX+DHHGg6Ecjh3vmqtidX3qHI2qycTk/iwxSt5UzTmEP92ZBnEWTk4Mx8Mpl78ZDokxg/KWb+Q0QkvdKVmq3TMW+RXEgrsziSAfNXFMhDc60N5N9jQzjfO0kBKpUZl0ZmwJ41j/B9Hz6wmRaJB84niNmQrzp9eSlQCDDzazGDdVi3P36VZQ+Jy4f9UBNp+3zTjqI4abaFAm+GShVaXlsGdF3FYzZcDI6cori4kMxUECl9IjJZpzkvitAoxKue+90pDMvcKRxLl53TmOKCmV/xRolNKSqqUxc6LStOETmFOiLZZptlZepcKiAzteG8PEdpnQpbOMNcMsR4RR2Bs0cKFEvSmIjAFcnarqwUL4lDhHmnVkwu1IwshbiCcgvOheZuYyOteufZZwlcTlLgnZ3o/WcYdzZHW/WGaqaVfmTZ1aWCceJjkbZqsfbkOtcFlUZM/jy+hXHDbaUobWqqXaeWobbLO99yG5N3U4wxco0rQGGcOLASFMXeJoham8M+/x6O2WywK2l4HGbq1CoUyC/IZikQhdq3SiuNrvAEj0AVu9x2x3lp/xWzahaxidezFVtdcb5uEnzyl0ZmYiuKI0exvCd4Xc9CV1KB0db00z92wDPde0kukbvZIWN6jUWFTmPIC/Y4UPCm8UfDTFZpZNon1qLFTkBhxzB+FjQRA2Q/YRJT8pQigslMaUpFyAG8TMlXigiqmAZX4xgijKjRlGpLE0GdplRfCaJo0JQaSxNBk6ZmMzcya0FmrcisDdn0Q3HI2sWSppYigmlM1XT/kLQZSNpMJG0WkjYbSZuDpM1F0uYhFc1HxU4m1QJjDK6iL0S5uSj5rgXc3RejEigtcRBtqYPQsiTskmO5vosV+q4VGIKbOkDg0jtRrq+Em1YloaTFar3EGr1EUC8R0kus1Uus00usL97ABr2BjXoDm/QGNhuWtMVBKOwg/i78lT7hBsAvDmwHc/ao3vmUbBmhjeYySZNWvGkfZAgISDSaDo1SVpzGDsAEkF8B+gEapViUoZgUWXcRIGFZNm6gWbAKk0bp0k1MHG9fLYtV4iS2SmLEQFARzRcnf9PUS0LVn05/J9MiRRBU3v2IrvW974v4N00L7ZMk0wXP1409CHo/an8zTRHD3eSJ6m8D4YMkZNl3M79sqeuAsr/m3f+8/yl7A50aiAEJgeBeMWzu7ui9UfUBCe2TIqZIoOd/3/udRBOQidQZUERzb2/VwZN1H/Sju82ew2H2Wfr6qvfVf3hqwDvAIpkQVFy4B9Pe9e4/XvPeceu7h3dvO56iJPf0+A6cqA2ip18ER+iFgggiuOkvj24bby0N9j2UHIkgqIt+sVgfodC4YghLSMjSZbH0VR/6dMDrYJeKHilKTemt6v6kvzvn3/RrdWtr0GoN/xL+Sex/cPYLUpepx9cz/D46UPU5KXgAQa+NDps1v6J3xP1i2HtaDB0M9aX2deA7SYff//+gUCovMmIK/qfsFcOk+4Y5ZN97XlG6zebqtMbKgeRFi51vnxTQYBUik2rS/Cn6PC8ADR8FGxsRPB82dzfND90gIcshOcYUkfjherBz53odpm6TP8txlwOZ71xmfHHOvq053qFF/MRlS3jP0ELudrf2OeN8DHvp6ZceLe8qKYvWz/7yp0u4dKPfli3CYq0O13Ih71mylJ80tOi10On8wi+F4+LWgDPeJ30msSQt9/vkmHq9/Lvo2b461mP801v3W4xTcs6CbvF9UDdrSt+A8OUbpSh55qAUFXWznBBfdeJ8a4d7ugT5tvxUza3h9m4H7ptTqiG4z0g5dc0X29OcGlhpGFMpQo9ytTS+NViZpNdvU4kWx+LKxNY10kQ1yqGXrhe4/1nvP7E+nd5A92TtaRplbHSqoIdOqtRWti+fkB5/n1+/VvCmz12pG1kpQWsfi1ftlBobm0bpngs16CHkbIwdLnParxtTV3QYRlfJ0KFskH7pdN/YDn+yRuSd7sNH3aO0DYPggk6uWuXrfOc+fa3VTxFVvKaNxHsiHmsXyCLIE5yuOeN3/Jdf8HBL/5M6shjyhxHx9BjB1O0+4NLOnjLLSxwO7ukN4jMbOIcD879KLSi6Pk61Oqm2377n8079PXEEQ7cy7OKEC9nbpet118fxweTafpt69x/Bt8UqGzNQt7aelpc44dn5cqhwf71+qKp/Zf/+a0zcizOUWpl/iBcSXip0pplkatCchoH5c5aUM8I7/dWxAej8WicPL1URFZ9BDJelUwEwTkGqUhgSlydVes95YdXvhh9Gfz/aeFWvgVb4tuLbcv4+wLdutVZv/cUonwBD/6eDlE0aSiKK/uoH3+J1wDE/jMVqY2ysGufN84oIXB0sPzy8ollX/LegY74DgJXJR57sn+VGza0x3DnuIgABFM15LmajjjsNlYj+JEZGbuRYcAMOWxFkPN2w6Wd46xo4gVWQR/X4lyI/R6K/YK0110GzudPRW7Y+UOBGTfNNzHeYT0fiH0taunBpq9HEW8OKSaBGj21L0MqenEmNRWBAWDWAk4CpNoEZJ2tTaPFgbQYj8HxtFilErs3BTRwT8uO1NXQaWfIotchmPkAF5mMBAliEmZiOGVgCG9LgRzpscMAOOwowlT3JhusdazXGSC/hxR3UlmWVwWHpOIKheqONvjyhSiTHIkVUco5bnji8m//zL7PKaT1Vl5I6UE609f+gkr6MZKVyKc7zJRmCahLsdlyA5fdQkRSan9LgnnLEyGSkaKJCJog0wAgvepWBt80+1yKln1bMVtCljfNWDueKLsWwaEbBSfSPTEmVRsUcYYMnEjcjeyCZzBXK9E9BYBXLKjOSpUDR+nEV3TFSUdQaz+ot98QxgXwx0GQ+EEUAKB2qZPkQQ0GqFD8UPFMqyaCHM24BZmSGic9EYMagKizOw9Hz50DMrDLrqqLkTAhplMictiCAx5S3BIUQdeJeLnBy2CNtMfz6cV4u8XKoFZQesbf9YZiIERiHjaNodDW6LgcirX/mPnJIkBGDUpTBhSa0EIr38D5hCIszhCM8URGBqImoWjpvpt1ebu/v3Gl3qJfMnNM+9V+kiRFyROTPHQWOcs1dNW94/ukKMPZBvDi55i5CttdeJz84DLngLqjcdwEZ87bFFR8CIG35OAkDVN6VRDZ7aq67NteYqZ2lpT8oYB2CytoBd6VuAx4WgiAsnuj3WohG+LugzXiQRDeM3XYXlULv4dp5VFYC"><link rel="preload" as="font" crossorigin="anonymous" href="/assets/KaTeX_Size4-Regular.Dl5lxZxV.woff2"><link rel="preload" as="font" crossorigin="anonymous" href="/assets/KaTeX_Typewriter-Regular.CO6r4hn1.woff2"></head><body><div id="app" data-server-rendered="true"><!--[--><!--[--><!--[--><!----><!----><div class="yun-page-header-gradient" style="--gradient-from:161 196 253;--gradient-to:194 233 251"></div><!----><!----><!----><canvas class="fireworks"></canvas><!--[--><div class="yun-bg"></div><!--]--><div class="yun-page-loading" absolute left-0 right-0 bottom-0 top-0 flex justify="center" items-center z-10 bg="$va-c-bg" data-v-e7dc65c9><div class="spinner" data-v-e7dc65c9></div></div><a href="#" class="back-to-top yun-icon-btn bg-$va-c-bg-soft shadow-md"><div class="size-8" i-ri-arrow-up-s-line></div><svg class="progress-circle-container" viewBox="0 0 100 100"><circle stroke-dasharray="301.59289474462014 301.59289474462014" stroke-dashoffset="301.59289474462014" stroke="currentColor" stroke-width="2" stroke-linecap="round" class="progress-circle" cx="50" cy="50" r="48" fill="none"/></svg></a><!-- TODO --><!-- <YunDock /> --><!--]--><!--[--><!--]--><!----><!--]--><!--[--><div flex="~" class="w-full m-auto justify-center items-start gap-4 mt-12 md:mt-24"><!--[--><!----><main class="yun-main lt-md:w-full" flex="~ center"><!--[--><div class="content w-full md:w-3xl lg:w-2xl xl:w-2xl 2xl:w-4xl" flex="~ col grow" p="lt-md:0"><div class="yun-card flex-center rounded-2 relative" flex="col" min-h="100px" bg="$va-c-bg-light" m="0" style><img width="640" height="360" class="object-cover select-none" h="64 md:sm" w="full" src="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/black_saber.png" loading="lazy"><!----><!--[--><div class="mt-8 mb-4"><!--[--><header class="post-header" cover="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/black_saber.png"><h1 p="2" text="2xl center" font="serif black" style="" class="post-title flex-center"><!----><span inline-flex class="leading-none">Java面试专题 - 框架篇</span></h1></header><!--]--></div><!--[--><!--[--><!--[--><!--[--><!----><!----><div class="post-top-icon" color="$va-c-warning"><div i-ri-pushpin-line></div></div><div flex="~ center" text="sm" class="flex-col gap-2! post-meta gap-4"><div class="post-time flex items-center gap-4"><span class="posted-time inline-flex-center gap-1" title="发表于2023-04-21 19:52:05"><div class="inline-block" i-ri-calendar-line></div><time class="op-80">2023-04-21</time></span><!----></div><!--[--><!--]--><div class="inline-flex-center gap-4"><div class="inline-flex-center post-counter gap-4"><span class="word-count inline-flex-center gap-1" title="本文字数"><div class="inline-block" i-ri-file-word-line></div><span class="op-80">25.1k</span></span><span class="reading-time inline-flex-center gap-1" title="阅读时长"><div i-ri-timer-line></div><time class="op-80">134m</time></span></div><div class="inline-flex gap-4" text="sm" h="5"><!----><div inline-flex justify="center" items="center" title="评论数"><div inline-flex i-ri-chat-4-line></div><span ml-1 inline-flex class="waline-comment-count op-80" data-path="/posts/Java_Interview_Topics-Framework"></span></div></div></div></div><!--]--><div class="inline-flex mt-2" text="sm" py="1"><a href="/categories?category=Java/%E9%9D%A2%E8%AF%95" class="transition post-category inline-flex-center text-xs border-$va-c-divider" px-2 h="7" border rounded-full hover="bg-blue-500 text-white"><div m="x-1" inline-flex i-ri-folder-2-line></div><span>Java / 面试</span></a><span mx="2"></span><div class="post-tags inline-flex" items="center" gap="1" flex="wrap 1" justify="end"><!--[--><a href="/tags/?tag=Spring+Refresh" class="transition post-tag inline-flex-center text-xs border-$va-c-divider" px-2 h="7" rounded-full border hover="bg-blue-500 text-white"><span>Spring Refresh</span></a><a href="/tags/?tag=Spring+Bean" class="transition post-tag inline-flex-center text-xs border-$va-c-divider" px-2 h="7" rounded-full border hover="bg-blue-500 text-white"><span>Spring Bean</span></a><a href="/tags/?tag=Spring+MVC" class="transition post-tag inline-flex-center text-xs border-$va-c-divider" px-2 h="7" rounded-full border hover="bg-blue-500 text-white"><span>Spring MVC</span></a><a href="/tags/?tag=Spring+Boot" class="transition post-tag inline-flex-center text-xs border-$va-c-divider" px-2 h="7" rounded-full border hover="bg-blue-500 text-white"><span>Spring Boot</span></a><!--]--></div></div><!--]--><!--]--><!--]--><div p="x-4 b-8" class="sm:px-6 lg:px-12 xl:px-16" w="full"><!--[--><!--]--><!--[--><!-- <Transition appear> --><article class="markdown-body"><!--[--><!----><!----><!--[--><!--]--><!--[--><p>参考视频：<a href="https://www.bilibili.com/video/BV15b4y117RJ" target="_blank" rel="noreferrer">满神Java面试专题</a></p><p>笔记的整体结构依据视频编写，并随着学习的深入补充了很多知识</p><!-- more --><h2 id="_1-spring-refresh-流程" tabindex="-1">1. Spring refresh 流程 <a class="header-anchor" href="#_1-spring-refresh-流程" aria-label="Permalink to &quot;1. Spring refresh 流程&quot;">​</a></h2><h3 id="spring-refresh-概述" tabindex="-1"><strong>Spring refresh 概述</strong> <a class="header-anchor" href="#spring-refresh-概述" aria-label="Permalink to &quot;**Spring refresh 概述**&quot;">​</a></h3><p>refresh 是 AbstractApplicationContext 中的一个方法，负责初始化 ApplicationContext 容器，容器必须调用 refresh 才能正常工作。它的内部主要会调用 12 个方法，我们把它们称为 refresh 的 12 个步骤：</p><ol><li><p>prepareRefresh</p></li><li><p>obtainFreshBeanFactory</p></li><li><p>prepareBeanFactory</p></li><li><p>postProcessBeanFactory</p></li><li><p>invokeBeanFactoryPostProcessors</p></li><li><p>registerBeanPostProcessors</p></li><li><p>initMessageSource</p></li><li><p>initApplicationEventMulticaster</p></li><li><p>onRefresh</p></li><li><p>registerListeners</p></li><li><p>finishBeanFactoryInitialization</p></li><li><p>finishRefresh</p></li></ol><p><code>org.springframework.context.support.AbstractApplicationContext#refresh</code></p><div class="language-java max-h-300px"><button title="Copy code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code v-pre><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">    @</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">Override</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">    public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> refresh</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">() throws BeansException, IllegalStateException {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">    	synchronized</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> (</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">.startupShutdownMonitor) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">			// Prepare this context for refreshing.</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">			prepareRefresh</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">();</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">			// Tell the subclass to refresh the internal bean factory.</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">			ConfigurableListableBeanFactory beanFactory </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> obtainFreshBeanFactory</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">();</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">			// Prepare the bean factory for use in this context.</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">			prepareBeanFactory</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(beanFactory);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">			try</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">				// Allows post-processing of the bean factory in context subclasses.</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">				postProcessBeanFactory</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(beanFactory);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">				// Invoke factory processors registered as beans in the context.</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">				invokeBeanFactoryPostProcessors</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(beanFactory);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">				// Register bean processors that intercept bean creation.</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">				registerBeanPostProcessors</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(beanFactory);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">				// Initialize message source for this context.</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">				initMessageSource</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">();</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">				// Initialize event multicaster for this context.</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">				initApplicationEventMulticaster</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">();</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">				// Initialize other special beans in specific context subclasses.</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">				onRefresh</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">();</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">				// Check for listener beans and register them.</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">				registerListeners</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">();</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">				// Instantiate all remaining (non-lazy-init) singletons.</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">				finishBeanFactoryInitialization</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(beanFactory);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">				// Last step: publish corresponding event.</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">				finishRefresh</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">			}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">			catch</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> (BeansException </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70">ex</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">				if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> (logger.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">isWarnEnabled</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">()) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">					logger.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">warn</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">"Exception encountered during context initialization - "</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> +</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">							"cancelling refresh attempt: "</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> +</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> ex);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">				}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">				// Destroy already created singletons to avoid dangling resources.</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">				destroyBeans</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">();</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">				// Reset 'active' flag.</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">				cancelRefresh</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(ex);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">				// Propagate exception to caller.</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">				throw</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> ex;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">			}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">			finally</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">				// Reset common introspection caches in Spring's core, since we</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">				// might not ever need metadata for singleton beans anymore...</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">				resetCommonCaches</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">			}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">		}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">    }</span></span></code></pre><button class="code-block-unfold-btn"></button></div><blockquote><p><em><strong>功能分类</strong></em></p><ul><li><p>1 为准备环境</p></li><li><p>2 3 4 5 6 为准备 BeanFactory</p><ul><li>ApplicationContext只是一个外部的容器，它的一些核心功能还得另外交给这个叫BeanFactory容器来完成，即Bean的创建，Bean的依赖注入，Bean的初始化，ApplicationContext会借助其成员变量BeanFactory来完成Bean的创建，Bean的依赖注入，Bean的初始化等功能</li></ul></li><li><p>7 8 9 10 12 为准备 ApplicationContext</p></li><li><p>11 为初始化 BeanFactory 中非延迟单例 bean</p></li></ul></blockquote><h3 id="_1-preparerefresh" tabindex="-1"><strong>1. prepareRefresh</strong> <a class="header-anchor" href="#_1-preparerefresh" aria-label="Permalink to &quot;**1. prepareRefresh**&quot;">​</a></h3><ul><li><p>这一步创建和准备了 Environment 对象，它作为 ApplicationContext 的一个成员变量</p></li><li><p>Environment 对象的作用之一是为后续 @Value，值注入时提供键值</p></li><li><p>Environment 分成三个主要部分</p><ul><li>systemProperties - 保存 java 环境键值</li><li>systemEnvironment - 保存系统环境键值（操作系统的键值，如JAVA_HOME、PATH、CLASS_PATH等）</li><li>自定义 PropertySource - 保存自定义键值，例如来自于 *.properties 文件的键值</li></ul></li></ul><figure><img src="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210902181639048.png" alt="image-20210902181639048" loading="lazy" decoding="async" class="lazy"></figure><ul><li>解析@Value、${}、#{}</li></ul><figure><img src="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230421212541621.png" alt="image-20230421212541621" loading="lazy" decoding="async" class="lazy"></figure><div class="language-java max-h-300px"><button title="Copy code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code v-pre><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">    /**</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">     * Prepare this context for refreshing, setting its startup date and</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">     * active flag as well as performing any initialization of property sources.</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">     * 准备此上下文以进行刷新、设置其启动日期和活动标志以及执行属性源的任何初始化。</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">     */</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">    protected</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> prepareRefresh</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">() {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">       ...</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">       // Initialize any placeholder property sources in the context environment.</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">       initPropertySources</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">();</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">       // Validate that all properties marked as required are resolvable:</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">       // see ConfigurablePropertyResolver#setRequiredProperties</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">       getEnvironment</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">().</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">validateRequiredProperties</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">();</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">       ...</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">    }</span></span></code></pre><button class="code-block-unfold-btn"></button></div><hr><h3 id="_2-obtainfreshbeanfactory" tabindex="-1"><strong>2. obtainFreshBeanFactory</strong> <a class="header-anchor" href="#_2-obtainfreshbeanfactory" aria-label="Permalink to &quot;**2. obtainFreshBeanFactory**&quot;">​</a></h3><ul><li>这一步获取（或创建） BeanFactory，它也是作为 ApplicationContext 的一个成员变量</li><li>ApplicationContext+BeanFactory：ApplicationContext在Bean的管理上借助BeanFactory的功能</li><li>BeanFactory 的作用是负责 bean 的创建、依赖注入和初始化，bean 的各项特征由 BeanDefinition 定义<ul><li>BeanDefinition 作为 bean 的设计蓝图，规定了 bean 的特征，如单例多例、依赖关系、初始销毁方法等</li><li>BeanDefinition 的来源有多种多样，可以是通过 xml 获得、配置类获得、组件扫描获得，也可以是编程添加</li></ul></li><li>所有的 BeanDefinition 会存入 BeanFactory 中的 beanDefinitionMap 集合；</li></ul><figure><img src="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210902182004819.png" alt="image-20210902182004819" loading="lazy" decoding="async" class="lazy"></figure><figure><img src="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230421223009256.png" alt="image-20230421223009256" loading="lazy" decoding="async" class="lazy"></figure><blockquote><ul><li>BeanFactory中也有很多成员变量要初始化，其中有一个非常重要的beanDefinitionMap，BeanFactory并不是一上来就创建这些Bean，它必须先有些Bean的定义，它得知道这个Bean长什么样子，Bean是单例还是多例，它的初始化方法是什么，它有哪些属性需要依赖注入，这些信息在Spring中都是用beanDefinitionMap这个类来描述的，而这个beanDefinitionMap是用来存储所有的BeanDefinition</li><li>BeanFactory不是一下子就把Bean创建出来，得借助BeanDefinition（Bean的设计蓝图），刚开始都是收集BeanDefinition的各种信息</li></ul></blockquote><ul><li>此方法仅在AbstractApplicationContext类内被调用且未被重写</li></ul><div class="language-java max-h-300px"><button title="Copy code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code v-pre><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">    protected</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> ConfigurableListableBeanFactory </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">obtainFreshBeanFactory</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">() {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">       refreshBeanFactory</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">();</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">       return</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> getBeanFactory</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">    }</span></span></code></pre><button class="code-block-unfold-btn"></button></div><ul><li>以下两个方法由AbstractRefreshableApplicationContext和GenericApplicationContext两个类重写，且创建或获取的BeanFactory类型都为DefaultListableBeanFactory</li></ul><div class="language-java max-h-300px"><button title="Copy code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code v-pre><span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">    protected</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> abstract</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> refreshBeanFactory</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">() throws BeansException, IllegalStateException;</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">	@</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">Override</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">	public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> abstract</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> ConfigurableListableBeanFactory </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">getBeanFactory</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">() throws IllegalStateException;</span></span></code></pre><button class="code-block-unfold-btn"></button></div><hr><h3 id="_3-preparebeanfactory" tabindex="-1"><strong>3. prepareBeanFactory</strong> <a class="header-anchor" href="#_3-preparebeanfactory" aria-label="Permalink to &quot;**3. prepareBeanFactory**&quot;">​</a></h3><div class="language-java max-h-300px"><button title="Copy code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code v-pre><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">/**</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D"> * Configure the factory's standard context characteristics,</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D"> * such as the context's ClassLoader and post-processors.</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D"> * </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">@param</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70"> beanFactory</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D"> the BeanFactory to configure</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D"> */</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">protected</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> prepareBeanFactory</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(ConfigurableListableBeanFactory beanFactory) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">   ......</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">}</span></span></code></pre><button class="code-block-unfold-btn"></button></div><ul><li>这一步会进一步完善 BeanFactory，为它的各项成员变量赋值</li><li>beanExpressionResolver 用来解析 SpEL，常见实现为 StandardBeanExpressionResolver</li></ul><div class="language-java max-h-300px"><button title="Copy code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code v-pre><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">beanFactory.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">setBeanExpressionResolver</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> StandardBeanExpressionResolver</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(beanFactory.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">getBeanClassLoader</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">()));</span></span></code></pre><button class="code-block-unfold-btn"></button></div><ul><li><p>propertyEditorRegistrar 会注册类型转换器</p><ul><li>它在这里使用了 ResourceEditorRegistrar 实现类</li><li>并应用 ApplicationContext 提供的 Environment 完成 ${ } 解析</li></ul><div class="language-java max-h-300px"><button title="Copy code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code v-pre><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">beanFactory.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">addPropertyEditorRegistrar</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> ResourceEditorRegistrar</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">, </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">getEnvironment</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">()));</span></span></code></pre><button class="code-block-unfold-btn"></button></div></li><li><p>registerResolvableDependency 来注册 beanFactory 以及 ApplicationContext，让它们也能用于依赖注入</p></li></ul><div class="language-java max-h-300px"><button title="Copy code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code v-pre><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">// BeanFactory interface not registered as resolvable type in a plain factory.</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">// MessageSource registered (and found for autowiring) as a bean.</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">beanFactory.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">registerResolvableDependency</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(BeanFactory.class, beanFactory);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">beanFactory.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">registerResolvableDependency</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(ResourceLoader.class, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">beanFactory.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">registerResolvableDependency</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(ApplicationEventPublisher.class, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">beanFactory.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">registerResolvableDependency</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(ApplicationContext.class, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">);</span></span></code></pre><button class="code-block-unfold-btn"></button></div><ul><li><p>beanPostProcessors 是 bean 后处理器集合，会工作在 bean 的生命周期各个阶段，此处会添加两个：</p><ul><li>ApplicationContextAwareProcessor 用来解析 Aware 接口</li></ul><div class="language-java max-h-300px"><button title="Copy code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code v-pre><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">// Configure the bean factory with context callbacks.</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">beanFactory.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">addBeanPostProcessor</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> ApplicationContextAwareProcessor</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">));</span></span></code></pre><button class="code-block-unfold-btn"></button></div><ul><li>ApplicationListenerDetector 用来识别容器中 ApplicationListener 类型的 bean</li></ul><div class="language-java max-h-300px"><button title="Copy code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code v-pre><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">// Register early post-processor for detecting inner beans as ApplicationListeners.</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">beanFactory.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">addBeanPostProcessor</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> ApplicationListenerDetector</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">));</span></span></code></pre><button class="code-block-unfold-btn"></button></div><ul><li>粉红正方形代表内置的Bean后处理器</li></ul></li></ul><figure><img src="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210902182541925.png" alt="image-20210902182541925" loading="lazy" decoding="async" class="lazy"></figure><blockquote><ul><li>beanExpressionResolver是用来解析SpringEL表达式(SpEL)，即<code>#{}</code></li><li>propertyEditorRegistrar是注册一些类型转换器，因为Spring接下来尤其是做值注入，需要把字符串类型转换为一些其他类型，此时需要注册一些propertyEditor转换器来完成转换</li><li>resolvableDependencies是管理一些特殊的对象用来进行依赖注入，因为将来大部分的Bean都是放在singletonObjects单例Bean工厂里去完成依赖注入，但是有些比较特殊的对象，如注入BeanFactory本身或者注入ApplicationContext本身，这些对象不是真正的Bean（特殊对象而已，还算不上Bean），它们没有在这个单例池里，没有在这个BeanDefinition里去定义，那么查询这些特殊Bean就是在这个resolvableDependencies里查</li><li>beanPostProcessors是在我们Bean创建时，对这个Bean的各项功能做一些扩展，对里面的一些注解进行识别，Spring标准的功能里功能是非常有限的，它对Bean的创建过程做各种各样的扩展时必须借助于很多的beanPostProcessor</li></ul></blockquote><hr><h3 id="_4-postprocessbeanfactory" tabindex="-1"><strong>4. postProcessBeanFactory</strong> <a class="header-anchor" href="#_4-postprocessbeanfactory" aria-label="Permalink to &quot;**4. postProcessBeanFactory**&quot;">​</a></h3><ul><li><p>这一步是空实现，留给子类扩展。（Bean工厂的一种扩展方式）</p><div class="language-java max-h-300px"><button title="Copy code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code v-pre><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">/**</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D"> * Modify the application context's internal bean factory after its standard</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D"> * initialization. All bean definitions will have been loaded, but no beans</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D"> * will have been instantiated yet. This allows for registering special</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D"> * BeanPostProcessors etc in certain ApplicationContext implementations.</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D"> * </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">@param</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70"> beanFactory</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D"> the bean factory used by the application context</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D"> */</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">protected</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> postProcessBeanFactory</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(ConfigurableListableBeanFactory beanFactory) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">}</span></span></code></pre><button class="code-block-unfold-btn"></button></div><ul><li>一般 Web 环境的 ApplicationContext 都要利用它注册新的 Scope，完善 Web 下的 BeanFactory</li></ul></li><li><p>这里体现的是模板方法设计模式</p></li></ul><blockquote><p>ApplicationContext将来可能有不同的子类，有一种是非web环境下的子类，还有一种是web环境下的子类，那web环境下的子类初始化beanFactory，就需要更多的信息，比如要注册一些新的scope，非web环境下的子类，只需要有singleton和prototype这两种scope,web环境下可能还需要request,session这样的scope，所以该方法就没有实现，留给子类扩展</p></blockquote><hr><h3 id="_5-invokebeanfactorypostprocessors" tabindex="-1"><strong>5. invokeBeanFactoryPostProcessors</strong> <a class="header-anchor" href="#_5-invokebeanfactorypostprocessors" aria-label="Permalink to &quot;**5. invokeBeanFactoryPostProcessors**&quot;">​</a></h3><div class="language-java max-h-300px"><button title="Copy code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code v-pre><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">/**</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D"> * Instantiate and invoke all registered BeanFactoryPostProcessor beans,</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D"> * respecting explicit order if given.</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D"> * &lt;p&gt;Must be called before singleton instantiation.</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D"> * 实例化并调用所有已注册的 BeanFactoryPostProcessor bean，如果给定则遵循显式顺序。必须在单例化之前调用。</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D"> */</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">protected</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> invokeBeanFactoryPostProcessors</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(ConfigurableListableBeanFactory beanFactory) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">   PostProcessorRegistrationDelegate.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">invokeBeanFactoryPostProcessors</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(beanFactory, </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">getBeanFactoryPostProcessors</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">());</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">   // Detect a LoadTimeWeaver and prepare for weaving, if found in the meantime</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">   // (e.g. through an @Bean method registered by ConfigurationClassPostProcessor)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">   if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> (beanFactory.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">getTempClassLoader</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">() </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">==</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> null</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> &amp;&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> beanFactory.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">containsBean</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(LOAD_TIME_WEAVER_BEAN_NAME)) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">      beanFactory.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">addBeanPostProcessor</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> LoadTimeWeaverAwareProcessor</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(beanFactory));</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">      beanFactory.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">setTempClassLoader</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> ContextTypeMatchClassLoader</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(beanFactory.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">getBeanClassLoader</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">()));</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">   }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">}</span></span></code></pre><button class="code-block-unfold-btn"></button></div><ul><li><p>这一步会调用 beanFactory 后处理器（Bean工厂的另一种扩展方式）</p><ul><li>实际上将来真正工作的时候不可能为了扩展功能就去实现新的ApplicationContext子类，所以更好的扩展方式就是通过Bean工厂后处理器的方式来扩展BeanFactory的功能</li></ul></li><li><p><strong>beanFactory 后处理器</strong>，<strong>充当 beanFactory 的扩展点</strong>，可以用来补充或修改 BeanDefinition</p></li></ul><div class="language-java max-h-300px"><button title="Copy code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code v-pre><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> static</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> invokeBeanFactoryPostProcessors</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">      ConfigurableListableBeanFactory beanFactory, List</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">&lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">BeanFactoryPostProcessor</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> beanFactoryPostProcessors) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">    ...</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">	Set&lt;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">String</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">&gt; processedBeans </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> new</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> HashSet&lt;&gt;();</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">	if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> (beanFactory </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">instanceof</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> BeanDefinitionRegistry) {    </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">        BeanDefinitionRegistry registry </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> (BeanDefinitionRegistry) beanFactory;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">        ...</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">        // Do not initialize FactoryBeans here: We need to leave all regular beans</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">        // uninitialized to let the bean factory post-processors apply to them!</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">        // Separate between BeanDefinitionRegistryPostProcessors that implement</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">        // PriorityOrdered, Ordered, and the rest.</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">        List&lt;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">BeanDefinitionRegistryPostProcessor</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">&gt; currentRegistryProcessors </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> new</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> ArrayList&lt;&gt;();</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">        // First, invoke the BeanDefinitionRegistryPostProcessors that implement PriorityOrdered.</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">        String</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">[] postProcessorNames </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">                beanFactory.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">getBeanNamesForType</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(BeanDefinitionRegistryPostProcessor.class, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">false</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">        for</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> (String ppName </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> postProcessorNames) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">            if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> (beanFactory.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">isTypeMatch</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(ppName, PriorityOrdered.class)) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">                currentRegistryProcessors.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">add</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(beanFactory.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">getBean</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(ppName, BeanDefinitionRegistryPostProcessor.class));</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">                processedBeans.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">add</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(ppName);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">            }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">        }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">    ...</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">}</span></span></code></pre><button class="code-block-unfold-btn"></button></div><ul><li><p>常见的 beanFactory 后处理器有</p><ul><li>ConfigurationClassPostProcessor – 解析 @Configuration、@Bean、@Import、@PropertySource 等</li></ul><div class="language-java max-h-300px"><button title="Copy code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code v-pre><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> ConfigurationClassPostProcessor</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> implements</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> BeanDefinitionRegistryPostProcessor</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">,</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">      PriorityOrdered</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">, </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">ResourceLoaderAware</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">, </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">BeanClassLoaderAware</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">, </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">EnvironmentAware</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> {...}</span></span></code></pre><button class="code-block-unfold-btn"></button></div><ul><li>PropertySourcesPlaceHolderConfigurer – 替换 BeanDefinition 中的 <code>${}</code>（XML的ApplicationContext实现用的多）</li><li>MapperScannerConfigurer – 补充 Mapper 接口对应的 BeanDefinition</li></ul></li></ul><figure><img src="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230421232304434.png" alt="image-20230421232304434" loading="lazy" decoding="async" class="lazy"></figure><blockquote><p>beanFactory 后处理器在refresh方法调用之前就有一部分后处理器加入到容器了</p></blockquote><div class="language-java max-h-300px"><button title="Copy code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code v-pre><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">public</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> ConfigurableApplicationContext </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">run</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(String... args) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">    ...</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">	prepareContext</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(context, environment, listeners, applicationArguments, printedBanner);</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">	refreshContext</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(context);</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">	afterRefresh</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(context, applicationArguments);    </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">    ...</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">}</span></span></code></pre><button class="code-block-unfold-btn"></button></div><hr><h3 id="_6-registerbeanpostprocessors" tabindex="-1"><strong>6. registerBeanPostProcessors</strong> <a class="header-anchor" href="#_6-registerbeanpostprocessors" aria-label="Permalink to &quot;**6. registerBeanPostProcessors**&quot;">​</a></h3><div class="language-java max-h-300px"><button title="Copy code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code v-pre><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">/**</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D"> * Instantiate and register all BeanPostProcessor beans,</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D"> * respecting explicit order if given.</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D"> * &lt;p&gt;Must be called before any instantiation of application beans.</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D"> * 实例化并注册所有 BeanPostProcessor bean，如果给定则遵守显式顺序。必须在任何应用程序 bean 实例化之前调用。</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D"> */</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">protected</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> registerBeanPostProcessors</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(ConfigurableListableBeanFactory beanFactory) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">   PostProcessorRegistrationDelegate.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">registerBeanPostProcessors</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(beanFactory, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">}</span></span></code></pre><button class="code-block-unfold-btn"></button></div><ul><li>这一步是继续从 beanFactory 中找出 bean 后处理器，添加至 beanPostProcessors 集合中</li></ul><div class="language-java max-h-300px"><button title="Copy code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code v-pre><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> static</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> registerBeanPostProcessors</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">      ConfigurableListableBeanFactory beanFactory, AbstractApplicationContext applicationContext) {</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">   String</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">[] postProcessorNames </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> beanFactory.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">getBeanNamesForType</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(BeanPostProcessor.class, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">false</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">   // Register BeanPostProcessorChecker that logs an info message when</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">   // a bean is created during BeanPostProcessor instantiation, i.e. when</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">   // a bean is not eligible for getting processed by all BeanPostProcessors.</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">   int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> beanProcessorTargetCount </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> beanFactory.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">getBeanPostProcessorCount</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">() </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">+</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> 1</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> +</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> postProcessorNames.length;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">   beanFactory.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">addBeanPostProcessor</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> BeanPostProcessorChecker</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(beanFactory, beanProcessorTargetCount));</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">   // Separate between BeanPostProcessors that implement PriorityOrdered,</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">   // Ordered, and the rest.</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">   List&lt;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">BeanPostProcessor</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">&gt; priorityOrderedPostProcessors </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> new</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> ArrayList&lt;&gt;();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">   List&lt;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">BeanPostProcessor</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">&gt; internalPostProcessors </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> new</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> ArrayList&lt;&gt;();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">   List&lt;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">String</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">&gt; orderedPostProcessorNames </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> new</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> ArrayList&lt;&gt;();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">   List&lt;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">String</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">&gt; nonOrderedPostProcessorNames </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> new</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> ArrayList&lt;&gt;();</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">   for</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> (String ppName </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> postProcessorNames) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">      if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> (beanFactory.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">isTypeMatch</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(ppName, PriorityOrdered.class)) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">         BeanPostProcessor pp </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> beanFactory.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">getBean</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(ppName, BeanPostProcessor.class);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">         priorityOrderedPostProcessors.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">add</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(pp);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">         if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> (pp </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">instanceof</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> MergedBeanDefinitionPostProcessor) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">            internalPostProcessors.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">add</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(pp);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">         }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">      }</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">      else</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> (beanFactory.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">isTypeMatch</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(ppName, Ordered.class)) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">         orderedPostProcessorNames.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">add</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(ppName);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">      }</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">      else</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">         nonOrderedPostProcessorNames.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">add</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(ppName);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">      }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">   }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">   // First, register the BeanPostProcessors that implement PriorityOrdered.</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">   sortPostProcessors</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(priorityOrderedPostProcessors, beanFactory);</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">   registerBeanPostProcessors</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(beanFactory, priorityOrderedPostProcessors);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">   // Next, register the BeanPostProcessors that implement Ordered.</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">   List&lt;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">BeanPostProcessor</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">&gt; orderedPostProcessors </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> new</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> ArrayList&lt;&gt;(orderedPostProcessorNames.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">size</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">());</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">   for</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> (String ppName </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> orderedPostProcessorNames) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">      BeanPostProcessor pp </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> beanFactory.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">getBean</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(ppName, BeanPostProcessor.class);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">      orderedPostProcessors.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">add</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(pp);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">      if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> (pp </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">instanceof</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> MergedBeanDefinitionPostProcessor) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">         internalPostProcessors.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">add</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(pp);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">      }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">   }</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">   sortPostProcessors</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(orderedPostProcessors, beanFactory);</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">   registerBeanPostProcessors</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(beanFactory, orderedPostProcessors);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">   // Now, register all regular BeanPostProcessors.</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">   List&lt;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">BeanPostProcessor</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">&gt; nonOrderedPostProcessors </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> new</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> ArrayList&lt;&gt;(nonOrderedPostProcessorNames.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">size</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">());</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">   for</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> (String ppName </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> nonOrderedPostProcessorNames) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">      BeanPostProcessor pp </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> beanFactory.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">getBean</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(ppName, BeanPostProcessor.class);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">      nonOrderedPostProcessors.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">add</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(pp);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">      if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> (pp </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">instanceof</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> MergedBeanDefinitionPostProcessor) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">         internalPostProcessors.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">add</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(pp);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">      }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">   }</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">   registerBeanPostProcessors</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(beanFactory, nonOrderedPostProcessors);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">   // Finally, re-register all internal BeanPostProcessors.</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">   sortPostProcessors</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(internalPostProcessors, beanFactory);</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">   registerBeanPostProcessors</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(beanFactory, internalPostProcessors);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">   // Re-register post-processor for detecting inner beans as ApplicationListeners,</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">   // moving it to the end of the processor chain (for picking up proxies etc).</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">   beanFactory.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">addBeanPostProcessor</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> ApplicationListenerDetector</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(applicationContext));</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">}</span></span></code></pre><button class="code-block-unfold-btn"></button></div><ul><li><p><strong>bean 后处理器</strong>，<strong>充当 bean 的扩展点</strong>，可以工作在 bean 的实例化、依赖注入、初始化阶段，常见的有：</p><ul><li>AutowiredAnnotationBeanPostProcessor 功能有：解析 @Autowired，@Value</li></ul><figure><img src="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20231128221603715.png" alt="image-20231128221603715" loading="lazy" decoding="async" class="lazy"></figure><ul><li>CommonAnnotationBeanPostProcessor 功能有：解析 @Resource，@PostConstruct，@PreDestroy</li></ul><figure><img src="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20231128222113889.png" alt="image-20231128222113889" loading="lazy" decoding="async" class="lazy"></figure><ul><li>AnnotationAwareAspectJAutoProxyCreator 功能有：为符合切点的目标 bean 自动创建代理</li></ul><figure><img src="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20231128221128903.png" alt="image-20231128221128903" loading="lazy" decoding="async" class="lazy"></figure></li></ul><figure><img src="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230421232557342.png" alt="image-20230421232557342" loading="lazy" decoding="async" class="lazy"></figure><figure><img src="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230421232957513.png" alt="image-20230421232957513" loading="lazy" decoding="async" class="lazy"></figure><blockquote><p>Bean的后处理器是对我们Bean创建的过程中做各种功能的增强，而Bean的后处理器其实都是从beanDefinitionMap中去搜索，看看里面这些BeanDefinition有没有实现BeanPostProcessor接口，如果实现了接口就会识别出来是个特殊的Bean，是个Bean的后处理器，那么就会把这样的Bean创建出来，创建出来以后，把这个Bean的后处理器对象加人到这个beanPostProcessors集合里，那在Ben真正创建的时候就会用到这些后处理器</p></blockquote><hr><h3 id="_7-initmessagesource" tabindex="-1"><strong>7. initMessageSource</strong> <a class="header-anchor" href="#_7-initmessagesource" aria-label="Permalink to &quot;**7. initMessageSource**&quot;">​</a></h3><ul><li>这一步是为 ApplicationContext 添加 messageSource 成员，实现国际化功能</li><li>去 beanFactory 内找名为 messageSource 的 bean，如果没有，则提供空的 MessageSource 实现</li></ul><div class="language-java max-h-300px"><button title="Copy code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code v-pre><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">/**</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D"> * Initialize the MessageSource.</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D"> * Use parent's if none defined in this context.</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D"> */</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">protected</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> initMessageSource</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">() {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">   ConfigurableListableBeanFactory beanFactory </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> getBeanFactory</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">();</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">   if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> (beanFactory.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">containsLocalBean</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(MESSAGE_SOURCE_BEAN_NAME)) {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">      this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">.messageSource </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> beanFactory.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">getBean</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(MESSAGE_SOURCE_BEAN_NAME, MessageSource.class);</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">      // Make MessageSource aware of parent MessageSource.</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">      if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> (</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">.parent </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">!=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> null</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> &amp;&amp;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">.messageSource </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">instanceof</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> HierarchicalMessageSource) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">         HierarchicalMessageSource hms </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> (HierarchicalMessageSource) </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">.messageSource;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">         if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> (hms.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">getParentMessageSource</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">() </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">==</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> null</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">            // Only set parent context as parent MessageSource if no parent MessageSource</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">            // registered already.</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">            hms.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">setParentMessageSource</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">getInternalParentMessageSource</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">());</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">         }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">      }</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">      if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> (logger.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">isTraceEnabled</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">()) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">         logger.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">trace</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">"Using MessageSource ["</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> +</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">.messageSource </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">+</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF"> "]"</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">      }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">   }</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">   else</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">      // Use empty MessageSource to be able to accept getMessage calls.</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">      DelegatingMessageSource dms </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> DelegatingMessageSource</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">      dms.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">setParentMessageSource</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">getInternalParentMessageSource</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">());</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">      this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">.messageSource </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> dms;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">      beanFactory.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">registerSingleton</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(MESSAGE_SOURCE_BEAN_NAME, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">.messageSource);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">      if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> (logger.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">isTraceEnabled</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">()) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">         logger.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">trace</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">"No '"</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> +</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> MESSAGE_SOURCE_BEAN_NAME </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">+</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF"> "' bean, using ["</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> +</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">.messageSource </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">+</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF"> "]"</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">      }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">   }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">}</span></span></code></pre><button class="code-block-unfold-btn"></button></div><figure><img src="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210902183819984.png" alt="image-20210902183819984" loading="lazy" decoding="async" class="lazy"></figure><hr><h3 id="_8-initapplicationcontexteventmulticaster" tabindex="-1"><strong>8. initApplicationContextEventMulticaster</strong> <a class="header-anchor" href="#_8-initapplicationcontexteventmulticaster" aria-label="Permalink to &quot;**8. initApplicationContextEventMulticaster**&quot;">​</a></h3><ul><li>这一步为 ApplicationContext 添加事件广播器成员，即 applicationContextEventMulticaster</li><li>它的作用是发布事件给监听器</li><li>去 beanFactory 找名为 applicationEventMulticaster 的 bean 作为事件广播器，若没有，会创建默认的事件广播器</li><li>之后就可以调用 ApplicationContext.publishEvent(事件对象) 来发布事件</li></ul><div class="language-java max-h-300px"><button title="Copy code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code v-pre><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">/**</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D"> * Initialize the ApplicationEventMulticaster.</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D"> * Uses SimpleApplicationEventMulticaster if none defined in the context.</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D"> * </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">@see</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D"> org.springframework.context.event.SimpleApplicationEventMulticaster</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D"> */</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">protected</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> initApplicationEventMulticaster</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">() {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">   ConfigurableListableBeanFactory beanFactory </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> getBeanFactory</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">();</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">   if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> (beanFactory.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">containsLocalBean</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(APPLICATION_EVENT_MULTICASTER_BEAN_NAME)) {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">      this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">.applicationEventMulticaster </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">            beanFactory.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">getBean</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(APPLICATION_EVENT_MULTICASTER_BEAN_NAME, ApplicationEventMulticaster.class);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">      if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> (logger.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">isTraceEnabled</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">()) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">         logger.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">trace</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">"Using ApplicationEventMulticaster ["</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> +</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">.applicationEventMulticaster </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">+</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF"> "]"</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">      }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">   }</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">   else</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">      this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">.applicationEventMulticaster </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> SimpleApplicationEventMulticaster</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(beanFactory);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">      beanFactory.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">registerSingleton</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(APPLICATION_EVENT_MULTICASTER_BEAN_NAME, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">.applicationEventMulticaster);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">      if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> (logger.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">isTraceEnabled</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">()) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">         logger.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">trace</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">"No '"</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> +</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> APPLICATION_EVENT_MULTICASTER_BEAN_NAME </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">+</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF"> "' bean, using "</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> +</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">               "["</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> +</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">.applicationEventMulticaster.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">getClass</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">().</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">getSimpleName</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">() </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">+</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF"> "]"</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">      }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">   }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">}</span></span></code></pre><button class="code-block-unfold-btn"></button></div><figure><img src="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210902183943469.png" alt="image-20210902183943469" loading="lazy" decoding="async" class="lazy"></figure><hr><h3 id="_9-onrefresh" tabindex="-1"><strong>9. onRefresh</strong> <a class="header-anchor" href="#_9-onrefresh" aria-label="Permalink to &quot;**9. onRefresh**&quot;">​</a></h3><div class="language-java max-h-300px"><button title="Copy code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code v-pre><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">/**</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D"> * Template method which can be overridden to add context-specific refresh work.</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D"> * Called on initialization of special beans, before instantiation of singletons.</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D"> * &lt;p&gt;This implementation is empty.</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D"> * </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">@throws</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> BeansException</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D"> in case of errors</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D"> * </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">@see</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D"> #refresh()</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D"> */</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">protected</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> onRefresh</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">() throws BeansException {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">   // For subclasses: do nothing by default.</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">}</span></span></code></pre><button class="code-block-unfold-btn"></button></div><ul><li>这一步是空实现，留给子类扩展<ul><li>SpringBoot 中的子类在这里准备了 WebServer，即内嵌 web 容器</li></ul></li><li>体现的是模板方法设计模式</li></ul><hr><h3 id="_10-registerlisteners" tabindex="-1"><strong>10. registerListeners</strong> <a class="header-anchor" href="#_10-registerlisteners" aria-label="Permalink to &quot;**10. registerListeners**&quot;">​</a></h3><ul><li>这一步会从多种途径找到事件监听器，并添加至 applicationEventMulticaster</li><li>事件监听器顾名思义，用来接收事件广播器发布的事件，有如下来源<ul><li>事先编程添加的</li><li>来自容器中的 bean</li><li>来自于 @EventListener 的解析</li></ul></li><li>要实现事件监听器，只需要实现 ApplicationListener 接口，重写其中 onApplicationEvent(E e) 方法即可</li></ul><div class="language-java max-h-300px"><button title="Copy code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code v-pre><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">/**</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D"> * Add beans that implement ApplicationListener as listeners.</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D"> * Doesn't affect other listeners, which can be added without being beans.</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D"> */</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">protected</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> registerListeners</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">() {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">   // Register statically specified listeners first.</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">   for</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> (ApplicationListener&lt;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">?</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">&gt; listener </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> getApplicationListeners</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">()) {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">      getApplicationEventMulticaster</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">().</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">addApplicationListener</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(listener);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">   }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">   // Do not initialize FactoryBeans here: We need to leave all regular beans</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">   // uninitialized to let post-processors apply to them!</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">   String</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">[] listenerBeanNames </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> getBeanNamesForType</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(ApplicationListener.class, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">false</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">   for</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> (String listenerBeanName </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> listenerBeanNames) {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">      getApplicationEventMulticaster</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">().</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">addApplicationListenerBean</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(listenerBeanName);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">   }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">   // Publish early application events now that we finally have a multicaster...</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">   Set&lt;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">ApplicationEvent</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">&gt; earlyEventsToProcess </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">.earlyApplicationEvents;</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">   this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">.earlyApplicationEvents </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> null</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">   if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> (earlyEventsToProcess </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">!=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> null</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">      for</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> (ApplicationEvent earlyEvent </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> earlyEventsToProcess) {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">         getApplicationEventMulticaster</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">().</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">multicastEvent</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(earlyEvent);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">      }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">   }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">}</span></span></code></pre><button class="code-block-unfold-btn"></button></div><ul><li>微系统与第三方框架licationEventMulticaster 的实现类执行所有监听器的 onApplicationEvent 方法</li></ul><div class="language-java max-h-300px"><button title="Copy code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code v-pre><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> SimpleApplicationEventMulticaster</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> extends</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> AbstractApplicationEventMulticaster</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> {</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">	......</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">	@</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">SuppressWarnings</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">({</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">"rawtypes"</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">"unchecked"</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">})</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">	private</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> doInvokeListener</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(ApplicationListener </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70">listener</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">, ApplicationEvent </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70">event</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">		try</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">			listener.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">onApplicationEvent</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(event);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">		}</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">		catch</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> (ClassCastException </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70">ex</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">			String msg </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> ex.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">getMessage</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">();</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">			if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> (msg </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">==</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> null</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> ||</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> matchesClassCastMessage</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(msg, event.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">getClass</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">())) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">				// Possibly a lambda-defined listener which we could not resolve the generic event type for</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">				// -&gt; let's suppress the exception and just log a debug message.</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">				Log logger </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> LogFactory.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">getLog</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">getClass</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">());</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">				if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> (logger.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">isTraceEnabled</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">()) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">					logger.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">trace</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">"Non-matching event type for listener: "</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> +</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> listener, ex);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">				}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">			}</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">			else</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">				throw</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> ex;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">			}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">		}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">	}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">	......</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">}</span></span></code></pre><button class="code-block-unfold-btn"></button></div><figure><img src="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210902184343872.png" alt="image-20210902184343872" loading="lazy" decoding="async" class="lazy"></figure><hr><h3 id="_11-finishbeanfactoryinitialization" tabindex="-1"><strong>11. finishBeanFactoryInitialization</strong> <a class="header-anchor" href="#_11-finishbeanfactoryinitialization" aria-label="Permalink to &quot;**11. finishBeanFactoryInitialization**&quot;">​</a></h3><ul><li>这一步会将 beanFactory 的成员补充完毕，并初始化所有非延迟单例 bean</li><li>conversionService 也是一套转换机制，作为对 PropertyEditor 的补充</li><li>embeddedValueResolvers 即内嵌值解析器，用来解析 @Value 中的 <code>${}</code>，借用的是 Environment 的功能</li><li>singletonObjects 即单例池，缓存所有单例对象<ul><li>对象的创建都分三个阶段，每一阶段都有不同的 bean 后处理器参与进来，扩展功能</li></ul></li></ul><div class="language-java max-h-300px"><button title="Copy code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code v-pre><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">/**</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D"> * Finish the initialization of this context's bean factory,</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D"> * initializing all remaining singleton beans.</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D"> */</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">protected</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> finishBeanFactoryInitialization</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(ConfigurableListableBeanFactory beanFactory) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">   // Initialize conversion service for this context.</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">   if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> (beanFactory.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">containsBean</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(CONVERSION_SERVICE_BEAN_NAME) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">&amp;&amp;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">         beanFactory.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">isTypeMatch</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(CONVERSION_SERVICE_BEAN_NAME, ConversionService.class)) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">      beanFactory.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">setConversionService</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">            beanFactory.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">getBean</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(CONVERSION_SERVICE_BEAN_NAME, ConversionService.class));</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">   }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">   // Register a default embedded value resolver if no bean post-processor</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">   // (such as a PropertyPlaceholderConfigurer bean) registered any before:</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">   // at this point, primarily for resolution in annotation attribute values.</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">   if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">!</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">beanFactory.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">hasEmbeddedValueResolver</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">()) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">      beanFactory.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">addEmbeddedValueResolver</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(strVal </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">-&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> getEnvironment</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">().</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">resolvePlaceholders</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(strVal));</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">   }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">   // Initialize LoadTimeWeaverAware beans early to allow for registering their transformers early.</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">   String</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">[] weaverAwareNames </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> beanFactory.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">getBeanNamesForType</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(LoadTimeWeaverAware.class, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">false</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">false</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">   for</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> (String weaverAwareName </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> weaverAwareNames) {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">      getBean</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(weaverAwareName);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">   }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">   // Stop using the temporary ClassLoader for type matching.</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">   beanFactory.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">setTempClassLoader</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">null</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">   // Allow for caching all bean definition metadata, not expecting further changes.</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">   beanFactory.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">freezeConfiguration</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">();</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">   // Instantiate all remaining (non-lazy-init) singletons.</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">   beanFactory.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">preInstantiateSingletons</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">}</span></span></code></pre><button class="code-block-unfold-btn"></button></div><figure><img src="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210902184641623.png" alt="image-20210902184641623" loading="lazy" decoding="async" class="lazy"></figure><blockquote><ul><li>conversionService 也是做类型转换的，由于 Spring 的历史原因，最早是 propertyEditorRegistrars 来转换的，后来发现功能上、实现上有些欠考虑，因此设计了 conversionService 接口，这两个转换器是并存的</li><li>embeddedValueResolvers 是做 <code>${}</code> 这种内嵌值的解析，间接地调用 Environment 的功能来完成 <code>${}</code> 的解析，只不过是从属于 BeanFactory 中的成员</li><li>singletonObjects (单例池，用来缓存所有单例对象)是单例对象集合，它会找到 beanDefinitionMap 中所有使用到单例的对象，看有没有初始化方法，有没有依赖注入信息等，根据这些来创建Bean，前提是非延迟单例对象，如果是非延迟单例对象，这一步它就会把 Bean 的实例对象创建出来，如果是延迟单例对象，你第一次用到它的时候才会创建，在创建的过程中，之前的 beanPostProcessors 都可以派上用场，它们会工作在 Bean 创建的各个阶段，分为三个大的阶段，Bean 的创建、Bean 的依赖注入、Bean 的初始化，每个阶段都有不同的 Bean 后处理器参与进来，扩展功能</li></ul></blockquote><hr><h3 id="_12-finishrefresh" tabindex="-1"><strong>12. finishRefresh</strong> <a class="header-anchor" href="#_12-finishrefresh" aria-label="Permalink to &quot;**12. finishRefresh**&quot;">​</a></h3><ul><li>这一步会为 ApplicationContext 添加 lifecycleProcessor 成员，用来控制容器内需要生命周期管理的 bean</li><li>如果容器中有名称为 lifecycleProcessor 的 bean 就用它，否则创建默认的生命周期管理器</li><li>准备好生命周期管理器，就可以实现<ul><li>调用 context 的 start，即可触发所有实现 LifeCycle 接口 bean 的 start</li><li>调用 context 的 stop，即可触发所有实现 LifeCycle 接口 bean 的 stop</li></ul></li><li>发布 ContextRefreshed 事件，整个 refresh 执行完成</li></ul><div class="language-java max-h-300px"><button title="Copy code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code v-pre><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">/**</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D"> * Finish the refresh of this context, invoking the LifecycleProcessor's</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D"> * onRefresh() method and publishing the</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D"> * {@link org.springframework.context.event.ContextRefreshedEvent}.</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D"> */</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">protected</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> finishRefresh</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">() {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">   // Clear context-level resource caches (such as ASM metadata from scanning).</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">   clearResourceCaches</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">();</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">   // Initialize lifecycle processor for this context.</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">   initLifecycleProcessor</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">();</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">   // Propagate refresh to lifecycle processor first.</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">   getLifecycleProcessor</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">().</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">onRefresh</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">();</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">   // Publish the final event.</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">   publishEvent</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> ContextRefreshedEvent</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">));</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">   // Participate in LiveBeansView MBean, if active.</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">   LiveBeansView.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">registerApplicationContext</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">}</span></span></code></pre><button class="code-block-unfold-btn"></button></div><figure><img src="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210902185052433.png" alt="image-20210902185052433" loading="lazy" decoding="async" class="lazy"></figure><blockquote><p>lifecycleProcessor (生命周期处理器): 整个 Spring 容器中有很多的 Bean，它们都有自己独立的生命周期，都有一个停止，启动之类的生命周期处理，这里的生命周期并不是指初始化销毁，可以理解为一种服务，可以停止和启动，同样的从 beanDefinitionMap 中找到一个 lifecycleProcessor 的 Bean，如果有就直接用，没有它就用自己默认的生命周期处理器，这个 lifecycleProcessor 里面有 start 方法，可以调用 Bean 工厂中其他实现 lifecycleProcessor 接口的Bean的 start 方法，调用 stop 方法也一样，起到一个总控的作用，这个生命周期处理器创建好以后可以发布 ContextRefreshed 事件，表示整个 Spring 容器已经初始化( Refresh )完成</p></blockquote><hr><h3 id="总结" tabindex="-1"><strong>总结</strong> <a class="header-anchor" href="#总结" aria-label="Permalink to &quot;**总结**&quot;">​</a></h3><figure><img src="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230422003035699.png" alt="image-20230422003035699" loading="lazy" decoding="async" class="lazy"></figure><hr><h2 id="_2-spring-bean-生命周期" tabindex="-1">2. Spring bean 生命周期 <a class="header-anchor" href="#_2-spring-bean-生命周期" aria-label="Permalink to &quot;2. Spring bean 生命周期&quot;">​</a></h2><p><strong>bean 生命周期 概述</strong></p><figure><img src="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230422003651658.png" alt="image-20230422003651658" loading="lazy" decoding="async" class="lazy"></figure><ul><li>里面的这些Bean符合懒惰式初始化，开始并不会创建这些Bean，当你第一次获取时，才会创建这些Bean的实例，然后进行依赖注入初始化等操作，以doGetBean作为起点</li></ul><p>bean 的生命周期从调用 beanFactory 的 getBean 开始，到这个 bean 被销毁，可以总结为以下七个阶段：</p><ol><li>处理名称，检查缓存</li><li>处理父子容器</li><li>处理 dependsOn</li><li>选择 scope 策略</li><li>创建 bean</li><li>类型转换处理</li><li>销毁 bean</li></ol><blockquote><p><em><strong>注意</strong></em></p><ul><li>划分的阶段和名称并不重要，重要的是理解整个过程中做了哪些事情</li></ul></blockquote><hr><h3 id="_1-处理名称-检查缓存" tabindex="-1"><strong>1. 处理名称，检查缓存</strong> <a class="header-anchor" href="#_1-处理名称-检查缓存" aria-label="Permalink to &quot;**1. 处理名称，检查缓存**&quot;">​</a></h3><ul><li>这一步会处理别名，将别名解析为实际名称</li><li>对 FactoryBean 也会特殊处理，如果以 &amp; 开头表示要获取 FactoryBean 本身，否则表示要获取其产品</li><li>这里针对单例对象会检查一级、二级、三级缓存<ul><li>singletonFactories 三级缓存，存放单例工厂对象</li><li>earlySingletonObjects 二级缓存，存放单例工厂的产品对象<ul><li>如果发生循环依赖，产品是代理；无循环依赖，产品是原始对象</li></ul></li><li>singletonObjects 一级缓存，存放单例成品对象</li></ul></li></ul><div class="language-java max-h-300px"><button title="Copy code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code v-pre><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">//org.springframework.beans.factory.support.AbstractBeanFactory#doGetBean</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">{</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">    ...</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">    final</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> String beanName </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> transformedBeanName</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(name);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">    Object bean;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">    // Eagerly check singleton cache for manually registered singletons.</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">    Object sharedInstance </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> getSingleton</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(beanName);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> (sharedInstance </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">!=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> null</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> &amp;&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> args </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">==</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> null</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">       if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> (logger.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">isTraceEnabled</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">()) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">          if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> (</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">isSingletonCurrentlyInCreation</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(beanName)) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">             logger.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">trace</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">"Returning eagerly cached instance of singleton bean '"</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> +</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> beanName </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">+</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">                   "' that is not fully initialized yet - a consequence of a circular reference"</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">          }</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">          else</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">             logger.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">trace</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">"Returning cached instance of singleton bean '"</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> +</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> beanName </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">+</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF"> "'"</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">          }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">       }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">       bean </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> getObjectForBeanInstance</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(sharedInstance, name, beanName, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">null</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">	...</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">}</span></span></code></pre><button class="code-block-unfold-btn"></button></div><figure><img src="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230422005021610.png" alt="image-20230422005021610" loading="lazy" decoding="async" class="lazy"></figure><hr><h3 id="_2-处理父子容器" tabindex="-1"><strong>2. 处理父子容器</strong> <a class="header-anchor" href="#_2-处理父子容器" aria-label="Permalink to &quot;**2. 处理父子容器**&quot;">​</a></h3><ul><li>如果当前容器根据名字找不到这个 bean，此时若父容器存在，则执行父容器的 getBean 流程</li><li>优先找子容器的 bean，找到了直接返回，找不到继续到父容器找</li><li>父子容器的 bean 名称可以重复</li></ul><div class="language-java max-h-300px"><button title="Copy code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code v-pre><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">//org.springframework.beans.factory.support.AbstractBeanFactory#doGetBean</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">{</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">    ...</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">    // Check if bean definition exists in this factory.</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">    BeanFactory parentBeanFactory </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> getParentBeanFactory</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">();</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> (parentBeanFactory </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">!=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> null</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> &amp;&amp;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> !</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">containsBeanDefinition</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(beanName)) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">       // Not found -&gt; check parent.</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">       String nameToLookup </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> originalBeanName</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(name);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">       if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> (parentBeanFactory </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">instanceof</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> AbstractBeanFactory) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">          return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> ((AbstractBeanFactory) parentBeanFactory).</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">doGetBean</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">                nameToLookup, requiredType, args, typeCheckOnly);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">       }</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">       else</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> (args </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">!=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> null</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">          // Delegation to parent with explicit args.</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">          return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> (T) parentBeanFactory.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">getBean</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(nameToLookup, args);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">       }</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">       else</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> (requiredType </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">!=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> null</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">          // No args -&gt; delegate to standard getBean method.</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">          return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> parentBeanFactory.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">getBean</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(nameToLookup, requiredType);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">       }</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">       else</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">          return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> (T) parentBeanFactory.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">getBean</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(nameToLookup);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">       }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">    ...</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">}</span></span></code></pre><button class="code-block-unfold-btn"></button></div><blockquote><p>首先查找缓存，缓存里有就直接返回，缓存里如果没有，也不会立刻去创建这个Bean，如果容器中又配置了父容器的话，缓存里没有它会到父容器里查找，看看里面有没有创建好的Bean，如果有就用父容器的Bean，就不用走创建流程，如果还没有才走后续流程</p></blockquote><hr><h3 id="_3-处理-dependson" tabindex="-1"><strong>3. 处理 dependsOn</strong> <a class="header-anchor" href="#_3-处理-dependson" aria-label="Permalink to &quot;**3. 处理 dependsOn**&quot;">​</a></h3><ul><li>如果当前 bean 有通过 dependsOn 指定了非显式依赖的 bean，这一步会提前创建这些 dependsOn 的 bean</li><li>所谓非显式依赖，就是指两个 bean 之间不存在直接依赖关系，但需要控制它们的创建先后顺序</li></ul><div class="language-java max-h-300px"><button title="Copy code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code v-pre><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">//org.springframework.beans.factory.support.AbstractBeanFactory#doGetBean</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">{</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">    ...</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">    final</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> RootBeanDefinition mbd </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> getMergedLocalBeanDefinition</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(beanName);</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">    checkMergedBeanDefinition</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(mbd, beanName, args);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">    // Guarantee initialization of beans that the current bean depends on.</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">    String</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">[] dependsOn </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> mbd.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">getDependsOn</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">();</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> (dependsOn </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">!=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> null</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">       for</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> (String dep </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> dependsOn) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">          if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> (</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">isDependent</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(beanName, dep)) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">             throw</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> BeanCreationException</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(mbd.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">getResourceDescription</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(), beanName,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">                   "Circular depends-on relationship between '"</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> +</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> beanName </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">+</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF"> "' and '"</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> +</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> dep </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">+</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF"> "'"</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">          }</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">          registerDependentBean</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(dep, beanName);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">          try</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">             getBean</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(dep);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">          }</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">          catch</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> (NoSuchBeanDefinitionException </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70">ex</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">             throw</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> BeanCreationException</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(mbd.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">getResourceDescription</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(), beanName,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">                   "'"</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> +</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> beanName </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">+</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF"> "' depends on missing bean '"</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> +</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> dep </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">+</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF"> "'"</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">, ex);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">          }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">       }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">    ...</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">}</span></span></code></pre><button class="code-block-unfold-btn"></button></div><figure><img src="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230422005341839.png" alt="image-20230422005341839" loading="lazy" decoding="async" class="lazy"></figure><blockquote><p>大部分的Bean都有依赖关系，这些有依赖关系的Bean它们创建的次序是可以保障的，那些没有依赖关系的Bean可以使用dependsOn来控制次序</p></blockquote><hr><h3 id="_4-选择-scope-策略" tabindex="-1"><strong>4. 选择 scope 策略</strong> <a class="header-anchor" href="#_4-选择-scope-策略" aria-label="Permalink to &quot;**4. 选择 scope 策略**&quot;">​</a></h3><ul><li>对于 singleton scope，首先到单例池去获取 bean，如果有则直接返回，没有再进入创建流程</li><li>对于 prototype scope，每次都会进入创建流程</li><li>对于自定义 scope，例如 request，首先到 request 域获取 bean，如果有则直接返回，如果没有，则创建并放入 request</li></ul><div class="language-java max-h-300px"><button title="Copy code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code v-pre><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">//org.springframework.beans.factory.support.AbstractBeanFactory#doGetBean</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">{</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">    ...</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">    // Create bean instance.</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">       if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> (mbd.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">isSingleton</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">()) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">          sharedInstance </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> getSingleton</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(beanName, () </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">             try</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">                return</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> createBean</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(beanName, mbd, args);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">             }</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">             catch</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> (BeansException </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70">ex</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">                // Explicitly remove instance from singleton cache: It might have been put there</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">                // eagerly by the creation process, to allow for circular reference resolution.</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">                // Also remove any beans that received a temporary reference to the bean.</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">                destroySingleton</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(beanName);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">                throw</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> ex;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">             }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">          });</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">          bean </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> getObjectForBeanInstance</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(sharedInstance, name, beanName, mbd);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">       }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">       else</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> (mbd.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">isPrototype</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">()) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">          // It's a prototype -&gt; create a new instance.</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">          Object prototypeInstance </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> null</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">          try</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">             beforePrototypeCreation</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(beanName);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">             prototypeInstance </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> createBean</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(beanName, mbd, args);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">          }</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">          finally</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">             afterPrototypeCreation</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(beanName);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">          }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">          bean </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> getObjectForBeanInstance</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(prototypeInstance, name, beanName, mbd);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">       }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">       else</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">          String scopeName </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> mbd.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">getScope</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">();</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">          final</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> Scope scope </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">.scopes.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">get</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(scopeName);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">          if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> (scope </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">==</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> null</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">             throw</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> IllegalStateException</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">"No Scope registered for scope name '"</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> +</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> scopeName </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">+</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF"> "'"</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">          }</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">          try</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">             Object scopedInstance </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> scope.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">get</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(beanName, () </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">                beforePrototypeCreation</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(beanName);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">                try</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">                   return</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> createBean</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(beanName, mbd, args);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">                }</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">                finally</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">                   afterPrototypeCreation</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(beanName);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">                }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">             });</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">             bean </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> getObjectForBeanInstance</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(scopedInstance, name, beanName, mbd);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">          }</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">          catch</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> (IllegalStateException </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70">ex</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">             throw</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> BeanCreationException</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(beanName,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">                   "Scope '"</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> +</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> scopeName </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">+</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF"> "' is not active for the current thread; consider "</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> +</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">                   "defining a scoped proxy for this bean if you intend to refer to it from a singleton"</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">                   ex);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">          }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">       }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">    ...</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">}</span></span></code></pre><button class="code-block-unfold-btn"></button></div><figure><img src="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230422011157499.png" alt="image-20230422011157499" loading="lazy" decoding="async" class="lazy"></figure><hr><h3 id="_5-创建-bean" tabindex="-1">5 创建 bean <a class="header-anchor" href="#_5-创建-bean" aria-label="Permalink to &quot;5 创建 bean&quot;">​</a></h3><figure><img src="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230422013329269.png" alt="image-20230422013329269" loading="lazy" decoding="async" class="lazy"></figure><div class="language-java max-h-300px"><button title="Copy code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code v-pre><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">//org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory#createBean</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">@</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">Override</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">protected</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> Object </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">createBean</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(String beanName, RootBeanDefinition mbd, @</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">Nullable</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> Object</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">[] args)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">      throws BeanCreationException {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">	...</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">      // Give BeanPostProcessors a chance to return a proxy instead of the target bean instance.</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">      Object bean </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> resolveBeforeInstantiation</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(beanName, mbdToUse);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">	...</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">      Object beanInstance </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> doCreateBean</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(beanName, mbdToUse, args);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">	...</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">}</span></span></code></pre><button class="code-block-unfold-btn"></button></div><hr><h4 id="_5-1-创建-bean-创建-bean-实例" tabindex="-1"><strong>5.1 创建 bean - 创建 bean 实例</strong> <a class="header-anchor" href="#_5-1-创建-bean-创建-bean-实例" aria-label="Permalink to &quot;**5.1 创建 bean - 创建 bean 实例**&quot;">​</a></h4><table><thead><tr><th><strong>要点</strong></th><th><strong>总结</strong></th></tr></thead><tbody><tr><td>有自定义 TargetSource 的情况</td><td>由 AnnotationAwareAspectJAutoProxyCreator 创建代理返回</td></tr><tr><td>Supplier 方式创建 bean 实例</td><td>为 Spring 5.0 新增功能，方便编程方式创建 bean 实例</td></tr><tr><td>FactoryMethod 方式 创建 bean 实例</td><td>① 分成静态工厂与实例工厂；② 工厂方法若有参数，需要对工厂方法参数进行解析，利用 resolveDependency；③ 如果有多个工厂方法候选者，还要进一步按权重筛选</td></tr><tr><td>AutowiredAnnotationBeanPostProcessor</td><td>① 优先选择带 @Autowired 注解的构造；② 若有唯一的带参构造，也会入选</td></tr><tr><td>mbd.getPreferredConstructors</td><td>选择所有公共构造，这些构造之间按权重筛选</td></tr><tr><td>采用默认构造</td><td>如果上面的后处理器和 BeanDefinition 都没找到构造，采用默认构造，即使是私有的 ( 私有构造方法也会用私有的构造创建 Bean 的实例，使用暴力反射并通过私有构造方法进行方法调用 )</td></tr></tbody></table><ul><li><strong>创建 bean 实例之前</strong>，有自定义 TargetSource 的情况</li></ul><div class="language-java max-h-300px"><button title="Copy code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code v-pre><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">//org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory#</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">@</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">Nullable</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">protected</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> Object </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">resolveBeforeInstantiation</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(String beanName, RootBeanDefinition mbd) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">   	...</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> 	bean </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> applyBeanPostProcessorsBeforeInstantiation</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(targetType, beanName);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">	...</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">	bean </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> applyBeanPostProcessorsAfterInitialization</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(bean, beanName);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">	...</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">@</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">Nullable</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">protected</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> Object </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">applyBeanPostProcessorsBeforeInstantiation</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(Class</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">&lt;?&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> beanClass, String beanName) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">   ...</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">         Object result </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> ibp.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">postProcessBeforeInstantiation</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(beanClass, beanName);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">   ...</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">@</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">Override</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">public</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> Object </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">applyBeanPostProcessorsAfterInitialization</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(Object existingBean, String beanName)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">	throws BeansException {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> 	...</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">	Object current </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> processor.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">postProcessAfterInitialization</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(result, beanName);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">	...</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">}</span></span></code></pre><button class="code-block-unfold-btn"></button></div><div class="language-java max-h-300px"><button title="Copy code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code v-pre><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">	//org.springframework.aop.framework.autoproxy.AbstractAutoProxyCreator</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">	//创建 bean 实例之前</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">	@</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">Override</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">    public</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> Object </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">postProcessBeforeInstantiation</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(Class</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">&lt;?&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> beanClass, String beanName) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">       Object cacheKey </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> getCacheKey</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(beanClass, beanName);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">       if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">!</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">StringUtils.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">hasLength</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(beanName) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">||</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> !</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">.targetSourcedBeans.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">contains</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(beanName)) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">          if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> (</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">.advisedBeans.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">containsKey</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(cacheKey)) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">             return</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> null</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">          }</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">          if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> (</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">isInfrastructureClass</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(beanClass) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">||</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> shouldSkip</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(beanClass, beanName)) {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">             this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">.advisedBeans.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">put</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(cacheKey, Boolean.FALSE);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">             return</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> null</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">          }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">       }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">       // Create proxy here if we have a custom TargetSource.</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">       // Suppresses unnecessary default instantiation of the target bean:</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">       // The TargetSource will handle target instances in a custom fashion.</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">       TargetSource targetSource </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> getCustomTargetSource</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(beanClass, beanName);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">       if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> (targetSource </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">!=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> null</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">          if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> (StringUtils.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">hasLength</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(beanName)) {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">             this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">.targetSourcedBeans.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">add</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(beanName);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">          }</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">          Object</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">[] specificInterceptors </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> getAdvicesAndAdvisorsForBean</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(beanClass, beanName, targetSource);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">          Object proxy </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> createProxy</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(beanClass, beanName, specificInterceptors, targetSource);</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">          this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">.proxyTypes.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">put</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(cacheKey, proxy.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">getClass</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">());</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">          return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> proxy;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">       }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">       return</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> null</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">    }</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">	//bean 初始化完成之后</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">	@</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">Override</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">	public</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> Object </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">postProcessAfterInitialization</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(@</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">Nullable</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> Object bean, String beanName) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">		if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> (bean </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">!=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> null</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">			Object cacheKey </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> getCacheKey</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(bean.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">getClass</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(), beanName);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">			if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> (</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">.earlyProxyReferences.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">remove</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(cacheKey) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">!=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> bean) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">				return</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> wrapIfNecessary</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(bean, beanName, cacheKey);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">			}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">		}</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">		return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> bean;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">	}</span></span></code></pre><button class="code-block-unfold-btn"></button></div><ul><li>默认情况</li></ul><div class="language-java max-h-300px"><button title="Copy code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code v-pre><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">//org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory#doCreateBean</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">protected</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> Object </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">doCreateBean</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">final</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> String beanName, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">final</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> RootBeanDefinition mbd, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">final</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> @</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">Nullable</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> Object</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">[] args)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">			throws BeanCreationException {</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">		// Instantiate the bean.</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">		BeanWrapper instanceWrapper </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> null</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">		if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> (mbd.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">isSingleton</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">()) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">			instanceWrapper </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">.factoryBeanInstanceCache.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">remove</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(beanName);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">		}</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">		if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> (instanceWrapper </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">==</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> null</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">			instanceWrapper </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> createBeanInstance</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(beanName, mbd, args);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">		}</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">		final</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> Object bean </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> instanceWrapper.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">getWrappedInstance</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">		Class&lt;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">?</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">&gt; beanType </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> instanceWrapper.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">getWrappedClass</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">();</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">		if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> (beanType </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">!=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> NullBean.class) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">			mbd.resolvedTargetType </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> beanType;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">		}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">    ...</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">}</span></span></code></pre><button class="code-block-unfold-btn"></button></div><div class="language-java max-h-300px"><button title="Copy code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code v-pre><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">//org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory#createBeanInstance</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">protected</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> BeanWrapper </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">createBeanInstance</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(String beanName, RootBeanDefinition mbd, @</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">Nullable</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> Object</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">[] args) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">   ...</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">   Supplier&lt;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">?</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">&gt; instanceSupplier </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> mbd.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">getInstanceSupplier</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">();</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">   if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> (instanceSupplier </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">!=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> null</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">      return</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> obtainFromSupplier</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(instanceSupplier, beanName);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">   }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">   if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> (mbd.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">getFactoryMethodName</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">() </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">!=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> null</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">      return</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> instantiateUsingFactoryMethod</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(beanName, mbd, args);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">   }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">   // Shortcut when re-creating the same bean...</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">   boolean</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> resolved </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> false</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">   boolean</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> autowireNecessary </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> false</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">   if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> (args </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">==</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> null</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">      synchronized</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> (mbd.constructorArgumentLock) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">         if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> (mbd.resolvedConstructorOrFactoryMethod </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">!=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> null</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">            resolved </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">            autowireNecessary </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> mbd.constructorArgumentsResolved;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">         }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">      }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">   }</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">   if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> (resolved) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">      if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> (autowireNecessary) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">         return</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> autowireConstructor</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(beanName, mbd, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">null</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">null</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">      }</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">      else</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">         return</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> instantiateBean</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(beanName, mbd);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">      }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">   }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">   // Candidate constructors for autowiring?</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">   Constructor&lt;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">?</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">&gt;[] ctors </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> determineConstructorsFromBeanPostProcessors</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(beanClass, beanName);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">   if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> (ctors </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">!=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> null</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> ||</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> mbd.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">getResolvedAutowireMode</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">() </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">==</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> AUTOWIRE_CONSTRUCTOR </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">||</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">         mbd.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">hasConstructorArgumentValues</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">() </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">||</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> !</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">ObjectUtils.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">isEmpty</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(args)) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">      return</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> autowireConstructor</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(beanName, mbd, ctors, args);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">   }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">   // Preferred constructors for default construction?</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">   ctors </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> mbd.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">getPreferredConstructors</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">();</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">   if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> (ctors </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">!=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> null</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">      return</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> autowireConstructor</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(beanName, mbd, ctors, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">null</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">   }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">   // No special handling: simply use no-arg constructor.</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">   return</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> instantiateBean</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(beanName, mbd);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">}</span></span></code></pre><button class="code-block-unfold-btn"></button></div><hr><h4 id="_5-2-创建-bean-依赖注入" tabindex="-1"><strong>5.2 创建 bean - 依赖注入</strong> <a class="header-anchor" href="#_5-2-创建-bean-依赖注入" aria-label="Permalink to &quot;**5.2 创建 bean - 依赖注入**&quot;">​</a></h4><figure><img src="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230422013843155.png" alt="image-20230422013843155" loading="lazy" decoding="async" class="lazy"></figure><div class="language-java max-h-300px"><button title="Copy code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code v-pre><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">//org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory#doCreateBean</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">{</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">        ...</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">        // Allow post-processors to modify the merged bean definition.</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">		synchronized</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> (mbd.postProcessingLock) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">			if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">!</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">mbd.postProcessed) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">				try</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">					applyMergedBeanDefinitionPostProcessors</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(mbd, beanType, beanName);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">				}</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">				catch</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> (Throwable </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70">ex</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">					throw</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> BeanCreationException</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(mbd.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">getResourceDescription</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(), beanName,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">							"Post-processing of merged bean definition failed"</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">, ex);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">				}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">				mbd.postProcessed </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">			}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">		}</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">    	// Eagerly cache singletons to be able to resolve circular references</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">		// even when triggered by lifecycle interfaces like BeanFactoryAware.</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">		boolean</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> earlySingletonExposure </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> (mbd.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">isSingleton</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">() </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">&amp;&amp;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">.allowCircularReferences </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">&amp;&amp;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">				isSingletonCurrentlyInCreation</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(beanName));</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">		if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> (earlySingletonExposure) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">			if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> (logger.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">isTraceEnabled</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">()) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">				logger.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">trace</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">"Eagerly caching bean '"</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> +</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> beanName </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">+</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">						"' to allow for resolving potential circular references"</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">			}</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">             //添加单例工厂</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">			addSingletonFactory</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(beanName, () </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">-&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> getEarlyBeanReference</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(beanName, mbd, bean));</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">		}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">    	...</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">        	populateBean</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(beanName, mbd, instanceWrapper);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> 	...</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">}</span></span></code></pre><button class="code-block-unfold-btn"></button></div><div class="language-java max-h-300px"><button title="Copy code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code v-pre><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">//org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory#applyMergedBeanDefinitionPostProcessors</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">protected</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> applyMergedBeanDefinitionPostProcessors</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(RootBeanDefinition mbd, Class</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">&lt;?&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> beanType, String beanName) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">   for</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> (BeanPostProcessor bp </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> getBeanPostProcessors</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">()) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">      if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> (bp </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">instanceof</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> MergedBeanDefinitionPostProcessor) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">         MergedBeanDefinitionPostProcessor bdp </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> (MergedBeanDefinitionPostProcessor) bp;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">         bdp.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">postProcessMergedBeanDefinition</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(mbd, beanType, beanName);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">      }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">   }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">}</span></span></code></pre><button class="code-block-unfold-btn"></button></div><ul><li>AutowiredAnnotationBeanPostProcessor</li></ul><div class="language-java max-h-300px"><button title="Copy code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code v-pre><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">//org.springframework.beans.factory.annotation.AutowiredAnnotationBeanPostProcessor#postProcessMergedBeanDefinition</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">@</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">Override</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> postProcessMergedBeanDefinition</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(RootBeanDefinition beanDefinition, Class</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">&lt;?&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> beanType, String beanName) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">   InjectionMetadata metadata </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> findAutowiringMetadata</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(beanName, beanType, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">null</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">   metadata.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">checkConfigMembers</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(beanDefinition);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">}</span></span></code></pre><button class="code-block-unfold-btn"></button></div><ul><li>CommonAnnotationBeanPostProcessor</li></ul><div class="language-java max-h-300px"><button title="Copy code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code v-pre><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">//org.springframework.context.annotation.CommonAnnotationBeanPostProcessor#postProcessMergedBeanDefinition</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">@</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">Override</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> postProcessMergedBeanDefinition</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(RootBeanDefinition beanDefinition, Class</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">&lt;?&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> beanType, String beanName) {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">   super</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">postProcessMergedBeanDefinition</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(beanDefinition, beanType, beanName);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">   InjectionMetadata metadata </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> findResourceMetadata</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(beanName, beanType, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">null</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">   metadata.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">checkConfigMembers</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(beanDefinition);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">}</span></span></code></pre><button class="code-block-unfold-btn"></button></div><ul><li><code>AUTOWIRE_BY_NAME;AUTOWIRE_BY_TYPE;resolveDependency;applyPropertyValues</code></li></ul><div class="language-java max-h-300px"><button title="Copy code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code v-pre><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">//org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory#populateBean</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">protected</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> populateBean</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(String beanName, RootBeanDefinition mbd, @</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">Nullable</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> BeanWrapper bw) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">   ...</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">   PropertyValues pvs </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> (mbd.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">hasPropertyValues</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">() </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">?</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> mbd.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">getPropertyValues</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">() </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> null</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">   int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> resolvedAutowireMode </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> mbd.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">getResolvedAutowireMode</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">();</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">   if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> (resolvedAutowireMode </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">==</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> AUTOWIRE_BY_NAME </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">||</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> resolvedAutowireMode </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">==</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> AUTOWIRE_BY_TYPE) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">      ...</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">   }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">   ...</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">   if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> (needsDepCheck) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">      if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> (filteredPds </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">==</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> null</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">         filteredPds </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> filterPropertyDescriptorsForDependencyCheck</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(bw, mbd.allowCaching);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">      }</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">      checkDependencies</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(beanName, mbd, filteredPds, pvs);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">   }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">   if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> (pvs </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">!=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> null</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">) {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">      applyPropertyValues</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(beanName, mbd, bw, pvs);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">   }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">}</span></span></code></pre><button class="code-block-unfold-btn"></button></div><table><thead><tr><th><strong>要点</strong></th><th><strong>总结</strong></th></tr></thead><tbody><tr><td>AutowiredAnnotationBeanPostProcessor</td><td>识别 @Autowired 及 @Value 标注的成员，封装为 InjectionMetadata 进行依赖注入</td></tr><tr><td>CommonAnnotationBeanPostProcessor</td><td>识别 @Resource 标注的成员，封装为 InjectionMetadata 进行依赖注入</td></tr><tr><td>resolveDependency</td><td>用来查找要装配的值，可以识别：① Optional；② ObjectFactory 及 ObjectProvider；③ @Lazy 注解；④ @Value 注解（<code>${}</code>, <code>#{}</code>, 类型转换）；⑤ 集合类型（Collection，Map，数组等）；⑥ 泛型和 @Qualifier（用来区分类型歧义）；⑦ primary 及名字匹配（用来区分类型歧义）</td></tr><tr><td>AUTOWIRE_BY_NAME</td><td>根据成员名字找 bean 对象，修改 mbd 的 propertyValues，不会考虑简单类型的成员</td></tr><tr><td>AUTOWIRE_BY_TYPE</td><td>根据成员类型执行 resolveDependency 找到依赖注入的值，修改 mbd 的 propertyValues</td></tr><tr><td>applyPropertyValues</td><td>根据 mbd 的 propertyValues 进行依赖注入（即xml中 `&lt;property name ref</td></tr></tbody></table><ul><li>相同成员依赖注入优先级：精准匹配&gt;按类型/名字匹配&gt;注解方式匹配</li></ul><figure><img src="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230422014541831.png" alt="image-20230422014541831" loading="lazy" decoding="async" class="lazy"></figure><blockquote><p>Bean的实例对象刚刚创建时里面是空空如也的，需要不断补充和完善它，接下来就对当前这个Bean的实例进行依赖注入，即建立当前这个Bean的实例跟容器中其他Bean之间的依赖关系，可以通过注解匹配和根据类型以及名字匹配</p><ul><li>在依赖注入阶段，有个条件是产生循环依赖，产生循环依赖以后，它会在单例工厂池中通过一个工厂对象来间接的调用到我们的自动代理后处理器类来创建代理</li></ul><div class="language-java max-h-300px"><button title="Copy code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code v-pre><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">//org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory#getEarlyBeanReference</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">      ...</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">         exposedObject </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> bp.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">getEarlyBeanReference</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(exposedObject, beanName);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">      ...</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">//org.springframework.aop.framework.autoproxy.AbstractAutoProxyCreator#getEarlyBeanReference         </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">	@</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">Override</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">	public</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> Object </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">getEarlyBeanReference</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(Object bean, String beanName) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">		Object cacheKey </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> getCacheKey</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(bean.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">getClass</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(), beanName);</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">		this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">.earlyProxyReferences.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">put</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(cacheKey, bean);</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">         //创建代理方法</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">		return</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> wrapIfNecessary</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(bean, beanName, cacheKey);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">	}</span></span></code></pre><button class="code-block-unfold-btn"></button></div></blockquote><hr><h4 id="_5-3-创建-bean-初始化" tabindex="-1"><strong>5.3 创建 bean - 初始化</strong> <a class="header-anchor" href="#_5-3-创建-bean-初始化" aria-label="Permalink to &quot;**5.3 创建 bean - 初始化**&quot;">​</a></h4><figure><img src="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230422014943738.png" alt="image-20230422014943738" loading="lazy" decoding="async" class="lazy"></figure><div class="language-java max-h-300px"><button title="Copy code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code v-pre><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">//org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory#doCreateBean</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">{    </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">    ...</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">    // Initialize the bean instance.</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">    Object exposedObject </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> bean;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">    ...</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">       exposedObject </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> initializeBean</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(beanName, exposedObject, mbd);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">    ...</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">}</span></span></code></pre><button class="code-block-unfold-btn"></button></div><div class="language-java max-h-300px"><button title="Copy code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code v-pre><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">//org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory#initializeBean</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">protected</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> Object </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">initializeBean</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">final</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> String beanName, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">final</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> Object bean, @</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">Nullable</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> RootBeanDefinition mbd) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">   if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> (System.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">getSecurityManager</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">() </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">!=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> null</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">      AccessController.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">doPrivileged</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">((PrivilegedAction</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">&lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">Object</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">) () </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">         invokeAwareMethods</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(beanName, bean);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">         return</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> null</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">      }, </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">getAccessControlContext</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">());</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">   }</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">   else</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">      invokeAwareMethods</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(beanName, bean);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">   }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">   Object wrappedBean </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> bean;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">   if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> (mbd </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">==</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> null</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> ||</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> !</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">mbd.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">isSynthetic</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">()) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">      wrappedBean </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> applyBeanPostProcessorsBeforeInitialization</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(wrappedBean, beanName);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">   }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">   ...</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">      invokeInitMethods</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(beanName, wrappedBean, mbd);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">   ...</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">   if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> (mbd </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">==</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> null</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> ||</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> !</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">mbd.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">isSynthetic</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">()) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">      //有自定义 TargetSource 的情况由 AnnotationAwareAspectJAutoProxyCreator 创建代理返回</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">      wrappedBean </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> applyBeanPostProcessorsAfterInitialization</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(wrappedBean, beanName);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">   }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">   return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> wrappedBean;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">}</span></span></code></pre><button class="code-block-unfold-btn"></button></div><table><thead><tr><th><strong>要点</strong></th><th><strong>总结</strong></th></tr></thead><tbody><tr><td>内置 Aware 接口的装配</td><td>包括 BeanNameAware，BeanFactoryAware 等</td></tr><tr><td>扩展 Aware 接口的装配</td><td>由 ApplicationContextAwareProcessor 解析，执行时机在 postProcessBeforeInitialization</td></tr><tr><td>@PostConstruct</td><td>由 CommonAnnotationBeanPostProcessor 解析，执行时机在 postProcessBeforeInitialization</td></tr><tr><td>InitializingBean</td><td>通过接口回调执行初始化</td></tr><tr><td>initMethod</td><td>根据 BeanDefinition 得到的初始化方法执行初始化，即 <code>&lt;bean init-method&gt;</code> 或 @Bean(initMethod)</td></tr><tr><td>创建 aop 代理</td><td>由 AnnotationAwareAspectJAutoProxyCreator 创建，执行时机在 postProcessAfterInitialization</td></tr></tbody></table><ul><li>初始化顺序：<ul><li>1.执行BeanFactoryAware接口的定义的初始化方法setBeanFactory</li><li>2.执行标注@PostConstruct的方法init</li><li>3.执行InitializingBean接口的重写方法初始化afterPorpertiesSet</li><li>4.执行用BeanDefinition指定的初始化方法</li></ul></li></ul><figure><img src="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230422015021268.png" alt="image-20230422015021268" loading="lazy" decoding="async" class="lazy"></figure><blockquote><p>初始化阶段：处理一些Aware接口、调用初始化方法、创建aop代理(如果你的Bean跟切面表达式匹配上，就帮你创建代理)，在初始化阶段，由Spring的BeanFactory容器来回调Aware接口中的方法，如你实现了BeanFactoryAware接口，就会相应地把BeanFactory对象通过回调此接口的方法给你传递进来 初始化方法：@PostConstruct是通过一个Bean的后处理器来进行调用的</p></blockquote><hr><h4 id="_5-4-创建-bean-注册可销毁-bean" tabindex="-1"><strong>5.4 创建 bean - 注册可销毁 bean</strong> <a class="header-anchor" href="#_5-4-创建-bean-注册可销毁-bean" aria-label="Permalink to &quot;**5.4 创建 bean - 注册可销毁 bean**&quot;">​</a></h4><figure><img src="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230422015302186.png" alt="image-20230422015302186" loading="lazy" decoding="async" class="lazy"></figure><div class="language-java max-h-300px"><button title="Copy code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code v-pre><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">//org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory#doCreateBean</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">...</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">// Register bean as disposable.</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">try</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">   registerDisposableBeanIfNecessary</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(beanName, bean, mbd);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">}</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">catch</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> (BeanDefinitionValidationException </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70">ex</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">   throw</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> BeanCreationException</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">         mbd.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">getResourceDescription</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(), beanName, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">"Invalid destruction signature"</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">, ex);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">...</span></span></code></pre><button class="code-block-unfold-btn"></button></div><div class="language-java max-h-300px"><button title="Copy code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code v-pre><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">//org.springframework.beans.factory.support.AbstractBeanFactory#registerDisposableBeanIfNecessary</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">protected</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> registerDisposableBeanIfNecessary</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(String beanName, Object bean, RootBeanDefinition mbd) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">   AccessControlContext acc </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> (System.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">getSecurityManager</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">() </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">!=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> null</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> ?</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> getAccessControlContext</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">() </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> null</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">   if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">!</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">mbd.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">isPrototype</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">() </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">&amp;&amp;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> requiresDestruction</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(bean, mbd)) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">      if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> (mbd.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">isSingleton</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">()) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">         // Register a DisposableBean implementation that performs all destruction</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">         // work for the given bean: DestructionAwareBeanPostProcessors,</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">         // DisposableBean interface, custom destroy method.</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">         registerDisposableBean</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(beanName,</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">               new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> DisposableBeanAdapter</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(bean, beanName, mbd, </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">getBeanPostProcessors</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(), acc));</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">      }</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">      else</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">         // A bean with a custom scope...</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">         Scope scope </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">.scopes.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">get</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(mbd.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">getScope</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">());</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">         if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> (scope </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">==</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> null</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">            throw</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> IllegalStateException</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">"No Scope registered for scope name '"</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> +</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> mbd.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">getScope</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">() </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">+</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF"> "'"</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">         }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">         scope.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">registerDestructionCallback</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(beanName,</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">               new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> DisposableBeanAdapter</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(bean, beanName, mbd, </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">getBeanPostProcessors</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(), acc));</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">      }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">   }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">}</span></span></code></pre><button class="code-block-unfold-btn"></button></div><p>在这一步判断并登记可销毁 bean</p><ul><li>判断依据<ul><li>如果实现了 DisposableBean 或 AutoCloseable 接口，则为可销毁 bean</li><li>如果自定义了 destroyMethod，则为可销毁 bean</li><li>如果采用 @Bean 没有指定 destroyMethod，则采用自动推断方式获取销毁方法名（close，shutdown）</li><li>如果有 @PreDestroy 标注的方法</li></ul></li><li>存储位置<ul><li>singleton scope 的可销毁 bean 会存储于 beanFactory 的成员当中</li><li>自定义 scope 的可销毁 bean 会存储于对应的域对象当中</li><li>prototype scope 不会存储，需要自己找到此对象销毁</li></ul></li><li>存储时都会封装为 DisposableBeanAdapter 类型对销毁方法的调用进行适配</li></ul><hr><h3 id="_6-类型转换处理" tabindex="-1"><strong>6. 类型转换处理</strong> <a class="header-anchor" href="#_6-类型转换处理" aria-label="Permalink to &quot;**6. 类型转换处理**&quot;">​</a></h3><ul><li>如果 getBean 的 requiredType 参数与实际得到的对象类型不同，会尝试进行类型转换</li><li>这时Bean已经被创建并作为结果返回</li></ul><figure><img src="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230422015511898.png" alt="image-20230422015511898" loading="lazy" decoding="async" class="lazy"></figure><hr><h3 id="_7-销毁-bean" tabindex="-1"><strong>7. 销毁 bean</strong> <a class="header-anchor" href="#_7-销毁-bean" aria-label="Permalink to &quot;**7. 销毁 bean**&quot;">​</a></h3><ul><li>销毁时机<ul><li>singleton bean 的销毁在 ApplicationContext.close 时，此时会找到所有 DisposableBean 的名字，逐一销毁</li><li>自定义 scope bean 的销毁在作用域对象生命周期结束时（这类Bean的销毁时机在request域生命周期结束的时候，在它结束之前调用request scope bean的一个销毁）</li><li>prototype bean 的销毁可以通过自己手动调用 AutowireCapableBeanFactory.destroyBean 方法执行销毁</li></ul></li><li>同一 bean 中不同形式销毁方法的调用次序<ul><li>优先后处理器销毁，即 @PreDestroy</li><li>其次 DisposableBean 接口销毁</li><li>最后 destroyMethod 销毁（包括自定义名称，推断名称，AutoCloseable 接口 多选一）</li></ul></li></ul><hr><h3 id="总结-1" tabindex="-1"><strong>总结</strong> <a class="header-anchor" href="#总结-1" aria-label="Permalink to &quot;**总结**&quot;">​</a></h3><figure><img src="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230422015825420.png" alt="image-20230422015825420" loading="lazy" decoding="async" class="lazy"></figure><hr><h2 id="_3-spring-bean-循环依赖" tabindex="-1">3. Spring bean 循环依赖 <a class="header-anchor" href="#_3-spring-bean-循环依赖" aria-label="Permalink to &quot;3. Spring bean 循环依赖&quot;">​</a></h2><h3 id="补充-创建代理" tabindex="-1">补充：创建代理 <a class="header-anchor" href="#补充-创建代理" aria-label="Permalink to &quot;补充：创建代理&quot;">​</a></h3><p><strong>要点</strong></p><ul><li>要完全理解循环依赖，需要理解代理对象的创建时机</li><li>掌握 ProxyFactory 创建代理的过程，理解 Advisor，Advice，Pointcut 与 Aspect</li><li>掌握 AnnotationAwareAspectJAutoProxyCreator 筛选 Advisor 合格者，创建代理的过程<ul><li>bean 的后处理器，作用是为我们容器中的 bean，那些目标 bean 需不需要为之创建代理，它内部也会间接调用 ProxyFactory 来创建代理</li></ul></li></ul><p><strong>代理工厂</strong></p><ul><li>只加了通知（环绕通知）来进行功能增强</li></ul><figure><img src="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230423122730735.png" alt="image-20230423122730735" loading="lazy" decoding="async" class="lazy"></figure><figure><img src="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20231202153033525.png" alt="image-20231202153033525" loading="lazy" decoding="async" class="lazy"></figure><ul><li>加入切点，观察CGLIB动态代理和JDK动态代理的区别</li></ul><figure><img src="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230423123833981.png" alt="image-20230423123833981" loading="lazy" decoding="async" class="lazy"></figure><blockquote><p><strong>说说 JDK 动态代理和 CGLIB 代理 ？</strong></p><p>Spring 的 AOP 是通过<a href="https://mp.weixin.qq.com/s/aZtfwik0weJN5JzYc-JxYg" target="_blank" rel="noreferrer">动态代理open in new window</a>来实现的，动态代理主要有两种方式 JDK 动态代理和 Cglib 动态代理，这两种动态代理的使用和原理有些不同。</p><p><strong>JDK 动态代理</strong></p><ol><li><strong>Interface</strong>：对于 JDK 动态代理，目标类需要实现一个 Interface。</li><li><strong>InvocationHandler</strong>：InvocationHandler 是一个接口，可以通过实现这个接口，定义横切逻辑，再通过反射机制（invoke）调用目标类的代码，在此过程，可能包装逻辑，对目标方法进行前置后置处理。</li><li><strong>Proxy</strong>：Proxy 利用 InvocationHandler 动态创建一个符合目标类实现的接口的实例，生成目标类的代理对象。</li></ol><p><strong>CgLib 动态代理</strong></p><ol><li>使用 JDK 创建代理有一大限制，它只能为接口创建代理实例，而 CgLib 动态代理就没有这个限制。</li><li>CgLib 动态代理是使用字节码处理框架 <strong>ASM</strong>，其原理是通过字节码技术为一个类创建子类，并在子类中采用方法拦截的技术拦截所有父类方法的调用，顺势织入横切逻辑。</li><li><strong>CgLib</strong> 创建的动态代理对象性能比 JDK 创建的动态代理对象的性能高不少，但是 CGLib 在创建代理对象时所花费的时间却比 JDK 多得多，所以对于单例的对象，因为无需频繁创建对象，用 CGLib 合适，反之，使用 JDK 方式要更为合适一些。同时，由于 CGLib 是采用动态创建子类的方法，对于 final 方法，无法进行代理。</li></ol><p>我们来看一个常见的小场景，客服中转，解决用户问题：</p><figure><img src="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/spring-c5c4b247-62dd-43a2-a043-da51c58f77c8.png" alt="用户向客服提问题" loading="lazy" decoding="async" class="lazy"></figure><p><strong>JDK 动态代理实现：</strong></p><figure><img src="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/spring-65b14a3f-2653-463e-af77-a8875d3d635c.png" alt="JDK动态代理类图" loading="lazy" decoding="async" class="lazy"></figure><ul><li><p>接口</p><div class="language-java max-h-300px"><button title="Copy code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code v-pre><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> interface</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> ISolver</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">    void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> solve</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">}</span></span></code></pre><button class="code-block-unfold-btn"></button></div></li><li><p>目标类:需要实现对应接口</p><div class="language-java max-h-300px"><button title="Copy code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code v-pre><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> Solver</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> implements</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> ISolver</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">    @</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">Override</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">    public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> solve</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">() {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">        System.out.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">println</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">"疯狂掉头发解决问题……"</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">}</span></span></code></pre><button class="code-block-unfold-btn"></button></div></li><li><p>态代理工厂:ProxyFactory，直接用反射方式生成一个目标对象的代理对象，这里用了一个匿名内部类方式重写 InvocationHandler 方法，实现接口重写也差不多</p><div class="language-java max-h-300px"><button title="Copy code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code v-pre><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> ProxyFactory</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> {</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">    // 维护一个目标对象</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">    private</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> Object target;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">    public</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> ProxyFactory</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(Object </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70">target</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">) {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">        this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">.target </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> target;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">    // 为目标对象生成代理对象</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">    public</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> Object </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">getProxyInstance</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">() {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">        return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> Proxy.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">newProxyInstance</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(target.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">getClass</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">().</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">getClassLoader</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(), target.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">getClass</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">().</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">getInterfaces</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(),</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">                new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> InvocationHandler</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">() {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">                    @</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">Override</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">                    public</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> Object </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">invoke</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(Object </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70">proxy</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">, Method </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70">method</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">Object</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">[] </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70">args</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">throws</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> Throwable {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">                        System.out.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">println</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">"请问有什么可以帮到您？"</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">                        // 调用目标对象方法</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">                        Object returnValue </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> method.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">invoke</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(target, args);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">                        System.out.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">println</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">"问题已经解决啦！"</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">                        return</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> null</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">                    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">                });</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">}</span></span></code></pre><button class="code-block-unfold-btn"></button></div></li><li><p>客户端：Client，生成一个代理对象实例，通过代理对象调用目标对象方法</p><div class="language-java max-h-300px"><button title="Copy code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code v-pre><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> Client</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">    public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> static</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> main</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">String</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">[] </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70">args</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">        //目标对象:程序员</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">        ISolver developer </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> Solver</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">();</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">        //代理：客服小姐姐</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">        ISolver csProxy </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> (ISolver) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> ProxyFactory</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(developer).</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">getProxyInstance</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">();</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">        //目标方法：解决问题</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">        csProxy.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">solve</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">}</span></span></code></pre><button class="code-block-unfold-btn"></button></div></li></ul><p><strong>Cglib 动态代理实现：</strong></p><figure><img src="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/spring-74da87af-20d1-4a5b-a212-3837a15f0bab.png" alt="Cglib动态代理类图" loading="lazy" decoding="async" class="lazy"></figure><ul><li><p>目标类：Solver，这里目标类不用再实现接口。</p><div class="language-java max-h-300px"><button title="Copy code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code v-pre><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> Solver</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> {</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">    public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> solve</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">() {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">        System.out.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">println</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">"疯狂掉头发解决问题……"</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">}</span></span></code></pre><button class="code-block-unfold-btn"></button></div></li><li><p>动态代理工厂：</p><div class="language-java max-h-300px"><button title="Copy code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code v-pre><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> ProxyFactory</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> implements</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> MethodInterceptor</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> {</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">   //维护一个目标对象</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">    private</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> Object target;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">    public</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> ProxyFactory</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(Object </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70">target</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">) {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">        this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">.target </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> target;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">    //为目标对象生成代理对象</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">    public</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> Object </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">getProxyInstance</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">() {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">        //工具类</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">        Enhancer en </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> Enhancer</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">();</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">        //设置父类</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">        en.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">setSuperclass</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(target.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">getClass</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">());</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">        //设置回调函数</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">        en.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">setCallback</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">);</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">        //创建子类对象代理</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">        return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> en.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">create</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">    @</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">Override</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">    public</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> Object </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">intercept</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(Object </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70">obj</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">, Method </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70">method</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">Object</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">[] </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70">args</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">, MethodProxy </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70">proxy</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">throws</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> Throwable {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">        System.out.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">println</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">"请问有什么可以帮到您？"</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">);</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">        // 执行目标对象的方法</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">        Object returnValue </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> method.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">invoke</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(target, args);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">        System.out.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">println</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">"问题已经解决啦！"</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">        return</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> null</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">}</span></span></code></pre><button class="code-block-unfold-btn"></button></div></li><li><p>客户端：Client</p><div class="language-java max-h-300px"><button title="Copy code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code v-pre><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> Client</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">    public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> static</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> main</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">String</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">[] </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70">args</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">        //目标对象:程序员</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">        Solver developer </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> Solver</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">();</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">        //代理：客服小姐姐</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">        Solver csProxy </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> (Solver) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> ProxyFactory</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(developer).</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">getProxyInstance</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">();</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">        //目标方法：解决问题</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">        csProxy.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">solve</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">}</span></span></code></pre><button class="code-block-unfold-btn"></button></div></li></ul></blockquote><p><strong>代理对象与advisor的关系</strong></p><ul><li>代理对象会间接去引用这些Advisor切面</li></ul><figure><img src="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230423124430187.png" alt="image-20230423124430187" loading="lazy" decoding="async" class="lazy"></figure><p><strong>@Aspect与advisor的关系</strong></p><ul><li>注解方式，整个类是一个切面，方法是通知，注解里的表达式是切点，这些注解的方式最终还是会转换成MethodInterceptor和Advisor这种方式的，而且转换的方式是以这种通知方法为单位来进行转换的，如有一个Aspect1的类它里面有一个环绕通知，最终会转换成一个advisor的切面，一个通知方法对应一个advisor切面，一个类中有多个通知方法就分别对应一个advisor切面，advisor切面相当于是一种更基本的或是Spring内置的这种切面形式，对于这些环绕通知，前置通知，后置通知也好，它们最终都会转换成Spring内置的MethodInterceptor的这种环绕通知的调用方式</li></ul><figure><img src="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230423143827599.png" alt="image-20230423143827599" loading="lazy" decoding="async" class="lazy"></figure><p><strong>AnnotationAwareAspectJAutoProxyCreator 自动代理后处理器</strong></p><figure><img src="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20231202162832299.png" alt="image-20231202162832299" loading="lazy" decoding="async" class="lazy"></figure><ul><li>wrapIfNecessary</li></ul><div class="language-java max-h-300px"><button title="Copy code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code v-pre><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">//org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory#initializeBean</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">...</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">      wrappedBean </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> applyBeanPostProcessorsAfterInitialization</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(wrappedBean, beanName);</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">//↓↓</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">...</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">//org.springframework.aop.framework.autoproxy.AbstractAutoProxyCreator#postProcessAfterInitialization</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">...</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">    return</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> wrapIfNecessary</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(bean, beanName, cacheKey);</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">//↓↓</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">...</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">//AbstractAutoProxyCreator#wrapIfNecessary  </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">    // Create proxy if we have advice.</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">    ...</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">        Object proxy </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> createProxy</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">                bean.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">getClass</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(), beanName, specificInterceptors, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> SingletonTargetSource</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(bean));</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">    ...</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">//AbstractAutoProxyCreator#createProxy</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">...</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">	return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> proxyFactory.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">getProxy</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(classLoader);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">...</span></span></code></pre><button class="code-block-unfold-btn"></button></div><figure><img src="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230423144839058.png" alt="image-20230423144839058" loading="lazy" decoding="async" class="lazy"></figure><ul><li>wrapIfNecessary-DEBUG</li></ul><figure><img src="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230423150240536.png" alt="image-20230423150240536" loading="lazy" decoding="async" class="lazy"></figure><ul><li><p>代理创建时机</p><ul><li>创建 bean 实例之前，如果你的bean自定义了 TargetSource，就会调用到自动代理后处理器来创建代理对象（用得较少，了解即可）；</li><li>在初始化阶段，会调用到这个自动代理后处理器，在初始化执行完以后，就要调用后处理器的 PostProcessAfterInitialization 方法，这时候就会用到这个自动代理后处理器来创建代理对象；</li><li>在依赖注入阶段，有个条件是产生循环依赖，产生循环依赖以后，它会在单例工厂池中通过一个工厂对象来间接的调用到我们的自动代理后处理器类来创建代理<ul><li><code>org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory#postProcessObjectFromFactoryBean</code></li></ul></li></ul><div class="language-java max-h-300px"><button title="Copy code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code v-pre><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">/**</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D"> * Applies the {@code postProcessAfterInitialization} callback of all</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D"> * registered BeanPostProcessors, giving them a chance to post-process the</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D"> * object obtained from FactoryBeans (for example, to auto-proxy them).</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D"> * </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">@see</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D"> #applyBeanPostProcessorsAfterInitialization</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D"> */</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">@</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">Override</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">protected</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> Object </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">postProcessObjectFromFactoryBean</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(Object object, String beanName) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">   return</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> applyBeanPostProcessorsAfterInitialization</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(object, beanName);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">}</span></span></code></pre><button class="code-block-unfold-btn"></button></div></li></ul><figure><img src="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230423150540283.png" alt="image-20230423150540283" loading="lazy" decoding="async" class="lazy"></figure><figure><img src="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230423150918284.png" alt="image-20230423150918284" loading="lazy" decoding="async" class="lazy"></figure><p><strong>总结</strong></p><ul><li>最基本的切面是 Advisor，一个Aspect 切面对应一到多个 Advisor</li><li>最基本的 Advice 是 Methodinterceptor，其它 Advice 最终都将适配为 Methodinterceptor</li><li>创建代理的方式<ul><li>实现了用户自定义接口，采用jdk 动态代理</li><li>没有实现用户自定义接口，采用 cglib 代理</li><li>设置了 setProxyTargetClass(true)，统一采用 cglib 代理</li></ul></li><li>切面、切点、通知等不会被代理</li><li>AnnotationAwareAspectJAutoProxyCreator 调用时机: 创建阶段、依赖注入阶段、<strong>初始化阶段</strong></li></ul><hr><h3 id="循环依赖的产生" tabindex="-1"><strong>循环依赖的产生</strong> <a class="header-anchor" href="#循环依赖的产生" aria-label="Permalink to &quot;**循环依赖的产生**&quot;">​</a></h3><ul><li>首先要明白，bean 的创建要遵循一定的步骤，必须是创建、注入、初始化三步，这些顺序不能乱</li></ul><img src="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210903085238916.png" alt="image-20210903085238916" class="scale-50"><ul><li><p>set 方法（包括成员变量）的循环依赖如图所示</p><ul><li><p>可以在【a 创建】和【a set 注入 b】之间加入 b 的整个流程来解决</p></li><li><p>【b set 注入 a】 时可以成功，因为之前 a 的实例（未初始化）已经创建完毕</p></li><li><p>a 的顺序，及 b 的顺序都能得到保障</p></li></ul></li></ul><img src="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210903085454603.png" alt="image-20210903085454603" class="scale-33"><ul><li>构造方法的循环依赖如图所示，显然无法用前面的方法解决</li></ul><figure><img src="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230423164711640.png" alt="image-20230423164711640" loading="lazy" decoding="async" class="lazy"></figure><hr><h3 id="构造循环依赖的解决" tabindex="-1"><strong>构造循环依赖的解决</strong> <a class="header-anchor" href="#构造循环依赖的解决" aria-label="Permalink to &quot;**构造循环依赖的解决**&quot;">​</a></h3><ul><li>思路1<ul><li>a 注入 b 的代理对象，这样能够保证 a 的流程走通</li><li>后续需要用到 b 的真实对象时，可以通过代理间接访问</li></ul></li></ul><img src="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210903091627659.png" alt="image-20210903091627659" class="scale-50"><ul><li>思路2<ul><li>a 注入 b 的工厂对象，让 b 的实例创建被推迟，这样能够保证 a 的流程先走通</li><li>后续需要用到 b 的真实对象时，再通过 ObjectFactory 工厂间接访问</li></ul></li></ul><img src="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210903091743366.png" alt="image-20210903091743366" class="scale-50"><figure><img src="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230423164819587.png" alt="image-20230423164819587" loading="lazy" decoding="async" class="lazy"></figure><ul><li>示例1：用 @Lazy 为构造方法参数生成代理</li></ul><figure><img src="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230423165237989.png" alt="image-20230423165237989" loading="lazy" decoding="async" class="lazy"></figure><blockquote><p>@Lazy 可以加在成员变量上或方法参数上，也包括构造方法的参数上，加了之后 Spring 就去查找依赖注入的值时，就根据此注解进行解析，查找依赖注入的值会调用到 beanFactory 中的一个 resolveDependency 的方法判断是否该值加了 @Lazy 注解，加了就会进行代理对象的创建，否则返回原始对象</p></blockquote><ul><li>示例2：用 ObjectFactory 或 ObjectProvider 延迟依赖对象的创建</li></ul><figure><img src="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230423165816753.png" alt="image-20230423165816753" loading="lazy" decoding="async" class="lazy"></figure><blockquote><p>ObjectFactory 和 ObjectProvider 都是 Spring 提供的工厂接口</p></blockquote><ul><li>示例3：用 @Scope 产生代理</li></ul><figure><img src="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230423170840218.png" alt="image-20230423170840218" loading="lazy" decoding="async" class="lazy"></figure><blockquote><p>在 @Lazy 和 @Scope 这两种代理中选择创建代理的话，会选择 @Lazy，因为 @Scope 是一种比较 low 的解决方式，因为它是由代理工厂来生产代理对象的，所以这里就绕了一个弯，而且真正的目标也会在我们的单例池里存一份(scopeTarget.b)</p></blockquote><ul><li>示例4：用 Provider 接口解决，原理上与 ObjectProvider 一样，Provider 接口是独立的 jar 包，需要加入依赖</li></ul><div class="language-xml max-h-300px"><button title="Copy code" class="copy"></button><span class="lang">xml</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code v-pre><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">&lt;</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D">dependency</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">    &lt;</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D">groupId</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">&gt;javax.inject&lt;/</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D">groupId</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">    &lt;</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D">artifactId</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">&gt;javax.inject&lt;/</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D">artifactId</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">    &lt;</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D">version</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">&gt;1&lt;/</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D">version</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">&lt;/</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D">dependency</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">&gt;</span></span></code></pre><button class="code-block-unfold-btn"></button></div><figure><img src="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230423170300385.png" alt="image-20230423170300385" loading="lazy" decoding="async" class="lazy"></figure><blockquote><p>Provider这个接口是java官方提供的一套工厂接口，在pom文件加入javax.inject的依赖，它的作用跟前面的两个工厂接口的作用是一样的，即可以推迟产品对象的获取</p></blockquote><hr><h3 id="解决-set-循环依赖的原理" tabindex="-1">解决 set 循环依赖的原理 <a class="header-anchor" href="#解决-set-循环依赖的原理" aria-label="Permalink to &quot;解决 set 循环依赖的原理&quot;">​</a></h3><p>**一级缓存 singletonObjects **</p><figure><img src="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230423152153455.png" alt="image-20230423152153455" loading="lazy" decoding="async" class="lazy"></figure><p>作用是保证单例对象仅被创建一次</p><ul><li>第一次走 <code>getBean("a")</code> 流程后，最后会将成品 a 放入 singletonObjects 一级缓存</li><li>后续再走 <code>getBean("a")</code> 流程时，先从一级缓存中找，这时已经有成品 a，就无需再次创建</li></ul><p><strong>一级缓存与循环依赖</strong></p><figure><img src="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230423152409029.png" alt="image-20230423152409029" loading="lazy" decoding="async" class="lazy"></figure><p>一级缓存无法解决循环依赖问题，分析如下</p><ul><li>无论是获取 bean a 还是获取 bean b，走的方法都是同一个 getBean 方法，假设先走 <code>getBean("a")</code></li><li>当 a 的实例对象创建，接下来执行 <code>a.setB()</code> 时，需要走 <code>getBean("b")</code> 流程，红色箭头 1</li><li>当 b 的实例对象创建，接下来执行 <code>b.setA()</code> 时，又回到了 <code>getBean("a")</code> 的流程，红色箭头 2</li><li>但此时 singletonObjects 一级缓存内没有成品的 a，陷入了死循环</li></ul><p>**二级缓存 singletonFactories（官方三级缓存） **</p><figure><img src="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230423152834032.png" alt="image-20230423152834032" loading="lazy" decoding="async" class="lazy"></figure><p>解决思路如下：</p><ul><li>再增加一个 singletonFactories 缓存</li><li>在依赖注入前，即 <code>a.setB()</code> 以及 <code>b.setA()</code> 将 a 及 b 的半成品对象（未完成依赖注入和初始化）放入此缓存</li><li>执行依赖注入时，先看看 singletonFactories 缓存中是否有半成品的对象，如果有拿来注入，顺利走完流程</li></ul><p>对于上面的图</p><ul><li><code>a = new A()</code> 执行之后就会把这个半成品的 a 放入 singletonFactories 缓存，即 <code>factories.put(a)</code></li><li>接下来执行 <code>a.setB()</code>，走入 <code>getBean("b")</code> 流程，红色箭头 3</li><li>这回再执行到 <code>b.setA()</code> 时，需要一个 a 对象，有没有呢？有！</li><li><code>factories.get()</code> 在 singletonFactories 缓存中就可以找到，红色箭头 4 和 5</li><li>b 的流程能够顺利走完，将 b 成品放入 singletonObject 一级缓存，返回到 a 的依赖注入流程，红色箭头 6</li></ul><p><strong>二级缓存与创建代理</strong></p><figure><img src="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230423153224037.png" alt="image-20230423153224037" loading="lazy" decoding="async" class="lazy"></figure><p>二级缓存无法正确处理循环依赖并且包含有代理创建的场景，分析如下</p><ul><li>spring 默认要求，在 <code>a.init</code> 完成之后才能创建代理 <code>pa = proxy(a)</code></li><li>由于 a 的代理创建时机靠后，在执行 <code>factories.put(a)</code> 向 singletonFactories 中放入的还是原始对象</li><li>接下来箭头 3、4、5 这几步 b 对象拿到和注入的都是原始对象</li></ul><blockquote><p>二级缓存的问题(singletonFactories)：依赖注入先发生，创建代理后发生，创建对象时代理对象还没有，即它只能注入那个原始的目标对象</p><p>解决办法：把代理对象提前创建，但Spring没有这么做，它还是想代理对象尽可能在最后来创建，即初始化后才创建，只有发生了循环依赖时它才提前创建代理</p></blockquote><p>**三级缓存 earlySingletonObjects（官方二级缓存） **</p><figure><img src="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230423154033542.png" alt="image-20230423154033542" loading="lazy" decoding="async" class="lazy"></figure><p>简单分析的话，只需要将代理的创建时机放在依赖注入之前即可，但 spring 仍然希望代理的创建时机在 init 之后，只有出现循环依赖时，才会将代理的创建时机提前。所以解决思路稍显复杂：</p><ul><li>图中 <code>factories.put(fa)</code> 放入的既不是原始对象，也不是代理对象而是工厂对象 fa</li><li>当检查出发生循环依赖时，fa 的产品就是代理 pa，没有发生循环依赖，fa 的产品是原始对象 a</li><li>假设出现了循环依赖，拿到了 singletonFactories 中的工厂对象，通过在依赖注入前获得了 pa，红色箭头 5</li><li>这回 <code>b.setA()</code> 注入的就是代理对象，保证了正确性，红色箭头 7</li><li>还需要把 pa 存入新加的 earlySingletonObjects 缓存，红色箭头 6</li><li><code>a.init</code> 完成后，无需二次创建代理，从哪儿找到 pa 呢？earlySingletonObjects 已经缓存，蓝色箭头 9</li><li>当成品对象产生，放入 singletonObjects 后，singletonFactories 和 earlySingletonObjects 中的对象就没有用处，清除即可</li></ul><blockquote><p>引入三级缓存(earlySingletonObjects)，并且还要引入一个工厂才能实现刚才的目的，这个工厂(理解为一个Lambda表达式fa-&gt; pa || a)的作用是产生代理对象或原始对象，它会检查如果你将来发生了循环依赖，它就会提前创建生成代理对象并返回，如果没有发生循环依赖，它还是返回原始对象</p></blockquote><p><strong>set循环依赖演示</strong></p><figure><img src="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230423154514318.png" alt="image-20230423154514318" loading="lazy" decoding="async" class="lazy"></figure><ul><li>DEBUG - getSingleton</li></ul><figure><img src="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230423160842182.png" alt="image-20230423160842182" loading="lazy" decoding="async" class="lazy"></figure><figure><img src="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230423160934610.png" alt="image-20230423160934610" loading="lazy" decoding="async" class="lazy"></figure><figure><img src="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230423160952450.png" alt="image-20230423160952450" loading="lazy" decoding="async" class="lazy"></figure><blockquote><p>起点由 refresh 第十一步（finishBeanFactoryInitialization）开始，初始化所有非延迟单例 bean</p><div class="language-java max-h-300px"><button title="Copy code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code v-pre><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">protected</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> finishBeanFactoryInitialization</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(ConfigurableListableBeanFactory beanFactory) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">    ...</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">	beanFactory.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">preInstantiateSingletons</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">();    </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">@</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">Override</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> preInstantiateSingletons</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">() throws BeansException {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">	...</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">	List&lt;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">String</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">&gt; beanNames </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> new</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> ArrayList&lt;&gt;(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">.beanDefinitionNames);</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">	// Trigger initialization of all non-lazy singleton beans...</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">	for</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> (String beanName </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> beanNames) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">         ...</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">         //非延迟单例 bean 获取   </span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">		getBean</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(beanName);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">		...</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">	}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">}</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">//核心方法1</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">protected</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> &lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">T</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> T </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">doGetBean</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(String name, @</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">Nullable</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> Class</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">&lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">T</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> requiredType, @</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">Nullable</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> Object</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">[] args, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">boolean</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> typeCheckOnly) throws BeansException {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">    //从1、2、3级缓存解决set循环依赖的核心方法，allowEarlyReference=true；debug核心点，设置面向all的beanName.equals("a");哪个bean先注册就设置哪个</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">    //第一次getBean("a")，sharedInstance=null，因为一级二级缓存都没有存储a或其代理对象，三级缓存还未添加</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">	Object sharedInstance </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> getSingleton</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(beanName);</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">    //进入单例bean的创建步骤</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">    ...</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">    return</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> createBean</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(beanName, mbd, args);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">    ...</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">@</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">Override</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">protected</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> Object </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">createBean</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(String beanName, RootBeanDefinition mbd, @</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">Nullable</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> Object</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">[] args) throws BeanCreationException {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">    ...</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">	Object beanInstance </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> doCreateBean</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(beanName, mbdToUse, args);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">    ...</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">}</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">//bean的创建三阶段核心方法</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">protected</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> Object </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">doCreateBean</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(String beanName, RootBeanDefinition mbd, @</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">Nullable</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> Object</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">[] args) throws BeanCreationException {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">    ...</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">    //bean的实例化</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">    Object bean </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> instanceWrapper.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">getWrappedInstance</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">    ...</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">	//添加bean的三级缓存核心方法，存储Lambda表达式，后续调用getObject时会回调</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">	addSingletonFactory</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(beanName, () </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">-&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> getEarlyBeanReference</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(beanName, mbd, bean));</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">    //记录原始bean，后续判断初始化阶段或之前有没有创建代理</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">	Object exposedObject </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> bean;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">	try</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">         //依赖注入阶段</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">		populateBean</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(beanName, mbd, instanceWrapper);</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">		//初始化阶段</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">         exposedObject </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> initializeBean</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(beanName, exposedObject, mbd);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">	}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">    ...</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">}</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">protected</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> populateBean</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(String beanName, RootBeanDefinition mbd, @</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">Nullable</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> BeanWrapper bw) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">    ...</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">    for</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> (InstantiationAwareBeanPostProcessor bp </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> getBeanPostProcessorCache</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">().instantiationAware) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">        //遍历bean的后处理到AutowiredAnnotationBeanPostProcessor进行注解解析</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">		PropertyValues pvsToUse </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> bp.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">postProcessProperties</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(pvs, bw.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">getWrappedInstance</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(), beanName);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">        ...</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">    ...</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">}</span></span></code></pre><button class="code-block-unfold-btn"></button></div><ul><li>循环依赖在依赖注入的关键点 <code>postProcessProperties(...) -&gt; inject(...):AutowiredMethodElement -&gt; resolveMethodArguments(...) -&gt; resolveDependency(...) -&gt; doResolveDependency(...) -&gt; resolveCandidate(...) -&gt; getBean("b")；</code></li><li>进入 b 的创建过程，与 a 第一次 getBean 一样，然后依赖注入走到 <code>getBean("a")</code></li><li>第二次getBean("a")，就会进入三级缓存获取 bean 的流程</li></ul><div class="language-java max-h-300px"><button title="Copy code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code v-pre><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">public</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> Object </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">getSingleton</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(String beanName) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">	return</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> getSingleton</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(beanName, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">}</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">//getSingleton三级缓存获取对象工厂的核心流程</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">...</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">synchronized</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> (</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">.singletonObjects) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">	// Consistent creation of early reference within full singleton lock</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">	singletonObject </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">.singletonObjects.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">get</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(beanName);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">	if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> (singletonObject </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">==</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> null</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">		singletonObject </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">.earlySingletonObjects.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">get</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(beanName);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">		if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> (singletonObject </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">==</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> null</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">			ObjectFactory&lt;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">?</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">&gt; singletonFactory </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">.singletonFactories.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">get</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(beanName);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">			if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> (singletonFactory </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">!=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> null</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">                  //a第一次getBean时将自己到三级缓存里，singletonFactories=[{"a",()-&gt;{...}}]，所以当获取到a的工厂对象后调用getObject方法就会回调Lambda表达式里的代码块方法getEarlyBeanReference(beanName, mbd, bean)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">				singletonObject </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> singletonFactory.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">getObject</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">();</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">				this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">.earlySingletonObjects.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">put</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(beanName, singletonObject);</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">				this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">.singletonFactories.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">remove</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(beanName);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">			}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">		}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">	}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">...</span></span></code></pre><button class="code-block-unfold-btn"></button></div><div class="language-java max-h-300px"><button title="Copy code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code v-pre><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">protected</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> Object </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">getEarlyBeanReference</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(String beanName, RootBeanDefinition mbd, Object bean) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">   Object exposedObject </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> bean;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">   ...</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">         exposedObject </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> bp.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">getEarlyBeanReference</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(exposedObject, beanName);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">   ...</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">   return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> exposedObject;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">}</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">//org.springframework.aop.framework.autoproxy.AbstractAutoProxyCreator#getEarlyBeanReference</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">@</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">Override</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">public</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> Object </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">getEarlyBeanReference</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(Object bean, String beanName) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> 	Object cacheKey </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> getCacheKey</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(bean.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">getClass</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(), beanName);</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">    //将准备进入代理的对象引入存入二级缓存，后续在初始化完成后进行代理增强的判断，无需再次创建代理</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> 	this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">.earlyProxyReferences.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">put</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(cacheKey, bean);</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">    //将返回代理后的对象：包名.$类名$$EnhancerBySpringCGLIB$$引用地址</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> 	return</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> wrapIfNecessary</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(bean, beanName, cacheKey);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">}</span></span></code></pre><button class="code-block-unfold-btn"></button></div><div class="language-java max-h-300px"><button title="Copy code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code v-pre><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">//#doGetBean</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">...</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> (sharedInstance </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">!=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> null</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> &amp;&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> args </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">==</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> null</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">   ...</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">   beanInstance </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> getObjectForBeanInstance</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(sharedInstance, name, beanName, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">null</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">...</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">return</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> adaptBeanInstance</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(name, beanInstance, requiredType);</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">//方法跳出 -&gt; resolveCandidate(...) -&gt; resolveDependency -&gt; resolveMethodArguments(...) -&gt; inject(...)</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">//#doResolveDependency</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">    ...</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">    instanceCandidate </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> descriptor.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">resolveCandidate</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(autowiredBeanName, type, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">    ...</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">    return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> result;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">	}</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">	finally</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">        //方法返回前执行</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">	    ConstructorResolver.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">setCurrentInjectionPoint</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(previousInjectionPoint);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">	}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">}</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">//#resolveDependency</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">...</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> (result </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">==</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> null</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">      //result为a的代理对象</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">	  result </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> doResolveDependency</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(descriptor, requestingBeanName, autowiredBeanNames, typeConverter);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">	}</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">	return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> result;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">...</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">    </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">//#inject</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">    else</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">        arguments </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> resolveMethodArguments</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(method, bean, beanName);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">    }</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> (arguments </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">!=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> null</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">        try</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">            ReflectionUtils.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">makeAccessible</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(method);</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">            //反射执行setA注入给B</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">            method.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">invoke</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(bean, arguments);</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">            //输出：- setA(class 包名.$A$$EnhancerBySpringCGLIB$$5fbc14f4) </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">        }</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">        catch</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> (...) {...}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">...</span></span></code></pre><button class="code-block-unfold-btn"></button></div><ul><li>b依赖注入完后跳出 populateBean 进入b的初始化过程</li><li>b整个创建流程走完最后也是方法跳出到resolveCandidate方法，进行a的依赖注入流程，反射执行setB注入给a</li><li>a的初始化走完，进入第二次缓存检查，防止代理对象的遗漏</li></ul><div class="language-java max-h-300px"><button title="Copy code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code v-pre><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">//doCreateBean</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">...</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">//原始对象</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">Object exposedObject </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> bean;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">	try</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">		populateBean</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(beanName, mbd, instanceWrapper);</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">         //初始化后对象，因为在初始化阶段a没有进行代理创建，但是b注入a时提前把a的代理对象创建并进行值注入，所以后面进行第二次缓存检查获取代理对象，防止遗漏</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">		exposedObject </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> initializeBean</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(beanName, exposedObject, mbd);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">	}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">...</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> (earlySingletonExposure) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">    //从二级缓存获取a的代理对象</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">   Object earlySingletonReference </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> getSingleton</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(beanName, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">false</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">   if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> (earlySingletonReference </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">!=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> null</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">      if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> (exposedObject </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">==</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> bean) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">          //将a的原始引用指向代理对象引用</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">         exposedObject </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> earlySingletonReference;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">      }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">      ...</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">   }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">...</span></span></code></pre><button class="code-block-unfold-btn"></button></div></blockquote><ul><li>set循环依赖 - 二级缓存作用1</li></ul><figure><img src="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230423162034164.png" alt="image-20230423162034164" loading="lazy" decoding="async" class="lazy"></figure><div class="language-java max-h-300px"><button title="Copy code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code v-pre><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">//org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory#doCreateBean</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">...</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">    	//bean为原始对象</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">    	Object bean </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> instanceWrapper.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">getWrappedInstance</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">		...</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">             //发生循环依赖，将对象加入三级缓存singletonFactories</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">			addSingletonFactory</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(beanName, () </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">-&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> getEarlyBeanReference</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(beanName, mbd, bean));</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">		...</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">		// Initialize the bean instance.</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">		Object exposedObject </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> bean;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">		try</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">             //依赖注入</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">			populateBean</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(beanName, mbd, instanceWrapper);</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">			//初始化后的bean</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">             exposedObject </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> initializeBean</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(beanName, exposedObject, mbd);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">		}</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">		catch</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> (Throwable </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70">ex</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">) {...}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">		if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> (earlySingletonExposure) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">             //获取一级和二级缓存是否有该目前的bean，但不会到三级缓存中获取，目的是防止bean提前创建代理后在二级缓存中的遗漏</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">			Object earlySingletonReference </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> getSingleton</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(beanName, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">false</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">			if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> (earlySingletonReference </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">!=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> null</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">				if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> (exposedObject </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">==</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> bean) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">                      //防止二级缓存遗漏，若提前创建了代理直接改变引用即可，否则就是原始对象了（提前创建代理发生在doGetBean一开始调用的getSingleton(beanName)，此方法就会在三级缓存singletonFactories对要注入的bean进行提前创建代理，或者说B要注入A时，）</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">					exposedObject </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> earlySingletonReference;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">				}</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">                 //初始化阶段就创建代理了，直接返回代理对象</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">				else</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">!</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">.allowRawInjectionDespiteWrapping </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">&amp;&amp;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> hasDependentBean</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(beanName)) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">					...</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">				}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">			}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">		}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">...</span></span></code></pre><button class="code-block-unfold-btn"></button></div><ul><li>set循环依赖 - 二级缓存作用2</li></ul><figure><img src="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230423163506278.png" alt="image-20230423163506278" loading="lazy" decoding="async" class="lazy"></figure><ul><li>set循环依赖 - 如何避免重复创建代理</li></ul><figure><img src="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230423163952262.png" alt="image-20230423163952262" loading="lazy" decoding="async" class="lazy"></figure><hr><h3 id="总结-2" tabindex="-1">总结 <a class="header-anchor" href="#总结-2" aria-label="Permalink to &quot;总结&quot;">​</a></h3><ul><li>单例 set 方法(包括成员变量)循环依赖，Spring 会利用三级缓存解决，无需额外配置<ul><li>一级缓存存放成品对象</li><li>二级缓存存放发生了循环依赖时的产品对象 (可能是原始 bean，也可能是代理 bean)</li><li>三级缓存存放工厂对象，发生循环依赖时，会调用工厂获取产品</li><li>Spring 期望在初始化时创建代理，但如果发生了循环依赖，会由工厂提前创建代理，后续初始化时就不必重复创建代理</li><li>二级缓存的意义在于，如果提前创建了代理对象，在最后的阶段需要从二级缓存中获取此代理对象，作为最终结果</li></ul></li><li>构造方法及多例循环依赖解决办法<ul><li>@Lazy</li><li>@Scope</li><li>ObjectFactory &amp; ObjectProvider</li><li>Provider</li></ul></li></ul><hr><h2 id="_4-spring-事务失效" tabindex="-1">4. Spring 事务失效 <a class="header-anchor" href="#_4-spring-事务失效" aria-label="Permalink to &quot;4. Spring 事务失效&quot;">​</a></h2><h3 id="_1-抛出检查异常导致事务不能正确回滚" tabindex="-1"><strong>1. 抛出检查异常导致事务不能正确回滚</strong> <a class="header-anchor" href="#_1-抛出检查异常导致事务不能正确回滚" aria-label="Permalink to &quot;**1. 抛出检查异常导致事务不能正确回滚**&quot;">​</a></h3><ul><li><p>问题：出现了数据不一致情况（总金额2000=&gt;1500，被系统吃了500）</p></li><li><p>原因：Spring 默认只会回滚非检查异常</p></li><li><p>解法：配置 rollbackFor 属性</p><ul><li><code>@Transactional(rollbackFor = Exception.class)</code></li></ul></li></ul><figure><img src="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230422140026927.png" alt="image-20230422140026927" loading="lazy" decoding="async" class="lazy"></figure><hr><h3 id="_2-业务方法内自己-try-catch-异常导致事务不能正确回滚" tabindex="-1"><strong>2. 业务方法内自己 try-catch 异常导致事务不能正确回滚</strong> <a class="header-anchor" href="#_2-业务方法内自己-try-catch-异常导致事务不能正确回滚" aria-label="Permalink to &quot;**2. 业务方法内自己 try-catch 异常导致事务不能正确回滚**&quot;">​</a></h3><ul><li><p>问题：出现了数据不一致情况（总金额2000=&gt;1500，被系统吃了500）</p></li><li><p>原因：事务通知只有捉到了目标抛出的异常，才能进行后续的回滚处理，如果目标自己处理掉异常，事务通知无法知悉</p></li><li><p>解法1：异常原样抛出</p><ul><li>在 catch 块添加 <code>throw new RuntimeException(e);</code></li></ul></li><li><p>解法2：手动设置 <code>TransactionStatus.setRollbackOnly()</code></p><ul><li>在 catch 块添加 <code>TransactionInterceptor.currentTransactionStatus().setRollbackOnly();</code></li></ul></li></ul><figure><img src="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230422140710210.png" alt="image-20230422140710210" loading="lazy" decoding="async" class="lazy"></figure><hr><h3 id="_3-aop-切面顺序导致导致事务不能正确回滚" tabindex="-1"><strong>3. aop 切面顺序导致导致事务不能正确回滚</strong> <a class="header-anchor" href="#_3-aop-切面顺序导致导致事务不能正确回滚" aria-label="Permalink to &quot;**3. aop 切面顺序导致导致事务不能正确回滚**&quot;">​</a></h3><ul><li><p>原因：事务切面优先级最低，但如果自定义的切面优先级和他一样，则还是自定义切面在内层，这时若自定义切面没有正确抛出异常，事务也不会回滚</p></li><li><p>解法1、2：同情况2 中的解法:1、2</p></li><li><p>解法3：调整切面顺序，在 MyAspect 上添加 <code>@Order(Ordered.LOWEST_PRECEDENCE - 1)</code> （不推荐）</p></li></ul><figure><img src="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230422141539702.png" alt="image-20230422141539702" loading="lazy" decoding="async" class="lazy"></figure><hr><h3 id="_4-非-public-方法导致的事务失效" tabindex="-1"><strong>4. 非 public 方法导致的事务失效</strong> <a class="header-anchor" href="#_4-非-public-方法导致的事务失效" aria-label="Permalink to &quot;**4. 非 public 方法导致的事务失效**&quot;">​</a></h3><ul><li><p>原因：Spring 为方法创建代理、添加事务通知、前提条件都是该方法是 public 的；因为Spring中有个检查，它发现你的方法不是public，去读取事务的属性时就会返回null，即不会返回事务的属性，从而不会加这些事务的相关配置</p></li><li><p>解法1：改为 public 方法</p></li><li><p>解法2：添加 bean 配置如下（不推荐）</p></li></ul><div class="language-java max-h-300px"><button title="Copy code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code v-pre><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">@</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">Bean</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">public</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> TransactionAttributeSource </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">transactionAttributeSource</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">() {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">    return</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> AnnotationTransactionAttributeSource</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">false</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">}</span></span></code></pre><button class="code-block-unfold-btn"></button></div><figure><img src="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230422141914663.png" alt="image-20230422141914663" loading="lazy" decoding="async" class="lazy"></figure><hr><h3 id="_5-父子容器导致的事务失效" tabindex="-1"><strong>5. 父子容器导致的事务失效</strong> <a class="header-anchor" href="#_5-父子容器导致的事务失效" aria-label="Permalink to &quot;**5. 父子容器导致的事务失效**&quot;">​</a></h3><p>现在配置了父子容器，WebConfig 对应子容器，AppConfig 对应父容器，发现事务依然失效</p><ul><li>原因：子容器扫描范围过大，本来只需扫描controller，但是把service也扫了进来，service虽然有事务注解，但是子容器配置类并没有开启事务配置，因此事务失效</li></ul><figure><img src="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20231205214825213.png" alt="image-20231205214825213" loading="lazy" decoding="async" class="lazy"></figure><ul><li><p>解法1：各扫描各的，不要图简便</p></li><li><p>解法2：不要用父子容器，所有 bean 放在同一容器</p></li></ul><figure><img src="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230422143148085.png" alt="image-20230422143148085" loading="lazy" decoding="async" class="lazy"></figure><hr><h3 id="_6-★调用本类方法导致传播行为失效★" tabindex="-1"><strong>6. ★调用本类方法导致传播行为失效★</strong> <a class="header-anchor" href="#_6-★调用本类方法导致传播行为失效★" aria-label="Permalink to &quot;**6. ★调用本类方法导致传播行为失效★**&quot;">​</a></h3><div class="language-java max-h-300px"><button title="Copy code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code v-pre><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">@</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">Transactional</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> foo</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(){</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">    bar</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">@</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">Transactional</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> bar</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(){</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">}</span></span></code></pre><button class="code-block-unfold-btn"></button></div><ul><li><p>原因：本类方法调用不经过代理，因此无法增强</p></li><li><p>解法1：依赖注入自己（代理）来调用</p></li><li><p>解法2：通过 AopContext 拿到代理对象，来调用（代理模式是在运行期间生成一些代理的新的字节码来实现功能的增强）</p></li><li><p>解法3：通过 CTW（编译时织入），LTW （加载时织入）实现功能增强（原理都是修改类的字节码来实现功能增强）</p></li></ul><p>解法1</p><div class="language-java max-h-300px"><button title="Copy code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code v-pre><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">@</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">Service</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> Service6</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">	@</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">Autowired</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">	private</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> Service6 proxy; </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">// 本质上是一种循环依赖</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">    @</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">Transactional</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">    public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> foo</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">()  {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">		proxy.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">bar</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">    @</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">Transactional</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">    public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> bar</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">() {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">}</span></span></code></pre><button class="code-block-unfold-btn"></button></div><p>解法2，还需要在 AppConfig 上添加 <code>@EnableAspectJAutoProxy(exposeProxy = true)</code></p><div class="language-java max-h-300px"><button title="Copy code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code v-pre><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">@</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">Service</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> Service6</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">    @</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">Transactional</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">    public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> foo</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(){</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">		((Service6) AopContext.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">currentProxy</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">()).</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">bar</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">    @</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">Transactional</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">    public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> bar</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(){</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">}</span></span></code></pre><button class="code-block-unfold-btn"></button></div><figure><img src="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230422143959797.png" alt="image-20230422143959797" loading="lazy" decoding="async" class="lazy"></figure><hr><h3 id="_7-transactional-没有保证原子行为" tabindex="-1"><strong>7. @Transactional 没有保证原子行为</strong> <a class="header-anchor" href="#_7-transactional-没有保证原子行为" aria-label="Permalink to &quot;**7. @Transactional 没有保证原子行为**&quot;">​</a></h3><div class="language-java max-h-300px"><button title="Copy code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code v-pre><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">@</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">Transactional</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">rollbackFor</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> Exception.class)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> transfer</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> from, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> to, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> amount) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">    int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> fromBalance </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> accountMapper.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">findBalanceBy</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(from);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">    logger.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">debug</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">"更新前查询余额为: {}"</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">, fromBalance);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> (fromBalance </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">-</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> amount </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">&gt;=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">        accountMapper.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">update</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(from, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">-</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">1</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> *</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> amount);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">        accountMapper.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">update</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(to, amount);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">}</span></span></code></pre><button class="code-block-unfold-btn"></button></div><p>上面的代码实际上是有 bug 的，假设 from 余额为 1000，两个线程都来转账 1000，可能会出现扣减为负数的情况</p><ul><li>原因：事务的原子性仅涵盖 insert、update、delete、select … for update 语句，select 方法并不阻塞</li></ul><img src="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210903120436365.png" alt="image-20210903120436365" class="scale-50"><ul><li>如上图所示，红色线程和蓝色线程的查询都发生在扣减之前，都以为自己有足够的余额做扣减</li></ul><figure><img src="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230422144457753.png" alt="image-20230422144457753" loading="lazy" decoding="async" class="lazy"></figure><hr><h3 id="_8-★-transactional-方法导致的-synchronized-失效★" tabindex="-1"><strong>8. ★@Transactional 方法导致的 synchronized 失效★</strong> <a class="header-anchor" href="#_8-★-transactional-方法导致的-synchronized-失效★" aria-label="Permalink to &quot;**8. ★@Transactional 方法导致的 synchronized 失效★**&quot;">​</a></h3><p>针对上面的问题，能否在方法上加 synchronized 锁来解决呢？</p><p>答案是不行，原因如下：</p><ul><li>synchronized 保证的仅是目标方法的原子性，环绕目标方法的还有 commit 等操作，它们并未处于 sync 块内</li><li>可以参考下图发现，蓝色线程的查询只要在红色线程提交之前执行，那么依然会查询到有 1000 足够余额来转账（实际已经扣过1000了，那么最终结果就是 -1000）</li></ul><figure><img src="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210903120800185.png" alt="image-20210903120800185" loading="lazy" decoding="async" class="lazy"></figure><ul><li>解法1：synchronized 范围应扩大至代理方法调用（DEBUG来Commit）</li></ul><figure><img src="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230422145400664.png" alt="image-20230422145400664" loading="lazy" decoding="async" class="lazy"></figure><ul><li>解法2：使用 select … for update 替换 select（推荐使用数据库层面来解决）</li></ul><figure><img src="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230422145452610.png" alt="image-20230422145452610" loading="lazy" decoding="async" class="lazy"></figure><hr><h2 id="_5-spring-mvc-执行流程" tabindex="-1">5. Spring MVC 执行流程 <a class="header-anchor" href="#_5-spring-mvc-执行流程" aria-label="Permalink to &quot;5. Spring MVC 执行流程&quot;">​</a></h2><p><strong>概要</strong></p><p>我把整个流程分成三个阶段</p><ul><li>初始化阶段</li><li>匹配阶段</li><li>执行阶段</li></ul><h3 id="初始化阶段" tabindex="-1"><strong>初始化阶段</strong> <a class="header-anchor" href="#初始化阶段" aria-label="Permalink to &quot;**初始化阶段**&quot;">​</a></h3><figure><img src="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20231206162537789.png" alt="image-20231206162537789" loading="lazy" decoding="async" class="lazy"></figure><ol><li><p>在 Web 容器第一次用到 DispatcherServlet 的时候，会创建其对象并执行 init 方法</p></li><li><p>init 方法内会创建 Spring Web 容器，并调用容器 refresh 方法</p></li><li><p>refresh 过程中会创建并初始化 SpringMVC 中的重要组件， 例如 MultipartResolver，HandlerMapping，HandlerAdapter，HandlerExceptionResolver、ViewResolver 等</p></li><li><p>容器初始化后，会将上一步初始化好的重要组件，赋值给 DispatcherServlet 的成员变量，供后续使用</p></li></ol><figure><img src="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210903140657163.png" alt loading="lazy" decoding="async" class="lazy"></figure><figure><img src="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230422150617027.png" alt="image-20230422150617027" loading="lazy" decoding="async" class="lazy"></figure><blockquote><ul><li><strong>DispatcherServlet</strong> 是 SpringMVC 中的一个非常核心的类，由 web 容器(tomcat)创建和初始化，传统的 SpringMVC 跟 Spring 整合的时候还是由 Tomcat 来创建它的，当然，到了 SpringBoot 里，这个 DispatcherServlet 就有可能由 Spring 容器自身来创建和初始化</li><li>除 MultipartResovler 可能只有一个实例以外，其他的重要组件同一个类型可能有多个实例对象存在这个 Spring 容器中</li><li><strong>HandlerMapping</strong> 是做请求映射的，就是根据你的请求路径找到一个对应的控制器和它相关的方法来处理这个请求，就是把浏览器的请求映射到我们 Spring 中一个控制器的方法调用上</li><li><strong>HandlerAdapter</strong> 就是负责真正去调用这个控制器的控制方法来处理请求，如果在调用这个控制器的控制方法的过程中出现了异常时由<strong>HandlerExceptionResovler</strong>来处理异常，最终这个控制方法执行完毕后，就会封装成一个 ModelAndView 对象，但这个对象中的视图可能只包含一个字符串的名字，那我们需要把这个字符串的名字去解析成一个视图对象由 <strong>ViewResovler</strong> 负责把名字解析成视图对象，视图对象内部就可以根据不同的实现去选择是跳转到JSP还是跳转到一些模板引擎，去执行这个视图的渲染工作</li><li>最后的这个 <strong>MultipartResovler</strong> 并不是必须的，它是用在文件的上传时处理这种 Multipart 格式的表单数据</li></ul><p><strong>Spring MVC 的核心组件</strong>？</p><ol><li><strong>DispatcherServlet</strong>：前置控制器，是整个流程控制的<strong>核心</strong>，控制其他组件的执行，进行统一调度，降低组件之间的耦合性，相当于总指挥。</li><li><strong>Handler</strong>：处理器，完成具体的业务逻辑，相当于 Servlet 或 Action。</li><li><strong>HandlerMapping</strong>：DispatcherServlet 接收到请求之后，通过 HandlerMapping 将不同的请求映射到不同的 Handler。</li><li><strong>HandlerInterceptor</strong>：处理器拦截器，是一个接口，如果需要完成一些拦截处理，可以实现该接口。</li><li><strong>HandlerExecutionChain</strong>：处理器执行链，包括两部分内容：Handler 和 HandlerInterceptor（系统会有一个默认的 HandlerInterceptor，如果需要额外设置拦截，可以添加拦截器）。</li><li><strong>HandlerAdapter</strong>：处理器适配器，Handler 执行业务方法之前，需要进行一系列的操作，包括表单数据的验证、数据类型的转换、将表单数据封装到 JavaBean 等，这些操作都是由 HandlerApater 来完成，开发者只需将注意力集中业务逻辑的处理上，DispatcherServlet 通过 HandlerAdapter 执行不同的 Handler。</li><li><strong>ModelAndView</strong>：装载了模型数据和视图信息，作为 Handler 的处理结果，返回给 DispatcherServlet。</li><li><strong>ViewResolver</strong>：视图解析器，DispatcheServlet 通过它将逻辑视图解析为物理视图，最终将渲染结果响应给客户端。</li></ol></blockquote><hr><h3 id="匹配阶段" tabindex="-1"><strong>匹配阶段</strong> <a class="header-anchor" href="#匹配阶段" aria-label="Permalink to &quot;**匹配阶段**&quot;">​</a></h3><ol><li><p>用户发送的请求统一到达前端控制器 DispatcherServlet</p></li><li><p>DispatcherServlet 遍历所有 HandlerMapping ，找到与路径匹配的处理器</p><p>① HandlerMapping 有多个，每个 HandlerMapping 会返回不同的处理器对象，谁先匹配，返回谁的处理器。其中能识别 @RequestMapping 的优先级最高</p><p>② 对应 @RequestMapping 的处理器是 HandlerMethod，它包含了控制器对象和控制器方法信息</p><p>③ 其中路径与处理器的映射关系在 HandlerMapping 初始化时就会建立好</p></li></ol><img src="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210903141017502.png" alt="image-20210903141017502" class="scale-80"><ol start="3"><li>将 HandlerMethod 连同匹配到的拦截器，生成调用链对象 HandlerExecutionChain 返回</li></ol><img src="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210903141124911.png" alt="image-20210903141124911" class="scale-80"><ol start="4"><li>遍历HandlerAdapter 处理器适配器，找到能处理 HandlerMethod 的适配器对象，开始调用</li></ol><img src="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210903141204799.png" alt="image-20210903141204799" class="scale-80"><figure><img src="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230422151134584.png" alt="image-20230422151134584" loading="lazy" decoding="async" class="lazy"></figure><blockquote><ul><li>DispatcherServlet主要职责是作为一个左请求的入口，但是接下来处理请求是交给其他一些处理器对象来完成，它并不负责处理具体的请求，因此接下来会遍历所有的HandlerMapping，借助这个HandlerMapping找到与当前路径能够匹配的处理器，由处理器对象来处理请求，并不是一个请求返回多个处理器，最终只能一个请求由一个处理器对象进行处理，即谁先与当前路径匹配上，就返回谁的处理</li><li>@RequestMapping对应的处理器对象HandlerMethod，它包含了它属于哪个controller对象以及对应的controller方法的这些信息，通过HandlerMethod可以得到它将来要调用哪个controller对象和调用哪个controller方法，即反射调用</li></ul></blockquote><hr><h3 id="调用阶段" tabindex="-1"><strong>调用阶段</strong> <a class="header-anchor" href="#调用阶段" aria-label="Permalink to &quot;**调用阶段**&quot;">​</a></h3><ol><li>执行拦截器 preHandle</li></ol><img src="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210903141445870.png" alt="image-20210903141445870" class="scale-67"><ol start="2"><li><p>由 HandlerAdapter 调用 HandlerMethod</p><p>① 调用前处理不同类型的参数</p><p>② 调用后处理不同类型的返回值</p></li></ol><img src="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210903141658199.png" alt="image-20210903141658199" class="scale-67"><ol start="3"><li><p>第 2 步没有异常</p><p>① 返回 ModelAndView</p><p>② 执行拦截器 postHandle 方法</p><p>③ 解析视图，得到 View 对象，进行视图渲染</p></li></ol><img src="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210903141749830.png" alt="image-20210903141749830" class="scale-67"><ol start="4"><li>第 2 步有异常，进入 HandlerExceptionResolver 异常处理流程</li></ol><img src="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210903141844185.png" alt="image-20210903141844185" class="scale-67"><ol start="5"><li><p>最后都会执行拦截器的 afterCompletion 方法</p></li><li><p>如果控制器方法标注了 @ResponseBody 注解，则在第 2 步，就会生成 json 结果，并标记 ModelAndView 已处理，这样就不会执行第 3 步的视图渲染</p></li></ol><figure><img src="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230426024421958.png" alt="image-20230426024421958" loading="lazy" decoding="async" class="lazy"></figure><blockquote><ul><li>执行阶段首先会调用执行链中的拦截器的 preHandle 方法，<strong>由外到内依次调用</strong>，调用这个 preHandle 方法的时候，这个方法会有一个返回值，返回值为真表示放行，会进行后续的调用，为假表示被拦截器拦截下来了，就不会往后走了</li><li>HandlerAdapter 调用 HandlerMethod，虽然知道哪个bean的哪个方法，但是方法调用之前得给方法准备所有的参数，因为控制器方法的参数是十分复杂的，多种多样，既可以是 Request、Respone、Session之类，也可能是一些模型，model 对象，还有可能是方法的参数来自于请求参数，路径参数，各种情况都有，你得把这些参数进行一个解析，把参数都准备好了，就可以反射调用这个 HandlerMethod 中的 method 方法，通过 method 的反射调用执行 invoke 方法，然后把 bean 传进去，把刚才准备好的参数传入 invoke 方法并执行，这样就完成了控制器方法的一个调用，等调用结束后还要处理返回值，这个控制器方法的返回值也是多种多样，有可能返回的是一个字符串类型，Map 集合，List 集合，或者 JavaBean，都有可能，因此还要对这个返回值进行一个处理，那返回值处理完了，这个调用就暂时结束了</li><li>结束之后分成两种情况，一种是没有异常，一种是有异常<ul><li>没有异常<ol><li>把上一步结果返回统一封装成 ModelAndView，不管之前是什么类型(字符串…)，最终都会封装成 ModelAndView 对象，此对象里面就包含模型数据，视图相关的信息</li><li>返回了 ModelAndView 对象之后又回到拦截器，这回是调用拦截器的 postHandle 方法，这个 postHandle 方法调用的次序正好和 preHandle 方法调用的次序相反，即由内至外，把所有的 postHandle 也调用一遍后，最终才处理这个 ModelAndView</li><li>ModelAndView 处理的时候，第一个要处理的是这个视图，因为前面的调用仅仅返回的是一个字符串的视图名称，而不是一个视图对象，因此要借助一个叫做 ViewResovler 视图解析器，把这种字符串名字解析成一个真正的视图对象，当然，如果返回的直接是视图对象，它就直接用了</li><li>解析好视图之后，它就可以进入这个视图的渲染，它会把模型数据根据视图的实现不同先存储到不同的位置，如 JSP 的实现，它就把模型数据取出来放入到 Request 作用域，接下来转发到 JSP 的视图，JSP 视图里就可以从作用域中取出模型数据，最后渲染生成一个 html 并返回</li><li>等这个视图处理完后，还有一个收尾工作，它最终还会回到我们的拦截器，由内到外的顺序调用 afterCompletion 方法，等所有的 afterCompletion 调用完后，整个的执行流程就结束了</li></ol></li><li>出现了异常<ol><li>出现异常之后，ModelAndView 就没有了，而是拿到一个 Exception 的异常对象，它有一个 catch 块可以捕捉到异常对象</li><li>捉住到异常对象以后，DispatcherServlet 里还有一个 HandlerExceptionResolver 成员，它们就是用来处理异常的，按照优先级次序，谁先匹配到这个异常对象谁就来处理，挑出一个 HandlerExceptionResolver 来处理异常</li><li>当然，处理完异常，它也会走到最后的 afterCompletion 方法方法由内向外去逐一调用，这个时候就不会调用 postHandle 方法，因为出现异常了，它就没机会执行这个 postHandle</li></ol></li></ul></li><li>无论以后有没有异常都会执行到拦截器的 afterCompletion 方法</li><li>还有一点，就是如果我们的控制器方法标注了 @ResponseBody 注解，这个时候就不是跳转到视图了，它是要返回这种 Json 数据，即在 HandlerAdapter 调用 HandlerMethod 时，有一个阶段是处理返回值，即在处理返回值的阶段去检查是不是这个方法上标注了 @ResponseBody 注解，如果是的话，它就会标记 ModelAndView 已处理，后续就不会去执行视图渲染了，即在处理返回值阶段的时候生成一个叫 MessageConverter 的消息转换器，生成 Json 作为最终结果返回，就不会走视图渲染的流程，当然，这里的 postHandle 和 afterCompletion 这些拦截器的处理操作还是会执行</li></ul></blockquote><hr><h3 id="总结-3" tabindex="-1"><strong>总结</strong> <a class="header-anchor" href="#总结-3" aria-label="Permalink to &quot;**总结**&quot;">​</a></h3><figure><img src="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/spring-e29a122b-db07-48b8-8289-7251032e87a1.png" alt="Spring MVC的工作流程" loading="lazy" decoding="async" class="lazy"></figure><ol><li>客户端向服务端发送一次请求，这个请求会先到前端控制器 DispatcherServlet(也叫中央控制器)。</li><li>DispatcherServlet 接收到请求后会调用 HandlerMapping 处理器映射器。由此得知，该请求该由哪个 Controller 来处理（并未调用 Controller，只是得知）</li><li>DispatcherServlet 调用 HandlerAdapter 处理器适配器，告诉处理器适配器应该要去执行哪个 Controller</li><li>HandlerAdapter 处理器适配器去执行 Controller 并得到 ModelAndView(数据和视图)，并层层返回给 DispatcherServlet</li><li>DispatcherServlet 将 ModelAndView 交给 ViewReslover 视图解析器解析，然后返回真正的视图。</li><li>DispatcherServlet 将模型数据填充到视图中</li><li>DispatcherServlet 将结果响应给客户端</li></ol><p><strong>Spring MVC</strong> 虽然整体流程复杂，但是实际开发中很简单，大部分的组件不需要开发人员创建和管理，只需要通过配置文件的方式完成配置即可，真正需要开发人员进行处理的只有 <strong>Handler（Controller）</strong> 、<strong>View</strong> 、<strong>Model</strong>。</p><p>当然我们现在大部分的开发都是前后端分离，Restful 风格接口，后端只需要返回 Json 数据就行了。</p><hr><h2 id="_5-1-springmvc-restful-执行流程" tabindex="-1">5.1 SpringMVC Restful 执行流程 <a class="header-anchor" href="#_5-1-springmvc-restful-执行流程" aria-label="Permalink to &quot;5.1 SpringMVC Restful 执行流程&quot;">​</a></h2><p>PS:这是一道全新的八股，毕竟 ModelAndView 这种方式应该没人用了吧？现在都是前后端分离接口，八股也该更新换代了。</p><p>我们都知道 Restful 接口，响应格式是 json，这就用到了一个常用注解：<strong>@ResponseBody</strong></p><div class="language-java max-h-300px"><button title="Copy code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code v-pre><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">    @</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">GetMapping</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">"/user"</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">    @</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">ResponseBody</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">    public</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> User </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">user</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(){</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">        return</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> User</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">,</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">"张三"</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">    }</span></span></code></pre><button class="code-block-unfold-btn"></button></div><p>加入了这个注解后，整体的流程上和使用 ModelAndView 大体上相同，但是细节上有一些不同：</p><figure><img src="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20231206192404673.png" alt="image-20231206192404673" loading="lazy" decoding="async" class="lazy"></figure><ol><li><p>客户端向服务端发送一次请求，这个请求会先到前端控制器 DispatcherServlet</p></li><li><p>DispatcherServlet 接收到请求后会调用 HandlerMapping 处理器映射器。由此得知，该请求该由哪个 Controller 来处理</p></li><li><p>DispatcherServlet 调用 HandlerAdapter 处理器适配器，告诉处理器适配器应该要去执行哪个 Controller</p></li><li><p>Controller 被封装成了 ServletInvocableHandlerMethod，HandlerAdapter 处理器适配器去执行 invokeAndHandle 方法，完成对 Controller 的请求处理</p></li><li><p>HandlerAdapter 执行完对 Controller 的请求，会调用 HandlerMethodReturnValueHandler 去处理返回值，主要的过程：</p><p>5.1. 调用 RequestResponseBodyMethodProcessor，创建 ServletServerHttpResponse（Spring 对原生 ServerHttpResponse 的封装）实例</p><p>5.2.使用 HttpMessageConverter 的 write 方法，将返回值写入 ServletServerHttpResponse 的 OutputStream 输出流中</p><p>5.3.在写入的过程中，会使用 JsonGenerator（默认使用 Jackson 框架）对返回值进行 Json 序列化</p></li><li><p>执行完请求后，返回的 ModealAndView 为 null，ServletServerHttpResponse 里也已经写入了响应，所以不用关心 View 的处理</p></li></ol><hr><h2 id="_6-spring-注解" tabindex="-1">6. Spring 注解 <a class="header-anchor" href="#_6-spring-注解" aria-label="Permalink to &quot;6. Spring 注解&quot;">​</a></h2><p><strong>lang</strong></p><p>lang 中的注解是 Spring 框架内部自己使用的一些注解</p><ul><li>@NonNull</li><li>@NonNullApi</li><li>@NonNullFields</li><li>@Nullable</li><li>@UsesSunMisc</li></ul><hr><h3 id="事务注解" tabindex="-1"><strong>事务注解</strong> <a class="header-anchor" href="#事务注解" aria-label="Permalink to &quot;**事务注解**&quot;">​</a></h3><ul><li><p><strong>@EnableTransactionManagement</strong>，会额外加载 4 个 bean</p><ul><li>BeanFactoryTransactionAttributeSourceAdvisor 事务切面类</li><li>TransactionAttributeSource 用来解析事务属性</li><li>TransactionInterceptor 事务拦截器</li><li>TransactionalEventListenerFactory 事务监听器工厂</li></ul><figure><img src="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230422152841010.png" alt="image-20230422152841010" loading="lazy" decoding="async" class="lazy"></figure></li><li><p><strong>@Transactional</strong></p></li></ul><hr><p><strong>监控</strong></p><ul><li>@EnableMBeanExport</li><li>@ManagedAttribute</li><li>@ManagedMetric</li><li>@ManagedNotification</li><li>@ManagedNotifications</li><li>@ManagedOperation</li><li>@ManagedOperationParameter</li><li>@ManagedOperationParameters</li><li>@ManagedResource</li></ul><p><strong>核心</strong></p><ul><li>@AliasFor是给注解起别名(了解)</li></ul><ul><li><strong>@Order</strong>是用来控制一些bean它们的一些执行顺序，最低优先级=整数最大值</li></ul><p><strong>事件、调度、异步</strong></p><ul><li>@EventListener</li><li>@TransactionalEventListener</li><li>@EnableAsync</li><li>@Async</li><li>@EnableScheduling</li><li>@Scheduled</li><li>@Schedules</li></ul><hr><h3 id="切面" tabindex="-1"><strong>切面</strong> <a class="header-anchor" href="#切面" aria-label="Permalink to &quot;**切面**&quot;">​</a></h3><ul><li><strong>@EnableAspectJAutoProxy</strong><ul><li>会加载 AnnotationAwareAspectJAutoProxyCreator，它是一个 bean 后处理器，用来创建代理</li><li>如果没有配置 @EnableAspectJAutoProxy，又需要用到代理（如事务）则会使用 InfrastructureAdvisorAutoProxyCreator 这个 bean 后处理器</li></ul></li></ul><figure><img src="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230422154010262.png" alt="image-20230422154010262" loading="lazy" decoding="async" class="lazy"></figure><blockquote><ul><li>@EnableAspectJAutoProxy是启用我们的AOP这种自动代理，看看它@Import的实现，后面的类型加入 AnnotationAwareAspectJAutoProxyCreator 的 bean 后处理器，这个后处理会在 bean 的初始化后期帮助我们检查看看需不需添加一个代理，如果你的 bean 跟某个切点表达式匹配上了，它就会为你的 bean 生成一个代理对象，最终将代理对象放入单例池去代替掉目标的 target 对象，说白了，它就是帮助我们产生这个代理来协助 AOP 增强的，当然，这个代理的执行时机绝大多数情况都是在初始化之后生成代理的，如果遇到了循环依赖又需要代理的情况，它会让代理的生成提前，在这个依赖注入之前就生成代理</li><li>@Around、@Before、@After 这些与切面通知相关注解实际上是属于第三方库 AspectJ 提供的，Spring 只是借用了人家第三方的注解，并不是 Spring 自己的</li></ul></blockquote><h3 id="组件扫描与配置类" tabindex="-1"><strong>组件扫描与配置类</strong> <a class="header-anchor" href="#组件扫描与配置类" aria-label="Permalink to &quot;**组件扫描与配置类**&quot;">​</a></h3><ul><li><p>@Component</p></li><li><p>@Controller</p></li><li><p>@Service</p></li><li><p>@Repository</p></li></ul><blockquote><p>@Component、@Controller、@Service、@Repository 这四个是配合做组件扫描的，标注了这些注解的类将来一旦组件扫描到它了，就会把它纳入到 Spring 的容器管理，跟它们配合使用的还有 @ComponentScan，它可以指定一个起始包名，它就会以这个起始包名开始去扫描这个包以及这个包的所有子孙后代包，扫描这些注解，扫描到就把它们加入到 Spring 的容器管理中</p></blockquote><ul><li><p>@ComponentScan</p></li><li><p>@Conditional（Spring 自身就有的功能，并不是只有 SpringBoot）是在这个组件扫描时做一些条件装配，符合条件的就加入到 Spring 容器中，如果判断条件不成立，即使扫描到了，它也不会加入的，它除了和我们组件扫描时候配合以外，还可以跟这个配置类解析 @Bean时配合使用，也会判断是否满足条件</p></li><li><p><strong>@Configuration</strong></p><ul><li>配置类其实相当于一个工厂，标注 @Bean 注解的方法相当于工厂方法</li></ul><figure><img src="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230422190940503.png" alt="image-20230422190940503" loading="lazy" decoding="async" class="lazy"></figure><ul><li>@Bean 不支持方法重载，如果有多个重载方法，仅有一个能入选为工厂方法</li></ul><figure><img src="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230422191323803.png" alt="image-20230422191323803" loading="lazy" decoding="async" class="lazy"></figure><ul><li>@Configuration 默认会为标注的类生成代理，其目的是保证 @Bean 方法相互调用时，仍然能保证其单例特性</li></ul><figure><img src="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230422191956615.png" alt="image-20230422191956615" loading="lazy" decoding="async" class="lazy"></figure><ul><li>@Configuration 中如果含有 BeanFactory 后处理器的 bean 要创建，则实例工厂方法会导致 MyConfig 提前创建，造成其依赖注入失败，解决方法是改用静态工厂方法或直接为 @Bean 的方法参数依赖注入，针对 Mapper 扫描可以改用注解方式</li></ul><figure><img src="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230422192558594.png" alt="image-20230422192558594" loading="lazy" decoding="async" class="lazy"></figure></li><li><p>@Bean 是标注在配置类里的那些方法（工厂方法），标注 @Configuration 的配置类（工厂类）来定义 @Bean 方法返回的 bean</p></li><li><p>@Import</p><ul><li><p>四种用法</p><p>① 引入单个 bean</p><p>② 引入一个配置类</p><p>③ 通过 Selector 引入多个类</p><p>④ 通过 beanDefinition 注册器引入多个类</p></li></ul><figure><img src="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230422193333726.png" alt="image-20230422193333726" loading="lazy" decoding="async" class="lazy"></figure><ul><li><p>解析规则</p><ul><li>同一配置类中，@Import 先解析 @Bean 后解析</li><li>同名定义，默认后面解析的会覆盖前面解析的</li><li>不允许覆盖的情况下，如何能够让 MyConfig(主配置类) 的配置优先? (虽然覆盖方式能解决)</li><li>采用 DeferredImportSelector，因为它最后工作，可以简单认为先解析 @Bean，再 Import</li></ul></li></ul><figure><img src="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230422215656267.png" alt="image-20230422215656267" loading="lazy" decoding="async" class="lazy"></figure><blockquote><p>@Import是导入其他的配置类或普通类；导入其他的一些Selector根据它们返回的bean的名字把它们加入到当前的Spring容器中</p></blockquote></li><li><p>@Lazy</p><ul><li>加在类上，表示此类延迟实例化、初始化</li><li>加在方法参数上，此参数会以代理方式注入</li></ul><blockquote><p>有两个用途，一个用途是标注在类上，表示这个类是延迟初始化和实例化的，即一开始你没有用到的时候，它是不会创建这个标注了 @Lazy 的 bean 的实例，当你第一次用到的时候，才会去创建这个标注了 @Lazy 的 bean；还有一个更重要的用法是用在方法参数上和成员变量上，它可以解决循环依赖问题，即让你的这个依赖注入包括参数的注入，它是推迟执行，会注入一个代理对象，代理对象注入以后就解决了循环依赖，将来等循环依赖这个过程走完，你将来真正用到这个 bean 时，它才会真正创建这个 bean，它是用代理解决了循环依赖，这是它更重要的一个用途</p></blockquote></li><li><p>@PropertySource 是用来读取一些自定义的 properties 文件，把它们作为键值信息加入到我们 environment 对象里来， environment 就是包含了整个应用程序在运行期间需要的所有键值信息</p></li></ul><p><strong>依赖注入</strong></p><ul><li><strong>@Autowired</strong> 加在方法参数上或成员变量上都可以完成依赖注入</li><li><strong>@Qualifier</strong> 是在依赖注入时，如果同一类型有多个 bean，就会根据名字进行区分</li><li><strong>@Value</strong> 是做值注入的，可以对<code>${}</code>，<code>#{}</code>这种内嵌式的符号实现内嵌式的注入</li></ul><p><strong>缓存</strong></p><ul><li>@EnableCaching</li><li>@CacheConfig</li><li>@CacheEvict</li><li>@CachePut</li><li>@Cacheable</li><li>@Caching</li></ul><hr><h3 id="mvc-mapping" tabindex="-1"><strong>mvc mapping</strong> <a class="header-anchor" href="#mvc-mapping" aria-label="Permalink to &quot;**mvc mapping**&quot;">​</a></h3><ul><li>@RequestMapping 作用是建立我们请求路径跟控制器方法之间的映射关系，将来有一个请求过来的时候它就会根据这个请求路径与我们 @RequestMapping 中的路径进行一个匹配，匹配上了它就知道，接下来应该由匹配成功的标注了 @RequestMapping 注解的方法来处理这个请求，这是它的一个最重要的用途，当然这个注解也可以加在类上，加在类上时当你的这个类有多个控制器方法它们有一个相同的路径前缀时，那么可以把这个相同的路径前缀给它提取出来，放在类上的 @RequestMapping<ul><li>可以派生多个注解如 @GetMapping 等，@GetMapping 功能跟 @RequestMapping 相同，只不过 method 只能是GET请求，它不会去处理其他的 POST，PUT，DELETE 之类的请求，只认 GET 请求</li></ul></li></ul><p><strong>mvc rest</strong></p><ul><li>@RequestBody 是处理请求体中的 Json 数据的，把 Json 数据转换为 Java 对象</li><li>@ResponseBody 是把控制器上返回的 Java 对象转换成 Json 数据，然后写入到响应体，组合 @ResponseBody + @Controller = @RestController</li><li>@ResponseStatus 是可以控制响应的状态码</li></ul><p><strong>mvc 统一处理</strong></p><ul><li><strong>@ControllerAdvice</strong> ：如果你做一些统一处理的异常方法，或这个转换器方法，还有这个标注了 @ModelAttribute 的方法 ，都可以放在那种标注了 @ControllerAdvice 的类来达到一个统一处理的目的，当然，我们最常用的是把一些处理异常的方法放在标注了 @ControllerAdvice 的方法中来实现一个异常的统一处理，可以让一个标注了 @ExceptionHandler 的方法来处理异常，它是专门来处理异常方法的，当然，这两个注解结合使用的比较多</li><li>标注了 <strong>@ExceptionHandler</strong> 的方法不一定是放在标注了 @ControllerAdvice 的方法中，也可以放在一个普通的控制器中，放在一个单独的控制器中就相当于是一个局部的异常处理，如果方法在一个标注 @ControllerAdvice 的类中，就表示是一个全局的异常处理</li><li>@RestControllerAdvice 是一个组合注解，即 @ControllerAdvice + @ResponseBody，将来标注了 @ControllerAdvice 的<strong>方法</strong>做了异常处理，也会转换为 Json 数据写到响应体里</li></ul><p><strong>mvc 参数</strong></p><ul><li>@RequestHeader 是获取请求头中的参数信息</li><li>@CookieValue 是获取Cookie的值</li><li><strong>@PathVariable</strong> 是获取请求路径的参数值</li><li><strong>@RequestParam</strong> 是获取真正的请求参数值，就是之后的键值信息，也可以是表单中的请求参数，只要你的请求参数跟方法名称对应上，就可以省略这个@RequestParam，其主要作用是可以设置默认值，即defaultValue属性，如果没有传这个请求参数，可以给它设置一个默认值</li></ul><p><strong>转换与格式化</strong></p><ul><li>@DateTimeFormat是转换日期和时间格式</li><li>@NumberFormat是转换数字格式的</li><li>@InitBinder是注册一些自定义的类型转换器的</li></ul><p><strong>validation</strong>是做这个bean的校验的</p><ul><li>@Validated 加在 Javabean 上，表示这个 Javabean 将来要做数据校验，至于这个校验规则也是加在 Javabean 的属性上，它是借助一个第三方的注解，比如 @NotEmpty，@NotBlank，@NotNull等，这些注解才真正完成校验规则的，而 @Validated 只是作为一个校验的入口</li></ul><p><strong>scope</strong></p><ul><li>标注了@ApplicationScop，@RequestScope，@SessionScope这类的注解的类，就可以在Spring容器中里面控制它们的作用域</li></ul><p><strong>mvc ajax</strong></p><ul><li>@CrossOrigin是解决ajax请求的一个跨域问题，原理是在响应头上加一些特殊的头，允许你的这个ajax跨域的这种请求，当然，如果你用的HttpClient的这种客户端就没有这种跨域问题，它只适合用于javaScrip里面使用ajax访问时才会存在跨域问题</li></ul><hr><h3 id="boot" tabindex="-1"><strong>boot</strong> <a class="header-anchor" href="#boot" aria-label="Permalink to &quot;**boot**&quot;">​</a></h3><p><strong>auto</strong></p><ul><li>@SpringBootApplication（每个SpringBoot程序都要加的注解)是一个组合注解，即@EnableAutoConfiguration，@SpringBootConfiguration 和@ ComponentScan）</li><li>@EnableAutoConfiguration 是去找到一些自动配置类，把这些自动配置类关联的 Bean 都要注册到 Spring 容器当中，这个也是一个组合注解，@AutoConfigurationPackage 和 @Import，@AutoConfigurationPackage 的作用是它所标注的类的包名会被记录下来，放到容器中，将来你要用到这个包名的时候，那么就可以通过一个工具类到容器中找到这个包名</li><li>@SpringBootConfiguration 是表示一个针对 SpringBoot 的配置类，跟原生的 @Configuration 几乎等价，它跟 @Configuration 区别在哪呢，其实用 @Configuration 标注的，将来一个应用程序可以有多个的配置类，但是 @SpringBootConfiguration 它对应的配置类呢，整个应用程序只可以有这么一个配置类（应用程序类），因为它要根据它断定你的主配置，根据你的主配置类找到我们的应用程序，算是一个入口</li></ul><figure><img src="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230422190402081.png" alt="image-20230422190402081" loading="lazy" decoding="async" class="lazy"></figure><p><strong>condition</strong>（对@Conditional的一个扩展）</p><ul><li>@ConditionalOnClass是当你的类路径下包含某个类时，这个条件才算成立，比如说我要配置数据源，可能希望类路径下有具体的数据源实现类，如有一个driuid的DataSource，这个条件才成立，否则不成立，即检查类路径下如果有某个类存在条件才成立，才会执行后续的装配；<strong>classpath 下存在某个 class 时，条件才成立</strong></li></ul><figure><img src="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230422190325299.png" alt="image-20230422190325299" loading="lazy" decoding="async" class="lazy"></figure><ul><li>@ConditionalOnMissingBean 是当你的容器中缺失某个 bean 时，条件才成立，它经常作为一些后补的操作，如你没有提供某个 bean，即当你缺失配置某个 bean 时条件就会成立，把一个默认的后补的 bean 添加到 Spring 容器中，这个缺失的条件是根据 bean 的名字来匹配的，如果容器中没有这个 bean 时条件就成立，如果这个 bean 的名字已经存在了，条件就不成立；<strong>beanFactory 内不存在某个 bean 时，条件才成立</strong></li><li>@ConditionalOnProperty 是根据 properties 文件的键值信息，看看是不是做了某些键值的配置，如果这些键值配置了，并且条件相符，条件才算成立，比如你的某个键或值跟这个 @ConditionalOnProperty 中值也一致了，条件才算成立，如果你没有这个相应的键值，条件就不成立；<strong>配置文件中存在某个 property（键、值）时，条件才成立</strong></li></ul><p><strong>properties</strong></p><ul><li><p>@ConfigurationProperties，会将当前 bean 的属性与配置文件中的键值进行绑定</p><ul><li>@ConfigurationProperties 是把我们 properties 文件中的键值信息跟 JavaBean 的属性进行绑定，属性名称与这个配置文件中键的名称相同，对应的值就会赋值给我们标注了 @ConfigurationProperties 的 Javabean 的属性，相当于简化了一些 bean 的初始化，如果用 @Value 虽然也可以对这个值进行初始化，但是比较复杂，@ConfigurationProperties 在一定程度上可以去简化 @Value 的一些赋值操作</li></ul></li><li><p>@EnableConfigurationProperties 就是启用 @ConfigurationProperties 功能，它也是在 bean 工厂加了一些后处理器，这些后处理器能够识别 @ConfigurationProperties ，一旦识别到它就会执行这个绑定操作，<strong>会添加以下两个较为重要的 bean</strong></p><ul><li>ConfigurationPropertiesBindingPostProcessor，bean 后处理器，在 bean 初始化前调用下面的 binder</li><li>ConfigurationPropertiesBinder，真正执行绑定操作</li></ul></li></ul><hr><h2 id="_7-springboot-自动配置原理" tabindex="-1">7. SpringBoot 自动配置原理 <a class="header-anchor" href="#_7-springboot-自动配置原理" aria-label="Permalink to &quot;7. SpringBoot 自动配置原理&quot;">​</a></h2><p><strong>自动配置原理</strong></p><figure><img src="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230423003501071.png" alt="image-20230423003501071" loading="lazy" decoding="async" class="lazy"></figure><p>@SpringBootApplication 是一个组合注解，由 @ComponentScan、@EnableAutoConfiguration 和 @SpringBootConfiguration 组成</p><ol><li><p>@SpringBootConfiguration 与普通 @Configuration 相比，唯一区别是前者要求整个 app 中只出现一次</p></li><li><p>@ComponentScan</p><ul><li>excludeFilters - 用来在组件扫描时进行排除，也会排除自动配置类</li></ul><figure><img src="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230423003533333.png" alt="image-20230423003533333" loading="lazy" decoding="async" class="lazy"></figure></li><li><p>@EnableAutoConfiguration 也是一个组合注解，由下面注解组成</p><ul><li>@AutoConfigurationPackage – 用来记住扫描的起始包，放到容器中，将来要用到包名时可以用一个工具类到容器中找到</li><li>@Import(AutoConfigurationImportSelector.class) 用来加载 <code>META-INF/spring.factories</code> 中的自动配置类</li></ul><figure><img src="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230423004955603.png" alt="image-20230423004955603" loading="lazy" decoding="async" class="lazy"></figure></li></ol><p><strong>为什么不使用 @Import 直接引入自动配置类</strong></p><p>有两个原因：</p><ol><li>让主配置类和自动配置类变成了强耦合，主配置类不应该知道有哪些从属配置</li><li>直接用 <code>@Import(自动配置类.class)</code>，引入的配置解析优先级较高，自动配置类的解析应该在主配置没提供时作为默认配置</li></ol><p>因此，采用了 <code>@Import(AutoConfigurationImportSelector.class)</code></p><ul><li>由 <code>AutoConfigurationImportSelector.class</code> 去读取 <code>META-INF/spring.factories</code> 中的自动配置类，实现了弱耦合。</li><li>另外 <code>AutoConfigurationImportSelector.class</code> 实现了 DeferredImportSelector 接口，让自动配置的解析晚于主配置的解析</li></ul><hr><h2 id="_8-spring-中的设计模式" tabindex="-1">8. Spring 中的设计模式 <a class="header-anchor" href="#_8-spring-中的设计模式" aria-label="Permalink to &quot;8. Spring 中的设计模式&quot;">​</a></h2><h3 id="_1-spring-中的-singleton" tabindex="-1"><strong>1. Spring 中的 Singleton</strong> <a class="header-anchor" href="#_1-spring-中的-singleton" aria-label="Permalink to &quot;**1. Spring 中的 Singleton**&quot;">​</a></h3><p><strong>请大家区分 singleton pattern 与 Spring 中的 singleton bean</strong></p><ul><li>根据单例模式的目的 <em>Ensure a class only has one instance, and provide a global point of access to it</em></li><li>显然 Spring 中的 singleton bean 并非实现了单例模式，singleton bean 只能保证每个容器内，相同 id 的 bean 单实例</li><li>当然 Spring 中也用到了单例模式，例如<ul><li><code>org.springframework.transaction.TransactionDefinition#withDefaults</code></li><li><code>org.springframework.aop.TruePointcut#INSTANCE</code></li><li><code>org.springframework.aop.interceptor.ExposeInvocationInterceptor#ADVISOR</code></li><li><code>org.springframework.core.annotation.AnnotationAwareOrderComparator#INSTANCE</code></li><li><code>org.springframework.core.OrderComparator#INSTANCE</code></li></ul></li></ul><blockquote><p>单例模式的原始定义是确保一个类只有一个实例，并且提到一个全局的访问点，则Spring中的 Singleton bean 是不符合的，因为你一个 Spring 容器中可以一个类型定义多个实例，只要多个 bean 它们的 id 和名字有可能不一样，则可能有多个实例，而且 Spring 可以有多个容器的，多个容器同一个类也可能有不同的实例，同样的 propertype bean 也不是原型模式</p></blockquote><hr><h3 id="_2-spring-中的-builder" tabindex="-1"><strong>2. Spring 中的 Builder</strong> <a class="header-anchor" href="#_2-spring-中的-builder" aria-label="Permalink to &quot;**2. Spring 中的 Builder**&quot;">​</a></h3><p>定义： <em>Separate the construction of a complex object from its representation so that the same construction process can create different representations</em></p><p>它主要的亮点有三处：</p><ol><li><p>较为灵活的构建产品对象</p></li><li><p>在不执行最后 build 方法前，产品对象都不可用</p></li><li><p>构建过程采用链式调用，看起来比较爽</p></li></ol><p>Spring 中体现 Builder 模式的地方：（这种以Builder结尾的命名的，一般来讲都可以看作它是实现了这种构建器对象，可以对照着它的定义看一下）</p><ul><li><p>org.springframework.beans.factory.support.BeanDefinitionBuilder</p></li><li><p>org.springframework.web.util.UriComponentsBuilder</p></li><li><p>org.springframework.http.ResponseEntity.HeadersBuilder</p></li><li><p>org.springframework.http.ResponseEntity.BodyBuilder</p></li></ul><blockquote><p>Builder 建造器模式，它用在一个对象建造过程比较复杂，可以用这个构建器跟对象把它俩分离开来，这个构建器负责对象创建前的准备，最终调用它的Builder方法创建最终的产品对象</p></blockquote><hr><h3 id="_3-spring-中的-factory-method" tabindex="-1"><strong>3. Spring 中的 Factory Method</strong> <a class="header-anchor" href="#_3-spring-中的-factory-method" aria-label="Permalink to &quot;**3. Spring 中的 Factory Method**&quot;">​</a></h3><p>定义： <em>Define an interface for creating an object, but let subclasses decide which class to instantiate. Factory Method lets a class defer instantiation to subclasses</em></p><p>根据上面的定义，Spring 中的 ApplicationContext 与 BeanFactory 中的 getBean 都可以视为工厂方法，它隐藏了 bean （产品）的创建过程和具体实现；</p><blockquote><p>因为你 getBean 出来有可能是一个接口，但是具体实现你也不知道，它都是在 Spring 的配置文件或配置类 bean (产品)的创建过程和具体实现已经定义好了，并且你怎么构建也不知道，也不用去关心，甚至你不用接口去 getBean 它有可能给你返回的是一个<strong>代理</strong>，即隐藏了 bean 创建过程和具体实现</p></blockquote><p>Spring 中其它工厂：</p><ul><li><p>org.springframework.beans.factory.FactoryBean</p></li><li><p>@Bean 标注的静态方法及实例方法</p></li><li><p>ObjectFactory 及 ObjectProvider</p></li></ul><p>前两种工厂主要封装第三方的 bean 的创建过程，后两种工厂可以推迟 bean 创建，解决循环依赖及单例注入多例等问题</p><blockquote><p>Factory Method工厂方法模式，抛开它的定义，它的核心就是去让我们的接口和实现相分离，去降低耦合，这是它最重要的目的</p></blockquote><hr><h3 id="_4-spring-中的-adapter" tabindex="-1"><strong>4. Spring 中的 Adapter</strong> <a class="header-anchor" href="#_4-spring-中的-adapter" aria-label="Permalink to &quot;**4. Spring 中的 Adapter**&quot;">​</a></h3><p>定义： <em>Convert the interface of a class into another interface clients expect. Adapter lets classes work together that couldn’t otherwise because of incompatible interfaces</em></p><p>典型的实现有两处：</p><ul><li><code>org.springframework.web.servlet.HandlerAdapter</code> – 因为控制器实现有各种各样，比如有<ul><li>大家熟悉的 @RequestMapping 标注的控制器实现</li><li>传统的基于 Controller 接口（不是 @Controller 注解啊）的实现</li><li>较新的基于 RouterFunction 接口的实现</li><li>它们的处理方法都不一样，为了统一调用，必须适配为 HandlerAdapter 接口</li></ul></li><li><code>org.springframework.beans.factory.support.DisposableBeanAdapter</code> – 因为销毁方法多种多样，因此都要适配为 DisposableBean 来统一调用销毁方法</li></ul><blockquote><p>Adapter适配器模式，适配器模式的定义是把一个或一套接口转换成另一套调用者所期望的接口</p></blockquote><hr><h3 id="_5-spring-中的-composite" tabindex="-1"><strong>5. Spring 中的 Composite</strong> <a class="header-anchor" href="#_5-spring-中的-composite" aria-label="Permalink to &quot;**5. Spring 中的 Composite**&quot;">​</a></h3><p>定义： <em>Compose objects into tree structures to represent part-whole hierarchies. Composite lets clients treat individual objects and compositions of objects uniformly</em></p><p>典型实现有：</p><ul><li>org.springframework.web.method.support.HandlerMethodArgumentResolverComposite</li><li>org.springframework.web.method.support.HandlerMethodReturnValueHandlerComposite</li><li>org.springframework.web.servlet.handler.HandlerExceptionResolverComposite</li><li>org.springframework.web.servlet.view.ViewResolverComposite</li></ul><p>composite 对象的作用是，将分散的调用集中起来，统一调用入口，它的特征是，与具体干活的实现实现的是同一个接口，当调用 composite 对象的接口方法时，其实是委托具体干活的实现来完成</p><blockquote><p>Composite 组合模式，它的作用是将分散的调用集中起来，统一调用入口，如在 SpringMVC 中，在调用某个控制器方法前都要给它准备各种各样的参数，不同的参数它的来源是不一样的，获取方式也不一样，如有的是从路径中获取参数，有的是从请求参数获取信息，有的是要生成一个 Model 模型对象作为参数，有的是从传统的 request，response 中获取参数，所以这种不同的参数的解析也是不一样的，这么多参数的解析器，我们要把它们的调用统一起来，我们就提供一个 HandlerMethodArgumentResloverComposite，即参数解析器的组合器，将来只需要调用组合器就行，组合器里有个集合，这个集合里有各种各样的参数解析器，这样就把分散的调用集中起来，统一调用入口，它的特征是与具体干活的实现实现的是同一个 HandlerMethodArgumentReslover 接口，当调用 composite 组合器对象的接口方法时，其实是委托具体干活的实现来完成的</p></blockquote><hr><h3 id="_6-spring-中的-decorator" tabindex="-1"><strong>6. Spring 中的 Decorator</strong> <a class="header-anchor" href="#_6-spring-中的-decorator" aria-label="Permalink to &quot;**6. Spring 中的 Decorator**&quot;">​</a></h3><p>定义： <em>Attach additional responsibilities to an object dynamically. Decorators provide a flexible alternative to subclassing for extending functionality</em></p><p>典型实现：</p><ul><li>org.springframework.web.util.ContentCachingRequestWrapper</li></ul><blockquote><p>Decorator 装饰器模式，它的定义是对一个对象动态地去增加一些职责和功能，它主要解决这种用子类扩展方式来实现这种功能增强的问题，因为子类去实现功能增强最大的问题是子类不管用不用的到，它都得把父类的方法继承过来，即继承了很多它用不上的父类方法，装饰器就可以避免这个问题，它跟代理模式的定义很像，也是做功能增强，但做功能增强的实际上不是代理对象，是那些通知(环绕通知之类的)，代理其实只起到一个入口的作用，代理只起到对目标对象和目标方法提供一个统一入口的作用，把它们结合起来</p></blockquote><hr><h3 id="_7-spring-中的-proxy" tabindex="-1"><strong>7. Spring 中的 Proxy</strong> <a class="header-anchor" href="#_7-spring-中的-proxy" aria-label="Permalink to &quot;**7. Spring 中的 Proxy**&quot;">​</a></h3><p>定义： <em>Provide a surrogate or placeholder for another object to control access to it</em></p><p>装饰器模式注重的是功能增强，避免子类继承方式进行功能扩展，而代理模式更注重控制目标的访问</p><p>典型实现：</p><ul><li><p>org.springframework.aop.framework.JdkDynamicAopProxy</p><ul><li>用jdk动态代理的方式生成最终的代理对象，它的限制是要求你的目标对象必须实现一个接口，那生成的代理也是针对这个接口代理</li></ul></li><li><p>org.springframework.aop.framework.ObjenesisCglibAopProxy</p><ul><li>既可以针对接口代理，也可以生成一个子类作为代理，<strong>Objenesis是做补充的（提供一个无参构造）</strong>，这种如果你的目标它没有无参构造，那它在创建这个目标对象时就创建不了，它必须让目标提供一个无参构造</li><li>Objenesis相当于一个小工具，即使你的目标只有一些带参构造，没有无参构造，它也可以生成一个空空如也的对象，让这个代理能够创建成功</li></ul></li></ul><blockquote><p>Proxy代理模式，它原本的定义是对另外的对象提供一个代理或者占位用来控制对这个对象的访问，即侧重于对这个目标对象的控制和访问，而不是侧重于对目标对象做功能增强的</p></blockquote><hr><h3 id="_8-spring-中的-chain-of-responsibility" tabindex="-1"><strong>8. Spring 中的 Chain of Responsibility</strong> <a class="header-anchor" href="#_8-spring-中的-chain-of-responsibility" aria-label="Permalink to &quot;**8. Spring 中的 Chain of Responsibility**&quot;">​</a></h3><p>定义： <em>Avoid coupling the sender of a request to its receiver by giving more than one object a chance to handle the request. Chain the receiving objects and pass the request along the chain until an object handles it</em></p><p>典型实现：</p><ul><li>org.springframework.web.servlet.HandlerInterceptor</li></ul><blockquote><p>Chain of Responsibility责任链模式，它的定义是将来可以有多个请求的处理对象，把这多个请求的处理对象串成一个链，每个对象都有机会处理这个请求，这个请求就会沿着这个处理链依次向后传递，直到遇到一个能够处理它的对象为止，根据这个定义，SpringMVC的HandlerInterceptor拦截器是符合这个定义的，我们使用拦截器的时候都知道，多个拦截器都会和最终的这个控制器方法形成一个调用链，这个调用链其实就是我们这里的责任链，请求会沿着这个调用链，先给调用链里第一个拦截器，第一个拦截器处理完后放行了就交给第二个拦截器，以此类推，最终到达我们的这个控制器方法来调用它，这就是拦截器的一个典型体现</p></blockquote><hr><h3 id="_9-spring-中的-observer" tabindex="-1"><strong>9. Spring 中的 Observer</strong> <a class="header-anchor" href="#_9-spring-中的-observer" aria-label="Permalink to &quot;**9. Spring 中的 Observer**&quot;">​</a></h3><p>定义： <em>Define a one-to-many dependency between objects so that when one object changes state, all its dependents are notified and updated automatically</em></p><p>典型实现：</p><ul><li>org.springframework.context.ApplicationListener</li><li>org.springframework.context.event.ApplicationEventMulticaster</li><li>org.springframework.context.ApplicationEvent</li></ul><blockquote><p>Observer观察者模式，作用就是用来解耦的，它主要体现在Spring它实现了这种ApplicationListener监听器(接收事件)，ApplicationEventMulticaster事件广播器(发生事件)，想当于把发送者和接收者进行一个解耦，还有一个ApplicationEvent对象</p></blockquote><hr><h3 id="_10-spring-中的-strategy" tabindex="-1"><strong>10. Spring 中的 Strategy</strong> <a class="header-anchor" href="#_10-spring-中的-strategy" aria-label="Permalink to &quot;**10. Spring 中的 Strategy**&quot;">​</a></h3><p>定义： <em>Define a family of algorithms, encapsulate each one, and make them interchangeable. Strategy lets the algorithm vary independently from clients that use it</em></p><p>典型实现：</p><ul><li><p>org.springframework.beans.factory.support.InstantiationStrategy</p></li><li><p>org.springframework.core.annotation.MergedAnnotations.SearchStrategy</p><ul><li>查找注解的时候,它是要到当前类查找还是要考虑它的父类呢，就用到多种策略方式</li></ul></li><li><p>org.springframework.boot.autoconfigure.condition.SearchStrategy</p><ul><li>做条件判断的时候，同样的条件判断是看看你的这个bean是当前容器里还是在这个父容器里呢，还是在所有容器里都去找呢，也是有一个搜索的策略</li></ul></li></ul><hr><h3 id="_11-spring-中的-template-method" tabindex="-1"><strong>11. Spring 中的 Template Method</strong> <a class="header-anchor" href="#_11-spring-中的-template-method" aria-label="Permalink to &quot;**11. Spring 中的 Template Method**&quot;">​</a></h3><p>定义： <em>Define the skeleton of an algorithm in an operation, deferring some steps to subclasses. Template Method lets subclasses redefine certain steps of an algorithm without changing the algorithm’s structure</em></p><p>典型实现：</p><ul><li>大部分以 Template 命名的类，如 JdbcTemplate，TransactionTemplate</li><li>很多以 Abstract 命名的类，如 AbstractApplicationContext</li></ul><!--]--><!--]--><!----><!--[--><div m="y-4" class="end flex justify-center items-center"><hr class="line inline-flex" w="full" m="!y-2"><span p="x-4" font="bold" class="whitespace-nowrap">To Be Continued.</span><hr class="line inline-flex" w="full" m="!y-2"></div><!--]--></article><!-- </Transition> --><!--]--><!--[--><!--[--><!--[--><div class="yun-sponsor-container flex-center flex-col" m="t-6"><button class="sponsor-button yun-icon-btn shadow hover:shadow-md" title="打赏" text="red-400"><div class="mt-2px" i-ri-heart-fill></div></button><div m="y-4" class="qrcode-container qrcode flex-center flex-col"><div class="sponsor-description" mb="4" text="sm">你的打赏和支持是我坚持写下去的动力</div><div class="flex justify-around"><!--[--><a class="flex-center flex-col animate-iteration-1 animate-fade-in" href="/images/sponsor/alipay.png" target="_blank" style="color:#00a3ee"><img class="sponsor-method-img" border="~ rounded" p="1" loading="lazy" src="/images/sponsor/alipay.png" title="支付宝"><div text="xl" m="2" class="i-ri-alipay-line"></div></a><a class="flex-center flex-col animate-iteration-1 animate-fade-in" href="/images/sponsor/qqpay.png" target="_blank" style="color:#12b7f5"><img class="sponsor-method-img" border="~ rounded" p="1" loading="lazy" src="/images/sponsor/qqpay.png" title="QQ 支付"><div text="xl" m="2" class="i-ri-qq-line"></div></a><a class="flex-center flex-col animate-iteration-1 animate-fade-in" href="/images/sponsor/wechatpay.png" target="_blank" style="color:#2dc100"><img class="sponsor-method-img" border="~ rounded" p="1" loading="lazy" src="/images/sponsor/wechatpay.png" title="微信支付"><div text="xl" m="2" class="i-ri-wechat-pay-line"></div></a><!--]--></div></div></div><ul class="post-copyright" m="y-4"><li class="post-copyright-author"><strong>本文作者：</strong><span>imklaus</span></li><li class="post-copyright-link"><strong>本文链接：</strong><a href="https://www.imlklaus.cn/posts/Java_Interview_Topics-Framework" target="_blank" title="本文链接">https://www.imlklaus.cn/posts/Java_Interview_Topics-Framework</a></li><li class="post-copyright-license"><strong>版权声明：</strong><span>本博客所有文章除特别声明外，均默认采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" target="_blank" rel="noopener" title="CC BY-NC-SA 4.0 ">CC BY-NC-SA</a> 许可协议。</span></li></ul><!--]--><!--]--><!--]--></div><!--]--><!----></div><!--[--><!--]--><!--[--><div class="post-nav"><div class="post-nav-item"><a href="/posts/Concurrent_Programming-Basic+Synchronous" class="post-nav-prev" title="并发编程整理版 - 基础/同步"><div class="icon" i-ri-arrow-left-s-line></div><span class="title truncate" text="sm">并发编程整理版 - 基础/同步</span></a></div><div class="post-nav-item"><a href="/posts/interview2025" class="post-nav-next" title="面试笔录"><span class="title truncate" text="sm">面试笔录</span><div class="icon" i-ri-arrow-right-s-line></div></a></div></div><!--]--><!--[--><!--]--><!--[--><div class="yun-card flex-center rounded-2 comment yun-comment sm:p-6 lg:px-12 xl:px-16" flex="col" min-h="100px" bg="$va-c-bg-light" w="full" p="4"><!----><!----><!--[--><!----><!--]--><!----></div><!--]--><!--[--><!-- eslint-disable-next-line vue/no-lone-template empty --><template class="mt-4"></template><!--]--><!--[--><!--]--><!--[--><!--]--></div><!--]--></main><!--[--><button class="xl:hidden toc-btn shadow-md fixed yun-icon-btn z-20 bg-$va-c-bg-soft" opacity="75" right="4" bottom="19"><div i-ri-file-list-line></div></button><!----><aside flex="~ col" class="va-card yun-aside sticky top-0 lg:top-$yun-margin-top min-h-sm" text="center" overflow="auto"><div class="w-full" flex="~ col" pb-2 style="display:none"><!--[--><h2 m="t-6 b-2" font="serif black">文章目录</h2><div style="display:none" data-v-2cefcb73><div class="content" data-v-2cefcb73><div class="outline-title" data-v-2cefcb73>本页</div><div class="outline-marker" data-v-2cefcb73></div><nav aria-labelledby="doc-outline-aria-label" data-v-2cefcb73><span id="doc-outline-aria-label" class="visually-hidden" data-v-2cefcb73>Table of Contents for current page</span><ul class="root va-toc relative z-1 css-i18n-toc" data-v-2cefcb73 data-v-c0236dac><!--[--><!--]--></ul></nav></div></div><!--]--><div class="flex-grow"></div><!----></div></aside><!--]--><!--]--></div><footer flex="~ col" class="relative yun-footer va-footer px-4 py-4 pt-0 text-$va-c-text-light w-full mt-14" bg="white dark:$va-c-bg-soft" text="center sm"><div class="yun-cloud absolute top--10 left-0 right-0"><svg class="waves" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M-160 44c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z" fill="var(--yun-c-cloud)"/></defs><g class="parallax"><use xlink:href="#gentle-wave" x="48" y="0"/><use xlink:href="#gentle-wave" x="48" y="3"/><use xlink:href="#gentle-wave" x="48" y="5"/><use xlink:href="#gentle-wave" x="48" y="7"/></g></svg></div><div class="beian" m="y-2"><a href="https://beian.miit.gov.cn/" target="_blank" rel="noopener">粤ICP备2025395704号</a></div><div class="copyright flex justify-center items-center gap-2" p="1"><span>©<!--[--> 2023 -<!--]--> 2025</span><a class="animate-pulse inline-flex" href="https://www.yunyoujun.cn/sponsors/" target="_blank" title="Sponsor YunYouJun"><div class="i-ri-bluesky-fill"></div></a><span>imklaus</span></div><div class="powered" m="2"><span>由 <a href="git+https://github.com/YunYouJun/valaxy.git" target="_blank" rel="noopener">Valaxy</a> <span class="op-60">v0.26.10</span> 驱动</span><span mx-1>|</span><span><span>主题</span><span mx-1>-</span><a href="git+https://github.com/YunYouJun/valaxy/tree/main/packages/valaxy-theme-yun.git" title="valaxy-theme-yun" target="_blank">Yun</a><span class="ml-1 op-60">v0.26.10</span></span></div><!--[--><!--]--><div class="yun-footer-gradient" style="--gradient-from:161 196 253;--gradient-to:194 233 251"></div></footer><!--]--><!--]--></div><script>window.__INITIAL_STATE__='{"pinia":{"yun-app":{},"app":{"showLoading":true},"site":{},"routerStore":{}}}'</script><script type="application/ld+json" data-hid="schema-org-graph">{"@context":"https://schema.org","@graph":[{"@id":"https://www.imlklaus.cn/#identity","@type":"Person","name":"imklaus","url":"https://www.imlklaus.cn/","image":{"@id":"https://www.imlklaus.cn/#/schema/image/4219811"},"sameAs":["/atom.xml","https://music.163.com/#/user/home?id=102158629","https://space.bilibili.com/19430480","https://github.com/imLKlauS","https://t.me/elpsycn","mailto:me@imlklaus.cn","https://www.travellings.cn/go.html"]},{"@id":"https://www.imlklaus.cn/#website","@type":"WebSite","dateModified":"2023-4-21 19:52:05","datePublished":"2023-4-21 19:52:05","inLanguage":"en","name":"Java面试专题 - 框架篇","url":"https://www.imlklaus.cn/","publisher":{"@id":"https://www.imlklaus.cn/#identity"}},{"@id":"https://www.imlklaus.cn/#webpage","@type":"WebPage","dateModified":"2023-04-21T11:52:05.000Z","datePublished":"2023-04-21T11:52:05.000Z","description":"The Winner Takes It All.","name":"Java面试专题 - 框架篇","url":"https://www.imlklaus.cn/","about":{"@id":"https://www.imlklaus.cn/#identity"},"isPartOf":{"@id":"https://www.imlklaus.cn/#website"},"potentialAction":[{"@type":"ReadAction","target":["https://www.imlklaus.cn/"]}]},{"@id":"https://www.imlklaus.cn/#article","dateModified":"2023-04-21T11:52:05.000Z","datePublished":"2023-04-21T11:52:05.000Z","description":"The Winner Takes It All.","headline":"Java面试专题 - 框架篇","inLanguage":"en","thumbnailUrl":"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/black_saber.png","@type":["Article","BlogPosting"],"author":{"@id":"https://www.imlklaus.cn/#/schema/person/893d71a"},"image":{"@id":"https://www.imlklaus.cn/#/schema/image/257429a"},"isPartOf":{"@id":"https://www.imlklaus.cn/#webpage"},"mainEntityOfPage":{"@id":"https://www.imlklaus.cn/#webpage"},"publisher":{"@id":"https://www.imlklaus.cn/#identity"}},{"@id":"https://www.imlklaus.cn/#/schema/person/893d71a","@type":"Person","name":"imklaus","url":"https://www.imlklaus.cn/"},{"@id":"https://www.imlklaus.cn/#/schema/image/4219811","@type":"ImageObject","contentUrl":"https://www.imlklaus.cn/images/tiamat8.jpg","inLanguage":"en","url":"https://www.imlklaus.cn/images/tiamat8.jpg"},{"@id":"https://www.imlklaus.cn/#/schema/image/257429a","@type":"ImageObject","contentUrl":"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/black_saber.png","inLanguage":"en","url":"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/black_saber.png"}]}</script></body></html>