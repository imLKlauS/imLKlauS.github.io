<!DOCTYPE html><html lang="en" data-beasties-container><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><link rel="icon" href="/favicon/dinosaur-egg.png"><script>!function(){const e=window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches,t=localStorage.getItem("vueuse-color-scheme")||"auto";("dark"===t||e&&"light"!==t)&&document.documentElement.classList.toggle("dark",!0)}()</script><style type="text/css">:root{color-scheme:light dark;--va-c-bg:#fff}html{background-color:var(--va-c-bg)}.yun-cloud{display:flex;width:100%;z-index:var(--yun-z-cloud);box-sizing:border-box}.yun-cloud .waves{display:flex;position:relative;width:100%;height:40px}.yun-cloud .parallax>use{animation:move-forever 25s cubic-bezier(.55,.5,.45,.5) infinite}.yun-cloud .parallax>use:first-child{opacity:.7;animation-delay:-2s;animation-duration:7s}.yun-cloud .parallax>use:nth-child(2){opacity:.5;animation-delay:-3s;animation-duration:10s}.yun-cloud .parallax>use:nth-child(3){opacity:.3;animation-delay:-4s;animation-duration:13s}.yun-cloud .parallax>use:nth-child(4){animation-delay:-5s;animation-duration:20s}@keyframes move-forever{0%{transform:translate3d(-90px,0,0)}to{transform:translate3d(85px,0,0)}}.yun-footer{letter-spacing:.05rem;line-height:1.8}.yun-footer-gradient{position:absolute;bottom:0;left:0;right:0;width:100%;height:300px;z-index:999;pointer-events:none;background:linear-gradient(to right,rgb(var(--gradient-from)/.2) 0,rgb(var(--gradient-to)/.2));-webkit-mask-image:linear-gradient(#fff0,#000 70%);mask-image:linear-gradient(#fff0,#000 70%);animation:fade-in 2s}.va-toc[data-v-2cefcb73]{text-align:left}.content[data-v-2cefcb73]{position:relative;padding-left:16px;font-size:14px;text-align:left}.outline-marker[data-v-2cefcb73]{position:absolute;top:32px;left:-2px;z-index:0;opacity:0;width:4px;height:18px;background-color:var(--va-c-brand);transition:top .25s cubic-bezier(0,1,.5,1),background-color .5s,opacity .25s;border-top-right-radius:2px;border-bottom-right-radius:2px}.outline-title[data-v-2cefcb73]{letter-spacing:.4px;line-height:28px;font-size:14px;font-weight:600}.visually-hidden[data-v-2cefcb73]{position:absolute;width:1px;height:1px;white-space:nowrap;clip:rect(0 0 0 0);clip-path:inset(50%);overflow:hidden}.yun-aside{width:0;transform:translate(100%);transition:all .2s cubic-bezier(.77,0,.17,1.02);max-height:calc(100vh - var(--yun-margin-top))}@media screen and (min-width:1280px){.yun-aside{transform:translate(0)}}.toc-btn{color:var(--va-c-primary);z-index:var(--yun-z-toc-btn)}.back-to-top{position:fixed;right:-1.5rem;bottom:1rem;z-index:var(--yun-z-go-up-btn);opacity:0;pointer-events:none;color:var(--va-c-primary);transform:translate(0) rotate(270deg);transition:all var(--va-transition-duration),opacity var(--va-transition-duration-fast)!important}.progress-circle{transition:.3s stroke-dashoffset;transform:rotate(-90deg);transform-origin:50% 50%}.progress-circle-container{position:absolute}.spinner[data-v-e7dc65c9]{width:60px;height:60px;border:1px solid var(--va-c-primary);margin:100px auto;animation:rotateplane-e7dc65c9 1.2s infinite ease-in-out}@keyframes rotateplane-e7dc65c9{0%{transform:perspective(120px) rotateX(0) rotateY(0)}50%{transform:perspective(120px) rotateX(-180.1deg) rotateY(0)}to{transform:perspective(120px) rotateX(-180deg) rotateY(-180deg)}}.yun-bg{position:fixed;width:100%;height:100%;z-index:-1;top:0;left:0;background-image:var(--yun-bg-img);background-size:cover;background-position:center;background-repeat:no-repeat;background-attachment:fixed;animation-name:bg-fade-in;animation-duration:2s;opacity:var(--yun-bg-img-opacity, 1)}@supports (-webkit-touch-callout:none){.yun-bg{background-attachment:scroll}}@keyframes bg-fade-in{0%{opacity:0}to{opacity:var(--yun-bg-img-opacity, 1)}}canvas.fireworks{position:fixed;left:0;top:0;z-index:1;pointer-events:none}.yun-page-header-gradient{position:absolute;top:0;left:0;right:0;width:100%;height:500px;z-index:var(--yun-z-page-gradient);pointer-events:none;background:linear-gradient(to right,rgb(var(--gradient-from)/.2) 0,rgb(var(--gradient-to)/.2));-webkit-mask-image:linear-gradient(#000,#fff0 70%);mask-image:linear-gradient(#000,#fff0 70%);animation:fade-in 2s}:root{--p-overlay-popover-shadow:0px 4px 6px -1px rgb(0 0 0 / .1),0px 2px 4px -2px rgb(0 0 0 / .1);--p-overlay-popover-border-radius:4px;--p-tooltip-max-width:12.5rem;--p-tooltip-gutter:.25rem;--p-tooltip-shadow:var(--p-overlay-popover-shadow);--p-tooltip-padding:.25rem .75rem;--p-tooltip-border-radius:var(--p-overlay-popover-border-radius);--p-tooltip-background:var(--va-c-bg);--p-tooltip-color:var(--va-c-text)}*,:after,:before{box-sizing:border-box;border-width:0;border-style:solid;border-color:var(--un-default-border-color,#e5e7eb)}html{line-height:1.5;-webkit-text-size-adjust:100%;-moz-tab-size:4;tab-size:4;font-family:ui-sans-serif,system-ui,sans-serif,"Apple Color Emoji","Segoe UI Emoji",Segoe UI Symbol,"Noto Color Emoji";font-feature-settings:normal;font-variation-settings:normal;-webkit-tap-highlight-color:transparent}body{margin:0;line-height:inherit}a{color:inherit;text-decoration:inherit}code,pre{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,Liberation Mono,Courier New,monospace;font-feature-settings:normal;font-variation-settings:normal;font-size:1em}button{font-family:inherit;font-feature-settings:inherit;font-variation-settings:inherit;font-size:100%;font-weight:inherit;line-height:inherit;color:inherit;margin:0;padding:0}button{text-transform:none}button{-webkit-appearance:button;background-image:none}blockquote,figure,h1,h2,h3,h4,h5,hr,p,pre{margin:0}ol,ul{list-style:none;margin:0;padding:0}button{cursor:pointer}body{counter-reset:katexEqnNo mmlEqnNo}:root{--va-c-border:#c2c2c4;--va-c-divider:#e2e2e3;--va-c-gutter:#e2e2e3}:root{--va-c-gray-1:#dddde3;--va-c-gray-2:#e4e4e9;--va-c-gray-3:#ebebef;--va-c-gray-soft:rgba(142, 150, 170, .14);--va-c-indigo-1:#3451b2;--va-c-indigo-2:#3a5ccc;--va-c-indigo-3:#5672cd;--va-c-indigo-soft:rgba(100, 108, 255, .14);--va-c-green-1:#18794e;--va-c-green-2:#299764;--va-c-green-3:#30a46c;--va-c-green-soft:rgba(16, 185, 129, .14);--va-c-yellow-1:#915930;--va-c-yellow-2:#946300;--va-c-yellow-3:#9f6a00;--va-c-yellow-soft:rgba(234, 179, 8, .14);--va-c-red-1:#b8272c;--va-c-red-2:#d5393e;--va-c-red-3:#e0575b;--va-c-red-soft:rgba(244, 63, 94, .14);--va-c-sponsor:#db2777}:root{--va-c-default-1:var(--va-c-gray-1);--va-c-default-2:var(--va-c-gray-2);--va-c-default-3:var(--va-c-gray-3);--va-c-default-soft:var(--va-c-gray-soft);--va-c-brand-1:var(--va-c-indigo-1);--va-c-brand-2:var(--va-c-indigo-2);--va-c-brand-3:var(--va-c-indigo-3);--va-c-brand-soft:var(--va-c-indigo-soft);--va-c-brand:var(--va-c-brand-1);--va-c-tip-1:var(--va-c-brand-1);--va-c-tip-2:var(--va-c-brand-2);--va-c-tip-3:var(--va-c-brand-3);--va-c-tip-soft:var(--va-c-brand-soft);--va-c-warning-1:var(--va-c-yellow-1);--va-c-warning-2:var(--va-c-yellow-2);--va-c-warning-3:var(--va-c-yellow-3);--va-c-warning-soft:var(--va-c-yellow-soft);--va-c-danger-1:var(--va-c-red-1);--va-c-danger-2:var(--va-c-red-2);--va-c-danger-3:var(--va-c-red-3);--va-c-danger-soft:var(--va-c-red-soft)}:root{--va-aside-width:256px;--va-sidebar-width:300px;--va-border-width:1px;--va-font-serif:"Noto Serif SC",DM Serif Display,STZhongsong,STKaiti,KaiTi,Roboto,serif;--va-font-sans:DM Sans,Inter,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Oxygen,Ubuntu,Cantarell,"Fira Sans","Droid Sans","Helvetica Neue",sans-serif;--va-font-mono:DM Mono,Menlo,Monaco,Consolas,"Courier New",monospace;--va-transition-duration-fast:.2s;--va-transition-duration:.4s;--va-transition-duration-slow:.6s;--va-transition:all var(--va-transition-duration-fast) ease-in-out}:root{--va-c-white:#fff;--va-c-black:#1a1a1a;--va-c-gray:#8e8e8e;--va-c-danger:#db2828;--va-c-warning:#f2711c;--va-c-text-light-1:#213547;--va-c-text-light-2:rgba(60, 60, 60, .7);--va-c-text-light-3:rgba(60, 60, 60, .33);--va-c-text-light-4:rgba(60, 60, 60, .18);--va-c-text-dark-1:rgba(255, 255, 255, .87);--va-c-text-dark-2:rgba(235, 235, 235, .6);--va-c-text-dark-3:rgba(235, 235, 235, .38);--va-c-text-dark-4:rgba(235, 235, 235, .18);--va-c-primary-light:rgb(192.9, 91.2, 255);--va-c-primary-lighter:rgb(199.8, 109.4, 255);--va-c-primary-dark:rgb(173.5648351648, 40.2, 255);--va-c-primary:#BA49FF}:root{color-scheme:light;--va-c-brand:#BA49FF;--va-border-color:#222;--va-c-text:#333;--va-c-text-light:#555;--va-c-text-lighter:#666;--va-c-text-dark:#111;--va-c-primary-rgb:186,73,255;--va-c-link:var(--va-c-primary-dark)}:root{--va-c-text-1:rgba(60, 60, 67);--va-c-text-2:rgba(60, 60, 67, .78);--va-c-text-3:rgba(60, 60, 67, .56)}:root{--va-c-bg:#ffffff;--va-c-bg-light:#ffffff;--va-c-bg-dark:#fafafa;--va-c-bg-opacity:rgba(255, 255, 255, .8);--va-c-bg-soft:#f9f9f9;--va-c-bg-alt:#f9f9f9;--va-c-bg-mute:#f1f1f1}:root{--va-code-line-height:1.7;--va-code-font-size:.875em;--va-code-block-color:var(--va-c-text-2);--va-code-block-bg:var(--va-c-bg-alt);--va-code-block-divider-color:var(--va-c-gutter);--va-code-lang-color:var(--va-c-text-3);--va-code-line-highlight-color:var(--va-c-default-soft);--va-code-line-number-color:var(--va-c-text-3);--va-code-line-diff-add-color:var(--va-c-green-soft);--va-code-line-diff-add-symbol-color:var(--va-c-green-1);--va-code-line-diff-remove-color:var(--va-c-red-soft);--va-code-line-diff-remove-symbol-color:var(--va-c-red-1);--va-code-line-warning-color:var(--va-c-yellow-soft);--va-code-line-error-color:var(--va-c-red-soft);--va-code-copy-code-border-color:var(--va-c-divider);--va-code-copy-code-bg:var(--va-c-bg-soft);--va-code-copy-code-hover-border-color:var(--va-c-divider);--va-code-copy-code-hover-bg:var(--va-c-bg);--va-code-copy-code-active-text:var(--va-c-text-2);--va-code-copy-copied-text-content:"Copied";--va-code-tab-divider:var(--va-code-block-divider-color);--va-code-tab-text-color:var(--va-c-text-2);--va-code-tab-bg:var(--va-code-block-bg);--va-code-tab-hover-text-color:var(--va-c-text-1);--va-code-tab-active-text-color:var(--va-c-text-1);--va-code-tab-active-bar-color:var(--va-c-brand-1)}:root{--va-icon-copy:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' height='20' width='20' stroke='rgba(128,128,128,1)' stroke-width='2' class='h-6 w-6' viewBox='0 0 24 24'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' d='M9 5H7a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2h-2M9 5a2 2 0 0 0 2 2h2a2 2 0 0 0 2-2M9 5a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2'/%3E%3C/svg%3E");--va-icon-copied:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' height='20' width='20' stroke='rgba(128,128,128,1)' stroke-width='2' class='h-6 w-6' viewBox='0 0 24 24'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' d='M9 5H7a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2h-2M9 5a2 2 0 0 0 2 2h2a2 2 0 0 0 2-2M9 5a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2m-6 9 2 2 4-4'/%3E%3C/svg%3E");--va-icon-collapse:url("data:image/svg+xml,%3Csvg%20xmlns='http://www.w3.org/2000/svg'%20width='32'%20height='32' stroke='rgba(128,128,128,1)' viewBox='0%200%2024%2024'%3E%3Cpath%20fill='currentColor'%20d='m12%2016.175l3.9-3.875q.275-.275.688-.288t.712.288q.275.275.275.7t-.275.7l-4.6%204.6q-.15.15-.325.213t-.375.062q-.2%200-.375-.063T11.3%2018.3l-4.6-4.6q-.275-.275-.288-.687T6.7%2012.3q.275-.275.7-.275t.7.275l3.9%203.875Zm0-6L15.9%206.3q.275-.275.688-.287t.712.287q.275.275.275.7t-.275.7l-4.6%204.6q-.15.15-.325.213t-.375.062q-.2%200-.375-.062T11.3%2012.3L6.7%207.7q-.275-.275-.288-.688T6.7%206.3q.275-.275.7-.275t.7.275l3.9%203.875Z'/%3E%3C/svg%3E")}:root{--va-header-anchor-symbol:"#"}html{-webkit-tap-highlight-color:transparent;font-family:var(--va-font-sans)}a{color:var(--va-c-link);font-weight:500}*{outline:0}hr{margin:1rem}button{background-color:transparent}#app,body,html{margin:0;padding:0;line-height:2}html{background-color:var(--va-c-bg)}a{cursor:pointer}:root{--yun-margin-top:68px;--yun-home-hero-image-filter:blur(48px);--yun-home-hero-name-background:-webkit-linear-gradient(120deg, var(--va-c-text) 30%, black);--yun-home-hero-image-background-image:linear-gradient(-45deg, #bd34fe 50%, #47caff 50%);--yun-nav-height:50px}:root{--yun-post-card-max-width:900px;--yun-c-cloud:white;--yun-z-select:6;--yun-z-cloud:7;--yun-z-go-down:9;--yun-z-backdrop:9;--yun-z-sidebar:10;--yun-z-fireworks:11;--yun-z-toc-btn:11;--yun-z-go-up-btn:20;--yun-z-fullscreen-menu:21;--yun-z-nav-menu:22;--yun-z-menu-btn:22;--yun-z-search-popup:30;--yun-z-search-btn:31;--yun-z-overlay:32;--yun-z-aside:33;--yun-z-left-sidebar:34;--yun-z-left-sidebar-menu:35;--yun-z-page-gradient:35;--yun-z-dock:999999;--va-z-overlay:var(--yun-z-backdrop)}:root{--yun-bg-img:url(/assets/bg-img.kXdNMxcF.jpg);--yun-sidebar-bg-color:var(--va-c-bg-light);--yun-sidebar-bg-img:url(/assets/sidebar-bg-img.mp54gEws.webp)}@media screen and (max-width:768px){:root{--rect-margin:16px}}@media screen and not (max-width:768px){:root{--rect-margin:48px}}.post-category{color:var(--va-c-text)}.post-tag{white-space:nowrap;color:var(--yun-tag-color)}.post-tag:hover{color:var(--va-c-primary)}html{overflow-y:scroll}:root{--smc-font-sans:Raleway,-apple-system,"PingFang SC","Microsoft YaHei",Arial,sans-serif;--smc-font-serif:"Songti SC","Noto Serif SC",STZhongsong,STKaiti,KaiTi,Roboto,serif;--smc-font-mono:Menlo,Monaco,Consolas,"Courier New",monospace}:root{--smc-c-primary-light:rgb(224.6703296703, 175, 255);--smc-c-primary-lighter:rgb(253.6730769231, 251.5, 255);--smc-c-primary:#BA49FF;--smc-theme-name:yun;--smc-line-height:1.8;--smc-c-primary-rgb:186,73,255;--smc-c-text:#24292e;--smc-c-text-light:#555;--smc-c-text-lighter:#666;--smc-header-bottom-color:#eaecef;--smc-border-color:var(--smc-c-primary-light);--smc-code-bg-color:#f6f8fa;--smc-link-color:rgb(166.6648351648, 22, 255)}.markdown-body{-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%;background:var(--smc-bg-color);color:var(--smc-c-text);font-family:var(--smc-font-sans);font-size:1rem;line-height:var(--smc-line-height);overflow-wrap:break-word}.markdown-body *{box-sizing:border-box}.markdown-body a{background-color:transparent}.markdown-body a:active,.markdown-body a:hover{outline-width:0}.markdown-body hr{background-color:var(--smc-c-primary,#333);height:2px;margin:1.5rem 0}.markdown-body blockquote{margin:1rem 0;padding:0 1rem;border-left:.25em solid var(--smc-border-color)}.markdown-body code,.markdown-body pre{font-family:Source Code Pro,Consolas,Monaco,SFMono-Regular,Ubuntu Mono,Menlo,monospace}.markdown-body code{padding:3px 6px;font-size:.85rem;color:var(--smc-c-text-light);background:var(--smc-code-bg-color);border-radius:3px}.markdown-body pre{margin-top:0;margin-bottom:0;overflow-wrap:normal;padding:1rem;overflow:auto;background-color:var(--smc-code-bg-color);border-radius:3px}.markdown-body pre>code{font-size:.85rem;white-space:pre}.markdown-body pre code{display:block;padding:0;margin:0;overflow:visible;line-height:inherit;word-break:normal;background-color:transparent;border:0}.markdown-body img{display:block;margin:1rem auto;max-width:92%;max-height:600px;border-radius:.2rem;transition:.4s;--tw-shadow:0 1px 3px 0 rgb(0 0 0/.1),0 1px 2px -1px rgb(0 0 0/.1);--tw-shadow-colored:0 1px 3px 0 var(--tw-shadow-color),0 1px 2px -1px var(--tw-shadow-color);-webkit-box-shadow:var(--tw-ring-offset-shadow,0 0 transparent),var(--tw-ring-shadow,0 0 transparent),var(--tw-shadow);box-shadow:var(--tw-ring-offset-shadow,0 0 transparent),var(--tw-ring-shadow,0 0 transparent),var(--tw-shadow)}.markdown-body img:hover{--tw-shadow:0 4px 6px -1px rgb(0 0 0/.1),0 2px 4px -2px rgb(0 0 0/.1);--tw-shadow-colored:0 4px 6px -1px var(--tw-shadow-color),0 2px 4px -2px var(--tw-shadow-color)}.markdown-body img:before{content:"「 LOADING ERROR 」"}@media screen and (min-width:1600px){.markdown-body img{max-width:800px}}.markdown-body a{color:var(--smc-c-primary);text-decoration:none;border-bottom:1px solid transparent;transition:all .2s ease-in-out}.markdown-body a:hover{color:var(--smc-link-color);border-bottom:1px solid var(--smc-link-color)}.markdown-body a:not([href]){color:inherit;text-decoration:none}.markdown-body ol,.markdown-body ul{padding-left:2em}.markdown-body ol ul,.markdown-body ul ul{margin-top:0;margin-bottom:0}.markdown-body li{overflow-wrap:break-all;margin-top:.25em}.markdown-body li>p{margin-top:16px}.markdown-body table{width:100%;overflow:auto;border-spacing:0;border-collapse:collapse}.markdown-body table td,.markdown-body table th{padding:6px 13px;border:1px solid var(--smc-c-primary-light,#999)}.markdown-body table thead th{font-weight:600}.markdown-body table>tbody>tr:hover{background-color:rgba(var(--smc-c-primary-rgb),.1)}.markdown-body strong{font-family:var(--smc-font-serif);font-weight:900}.markdown-body p{margin-top:1rem;margin-bottom:1rem;overflow-x:auto;overflow-y:hidden}.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5{margin-top:1.5rem;margin-bottom:1rem;font-weight:300;line-height:1.5}.markdown-body h2{font-size:2.2rem;border-bottom:1px solid var(--smc-header-bottom-color)}.markdown-body h3{font-size:1.9rem}.markdown-body h4{font-size:1.6rem}.markdown-body h5{font-size:1.3rem}@media screen and (max-width:768px){.markdown-body h2{font-size:1.8rem}.markdown-body h3{font-size:1.6rem}.markdown-body h4{font-size:1.4rem}.markdown-body h5{font-size:1.2rem}}.yun-icon-btn{background-color:transparent;cursor:pointer;display:inline-flex;align-items:center;justify-content:center;border:none;width:3rem;height:3rem;border-radius:50%;transition:background-color var(--va-transition-duration)}.yun-icon-btn div{font-size:1.2rem}.yun-icon-btn:hover{background-color:rgba(var(--va-c-primary-rgb),.08)}.yun-icon-btn:active{background-color:rgba(var(--va-c-primary-rgb),.16)}.markdown-body{--smc-font-sans:var(--va-font-sans);--smc-font-serif:var(--va-font-serif);--smc-font-mono:var(--va-font-mono);--c-toc-link:var(--va-c-text-light)}.markdown-body{word-wrap:break-word}.markdown-body a{color:var(--va-c-link)}.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5{font-family:var(--va-font-serif);font-weight:900}.markdown-body ul{list-style:initial}.markdown-body ul li>p{margin-bottom:0}.markdown-body ol>li{list-style:decimal}.markdown-body img{margin:.5rem auto;height:auto;max-width:min(92%,800px)}.markdown-body p{overflow:unset}.markdown-body hr{opacity:.6;height:2px;border-top-width:0;background-color:var(--va-c-text)}@media(max-width:767.9px){.markdown-body{padding:.5rem}}@media screen and (max-width:640px){.markdown-body div[class*=language-]{position:relative;margin:16px -24px 0;height:auto}}html:not(.dark) .vp-code span{color:var(--shiki-light,inherit)}:root{--va-custom-block-font-size:14px;--va-custom-block-code-font-size:13px;--va-custom-block-info-border:transparent;--va-custom-block-info-text:var(--va-c-text-1);--va-custom-block-info-bg:var(--va-c-default-soft);--va-custom-block-info-code-bg:var(--va-c-default-soft);--va-custom-block-tip-border:transparent;--va-custom-block-tip-text:var(--va-c-text-1);--va-custom-block-tip-bg:var(--va-c-brand-soft);--va-custom-block-tip-code-bg:var(--va-c-brand-soft);--va-custom-block-warning-border:transparent;--va-custom-block-warning-text:var(--va-c-text-1);--va-custom-block-warning-bg:var(--va-c-warning-soft);--va-custom-block-warning-code-bg:var(--va-c-warning-soft);--va-custom-block-danger-border:transparent;--va-custom-block-danger-text:var(--va-c-text-1);--va-custom-block-danger-bg:var(--va-c-danger-soft);--va-custom-block-danger-code-bg:var(--va-c-danger-soft);--va-custom-block-details-border:var(--va-custom-block-info-border);--va-custom-block-details-text:var(--va-custom-block-info-text);--va-custom-block-details-bg:var(--va-custom-block-info-bg);--va-custom-block-details-code-bg:var(--va-custom-block-info-code-bg)}:root{--vp-code-block-bg:var(--va-c-bg-alt);--vp-code-tab-divider:var(--va-c-gutter)}@media screen and (max-width:640px){.markdown-body div[class*=language-]{margin:0 var(--va-code-mobile-margin-x,-1rem)}}@media(min-width:640px){.markdown-body div[class*=language-]{border-radius:6px;margin:16px 0}}.markdown-body code{font-size:.85em}.markdown-body div[class*=language-]{overflow:auto hidden;position:relative;background-color:var(--va-code-block-bg)}.markdown-body [class*=language-] code,.markdown-body [class*=language-] pre{direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;tab-size:4;-webkit-hyphens:none;hyphens:none}.markdown-body [class*=language-] pre{position:relative;z-index:1;margin:0;padding:20px 0;background:0 0;overflow-x:auto}.markdown-body [class*=language-] code{display:block;padding:0 24px;width:fit-content;min-width:100%;line-height:var(--va-code-line-height);font-size:var(--va-code-font-size);color:var(--va-code-block-color);transition:color .5s}.markdown-body [class*=language-]>button.copy{direction:ltr;position:absolute;top:12px;right:12px;z-index:3;border:1px solid var(--va-code-copy-code-border-color);border-radius:4px;width:40px;height:40px;background-color:var(--va-code-copy-code-bg);opacity:0;cursor:pointer;background-image:var(--va-icon-copy);background-position:50%;background-size:20px;background-repeat:no-repeat;transition:border-color .25s,background-color .25s,opacity .25s}.markdown-body [class*=language-]:hover>button.copy,.markdown-body [class*=language-]>button.copy:focus{opacity:1}.markdown-body [class*=language-]>button.copy:hover{border-color:var(--va-code-copy-code-hover-border-color);background-color:var(--va-code-copy-code-hover-bg)}.markdown-body [class*=language-]>span.lang{position:absolute;top:2px;right:8px;z-index:2;font-size:12px;font-weight:500;color:var(--va-code-lang-color);transition:color .4s,opacity .4s}.markdown-body [class*=language-]:hover>button.copy+span.lang,.markdown-body [class*=language-]>button.copy:focus+span.lang{opacity:0}.markdown-body [class*=language-]>button.code-block-unfold-btn{display:none;position:absolute;z-index:10;bottom:0;left:0;width:100%;height:24px;opacity:1;cursor:pointer;background-image:linear-gradient(-180deg,rgba(0,0,0,0) 0,var(--va-c-bg-dark) 100%)}.markdown-body [class*=language-]>button.code-block-unfold-btn:before{display:block;content:"";width:100%;height:100%;background-image:var(--va-icon-collapse);background-position:50%;background-size:16px;background-repeat:no-repeat}.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5{position:relative;font-weight:600;outline:0}.markdown-body figure{text-align:center}.markdown-body .end .line{height:1px}.markdown-body .header-anchor{position:absolute;top:0;left:0;margin-left:-.87em;font-weight:500;-webkit-user-select:none;user-select:none;opacity:0;text-decoration:none;transition:color .25s,opacity .25s}.markdown-body .header-anchor:before{content:var(--va-header-anchor-symbol, "#")}.markdown-body .header-anchor:before:hover{text-decoration:none}.markdown-body h2 .header-anchor:focus,.markdown-body h2:hover .header-anchor,.markdown-body h3 .header-anchor:focus,.markdown-body h3:hover .header-anchor,.markdown-body h4 .header-anchor:focus,.markdown-body h4:hover .header-anchor,.markdown-body h5 .header-anchor:focus,.markdown-body h5:hover .header-anchor{opacity:1}html{transition:background-color .6s}:root{--va-font-serif:""Noto Serif SC", STZhongsong, STKaiti, KaiTi, Roboto,  serif";--va-c-bg-light:rgba(255, 255, 255, .8)}@supports ((-webkit-hyphens:none) and (not (margin-trim:inline))) or ((-moz-orient:inline) and (not (color:rgb(from red r g b)))){*,:after,:before{--un-scale-x:1;--un-scale-y:1;--un-scale-z:1;--un-ease:initial;--un-bg-opacity:100%;--un-leading:initial;--un-translate-x:initial;--un-translate-y:initial;--un-translate-z:initial;--un-rotate-x:rotateX(0);--un-rotate-y:rotateY(0);--un-rotate-z:rotateZ(0);--un-skew-x:skewX(0);--un-skew-y:skewY(0);--un-text-opacity:100%;--un-border-opacity:100%;--un-from-opacity:100%;--un-to-opacity:100%;--un-border-bottom-opacity:100%}}@property --un-text-opacity{syntax:"<percentage>";inherits:falseinitial-value:100%}@property --un-leading{syntax:"*"inherits:false}@property --un-outline-style{syntax:"*";inherits:falseinitial-value:solid}@property --un-border-opacity{syntax:"<percentage>";inherits:falseinitial-value:100%}@property --un-border-bottom-opacity{syntax:"<percentage>";inherits:falseinitial-value:100%}@property --un-bg-opacity{syntax:"<percentage>";inherits:falseinitial-value:100%}@property --un-inset-ring-color{syntax:"*"inherits:false}@property --un-inset-ring-shadow{syntax:"*";inherits:falseinitial-value:0 0 #0000}@property --un-inset-shadow{syntax:"*";inherits:falseinitial-value:0 0 #0000}@property --un-inset-shadow-color{syntax:"*"inherits:false}@property --un-ring-color{syntax:"*"inherits:false}@property --un-ring-inset{syntax:"*"inherits:false}@property --un-ring-offset-color{syntax:"*"inherits:false}@property --un-ring-offset-shadow{syntax:"*";inherits:falseinitial-value:0 0 #0000}@property --un-ring-offset-width{syntax:"<length>";inherits:falseinitial-value:0px}@property --un-ring-shadow{syntax:"*";inherits:falseinitial-value:0 0 #0000}@property --un-shadow{syntax:"*";inherits:falseinitial-value:0 0 #0000}@property --un-shadow-color{syntax:"*"inherits:false}@property --un-translate-x{syntax:"*";inherits:falseinitial-value:0}@property --un-translate-y{syntax:"*";inherits:falseinitial-value:0}@property --un-translate-z{syntax:"*";inherits:falseinitial-value:0}@property --un-rotate-x{syntax:"*";inherits:falseinitial-value:rotateX(0)}@property --un-rotate-y{syntax:"*";inherits:falseinitial-value:rotateY(0)}@property --un-rotate-z{syntax:"*";inherits:falseinitial-value:rotateZ(0)}@property --un-skew-x{syntax:"*";inherits:falseinitial-value:skewX(0)}@property --un-skew-y{syntax:"*";inherits:falseinitial-value:skewY(0)}@property --un-scale-x{syntax:"*";inherits:falseinitial-value:1}@property --un-scale-y{syntax:"*";inherits:falseinitial-value:1}@property --un-scale-z{syntax:"*";inherits:falseinitial-value:1}@property --un-ease{syntax:"*"inherits:false}@property --un-from-opacity{syntax:"<percentage>";inherits:falseinitial-value:100%}@property --un-gradient-from{syntax:"<color>";inherits:falseinitial-value:#0000}@property --un-gradient-from-position{syntax:"<length-percentage>";inherits:falseinitial-value:0%}@property --un-gradient-position{syntax:"*"inherits:false}@property --un-gradient-stops{syntax:"*"inherits:false}@property --un-gradient-to{syntax:"<color>";inherits:falseinitial-value:#0000}@property --un-gradient-to-position{syntax:"<length-percentage>";inherits:falseinitial-value:100%}@property --un-gradient-via{syntax:"<color>";inherits:falseinitial-value:#0000}@property --un-gradient-via-position{syntax:"<length-percentage>";inherits:falseinitial-value:50%}@property --un-gradient-via-stops{syntax:"*"inherits:false}@property --un-to-opacity{syntax:"<percentage>";inherits:falseinitial-value:100%}@property --un-blur{syntax:"*"inherits:false}@property --un-brightness{syntax:"*"inherits:false}@property --un-contrast{syntax:"*"inherits:false}@property --un-drop-shadow{syntax:"*"inherits:false}@property --un-grayscale{syntax:"*"inherits:false}@property --un-hue-rotate{syntax:"*"inherits:false}@property --un-invert{syntax:"*"inherits:false}@property --un-saturate{syntax:"*"inherits:false}@property --un-sepia{syntax:"*"inherits:false}:root{--spacing:.25rem;--default-transition-timingFunction:cubic-bezier(.4, 0, .2, 1);--default-transition-duration:.15s;--container-4xl:56rem;--radius-DEFAULT:.25rem;--ease-in-out:cubic-bezier(.4, 0, .2, 1);--container-2xl:42rem;--colors-white:#fff;--ease-in:cubic-bezier(.4, 0, 1, 1);--container-3xl:48rem;--leading-none:1;--container-sm:24rem;--fontWeight-bold:700;--radius-lg:.5rem;--colors-black:#000;--fontWeight-medium:500;--leading-loose:2;--fontWeight-black:900;--container-md:28rem;--ease-DEFAULT:cubic-bezier(.4, 0, .2, 1);--fontWeight-light:300;--colors-gray-DEFAULT:oklch(70.7% .022 261.325);--colors-gray-100:oklch(96.7% .003 264.542);--colors-red-DEFAULT:oklch(70.4% .191 22.216);--colors-dark-DEFAULT:oklch(25.2% 0 0);--colors-blue-500:oklch(62.3% .214 259.815);--text-sm-fontSize:.875rem;--text-sm-lineHeight:1.25rem;--text-2xl-fontSize:1.5rem;--text-2xl-lineHeight:2rem;--text-xl-fontSize:1.25rem;--text-xl-lineHeight:1.75rem;--text-lg-fontSize:1.125rem;--text-lg-lineHeight:1.75rem;--text-xs-fontSize:.75rem;--text-xs-lineHeight:1rem;--text-base-fontSize:1rem;--text-base-lineHeight:1.5rem;--radius-none:0;--colors-dark-300:oklch(29.72% 0 0);--colors-red-400:oklch(70.4% .191 22.216);--text-4xl-fontSize:2.25rem;--text-4xl-lineHeight:2.5rem;--colors-gray-600:oklch(44.6% .03 256.802);--font-sans:ui-sans-serif,system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";--font-mono:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;--default-font-family:var(--font-sans);--default-monoFont-family:var(--font-mono)}*,:after,:before{box-sizing:border-box;margin:0;padding:0;border:0 solid}html{line-height:1.5;-webkit-text-size-adjust:100%;tab-size:4;font-family:var( --default-font-family, ui-sans-serif, system-ui, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji" );font-feature-settings:var(--default-font-featureSettings,normal);font-variation-settings:var(--default-font-variationSettings,normal);-webkit-tap-highlight-color:transparent}hr{height:0;color:inherit;border-top-width:1px}h1,h2,h3,h4,h5{font-size:inherit;font-weight:inherit}a{color:inherit;-webkit-text-decoration:inherit;text-decoration:inherit}strong{font-weight:bolder}code,pre{font-family:var( --default-monoFont-family, ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace );font-feature-settings:var(--default-monoFont-featureSettings,normal);font-variation-settings:var(--default-monoFont-variationSettings,normal);font-size:1em}table{text-indent:0;border-color:inherit;border-collapse:collapse}ol,ul{list-style:none}canvas,img,svg{display:block;vertical-align:middle}img{max-width:100%;height:auto}button{font:inherit;font-feature-settings:inherit;font-variation-settings:inherit;letter-spacing:inherit;color:inherit;border-radius:0;background-color:transparent;opacity:1}button{appearance:button}.i-ri-alipay-line{--un-icon:url("data:image/svg+xml;utf8,%3Csvg viewBox='0 0 24 24' width='1.2em' height='1.2em' xmlns='http://www.w3.org/2000/svg' %3E%3Cpath fill='currentColor' d='M18.408 16.79q-3.26-1.425-4.64-2.086c-1.4 1.696-2.872 2.72-5.08 2.72S5 16.064 5.176 14.392c.12-1.096.872-2.888 4.128-2.576c1.72.16 2.504.48 3.912.944c.36-.664.664-1.4.888-2.176H7.88v-.616h3.072V8.864H7.2v-.68h3.752V6.592s.032-.248.312-.248H12.8v1.848h4v.68h-4v1.104h3.264a12.4 12.4 0 0 1-1.32 3.32q.765.273 4.76 1.483a8 8 0 1 0-1.096 2.012M12 22C6.477 22 2 17.523 2 12S6.477 2 12 2s10 4.477 10 10s-4.477 10-10 10m-3.568-5.632c1.44 0 2.824-.872 3.96-2.352c-1.608-.776-2.944-1.16-4.44-1.16c-1.304 0-1.984.8-2.104 1.416s.248 2.096 2.584 2.096'/%3E%3C/svg%3E");-webkit-mask:var(--un-icon) no-repeat;mask:var(--un-icon) no-repeat;-webkit-mask-size:100% 100%;mask-size:100% 100%;background-color:currentColor;color:inherit;width:1.2em;height:1.2em}[i-ri-arrow-right-s-line=""]{--un-icon:url("data:image/svg+xml;utf8,%3Csvg viewBox='0 0 24 24' width='1.2em' height='1.2em' xmlns='http://www.w3.org/2000/svg' %3E%3Cpath fill='currentColor' d='m13.172 12l-4.95-4.95l1.414-1.413L16 12l-6.364 6.364l-1.414-1.415z'/%3E%3C/svg%3E");-webkit-mask:var(--un-icon) no-repeat;mask:var(--un-icon) no-repeat;-webkit-mask-size:100% 100%;mask-size:100% 100%;background-color:currentColor;color:inherit;width:1.2em;height:1.2em}[i-ri-arrow-up-s-line=""]{--un-icon:url("data:image/svg+xml;utf8,%3Csvg viewBox='0 0 24 24' width='1.2em' height='1.2em' xmlns='http://www.w3.org/2000/svg' %3E%3Cpath fill='currentColor' d='m12 10.828l-4.95 4.95l-1.414-1.414L12 8l6.364 6.364l-1.414 1.414z'/%3E%3C/svg%3E");-webkit-mask:var(--un-icon) no-repeat;mask:var(--un-icon) no-repeat;-webkit-mask-size:100% 100%;mask-size:100% 100%;background-color:currentColor;color:inherit;width:1.2em;height:1.2em}.i-ri-bluesky-fill{--un-icon:url("data:image/svg+xml;utf8,%3Csvg viewBox='0 0 24 24' width='1.2em' height='1.2em' xmlns='http://www.w3.org/2000/svg' %3E%3Cpath fill='currentColor' d='M12 11.388c-.906-1.761-3.372-5.044-5.665-6.662c-2.197-1.55-3.034-1.283-3.583-1.033C2.116 3.978 2 4.955 2 5.528c0 .575.315 4.709.52 5.4c.68 2.28 3.094 3.05 5.32 2.803c-3.26.483-6.157 1.67-2.36 5.898c4.178 4.325 5.726-.927 6.52-3.59c.794 2.663 1.708 7.726 6.444 3.59c3.556-3.59.977-5.415-2.283-5.898c2.225.247 4.64-.523 5.319-2.803c.205-.69.52-4.825.52-5.399c0-.575-.116-1.55-.752-1.838c-.549-.248-1.386-.517-3.583 1.033c-2.293 1.621-4.76 4.904-5.665 6.664'/%3E%3C/svg%3E");-webkit-mask:var(--un-icon) no-repeat;mask:var(--un-icon) no-repeat;-webkit-mask-size:100% 100%;mask-size:100% 100%;background-color:currentColor;color:inherit;width:1.2em;height:1.2em}[i-ri-calendar-line=""]{--un-icon:url("data:image/svg+xml;utf8,%3Csvg viewBox='0 0 24 24' width='1.2em' height='1.2em' xmlns='http://www.w3.org/2000/svg' %3E%3Cpath fill='currentColor' d='M9 1v2h6V1h2v2h4a1 1 0 0 1 1 1v16a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V4a1 1 0 0 1 1-1h4V1zm11 10H4v8h16zM7 5H4v4h16V5h-3v2h-2V5H9v2H7z'/%3E%3C/svg%3E");-webkit-mask:var(--un-icon) no-repeat;mask:var(--un-icon) no-repeat;-webkit-mask-size:100% 100%;mask-size:100% 100%;background-color:currentColor;color:inherit;width:1.2em;height:1.2em}[i-ri-chat-4-line=""]{--un-icon:url("data:image/svg+xml;utf8,%3Csvg viewBox='0 0 24 24' width='1.2em' height='1.2em' xmlns='http://www.w3.org/2000/svg' %3E%3Cpath fill='currentColor' d='M5.763 17H20V5H4v13.385zm.692 2L2 22.5V4a1 1 0 0 1 1-1h18a1 1 0 0 1 1 1v14a1 1 0 0 1-1 1z'/%3E%3C/svg%3E");-webkit-mask:var(--un-icon) no-repeat;mask:var(--un-icon) no-repeat;-webkit-mask-size:100% 100%;mask-size:100% 100%;background-color:currentColor;color:inherit;width:1.2em;height:1.2em}[i-ri-file-list-line=""]{--un-icon:url("data:image/svg+xml;utf8,%3Csvg viewBox='0 0 24 24' width='1.2em' height='1.2em' xmlns='http://www.w3.org/2000/svg' %3E%3Cpath fill='currentColor' d='M20 22H4a1 1 0 0 1-1-1V3a1 1 0 0 1 1-1h16a1 1 0 0 1 1 1v18a1 1 0 0 1-1 1m-1-2V4H5v16zM8 7h8v2H8zm0 4h8v2H8zm0 4h8v2H8z'/%3E%3C/svg%3E");-webkit-mask:var(--un-icon) no-repeat;mask:var(--un-icon) no-repeat;-webkit-mask-size:100% 100%;mask-size:100% 100%;background-color:currentColor;color:inherit;width:1.2em;height:1.2em}[i-ri-file-word-line=""]{--un-icon:url("data:image/svg+xml;utf8,%3Csvg viewBox='0 0 24 24' width='1.2em' height='1.2em' xmlns='http://www.w3.org/2000/svg' %3E%3Cpath fill='currentColor' d='M16 8v8h-2l-2-2l-2 2H8V8h2v5l2-2l2 2V8h1V4H5v16h14V8zM3 2.992C3 2.444 3.447 2 3.999 2H16l5 5v13.993A1 1 0 0 1 20.007 22H3.993A1 1 0 0 1 3 21.008z'/%3E%3C/svg%3E");-webkit-mask:var(--un-icon) no-repeat;mask:var(--un-icon) no-repeat;-webkit-mask-size:100% 100%;mask-size:100% 100%;background-color:currentColor;color:inherit;width:1.2em;height:1.2em}[i-ri-folder-2-line=""]{--un-icon:url("data:image/svg+xml;utf8,%3Csvg viewBox='0 0 24 24' width='1.2em' height='1.2em' xmlns='http://www.w3.org/2000/svg' %3E%3Cpath fill='currentColor' d='M12.414 5H21a1 1 0 0 1 1 1v14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V4a1 1 0 0 1 1-1h7.414zM20 11H4v8h16zm0-2V7h-8.414l-2-2H4v4z'/%3E%3C/svg%3E");-webkit-mask:var(--un-icon) no-repeat;mask:var(--un-icon) no-repeat;-webkit-mask-size:100% 100%;mask-size:100% 100%;background-color:currentColor;color:inherit;width:1.2em;height:1.2em}[i-ri-heart-fill=""]{--un-icon:url("data:image/svg+xml;utf8,%3Csvg viewBox='0 0 24 24' width='1.2em' height='1.2em' xmlns='http://www.w3.org/2000/svg' %3E%3Cpath fill='currentColor' d='M12.001 4.529a6 6 0 0 1 8.242.228a6 6 0 0 1 .236 8.236l-8.48 8.492l-8.478-8.492a6 6 0 0 1 8.48-8.464'/%3E%3C/svg%3E");-webkit-mask:var(--un-icon) no-repeat;mask:var(--un-icon) no-repeat;-webkit-mask-size:100% 100%;mask-size:100% 100%;background-color:currentColor;color:inherit;width:1.2em;height:1.2em}[i-ri-pushpin-line=""]{--un-icon:url("data:image/svg+xml;utf8,%3Csvg viewBox='0 0 24 24' width='1.2em' height='1.2em' xmlns='http://www.w3.org/2000/svg' %3E%3Cpath fill='currentColor' d='m13.827 1.69l8.486 8.485l-1.415 1.414l-.707-.707l-4.242 4.243l-.707 3.536l-1.415 1.414l-4.242-4.243l-4.95 4.95l-1.414-1.414l4.95-4.95l-4.243-4.243l1.414-1.414l3.536-.707l4.242-4.243l-.707-.707zm.707 3.536l-4.67 4.67l-2.822.565l6.5 6.5l.564-2.822l4.671-4.67z'/%3E%3C/svg%3E");-webkit-mask:var(--un-icon) no-repeat;mask:var(--un-icon) no-repeat;-webkit-mask-size:100% 100%;mask-size:100% 100%;background-color:currentColor;color:inherit;width:1.2em;height:1.2em}.i-ri-qq-line{--un-icon:url("data:image/svg+xml;utf8,%3Csvg viewBox='0 0 24 24' width='1.2em' height='1.2em' xmlns='http://www.w3.org/2000/svg' %3E%3Cpath fill='currentColor' d='m17.536 12.514l-.696-1.796c0-.021.01-.375.01-.558C16.85 7.088 15.447 4 12 4s-4.848 3.088-4.848 6.16c0 .183.009.537.01.557l-.696 1.797c-.19.515-.38 1.05-.517 1.51c-.657 2.189-.444 3.095-.282 3.115c.348.043 1.354-1.648 1.354-1.648c0 .98.487 2.258 1.542 3.18c-.394.127-.878.32-1.188.557c-.28.214-.245.431-.194.52c.22.385 3.79.245 4.82.125c1.03.12 4.599.26 4.82-.126c.05-.088.085-.305-.194-.519c-.311-.237-.795-.43-1.19-.556c1.055-.923 1.542-2.202 1.542-3.181c0 0 1.007 1.691 1.355 1.648c.162-.02.378-.928-.283-3.116a27 27 0 0 0-.516-1.509m1.021 8.227c-.373.652-.833.892-1.438 1.057a5 5 0 0 1-.794.138c-.44.045-.986.065-1.613.064a33 33 0 0 1-2.71-.116c-.692.065-1.785.114-2.71.116a16 16 0 0 1-1.614-.064a5 5 0 0 1-.793-.138c-.605-.164-1.065-.405-1.44-1.059a2.27 2.27 0 0 1-.239-1.652c-.592-.132-1.001-.482-1.279-.911a2.4 2.4 0 0 1-.309-.71a4 4 0 0 1-.116-1.106c.013-.785.187-1.762.532-2.912c.14-.466.327-1.008.567-1.655l.554-1.43l-.002-.203C5.153 5.605 7.589 2 12 2c4.413 0 6.848 3.605 6.848 8.16l-.001.203l.553 1.43l.01.026c.225.606.413 1.153.556 1.626c.348 1.15.522 2.128.535 2.916q.012.61-.118 1.108c-.066.246-.161.48-.31.708c-.276.427-.684.776-1.277.91c.13.554.055 1.14-.24 1.654'/%3E%3C/svg%3E");-webkit-mask:var(--un-icon) no-repeat;mask:var(--un-icon) no-repeat;-webkit-mask-size:100% 100%;mask-size:100% 100%;background-color:currentColor;color:inherit;width:1.2em;height:1.2em}[i-ri-timer-line=""]{--un-icon:url("data:image/svg+xml;utf8,%3Csvg viewBox='0 0 24 24' width='1.2em' height='1.2em' xmlns='http://www.w3.org/2000/svg' %3E%3Cpath fill='currentColor' d='m17.618 5.968l1.453-1.453l1.414 1.414l-1.453 1.453A9 9 0 1 1 12 4c2.125 0 4.078.736 5.618 1.968M12 20a7 7 0 1 0 0-14a7 7 0 0 0 0 14M11 8h2v6h-2zM8 1h8v2H8z'/%3E%3C/svg%3E");-webkit-mask:var(--un-icon) no-repeat;mask:var(--un-icon) no-repeat;-webkit-mask-size:100% 100%;mask-size:100% 100%;background-color:currentColor;color:inherit;width:1.2em;height:1.2em}.i-ri-wechat-pay-line{--un-icon:url("data:image/svg+xml;utf8,%3Csvg viewBox='0 0 24 24' width='1.2em' height='1.2em' xmlns='http://www.w3.org/2000/svg' %3E%3Cpath fill='currentColor' d='m19.146 8.993l-9.799 5.608l-.07.045a.65.65 0 0 1-.3.07a.66.66 0 0 1-.58-.345l-.046-.092l-1.831-3.95c-.023-.046-.023-.092-.023-.138c0-.184.139-.321.324-.321q.105 0 .209.069l2.155 1.515c.162.092.347.161.556.161a.9.9 0 0 0 .348-.069l8.274-3.649C16.935 6.273 14.635 5.2 12.001 5.2c-4.421 0-7.9 3.022-7.9 6.6c0 1.365.5 2.673 1.431 3.78q.073.088.215.236a4 4 0 0 1 1.1 3.102l-.024.297l.715-.436a4 4 0 0 1 2.706-.536q.317.05.52.076q.61.081 1.237.081c4.42 0 7.9-3.022 7.9-6.6c0-.996-.27-1.95-.755-2.807M6.193 21.943a1 1 0 0 1-1.527-.932l.189-2.259a2 2 0 0 0-.55-1.551a7 7 0 0 1-.303-.333C2.806 15.447 2.1 13.695 2.1 11.8c0-4.75 4.432-8.6 9.9-8.6c5.467 0 9.9 3.85 9.9 8.6s-4.433 8.6-9.9 8.6q-.765-.001-1.5-.098q-.229-.03-.568-.084a2 2 0 0 0-1.353.268z'/%3E%3C/svg%3E");-webkit-mask:var(--un-icon) no-repeat;mask:var(--un-icon) no-repeat;-webkit-mask-size:100% 100%;mask-size:100% 100%;background-color:currentColor;color:inherit;width:1.2em;height:1.2em}.va-card{background-color:color-mix(in oklab,var(--va-c-bg-light) var(--un-bg-opacity),transparent);--un-shadow:0 1px 3px 0 var(--un-shadow-color, rgb(0 0 0 / .1)),0 1px 2px -1px var(--un-shadow-color, rgb(0 0 0 / .1));box-shadow:var(--un-inset-shadow),var(--un-inset-ring-shadow),var(--un-ring-offset-shadow),var(--un-ring-shadow),var(--un-shadow)}.flex-center,[flex~=center]{display:flex;align-items:center;justify-content:center}.inline-flex-center{display:inline-flex;align-items:center;justify-content:center}.yun-card{--un-shadow:0 1px 3px 0 var(--un-shadow-color, rgb(0 0 0 / .1)),0 1px 2px -1px var(--un-shadow-color, rgb(0 0 0 / .1));box-shadow:var(--un-inset-shadow),var(--un-inset-ring-shadow),var(--un-ring-offset-shadow),var(--un-ring-shadow),var(--un-shadow);transition-property:all;transition-timing-function:var(--un-ease,var(--default-transition-timingFunction));transition-duration:var(--un-duration, var(--default-transition-duration));transition-duration:var(--va-transition-duration)}.va-card:hover{--un-shadow:0 10px 15px -3px var(--un-shadow-color, rgb(0 0 0 / .1)),0 4px 6px -4px var(--un-shadow-color, rgb(0 0 0 / .1));box-shadow:var(--un-inset-shadow),var(--un-inset-ring-shadow),var(--un-ring-offset-shadow),var(--un-ring-shadow),var(--un-shadow)}.yun-card:hover{--un-shadow:0 25px 50px -12px var(--un-shadow-color, rgb(0 0 0 / .25));box-shadow:var(--un-inset-shadow),var(--un-inset-ring-shadow),var(--un-ring-offset-shadow),var(--un-ring-shadow),var(--un-shadow)}[text~="2xl"]{font-size:var(--text-2xl-fontSize);line-height:var(--un-leading, var(--text-2xl-lineHeight))}[text~=sm]{font-size:var(--text-sm-fontSize);line-height:var(--un-leading, var(--text-sm-lineHeight))}[text~=xl]{font-size:var(--text-xl-fontSize);line-height:var(--un-leading, var(--text-xl-lineHeight))}.text-xs{font-size:var(--text-xs-fontSize);line-height:var(--un-leading, var(--text-xs-lineHeight))}.text-\$va-c-text-light{color:color-mix(in oklab,var(--va-c-text-light) var(--un-text-opacity),transparent)}[text~=red-400]{color:color-mix(in srgb,var(--colors-red-400) var(--un-text-opacity),transparent)}[hover~=text-white]:hover{color:color-mix(in srgb,var(--colors-white) var(--un-text-opacity),transparent)}[color~="$va-c-warning"]{color:color-mix(in oklab,var(--va-c-warning) var(--un-text-opacity),transparent)}.leading-none{--un-leading:var(--leading-none);line-height:var(--leading-none)}[font~=black]{--un-font-weight:var(--fontWeight-black);font-weight:var(--fontWeight-black)}[font~=bold]{--un-font-weight:var(--fontWeight-bold);font-weight:var(--fontWeight-bold)}[m~="0"]{margin:calc(var(--spacing) * 0)}[m~="2"]{margin:calc(var(--spacing) * 2)}.m-auto{margin:auto}[mx-1=""],[m~=x-1]{margin-inline:calc(var(--spacing) * 1)}[m~=y-4]{margin-block:calc(var(--spacing) * 4)}[m~=y-2]{margin-block:calc(var(--spacing) * 2)}[m~="!y-2"]{margin-block:calc(var(--spacing) * 2)!important}[mx~="2"]{margin-inline:calc(var(--spacing) * 2)}.mb-4,[mb~="4"]{margin-bottom:calc(var(--spacing) * 4)}[m~=b-2]{margin-bottom:calc(var(--spacing) * 2)}.ml-1,[ml-1=""]{margin-left:calc(var(--spacing) * 1)}.mt-4{margin-top:calc(var(--spacing) * 4)}.mt-12{margin-top:calc(var(--spacing) * 12)}.mt-14{margin-top:calc(var(--spacing) * 14)}.mt-2{margin-top:calc(var(--spacing) * 2)}.mt-2px{margin-top:2px}[m~=t-6]{margin-top:calc(var(--spacing) * 6)}.mt-8{margin-top:calc(var(--spacing) * 8)}[p~="1"]{padding:calc(var(--spacing) * 1)}[p~="2"]{padding:calc(var(--spacing) * 2)}[p~="4"]{padding:calc(var(--spacing) * 4)}.px-4,[p~=x-4]{padding-inline:calc(var(--spacing) * 4)}[px-2=""]{padding-inline:calc(var(--spacing) * 2)}.py-4{padding-block:calc(var(--spacing) * 4)}[py~="1"]{padding-block:calc(var(--spacing) * 1)}[pb-2=""]{padding-bottom:calc(var(--spacing) * 2)}.pt-0{padding-top:calc(var(--spacing) * 0)}[p~=b-8]{padding-bottom:calc(var(--spacing) * 8)}[text~=center]{text-align:center}[border=""],[border~="~"]{border-width:1px}.border-\$va-c-divider{border-color:color-mix(in oklab,var(--va-c-divider) var(--un-border-opacity),transparent)}[border~=rounded]{border-radius:var(--radius-DEFAULT)}.rounded-2{border-radius:.5rem}[rounded-full=""]{border-radius:calc(infinity * 1px)}[bg~="$va-c-bg-light"]{background-color:color-mix(in oklab,var(--va-c-bg-light) var(--un-bg-opacity),transparent)}.bg-\$va-c-bg-soft{background-color:color-mix(in oklab,var(--va-c-bg-soft) var(--un-bg-opacity),transparent)}[bg~=white]{background-color:color-mix(in srgb,var(--colors-white) var(--un-bg-opacity),transparent)}[bg~="$va-c-bg"]{background-color:color-mix(in oklab,var(--va-c-bg) var(--un-bg-opacity),transparent)}[hover~=bg-blue-500]:hover{background-color:color-mix(in srgb,var(--colors-blue-500) var(--un-bg-opacity),transparent)}.op-60{opacity:60%}.op-80{opacity:80%}.flex,[flex=""],[flex~="~"]{display:flex}.inline-flex,[inline-flex=""]{display:inline-flex}[flex~="1"]{flex:1 1 0%}.flex-grow,[flex~=grow]{flex-grow:1}.flex-col,[flex~=col]{flex-direction:column}[flex~=wrap]{flex-wrap:wrap}.gap-1,[gap~="1"]{gap:calc(var(--spacing) * 1)}.gap-2{gap:calc(var(--spacing) * 2)}.gap-2\!{gap:calc(var(--spacing) * 2)!important}.gap-4{gap:calc(var(--spacing) * 4)}.size-8{width:calc(var(--spacing) * 8);height:calc(var(--spacing) * 8)}[h~="5"]{height:calc(var(--spacing) * 5)}.max-h-300px{max-height:300px}.min-h-sm{min-height:var(--container-sm)}.w-full,[w~=full]{width:100%}[h~="64"]{height:calc(var(--spacing) * 64)}[h~="7"]{height:calc(var(--spacing) * 7)}[min-h~="100px"]{min-height:100px}.inline-block{display:inline-block}.whitespace-nowrap{white-space:nowrap}.truncate{overflow:hidden;text-overflow:ellipsis;white-space:nowrap}.shadow{--un-shadow:0 1px 3px 0 var(--un-shadow-color, rgb(0 0 0 / .1)),0 1px 2px -1px var(--un-shadow-color, rgb(0 0 0 / .1));box-shadow:var(--un-inset-shadow),var(--un-inset-ring-shadow),var(--un-ring-offset-shadow),var(--un-ring-shadow),var(--un-shadow)}.shadow-md{--un-shadow:0 4px 6px -1px var(--un-shadow-color, rgb(0 0 0 / .1)),0 2px 4px -2px var(--un-shadow-color, rgb(0 0 0 / .1));box-shadow:var(--un-inset-shadow),var(--un-inset-ring-shadow),var(--un-ring-offset-shadow),var(--un-ring-shadow),var(--un-shadow)}.hover\:shadow-md:hover{--un-shadow:0 4px 6px -1px var(--un-shadow-color, rgb(0 0 0 / .1)),0 2px 4px -2px var(--un-shadow-color, rgb(0 0 0 / .1));box-shadow:var(--un-inset-shadow),var(--un-inset-ring-shadow),var(--un-ring-offset-shadow),var(--un-ring-shadow),var(--un-shadow)}.transition{transition-property:color,background-color,border-color,text-decoration-color,fill,stroke,--un-gradient-from,--un-gradient-via,--un-gradient-to,opacity,box-shadow,transform,translate,scale,rotate,filter,-webkit-backdrop-filter,backdrop-filter;transition-timing-function:var(--un-ease,var(--default-transition-timingFunction));transition-duration:var(--un-duration, var(--default-transition-duration))}.items-start{align-items:flex-start}.items-center,[items-center=""],[items~=center]{align-items:center}[start~="2"]{inset-inline-start:calc(var(--spacing) * 2)}[start~="3"]{inset-inline-start:calc(var(--spacing) * 3)}[start~="4"]{inset-inline-start:calc(var(--spacing) * 4)}[start~="5"]{inset-inline-start:calc(var(--spacing) * 5)}[bottom-0=""]{bottom:calc(var(--spacing) * 0)}.left-0,[left-0=""]{left:calc(var(--spacing) * 0)}.right-0,[right-0=""]{right:calc(var(--spacing) * 0)}.top--10{top:calc(var(--spacing) * -10)}.top-0,[top-0=""]{top:calc(var(--spacing) * 0)}[bottom~="19"]{bottom:calc(var(--spacing) * 19)}[right~="4"]{right:calc(var(--spacing) * 4)}[justify~=end]{justify-content:flex-end}.justify-center,[justify~=center]{justify-content:center}.justify-around{justify-content:space-around}.absolute,[absolute=""]{position:absolute}.fixed{position:fixed}.relative{position:relative}.sticky{position:sticky}.z-1{z-index:1}[z-10=""]{z-index:10}.z-20{z-index:20}[overflow~=auto]{overflow:auto}[stroke-width~="2"]{stroke-width:2px}@keyframes fade-in{0%{opacity:0}to{opacity:1}}@keyframes pulse{0%,to{opacity:1}50%{opacity:.5}}.animate-fade-in{animation:fade-in 1s linear 1}.animate-pulse{animation:pulse 2s cubic-bezier(.4,0,.6,1) infinite}.animate-iteration-1{animation-iteration-count:1}[font~=serif]{font-family:var(--va-font-serif)}@supports (color:color-mix(in lab,red,red)){[text~=red-400]{color:color-mix(in oklab,var(--colors-red-400) var(--un-text-opacity),transparent)}[hover~=text-white]:hover{color:color-mix(in oklab,var(--colors-white) var(--un-text-opacity),transparent)}[bg~=white]{background-color:color-mix(in oklab,var(--colors-white) var(--un-bg-opacity),transparent)}[hover~=bg-blue-500]:hover{background-color:color-mix(in oklab,var(--colors-blue-500) var(--un-bg-opacity),transparent)}}@media (max-width:calc(48rem - .1px)){[p~="lt-md:0"]{padding:calc(var(--spacing) * 0)}.lt-md\:w-full{width:100%}}@media(min-width:40rem){.sm\:p-6{padding:calc(var(--spacing) * 6)}.sm\:px-6{padding-inline:calc(var(--spacing) * 6)}}@media(min-width:48rem){.md\:mt-24{margin-top:calc(var(--spacing) * 24)}.md\:w-3xl{width:var(--container-3xl)}}@media(min-width:64rem){.lg\:px-12{padding-inline:calc(var(--spacing) * 12)}.lg\:w-2xl{width:var(--container-2xl)}.lg\:top-\$yun-margin-top{top:var(--yun-margin-top)}}@media(min-width:80rem){.xl\:px-16{padding-inline:calc(var(--spacing) * 16)}.xl\:w-2xl{width:var(--container-2xl)}.xl\:hidden{display:none}}@media(min-width:96rem){.\32xl\:w-4xl{width:var(--container-4xl)}}</style><script>const locale=localStorage.getItem("valaxy-locale")||"zh-CN";document.documentElement.setAttribute("lang",locale)</script><script type="module" async crossorigin src="/assets/app.DNNK9eY1.js"></script><link rel="modulepreload" crossorigin href="/assets/framework.GzYmdVjK.js"><link rel="modulepreload" crossorigin href="/assets/chunks/@vueuse/motion.D4J2SB46.js"><link rel="modulepreload" crossorigin href="/assets/chunks/vue-router.Dq2gs_fP.js"><link rel="modulepreload" crossorigin href="/assets/chunks/dayjs.Dto65haK.js"><link rel="modulepreload" crossorigin href="/assets/chunks/vue-i18n.BvWwj3SI.js"><link rel="modulepreload" crossorigin href="/assets/chunks/pinia.BcfqlbOB.js"><link rel="modulepreload" crossorigin href="/assets/chunks/nprogress.W5IEJXTh.js"><link rel="preload" crossorigin href="/assets/app.D1aPWwca.css" onload='this.rel="stylesheet"' as="style"><noscript><link rel="stylesheet" crossorigin href="/assets/app.D1aPWwca.css"></noscript><link rel="preload" crossorigin href="/assets/group-icons.Bm1YPxXM.css" onload='this.rel="stylesheet"' as="style"><noscript><link rel="stylesheet" crossorigin href="/assets/group-icons.Bm1YPxXM.css"></noscript><link rel="modulepreload" crossorigin href="/assets/post.Da22kVJe.js"><link rel="preload" href="/assets/group-icons.Bm1YPxXM.css" onload='this.rel="stylesheet"' as="style"><noscript><link rel="stylesheet" href="/assets/group-icons.Bm1YPxXM.css"></noscript><link rel="modulepreload" crossorigin href="/assets/JVM.D60aAX7A.js"><title>Java 虚拟机从入门到精通 - imklaus's Blog</title><script id="check-mac-os" async>document.documentElement.classList.toggle("mac",/Mac|iPhone|iPod|iPad/i.test(navigator.platform))</script><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@900&amp;display=swap"><meta property="og:locale:alternate" content="en"><meta name="description" content="The Winner Takes It All."><meta property="og:description" content="The Winner Takes It All."><meta property="og:locale" content="zh-CN"><meta property="og:site_name" content="imklaus's Blog "><meta property="og:title" content="Java 虚拟机从入门到精通"><meta property="og:image" content="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/freecompress-Snipaste_2025-12-04_20-53-39.png"><meta property="og:type" content="website"><meta property="og:url" content="https://www.imlklaus.cn/"><link rel="icon" href="/favicon/dinosaur-egg.png" type="image/png"><meta name="generator" content="Valaxy 0.26.10"><meta name="theme-color" content="#fff"><meta name="msapplication-TileColor" content="#fff"><meta name="twitter:card" content="summary_large_image"><link rel="preload" as="font" crossorigin="anonymous" href="/assets/KaTeX_AMS-Regular.BQhdFMY1.woff2"><link rel="preload" as="font" crossorigin="anonymous" href="/assets/KaTeX_Caligraphic-Bold.Dq_IR9rO.woff2"><link rel="preload" as="font" crossorigin="anonymous" href="/assets/KaTeX_Caligraphic-Regular.Di6jR-x-.woff2"><link rel="preload" as="font" crossorigin="anonymous" href="/assets/KaTeX_Fraktur-Bold.CL6g_b3V.woff2"><link rel="preload" as="font" crossorigin="anonymous" href="/assets/KaTeX_Fraktur-Regular.CTYiF6lA.woff2"><link rel="preload" as="font" crossorigin="anonymous" href="/assets/KaTeX_Main-Bold.Cx986IdX.woff2"><link rel="preload" as="font" crossorigin="anonymous" href="/assets/KaTeX_Main-BoldItalic.DxDJ3AOS.woff2"><link rel="preload" as="font" crossorigin="anonymous" href="/assets/KaTeX_Main-Italic.NWA7e6Wa.woff2"><link rel="preload" as="font" crossorigin="anonymous" href="/assets/KaTeX_Main-Regular.B22Nviop.woff2"><link rel="preload" as="font" crossorigin="anonymous" href="/assets/KaTeX_Math-BoldItalic.CZnvNsCZ.woff2"><link rel="preload" as="font" crossorigin="anonymous" href="/assets/KaTeX_Math-Italic.t53AETM-.woff2"><link rel="preload" as="font" crossorigin="anonymous" href="/assets/KaTeX_SansSerif-Bold.D1sUS0GD.woff2"><link rel="preload" as="font" crossorigin="anonymous" href="/assets/KaTeX_SansSerif-Italic.C3H0VqGB.woff2"><link rel="preload" as="font" crossorigin="anonymous" href="/assets/KaTeX_SansSerif-Regular.DDBCnlJ7.woff2"><link rel="preload" as="font" crossorigin="anonymous" href="/assets/KaTeX_Script-Regular.D3wIWfF6.woff2"><link rel="preload" as="font" crossorigin="anonymous" href="/assets/KaTeX_Size1-Regular.mCD8mA8B.woff2"><link rel="preload" as="font" crossorigin="anonymous" href="/assets/KaTeX_Size2-Regular.Dy4dx90m.woff2"><link rel="preload" as="font" crossorigin="anonymous" href="data:font/woff2;base64,d09GMgABAAAAAA4oAA4AAAAAHbQAAA3TAAEAAAAAAAAAAAAAAAAAAAAAAAAAAAAABmAAgRQIDgmcDBEICo1oijYBNgIkA14LMgAEIAWJAAeBHAyBHBvbGiMRdnO0IkRRkiYDgr9KsJ1NUAf2kILNxgUmgqIgq1P89vcbIcmsQbRps3vCcXdYOKSWEPEKgZgQkprQQsxIXUgq0DqpGKmIvrgkeVGtEQD9DzAO29fM9jYhxZEsL2FeURH2JN4MIcTdO049NCVdxQ/w9NrSYFEBKTDKpLKfNkCGDc1RwjZLQcm3vqJ2UW9Xfa3tgAHz6ivp6vgC2yD4/6352ndnN0X0TL7seypkjZlMsjmZnf0Mm5Q+JykRWQBKCVCVPbARPXWyQtb5VgLB6Biq7/Uixcj2WGqdI8tGSgkuRG+t910GKP2D7AQH0DB9FMDW/obJZ8giFI3Wg8Cvevz0M+5m0rTh7XDBlvo9Y4vm13EXmfttwI4mBo1EG15fxJhUiCLbiiyCf/ZA6MFAhg3pGIZGdGIVjtPn6UcMk9A/UUr9PhoNsCENw1APAq0gpH73e+M+0ueyHbabc3vkbcdtzcf/fiy+NxQEjf9ud/ELBHAXJ0nk4z+MXH2Ev/kWyV4k7SkvpPc9Qr38F6RPWnM9cN6DJ0AdD1BhtgABtmoRoFCvPsBAumNm6soZG2Gk5GyVTo2sJncSyp0jQTYoR6WDvTwaaEcHsxHfvuWhHA3a6bN7twRKtcGok6NsCi7jYRrM2jExsUFMxMQYuJbMhuWNOumEJy9hi29Dmg5zMp/A5+hhPG19j1vBrq8JTLr8ki5VLPmG/PynJHVul440bxg5xuymHUFPBshC+nA9I1FmwbRBTNHAcik3Oae0cxKoI3MOriM42UrPe51nsaGxJ+WfXubAsP84aabUlQSJ1IiE0iPETLUU4CATgfXSCSpuRFRmCGbO+wSpAnzaeaCYW1VNEysRtuXCEL1kUFUbbtMv3Tilt/1c11jt3Q5bbMa84cpWipp8Elw3MZhOHsOlwwVUQM3lAR35JiFQbaYCRnMF2lxAWoOg2gyoIV4PouX8HytNIfLhqpJtXB4vjiViUI8IJ7bkC4ikkQvKksnOTKICwnqWSZ9YS5f0WCxmpgjbIq7EJcM4aI2nmhLNY2JIUgOjXZFWBHb+x5oh6cwb0Tv1ackHdKi0I9OO2wE9aogIOn540CCCziyhN+IaejtgAONKznHlHyutPrHGwCx9S6B8kfS4Mfi4Eyv7OU730bT1SCBjt834cXsf43zVjPUqqJjgrjeGnBxSG4aYAKFuVbeCfkDIjAqMb6yLNIbCuvXhMH2/+k2vkNpkORhR59N1CkzoOENvneIosjYmuTxlhUzaGEJQ/iWqx4dmwpmKjrwTiTGTCVozNAYqk/zXOndWxuWSmJkQpJw3pK5KX6QrLt5LATMqpmPAQhkhK6PUjzHUn7E0gHE0kPE0iKkolgkUx9SZmVAdDgpffdyJKg3k7VmzYGCwVXGz/tXmkOIp+vcWs+EMuhhvN0h9uhfzWJziBQmCREGSIFmQIkgVpAnSBRmC//6hkLZwaVhwxlrJSOdqlFtOYxlau9F2QN5Y98xmIAsiM1HVp2VFX+DHHGg6Ecjh3vmqtidX3qHI2qycTk/iwxSt5UzTmEP92ZBnEWTk4Mx8Mpl78ZDokxg/KWb+Q0QkvdKVmq3TMW+RXEgrsziSAfNXFMhDc60N5N9jQzjfO0kBKpUZl0ZmwJ41j/B9Hz6wmRaJB84niNmQrzp9eSlQCDDzazGDdVi3P36VZQ+Jy4f9UBNp+3zTjqI4abaFAm+GShVaXlsGdF3FYzZcDI6cori4kMxUECl9IjJZpzkvitAoxKue+90pDMvcKRxLl53TmOKCmV/xRolNKSqqUxc6LStOETmFOiLZZptlZepcKiAzteG8PEdpnQpbOMNcMsR4RR2Bs0cKFEvSmIjAFcnarqwUL4lDhHmnVkwu1IwshbiCcgvOheZuYyOteufZZwlcTlLgnZ3o/WcYdzZHW/WGaqaVfmTZ1aWCceJjkbZqsfbkOtcFlUZM/jy+hXHDbaUobWqqXaeWobbLO99yG5N3U4wxco0rQGGcOLASFMXeJoham8M+/x6O2WywK2l4HGbq1CoUyC/IZikQhdq3SiuNrvAEj0AVu9x2x3lp/xWzahaxidezFVtdcb5uEnzyl0ZmYiuKI0exvCd4Xc9CV1KB0db00z92wDPde0kukbvZIWN6jUWFTmPIC/Y4UPCm8UfDTFZpZNon1qLFTkBhxzB+FjQRA2Q/YRJT8pQigslMaUpFyAG8TMlXigiqmAZX4xgijKjRlGpLE0GdplRfCaJo0JQaSxNBk6ZmMzcya0FmrcisDdn0Q3HI2sWSppYigmlM1XT/kLQZSNpMJG0WkjYbSZuDpM1F0uYhFc1HxU4m1QJjDK6iL0S5uSj5rgXc3RejEigtcRBtqYPQsiTskmO5vosV+q4VGIKbOkDg0jtRrq+Em1YloaTFar3EGr1EUC8R0kus1Uus00usL97ABr2BjXoDm/QGNhuWtMVBKOwg/i78lT7hBsAvDmwHc/ao3vmUbBmhjeYySZNWvGkfZAgISDSaDo1SVpzGDsAEkF8B+gEapViUoZgUWXcRIGFZNm6gWbAKk0bp0k1MHG9fLYtV4iS2SmLEQFARzRcnf9PUS0LVn05/J9MiRRBU3v2IrvW974v4N00L7ZMk0wXP1409CHo/an8zTRHD3eSJ6m8D4YMkZNl3M79sqeuAsr/m3f+8/yl7A50aiAEJgeBeMWzu7ui9UfUBCe2TIqZIoOd/3/udRBOQidQZUERzb2/VwZN1H/Sju82ew2H2Wfr6qvfVf3hqwDvAIpkQVFy4B9Pe9e4/XvPeceu7h3dvO56iJPf0+A6cqA2ip18ER+iFgggiuOkvj24bby0N9j2UHIkgqIt+sVgfodC4YghLSMjSZbH0VR/6dMDrYJeKHilKTemt6v6kvzvn3/RrdWtr0GoN/xL+Sex/cPYLUpepx9cz/D46UPU5KXgAQa+NDps1v6J3xP1i2HtaDB0M9aX2deA7SYff//+gUCovMmIK/qfsFcOk+4Y5ZN97XlG6zebqtMbKgeRFi51vnxTQYBUik2rS/Cn6PC8ADR8FGxsRPB82dzfND90gIcshOcYUkfjherBz53odpm6TP8txlwOZ71xmfHHOvq053qFF/MRlS3jP0ELudrf2OeN8DHvp6ZceLe8qKYvWz/7yp0u4dKPfli3CYq0O13Ih71mylJ80tOi10On8wi+F4+LWgDPeJ30msSQt9/vkmHq9/Lvo2b461mP801v3W4xTcs6CbvF9UDdrSt+A8OUbpSh55qAUFXWznBBfdeJ8a4d7ugT5tvxUza3h9m4H7ptTqiG4z0g5dc0X29OcGlhpGFMpQo9ytTS+NViZpNdvU4kWx+LKxNY10kQ1yqGXrhe4/1nvP7E+nd5A92TtaRplbHSqoIdOqtRWti+fkB5/n1+/VvCmz12pG1kpQWsfi1ftlBobm0bpngs16CHkbIwdLnParxtTV3QYRlfJ0KFskH7pdN/YDn+yRuSd7sNH3aO0DYPggk6uWuXrfOc+fa3VTxFVvKaNxHsiHmsXyCLIE5yuOeN3/Jdf8HBL/5M6shjyhxHx9BjB1O0+4NLOnjLLSxwO7ukN4jMbOIcD879KLSi6Pk61Oqm2377n8079PXEEQ7cy7OKEC9nbpet118fxweTafpt69x/Bt8UqGzNQt7aelpc44dn5cqhwf71+qKp/Zf/+a0zcizOUWpl/iBcSXip0pplkatCchoH5c5aUM8I7/dWxAej8WicPL1URFZ9BDJelUwEwTkGqUhgSlydVes95YdXvhh9Gfz/aeFWvgVb4tuLbcv4+wLdutVZv/cUonwBD/6eDlE0aSiKK/uoH3+J1wDE/jMVqY2ysGufN84oIXB0sPzy8ollX/LegY74DgJXJR57sn+VGza0x3DnuIgABFM15LmajjjsNlYj+JEZGbuRYcAMOWxFkPN2w6Wd46xo4gVWQR/X4lyI/R6K/YK0110GzudPRW7Y+UOBGTfNNzHeYT0fiH0taunBpq9HEW8OKSaBGj21L0MqenEmNRWBAWDWAk4CpNoEZJ2tTaPFgbQYj8HxtFilErs3BTRwT8uO1NXQaWfIotchmPkAF5mMBAliEmZiOGVgCG9LgRzpscMAOOwowlT3JhusdazXGSC/hxR3UlmWVwWHpOIKheqONvjyhSiTHIkVUco5bnji8m//zL7PKaT1Vl5I6UE609f+gkr6MZKVyKc7zJRmCahLsdlyA5fdQkRSan9LgnnLEyGSkaKJCJog0wAgvepWBt80+1yKln1bMVtCljfNWDueKLsWwaEbBSfSPTEmVRsUcYYMnEjcjeyCZzBXK9E9BYBXLKjOSpUDR+nEV3TFSUdQaz+ot98QxgXwx0GQ+EEUAKB2qZPkQQ0GqFD8UPFMqyaCHM24BZmSGic9EYMagKizOw9Hz50DMrDLrqqLkTAhplMictiCAx5S3BIUQdeJeLnBy2CNtMfz6cV4u8XKoFZQesbf9YZiIERiHjaNodDW6LgcirX/mPnJIkBGDUpTBhSa0EIr38D5hCIszhCM8URGBqImoWjpvpt1ebu/v3Gl3qJfMnNM+9V+kiRFyROTPHQWOcs1dNW94/ukKMPZBvDi55i5CttdeJz84DLngLqjcdwEZ87bFFR8CIG35OAkDVN6VRDZ7aq67NteYqZ2lpT8oYB2CytoBd6VuAx4WgiAsnuj3WohG+LugzXiQRDeM3XYXlULv4dp5VFYC"><link rel="preload" as="font" crossorigin="anonymous" href="/assets/KaTeX_Size4-Regular.Dl5lxZxV.woff2"><link rel="preload" as="font" crossorigin="anonymous" href="/assets/KaTeX_Typewriter-Regular.CO6r4hn1.woff2"></head><body><div id="app" data-server-rendered="true"><!--[--><!--[--><!--[--><!----><!----><div class="yun-page-header-gradient" style="--gradient-from:161 196 253;--gradient-to:194 233 251"></div><!----><!----><!----><canvas class="fireworks"></canvas><!--[--><div class="yun-bg"></div><!--]--><div class="yun-page-loading" absolute left-0 right-0 bottom-0 top-0 flex justify="center" items-center z-10 bg="$va-c-bg" data-v-e7dc65c9><div class="spinner" data-v-e7dc65c9></div></div><a href="#" class="back-to-top yun-icon-btn bg-$va-c-bg-soft shadow-md"><div class="size-8" i-ri-arrow-up-s-line></div><svg class="progress-circle-container" viewBox="0 0 100 100"><circle stroke-dasharray="301.59289474462014 301.59289474462014" stroke-dashoffset="301.59289474462014" stroke="currentColor" stroke-width="2" stroke-linecap="round" class="progress-circle" cx="50" cy="50" r="48" fill="none"/></svg></a><!-- TODO --><!-- <YunDock /> --><!--]--><!--[--><!--]--><!----><!--]--><!--[--><div flex="~" class="w-full m-auto justify-center items-start gap-4 mt-12 md:mt-24"><!--[--><!----><main class="yun-main lt-md:w-full" flex="~ center"><!--[--><div class="content w-full md:w-3xl lg:w-2xl xl:w-2xl 2xl:w-4xl" flex="~ col grow" p="lt-md:0"><div class="yun-card flex-center rounded-2 relative" flex="col" min-h="100px" bg="$va-c-bg-light" m="0" style><img width="640" height="360" class="object-cover select-none" h="64 md:sm" w="full" src="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/freecompress-Snipaste_2025-12-04_20-53-39.png" loading="lazy"><!----><!--[--><div class="mt-8 mb-4"><!--[--><header class="post-header" cover="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/freecompress-Snipaste_2025-12-04_20-53-39.png"><h1 p="2" text="2xl center" font="serif black" style="" class="post-title flex-center"><!----><span inline-flex class="leading-none">Java 虚拟机从入门到精通</span></h1></header><!--]--></div><!--[--><!--[--><!--[--><!--[--><!----><!----><div class="post-top-icon" color="$va-c-warning"><div i-ri-pushpin-line></div></div><div flex="~ center" text="sm" class="flex-col gap-2! post-meta gap-4"><div class="post-time flex items-center gap-4"><span class="posted-time inline-flex-center gap-1" title="发表于2025-11-17 03:18:00"><div class="inline-block" i-ri-calendar-line></div><time class="op-80">2025-11-17</time></span><!----></div><!--[--><!--]--><div class="inline-flex-center gap-4"><div class="inline-flex-center post-counter gap-4"><span class="word-count inline-flex-center gap-1" title="本文字数"><div class="inline-block" i-ri-file-word-line></div><span class="op-80">23.4k</span></span><span class="reading-time inline-flex-center gap-1" title="阅读时长"><div i-ri-timer-line></div><time class="op-80">108m</time></span></div><div class="inline-flex gap-4" text="sm" h="5"><!----><div inline-flex justify="center" items="center" title="评论数"><div inline-flex i-ri-chat-4-line></div><span ml-1 inline-flex class="waline-comment-count op-80" data-path="/posts/JVM"></span></div></div></div></div><!--]--><div class="inline-flex mt-2" text="sm" py="1"><a href="/categories?category=Java/%E8%99%9A%E6%8B%9F%E6%9C%BA" class="transition post-category inline-flex-center text-xs border-$va-c-divider" px-2 h="7" border rounded-full hover="bg-blue-500 text-white"><div m="x-1" inline-flex i-ri-folder-2-line></div><span>Java / 虚拟机</span></a><span mx="2"></span><div class="post-tags inline-flex" items="center" gap="1" flex="wrap 1" justify="end"><!--[--><a href="/tags/?tag=JVM" class="transition post-tag inline-flex-center text-xs border-$va-c-divider" px-2 h="7" rounded-full border hover="bg-blue-500 text-white"><span>JVM</span></a><!--]--></div></div><!--]--><!--]--><!--]--><div p="x-4 b-8" class="sm:px-6 lg:px-12 xl:px-16" w="full"><!--[--><!--]--><!--[--><!-- <Transition appear> --><article class="markdown-body"><!--[--><!----><!----><!--[--><!--]--><!--[--><p>参考视频：<a href="https://www.bilibili.com/video/BV1yE411Z7AP" target="_blank" rel="noreferrer">满神Java虚拟机快速入门</a></p><p>笔记的整体结构依据视频编写，并随着学习的深入补充了很多知识</p><!-- more --><h2 id="什么是jvm" tabindex="-1">什么是JVM <a class="header-anchor" href="#什么是jvm" aria-label="Permalink to &quot;什么是JVM&quot;">​</a></h2><h3 id="定义" tabindex="-1">定义 <a class="header-anchor" href="#定义" aria-label="Permalink to &quot;定义&quot;">​</a></h3><p>Java Virtual Machine，Java程序的<strong>运行环境</strong>（JAVA二进制字节码的运行环境）</p><hr><h3 id="好处" tabindex="-1">好处 <a class="header-anchor" href="#好处" aria-label="Permalink to &quot;好处&quot;">​</a></h3><ul><li>一次编写，到处运行（JVM屏蔽了我们的字节码跟底层操作系统之间的差异，对外提供一个一致的运行环境，JVM就可以用这种解释的方法来执行我们的二进制的字节码，以达到我们代码的一个平台无关性）</li><li>自动内存管理，垃圾回收机制（早期与C语言竞争）</li><li>数组下标越界检查（数组的新元素覆盖了程序的其他部分比抛异常严重多了，之前C语言是没有数组下标检查的，程序员必须自己去捕捉异常，一旦数组下标越界就有可能覆盖其他代码的内存，是很严重的）</li><li>多态（让代码的扩展性得到大大提升，JVM在内部使用虚方法表的机制来实现了多态）</li></ul><figure><img src="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20231221175716734.png" alt="image-20231221175716734" loading="lazy" decoding="async" class="lazy"></figure><p>理解底层的实现原理（自动拆装箱，for each增强，动态代理等，都需要掌握一定的字节码技术）</p><hr><h2 id="jvm内存结构" tabindex="-1">JVM内存结构 <a class="header-anchor" href="#jvm内存结构" aria-label="Permalink to &quot;JVM内存结构&quot;">​</a></h2><figure><img src="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20231225170711941.png" alt="image-20231225170711941" loading="lazy" decoding="async" class="lazy"></figure><p>JVM分三大块：类加载器、JVM内存结构、执行引擎</p><p>Java源代码编译为二进制字节码后必须经过类加载器才可以被加载到JVM里去运行，类都是放在这个方法区里，类将来创建的实例对象都放在堆里，堆中的实例对象将来调用方法时又会用到虚拟机栈，程序计数器，本地方法栈；</p><p>方法执行时，每行代码是由执行引擎中的解释器逐行执行，方法中的热点代码或频繁调用的代码会由一个即时编译器进行一个优化；执行引擎中的垃圾回收机制会对堆里一些不再被引用的对象进行垃圾回收；还有一些Java代码不方便实现的功能必须调用底层操作系统的功能，所以Java需要跟底层操作系统的一些功能打交道就要用到本地方法接口来调用操作系统提供的一些功能方法</p><hr><h3 id="程序计数器" tabindex="-1">程序计数器 <a class="header-anchor" href="#程序计数器" aria-label="Permalink to &quot;程序计数器&quot;">​</a></h3><figure><img src="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20231221175841983.png" alt="image-20231221175841983" loading="lazy" decoding="async" class="lazy"></figure><p>指令前面的数字可以理解成一个指令对应的内存地址，当这些指令被加载到JVM内存以后，就会有这些地址信息，根据地址信息就可以找到这条命令来执行它，加上程序计数器后执行流程：拿到getstatic指令通过解释器解释为机器码再交给CPU来运行，与此同时它也会把它下一条的指令astore_1的地址3放入程序计数器，等第一条指令执行完后，解释器就会到程序计数器里根据地址找到下一条指令来执行，以此类推，所以如果没有这个程序计数器，解释器就不知道接下来要执行哪条指令</p><figure><img src="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20231221175916827.png" alt="image-20231221175916827" loading="lazy" decoding="async" class="lazy"></figure><p>程序计数器是在JVM规范中唯一一个不会出现内存溢出的区域，其他区域都会出现内存溢出</p><hr><h3 id="虚拟机栈" tabindex="-1">虚拟机栈 <a class="header-anchor" href="#虚拟机栈" aria-label="Permalink to &quot;虚拟机栈&quot;">​</a></h3><figure><img src="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20231221175929568.png" alt="image-20231221175929568" loading="lazy" decoding="async" class="lazy"></figure><figure><img src="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20231221175951712.png" alt="image-20231221175951712" loading="lazy" decoding="async" class="lazy"></figure><figure><img src="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20231221180008424.png" alt="image-20231221180008424" loading="lazy" decoding="async" class="lazy"></figure><p>如果方法内局部变量没有逃离方法的作用访问，它是线程安全的，反之，你的局部变量当成返回值返回，就会存在线程安全的风险，你必须对它施加保护；</p><p>如果是局部变量引用了对象，并逃离方法的作用范围，需要考虑线程安全，如果是基本类型变量也可以保证线程安全</p><hr><h4 id="栈内存溢出" tabindex="-1">栈内存溢出 <a class="header-anchor" href="#栈内存溢出" aria-label="Permalink to &quot;栈内存溢出&quot;">​</a></h4><figure><img src="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20231221180019665.png" alt="image-20231221180019665" loading="lazy" decoding="async" class="lazy"></figure><p>适当减小栈的总大小，递归次数变小</p><figure><img src="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20231221180030171.png" alt="image-20231221180030171" loading="lazy" decoding="async" class="lazy"></figure><p>两个类之间的循环引用导致的栈内存溢出（第三方类库产生的无限递归）</p><hr><h4 id="线程诊断-cpu占用高" tabindex="-1">线程诊断 - CPU占用高 <a class="header-anchor" href="#线程诊断-cpu占用高" aria-label="Permalink to &quot;线程诊断 - CPU占用高&quot;">​</a></h4><figure><img src="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20231221180040579.png" alt="image-20231221180040579" loading="lazy" decoding="async" class="lazy"></figure><blockquote><p>在Linux中，tid是指线程ID（Thread ID），它是用来唯一标识一个线程的数字。每个线程都有自己的tid，可以通过系统调用或命令来获取线程的tid。tid的作用是在多线程程序中区分不同的线程，以便操作系统能够正确地管理和调度线程。</p><p>在Linux中，nid是指内核线程ID（Kernel Thread ID），它是用来唯一标识一个内核线程的数字。与用户线程ID（tid）不同，nid是用来标识内核线程的。内核线程是在内核空间运行的线程，通常用于执行系统任务和管理内核资源。nid的作用是在内核中区分不同的线程，以便内核能够正确地管理和调度内核线程。</p></blockquote><hr><h4 id="线程诊断-死锁" tabindex="-1">线程诊断 - 死锁 <a class="header-anchor" href="#线程诊断-死锁" aria-label="Permalink to &quot;线程诊断 - 死锁&quot;">​</a></h4><figure><img src="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20231221180055689.png" alt="image-20231221180055689" loading="lazy" decoding="async" class="lazy"></figure><hr><h3 id="本地方法栈" tabindex="-1">本地方法栈 <a class="header-anchor" href="#本地方法栈" aria-label="Permalink to &quot;本地方法栈&quot;">​</a></h3><figure><img src="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20231221180105811.png" alt="image-20231221180105811" loading="lazy" decoding="async" class="lazy"></figure><hr><h3 id="堆" tabindex="-1">堆 <a class="header-anchor" href="#堆" aria-label="Permalink to &quot;堆&quot;">​</a></h3><p>本地方法：在一些Java的基础类库里、在执行引擎中都会去调用这些本地方法（native）</p><p>线程私有：JVM栈、程序计数器、本地方法栈</p><p>线程共享：方法区、堆</p><figure><img src="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20231221180115797.png" alt="image-20231221180115797" loading="lazy" decoding="async" class="lazy"></figure><p>案例</p><ul><li>垃圾回收后，内存占用仍然很高</li></ul><p>原始方法：jps获取java进程→jmap -heap pid（观察Eden Space占用内存（used）和老年代占用内存之和）→jconsole（执行GC发现堆内存并没有减多少）→jvisualvm（监视界面点击堆dump→查找最大对象并观察最大对象内部情况定位问题）</p><hr><h3 id="方法区" tabindex="-1">方法区 <a class="header-anchor" href="#方法区" aria-label="Permalink to &quot;方法区&quot;">​</a></h3><p>方法区跟堆一样都是线程共享的区域，里面存储了跟类结构相关的信息，如成员变量（字段），方法数据，成员方法以及构造器方法的代码部分，包括特殊方法（类的构造器），还有一个运行时常量池</p><p>概念上定义了方法区，但具体的不同JVM厂商去实现并不会去遵循JVM逻辑上的定义，逻辑上方法区是堆的一部分，但具体实现它根据不同的JVM厂商都会有所不同</p><p>Oracle的Hotspot虚拟机它在JDK8以前它的实现叫做永久代，它就是根据堆的一部分来实现的方法区，但到了1.8以后，永久代就移除了，换了一种实现，这个实现叫做元空间，它就不是用的堆的内存了，它用的是本地内存（操作系统内存），所以不同的实现它的方法区的位置就会有所不同，如IBM J9，之前BEA公司的JRockit JVM（JRockit JVM最初是由一家名为BEA Systems的公司开发的。后来，BEA Systems被Oracle收购，JRockit JVM也随之成为Oracle的产品。）都没有把方法区放在堆内存中，因此当提到永久代时，那它只是Hotspot JDK在8以前的一个实现而已，方法区是规范，永久代和元空间都是它的一种实现</p><blockquote><p><strong>Method Area</strong></p><p>The Java Virtual Machine has a <em>method area</em> that is shared among all Java Virtual Machine threads. The method area is analogous to the storage area for compiled code of a conventional language or analogous to the "text" segment in an operating system process. It stores per-class structures such as the run-time constant pool, field and method data, and the code for methods and constructors, including the special methods (<a href="https://docs.oracle.com/javase/specs/jvms/se8/html/jvms-2.html#jvms-2.9" target="_blank" rel="noreferrer">§2.9</a>) used in class and instance initialization and interface initialization.</p><p>The method area is created on virtual machine start-up. Although the method area is logically part of the heap, simple implementations may choose not to either garbage collect or compact it. This specification does not mandate the location of the method area or the policies used to manage compiled code. The method area may be of a fixed size or may be expanded as required by the computation and may be contracted if a larger method area becomes unnecessary. The memory for the method area does not need to be contiguous.</p><p>A Java Virtual Machine implementation may provide the programmer or the user control over the initial size of the method area, as well as, in the case of a varying-size method area, control over the maximum and minimum method area size.</p><p>The following exceptional condition is associated with the method area:</p><ul><li>If memory in the method area cannot be made available to satisfy an allocation request, the Java Virtual Machine throws an <code>OutOfMemoryError</code>.</li></ul><p>Java 虚拟机有一个方法区，由所有 Java 虚拟机线程共享。方法区类似于传统语言编译代码的存储区，或类似于操作系统进程中的"文本"段。它按类存储结构，如运行时常量池、字段和方法数据，以及方法和构造函数的代码，包括用于类和实例初始化以及接口初始化的特殊方法（第 2.9 节）。</p><p>方法区在虚拟机启动时创建。尽管<strong>方法区在逻辑上是堆的一部分</strong>，但简单的实现可能会选择不对其进行垃圾回收或压缩。本规范并未规定方法区的位置或用于管理编译代码的策略。方法区的大小可以是固定的，也可以根据计算需要进行扩展，如果不需要更大的方法区，也可以进行收缩。方法区的内存不需要连续。</p><p>Java 虚拟机实现可为程序员或用户提供对方法区初始大小的控制，在方法区大小可变的情况下，还可提供对最大和最小方法区大小的控制。</p><p>以下例外条件与方法区域相关联：</p><ul><li>如果方法区中的内存无法满足分配请求，Java 虚拟机将抛出 OutOfMemoryError（内存不足错误）。</li></ul></blockquote><figure><img src="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20231221180126045.png" alt="image-20231221180126045" loading="lazy" decoding="async" class="lazy"></figure><p>元空间在用的是本地内存（物理内存），很难暴露出问题，因此设置较小的元空间最大值把OOM问题暴露出来</p><figure><img src="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20231226205053481.png" alt="image-20231226205053481" loading="lazy" decoding="async" class="lazy"></figure><figure><img src="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20231221180135041.png" alt="image-20231221180135041" loading="lazy" decoding="async" class="lazy"></figure><figure><img src="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20231221180144290.png" alt="image-20231221180144290" loading="lazy" decoding="async" class="lazy"></figure><p>jdk 中的 ClassWriter（asm项目）和 CGLIB 中的 ClassWriter 都继承了 ClassVisitor，虽然 ClassVisitor 包名不同，但都是一个东西，即在运行期间动态生成类的字节码完成动态的类加载…</p><hr><h4 id="运行时常量池" tabindex="-1">运行时常量池 <a class="header-anchor" href="#运行时常量池" aria-label="Permalink to &quot;运行时常量池&quot;">​</a></h4><p>Java 代码编译为二进制字节码（类基本信息，常量池，类方法定义，包含了虚拟机指令）</p><p>类方法定义（反编译）</p><div class="language-sh max-h-300px"><button title="Copy code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code v-pre><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">{</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">  public</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF"> cn.itcast.jvm.t5.HelloWorld</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">();	</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D"># 无参构造 </span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">    descriptor:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> ()V</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">    flags:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF"> ACC_PUBLIC</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">    Code:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">      stack</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">1,</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> locals</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">1,</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> args_size</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">1</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">         0:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF"> aload_0</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">         1:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF"> invokespecial</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D"> #1</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">                  // Method java/lang/Object."&lt;init&gt;":()V</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">         4:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF"> return</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">      LineNumberTable:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">        line</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF"> 4:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> 0</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">      LocalVariableTable:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">        Start</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">  Length</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">  Slot</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">  Name</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">   Signature</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">            0</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">       5</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">     0</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">  this</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">   Lcn/itcast/jvm/t5/HelloWorld</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">  public</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF"> static</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF"> void</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF"> main</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">java.lang.String[]</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">); </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D"># main方法</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">    descriptor:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> ([Ljava/lang/String;)V</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">    flags:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF"> ACC_PUBLIC,</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF"> ACC_STATIC</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">    Code:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">      stack</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">2,</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> locals</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">1,</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> args_size</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">1</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">      	 # 获取System类的静态变量out</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">         0:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF"> getstatic</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">     #2</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">                  // Field java/lang/System.out:Ljava/io/PrintStream;</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">         # 加载hello world字符串参数</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">         3:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF"> ldc</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">           #3</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">                  // String hello world</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">         # 执行一次虚方法调用，即静态变量out中的println方法</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">         5:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF"> invokevirtual</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D"> #4</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">                  // Method java/io/PrintStream.println:(Ljava/lang/String;)V</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">         # 整个main方法执行结束</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">         8:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF"> return</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">      LineNumberTable:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">        line</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF"> 6:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> 0</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">        line</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF"> 7:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> 8</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">      LocalVariableTable:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">        Start</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">  Length</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">  Slot</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">  Name</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">   Signature</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">            0</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">       9</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">     0</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">  args</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">   [Ljava/lang/String;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">}</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">SourceFile:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF"> "HelloWorld.java"</span></span></code></pre><button class="code-block-unfold-btn"></button></div><p>指令后的注释是javap程序加上的，这些指令真正由解释器去执行翻译的时候是没有的，解释器看到的只有</p><div class="language-shell max-h-300px"><button title="Copy code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code v-pre><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">getstatic</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">     #2 </span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">ldc</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">           #3  </span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">invokevirtual</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D"> #4</span></span></code></pre><button class="code-block-unfold-btn"></button></div><p>解释器在解释的过程中就会根据<code>#2，#3，#4</code>进行一个查表翻译，如执行<code>getstatic</code>，根据后面的<code>#2</code>到常量池中查找</p><div class="language-sh max-h-300px"><button title="Copy code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code v-pre><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">Constant</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF"> pool:</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">   #1 = Methodref          #6.#20</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">         // java/lang/Object."&lt;init&gt;":()V</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">   #2 = Fieldref           #21.#22</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">        // java/lang/System.out:Ljava/io/PrintStream;</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">   #3 = String             #23</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">            // hello world</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">   #4 = Methodref          #24.#25</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">        // java/io/PrintStream.println:(Ljava/lang/String;)V</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">   #5 = Class              #26</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">            // cn/itcast/jvm/t5/HelloWorld</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">   #6 = Class              #27</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">            // java/lang/Object</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">   #7 = Utf8               &lt;init&gt;</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">   #8 = Utf8               ()V</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">   #9 = Utf8               Code</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">  #10 = Utf8               LineNumberTable</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">  #11 = Utf8               LocalVariableTable</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">  #12 = Utf8               this</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">  #13 = Utf8               Lcn/itcast/jvm/t5/HelloWorld;</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">  #14 = Utf8               main</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">  #15 = Utf8               ([Ljava/lang/String;)V</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">  #16 = Utf8               args</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">  #17 = Utf8               [Ljava/lang/String;</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">  #18 = Utf8               SourceFile</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">  #19 = Utf8               HelloWorld.java</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">  #20 = NameAndType        #7:#8</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">          // "&lt;init&gt;":()V</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">  #21 = Class              #28</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">            // java/lang/System</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">  #22 = NameAndType        #29:#30</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">        // out:Ljava/io/PrintStream;</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">  #23 = Utf8               hello world</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">  #24 = Class              #31</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">            // java/io/PrintStream</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">  #25 = NameAndType        #32:#33</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">        // println:(Ljava/lang/String;)V</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">  #26 = Utf8               cn/itcast/jvm/t5/HelloWorld</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">  #27 = Utf8               java/lang/Object</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">  #28 = Utf8               java/lang/System</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">  #29 = Utf8               out</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">  #30 = Utf8               Ljava/io/PrintStream;</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">  #31 = Utf8               java/io/PrintStream</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">  #32 = Utf8               println</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">  #33 = Utf8               (Ljava/lang/String;)V</span></span></code></pre><button class="code-block-unfold-btn"></button></div><p><code>#2 = Fieldref</code>：引用了一个成员变量，又根据其后面的<code>#21.#22</code>找到<code>#28</code>中是<code>System</code>类和<code>#29</code>中的变量<code>out</code>与<code>#30</code>中<code>out</code>变量的类型<code>PrintStream</code>；</p><p>执行<code>ldc</code>，根据后面的<code>#3</code>到常量池中查找</p><p><code>#3 = String</code>：指一个字符串，根据后面<code>#23 = Utf8</code>，<code>Utf8</code>是JVM常量池中的引用类型，找到一个<code>hello world</code>字符串，把这个<code>hello world</code>符号变成一个字符串对象作为参数加载进来；</p><p>执行<code>invokevirtual</code>，根据后面<code>#4</code>到常量池中查找</p><p><code>#4 = Methodref</code>：指一个方法引用，根据后面 <code>#24.#25</code>找到<code>java/io/PrintStream</code>类中的方法<code>println:(Ljava/lang/String;)V</code>，方法参数为字符串类型，无返回值；</p><p>因此常量池的作用就是给这些指令提供一些常量符号，根据常量符号以查表的方式找到具体的值，这样虚拟指令才能够成功的执行</p><p>上面的Constant pool只是一个类的常量池信息，运行时需要把它放到内存中，常量池放到内存中的位置被称为运行时常量池，并把里面的符号地址变为真实地址，上面的1，2，3就会变为真正的地址，根据内存地址找到相应的符号，类名，方法名等</p><hr><h4 id="stringtable" tabindex="-1">StringTable <a class="header-anchor" href="#stringtable" aria-label="Permalink to &quot;StringTable&quot;">​</a></h4><p>StringTable数据结构上是一个hash表，俗称串池，刚开始里面是空的，执行指令把符号变为字符串("a")对象后作为key到串池中查找有没有取值相同的key，没有就直接放入到串池中，这样串池就有了这个字符串对象了</p><p>每个字符串对象并不是事先就放入串池中，而是执行时用到当行代码才开始创建这个字符串对象（懒惰），串池中的对象只会存一份，取值相同的字符串是唯一的（缓存效果）</p><div class="language-sh max-h-300px"><button title="Copy code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code v-pre><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D"># String s1 = "a"; </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D"># String s2 = "b";</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D"># String s3 = "ab";</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">0:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF"> ldc</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">           #2</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">                  // String a</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">2:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF"> astore_1</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">3:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF"> ldc</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">           #3</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">                  // String b</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">5:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF"> astore_2</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">6:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF"> ldc</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">           #4</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">                  // String ab</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">8:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF"> astore_3</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">...</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">LocalVariableTable:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">        Start</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">  Length</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">  Slot</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">  Name</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">   Signature</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">            0</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">      51</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">     0</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">  args</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">   [Ljava/lang/String;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">            3</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">      48</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">     1</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">    s1</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">   Ljava/lang/String</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">            6</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">      45</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">     2</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">    s2</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">   Ljava/lang/String</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">            9</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">      42</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">     3</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">    s3</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">   Ljava/lang/String</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">;</span></span></code></pre><button class="code-block-unfold-btn"></button></div><hr><h5 id="字符串变量拼接" tabindex="-1">字符串变量拼接 <a class="header-anchor" href="#字符串变量拼接" aria-label="Permalink to &quot;字符串变量拼接&quot;">​</a></h5><div class="language-sh max-h-300px"><button title="Copy code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code v-pre><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D"># String s1 = "a"; </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D"># String s2 = "b";</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D"># String s3 = "ab";   </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D"># String s4 = s1 + s2;//通过以下分析s3的值在运行时常量池中，而s4引用了新的字符串对象"ab"，在堆中，两者的位置不一样(new StringBuilder().append("a").append("b").toString())</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">     0:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF"> ldc</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">           #2</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">                  // String a</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">     2:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF"> astore_1</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">	 #//把局部变量s1存入局部变量表中的槽位1</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">     3:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF"> ldc</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">           #3</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">                  // String b</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">     5:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF"> astore_2</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">     6:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF"> ldc</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">           #4</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">                  // String ab</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">     8:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF"> astore_3</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">     9:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF"> new</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">           #5</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">                  // class java/lang/StringBuilder 创建StringBuilder对象</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">    12:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF"> dup</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">    13:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF"> invokespecial</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D"> #6</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">                  // Method java/lang/StringBuilder."&lt;init&gt;":()V 调用StringBuilder的&lt;init&gt;方法（构造方法，()为无参）</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">    16:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF"> aload_1</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">		 #//把s1即"a"加载进来，从局部变量表中槽位1拿到s1变量</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">    17:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF"> invokevirtual</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D"> #7</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">                  // Method java/lang/StringBuilder.append:(Ljava/lang/String;)Ljava/lang/StringBuilder; 调用StringBuilder的append方法：append("a")</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">    20:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF"> aload_2</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">    21:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF"> invokevirtual</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D"> #7</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">                  // Method java/lang/StringBuilder.append:(Ljava/lang/String;)Ljava/lang/StringBuilder;   append("b")</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">    24:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF"> invokevirtual</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D"> #8</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">                  // Method java/lang/StringBuilder.toString:()Ljava/lang/String; 调用StringBuilder的toString方法：</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">    27:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF"> astore</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">        4</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">				#//把toString方法转换后的结果(new String("ab"))存入局部变量表的槽位4 </span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">    ...</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">     LocalVariableTable:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">        Start</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">  Length</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">  Slot</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">  Name</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">   Signature</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">            0</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">      51</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">     0</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">  args</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">   [Ljava/lang/String;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">            3</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">      48</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">     1</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">    s1</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">   Ljava/lang/String</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">            6</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">      45</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">     2</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">    s2</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">   Ljava/lang/String</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">            9</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">      42</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">     3</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">    s3</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">   Ljava/lang/String</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">           29</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">      22</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">     4</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">    s4</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">   Ljava/lang/String</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">;</span></span></code></pre><button class="code-block-unfold-btn"></button></div><div class="language-java max-h-300px"><button title="Copy code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code v-pre><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">@</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">Override</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">public</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> String </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">toString</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">() {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">    // Create a copy, don't share the array 把StringBuilder当前拼接好的值又创建了一个新的String对象</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">    return</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> String</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(value, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">, count);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">}</span></span></code></pre><button class="code-block-unfold-btn"></button></div><hr><h5 id="编译期优化" tabindex="-1">编译期优化 <a class="header-anchor" href="#编译期优化" aria-label="Permalink to &quot;编译期优化&quot;">​</a></h5><div class="language-shell max-h-300px"><button title="Copy code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code v-pre><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D"># String s1 = "a"; </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D"># String s2 = "b";</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D"># String s3 = "ab";   </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D"># String s4 = s1 + s2;</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D"># String s5 = "a" + "b";</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">		...</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">		6:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF"> ldc</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">           #4</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">                  // String ab</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">		8:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF"> astore_3</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">	    ...</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">        29:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF"> ldc</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">           #4</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">                  // String ab 执行到此行指令会通过key为"ab"在串池中查找符号，会发现已经有此符号，就不会去创建新的字符串对象了，就会沿用串池中已有的对象。这个操作是javac在编译期的优化，因为a和b都是常量，它们的内容都不会变，它俩拼接的结果是确定的，既然是确定的，那在编译期间就可以知道它们拼接的结果肯定是ab而不是别的值。s4与s5不同，s1和s2是变量，变量将来在运行期间其引用有可能被修改，既然它的结果有可能发生修改，那它的结果就不能确定，所以它必须在运行期间用StringBuilder的方法动态地拼接，而s5在编译期就能确定结果就不用通过StringBuilder的方式拼接</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">        31:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF"> astore</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">        5</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> 		...</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> 		LocalVariableTable:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">            Start</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">  Length</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">  Slot</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">  Name</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">   Signature</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">                0</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">      51</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">     0</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">  args</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">   [Ljava/lang/String;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">                3</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">      48</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">     1</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">    s1</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">   Ljava/lang/String</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">                6</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">      45</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">     2</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">    s2</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">   Ljava/lang/String</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">                9</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">      42</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">     3</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">    s3</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">   Ljava/lang/String</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">               29</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">      22</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">     4</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">    s4</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">   Ljava/lang/String</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">               33</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">      18</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">     5</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">    s5</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">   Ljava/lang/String</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">;</span></span></code></pre><button class="code-block-unfold-btn"></button></div><hr><h5 id="字符串延迟加载" tabindex="-1">字符串延迟加载 <a class="header-anchor" href="#字符串延迟加载" aria-label="Permalink to &quot;字符串延迟加载&quot;">​</a></h5><figure><img src="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20231229144501453.png" alt="image-20231229144501453" loading="lazy" decoding="async" class="lazy"></figure><hr><h5 id="intern与面试题" tabindex="-1">intern与面试题 <a class="header-anchor" href="#intern与面试题" aria-label="Permalink to &quot;intern与面试题&quot;">​</a></h5><div class="language-java max-h-300px"><button title="Copy code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code v-pre><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">//["a", "b"]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">String s </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> String</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">"a"</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">+</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> String</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">"b"</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">);</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">//new String("ab")</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">//["a", "b",   "ab"]</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">// 堆  new String("a")   new String("b") new String("ab")</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">String s2 </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> s.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">intern</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(); </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">// 将这个字符串对象尝试放入串池，如果有则并不会放入，如果没有则放入串池， 会把串池中的对象返回(jdk1.7,1.8)</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">//s2 == "ab"  s已放入串池 s == "ab"</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">System.out.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">println</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">( s2 </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">==</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF"> "ab"</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">);</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">//true</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">System.out.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">println</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">( s </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">==</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF"> "ab"</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> );</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">//true jdk1.6会拷贝一份到常量池，s != "ab"  s = new String("ab")</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">//--------------------------------------</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">String x </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF"> "ab"</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">//["ab", "a", "b"]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">String s </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> String</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">"a"</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">+</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> String</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">"b"</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">);</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">//new String("ab")</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">// 堆  new String("a")   new String("b") new String("ab")</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">//因为串池中已有"ab"，所以s并没有将堆中"ab"对象放入到串池，只是直接返回串池已有的"ab"(jdk1.7,1.8)，s -&gt; new String("ab")</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">String s2 </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> s.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">intern</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(); </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">//s2 == "ab"  串池已有"ab"，s = new String("ab")</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">//以下两个结果1.8、1.6是一样的</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">System.out.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">println</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">( s2 </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">==</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> x);</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">//true</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">System.out.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">println</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">( s </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">==</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> x );</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">//false</span></span></code></pre><button class="code-block-unfold-btn"></button></div><p>StringBuilder动态拼接的新字符串对象不会加入到串池中，可以调用String的intern方法</p><ul><li>1.8将这个字符串对象尝试放入串池，如果有则并不会放入，如果没有则放入串池， 会把串池中的对象返回</li><li>1.6 将这个字符串对象尝试放入串池，如果有则并不会放入，如果没有会把此对象复制一份，放入串池， 会把串池中的对象返回</li></ul><div class="language-java max-h-300px"><button title="Copy code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code v-pre><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">        String s1 </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF"> "a"</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">        String s2 </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF"> "b"</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">        String s3 </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF"> "a"</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> +</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF"> "b"</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">//ab</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">        String s4 </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> s1 </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">+</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> s2;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">//new String("ab")</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">        String s5 </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF"> "ab"</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">        String s6 </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> s4.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">intern</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">();</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">//ab</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">        System.out.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">println</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(s3 </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">==</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> s4);</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">//false</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">        System.out.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">println</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(s3 </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">==</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> s5);</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">//true</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">        System.out.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">println</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(s3 </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">==</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> s6);</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">//true</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">//-----------------------1.8</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">        String x2 </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> String</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">"c"</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">+</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> String</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">"d"</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">); </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">// new String("cd")</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">        String x1 </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF"> "cd"</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">        x2.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">intern</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">();</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">//x2=new String("cd")</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">// 问，如果调换了【↑最后两行代码】的位置呢</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">        System.out.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">println</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(x1 </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">==</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> x2);</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">//false</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">//^^^^^^^^^^^^^^^^^^^^^^^^^</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">		String x2 </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> String</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">"c"</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">+</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> String</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">"d"</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">); </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">// new String("cd")</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">		x2.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">intern</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">();</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">// cd</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">		String x1 </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF"> "cd"</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">		System.out.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">println</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(x1 </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">==</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> x2);</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">//true</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">//------------------------1.6</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">		String x2 </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> String</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">"c"</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">+</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> String</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">"d"</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">); </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">// new String("cd")</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">		String x1 </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF"> "cd"</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">		x2.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">intern</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">();</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">//x2=new String("cd")</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">// 问，如果调换了【↑最后两行代码】的位置呢</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">		System.out.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">println</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(x1 </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">==</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> x2);</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">//false</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">//^^^^^^^^^^^^^^^^^^^^^^^^^</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">		String x2 </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> String</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">"c"</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">+</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> String</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">"d"</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">); </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">// new String("cd")</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">		x2.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">intern</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">();</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">// cd x2=new String("cd")</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">		String x1 </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF"> "cd"</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">		System.out.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">println</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(x1 </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">==</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> x2);</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">//false</span></span></code></pre><button class="code-block-unfold-btn"></button></div><hr><h5 id="位置" tabindex="-1">位置 <a class="header-anchor" href="#位置" aria-label="Permalink to &quot;位置&quot;">​</a></h5><figure><img src="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20231229165451054.png" alt="image-20231229165451054" loading="lazy" decoding="async" class="lazy"></figure><p>JVM1.6中，StringTable它是常量池的一部分，它随常量池存储在永久代中；从1.7开始，它就把StringTable转移到堆中，即1.7，1.8把StringTable从永久代移到堆里，这是因为永久代的内存回收效率很低，永久代是需要Full GC时才会触发永久代的垃圾回收，而Full GC得等到整个老年代的空间不足时才会触发，这个触发的时间就有点晚，间接导致StringTable的回收效率并不高，其实StringTable的使用非常频繁，它里面都存储着字符串常量，一个Java的应用程序中大量的字符串常量对象都会分配到StringTable里，如果StringTable的回收效率不高就会占用大量的内存，进而导致永久代内存不足，因此1.7开始就将StringTable转移到堆里，在堆中的StringTable只需minor gc就会触发其垃圾回收，把常量池中用不到的字符串常量回收掉，这样就大大减轻了字符串对堆内存的占用</p><figure><img src="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20231229165716531.png" alt="image-20231229165716531" loading="lazy" decoding="async" class="lazy"></figure><figure><img src="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20231229170533250.png" alt="image-20231229170533250" loading="lazy" decoding="async" class="lazy"></figure><figure><img src="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20231229170635476.png" alt="image-20231229170635476" loading="lazy" decoding="async" class="lazy"></figure><p>如果进行垃圾回收时花费了98%的时间用来进行垃圾回收并且仅回收了不到2%的垃圾就会抛出OOM，这种情况属于癌症晚期了，即JVM进入了一个不可救药的地步了，因为内部花费了98%的精力去救JVM，但只回收了不到2%的堆内存，这时就不会进行垃圾回收了，就会报以上错误，就不是报堆空间不足的错误</p><p>把这个限制关掉后就会报堆空间不足</p><figure><img src="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20231229171230214.png" alt="image-20231229171230214" loading="lazy" decoding="async" class="lazy"></figure><hr><h5 id="垃圾回收" tabindex="-1">垃圾回收 <a class="header-anchor" href="#垃圾回收" aria-label="Permalink to &quot;垃圾回收&quot;">​</a></h5><p>StringTable会受到垃圾回收的管理的，当内存空间不足时，StringTable中那些没有被引用的字符串常量仍然会被垃圾回收</p><p><code>-XX:+PrintStringTableStatistics</code>是打印字符串表的统计信息，通过它我们可以清除的看到常量池中字符串实例的个数，包括一些占用大小等信息</p><p><code>-XX:+PrintGCDetails -verbose:gc</code>这两个参数是打印垃圾回收的详细信息，如果发生垃圾回收，它就会把垃圾回收的次数，花费时间等显示出来</p><p>StringTable的统计信息，StringTable底层类型于Hashtable的实现，即哈希表，数组+链表的结构，每个数组的个数称为桶，StringTable就是以哈希表的方式来存储数据的</p><figure><img src="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20231229173753849.png" alt="image-20231229173753849" loading="lazy" decoding="async" class="lazy"></figure><p>上面代码没有任何字符串操作就已经有1754个字符串对象了，这是因为Java程序在运行时类名、方法名等数据也是以字符串常量的形式表示的，它们也存储在串池中，加入100个字符串对象如下：</p><figure><img src="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20231229174226018.png" alt="image-20231229174226018" loading="lazy" decoding="async" class="lazy"></figure><p>加入10000个字符串对象如下：</p><figure><img src="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20231229175158817.png" alt="image-20231229175158817" loading="lazy" decoding="async" class="lazy"></figure><hr><h5 id="性能调优" tabindex="-1">性能调优 <a class="header-anchor" href="#性能调优" aria-label="Permalink to &quot;性能调优&quot;">​</a></h5><p><strong>调整StringTable桶个数</strong></p><p>StringTable底层是一个哈希表，哈希表的性能是跟它的大小密切相关的，如果哈希表的桶个数比较多，那么相对的元素就会比较分散，哈希碰撞的几率就会减少，查找的速度也会变快，反之，如果桶的个数比较少，那么哈希碰撞的几率就变高，导致链表较长从而查找速度就会受到影响</p><p>调整 <code>-XX:StringTableSize=桶个数</code>，设置StringTable的大小范围为1009到2305843009213693951</p><figure><img src="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20231230160417787.png" alt="image-20231230160417787" loading="lazy" decoding="async" class="lazy"></figure><figure><img src="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20231230161741076.png" alt="image-20231230161741076" loading="lazy" decoding="async" class="lazy"></figure><p>如果你的系统里字符串的常量个数非常多的话，建议适当把StringTable的桶个数设置调整的较大些，让它有个较好哈希分布，较少哈希冲突（以空间换时间），就可以让StringTable中串池的效率得到明显的性能提升</p><p><strong>intern入池</strong></p><figure><img src="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20231230164433074.png" alt="image-20231230164433074" loading="lazy" decoding="async" class="lazy"></figure><figure><img src="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20231230165427347.png" alt="image-20231230165427347" loading="lazy" decoding="async" class="lazy"></figure><p>如果你的应用里有大量的字符串并且这些字符串有可能存在重复的情况，就可以让字符串入池来减少字符串个数节约我们堆内存的使用</p><hr><h3 id="直接内存" tabindex="-1">直接内存 <a class="header-anchor" href="#直接内存" aria-label="Permalink to &quot;直接内存&quot;">​</a></h3><h4 id="定义与使用" tabindex="-1">定义与使用 <a class="header-anchor" href="#定义与使用" aria-label="Permalink to &quot;定义与使用&quot;">​</a></h4><p>直接内存是属于系统内存，是我们操作系统的内存</p><p><strong>Direct Memory</strong></p><ul><li>常见于 NIO 操作时，用于数据缓冲区（NIO里有一个ByteBuffer，它使用和所分配的内存就是直接内存，它不属于JVM来管理而属于操作系统内存）</li><li>分配回收成本较高，但读写性能高（操作系统内存，Java要想直接使用或分配或将来释放掉就会比较慢些，但读写性能高）</li></ul><div class="language-java max-h-300px"><button title="Copy code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code v-pre><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">/**</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D"> * 演示 ByteBuffer 作用</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D"> */</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> Demo1_9</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">    static</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> final</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> String FROM </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF"> "E:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">\\</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">编程资料</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">\\</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">第三方教学视频</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">\\</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">youtube</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">\\</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">Getting Started with Spring Boot-sbPSjI4tt10.mp4"</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">//800多M文件</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">    static</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> final</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> String TO </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF"> "E:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">\\</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">a.mp4"</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">    static</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> final</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> _1Mb </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> 1024</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> *</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> 1024</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">    public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> static</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> main</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">String</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">[] </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70">args</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">) {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">        io</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(); </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">// io 用时：1535.586957 1766.963399 1359.240226</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">        directBuffer</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(); </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">// directBuffer 用时：479.295165 702.291454 562.56592</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">    private</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> static</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> directBuffer</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">() {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">        long</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> start </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> System.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">nanoTime</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">();</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">        try</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> (FileChannel from </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> FileInputStream</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(FROM).</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">getChannel</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">             FileChannel to </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> FileOutputStream</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(TO).</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">getChannel</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">        ) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">            ByteBuffer bb </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> ByteBuffer.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">allocateDirect</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(_1Mb);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">            while</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> (</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">                int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> len </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> from.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">read</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(bb);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">                if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> (len </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">==</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> -</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">                    break</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">                }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">                bb.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">flip</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">                to.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">write</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(bb);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">                bb.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">clear</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">            }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">        } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">catch</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> (IOException </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70">e</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">            e.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">printStackTrace</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">        }</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">        long</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> end </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> System.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">nanoTime</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">        System.out.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">println</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">"directBuffer 用时："</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> +</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> (end </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">-</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> start) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">/</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> 1000_000.0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">    private</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> static</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> io</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">() {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">        long</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> start </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> System.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">nanoTime</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">();</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">        try</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> (FileInputStream from </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> FileInputStream</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(FROM);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">             FileOutputStream to </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> FileOutputStream</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(TO);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">        ) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">            byte</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">[] buf </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> new</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> byte</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">[_1Mb];</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">            while</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> (</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">                int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> len </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> from.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">read</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(buf);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">                if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> (len </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">==</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> -</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">                    break</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">                }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">                to.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">write</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(buf, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">, len);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">            }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">        } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">catch</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> (IOException </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70">e</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">            e.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">printStackTrace</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">        }</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">        long</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> end </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> System.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">nanoTime</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">        System.out.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">println</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">"io 用时："</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> +</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> (end </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">-</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> start) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">/</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> 1000_000.0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">}</span></span></code></pre><button class="code-block-unfold-btn"></button></div><p>​ Java本身并不具备磁盘读写的能力，它要调用磁盘读写功能需要调用操作系统提供的函数（native），切换到内核态以后，就可以由CPU函数真正去读取具体的磁盘文件内容，从磁盘文件读取进来，读取进来后内核态会在操作系统内存中划分一块系统缓冲区，那么磁盘文件内容就会先读入这个缓冲区，它不会把几百兆的内容一次性读取到内存，这样内存就太紧张了，所以让文件内容到缓冲区分次读取。但是注意，系统缓冲区Java代码是不能够运行的，Java会在堆内存中分配一块Java缓冲区，对应代码中的<code>new Byte[]</code>，Byte数组大小化为1MB，Java代码要能访问刚才读取的那个流中的数据，必须再从系统缓冲区把这个数据间接地给它读入Java缓冲区，之后就再次进入用户态，再去调用输出流的写入操作，反复进行读写操作，把整个文件复制到目标位置。因为有两块缓冲区，系统内存有一块缓冲区，Java里也有一块缓冲区，那你读取的时候必然设计到你的数据得存两份，第一次读到系统缓冲区还不行，因为Java代码访问不到它们，所以要把系统缓冲区的数据再读到Java缓冲区，这样就造成不必要的复制了，效率不是很高。</p><p>​ 使用Direct Memory情况：调用ByteBuffer的allocateDirect静态方法分配直接内存，磁盘文件读取时会进入直接内存，而Java代码也可以访问到直接内存，这样就比刚才没用直接内存的代码少了一次缓冲区的复制操作，速度就得到成倍的提升，这就是直接内存带来的好处，它也是擅长或适合做这种文件的IO操作，当然在NIO里也会再进一步优化</p><figure><img src="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20231221180202841.png" alt="image-20231221180202841" loading="lazy" decoding="async" class="lazy"></figure><ul><li>不受 JVM 内存回收管理（JVM进行垃圾回收时不会直接去释放直接内存它分配的内存）</li></ul><hr><h4 id="内存溢出" tabindex="-1">内存溢出 <a class="header-anchor" href="#内存溢出" aria-label="Permalink to &quot;内存溢出&quot;">​</a></h4><div class="language-java max-h-300px"><button title="Copy code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code v-pre><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">/**</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D"> * 演示直接内存溢出</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D"> */</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> Demo1_10</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">    static</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> _100Mb </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> 1024</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> *</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> 1024</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> *</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> 100</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">    public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> static</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> main</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">String</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">[] </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70">args</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">        List&lt;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">ByteBuffer</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">&gt; list </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> new</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> ArrayList&lt;&gt;();</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">        int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> i </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">        try</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">            while</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> (</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">                ByteBuffer byteBuffer </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> ByteBuffer.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">allocateDirect</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(_100Mb);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">                list.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">add</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(byteBuffer);</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">//让byteBuffer长时间占用内存而放入生命周期长的集合中观察异常暴露</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">                i</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">++</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">            }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">        } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">finally</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">            System.out.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">println</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(i);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">        }</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">        // 方法区是jvm规范， jdk6 中对方法区的实现称为永久代</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">        //                  jdk8 对方法区的实现称为元空间</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">}</span></span></code></pre><button class="code-block-unfold-btn"></button></div><p>抛出直接缓冲内存溢出</p><figure><img src="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20231230175244632.png" alt="image-20231230175244632" loading="lazy" decoding="async" class="lazy"></figure><hr><h4 id="分配和回收原理" tabindex="-1">分配和回收原理 <a class="header-anchor" href="#分配和回收原理" aria-label="Permalink to &quot;分配和回收原理&quot;">​</a></h4><ul><li>使用了 Unsafe 对象完成直接内存的分配回收，并且回收需要主动调用 freeMemory 方法</li></ul><p>以下代码看似好像是垃圾回收把直接内存给回收的，其实并非如此</p><div class="language-java max-h-300px"><button title="Copy code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code v-pre><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">/**</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D"> * 禁用显式回收对直接内存的影响</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D"> */</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> Demo1_26</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">    static</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> _1Gb </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> 1024</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> *</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> 1024</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> *</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> 1024</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">    /*</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">     * -XX:+DisableExplicitGC 显式的</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">     */</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">    public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> static</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> main</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">String</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">[] </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70">args</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">throws</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> IOException {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">        ByteBuffer byteBuffer </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> ByteBuffer.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">allocateDirect</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(_1Gb);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">        System.out.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">println</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">"分配完毕..."</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">        System.in.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">read</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">        System.out.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">println</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">"开始释放..."</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">        byteBuffer </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> null</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">        System.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">gc</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(); </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">// 显式的垃圾回收，Full GC</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">        System.in.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">read</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">}</span></span></code></pre><button class="code-block-unfold-btn"></button></div><p>以下代码看出ByteBuffer底层分配和释放内存的相关的类型是Java中非常底层的Unsafe类，这个类可以干一些分配与释放内存的事情，但不推荐新手使用此类来操作，它都是JDK内部去使用的</p><div class="language-java max-h-300px"><button title="Copy code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code v-pre><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">/**</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D"> * 直接内存分配的底层原理：Unsafe</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D"> */</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> Demo1_27</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">    static</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> _1Gb </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> 1024</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> *</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> 1024</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> *</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> 1024</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">    public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> static</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> main</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">String</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">[] </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70">args</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">throws</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> IOException {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">        Unsafe unsafe </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> getUnsafe</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">();</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">        // 分配内存  返回的long类型变量代表直接内存分配的一个内存地址，将来可以通过这个内存地址调用freeMemory方法释放刚才分配的内存</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">        long</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> base </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> unsafe.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">allocateMemory</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(_1Gb);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">        unsafe.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">setMemory</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(base, _1Gb, (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">byte</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">) </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">        System.in.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">read</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">();</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">        // 释放内存</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">        unsafe.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">freeMemory</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(base);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">        System.in.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">read</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">    public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> static</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> Unsafe </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">getUnsafe</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">() {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">        try</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">            Field f </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> Unsafe.class.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">getDeclaredField</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">"theUnsafe"</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">            f.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">setAccessible</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">            Unsafe unsafe </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> (Unsafe) f.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">get</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">null</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">            return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> unsafe;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">        } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">catch</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> (NoSuchFieldException | IllegalAccessException </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70">e</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">            throw</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> RuntimeException</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(e);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">        }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">}</span></span></code></pre><button class="code-block-unfold-btn"></button></div><p>运行程序观察任务管理器Java进程内存占用变化，最终内存被释放由此验证直接内存的分配和释放是通过Unsafe对象来管理的，不是JVM的垃圾回收，垃圾回收只能释放Java的内存，垃圾回收针对Java中那些无用的对象，它们的释放是自动的，无需手动调用任何方法，但直接内存不同，它必须主动去调用Unsafe的freeMemory方法才能完成对这个内存的释放</p><p><strong>直接内存的释放是借助了Java中的一个虚引用机制</strong></p><ul><li>ByteBuffer 的实现类内部，使用了 Cleaner （虚引用）来监测 ByteBuffer 对象，一旦ByteBuffer 对象被垃圾回收，那么就会由 ReferenceHandler 线程（守护）通过 Cleaner 的 clean 方法调用 freeMemory 来释放直接内存</li></ul><div class="language-java max-h-300px"><button title="Copy code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code v-pre><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> static</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> ByteBuffer </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">allocateDirect</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> capacity) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">    return</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> DirectByteBuffer</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(capacity);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">}</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">//...↓</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D"> // Primary constructor</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">    //</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">    DirectByteBuffer</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> cap) {                   </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">// package-private</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">        super</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">-</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">, cap, cap);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">        boolean</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> pa </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> VM.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">isDirectMemoryPageAligned</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">();</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">        int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> ps </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> Bits.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">pageSize</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">();</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">        long</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> size </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> Math.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">max</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">1L</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">, (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">long</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">)cap </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">+</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> (pa </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">?</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> ps </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">));</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">        Bits.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">reserveMemory</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(size, cap);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">        long</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> base </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">        try</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">            //调用的allocateDirect其内部间接地调用了Unsafe的allocateMemory方法</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">            base </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> unsafe.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">allocateMemory</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(size);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">        } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">catch</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> (OutOfMemoryError </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70">x</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">            Bits.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">unreserveMemory</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(size, cap);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">            throw</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> x;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">        }</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">        //完成了对直接内存的一个分配</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">        unsafe.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">setMemory</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(base, size, (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">byte</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">) </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">        if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> (pa </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">&amp;&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> (base </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">%</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> ps </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">!=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">)) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">            // Round up to page boundary</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">            address </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> base </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">+</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> ps </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">-</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> (base </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> (ps </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">-</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> 1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">));</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">        } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">else</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">            address </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> base;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">        }</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">        //直接内存释放的关键点			回调的任务对象</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">        //Cleaner在Java类库中是一个特殊的类型，即虚引用类型，它的特点是当它所关联的对象（ByteBuffer）被回收时，那么Cleaner就会触发这个虚引用的clean方法，ByteBuffer是Java对象，还是受垃圾回收管理，当ByteBuffer自己被垃圾回收时，就会触发虚引用对象（Cleaner）中的clean方法</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">        cleaner </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> Cleaner.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">create</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> Deallocator</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(base, size, cap));</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">        att </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> null</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">	</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">	//....</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">    private</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> static</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> Deallocator</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">        implements</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> Runnable</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">    {</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">        private</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> static</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> Unsafe unsafe </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> Unsafe.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">getUnsafe</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">();</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">        private</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> long</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> address;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">        private</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> long</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> size;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">        private</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> capacity;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">        private</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> Deallocator</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">long</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70"> address</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">long</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70"> size</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">int</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70"> capacity</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">            assert</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> (address </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">!=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">);</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">            this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">.address </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> address;</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">            this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">.size </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> size;</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">            this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">.capacity </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> capacity;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">        }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">        public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> run</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">() {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">            if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> (address </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">==</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">                // Paranoia</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">                return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">            }</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">            //对分配的直接内存进行主动释放</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">            unsafe.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">freeMemory</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(address);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">            address </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">            Bits.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">unreserveMemory</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(size, capacity);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">        }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">    }</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> Cleaner</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> extends</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> PhantomReference</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">&lt;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">Object</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">&gt; {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">    private</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> final</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> Runnable thunk;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">	...</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">	//此方法不是在主线程执行的，由后台ReferenceHandler的线程专门去监测这些虚引用对象，一旦虚引用对象关联的实际对象，也就是DirectByteBuffer对象被回收掉以后，就会调用虚引用对象(Cleaner)中的clean方法，然后执行任务对象的run方法（Deallocator对象中的run方法执行直接内存的释放）        </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">	public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> clean</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">() {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">        if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> (</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">remove</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">)) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">            try</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">                this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">.thunk.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">run</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">            } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">catch</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">final</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> Throwable </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70">var2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">                AccessController.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">doPrivileged</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">new</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> PrivilegedAction&lt;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">Void</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">&gt;() {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">                    public</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> Void </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">run</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">() {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">                        if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> (System.err </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">!=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> null</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">                            (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> Error</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">"Cleaner terminated abnormally"</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">, var2)).</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">printStackTrace</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">                        }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">                        System.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">exit</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">                        return</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> null</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">                    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">                });</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">            }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">        }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">	...</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">}</span></span></code></pre><button class="code-block-unfold-btn"></button></div><p><code>-XX:+DisableExplicitGC</code>参数表示禁用显式的垃圾回收，就是让我们代码中的<code>System.gc();</code>无效，这行代码指显式地进行垃圾回收，是一种Full GC，是一种影响性能的垃圾回收，不光要回收新生代还要回收老年代，会造成程序暂停的时间比较长（STW），为了防止在程序中写<code>System.gc();</code>代码而触发这种显式的垃圾回收，就可以加上这个VM参数进行JVM调优。</p><p>加上这个参数以后可能又会影响直接内存的回收机制，测试发现，虽然对别的代码没有影响，但对这个直接内存还是有影响的，因为我们不通过这种显式的垃圾回收代码来回收这个ByteBuffer对象，那只能等到真正的垃圾回收时才会被清理，那么它关联的直接内存才会被释放掉，所以就造成了直接内存就会占用较大，长时间得不到释放，那只能通过Unsafe的freeMemory方法来主动释放了，这个参数开了ByteBuffer对象得不到释放，关了只能显式垃圾回收ByteBuffer对象</p><blockquote><p>TLAB（Thread-Local Allocation Buffer）和ThreadLocal 是两个不同的概念，它们在虚拟机中的作用和功能也不同。</p><p>TLAB 是虚拟机为每个线程分配的一块私有的内存区域，用于存储线程私有的对象实例。它的作用是减少线程间的竞争，提高对象分配的效率。</p><p>ThreadLocal 是 Java 中的一个类，用于在每个线程中存储和访问线程私有的变量。它提供了一种线程局部变量的机制，使得每个线程都可以拥有自己的变量副本，而不会相互干扰。</p><p>虚拟机中的TLAB和ThreadLocal没有直接的关系，它们分别用于不同的场景和目的。TLAB用于优化对象的分配和内存的管理，而ThreadLocal用于实现线程私有的变量存储。在某些情况下，可以将ThreadLocal变量存储的对象实例放在TLAB中，以达到更好的性能。</p></blockquote><hr><h2 id="垃圾回收-1" tabindex="-1">垃圾回收 <a class="header-anchor" href="#垃圾回收-1" aria-label="Permalink to &quot;垃圾回收&quot;">​</a></h2><h3 id="如何判断对象可以回收" tabindex="-1">如何判断对象可以回收 <a class="header-anchor" href="#如何判断对象可以回收" aria-label="Permalink to &quot;如何判断对象可以回收&quot;">​</a></h3><h4 id="引用计数法" tabindex="-1">引用计数法 <a class="header-anchor" href="#引用计数法" aria-label="Permalink to &quot;引用计数法&quot;">​</a></h4><figure><img src="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20240106141550073.png" alt="image-20240106141550073" loading="lazy" decoding="async" class="lazy"></figure><p>弊端：循环引用。</p><p>A对象引用了B对象，A对象引用计数为1，而B对象引用了A对象，B对象引用计数也为1，并且这两个对象没有谁引用它俩，这种情况是不能被垃圾回收的，它们的引用计数都为1，虽然都不会被引用了，但是它们的引用计数不能归零，导致这两个对象不能够被垃圾回收，就造成内存泄漏问题。早期Python虚拟机进行垃圾回收控制时就是采用了引用计数法，JVM就没有采用这种方法，而是采用了可达性分析算法。</p><hr><h4 id="可达性分析算法" tabindex="-1">可达性分析算法 <a class="header-anchor" href="#可达性分析算法" aria-label="Permalink to &quot;可达性分析算法&quot;">​</a></h4><p>可达性分析算法首先要确定一系列根对象，根对象可以理解为那些肯定不能当成垃圾被回收的对象。在垃圾回收之前，首先对堆内存中的所有对象进行一遍扫描，然后看看每个对象是不是被刚才提到的根对象所直接或间接地引用，如果是这个对象就不能被回收，反之，如果一个对象没有被根对象直接或间接地引用，那么这个对象就可以作为垃圾，将来可以被回收。比如一串葡萄，把葡萄洗干净后提着它的根，根上的葡萄不能回收，摘下来的葡萄就可以被回收</p><ul><li>Java 虚拟机中的垃圾回收器采用可达性分析来探索所有存活的对象</li><li>扫描堆中的对象，看是否能够沿着 GC Root对象（一系列对象） 为起点的引用链找到该对象，找不到，表示可以回收</li></ul><p>使用MemoryAnalyzer抓取GC Root快照</p><ul><li>jps获取Java进程id</li><li><code>jmap -dump:format=b,live,file=文件名 进程id</code></li></ul><figure><img src="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20240106145341790.png" alt="image-20240106145341790" loading="lazy" decoding="async" class="lazy"></figure><p>Native Stack：JVM在执行一些方法调用时它必须调用操作系统方法，操作系统方法在执行时它所引用的一些Java对象也是可以作为根对象，也是不能被垃圾回收的</p><figure><img src="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20240106145907591.png" alt="image-20240106145907591" loading="lazy" decoding="async" class="lazy"></figure><p>Thread：活动线程，活动线程中所使用的对象肯定不能被垃圾回收，线程正在运行，把它所引用的对象给回收了就没法继续运行，线程运行时由一次次的方法调用组成，每次方法调用都会产生一个栈帧，栈帧内所使用的一些“东西”可以作为根对象</p><figure><img src="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20240106152656600.png" alt="image-20240106152656600" loading="lazy" decoding="async" class="lazy"></figure><figure><img src="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20240106150640884.png" alt="image-20240106150640884" loading="lazy" decoding="async" class="lazy"></figure><figure><img src="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20240106153525681.png" alt="image-20240106153525681" loading="lazy" decoding="async" class="lazy"></figure><figure><img src="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20240106154404292.png" alt="image-20240106154404292" loading="lazy" decoding="async" class="lazy"></figure><p>Busy Monitor：Java对象中的同步锁机制，即synchronized关键字，对一个对象加了同步锁，加了锁的对象就不能被垃圾回收，如果它将来被垃圾回收了，谁来解锁呢，对象跟锁都被回收掉了，所以这种加了锁的对象也是可以作为根对象的，它们所引用的其他对象也是需要被保留的</p><figure><img src="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20240106151658417.png" alt="image-20240106151658417" loading="lazy" decoding="async" class="lazy"></figure><hr><h4 id="四种引用" tabindex="-1">四种引用 <a class="header-anchor" href="#四种引用" aria-label="Permalink to &quot;四种引用&quot;">​</a></h4><ol><li>强引用</li></ol><ul><li>只要沿着GC Root引用链能够找到该对象，那么该对象就不会被垃圾回收</li><li>只有所有 GC Roots 对象都不通过【强引用】引用该对象，该对象才能被垃圾回收</li></ul><figure><img src="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20231221180220238.png" alt="image-20231221180220238" loading="lazy" decoding="async" class="lazy"></figure><figure><img src="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20231221180247752.png" alt="image-20231221180247752" loading="lazy" decoding="async" class="lazy"></figure><ol start="2"><li>软引用（SoftReference）</li></ol><ul><li>仅有软引用引用该对象时，在垃圾回收后，内存仍不足时会再次出发垃圾回收，回收软引用对象</li><li>可以配合引用队列来释放软引用自身</li></ul><ol start="3"><li>弱引用（WeakReference）</li></ol><ul><li>仅有弱引用引用该对象时，在垃圾回收时，无论内存是否充足，都会回收弱引用对象</li><li>可以配合引用队列来释放弱引用自身</li></ul><figure><img src="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20231221180304817.png" alt="image-20231221180304817" loading="lazy" decoding="async" class="lazy"></figure><p>软引用与弱引用自身也占用一定内存，如果对它俩占用的内存进一步释放，需使用引用队列来找到它俩，它俩还可能被强引用着，所以在引用队列里依次遍历把它俩占用的内存释放掉</p><ol start="4"><li>虚引用（PhantomReference）</li></ol><ul><li>必须配合引用队列使用，主要配合 ByteBuffer 使用，被引用对象回收时，会将虚引用入队，由 Reference Handler 线程调用虚引用相关方法释放直接内存</li></ul><ol start="5"><li>终结器引用（FinalReference）</li></ol><ul><li>无需手动编码，但其内部配合引用队列使用，在垃圾回收时，终结器引用入队（被引用对象暂时没有被回收），再由Finalizer 线程通过终结器引用找到被引用对象并调用它的 finalize方法，第二次 GC 时才能回收被引用对象</li></ul><figure><img src="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20231221180327244.png" alt="image-20231221180327244" loading="lazy" decoding="async" class="lazy"></figure><p>虚引用对象被回收时，虚引用对象自己就会放入引用队列，从而间接地通过ReferenceHandler线程来调用虚引用对象的方法，然后调用<code>Unsafe.freeMemory方法</code>来释放直接内存</p><figure><img src="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20231221180336772.png" alt="image-20231221180336772" loading="lazy" decoding="async" class="lazy"></figure><p><strong>不使用finalize方法释放内存的理由</strong></p><p>finalize方法工作效率很低，第一次回收时还不能真正给回收掉，而是先把它入队，而且处理引用队列的线程优先级很低，被执行的机会很少，就会导致该对象的finalize方法迟迟不会被调用，该对象占用的内存也迟迟得不到释放；</p><hr><h5 id="场景" tabindex="-1">场景 <a class="header-anchor" href="#场景" aria-label="Permalink to &quot;场景&quot;">​</a></h5><p><strong>软引用</strong></p><figure><img src="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20240107152358548.png" alt="image-20240107152358548" loading="lazy" decoding="async" class="lazy"></figure><ul><li>引用队列清理软引用本身</li></ul><div class="language-java max-h-300px"><button title="Copy code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code v-pre><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">/**</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D"> * 演示软引用, 配合引用队列</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D"> */</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> Demo2_4</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">    private</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> static</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> final</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> _4MB </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> 4</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> *</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> 1024</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> *</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> 1024</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">    public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> static</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> main</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">String</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">[] </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70">args</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">        List&lt;SoftReference&lt;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">byte</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">[]&gt;&gt; list </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> new</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> ArrayList&lt;&gt;();</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">        // 引用队列</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">        ReferenceQueue&lt;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">byte</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">[]&gt; queue </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> new</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> ReferenceQueue&lt;&gt;();</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">        for</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> i </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">; i </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">&lt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> 5</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">; i</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">++</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">            // 关联了引用队列， 当软引用所关联的 byte[]被回收时，软引用自己会加入到 queue 中去</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">            SoftReference&lt;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">byte</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">[]&gt; ref </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> new</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> SoftReference&lt;&gt;(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">new</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> byte</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">[_4MB], queue);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">            System.out.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">println</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(ref.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">get</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">());</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">            list.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">add</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(ref);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">            System.out.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">println</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(list.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">size</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">());</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">        }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">        // 从队列中获取无用的 软引用对象，并移除</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">        Reference&lt;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">?</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> extends</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> byte</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">[]&gt; poll </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> queue.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">poll</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">();</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">        while</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">( poll </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">!=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> null</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">            list.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">remove</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(poll);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">            poll </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> queue.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">poll</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">        }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">        System.out.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">println</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">"==========================="</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">        for</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> (SoftReference&lt;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">byte</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">[]&gt; reference </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> list) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">            System.out.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">println</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(reference.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">get</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">());</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">        }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">}</span></span></code></pre><button class="code-block-unfold-btn"></button></div><p><strong>弱引用</strong></p><ul><li>弱引用一般都是在垃圾回收时就会把一些弱引用对象所占用的内存释放掉，弱引用对象自身占用的内存的释放同样要配合引用队列来实现，具体做法跟软引用非常类似</li></ul><figure><img src="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20240107155825827.png" alt="image-20240107155825827" loading="lazy" decoding="async" class="lazy"></figure><hr><h3 id="垃圾回收算法" tabindex="-1">垃圾回收算法 <a class="header-anchor" href="#垃圾回收算法" aria-label="Permalink to &quot;垃圾回收算法&quot;">​</a></h3><h4 id="标记清除-mark-sweep" tabindex="-1">标记清除（Mark Sweep） <a class="header-anchor" href="#标记清除-mark-sweep" aria-label="Permalink to &quot;标记清除（Mark Sweep）&quot;">​</a></h4><figure><img src="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20231221180344295.png" alt="image-20231221180344295" loading="lazy" decoding="async" class="lazy"></figure><p>​ 内存释放并不会把标记的区域作清零处理，它只需要把对象所占用的内存的起始和结束的地址给记录下来放到一个叫做空闲的地址列表里即可，下次再分配新对象时就到这个空闲的地址列表里找看有没有一块足够的空间容纳这个新对象，如果有就进行一个内存分配，并不会把此区域作清零处理</p><p>优点：速度快，清除操作只需要把垃圾对象的内存的起始和结束地址做一个记录就完成了清除操作，无需再做额外的处理，整个垃圾回收的速度相对比较快</p><p>缺点：容易产生内存碎片，在清除操作完成后，不会对这个空闲的内存空间再做进一步的整理工作了，所以如果分配了一个较大的对象，如数组，数组对象的内存分配需要一段连续空间，就很难塞到比较窄的空间了，总的空闲空间加起来是够的，但是由于空闲空间不连续，这种情况称为内存碎片，造成新对象仍然不能被提供一个有效内存使用，就造成了一个内存溢出问题</p><hr><h4 id="标记整理-mark-compact" tabindex="-1">标记整理（Mark Compact） <a class="header-anchor" href="#标记整理-mark-compact" aria-label="Permalink to &quot;标记整理（Mark Compact）&quot;">​</a></h4><figure><img src="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20231221180351150.png" alt="image-20231221180351150" loading="lazy" decoding="async" class="lazy"></figure><p>​ 标记阶段跟标记清除算法的标记阶段是一样的，也是对堆中这些对象进行标记，看看哪些对象是垃圾，那些没有被GC Root引用的对象就会作为垃圾，区别是在第二阶段是整理阶段而不是清除阶段， 所谓的整理就是避免在标记清除算法产生的内存碎片问题，在清除垃圾的过程中，它会把可用的对象向前移动，让内存更为紧凑，整理之后，垃圾就会被清除，那连续的空间就更多了，就不会造成标记清除时产生的内存碎片问题</p><p>优点：没有内存碎片</p><p>缺点：整理阶段就会牵扯到对象的移动，效率就会偏低，速度较慢（图中红字）</p><hr><h4 id="复制-copy" tabindex="-1">复制（Copy） <a class="header-anchor" href="#复制-copy" aria-label="Permalink to &quot;复制（Copy）&quot;">​</a></h4><figure><img src="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20231221180406766.png" alt="image-20231221180406766" loading="lazy" decoding="async" class="lazy"></figure><p>​ 复制算法比较特殊，它是把内存区域划分为大小相等的两块区域，左边区域称为FROM，右边为TO，TO区域始终空闲着，里面一个对象都没有。首先还是先做标记，找到那些不被GC Root引用的对象标记为垃圾，然后把FROM区域中那些尚存活的对象给它们复制到TO区域中，复制完成后FROM区域就全都是垃圾了，就可以一下子清空了，并且交换FROM和TO的位置，即原来的FROM变为TO，原来的TO变为FROM</p><p>优点：不会产生内存碎片</p><p>缺点：会占用双倍的内存空间</p><hr><h4 id="总结" tabindex="-1">总结 <a class="header-anchor" href="#总结" aria-label="Permalink to &quot;总结&quot;">​</a></h4><p>这三种算法实际在JVM的垃圾回收机制中，都会根据不同的情况来采用，不会只有其中一种算法，它会结合其中多种算法来共同实现这个垃圾回收的，就是接下来的分代垃圾回收机制</p><hr><h3 id="分代垃圾回收" tabindex="-1">分代垃圾回收 <a class="header-anchor" href="#分代垃圾回收" aria-label="Permalink to &quot;分代垃圾回收&quot;">​</a></h3><figure><img src="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20231221180415723.png" alt="image-20231221180415723" loading="lazy" decoding="async" class="lazy"></figure><p>​ 分代垃圾回收机制把整个堆内存（大的区域）划分为两块，一个叫新生代，一个叫老年代，新生代又进一步划分为三个小的区域，分别叫伊甸园、幸存区From和幸存区To，这么划分的原因主要是在Java中有的对象可能需要长时间使用，长时间使用的对象就把它放到老年代中，而那些用完就可以丢弃的对象就放到新生代中，这样的话就可以针对这个对象生命周期的不同特点进行不同的垃圾回收策略，老年代的垃圾回收很久才发生一次，而新生代的垃圾回收就发生的比较频繁，新生代处理的都是那些朝生夕死的对象，而老年代处理的都是那些更有价值而长时间存活的，这样针对不同的区域采用不同的算法就可以更有效地对垃圾回收进行一个管理。</p><p>​ 打个比方，一栋居民楼（Java中的堆内存），居民楼中每家每户每天都要产生一些垃圾，这个垃圾信息我们需要一个保洁工人来进行一个处理，如果每家每户都打扫显然效率和时间不可接受，在现实生活中都会在楼下设一个专门丢弃垃圾的垃圾场（新生代），垃圾场的垃圾就是那些<strong>生命周期更短的垃圾</strong>，如盒饭、纸巾等，保洁工人只需每天打扫一次即可（Minor GC），每家每户存储的垃圾（老年代），如用久的椅子不想扔就暂存在家里，将来等到家里空间放不下了，就叫保洁工人来一次大清理（Full GC），把那些无用的垃圾清理掉，耗时就比较长了，当然执行的频率也比较低，因为垃圾场每天清理一次就够了，而每家每户的垃圾相对更有价值一些，需等到整个空间不足时才去清理。</p><p><strong>分代垃圾回收机制</strong></p><ul><li>Minor GC：</li></ul><p>​ 当我们创建一个新的对象时，那么这个新的对象默认情况就会采用伊甸园的一块空间（伊甸园就是人类始祖亚当夏娃诞生的地方，那么我们的对象也是诞生在伊甸园中），接下来会有更多的对象被创建，它们都被分配到这个伊甸园当中，伊甸园逐渐地被占满了，当我们再创建一个对象时，这个伊甸园空间就不够了，容纳不下了，这个时候就会触发一次新生代的Minor GC，Minor GC触发以后就会采用可达性分析算法沿着GC Root引用链去找看哪些对象是有用还是可以作为垃圾，先进行一次标记动作，标记成功了就采用复制算法把存活的对象复制到幸存区To中，存活对象复制到To区域后会让其寿命加1，刚开始寿命是0，现在经历了一次垃圾回收还幸存下来不死它们的寿命就加1，伊甸园的对象就可以回收掉了，做完复制操作以后同样将幸存区To与幸存区From的位置交换。</p><p>​ 第一次垃圾回收后，空间就充足了，可以向伊甸园分配一些对象，刚才放不下的对象就放进去了，类似的又分配一大堆对象进去，等伊甸园又满了就触发第二次Minor GC，第二次垃圾回收除了要找到伊甸园中存活的对象以外，还要到幸存区中看看有没有需要继续存活的对象，幸存区中也一样，它也不是第一次经过了垃圾回收不死，第二次仍然存活的，也许第二次回收时它已经没用了，这个时候就会把第二次垃圾回收时幸存的对象复制到幸存区To里，寿命加1，如果幸存区From中有对象也存活了，也复制到幸存区To中，寿命加1变为2，然后把伊甸园中的对象清理掉，和幸存区From没用的对象也清理掉，同样两个幸存区的位置交换，这样新对象就可以继续放入伊甸园了。当然，幸存区中的对象不会永远在幸存区中，当它的寿命超过了一个阈值，即经历了15次垃圾回收后仍活着，说明这个对象价值较高，经常在使用，就没必要一直将它留在幸存区中了，因为它还在幸存区中留着，以后再进行垃圾回收时还是不能回收它，所以这个对象的寿命如果超过一个阈值15了，就把它晋升到老年代去，因为老年代垃圾回收频率比较低，不会轻易把它回收掉，像这种价值较高的对象就从幸存区中把它晋升到老年代去。</p><p>​ minor gc 会引发 stop the world，暂停其它用户的线程，等垃圾回收结束，用户线程才恢复运行</p><ul><li>Full GC：</li></ul><p>​ 将来老年代晋升的对象多了，也把老年代空间占满呢？有这么一种情况，新生代放的对象也挺多了，老年代放的对象也挺多了，几乎全满，这个时候会一个新的对象往新生代的伊甸园区放不下了，From区域也放不下了，老年代也放不下了，这个时候就会触发一次Full GC，这个垃圾回收动作都是在空间不足时才会触发的。Full GC就是当老年代的空间不足，当然会长时间回收新生代内存，当新生代内存不够时就会尝试触发这个Full GC来触发这个老年代的垃圾回收，老年代的垃圾回收就会做一次整个清理，从新生代到老年代</p><figure><img src="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20231221180424559.png" alt="image-20231221180424559" loading="lazy" decoding="async" class="lazy"></figure><p>stop the world：在发生垃圾回收时，必须暂停其他的用户线程，由垃圾回收线程（守护）来完成垃圾回收的动作，当把这些要处理的对象都从伊甸园和幸存区From拷贝到幸存区To以后，垃圾回收的动作都做完了，其他的用户线程才能继续运行。这样做的原因是在垃圾回收的过程中会牵扯到对象的复制，对象的地址会发生改变，这种情况下如果多个线程都在同时运行，这样就造成了一个混乱，对象都移动了，其他线程再访问这个对象地址根据原来的地址就找不到了，因此minor gc 会引发 stop the world，暂停其它用户的线程，等垃圾回收结束，用户线程才恢复运行，minor gc暂停的时间非常的短，因为新生代本身大部分对象都是垃圾，都会被回收掉，复制的对象只有很少一部分，所以标记和复制的暂停时间并不长</p><p>​ 当对象寿命超过阈值时，会晋升至老年代，最大寿命是15（4bit），因为寿命是保存在每个对象的对象头中，其中存寿命的部分是4bit（0000 ~ 1111），不设得更大的原因是1、没有意义的；2、对象头比较精贵，每个bit都有各自的用途，不能把所有的空间都留给寿命存储。不同的垃圾回收器阈值也不一样，有的时候当空间紧张时，也许对象寿命还没有到15，当幸存区空间紧张时对象也会提前晋升到老年代去</p><p>​ 当老年代空间不足，会先尝试触发 minor gc，如果之后空间仍不足，那么触发 full gc，STW的时间更长，因为老年代采用的回收算法跟新生代是不一样的，新生代是一种复制算法，老年代因为存活的对象比较多，整理起来或清除起来比较慢，另外，采用的算法可能是标记+清除或标记+整理，标记+清除就好点，速度比较快，标记+整理速度就比较慢，再者，老年代的对象都不是那么容易被当成垃圾回收，所以回收的效率相对的更低，回收时间相对也更长，STW时间也会更长，full gc结束后若老年代空间仍然不足，内存分配失败就会触发OutOfMemory：java heap space</p><hr><h4 id="相关-vm-参数" tabindex="-1">相关 VM 参数 <a class="header-anchor" href="#相关-vm-参数" aria-label="Permalink to &quot;相关 VM 参数&quot;">​</a></h4><table><thead><tr><th style="text-align:left">含义</th><th style="text-align:left">参数</th></tr></thead><tbody><tr><td style="text-align:left">堆初始大小</td><td style="text-align:left"><code>-Xms</code></td></tr><tr><td style="text-align:left">堆最大大小</td><td style="text-align:left"><code>-Xmx</code> 或 <code>-XX:MaxHeapSize=size</code></td></tr><tr><td style="text-align:left">新生代大小</td><td style="text-align:left"><code>-Xmn</code> 或 <code>(-XX:NewSize=size + -XX:MaxNewSize=size )</code></td></tr><tr><td style="text-align:left">幸存区比例（动态）</td><td style="text-align:left"><code>-XX:InitialSurvivorRatio=ratio</code> （初始化幸存区比例）和 <code>-XX:+UseAdaptiveSizePolicy</code>（开启动态的开关，开启后就会动态调整新生代中伊甸园和幸存区的比例）</td></tr><tr><td style="text-align:left">幸存区比例</td><td style="text-align:left"><code>-XX:SurvivorRatio=ratio</code>（默认值是8，新生代假设为10M内存，其中8M是划给伊甸园的，剩下2M是二等份，一份给From，一份给To）</td></tr><tr><td style="text-align:left">晋升阈值</td><td style="text-align:left"><code>-XX:MaxTenuringThreshold=threshold</code>（调整新生代中对象的晋升阈值，默认值跟垃圾回收器有关，有的是15，有的是6）</td></tr><tr><td style="text-align:left">晋升详情</td><td style="text-align:left"><code>-XX:+PrintTenuringDistribution</code></td></tr><tr><td style="text-align:left">GC详情</td><td style="text-align:left"><code>-XX:+PrintGCDetails -verbose:gc</code></td></tr><tr><td style="text-align:left">FullGC 前 MinorGC</td><td style="text-align:left"><code>-XX:+ScavengeBeforeFullGC</code>（FullGC前是否要做一次MinorGC，减少一些不必要的对象，这样会加速FullGC的进度，默认是打开的）</td></tr></tbody></table><blockquote><p>幸存区比例还有一种是动态调整的，在某些垃圾回收器下，需要动态调整幸存区的比例，也就是不用我们自己去控制它到底是8-1-1还是6-2-2</p></blockquote><hr><h4 id="案例分析" tabindex="-1">案例分析 <a class="header-anchor" href="#案例分析" aria-label="Permalink to &quot;案例分析&quot;">​</a></h4><p>下图是在指定JVM参数下运行没有任何代码、加入不同大小的对象的main方法的堆内存的占用情况</p><ul><li>0行代码</li></ul><figure><img src="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20240110193251171.png" alt="image-20240110193251171" loading="lazy" decoding="async" class="lazy"></figure><ul><li>加入7M的对象</li></ul><figure><img src="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20240110195052490.png" alt="image-20240110195052490" loading="lazy" decoding="async" class="lazy"></figure><ul><li><code>7M + 512k</code></li></ul><figure><img src="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20240110195515243.png" alt="image-20240110195515243" loading="lazy" decoding="async" class="lazy"></figure><ul><li><code>7M + 512k*2</code></li></ul><figure><img src="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20240110200558836.png" alt="image-20240110200558836" loading="lazy" decoding="async" class="lazy"></figure><ul><li>8M</li></ul><figure><img src="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20240110201208986.png" alt="image-20240110201208986" loading="lazy" decoding="async" class="lazy"></figure><ul><li><code>8M*2</code></li></ul><figure><img src="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20240110202117772.png" alt="image-20240110202117772" loading="lazy" decoding="async" class="lazy"></figure><ul><li><strong>子线程</strong>下加入<code>8M*2</code>抛出的OOM不会导致主线程结束（线程对象也占用一定内存）</li></ul><figure><img src="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20240110202517160.png" alt="image-20240110202517160" loading="lazy" decoding="async" class="lazy"></figure><figure><img src="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20231221180432877.png" alt="image-20231221180432877" loading="lazy" decoding="async" class="lazy"></figure><blockquote><p>线程和线程之间是隔离的，但是堆是共享的，子线程放入第二个8mb的对象时，报错死亡，但是主线程后续并没有继续放入新的对象；</p><p>子线程内存溢出抛出的异常跟所有其他的异常其实是一样的，所以不会让主线程停止运行，而主线程的堆状态是跟子线程抛出异常时相同的，因为它们共用堆内存，看程序运行结束的堆状态信息也能体现这一点；</p><p>堆是共享的，但是线程死亡之后对堆的改变如果没有被其他使用，那改变的内存是可以被作为垃圾的；</p><p>此时主线程堆内存状态和子线程一样，是分配失败后进行过两次GC之后的状态；</p><p>子线程里放入大对象时，发现继续放入会造成内存泄漏，所以最后这个8mb对象就没有放入，但还是会给程序反馈报异常，主线程依然可以使用堆内存；</p><p>当一个线程抛出OOM异常后，它所占据的内存资源并不会马上全部被释放掉，而是失去引用，可以被垃圾回收，从而不会影响其他线程的运行。</p></blockquote><hr><h3 id="垃圾回收器" tabindex="-1">垃圾回收器 <a class="header-anchor" href="#垃圾回收器" aria-label="Permalink to &quot;垃圾回收器&quot;">​</a></h3><ol><li><p>串行</p><ul><li>单线程（在垃圾回收发生时，其他线程都暂停，由一个线程来完成垃圾回收）</li><li>堆内存较小，适合个人电脑（CPU核数少的）</li></ul></li><li><p>吞吐量优先（吞吐量 = 运行用户代码时间 /（运行用户代码时间 + 垃圾收集时间））</p><ul><li>多线程</li><li>堆内存较大，多核 cpu（服务器电脑）</li><li>让单位时间内，STW 的时间最短 0.2 0.2 = 0.4，垃圾回收时间占比最低，这样就称吞吐量高</li></ul></li><li><p>响应时间优先</p><ul><li><p>多线程</p></li><li><p>堆内存较大，多核 cpu</p></li><li><p>尽可能让单次 STW 的时间最短 0.1 0.1 0.1 0.1 0.1 = 0.5</p></li></ul></li></ol><blockquote><p>虽然有多个线程，但假设只有一个CPU，工作的时候多个线程轮流去争抢单核CPU的时间片，其实这个效率还不如单线程，就好比有多个保洁工人，但扫帚只有一把，那他们打扫卫生必须轮流使用这把扫帚，那这个效率显然跟一个人打扫的效率是一样的；</p><p>吞吐量指的是正常业务吞吐量要大；响应时间指的正常业务每次被打扰时间要短；</p><p>一个着重于垃圾回收次数，一个着重于每次垃圾回收的速度。</p></blockquote><hr><h4 id="串行" tabindex="-1">串行 <a class="header-anchor" href="#串行" aria-label="Permalink to &quot;串行&quot;">​</a></h4><p>Serial：新生代，复制算法；SerialOld：老年代，标记+整理算法</p><p>新生代和老年代的垃圾回收器是分别运行的，比如新生代内存不足，它是使用Serial来完成垃圾回收，等老年代空间不足，Serial完成新生代的Minor GC，SerialOld完成老年代的Full GC</p><figure><img src="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20231221180449859.png" alt="image-20231221180449859" loading="lazy" decoding="async" class="lazy"></figure><hr><h4 id="吞吐量优先" tabindex="-1">吞吐量优先 <a class="header-anchor" href="#吞吐量优先" aria-label="Permalink to &quot;吞吐量优先&quot;">​</a></h4><p><code>-XX:+UseParallelGC ~ -XX:+UseParallelOldGC</code>这两个开关在jdk1.8默认是开启的</p><p>ParallelGC：新生代<strong>并行</strong>垃圾回收器，复制算法；ParallelOldGC：老年代<strong>并行</strong>垃圾回收器，标记+整理算法</p><p>这两个开关只有开启其中一个，另一个也会同时开启</p><figure><img src="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20231221180458102.png" alt="image-20231221180458102" loading="lazy" decoding="async" class="lazy"></figure><blockquote><p>多个用户线程到达安全点停下来后，这时垃圾回收器会开启多个线程来进行垃圾回收，垃圾回收线程的个数默认情况下跟CPU核数相关，只要CPU核数小于一个值时，那这个线程数就跟CPU核数是一样的了，如图中4核CPU，将来就会开启4个垃圾回收线程来完成回收的工作，回收结束后再恢复其他线程的一个运行；</p><p>4核CPU都去忙垃圾回收了，所以在垃圾回收的过程中，CPU的占用率一下子会飙到100%，如果下次又遇到垃圾回收时又会飙到100%，这是此垃圾回收器在垃圾回收发生时对CPU利用率的一个影响，多个CPU要发挥它们的性能，大家一起上，赶紧把垃圾回收的工作做完好恢复其他用户线程的运行完成后续工作；</p><p>ParallelGC的一个特点是可以根据一个目标设置ParallelGC的工作方式：<code>-XX:+UseAdaptiveSizePolicy</code>（自适应大小调整策略）、<code>-XX:GCTimeRatio=ratio</code>（主要调整吞吐量）、<code>-XX:MaxGCPauseMillis=ms</code>（调整暂停时间）；ParallelGC 比较智能，它可以根据你的一个设定目标（目标1与目标2）来尝试去调整堆的大小来达到你期望的那个目标。</p></blockquote><hr><h4 id="响应时间优先" tabindex="-1">响应时间优先 <a class="header-anchor" href="#响应时间优先" aria-label="Permalink to &quot;响应时间优先&quot;">​</a></h4><p>ConcMarkSweep：并发+标记+清除</p><p>​ Concurrent并发的含义是指垃圾回收器在工作的同时，其他用户线程也能同时运行，就是用户线程和垃圾回收线程是并发执行的，都要抢占CPU，而Parallel并行的含义是指是多个垃圾回收器它们并行运行，但在垃圾回收期间它不允许其他的用户线程继续运行（STW），这样的话，那CMSGC它在某些时刻能够起到一个并发的效果，也就是它在工作的同时用户线程也能工作，这样就进一步减少STW的时间，当然它垃圾回收的某几个阶段还是需要STW，但是在垃圾回收的其中一些阶段是不需要STW的，它可以跟用户线程并发执行，CMSGC是工作在老年代的垃圾回收器</p><p>并发失败由CMSGC并发垃圾回收器退化到SerialOld单线程垃圾回收器</p><figure><img src="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20231221180506072.png" alt="image-20231221180506072" loading="lazy" decoding="async" class="lazy"></figure><p>​ 首先多个CPU开始并行执行，当老年代发生内存不足，那么执行线程都达到了安全点暂停下来了，暂停下来以后CMSGC就开始工作了，执行一个初始标记的动作，在这个初始标记动作的时候仍然需要STW，即其他用户线程阻塞暂停起来，因为初始标记很快就完成了，不会把堆内存所有的对象都列一遍，只会标记一些根对象，暂停时间非常短，等这个初始标记完成以后，接下来用户线程就可以恢复运行了，与此同时垃圾回收线程还可以继续并发标记，把剩余的那些垃圾找出来，这个时候是跟用户线程并发执行的，不用STW，所以此时响应时间很短，几乎不影响用户线程的工作，等到并发标记完成后，还要做一步重新标记，这一步又要STW，这是因为并发标记的同时用户线程也在工作，用户线程工作的时候有可能产生一些新的对象，改变一些对象的引用，就可能对垃圾回收做一些干扰，所以等到并发标记结束以后还要做一遍重新标记的工作，等重新标记完了，用户线程又可以恢复运行，这时垃圾回收线程再做一次并发清理。CMSGC整个工作阶段只有在初始标记和重新标记会造成STW，其他阶段都是并发执行的，所以它的响应时间非常得短，是一个响应时间优先的老年代垃圾回收器。</p><p>​ 初始标记的并发线程数受<code>-XX:ParallelGCThreads=n ~ -XX:ConcGCThreads=threads</code>两个参数影响，ParallelGCThreads指并行的垃圾回收线程数，一般跟你的CPU核数一样，图中n=4，但并发的线程数通过ConcGCThreads设置，一般这个参数建议设置为并行线程数的1/4，即4核CPU，那它的值就是1。</p><p>​ CMSGC对CPU的占用不如ParallelGC的占用高，如4核CPU它只占了1核作为垃圾回收，对CPU的占用并不高，但是用户线程也在运行时就满足4核CPU都能使用上，但是其中1核CPU被垃圾回收线程占用了，所以用户工作线程只能占用原来的3/4，所以对整个应用程序的吞吐量是有影响的…</p><p>​ CMSGC在工作的过程中执行并发清理时，由于其他的用户线程还可以继续运行，其他的用户线程在运行的同时可能又会产生一些新的垃圾，所以这个并发清理的同时不能把一些新的垃圾干掉，所以得等到下一次垃圾回收时再清理这些新产生的垃圾，这些新垃圾称之为<strong>浮动垃圾</strong>，这些浮动垃圾得等到下次做垃圾回收时才能清理掉，但是就带来一个问题，因为在垃圾回收的过程中可能产生新的垃圾，它就不能想其他的垃圾回收器那样等到整个堆内存不足了才做垃圾回收，那样的话这些新垃圾就没处放了，所以要预留一些空间来保留这些浮动垃圾，由参数<code>-XX:CMSInitiatingOccupancyFraction=percent</code>控制CMSGC垃圾回收的时机，其含义是执行CMSGC垃圾回收的内存占比。</p><p>​ 在重新标记阶段有一个特殊的场景，有可能新生代的一些对象会引用老年代的对象，如果在这个时候重新标记就会扫描整个堆，通过新生代去引用扫描一遍老年代的对象，做可达性分析，这样的话对性能影响会有些大，新生代创建的对象个数比较多，其中很多本身是作为垃圾的，如果再从新生代来找老年代，就算是找到了将来新生代的垃圾也会被回收掉，相当于在回收前多做了一些无用的查找工作，可以用参数<code>-XX:+CMSScavengeBeforeRemark</code>来避免此现象发生。</p><p>​ CMSGC有一个特点是在内存碎片比较多的时候，因为它是一种标记+清除算法，可能产生比较多的内存碎片，这样的话就会造成将来分配对象时Minor GC不足，结果老年代由于碎片过多也不足，则会造成由于碎片过多而并发失败，CMSGC就不能正常工作了，这时这个垃圾回收器就会退化为SerialOld，做一次单线程串行的垃圾回收，做一些整理，等碎片减少了才能继续恢复工作，一旦发生这种并发失败问题，垃圾回收的时间就会一下子飚上来，这是CMSGC的一个最大问题，垃圾回收的时间会一下子变得很长，导致本来是一个响应时间优先的垃圾回收器，结果响应时间一下子变得很长，这样就给用户带来不好的体验。</p><hr><h4 id="g1-garbage-first-one" tabindex="-1">G1（Garbage First/One） <a class="header-anchor" href="#g1-garbage-first-one" aria-label="Permalink to &quot;G1（Garbage First/One）&quot;">​</a></h4><p>G1是一款比较有年头的垃圾回收器，只是一直不太成熟，到最近其技术有一些突破才被广泛应用起来；</p><p>JDK9一个重要改进就是已经废弃了之前的CMSGC，由G1取代CMSGC成为JDK9默认的垃圾回收器</p><figure><img src="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20231221180513683.png" alt="image-20231221180513683" loading="lazy" decoding="async" class="lazy"></figure><p>G1可以在用户线程工作的同时垃圾回收线程也能并发的执行，也可以设置一个参数<code>-XX:MaxGCPauseMillis=time</code>来设置暂停目标，默认200ms，是一种低延迟效果，当然也可以把目标设高些来提升吞吐量</p><hr><h5 id="_1-g1-垃圾回收阶段" tabindex="-1">1）G1 垃圾回收阶段 <a class="header-anchor" href="#_1-g1-垃圾回收阶段" aria-label="Permalink to &quot;1）G1 垃圾回收阶段&quot;">​</a></h5><p>G1 垃圾回收的三个阶段是参考oracle工程师的一个说法</p><figure><img src="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20231221180521473.png" alt="image-20231221180521473" loading="lazy" decoding="async" class="lazy"></figure><hr><h5 id="_2-young-collection" tabindex="-1">2）Young Collection <a class="header-anchor" href="#_2-young-collection" aria-label="Permalink to &quot;2）Young Collection&quot;">​</a></h5><p>刚开始这些划分的区域都是白色的，表示空闲的区域</p><figure><img src="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20231221180615496.png" alt="image-20231221180615496" loading="lazy" decoding="async" class="lazy"></figure><figure><img src="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20231221180535182.png" alt loading="lazy" decoding="async" class="lazy"></figure><figure><img src="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20231221180627374.png" alt="image-20231221180627374" loading="lazy" decoding="async" class="lazy"></figure><hr><h5 id="_3-young-collection-cm" tabindex="-1">3）Young Collection + CM <a class="header-anchor" href="#_3-young-collection-cm" aria-label="Permalink to &quot;3）Young Collection + CM&quot;">​</a></h5><p>初始标记：找到那些根对象并标记，在新生代GC发生STW时会对根对象做初始标记</p><p>并发标记：从根对象出发，顺着GC Root引用链找到其他的引用对象并标记</p><figure><img src="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20231221180634904.png" alt="image-20231221180634904" loading="lazy" decoding="async" class="lazy"></figure><p><code>-XX:InitiatingHeapOccupancyPercent=percent</code>设置为45%时，当老年代区域（O）占整个堆内存的45%时就开始并发标记</p><hr><h5 id="_4-mixed-collection" tabindex="-1">4）Mixed Collection <a class="header-anchor" href="#_4-mixed-collection" aria-label="Permalink to &quot;4）Mixed Collection&quot;">​</a></h5><p>​ 旧的老年代区域将无用对象采用复制算法复制到新的老年代区域，有大量对象由一个区复制到另一个区，时间较长，就达不到参数<code>-XX:MaxGCPauseMillis=ms</code>控制最大暂停时间的目标值了，为达到此目标，G1就会从这些老年代区域了挑出那些回收价值最高的区域，也就是挑出的区域如果回收了能够释放的空间比较多，那就只挑其中一部分区域来进行一个垃圾回收，这样的话复制的区域就少了，自然暂停时间的目标值就能达到了，需要垃圾回收的时间就变短了，当然，如果要复制的对象没那么多，且暂停时间的目标也能达到，就会把所有的老年代区域都进行一个复制工作，一方面是为了保留那些存活对象，另一方面是为了整理内存减少空间碎片，这是混合收集的工作方式，这就解释了问什么官方要叫Garbage First了，它是在混合收集阶段优先要回收那些垃圾最多的区域，主要的目的就是达到暂停时间短的目标</p><p>最终标记完成了，就会对存活的对象进行一个拷贝（对老年代来讲不是所有的老年代区域的都拷贝，是先回收那些回收价值最高、能够释放较多空间的区域，然后再进行剩余老年代区域的拷贝（红色区域））</p><figure><img src="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20231221180643619.png" alt="image-20231221180643619" loading="lazy" decoding="async" class="lazy"></figure><hr><h5 id="_5-full-gc" tabindex="-1">5）Full GC <a class="header-anchor" href="#_5-full-gc" aria-label="Permalink to &quot;5）Full GC&quot;">​</a></h5><ul><li>SerialGC（串行）<ul><li>新生代内存不足发生的垃圾收集 - minor gc</li><li>老年代内存不足发生的垃圾收集 - <strong>full gc</strong></li></ul></li><li>ParallelGC（并行）<ul><li>新生代内存不足发生的垃圾收集 - minor gc</li><li>老年代内存不足发生的垃圾收集 - <strong>full gc</strong></li></ul></li><li>CMS（并发）<ul><li>新生代内存不足发生的垃圾收集 - minor gc</li><li>老年代内存不足</li></ul></li><li>G1（并发）<ul><li>新生代内存不足发生的垃圾收集 - minor gc</li><li>老年代内存不足</li></ul></li></ul><figure><img src="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20231221180655683.png" alt="image-20231221180655683" loading="lazy" decoding="async" class="lazy"></figure><p>G1：并发垃圾收集阶段（回收速度比新产生的垃圾快），虽有暂停，重新标记和最后数据拷贝的过程还会有暂停，暂停时间相对较短，还称不上full gc。判断依据是观察GC日志，打印出Full GC字样才触发了Full GC。G1或CMS工作在并发收集阶段，回收速度高于垃圾产生速度，后台的回收日志里是不会有Full GC的字样的。</p><hr><h5 id="_6-young-collection-跨代引用" tabindex="-1">6）Young Collection 跨代引用 <a class="header-anchor" href="#_6-young-collection-跨代引用" aria-label="Permalink to &quot;6）Young Collection 跨代引用&quot;">​</a></h5><p>新生代垃圾回收的过程：首先找到根对象，根对象可达性分析再找到存活对象，存活对象进行复制操作至幸存区，这里就有一个问题就是要找这个新生代对象的根对象，通过根对象进行一个查找，那首先要找根对象，根对象有一部分来自老年代…</p><figure><img src="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20231221180703990.png" alt="image-20231221180703990" loading="lazy" decoding="async" class="lazy"></figure><p>标记为脏卡后，做GC Root遍历时就不用去找整个老年代了，只需关注这些脏卡对象或区域</p><figure><img src="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20231221180726120.png" alt="image-20231221180726120" loading="lazy" decoding="async" class="lazy"></figure><p>新生代垃圾收集时，跨代引用是利用卡表和Remember Set的技术加速新生代的垃圾回收</p><hr><h5 id="_7-remark" tabindex="-1">7）Remark <a class="header-anchor" href="#_7-remark" aria-label="Permalink to &quot;7）Remark&quot;">​</a></h5><figure><img src="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20231221180748263.png" alt="image-20231221180748263" loading="lazy" decoding="async" class="lazy"></figure><figure><img src="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20231221180801833.png" alt="image-20231221180801833" loading="lazy" decoding="async" class="lazy"></figure><p>​ 图中B首先为灰色，由于有强引用引用着它，所以最终会变为黑色而存活，当处理到C时，因为处于并发标记阶段，这就意味着同时有其他用户线程对对象的引用做修改，把B对C的引用给断了，那处理完B就处理C了，这时GC发现B与C之间已经没有联系了，所以处理到C时就会进行一个标记表明C将来是白色，等整个并发标记结束以后，C由于仍然是白色最终会被当做垃圾被回收掉，这是情况一；在C与B处理完以后，并发标记可能还没有结束，这时用户线程又改变了C的引用地址，把C对象当成A对象的属性作为一次赋值操作，C的引用又发生改变了，这个时候问题就来了，因为C之前已经处理过了，GC认为C已经是白色的了，那A又是黑色的，已经处理过了，以后不会处理它了，所以等到整个并发标记结束以后C就被遗漏了，GC仍然认为C是白色的，是垃圾，就把它给回收掉了，这样就不对了，因为这时有一个强引用引用着C，那再把它回收掉的话，这个伤害就大了，所以要对对象的引用做进一步的检查，即Remark重新标记阶段，就是为了防止这样的现象发生的。具体的做法是当对象的引用发生改变时，JVM就会给它加一个<strong>写屏障</strong>，写屏障就是只要你的对象引用发生改变，那这个写屏障的代码就会被执行。如刚才C的引用给A的其中一个属性，那么C的引用就发生了变化，这时写屏障的指令就会被执行，指令会把C加入到一个队列中，并且把C由白色变为灰色表示还没有处理完，等整个并发标记结束了，接下来进入重新标记阶段，会进行STW，让其他用户线程都暂停，这时重新标记的线程就会从这个队列中把队列中的对象一个个取出来再做一次检查，若发现是灰色的，那还要做进一步的判断处理，结果会发现A强引用着C，因此还应该把C变为黑色，这样C对象就不会被误当成垃圾被回收掉了。</p><p>Remark：采用一个<code>pre-write barrier</code>写屏障技术，在对象的引用被改变前把对象加入到一个队列<code>satb_mark_queue</code>里表示未被处理的，将来Remark阶段就可以配合这个队列来对这些对象做进一步的判断</p><hr><h5 id="_8-jdk-8u20-字符串去重" tabindex="-1">8）JDK 8u20 字符串去重 <a class="header-anchor" href="#_8-jdk-8u20-字符串去重" aria-label="Permalink to &quot;8）JDK 8u20 字符串去重&quot;">​</a></h5><ul><li>优点：节省大量内存</li><li>缺点：略微多占用了 cpu 时间，新生代回收时间略微增加<ul><li>在总的性能来看，此功能带来的收益是远远高于它所占用的CPU时间和新生代垃圾回收的时间的</li></ul></li></ul><p><code>-XX:+UseStringDeduplication</code>开启字符去重功能，默认开启</p><div class="language-java max-h-300px"><button title="Copy code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code v-pre><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">String s1 </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> String</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">"hello"</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">); </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">// char[]{'h','e','l','l','o'}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">String s2 </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> String</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">"hello"</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">); </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">// char[]{'h','e','l','l','o'}</span></span></code></pre><button class="code-block-unfold-btn"></button></div><ul><li>将所有新分配的字符串放入一个队列</li><li>当新生代回收时，G1并发检查是否有字符串重复</li><li>如果它们值一样，让它们引用同一个 <code>char[]</code></li><li>注意，与 <code>String.intern()</code> 不一样<ul><li><code>String.intern()</code> 关注的是字符串对象</li><li>而字符串去重关注的是 <code>char[]</code></li><li>在 JVM 内部，使用了不同的字符串表</li></ul></li></ul><hr><h5 id="_9-jdk-8u40-并发标记类卸载" tabindex="-1">9）JDK 8u40 并发标记类卸载 <a class="header-anchor" href="#_9-jdk-8u40-并发标记类卸载" aria-label="Permalink to &quot;9）JDK 8u40 并发标记类卸载&quot;">​</a></h5><figure><img src="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20231221180813454.png" alt="image-20231221180813454" loading="lazy" decoding="async" class="lazy"></figure><hr><h5 id="_10-jdk-8u60-回收巨型对象" tabindex="-1">10）JDK 8u60 回收巨型对象 <a class="header-anchor" href="#_10-jdk-8u60-回收巨型对象" aria-label="Permalink to &quot;10）JDK 8u60 回收巨型对象&quot;">​</a></h5><p>G1希望巨型对象越早回收越好，最好是在新生代垃圾回收时就把它处理掉</p><figure><img src="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20231221180823360.png" alt="image-20231221180823360" loading="lazy" decoding="async" class="lazy"></figure><hr><h5 id="_11-jdk-9-并发标记起始时间的调整" tabindex="-1">11）JDK 9 并发标记起始时间的调整 <a class="header-anchor" href="#_11-jdk-9-并发标记起始时间的调整" aria-label="Permalink to &quot;11）JDK 9 并发标记起始时间的调整&quot;">​</a></h5><p>JDK9对G1这个垃圾回收器有很多的功能增强，其中一项比较重要的是它并发标记时间的一个调整，G1也会面临一个Full GC的问题，如果垃圾回收的速度跟不上垃圾产生的速度，最终也会退化为Full GC的，之前说G1垃圾回收时Full GC是单线程其实不太正确，在现在G1版本中，即使是Full GC也早已变成了多线程，但Full GC它STW的时间肯定更长，所以还是要尽可能得避免Full GC的发生，因此可以提前让垃圾回收开始，让并发标记、混合收集提前开始，这样就能够减少Full GC发生的几率。</p><p>动态调整<code>-XX:InitiatingHeapOccupancyPercent</code>可以尽可能避免并发垃圾回收退化为Full GC</p><figure><img src="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20231221180845089.png" alt="image-20231221180845089" loading="lazy" decoding="async" class="lazy"></figure><hr><h5 id="_12-jdk-9-更高效的回收" tabindex="-1">12）JDK 9 更高效的回收 <a class="header-anchor" href="#_12-jdk-9-更高效的回收" aria-label="Permalink to &quot;12）JDK 9 更高效的回收&quot;">​</a></h5><ul><li>250+增强</li><li>180+bug修复</li><li><a href="https://docs.oracle.com/en/java/javase/12/gctuning" target="_blank" rel="noreferrer">https://docs.oracle.com/en/java/javase/12/gctuning</a></li></ul><hr><h3 id="垃圾回收调优" tabindex="-1">垃圾回收调优 <a class="header-anchor" href="#垃圾回收调优" aria-label="Permalink to &quot;垃圾回收调优&quot;">​</a></h3><ul><li><p>预备知识</p><ul><li><p>掌握 GC 相关的 VM 参数，会基本的空间调整</p></li><li><p>掌握相关工具</p></li><li><p>明白一点：调优跟应用、环境有关，没有放之四海而皆准的法则</p></li></ul></li></ul><hr><h4 id="_1-调优领域" tabindex="-1">1）调优领域 <a class="header-anchor" href="#_1-调优领域" aria-label="Permalink to &quot;1）调优领域&quot;">​</a></h4><ul><li>内存</li><li>锁竞争</li><li>cpu 占用</li><li>io</li></ul><hr><h4 id="_2-确定目标" tabindex="-1">2）确定目标 <a class="header-anchor" href="#_2-确定目标" aria-label="Permalink to &quot;2）确定目标&quot;">​</a></h4><p>Hotspot：CMS、G1、ZGC、ParallelGC</p><p>ZGC：JDK12引入的一个处于体验阶段的垃圾回收器，其目标也是超低延迟</p><figure><img src="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20231221180858292.png" alt="image-20231221180858292" loading="lazy" decoding="async" class="lazy"></figure><hr><h4 id="_3-最快的-gc" tabindex="-1">3）最快的 GC <a class="header-anchor" href="#_3-最快的-gc" aria-label="Permalink to &quot;3）最快的 GC&quot;">​</a></h4><p>答案是不发生 GC</p><p>执行一条没有限制大表SQL查询，它会把所有的数据都从数据库通过JDBC读取你的Java内存，这样的话，你的内存再大也架不住好多个这样的SQL语句同时执行，多个数据不断地多次把大量的数据加载到你的堆内存中，会导致你的GC频繁发生，甚至最后OutOfMemory也是有可能的，所有在SQL语句中加入limit n限制返回的记录总数，避免一些无用的数据都放在Java的内存里</p><figure><img src="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20231221180907942.png" alt="image-20231221180907942" loading="lazy" decoding="async" class="lazy"></figure><hr><h4 id="_4-新生代调优" tabindex="-1">4）新生代调优 <a class="header-anchor" href="#_4-新生代调优" aria-label="Permalink to &quot;4）新生代调优&quot;">​</a></h4><p>​ 只有排除了自己的代码问题以后才进行一个内存调优，内存调优这块建议先从新生代开始。当你new一个对象时，这个对象首先会在伊甸园中分配，分配速度是非常非常快的，即TLAB，全称Thread-Local Allocation Buffer，从名字可以猜到是每个线程局部的、私有的，Allocation Buffer含义是分配一个缓冲区；</p><p>​ 在做对象的内存分配时也要做一个线程的并发安全保护（JVM来完成）；</p><p>​ TLAB可以减少线程之间对内存分配时的一个并发冲突；</p><p>​ 伊甸园中创建的对象效率还是非常高的；</p><p>​ 新生代发生垃圾回收时，之前介绍的所有垃圾回收器它们采用的都是复制算法，复制算法的特点是把伊甸园、幸存区From中的幸存对象都复制到幸存区To，复制完以后伊甸园和幸存区From里面的内存都被释放出来了，因此这个死亡对象的回收代价为零；新生代中大部分的对象都是用过即死，当垃圾回收时，绝大部分的新生代对象都会被回收，只有少数对象存活下来，正因为新生代幸存对象很少又采用复制拷贝算法就导致Minor GC的时间非常的短，远远低于老年代发生内存不足触发Full GC的时间，这个时间是相差一到两个数量级，所以要做新生代的内存调优，做整个Java堆内存的调优一般都是从新生代开始，因为新生代优化的空间更大。</p><figure><img src="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20231221180917635.png" alt="image-20231221180917635" loading="lazy" decoding="async" class="lazy"></figure><p>​ 虽然新生代的内存调优最有效的方式是把新生代的内存加大，但是需要注意，新生代在调大的情况下它会存在一些问题。新生代堆内存设小了，新生代可用空间少了，创建新对象时一旦发现新生代的空间不足就会触发新生代的Minor GC，Minor GC一发生就会造成STW，短暂的暂停时间触发时机增多；新生代内存设置大了也不一定好，如果新生代的内存设得太大了，必然老年代的可用空间就相对变少了，那老年代的空间少了，将来新生代觉得空闲空间很多，新创建的对象都不会触发垃圾回收，但是老年代的空间紧张，再触发垃圾回收那可就是Full GC，那Full GC的暂停时间就比新生代的Minor GC暂停时间更长。</p><blockquote><p>-Xmn</p><p>Sets the initial and maximum size (in bytes) of the heap for the young generation (nursery). GC is performed in this region more often than in other regions. If the size for the young generation is too small, then a lot of minor garbage collections are performed. If the size is too large, then only full garbage collections are performed, which can take a long time to complete. Oracle recommends that you keep the size for the young generation greater than 25% and less than 50% of the overall heap size.</p><p>设置新生代堆的初始和最大大小（字节）。GC 在该区域比在其他区域执行得更频繁。如果新生代的大小太小，则会执行大量的小规模垃圾回收。如果大小过大，则只完全垃圾回收，这可能需要很长时间才能完成。Oracle 建议将新生代的大小保持在整个堆大小的 25% 以上和 50% 以下。</p></blockquote><img src="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20231221180931280.png" alt="image-20231221180931280" class="scale-67"><p>​ 真正实践的时候，新生代的内存跟吞吐量（单位时间能响应的请求数）的关系如上图所示，随着新生代的堆空间越来越大，吞吐量也越来越高，因为垃圾回收占用整个CPU计算时间的比例少了，吞吐量就高了，但是到了一定空间大小以后，吞吐量会有一个下降，这是因为虽然新生代空间大了，就意味着垃圾回收的时间较长，打个比喻，一栋楼房子大了，打扫的时间也会较长，所以这个曲线看出新生代空间也不是越大越好，但是需要在新生代的内存大小和吞吐量之间找到一个最优解</p><p>​ 总的原则还是将新生代的空间调得尽可能大，因为还有一个因素是新生代的垃圾回收都是复制算法，复制算法也是分为标记+复制两个阶段，这两个阶段中复制花费的时间要多一些，因为复制要牵扯到对象占用的内存块移动，另外要更新其他引用对象的地址，这个速度相对更耗时一些…</p><img src="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20231221180942190.png" alt="image-20231221180942190" class="scale-67"><img src="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20231221180948555.png" alt="image-20231221180948555" class="scale-67"><p>​ 一方面希望存活时间比较短的对象留在幸存区以便在下次垃圾回收时把它回收掉，另一方面又希望长时间存活的对象应该尽快晋升到老年代去，它留在幸存区里只能够耗费幸存区的内存，又因为新生代都是复制算法，会幸存区中对象下次存活了把它们都从From复制到To去，新生代复制算法主要的耗费时间是在对象的复制上，如果有大量长时间的存活对象不能及早的晋升，就相当于留在幸存区中被复制来复制去，这样对性能反而是一个负担，这时可以设置参数<code>-XX:MaxTenuringThreshold=threshold</code>来调整最大晋升阈值，把晋升阈值调得比较小，让那些长时间存活的对象能够尽快的晋升到老年代去；</p><p>每次把幸存区中不同年龄的对象所占用的空间打印出来可以更细致地去决定到底把这个最大晋升阈值调成多少比较合适，让那些长时间存活的对象能够尽早晋升</p><img src="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20231221181003562.png" alt="image-20231221181003562" class="scale-67"><hr><h4 id="_5-老年代调优" tabindex="-1">5）老年代调优 <a class="header-anchor" href="#_5-老年代调优" aria-label="Permalink to &quot;5）老年代调优&quot;">​</a></h4><p>CMS垃圾回收的同时其他用户线程也在运行，就有可能产生新的垃圾，即浮动垃圾，浮动垃圾积累多了又导致内存不足就会造成CMS并发失败，那么CMS垃圾回收器就不能正常工作了，就会退化为SerialOld串行的老年代垃圾回收器，效率特别低，一下子就会STW，导致响应时间特别长，所以给老年代规划内存时可能需要给它规划得更大些，越大越好，这是为了预留更多的空间，避免浮动垃圾引起的并发失败；</p><p>如果程序运行一段时间以后，并没有发现Full GC，即不是由于老年代的空间不足引起的垃圾回收，说明老年代的空间很充裕，没有Full GC那系统工作已经是很ok的，所以先别尝试做老年代的调优，即使发生了Full GC，你也应该尝试先从新生代开始调优，去调整新生代的大小、幸存区大小，包括幸存区的那些晋升阈值、容量等。这些手段都用了还是经常发生Full GC再回过头来看看老年代的设置，一旦老年代发生Full GC，观察Full GC时老年代是由于超过了多大的内存导致了Full GC的发生，那可以在Full GC时原有的内存基础上给它调大到<code>1/4~1/3</code>，这样就相当于划分更合理的、更大的内存给老年代使用，减少老年代Full GC的产生</p><figure><img src="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20231221181010496.png" alt="image-20231221181010496" loading="lazy" decoding="async" class="lazy"></figure><hr><h4 id="_6-案例" tabindex="-1">6）案例 <a class="header-anchor" href="#_6-案例" aria-label="Permalink to &quot;6）案例&quot;">​</a></h4><ul><li>案例1 Full GC 和 Minor GC频繁</li></ul><p>​ 程序运行期间，其GC特别频繁，尤其是Minor GC，甚至达到1分钟上百次，那GC特别频繁就说明空间紧张，如果是新生代空间紧张，当业务高峰期来了，大量的对象被创建，很快就把新生代的空间塞满了，塞满后就会带来一个后果，就是幸存区空间紧张了，它里面的对象晋升阈值就会降低，导致很多本来生命周期很短的对象也被晋升到老年代去，那情况就进一步恶化了，老年代就存了大量这种生命周期很短的对象，然后进一步触发老年代的Full GC的频繁发生。经过分析后通过监测工具观察这个堆空间大小，确实发现新生代内存设置得太小了，根据之前调优知道，内存优化应该先从新生代开始，所以解决方法是尝试增大新生代的内存，新生代内存增大以后内存充裕了，那新生代的垃圾回收就变得不那么频繁了，同时增大了幸存区的空间以及晋升的阈值，这样就可以让很多生命周期较短的对象尽可能地被留在新生代里而不要晋升到老年代去，进一步让老年代的Full GC也不容易出现或不那么频繁了</p><ul><li>案例2 请求高峰期发生 Full GC，单次暂停时间特别长 （CMS）</li></ul><p>​ 此案例为业务需求要的是低延迟，所以在垃圾回收器选择上选择了CMSGC。单次暂停时间特别长就分析到底是哪一部分时间耗费的较长，因为已经确认了垃圾回收器是CMSGC，所以就去查看GC日志看看CMS哪个阶段耗费的时间较长。CMS分为初始阶段、并发标记阶段、重新标记阶段、并发清理阶段，其中初始标记和并发标记都是比较快的，比较慢的是这个重新标记，通过查看GC日志，它会把每个阶段耗费的时间在GC日志里找到，这时发现在重新标记阶段的耗时接近了1s多快到2s，所以问题就定位到重新标记阶段，在CMS做重新标记时会扫描整个堆内存，不光要扫描老年代的对象还要扫描新生代对象，如果这时业务处于高峰期，那新生代的对象个数比较多，那它扫描和标记的时间就会变得非常多，因为它要根据这个对象找到其引用，是一种遍历算法，耗时太多了，那能不能在重新标记之前把一些新生代的对象先做一次垃圾回收，减少新生代对象的数量，这样就可以减少在重新标记阶段所耗费的时间呢？可以通过设置参数<code>-XX:+CMSScavengeBeforeRemark</code>，即在重新标记发生之前先对新生代的对象做一次垃圾清理，清理之后存活对象就少了，那需要重新标记阶段需要查找和标记的对象也变得比以前要少得多，这样就可以解决问题了。通过这个参数发现，重新标记的时间从接近2s降低到了3ms左右了，就达到了响应时间的要求了，解决了单次暂停时间特别长的问题。</p><ul><li>案例3 老年代充裕情况下，发生 Full GC （CMS jdk1.7）</li></ul><p>​ CMS会可能由于空间不足导致并发失败，或空间碎片比较多触发Full GC，但经过排查在GC日志里都没有并发失败，包括碎片过多这样的错误提示，那说明老年代的空间是充裕的，不是由于老年代的空间不足产生的Full GC，后来就想到这个应用程序不符合JDK的版本，是1.7而不是1.8，1.8是有一个元空间作为方法区的实现，而1.7以前的JDK是采用的永久代作为方法区的实现，那1.7以前（0~1.6）的JDK版本里，永久代的空间不足也会导致Full GC垃圾回收的发生，到了1.8以后因为改成了元空间，它的垃圾回收就不是由Java来控制的了，所以元空间默认情况下其内存空间是使用的操作系统的内存空间的，所以它的空间容量一般是比较充裕的，不会发生这个元空间的空间不足问题，而1.7以前的永久代的空间如果设小了就会触发整个堆的一次Full GC，所以经过这样的定位就初步定位到是<strong>由于元空间的内存不足导致的Full GC</strong>，所以增大了元空间的初始值和最大值，保证了Full GC不会再发生。</p><h2 id="类加载与字节码技术" tabindex="-1">类加载与字节码技术 <a class="header-anchor" href="#类加载与字节码技术" aria-label="Permalink to &quot;类加载与字节码技术&quot;">​</a></h2><ol><li>类文件结构</li><li>字节码指令</li><li>编译期处理</li><li>类加载阶段</li><li>类加载器</li><li>运行期优化</li></ol><figure><img src="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20240116162402825.png" alt="image-20240116162402825" loading="lazy" decoding="async" class="lazy"></figure><figure><img src="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20231221181022940.png" alt="image-20231221181022940" loading="lazy" decoding="async" class="lazy"></figure><figure><img src="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20231221181036489.png" alt="image-20231221181036489" loading="lazy" decoding="async" class="lazy"></figure><figure><img src="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20231221181044905.png" alt="image-20231221181044905" loading="lazy" decoding="async" class="lazy"></figure><figure><img src="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20231221181053001.png" alt="image-20231221181053001" loading="lazy" decoding="async" class="lazy"></figure><figure><img src="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20231221181059549.png" alt="image-20231221181059549" loading="lazy" decoding="async" class="lazy"></figure><figure><img src="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20231221181110030.png" alt="image-20231221181110030" loading="lazy" decoding="async" class="lazy"></figure><figure><img src="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20231221181120370.png" alt="image-20231221181120370" loading="lazy" decoding="async" class="lazy"></figure><figure><img src="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20231221181130765.png" alt="image-20231221181130765" loading="lazy" decoding="async" class="lazy"></figure><figure><img src="https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20231221181201053.png" alt="image-20231221181201053" loading="lazy" decoding="async" class="lazy"></figure><!--]--><!--]--><!----><!--[--><div m="y-4" class="end flex justify-center items-center"><hr class="line inline-flex" w="full" m="!y-2"><span p="x-4" font="bold" class="whitespace-nowrap">To Be Continued.</span><hr class="line inline-flex" w="full" m="!y-2"></div><!--]--></article><!-- </Transition> --><!--]--><!--[--><!--[--><!--[--><div class="yun-sponsor-container flex-center flex-col" m="t-6"><button class="sponsor-button yun-icon-btn shadow hover:shadow-md" title="打赏" text="red-400"><div class="mt-2px" i-ri-heart-fill></div></button><div m="y-4" class="qrcode-container qrcode flex-center flex-col"><div class="sponsor-description" mb="4" text="sm">你的打赏和支持是我坚持写下去的动力</div><div class="flex justify-around"><!--[--><a class="flex-center flex-col animate-iteration-1 animate-fade-in" href="/images/sponsor/alipay.png" target="_blank" style="color:#00a3ee"><img class="sponsor-method-img" border="~ rounded" p="1" loading="lazy" src="/images/sponsor/alipay.png" title="支付宝"><div text="xl" m="2" class="i-ri-alipay-line"></div></a><a class="flex-center flex-col animate-iteration-1 animate-fade-in" href="/images/sponsor/qqpay.png" target="_blank" style="color:#12b7f5"><img class="sponsor-method-img" border="~ rounded" p="1" loading="lazy" src="/images/sponsor/qqpay.png" title="QQ 支付"><div text="xl" m="2" class="i-ri-qq-line"></div></a><a class="flex-center flex-col animate-iteration-1 animate-fade-in" href="/images/sponsor/wechatpay.png" target="_blank" style="color:#2dc100"><img class="sponsor-method-img" border="~ rounded" p="1" loading="lazy" src="/images/sponsor/wechatpay.png" title="微信支付"><div text="xl" m="2" class="i-ri-wechat-pay-line"></div></a><!--]--></div></div></div><ul class="post-copyright" m="y-4"><li class="post-copyright-author"><strong>本文作者：</strong><span>imklaus</span></li><li class="post-copyright-link"><strong>本文链接：</strong><a href="https://www.imlklaus.cn/posts/JVM" target="_blank" title="本文链接">https://www.imlklaus.cn/posts/JVM</a></li><li class="post-copyright-license"><strong>版权声明：</strong><span>本博客所有文章除特别声明外，均默认采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" target="_blank" rel="noopener" title="CC BY-NC-SA 4.0 ">CC BY-NC-SA</a> 许可协议。</span></li></ul><!--]--><!--]--><!--]--></div><!--]--><!----></div><!--[--><!--]--><!--[--><div class="post-nav"><div class="post-nav-item"><!----></div><div class="post-nav-item"><a href="/posts/Concurrent_Programming-JUC" class="post-nav-next" title="并发编程整理版 - JUC"><span class="title truncate" text="sm">并发编程整理版 - JUC</span><div class="icon" i-ri-arrow-right-s-line></div></a></div></div><!--]--><!--[--><!--]--><!--[--><div class="yun-card flex-center rounded-2 comment yun-comment sm:p-6 lg:px-12 xl:px-16" flex="col" min-h="100px" bg="$va-c-bg-light" w="full" p="4"><!----><!----><!--[--><!----><!--]--><!----></div><!--]--><!--[--><!-- eslint-disable-next-line vue/no-lone-template empty --><template class="mt-4"></template><!--]--><!--[--><!--]--><!--[--><!--]--></div><!--]--></main><!--[--><button class="xl:hidden toc-btn shadow-md fixed yun-icon-btn z-20 bg-$va-c-bg-soft" opacity="75" right="4" bottom="19"><div i-ri-file-list-line></div></button><!----><aside flex="~ col" class="va-card yun-aside sticky top-0 lg:top-$yun-margin-top min-h-sm" text="center" overflow="auto"><div class="w-full" flex="~ col" pb-2 style="display:none"><!--[--><h2 m="t-6 b-2" font="serif black">文章目录</h2><div style="display:none" data-v-2cefcb73><div class="content" data-v-2cefcb73><div class="outline-title" data-v-2cefcb73>本页</div><div class="outline-marker" data-v-2cefcb73></div><nav aria-labelledby="doc-outline-aria-label" data-v-2cefcb73><span id="doc-outline-aria-label" class="visually-hidden" data-v-2cefcb73>Table of Contents for current page</span><ul class="root va-toc relative z-1 css-i18n-toc" data-v-2cefcb73 data-v-c0236dac><!--[--><!--]--></ul></nav></div></div><!--]--><div class="flex-grow"></div><!----></div></aside><!--]--><!--]--></div><footer flex="~ col" class="relative yun-footer va-footer px-4 py-4 pt-0 text-$va-c-text-light w-full mt-14" bg="white dark:$va-c-bg-soft" text="center sm"><div class="yun-cloud absolute top--10 left-0 right-0"><svg class="waves" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M-160 44c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z" fill="var(--yun-c-cloud)"/></defs><g class="parallax"><use xlink:href="#gentle-wave" x="48" y="0"/><use xlink:href="#gentle-wave" x="48" y="3"/><use xlink:href="#gentle-wave" x="48" y="5"/><use xlink:href="#gentle-wave" x="48" y="7"/></g></svg></div><div class="beian" m="y-2"><a href="https://beian.miit.gov.cn/" target="_blank" rel="noopener">粤ICP备2025395704号</a></div><div class="copyright flex justify-center items-center gap-2" p="1"><span>©<!--[--> 2023 -<!--]--> 2025</span><a class="animate-pulse inline-flex" href="https://www.yunyoujun.cn/sponsors/" target="_blank" title="Sponsor YunYouJun"><div class="i-ri-bluesky-fill"></div></a><span>imklaus</span></div><div class="powered" m="2"><span>由 <a href="git+https://github.com/YunYouJun/valaxy.git" target="_blank" rel="noopener">Valaxy</a> <span class="op-60">v0.26.10</span> 驱动</span><span mx-1>|</span><span><span>主题</span><span mx-1>-</span><a href="git+https://github.com/YunYouJun/valaxy/tree/main/packages/valaxy-theme-yun.git" title="valaxy-theme-yun" target="_blank">Yun</a><span class="ml-1 op-60">v0.26.10</span></span></div><!--[--><!--]--><div class="yun-footer-gradient" style="--gradient-from:161 196 253;--gradient-to:194 233 251"></div></footer><!--]--><!--]--></div><script>window.__INITIAL_STATE__='{"pinia":{"yun-app":{},"app":{"showLoading":true},"site":{},"routerStore":{}}}'</script><script type="application/ld+json" data-hid="schema-org-graph">{"@context":"https://schema.org","@graph":[{"@id":"https://www.imlklaus.cn/#identity","@type":"Person","name":"imklaus","url":"https://www.imlklaus.cn/","image":{"@id":"https://www.imlklaus.cn/#/schema/image/4219811"},"sameAs":["/atom.xml","https://music.163.com/#/user/home?id=102158629","https://space.bilibili.com/19430480","https://github.com/imLKlauS","https://t.me/elpsycn","mailto:me@imlklaus.cn","https://www.travellings.cn/go.html"]},{"@id":"https://www.imlklaus.cn/#website","@type":"WebSite","dateModified":"2025/11/17 3:18:00","datePublished":"2025/11/17 3:18:00","inLanguage":"en","name":"Java 虚拟机从入门到精通","url":"https://www.imlklaus.cn/","publisher":{"@id":"https://www.imlklaus.cn/#identity"}},{"@id":"https://www.imlklaus.cn/#webpage","@type":"WebPage","dateModified":"2025-11-16T19:18:00.000Z","datePublished":"2025-11-16T19:18:00.000Z","description":"The Winner Takes It All.","name":"Java 虚拟机从入门到精通","url":"https://www.imlklaus.cn/","about":{"@id":"https://www.imlklaus.cn/#identity"},"isPartOf":{"@id":"https://www.imlklaus.cn/#website"},"potentialAction":[{"@type":"ReadAction","target":["https://www.imlklaus.cn/"]}]},{"@id":"https://www.imlklaus.cn/#article","dateModified":"2025-11-16T19:18:00.000Z","datePublished":"2025-11-16T19:18:00.000Z","description":"The Winner Takes It All.","headline":"Java 虚拟机从入门到精通","inLanguage":"en","thumbnailUrl":"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/freecompress-Snipaste_2025-12-04_20-53-39.png","@type":["Article","BlogPosting"],"author":{"@id":"https://www.imlklaus.cn/#/schema/person/893d71a"},"image":{"@id":"https://www.imlklaus.cn/#/schema/image/063833"},"isPartOf":{"@id":"https://www.imlklaus.cn/#webpage"},"mainEntityOfPage":{"@id":"https://www.imlklaus.cn/#webpage"},"publisher":{"@id":"https://www.imlklaus.cn/#identity"}},{"@id":"https://www.imlklaus.cn/#/schema/person/893d71a","@type":"Person","name":"imklaus","url":"https://www.imlklaus.cn/"},{"@id":"https://www.imlklaus.cn/#/schema/image/4219811","@type":"ImageObject","contentUrl":"https://www.imlklaus.cn/images/tiamat8.jpg","inLanguage":"en","url":"https://www.imlklaus.cn/images/tiamat8.jpg"},{"@id":"https://www.imlklaus.cn/#/schema/image/063833","@type":"ImageObject","contentUrl":"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/freecompress-Snipaste_2025-12-04_20-53-39.png","inLanguage":"en","url":"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/freecompress-Snipaste_2025-12-04_20-53-39.png"}]}</script></body></html>