<!DOCTYPE html><html lang="en" data-critters-container><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><link rel="icon" href="https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230825001534253.png"><script>const prefersDark=window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches,colorSchemeSetting=localStorage.getItem("vueuse-color-scheme")||"auto";("dark"===colorSchemeSetting||prefersDark&&"light"!==colorSchemeSetting)&&document.documentElement.classList.toggle("dark",!0)</script><script>const locale=localStorage.getItem("valaxy-locale")||"zh-CN";document.documentElement.setAttribute("lang",locale)</script><script type="module" async crossorigin src="/assets/app-eda06591.js"></script><link rel="modulepreload" crossorigin href="/js/animejs/animejs.82133372.js"><link rel="modulepreload" crossorigin href="/assets/app-eda06591.js"><link rel="modulepreload" crossorigin href="/js/@vueuse/@vueuse.592447f3.js"><style>@charset "UTF-8";.links-of-author .icon{width:1.5rem;height:1.5rem}.site-link-item:nth-child(2){border:none}.site-link-item .count{color:var(--va-c-text);font-family:var(--va-font-sans);display:block;text-align:center;font-size:1rem}.site-link-item .icon{width:1.5rem;height:1.5rem}.site-link-item .icon:hover{color:var(--va-c-primary-light)}.site-author-avatar img{height:96px;width:96px;max-width:100%;margin:0;padding:4px;background-color:#fff;box-shadow:0 0 10px #0003;transition:.4s}.site-author-avatar img:hover{box-shadow:0 0 30px rgba(var(--va-c-primary-rgb),.2)}.yun-search-btn{position:fixed;top:.6rem;right:.8rem;color:var(--va-c-primary);z-index:var(--yun-z-search-btn)}.yun-bg{position:fixed;width:100%;height:100%;z-index:-1;background-image:var(--yun-bg-img);background-size:cover;background-position:center;background-repeat:no-repeat;background-attachment:fixed;animation-name:bgFadeIn;animation-duration:2s;opacity:var(--yun-bg-img-opacity,1)}@supports (-webkit-touch-callout:none){.yun-bg{background-attachment:scroll}}@keyframes bgFadeIn{0%{opacity:0}to{opacity:var(--yun-bg-img-opacity,1)}}canvas.fireworks{position:fixed;left:0;top:0;z-index:1;pointer-events:none}*,:after,:before{box-sizing:border-box;border-width:0;border-style:solid;border-color:var(--un-default-border-color,#e5e7eb)}html{line-height:1.5;-webkit-text-size-adjust:100%;text-size-adjust:100%;-moz-tab-size:4;tab-size:4;font-family:ui-sans-serif,system-ui,-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica Neue,Arial,Noto Sans,sans-serif,"Apple Color Emoji","Segoe UI Emoji",Segoe UI Symbol,"Noto Color Emoji"}body{margin:0;line-height:inherit}hr{height:0;color:inherit;border-top-width:1px}h1,h2,h3,h4,h5,h6{font-size:inherit;font-weight:inherit}a{color:inherit;text-decoration:inherit}strong{font-weight:bolder}code,pre{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,Liberation Mono,Courier New,monospace;font-size:1em}table{text-indent:0;border-color:inherit;border-collapse:collapse}button{font-family:inherit;font-feature-settings:inherit;font-variation-settings:inherit;font-size:100%;font-weight:inherit;line-height:inherit;color:inherit;margin:0;padding:0}button{text-transform:none}[type=button],button{-webkit-appearance:button;background-image:none}blockquote,figure,h1,h2,h3,h4,h5,h6,hr,p,pre{margin:0}ol,ul{list-style:none;margin:0;padding:0}button{cursor:pointer}canvas,img,svg{display:block;vertical-align:middle}img{max-width:100%;height:auto}body{counter-reset:katexEqnNo mmlEqnNo}html{-webkit-tap-highlight-color:transparent}a{color:var(--va-c-link);font-weight:500}*{outline:0}hr{opacity:.2;margin:1rem}button{background-color:transparent}#app,body,html{margin:0;padding:0;line-height:2}body{background-color:var(--va-c-bg)}a{cursor:pointer}html:not(.dark) .vp-code-dark{display:none}@media screen and (max-width:640px){.markdown-body div[class*=language-]{margin:0 var(--va-code-mobile-margin-x,-1rem)}}@media (min-width:640px){.markdown-body div[class*=language-]{border-radius:6px;margin:16px 0}}@media (max-width:639px){.markdown-body li div[class*=language-]{border-radius:6px 0 0 6px}}.markdown-body code{font-size:.85em}.markdown-body div[class*=language-]{position:relative;background-color:var(--va-code-block-bg);overflow-x:auto}.markdown-body div[class*=language-] code{padding:0 24px;line-height:var(--va-code-line-height);font-size:var(--va-code-font-size);color:var(--va-code-block-color);transition:color .5s;width:fit-content;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none}.markdown-body div[class*=language-] pre{position:relative;z-index:1;margin:0;padding:1rem 0;background:0 0;overflow-x:auto}.markdown-body div[class*=language-] pre code{display:block}.markdown-body [class*=language-]>button.copy{direction:ltr;position:absolute;top:12px;right:12px;z-index:3;border:1px solid var(--va-code-copy-code-border-color);border-radius:4px;width:40px;height:40px;background-color:var(--va-code-copy-code-bg);opacity:0;cursor:pointer;background-image:var(--va-icon-copy);background-position:50%;background-size:20px;background-repeat:no-repeat;transition:border-color .25s,background-color .25s,opacity .25s}.markdown-body [class*=language-]:hover>button.copy,.markdown-body [class*=language-]>button.copy:focus{opacity:1}.markdown-body [class*=language-]>button.copy:hover{border-color:var(--va-code-copy-code-hover-border-color);background-color:var(--va-code-copy-code-hover-bg)}.markdown-body [class*=language-]>span.lang{position:absolute;top:2px;right:8px;z-index:2;font-size:12px;font-weight:500;color:var(--va-code-lang-color);transition:color .4s,opacity .4s}.markdown-body [class*=language-]:hover>button.copy+span.lang,.markdown-body [class*=language-]>button.copy:focus+span.lang{opacity:0}:root{--va-c-text-warning:#544500}.vt-hamburger:hover .vt-hamburger-top{transform:translate(-5.5px)}.vt-hamburger:hover .vt-hamburger-middle{transform:translate(0)}.vt-hamburger:hover .vt-hamburger-bottom{transform:translate(-11px)}h1:focus .header-anchor,h1:hover .header-anchor,h2:focus .header-anchor,h2:hover .header-anchor,h3:focus .header-anchor,h3:hover .header-anchor,h4:focus .header-anchor,h4:hover .header-anchor,h5:focus .header-anchor,h5:hover .header-anchor,h6:focus .header-anchor,h6:hover .header-anchor{visibility:visible;opacity:1}a.header-anchor{float:left;margin-top:.125em;margin-left:-.87em;padding-right:.23em;font-size:.85em;visibility:hidden;opacity:0;transition:opacity var(--va-transition-duration)}a.header-anchor:before{content:none}a.header-anchor:focus,a.header-anchor:hover{text-decoration:none}.markdown-body figure{text-align:center}:root{--va-aside-width:256px;--va-sidebar-width:300px;--va-border-width:1px;--va-font-serif:"Noto Serif SC",STZhongsong,STKaiti,KaiTi,Roboto,serif;--va-font-sans:Inter,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Oxygen,Ubuntu,Cantarell,"Fira Sans","Droid Sans","Helvetica Neue",sans-serif;--va-font-mono:Menlo,Monaco,Consolas,"Courier New",monospace;--va-transition-duration-fast:.2s;--va-transition-duration:.4s;--va-transition-duration-slow:.6s;--va-transition:all var(--va-transition-duration-fast) ease-in-out}:root{--va-c-white:#ffffff;--va-c-black:#1a1a1a;--va-c-gray:#8e8e8e;--va-c-danger:#db2828;--va-c-warning:#f2711c;--va-c-text-light-1:#213547;--va-c-text-light-2:rgba(60, 60, 60, .7);--va-c-text-light-3:rgba(60, 60, 60, .33);--va-c-text-light-4:rgba(60, 60, 60, .18);--va-c-text-dark-1:rgba(255, 255, 255, .87);--va-c-text-dark-2:rgba(235, 235, 235, .6);--va-c-text-dark-3:rgba(235, 235, 235, .38);--va-c-text-dark-4:rgba(235, 235, 235, .18);--va-c-primary-light:#8ad9e0;--va-c-primary-lighter:#c6edf0;--va-c-primary-dark:#39c0cb;--va-c-primary:#4dc6d0}:root{color-scheme:light;--va-c-brand:#4dc6d0;--va-border-color:#222;--va-c-bg:white;--va-c-bg-light:white;--va-c-bg-dark:#fafafa;--va-c-bg-opacity:rgba(255, 255, 255, .8);--va-c-bg-soft:#f9f9f9;--va-c-bg-alt:#f9f9f9;--va-c-bg-mute:#f1f1f1;--va-c-text:#333;--va-c-text-light:#555;--va-c-text-lighter:#666;--va-c-text-dark:#111;--va-c-primary-rgb:77,198,208;--va-c-link:var(--va-c-primary-dark);--va-c-divider:rgba(60, 60, 60, .2)}:root{--va-c-text-1:rgba(60, 60, 67);--va-c-text-2:rgba(60, 60, 67, .78);--va-c-text-3:rgba(60, 60, 67, .56)}:root{--va-code-line-height:1.7;--va-code-font-size:.875em;--va-code-block-color:var(--va-c-text-2);--va-code-block-bg:var(--va-c-bg-alt);--va-code-block-divider-color:var(--va-c-gutter);--va-code-lang-color:var(--va-c-text-3);--va-code-line-highlight-color:rgba(0, 0, 0, .5);--va-code-line-number-color:var(--va-c-text-dark-3);--va-code-copy-code-border-color:var(--va-c-divider);--va-code-copy-code-bg:var(--va-c-bg-soft);--va-code-copy-code-hover-border-color:var(--va-c-divider);--va-code-copy-code-hover-bg:var(--va-c-bg);--va-code-copy-code-active-text:var(--va-c-text-2);--va-code-copy-copied-text-content:"Copied"}:root{--va-icon-copy:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' height='20' width='20' stroke='rgba(128,128,128,1)' stroke-width='2' class='h-6 w-6' viewBox='0 0 24 24'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' d='M9 5H7a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2h-2M9 5a2 2 0 0 0 2 2h2a2 2 0 0 0 2-2M9 5a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2'/%3E%3C/svg%3E");--va-icon-copied:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' height='20' width='20' stroke='rgba(128,128,128,1)' stroke-width='2' class='h-6 w-6' viewBox='0 0 24 24'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' d='M9 5H7a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2h-2M9 5a2 2 0 0 0 2 2h2a2 2 0 0 0 2-2M9 5a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2m-6 9 2 2 4-4'/%3E%3C/svg%3E")}html{overflow-y:scroll}.yun-main{padding-left:var(--va-sidebar-width);transition:padding-left var(--va-transition-duration);box-sizing:border-box}.yun-icon-btn{background-color:transparent;cursor:pointer;display:inline-flex;align-items:center;justify-content:center;border:none;width:3rem;height:3rem;border-radius:50%;transition:background-color var(--va-transition-duration)}.yun-icon-btn div{font-size:1.2rem}.yun-icon-btn:hover{background-color:rgba(var(--va-c-primary-rgb),.08)}.yun-icon-btn:active{background-color:rgba(var(--va-c-primary-rgb),.16)}:root{--smc-font-sans:Raleway,-apple-system,"PingFang SC","Microsoft YaHei",Arial,sans-serif;--smc-font-serif:"Songti SC","Noto Serif SC",STZhongsong,STKaiti,KaiTi,Roboto,serif;--smc-font-mono:Menlo,Monaco,Consolas,"Courier New",monospace}:root{--smc-c-primary-light:#9ee0e5;--smc-c-primary-lighter:#daf3f5;--smc-c-primary:#4dc6d0;--smc-theme-name:yun;--smc-line-height:1.8;--smc-c-primary-rgb:77,198,208;--smc-c-text:#24292e;--smc-c-text-light:#555;--smc-c-text-lighter:#666;--smc-header-bottom-color:#eaecef;--smc-border-color:var(--smc-c-primary-light);--smc-code-bg-color:#f6f8fa;--smc-link-color:#31afb9}.markdown-body{-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%;background:var(--smc-bg-color);color:var(--smc-c-text);font-family:var(--smc-font-sans);font-size:1rem;line-height:var(--smc-line-height);overflow-wrap:break-word}.markdown-body *{box-sizing:border-box}.markdown-body a{background-color:transparent}.markdown-body a:active,.markdown-body a:hover{outline-width:0}.markdown-body blockquote{margin:1rem 0;padding:0 1rem;border-left:.25em solid var(--smc-border-color)}.markdown-body code,.markdown-body pre{font-family:Source Code Pro,Consolas,Monaco,SFMono-Regular,Ubuntu Mono,Menlo,monospace}.markdown-body code{padding:3px 6px;font-size:.85rem;color:var(--smc-c-text-light);background:var(--smc-code-bg-color);border-radius:3px}.markdown-body pre{margin-top:0;margin-bottom:0;overflow-wrap:normal;padding:1rem;overflow:auto;background-color:var(--smc-code-bg-color);border-radius:3px}.markdown-body pre>code{font-size:.85rem;white-space:pre}.markdown-body pre code{display:block;padding:0;margin:0;overflow:visible;line-height:inherit;word-break:normal;background-color:transparent;border:0}.markdown-body img{display:block;margin:1rem auto;max-width:92%;max-height:600px;border-radius:.2rem;transition:.4s;--tw-shadow:0 1px 3px 0 rgb(0 0 0/.1),0 1px 2px -1px rgb(0 0 0/.1);--tw-shadow-colored:0 1px 3px 0 var(--tw-shadow-color),0 1px 2px -1px var(--tw-shadow-color);-webkit-box-shadow:var(--tw-ring-offset-shadow,0 0 transparent),var(--tw-ring-shadow,0 0 transparent),var(--tw-shadow);box-shadow:var(--tw-ring-offset-shadow,0 0 transparent),var(--tw-ring-shadow,0 0 transparent),var(--tw-shadow)}.markdown-body img:hover{--tw-shadow:0 4px 6px -1px rgb(0 0 0/.1),0 2px 4px -2px rgb(0 0 0/.1);--tw-shadow-colored:0 4px 6px -1px var(--tw-shadow-color),0 2px 4px -2px var(--tw-shadow-color)}.markdown-body img:before{content:"„Äå LOADING ERROR „Äç"}@media screen and (min-width:1600px){.markdown-body img{max-width:800px}}.markdown-body a{color:var(--smc-c-primary);text-decoration:none;border-bottom:1px solid transparent;transition:all .2s ease-in-out}.markdown-body a:hover{color:var(--smc-link-color);border-bottom:1px solid var(--smc-link-color)}.markdown-body ol,.markdown-body ul{padding-left:2em}.markdown-body ol ul,.markdown-body ul ul{margin-top:0;margin-bottom:0}.markdown-body li{overflow-wrap:break-all;margin-top:.25em}.markdown-body li>p{margin-top:16px}.markdown-body table{width:100%;overflow:auto;border-spacing:0;border-collapse:collapse}.markdown-body table td,.markdown-body table th{padding:6px 13px;border:1px solid var(--smc-c-primary-light,#999)}.markdown-body table thead th{font-weight:600}.markdown-body table>tbody>tr:hover{background-color:rgba(var(--smc-c-primary-rgb),.1)}.markdown-body strong{font-family:var(--smc-font-serif);font-weight:900}.markdown-body p{margin-top:1rem;margin-bottom:1rem;overflow-x:auto;overflow-y:hidden}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin-top:1.5rem;margin-bottom:1rem;font-weight:300;line-height:1.5}.markdown-body h1{font-size:2.5rem;border-bottom:1px solid var(--smc-header-bottom-color)}.markdown-body h2{font-size:2.2rem;border-bottom:1px solid var(--smc-header-bottom-color)}.markdown-body h3{font-size:1.9rem}.markdown-body h4{font-size:1.6rem}.markdown-body h5{font-size:1.3rem}.markdown-body h6{font-size:1rem}@media screen and (max-width:768px){.markdown-body h1{font-size:2rem}.markdown-body h2{font-size:1.8rem}.markdown-body h3{font-size:1.6rem}.markdown-body h4{font-size:1.4rem}.markdown-body h5{font-size:1.2rem}.markdown-body h6{font-size:1rem}}.markdown-body{--smc-font-family:var(--va-font-sans);--c-toc-link:var(--va-c-text-light)}.markdown-body{word-wrap:break-word}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{font-family:var(--va-font-serif);font-weight:900}.markdown-body ul{list-style:initial}.markdown-body ul li>p{margin-bottom:0}.markdown-body ol li{list-style:decimal}.markdown-body img{margin:.5rem auto;height:auto}.markdown-body p{overflow:unset}:root{--yun-post-card-max-width:900px;--yun-c-cloud:white;--yun-z-toc-btn:7;--yun-z-cloud:7;--yun-z-go-down:9;--yun-z-backdrop:9;--yun-z-sidebar:10;--yun-z-fireworks:11;--yun-z-menu-btn:20;--yun-z-go-up-btn:20;--yun-z-search-popup:30;--yun-z-search-btn:31;--va-z-overlay:var(--yun-z-backdrop)}:root{--yun-bg-img:url(/assets/bg-img-73ffcfc5.jpg);--yun-sidebar-bg-color:var(--va-c-bg-light);--yun-sidebar-bg-img:url(/assets/sidebar-bg-img-b7854581.webp)}:root{--va-c-bg-light:rgba(255, 255, 255, .8);--yun-sidebar-bg-img:url(https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230825004631944.png);--yun-sidebar-bg-color:rgba(255, 255, 255, 0)}*,:after,:before{--un-rotate:0;--un-rotate-x:0;--un-rotate-y:0;--un-rotate-z:0;--un-scale-x:1;--un-scale-y:1;--un-scale-z:1;--un-skew-x:0;--un-skew-y:0;--un-translate-x:0;--un-translate-y:0;--un-translate-z:0;--un-scroll-snap-strictness:proximity;--un-border-spacing-x:0;--un-border-spacing-y:0;--un-ring-offset-shadow:0 0 rgba(0,0,0,0);--un-ring-shadow:0 0 rgba(0,0,0,0);--un-shadow:0 0 rgba(0,0,0,0);--un-ring-offset-width:0px;--un-ring-offset-color:#fff;--un-ring-width:0px;--un-ring-color:rgba(147,197,253,.5)}[i-ri-archive-line=""]{--un-icon:url("data:image/svg+xml;utf8,%3Csvg viewBox='0 0 24 24' width='1.2em' height='1.2em' xmlns='http://www.w3.org/2000/svg' %3E%3Cpath fill='currentColor' d='M3 10H2V4.003C2 3.449 2.455 3 2.992 3h18.016A.99.99 0 0 1 22 4.003V10h-1v10.002a.996.996 0 0 1-.993.998H3.993A.996.996 0 0 1 3 20.002V10Zm16 0H5v9h14v-9ZM4 5v3h16V5H4Zm5 7h6v2H9v-2Z'/%3E%3C/svg%3E");-webkit-mask:var(--un-icon) no-repeat;mask:var(--un-icon) no-repeat;-webkit-mask-size:100% 100%;mask-size:100% 100%;background-color:currentColor;color:inherit;width:1.2em;height:1.2em}[i-ri-arrow-left-s-line=""]{--un-icon:url("data:image/svg+xml;utf8,%3Csvg viewBox='0 0 24 24' width='1.2em' height='1.2em' xmlns='http://www.w3.org/2000/svg' %3E%3Cpath fill='currentColor' d='m10.828 12l4.95 4.95l-1.414 1.415L8 12l6.364-6.364l1.414 1.414l-4.95 4.95Z'/%3E%3C/svg%3E");-webkit-mask:var(--un-icon) no-repeat;mask:var(--un-icon) no-repeat;-webkit-mask-size:100% 100%;mask-size:100% 100%;background-color:currentColor;color:inherit;width:1.2em;height:1.2em}[i-ri-arrow-right-s-line=""]{--un-icon:url("data:image/svg+xml;utf8,%3Csvg viewBox='0 0 24 24' width='1.2em' height='1.2em' xmlns='http://www.w3.org/2000/svg' %3E%3Cpath fill='currentColor' d='m13.171 12l-4.95-4.95l1.415-1.413L16 12l-6.364 6.364l-1.414-1.415l4.95-4.95Z'/%3E%3C/svg%3E");-webkit-mask:var(--un-icon) no-repeat;mask:var(--un-icon) no-repeat;-webkit-mask-size:100% 100%;mask-size:100% 100%;background-color:currentColor;color:inherit;width:1.2em;height:1.2em}[i-ri-arrow-up-s-line=""]{--un-icon:url("data:image/svg+xml;utf8,%3Csvg viewBox='0 0 24 24' width='1.2em' height='1.2em' xmlns='http://www.w3.org/2000/svg' %3E%3Cpath fill='currentColor' d='m12 10.828l-4.95 4.95l-1.414-1.414L12 8l6.364 6.364l-1.415 1.414l-4.95-4.95Z'/%3E%3C/svg%3E");-webkit-mask:var(--un-icon) no-repeat;mask:var(--un-icon) no-repeat;-webkit-mask-size:100% 100%;mask-size:100% 100%;background-color:currentColor;color:inherit;width:1.2em;height:1.2em}[i-ri-calendar-2-line=""]{--un-icon:url("data:image/svg+xml;utf8,%3Csvg viewBox='0 0 24 24' width='1.2em' height='1.2em' xmlns='http://www.w3.org/2000/svg' %3E%3Cpath fill='currentColor' d='M9 1v2h6V1h2v2h4a1 1 0 0 1 1 1v16a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V4a1 1 0 0 1 1-1h4V1h2Zm11 10H4v8h16v-8ZM8 13v2H6v-2h2Zm5 0v2h-2v-2h2Zm5 0v2h-2v-2h2ZM7 5H4v4h16V5h-3v2h-2V5H9v2H7V5Z'/%3E%3C/svg%3E");-webkit-mask:var(--un-icon) no-repeat;mask:var(--un-icon) no-repeat;-webkit-mask-size:100% 100%;mask-size:100% 100%;background-color:currentColor;color:inherit;width:1.2em;height:1.2em}[i-ri-calendar-line=""]{--un-icon:url("data:image/svg+xml;utf8,%3Csvg viewBox='0 0 24 24' width='1.2em' height='1.2em' xmlns='http://www.w3.org/2000/svg' %3E%3Cpath fill='currentColor' d='M9 1v2h6V1h2v2h4a1 1 0 0 1 1 1v16a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V4a1 1 0 0 1 1-1h4V1h2Zm11 10H4v8h16v-8ZM7 5H4v4h16V5h-3v2h-2V5H9v2H7V5Z'/%3E%3C/svg%3E");-webkit-mask:var(--un-icon) no-repeat;mask:var(--un-icon) no-repeat;-webkit-mask-size:100% 100%;mask-size:100% 100%;background-color:currentColor;color:inherit;width:1.2em;height:1.2em}[i-ri-chat-4-line=""]{--un-icon:url("data:image/svg+xml;utf8,%3Csvg viewBox='0 0 24 24' width='1.2em' height='1.2em' xmlns='http://www.w3.org/2000/svg' %3E%3Cpath fill='currentColor' d='M5.763 17H20V5H4v13.385L5.763 17Zm.692 2L2 22.5V4a1 1 0 0 1 1-1h18a1 1 0 0 1 1 1v14a1 1 0 0 1-1 1H6.455Z'/%3E%3C/svg%3E");-webkit-mask:var(--un-icon) no-repeat;mask:var(--un-icon) no-repeat;-webkit-mask-size:100% 100%;mask-size:100% 100%;background-color:currentColor;color:inherit;width:1.2em;height:1.2em}[i-ri-eye-line=""]{--un-icon:url("data:image/svg+xml;utf8,%3Csvg viewBox='0 0 24 24' width='1.2em' height='1.2em' xmlns='http://www.w3.org/2000/svg' %3E%3Cpath fill='currentColor' d='M12 3c5.392 0 9.878 3.88 10.819 9c-.94 5.12-5.427 9-10.819 9c-5.392 0-9.878-3.88-10.818-9C2.122 6.88 6.608 3 12 3Zm0 16a9.005 9.005 0 0 0 8.778-7a9.005 9.005 0 0 0-17.555 0A9.005 9.005 0 0 0 12 19Zm0-2.5a4.5 4.5 0 1 1 0-9a4.5 4.5 0 0 1 0 9Zm0-2a2.5 2.5 0 1 0 0-5a2.5 2.5 0 0 0 0 5Z'/%3E%3C/svg%3E");-webkit-mask:var(--un-icon) no-repeat;mask:var(--un-icon) no-repeat;-webkit-mask-size:100% 100%;mask-size:100% 100%;background-color:currentColor;color:inherit;width:1.2em;height:1.2em}[i-ri-file-list-line=""]{--un-icon:url("data:image/svg+xml;utf8,%3Csvg viewBox='0 0 24 24' width='1.2em' height='1.2em' xmlns='http://www.w3.org/2000/svg' %3E%3Cpath fill='currentColor' d='M20 22H4a1 1 0 0 1-1-1V3a1 1 0 0 1 1-1h16a1 1 0 0 1 1 1v18a1 1 0 0 1-1 1Zm-1-2V4H5v16h14ZM8 7h8v2H8V7Zm0 4h8v2H8v-2Zm0 4h8v2H8v-2Z'/%3E%3C/svg%3E");-webkit-mask:var(--un-icon) no-repeat;mask:var(--un-icon) no-repeat;-webkit-mask-size:100% 100%;mask-size:100% 100%;background-color:currentColor;color:inherit;width:1.2em;height:1.2em}[i-ri-file-word-line=""]{--un-icon:url("data:image/svg+xml;utf8,%3Csvg viewBox='0 0 24 24' width='1.2em' height='1.2em' xmlns='http://www.w3.org/2000/svg' %3E%3Cpath fill='currentColor' d='M16 8v8h-2l-2-2l-2 2H8V8h2v5l2-2l2 2V8h1V4H5v16h14V8h-3ZM3 2.992C3 2.444 3.447 2 3.998 2H16l5 5v13.992A1 1 0 0 1 20.007 22H3.993A1 1 0 0 1 3 21.008V2.992Z'/%3E%3C/svg%3E");-webkit-mask:var(--un-icon) no-repeat;mask:var(--un-icon) no-repeat;-webkit-mask-size:100% 100%;mask-size:100% 100%;background-color:currentColor;color:inherit;width:1.2em;height:1.2em}[i-ri-folder-2-line=""]{--un-icon:url("data:image/svg+xml;utf8,%3Csvg viewBox='0 0 24 24' width='1.2em' height='1.2em' xmlns='http://www.w3.org/2000/svg' %3E%3Cpath fill='currentColor' d='M12.414 5H21a1 1 0 0 1 1 1v14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V4a1 1 0 0 1 1-1h7.414l2 2ZM20 11H4v8h16v-8Zm0-2V7h-8.414l-2-2H4v4h16Z'/%3E%3C/svg%3E");-webkit-mask:var(--un-icon) no-repeat;mask:var(--un-icon) no-repeat;-webkit-mask-size:100% 100%;mask-size:100% 100%;background-color:currentColor;color:inherit;width:1.2em;height:1.2em}.i-ri-heart-line,[i-ri-heart-line=""]{--un-icon:url("data:image/svg+xml;utf8,%3Csvg viewBox='0 0 24 24' width='1.2em' height='1.2em' xmlns='http://www.w3.org/2000/svg' %3E%3Cpath fill='currentColor' d='M12.001 4.529a5.998 5.998 0 0 1 8.242.228a6 6 0 0 1 .236 8.236l-8.48 8.492l-8.478-8.492a6 6 0 0 1 8.48-8.464Zm6.826 1.641a3.998 3.998 0 0 0-5.49-.153l-1.335 1.198l-1.336-1.197a4 4 0 0 0-5.686 5.605L12 18.654l7.02-7.03a4 4 0 0 0-.193-5.454Z'/%3E%3C/svg%3E");-webkit-mask:var(--un-icon) no-repeat;mask:var(--un-icon) no-repeat;-webkit-mask-size:100% 100%;mask-size:100% 100%;background-color:currentColor;color:inherit;width:1.2em;height:1.2em}[i-ri-home-4-line=""]{--un-icon:url("data:image/svg+xml;utf8,%3Csvg viewBox='0 0 24 24' width='1.2em' height='1.2em' xmlns='http://www.w3.org/2000/svg' %3E%3Cpath fill='currentColor' d='M19 21H5a1 1 0 0 1-1-1v-9H1l10.327-9.388a1 1 0 0 1 1.346 0L23 11h-3v9a1 1 0 0 1-1 1Zm-6-2h5V9.158l-6-5.455l-6 5.455V19h5v-6h2v6Z'/%3E%3C/svg%3E");-webkit-mask:var(--un-icon) no-repeat;mask:var(--un-icon) no-repeat;-webkit-mask-size:100% 100%;mask-size:100% 100%;background-color:currentColor;color:inherit;width:1.2em;height:1.2em}[i-ri-price-tag-3-line=""]{--un-icon:url("data:image/svg+xml;utf8,%3Csvg viewBox='0 0 24 24' width='1.2em' height='1.2em' xmlns='http://www.w3.org/2000/svg' %3E%3Cpath fill='currentColor' d='m10.904 2.1l9.9 1.414l1.414 9.9l-9.193 9.192a1 1 0 0 1-1.414 0l-9.9-9.9a1 1 0 0 1 0-1.413L10.905 2.1Zm.707 2.121L3.833 12l8.485 8.485l7.779-7.778l-1.061-7.425l-7.425-1.06Zm2.122 6.364a2 2 0 1 1 2.828-2.828a2 2 0 0 1-2.828 2.828Z'/%3E%3C/svg%3E");-webkit-mask:var(--un-icon) no-repeat;mask:var(--un-icon) no-repeat;-webkit-mask-size:100% 100%;mask-size:100% 100%;background-color:currentColor;color:inherit;width:1.2em;height:1.2em}[i-ri-pushpin-line=""]{--un-icon:url("data:image/svg+xml;utf8,%3Csvg viewBox='0 0 24 24' width='1.2em' height='1.2em' xmlns='http://www.w3.org/2000/svg' %3E%3Cpath fill='currentColor' d='m13.827 1.69l8.486 8.485l-1.415 1.414l-.707-.707l-4.242 4.243l-.707 3.535l-1.415 1.415l-4.242-4.243l-4.95 4.95l-1.414-1.414l4.95-4.95l-4.243-4.243l1.414-1.414l3.536-.707L13.12 3.81l-.707-.707l1.414-1.414Zm.707 3.535l-4.67 4.671l-2.822.565l6.5 6.5l.564-2.822l4.671-4.67l-4.243-4.244Z'/%3E%3C/svg%3E");-webkit-mask:var(--un-icon) no-repeat;mask:var(--un-icon) no-repeat;-webkit-mask-size:100% 100%;mask-size:100% 100%;background-color:currentColor;color:inherit;width:1.2em;height:1.2em}[i-ri-search-line=""]{--un-icon:url("data:image/svg+xml;utf8,%3Csvg viewBox='0 0 24 24' width='1.2em' height='1.2em' xmlns='http://www.w3.org/2000/svg' %3E%3Cpath fill='currentColor' d='m18.031 16.617l4.283 4.282l-1.415 1.415l-4.282-4.283A8.96 8.96 0 0 1 11 20c-4.968 0-9-4.032-9-9s4.032-9 9-9s9 4.032 9 9a8.96 8.96 0 0 1-1.969 5.617Zm-2.006-.742A6.977 6.977 0 0 0 18 11c0-3.867-3.133-7-7-7s-7 3.133-7 7s3.133 7 7 7a6.977 6.977 0 0 0 4.875-1.975l.15-.15Z'/%3E%3C/svg%3E");-webkit-mask:var(--un-icon) no-repeat;mask:var(--un-icon) no-repeat;-webkit-mask-size:100% 100%;mask-size:100% 100%;background-color:currentColor;color:inherit;width:1.2em;height:1.2em}[i-ri-timer-line=""]{--un-icon:url("data:image/svg+xml;utf8,%3Csvg viewBox='0 0 24 24' width='1.2em' height='1.2em' xmlns='http://www.w3.org/2000/svg' %3E%3Cpath fill='currentColor' d='m17.618 5.968l1.453-1.453l1.414 1.414l-1.453 1.453A9 9 0 1 1 12 4c2.125 0 4.078.736 5.618 1.968ZM12 20a7 7 0 1 0 0-14a7 7 0 0 0 0 14ZM11 8h2v6h-2V8ZM8 1h8v2H8V1Z'/%3E%3C/svg%3E");-webkit-mask:var(--un-icon) no-repeat;mask:var(--un-icon) no-repeat;-webkit-mask-size:100% 100%;mask-size:100% 100%;background-color:currentColor;color:inherit;width:1.2em;height:1.2em}[i-ri-translate=""]{--un-icon:url("data:image/svg+xml;utf8,%3Csvg viewBox='0 0 24 24' width='1.2em' height='1.2em' xmlns='http://www.w3.org/2000/svg' %3E%3Cpath fill='currentColor' d='M5 15v2a2 2 0 0 0 1.85 1.994L7 19h3v2H7a4 4 0 0 1-4-4v-2h2Zm13-5l4.4 11h-2.155l-1.201-3h-4.09l-1.199 3h-2.154L16 10h2Zm-1 2.885L15.753 16h2.492L17 12.885ZM8 2v2h4v7H8v3H6v-3H2V4h4V2h2Zm9 1a4 4 0 0 1 4 4v2h-2V7a2 2 0 0 0-2-2h-3V3h3ZM6 6H4v3h2V6Zm4 0H8v3h2V6Z'/%3E%3C/svg%3E");-webkit-mask:var(--un-icon) no-repeat;mask:var(--un-icon) no-repeat;-webkit-mask-size:100% 100%;mask-size:100% 100%;background-color:currentColor;color:inherit;width:1.2em;height:1.2em}[i~=ri-sun-line]{--un-icon:url("data:image/svg+xml;utf8,%3Csvg viewBox='0 0 24 24' width='1.2em' height='1.2em' xmlns='http://www.w3.org/2000/svg' %3E%3Cpath fill='currentColor' d='M12 18a6 6 0 1 1 0-12a6 6 0 0 1 0 12Zm0-2a4 4 0 1 0 0-8a4 4 0 0 0 0 8ZM11 1h2v3h-2V1Zm0 19h2v3h-2v-3ZM3.515 4.929l1.414-1.414L7.05 5.636L5.636 7.05L3.515 4.93ZM16.95 18.364l1.414-1.414l2.121 2.121l-1.414 1.414l-2.121-2.121Zm2.121-14.85l1.414 1.415l-2.121 2.121l-1.414-1.414l2.121-2.121ZM5.636 16.95l1.414 1.414l-2.121 2.121l-1.414-1.414l2.121-2.121ZM23 11v2h-3v-2h3ZM4 11v2H1v-2h3Z'/%3E%3C/svg%3E");-webkit-mask:var(--un-icon) no-repeat;mask:var(--un-icon) no-repeat;-webkit-mask-size:100% 100%;mask-size:100% 100%;background-color:currentColor;color:inherit;width:1.2em;height:1.2em}.yun-card{margin:auto;--un-shadow:var(--un-shadow-inset) 0 1px 3px 0 var(--un-shadow-color, rgba(0,0,0,.1)),var(--un-shadow-inset) 0 1px 2px -1px var(--un-shadow-color, rgba(0,0,0,.1));box-shadow:var(--un-ring-offset-shadow),var(--un-ring-shadow),var(--un-shadow);transition-property:color,background-color,border-color,outline-color,text-decoration-color,fill,stroke,opacity,box-shadow,transform,filter,backdrop-filter;transition-timing-function:cubic-bezier(.4,0,.2,1);transition-duration:.15s;transition-duration:var(--va-transition-duration)}.btn{display:inline-block;cursor:pointer;border-radius:.25rem;background-color:var(--va-c-primary);padding:.25rem 1rem;--un-text-opacity:1;color:rgba(255,255,255,var(--un-text-opacity));transition-property:color,background-color,border-color,outline-color,text-decoration-color,fill,stroke,opacity,box-shadow,transform,filter,backdrop-filter;transition-timing-function:cubic-bezier(.4,0,.2,1);transition-duration:.15s}.flex-center{display:flex;align-items:center;justify-content:center}.btn:disabled{cursor:default;--un-bg-opacity:1;background-color:rgba(75,85,99,var(--un-bg-opacity));opacity:.5}.va-card{background-color:var(--va-c-bg-light);--un-shadow:var(--un-shadow-inset) 0 1px 3px 0 var(--un-shadow-color, rgba(0,0,0,.1)),var(--un-shadow-inset) 0 1px 2px -1px var(--un-shadow-color, rgba(0,0,0,.1));box-shadow:var(--un-ring-offset-shadow),var(--un-ring-shadow),var(--un-shadow)}.btn:hover{background-color:var(--va-c-primary-light)}.va-card:hover,.yun-card:hover{--un-shadow:var(--un-shadow-inset) 0 10px 15px -3px var(--un-shadow-color, rgba(0,0,0,.1)),var(--un-shadow-inset) 0 4px 6px -4px var(--un-shadow-color, rgba(0,0,0,.1));box-shadow:var(--un-ring-offset-shadow),var(--un-ring-shadow),var(--un-shadow)}@media (max-width:767.9px){.yun-main{padding-left:0}}.fixed{position:fixed}.relative{position:relative}[bottom~="19"]{bottom:4.75rem}[right~="2"]{right:.5rem}.z-350{z-index:350}[z~="$yun-z-menu-btn"]{z-index:var(--yun-z-menu-btn)}[z~="$yun-z-sidebar"]{z-index:var(--yun-z-sidebar)}[m~="0"]{margin:0}[m~="2"]{margin:.5rem}[m~=y-4]{margin-top:1rem;margin-bottom:1rem}[my~="1"]{margin-top:.25rem;margin-bottom:.25rem}[m~=x-1]{margin-left:.25rem;margin-right:.25rem}[mx~="2"],[m~=x-2]{margin-left:.5rem;margin-right:.5rem}[m~=y-2]{margin-top:.5rem;margin-bottom:.5rem}[mb~="4"],[m~=b-4]{margin-bottom:1rem}.mb-2,[m~=b-2]{margin-bottom:.5rem}[ml-1=""],[m~=l-1]{margin-left:.25rem}[m~=t-4]{margin-top:1rem}[mt-6=""],[m~=t-6]{margin-top:1.5rem}[m~=l-4]{margin-left:1rem}[m~=r-1]{margin-right:.25rem}[m~=t-0]{margin-top:0}[m~=t-16]{margin-top:4rem}[mt~="2"]{margin-top:.5rem}[h~="8"]{height:2rem}[h~="5"]{height:1.25rem}[w~="8"]{width:2rem}[w~=full]{width:100%}[h~="64"]{height:16rem}[min-h~="100px"]{min-height:100px}.flex,[flex~="~"]{display:flex}.inline-flex,[inline-flex=""]{display:inline-flex}.flex-grow,[flex~=grow]{flex-grow:1}[flex~=col]{flex-direction:column}@keyframes pulse{0%,to{opacity:1}50%{opacity:.5}}.animate-pulse{animation:pulse 2s cubic-bezier(.4,0,.6,1) infinite}[cursor~=pointer]{cursor:pointer}.items-center,[items~=center]{align-items:center}.justify-center,[justify~=center]{justify-content:center}.gap-2{gap:.5rem}[overflow~=auto]{overflow:auto}[border~="~"]{border-width:1px}[border~=rounded]{border-radius:.25rem}.rounded-full{border-radius:9999px}[bg~="$va-c-bg-light"]{background-color:var(--va-c-bg-light)}[bg~="$yun-sidebar-bg-color"]{background-color:var(--yun-sidebar-bg-color)}[bg~=contain]{background-size:contain}[bg~=no-repeat]{background-repeat:no-repeat}[stroke-width~="2"]{stroke-width:2px}.p-4,[p~="4"]{padding:1rem}[p~="1"]{padding:.25rem}[p~="2"]{padding:.5rem}[p~=x-4]{padding-left:1rem;padding-right:1rem}[py~="1"]{padding-top:.25rem;padding-bottom:.25rem}[p~=b-8]{padding-bottom:2rem}[p~=l-4]{padding-left:1rem}[text~=center]{text-align:center}[text~="2xl"]{font-size:1.5rem;line-height:2rem}[text-xl=""],[text~=xl]{font-size:1.25rem;line-height:1.75rem}[text~=xs]{font-size:.75rem;line-height:1rem}[text~=sm]{font-size:.875rem;line-height:1.25rem}[font~=black]{font-weight:900}.leading-none{line-height:1}[color~="$va-c-warning"]{color:var(--va-c-warning)}.text-\$va-c-text-light{color:var(--va-c-text-light)}[text~=red-400]{--un-text-opacity:1;color:rgba(248,113,113,var(--un-text-opacity))}.shadow{--un-shadow:var(--un-shadow-inset) 0 1px 3px 0 var(--un-shadow-color, rgba(0,0,0,.1)),var(--un-shadow-inset) 0 1px 2px -1px var(--un-shadow-color, rgba(0,0,0,.1));box-shadow:var(--un-ring-offset-shadow),var(--un-ring-shadow),var(--un-shadow)}[font~=serif]{font-family:var(--va-font-serif)}@media (max-width:767.9px){.lt-md\:ml-0{margin-left:0}[p~="lt-md:0"]{padding:0}}@media (min-width:640px){.sm\:px-6{padding-left:1.5rem;padding-right:1.5rem}}@media (min-width:1024px){.lg\:px-12{padding-left:3rem;padding-right:3rem}}@media (min-width:1280px){.xl\:hidden{display:none}.xl\:px-16{padding-left:4rem;padding-right:4rem}}.va-toc[data-v-22b646a4]{text-align:left}.content[data-v-22b646a4]{position:relative;padding-left:16px;font-size:14px;text-align:left}.outline-marker[data-v-22b646a4]{position:absolute;top:32px;left:-2px;z-index:0;opacity:0;width:4px;height:18px;background-color:var(--va-c-brand);transition:top .25s cubic-bezier(0,1,.5,1),background-color .5s,opacity .25s;border-top-right-radius:2px;border-bottom-right-radius:2px}.outline-title[data-v-22b646a4]{letter-spacing:.4px;line-height:28px;font-size:14px;font-weight:600}.visually-hidden[data-v-22b646a4]{position:absolute;width:1px;height:1px;white-space:nowrap;clip:rect(0 0 0 0);clip-path:inset(50%);overflow:hidden}.yun-aside{position:fixed;right:0;top:0;bottom:0;width:var(--va-sidebar-width,300px);transform:translate(100%);transition:box-shadow var(--va-transition-duration),background-color var(--va-transition-duration),opacity .25s,transform var(--va-transition-duration) cubic-bezier(.19,1,.22,1)}@media screen and (min-width:1280px){.yun-aside{transform:translate(0)}}.toc-btn{color:var(--va-c-primary);background-color:#fff;z-index:var(--yun-z-toc-btn)}.post-nav-next .title,.post-nav-prev .title{overflow:hidden;max-width:10rem}.post-nav-next .icon,.post-nav-prev .icon{width:1.2rem;height:1.2rem}@media screen and (min-width:1024px){.post-nav-next .title,.post-nav-prev .title{max-width:18rem}}@media screen and (min-width:1280px){.content{max-width:calc(100vw - 2 * var(--va-sidebar-width) - 1rem - 8px)}}:root{--page-btn-bg-color:rgba(255, 255, 255, .5);--page-btn-hover-bg-color:var(--va-c-primary-lighter);--page-btn-active-bg-color:var(--va-c-primary-light)}@-webkit-keyframes lg-right-end{0%{left:0}50%{left:-30px}to{left:0}}@-webkit-keyframes lg-left-end{0%{left:0}50%{left:30px}to{left:0}}:root{--banner-line-color:black;--banner-char-color:black;--banner-char-bg-color:rgba(255, 255, 255, .5);--banner-char-hover-color:white}.sponsor-button div{transform:scale(1.1);transition:transform var(--va-transition-duration) ease-in-out}.sponsor-button:hover div{transform:scale(1.2)}:root{--waline-font-size:1rem;--waline-white:#fff;--waline-light-grey:#999;--waline-dark-grey:#666;--waline-theme-color:#27ae60;--waline-active-color:#2ecc71;--waline-color:#444;--waline-bgcolor:#fff;--waline-bgcolor-light:#f8f8f8;--waline-bgcolor-hover:#f0f0f0;--waline-border-color:#ddd;--waline-disable-bgcolor:#f8f8f8;--waline-disable-color:#000;--waline-code-bgcolor:#282c34;--waline-bq-color:#f0f0f0;--waline-avatar-size:3.25rem;--waline-m-avatar-size:calc(var(--waline-avatar-size) * 9 / 13);--waline-badge-color:#3498db;--waline-badge-font-size:.75em;--waline-info-bgcolor:#f8f8f8;--waline-info-color:#999;--waline-info-font-size:.625em;--waline-border:1px solid var(--waline-border-color);--waline-avatar-radius:50%;--waline-box-shadow:none}:root{--waline-theme-color:var(--va-c-primary);--waline-active-color:var(--va-c-primary-light)}</style><link rel="preload" href="/assets/index-e381b313.css" as="style"><link rel="modulepreload" crossorigin href="/js/posts/Deep Study of Java Concurrent Programming - Advanced Chapter.4a26fe5a.js"><title>Ê∑±ÂÖ•Â≠¶‰π†JavaÂπ∂ÂèëÁºñÁ®ã-È´òÁ∫ßÁØá - imklaus's Blog</title><link rel="icon" href="https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230825001534253.png" type="image/png"><meta name="theme-color" content="#ffffff"><meta name="msapplication-TileColor" content="#ffffff"><meta name="generator" content="Valaxy 0.14.61"><meta name="description" content><meta property="og:description" content><meta property="og:locale" content="zh-CN"><meta property="og:site_name" content="imklaus's Blog "><meta property="og:title" content="Ê∑±ÂÖ•Â≠¶‰π†JavaÂπ∂ÂèëÁºñÁ®ã-È´òÁ∫ßÁØá"><meta property="og:image" content="https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/wallhaven-j52r8w_1920x1080.png"><meta property="og:url" content="https://imlklaus.github.io/"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@900&amp;display=swap"><link rel="preload" as="font" crossorigin="anonymous" href="/assets/KaTeX_AMS-Regular-0cdd387c.woff2"><link rel="preload" as="font" crossorigin="anonymous" href="/assets/KaTeX_Caligraphic-Bold-de7701e4.woff2"><link rel="preload" as="font" crossorigin="anonymous" href="/assets/KaTeX_Caligraphic-Regular-5d53e70a.woff2"><link rel="preload" as="font" crossorigin="anonymous" href="/assets/KaTeX_Fraktur-Bold-74444efd.woff2"><link rel="preload" as="font" crossorigin="anonymous" href="/assets/KaTeX_Fraktur-Regular-51814d27.woff2"><link rel="preload" as="font" crossorigin="anonymous" href="/assets/KaTeX_Main-Bold-0f60d1b8.woff2"><link rel="preload" as="font" crossorigin="anonymous" href="/assets/KaTeX_Main-BoldItalic-99cd42a3.woff2"><link rel="preload" as="font" crossorigin="anonymous" href="/assets/KaTeX_Main-Italic-97479ca6.woff2"><link rel="preload" as="font" crossorigin="anonymous" href="/assets/KaTeX_Main-Regular-c2342cd8.woff2"><link rel="preload" as="font" crossorigin="anonymous" href="/assets/KaTeX_Math-BoldItalic-dc47344d.woff2"><link rel="preload" as="font" crossorigin="anonymous" href="/assets/KaTeX_Math-Italic-7af58c5e.woff2"><link rel="preload" as="font" crossorigin="anonymous" href="/assets/KaTeX_SansSerif-Bold-e99ae511.woff2"><link rel="preload" as="font" crossorigin="anonymous" href="/assets/KaTeX_SansSerif-Italic-00b26ac8.woff2"><link rel="preload" as="font" crossorigin="anonymous" href="/assets/KaTeX_SansSerif-Regular-68e8c73e.woff2"><link rel="preload" as="font" crossorigin="anonymous" href="/assets/KaTeX_Script-Regular-036d4e95.woff2"><link rel="preload" as="font" crossorigin="anonymous" href="/assets/KaTeX_Size1-Regular-6b47c401.woff2"><link rel="preload" as="font" crossorigin="anonymous" href="/assets/KaTeX_Size2-Regular-d04c5421.woff2"><link rel="preload" as="font" crossorigin="anonymous" href="data:font/woff2;base64,d09GMgABAAAAAA4oAA4AAAAAHbQAAA3TAAEAAAAAAAAAAAAAAAAAAAAAAAAAAAAABmAAgRQIDgmcDBEICo1oijYBNgIkA14LMgAEIAWJAAeBHAyBHBvbGiMRdnO0IkRRkiYDgr9KsJ1NUAf2kILNxgUmgqIgq1P89vcbIcmsQbRps3vCcXdYOKSWEPEKgZgQkprQQsxIXUgq0DqpGKmIvrgkeVGtEQD9DzAO29fM9jYhxZEsL2FeURH2JN4MIcTdO049NCVdxQ/w9NrSYFEBKTDKpLKfNkCGDc1RwjZLQcm3vqJ2UW9Xfa3tgAHz6ivp6vgC2yD4/6352ndnN0X0TL7seypkjZlMsjmZnf0Mm5Q+JykRWQBKCVCVPbARPXWyQtb5VgLB6Biq7/Uixcj2WGqdI8tGSgkuRG+t910GKP2D7AQH0DB9FMDW/obJZ8giFI3Wg8Cvevz0M+5m0rTh7XDBlvo9Y4vm13EXmfttwI4mBo1EG15fxJhUiCLbiiyCf/ZA6MFAhg3pGIZGdGIVjtPn6UcMk9A/UUr9PhoNsCENw1APAq0gpH73e+M+0ueyHbabc3vkbcdtzcf/fiy+NxQEjf9ud/ELBHAXJ0nk4z+MXH2Ev/kWyV4k7SkvpPc9Qr38F6RPWnM9cN6DJ0AdD1BhtgABtmoRoFCvPsBAumNm6soZG2Gk5GyVTo2sJncSyp0jQTYoR6WDvTwaaEcHsxHfvuWhHA3a6bN7twRKtcGok6NsCi7jYRrM2jExsUFMxMQYuJbMhuWNOumEJy9hi29Dmg5zMp/A5+hhPG19j1vBrq8JTLr8ki5VLPmG/PynJHVul440bxg5xuymHUFPBshC+nA9I1FmwbRBTNHAcik3Oae0cxKoI3MOriM42UrPe51nsaGxJ+WfXubAsP84aabUlQSJ1IiE0iPETLUU4CATgfXSCSpuRFRmCGbO+wSpAnzaeaCYW1VNEysRtuXCEL1kUFUbbtMv3Tilt/1c11jt3Q5bbMa84cpWipp8Elw3MZhOHsOlwwVUQM3lAR35JiFQbaYCRnMF2lxAWoOg2gyoIV4PouX8HytNIfLhqpJtXB4vjiViUI8IJ7bkC4ikkQvKksnOTKICwnqWSZ9YS5f0WCxmpgjbIq7EJcM4aI2nmhLNY2JIUgOjXZFWBHb+x5oh6cwb0Tv1ackHdKi0I9OO2wE9aogIOn540CCCziyhN+IaejtgAONKznHlHyutPrHGwCx9S6B8kfS4Mfi4Eyv7OU730bT1SCBjt834cXsf43zVjPUqqJjgrjeGnBxSG4aYAKFuVbeCfkDIjAqMb6yLNIbCuvXhMH2/+k2vkNpkORhR59N1CkzoOENvneIosjYmuTxlhUzaGEJQ/iWqx4dmwpmKjrwTiTGTCVozNAYqk/zXOndWxuWSmJkQpJw3pK5KX6QrLt5LATMqpmPAQhkhK6PUjzHUn7E0gHE0kPE0iKkolgkUx9SZmVAdDgpffdyJKg3k7VmzYGCwVXGz/tXmkOIp+vcWs+EMuhhvN0h9uhfzWJziBQmCREGSIFmQIkgVpAnSBRmC//6hkLZwaVhwxlrJSOdqlFtOYxlau9F2QN5Y98xmIAsiM1HVp2VFX+DHHGg6Ecjh3vmqtidX3qHI2qycTk/iwxSt5UzTmEP92ZBnEWTk4Mx8Mpl78ZDokxg/KWb+Q0QkvdKVmq3TMW+RXEgrsziSAfNXFMhDc60N5N9jQzjfO0kBKpUZl0ZmwJ41j/B9Hz6wmRaJB84niNmQrzp9eSlQCDDzazGDdVi3P36VZQ+Jy4f9UBNp+3zTjqI4abaFAm+GShVaXlsGdF3FYzZcDI6cori4kMxUECl9IjJZpzkvitAoxKue+90pDMvcKRxLl53TmOKCmV/xRolNKSqqUxc6LStOETmFOiLZZptlZepcKiAzteG8PEdpnQpbOMNcMsR4RR2Bs0cKFEvSmIjAFcnarqwUL4lDhHmnVkwu1IwshbiCcgvOheZuYyOteufZZwlcTlLgnZ3o/WcYdzZHW/WGaqaVfmTZ1aWCceJjkbZqsfbkOtcFlUZM/jy+hXHDbaUobWqqXaeWobbLO99yG5N3U4wxco0rQGGcOLASFMXeJoham8M+/x6O2WywK2l4HGbq1CoUyC/IZikQhdq3SiuNrvAEj0AVu9x2x3lp/xWzahaxidezFVtdcb5uEnzyl0ZmYiuKI0exvCd4Xc9CV1KB0db00z92wDPde0kukbvZIWN6jUWFTmPIC/Y4UPCm8UfDTFZpZNon1qLFTkBhxzB+FjQRA2Q/YRJT8pQigslMaUpFyAG8TMlXigiqmAZX4xgijKjRlGpLE0GdplRfCaJo0JQaSxNBk6ZmMzcya0FmrcisDdn0Q3HI2sWSppYigmlM1XT/kLQZSNpMJG0WkjYbSZuDpM1F0uYhFc1HxU4m1QJjDK6iL0S5uSj5rgXc3RejEigtcRBtqYPQsiTskmO5vosV+q4VGIKbOkDg0jtRrq+Em1YloaTFar3EGr1EUC8R0kus1Uus00usL97ABr2BjXoDm/QGNhuWtMVBKOwg/i78lT7hBsAvDmwHc/ao3vmUbBmhjeYySZNWvGkfZAgISDSaDo1SVpzGDsAEkF8B+gEapViUoZgUWXcRIGFZNm6gWbAKk0bp0k1MHG9fLYtV4iS2SmLEQFARzRcnf9PUS0LVn05/J9MiRRBU3v2IrvW974v4N00L7ZMk0wXP1409CHo/an8zTRHD3eSJ6m8D4YMkZNl3M79sqeuAsr/m3f+8/yl7A50aiAEJgeBeMWzu7ui9UfUBCe2TIqZIoOd/3/udRBOQidQZUERzb2/VwZN1H/Sju82ew2H2Wfr6qvfVf3hqwDvAIpkQVFy4B9Pe9e4/XvPeceu7h3dvO56iJPf0+A6cqA2ip18ER+iFgggiuOkvj24bby0N9j2UHIkgqIt+sVgfodC4YghLSMjSZbH0VR/6dMDrYJeKHilKTemt6v6kvzvn3/RrdWtr0GoN/xL+Sex/cPYLUpepx9cz/D46UPU5KXgAQa+NDps1v6J3xP1i2HtaDB0M9aX2deA7SYff//+gUCovMmIK/qfsFcOk+4Y5ZN97XlG6zebqtMbKgeRFi51vnxTQYBUik2rS/Cn6PC8ADR8FGxsRPB82dzfND90gIcshOcYUkfjherBz53odpm6TP8txlwOZ71xmfHHOvq053qFF/MRlS3jP0ELudrf2OeN8DHvp6ZceLe8qKYvWz/7yp0u4dKPfli3CYq0O13Ih71mylJ80tOi10On8wi+F4+LWgDPeJ30msSQt9/vkmHq9/Lvo2b461mP801v3W4xTcs6CbvF9UDdrSt+A8OUbpSh55qAUFXWznBBfdeJ8a4d7ugT5tvxUza3h9m4H7ptTqiG4z0g5dc0X29OcGlhpGFMpQo9ytTS+NViZpNdvU4kWx+LKxNY10kQ1yqGXrhe4/1nvP7E+nd5A92TtaRplbHSqoIdOqtRWti+fkB5/n1+/VvCmz12pG1kpQWsfi1ftlBobm0bpngs16CHkbIwdLnParxtTV3QYRlfJ0KFskH7pdN/YDn+yRuSd7sNH3aO0DYPggk6uWuXrfOc+fa3VTxFVvKaNxHsiHmsXyCLIE5yuOeN3/Jdf8HBL/5M6shjyhxHx9BjB1O0+4NLOnjLLSxwO7ukN4jMbOIcD879KLSi6Pk61Oqm2377n8079PXEEQ7cy7OKEC9nbpet118fxweTafpt69x/Bt8UqGzNQt7aelpc44dn5cqhwf71+qKp/Zf/+a0zcizOUWpl/iBcSXip0pplkatCchoH5c5aUM8I7/dWxAej8WicPL1URFZ9BDJelUwEwTkGqUhgSlydVes95YdXvhh9Gfz/aeFWvgVb4tuLbcv4+wLdutVZv/cUonwBD/6eDlE0aSiKK/uoH3+J1wDE/jMVqY2ysGufN84oIXB0sPzy8ollX/LegY74DgJXJR57sn+VGza0x3DnuIgABFM15LmajjjsNlYj+JEZGbuRYcAMOWxFkPN2w6Wd46xo4gVWQR/X4lyI/R6K/YK0110GzudPRW7Y+UOBGTfNNzHeYT0fiH0taunBpq9HEW8OKSaBGj21L0MqenEmNRWBAWDWAk4CpNoEZJ2tTaPFgbQYj8HxtFilErs3BTRwT8uO1NXQaWfIotchmPkAF5mMBAliEmZiOGVgCG9LgRzpscMAOOwowlT3JhusdazXGSC/hxR3UlmWVwWHpOIKheqONvjyhSiTHIkVUco5bnji8m//zL7PKaT1Vl5I6UE609f+gkr6MZKVyKc7zJRmCahLsdlyA5fdQkRSan9LgnnLEyGSkaKJCJog0wAgvepWBt80+1yKln1bMVtCljfNWDueKLsWwaEbBSfSPTEmVRsUcYYMnEjcjeyCZzBXK9E9BYBXLKjOSpUDR+nEV3TFSUdQaz+ot98QxgXwx0GQ+EEUAKB2qZPkQQ0GqFD8UPFMqyaCHM24BZmSGic9EYMagKizOw9Hz50DMrDLrqqLkTAhplMictiCAx5S3BIUQdeJeLnBy2CNtMfz6cV4u8XKoFZQesbf9YZiIERiHjaNodDW6LgcirX/mPnJIkBGDUpTBhSa0EIr38D5hCIszhCM8URGBqImoWjpvpt1ebu/v3Gl3qJfMnNM+9V+kiRFyROTPHQWOcs1dNW94/ukKMPZBvDi55i5CttdeJz84DLngLqjcdwEZ87bFFR8CIG35OAkDVN6VRDZ7aq67NteYqZ2lpT8oYB2CytoBd6VuAx4WgiAsnuj3WohG+LugzXiQRDeM3XYXlULv4dp5VFYC"><link rel="preload" as="font" crossorigin="anonymous" href="/assets/KaTeX_Size4-Regular-a4af7d41.woff2"><link rel="preload" as="font" crossorigin="anonymous" href="/assets/KaTeX_Typewriter-Regular-71d517d6.woff2"><link rel="preload" as="font" crossorigin="anonymous" href="data:font/woff2;base64,d09GMgABAAAAAAkcAAsAAAAAEogAAAjNAAEAAAAAAAAAAAAAAAAAAAAAAAAAAAAABmAAgSQRCAqcLJZKCzoAATYCJANwBCAFgkoHIBupDgDm53Gzej8JpU0wqygVVyoWwphIsuuw60jpmBY6ppTa7mk7jtx57UQ0V2ulvfmteSIQji061T2HvfDEECASKizU5VUQXFjFRtgYTVg+woiYDVezOThR4tAvr/YYgOO/RZ+BAABzYtMA8Kl8Neg3UIDCoCkOyWBuLcCvSHycH78QvhFxmUCK03A0RwGSvXBAHgR8UB8DMvocJYAgbiZiJnqmYGbXjG3mz7P8nHhe8Uvxr0j+fzwPABAjWT1E83IJHh/x87G/jv1l7JtYR+y+WF2MKAai/qfDtfIRt7hBikI8D1IpipXqWqYSDgDBfwE7qDLw5EEALqFRDMKAsApNwchXAJgFL/WETMbKcDVSifR6QkjwkDaRTEugqlBtKVcL6Smi1dHlIqUmuii6Pic1JTIlFTX3uRenMNpiCiKOCZBm2ges0b/ScigDVgcb2MEHfloel7e1z208KrZUeQFjK0dIkbl6FOFczRhFE6zaRklPlz52tOXcKtmpdqisgHnbxRatg66vsZNHaWMPQ/eZmH6jaavlNASsipbKwVZSYrRm1mywI0670UEdhLy+yuscolSZJHKwg5IyNzRJQbKRZiicwnYiChjO1vSbKCBpkAgCjGIb6KCvA5GL0VHeUDwAQEHkSC2ToBJhKN9KAneim2ekLf1vENf3mjT3vAS295XY2MMgzRpSqTVWpt4ang+ksXynRUQPlkFOu+b6Yw0jBp8krbXbYbjc5mn6KpsNWKtqtcNz0D8xTTQKzthbZYAxLev3NkFgyYWsngBjGo8jg6a9Y3rKR9Pfqun10RvJi9X9foZGvrltMkJgWR7dhI7SSITEaBWIQQTMUSOJkTi5nlqpZUfNKcYD1Do/ZdkbR8UeVpKLSbMVgKLX0flzQYqCrLpll+/vus2IM9+lbdTgWWRLQJqvaq7eHKulgL2ssp7LrpxR2DBI/ja1zXvi7cS1E0Gr0uhy7PUGwPmdkkdjEYOjpGnQRXowC/GBq51eymLRXrsXsTzXX37VlXzeVxoI6m8Gy67oBnzsB6DoQYY7GHM2fbT4oS9zON45lPnwbmww2BL0G89EnfaVPi5eJ3NZFtjc277Wb9M1A+UWG2WZyrj6PMKmLHRoH04iZLuivlsHTmm9/qYJ1r2Z90DtuKYduK6SdNZ3dRRxHAoE+l4HGM6MyIe+0se+zHEfsP4s2sqqnVdSTE/8lCVYMRVsuBVEJOvT3fa1Xr4X2iDZflVFmxyDmpu1r8b9IsVzXUB9w1/l9ccf7WCszaI1ATtUx7oRztk1dtbBcciudJAi83Vv2yaTg9uON6toxLlIM2GVxClo2eVBt5gcOHRwHLIpptC92TeKRi3MjtBkTAOaoU+6P1q364+kdgt/+xh2fRvlOf2p5xR4ut7P4s0sPwY63OguajQWuYqMjUWaA9100ya6yHdHr/BMyxN9QmGa2zjPnbZr17KTy9weKwqXYtqjcMunRkgE9kP+Refvml14hAZw8WFQGmZnnaEi0eLUQTCc+tLSphVyaUH6lAJoXjF1MDiaFSOexNCRKYW8TOkhKzDEDjPDvHHI3c5hXbQLhujhUuPmBYd+N/EaktFsDqoDo4/G0yx70s3SSuXJDIvjMNsIQ7TDqb+/sv8NHGl6BvDAMOnsCpv9PQcP9tS6N294zEnwtNdt2tfTXSz7JGwAqALmbKpr90BaeqA9tlvduWP4/xa0thZcJMNDC6XqrFuy2xGF7YaiQkN7UfhEbMaNkOxQHezh7YVFBsP9TcoybgmzhaExmpxb/78Naf89LmVWthVvvSWh3rZUWtlMFStWENDf5uqEd2LiP/M/fvWEWUntjnTynpI2ainnLdjPUIvL2uGFJvoUQy0taZvPePLqxy0lK6mUo8yp6B+WtdyyTHivdrgLZrhbvAOlWMbQEJtJZ7JuXgRLC+hwe/kb90WvW4U4/PGGRUmLk995J1loWLRhQwVCKkve4JOS8YJASY+P8KQNe/vahGNU8TJRe/eCaaG7ozsrt6Ixu623v/ck0rvlG2EYBoAh6abIxoZ9UeHoNQAiMPKv/8pIi+47EAMHcfLh7dyX8q0Po+Iap94fFob+4fr/DXr96x+j1x2dhZ0dBfRqardjBIZ+M+S6Lo6ojE+4HKF7Kz7zG+eCOkwQ98UfOirDqrckKPVz3sR8srT/gsev3H0p3Rq7wkD1JLE/XZ+2Ze5pV5eqPiqqmBkc1PQYDBvlk5MdqQff21UyInvyhyjMsHXV33tD3zaQ7Us/NKfX44qLQ/8ffOtzXIjnymRNXampDWkGDR5yOyThG2/9UXC6liWEEz0hX+uR1Xg780i4eNOSig3Fk2pSkPpBqrrmx3/+TbB2ya9ePfrGJx98H8rvjKsRQoSh/G0s8cO6bhwwUI8vUz1c21B04cscrjVV1q8zzCVJkmv/T8y21/bLszJpxeqptculJZpleUyKrPX/X3QZBL+rl+hTWuR/2At7LhYVX9BBsULaqi9LWh+6xMDLW6V65dy2gsMbszemQ96XMDvrSfRM60ceo5R/oGDXB0KrxJsTACBhbV48S4Cd5IeyAVdU5Yg+2nPGKS+XAwmOljrwpIdMmdJPexI9ndnIXUIVgety83YzRdXD6E6YvF0gVGJRMhpOyQW6xGM0Zbq7zw8AoAcWAYa7cSOsARF+Fm8DBAAYgDUq07ZSWvm3UIoAAIAfde39SB7Hz+K/xR9vAkMBg0YE8PKEChkH47+9MDggitAdAEObxnBmZAFu5C4eyMxqN/2c3ZUK2qJ+tDUvrTR/BGHDbqZplsDNZVVQjIaim4XA6TE4YLCfEdweIwAKaArx8aN1JETYMNMDEWGYZdRjMJDAB4T7+EEiwAdiBKCBlRQCfnwjEgohbttG2AYb3yS+7tWIDW1rd/6mMedAM+yEHbAvWge0XgNevwdW20Cmdfb6NXBYqm+DtZHUyUW88R/abjA/OxeYpIa9sNmNGMqHbMgd2CAZPzVuOfQFg5H275pWwx73mQMODQAAAA=="></head><body><div id="app" data-server-rendered="true"><!--[--><!--[--><canvas class="fireworks"></canvas><!--[--><div class="yun-bg"></div><!--]--><!--[--><button class="yun-search-btn popup-trigger yun-icon-btn" title="ÊêúÁ¥¢"><div i-ri-search-line></div></button><!----><!--]--><!--]--><!--[--><!--]--><!----><!--[--><!--[--><!----><button type="button" class="vt-hamburger menu-btn sidebar-toggle yun-icon-btn leading-4 fixed left-0.8rem top-0.6rem md:hidden" aria-label="mobile navigation" aria-expanded="false" inline-flex cursor="pointer" z="$yun-z-menu-btn"><span class="vt-hamburger-container"><span class="vt-hamburger-top"></span><span class="vt-hamburger-middle"></span><span class="vt-hamburger-bottom"></span></span></button><aside class="md:translate-x-0 va-card transition sidebar fixed inset-y-0 left-0 overflow-y-auto" text="center" bg="$yun-sidebar-bg-color contain no-repeat" z="$yun-z-sidebar"><!----><div class><!--[--><div class="sidebar-panel" p="2"><div class="site-info" m="t-6"><a href="/about" class="site-author-avatar"><img class="rounded-full" src="/images/avatar.jpg" alt="avatar"><span class="site-author-status" title="The moonlight is beautiful.">üíõ</span></a><div class="site-author-name leading-6" m="t-0 b-4"><a href="/about" class>imklaus</a></div><a href="/about/site" class="site-name">imklaus's Blog</a><h4 class="site-subtitle block" text="xs">The Winner Takes It All.</h4><!----></div><nav class="site-nav" text-xl mt-6><a href="/" class="site-link-item yun-icon-btn" title="È¶ñÈ°µ"><div i-ri-home-4-line></div></a><a href="/archives/" class="site-link-item" title="ÂΩíÊ°£"><div class="icon" i-ri-archive-line></div><span class="count">27</span></a><a href="/categories/" class="site-link-item" title="ÂàÜÁ±ª"><div class="icon" i-ri-folder-2-line></div><span class="count">2</span></a><a href="/tags/" class="site-link-item" title="Ê†áÁ≠æ"><div class="icon" i-ri-price-tag-3-line></div><span class="count">76</span></a><a href="/slides/" class="site-link-item yun-icon-btn" title="ÂπªÁÅØÁâá"><!--[--><div class="i-ri-keynote-line"></div><!--]--></a></nav><hr m="t-4 b-2"><div class="links-of-author"><!--[--><a class="links-of-author-item yun-icon-btn" rel="noopener" href="/atom.xml" title="RSS" target="_blank" style="color:orange"><div class="i-ri-rss-line icon"></div></a><a class="links-of-author-item yun-icon-btn" rel="noopener" href="https://github.com/imLKlauS" title="GitHub" target="_blank" style="color:#6e5494"><div class="i-ri-github-line icon"></div></a><a class="links-of-author-item yun-icon-btn" rel="noopener" href="https://music.163.com/#/user/home?id=102158629" title="ÂÜ∑Èó®Ê≠åÊâã" target="_blank" style="color:#c20c0c"><div class="i-ri-netease-cloud-music-line icon"></div></a><a class="links-of-author-item yun-icon-btn" rel="noopener" href="https://space.bilibili.com/19430480" title="ÂìîÂì©ÂìîÂì©" target="_blank" style="color:#ff8eb3"><div class="i-ri-bilibili-line icon"></div></a><a class="links-of-author-item yun-icon-btn" rel="noopener" href="https://t.me/elpsycn" title="Telegram Channel" target="_blank" style="color:#08c"><div class="i-ri-telegram-line icon"></div></a><a class="links-of-author-item yun-icon-btn" rel="noopener" href="q1064779584@163.com" title="E-Mail" target="_blank" style="color:#8e71c1"><div class="i-ri-mail-line icon"></div></a><a class="links-of-author-item yun-icon-btn" rel="noopener" href="https://www.travellings.cn/go.html" title="Travelling" target="_blank" style="color:var(--va-c-text)"><div class="i-ri-train-line icon"></div></a><!--]--></div><hr m="y-2"><div class="links flex-center"><!--[--><a href="/comment/" class="link-item yun-icon-btn" inline-flex title="ÁïôË®ÄÊùø" style="color:#737de5"><!--[--><div class="i-ri-clipboard-line icon w-8 h-8"></div><!--]--></a><a href="/albums/" class="link-item yun-icon-btn" inline-flex title="Áõ∏ÂÜå" style="color:#43abee"><!--[--><div class="i-ri-gallery-line icon w-8 h-8"></div><!--]--></a><a href="/links/" class="link-item yun-icon-btn" inline-flex title="ÂèãÈìæ" style="color:#4bbea4"><!--[--><div class="i-ri-open-arm-line icon w-8 h-8"></div><!--]--></a><a href="/music/" class="link-item yun-icon-btn" inline-flex title="Âê¨Ê≠å" style="color:#1e90ff"><!--[--><div class="i-ri-netease-cloud-music-line icon w-8 h-8"></div><!--]--></a><!--]--></div><br></div><div><button class="yun-icon-btn" title="ÂàáÊç¢Ê∑±Ëâ≤Ê®°Âºè" style="color:#f1cb64"><div i="ri-sun-line dark:ri-moon-line"></div></button><button class="yun-icon-btn" title="ÂàáÊç¢ËØ≠Ë®Ä" style="color:var(--va-c-text)"><div i-ri-translate class="transition transform"></div></button></div><!--]--></div></aside><!--]--><main class="yun-main lt-md:ml-0" flex="~"><div w="full" flex="~"><!--[--><div class="content" flex="~ col grow" w="full" p="l-4 lt-md:0"><div class="yun-card flex-center relative" flex="col" min-h="100px" bg="$va-c-bg-light" m="0" style><img width="640" height="360" class="object-cover select-none" h="64 md:sm" w="full" src="https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/wallhaven-j52r8w_1920x1080.png"><!----><!--[--><!--[--><header class="post-header mb-2" m="t-16 sm:t-6" cover="https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/wallhaven-j52r8w_1920x1080.png"><h1 class="post-title flex-center" p="2" text="2xl center" font="serif black" style=""><!----><span inline-flex class="leading-none">Ê∑±ÂÖ•Â≠¶‰π†JavaÂπ∂ÂèëÁºñÁ®ã-È´òÁ∫ßÁØá</span></h1></header><!--]--><!--[--><!--[--><!--[--><!--[--><!----><!----><div class="post-top-icon" color="$va-c-warning"><div i-ri-pushpin-line></div></div><div class="post-meta" flex="~ col" justify="center" items="center" text="sm" py="1"><div class="post-time flex items-center"><span class="inline-flex-center" title="ÂèëË°®‰∫é2023-07-07T22:52:11.000Z"><div class="inline-block" i-ri-calendar-line></div><time m="l-1">2023-07-07</time></span><span class="inline-flex-center" title="Êõ¥Êñ∞‰∫é2023-10-03T08:05:29.537Z"><span m="x-2">-</span><div i-ri-calendar-2-line></div><time m="l-1">2023-10-03</time></span></div><div class="post-counter flex items-center" mt="2"><span class="inline-flex-center" title="Êú¨ÊñáÂ≠óÊï∞"><div class="inline-block" i-ri-file-word-line></div><time m="l-1">28.7k</time></span><span class="inline-flex-center" title="ÈòÖËØªÊó∂Èïø"><span m="x-2">-</span><div i-ri-timer-line></div><time m="l-1">176m</time></span></div></div><!--[--><!--]--><!--]--><div flex="~" text="sm" my="1" h="5"><div inline-flex justify="center" items="center" mx="2" title="ÈòÖËØªÊ¨°Êï∞"><div inline-flex i-ri-eye-line></div><span ml-1 inline-flex class="waline-pageview-count" data-path="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20advanced%20chapter"></span></div><div inline-flex justify="center" items="center" mx="2" title="ËØÑËÆ∫Êï∞"><div inline-flex i-ri-chat-4-line></div><span ml-1 inline-flex class="waline-comment-count" data-path="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20advanced%20chapter"></span></div></div><div class="inline-flex" text="sm" py="1"><a href="/categories/?category=Java" class="post-category inline-flex-center"><div m="x-1" inline-flex i-ri-folder-2-line></div><span>Java</span></a><span mx="2">-</span><!--[--><a href="/tags/?tag=%E7%BA%BF%E7%A8%8B%E6%B1%A0" class="post-tag inline-flex-center" m="x-1"><div m="r-1" i-ri-price-tag-3-line></div><span>Á∫øÁ®ãÊ±†</span></a><a href="/tags/?tag=JUC" class="post-tag inline-flex-center" m="x-1"><div m="r-1" i-ri-price-tag-3-line></div><span>JUC</span></a><a href="/tags/?tag=AQS" class="post-tag inline-flex-center" m="x-1"><div m="r-1" i-ri-price-tag-3-line></div><span>AQS</span></a><a href="/tags/?tag=ReentrantLock" class="post-tag inline-flex-center" m="x-1"><div m="r-1" i-ri-price-tag-3-line></div><span>ReentrantLock</span></a><a href="/tags/?tag=volatile" class="post-tag inline-flex-center" m="x-1"><div m="r-1" i-ri-price-tag-3-line></div><span>volatile</span></a><a href="/tags/?tag=Semaphore" class="post-tag inline-flex-center" m="x-1"><div m="r-1" i-ri-price-tag-3-line></div><span>Semaphore</span></a><a href="/tags/?tag=ConcurrentHashMap" class="post-tag inline-flex-center" m="x-1"><div m="r-1" i-ri-price-tag-3-line></div><span>ConcurrentHashMap</span></a><!--]--></div><!--]--><!--]--><!--]--><div p="x-4 b-8" class="sm:px-6 lg:px-12 xl:px-16" w="full"><!--[--><article class="markdown-body"><!--[--><!----><!--[--><h1 id="Âπ∂ÂèëÁºñÁ®ãÁ¨îËÆ∞" tabindex="-1">Âπ∂ÂèëÁºñÁ®ãÁ¨îËÆ∞ <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20advanced%20chapter#Âπ∂ÂèëÁºñÁ®ãÁ¨îËÆ∞" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h1><p>Êú¨ÂçöÂÆ¢Ê†πÊçÆ<strong>ÈªëÈ©¨javaÂπ∂ÂèëÁºñÁ®ãÊïôÁ®ã</strong>Â≠¶‰π†ËÄåÂÅöÁöÑÁ¨îËÆ∞ÔºåÈìæÊé•Â¶Ç‰∏ãÔºö<a target="_blank" rel="noreferrer" href="https://www.bilibili.com/video/av81461839?from=search&amp;seid=8445102345230304010"><!--[-->Ê∑±ÂÖ•Â≠¶‰π†JavaÂπ∂Âèë<!--]--><!----></a></p><h2 id="‰∏É„ÄÅÁ∫øÁ®ãÊ±†" tabindex="-1">‰∏É„ÄÅÁ∫øÁ®ãÊ±† <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20advanced%20chapter#‰∏É„ÄÅÁ∫øÁ®ãÊ±†" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h2><h3 id="_1„ÄÅËá™ÂÆö‰πâÁ∫øÁ®ãÊ±†" tabindex="-1">1„ÄÅËá™ÂÆö‰πâÁ∫øÁ®ãÊ±† <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20advanced%20chapter#_1„ÄÅËá™ÂÆö‰πâÁ∫øÁ®ãÊ±†" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h3><h4 id="ËÉåÊôØ" tabindex="-1">ËÉåÊôØ <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20advanced%20chapter#ËÉåÊôØ" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h4><p>Êàë‰ª¨ÈÉΩÁü•ÈÅìÁ∫øÁ®ãÊòØ‰∏ÄÁßçÁ≥ªÁªüËµÑÊ∫êÔºåÊØèÂàõÂª∫‰∏Ä‰∏™Êñ∞ÁöÑÁ∫øÁ®ãÂÆÉÈÉΩË¶ÅÂç†Áî®‰∏ÄÂÆöÁöÑÂÜÖÂ≠òÔºàÂàÜÈÖçÊ†àÂÜÖÂ≠òÔºâÔºåÂ¶ÇÊûúÂú®È´òÂπ∂ÂèëÁöÑÊÉÖÂÜµ‰∏ãÔºå‰∏Ä‰∏ãÂ≠êÊù•‰∫ÜÂæàÂ§öÁöÑ‰ªªÂä°ÔºåÂ¶ÇÊûúË¶Å‰∏∫ÊØè‰∏™‰ªªÂä°ÂàõÂª∫Êñ∞ÁöÑÁ∫øÁ®ãÔºåÂèØ‰ª•ÊÉ≥Ë±°Âà∞Âç†Áî®ÁöÑÂÜÖÂ≠òÊòØÁõ∏ÂΩìÂ§ßÁöÑÔºåÊúâÂèØËÉΩ‰ºöÂá∫Áé∞outOfMemoryÔºåËÄå‰∏îÁ∫øÁ®ãÂπ∂‰∏çÊòØÂàõÂª∫ÂæóË∂äÂ§öË∂äÂ•ΩÔºåËøòË¶ÅËÄÉËôëCPUÊ†∏ÂøÉÊï∞ÔºåÂΩìÁ∫øÁ®ãÊä¢‰∏çÂà∞CPU‰ΩøÁî®ÊùÉÊó∂ÔºàÊó∂Èó¥ÁâáÔºâÂ∞±‰ºöÈô∑ÂÖ•ÈòªÂ°ûÁä∂ÊÄÅÔºåÂ∞±‰ºöÂºïËµ∑Á∫øÁ®ãÁöÑ‰∏ä‰∏ãÊñáÂàáÊç¢ÈóÆÈ¢òÔºåÊääÂΩìÂâçÁ∫øÁ®ãÁöÑËøêË°åÁä∂ÊÄÅ‰øùÂ≠ò‰∏ãÊù•ÔºåÁ≠â‰∏ãÊ¨°ËΩÆÂà∞ÂÆÉËøêË°åÊó∂ÔºåËøòË¶ÅÊÅ¢Â§çÂÆÉ‰πãÂâçÁöÑÈÇ£‰∫õÁä∂ÊÄÅÔºåÂ¶ÇÊûúÁ∫øÁ®ãÁöÑ‰∏ä‰∏ãÊñáÂàáÊç¢ÂæóË∂äÊù•Ë∂äÈ¢ëÁπÅÂ∞±‰ºöÂØπ‰Ω†ÁöÑÁ≥ªÁªüÊÄßËÉΩÂΩ±ÂìçË∂äÂ§ßÔºåÂ∞§ÂÖ∂ÊòØÂú®È´òÂπ∂ÂèëÁöÑÊÉÖÂÜµ‰∏ãÔºåÂõ†Ê≠§Â§Ñ‰∫éËøô‰∏§‰∏™ÂéüÂõ†ÔºåÊØèÊ¨°‰ªªÂä°Êù•‰∫Ü‰∏ç‰ºöÂÖàÂéªÂàõÂª∫Êñ∞ÁöÑÁ∫øÁ®ãÔºåËÄåÊòØÂ∫îËØ•ÂÖÖÂàÜÂà©Áî®Â∑≤ÊúâÁ∫øÁ®ãÔºåÂ∞ΩÈáèÂèëÊå•ÂÆÉ‰ª¨ÁöÑÊΩúÂäõÂéªÂ§ÑÁêÜËøô‰∏™‰ªªÂä°ÔºåËÄå‰∏çÊòØÊØèÊ¨°ÈÉΩÂàõÂª∫Êñ∞ÁöÑÁ∫øÁ®ãÂéªÂ§ÑÁêÜ‰ªªÂä°ÔºåËøô‰πü‰ΩìÁé∞‰∫ÜÂâçÈù¢ËØ¥ÁöÑ‰∫´ÂÖÉÊ®°Âºè</p><h4 id="ÂõæËß£" tabindex="-1">ÂõæËß£ <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20advanced%20chapter#ÂõæËß£" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h4><figure><img src="https://jsd.cdn.zzko.cn/gh/imLKlauS/blog-picture@main/blogs/20201021154837.png" alt="img" loading="lazy" decoding="async"></figure><ul><li>ÈòªÂ°ûÈòüÂàó‰∏≠Áª¥Êä§‰∫ÜÁî±‰∏ªÁ∫øÁ®ãÔºàÊàñËÄÖÂÖ∂‰ªñÁ∫øÁ®ãÔºâÊâÄ‰∫ßÁîüÁöÑÁöÑ‰ªªÂä°</li><li>‰∏ªÁ∫øÁ®ãÁ±ª‰ºº‰∫é<strong>Áîü‰∫ßËÄÖ</strong>Ôºå‰∫ßÁîü‰ªªÂä°Âπ∂ÊîæÂÖ•ÈòªÂ°ûÈòüÂàó‰∏≠</li><li>Á∫øÁ®ãÊ±†Á±ª‰ºº‰∫é<strong>Ê∂àË¥πËÄÖ</strong>ÔºåÂæóÂà∞ÈòªÂ°ûÈòüÂàó‰∏≠Â∑≤ÊúâÁöÑ‰ªªÂä°Âπ∂ÊâßË°å</li></ul><h4 id="‰ª£Á†Å" tabindex="-1">‰ª£Á†Å <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20advanced%20chapter#‰ª£Á†Å" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h4><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8">@</span><span style="color:#f97583">Slf4j</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">topic</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#9ecbff">"c.TestPool"</span><span style="color:#e1e4e8">)</span></span>
<span class="line"><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">class</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">TestPool</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">static</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">void</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">main</span><span style="color:#e1e4e8">(</span><span style="color:#f97583">String</span><span style="color:#e1e4e8">[] </span><span style="color:#ffab70">args</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">        ThreadPool threadPool </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">ThreadPool</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">1</span><span style="color:#e1e4e8">,</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#79b8ff">1000</span><span style="color:#e1e4e8">, TimeUnit.MILLISECONDS, </span><span style="color:#79b8ff">1</span><span style="color:#e1e4e8">, (queue, task)</span><span style="color:#f97583">-&gt;</span><span style="color:#e1e4e8">{</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#6a737d">// 1. Ê≠ªÁ≠â</span></span>
<span class="line"><span style="color:#6a737d">//            queue.put(task);</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#6a737d">// 2) Â∏¶Ë∂ÖÊó∂Á≠âÂæÖ</span></span>
<span class="line"><span style="color:#6a737d">//            queue.offer(task, 1500, TimeUnit.MILLISECONDS);</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#6a737d">// 3) ËÆ©Ë∞ÉÁî®ËÄÖÊîæÂºÉ‰ªªÂä°ÊâßË°å</span></span>
<span class="line"><span style="color:#6a737d">//            log.debug("ÊîæÂºÉ{}", task);</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#6a737d">// 4) ËÆ©Ë∞ÉÁî®ËÄÖÊäõÂá∫ÂºÇÂ∏∏</span></span>
<span class="line"><span style="color:#6a737d">//            throw new RuntimeException("‰ªªÂä°ÊâßË°åÂ§±Ë¥• " + task);</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#6a737d">// 5) ËÆ©Ë∞ÉÁî®ËÄÖËá™Â∑±ÊâßË°å‰ªªÂä°</span></span>
<span class="line"><span style="color:#e1e4e8">            task.</span><span style="color:#b392f0">run</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">        });</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">for</span><span style="color:#e1e4e8"> (</span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> i </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8">; i </span><span style="color:#f97583">&lt;</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">4</span><span style="color:#e1e4e8">; i</span><span style="color:#f97583">++</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> j </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> i;</span></span>
<span class="line"><span style="color:#e1e4e8">            threadPool.</span><span style="color:#b392f0">execute</span><span style="color:#e1e4e8">(() </span><span style="color:#f97583">-&gt;</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#f97583">try</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">                    Thread.</span><span style="color:#b392f0">sleep</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">1000L</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">                } </span><span style="color:#f97583">catch</span><span style="color:#e1e4e8"> (InterruptedException </span><span style="color:#ffab70">e</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">                    e.</span><span style="color:#b392f0">printStackTrace</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">                }</span></span>
<span class="line"><span style="color:#e1e4e8">                log.</span><span style="color:#b392f0">debug</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"{}"</span><span style="color:#e1e4e8">, j);</span></span>
<span class="line"><span style="color:#e1e4e8">            });</span></span>
<span class="line"><span style="color:#e1e4e8">        }</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"><span style="color:#e1e4e8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">@</span><span style="color:#f97583">FunctionalInterface</span><span style="color:#e1e4e8"> </span><span style="color:#6a737d">// ÊãíÁªùÁ≠ñÁï•</span></span>
<span class="line"><span style="color:#f97583">interface</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">RejectPolicy</span><span style="color:#e1e4e8">&lt;</span><span style="color:#f97583">T</span><span style="color:#e1e4e8">&gt; {</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">void</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">reject</span><span style="color:#e1e4e8">(BlockingQueue&lt;</span><span style="color:#f97583">T</span><span style="color:#e1e4e8">&gt; </span><span style="color:#ffab70">queue</span><span style="color:#e1e4e8">, T </span><span style="color:#ffab70">task</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">@</span><span style="color:#f97583">Slf4j</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">topic</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#9ecbff">"c.ThreadPool"</span><span style="color:#e1e4e8">)</span></span>
<span class="line"><span style="color:#f97583">class</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">ThreadPool</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">// ‰ªªÂä°ÈòüÂàó</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">private</span><span style="color:#e1e4e8"> BlockingQueue&lt;</span><span style="color:#f97583">Runnable</span><span style="color:#e1e4e8">&gt; taskQueue;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">// Á∫øÁ®ãÈõÜÂêà</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">private</span><span style="color:#e1e4e8"> HashSet&lt;</span><span style="color:#f97583">Worker</span><span style="color:#e1e4e8">&gt; workers </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> HashSet&lt;&gt;();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">// Ê†∏ÂøÉÁ∫øÁ®ãÊï∞</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">private</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> coreSize;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">// Ëé∑Âèñ‰ªªÂä°Êó∂ÁöÑË∂ÖÊó∂Êó∂Èó¥</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">private</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">long</span><span style="color:#e1e4e8"> timeout;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">private</span><span style="color:#e1e4e8"> TimeUnit timeUnit;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">private</span><span style="color:#e1e4e8"> RejectPolicy&lt;</span><span style="color:#f97583">Runnable</span><span style="color:#e1e4e8">&gt; rejectPolicy;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">// ÊâßË°å‰ªªÂä°</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">void</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">execute</span><span style="color:#e1e4e8">(Runnable </span><span style="color:#ffab70">task</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#6a737d">// ÂΩì‰ªªÂä°Êï∞Ê≤°ÊúâË∂ÖËøá coreSize Êó∂ÔºåÁõ¥Êé•‰∫§Áªô worker ÂØπË±°ÊâßË°å</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#6a737d">// Â¶ÇÊûú‰ªªÂä°Êï∞Ë∂ÖËøá coreSize Êó∂ÔºåÂä†ÂÖ•‰ªªÂä°ÈòüÂàóÊöÇÂ≠ò</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">synchronized</span><span style="color:#e1e4e8"> (workers) {</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">if</span><span style="color:#e1e4e8">(workers.</span><span style="color:#b392f0">size</span><span style="color:#e1e4e8">() </span><span style="color:#f97583">&lt;</span><span style="color:#e1e4e8"> coreSize) {</span></span>
<span class="line"><span style="color:#e1e4e8">                Worker worker </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Worker</span><span style="color:#e1e4e8">(task);</span></span>
<span class="line"><span style="color:#e1e4e8">                log.</span><span style="color:#b392f0">debug</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"Êñ∞Â¢û worker{}, {}"</span><span style="color:#e1e4e8">, worker, task);</span></span>
<span class="line"><span style="color:#e1e4e8">                workers.</span><span style="color:#b392f0">add</span><span style="color:#e1e4e8">(worker);</span></span>
<span class="line"><span style="color:#e1e4e8">                worker.</span><span style="color:#b392f0">start</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">            } </span><span style="color:#f97583">else</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#6a737d">//                taskQueue.put(task);</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#6a737d">// 1) Ê≠ªÁ≠â</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#6a737d">// 2) Â∏¶Ë∂ÖÊó∂Á≠âÂæÖ</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#6a737d">// 3) ËÆ©Ë∞ÉÁî®ËÄÖÊîæÂºÉ‰ªªÂä°ÊâßË°å</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#6a737d">// 4) ËÆ©Ë∞ÉÁî®ËÄÖÊäõÂá∫ÂºÇÂ∏∏</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#6a737d">// 5) ËÆ©Ë∞ÉÁî®ËÄÖËá™Â∑±ÊâßË°å‰ªªÂä°</span></span>
<span class="line"><span style="color:#e1e4e8">                taskQueue.</span><span style="color:#b392f0">tryPut</span><span style="color:#e1e4e8">(rejectPolicy, task);</span></span>
<span class="line"><span style="color:#e1e4e8">            }</span></span>
<span class="line"><span style="color:#e1e4e8">        }</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">ThreadPool</span><span style="color:#e1e4e8">(</span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> </span><span style="color:#ffab70">coreSize</span><span style="color:#e1e4e8">, </span><span style="color:#f97583">long</span><span style="color:#e1e4e8"> </span><span style="color:#ffab70">timeout</span><span style="color:#e1e4e8">, TimeUnit </span><span style="color:#ffab70">timeUnit</span><span style="color:#e1e4e8">, </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> </span><span style="color:#ffab70">queueCapcity</span><span style="color:#e1e4e8">, RejectPolicy&lt;</span><span style="color:#f97583">Runnable</span><span style="color:#e1e4e8">&gt; </span><span style="color:#ffab70">rejectPolicy</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#79b8ff">this</span><span style="color:#e1e4e8">.coreSize </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> coreSize;</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#79b8ff">this</span><span style="color:#e1e4e8">.timeout </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> timeout;</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#79b8ff">this</span><span style="color:#e1e4e8">.timeUnit </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> timeUnit;</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#79b8ff">this</span><span style="color:#e1e4e8">.taskQueue </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> BlockingQueue&lt;&gt;(queueCapcity);</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#79b8ff">this</span><span style="color:#e1e4e8">.rejectPolicy </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> rejectPolicy;</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">class</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Worker</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">extends</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Thread</span><span style="color:#e1e4e8">{</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">private</span><span style="color:#e1e4e8"> Runnable task;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Worker</span><span style="color:#e1e4e8">(Runnable </span><span style="color:#ffab70">task</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#79b8ff">this</span><span style="color:#e1e4e8">.task </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> task;</span></span>
<span class="line"><span style="color:#e1e4e8">        }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">        @</span><span style="color:#f97583">Override</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">void</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">run</span><span style="color:#e1e4e8">() {</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#6a737d">// ÊâßË°å‰ªªÂä°</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#6a737d">// 1) ÂΩì task ‰∏ç‰∏∫Á©∫ÔºåÊâßË°å‰ªªÂä°</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#6a737d">// 2) ÂΩì task ÊâßË°åÂÆåÊØïÔºåÂÜçÊé•ÁùÄ‰ªé‰ªªÂä°ÈòüÂàóËé∑Âèñ‰ªªÂä°Âπ∂ÊâßË°å</span></span>
<span class="line"><span style="color:#6a737d">//            while(task != null || (task = taskQueue.take()) != null) {</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">while</span><span style="color:#e1e4e8">(task </span><span style="color:#f97583">!=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">||</span><span style="color:#e1e4e8"> (task </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> taskQueue.</span><span style="color:#b392f0">poll</span><span style="color:#e1e4e8">(timeout, timeUnit)) </span><span style="color:#f97583">!=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#f97583">try</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">                    log.</span><span style="color:#b392f0">debug</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"Ê≠£Âú®ÊâßË°å...{}"</span><span style="color:#e1e4e8">, task);</span></span>
<span class="line"><span style="color:#e1e4e8">                    task.</span><span style="color:#b392f0">run</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">                } </span><span style="color:#f97583">catch</span><span style="color:#e1e4e8"> (Exception </span><span style="color:#ffab70">e</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">                    e.</span><span style="color:#b392f0">printStackTrace</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">                } </span><span style="color:#f97583">finally</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">                    task </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">                }</span></span>
<span class="line"><span style="color:#e1e4e8">            }</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">synchronized</span><span style="color:#e1e4e8"> (workers) {</span></span>
<span class="line"><span style="color:#e1e4e8">                log.</span><span style="color:#b392f0">debug</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"worker Ë¢´ÁßªÈô§{}"</span><span style="color:#e1e4e8">, </span><span style="color:#79b8ff">this</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">                workers.</span><span style="color:#b392f0">remove</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">this</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">            }</span></span>
<span class="line"><span style="color:#e1e4e8">        }</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"><span style="color:#e1e4e8">}</span></span>
<span class="line"><span style="color:#e1e4e8">@</span><span style="color:#f97583">Slf4j</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">topic</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#9ecbff">"c.BlockingQueue"</span><span style="color:#e1e4e8">)</span></span>
<span class="line"><span style="color:#f97583">class</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">BlockingQueue</span><span style="color:#e1e4e8">&lt;</span><span style="color:#f97583">T</span><span style="color:#e1e4e8">&gt; {</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">// 1. ‰ªªÂä°ÈòüÂàó</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">private</span><span style="color:#e1e4e8"> Deque&lt;</span><span style="color:#f97583">T</span><span style="color:#e1e4e8">&gt; queue </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> ArrayDeque&lt;&gt;();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">// 2. ÈîÅ</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">private</span><span style="color:#e1e4e8"> ReentrantLock lock </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">ReentrantLock</span><span style="color:#e1e4e8">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">// 3. Áîü‰∫ßËÄÖÊù°‰ª∂ÂèòÈáè</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">private</span><span style="color:#e1e4e8"> Condition fullWaitSet </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> lock.</span><span style="color:#b392f0">newCondition</span><span style="color:#e1e4e8">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">// 4. Ê∂àË¥πËÄÖÊù°‰ª∂ÂèòÈáè</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">private</span><span style="color:#e1e4e8"> Condition emptyWaitSet </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> lock.</span><span style="color:#b392f0">newCondition</span><span style="color:#e1e4e8">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">// 5. ÂÆπÈáè</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">private</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> capcity;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">BlockingQueue</span><span style="color:#e1e4e8">(</span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> </span><span style="color:#ffab70">capcity</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#79b8ff">this</span><span style="color:#e1e4e8">.capcity </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> capcity;</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">// Â∏¶Ë∂ÖÊó∂ÈòªÂ°ûËé∑Âèñ</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">public</span><span style="color:#e1e4e8"> T </span><span style="color:#b392f0">poll</span><span style="color:#e1e4e8">(</span><span style="color:#f97583">long</span><span style="color:#e1e4e8"> </span><span style="color:#ffab70">timeout</span><span style="color:#e1e4e8">, TimeUnit </span><span style="color:#ffab70">unit</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">        lock.</span><span style="color:#b392f0">lock</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">try</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#6a737d">// Â∞Ü timeout Áªü‰∏ÄËΩ¨Êç¢‰∏∫ Á∫≥Áßí</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">long</span><span style="color:#e1e4e8"> nanos </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> unit.</span><span style="color:#b392f0">toNanos</span><span style="color:#e1e4e8">(timeout);</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">while</span><span style="color:#e1e4e8"> (queue.</span><span style="color:#b392f0">isEmpty</span><span style="color:#e1e4e8">()) {</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#f97583">try</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">                    </span><span style="color:#6a737d">// ËøîÂõûÂÄºÊòØÂâ©‰ΩôÊó∂Èó¥</span></span>
<span class="line"><span style="color:#e1e4e8">                    </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (nanos </span><span style="color:#f97583">&lt;=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">                        </span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">                    }</span></span>
<span class="line"><span style="color:#e1e4e8">                    nanos </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> emptyWaitSet.</span><span style="color:#b392f0">awaitNanos</span><span style="color:#e1e4e8">(nanos);</span></span>
<span class="line"><span style="color:#e1e4e8">                } </span><span style="color:#f97583">catch</span><span style="color:#e1e4e8"> (InterruptedException </span><span style="color:#ffab70">e</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">                    e.</span><span style="color:#b392f0">printStackTrace</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">                }</span></span>
<span class="line"><span style="color:#e1e4e8">            }</span></span>
<span class="line"><span style="color:#e1e4e8">            T t </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> queue.</span><span style="color:#b392f0">removeFirst</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">            fullWaitSet.</span><span style="color:#b392f0">signal</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> t;</span></span>
<span class="line"><span style="color:#e1e4e8">        } </span><span style="color:#f97583">finally</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">            lock.</span><span style="color:#b392f0">unlock</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">        }</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">// ÈòªÂ°ûËé∑Âèñ</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">public</span><span style="color:#e1e4e8"> T </span><span style="color:#b392f0">take</span><span style="color:#e1e4e8">() {</span></span>
<span class="line"><span style="color:#e1e4e8">        lock.</span><span style="color:#b392f0">lock</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">try</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">while</span><span style="color:#e1e4e8"> (queue.</span><span style="color:#b392f0">isEmpty</span><span style="color:#e1e4e8">()) {</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#f97583">try</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">                    emptyWaitSet.</span><span style="color:#b392f0">await</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">                } </span><span style="color:#f97583">catch</span><span style="color:#e1e4e8"> (InterruptedException </span><span style="color:#ffab70">e</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">                    e.</span><span style="color:#b392f0">printStackTrace</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">                }</span></span>
<span class="line"><span style="color:#e1e4e8">            }</span></span>
<span class="line"><span style="color:#e1e4e8">            T t </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> queue.</span><span style="color:#b392f0">removeFirst</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">            fullWaitSet.</span><span style="color:#b392f0">signal</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> t;</span></span>
<span class="line"><span style="color:#e1e4e8">        } </span><span style="color:#f97583">finally</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">            lock.</span><span style="color:#b392f0">unlock</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">        }</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">// ÈòªÂ°ûÊ∑ªÂä†</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">void</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">put</span><span style="color:#e1e4e8">(T </span><span style="color:#ffab70">task</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">        lock.</span><span style="color:#b392f0">lock</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">try</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">while</span><span style="color:#e1e4e8"> (queue.</span><span style="color:#b392f0">size</span><span style="color:#e1e4e8">() </span><span style="color:#f97583">==</span><span style="color:#e1e4e8"> capcity) {</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#f97583">try</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">                    log.</span><span style="color:#b392f0">debug</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"Á≠âÂæÖÂä†ÂÖ•‰ªªÂä°ÈòüÂàó {} ..."</span><span style="color:#e1e4e8">, task);</span></span>
<span class="line"><span style="color:#e1e4e8">                    fullWaitSet.</span><span style="color:#b392f0">await</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">                } </span><span style="color:#f97583">catch</span><span style="color:#e1e4e8"> (InterruptedException </span><span style="color:#ffab70">e</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">                    e.</span><span style="color:#b392f0">printStackTrace</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">                }</span></span>
<span class="line"><span style="color:#e1e4e8">            }</span></span>
<span class="line"><span style="color:#e1e4e8">            log.</span><span style="color:#b392f0">debug</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"Âä†ÂÖ•‰ªªÂä°ÈòüÂàó {}"</span><span style="color:#e1e4e8">, task);</span></span>
<span class="line"><span style="color:#e1e4e8">            queue.</span><span style="color:#b392f0">addLast</span><span style="color:#e1e4e8">(task);</span></span>
<span class="line"><span style="color:#e1e4e8">            emptyWaitSet.</span><span style="color:#b392f0">signal</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">        } </span><span style="color:#f97583">finally</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">            lock.</span><span style="color:#b392f0">unlock</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">        }</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">// Â∏¶Ë∂ÖÊó∂Êó∂Èó¥ÈòªÂ°ûÊ∑ªÂä†</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">boolean</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">offer</span><span style="color:#e1e4e8">(T </span><span style="color:#ffab70">task</span><span style="color:#e1e4e8">, </span><span style="color:#f97583">long</span><span style="color:#e1e4e8"> </span><span style="color:#ffab70">timeout</span><span style="color:#e1e4e8">, TimeUnit </span><span style="color:#ffab70">timeUnit</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">        lock.</span><span style="color:#b392f0">lock</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">try</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">long</span><span style="color:#e1e4e8"> nanos </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> timeUnit.</span><span style="color:#b392f0">toNanos</span><span style="color:#e1e4e8">(timeout);</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">while</span><span style="color:#e1e4e8"> (queue.</span><span style="color:#b392f0">size</span><span style="color:#e1e4e8">() </span><span style="color:#f97583">==</span><span style="color:#e1e4e8"> capcity) {</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#f97583">try</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">                    </span><span style="color:#f97583">if</span><span style="color:#e1e4e8">(nanos </span><span style="color:#f97583">&lt;=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">                        </span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">false</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">                    }</span></span>
<span class="line"><span style="color:#e1e4e8">                    log.</span><span style="color:#b392f0">debug</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"Á≠âÂæÖÂä†ÂÖ•‰ªªÂä°ÈòüÂàó {} ..."</span><span style="color:#e1e4e8">, task);</span></span>
<span class="line"><span style="color:#e1e4e8">                    nanos </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> fullWaitSet.</span><span style="color:#b392f0">awaitNanos</span><span style="color:#e1e4e8">(nanos);</span></span>
<span class="line"><span style="color:#e1e4e8">                } </span><span style="color:#f97583">catch</span><span style="color:#e1e4e8"> (InterruptedException </span><span style="color:#ffab70">e</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">                    e.</span><span style="color:#b392f0">printStackTrace</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">                }</span></span>
<span class="line"><span style="color:#e1e4e8">            }</span></span>
<span class="line"><span style="color:#e1e4e8">            log.</span><span style="color:#b392f0">debug</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"Âä†ÂÖ•‰ªªÂä°ÈòüÂàó {}"</span><span style="color:#e1e4e8">, task);</span></span>
<span class="line"><span style="color:#e1e4e8">            queue.</span><span style="color:#b392f0">addLast</span><span style="color:#e1e4e8">(task);</span></span>
<span class="line"><span style="color:#e1e4e8">            emptyWaitSet.</span><span style="color:#b392f0">signal</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">true</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">        } </span><span style="color:#f97583">finally</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">            lock.</span><span style="color:#b392f0">unlock</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">        }</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">size</span><span style="color:#e1e4e8">() {</span></span>
<span class="line"><span style="color:#e1e4e8">        lock.</span><span style="color:#b392f0">lock</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">try</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> queue.</span><span style="color:#b392f0">size</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">        } </span><span style="color:#f97583">finally</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">            lock.</span><span style="color:#b392f0">unlock</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">        }</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">void</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">tryPut</span><span style="color:#e1e4e8">(RejectPolicy&lt;</span><span style="color:#f97583">T</span><span style="color:#e1e4e8">&gt; </span><span style="color:#ffab70">rejectPolicy</span><span style="color:#e1e4e8">, T </span><span style="color:#ffab70">task</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">        lock.</span><span style="color:#b392f0">lock</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">try</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#6a737d">// Âà§Êñ≠ÈòüÂàóÊòØÂê¶Êª°</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">if</span><span style="color:#e1e4e8">(queue.</span><span style="color:#b392f0">size</span><span style="color:#e1e4e8">() </span><span style="color:#f97583">==</span><span style="color:#e1e4e8"> capcity) {</span></span>
<span class="line"><span style="color:#e1e4e8">                rejectPolicy.</span><span style="color:#b392f0">reject</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">this</span><span style="color:#e1e4e8">, task);</span></span>
<span class="line"><span style="color:#e1e4e8">            } </span><span style="color:#f97583">else</span><span style="color:#e1e4e8"> {  </span><span style="color:#6a737d">// ÊúâÁ©∫Èó≤</span></span>
<span class="line"><span style="color:#e1e4e8">                log.</span><span style="color:#b392f0">debug</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"Âä†ÂÖ•‰ªªÂä°ÈòüÂàó {}"</span><span style="color:#e1e4e8">, task);</span></span>
<span class="line"><span style="color:#e1e4e8">                queue.</span><span style="color:#b392f0">addLast</span><span style="color:#e1e4e8">(task);</span></span>
<span class="line"><span style="color:#e1e4e8">                emptyWaitSet.</span><span style="color:#b392f0">signal</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">            }</span></span>
<span class="line"><span style="color:#e1e4e8">        } </span><span style="color:#f97583">finally</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">            lock.</span><span style="color:#b392f0">unlock</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">        }</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"><span style="color:#e1e4e8">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e">@</span><span style="color:#d73a49">Slf4j</span><span style="color:#24292e">(</span><span style="color:#005cc5">topic</span><span style="color:#24292e"> </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#032f62">"c.TestPool"</span><span style="color:#24292e">)</span></span>
<span class="line"><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">class</span><span style="color:#24292e"> </span><span style="color:#6f42c1">TestPool</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">static</span><span style="color:#24292e"> </span><span style="color:#d73a49">void</span><span style="color:#24292e"> </span><span style="color:#6f42c1">main</span><span style="color:#24292e">(</span><span style="color:#d73a49">String</span><span style="color:#24292e">[] </span><span style="color:#e36209">args</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">        ThreadPool threadPool </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">ThreadPool</span><span style="color:#24292e">(</span><span style="color:#005cc5">1</span><span style="color:#24292e">,</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#005cc5">1000</span><span style="color:#24292e">, TimeUnit.MILLISECONDS, </span><span style="color:#005cc5">1</span><span style="color:#24292e">, (queue, task)</span><span style="color:#d73a49">-&gt;</span><span style="color:#24292e">{</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#6a737d">// 1. Ê≠ªÁ≠â</span></span>
<span class="line"><span style="color:#6a737d">//            queue.put(task);</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#6a737d">// 2) Â∏¶Ë∂ÖÊó∂Á≠âÂæÖ</span></span>
<span class="line"><span style="color:#6a737d">//            queue.offer(task, 1500, TimeUnit.MILLISECONDS);</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#6a737d">// 3) ËÆ©Ë∞ÉÁî®ËÄÖÊîæÂºÉ‰ªªÂä°ÊâßË°å</span></span>
<span class="line"><span style="color:#6a737d">//            log.debug("ÊîæÂºÉ{}", task);</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#6a737d">// 4) ËÆ©Ë∞ÉÁî®ËÄÖÊäõÂá∫ÂºÇÂ∏∏</span></span>
<span class="line"><span style="color:#6a737d">//            throw new RuntimeException("‰ªªÂä°ÊâßË°åÂ§±Ë¥• " + task);</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#6a737d">// 5) ËÆ©Ë∞ÉÁî®ËÄÖËá™Â∑±ÊâßË°å‰ªªÂä°</span></span>
<span class="line"><span style="color:#24292e">            task.</span><span style="color:#6f42c1">run</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">        });</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">for</span><span style="color:#24292e"> (</span><span style="color:#d73a49">int</span><span style="color:#24292e"> i </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#005cc5">0</span><span style="color:#24292e">; i </span><span style="color:#d73a49">&lt;</span><span style="color:#24292e"> </span><span style="color:#005cc5">4</span><span style="color:#24292e">; i</span><span style="color:#d73a49">++</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">int</span><span style="color:#24292e"> j </span><span style="color:#d73a49">=</span><span style="color:#24292e"> i;</span></span>
<span class="line"><span style="color:#24292e">            threadPool.</span><span style="color:#6f42c1">execute</span><span style="color:#24292e">(() </span><span style="color:#d73a49">-&gt;</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#d73a49">try</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">                    Thread.</span><span style="color:#6f42c1">sleep</span><span style="color:#24292e">(</span><span style="color:#005cc5">1000L</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">                } </span><span style="color:#d73a49">catch</span><span style="color:#24292e"> (InterruptedException </span><span style="color:#e36209">e</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">                    e.</span><span style="color:#6f42c1">printStackTrace</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">                }</span></span>
<span class="line"><span style="color:#24292e">                log.</span><span style="color:#6f42c1">debug</span><span style="color:#24292e">(</span><span style="color:#032f62">"{}"</span><span style="color:#24292e">, j);</span></span>
<span class="line"><span style="color:#24292e">            });</span></span>
<span class="line"><span style="color:#24292e">        }</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"><span style="color:#24292e">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">@</span><span style="color:#d73a49">FunctionalInterface</span><span style="color:#24292e"> </span><span style="color:#6a737d">// ÊãíÁªùÁ≠ñÁï•</span></span>
<span class="line"><span style="color:#d73a49">interface</span><span style="color:#24292e"> </span><span style="color:#6f42c1">RejectPolicy</span><span style="color:#24292e">&lt;</span><span style="color:#d73a49">T</span><span style="color:#24292e">&gt; {</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">void</span><span style="color:#24292e"> </span><span style="color:#6f42c1">reject</span><span style="color:#24292e">(BlockingQueue&lt;</span><span style="color:#d73a49">T</span><span style="color:#24292e">&gt; </span><span style="color:#e36209">queue</span><span style="color:#24292e">, T </span><span style="color:#e36209">task</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">@</span><span style="color:#d73a49">Slf4j</span><span style="color:#24292e">(</span><span style="color:#005cc5">topic</span><span style="color:#24292e"> </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#032f62">"c.ThreadPool"</span><span style="color:#24292e">)</span></span>
<span class="line"><span style="color:#d73a49">class</span><span style="color:#24292e"> </span><span style="color:#6f42c1">ThreadPool</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">// ‰ªªÂä°ÈòüÂàó</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">private</span><span style="color:#24292e"> BlockingQueue&lt;</span><span style="color:#d73a49">Runnable</span><span style="color:#24292e">&gt; taskQueue;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">// Á∫øÁ®ãÈõÜÂêà</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">private</span><span style="color:#24292e"> HashSet&lt;</span><span style="color:#d73a49">Worker</span><span style="color:#24292e">&gt; workers </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> HashSet&lt;&gt;();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">// Ê†∏ÂøÉÁ∫øÁ®ãÊï∞</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">private</span><span style="color:#24292e"> </span><span style="color:#d73a49">int</span><span style="color:#24292e"> coreSize;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">// Ëé∑Âèñ‰ªªÂä°Êó∂ÁöÑË∂ÖÊó∂Êó∂Èó¥</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">private</span><span style="color:#24292e"> </span><span style="color:#d73a49">long</span><span style="color:#24292e"> timeout;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">private</span><span style="color:#24292e"> TimeUnit timeUnit;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">private</span><span style="color:#24292e"> RejectPolicy&lt;</span><span style="color:#d73a49">Runnable</span><span style="color:#24292e">&gt; rejectPolicy;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">// ÊâßË°å‰ªªÂä°</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">void</span><span style="color:#24292e"> </span><span style="color:#6f42c1">execute</span><span style="color:#24292e">(Runnable </span><span style="color:#e36209">task</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6a737d">// ÂΩì‰ªªÂä°Êï∞Ê≤°ÊúâË∂ÖËøá coreSize Êó∂ÔºåÁõ¥Êé•‰∫§Áªô worker ÂØπË±°ÊâßË°å</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6a737d">// Â¶ÇÊûú‰ªªÂä°Êï∞Ë∂ÖËøá coreSize Êó∂ÔºåÂä†ÂÖ•‰ªªÂä°ÈòüÂàóÊöÇÂ≠ò</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">synchronized</span><span style="color:#24292e"> (workers) {</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">if</span><span style="color:#24292e">(workers.</span><span style="color:#6f42c1">size</span><span style="color:#24292e">() </span><span style="color:#d73a49">&lt;</span><span style="color:#24292e"> coreSize) {</span></span>
<span class="line"><span style="color:#24292e">                Worker worker </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Worker</span><span style="color:#24292e">(task);</span></span>
<span class="line"><span style="color:#24292e">                log.</span><span style="color:#6f42c1">debug</span><span style="color:#24292e">(</span><span style="color:#032f62">"Êñ∞Â¢û worker{}, {}"</span><span style="color:#24292e">, worker, task);</span></span>
<span class="line"><span style="color:#24292e">                workers.</span><span style="color:#6f42c1">add</span><span style="color:#24292e">(worker);</span></span>
<span class="line"><span style="color:#24292e">                worker.</span><span style="color:#6f42c1">start</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">            } </span><span style="color:#d73a49">else</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#6a737d">//                taskQueue.put(task);</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#6a737d">// 1) Ê≠ªÁ≠â</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#6a737d">// 2) Â∏¶Ë∂ÖÊó∂Á≠âÂæÖ</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#6a737d">// 3) ËÆ©Ë∞ÉÁî®ËÄÖÊîæÂºÉ‰ªªÂä°ÊâßË°å</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#6a737d">// 4) ËÆ©Ë∞ÉÁî®ËÄÖÊäõÂá∫ÂºÇÂ∏∏</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#6a737d">// 5) ËÆ©Ë∞ÉÁî®ËÄÖËá™Â∑±ÊâßË°å‰ªªÂä°</span></span>
<span class="line"><span style="color:#24292e">                taskQueue.</span><span style="color:#6f42c1">tryPut</span><span style="color:#24292e">(rejectPolicy, task);</span></span>
<span class="line"><span style="color:#24292e">            }</span></span>
<span class="line"><span style="color:#24292e">        }</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#6f42c1">ThreadPool</span><span style="color:#24292e">(</span><span style="color:#d73a49">int</span><span style="color:#24292e"> </span><span style="color:#e36209">coreSize</span><span style="color:#24292e">, </span><span style="color:#d73a49">long</span><span style="color:#24292e"> </span><span style="color:#e36209">timeout</span><span style="color:#24292e">, TimeUnit </span><span style="color:#e36209">timeUnit</span><span style="color:#24292e">, </span><span style="color:#d73a49">int</span><span style="color:#24292e"> </span><span style="color:#e36209">queueCapcity</span><span style="color:#24292e">, RejectPolicy&lt;</span><span style="color:#d73a49">Runnable</span><span style="color:#24292e">&gt; </span><span style="color:#e36209">rejectPolicy</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#005cc5">this</span><span style="color:#24292e">.coreSize </span><span style="color:#d73a49">=</span><span style="color:#24292e"> coreSize;</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#005cc5">this</span><span style="color:#24292e">.timeout </span><span style="color:#d73a49">=</span><span style="color:#24292e"> timeout;</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#005cc5">this</span><span style="color:#24292e">.timeUnit </span><span style="color:#d73a49">=</span><span style="color:#24292e"> timeUnit;</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#005cc5">this</span><span style="color:#24292e">.taskQueue </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> BlockingQueue&lt;&gt;(queueCapcity);</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#005cc5">this</span><span style="color:#24292e">.rejectPolicy </span><span style="color:#d73a49">=</span><span style="color:#24292e"> rejectPolicy;</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">class</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Worker</span><span style="color:#24292e"> </span><span style="color:#d73a49">extends</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Thread</span><span style="color:#24292e">{</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">private</span><span style="color:#24292e"> Runnable task;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Worker</span><span style="color:#24292e">(Runnable </span><span style="color:#e36209">task</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#005cc5">this</span><span style="color:#24292e">.task </span><span style="color:#d73a49">=</span><span style="color:#24292e"> task;</span></span>
<span class="line"><span style="color:#24292e">        }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">        @</span><span style="color:#d73a49">Override</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">void</span><span style="color:#24292e"> </span><span style="color:#6f42c1">run</span><span style="color:#24292e">() {</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#6a737d">// ÊâßË°å‰ªªÂä°</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#6a737d">// 1) ÂΩì task ‰∏ç‰∏∫Á©∫ÔºåÊâßË°å‰ªªÂä°</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#6a737d">// 2) ÂΩì task ÊâßË°åÂÆåÊØïÔºåÂÜçÊé•ÁùÄ‰ªé‰ªªÂä°ÈòüÂàóËé∑Âèñ‰ªªÂä°Âπ∂ÊâßË°å</span></span>
<span class="line"><span style="color:#6a737d">//            while(task != null || (task = taskQueue.take()) != null) {</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">while</span><span style="color:#24292e">(task </span><span style="color:#d73a49">!=</span><span style="color:#24292e"> </span><span style="color:#005cc5">null</span><span style="color:#24292e"> </span><span style="color:#d73a49">||</span><span style="color:#24292e"> (task </span><span style="color:#d73a49">=</span><span style="color:#24292e"> taskQueue.</span><span style="color:#6f42c1">poll</span><span style="color:#24292e">(timeout, timeUnit)) </span><span style="color:#d73a49">!=</span><span style="color:#24292e"> </span><span style="color:#005cc5">null</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#d73a49">try</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">                    log.</span><span style="color:#6f42c1">debug</span><span style="color:#24292e">(</span><span style="color:#032f62">"Ê≠£Âú®ÊâßË°å...{}"</span><span style="color:#24292e">, task);</span></span>
<span class="line"><span style="color:#24292e">                    task.</span><span style="color:#6f42c1">run</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">                } </span><span style="color:#d73a49">catch</span><span style="color:#24292e"> (Exception </span><span style="color:#e36209">e</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">                    e.</span><span style="color:#6f42c1">printStackTrace</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">                } </span><span style="color:#d73a49">finally</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">                    task </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#005cc5">null</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">                }</span></span>
<span class="line"><span style="color:#24292e">            }</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">synchronized</span><span style="color:#24292e"> (workers) {</span></span>
<span class="line"><span style="color:#24292e">                log.</span><span style="color:#6f42c1">debug</span><span style="color:#24292e">(</span><span style="color:#032f62">"worker Ë¢´ÁßªÈô§{}"</span><span style="color:#24292e">, </span><span style="color:#005cc5">this</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">                workers.</span><span style="color:#6f42c1">remove</span><span style="color:#24292e">(</span><span style="color:#005cc5">this</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">            }</span></span>
<span class="line"><span style="color:#24292e">        }</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"><span style="color:#24292e">}</span></span>
<span class="line"><span style="color:#24292e">@</span><span style="color:#d73a49">Slf4j</span><span style="color:#24292e">(</span><span style="color:#005cc5">topic</span><span style="color:#24292e"> </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#032f62">"c.BlockingQueue"</span><span style="color:#24292e">)</span></span>
<span class="line"><span style="color:#d73a49">class</span><span style="color:#24292e"> </span><span style="color:#6f42c1">BlockingQueue</span><span style="color:#24292e">&lt;</span><span style="color:#d73a49">T</span><span style="color:#24292e">&gt; {</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">// 1. ‰ªªÂä°ÈòüÂàó</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">private</span><span style="color:#24292e"> Deque&lt;</span><span style="color:#d73a49">T</span><span style="color:#24292e">&gt; queue </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> ArrayDeque&lt;&gt;();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">// 2. ÈîÅ</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">private</span><span style="color:#24292e"> ReentrantLock lock </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">ReentrantLock</span><span style="color:#24292e">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">// 3. Áîü‰∫ßËÄÖÊù°‰ª∂ÂèòÈáè</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">private</span><span style="color:#24292e"> Condition fullWaitSet </span><span style="color:#d73a49">=</span><span style="color:#24292e"> lock.</span><span style="color:#6f42c1">newCondition</span><span style="color:#24292e">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">// 4. Ê∂àË¥πËÄÖÊù°‰ª∂ÂèòÈáè</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">private</span><span style="color:#24292e"> Condition emptyWaitSet </span><span style="color:#d73a49">=</span><span style="color:#24292e"> lock.</span><span style="color:#6f42c1">newCondition</span><span style="color:#24292e">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">// 5. ÂÆπÈáè</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">private</span><span style="color:#24292e"> </span><span style="color:#d73a49">int</span><span style="color:#24292e"> capcity;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#6f42c1">BlockingQueue</span><span style="color:#24292e">(</span><span style="color:#d73a49">int</span><span style="color:#24292e"> </span><span style="color:#e36209">capcity</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#005cc5">this</span><span style="color:#24292e">.capcity </span><span style="color:#d73a49">=</span><span style="color:#24292e"> capcity;</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">// Â∏¶Ë∂ÖÊó∂ÈòªÂ°ûËé∑Âèñ</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">public</span><span style="color:#24292e"> T </span><span style="color:#6f42c1">poll</span><span style="color:#24292e">(</span><span style="color:#d73a49">long</span><span style="color:#24292e"> </span><span style="color:#e36209">timeout</span><span style="color:#24292e">, TimeUnit </span><span style="color:#e36209">unit</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">        lock.</span><span style="color:#6f42c1">lock</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">try</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#6a737d">// Â∞Ü timeout Áªü‰∏ÄËΩ¨Êç¢‰∏∫ Á∫≥Áßí</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">long</span><span style="color:#24292e"> nanos </span><span style="color:#d73a49">=</span><span style="color:#24292e"> unit.</span><span style="color:#6f42c1">toNanos</span><span style="color:#24292e">(timeout);</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">while</span><span style="color:#24292e"> (queue.</span><span style="color:#6f42c1">isEmpty</span><span style="color:#24292e">()) {</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#d73a49">try</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">                    </span><span style="color:#6a737d">// ËøîÂõûÂÄºÊòØÂâ©‰ΩôÊó∂Èó¥</span></span>
<span class="line"><span style="color:#24292e">                    </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (nanos </span><span style="color:#d73a49">&lt;=</span><span style="color:#24292e"> </span><span style="color:#005cc5">0</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">                        </span><span style="color:#d73a49">return</span><span style="color:#24292e"> </span><span style="color:#005cc5">null</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">                    }</span></span>
<span class="line"><span style="color:#24292e">                    nanos </span><span style="color:#d73a49">=</span><span style="color:#24292e"> emptyWaitSet.</span><span style="color:#6f42c1">awaitNanos</span><span style="color:#24292e">(nanos);</span></span>
<span class="line"><span style="color:#24292e">                } </span><span style="color:#d73a49">catch</span><span style="color:#24292e"> (InterruptedException </span><span style="color:#e36209">e</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">                    e.</span><span style="color:#6f42c1">printStackTrace</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">                }</span></span>
<span class="line"><span style="color:#24292e">            }</span></span>
<span class="line"><span style="color:#24292e">            T t </span><span style="color:#d73a49">=</span><span style="color:#24292e"> queue.</span><span style="color:#6f42c1">removeFirst</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">            fullWaitSet.</span><span style="color:#6f42c1">signal</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">return</span><span style="color:#24292e"> t;</span></span>
<span class="line"><span style="color:#24292e">        } </span><span style="color:#d73a49">finally</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">            lock.</span><span style="color:#6f42c1">unlock</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">        }</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">// ÈòªÂ°ûËé∑Âèñ</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">public</span><span style="color:#24292e"> T </span><span style="color:#6f42c1">take</span><span style="color:#24292e">() {</span></span>
<span class="line"><span style="color:#24292e">        lock.</span><span style="color:#6f42c1">lock</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">try</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">while</span><span style="color:#24292e"> (queue.</span><span style="color:#6f42c1">isEmpty</span><span style="color:#24292e">()) {</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#d73a49">try</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">                    emptyWaitSet.</span><span style="color:#6f42c1">await</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">                } </span><span style="color:#d73a49">catch</span><span style="color:#24292e"> (InterruptedException </span><span style="color:#e36209">e</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">                    e.</span><span style="color:#6f42c1">printStackTrace</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">                }</span></span>
<span class="line"><span style="color:#24292e">            }</span></span>
<span class="line"><span style="color:#24292e">            T t </span><span style="color:#d73a49">=</span><span style="color:#24292e"> queue.</span><span style="color:#6f42c1">removeFirst</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">            fullWaitSet.</span><span style="color:#6f42c1">signal</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">return</span><span style="color:#24292e"> t;</span></span>
<span class="line"><span style="color:#24292e">        } </span><span style="color:#d73a49">finally</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">            lock.</span><span style="color:#6f42c1">unlock</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">        }</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">// ÈòªÂ°ûÊ∑ªÂä†</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">void</span><span style="color:#24292e"> </span><span style="color:#6f42c1">put</span><span style="color:#24292e">(T </span><span style="color:#e36209">task</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">        lock.</span><span style="color:#6f42c1">lock</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">try</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">while</span><span style="color:#24292e"> (queue.</span><span style="color:#6f42c1">size</span><span style="color:#24292e">() </span><span style="color:#d73a49">==</span><span style="color:#24292e"> capcity) {</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#d73a49">try</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">                    log.</span><span style="color:#6f42c1">debug</span><span style="color:#24292e">(</span><span style="color:#032f62">"Á≠âÂæÖÂä†ÂÖ•‰ªªÂä°ÈòüÂàó {} ..."</span><span style="color:#24292e">, task);</span></span>
<span class="line"><span style="color:#24292e">                    fullWaitSet.</span><span style="color:#6f42c1">await</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">                } </span><span style="color:#d73a49">catch</span><span style="color:#24292e"> (InterruptedException </span><span style="color:#e36209">e</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">                    e.</span><span style="color:#6f42c1">printStackTrace</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">                }</span></span>
<span class="line"><span style="color:#24292e">            }</span></span>
<span class="line"><span style="color:#24292e">            log.</span><span style="color:#6f42c1">debug</span><span style="color:#24292e">(</span><span style="color:#032f62">"Âä†ÂÖ•‰ªªÂä°ÈòüÂàó {}"</span><span style="color:#24292e">, task);</span></span>
<span class="line"><span style="color:#24292e">            queue.</span><span style="color:#6f42c1">addLast</span><span style="color:#24292e">(task);</span></span>
<span class="line"><span style="color:#24292e">            emptyWaitSet.</span><span style="color:#6f42c1">signal</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">        } </span><span style="color:#d73a49">finally</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">            lock.</span><span style="color:#6f42c1">unlock</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">        }</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">// Â∏¶Ë∂ÖÊó∂Êó∂Èó¥ÈòªÂ°ûÊ∑ªÂä†</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">boolean</span><span style="color:#24292e"> </span><span style="color:#6f42c1">offer</span><span style="color:#24292e">(T </span><span style="color:#e36209">task</span><span style="color:#24292e">, </span><span style="color:#d73a49">long</span><span style="color:#24292e"> </span><span style="color:#e36209">timeout</span><span style="color:#24292e">, TimeUnit </span><span style="color:#e36209">timeUnit</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">        lock.</span><span style="color:#6f42c1">lock</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">try</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">long</span><span style="color:#24292e"> nanos </span><span style="color:#d73a49">=</span><span style="color:#24292e"> timeUnit.</span><span style="color:#6f42c1">toNanos</span><span style="color:#24292e">(timeout);</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">while</span><span style="color:#24292e"> (queue.</span><span style="color:#6f42c1">size</span><span style="color:#24292e">() </span><span style="color:#d73a49">==</span><span style="color:#24292e"> capcity) {</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#d73a49">try</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">                    </span><span style="color:#d73a49">if</span><span style="color:#24292e">(nanos </span><span style="color:#d73a49">&lt;=</span><span style="color:#24292e"> </span><span style="color:#005cc5">0</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">                        </span><span style="color:#d73a49">return</span><span style="color:#24292e"> </span><span style="color:#005cc5">false</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">                    }</span></span>
<span class="line"><span style="color:#24292e">                    log.</span><span style="color:#6f42c1">debug</span><span style="color:#24292e">(</span><span style="color:#032f62">"Á≠âÂæÖÂä†ÂÖ•‰ªªÂä°ÈòüÂàó {} ..."</span><span style="color:#24292e">, task);</span></span>
<span class="line"><span style="color:#24292e">                    nanos </span><span style="color:#d73a49">=</span><span style="color:#24292e"> fullWaitSet.</span><span style="color:#6f42c1">awaitNanos</span><span style="color:#24292e">(nanos);</span></span>
<span class="line"><span style="color:#24292e">                } </span><span style="color:#d73a49">catch</span><span style="color:#24292e"> (InterruptedException </span><span style="color:#e36209">e</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">                    e.</span><span style="color:#6f42c1">printStackTrace</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">                }</span></span>
<span class="line"><span style="color:#24292e">            }</span></span>
<span class="line"><span style="color:#24292e">            log.</span><span style="color:#6f42c1">debug</span><span style="color:#24292e">(</span><span style="color:#032f62">"Âä†ÂÖ•‰ªªÂä°ÈòüÂàó {}"</span><span style="color:#24292e">, task);</span></span>
<span class="line"><span style="color:#24292e">            queue.</span><span style="color:#6f42c1">addLast</span><span style="color:#24292e">(task);</span></span>
<span class="line"><span style="color:#24292e">            emptyWaitSet.</span><span style="color:#6f42c1">signal</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">return</span><span style="color:#24292e"> </span><span style="color:#005cc5">true</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">        } </span><span style="color:#d73a49">finally</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">            lock.</span><span style="color:#6f42c1">unlock</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">        }</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">int</span><span style="color:#24292e"> </span><span style="color:#6f42c1">size</span><span style="color:#24292e">() {</span></span>
<span class="line"><span style="color:#24292e">        lock.</span><span style="color:#6f42c1">lock</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">try</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">return</span><span style="color:#24292e"> queue.</span><span style="color:#6f42c1">size</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">        } </span><span style="color:#d73a49">finally</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">            lock.</span><span style="color:#6f42c1">unlock</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">        }</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">void</span><span style="color:#24292e"> </span><span style="color:#6f42c1">tryPut</span><span style="color:#24292e">(RejectPolicy&lt;</span><span style="color:#d73a49">T</span><span style="color:#24292e">&gt; </span><span style="color:#e36209">rejectPolicy</span><span style="color:#24292e">, T </span><span style="color:#e36209">task</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">        lock.</span><span style="color:#6f42c1">lock</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">try</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#6a737d">// Âà§Êñ≠ÈòüÂàóÊòØÂê¶Êª°</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">if</span><span style="color:#24292e">(queue.</span><span style="color:#6f42c1">size</span><span style="color:#24292e">() </span><span style="color:#d73a49">==</span><span style="color:#24292e"> capcity) {</span></span>
<span class="line"><span style="color:#24292e">                rejectPolicy.</span><span style="color:#6f42c1">reject</span><span style="color:#24292e">(</span><span style="color:#005cc5">this</span><span style="color:#24292e">, task);</span></span>
<span class="line"><span style="color:#24292e">            } </span><span style="color:#d73a49">else</span><span style="color:#24292e"> {  </span><span style="color:#6a737d">// ÊúâÁ©∫Èó≤</span></span>
<span class="line"><span style="color:#24292e">                log.</span><span style="color:#6f42c1">debug</span><span style="color:#24292e">(</span><span style="color:#032f62">"Âä†ÂÖ•‰ªªÂä°ÈòüÂàó {}"</span><span style="color:#24292e">, task);</span></span>
<span class="line"><span style="color:#24292e">                queue.</span><span style="color:#6f42c1">addLast</span><span style="color:#24292e">(task);</span></span>
<span class="line"><span style="color:#24292e">                emptyWaitSet.</span><span style="color:#6f42c1">signal</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">            }</span></span>
<span class="line"><span style="color:#24292e">        } </span><span style="color:#d73a49">finally</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">            lock.</span><span style="color:#6f42c1">unlock</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">        }</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"><span style="color:#24292e">}</span></span></code></pre></div><p>ÂÆûÁé∞‰∫Ü‰∏Ä‰∏™ÁÆÄÂçïÁöÑÁ∫øÁ®ãÊ±†</p><ul><li>ÈòªÂ°ûÈòüÂàóBlockingQueueÁî®‰∫éÊöÇÂ≠òÊù•‰∏çÂèäË¢´Á∫øÁ®ãÊâßË°åÁöÑ‰ªªÂä°<ul><li>‰πüÂèØ‰ª•ËØ¥ÊòØÂπ≥Ë°°Áîü‰∫ßËÄÖÂíåÊ∂àË¥πËÄÖÊâßË°åÈÄüÂ∫¶‰∏äÁöÑÂ∑ÆÂºÇ</li><li>ÈáåÈù¢ÁöÑËé∑Âèñ‰ªªÂä°ÂíåÊîæÂÖ•‰ªªÂä°Áî®Âà∞‰∫Ü<strong>Áîü‰∫ßËÄÖÊ∂àË¥πËÄÖÊ®°Âºè</strong></li></ul></li><li>Á∫øÁ®ãÊ±†‰∏≠ÂØπÁ∫øÁ®ãThreadËøõË°å‰∫ÜÂÜçÊ¨°ÁöÑÂ∞ÅË£ÖÔºåÂ∞ÅË£Ö‰∏∫‰∫ÜWorker<ul><li>Âú®Ë∞ÉÁî®‰ªªÂä°ÁöÑrunÊñπÊ≥ïÊó∂ÔºåÁ∫øÁ®ã‰ºöÂéªÊâßË°åËØ•‰ªªÂä°ÔºåÊâßË°åÂÆåÊØïÂêéËøò‰ºö<strong>Âà∞ÈòªÂ°ûÈòüÂàó‰∏≠Ëé∑ÂèñÊñ∞‰ªªÂä°Êù•ÊâßË°å</strong></li></ul></li><li>Á∫øÁ®ãÊ±†‰∏≠ÊâßË°å‰ªªÂä°ÁöÑ‰∏ªË¶ÅÊñπÊ≥ï‰∏∫executeÊñπÊ≥ï<ul><li>ÊâßË°åÊó∂Ë¶ÅÂà§Êñ≠Ê≠£Âú®ÊâßË°åÁöÑÁ∫øÁ®ãÊï∞ÊòØÂê¶Â§ß‰∫é‰∫ÜÁ∫øÁ®ãÊ±†ÂÆπÈáè</li></ul></li><li>ÂΩìË∂ÖËøáÊÄªÁ∫øÁ®ãÊï∞ÔºàÊ†∏ÂøÉÁ∫øÁ®ãÊú™ÊâßË°åÂÆå+Â∑•‰ΩúÈòüÂàóÂ∑≤Êª°ÔºâÊâßË°åËá™ÂÆö‰πâÊãíÁªùÁ≠ñÁï•ÔºàÂáΩÊï∞ÂºèÊé•Âè£Ôºâ</li></ul><h3 id="_2„ÄÅthreadpoolexecutor" tabindex="-1">2„ÄÅThreadPoolExecutor <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20advanced%20chapter#_2„ÄÅthreadpoolexecutor" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h3><h4 id="ÁªßÊâøÂÖ≥Á≥ª" tabindex="-1">ÁªßÊâøÂÖ≥Á≥ª <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20advanced%20chapter#ÁªßÊâøÂÖ≥Á≥ª" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h4><figure><img src="https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/20201022212832.png" alt="img" loading="lazy" decoding="async"></figure><h4 id="Á∫øÁ®ãÊ±†Áä∂ÊÄÅ" tabindex="-1">Á∫øÁ®ãÊ±†Áä∂ÊÄÅ <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20advanced%20chapter#Á∫øÁ®ãÊ±†Áä∂ÊÄÅ" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h4><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6a737d">// Á∫øÁ®ãÊ±†Áä∂ÊÄÅ</span></span>
<span class="line"><span style="color:#6a737d">// runState is stored in the high-order bits</span></span>
<span class="line"><span style="color:#6a737d">// RUNNING È´ò3‰Ωç‰∏∫111</span></span>
<span class="line"><span style="color:#f97583">private</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">static</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">final</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> RUNNING    </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">-</span><span style="color:#79b8ff">1</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">&lt;&lt;</span><span style="color:#e1e4e8"> COUNT_BITS;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6a737d">// SHUTDOWN È´ò3‰Ωç‰∏∫000</span></span>
<span class="line"><span style="color:#f97583">private</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">static</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">final</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> SHUTDOWN   </span><span style="color:#f97583">=</span><span style="color:#e1e4e8">  </span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">&lt;&lt;</span><span style="color:#e1e4e8"> COUNT_BITS;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6a737d">// È´ò3‰Ωç 001</span></span>
<span class="line"><span style="color:#f97583">private</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">static</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">final</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> STOP       </span><span style="color:#f97583">=</span><span style="color:#e1e4e8">  </span><span style="color:#79b8ff">1</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">&lt;&lt;</span><span style="color:#e1e4e8"> COUNT_BITS;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6a737d">// È´ò3‰Ωç 010</span></span>
<span class="line"><span style="color:#f97583">private</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">static</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">final</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> TIDYING    </span><span style="color:#f97583">=</span><span style="color:#e1e4e8">  </span><span style="color:#79b8ff">2</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">&lt;&lt;</span><span style="color:#e1e4e8"> COUNT_BITS;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6a737d">// È´ò3‰Ωç 011</span></span>
<span class="line"><span style="color:#f97583">private</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">static</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">final</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> TERMINATED </span><span style="color:#f97583">=</span><span style="color:#e1e4e8">  </span><span style="color:#79b8ff">3</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">&lt;&lt;</span><span style="color:#e1e4e8"> COUNT_BITS;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6a737d">// Á∫øÁ®ãÊ±†Áä∂ÊÄÅ</span></span>
<span class="line"><span style="color:#6a737d">// runState is stored in the high-order bits</span></span>
<span class="line"><span style="color:#6a737d">// RUNNING È´ò3‰Ωç‰∏∫111</span></span>
<span class="line"><span style="color:#d73a49">private</span><span style="color:#24292e"> </span><span style="color:#d73a49">static</span><span style="color:#24292e"> </span><span style="color:#d73a49">final</span><span style="color:#24292e"> </span><span style="color:#d73a49">int</span><span style="color:#24292e"> RUNNING    </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#d73a49">-</span><span style="color:#005cc5">1</span><span style="color:#24292e"> </span><span style="color:#d73a49">&lt;&lt;</span><span style="color:#24292e"> COUNT_BITS;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6a737d">// SHUTDOWN È´ò3‰Ωç‰∏∫000</span></span>
<span class="line"><span style="color:#d73a49">private</span><span style="color:#24292e"> </span><span style="color:#d73a49">static</span><span style="color:#24292e"> </span><span style="color:#d73a49">final</span><span style="color:#24292e"> </span><span style="color:#d73a49">int</span><span style="color:#24292e"> SHUTDOWN   </span><span style="color:#d73a49">=</span><span style="color:#24292e">  </span><span style="color:#005cc5">0</span><span style="color:#24292e"> </span><span style="color:#d73a49">&lt;&lt;</span><span style="color:#24292e"> COUNT_BITS;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6a737d">// È´ò3‰Ωç 001</span></span>
<span class="line"><span style="color:#d73a49">private</span><span style="color:#24292e"> </span><span style="color:#d73a49">static</span><span style="color:#24292e"> </span><span style="color:#d73a49">final</span><span style="color:#24292e"> </span><span style="color:#d73a49">int</span><span style="color:#24292e"> STOP       </span><span style="color:#d73a49">=</span><span style="color:#24292e">  </span><span style="color:#005cc5">1</span><span style="color:#24292e"> </span><span style="color:#d73a49">&lt;&lt;</span><span style="color:#24292e"> COUNT_BITS;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6a737d">// È´ò3‰Ωç 010</span></span>
<span class="line"><span style="color:#d73a49">private</span><span style="color:#24292e"> </span><span style="color:#d73a49">static</span><span style="color:#24292e"> </span><span style="color:#d73a49">final</span><span style="color:#24292e"> </span><span style="color:#d73a49">int</span><span style="color:#24292e"> TIDYING    </span><span style="color:#d73a49">=</span><span style="color:#24292e">  </span><span style="color:#005cc5">2</span><span style="color:#24292e"> </span><span style="color:#d73a49">&lt;&lt;</span><span style="color:#24292e"> COUNT_BITS;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6a737d">// È´ò3‰Ωç 011</span></span>
<span class="line"><span style="color:#d73a49">private</span><span style="color:#24292e"> </span><span style="color:#d73a49">static</span><span style="color:#24292e"> </span><span style="color:#d73a49">final</span><span style="color:#24292e"> </span><span style="color:#d73a49">int</span><span style="color:#24292e"> TERMINATED </span><span style="color:#d73a49">=</span><span style="color:#24292e">  </span><span style="color:#005cc5">3</span><span style="color:#24292e"> </span><span style="color:#d73a49">&lt;&lt;</span><span style="color:#24292e"> COUNT_BITS;</span></span></code></pre></div><table><thead><tr><th>Áä∂ÊÄÅÂêçÁß∞</th><th>È´ò3‰ΩçÁöÑÂÄº</th><th>ÊèèËø∞</th></tr></thead><tbody><tr><td>RUNNING</td><td>111</td><td>Êé•Êî∂Êñ∞‰ªªÂä°ÔºåÂêåÊó∂Â§ÑÁêÜ‰ªªÂä°ÈòüÂàó‰∏≠ÁöÑ‰ªªÂä°</td></tr><tr><td>SHUTDOWN</td><td>000</td><td>‰∏çÊé•ÂèóÊñ∞‰ªªÂä°Ôºå‰ΩÜÊòØÂ§ÑÁêÜ‰ªªÂä°ÈòüÂàó‰∏≠ÁöÑ‰ªªÂä°</td></tr><tr><td>STOP</td><td>001</td><td>‰∏≠Êñ≠Ê≠£Âú®ÊâßË°åÁöÑ‰ªªÂä°ÔºåÂêåÊó∂ÊäõÂºÉÈòªÂ°ûÈòüÂàó‰∏≠ÁöÑ‰ªªÂä°</td></tr><tr><td>TIDYING</td><td>010</td><td>‰ªªÂä°ÊâßË°åÂÆåÊØïÔºåÊ¥ªÂä®Á∫øÁ®ã‰∏∫0Êó∂ÔºåÂç≥Â∞ÜËøõÂÖ•ÁªàÁªìÈò∂ÊÆµ</td></tr><tr><td>TERMINATED</td><td>011</td><td>ÁªàÁªìÁä∂ÊÄÅ</td></tr></tbody></table><p>Á∫øÁ®ãÊ±†Áä∂ÊÄÅÂíåÁ∫øÁ®ãÊ±†‰∏≠Á∫øÁ®ãÁöÑÊï∞Èáè<strong>Áî±‰∏Ä‰∏™ÂéüÂ≠êÊï¥ÂûãctlÊù•ÂÖ±ÂêåË°®Á§∫</strong></p><ul><li>‰ΩøÁî®‰∏Ä‰∏™Êï∞Êù•Ë°®Á§∫‰∏§‰∏™ÂÄºÁöÑ‰∏ªË¶ÅÂéüÂõ†ÊòØÔºö<strong>ÂèØ‰ª•ÈÄöËøá‰∏ÄÊ¨°CASÂêåÊó∂Êõ¥Êîπ‰∏§‰∏™Â±ûÊÄßÁöÑÂÄº</strong></li></ul><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6a737d">// c ‰∏∫ÊóßÂÄºÔºå ctlOf ËøîÂõûÁªìÊûú‰∏∫Êñ∞ÂÄº</span></span>
<span class="line"><span style="color:#e1e4e8">ctl.</span><span style="color:#b392f0">compareAndSet</span><span style="color:#e1e4e8">(c, </span><span style="color:#b392f0">ctlOf</span><span style="color:#e1e4e8">(targetState, </span><span style="color:#b392f0">workerCountOf</span><span style="color:#e1e4e8">(c))));</span></span>
<span class="line"><span style="color:#6a737d">// rs(runningState) ‰∏∫È´ò 3 ‰Ωç‰ª£Ë°®Á∫øÁ®ãÊ±†Áä∂ÊÄÅÔºå wc ‰∏∫‰Ωé 29 ‰Ωç‰ª£Ë°®Á∫øÁ®ã‰∏™Êï∞Ôºåctl ÊòØÂêàÂπ∂ÂÆÉ‰ª¨</span></span>
<span class="line"><span style="color:#f97583">private</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">static</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">ctlOf</span><span style="color:#e1e4e8">(</span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> rs, </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> wc) { </span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> rs </span><span style="color:#f97583">|</span><span style="color:#e1e4e8"> wc; }</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6a737d">// c ‰∏∫ÊóßÂÄºÔºå ctlOf ËøîÂõûÁªìÊûú‰∏∫Êñ∞ÂÄº</span></span>
<span class="line"><span style="color:#24292e">ctl.</span><span style="color:#6f42c1">compareAndSet</span><span style="color:#24292e">(c, </span><span style="color:#6f42c1">ctlOf</span><span style="color:#24292e">(targetState, </span><span style="color:#6f42c1">workerCountOf</span><span style="color:#24292e">(c))));</span></span>
<span class="line"><span style="color:#6a737d">// rs(runningState) ‰∏∫È´ò 3 ‰Ωç‰ª£Ë°®Á∫øÁ®ãÊ±†Áä∂ÊÄÅÔºå wc ‰∏∫‰Ωé 29 ‰Ωç‰ª£Ë°®Á∫øÁ®ã‰∏™Êï∞Ôºåctl ÊòØÂêàÂπ∂ÂÆÉ‰ª¨</span></span>
<span class="line"><span style="color:#d73a49">private</span><span style="color:#24292e"> </span><span style="color:#d73a49">static</span><span style="color:#24292e"> </span><span style="color:#d73a49">int</span><span style="color:#24292e"> </span><span style="color:#6f42c1">ctlOf</span><span style="color:#24292e">(</span><span style="color:#d73a49">int</span><span style="color:#24292e"> rs, </span><span style="color:#d73a49">int</span><span style="color:#24292e"> wc) { </span><span style="color:#d73a49">return</span><span style="color:#24292e"> rs </span><span style="color:#d73a49">|</span><span style="color:#24292e"> wc; }</span></span></code></pre></div><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6a737d">// ÂéüÂ≠êÊï¥Êï∞ÔºåÂâç3‰Ωç‰øùÂ≠ò‰∫ÜÁ∫øÁ®ãÊ±†ÁöÑÁä∂ÊÄÅÔºåÂâ©‰Ωô‰Ωç‰øùÂ≠òÁöÑÊòØÁ∫øÁ®ãÊï∞Èáè</span></span>
<span class="line"><span style="color:#f97583">private</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">final</span><span style="color:#e1e4e8"> AtomicInteger ctl </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">AtomicInteger</span><span style="color:#e1e4e8">(</span><span style="color:#b392f0">ctlOf</span><span style="color:#e1e4e8">(RUNNING, </span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8">));</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6a737d">// Âπ∂‰∏çÊòØÊâÄÊúâÂπ≥Âè∞ÁöÑintÈÉΩÊòØ32‰Ωç„ÄÇ</span></span>
<span class="line"><span style="color:#6a737d">// ÂéªÊéâÂâç‰∏â‰Ωç‰øùÂ≠òÁ∫øÁ®ãÁä∂ÊÄÅÁöÑ‰ΩçÊï∞ÔºåÂâ©‰∏ãÁöÑÁî®‰∫é‰øùÂ≠òÁ∫øÁ®ãÊï∞Èáè</span></span>
<span class="line"><span style="color:#6a737d">// È´ò3‰Ωç‰∏∫0ÔºåÂâ©‰Ωô‰ΩçÊï∞ÂÖ®‰∏∫1</span></span>
<span class="line"><span style="color:#f97583">private</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">static</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">final</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> COUNT_BITS </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> Integer.SIZE </span><span style="color:#f97583">-</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">3</span><span style="color:#e1e4e8">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6a737d">// 2^COUNT_BITSÊ¨°ÊñπÔºåË°®Á§∫ÂèØ‰ª•‰øùÂ≠òÁöÑÊúÄÂ§ßÁ∫øÁ®ãÊï∞</span></span>
<span class="line"><span style="color:#6a737d">// CAPACITY ÁöÑÈ´ò3‰Ωç‰∏∫ 0</span></span>
<span class="line"><span style="color:#f97583">private</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">static</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">final</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> CAPACITY   </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> (</span><span style="color:#79b8ff">1</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">&lt;&lt;</span><span style="color:#e1e4e8"> COUNT_BITS) </span><span style="color:#f97583">-</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">1</span><span style="color:#e1e4e8">;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6a737d">// ÂéüÂ≠êÊï¥Êï∞ÔºåÂâç3‰Ωç‰øùÂ≠ò‰∫ÜÁ∫øÁ®ãÊ±†ÁöÑÁä∂ÊÄÅÔºåÂâ©‰Ωô‰Ωç‰øùÂ≠òÁöÑÊòØÁ∫øÁ®ãÊï∞Èáè</span></span>
<span class="line"><span style="color:#d73a49">private</span><span style="color:#24292e"> </span><span style="color:#d73a49">final</span><span style="color:#24292e"> AtomicInteger ctl </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">AtomicInteger</span><span style="color:#24292e">(</span><span style="color:#6f42c1">ctlOf</span><span style="color:#24292e">(RUNNING, </span><span style="color:#005cc5">0</span><span style="color:#24292e">));</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6a737d">// Âπ∂‰∏çÊòØÊâÄÊúâÂπ≥Âè∞ÁöÑintÈÉΩÊòØ32‰Ωç„ÄÇ</span></span>
<span class="line"><span style="color:#6a737d">// ÂéªÊéâÂâç‰∏â‰Ωç‰øùÂ≠òÁ∫øÁ®ãÁä∂ÊÄÅÁöÑ‰ΩçÊï∞ÔºåÂâ©‰∏ãÁöÑÁî®‰∫é‰øùÂ≠òÁ∫øÁ®ãÊï∞Èáè</span></span>
<span class="line"><span style="color:#6a737d">// È´ò3‰Ωç‰∏∫0ÔºåÂâ©‰Ωô‰ΩçÊï∞ÂÖ®‰∏∫1</span></span>
<span class="line"><span style="color:#d73a49">private</span><span style="color:#24292e"> </span><span style="color:#d73a49">static</span><span style="color:#24292e"> </span><span style="color:#d73a49">final</span><span style="color:#24292e"> </span><span style="color:#d73a49">int</span><span style="color:#24292e"> COUNT_BITS </span><span style="color:#d73a49">=</span><span style="color:#24292e"> Integer.SIZE </span><span style="color:#d73a49">-</span><span style="color:#24292e"> </span><span style="color:#005cc5">3</span><span style="color:#24292e">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6a737d">// 2^COUNT_BITSÊ¨°ÊñπÔºåË°®Á§∫ÂèØ‰ª•‰øùÂ≠òÁöÑÊúÄÂ§ßÁ∫øÁ®ãÊï∞</span></span>
<span class="line"><span style="color:#6a737d">// CAPACITY ÁöÑÈ´ò3‰Ωç‰∏∫ 0</span></span>
<span class="line"><span style="color:#d73a49">private</span><span style="color:#24292e"> </span><span style="color:#d73a49">static</span><span style="color:#24292e"> </span><span style="color:#d73a49">final</span><span style="color:#24292e"> </span><span style="color:#d73a49">int</span><span style="color:#24292e"> CAPACITY   </span><span style="color:#d73a49">=</span><span style="color:#24292e"> (</span><span style="color:#005cc5">1</span><span style="color:#24292e"> </span><span style="color:#d73a49">&lt;&lt;</span><span style="color:#24292e"> COUNT_BITS) </span><span style="color:#d73a49">-</span><span style="color:#24292e"> </span><span style="color:#005cc5">1</span><span style="color:#24292e">;</span></span></code></pre></div><p>Ëé∑ÂèñÁ∫øÁ®ãÊ±†Áä∂ÊÄÅ„ÄÅÁ∫øÁ®ãÊï∞Èáè‰ª•ÂèäÂêàÂπ∂‰∏§‰∏™ÂÄºÁöÑÊìç‰Ωú</p><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6a737d">// Packing and unpacking ctl</span></span>
<span class="line"><span style="color:#6a737d">// Ëé∑ÂèñËøêË°åÁä∂ÊÄÅ</span></span>
<span class="line"><span style="color:#6a737d">// ËØ•Êìç‰Ωú‰ºöËÆ©Èô§È´ò3‰Ωç‰ª•Â§ñÁöÑÊï∞ÂÖ®ÈÉ®Âèò‰∏∫0</span></span>
<span class="line"><span style="color:#f97583">private</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">static</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">runStateOf</span><span style="color:#e1e4e8">(</span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> c)     { </span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> c </span><span style="color:#f97583">&amp;</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">~</span><span style="color:#e1e4e8">CAPACITY; }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6a737d">// Ëé∑ÂèñËøêË°åÁ∫øÁ®ãÊï∞</span></span>
<span class="line"><span style="color:#6a737d">// ËØ•Êìç‰Ωú‰ºöËÆ©È´ò3‰Ωç‰∏∫0</span></span>
<span class="line"><span style="color:#f97583">private</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">static</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">workerCountOf</span><span style="color:#e1e4e8">(</span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> c)  { </span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> c </span><span style="color:#f97583">&amp;</span><span style="color:#e1e4e8"> CAPACITY; }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6a737d">// ËÆ°ÁÆóctlÊñ∞ÂÄº</span></span>
<span class="line"><span style="color:#f97583">private</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">static</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">ctlOf</span><span style="color:#e1e4e8">(</span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> rs, </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> wc) { </span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> rs </span><span style="color:#f97583">|</span><span style="color:#e1e4e8"> wc; }</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6a737d">// Packing and unpacking ctl</span></span>
<span class="line"><span style="color:#6a737d">// Ëé∑ÂèñËøêË°åÁä∂ÊÄÅ</span></span>
<span class="line"><span style="color:#6a737d">// ËØ•Êìç‰Ωú‰ºöËÆ©Èô§È´ò3‰Ωç‰ª•Â§ñÁöÑÊï∞ÂÖ®ÈÉ®Âèò‰∏∫0</span></span>
<span class="line"><span style="color:#d73a49">private</span><span style="color:#24292e"> </span><span style="color:#d73a49">static</span><span style="color:#24292e"> </span><span style="color:#d73a49">int</span><span style="color:#24292e"> </span><span style="color:#6f42c1">runStateOf</span><span style="color:#24292e">(</span><span style="color:#d73a49">int</span><span style="color:#24292e"> c)     { </span><span style="color:#d73a49">return</span><span style="color:#24292e"> c </span><span style="color:#d73a49">&amp;</span><span style="color:#24292e"> </span><span style="color:#d73a49">~</span><span style="color:#24292e">CAPACITY; }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6a737d">// Ëé∑ÂèñËøêË°åÁ∫øÁ®ãÊï∞</span></span>
<span class="line"><span style="color:#6a737d">// ËØ•Êìç‰Ωú‰ºöËÆ©È´ò3‰Ωç‰∏∫0</span></span>
<span class="line"><span style="color:#d73a49">private</span><span style="color:#24292e"> </span><span style="color:#d73a49">static</span><span style="color:#24292e"> </span><span style="color:#d73a49">int</span><span style="color:#24292e"> </span><span style="color:#6f42c1">workerCountOf</span><span style="color:#24292e">(</span><span style="color:#d73a49">int</span><span style="color:#24292e"> c)  { </span><span style="color:#d73a49">return</span><span style="color:#24292e"> c </span><span style="color:#d73a49">&amp;</span><span style="color:#24292e"> CAPACITY; }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6a737d">// ËÆ°ÁÆóctlÊñ∞ÂÄº</span></span>
<span class="line"><span style="color:#d73a49">private</span><span style="color:#24292e"> </span><span style="color:#d73a49">static</span><span style="color:#24292e"> </span><span style="color:#d73a49">int</span><span style="color:#24292e"> </span><span style="color:#6f42c1">ctlOf</span><span style="color:#24292e">(</span><span style="color:#d73a49">int</span><span style="color:#24292e"> rs, </span><span style="color:#d73a49">int</span><span style="color:#24292e"> wc) { </span><span style="color:#d73a49">return</span><span style="color:#24292e"> rs </span><span style="color:#d73a49">|</span><span style="color:#24292e"> wc; }</span></span></code></pre></div><h4 id="Á∫øÁ®ãÊ±†Â±ûÊÄß" tabindex="-1">Á∫øÁ®ãÊ±†Â±ûÊÄß <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20advanced%20chapter#Á∫øÁ®ãÊ±†Â±ûÊÄß" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h4><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6a737d">// Â∑•‰ΩúÁ∫øÁ®ãÔºåÂÜÖÈÉ®Â∞ÅË£Ö‰∫ÜThread</span></span>
<span class="line"><span style="color:#f97583">private</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">final</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">class</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Worker</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">extends</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">AbstractQueuedSynchronizer</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">implements</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Runnable</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">    ...</span></span>
<span class="line"><span style="color:#e1e4e8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6a737d">// ÈòªÂ°ûÈòüÂàóÔºåÁî®‰∫éÂ≠òÊîæÊù•‰∏çÂèäË¢´Ê†∏ÂøÉÁ∫øÁ®ãÊâßË°åÁöÑ‰ªªÂä°</span></span>
<span class="line"><span style="color:#f97583">private</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">final</span><span style="color:#e1e4e8"> BlockingQueue&lt;</span><span style="color:#f97583">Runnable</span><span style="color:#e1e4e8">&gt; workQueue;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6a737d">// ÈîÅ</span></span>
<span class="line"><span style="color:#f97583">private</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">final</span><span style="color:#e1e4e8"> ReentrantLock mainLock </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">ReentrantLock</span><span style="color:#e1e4e8">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6a737d">//  Áî®‰∫éÂ≠òÊîæÊ†∏ÂøÉÁ∫øÁ®ãÁöÑÂÆπÂô®ÔºåÂè™ÊúâÂΩìÊåÅÊúâÈîÅÊó∂ÊâçËÉΩÂ§üËé∑ÂèñÂÖ∂‰∏≠ÁöÑÂÖÉÁ¥†ÔºàÊ†∏ÂøÉÁ∫øÁ®ãÔºâ</span></span>
<span class="line"><span style="color:#f97583">private</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">final</span><span style="color:#e1e4e8"> HashSet&lt;</span><span style="color:#f97583">Worker</span><span style="color:#e1e4e8">&gt; workers </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> HashSet&lt;</span><span style="color:#f97583">Worker</span><span style="color:#e1e4e8">&gt;();</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6a737d">// Â∑•‰ΩúÁ∫øÁ®ãÔºåÂÜÖÈÉ®Â∞ÅË£Ö‰∫ÜThread</span></span>
<span class="line"><span style="color:#d73a49">private</span><span style="color:#24292e"> </span><span style="color:#d73a49">final</span><span style="color:#24292e"> </span><span style="color:#d73a49">class</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Worker</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">extends</span><span style="color:#24292e"> </span><span style="color:#6f42c1">AbstractQueuedSynchronizer</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">implements</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Runnable</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">    ...</span></span>
<span class="line"><span style="color:#24292e">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6a737d">// ÈòªÂ°ûÈòüÂàóÔºåÁî®‰∫éÂ≠òÊîæÊù•‰∏çÂèäË¢´Ê†∏ÂøÉÁ∫øÁ®ãÊâßË°åÁöÑ‰ªªÂä°</span></span>
<span class="line"><span style="color:#d73a49">private</span><span style="color:#24292e"> </span><span style="color:#d73a49">final</span><span style="color:#24292e"> BlockingQueue&lt;</span><span style="color:#d73a49">Runnable</span><span style="color:#24292e">&gt; workQueue;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6a737d">// ÈîÅ</span></span>
<span class="line"><span style="color:#d73a49">private</span><span style="color:#24292e"> </span><span style="color:#d73a49">final</span><span style="color:#24292e"> ReentrantLock mainLock </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">ReentrantLock</span><span style="color:#24292e">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6a737d">//  Áî®‰∫éÂ≠òÊîæÊ†∏ÂøÉÁ∫øÁ®ãÁöÑÂÆπÂô®ÔºåÂè™ÊúâÂΩìÊåÅÊúâÈîÅÊó∂ÊâçËÉΩÂ§üËé∑ÂèñÂÖ∂‰∏≠ÁöÑÂÖÉÁ¥†ÔºàÊ†∏ÂøÉÁ∫øÁ®ãÔºâ</span></span>
<span class="line"><span style="color:#d73a49">private</span><span style="color:#24292e"> </span><span style="color:#d73a49">final</span><span style="color:#24292e"> HashSet&lt;</span><span style="color:#d73a49">Worker</span><span style="color:#24292e">&gt; workers </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> HashSet&lt;</span><span style="color:#d73a49">Worker</span><span style="color:#24292e">&gt;();</span></span></code></pre></div><h4 id="ÊûÑÈÄ†ÊñπÊ≥ïÊûÅÂÖ∂ÂèÇÊï∞" tabindex="-1">ÊûÑÈÄ†ÊñπÊ≥ïÊûÅÂÖ∂ÂèÇÊï∞ <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20advanced%20chapter#ÊûÑÈÄ†ÊñπÊ≥ïÊûÅÂÖ∂ÂèÇÊï∞" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h4><p><strong>ThreadPoolExecutorÊúÄÂÖ®Èù¢ÁöÑÊûÑÈÄ†ÊñπÊ≥ï</strong></p><p>‰πüÊòØÊûÑÈÄ†Ëá™ÂÆö‰πâÁ∫øÁ®ãÊ±†ÁöÑÊñπÊ≥ï</p><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">ThreadPoolExecutor</span><span style="color:#e1e4e8">(</span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> corePoolSize,</span></span>
<span class="line"><span style="color:#e1e4e8">                          </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> maximumPoolSize,</span></span>
<span class="line"><span style="color:#e1e4e8">                          </span><span style="color:#f97583">long</span><span style="color:#e1e4e8"> keepAliveTime,</span></span>
<span class="line"><span style="color:#e1e4e8">                          TimeUnit unit,</span></span>
<span class="line"><span style="color:#e1e4e8">                          BlockingQueue</span><span style="color:#f97583">&lt;</span><span style="color:#e1e4e8">Runnable</span><span style="color:#f97583">&gt;</span><span style="color:#e1e4e8"> workQueue,</span></span>
<span class="line"><span style="color:#e1e4e8">                          ThreadFactory threadFactory,</span></span>
<span class="line"><span style="color:#e1e4e8">                          RejectedExecutionHandler handler)</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#6f42c1">ThreadPoolExecutor</span><span style="color:#24292e">(</span><span style="color:#d73a49">int</span><span style="color:#24292e"> corePoolSize,</span></span>
<span class="line"><span style="color:#24292e">                          </span><span style="color:#d73a49">int</span><span style="color:#24292e"> maximumPoolSize,</span></span>
<span class="line"><span style="color:#24292e">                          </span><span style="color:#d73a49">long</span><span style="color:#24292e"> keepAliveTime,</span></span>
<span class="line"><span style="color:#24292e">                          TimeUnit unit,</span></span>
<span class="line"><span style="color:#24292e">                          BlockingQueue</span><span style="color:#d73a49">&lt;</span><span style="color:#24292e">Runnable</span><span style="color:#d73a49">&gt;</span><span style="color:#24292e"> workQueue,</span></span>
<span class="line"><span style="color:#24292e">                          ThreadFactory threadFactory,</span></span>
<span class="line"><span style="color:#24292e">                          RejectedExecutionHandler handler)</span></span></code></pre></div><h4 id="ÂèÇÊï∞Ëß£Èáä" tabindex="-1"><strong>ÂèÇÊï∞Ëß£Èáä</strong> <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20advanced%20chapter#ÂèÇÊï∞Ëß£Èáä" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h4><ul><li>corePoolSizeÔºöÊ†∏ÂøÉÁ∫øÁ®ãÊï∞</li><li>maximumPoolSizeÔºöÊúÄÂ§ßÁ∫øÁ®ãÊï∞<ul><li>maximumPoolSize - corePoolSize = ÊïëÊÄ•Á∫øÁ®ãÊï∞</li></ul></li><li>keepAliveTimeÔºöÊïëÊÄ•Á∫øÁ®ãÁ©∫Èó≤Êó∂ÁöÑÊúÄÂ§ßÁîüÂ≠òÊó∂Èó¥</li><li>unitÔºöÊó∂Èó¥Âçï‰Ωç</li><li>workQueueÔºöÈòªÂ°ûÈòüÂàóÔºàÂ≠òÊîæ‰ªªÂä°Ôºâ<ul><li>ÊúâÁïåÈòªÂ°ûÈòüÂàó ArrayBlockingQueue</li><li>Êó†ÁïåÈòªÂ°ûÈòüÂàó LinkedBlockingQueue</li><li>ÊúÄÂ§öÂè™Êúâ‰∏Ä‰∏™ÂêåÊ≠•ÂÖÉÁ¥†ÁöÑ SynchronousQueue</li><li>‰ºòÂÖàÈòüÂàó PriorityBlockingQueue</li></ul></li><li>threadFactoryÔºöÁ∫øÁ®ãÂ∑•ÂéÇÔºàÁªôÁ∫øÁ®ãÂèñÂêçÂ≠óÔºâ</li><li>handlerÔºöÊãíÁªùÁ≠ñÁï•</li></ul><h4 id="Â∑•‰ΩúÊñπÂºè" tabindex="-1">Â∑•‰ΩúÊñπÂºè <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20advanced%20chapter#Â∑•‰ΩúÊñπÂºè" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h4><figure><img src="https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230718205840140.png" alt="image-20230718205840140" loading="lazy" decoding="async"></figure><ul><li>ÂΩì‰∏Ä‰∏™‰ªªÂä°‰º†ÁªôÁ∫øÁ®ãÊ±†‰ª•ÂêéÔºåÂèØËÉΩÊúâ‰ª•‰∏ãÂá†ÁßçÂèØËÉΩ<ul><li>Â∞Ü‰ªªÂä°ÂàÜÈÖçÁªô‰∏Ä‰∏™Ê†∏ÂøÉÁ∫øÁ®ãÊù•ÊâßË°å</li><li>Ê†∏ÂøÉÁ∫øÁ®ãÈÉΩÂú®ÊâßË°å‰ªªÂä°ÔºåÂ∞Ü‰ªªÂä°ÊîæÂà∞ÈòªÂ°ûÈòüÂàóworkQueue‰∏≠Á≠âÂæÖË¢´ÊâßË°å</li><li>ÈòªÂ°ûÈòüÂàóÊª°‰∫ÜÔºå‰ΩøÁî®ÊïëÊÄ•Á∫øÁ®ãÊù•ÊâßË°å‰ªªÂä°<ul><li>ÊïëÊÄ•Á∫øÁ®ãÁî®ÂÆå‰ª•ÂêéÔºåË∂ÖËøáÁîüÂ≠òÊó∂Èó¥ÔºàkeepAliveTimeÔºâÂêé‰ºöË¢´ÈáäÊîæ</li></ul></li><li>‰ªªÂä°ÊÄªÊï∞Â§ß‰∫é‰∫Ü ÊúÄÂ§ßÁ∫øÁ®ãÊï∞ÔºàmaximumPoolSizeÔºâ‰∏éÈòªÂ°ûÈòüÂàóÂÆπÈáèÁöÑÊúÄÂ§ßÂÄºÔºàworkQueue.capacityÔºâÔºå‰ΩøÁî®ÊãíÊé•Á≠ñÁï•</li></ul></li></ul><blockquote><ul><li><p>Á∫øÁ®ãÊ±†‰∏≠ÂàöÂºÄÂßãÊ≤°ÊúâÁ∫øÁ®ãÔºåÂΩì‰∏Ä‰∏™‰ªªÂä°Êèê‰∫§ÁªôÁ∫øÁ®ãÊ±†ÂêéÔºåÁ∫øÁ®ãÊ±†‰ºöÂàõÂª∫‰∏Ä‰∏™Êñ∞Á∫øÁ®ãÊù•ÊâßË°å‰ªªÂä°„ÄÇ</p></li><li><p>ÂΩìÁ∫øÁ®ãÊï∞ËææÂà∞ corePoolSize Âπ∂Ê≤°ÊúâÁ∫øÁ®ãÁ©∫Èó≤ÔºåËøôÊó∂ÂÜçÂä†ÂÖ•‰ªªÂä°ÔºåÊñ∞Âä†ÁöÑ‰ªªÂä°‰ºöË¢´Âä†ÂÖ•workQueue ÈòüÂàóÊéí</p><p>ÈòüÔºåÁõ¥Âà∞ÊúâÁ©∫Èó≤ÁöÑÁ∫øÁ®ã„ÄÇ</p></li><li><p>Â¶ÇÊûúÈòüÂàóÈÄâÊã©‰∫ÜÊúâÁïåÈòüÂàóÔºåÈÇ£‰πà‰ªªÂä°Ë∂ÖËøá‰∫ÜÈòüÂàóÂ§ßÂ∞èÊó∂Ôºå‰ºöÂàõÂª∫ maximumPoolSize - corePoolSize Êï∞ÁõÆÁöÑÁ∫øÁ®ãÊù•ÊïëÊÄ•„ÄÇ(<strong>ÊïëÊÄ•Á∫øÁ®ãÁöÑÂâçÊèêÊòØÈÖçÂêàÊúâÁïåÈòüÂàóÊù•‰ΩøÁî®</strong>)</p></li><li><p>Â¶ÇÊûúÁ∫øÁ®ãÂà∞Ëææ maximumPoolSize ‰ªçÁÑ∂ÊúâÊñ∞‰ªªÂä°ËøôÊó∂‰ºöÊâßË°åÊãíÁªùÁ≠ñÁï•„ÄÇÊãíÁªùÁ≠ñÁï• jdk Êèê‰æõ‰∫Ü 4 ÁßçÂÆûÁé∞ÔºåÂÖ∂ÂÆÉËëóÂêçÊ°ÜÊû∂‰πüÊèê‰æõ‰∫ÜÂÆûÁé∞</p><ul><li>AbortPolicy ËÆ©Ë∞ÉÁî®ËÄÖÊäõÂá∫ RejectedExecutionException ÂºÇÂ∏∏ÔºåËøôÊòØÈªòËÆ§Á≠ñÁï•</li><li>CallerRunsPolicy ËÆ©Ë∞ÉÁî®ËÄÖËøêË°å‰ªªÂä°</li><li>DiscardPolicy ÊîæÂºÉÊú¨Ê¨°‰ªªÂä°</li><li>DiscardOldestPolicy ÊîæÂºÉÈòüÂàó‰∏≠ÊúÄÊó©ÁöÑ‰ªªÂä°ÔºåÊú¨‰ªªÂä°ÂèñËÄå‰ª£‰πãDubbo ÁöÑÂÆûÁé∞ÔºåÂú®ÊäõÂá∫ RejectedExecutionException ÂºÇÂ∏∏‰πãÂâç‰ºöËÆ∞ÂΩïÊó•ÂøóÔºåÂπ∂ dump Á∫øÁ®ãÊ†à‰ø°ÊÅØÔºåÊñπ‰æøÂÆö‰ΩçÈóÆÈ¢ò</li><li>Netty ÁöÑÂÆûÁé∞ÔºåÊòØÂàõÂª∫‰∏Ä‰∏™Êñ∞Á∫øÁ®ãÊù•ÊâßË°å‰ªªÂä°</li><li>ActiveMQ ÁöÑÂÆûÁé∞ÔºåÂ∏¶Ë∂ÖÊó∂Á≠âÂæÖÔºà60sÔºâÂ∞ùËØïÊîæÂÖ•ÈòüÂàóÔºåÁ±ª‰ººÊàë‰ª¨‰πãÂâçËá™ÂÆö‰πâÁöÑÊãíÁªùÁ≠ñÁï•</li><li>PinPoint ÁöÑÂÆûÁé∞ÔºåÂÆÉ‰ΩøÁî®‰∫Ü‰∏Ä‰∏™ÊãíÁªùÁ≠ñÁï•ÈìæÔºå‰ºöÈÄê‰∏ÄÂ∞ùËØïÁ≠ñÁï•Èìæ‰∏≠ÊØèÁßçÊãíÁªùÁ≠ñÁï•</li></ul></li><li><p>ÂΩìÈ´òÂ≥∞ËøáÂéªÂêéÔºåË∂ÖËøácorePoolSize ÁöÑÊïëÊÄ•Á∫øÁ®ãÂ¶ÇÊûú‰∏ÄÊÆµÊó∂Èó¥Ê≤°Êúâ‰ªªÂä°ÂÅöÔºåÈúÄË¶ÅÁªìÊùüËäÇÁúÅËµÑÊ∫êÔºåËøô‰∏™Êó∂Èó¥Áî±keepAliveTime Âíå unit Êù•ÊéßÂà∂„ÄÇ</p></li></ul></blockquote><h4 id="ÊãíÁªùÁ≠ñÁï•" tabindex="-1">ÊãíÁªùÁ≠ñÁï• <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20advanced%20chapter#ÊãíÁªùÁ≠ñÁï•" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h4><p>Â¶ÇÊûúÁ∫øÁ®ãÂà∞Ëææ maximumPoolSize ‰ªçÁÑ∂ÊúâÊñ∞‰ªªÂä°ËøôÊó∂‰ºöÊâßË°å<strong>ÊãíÁªùÁ≠ñÁï•</strong>„ÄÇÊãíÁªùÁ≠ñÁï• jdk Êèê‰æõ‰∫Ü 4 ÁßçÂÆûÁé∞</p><figure><img src="https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/20201022194718.png" alt="img" loading="lazy" decoding="async"></figure><ul><li>AbortPolicyÔºöËÆ©Ë∞ÉÁî®ËÄÖÊäõÂá∫ RejectedExecutionException ÂºÇÂ∏∏Ôºå<strong>ËøôÊòØÈªòËÆ§Á≠ñÁï•</strong></li><li>CallerRunsPolicyÔºöËÆ©Ë∞ÉÁî®ËÄÖËøêË°å‰ªªÂä°</li><li>DiscardPolicyÔºöÊîæÂºÉÊú¨Ê¨°‰ªªÂä°</li><li>DiscardOldestPolicyÔºöÊîæÂºÉÈòüÂàó‰∏≠ÊúÄÊó©ÁöÑ‰ªªÂä°ÔºåÊú¨‰ªªÂä°ÂèñËÄå‰ª£‰πã</li></ul><h4 id="‰ΩøÁî®" tabindex="-1">‰ΩøÁî® <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20advanced%20chapter#‰ΩøÁî®" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h4><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">class</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Demo1</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">   </span><span style="color:#f97583">static</span><span style="color:#e1e4e8"> AtomicInteger threadId </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">AtomicInteger</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">   </span><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">static</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">void</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">main</span><span style="color:#e1e4e8">(</span><span style="color:#f97583">String</span><span style="color:#e1e4e8">[] </span><span style="color:#ffab70">args</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">      </span><span style="color:#6a737d">// ÊâãÂä®ÂàõÂª∫Á∫øÁ®ãÊ±†</span></span>
<span class="line"><span style="color:#e1e4e8">      </span><span style="color:#6a737d">// ÂàõÂª∫ÊúâÁïåÈòªÂ°ûÈòüÂàó</span></span>
<span class="line"><span style="color:#e1e4e8">      ArrayBlockingQueue&lt;</span><span style="color:#f97583">Runnable</span><span style="color:#e1e4e8">&gt; runnable </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> ArrayBlockingQueue&lt;</span><span style="color:#f97583">Runnable</span><span style="color:#e1e4e8">&gt;(</span><span style="color:#79b8ff">10</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">      </span><span style="color:#6a737d">// ÂàõÂª∫Á∫øÁ®ãÂ∑•ÂéÇ</span></span>
<span class="line"><span style="color:#e1e4e8">      ThreadFactory threadFactory </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">ThreadFactory</span><span style="color:#e1e4e8">() {</span></span>
<span class="line"><span style="color:#e1e4e8">         @</span><span style="color:#f97583">Override</span></span>
<span class="line"><span style="color:#e1e4e8">         </span><span style="color:#f97583">public</span><span style="color:#e1e4e8"> Thread </span><span style="color:#b392f0">newThread</span><span style="color:#e1e4e8">(Runnable </span><span style="color:#ffab70">r</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">            Thread thread </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Thread</span><span style="color:#e1e4e8">(r, </span><span style="color:#9ecbff">"working_thread_"</span><span style="color:#f97583">+</span><span style="color:#e1e4e8">threadId.</span><span style="color:#b392f0">getAndIncrement</span><span style="color:#e1e4e8">());</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> thread;</span></span>
<span class="line"><span style="color:#e1e4e8">         }</span></span>
<span class="line"><span style="color:#e1e4e8">      };</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">      </span><span style="color:#6a737d">// ÊâãÂä®ÂàõÂª∫Á∫øÁ®ãÊ±†</span></span>
<span class="line"><span style="color:#e1e4e8">      </span><span style="color:#6a737d">// ÊãíÁªùÁ≠ñÁï•ÈááÁî®ÈªòËÆ§Á≠ñÁï•</span></span>
<span class="line"><span style="color:#e1e4e8">      ThreadPoolExecutor executor </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">ThreadPoolExecutor</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">5</span><span style="color:#e1e4e8">, </span><span style="color:#79b8ff">7</span><span style="color:#e1e4e8">, </span><span style="color:#79b8ff">10</span><span style="color:#e1e4e8">, TimeUnit.SECONDS, runnable, threadFactory);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">      </span><span style="color:#f97583">for</span><span style="color:#e1e4e8"> (</span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> i </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8">; i </span><span style="color:#f97583">&lt;</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">20</span><span style="color:#e1e4e8">; i</span><span style="color:#f97583">++</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">         executor.</span><span style="color:#b392f0">execute</span><span style="color:#e1e4e8">(</span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Runnable</span><span style="color:#e1e4e8">() {</span></span>
<span class="line"><span style="color:#e1e4e8">            @</span><span style="color:#f97583">Override</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">void</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">run</span><span style="color:#e1e4e8">() {</span></span>
<span class="line"><span style="color:#e1e4e8">               System.out.</span><span style="color:#b392f0">println</span><span style="color:#e1e4e8">(Thread.</span><span style="color:#b392f0">currentThread</span><span style="color:#e1e4e8">());</span></span>
<span class="line"><span style="color:#e1e4e8">               </span><span style="color:#f97583">try</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">                  Thread.</span><span style="color:#b392f0">sleep</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">100000</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">               } </span><span style="color:#f97583">catch</span><span style="color:#e1e4e8"> (InterruptedException </span><span style="color:#ffab70">e</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">                  e.</span><span style="color:#b392f0">printStackTrace</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">               }</span></span>
<span class="line"><span style="color:#e1e4e8">            }</span></span>
<span class="line"><span style="color:#e1e4e8">         });</span></span>
<span class="line"><span style="color:#e1e4e8">      }</span></span>
<span class="line"><span style="color:#e1e4e8">   }</span></span>
<span class="line"><span style="color:#e1e4e8">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">class</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Demo1</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">   </span><span style="color:#d73a49">static</span><span style="color:#24292e"> AtomicInteger threadId </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">AtomicInteger</span><span style="color:#24292e">(</span><span style="color:#005cc5">0</span><span style="color:#24292e">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">   </span><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">static</span><span style="color:#24292e"> </span><span style="color:#d73a49">void</span><span style="color:#24292e"> </span><span style="color:#6f42c1">main</span><span style="color:#24292e">(</span><span style="color:#d73a49">String</span><span style="color:#24292e">[] </span><span style="color:#e36209">args</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">      </span><span style="color:#6a737d">// ÊâãÂä®ÂàõÂª∫Á∫øÁ®ãÊ±†</span></span>
<span class="line"><span style="color:#24292e">      </span><span style="color:#6a737d">// ÂàõÂª∫ÊúâÁïåÈòªÂ°ûÈòüÂàó</span></span>
<span class="line"><span style="color:#24292e">      ArrayBlockingQueue&lt;</span><span style="color:#d73a49">Runnable</span><span style="color:#24292e">&gt; runnable </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> ArrayBlockingQueue&lt;</span><span style="color:#d73a49">Runnable</span><span style="color:#24292e">&gt;(</span><span style="color:#005cc5">10</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">      </span><span style="color:#6a737d">// ÂàõÂª∫Á∫øÁ®ãÂ∑•ÂéÇ</span></span>
<span class="line"><span style="color:#24292e">      ThreadFactory threadFactory </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">ThreadFactory</span><span style="color:#24292e">() {</span></span>
<span class="line"><span style="color:#24292e">         @</span><span style="color:#d73a49">Override</span></span>
<span class="line"><span style="color:#24292e">         </span><span style="color:#d73a49">public</span><span style="color:#24292e"> Thread </span><span style="color:#6f42c1">newThread</span><span style="color:#24292e">(Runnable </span><span style="color:#e36209">r</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">            Thread thread </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Thread</span><span style="color:#24292e">(r, </span><span style="color:#032f62">"working_thread_"</span><span style="color:#d73a49">+</span><span style="color:#24292e">threadId.</span><span style="color:#6f42c1">getAndIncrement</span><span style="color:#24292e">());</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">return</span><span style="color:#24292e"> thread;</span></span>
<span class="line"><span style="color:#24292e">         }</span></span>
<span class="line"><span style="color:#24292e">      };</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">      </span><span style="color:#6a737d">// ÊâãÂä®ÂàõÂª∫Á∫øÁ®ãÊ±†</span></span>
<span class="line"><span style="color:#24292e">      </span><span style="color:#6a737d">// ÊãíÁªùÁ≠ñÁï•ÈááÁî®ÈªòËÆ§Á≠ñÁï•</span></span>
<span class="line"><span style="color:#24292e">      ThreadPoolExecutor executor </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">ThreadPoolExecutor</span><span style="color:#24292e">(</span><span style="color:#005cc5">5</span><span style="color:#24292e">, </span><span style="color:#005cc5">7</span><span style="color:#24292e">, </span><span style="color:#005cc5">10</span><span style="color:#24292e">, TimeUnit.SECONDS, runnable, threadFactory);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">      </span><span style="color:#d73a49">for</span><span style="color:#24292e"> (</span><span style="color:#d73a49">int</span><span style="color:#24292e"> i </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#005cc5">0</span><span style="color:#24292e">; i </span><span style="color:#d73a49">&lt;</span><span style="color:#24292e"> </span><span style="color:#005cc5">20</span><span style="color:#24292e">; i</span><span style="color:#d73a49">++</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">         executor.</span><span style="color:#6f42c1">execute</span><span style="color:#24292e">(</span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Runnable</span><span style="color:#24292e">() {</span></span>
<span class="line"><span style="color:#24292e">            @</span><span style="color:#d73a49">Override</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">void</span><span style="color:#24292e"> </span><span style="color:#6f42c1">run</span><span style="color:#24292e">() {</span></span>
<span class="line"><span style="color:#24292e">               System.out.</span><span style="color:#6f42c1">println</span><span style="color:#24292e">(Thread.</span><span style="color:#6f42c1">currentThread</span><span style="color:#24292e">());</span></span>
<span class="line"><span style="color:#24292e">               </span><span style="color:#d73a49">try</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">                  Thread.</span><span style="color:#6f42c1">sleep</span><span style="color:#24292e">(</span><span style="color:#005cc5">100000</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">               } </span><span style="color:#d73a49">catch</span><span style="color:#24292e"> (InterruptedException </span><span style="color:#e36209">e</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">                  e.</span><span style="color:#6f42c1">printStackTrace</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">               }</span></span>
<span class="line"><span style="color:#24292e">            }</span></span>
<span class="line"><span style="color:#24292e">         });</span></span>
<span class="line"><span style="color:#24292e">      }</span></span>
<span class="line"><span style="color:#24292e">   }</span></span>
<span class="line"><span style="color:#24292e">}</span></span></code></pre></div><h4 id="fixedthreadpool" tabindex="-1">FixedThreadPool <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20advanced%20chapter#fixedthreadpool" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h4><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">class</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">TestFixedThreadPool</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">   </span><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">static</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">void</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">main</span><span style="color:#e1e4e8">(</span><span style="color:#f97583">String</span><span style="color:#e1e4e8">[] </span><span style="color:#ffab70">args</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">      </span><span style="color:#6a737d">// Ëá™ÂÆö‰πâÁ∫øÁ®ãÂ∑•ÂéÇ</span></span>
<span class="line"><span style="color:#e1e4e8">      ThreadFactory factory </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">ThreadFactory</span><span style="color:#e1e4e8">() {</span></span>
<span class="line"><span style="color:#e1e4e8">         AtomicInteger atomicInteger </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">AtomicInteger</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">1</span><span style="color:#e1e4e8">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">         @</span><span style="color:#f97583">Override</span></span>
<span class="line"><span style="color:#e1e4e8">         </span><span style="color:#f97583">public</span><span style="color:#e1e4e8"> Thread </span><span style="color:#b392f0">newThread</span><span style="color:#e1e4e8">(Runnable </span><span style="color:#ffab70">r</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Thread</span><span style="color:#e1e4e8">(r, </span><span style="color:#9ecbff">"myThread_"</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">+</span><span style="color:#e1e4e8"> atomicInteger.</span><span style="color:#b392f0">getAndIncrement</span><span style="color:#e1e4e8">());</span></span>
<span class="line"><span style="color:#e1e4e8">         }</span></span>
<span class="line"><span style="color:#e1e4e8">      };</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">      </span><span style="color:#6a737d">// ÂàõÂª∫Ê†∏ÂøÉÁ∫øÁ®ãÊï∞Èáè‰∏∫2ÁöÑÁ∫øÁ®ãÊ±†</span></span>
<span class="line"><span style="color:#e1e4e8">      </span><span style="color:#6a737d">// ÈÄöËøá ThreadFactoryÂèØ‰ª•ÁªôÁ∫øÁ®ãÊ∑ªÂä†ÂêçÂ≠ó</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">      ExecutorService executorService </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> Executors.</span><span style="color:#b392f0">newFixedThreadPool</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">2</span><span style="color:#e1e4e8">, factory);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">      </span><span style="color:#6a737d">// ‰ªªÂä°</span></span>
<span class="line"><span style="color:#e1e4e8">      Runnable runnable </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Runnable</span><span style="color:#e1e4e8">() {</span></span>
<span class="line"><span style="color:#e1e4e8">         @</span><span style="color:#f97583">Override</span></span>
<span class="line"><span style="color:#e1e4e8">         </span><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">void</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">run</span><span style="color:#e1e4e8">() {</span></span>
<span class="line"><span style="color:#e1e4e8">            System.out.</span><span style="color:#b392f0">println</span><span style="color:#e1e4e8">(Thread.</span><span style="color:#b392f0">currentThread</span><span style="color:#e1e4e8">().</span><span style="color:#b392f0">getName</span><span style="color:#e1e4e8">());</span></span>
<span class="line"><span style="color:#e1e4e8">            System.out.</span><span style="color:#b392f0">println</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"this is fixedThreadPool"</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">         }</span></span>
<span class="line"><span style="color:#e1e4e8">      };</span></span>
<span class="line"><span style="color:#e1e4e8">      </span></span>
<span class="line"><span style="color:#e1e4e8">      executorService.</span><span style="color:#b392f0">execute</span><span style="color:#e1e4e8">(runnable);</span></span>
<span class="line"><span style="color:#e1e4e8">   }</span></span>
<span class="line"><span style="color:#e1e4e8">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">class</span><span style="color:#24292e"> </span><span style="color:#6f42c1">TestFixedThreadPool</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">   </span><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">static</span><span style="color:#24292e"> </span><span style="color:#d73a49">void</span><span style="color:#24292e"> </span><span style="color:#6f42c1">main</span><span style="color:#24292e">(</span><span style="color:#d73a49">String</span><span style="color:#24292e">[] </span><span style="color:#e36209">args</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">      </span><span style="color:#6a737d">// Ëá™ÂÆö‰πâÁ∫øÁ®ãÂ∑•ÂéÇ</span></span>
<span class="line"><span style="color:#24292e">      ThreadFactory factory </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">ThreadFactory</span><span style="color:#24292e">() {</span></span>
<span class="line"><span style="color:#24292e">         AtomicInteger atomicInteger </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">AtomicInteger</span><span style="color:#24292e">(</span><span style="color:#005cc5">1</span><span style="color:#24292e">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">         @</span><span style="color:#d73a49">Override</span></span>
<span class="line"><span style="color:#24292e">         </span><span style="color:#d73a49">public</span><span style="color:#24292e"> Thread </span><span style="color:#6f42c1">newThread</span><span style="color:#24292e">(Runnable </span><span style="color:#e36209">r</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">return</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Thread</span><span style="color:#24292e">(r, </span><span style="color:#032f62">"myThread_"</span><span style="color:#24292e"> </span><span style="color:#d73a49">+</span><span style="color:#24292e"> atomicInteger.</span><span style="color:#6f42c1">getAndIncrement</span><span style="color:#24292e">());</span></span>
<span class="line"><span style="color:#24292e">         }</span></span>
<span class="line"><span style="color:#24292e">      };</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">      </span><span style="color:#6a737d">// ÂàõÂª∫Ê†∏ÂøÉÁ∫øÁ®ãÊï∞Èáè‰∏∫2ÁöÑÁ∫øÁ®ãÊ±†</span></span>
<span class="line"><span style="color:#24292e">      </span><span style="color:#6a737d">// ÈÄöËøá ThreadFactoryÂèØ‰ª•ÁªôÁ∫øÁ®ãÊ∑ªÂä†ÂêçÂ≠ó</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">      ExecutorService executorService </span><span style="color:#d73a49">=</span><span style="color:#24292e"> Executors.</span><span style="color:#6f42c1">newFixedThreadPool</span><span style="color:#24292e">(</span><span style="color:#005cc5">2</span><span style="color:#24292e">, factory);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">      </span><span style="color:#6a737d">// ‰ªªÂä°</span></span>
<span class="line"><span style="color:#24292e">      Runnable runnable </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Runnable</span><span style="color:#24292e">() {</span></span>
<span class="line"><span style="color:#24292e">         @</span><span style="color:#d73a49">Override</span></span>
<span class="line"><span style="color:#24292e">         </span><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">void</span><span style="color:#24292e"> </span><span style="color:#6f42c1">run</span><span style="color:#24292e">() {</span></span>
<span class="line"><span style="color:#24292e">            System.out.</span><span style="color:#6f42c1">println</span><span style="color:#24292e">(Thread.</span><span style="color:#6f42c1">currentThread</span><span style="color:#24292e">().</span><span style="color:#6f42c1">getName</span><span style="color:#24292e">());</span></span>
<span class="line"><span style="color:#24292e">            System.out.</span><span style="color:#6f42c1">println</span><span style="color:#24292e">(</span><span style="color:#032f62">"this is fixedThreadPool"</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">         }</span></span>
<span class="line"><span style="color:#24292e">      };</span></span>
<span class="line"><span style="color:#24292e">      </span></span>
<span class="line"><span style="color:#24292e">      executorService.</span><span style="color:#6f42c1">execute</span><span style="color:#24292e">(runnable);</span></span>
<span class="line"><span style="color:#24292e">   }</span></span>
<span class="line"><span style="color:#24292e">}</span></span></code></pre></div><p>Âõ∫ÂÆöÂ§ßÂ∞èÁöÑÁ∫øÁ®ãÊ±†ÂèØ‰ª•‰º†ÂÖ•‰∏§‰∏™ÂèÇÊï∞</p><ul><li>Ê†∏ÂøÉÁ∫øÁ®ãÊï∞ÔºönThreads</li><li>Á∫øÁ®ãÂ∑•ÂéÇÔºöthreadFactory</li></ul><p>ÂÜÖÈÉ®Ë∞ÉÁî®ÁöÑÊûÑÈÄ†ÊñπÊ≥ï</p><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#b392f0">ThreadPoolExecutor</span><span style="color:#e1e4e8">(nThreads, nThreads,</span></span>
<span class="line"><span style="color:#e1e4e8">                              </span><span style="color:#79b8ff">0L</span><span style="color:#e1e4e8">, TimeUnit.MILLISECONDS,</span></span>
<span class="line"><span style="color:#e1e4e8">                              </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> LinkedBlockingQueue&lt;</span><span style="color:#f97583">Runnable</span><span style="color:#e1e4e8">&gt;(),</span></span>
<span class="line"><span style="color:#e1e4e8">                              threadFactory);</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6f42c1">ThreadPoolExecutor</span><span style="color:#24292e">(nThreads, nThreads,</span></span>
<span class="line"><span style="color:#24292e">                              </span><span style="color:#005cc5">0L</span><span style="color:#24292e">, TimeUnit.MILLISECONDS,</span></span>
<span class="line"><span style="color:#24292e">                              </span><span style="color:#d73a49">new</span><span style="color:#24292e"> LinkedBlockingQueue&lt;</span><span style="color:#d73a49">Runnable</span><span style="color:#24292e">&gt;(),</span></span>
<span class="line"><span style="color:#24292e">                              threadFactory);</span></span></code></pre></div><p>ÁâπÁÇπ</p><ul><li>Ê†∏ÂøÉÁ∫øÁ®ãÊï∞ == ÊúÄÂ§ßÁ∫øÁ®ãÊï∞ÔºàÊ≤°ÊúâÊïëÊÄ•Á∫øÁ®ãË¢´ÂàõÂª∫ÔºâÔºåÂõ†Ê≠§‰πüÊó†ÈúÄË∂ÖÊó∂Êó∂Èó¥</li><li>ÈòªÂ°ûÈòüÂàóÊòØÊó†ÁïåÁöÑÔºåÂèØ‰ª•Êîæ‰ªªÊÑèÊï∞ÈáèÁöÑ‰ªªÂä°</li></ul><blockquote><p><strong>ËØÑ‰ª∑</strong> ÈÄÇÁî®‰∫é‰ªªÂä°ÈáèÂ∑≤Áü•ÔºåÁõ∏ÂØπËÄóÊó∂ÁöÑ‰ªªÂä°</p></blockquote><h4 id="cachedthreadpool" tabindex="-1">CachedThreadPool <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20advanced%20chapter#cachedthreadpool" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h4><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8">ExecutorService executorService = Executors.newCachedThreadPool();</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e">ExecutorService executorService = Executors.newCachedThreadPool();</span></span></code></pre></div><p><strong>ÂÜÖÈÉ®ÊûÑÈÄ†ÊñπÊ≥ï</strong></p><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8">ThreadPoolExecutor(0, Integer.MAX_VALUE,</span></span>
<span class="line"><span style="color:#e1e4e8">                              60L, TimeUnit.SECONDS,</span></span>
<span class="line"><span style="color:#e1e4e8">                              new SynchronousQueue&lt;Runnable&gt;());</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e">ThreadPoolExecutor(0, Integer.MAX_VALUE,</span></span>
<span class="line"><span style="color:#24292e">                              60L, TimeUnit.SECONDS,</span></span>
<span class="line"><span style="color:#24292e">                              new SynchronousQueue&lt;Runnable&gt;());</span></span></code></pre></div><ul><li><p>Ê≤°ÊúâÊ†∏ÂøÉÁ∫øÁ®ãÔºåÊúÄÂ§ßÁ∫øÁ®ãÊï∞‰∏∫Integer.MAX_VALUEÔºå<strong>ÊâÄÊúâÂàõÂª∫ÁöÑÁ∫øÁ®ãÈÉΩÊòØÊïëÊÄ•Á∫øÁ®ã</strong>ÔºåÁ©∫Èó≤Êó∂ÁîüÂ≠òÊó∂Èó¥‰∏∫60Áßí</p><ul><li><p>ÂÖ®ÈÉ®ÈÉΩÊòØÊïëÊÄ•Á∫øÁ®ãÔºà60s ÂêéÂèØ‰ª•ÂõûÊî∂Ôºâ</p></li><li><p>ÊïëÊÄ•Á∫øÁ®ãÂèØ‰ª•Êó†ÈôêÂàõÂª∫</p></li></ul></li><li><p>ÈòªÂ°ûÈòüÂàó‰ΩøÁî®ÁöÑÊòØSynchronousQueue</p><ul><li><p>SynchronousQueueÊòØ‰∏ÄÁßçÁâπÊÆäÁöÑÈòüÂàó</p><ul><li><strong>Ê≤°ÊúâÂÆπÈáè</strong>ÔºåÊ≤°ÊúâÁ∫øÁ®ãÊù•ÂèñÊòØÊîæ‰∏çËøõÂéªÁöÑ</li></ul></li><li><p>Âè™ÊúâÂΩìÁ∫øÁ®ãÂèñ‰ªªÂä°Êó∂ÔºåÊâç‰ºöÂ∞Ü‰ªªÂä°ÊîæÂÖ•ËØ•ÈòªÂ°ûÈòüÂàó‰∏≠</p></li></ul></li></ul><blockquote><p><strong>ËØÑ‰ª∑</strong> Êï¥‰∏™Á∫øÁ®ãÊ±†Ë°®Áé∞‰∏∫Á∫øÁ®ãÊï∞‰ºöÊ†πÊçÆ‰ªªÂä°Èáè‰∏çÊñ≠Â¢ûÈïøÔºåÊ≤°Êúâ‰∏äÈôêÔºåÂΩì‰ªªÂä°ÊâßË°åÂÆåÊØïÔºåÁ©∫Èó≤ 1ÂàÜÈíüÂêéÈáäÊîæÁ∫ø Á®ã„ÄÇ ÈÄÇÂêà‰ªªÂä°Êï∞ÊØîËæÉÂØÜÈõÜÔºå‰ΩÜÊØè‰∏™‰ªªÂä°ÊâßË°åÊó∂Èó¥ËæÉÁü≠ÁöÑÊÉÖÂÜµ</p></blockquote><h4 id="singlethread" tabindex="-1">SingleThread <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20advanced%20chapter#singlethread" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h4><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8">ExecutorService service </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> Executors.</span><span style="color:#b392f0">newSingleThreadExecutor</span><span style="color:#e1e4e8">();</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e">ExecutorService service </span><span style="color:#d73a49">=</span><span style="color:#24292e"> Executors.</span><span style="color:#6f42c1">newSingleThreadExecutor</span><span style="color:#24292e">();</span></span></code></pre></div><p><strong>ÂÜÖÈÉ®ÊûÑÈÄ†ÊñπÊ≥ï</strong></p><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#f97583">new</span><span style="color:#e1e4e8"> FinalizableDelegatedExecutorService</span></span>
<span class="line"><span style="color:#e1e4e8">    (</span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">ThreadPoolExecutor</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">1</span><span style="color:#e1e4e8">, </span><span style="color:#79b8ff">1</span><span style="color:#e1e4e8">,</span></span>
<span class="line"><span style="color:#e1e4e8">                            </span><span style="color:#79b8ff">0L</span><span style="color:#e1e4e8">, TimeUnit.MILLISECONDS,</span></span>
<span class="line"><span style="color:#e1e4e8">                            </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> LinkedBlockingQueue&lt;</span><span style="color:#f97583">Runnable</span><span style="color:#e1e4e8">&gt;()));</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#d73a49">new</span><span style="color:#24292e"> FinalizableDelegatedExecutorService</span></span>
<span class="line"><span style="color:#24292e">    (</span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">ThreadPoolExecutor</span><span style="color:#24292e">(</span><span style="color:#005cc5">1</span><span style="color:#24292e">, </span><span style="color:#005cc5">1</span><span style="color:#24292e">,</span></span>
<span class="line"><span style="color:#24292e">                            </span><span style="color:#005cc5">0L</span><span style="color:#24292e">, TimeUnit.MILLISECONDS,</span></span>
<span class="line"><span style="color:#24292e">                            </span><span style="color:#d73a49">new</span><span style="color:#24292e"> LinkedBlockingQueue&lt;</span><span style="color:#d73a49">Runnable</span><span style="color:#24292e">&gt;()));</span></span></code></pre></div><p>‰ΩøÁî®Âú∫ÊôØÔºö</p><p>Â∏åÊúõÂ§ö‰∏™‰ªªÂä°ÊéíÈòüÊâßË°å„ÄÇÁ∫øÁ®ãÊï∞Âõ∫ÂÆö‰∏∫ 1Ôºå‰ªªÂä°Êï∞Â§ö‰∫é 1 Êó∂Ôºå‰ºöÊîæÂÖ•Êó†ÁïåÈòüÂàóÊéíÈòü„ÄÇ‰ªªÂä°ÊâßË°åÂÆåÊØïÔºåËøôÂîØ‰∏ÄÁöÑÁ∫øÁ®ã</p><p>‰πü‰∏ç‰ºöË¢´ÈáäÊîæ„ÄÇ</p><p>Âå∫Âà´Ôºö</p><ul><li><p>Ëá™Â∑±ÂàõÂª∫‰∏Ä‰∏™ÂçïÁ∫øÁ®ã‰∏≤Ë°åÊâßË°å‰ªªÂä°ÔºåÂ¶ÇÊûú‰ªªÂä°ÊâßË°åÂ§±Ë¥•ËÄåÁªàÊ≠¢ÈÇ£‰πàÊ≤°Êúâ‰ªª‰ΩïË°•ÊïëÊé™ÊñΩÔºåËÄåÁ∫øÁ®ãÊ±†Ëøò‰ºöÊñ∞Âª∫‰∏Ä</p><p>‰∏™Á∫øÁ®ãÔºå‰øùËØÅÊ±†ÁöÑÊ≠£Â∏∏Â∑•‰Ωú</p></li><li><p>Executors.newSingleThreadExecutor() Á∫øÁ®ã‰∏™Êï∞ÂßãÁªà‰∏∫1Ôºå‰∏çËÉΩ‰øÆÊîπ</p><ul><li>FinalizableDelegatedExecutorService Â∫îÁî®ÁöÑÊòØË£ÖÈ•∞Âô®Ê®°ÂºèÔºåÂè™ÂØπÂ§ñÊö¥Èú≤‰∫Ü ExecutorService Êé•Âè£ÔºåÂõ†Ê≠§‰∏çËÉΩË∞ÉÁî® ThreadPoolExecutor ‰∏≠ÁâπÊúâÁöÑÊñπÊ≥ï</li></ul></li><li><p>Executors.newFixedThreadPool(1) ÂàùÂßãÊó∂‰∏∫1Ôºå‰ª•ÂêéËøòÂèØ‰ª•‰øÆÊîπ</p><ul><li>ÂØπÂ§ñÊö¥Èú≤ÁöÑÊòØ ThreadPoolExecutor ÂØπË±°ÔºåÂèØ‰ª•Âº∫ËΩ¨ÂêéË∞ÉÁî® setCorePoolSize Á≠âÊñπÊ≥ïËøõË°å‰øÆÊîπ</li></ul></li></ul><h4 id="Âá†‰∏™Ê≥®ÊÑè" tabindex="-1">Âá†‰∏™Ê≥®ÊÑè <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20advanced%20chapter#Âá†‰∏™Ê≥®ÊÑè" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h4><ul><li><p>SingleThreadÂíåËá™Â∑±ÂàõÂª∫‰∏Ä‰∏™Á∫øÁ®ãÊù•ËøêË°åÂ§ö‰∏™‰ªªÂä°ÁöÑÂå∫Âà´</p><ul><li>ÂΩìÁ∫øÁ®ãÊ≠£Âú®ÊâßË°åÁöÑ‰ªªÂä°ÂèëÁîüÈîôËØØÊó∂ÔºåÂ¶ÇÊûúÊòØËá™Â∑±ÂàõÂª∫ÁöÑÁ∫øÁ®ãÔºåËØ•‰ªªÂä°ÂíåÂâ©‰ΩôÁöÑ‰ªªÂä°Â∞±Êó†Ê≥ïÂÜçÁªßÁª≠ËøêË°å‰∏ãÂéª„ÄÇËÄåSingleThread‰ºöÂàõÂª∫‰∏Ä‰∏™Êñ∞Á∫øÁ®ãÔºåÁªßÁª≠ÊâßË°å‰ªªÂä°ÈòüÂàó‰∏≠Ââ©‰ΩôÁöÑ‰ªªÂä°„ÄÇ</li></ul></li><li><p>SingleThreadÂíånewFixedThreadPool(1)ÁöÑÂå∫Âà´</p><ul><li>newFixedThreadPool(1)‰º†ÂÄº‰∏∫1ÔºåÂèØ‰ª•Â∞ÜFixedThreadPoolÂº∫ËΩ¨‰∏∫ThreadPoolExecutorÔºåÁÑ∂ÂêéÈÄöËøásetCorePoolSizeÊîπÂèòÊ†∏ÂøÉÁ∫øÁ®ãÊï∞</li></ul><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6a737d">// Âº∫ËΩ¨‰∏∫ThreadPoolExecutor</span></span>
<span class="line"><span style="color:#e1e4e8">ThreadPoolExecutor threadPool </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> (ThreadPoolExecutor) Executors.</span><span style="color:#b392f0">newFixedThreadPool</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">1</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#6a737d">// ÊîπÂèòÊ†∏ÂøÉÁ∫øÁ®ãÊï∞</span></span>
<span class="line"><span style="color:#e1e4e8">threadPool.</span><span style="color:#b392f0">setCorePoolSize</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">2</span><span style="color:#e1e4e8">);</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6a737d">// Âº∫ËΩ¨‰∏∫ThreadPoolExecutor</span></span>
<span class="line"><span style="color:#24292e">ThreadPoolExecutor threadPool </span><span style="color:#d73a49">=</span><span style="color:#24292e"> (ThreadPoolExecutor) Executors.</span><span style="color:#6f42c1">newFixedThreadPool</span><span style="color:#24292e">(</span><span style="color:#005cc5">1</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#6a737d">// ÊîπÂèòÊ†∏ÂøÉÁ∫øÁ®ãÊï∞</span></span>
<span class="line"><span style="color:#24292e">threadPool.</span><span style="color:#6f42c1">setCorePoolSize</span><span style="color:#24292e">(</span><span style="color:#005cc5">2</span><span style="color:#24292e">);</span></span></code></pre></div><ul><li>ËÄåSingleThreadÊó†Ê≥ï‰øÆÊîπÊ†∏ÂøÉÁ∫øÁ®ãÊï∞</li></ul></li></ul><h4 id="ÊâßË°å‰ªªÂä°" tabindex="-1">ÊâßË°å‰ªªÂä° <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20advanced%20chapter#ÊâßË°å‰ªªÂä°" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h4><h5 id="execute-ÊñπÊ≥ï" tabindex="-1">execute()ÊñπÊ≥ï <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20advanced%20chapter#execute-ÊñπÊ≥ï" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h5><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#b392f0">execute</span><span style="color:#e1e4e8">(Runnable command)</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6f42c1">execute</span><span style="color:#24292e">(Runnable command)</span></span></code></pre></div><p>‰º†ÂÖ•‰∏Ä‰∏™RunnableÂØπË±°ÔºåÊâßË°åÂÖ∂‰∏≠ÁöÑrunÊñπÊ≥ï</p><p><strong>Ê∫êÁ†ÅËß£Êûê</strong></p><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">void</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">execute</span><span style="color:#e1e4e8">(Runnable command) {</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (command </span><span style="color:#f97583">==</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8">)</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">throw</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">NullPointerException</span><span style="color:#e1e4e8">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">// Ëé∑Âèñctl</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> c </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> ctl.</span><span style="color:#b392f0">get</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">    </span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">// Âà§Êñ≠ÂΩìÂâçÂêØÁî®ÁöÑÁ∫øÁ®ãÊï∞ÊòØÂê¶Â∞è‰∫éÊ†∏ÂøÉÁ∫øÁ®ãÊï∞</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (</span><span style="color:#b392f0">workerCountOf</span><span style="color:#e1e4e8">(c) </span><span style="color:#f97583">&lt;</span><span style="color:#e1e4e8"> corePoolSize) {</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#6a737d">// ‰∏∫ËØ•‰ªªÂä°ÂàÜÈÖçÁ∫øÁ®ã</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (</span><span style="color:#b392f0">addWorker</span><span style="color:#e1e4e8">(command, </span><span style="color:#79b8ff">true</span><span style="color:#e1e4e8">))</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#6a737d">// ÂàÜÈÖçÊàêÂäüÂ∞±ËøîÂõû</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">return</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">        </span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#6a737d">// ÂàÜÈÖçÂ§±Ë¥•ÂÜçÊ¨°Ëé∑Âèñctl</span></span>
<span class="line"><span style="color:#e1e4e8">        c </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> ctl.</span><span style="color:#b392f0">get</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"><span style="color:#e1e4e8">    </span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">// ÂàÜÈÖçÂíå‰ø°ÊÅØÁ∫øÁ®ãÂ§±Ë¥•‰ª•Âêé</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">// Â¶ÇÊûúÊ±†Áä∂ÊÄÅ‰∏∫RUNNINGÂπ∂‰∏îÊèíÂÖ•Âà∞‰ªªÂä°ÈòüÂàóÊàêÂäü</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (</span><span style="color:#b392f0">isRunning</span><span style="color:#e1e4e8">(c) </span><span style="color:#f97583">&amp;&amp;</span><span style="color:#e1e4e8"> workQueue.</span><span style="color:#b392f0">offer</span><span style="color:#e1e4e8">(command)) {</span></span>
<span class="line"><span style="color:#e1e4e8">        </span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#6a737d">// ÂèåÈáçÊ£ÄÊµãÔºåÂèØËÉΩÂú®Ê∑ªÂä†ÂêéÁ∫øÁ®ãÊ±†Áä∂ÊÄÅÂèò‰∏∫‰∫ÜÈùûRUNNING</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> recheck </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> ctl.</span><span style="color:#b392f0">get</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">        </span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#6a737d">// Â¶ÇÊûúÊ±†Áä∂ÊÄÅ‰∏∫ÈùûRUNNINGÔºåÂàô‰∏ç‰ºöÊâßË°åÊñ∞Êù•ÁöÑ‰ªªÂä°</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#6a737d">// Â∞ÜËØ•‰ªªÂä°‰ªéÈòªÂ°ûÈòüÂàó‰∏≠ÁßªÈô§</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (</span><span style="color:#f97583">!</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">isRunning</span><span style="color:#e1e4e8">(recheck) </span><span style="color:#f97583">&amp;&amp;</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">remove</span><span style="color:#e1e4e8">(command))</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#6a737d">// Ë∞ÉÁî®ÊãíÁªùÁ≠ñÁï•ÔºåÊãíÁªùËØ•‰ªªÂä°ÁöÑÊâßË°å</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#b392f0">reject</span><span style="color:#e1e4e8">(command);</span></span>
<span class="line"><span style="color:#e1e4e8">        </span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#6a737d">// Â¶ÇÊûúÊ≤°ÊúâÊ≠£Âú®ËøêË°åÁöÑÁ∫øÁ®ã</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">else</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (</span><span style="color:#b392f0">workerCountOf</span><span style="color:#e1e4e8">(recheck) </span><span style="color:#f97583">==</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8">)</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#6a737d">// Â∞±ÂàõÂª∫Êñ∞Á∫øÁ®ãÊù•ÊâßË°åËØ•‰ªªÂä°</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#b392f0">addWorker</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8">, </span><span style="color:#79b8ff">false</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"><span style="color:#e1e4e8">    </span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">// Â¶ÇÊûúÊ∑ªÂä†Â§±Ë¥•‰∫ÜÔºà‰ªªÂä°ÈòüÂàóÂ∑≤Êª°ÔºâÔºåÂ∞±Ë∞ÉÁî®ÊãíÁªùÁ≠ñÁï•</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">else</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (</span><span style="color:#f97583">!</span><span style="color:#b392f0">addWorker</span><span style="color:#e1e4e8">(command, </span><span style="color:#79b8ff">false</span><span style="color:#e1e4e8">))</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#b392f0">reject</span><span style="color:#e1e4e8">(command);</span></span>
<span class="line"><span style="color:#e1e4e8">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">void</span><span style="color:#24292e"> </span><span style="color:#6f42c1">execute</span><span style="color:#24292e">(Runnable command) {</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (command </span><span style="color:#d73a49">==</span><span style="color:#24292e"> </span><span style="color:#005cc5">null</span><span style="color:#24292e">)</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">throw</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">NullPointerException</span><span style="color:#24292e">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">// Ëé∑Âèñctl</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">int</span><span style="color:#24292e"> c </span><span style="color:#d73a49">=</span><span style="color:#24292e"> ctl.</span><span style="color:#6f42c1">get</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">    </span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">// Âà§Êñ≠ÂΩìÂâçÂêØÁî®ÁöÑÁ∫øÁ®ãÊï∞ÊòØÂê¶Â∞è‰∫éÊ†∏ÂøÉÁ∫øÁ®ãÊï∞</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (</span><span style="color:#6f42c1">workerCountOf</span><span style="color:#24292e">(c) </span><span style="color:#d73a49">&lt;</span><span style="color:#24292e"> corePoolSize) {</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6a737d">// ‰∏∫ËØ•‰ªªÂä°ÂàÜÈÖçÁ∫øÁ®ã</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (</span><span style="color:#6f42c1">addWorker</span><span style="color:#24292e">(command, </span><span style="color:#005cc5">true</span><span style="color:#24292e">))</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#6a737d">// ÂàÜÈÖçÊàêÂäüÂ∞±ËøîÂõû</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">return</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">        </span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6a737d">// ÂàÜÈÖçÂ§±Ë¥•ÂÜçÊ¨°Ëé∑Âèñctl</span></span>
<span class="line"><span style="color:#24292e">        c </span><span style="color:#d73a49">=</span><span style="color:#24292e"> ctl.</span><span style="color:#6f42c1">get</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"><span style="color:#24292e">    </span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">// ÂàÜÈÖçÂíå‰ø°ÊÅØÁ∫øÁ®ãÂ§±Ë¥•‰ª•Âêé</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">// Â¶ÇÊûúÊ±†Áä∂ÊÄÅ‰∏∫RUNNINGÂπ∂‰∏îÊèíÂÖ•Âà∞‰ªªÂä°ÈòüÂàóÊàêÂäü</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (</span><span style="color:#6f42c1">isRunning</span><span style="color:#24292e">(c) </span><span style="color:#d73a49">&amp;&amp;</span><span style="color:#24292e"> workQueue.</span><span style="color:#6f42c1">offer</span><span style="color:#24292e">(command)) {</span></span>
<span class="line"><span style="color:#24292e">        </span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6a737d">// ÂèåÈáçÊ£ÄÊµãÔºåÂèØËÉΩÂú®Ê∑ªÂä†ÂêéÁ∫øÁ®ãÊ±†Áä∂ÊÄÅÂèò‰∏∫‰∫ÜÈùûRUNNING</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">int</span><span style="color:#24292e"> recheck </span><span style="color:#d73a49">=</span><span style="color:#24292e"> ctl.</span><span style="color:#6f42c1">get</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">        </span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6a737d">// Â¶ÇÊûúÊ±†Áä∂ÊÄÅ‰∏∫ÈùûRUNNINGÔºåÂàô‰∏ç‰ºöÊâßË°åÊñ∞Êù•ÁöÑ‰ªªÂä°</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6a737d">// Â∞ÜËØ•‰ªªÂä°‰ªéÈòªÂ°ûÈòüÂàó‰∏≠ÁßªÈô§</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (</span><span style="color:#d73a49">!</span><span style="color:#24292e"> </span><span style="color:#6f42c1">isRunning</span><span style="color:#24292e">(recheck) </span><span style="color:#d73a49">&amp;&amp;</span><span style="color:#24292e"> </span><span style="color:#6f42c1">remove</span><span style="color:#24292e">(command))</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#6a737d">// Ë∞ÉÁî®ÊãíÁªùÁ≠ñÁï•ÔºåÊãíÁªùËØ•‰ªªÂä°ÁöÑÊâßË°å</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#6f42c1">reject</span><span style="color:#24292e">(command);</span></span>
<span class="line"><span style="color:#24292e">        </span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6a737d">// Â¶ÇÊûúÊ≤°ÊúâÊ≠£Âú®ËøêË°åÁöÑÁ∫øÁ®ã</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">else</span><span style="color:#24292e"> </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (</span><span style="color:#6f42c1">workerCountOf</span><span style="color:#24292e">(recheck) </span><span style="color:#d73a49">==</span><span style="color:#24292e"> </span><span style="color:#005cc5">0</span><span style="color:#24292e">)</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#6a737d">// Â∞±ÂàõÂª∫Êñ∞Á∫øÁ®ãÊù•ÊâßË°åËØ•‰ªªÂä°</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#6f42c1">addWorker</span><span style="color:#24292e">(</span><span style="color:#005cc5">null</span><span style="color:#24292e">, </span><span style="color:#005cc5">false</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"><span style="color:#24292e">    </span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">// Â¶ÇÊûúÊ∑ªÂä†Â§±Ë¥•‰∫ÜÔºà‰ªªÂä°ÈòüÂàóÂ∑≤Êª°ÔºâÔºåÂ∞±Ë∞ÉÁî®ÊãíÁªùÁ≠ñÁï•</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">else</span><span style="color:#24292e"> </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (</span><span style="color:#d73a49">!</span><span style="color:#6f42c1">addWorker</span><span style="color:#24292e">(command, </span><span style="color:#005cc5">false</span><span style="color:#24292e">))</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6f42c1">reject</span><span style="color:#24292e">(command);</span></span>
<span class="line"><span style="color:#24292e">}</span></span></code></pre></div><p>ÂÖ∂‰∏≠Ë∞ÉÁî®‰∫Ü**addWoker()**ÊñπÊ≥ïÔºåÂÜçÁúãÁúãÁúãËøô‰∏™ÊñπÊ≥ï</p><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#f97583">private</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">boolean</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">addWorker</span><span style="color:#e1e4e8">(Runnable firstTask, </span><span style="color:#f97583">boolean</span><span style="color:#e1e4e8"> core) {</span></span>
<span class="line"><span style="color:#e1e4e8">    retry</span><span style="color:#f97583">:</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">for</span><span style="color:#e1e4e8"> (;;) {</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> c </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> ctl.</span><span style="color:#b392f0">get</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> rs </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">runStateOf</span><span style="color:#e1e4e8">(c);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#6a737d">// Check if queue empty only if necessary.</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#6a737d">// Â¶ÇÊûúÊ±†Áä∂ÊÄÅ‰∏∫ÈùûRUNNINGÁä∂ÊÄÅ„ÄÅÁ∫øÁ®ãÊ±†‰∏∫SHUTDOWN‰∏îËØ•‰ªªÂä°‰∏∫Á©∫ ÊàñËÄÖÈòªÂ°ûÈòüÂàó‰∏≠Â∑≤ÁªèÊúâ‰ªªÂä°</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (rs </span><span style="color:#f97583">&gt;=</span><span style="color:#e1e4e8"> SHUTDOWN </span><span style="color:#f97583">&amp;&amp;</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">!</span><span style="color:#e1e4e8"> (rs </span><span style="color:#f97583">==</span><span style="color:#e1e4e8"> SHUTDOWN </span><span style="color:#f97583">&amp;&amp;</span></span>
<span class="line"><span style="color:#e1e4e8">               firstTask </span><span style="color:#f97583">==</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">&amp;&amp;</span></span>
<span class="line"><span style="color:#e1e4e8">               </span><span style="color:#f97583">!</span><span style="color:#e1e4e8"> workQueue.</span><span style="color:#b392f0">isEmpty</span><span style="color:#e1e4e8">()))</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#6a737d">// ÂàõÂª∫Êñ∞Á∫øÁ®ãÂ§±Ë¥•</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">false</span><span style="color:#e1e4e8">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">for</span><span style="color:#e1e4e8"> (;;) {</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#6a737d">// Ëé∑ÂæóÂΩìÂâçÂ∑•‰ΩúÁ∫øÁ®ãÊï∞</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> wc </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">workerCountOf</span><span style="color:#e1e4e8">(c);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#6a737d">// ÂèÇÊï∞‰∏≠ core ‰∏∫true</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#6a737d">// CAPACITY ‰∏∫ 1 &lt;&lt; COUNT_BITS-1Ôºå‰∏ÄËà¨‰∏ç‰ºöË∂ÖËøá</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#6a737d">// Â¶ÇÊûúÂ∑•‰ΩúÁ∫øÁ®ãÊï∞Â§ß‰∫é‰∫ÜÊ†∏ÂøÉÁ∫øÁ®ãÊï∞ÔºåÂàôÂàõÂª∫Â§±Ë¥•</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (wc </span><span style="color:#f97583">&gt;=</span><span style="color:#e1e4e8"> CAPACITY </span><span style="color:#f97583">||</span></span>
<span class="line"><span style="color:#e1e4e8">                wc </span><span style="color:#f97583">&gt;=</span><span style="color:#e1e4e8"> (core </span><span style="color:#f97583">?</span><span style="color:#e1e4e8"> corePoolSize </span><span style="color:#f97583">:</span><span style="color:#e1e4e8"> maximumPoolSize))</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">false</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#6a737d">// ÈÄöËøáCASÊìç‰ΩúÊîπÂèòcÁöÑÂÄº</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (</span><span style="color:#b392f0">compareAndIncrementWorkerCount</span><span style="color:#e1e4e8">(c))</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#6a737d">// Êõ¥ÊîπÊàêÂäüÂ∞±Ë∑≥Âá∫Â§öÈáçÂæ™ÁéØÔºå‰∏î‰∏çÂÜçËøêË°åÂæ™ÁéØ</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#f97583">break</span><span style="color:#e1e4e8"> retry;</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#6a737d">// Êõ¥ÊîπÂ§±Ë¥•ÔºåÈáçÊñ∞Ëé∑ÂèñctlÁöÑÂÄº</span></span>
<span class="line"><span style="color:#e1e4e8">            c </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> ctl.</span><span style="color:#b392f0">get</span><span style="color:#e1e4e8">();  </span><span style="color:#6a737d">// Re-read ctl</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (</span><span style="color:#b392f0">runStateOf</span><span style="color:#e1e4e8">(c) </span><span style="color:#f97583">!=</span><span style="color:#e1e4e8"> rs)</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#6a737d">// Ë∑≥Âá∫Â§öÈáçÂæ™ÁéØÔºå‰∏îÈáçÊñ∞ËøõÂÖ•Âæ™ÁéØ</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#f97583">continue</span><span style="color:#e1e4e8"> retry;</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#6a737d">// else CAS failed due to workerCount change; retry inner loop</span></span>
<span class="line"><span style="color:#e1e4e8">        }</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">// Áî®‰∫éÊ†áËÆ∞work‰∏≠ÁöÑ‰ªªÂä°ÊòØÂê¶ÊàêÂäüÊâßË°å</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">boolean</span><span style="color:#e1e4e8"> workerStarted </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">false</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">// Áî®‰∫éÊ†áËÆ∞workerÊòØÂê¶ÊàêÂäüÂä†ÂÖ•‰∫ÜÁ∫øÁ®ãÊ±†‰∏≠</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">boolean</span><span style="color:#e1e4e8"> workerAdded </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">false</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">    Worker w </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">try</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#6a737d">// ÂàõÂª∫Êñ∞Á∫øÁ®ãÊù•ÊâßË°å‰ªªÂä°</span></span>
<span class="line"><span style="color:#e1e4e8">        w </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Worker</span><span style="color:#e1e4e8">(firstTask);</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">final</span><span style="color:#e1e4e8"> Thread t </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> w.thread;</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (t </span><span style="color:#f97583">!=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">final</span><span style="color:#e1e4e8"> ReentrantLock mainLock </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">this</span><span style="color:#e1e4e8">.mainLock;</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#6a737d">// Âä†ÈîÅ</span></span>
<span class="line"><span style="color:#e1e4e8">            mainLock.</span><span style="color:#b392f0">lock</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">try</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#6a737d">// Recheck while holding lock.</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#6a737d">// Back out on ThreadFactory failure or if</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#6a737d">// shut down before lock acquired.</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#6a737d">// Âä†ÈîÅÁöÑÂêåÊó∂ÂÜçÊ¨°Ê£ÄÊµã</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#6a737d">// ÈÅøÂÖçÂú®ÈáäÊîæÈîÅ‰πãÂâçË∞ÉÁî®‰∫Üshut down</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> rs </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">runStateOf</span><span style="color:#e1e4e8">(ctl.</span><span style="color:#b392f0">get</span><span style="color:#e1e4e8">());</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (rs </span><span style="color:#f97583">&lt;</span><span style="color:#e1e4e8"> SHUTDOWN </span><span style="color:#f97583">||</span></span>
<span class="line"><span style="color:#e1e4e8">                    (rs </span><span style="color:#f97583">==</span><span style="color:#e1e4e8"> SHUTDOWN </span><span style="color:#f97583">&amp;&amp;</span><span style="color:#e1e4e8"> firstTask </span><span style="color:#f97583">==</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8">)) {</span></span>
<span class="line"><span style="color:#e1e4e8">                    </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (t.</span><span style="color:#b392f0">isAlive</span><span style="color:#e1e4e8">()) </span><span style="color:#6a737d">// precheck that t is startable</span></span>
<span class="line"><span style="color:#e1e4e8">                        </span><span style="color:#f97583">throw</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">IllegalThreadStateException</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">                    </span><span style="color:#6a737d">// Â∞ÜÁ∫øÁ®ãÊ∑ªÂä†Âà∞Á∫øÁ®ãÊ±†‰∏≠</span></span>
<span class="line"><span style="color:#e1e4e8">                    workers.</span><span style="color:#b392f0">add</span><span style="color:#e1e4e8">(w);</span></span>
<span class="line"><span style="color:#e1e4e8">                    </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> s </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> workers.</span><span style="color:#b392f0">size</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">                    </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (s </span><span style="color:#f97583">&gt;</span><span style="color:#e1e4e8"> largestPoolSize)</span></span>
<span class="line"><span style="color:#e1e4e8">                        largestPoolSize </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> s;</span></span>
<span class="line"><span style="color:#e1e4e8">                    </span><span style="color:#6a737d">// Ê∑ªÂä†ÊàêÂäüÊ†áÂøó‰ΩçÂèò‰∏∫true</span></span>
<span class="line"><span style="color:#e1e4e8">                    workerAdded </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">true</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">                }</span></span>
<span class="line"><span style="color:#e1e4e8">            } </span><span style="color:#f97583">finally</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">                mainLock.</span><span style="color:#b392f0">unlock</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">            }</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#6a737d">// Â¶ÇÊûúworkerÊàêÂäüÂä†ÂÖ•‰∫ÜÁ∫øÁ®ãÊ±†ÔºåÂ∞±ÊâßË°åÂÖ∂‰∏≠ÁöÑ‰ªªÂä°</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (workerAdded) {</span></span>
<span class="line"><span style="color:#e1e4e8">                t.</span><span style="color:#b392f0">start</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#6a737d">// ÂêØÂä®ÊàêÂäü</span></span>
<span class="line"><span style="color:#e1e4e8">                workerStarted </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">true</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">            }</span></span>
<span class="line"><span style="color:#e1e4e8">        }</span></span>
<span class="line"><span style="color:#e1e4e8">    } </span><span style="color:#f97583">finally</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#6a737d">// Â¶ÇÊûúÊâßË°åÂ§±Ë¥•</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (</span><span style="color:#f97583">!</span><span style="color:#e1e4e8"> workerStarted)</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#6a737d">// Ë∞ÉÁî®Ê∑ªÂä†Â§±Ë¥•ÁöÑÂáΩÊï∞</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#b392f0">addWorkerFailed</span><span style="color:#e1e4e8">(w);</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> workerStarted;</span></span>
<span class="line"><span style="color:#e1e4e8">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#d73a49">private</span><span style="color:#24292e"> </span><span style="color:#d73a49">boolean</span><span style="color:#24292e"> </span><span style="color:#6f42c1">addWorker</span><span style="color:#24292e">(Runnable firstTask, </span><span style="color:#d73a49">boolean</span><span style="color:#24292e"> core) {</span></span>
<span class="line"><span style="color:#24292e">    retry</span><span style="color:#d73a49">:</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">for</span><span style="color:#24292e"> (;;) {</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">int</span><span style="color:#24292e"> c </span><span style="color:#d73a49">=</span><span style="color:#24292e"> ctl.</span><span style="color:#6f42c1">get</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">int</span><span style="color:#24292e"> rs </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#6f42c1">runStateOf</span><span style="color:#24292e">(c);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6a737d">// Check if queue empty only if necessary.</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6a737d">// Â¶ÇÊûúÊ±†Áä∂ÊÄÅ‰∏∫ÈùûRUNNINGÁä∂ÊÄÅ„ÄÅÁ∫øÁ®ãÊ±†‰∏∫SHUTDOWN‰∏îËØ•‰ªªÂä°‰∏∫Á©∫ ÊàñËÄÖÈòªÂ°ûÈòüÂàó‰∏≠Â∑≤ÁªèÊúâ‰ªªÂä°</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (rs </span><span style="color:#d73a49">&gt;=</span><span style="color:#24292e"> SHUTDOWN </span><span style="color:#d73a49">&amp;&amp;</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">!</span><span style="color:#24292e"> (rs </span><span style="color:#d73a49">==</span><span style="color:#24292e"> SHUTDOWN </span><span style="color:#d73a49">&amp;&amp;</span></span>
<span class="line"><span style="color:#24292e">               firstTask </span><span style="color:#d73a49">==</span><span style="color:#24292e"> </span><span style="color:#005cc5">null</span><span style="color:#24292e"> </span><span style="color:#d73a49">&amp;&amp;</span></span>
<span class="line"><span style="color:#24292e">               </span><span style="color:#d73a49">!</span><span style="color:#24292e"> workQueue.</span><span style="color:#6f42c1">isEmpty</span><span style="color:#24292e">()))</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#6a737d">// ÂàõÂª∫Êñ∞Á∫øÁ®ãÂ§±Ë¥•</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">return</span><span style="color:#24292e"> </span><span style="color:#005cc5">false</span><span style="color:#24292e">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">for</span><span style="color:#24292e"> (;;) {</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#6a737d">// Ëé∑ÂæóÂΩìÂâçÂ∑•‰ΩúÁ∫øÁ®ãÊï∞</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">int</span><span style="color:#24292e"> wc </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#6f42c1">workerCountOf</span><span style="color:#24292e">(c);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#6a737d">// ÂèÇÊï∞‰∏≠ core ‰∏∫true</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#6a737d">// CAPACITY ‰∏∫ 1 &lt;&lt; COUNT_BITS-1Ôºå‰∏ÄËà¨‰∏ç‰ºöË∂ÖËøá</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#6a737d">// Â¶ÇÊûúÂ∑•‰ΩúÁ∫øÁ®ãÊï∞Â§ß‰∫é‰∫ÜÊ†∏ÂøÉÁ∫øÁ®ãÊï∞ÔºåÂàôÂàõÂª∫Â§±Ë¥•</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (wc </span><span style="color:#d73a49">&gt;=</span><span style="color:#24292e"> CAPACITY </span><span style="color:#d73a49">||</span></span>
<span class="line"><span style="color:#24292e">                wc </span><span style="color:#d73a49">&gt;=</span><span style="color:#24292e"> (core </span><span style="color:#d73a49">?</span><span style="color:#24292e"> corePoolSize </span><span style="color:#d73a49">:</span><span style="color:#24292e"> maximumPoolSize))</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#d73a49">return</span><span style="color:#24292e"> </span><span style="color:#005cc5">false</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#6a737d">// ÈÄöËøáCASÊìç‰ΩúÊîπÂèòcÁöÑÂÄº</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (</span><span style="color:#6f42c1">compareAndIncrementWorkerCount</span><span style="color:#24292e">(c))</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#6a737d">// Êõ¥ÊîπÊàêÂäüÂ∞±Ë∑≥Âá∫Â§öÈáçÂæ™ÁéØÔºå‰∏î‰∏çÂÜçËøêË°åÂæ™ÁéØ</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#d73a49">break</span><span style="color:#24292e"> retry;</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#6a737d">// Êõ¥ÊîπÂ§±Ë¥•ÔºåÈáçÊñ∞Ëé∑ÂèñctlÁöÑÂÄº</span></span>
<span class="line"><span style="color:#24292e">            c </span><span style="color:#d73a49">=</span><span style="color:#24292e"> ctl.</span><span style="color:#6f42c1">get</span><span style="color:#24292e">();  </span><span style="color:#6a737d">// Re-read ctl</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (</span><span style="color:#6f42c1">runStateOf</span><span style="color:#24292e">(c) </span><span style="color:#d73a49">!=</span><span style="color:#24292e"> rs)</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#6a737d">// Ë∑≥Âá∫Â§öÈáçÂæ™ÁéØÔºå‰∏îÈáçÊñ∞ËøõÂÖ•Âæ™ÁéØ</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#d73a49">continue</span><span style="color:#24292e"> retry;</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#6a737d">// else CAS failed due to workerCount change; retry inner loop</span></span>
<span class="line"><span style="color:#24292e">        }</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">// Áî®‰∫éÊ†áËÆ∞work‰∏≠ÁöÑ‰ªªÂä°ÊòØÂê¶ÊàêÂäüÊâßË°å</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">boolean</span><span style="color:#24292e"> workerStarted </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#005cc5">false</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">// Áî®‰∫éÊ†áËÆ∞workerÊòØÂê¶ÊàêÂäüÂä†ÂÖ•‰∫ÜÁ∫øÁ®ãÊ±†‰∏≠</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">boolean</span><span style="color:#24292e"> workerAdded </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#005cc5">false</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">    Worker w </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#005cc5">null</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">try</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6a737d">// ÂàõÂª∫Êñ∞Á∫øÁ®ãÊù•ÊâßË°å‰ªªÂä°</span></span>
<span class="line"><span style="color:#24292e">        w </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Worker</span><span style="color:#24292e">(firstTask);</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">final</span><span style="color:#24292e"> Thread t </span><span style="color:#d73a49">=</span><span style="color:#24292e"> w.thread;</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (t </span><span style="color:#d73a49">!=</span><span style="color:#24292e"> </span><span style="color:#005cc5">null</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">final</span><span style="color:#24292e"> ReentrantLock mainLock </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#005cc5">this</span><span style="color:#24292e">.mainLock;</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#6a737d">// Âä†ÈîÅ</span></span>
<span class="line"><span style="color:#24292e">            mainLock.</span><span style="color:#6f42c1">lock</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">try</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#6a737d">// Recheck while holding lock.</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#6a737d">// Back out on ThreadFactory failure or if</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#6a737d">// shut down before lock acquired.</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#6a737d">// Âä†ÈîÅÁöÑÂêåÊó∂ÂÜçÊ¨°Ê£ÄÊµã</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#6a737d">// ÈÅøÂÖçÂú®ÈáäÊîæÈîÅ‰πãÂâçË∞ÉÁî®‰∫Üshut down</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#d73a49">int</span><span style="color:#24292e"> rs </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#6f42c1">runStateOf</span><span style="color:#24292e">(ctl.</span><span style="color:#6f42c1">get</span><span style="color:#24292e">());</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (rs </span><span style="color:#d73a49">&lt;</span><span style="color:#24292e"> SHUTDOWN </span><span style="color:#d73a49">||</span></span>
<span class="line"><span style="color:#24292e">                    (rs </span><span style="color:#d73a49">==</span><span style="color:#24292e"> SHUTDOWN </span><span style="color:#d73a49">&amp;&amp;</span><span style="color:#24292e"> firstTask </span><span style="color:#d73a49">==</span><span style="color:#24292e"> </span><span style="color:#005cc5">null</span><span style="color:#24292e">)) {</span></span>
<span class="line"><span style="color:#24292e">                    </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (t.</span><span style="color:#6f42c1">isAlive</span><span style="color:#24292e">()) </span><span style="color:#6a737d">// precheck that t is startable</span></span>
<span class="line"><span style="color:#24292e">                        </span><span style="color:#d73a49">throw</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">IllegalThreadStateException</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">                    </span><span style="color:#6a737d">// Â∞ÜÁ∫øÁ®ãÊ∑ªÂä†Âà∞Á∫øÁ®ãÊ±†‰∏≠</span></span>
<span class="line"><span style="color:#24292e">                    workers.</span><span style="color:#6f42c1">add</span><span style="color:#24292e">(w);</span></span>
<span class="line"><span style="color:#24292e">                    </span><span style="color:#d73a49">int</span><span style="color:#24292e"> s </span><span style="color:#d73a49">=</span><span style="color:#24292e"> workers.</span><span style="color:#6f42c1">size</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">                    </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (s </span><span style="color:#d73a49">&gt;</span><span style="color:#24292e"> largestPoolSize)</span></span>
<span class="line"><span style="color:#24292e">                        largestPoolSize </span><span style="color:#d73a49">=</span><span style="color:#24292e"> s;</span></span>
<span class="line"><span style="color:#24292e">                    </span><span style="color:#6a737d">// Ê∑ªÂä†ÊàêÂäüÊ†áÂøó‰ΩçÂèò‰∏∫true</span></span>
<span class="line"><span style="color:#24292e">                    workerAdded </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#005cc5">true</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">                }</span></span>
<span class="line"><span style="color:#24292e">            } </span><span style="color:#d73a49">finally</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">                mainLock.</span><span style="color:#6f42c1">unlock</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">            }</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#6a737d">// Â¶ÇÊûúworkerÊàêÂäüÂä†ÂÖ•‰∫ÜÁ∫øÁ®ãÊ±†ÔºåÂ∞±ÊâßË°åÂÖ∂‰∏≠ÁöÑ‰ªªÂä°</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (workerAdded) {</span></span>
<span class="line"><span style="color:#24292e">                t.</span><span style="color:#6f42c1">start</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#6a737d">// ÂêØÂä®ÊàêÂäü</span></span>
<span class="line"><span style="color:#24292e">                workerStarted </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#005cc5">true</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">            }</span></span>
<span class="line"><span style="color:#24292e">        }</span></span>
<span class="line"><span style="color:#24292e">    } </span><span style="color:#d73a49">finally</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6a737d">// Â¶ÇÊûúÊâßË°åÂ§±Ë¥•</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (</span><span style="color:#d73a49">!</span><span style="color:#24292e"> workerStarted)</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#6a737d">// Ë∞ÉÁî®Ê∑ªÂä†Â§±Ë¥•ÁöÑÂáΩÊï∞</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#6f42c1">addWorkerFailed</span><span style="color:#24292e">(w);</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">return</span><span style="color:#24292e"> workerStarted;</span></span>
<span class="line"><span style="color:#24292e">}</span></span></code></pre></div><h4 id="Êèê‰∫§‰ªªÂä°" tabindex="-1">Êèê‰∫§‰ªªÂä° <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20advanced%20chapter#Êèê‰∫§‰ªªÂä°" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h4><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6a737d">// ÊâßË°å‰ªªÂä°</span></span>
<span class="line"><span style="color:#f97583">void</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">execute</span><span style="color:#e1e4e8">(Runnable command);</span></span>
<span class="line"><span style="color:#6a737d">// Êèê‰∫§‰ªªÂä° taskÔºåÁî®ËøîÂõûÂÄº Future Ëé∑Âæó‰ªªÂä°ÊâßË°åÁªìÊûú</span></span>
<span class="line"><span style="color:#f97583">&lt;</span><span style="color:#e1e4e8">T</span><span style="color:#f97583">&gt;</span><span style="color:#e1e4e8"> Future</span><span style="color:#f97583">&lt;</span><span style="color:#e1e4e8">T</span><span style="color:#f97583">&gt;</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">submit</span><span style="color:#e1e4e8">(Callable</span><span style="color:#f97583">&lt;</span><span style="color:#e1e4e8">T</span><span style="color:#f97583">&gt;</span><span style="color:#e1e4e8"> task);</span></span>
<span class="line"><span style="color:#6a737d">// Êèê‰∫§ tasks ‰∏≠ÊâÄÊúâ‰ªªÂä°</span></span>
<span class="line"><span style="color:#f97583">&lt;</span><span style="color:#e1e4e8">T</span><span style="color:#f97583">&gt;</span><span style="color:#e1e4e8"> List</span><span style="color:#f97583">&lt;</span><span style="color:#e1e4e8">Future</span><span style="color:#f97583">&lt;</span><span style="color:#e1e4e8">T</span><span style="color:#f97583">&gt;&gt;</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">invokeAll</span><span style="color:#e1e4e8">(Collection</span><span style="color:#f97583">&lt;?</span><span style="color:#e1e4e8"> extends Callable</span><span style="color:#f97583">&lt;</span><span style="color:#e1e4e8">T</span><span style="color:#f97583">&gt;&gt;</span><span style="color:#e1e4e8"> tasks)</span></span>
<span class="line"><span style="color:#e1e4e8">throws InterruptedException;</span></span>
<span class="line"><span style="color:#6a737d">// Êèê‰∫§ tasks ‰∏≠ÊâÄÊúâ‰ªªÂä°ÔºåÂ∏¶Ë∂ÖÊó∂Êó∂Èó¥</span></span>
<span class="line"><span style="color:#f97583">&lt;</span><span style="color:#e1e4e8">T</span><span style="color:#f97583">&gt;</span><span style="color:#e1e4e8"> List</span><span style="color:#f97583">&lt;</span><span style="color:#e1e4e8">Future</span><span style="color:#f97583">&lt;</span><span style="color:#e1e4e8">T</span><span style="color:#f97583">&gt;&gt;</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">invokeAll</span><span style="color:#e1e4e8">(Collection</span><span style="color:#f97583">&lt;?</span><span style="color:#e1e4e8"> extends Callable</span><span style="color:#f97583">&lt;</span><span style="color:#e1e4e8">T</span><span style="color:#f97583">&gt;&gt;</span><span style="color:#e1e4e8"> tasks,</span></span>
<span class="line"><span style="color:#f97583">long</span><span style="color:#e1e4e8"> timeout, TimeUnit unit)</span></span>
<span class="line"><span style="color:#e1e4e8">throws InterruptedException;</span></span>
<span class="line"><span style="color:#6a737d">// Êèê‰∫§ tasks ‰∏≠ÊâÄÊúâ‰ªªÂä°ÔºåÂì™‰∏™‰ªªÂä°ÂÖàÊàêÂäüÊâßË°åÂÆåÊØïÔºåËøîÂõûÊ≠§‰ªªÂä°ÊâßË°åÁªìÊûúÔºåÂÖ∂ÂÆÉ‰ªªÂä°ÂèñÊ∂à</span></span>
<span class="line"><span style="color:#f97583">&lt;</span><span style="color:#e1e4e8">T</span><span style="color:#f97583">&gt;</span><span style="color:#e1e4e8"> T </span><span style="color:#b392f0">invokeAny</span><span style="color:#e1e4e8">(Collection</span><span style="color:#f97583">&lt;?</span><span style="color:#e1e4e8"> extends Callable</span><span style="color:#f97583">&lt;</span><span style="color:#e1e4e8">T</span><span style="color:#f97583">&gt;&gt;</span><span style="color:#e1e4e8"> tasks)</span></span>
<span class="line"><span style="color:#e1e4e8">throws InterruptedException, ExecutionException;</span></span>
<span class="line"><span style="color:#6a737d">// Êèê‰∫§ tasks ‰∏≠ÊâÄÊúâ‰ªªÂä°ÔºåÂì™‰∏™‰ªªÂä°ÂÖàÊàêÂäüÊâßË°åÂÆåÊØïÔºåËøîÂõûÊ≠§‰ªªÂä°ÊâßË°åÁªìÊûúÔºåÂÖ∂ÂÆÉ‰ªªÂä°ÂèñÊ∂àÔºåÂ∏¶Ë∂ÖÊó∂Êó∂Èó¥</span></span>
<span class="line"><span style="color:#f97583">&lt;</span><span style="color:#e1e4e8">T</span><span style="color:#f97583">&gt;</span><span style="color:#e1e4e8"> T </span><span style="color:#b392f0">invokeAny</span><span style="color:#e1e4e8">(Collection</span><span style="color:#f97583">&lt;?</span><span style="color:#e1e4e8"> extends Callable</span><span style="color:#f97583">&lt;</span><span style="color:#e1e4e8">T</span><span style="color:#f97583">&gt;&gt;</span><span style="color:#e1e4e8"> tasks,</span></span>
<span class="line"><span style="color:#f97583">long</span><span style="color:#e1e4e8"> timeout, TimeUnit unit)</span></span>
<span class="line"><span style="color:#e1e4e8">throws InterruptedException, ExecutionException, TimeoutException;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6a737d">// ÊâßË°å‰ªªÂä°</span></span>
<span class="line"><span style="color:#d73a49">void</span><span style="color:#24292e"> </span><span style="color:#6f42c1">execute</span><span style="color:#24292e">(Runnable command);</span></span>
<span class="line"><span style="color:#6a737d">// Êèê‰∫§‰ªªÂä° taskÔºåÁî®ËøîÂõûÂÄº Future Ëé∑Âæó‰ªªÂä°ÊâßË°åÁªìÊûú</span></span>
<span class="line"><span style="color:#d73a49">&lt;</span><span style="color:#24292e">T</span><span style="color:#d73a49">&gt;</span><span style="color:#24292e"> Future</span><span style="color:#d73a49">&lt;</span><span style="color:#24292e">T</span><span style="color:#d73a49">&gt;</span><span style="color:#24292e"> </span><span style="color:#6f42c1">submit</span><span style="color:#24292e">(Callable</span><span style="color:#d73a49">&lt;</span><span style="color:#24292e">T</span><span style="color:#d73a49">&gt;</span><span style="color:#24292e"> task);</span></span>
<span class="line"><span style="color:#6a737d">// Êèê‰∫§ tasks ‰∏≠ÊâÄÊúâ‰ªªÂä°</span></span>
<span class="line"><span style="color:#d73a49">&lt;</span><span style="color:#24292e">T</span><span style="color:#d73a49">&gt;</span><span style="color:#24292e"> List</span><span style="color:#d73a49">&lt;</span><span style="color:#24292e">Future</span><span style="color:#d73a49">&lt;</span><span style="color:#24292e">T</span><span style="color:#d73a49">&gt;&gt;</span><span style="color:#24292e"> </span><span style="color:#6f42c1">invokeAll</span><span style="color:#24292e">(Collection</span><span style="color:#d73a49">&lt;?</span><span style="color:#24292e"> extends Callable</span><span style="color:#d73a49">&lt;</span><span style="color:#24292e">T</span><span style="color:#d73a49">&gt;&gt;</span><span style="color:#24292e"> tasks)</span></span>
<span class="line"><span style="color:#24292e">throws InterruptedException;</span></span>
<span class="line"><span style="color:#6a737d">// Êèê‰∫§ tasks ‰∏≠ÊâÄÊúâ‰ªªÂä°ÔºåÂ∏¶Ë∂ÖÊó∂Êó∂Èó¥</span></span>
<span class="line"><span style="color:#d73a49">&lt;</span><span style="color:#24292e">T</span><span style="color:#d73a49">&gt;</span><span style="color:#24292e"> List</span><span style="color:#d73a49">&lt;</span><span style="color:#24292e">Future</span><span style="color:#d73a49">&lt;</span><span style="color:#24292e">T</span><span style="color:#d73a49">&gt;&gt;</span><span style="color:#24292e"> </span><span style="color:#6f42c1">invokeAll</span><span style="color:#24292e">(Collection</span><span style="color:#d73a49">&lt;?</span><span style="color:#24292e"> extends Callable</span><span style="color:#d73a49">&lt;</span><span style="color:#24292e">T</span><span style="color:#d73a49">&gt;&gt;</span><span style="color:#24292e"> tasks,</span></span>
<span class="line"><span style="color:#d73a49">long</span><span style="color:#24292e"> timeout, TimeUnit unit)</span></span>
<span class="line"><span style="color:#24292e">throws InterruptedException;</span></span>
<span class="line"><span style="color:#6a737d">// Êèê‰∫§ tasks ‰∏≠ÊâÄÊúâ‰ªªÂä°ÔºåÂì™‰∏™‰ªªÂä°ÂÖàÊàêÂäüÊâßË°åÂÆåÊØïÔºåËøîÂõûÊ≠§‰ªªÂä°ÊâßË°åÁªìÊûúÔºåÂÖ∂ÂÆÉ‰ªªÂä°ÂèñÊ∂à</span></span>
<span class="line"><span style="color:#d73a49">&lt;</span><span style="color:#24292e">T</span><span style="color:#d73a49">&gt;</span><span style="color:#24292e"> T </span><span style="color:#6f42c1">invokeAny</span><span style="color:#24292e">(Collection</span><span style="color:#d73a49">&lt;?</span><span style="color:#24292e"> extends Callable</span><span style="color:#d73a49">&lt;</span><span style="color:#24292e">T</span><span style="color:#d73a49">&gt;&gt;</span><span style="color:#24292e"> tasks)</span></span>
<span class="line"><span style="color:#24292e">throws InterruptedException, ExecutionException;</span></span>
<span class="line"><span style="color:#6a737d">// Êèê‰∫§ tasks ‰∏≠ÊâÄÊúâ‰ªªÂä°ÔºåÂì™‰∏™‰ªªÂä°ÂÖàÊàêÂäüÊâßË°åÂÆåÊØïÔºåËøîÂõûÊ≠§‰ªªÂä°ÊâßË°åÁªìÊûúÔºåÂÖ∂ÂÆÉ‰ªªÂä°ÂèñÊ∂àÔºåÂ∏¶Ë∂ÖÊó∂Êó∂Èó¥</span></span>
<span class="line"><span style="color:#d73a49">&lt;</span><span style="color:#24292e">T</span><span style="color:#d73a49">&gt;</span><span style="color:#24292e"> T </span><span style="color:#6f42c1">invokeAny</span><span style="color:#24292e">(Collection</span><span style="color:#d73a49">&lt;?</span><span style="color:#24292e"> extends Callable</span><span style="color:#d73a49">&lt;</span><span style="color:#24292e">T</span><span style="color:#d73a49">&gt;&gt;</span><span style="color:#24292e"> tasks,</span></span>
<span class="line"><span style="color:#d73a49">long</span><span style="color:#24292e"> timeout, TimeUnit unit)</span></span>
<span class="line"><span style="color:#24292e">throws InterruptedException, ExecutionException, TimeoutException;</span></span></code></pre></div><h5 id="submit-ÊñπÊ≥ï" tabindex="-1">submit()ÊñπÊ≥ï <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20advanced%20chapter#submit-ÊñπÊ≥ï" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h5><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8">Future</span><span style="color:#f97583">&lt;</span><span style="color:#e1e4e8">T</span><span style="color:#f97583">&gt;</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">submit</span><span style="color:#e1e4e8">(Callable</span><span style="color:#f97583">&lt;</span><span style="color:#e1e4e8">T</span><span style="color:#f97583">&gt;</span><span style="color:#e1e4e8"> task)</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e">Future</span><span style="color:#d73a49">&lt;</span><span style="color:#24292e">T</span><span style="color:#d73a49">&gt;</span><span style="color:#24292e"> </span><span style="color:#6f42c1">submit</span><span style="color:#24292e">(Callable</span><span style="color:#d73a49">&lt;</span><span style="color:#24292e">T</span><span style="color:#d73a49">&gt;</span><span style="color:#24292e"> task)</span></span></code></pre></div><p>‰º†ÂÖ•‰∏Ä‰∏™CallableÂØπË±°ÔºåÁî®FutureÊù•<strong>ÊçïËé∑ËøîÂõûÂÄº</strong></p><p><strong>‰ΩøÁî®</strong></p><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6a737d">// ÈÄöËøásubmitÊâßË°åCallable‰∏≠ÁöÑcallÊñπÊ≥ï</span></span>
<span class="line"><span style="color:#6a737d">// ÈÄöËøáFutureÊù•ÊçïËé∑ËøîÂõûÂÄº</span></span>
<span class="line"><span style="color:#e1e4e8">Future&lt;</span><span style="color:#f97583">String</span><span style="color:#e1e4e8">&gt; future </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> threadPool.</span><span style="color:#b392f0">submit</span><span style="color:#e1e4e8">(</span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> Callable&lt;</span><span style="color:#f97583">String</span><span style="color:#e1e4e8">&gt;() {</span></span>
<span class="line"><span style="color:#e1e4e8">   @</span><span style="color:#f97583">Override</span></span>
<span class="line"><span style="color:#e1e4e8">   </span><span style="color:#f97583">public</span><span style="color:#e1e4e8"> String </span><span style="color:#b392f0">call</span><span style="color:#e1e4e8">() </span><span style="color:#f97583">throws</span><span style="color:#e1e4e8"> Exception {</span></span>
<span class="line"><span style="color:#e1e4e8">      </span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> </span><span style="color:#9ecbff">"hello submit"</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">   }</span></span>
<span class="line"><span style="color:#e1e4e8">});</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6a737d">// Êü•ÁúãÊçïËé∑ÁöÑËøîÂõûÂÄº</span></span>
<span class="line"><span style="color:#e1e4e8">System.out.</span><span style="color:#b392f0">println</span><span style="color:#e1e4e8">(future.</span><span style="color:#b392f0">get</span><span style="color:#e1e4e8">());</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6a737d">// ÈÄöËøásubmitÊâßË°åCallable‰∏≠ÁöÑcallÊñπÊ≥ï</span></span>
<span class="line"><span style="color:#6a737d">// ÈÄöËøáFutureÊù•ÊçïËé∑ËøîÂõûÂÄº</span></span>
<span class="line"><span style="color:#24292e">Future&lt;</span><span style="color:#d73a49">String</span><span style="color:#24292e">&gt; future </span><span style="color:#d73a49">=</span><span style="color:#24292e"> threadPool.</span><span style="color:#6f42c1">submit</span><span style="color:#24292e">(</span><span style="color:#d73a49">new</span><span style="color:#24292e"> Callable&lt;</span><span style="color:#d73a49">String</span><span style="color:#24292e">&gt;() {</span></span>
<span class="line"><span style="color:#24292e">   @</span><span style="color:#d73a49">Override</span></span>
<span class="line"><span style="color:#24292e">   </span><span style="color:#d73a49">public</span><span style="color:#24292e"> String </span><span style="color:#6f42c1">call</span><span style="color:#24292e">() </span><span style="color:#d73a49">throws</span><span style="color:#24292e"> Exception {</span></span>
<span class="line"><span style="color:#24292e">      </span><span style="color:#d73a49">return</span><span style="color:#24292e"> </span><span style="color:#032f62">"hello submit"</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">   }</span></span>
<span class="line"><span style="color:#24292e">});</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6a737d">// Êü•ÁúãÊçïËé∑ÁöÑËøîÂõûÂÄº</span></span>
<span class="line"><span style="color:#24292e">System.out.</span><span style="color:#6f42c1">println</span><span style="color:#24292e">(future.</span><span style="color:#6f42c1">get</span><span style="color:#24292e">());</span></span></code></pre></div><h5 id="invokeallÊñπÊ≥ï" tabindex="-1">invokeAllÊñπÊ≥ï <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20advanced%20chapter#invokeallÊñπÊ≥ï" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h5><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8">ExecutorService pool </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> Executors.</span><span style="color:#b392f0">newFixedThreadPool</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">3</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">List&lt;Future&lt;</span><span style="color:#f97583">String</span><span style="color:#e1e4e8">&gt;&gt; futures </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> pool.</span><span style="color:#b392f0">invokeAll</span><span style="color:#e1e4e8">(Arrays.</span><span style="color:#b392f0">asList</span><span style="color:#e1e4e8">(</span></span>
<span class="line"><span style="color:#e1e4e8">                () </span><span style="color:#f97583">-&gt;</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">                    log.</span><span style="color:#b392f0">debug</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"begin"</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">                    Thread.</span><span style="color:#b392f0">sleep</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">1000</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">                    </span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> </span><span style="color:#9ecbff">"1"</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">                },</span></span>
<span class="line"><span style="color:#e1e4e8">                () </span><span style="color:#f97583">-&gt;</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">                    log.</span><span style="color:#b392f0">debug</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"begin"</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">                    Thread.</span><span style="color:#b392f0">sleep</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">500</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">                    </span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> </span><span style="color:#9ecbff">"2"</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">                },</span></span>
<span class="line"><span style="color:#e1e4e8">                () </span><span style="color:#f97583">-&gt;</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">                    log.</span><span style="color:#b392f0">debug</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"begin"</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">                    Thread.</span><span style="color:#b392f0">sleep</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">2000</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">                    </span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> </span><span style="color:#9ecbff">"3"</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">                }</span></span>
<span class="line"><span style="color:#e1e4e8">        ));</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">        futures.</span><span style="color:#b392f0">forEach</span><span style="color:#e1e4e8">( f </span><span style="color:#f97583">-&gt;</span><span style="color:#e1e4e8">  {</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">try</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">                log.</span><span style="color:#b392f0">debug</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"{}"</span><span style="color:#e1e4e8">, f.</span><span style="color:#b392f0">get</span><span style="color:#e1e4e8">());</span></span>
<span class="line"><span style="color:#e1e4e8">            } </span><span style="color:#f97583">catch</span><span style="color:#e1e4e8"> (InterruptedException | ExecutionException </span><span style="color:#ffab70">e</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">                e.</span><span style="color:#b392f0">printStackTrace</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">            }</span></span>
<span class="line"><span style="color:#e1e4e8">        });</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e">ExecutorService pool </span><span style="color:#d73a49">=</span><span style="color:#24292e"> Executors.</span><span style="color:#6f42c1">newFixedThreadPool</span><span style="color:#24292e">(</span><span style="color:#005cc5">3</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">List&lt;Future&lt;</span><span style="color:#d73a49">String</span><span style="color:#24292e">&gt;&gt; futures </span><span style="color:#d73a49">=</span><span style="color:#24292e"> pool.</span><span style="color:#6f42c1">invokeAll</span><span style="color:#24292e">(Arrays.</span><span style="color:#6f42c1">asList</span><span style="color:#24292e">(</span></span>
<span class="line"><span style="color:#24292e">                () </span><span style="color:#d73a49">-&gt;</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">                    log.</span><span style="color:#6f42c1">debug</span><span style="color:#24292e">(</span><span style="color:#032f62">"begin"</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">                    Thread.</span><span style="color:#6f42c1">sleep</span><span style="color:#24292e">(</span><span style="color:#005cc5">1000</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">                    </span><span style="color:#d73a49">return</span><span style="color:#24292e"> </span><span style="color:#032f62">"1"</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">                },</span></span>
<span class="line"><span style="color:#24292e">                () </span><span style="color:#d73a49">-&gt;</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">                    log.</span><span style="color:#6f42c1">debug</span><span style="color:#24292e">(</span><span style="color:#032f62">"begin"</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">                    Thread.</span><span style="color:#6f42c1">sleep</span><span style="color:#24292e">(</span><span style="color:#005cc5">500</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">                    </span><span style="color:#d73a49">return</span><span style="color:#24292e"> </span><span style="color:#032f62">"2"</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">                },</span></span>
<span class="line"><span style="color:#24292e">                () </span><span style="color:#d73a49">-&gt;</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">                    log.</span><span style="color:#6f42c1">debug</span><span style="color:#24292e">(</span><span style="color:#032f62">"begin"</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">                    Thread.</span><span style="color:#6f42c1">sleep</span><span style="color:#24292e">(</span><span style="color:#005cc5">2000</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">                    </span><span style="color:#d73a49">return</span><span style="color:#24292e"> </span><span style="color:#032f62">"3"</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">                }</span></span>
<span class="line"><span style="color:#24292e">        ));</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">        futures.</span><span style="color:#6f42c1">forEach</span><span style="color:#24292e">( f </span><span style="color:#d73a49">-&gt;</span><span style="color:#24292e">  {</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">try</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">                log.</span><span style="color:#6f42c1">debug</span><span style="color:#24292e">(</span><span style="color:#032f62">"{}"</span><span style="color:#24292e">, f.</span><span style="color:#6f42c1">get</span><span style="color:#24292e">());</span></span>
<span class="line"><span style="color:#24292e">            } </span><span style="color:#d73a49">catch</span><span style="color:#24292e"> (InterruptedException | ExecutionException </span><span style="color:#e36209">e</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">                e.</span><span style="color:#6f42c1">printStackTrace</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">            }</span></span>
<span class="line"><span style="color:#24292e">        });</span></span></code></pre></div><h4 id="ÂÅúÊ≠¢" tabindex="-1">ÂÅúÊ≠¢ <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20advanced%20chapter#ÂÅúÊ≠¢" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h4><h5 id="shutdown" tabindex="-1">shutdown() <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20advanced%20chapter#shutdown" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h5><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6a737d">/**</span></span>
<span class="line"><span style="color:#6a737d">* Â∞ÜÁ∫øÁ®ãÊ±†ÁöÑÁä∂ÊÄÅÊîπ‰∏∫ SHUTDOWN</span></span>
<span class="line"><span style="color:#6a737d">* ‰∏çÂÜçÊé•ÂèóÊñ∞‰ªªÂä°Ôºå‰ΩÜÊòØ‰ºöÂ∞ÜÈòªÂ°ûÈòüÂàó‰∏≠ÁöÑ‰ªªÂä°ÊâßË°åÂÆå</span></span>
<span class="line"><span style="color:#6a737d">*/</span></span>
<span class="line"><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">void</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">shutdown</span><span style="color:#e1e4e8">() {</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">final</span><span style="color:#e1e4e8"> ReentrantLock mainLock </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">this</span><span style="color:#e1e4e8">.mainLock;</span></span>
<span class="line"><span style="color:#e1e4e8">    mainLock.</span><span style="color:#b392f0">lock</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">try</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#b392f0">checkShutdownAccess</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">        </span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#6a737d">// ‰øÆÊîπÁ∫øÁ®ãÊ±†Áä∂ÊÄÅ‰∏∫ SHUTDOWN</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#b392f0">advanceRunState</span><span style="color:#e1e4e8">(SHUTDOWN);</span></span>
<span class="line"><span style="color:#e1e4e8">        </span></span>
<span class="line"><span style="color:#e1e4e8">  		</span><span style="color:#6a737d">// ‰∏≠Êñ≠Á©∫Èó≤Á∫øÁ®ãÔºàÊ≤°ÊúâÊâßË°å‰ªªÂä°ÁöÑÁ∫øÁ®ãÔºâ</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#6a737d">// IdleÔºöÁ©∫Èó≤ÁöÑ</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#b392f0">interruptIdleWorkers</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#b392f0">onShutdown</span><span style="color:#e1e4e8">(); </span><span style="color:#6a737d">// hook for ScheduledThreadPoolExecutor</span></span>
<span class="line"><span style="color:#e1e4e8">    } </span><span style="color:#f97583">finally</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">        mainLock.</span><span style="color:#b392f0">unlock</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">// Â∞ùËØïÁªàÁªìÔºå‰∏ç‰∏ÄÂÆöÊàêÂäü</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">// </span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#b392f0">tryTerminate</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">}</span></span>
<span class="line"><span style="color:#f97583">final</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">void</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">tryTerminate</span><span style="color:#e1e4e8">() {</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">for</span><span style="color:#e1e4e8"> (;;) {</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> c </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> ctl.</span><span style="color:#b392f0">get</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#6a737d">// ÁªàÁªìÂ§±Ë¥•ÁöÑÊù°‰ª∂</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#6a737d">// Á∫øÁ®ãÊ±†Áä∂ÊÄÅ‰∏∫RUNNING</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#6a737d">// Á∫øÁ®ãÊ±†Áä∂ÊÄÅ‰∏∫ RUNNING SHUTDOWN STOP ÔºàÁä∂ÊÄÅÂÄºÂ§ß‰∫éTIDYINGÔºâ</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#6a737d">// Á∫øÁ®ãÊ±†Áä∂ÊÄÅ‰∏∫SHUTDOWNÔºå‰ΩÜÈòªÂ°ûÈòüÂàó‰∏≠ËøòÊúâ‰ªªÂä°Á≠âÂæÖÊâßË°å</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (</span><span style="color:#b392f0">isRunning</span><span style="color:#e1e4e8">(c) </span><span style="color:#f97583">||</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#b392f0">runStateAtLeast</span><span style="color:#e1e4e8">(c, TIDYING) </span><span style="color:#f97583">||</span></span>
<span class="line"><span style="color:#e1e4e8">            (</span><span style="color:#b392f0">runStateOf</span><span style="color:#e1e4e8">(c) </span><span style="color:#f97583">==</span><span style="color:#e1e4e8"> SHUTDOWN </span><span style="color:#f97583">&amp;&amp;</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">!</span><span style="color:#e1e4e8"> workQueue.</span><span style="color:#b392f0">isEmpty</span><span style="color:#e1e4e8">()))</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">return</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">        </span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#6a737d">// Â¶ÇÊûúÊ¥ªË∑ÉÁ∫øÁ®ãÊï∞‰∏ç‰∏∫0</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (</span><span style="color:#b392f0">workerCountOf</span><span style="color:#e1e4e8">(c) </span><span style="color:#f97583">!=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8">) { </span><span style="color:#6a737d">// Eligible to terminate</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#6a737d">// ‰∏≠Êñ≠Á©∫Èó≤Á∫øÁ®ã</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#b392f0">interruptIdleWorkers</span><span style="color:#e1e4e8">(ONLY_ONE);</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">return</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">        }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">final</span><span style="color:#e1e4e8"> ReentrantLock mainLock </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">this</span><span style="color:#e1e4e8">.mainLock;</span></span>
<span class="line"><span style="color:#e1e4e8">        mainLock.</span><span style="color:#b392f0">lock</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">try</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#6a737d">// Â§Ñ‰∫éÂèØ‰ª•ÁªàÁªìÁöÑÁä∂ÊÄÅ</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#6a737d">// ÈÄöËøáCASÂ∞ÜÁ∫øÁ®ãÊ±†Áä∂ÊÄÅÊîπ‰∏∫TIDYING</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (ctl.</span><span style="color:#b392f0">compareAndSet</span><span style="color:#e1e4e8">(c, </span><span style="color:#b392f0">ctlOf</span><span style="color:#e1e4e8">(TIDYING, </span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8">))) {</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#f97583">try</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">                    </span><span style="color:#b392f0">terminated</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">                } </span><span style="color:#f97583">finally</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">                    </span><span style="color:#6a737d">// ÈÄöËøáCASÂ∞ÜÁ∫øÁ®ãÊ±†Áä∂ÊÄÅÊîπ‰∏∫TERMINATED</span></span>
<span class="line"><span style="color:#e1e4e8">                    ctl.</span><span style="color:#b392f0">set</span><span style="color:#e1e4e8">(</span><span style="color:#b392f0">ctlOf</span><span style="color:#e1e4e8">(TERMINATED, </span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8">));</span></span>
<span class="line"><span style="color:#e1e4e8">                    termination.</span><span style="color:#b392f0">signalAll</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">                }</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#f97583">return</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">            }</span></span>
<span class="line"><span style="color:#e1e4e8">        } </span><span style="color:#f97583">finally</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">            mainLock.</span><span style="color:#b392f0">unlock</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">        }</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#6a737d">// else retry on failed CAS</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"><span style="color:#e1e4e8">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6a737d">/**</span></span>
<span class="line"><span style="color:#6a737d">* Â∞ÜÁ∫øÁ®ãÊ±†ÁöÑÁä∂ÊÄÅÊîπ‰∏∫ SHUTDOWN</span></span>
<span class="line"><span style="color:#6a737d">* ‰∏çÂÜçÊé•ÂèóÊñ∞‰ªªÂä°Ôºå‰ΩÜÊòØ‰ºöÂ∞ÜÈòªÂ°ûÈòüÂàó‰∏≠ÁöÑ‰ªªÂä°ÊâßË°åÂÆå</span></span>
<span class="line"><span style="color:#6a737d">*/</span></span>
<span class="line"><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">void</span><span style="color:#24292e"> </span><span style="color:#6f42c1">shutdown</span><span style="color:#24292e">() {</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">final</span><span style="color:#24292e"> ReentrantLock mainLock </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#005cc5">this</span><span style="color:#24292e">.mainLock;</span></span>
<span class="line"><span style="color:#24292e">    mainLock.</span><span style="color:#6f42c1">lock</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">try</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6f42c1">checkShutdownAccess</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">        </span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6a737d">// ‰øÆÊîπÁ∫øÁ®ãÊ±†Áä∂ÊÄÅ‰∏∫ SHUTDOWN</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6f42c1">advanceRunState</span><span style="color:#24292e">(SHUTDOWN);</span></span>
<span class="line"><span style="color:#24292e">        </span></span>
<span class="line"><span style="color:#24292e">  		</span><span style="color:#6a737d">// ‰∏≠Êñ≠Á©∫Èó≤Á∫øÁ®ãÔºàÊ≤°ÊúâÊâßË°å‰ªªÂä°ÁöÑÁ∫øÁ®ãÔºâ</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6a737d">// IdleÔºöÁ©∫Èó≤ÁöÑ</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6f42c1">interruptIdleWorkers</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6f42c1">onShutdown</span><span style="color:#24292e">(); </span><span style="color:#6a737d">// hook for ScheduledThreadPoolExecutor</span></span>
<span class="line"><span style="color:#24292e">    } </span><span style="color:#d73a49">finally</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">        mainLock.</span><span style="color:#6f42c1">unlock</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">// Â∞ùËØïÁªàÁªìÔºå‰∏ç‰∏ÄÂÆöÊàêÂäü</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">// </span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6f42c1">tryTerminate</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">}</span></span>
<span class="line"><span style="color:#d73a49">final</span><span style="color:#24292e"> </span><span style="color:#d73a49">void</span><span style="color:#24292e"> </span><span style="color:#6f42c1">tryTerminate</span><span style="color:#24292e">() {</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">for</span><span style="color:#24292e"> (;;) {</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">int</span><span style="color:#24292e"> c </span><span style="color:#d73a49">=</span><span style="color:#24292e"> ctl.</span><span style="color:#6f42c1">get</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6a737d">// ÁªàÁªìÂ§±Ë¥•ÁöÑÊù°‰ª∂</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6a737d">// Á∫øÁ®ãÊ±†Áä∂ÊÄÅ‰∏∫RUNNING</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6a737d">// Á∫øÁ®ãÊ±†Áä∂ÊÄÅ‰∏∫ RUNNING SHUTDOWN STOP ÔºàÁä∂ÊÄÅÂÄºÂ§ß‰∫éTIDYINGÔºâ</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6a737d">// Á∫øÁ®ãÊ±†Áä∂ÊÄÅ‰∏∫SHUTDOWNÔºå‰ΩÜÈòªÂ°ûÈòüÂàó‰∏≠ËøòÊúâ‰ªªÂä°Á≠âÂæÖÊâßË°å</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (</span><span style="color:#6f42c1">isRunning</span><span style="color:#24292e">(c) </span><span style="color:#d73a49">||</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#6f42c1">runStateAtLeast</span><span style="color:#24292e">(c, TIDYING) </span><span style="color:#d73a49">||</span></span>
<span class="line"><span style="color:#24292e">            (</span><span style="color:#6f42c1">runStateOf</span><span style="color:#24292e">(c) </span><span style="color:#d73a49">==</span><span style="color:#24292e"> SHUTDOWN </span><span style="color:#d73a49">&amp;&amp;</span><span style="color:#24292e"> </span><span style="color:#d73a49">!</span><span style="color:#24292e"> workQueue.</span><span style="color:#6f42c1">isEmpty</span><span style="color:#24292e">()))</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">return</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">        </span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6a737d">// Â¶ÇÊûúÊ¥ªË∑ÉÁ∫øÁ®ãÊï∞‰∏ç‰∏∫0</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (</span><span style="color:#6f42c1">workerCountOf</span><span style="color:#24292e">(c) </span><span style="color:#d73a49">!=</span><span style="color:#24292e"> </span><span style="color:#005cc5">0</span><span style="color:#24292e">) { </span><span style="color:#6a737d">// Eligible to terminate</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#6a737d">// ‰∏≠Êñ≠Á©∫Èó≤Á∫øÁ®ã</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#6f42c1">interruptIdleWorkers</span><span style="color:#24292e">(ONLY_ONE);</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">return</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">        }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">final</span><span style="color:#24292e"> ReentrantLock mainLock </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#005cc5">this</span><span style="color:#24292e">.mainLock;</span></span>
<span class="line"><span style="color:#24292e">        mainLock.</span><span style="color:#6f42c1">lock</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">try</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#6a737d">// Â§Ñ‰∫éÂèØ‰ª•ÁªàÁªìÁöÑÁä∂ÊÄÅ</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#6a737d">// ÈÄöËøáCASÂ∞ÜÁ∫øÁ®ãÊ±†Áä∂ÊÄÅÊîπ‰∏∫TIDYING</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (ctl.</span><span style="color:#6f42c1">compareAndSet</span><span style="color:#24292e">(c, </span><span style="color:#6f42c1">ctlOf</span><span style="color:#24292e">(TIDYING, </span><span style="color:#005cc5">0</span><span style="color:#24292e">))) {</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#d73a49">try</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">                    </span><span style="color:#6f42c1">terminated</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">                } </span><span style="color:#d73a49">finally</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">                    </span><span style="color:#6a737d">// ÈÄöËøáCASÂ∞ÜÁ∫øÁ®ãÊ±†Áä∂ÊÄÅÊîπ‰∏∫TERMINATED</span></span>
<span class="line"><span style="color:#24292e">                    ctl.</span><span style="color:#6f42c1">set</span><span style="color:#24292e">(</span><span style="color:#6f42c1">ctlOf</span><span style="color:#24292e">(TERMINATED, </span><span style="color:#005cc5">0</span><span style="color:#24292e">));</span></span>
<span class="line"><span style="color:#24292e">                    termination.</span><span style="color:#6f42c1">signalAll</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">                }</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#d73a49">return</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">            }</span></span>
<span class="line"><span style="color:#24292e">        } </span><span style="color:#d73a49">finally</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">            mainLock.</span><span style="color:#6f42c1">unlock</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">        }</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6a737d">// else retry on failed CAS</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"><span style="color:#24292e">}</span></span></code></pre></div><h5 id="shutdownnow" tabindex="-1">shutdownNow() <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20advanced%20chapter#shutdownnow" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h5><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6a737d">/**</span></span>
<span class="line"><span style="color:#6a737d">* Â∞ÜÁ∫øÁ®ãÊ±†ÁöÑÁä∂ÊÄÅÊîπ‰∏∫ STOP</span></span>
<span class="line"><span style="color:#6a737d">* ‰∏çÂÜçÊé•ÂèóÊñ∞‰ªªÂä°Ôºå‰πü‰∏ç‰ºöÂú®ÊâßË°åÈòªÂ°ûÈòüÂàó‰∏≠ÁöÑ‰ªªÂä°</span></span>
<span class="line"><span style="color:#6a737d">* ‰ºöÂ∞ÜÈòªÂ°ûÈòüÂàó‰∏≠Êú™ÊâßË°åÁöÑ‰ªªÂä°ËøîÂõûÁªôË∞ÉÁî®ËÄÖ</span></span>
<span class="line"><span style="color:#6a737d">*/</span></span>
<span class="line"><span style="color:#f97583">public</span><span style="color:#e1e4e8"> List</span><span style="color:#f97583">&lt;</span><span style="color:#e1e4e8">Runnable</span><span style="color:#f97583">&gt;</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">shutdownNow</span><span style="color:#e1e4e8">() {</span></span>
<span class="line"><span style="color:#e1e4e8">    List&lt;</span><span style="color:#f97583">Runnable</span><span style="color:#e1e4e8">&gt; tasks;</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">final</span><span style="color:#e1e4e8"> ReentrantLock mainLock </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">this</span><span style="color:#e1e4e8">.mainLock;</span></span>
<span class="line"><span style="color:#e1e4e8">    mainLock.</span><span style="color:#b392f0">lock</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">try</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#b392f0">checkShutdownAccess</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">        </span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#6a737d">// ‰øÆÊîπÁä∂ÊÄÅ‰∏∫STOPÔºå‰∏çÊâßË°å‰ªª‰Ωï‰ªªÂä°</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#b392f0">advanceRunState</span><span style="color:#e1e4e8">(STOP);</span></span>
<span class="line"><span style="color:#e1e4e8">        </span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#6a737d">// ‰∏≠Êñ≠ÊâÄÊúâÁ∫øÁ®ã</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#b392f0">interruptWorkers</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">        </span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#6a737d">// Â∞ÜÊú™ÊâßË°åÁöÑ‰ªªÂä°‰ªéÈòüÂàó‰∏≠ÁßªÈô§ÔºåÁÑ∂ÂêéËøîÂõûÁªôË∞ÉÁî®ËÄÖ</span></span>
<span class="line"><span style="color:#e1e4e8">        tasks </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">drainQueue</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">    } </span><span style="color:#f97583">finally</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">        mainLock.</span><span style="color:#b392f0">unlock</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">// Â∞ùËØïÁªàÁªìÔºå‰∏ÄÂÆö‰ºöÊàêÂäüÔºåÂõ†‰∏∫ÈòªÂ°ûÈòüÂàó‰∏∫Á©∫‰∫Ü</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#b392f0">tryTerminate</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> tasks;</span></span>
<span class="line"><span style="color:#e1e4e8">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6a737d">/**</span></span>
<span class="line"><span style="color:#6a737d">* Â∞ÜÁ∫øÁ®ãÊ±†ÁöÑÁä∂ÊÄÅÊîπ‰∏∫ STOP</span></span>
<span class="line"><span style="color:#6a737d">* ‰∏çÂÜçÊé•ÂèóÊñ∞‰ªªÂä°Ôºå‰πü‰∏ç‰ºöÂú®ÊâßË°åÈòªÂ°ûÈòüÂàó‰∏≠ÁöÑ‰ªªÂä°</span></span>
<span class="line"><span style="color:#6a737d">* ‰ºöÂ∞ÜÈòªÂ°ûÈòüÂàó‰∏≠Êú™ÊâßË°åÁöÑ‰ªªÂä°ËøîÂõûÁªôË∞ÉÁî®ËÄÖ</span></span>
<span class="line"><span style="color:#6a737d">*/</span></span>
<span class="line"><span style="color:#d73a49">public</span><span style="color:#24292e"> List</span><span style="color:#d73a49">&lt;</span><span style="color:#24292e">Runnable</span><span style="color:#d73a49">&gt;</span><span style="color:#24292e"> </span><span style="color:#6f42c1">shutdownNow</span><span style="color:#24292e">() {</span></span>
<span class="line"><span style="color:#24292e">    List&lt;</span><span style="color:#d73a49">Runnable</span><span style="color:#24292e">&gt; tasks;</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">final</span><span style="color:#24292e"> ReentrantLock mainLock </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#005cc5">this</span><span style="color:#24292e">.mainLock;</span></span>
<span class="line"><span style="color:#24292e">    mainLock.</span><span style="color:#6f42c1">lock</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">try</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6f42c1">checkShutdownAccess</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">        </span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6a737d">// ‰øÆÊîπÁä∂ÊÄÅ‰∏∫STOPÔºå‰∏çÊâßË°å‰ªª‰Ωï‰ªªÂä°</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6f42c1">advanceRunState</span><span style="color:#24292e">(STOP);</span></span>
<span class="line"><span style="color:#24292e">        </span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6a737d">// ‰∏≠Êñ≠ÊâÄÊúâÁ∫øÁ®ã</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6f42c1">interruptWorkers</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">        </span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6a737d">// Â∞ÜÊú™ÊâßË°åÁöÑ‰ªªÂä°‰ªéÈòüÂàó‰∏≠ÁßªÈô§ÔºåÁÑ∂ÂêéËøîÂõûÁªôË∞ÉÁî®ËÄÖ</span></span>
<span class="line"><span style="color:#24292e">        tasks </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#6f42c1">drainQueue</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">    } </span><span style="color:#d73a49">finally</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">        mainLock.</span><span style="color:#6f42c1">unlock</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">// Â∞ùËØïÁªàÁªìÔºå‰∏ÄÂÆö‰ºöÊàêÂäüÔºåÂõ†‰∏∫ÈòªÂ°ûÈòüÂàó‰∏∫Á©∫‰∫Ü</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6f42c1">tryTerminate</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">return</span><span style="color:#24292e"> tasks;</span></span>
<span class="line"><span style="color:#24292e">}</span></span></code></pre></div><h5 id="ÂÖ∂ÂÆÉÊñπÊ≥ï" tabindex="-1">ÂÖ∂ÂÆÉÊñπÊ≥ï <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20advanced%20chapter#ÂÖ∂ÂÆÉÊñπÊ≥ï" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h5><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6a737d">// ‰∏çÂú® RUNNING Áä∂ÊÄÅÁöÑÁ∫øÁ®ãÊ±†ÔºåÊ≠§ÊñπÊ≥ïÂ∞±ËøîÂõû true</span></span>
<span class="line"><span style="color:#f97583">boolean</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">isShutdown</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#6a737d">// Á∫øÁ®ãÊ±†Áä∂ÊÄÅÊòØÂê¶ÊòØ TERMINATED</span></span>
<span class="line"><span style="color:#f97583">boolean</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">isTerminated</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#6a737d">// Ë∞ÉÁî® shutdown ÂêéÔºåÁî±‰∫éË∞ÉÁî®Á∫øÁ®ãÂπ∂‰∏ç‰ºöÁ≠âÂæÖÊâÄÊúâ‰ªªÂä°ËøêË°åÁªìÊùüÔºåÂõ†Ê≠§Â¶ÇÊûúÂÆÉÊÉ≥Âú®Á∫øÁ®ãÊ±† TERMINATED ÂêéÂÅö‰∫õ‰∫ã</span></span>
<span class="line"><span style="color:#e1e4e8">ÊÉÖÔºåÂèØ‰ª•Âà©Áî®Ê≠§ÊñπÊ≥ïÁ≠âÂæÖ</span></span>
<span class="line"><span style="color:#f97583">boolean</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">awaitTermination</span><span style="color:#e1e4e8">(</span><span style="color:#f97583">long</span><span style="color:#e1e4e8"> timeout, TimeUnit unit) throws InterruptedException;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6a737d">// ‰∏çÂú® RUNNING Áä∂ÊÄÅÁöÑÁ∫øÁ®ãÊ±†ÔºåÊ≠§ÊñπÊ≥ïÂ∞±ËøîÂõû true</span></span>
<span class="line"><span style="color:#d73a49">boolean</span><span style="color:#24292e"> </span><span style="color:#6f42c1">isShutdown</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#6a737d">// Á∫øÁ®ãÊ±†Áä∂ÊÄÅÊòØÂê¶ÊòØ TERMINATED</span></span>
<span class="line"><span style="color:#d73a49">boolean</span><span style="color:#24292e"> </span><span style="color:#6f42c1">isTerminated</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#6a737d">// Ë∞ÉÁî® shutdown ÂêéÔºåÁî±‰∫éË∞ÉÁî®Á∫øÁ®ãÂπ∂‰∏ç‰ºöÁ≠âÂæÖÊâÄÊúâ‰ªªÂä°ËøêË°åÁªìÊùüÔºåÂõ†Ê≠§Â¶ÇÊûúÂÆÉÊÉ≥Âú®Á∫øÁ®ãÊ±† TERMINATED ÂêéÂÅö‰∫õ‰∫ã</span></span>
<span class="line"><span style="color:#24292e">ÊÉÖÔºåÂèØ‰ª•Âà©Áî®Ê≠§ÊñπÊ≥ïÁ≠âÂæÖ</span></span>
<span class="line"><span style="color:#d73a49">boolean</span><span style="color:#24292e"> </span><span style="color:#6f42c1">awaitTermination</span><span style="color:#24292e">(</span><span style="color:#d73a49">long</span><span style="color:#24292e"> timeout, TimeUnit unit) throws InterruptedException;</span></span></code></pre></div><h4 id="ÂºÇÊ≠•Ê®°Âºè‰πãÂ∑•‰ΩúÁ∫øÁ®ã" tabindex="-1">ÂºÇÊ≠•Ê®°Âºè‰πãÂ∑•‰ΩúÁ∫øÁ®ã <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20advanced%20chapter#ÂºÇÊ≠•Ê®°Âºè‰πãÂ∑•‰ΩúÁ∫øÁ®ã" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h4><h5 id="ÂÆö‰πâ" tabindex="-1">ÂÆö‰πâ <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20advanced%20chapter#ÂÆö‰πâ" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h5><p>ËÆ©ÊúâÈôêÁöÑÂ∑•‰ΩúÁ∫øÁ®ãÔºàWorker ThreadÔºâÊù•ËΩÆÊµÅÂºÇÊ≠•Â§ÑÁêÜÊó†ÈôêÂ§öÁöÑ‰ªªÂä°„ÄÇ‰πüÂèØ‰ª•Â∞ÜÂÖ∂ÂΩíÁ±ª‰∏∫ÂàÜÂ∑•Ê®°ÂºèÔºåÂÆÉÁöÑÂÖ∏ÂûãÂÆûÁé∞ Â∞±ÊòØÁ∫øÁ®ãÊ±†Ôºå‰πü‰ΩìÁé∞‰∫ÜÁªèÂÖ∏ËÆæËÆ°Ê®°Âºè‰∏≠ÁöÑ‰∫´ÂÖÉÊ®°Âºè„ÄÇ</p><p>‰æãÂ¶ÇÔºåÊµ∑Â∫ïÊçûÁöÑÊúçÂä°ÂëòÔºàÁ∫øÁ®ãÔºâÔºåËΩÆÊµÅÂ§ÑÁêÜÊØè‰ΩçÂÆ¢‰∫∫ÁöÑÁÇπÈ§êÔºà‰ªªÂä°ÔºâÔºåÂ¶ÇÊûú‰∏∫ÊØè‰ΩçÂÆ¢‰∫∫ÈÉΩÈÖç‰∏ÄÂêç‰∏ìÂ±ûÁöÑÊúçÂä°ÂëòÔºåÈÇ£ ‰πàÊàêÊú¨Â∞±Â§™È´ò‰∫ÜÔºàÂØπÊØîÂè¶‰∏ÄÁßçÂ§öÁ∫øÁ®ãËÆæËÆ°Ê®°ÂºèÔºöThread-Per-MessageÔºâ Ê≥®ÊÑèÔºå‰∏çÂêå‰ªªÂä°Á±ªÂûãÂ∫îËØ•‰ΩøÁî®‰∏çÂêåÁöÑÁ∫øÁ®ãÊ±†ÔºåËøôÊ†∑ËÉΩÂ§üÈÅøÂÖçÈ••È•øÔºåÂπ∂ËÉΩÊèêÂçáÊïàÁéá ‰æãÂ¶ÇÔºåÂ¶ÇÊûú‰∏Ä‰∏™È§êÈ¶ÜÁöÑÂ∑•‰∫∫Êó¢Ë¶ÅÊãõÂëºÂÆ¢‰∫∫Ôºà‰ªªÂä°Á±ªÂûãAÔºâÔºåÂèàË¶ÅÂà∞ÂêéÂé®ÂÅöËèúÔºà‰ªªÂä°Á±ªÂûãBÔºâÊòæÁÑ∂ÊïàÁéá‰∏çÂíãÂú∞ÔºåÂàÜÊàê ÊúçÂä°ÂëòÔºàÁ∫øÁ®ãÊ±†AÔºâ‰∏éÂé®Â∏àÔºàÁ∫øÁ®ãÊ±†BÔºâÊõ¥‰∏∫ÂêàÁêÜÔºåÂΩìÁÑ∂‰Ω†ËÉΩÊÉ≥Âà∞Êõ¥ÁªÜËá¥ÁöÑÂàÜÂ∑•</p><h5 id="È••È•ø" tabindex="-1">È••È•ø <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20advanced%20chapter#È••È•ø" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h5><p>Âõ∫ÂÆöÂ§ßÂ∞èÁ∫øÁ®ãÊ±†‰ºöÊúâÈ••È•øÁé∞Ë±°</p><ul><li>‰∏§‰∏™Â∑•‰∫∫ÊòØÂêå‰∏Ä‰∏™Á∫øÁ®ãÊ±†‰∏≠ÁöÑ‰∏§‰∏™Á∫øÁ®ã</li><li>‰ªñ‰ª¨Ë¶ÅÂÅöÁöÑ‰∫ãÊÉÖÊòØÔºö‰∏∫ÂÆ¢‰∫∫ÁÇπÈ§êÂíåÂà∞ÂêéÂé®ÂÅöËèúÔºåËøôÊòØ‰∏§‰∏™Èò∂ÊÆµÁöÑÂ∑•‰Ωú<ul><li>ÂÆ¢‰∫∫ÁÇπÈ§êÔºöÂøÖÈ°ªÂÖàÁÇπÂÆåÈ§êÔºåÁ≠âËèúÂÅöÂ•ΩÔºå‰∏äËèúÔºåÂú®Ê≠§ÊúüÈó¥Â§ÑÁêÜÁÇπÈ§êÁöÑÂ∑•‰∫∫ÂøÖÈ°ªÁ≠âÂæÖ</li><li>ÂêéÂé®ÂÅöËèúÔºöÊ≤°Âï•ËØ¥ÁöÑÔºåÂÅöÂ∞±ÊòØ‰∫Ü</li></ul></li><li>ÊØîÂ¶ÇÂ∑•‰∫∫A Â§ÑÁêÜ‰∫ÜÁÇπÈ§ê‰ªªÂä°ÔºåÊé•‰∏ãÊù•ÂÆÉË¶ÅÁ≠âÁùÄ Â∑•‰∫∫B ÊääËèúÂÅöÂ•ΩÔºåÁÑ∂Âêé‰∏äËèúÔºå‰ªñ‰ø©‰πüÈÖçÂêàÁöÑËõÆÂ•Ω</li><li>‰ΩÜÁé∞Âú®ÂêåÊó∂Êù•‰∫Ü‰∏§‰∏™ÂÆ¢‰∫∫ÔºåËøô‰∏™Êó∂ÂÄôÂ∑•‰∫∫A ÂíåÂ∑•‰∫∫B ÈÉΩÂéªÂ§ÑÁêÜÁÇπÈ§ê‰∫ÜÔºåËøôÊó∂Ê≤°‰∫∫ÂÅöÈ•≠‰∫ÜÔºåÈ••È•ø</li></ul><h4 id="‰ªªÂä°Ë∞ÉÂ∫¶Á∫øÁ®ãÊ±†" tabindex="-1">‰ªªÂä°Ë∞ÉÂ∫¶Á∫øÁ®ãÊ±† <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20advanced%20chapter#‰ªªÂä°Ë∞ÉÂ∫¶Á∫øÁ®ãÊ±†" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h4><p>Âú®„Äé‰ªªÂä°Ë∞ÉÂ∫¶Á∫øÁ®ãÊ±†„ÄèÂäüËÉΩÂä†ÂÖ•‰πãÂâçÔºåÂèØ‰ª•‰ΩøÁî® java.util.Timer Êù•ÂÆûÁé∞ÂÆöÊó∂ÂäüËÉΩÔºåTimer ÁöÑ‰ºòÁÇπÂú®‰∫éÁÆÄÂçïÊòìÁî®Ôºå‰ΩÜ Áî±‰∫éÊâÄÊúâ‰ªªÂä°ÈÉΩÊòØÁî±Âêå‰∏Ä‰∏™Á∫øÁ®ãÊù•Ë∞ÉÂ∫¶ÔºåÂõ†Ê≠§ÊâÄÊúâ‰ªªÂä°ÈÉΩÊòØ‰∏≤Ë°åÊâßË°åÁöÑÔºåÂêå‰∏ÄÊó∂Èó¥Âè™ËÉΩÊúâ‰∏Ä‰∏™‰ªªÂä°Âú®ÊâßË°åÔºåÂâç‰∏Ä‰∏™ ‰ªªÂä°ÁöÑÂª∂ËøüÊàñÂºÇÂ∏∏ÈÉΩÂ∞Ü‰ºöÂΩ±ÂìçÂà∞‰πãÂêéÁöÑ‰ªªÂä°„ÄÇ</p><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">static</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">void</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">main</span><span style="color:#e1e4e8">(</span><span style="color:#f97583">String</span><span style="color:#e1e4e8">[] args) {</span></span>
<span class="line"><span style="color:#e1e4e8">    Timer timer </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Timer</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">    TimerTask task1 </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">TimerTask</span><span style="color:#e1e4e8">() {</span></span>
<span class="line"><span style="color:#e1e4e8">        @</span><span style="color:#f97583">Override</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">void</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">run</span><span style="color:#e1e4e8">() {</span></span>
<span class="line"><span style="color:#e1e4e8">            log.</span><span style="color:#b392f0">debug</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"task 1"</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#b392f0">sleep</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">2</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">        }</span></span>
<span class="line"><span style="color:#e1e4e8">    };</span></span>
<span class="line"><span style="color:#e1e4e8">    TimerTask task2 </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">TimerTask</span><span style="color:#e1e4e8">() {</span></span>
<span class="line"><span style="color:#e1e4e8">        @</span><span style="color:#f97583">Override</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">void</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">run</span><span style="color:#e1e4e8">() {</span></span>
<span class="line"><span style="color:#e1e4e8">        	log.</span><span style="color:#b392f0">debug</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"task 2"</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">        }</span></span>
<span class="line"><span style="color:#e1e4e8">    };</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">// ‰ΩøÁî® timer Ê∑ªÂä†‰∏§‰∏™‰ªªÂä°ÔºåÂ∏åÊúõÂÆÉ‰ª¨ÈÉΩÂú® 1s ÂêéÊâßË°å</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">// ‰ΩÜÁî±‰∫é timer ÂÜÖÂè™Êúâ‰∏Ä‰∏™Á∫øÁ®ãÊù•È°∫Â∫èÊâßË°åÈòüÂàó‰∏≠ÁöÑ‰ªªÂä°ÔºåÂõ†Ê≠§„Äé‰ªªÂä°1„ÄèÁöÑÂª∂Êó∂ÔºåÂΩ±Âìç‰∫Ü„Äé‰ªªÂä°2„ÄèÁöÑÊâßË°å</span></span>
<span class="line"><span style="color:#e1e4e8">    timer.</span><span style="color:#b392f0">schedule</span><span style="color:#e1e4e8">(task1, </span><span style="color:#79b8ff">1000</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">    timer.</span><span style="color:#b392f0">schedule</span><span style="color:#e1e4e8">(task2, </span><span style="color:#79b8ff">1000</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">static</span><span style="color:#24292e"> </span><span style="color:#d73a49">void</span><span style="color:#24292e"> </span><span style="color:#6f42c1">main</span><span style="color:#24292e">(</span><span style="color:#d73a49">String</span><span style="color:#24292e">[] args) {</span></span>
<span class="line"><span style="color:#24292e">    Timer timer </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Timer</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">    TimerTask task1 </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">TimerTask</span><span style="color:#24292e">() {</span></span>
<span class="line"><span style="color:#24292e">        @</span><span style="color:#d73a49">Override</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">void</span><span style="color:#24292e"> </span><span style="color:#6f42c1">run</span><span style="color:#24292e">() {</span></span>
<span class="line"><span style="color:#24292e">            log.</span><span style="color:#6f42c1">debug</span><span style="color:#24292e">(</span><span style="color:#032f62">"task 1"</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#6f42c1">sleep</span><span style="color:#24292e">(</span><span style="color:#005cc5">2</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">        }</span></span>
<span class="line"><span style="color:#24292e">    };</span></span>
<span class="line"><span style="color:#24292e">    TimerTask task2 </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">TimerTask</span><span style="color:#24292e">() {</span></span>
<span class="line"><span style="color:#24292e">        @</span><span style="color:#d73a49">Override</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">void</span><span style="color:#24292e"> </span><span style="color:#6f42c1">run</span><span style="color:#24292e">() {</span></span>
<span class="line"><span style="color:#24292e">        	log.</span><span style="color:#6f42c1">debug</span><span style="color:#24292e">(</span><span style="color:#032f62">"task 2"</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">        }</span></span>
<span class="line"><span style="color:#24292e">    };</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">// ‰ΩøÁî® timer Ê∑ªÂä†‰∏§‰∏™‰ªªÂä°ÔºåÂ∏åÊúõÂÆÉ‰ª¨ÈÉΩÂú® 1s ÂêéÊâßË°å</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">// ‰ΩÜÁî±‰∫é timer ÂÜÖÂè™Êúâ‰∏Ä‰∏™Á∫øÁ®ãÊù•È°∫Â∫èÊâßË°åÈòüÂàó‰∏≠ÁöÑ‰ªªÂä°ÔºåÂõ†Ê≠§„Äé‰ªªÂä°1„ÄèÁöÑÂª∂Êó∂ÔºåÂΩ±Âìç‰∫Ü„Äé‰ªªÂä°2„ÄèÁöÑÊâßË°å</span></span>
<span class="line"><span style="color:#24292e">    timer.</span><span style="color:#6f42c1">schedule</span><span style="color:#24292e">(task1, </span><span style="color:#005cc5">1000</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">    timer.</span><span style="color:#6f42c1">schedule</span><span style="color:#24292e">(task2, </span><span style="color:#005cc5">1000</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">}</span></span></code></pre></div><figure><img src="https://jsd.cdn.zzko.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230719143233884.png" alt="image-20230719143233884" loading="lazy" decoding="async"></figure><p>‰ΩøÁî® ScheduledExecutorService ÊîπÂÜôÔºö</p><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8">ScheduledExecutorService executor </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> Executors.</span><span style="color:#b392f0">newScheduledThreadPool</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">2</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#6a737d">// Ê∑ªÂä†‰∏§‰∏™‰ªªÂä°ÔºåÂ∏åÊúõÂÆÉ‰ª¨ÈÉΩÂú® 1s ÂêéÊâßË°å</span></span>
<span class="line"><span style="color:#e1e4e8">executor.</span><span style="color:#b392f0">schedule</span><span style="color:#e1e4e8">(() </span><span style="color:#f97583">-&gt;</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">System.out.</span><span style="color:#b392f0">println</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"‰ªªÂä°1ÔºåÊâßË°åÊó∂Èó¥Ôºö"</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">+</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Date</span><span style="color:#e1e4e8">());</span></span>
<span class="line"><span style="color:#f97583">try</span><span style="color:#e1e4e8"> { Thread.</span><span style="color:#b392f0">sleep</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">2000</span><span style="color:#e1e4e8">); } </span><span style="color:#f97583">catch</span><span style="color:#e1e4e8"> (InterruptedException </span><span style="color:#ffab70">e</span><span style="color:#e1e4e8">) { }</span></span>
<span class="line"><span style="color:#e1e4e8">}, </span><span style="color:#79b8ff">1000</span><span style="color:#e1e4e8">, TimeUnit.MILLISECONDS);</span></span>
<span class="line"><span style="color:#e1e4e8">executor.</span><span style="color:#b392f0">schedule</span><span style="color:#e1e4e8">(() </span><span style="color:#f97583">-&gt;</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">System.out.</span><span style="color:#b392f0">println</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"‰ªªÂä°2ÔºåÊâßË°åÊó∂Èó¥Ôºö"</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">+</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Date</span><span style="color:#e1e4e8">());</span></span>
<span class="line"><span style="color:#e1e4e8">}, </span><span style="color:#79b8ff">1000</span><span style="color:#e1e4e8">, TimeUnit.MILLISECONDS);</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e">ScheduledExecutorService executor </span><span style="color:#d73a49">=</span><span style="color:#24292e"> Executors.</span><span style="color:#6f42c1">newScheduledThreadPool</span><span style="color:#24292e">(</span><span style="color:#005cc5">2</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#6a737d">// Ê∑ªÂä†‰∏§‰∏™‰ªªÂä°ÔºåÂ∏åÊúõÂÆÉ‰ª¨ÈÉΩÂú® 1s ÂêéÊâßË°å</span></span>
<span class="line"><span style="color:#24292e">executor.</span><span style="color:#6f42c1">schedule</span><span style="color:#24292e">(() </span><span style="color:#d73a49">-&gt;</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">System.out.</span><span style="color:#6f42c1">println</span><span style="color:#24292e">(</span><span style="color:#032f62">"‰ªªÂä°1ÔºåÊâßË°åÊó∂Èó¥Ôºö"</span><span style="color:#24292e"> </span><span style="color:#d73a49">+</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Date</span><span style="color:#24292e">());</span></span>
<span class="line"><span style="color:#d73a49">try</span><span style="color:#24292e"> { Thread.</span><span style="color:#6f42c1">sleep</span><span style="color:#24292e">(</span><span style="color:#005cc5">2000</span><span style="color:#24292e">); } </span><span style="color:#d73a49">catch</span><span style="color:#24292e"> (InterruptedException </span><span style="color:#e36209">e</span><span style="color:#24292e">) { }</span></span>
<span class="line"><span style="color:#24292e">}, </span><span style="color:#005cc5">1000</span><span style="color:#24292e">, TimeUnit.MILLISECONDS);</span></span>
<span class="line"><span style="color:#24292e">executor.</span><span style="color:#6f42c1">schedule</span><span style="color:#24292e">(() </span><span style="color:#d73a49">-&gt;</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">System.out.</span><span style="color:#6f42c1">println</span><span style="color:#24292e">(</span><span style="color:#032f62">"‰ªªÂä°2ÔºåÊâßË°åÊó∂Èó¥Ôºö"</span><span style="color:#24292e"> </span><span style="color:#d73a49">+</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Date</span><span style="color:#24292e">());</span></span>
<span class="line"><span style="color:#24292e">}, </span><span style="color:#005cc5">1000</span><span style="color:#24292e">, TimeUnit.MILLISECONDS);</span></span></code></pre></div><figure><img src="https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230719142957233.png" alt="image-20230719142957233" loading="lazy" decoding="async"></figure><p>scheduleAtFixedRate ‰æãÂ≠êÔºö</p><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8">ScheduledExecutorService pool </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> Executors.</span><span style="color:#b392f0">newScheduledThreadPool</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">1</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">log.</span><span style="color:#b392f0">debug</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"start..."</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">pool.</span><span style="color:#b392f0">scheduleAtFixedRate</span><span style="color:#e1e4e8">(() </span><span style="color:#f97583">-&gt;</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">log.</span><span style="color:#b392f0">debug</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"running..."</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">}, </span><span style="color:#79b8ff">1</span><span style="color:#e1e4e8">, </span><span style="color:#79b8ff">1</span><span style="color:#e1e4e8">, TimeUnit.SECONDS);</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e">ScheduledExecutorService pool </span><span style="color:#d73a49">=</span><span style="color:#24292e"> Executors.</span><span style="color:#6f42c1">newScheduledThreadPool</span><span style="color:#24292e">(</span><span style="color:#005cc5">1</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">log.</span><span style="color:#6f42c1">debug</span><span style="color:#24292e">(</span><span style="color:#032f62">"start..."</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">pool.</span><span style="color:#6f42c1">scheduleAtFixedRate</span><span style="color:#24292e">(() </span><span style="color:#d73a49">-&gt;</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">log.</span><span style="color:#6f42c1">debug</span><span style="color:#24292e">(</span><span style="color:#032f62">"running..."</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">}, </span><span style="color:#005cc5">1</span><span style="color:#24292e">, </span><span style="color:#005cc5">1</span><span style="color:#24292e">, TimeUnit.SECONDS);</span></span></code></pre></div><figure><img src="https://jsd.cdn.zzko.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230719143007433.png" alt="image-20230719143007433" loading="lazy" decoding="async"></figure><p>scheduleAtFixedRate ‰æãÂ≠êÔºà‰ªªÂä°ÊâßË°åÊó∂Èó¥Ë∂ÖËøá‰∫ÜÈó¥ÈöîÊó∂Èó¥ÔºâÔºö</p><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8">ScheduledExecutorService pool </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> Executors.</span><span style="color:#b392f0">newScheduledThreadPool</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">1</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">log.</span><span style="color:#b392f0">debug</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"start..."</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">pool.</span><span style="color:#b392f0">scheduleAtFixedRate</span><span style="color:#e1e4e8">(() </span><span style="color:#f97583">-&gt;</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">log.</span><span style="color:#b392f0">debug</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"running..."</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#b392f0">sleep</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">2</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">}, </span><span style="color:#79b8ff">1</span><span style="color:#e1e4e8">, </span><span style="color:#79b8ff">1</span><span style="color:#e1e4e8">, TimeUnit.SECONDS);</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e">ScheduledExecutorService pool </span><span style="color:#d73a49">=</span><span style="color:#24292e"> Executors.</span><span style="color:#6f42c1">newScheduledThreadPool</span><span style="color:#24292e">(</span><span style="color:#005cc5">1</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">log.</span><span style="color:#6f42c1">debug</span><span style="color:#24292e">(</span><span style="color:#032f62">"start..."</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">pool.</span><span style="color:#6f42c1">scheduleAtFixedRate</span><span style="color:#24292e">(() </span><span style="color:#d73a49">-&gt;</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">log.</span><span style="color:#6f42c1">debug</span><span style="color:#24292e">(</span><span style="color:#032f62">"running..."</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#6f42c1">sleep</span><span style="color:#24292e">(</span><span style="color:#005cc5">2</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">}, </span><span style="color:#005cc5">1</span><span style="color:#24292e">, </span><span style="color:#005cc5">1</span><span style="color:#24292e">, TimeUnit.SECONDS);</span></span></code></pre></div><figure><img src="https://jsd.cdn.zzko.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230719143045966.png" alt="image-20230719143045966" loading="lazy" decoding="async"></figure><p>scheduleWithFixedDelay ‰æãÂ≠êÔºö</p><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8">ScheduledExecutorService pool </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> Executors.</span><span style="color:#b392f0">newScheduledThreadPool</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">1</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">log.</span><span style="color:#b392f0">debug</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"start..."</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">pool.</span><span style="color:#b392f0">scheduleWithFixedDelay</span><span style="color:#e1e4e8">(()</span><span style="color:#f97583">-&gt;</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">log.</span><span style="color:#b392f0">debug</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"running..."</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#b392f0">sleep</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">2</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">}, </span><span style="color:#79b8ff">1</span><span style="color:#e1e4e8">, </span><span style="color:#79b8ff">1</span><span style="color:#e1e4e8">, TimeUnit.SECONDS);</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e">ScheduledExecutorService pool </span><span style="color:#d73a49">=</span><span style="color:#24292e"> Executors.</span><span style="color:#6f42c1">newScheduledThreadPool</span><span style="color:#24292e">(</span><span style="color:#005cc5">1</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">log.</span><span style="color:#6f42c1">debug</span><span style="color:#24292e">(</span><span style="color:#032f62">"start..."</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">pool.</span><span style="color:#6f42c1">scheduleWithFixedDelay</span><span style="color:#24292e">(()</span><span style="color:#d73a49">-&gt;</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">log.</span><span style="color:#6f42c1">debug</span><span style="color:#24292e">(</span><span style="color:#032f62">"running..."</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#6f42c1">sleep</span><span style="color:#24292e">(</span><span style="color:#005cc5">2</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">}, </span><span style="color:#005cc5">1</span><span style="color:#24292e">, </span><span style="color:#005cc5">1</span><span style="color:#24292e">, TimeUnit.SECONDS);</span></span></code></pre></div><figure><img src="https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230719143116176.png" alt="image-20230719143116176" loading="lazy" decoding="async"></figure><blockquote><p><strong>ËØÑ‰ª∑</strong> Êï¥‰∏™Á∫øÁ®ãÊ±†Ë°®Áé∞‰∏∫ÔºöÁ∫øÁ®ãÊï∞Âõ∫ÂÆöÔºå‰ªªÂä°Êï∞Â§ö‰∫éÁ∫øÁ®ãÊï∞Êó∂Ôºå‰ºöÊîæÂÖ•Êó†ÁïåÈòüÂàóÊéíÈòü„ÄÇ‰ªªÂä°ÊâßË°åÂÆåÊØïÔºåËøô‰∫õÁ∫ø Á®ã‰πü‰∏ç‰ºöË¢´ÈáäÊîæ„ÄÇÁî®Êù•ÊâßË°åÂª∂ËøüÊàñÂèçÂ§çÊâßË°åÁöÑ‰ªªÂä°</p></blockquote><h4 id="Ê≠£Á°ÆÂ§ÑÁêÜÊâßË°å‰ªªÂä°ÂºÇÂ∏∏" tabindex="-1">Ê≠£Á°ÆÂ§ÑÁêÜÊâßË°å‰ªªÂä°ÂºÇÂ∏∏ <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20advanced%20chapter#Ê≠£Á°ÆÂ§ÑÁêÜÊâßË°å‰ªªÂä°ÂºÇÂ∏∏" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h4><p>ÂèØ‰ª•ÂèëÁé∞ÔºåÂ¶ÇÊûúÁ∫øÁ®ãÊ±†‰∏≠ÁöÑÁ∫øÁ®ãÊâßË°å‰ªªÂä°Êó∂ÔºåÂ¶ÇÊûú‰ªªÂä°ÊäõÂá∫‰∫ÜÂºÇÂ∏∏ÔºåÈªòËÆ§ÊòØ‰∏≠Êñ≠ÊâßË°åËØ•‰ªªÂä°ËÄå‰∏çÊòØÊäõÂá∫ÂºÇÂ∏∏ÊàñËÄÖÊâìÂç∞ÂºÇÂ∏∏‰ø°ÊÅØ„ÄÇ</p><p>ÊñπÊ≥ï1Ôºö‰∏ªÂä®ÊçâÂºÇÂ∏∏</p><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8">ExecutorService pool </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> Executors.</span><span style="color:#b392f0">newFixedThreadPool</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">1</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">pool.</span><span style="color:#b392f0">submit</span><span style="color:#e1e4e8">(() </span><span style="color:#f97583">-&gt;</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8"> </span><span style="color:#f97583">try</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8"> log.</span><span style="color:#b392f0">debug</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"task1"</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8"> </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> i </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">1</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">/</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8"> } </span><span style="color:#f97583">catch</span><span style="color:#e1e4e8"> (Exception </span><span style="color:#ffab70">e</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8"> log.</span><span style="color:#b392f0">error</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"error:"</span><span style="color:#e1e4e8">, e);</span></span>
<span class="line"><span style="color:#e1e4e8"> }</span></span>
<span class="line"><span style="color:#e1e4e8">});</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e">ExecutorService pool </span><span style="color:#d73a49">=</span><span style="color:#24292e"> Executors.</span><span style="color:#6f42c1">newFixedThreadPool</span><span style="color:#24292e">(</span><span style="color:#005cc5">1</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">pool.</span><span style="color:#6f42c1">submit</span><span style="color:#24292e">(() </span><span style="color:#d73a49">-&gt;</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e"> </span><span style="color:#d73a49">try</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e"> log.</span><span style="color:#6f42c1">debug</span><span style="color:#24292e">(</span><span style="color:#032f62">"task1"</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e"> </span><span style="color:#d73a49">int</span><span style="color:#24292e"> i </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#005cc5">1</span><span style="color:#24292e"> </span><span style="color:#d73a49">/</span><span style="color:#24292e"> </span><span style="color:#005cc5">0</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e"> } </span><span style="color:#d73a49">catch</span><span style="color:#24292e"> (Exception </span><span style="color:#e36209">e</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e"> log.</span><span style="color:#6f42c1">error</span><span style="color:#24292e">(</span><span style="color:#032f62">"error:"</span><span style="color:#24292e">, e);</span></span>
<span class="line"><span style="color:#24292e"> }</span></span>
<span class="line"><span style="color:#24292e">});</span></span></code></pre></div><p>ÊñπÊ≥ï2Ôºö‰ΩøÁî® FutureÔºåÈîôËØØ‰ø°ÊÅØÈÉΩË¢´Â∞ÅË£ÖËøõsubmitÊñπÊ≥ïÁöÑËøîÂõûÊñπÊ≥ï‰∏≠ÔºÅ</p><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8">ExecutorService pool </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> Executors.</span><span style="color:#b392f0">newFixedThreadPool</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">1</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">Future&lt;</span><span style="color:#f97583">Boolean</span><span style="color:#e1e4e8">&gt; f </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> pool.</span><span style="color:#b392f0">submit</span><span style="color:#e1e4e8">(() </span><span style="color:#f97583">-&gt;</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8"> log.</span><span style="color:#b392f0">debug</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"task1"</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8"> </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> i </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">1</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">/</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8"> </span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">true</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">});</span></span>
<span class="line"><span style="color:#e1e4e8">log.</span><span style="color:#b392f0">debug</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"result:{}"</span><span style="color:#e1e4e8">, f.</span><span style="color:#b392f0">get</span><span style="color:#e1e4e8">());</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e">ExecutorService pool </span><span style="color:#d73a49">=</span><span style="color:#24292e"> Executors.</span><span style="color:#6f42c1">newFixedThreadPool</span><span style="color:#24292e">(</span><span style="color:#005cc5">1</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">Future&lt;</span><span style="color:#d73a49">Boolean</span><span style="color:#24292e">&gt; f </span><span style="color:#d73a49">=</span><span style="color:#24292e"> pool.</span><span style="color:#6f42c1">submit</span><span style="color:#24292e">(() </span><span style="color:#d73a49">-&gt;</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e"> log.</span><span style="color:#6f42c1">debug</span><span style="color:#24292e">(</span><span style="color:#032f62">"task1"</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e"> </span><span style="color:#d73a49">int</span><span style="color:#24292e"> i </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#005cc5">1</span><span style="color:#24292e"> </span><span style="color:#d73a49">/</span><span style="color:#24292e"> </span><span style="color:#005cc5">0</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e"> </span><span style="color:#d73a49">return</span><span style="color:#24292e"> </span><span style="color:#005cc5">true</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">});</span></span>
<span class="line"><span style="color:#24292e">log.</span><span style="color:#6f42c1">debug</span><span style="color:#24292e">(</span><span style="color:#032f62">"result:{}"</span><span style="color:#24292e">, f.</span><span style="color:#6f42c1">get</span><span style="color:#24292e">());</span></span></code></pre></div><h4 id="ÂÆöÊó∂" tabindex="-1">ÂÆöÊó∂ <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20advanced%20chapter#ÂÆöÊó∂" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h4><h5 id="ÂÆöÊúüÊâßË°å" tabindex="-1">ÂÆöÊúüÊâßË°å <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20advanced%20chapter#ÂÆöÊúüÊâßË°å" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h5><p>Â¶Ç‰ΩïËÆ©ÊØèÂë®Âõõ 18:00:00 ÂÆöÊó∂ÊâßË°å‰ªªÂä°Ôºü</p><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6a737d">// Ëé∑ÂæóÂΩìÂâçÊó∂Èó¥</span></span>
<span class="line"><span style="color:#e1e4e8">LocalDateTime now </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> LocalDateTime.</span><span style="color:#b392f0">now</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#6a737d">// Ëé∑ÂèñÊú¨Âë®Âõõ 18:00:00.000</span></span>
<span class="line"><span style="color:#e1e4e8">LocalDateTime thursday </span><span style="color:#f97583">=</span></span>
<span class="line"><span style="color:#e1e4e8">now.</span><span style="color:#b392f0">with</span><span style="color:#e1e4e8">(DayOfWeek.THURSDAY).</span><span style="color:#b392f0">withHour</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">18</span><span style="color:#e1e4e8">).</span><span style="color:#b392f0">withMinute</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8">).</span><span style="color:#b392f0">withSecond</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8">).</span><span style="color:#b392f0">withNano</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#6a737d">// Â¶ÇÊûúÂΩìÂâçÊó∂Èó¥Â∑≤ÁªèË∂ÖËøá Êú¨Âë®Âõõ 18:00:00.000Ôºå ÈÇ£‰πàÊâæ‰∏ãÂë®Âõõ 18:00:00.000</span></span>
<span class="line"><span style="color:#f97583">if</span><span style="color:#e1e4e8">(now.</span><span style="color:#b392f0">compareTo</span><span style="color:#e1e4e8">(thursday) </span><span style="color:#f97583">&gt;=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">thursday </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> thursday.</span><span style="color:#b392f0">plusWeeks</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">1</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">}</span></span>
<span class="line"><span style="color:#6a737d">// ËÆ°ÁÆóÊó∂Èó¥Â∑ÆÔºåÂç≥Âª∂Êó∂ÊâßË°åÊó∂Èó¥</span></span>
<span class="line"><span style="color:#f97583">long</span><span style="color:#e1e4e8"> initialDelay </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> Duration.</span><span style="color:#b392f0">between</span><span style="color:#e1e4e8">(now, thursday).</span><span style="color:#b392f0">toMillis</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#6a737d">// ËÆ°ÁÆóÈó¥ÈöîÊó∂Èó¥ÔºåÂç≥ 1 Âë®ÁöÑÊØ´ÁßíÂÄº</span></span>
<span class="line"><span style="color:#f97583">long</span><span style="color:#e1e4e8"> oneWeek </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">7</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">*</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">24</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">*</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">3600</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">*</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">1000</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">ScheduledExecutorService executor </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> Executors.</span><span style="color:#b392f0">newScheduledThreadPool</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">2</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">System.out.</span><span style="color:#b392f0">println</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"ÂºÄÂßãÊó∂Èó¥Ôºö"</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">+</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Date</span><span style="color:#e1e4e8">());</span></span>
<span class="line"><span style="color:#e1e4e8">executor.</span><span style="color:#b392f0">scheduleAtFixedRate</span><span style="color:#e1e4e8">(() </span><span style="color:#f97583">-&gt;</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">System.out.</span><span style="color:#b392f0">println</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"ÊâßË°åÊó∂Èó¥Ôºö"</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">+</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Date</span><span style="color:#e1e4e8">());</span></span>
<span class="line"><span style="color:#e1e4e8">}, initialDelay, oneWeek, TimeUnit.MILLISECONDS);</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6a737d">// Ëé∑ÂæóÂΩìÂâçÊó∂Èó¥</span></span>
<span class="line"><span style="color:#24292e">LocalDateTime now </span><span style="color:#d73a49">=</span><span style="color:#24292e"> LocalDateTime.</span><span style="color:#6f42c1">now</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#6a737d">// Ëé∑ÂèñÊú¨Âë®Âõõ 18:00:00.000</span></span>
<span class="line"><span style="color:#24292e">LocalDateTime thursday </span><span style="color:#d73a49">=</span></span>
<span class="line"><span style="color:#24292e">now.</span><span style="color:#6f42c1">with</span><span style="color:#24292e">(DayOfWeek.THURSDAY).</span><span style="color:#6f42c1">withHour</span><span style="color:#24292e">(</span><span style="color:#005cc5">18</span><span style="color:#24292e">).</span><span style="color:#6f42c1">withMinute</span><span style="color:#24292e">(</span><span style="color:#005cc5">0</span><span style="color:#24292e">).</span><span style="color:#6f42c1">withSecond</span><span style="color:#24292e">(</span><span style="color:#005cc5">0</span><span style="color:#24292e">).</span><span style="color:#6f42c1">withNano</span><span style="color:#24292e">(</span><span style="color:#005cc5">0</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#6a737d">// Â¶ÇÊûúÂΩìÂâçÊó∂Èó¥Â∑≤ÁªèË∂ÖËøá Êú¨Âë®Âõõ 18:00:00.000Ôºå ÈÇ£‰πàÊâæ‰∏ãÂë®Âõõ 18:00:00.000</span></span>
<span class="line"><span style="color:#d73a49">if</span><span style="color:#24292e">(now.</span><span style="color:#6f42c1">compareTo</span><span style="color:#24292e">(thursday) </span><span style="color:#d73a49">&gt;=</span><span style="color:#24292e"> </span><span style="color:#005cc5">0</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">thursday </span><span style="color:#d73a49">=</span><span style="color:#24292e"> thursday.</span><span style="color:#6f42c1">plusWeeks</span><span style="color:#24292e">(</span><span style="color:#005cc5">1</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">}</span></span>
<span class="line"><span style="color:#6a737d">// ËÆ°ÁÆóÊó∂Èó¥Â∑ÆÔºåÂç≥Âª∂Êó∂ÊâßË°åÊó∂Èó¥</span></span>
<span class="line"><span style="color:#d73a49">long</span><span style="color:#24292e"> initialDelay </span><span style="color:#d73a49">=</span><span style="color:#24292e"> Duration.</span><span style="color:#6f42c1">between</span><span style="color:#24292e">(now, thursday).</span><span style="color:#6f42c1">toMillis</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#6a737d">// ËÆ°ÁÆóÈó¥ÈöîÊó∂Èó¥ÔºåÂç≥ 1 Âë®ÁöÑÊØ´ÁßíÂÄº</span></span>
<span class="line"><span style="color:#d73a49">long</span><span style="color:#24292e"> oneWeek </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#005cc5">7</span><span style="color:#24292e"> </span><span style="color:#d73a49">*</span><span style="color:#24292e"> </span><span style="color:#005cc5">24</span><span style="color:#24292e"> </span><span style="color:#d73a49">*</span><span style="color:#24292e"> </span><span style="color:#005cc5">3600</span><span style="color:#24292e"> </span><span style="color:#d73a49">*</span><span style="color:#24292e"> </span><span style="color:#005cc5">1000</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">ScheduledExecutorService executor </span><span style="color:#d73a49">=</span><span style="color:#24292e"> Executors.</span><span style="color:#6f42c1">newScheduledThreadPool</span><span style="color:#24292e">(</span><span style="color:#005cc5">2</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">System.out.</span><span style="color:#6f42c1">println</span><span style="color:#24292e">(</span><span style="color:#032f62">"ÂºÄÂßãÊó∂Èó¥Ôºö"</span><span style="color:#24292e"> </span><span style="color:#d73a49">+</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Date</span><span style="color:#24292e">());</span></span>
<span class="line"><span style="color:#24292e">executor.</span><span style="color:#6f42c1">scheduleAtFixedRate</span><span style="color:#24292e">(() </span><span style="color:#d73a49">-&gt;</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">System.out.</span><span style="color:#6f42c1">println</span><span style="color:#24292e">(</span><span style="color:#032f62">"ÊâßË°åÊó∂Èó¥Ôºö"</span><span style="color:#24292e"> </span><span style="color:#d73a49">+</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Date</span><span style="color:#24292e">());</span></span>
<span class="line"><span style="color:#24292e">}, initialDelay, oneWeek, TimeUnit.MILLISECONDS);</span></span></code></pre></div><h4 id="tomcat-Á∫øÁ®ãÊ±†" tabindex="-1">Tomcat Á∫øÁ®ãÊ±† <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20advanced%20chapter#tomcat-Á∫øÁ®ãÊ±†" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h4><p>Tomcat Âú®Âì™ÈáåÁî®Âà∞‰∫ÜÁ∫øÁ®ãÊ±†Âë¢</p><figure><img src="https://jsd.cdn.zzko.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230719150054370.png" alt="image-20230719150054370" loading="lazy" decoding="async"></figure><ol><li>LimitLatch Áî®Êù•ÈôêÊµÅÔºåÂèØ‰ª•ÊéßÂà∂ÊúÄÂ§ßËøûÊé•‰∏™Êï∞ÔºåÁ±ª‰ºº J.U.C ‰∏≠ÁöÑ Semaphore ÂêéÈù¢ÂÜçËÆ≤</li><li>Acceptor Âè™Ë¥üË¥£„ÄêÊé•Êî∂Êñ∞ÁöÑ socket ËøûÊé•„Äë</li><li>Poller Âè™Ë¥üË¥£ÁõëÂê¨ socket channel ÊòØÂê¶Êúâ„ÄêÂèØËØªÁöÑ I/O ‰∫ã‰ª∂„Äë</li><li>‰∏ÄÊó¶ÂèØËØªÔºåÂ∞ÅË£Ö‰∏Ä‰∏™‰ªªÂä°ÂØπË±°ÔºàsocketProcessorÔºâÔºåÊèê‰∫§Áªô Executor Á∫øÁ®ãÊ±†Â§ÑÁêÜ</li><li>Executor Á∫øÁ®ãÊ±†‰∏≠ÁöÑÂ∑•‰ΩúÁ∫øÁ®ãÊúÄÁªàË¥üË¥£„ÄêÂ§ÑÁêÜËØ∑Ê±Ç„Äë</li></ol><p>Tomcat Á∫øÁ®ãÊ±†Êâ©Â±ï‰∫Ü ThreadPoolExecutorÔºåË°å‰∏∫Á®çÊúâ‰∏çÂêå</p><ol><li>Â¶ÇÊûúÊÄªÁ∫øÁ®ãÊï∞ËææÂà∞ maximumPoolSizeÔºåËøôÊó∂‰∏ç‰ºöÁ´ãÂàªÊäõ RejectedExecutionException ÂºÇÂ∏∏ÔºåËÄåÊòØÂÜçÊ¨°Â∞ùËØïÂ∞Ü‰ªªÂä°ÊîæÂÖ•ÈòüÂàóÔºåÂ¶ÇÊûúËøòÂ§±Ë¥•ÔºåÊâçÊäõÂá∫ RejectedExecutionException ÂºÇÂ∏∏</li></ol><p>Ê∫êÁ†Å tomcat-7.0.42</p><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">void</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">execute</span><span style="color:#e1e4e8">(Runnable command, </span><span style="color:#f97583">long</span><span style="color:#e1e4e8"> timeout, TimeUnit unit) {</span></span>
<span class="line"><span style="color:#e1e4e8">        submittedCount.</span><span style="color:#b392f0">incrementAndGet</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">try</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#79b8ff">super</span><span style="color:#e1e4e8">.</span><span style="color:#b392f0">execute</span><span style="color:#e1e4e8">(command);</span></span>
<span class="line"><span style="color:#e1e4e8">        } </span><span style="color:#f97583">catch</span><span style="color:#e1e4e8"> (RejectedExecutionException </span><span style="color:#ffab70">rx</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (</span><span style="color:#79b8ff">super</span><span style="color:#e1e4e8">.</span><span style="color:#b392f0">getQueue</span><span style="color:#e1e4e8">() </span><span style="color:#f97583">instanceof</span><span style="color:#e1e4e8"> TaskQueue) {</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#f97583">final</span><span style="color:#e1e4e8"> TaskQueue queue </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> (TaskQueue)</span><span style="color:#79b8ff">super</span><span style="color:#e1e4e8">.</span><span style="color:#b392f0">getQueue</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#f97583">try</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">                    </span><span style="color:#6a737d">// ‰Ωø‰ªªÂä°‰ªéÊñ∞ËøõÂÖ•ÈòªÂ°ûÈòüÂàó</span></span>
<span class="line"><span style="color:#e1e4e8">                    </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (</span><span style="color:#f97583">!</span><span style="color:#e1e4e8">queue.</span><span style="color:#b392f0">force</span><span style="color:#e1e4e8">(command, timeout, unit)) {</span></span>
<span class="line"><span style="color:#e1e4e8">                        submittedCount.</span><span style="color:#b392f0">decrementAndGet</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">                        </span><span style="color:#f97583">throw</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">RejectedExecutionException</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"Queue capacity is full."</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">                    }</span></span>
<span class="line"><span style="color:#e1e4e8">                } </span><span style="color:#f97583">catch</span><span style="color:#e1e4e8"> (InterruptedException </span><span style="color:#ffab70">x</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">                    submittedCount.</span><span style="color:#b392f0">decrementAndGet</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">                    Thread.</span><span style="color:#b392f0">interrupted</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">                    </span><span style="color:#f97583">throw</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">RejectedExecutionException</span><span style="color:#e1e4e8">(x);</span></span>
<span class="line"><span style="color:#e1e4e8">                }</span></span>
<span class="line"><span style="color:#e1e4e8">            } </span><span style="color:#f97583">else</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">                submittedCount.</span><span style="color:#b392f0">decrementAndGet</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#f97583">throw</span><span style="color:#e1e4e8"> rx;</span></span>
<span class="line"><span style="color:#e1e4e8">            }</span></span>
<span class="line"><span style="color:#e1e4e8">        }</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">void</span><span style="color:#24292e"> </span><span style="color:#6f42c1">execute</span><span style="color:#24292e">(Runnable command, </span><span style="color:#d73a49">long</span><span style="color:#24292e"> timeout, TimeUnit unit) {</span></span>
<span class="line"><span style="color:#24292e">        submittedCount.</span><span style="color:#6f42c1">incrementAndGet</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">try</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#005cc5">super</span><span style="color:#24292e">.</span><span style="color:#6f42c1">execute</span><span style="color:#24292e">(command);</span></span>
<span class="line"><span style="color:#24292e">        } </span><span style="color:#d73a49">catch</span><span style="color:#24292e"> (RejectedExecutionException </span><span style="color:#e36209">rx</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (</span><span style="color:#005cc5">super</span><span style="color:#24292e">.</span><span style="color:#6f42c1">getQueue</span><span style="color:#24292e">() </span><span style="color:#d73a49">instanceof</span><span style="color:#24292e"> TaskQueue) {</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#d73a49">final</span><span style="color:#24292e"> TaskQueue queue </span><span style="color:#d73a49">=</span><span style="color:#24292e"> (TaskQueue)</span><span style="color:#005cc5">super</span><span style="color:#24292e">.</span><span style="color:#6f42c1">getQueue</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#d73a49">try</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">                    </span><span style="color:#6a737d">// ‰Ωø‰ªªÂä°‰ªéÊñ∞ËøõÂÖ•ÈòªÂ°ûÈòüÂàó</span></span>
<span class="line"><span style="color:#24292e">                    </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (</span><span style="color:#d73a49">!</span><span style="color:#24292e">queue.</span><span style="color:#6f42c1">force</span><span style="color:#24292e">(command, timeout, unit)) {</span></span>
<span class="line"><span style="color:#24292e">                        submittedCount.</span><span style="color:#6f42c1">decrementAndGet</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">                        </span><span style="color:#d73a49">throw</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">RejectedExecutionException</span><span style="color:#24292e">(</span><span style="color:#032f62">"Queue capacity is full."</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">                    }</span></span>
<span class="line"><span style="color:#24292e">                } </span><span style="color:#d73a49">catch</span><span style="color:#24292e"> (InterruptedException </span><span style="color:#e36209">x</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">                    submittedCount.</span><span style="color:#6f42c1">decrementAndGet</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">                    Thread.</span><span style="color:#6f42c1">interrupted</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">                    </span><span style="color:#d73a49">throw</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">RejectedExecutionException</span><span style="color:#24292e">(x);</span></span>
<span class="line"><span style="color:#24292e">                }</span></span>
<span class="line"><span style="color:#24292e">            } </span><span style="color:#d73a49">else</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">                submittedCount.</span><span style="color:#6f42c1">decrementAndGet</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#d73a49">throw</span><span style="color:#24292e"> rx;</span></span>
<span class="line"><span style="color:#24292e">            }</span></span>
<span class="line"><span style="color:#24292e">        }</span></span>
<span class="line"><span style="color:#24292e">    }</span></span></code></pre></div><p>TaskQueue.java</p><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">boolean</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">force</span><span style="color:#e1e4e8">(Runnable o, </span><span style="color:#f97583">long</span><span style="color:#e1e4e8"> timeout, TimeUnit unit) throws InterruptedException {</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> ( parent.</span><span style="color:#b392f0">isShutdown</span><span style="color:#e1e4e8">() )</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">throw</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">RejectedExecutionException</span><span style="color:#e1e4e8">(</span></span>
<span class="line"><span style="color:#e1e4e8">                    </span><span style="color:#9ecbff">"Executor not running, can't force a command into the queue"</span></span>
<span class="line"><span style="color:#e1e4e8">            );</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">super</span><span style="color:#e1e4e8">.</span><span style="color:#b392f0">offer</span><span style="color:#e1e4e8">(o,timeout,unit); </span><span style="color:#6a737d">//forces the item onto the queue, to be used if the task</span></span>
<span class="line"><span style="color:#e1e4e8">        is rejected</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">boolean</span><span style="color:#24292e"> </span><span style="color:#6f42c1">force</span><span style="color:#24292e">(Runnable o, </span><span style="color:#d73a49">long</span><span style="color:#24292e"> timeout, TimeUnit unit) throws InterruptedException {</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">if</span><span style="color:#24292e"> ( parent.</span><span style="color:#6f42c1">isShutdown</span><span style="color:#24292e">() )</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">throw</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">RejectedExecutionException</span><span style="color:#24292e">(</span></span>
<span class="line"><span style="color:#24292e">                    </span><span style="color:#032f62">"Executor not running, can't force a command into the queue"</span></span>
<span class="line"><span style="color:#24292e">            );</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">return</span><span style="color:#24292e"> </span><span style="color:#005cc5">super</span><span style="color:#24292e">.</span><span style="color:#6f42c1">offer</span><span style="color:#24292e">(o,timeout,unit); </span><span style="color:#6a737d">//forces the item onto the queue, to be used if the task</span></span>
<span class="line"><span style="color:#24292e">        is rejected</span></span>
<span class="line"><span style="color:#24292e">    }</span></span></code></pre></div><p>Connector ÈÖçÁΩÆ</p><figure><img src="https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230719145956151.png" alt="image-20230719145956151" loading="lazy" decoding="async"></figure><p>Executor Á∫øÁ®ãÈÖçÁΩÆ</p><figure><img src="https://jsd.cdn.zzko.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230719150013951.png" alt="image-20230719150013951" loading="lazy" decoding="async"></figure><figure><img src="https://jsd.cdn.zzko.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230719150021940.png" alt="image-20230719150021940" loading="lazy" decoding="async"></figure><h3 id="_3„ÄÅfork-join" tabindex="-1">3„ÄÅFork/Join <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20advanced%20chapter#_3„ÄÅfork-join" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h3><h4 id="Ê¶ÇÂøµ" tabindex="-1">Ê¶ÇÂøµ <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20advanced%20chapter#Ê¶ÇÂøµ" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h4><ol><li>Fork/Join ÊòØ JDK 1.7 Âä†ÂÖ•ÁöÑÊñ∞ÁöÑÁ∫øÁ®ãÊ±†ÂÆûÁé∞ÔºåÂÆÉ‰ΩìÁé∞ÁöÑÊòØ‰∏ÄÁßçÂàÜÊ≤ªÊÄùÊÉ≥ÔºåÈÄÇÁî®‰∫éËÉΩÂ§üËøõË°å‰ªªÂä°ÊãÜÂàÜÁöÑ cpu ÂØÜÈõÜÂûãËøêÁÆó</li><li>ÊâÄË∞ìÁöÑ‰ªªÂä°ÊãÜÂàÜÔºåÊòØÂ∞Ü‰∏Ä‰∏™Â§ß‰ªªÂä°ÊãÜÂàÜ‰∏∫ÁÆóÊ≥ï‰∏äÁõ∏ÂêåÁöÑÂ∞è‰ªªÂä°ÔºåÁõ¥Ëá≥‰∏çËÉΩÊãÜÂàÜÂèØ‰ª•Áõ¥Êé•Ê±ÇËß£„ÄÇË∑üÈÄíÂΩíÁõ∏ÂÖ≥ÁöÑ‰∏Ä‰∫õËÆ°ÁÆóÔºåÂ¶ÇÂΩíÂπ∂ÊéíÂ∫è„ÄÅÊñêÊ≥¢ÈÇ£Â•ëÊï∞Âàó„ÄÅÈÉΩÂèØ‰ª•Áî®ÂàÜÊ≤ªÊÄùÊÉ≥ËøõË°åÊ±ÇËß£</li><li>Fork/Join Âú®ÂàÜÊ≤ªÁöÑÂü∫Á°Ä‰∏äÂä†ÂÖ•‰∫ÜÂ§öÁ∫øÁ®ãÔºåÂèØ‰ª•ÊääÊØè‰∏™‰ªªÂä°ÁöÑÂàÜËß£ÂíåÂêàÂπ∂‰∫§Áªô‰∏çÂêåÁöÑÁ∫øÁ®ãÊù•ÂÆåÊàêÔºåËøõ‰∏ÄÊ≠•ÊèêÂçá‰∫ÜËøêÁÆóÊïàÁéá</li><li>Fork/Join ÈªòËÆ§‰ºöÂàõÂª∫‰∏é cpu Ê†∏ÂøÉÊï∞Â§ßÂ∞èÁõ∏ÂêåÁöÑÁ∫øÁ®ãÊ±†</li></ol><h4 id="‰ΩøÁî®-1" tabindex="-1">‰ΩøÁî® <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20advanced%20chapter#‰ΩøÁî®-1" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h4><p>Êèê‰∫§Áªô Fork/Join Á∫øÁ®ãÊ±†ÁöÑ‰ªªÂä°ÈúÄË¶ÅÁªßÊâø RecursiveTaskÔºàÊúâËøîÂõûÂÄºÔºâÊàñ RecursiveActionÔºàÊ≤°ÊúâËøîÂõûÂÄºÔºâÔºå‰æãÂ¶Ç‰∏ã Èù¢ÂÆö‰πâ‰∫Ü‰∏Ä‰∏™ÂØπ 1~n ‰πãÈó¥ÁöÑÊï¥Êï∞Ê±ÇÂíåÁöÑ‰ªªÂä°</p><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">class</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">TestForkJoin</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">static</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">void</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">main</span><span style="color:#e1e4e8">(</span><span style="color:#f97583">String</span><span style="color:#e1e4e8">[] </span><span style="color:#ffab70">args</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">        ForkJoinPool pool </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">ForkJoinPool</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">4</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">        System.out.</span><span style="color:#b392f0">println</span><span style="color:#e1e4e8">(pool.</span><span style="color:#b392f0">invoke</span><span style="color:#e1e4e8">(</span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">AddTask1</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">5</span><span style="color:#e1e4e8">)));</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"><span style="color:#e1e4e8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">@</span><span style="color:#f97583">Slf4j</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">topic</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#9ecbff">"c.AddTask"</span><span style="color:#e1e4e8">)</span></span>
<span class="line"><span style="color:#f97583">class</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">AddTask1</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">extends</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">RecursiveTask</span><span style="color:#e1e4e8">&lt;</span><span style="color:#f97583">Integer</span><span style="color:#e1e4e8">&gt; {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> n;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">AddTask1</span><span style="color:#e1e4e8">(</span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> </span><span style="color:#ffab70">n</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#79b8ff">this</span><span style="color:#e1e4e8">.n </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> n;</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">    @</span><span style="color:#f97583">Override</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">public</span><span style="color:#e1e4e8"> String </span><span style="color:#b392f0">toString</span><span style="color:#e1e4e8">() {</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> </span><span style="color:#9ecbff">"{"</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">+</span><span style="color:#e1e4e8"> n </span><span style="color:#f97583">+</span><span style="color:#e1e4e8"> </span><span style="color:#9ecbff">'}'</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">    @</span><span style="color:#f97583">Override</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">protected</span><span style="color:#e1e4e8"> Integer </span><span style="color:#b392f0">compute</span><span style="color:#e1e4e8">() {</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (n </span><span style="color:#f97583">==</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">1</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">            log.</span><span style="color:#b392f0">debug</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"join() {}"</span><span style="color:#e1e4e8">, n);</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> n;</span></span>
<span class="line"><span style="color:#e1e4e8">        }</span></span>
<span class="line"><span style="color:#e1e4e8">        AddTask1 t1 </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">AddTask1</span><span style="color:#e1e4e8">(n </span><span style="color:#f97583">-</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">1</span><span style="color:#e1e4e8">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">        t1.</span><span style="color:#b392f0">fork</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">        log.</span><span style="color:#b392f0">debug</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"fork() {} + {}"</span><span style="color:#e1e4e8">, n, t1);</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> result </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> n </span><span style="color:#f97583">+</span><span style="color:#e1e4e8"> t1.</span><span style="color:#b392f0">join</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">        log.</span><span style="color:#b392f0">debug</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"join() {} + {} = {}"</span><span style="color:#e1e4e8">, n, t1, result);</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> result;</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"><span style="color:#e1e4e8">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">class</span><span style="color:#24292e"> </span><span style="color:#6f42c1">TestForkJoin</span><span style="color:#24292e"> {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">static</span><span style="color:#24292e"> </span><span style="color:#d73a49">void</span><span style="color:#24292e"> </span><span style="color:#6f42c1">main</span><span style="color:#24292e">(</span><span style="color:#d73a49">String</span><span style="color:#24292e">[] </span><span style="color:#e36209">args</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">        ForkJoinPool pool </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">ForkJoinPool</span><span style="color:#24292e">(</span><span style="color:#005cc5">4</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">        System.out.</span><span style="color:#6f42c1">println</span><span style="color:#24292e">(pool.</span><span style="color:#6f42c1">invoke</span><span style="color:#24292e">(</span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">AddTask1</span><span style="color:#24292e">(</span><span style="color:#005cc5">5</span><span style="color:#24292e">)));</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"><span style="color:#24292e">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">@</span><span style="color:#d73a49">Slf4j</span><span style="color:#24292e">(</span><span style="color:#005cc5">topic</span><span style="color:#24292e"> </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#032f62">"c.AddTask"</span><span style="color:#24292e">)</span></span>
<span class="line"><span style="color:#d73a49">class</span><span style="color:#24292e"> </span><span style="color:#6f42c1">AddTask1</span><span style="color:#24292e"> </span><span style="color:#d73a49">extends</span><span style="color:#24292e"> </span><span style="color:#6f42c1">RecursiveTask</span><span style="color:#24292e">&lt;</span><span style="color:#d73a49">Integer</span><span style="color:#24292e">&gt; {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">int</span><span style="color:#24292e"> n;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#6f42c1">AddTask1</span><span style="color:#24292e">(</span><span style="color:#d73a49">int</span><span style="color:#24292e"> </span><span style="color:#e36209">n</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#005cc5">this</span><span style="color:#24292e">.n </span><span style="color:#d73a49">=</span><span style="color:#24292e"> n;</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">    @</span><span style="color:#d73a49">Override</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">public</span><span style="color:#24292e"> String </span><span style="color:#6f42c1">toString</span><span style="color:#24292e">() {</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">return</span><span style="color:#24292e"> </span><span style="color:#032f62">"{"</span><span style="color:#24292e"> </span><span style="color:#d73a49">+</span><span style="color:#24292e"> n </span><span style="color:#d73a49">+</span><span style="color:#24292e"> </span><span style="color:#032f62">'}'</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">    @</span><span style="color:#d73a49">Override</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">protected</span><span style="color:#24292e"> Integer </span><span style="color:#6f42c1">compute</span><span style="color:#24292e">() {</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (n </span><span style="color:#d73a49">==</span><span style="color:#24292e"> </span><span style="color:#005cc5">1</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">            log.</span><span style="color:#6f42c1">debug</span><span style="color:#24292e">(</span><span style="color:#032f62">"join() {}"</span><span style="color:#24292e">, n);</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">return</span><span style="color:#24292e"> n;</span></span>
<span class="line"><span style="color:#24292e">        }</span></span>
<span class="line"><span style="color:#24292e">        AddTask1 t1 </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">AddTask1</span><span style="color:#24292e">(n </span><span style="color:#d73a49">-</span><span style="color:#24292e"> </span><span style="color:#005cc5">1</span><span style="color:#24292e">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">        t1.</span><span style="color:#6f42c1">fork</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">        log.</span><span style="color:#6f42c1">debug</span><span style="color:#24292e">(</span><span style="color:#032f62">"fork() {} + {}"</span><span style="color:#24292e">, n, t1);</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">int</span><span style="color:#24292e"> result </span><span style="color:#d73a49">=</span><span style="color:#24292e"> n </span><span style="color:#d73a49">+</span><span style="color:#24292e"> t1.</span><span style="color:#6f42c1">join</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">        log.</span><span style="color:#6f42c1">debug</span><span style="color:#24292e">(</span><span style="color:#032f62">"join() {} + {} = {}"</span><span style="color:#24292e">, n, t1, result);</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">return</span><span style="color:#24292e"> result;</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"><span style="color:#24292e">}</span></span></code></pre></div><figure><img src="https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230719151428743.png" alt="image-20230719151428743" loading="lazy" decoding="async"></figure><figure><img src="https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230719151443095.png" alt="image-20230719151443095" loading="lazy" decoding="async"></figure><p>ÊîπËøõ</p><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#f97583">class</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">AddTask3</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">extends</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">RecursiveTask</span><span style="color:#e1e4e8">&lt;</span><span style="color:#f97583">Integer</span><span style="color:#e1e4e8">&gt; {</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> begin;</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> end;</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">AddTask3</span><span style="color:#e1e4e8">(</span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> </span><span style="color:#ffab70">begin</span><span style="color:#e1e4e8">, </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> </span><span style="color:#ffab70">end</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#79b8ff">this</span><span style="color:#e1e4e8">.begin </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> begin;</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#79b8ff">this</span><span style="color:#e1e4e8">.end </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> end;</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"><span style="color:#e1e4e8">    @</span><span style="color:#f97583">Override</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">public</span><span style="color:#e1e4e8"> String </span><span style="color:#b392f0">toString</span><span style="color:#e1e4e8">() {</span></span>
<span class="line"><span style="color:#e1e4e8">    	</span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> </span><span style="color:#9ecbff">"{"</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">+</span><span style="color:#e1e4e8"> begin </span><span style="color:#f97583">+</span><span style="color:#e1e4e8"> </span><span style="color:#9ecbff">","</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">+</span><span style="color:#e1e4e8"> end </span><span style="color:#f97583">+</span><span style="color:#e1e4e8"> </span><span style="color:#9ecbff">'}'</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"><span style="color:#e1e4e8">    @</span><span style="color:#f97583">Override</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">protected</span><span style="color:#e1e4e8"> Integer </span><span style="color:#b392f0">compute</span><span style="color:#e1e4e8">() {</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#6a737d">// 5, 5</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (begin </span><span style="color:#f97583">==</span><span style="color:#e1e4e8"> end) {</span></span>
<span class="line"><span style="color:#e1e4e8">            log.</span><span style="color:#b392f0">debug</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"join() {}"</span><span style="color:#e1e4e8">, begin);</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> begin;</span></span>
<span class="line"><span style="color:#e1e4e8">        }</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#6a737d">// 4, 5</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (end </span><span style="color:#f97583">-</span><span style="color:#e1e4e8"> begin </span><span style="color:#f97583">==</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">1</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">            log.</span><span style="color:#b392f0">debug</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"join() {} + {} = {}"</span><span style="color:#e1e4e8">, begin, end, end </span><span style="color:#f97583">+</span><span style="color:#e1e4e8"> begin);</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> end </span><span style="color:#f97583">+</span><span style="color:#e1e4e8"> begin;</span></span>
<span class="line"><span style="color:#e1e4e8">        }</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#6a737d">// 1 5</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> mid </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> (end </span><span style="color:#f97583">+</span><span style="color:#e1e4e8"> begin) </span><span style="color:#f97583">/</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">2</span><span style="color:#e1e4e8">; </span><span style="color:#6a737d">// 3</span></span>
<span class="line"><span style="color:#e1e4e8">        AddTask3 t1 </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">AddTask3</span><span style="color:#e1e4e8">(begin, mid); </span><span style="color:#6a737d">// 1,3</span></span>
<span class="line"><span style="color:#e1e4e8">        t1.</span><span style="color:#b392f0">fork</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">        AddTask3 t2 </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">AddTask3</span><span style="color:#e1e4e8">(mid </span><span style="color:#f97583">+</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">1</span><span style="color:#e1e4e8">, end); </span><span style="color:#6a737d">// 4,5</span></span>
<span class="line"><span style="color:#e1e4e8">        t2.</span><span style="color:#b392f0">fork</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">        log.</span><span style="color:#b392f0">debug</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"fork() {} + {} = ?"</span><span style="color:#e1e4e8">, t1, t2);</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> result </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> t1.</span><span style="color:#b392f0">join</span><span style="color:#e1e4e8">() </span><span style="color:#f97583">+</span><span style="color:#e1e4e8"> t2.</span><span style="color:#b392f0">join</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">        log.</span><span style="color:#b392f0">debug</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"join() {} + {} = {}"</span><span style="color:#e1e4e8">, t1, t2, result);</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> result;</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"><span style="color:#e1e4e8">}</span></span>
<span class="line"><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">static</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">void</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">main</span><span style="color:#e1e4e8">(</span><span style="color:#f97583">String</span><span style="color:#e1e4e8">[] args) {</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">//ÁÑ∂ÂêéÊèê‰∫§Áªô ForkJoinPool Êù•ÊâßË°å</span></span>
<span class="line"><span style="color:#e1e4e8">    ForkJoinPool pool </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">ForkJoinPool</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">4</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">    System.out.</span><span style="color:#b392f0">println</span><span style="color:#e1e4e8">(pool.</span><span style="color:#b392f0">invoke</span><span style="color:#e1e4e8">(</span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">AddTask3</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">1</span><span style="color:#e1e4e8">, </span><span style="color:#79b8ff">10</span><span style="color:#e1e4e8">)));</span></span>
<span class="line"><span style="color:#e1e4e8">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#d73a49">class</span><span style="color:#24292e"> </span><span style="color:#6f42c1">AddTask3</span><span style="color:#24292e"> </span><span style="color:#d73a49">extends</span><span style="color:#24292e"> </span><span style="color:#6f42c1">RecursiveTask</span><span style="color:#24292e">&lt;</span><span style="color:#d73a49">Integer</span><span style="color:#24292e">&gt; {</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">int</span><span style="color:#24292e"> begin;</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">int</span><span style="color:#24292e"> end;</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#6f42c1">AddTask3</span><span style="color:#24292e">(</span><span style="color:#d73a49">int</span><span style="color:#24292e"> </span><span style="color:#e36209">begin</span><span style="color:#24292e">, </span><span style="color:#d73a49">int</span><span style="color:#24292e"> </span><span style="color:#e36209">end</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#005cc5">this</span><span style="color:#24292e">.begin </span><span style="color:#d73a49">=</span><span style="color:#24292e"> begin;</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#005cc5">this</span><span style="color:#24292e">.end </span><span style="color:#d73a49">=</span><span style="color:#24292e"> end;</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"><span style="color:#24292e">    @</span><span style="color:#d73a49">Override</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">public</span><span style="color:#24292e"> String </span><span style="color:#6f42c1">toString</span><span style="color:#24292e">() {</span></span>
<span class="line"><span style="color:#24292e">    	</span><span style="color:#d73a49">return</span><span style="color:#24292e"> </span><span style="color:#032f62">"{"</span><span style="color:#24292e"> </span><span style="color:#d73a49">+</span><span style="color:#24292e"> begin </span><span style="color:#d73a49">+</span><span style="color:#24292e"> </span><span style="color:#032f62">","</span><span style="color:#24292e"> </span><span style="color:#d73a49">+</span><span style="color:#24292e"> end </span><span style="color:#d73a49">+</span><span style="color:#24292e"> </span><span style="color:#032f62">'}'</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"><span style="color:#24292e">    @</span><span style="color:#d73a49">Override</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">protected</span><span style="color:#24292e"> Integer </span><span style="color:#6f42c1">compute</span><span style="color:#24292e">() {</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6a737d">// 5, 5</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (begin </span><span style="color:#d73a49">==</span><span style="color:#24292e"> end) {</span></span>
<span class="line"><span style="color:#24292e">            log.</span><span style="color:#6f42c1">debug</span><span style="color:#24292e">(</span><span style="color:#032f62">"join() {}"</span><span style="color:#24292e">, begin);</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">return</span><span style="color:#24292e"> begin;</span></span>
<span class="line"><span style="color:#24292e">        }</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6a737d">// 4, 5</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (end </span><span style="color:#d73a49">-</span><span style="color:#24292e"> begin </span><span style="color:#d73a49">==</span><span style="color:#24292e"> </span><span style="color:#005cc5">1</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">            log.</span><span style="color:#6f42c1">debug</span><span style="color:#24292e">(</span><span style="color:#032f62">"join() {} + {} = {}"</span><span style="color:#24292e">, begin, end, end </span><span style="color:#d73a49">+</span><span style="color:#24292e"> begin);</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">return</span><span style="color:#24292e"> end </span><span style="color:#d73a49">+</span><span style="color:#24292e"> begin;</span></span>
<span class="line"><span style="color:#24292e">        }</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6a737d">// 1 5</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">int</span><span style="color:#24292e"> mid </span><span style="color:#d73a49">=</span><span style="color:#24292e"> (end </span><span style="color:#d73a49">+</span><span style="color:#24292e"> begin) </span><span style="color:#d73a49">/</span><span style="color:#24292e"> </span><span style="color:#005cc5">2</span><span style="color:#24292e">; </span><span style="color:#6a737d">// 3</span></span>
<span class="line"><span style="color:#24292e">        AddTask3 t1 </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">AddTask3</span><span style="color:#24292e">(begin, mid); </span><span style="color:#6a737d">// 1,3</span></span>
<span class="line"><span style="color:#24292e">        t1.</span><span style="color:#6f42c1">fork</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">        AddTask3 t2 </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">AddTask3</span><span style="color:#24292e">(mid </span><span style="color:#d73a49">+</span><span style="color:#24292e"> </span><span style="color:#005cc5">1</span><span style="color:#24292e">, end); </span><span style="color:#6a737d">// 4,5</span></span>
<span class="line"><span style="color:#24292e">        t2.</span><span style="color:#6f42c1">fork</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">        log.</span><span style="color:#6f42c1">debug</span><span style="color:#24292e">(</span><span style="color:#032f62">"fork() {} + {} = ?"</span><span style="color:#24292e">, t1, t2);</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">int</span><span style="color:#24292e"> result </span><span style="color:#d73a49">=</span><span style="color:#24292e"> t1.</span><span style="color:#6f42c1">join</span><span style="color:#24292e">() </span><span style="color:#d73a49">+</span><span style="color:#24292e"> t2.</span><span style="color:#6f42c1">join</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">        log.</span><span style="color:#6f42c1">debug</span><span style="color:#24292e">(</span><span style="color:#032f62">"join() {} + {} = {}"</span><span style="color:#24292e">, t1, t2, result);</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">return</span><span style="color:#24292e"> result;</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"><span style="color:#24292e">}</span></span>
<span class="line"><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">static</span><span style="color:#24292e"> </span><span style="color:#d73a49">void</span><span style="color:#24292e"> </span><span style="color:#6f42c1">main</span><span style="color:#24292e">(</span><span style="color:#d73a49">String</span><span style="color:#24292e">[] args) {</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">//ÁÑ∂ÂêéÊèê‰∫§Áªô ForkJoinPool Êù•ÊâßË°å</span></span>
<span class="line"><span style="color:#24292e">    ForkJoinPool pool </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">ForkJoinPool</span><span style="color:#24292e">(</span><span style="color:#005cc5">4</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">    System.out.</span><span style="color:#6f42c1">println</span><span style="color:#24292e">(pool.</span><span style="color:#6f42c1">invoke</span><span style="color:#24292e">(</span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">AddTask3</span><span style="color:#24292e">(</span><span style="color:#005cc5">1</span><span style="color:#24292e">, </span><span style="color:#005cc5">10</span><span style="color:#24292e">)));</span></span>
<span class="line"><span style="color:#24292e">}</span></span></code></pre></div><figure><img src="https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230719152118555.png" alt="image-20230719152118555" loading="lazy" decoding="async"></figure><figure><img src="https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230719152127214.png" alt="image-20230719152127214" loading="lazy" decoding="async"></figure><h2 id="ÂÖ´„ÄÅjuc" tabindex="-1">ÂÖ´„ÄÅJUC <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20advanced%20chapter#ÂÖ´„ÄÅjuc" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h2><h3 id="_1„ÄÅaqs-ÂéüÁêÜ" tabindex="-1">1„ÄÅAQS ÂéüÁêÜ <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20advanced%20chapter#_1„ÄÅaqs-ÂéüÁêÜ" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h3><ul><li><p>Ê¶ÇËø∞ÔºöÂÖ®Áß∞ÊòØ AbstractQueuedSynchronizerÔºåÊòØÈòªÂ°ûÂºèÈîÅÂíåÁõ∏ÂÖ≥ÁöÑÂêåÊ≠•Âô®Â∑•ÂÖ∑ÁöÑÊ°ÜÊû∂</p></li><li><p>ÁâπÁÇπÔºö</p><ul><li>Áî® state Â±ûÊÄßÊù•Ë°®Á§∫ËµÑÊ∫êÁöÑÁä∂ÊÄÅÔºàÂàÜÁã¨Âç†Ê®°ÂºèÂíåÂÖ±‰∫´Ê®°ÂºèÔºâÔºåÂ≠êÁ±ªÈúÄË¶ÅÂÆö‰πâÂ¶Ç‰ΩïÁª¥Êä§Ëøô‰∏™Áä∂ÊÄÅÔºåÊéßÂà∂Â¶Ç‰ΩïËé∑ÂèñÈîÅÂíåÈáäÊîæÈîÅ<ul><li>getState - Ëé∑Âèñ state Áä∂ÊÄÅ</li><li>setState - ËÆæÁΩÆ state Áä∂ÊÄÅ</li><li>compareAndSetState - cas Êú∫Âà∂ËÆæÁΩÆ state Áä∂ÊÄÅ</li><li>Áã¨Âç†Ê®°ÂºèÊòØÂè™Êúâ‰∏Ä‰∏™Á∫øÁ®ãËÉΩÂ§üËÆøÈóÆËµÑÊ∫êÔºåËÄåÂÖ±‰∫´Ê®°ÂºèÂèØ‰ª•ÂÖÅËÆ∏Â§ö‰∏™Á∫øÁ®ãËÆøÈóÆËµÑÊ∫ê</li></ul></li><li>Êèê‰æõ‰∫ÜÂü∫‰∫é FIFO ÁöÑÁ≠âÂæÖÈòüÂàóÔºåÁ±ª‰ºº‰∫é Monitor ÁöÑ EntryList</li><li>Êù°‰ª∂ÂèòÈáèÊù•ÂÆûÁé∞Á≠âÂæÖ„ÄÅÂî§ÈÜíÊú∫Âà∂ÔºåÊîØÊåÅÂ§ö‰∏™Êù°‰ª∂ÂèòÈáèÔºåÁ±ª‰ºº‰∫é Monitor ÁöÑ WaitSet</li></ul></li></ul><p>Â≠êÁ±ª‰∏ªË¶ÅÂÆûÁé∞ËøôÊ†∑‰∏Ä‰∫õÊñπÊ≥ïÔºàÈªòËÆ§ÊäõÂá∫ UnsupportedOperationExceptionÔºâ</p><ul><li>tryAcquire</li><li>tryRelease</li><li>tryAcquireShared</li><li>tryReleaseShared</li><li>isHeldExclusively</li></ul><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6a737d">//Ëé∑ÂèñÈîÅÁöÑÂßøÂäø</span></span>
<span class="line"><span style="color:#6a737d">// Â¶ÇÊûúËé∑ÂèñÈîÅÂ§±Ë¥•</span></span>
<span class="line"><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (</span><span style="color:#f97583">!</span><span style="color:#b392f0">tryAcquire</span><span style="color:#e1e4e8">(arg)) {</span></span>
<span class="line"><span style="color:#e1e4e8"> </span><span style="color:#6a737d">// ÂÖ•Èòü, ÂèØ‰ª•ÈÄâÊã©ÈòªÂ°ûÂΩìÂâçÁ∫øÁ®ã park unpark</span></span>
<span class="line"><span style="color:#e1e4e8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6a737d">//ÈáäÊîæÈîÅÁöÑÂßøÂäø</span></span>
<span class="line"><span style="color:#6a737d">// Â¶ÇÊûúÈáäÊîæÈîÅÊàêÂäü</span></span>
<span class="line"><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (</span><span style="color:#b392f0">tryRelease</span><span style="color:#e1e4e8">(arg)) {</span></span>
<span class="line"><span style="color:#e1e4e8"> </span><span style="color:#6a737d">// ËÆ©ÈòªÂ°ûÁ∫øÁ®ãÊÅ¢Â§çËøêË°å</span></span>
<span class="line"><span style="color:#e1e4e8">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6a737d">//Ëé∑ÂèñÈîÅÁöÑÂßøÂäø</span></span>
<span class="line"><span style="color:#6a737d">// Â¶ÇÊûúËé∑ÂèñÈîÅÂ§±Ë¥•</span></span>
<span class="line"><span style="color:#d73a49">if</span><span style="color:#24292e"> (</span><span style="color:#d73a49">!</span><span style="color:#6f42c1">tryAcquire</span><span style="color:#24292e">(arg)) {</span></span>
<span class="line"><span style="color:#24292e"> </span><span style="color:#6a737d">// ÂÖ•Èòü, ÂèØ‰ª•ÈÄâÊã©ÈòªÂ°ûÂΩìÂâçÁ∫øÁ®ã park unpark</span></span>
<span class="line"><span style="color:#24292e">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6a737d">//ÈáäÊîæÈîÅÁöÑÂßøÂäø</span></span>
<span class="line"><span style="color:#6a737d">// Â¶ÇÊûúÈáäÊîæÈîÅÊàêÂäü</span></span>
<span class="line"><span style="color:#d73a49">if</span><span style="color:#24292e"> (</span><span style="color:#6f42c1">tryRelease</span><span style="color:#24292e">(arg)) {</span></span>
<span class="line"><span style="color:#24292e"> </span><span style="color:#6a737d">// ËÆ©ÈòªÂ°ûÁ∫øÁ®ãÊÅ¢Â§çËøêË°å</span></span>
<span class="line"><span style="color:#24292e">}</span></span></code></pre></div><h4 id="ÂÆûÁé∞‰∏çÂèØÈáçÂÖ•ÈîÅ" tabindex="-1">ÂÆûÁé∞‰∏çÂèØÈáçÂÖ•ÈîÅ <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20advanced%20chapter#ÂÆûÁé∞‰∏çÂèØÈáçÂÖ•ÈîÅ" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h4><p>Ëá™ÂÆö‰πâÂêåÊ≠•Âô®+Ëá™ÂÆö‰πâÈîÅ</p><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#f97583">import</span><span style="color:#e1e4e8"> java.util.concurrent.TimeUnit;</span></span>
<span class="line"><span style="color:#f97583">import</span><span style="color:#e1e4e8"> java.util.concurrent.locks.AbstractQueuedSynchronizer;</span></span>
<span class="line"><span style="color:#f97583">import</span><span style="color:#e1e4e8"> java.util.concurrent.locks.Condition;</span></span>
<span class="line"><span style="color:#f97583">import</span><span style="color:#e1e4e8"> java.util.concurrent.locks.Lock;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">@</span><span style="color:#f97583">Slf4j</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">topic</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#9ecbff">"c.TestAqs"</span><span style="color:#e1e4e8">)</span></span>
<span class="line"><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">class</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">TestAqs</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">static</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">void</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">main</span><span style="color:#e1e4e8">(</span><span style="color:#f97583">String</span><span style="color:#e1e4e8">[] </span><span style="color:#ffab70">args</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">        MyLock lock </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">MyLock</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Thread</span><span style="color:#e1e4e8">(() </span><span style="color:#f97583">-&gt;</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">            lock.</span><span style="color:#b392f0">lock</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">try</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">                log.</span><span style="color:#b392f0">debug</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"locking..."</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#b392f0">sleep</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">1</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">            } </span><span style="color:#f97583">finally</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">                log.</span><span style="color:#b392f0">debug</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"unlocking..."</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">                lock.</span><span style="color:#b392f0">unlock</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">            }</span></span>
<span class="line"><span style="color:#e1e4e8">        },</span><span style="color:#9ecbff">"t1"</span><span style="color:#e1e4e8">).</span><span style="color:#b392f0">start</span><span style="color:#e1e4e8">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Thread</span><span style="color:#e1e4e8">(() </span><span style="color:#f97583">-&gt;</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">            lock.</span><span style="color:#b392f0">lock</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">try</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">                log.</span><span style="color:#b392f0">debug</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"locking..."</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">            } </span><span style="color:#f97583">finally</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">                log.</span><span style="color:#b392f0">debug</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"unlocking..."</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">                lock.</span><span style="color:#b392f0">unlock</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">            }</span></span>
<span class="line"><span style="color:#e1e4e8">        },</span><span style="color:#9ecbff">"t2"</span><span style="color:#e1e4e8">).</span><span style="color:#b392f0">start</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"><span style="color:#e1e4e8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6a737d">// Ëá™ÂÆö‰πâÈîÅÔºà‰∏çÂèØÈáçÂÖ•ÈîÅÔºâ</span></span>
<span class="line"><span style="color:#f97583">class</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">MyLock</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">implements</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Lock</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">// Áã¨Âç†ÈîÅ  ÂêåÊ≠•Âô®Á±ª</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">class</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">MySync</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">extends</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">AbstractQueuedSynchronizer</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">        @</span><span style="color:#f97583">Override</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">protected</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">boolean</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">tryAcquire</span><span style="color:#e1e4e8">(</span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> </span><span style="color:#ffab70">arg</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">if</span><span style="color:#e1e4e8">(</span><span style="color:#b392f0">compareAndSetState</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8">, </span><span style="color:#79b8ff">1</span><span style="color:#e1e4e8">)) {</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#6a737d">// Âä†‰∏ä‰∫ÜÈîÅÔºåÂπ∂ËÆæÁΩÆ owner ‰∏∫ÂΩìÂâçÁ∫øÁ®ã</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#b392f0">setExclusiveOwnerThread</span><span style="color:#e1e4e8">(Thread.</span><span style="color:#b392f0">currentThread</span><span style="color:#e1e4e8">());</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">true</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">            }</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">false</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">        }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">        @</span><span style="color:#f97583">Override</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">protected</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">boolean</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">tryRelease</span><span style="color:#e1e4e8">(</span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> </span><span style="color:#ffab70">arg</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#b392f0">setExclusiveOwnerThread</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#6a737d">//volatileÂÜôÊîæÂà∞ÊúÄÂêéÔºåÂÜôÂ±èÈöúÊâçÊúâÊïà</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#b392f0">setState</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">true</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">        }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">        @</span><span style="color:#f97583">Override</span><span style="color:#e1e4e8"> </span><span style="color:#6a737d">// ÊòØÂê¶ÊåÅÊúâÁã¨Âç†ÈîÅ</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">protected</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">boolean</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">isHeldExclusively</span><span style="color:#e1e4e8">() {</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">getState</span><span style="color:#e1e4e8">() </span><span style="color:#f97583">==</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">1</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">        }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">public</span><span style="color:#e1e4e8"> Condition </span><span style="color:#b392f0">newCondition</span><span style="color:#e1e4e8">() {</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">ConditionObject</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">        }</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">private</span><span style="color:#e1e4e8"> MySync sync </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">MySync</span><span style="color:#e1e4e8">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">    @</span><span style="color:#f97583">Override</span><span style="color:#e1e4e8"> </span><span style="color:#6a737d">// Âä†ÈîÅÔºà‰∏çÊàêÂäü‰ºöËøõÂÖ•Á≠âÂæÖÈòüÂàóÔºâ</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">void</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">lock</span><span style="color:#e1e4e8">() {</span></span>
<span class="line"><span style="color:#e1e4e8">        sync.</span><span style="color:#b392f0">acquire</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">1</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">    @</span><span style="color:#f97583">Override</span><span style="color:#e1e4e8"> </span><span style="color:#6a737d">// Âä†ÈîÅÔºåÂèØÊâìÊñ≠</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">void</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">lockInterruptibly</span><span style="color:#e1e4e8">() </span><span style="color:#f97583">throws</span><span style="color:#e1e4e8"> InterruptedException {</span></span>
<span class="line"><span style="color:#e1e4e8">        sync.</span><span style="color:#b392f0">acquireInterruptibly</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">1</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">    @</span><span style="color:#f97583">Override</span><span style="color:#e1e4e8"> </span><span style="color:#6a737d">// Â∞ùËØïÂä†ÈîÅÔºà‰∏ÄÊ¨°Ôºâ</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">boolean</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">tryLock</span><span style="color:#e1e4e8">() {</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> sync.</span><span style="color:#b392f0">tryAcquire</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">1</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">    @</span><span style="color:#f97583">Override</span><span style="color:#e1e4e8"> </span><span style="color:#6a737d">// Â∞ùËØïÂä†ÈîÅÔºåÂ∏¶Ë∂ÖÊó∂</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">boolean</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">tryLock</span><span style="color:#e1e4e8">(</span><span style="color:#f97583">long</span><span style="color:#e1e4e8"> </span><span style="color:#ffab70">time</span><span style="color:#e1e4e8">, TimeUnit </span><span style="color:#ffab70">unit</span><span style="color:#e1e4e8">) </span><span style="color:#f97583">throws</span><span style="color:#e1e4e8"> InterruptedException {</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> sync.</span><span style="color:#b392f0">tryAcquireNanos</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">1</span><span style="color:#e1e4e8">, unit.</span><span style="color:#b392f0">toNanos</span><span style="color:#e1e4e8">(time));</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">    @</span><span style="color:#f97583">Override</span><span style="color:#e1e4e8"> </span><span style="color:#6a737d">// Ëß£ÈîÅ</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">void</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">unlock</span><span style="color:#e1e4e8">() {</span></span>
<span class="line"><span style="color:#e1e4e8">        sync.</span><span style="color:#b392f0">release</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">1</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">    @</span><span style="color:#f97583">Override</span><span style="color:#e1e4e8"> </span><span style="color:#6a737d">// ÂàõÂª∫Êù°‰ª∂ÂèòÈáè</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">public</span><span style="color:#e1e4e8"> Condition </span><span style="color:#b392f0">newCondition</span><span style="color:#e1e4e8">() {</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> sync.</span><span style="color:#b392f0">newCondition</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"><span style="color:#e1e4e8">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#d73a49">import</span><span style="color:#24292e"> java.util.concurrent.TimeUnit;</span></span>
<span class="line"><span style="color:#d73a49">import</span><span style="color:#24292e"> java.util.concurrent.locks.AbstractQueuedSynchronizer;</span></span>
<span class="line"><span style="color:#d73a49">import</span><span style="color:#24292e"> java.util.concurrent.locks.Condition;</span></span>
<span class="line"><span style="color:#d73a49">import</span><span style="color:#24292e"> java.util.concurrent.locks.Lock;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">@</span><span style="color:#d73a49">Slf4j</span><span style="color:#24292e">(</span><span style="color:#005cc5">topic</span><span style="color:#24292e"> </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#032f62">"c.TestAqs"</span><span style="color:#24292e">)</span></span>
<span class="line"><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">class</span><span style="color:#24292e"> </span><span style="color:#6f42c1">TestAqs</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">static</span><span style="color:#24292e"> </span><span style="color:#d73a49">void</span><span style="color:#24292e"> </span><span style="color:#6f42c1">main</span><span style="color:#24292e">(</span><span style="color:#d73a49">String</span><span style="color:#24292e">[] </span><span style="color:#e36209">args</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">        MyLock lock </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">MyLock</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Thread</span><span style="color:#24292e">(() </span><span style="color:#d73a49">-&gt;</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">            lock.</span><span style="color:#6f42c1">lock</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">try</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">                log.</span><span style="color:#6f42c1">debug</span><span style="color:#24292e">(</span><span style="color:#032f62">"locking..."</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#6f42c1">sleep</span><span style="color:#24292e">(</span><span style="color:#005cc5">1</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">            } </span><span style="color:#d73a49">finally</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">                log.</span><span style="color:#6f42c1">debug</span><span style="color:#24292e">(</span><span style="color:#032f62">"unlocking..."</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">                lock.</span><span style="color:#6f42c1">unlock</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">            }</span></span>
<span class="line"><span style="color:#24292e">        },</span><span style="color:#032f62">"t1"</span><span style="color:#24292e">).</span><span style="color:#6f42c1">start</span><span style="color:#24292e">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Thread</span><span style="color:#24292e">(() </span><span style="color:#d73a49">-&gt;</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">            lock.</span><span style="color:#6f42c1">lock</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">try</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">                log.</span><span style="color:#6f42c1">debug</span><span style="color:#24292e">(</span><span style="color:#032f62">"locking..."</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">            } </span><span style="color:#d73a49">finally</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">                log.</span><span style="color:#6f42c1">debug</span><span style="color:#24292e">(</span><span style="color:#032f62">"unlocking..."</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">                lock.</span><span style="color:#6f42c1">unlock</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">            }</span></span>
<span class="line"><span style="color:#24292e">        },</span><span style="color:#032f62">"t2"</span><span style="color:#24292e">).</span><span style="color:#6f42c1">start</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"><span style="color:#24292e">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6a737d">// Ëá™ÂÆö‰πâÈîÅÔºà‰∏çÂèØÈáçÂÖ•ÈîÅÔºâ</span></span>
<span class="line"><span style="color:#d73a49">class</span><span style="color:#24292e"> </span><span style="color:#6f42c1">MyLock</span><span style="color:#24292e"> </span><span style="color:#d73a49">implements</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Lock</span><span style="color:#24292e"> {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">// Áã¨Âç†ÈîÅ  ÂêåÊ≠•Âô®Á±ª</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">class</span><span style="color:#24292e"> </span><span style="color:#6f42c1">MySync</span><span style="color:#24292e"> </span><span style="color:#d73a49">extends</span><span style="color:#24292e"> </span><span style="color:#6f42c1">AbstractQueuedSynchronizer</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">        @</span><span style="color:#d73a49">Override</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">protected</span><span style="color:#24292e"> </span><span style="color:#d73a49">boolean</span><span style="color:#24292e"> </span><span style="color:#6f42c1">tryAcquire</span><span style="color:#24292e">(</span><span style="color:#d73a49">int</span><span style="color:#24292e"> </span><span style="color:#e36209">arg</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">if</span><span style="color:#24292e">(</span><span style="color:#6f42c1">compareAndSetState</span><span style="color:#24292e">(</span><span style="color:#005cc5">0</span><span style="color:#24292e">, </span><span style="color:#005cc5">1</span><span style="color:#24292e">)) {</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#6a737d">// Âä†‰∏ä‰∫ÜÈîÅÔºåÂπ∂ËÆæÁΩÆ owner ‰∏∫ÂΩìÂâçÁ∫øÁ®ã</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#6f42c1">setExclusiveOwnerThread</span><span style="color:#24292e">(Thread.</span><span style="color:#6f42c1">currentThread</span><span style="color:#24292e">());</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#d73a49">return</span><span style="color:#24292e"> </span><span style="color:#005cc5">true</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">            }</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">return</span><span style="color:#24292e"> </span><span style="color:#005cc5">false</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">        }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">        @</span><span style="color:#d73a49">Override</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">protected</span><span style="color:#24292e"> </span><span style="color:#d73a49">boolean</span><span style="color:#24292e"> </span><span style="color:#6f42c1">tryRelease</span><span style="color:#24292e">(</span><span style="color:#d73a49">int</span><span style="color:#24292e"> </span><span style="color:#e36209">arg</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#6f42c1">setExclusiveOwnerThread</span><span style="color:#24292e">(</span><span style="color:#005cc5">null</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#6a737d">//volatileÂÜôÊîæÂà∞ÊúÄÂêéÔºåÂÜôÂ±èÈöúÊâçÊúâÊïà</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#6f42c1">setState</span><span style="color:#24292e">(</span><span style="color:#005cc5">0</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">return</span><span style="color:#24292e"> </span><span style="color:#005cc5">true</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">        }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">        @</span><span style="color:#d73a49">Override</span><span style="color:#24292e"> </span><span style="color:#6a737d">// ÊòØÂê¶ÊåÅÊúâÁã¨Âç†ÈîÅ</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">protected</span><span style="color:#24292e"> </span><span style="color:#d73a49">boolean</span><span style="color:#24292e"> </span><span style="color:#6f42c1">isHeldExclusively</span><span style="color:#24292e">() {</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">return</span><span style="color:#24292e"> </span><span style="color:#6f42c1">getState</span><span style="color:#24292e">() </span><span style="color:#d73a49">==</span><span style="color:#24292e"> </span><span style="color:#005cc5">1</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">        }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">public</span><span style="color:#24292e"> Condition </span><span style="color:#6f42c1">newCondition</span><span style="color:#24292e">() {</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">return</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">ConditionObject</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">        }</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">private</span><span style="color:#24292e"> MySync sync </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">MySync</span><span style="color:#24292e">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">    @</span><span style="color:#d73a49">Override</span><span style="color:#24292e"> </span><span style="color:#6a737d">// Âä†ÈîÅÔºà‰∏çÊàêÂäü‰ºöËøõÂÖ•Á≠âÂæÖÈòüÂàóÔºâ</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">void</span><span style="color:#24292e"> </span><span style="color:#6f42c1">lock</span><span style="color:#24292e">() {</span></span>
<span class="line"><span style="color:#24292e">        sync.</span><span style="color:#6f42c1">acquire</span><span style="color:#24292e">(</span><span style="color:#005cc5">1</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">    @</span><span style="color:#d73a49">Override</span><span style="color:#24292e"> </span><span style="color:#6a737d">// Âä†ÈîÅÔºåÂèØÊâìÊñ≠</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">void</span><span style="color:#24292e"> </span><span style="color:#6f42c1">lockInterruptibly</span><span style="color:#24292e">() </span><span style="color:#d73a49">throws</span><span style="color:#24292e"> InterruptedException {</span></span>
<span class="line"><span style="color:#24292e">        sync.</span><span style="color:#6f42c1">acquireInterruptibly</span><span style="color:#24292e">(</span><span style="color:#005cc5">1</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">    @</span><span style="color:#d73a49">Override</span><span style="color:#24292e"> </span><span style="color:#6a737d">// Â∞ùËØïÂä†ÈîÅÔºà‰∏ÄÊ¨°Ôºâ</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">boolean</span><span style="color:#24292e"> </span><span style="color:#6f42c1">tryLock</span><span style="color:#24292e">() {</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">return</span><span style="color:#24292e"> sync.</span><span style="color:#6f42c1">tryAcquire</span><span style="color:#24292e">(</span><span style="color:#005cc5">1</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">    @</span><span style="color:#d73a49">Override</span><span style="color:#24292e"> </span><span style="color:#6a737d">// Â∞ùËØïÂä†ÈîÅÔºåÂ∏¶Ë∂ÖÊó∂</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">boolean</span><span style="color:#24292e"> </span><span style="color:#6f42c1">tryLock</span><span style="color:#24292e">(</span><span style="color:#d73a49">long</span><span style="color:#24292e"> </span><span style="color:#e36209">time</span><span style="color:#24292e">, TimeUnit </span><span style="color:#e36209">unit</span><span style="color:#24292e">) </span><span style="color:#d73a49">throws</span><span style="color:#24292e"> InterruptedException {</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">return</span><span style="color:#24292e"> sync.</span><span style="color:#6f42c1">tryAcquireNanos</span><span style="color:#24292e">(</span><span style="color:#005cc5">1</span><span style="color:#24292e">, unit.</span><span style="color:#6f42c1">toNanos</span><span style="color:#24292e">(time));</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">    @</span><span style="color:#d73a49">Override</span><span style="color:#24292e"> </span><span style="color:#6a737d">// Ëß£ÈîÅ</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">void</span><span style="color:#24292e"> </span><span style="color:#6f42c1">unlock</span><span style="color:#24292e">() {</span></span>
<span class="line"><span style="color:#24292e">        sync.</span><span style="color:#6f42c1">release</span><span style="color:#24292e">(</span><span style="color:#005cc5">1</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">    @</span><span style="color:#d73a49">Override</span><span style="color:#24292e"> </span><span style="color:#6a737d">// ÂàõÂª∫Êù°‰ª∂ÂèòÈáè</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">public</span><span style="color:#24292e"> Condition </span><span style="color:#6f42c1">newCondition</span><span style="color:#24292e">() {</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">return</span><span style="color:#24292e"> sync.</span><span style="color:#6f42c1">newCondition</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"><span style="color:#24292e">}</span></span></code></pre></div><figure><img src="https://jsd.cdn.zzko.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230719154757320.png" alt="image-20230719154757320" loading="lazy" decoding="async"></figure><h4 id="aqs-ÁöÑÂπ∂ÂèëÂ∑•ÂÖ∑Á±ª" tabindex="-1">AQS ÁöÑÂπ∂ÂèëÂ∑•ÂÖ∑Á±ª <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20advanced%20chapter#aqs-ÁöÑÂπ∂ÂèëÂ∑•ÂÖ∑Á±ª" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h4><figure><img src="https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230719155113602.png" alt="image-20230719155113602" loading="lazy" decoding="async"></figure><h3 id="_2„ÄÅreentrantlock-ÂéüÁêÜ" tabindex="-1">2„ÄÅReentrantLock ÂéüÁêÜ <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20advanced%20chapter#_2„ÄÅreentrantlock-ÂéüÁêÜ" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h3><p>ÂèØ‰ª•ÁúãÂà∞ReentrantLockÊèê‰æõ‰∫Ü‰∏§‰∏™ÂêåÊ≠•Âô®ÔºåÂÆûÁé∞ÂÖ¨Âπ≥ÈîÅÂíåÈùûÂÖ¨Âπ≥ÈîÅÔºåÈªòËÆ§ÊòØÈùûÂÖ¨Âπ≥ÈîÅÔºÅ</p><figure><img src="https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230719155304730.png" alt="image-20230719155304730" loading="lazy" decoding="async"></figure><h4 id="ÈùûÂÖ¨Âπ≥ÈîÅÂÆûÁé∞ÂéüÁêÜ" tabindex="-1">ÈùûÂÖ¨Âπ≥ÈîÅÂÆûÁé∞ÂéüÁêÜ <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20advanced%20chapter#ÈùûÂÖ¨Âπ≥ÈîÅÂÆûÁé∞ÂéüÁêÜ" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h4><h5 id="Âä†ÈîÅËß£ÈîÅÊµÅÁ®ã" tabindex="-1">Âä†ÈîÅËß£ÈîÅÊµÅÁ®ã <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20advanced%20chapter#Âä†ÈîÅËß£ÈîÅÊµÅÁ®ã" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h5><p>ÂÖà‰ªéÊûÑÈÄ†Âô®ÂºÄÂßãÁúãÔºåÈªòËÆ§‰∏∫ÈùûÂÖ¨Âπ≥ÈîÅÂÆûÁé∞</p><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">ReentrantLock</span><span style="color:#e1e4e8">() {</span></span>
<span class="line"><span style="color:#e1e4e8"> sync </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">NonfairSync</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#6f42c1">ReentrantLock</span><span style="color:#24292e">() {</span></span>
<span class="line"><span style="color:#24292e"> sync </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">NonfairSync</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">}</span></span></code></pre></div><p>NonfairSync ÁªßÊâøËá™ AQS</p><p>Ê≤°ÊúâÁ´û‰∫âÊó∂</p><figure><img src="https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230719155415862.png" alt="image-20230719155415862" loading="lazy" decoding="async"></figure><p>Á¨¨‰∏Ä‰∏™Á´û‰∫âÂá∫Áé∞Êó∂</p><figure><img src="https://jsd.cdn.zzko.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230719155428092.png" alt="image-20230719155428092" loading="lazy" decoding="async"></figure><p>Thread-1 ÊâßË°å‰∫Ü</p><ol><li>lockÊñπÊ≥ï‰∏≠CAS Â∞ùËØïÂ∞Ü state Áî± 0 Êîπ‰∏∫ 1ÔºåÁªìÊûúÂ§±Ë¥•</li><li>lockÊñπÊ≥ï‰∏≠Ëøõ‰∏ÄÊ≠•Ë∞ÉÁî®acquireÊñπÊ≥ïÔºåËøõÂÖ• tryAcquire ÈÄªËæëÔºåËøôÈáåÊàë‰ª¨ËÆ§‰∏∫ËøôÊó∂ state Â∑≤ÁªèÊòØ1ÔºåÁªìÊûú‰ªçÁÑ∂Â§±Ë¥•</li><li>Êé•‰∏ãÊù•ËøõÂÖ• acquireÊñπÊ≥ïÁöÑaddWaiter ÈÄªËæëÔºåÊûÑÈÄ† Node ÈòüÂàó<ul><li>Âõæ‰∏≠ÈªÑËâ≤‰∏âËßíË°®Á§∫ËØ• Node ÁöÑ waitStatus Áä∂ÊÄÅÔºåÂÖ∂‰∏≠ 0 ‰∏∫ÈªòËÆ§Ê≠£Â∏∏Áä∂ÊÄÅ</li><li>Node ÁöÑÂàõÂª∫ÊòØÊáíÊÉ∞ÁöÑ</li><li>ÂÖ∂‰∏≠Á¨¨‰∏Ä‰∏™ Node Áß∞‰∏∫ DummyÔºàÂìëÂÖÉÔºâÊàñÂì®ÂÖµÔºåÁî®Êù•Âç†‰ΩçÔºåÂπ∂‰∏çÂÖ≥ËÅîÁ∫øÁ®ã</li></ul></li></ol><figure><img src="https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230719155452096.png" alt="image-20230719155452096" loading="lazy" decoding="async"></figure><p>ÂΩìÂâçÁ∫øÁ®ãËøõÂÖ• acquireÊñπÊ≥ïÁöÑ acquireQueued ÈÄªËæë</p><ol><li>acquireQueued ‰ºöÂú®‰∏Ä‰∏™Ê≠ªÂæ™ÁéØ‰∏≠‰∏çÊñ≠Â∞ùËØïËé∑ÂæóÈîÅÔºåÂ§±Ë¥•ÂêéËøõÂÖ• park ÈòªÂ°û</li><li>Â¶ÇÊûúËá™Â∑±ÊòØÁ¥ßÈÇªÁùÄ headÔºàÊéíÁ¨¨‰∫å‰ΩçÔºâÔºåÈÇ£‰πàÂÜçÊ¨° tryAcquire Â∞ùËØïËé∑ÂèñÈîÅÔºåÂΩìÁÑ∂ËøôÊó∂ state ‰ªç‰∏∫ 1ÔºåÂ§±Ë¥•</li><li>ËøõÂÖ• shouldParkAfterFailedAcquire ÈÄªËæëÔºåÂ∞ÜÂâçÈ©± nodeÔºåÂç≥ head ÁöÑ waitStatus Êîπ‰∏∫ -1ÔºåËøôÊ¨°ËøîÂõû false</li></ol><figure><img src="https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230719155516878.png" alt="image-20230719155516878" loading="lazy" decoding="async"></figure><ol><li>shouldParkAfterFailedAcquire ÊâßË°åÂÆåÊØïÂõûÂà∞ acquireQueued ÔºåÂÜçÊ¨° tryAcquire Â∞ùËØïËé∑ÂèñÈîÅÔºåÂΩìÁÑ∂ËøôÊó∂ state ‰ªç‰∏∫ 1ÔºåÂ§±Ë¥•</li><li>ÂΩìÂÜçÊ¨°ËøõÂÖ• shouldParkAfterFailedAcquire Êó∂ÔºåËøôÊó∂Âõ†‰∏∫ÂÖ∂ÂâçÈ©± node ÁöÑ waitStatus Â∑≤ÁªèÊòØ -1ÔºåËøôÊ¨°ËøîÂõû true</li><li>ËøõÂÖ• parkAndCheckInterruptÔºå Thread-1 parkÔºàÁÅ∞Ëâ≤Ë°®Á§∫Â∑≤ÁªèÈòªÂ°ûÔºâ</li></ol><figure><img src="https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230719155528402.png" alt="image-20230719155528402" loading="lazy" decoding="async"></figure><p>ÂÜçÊ¨°ÊúâÂ§ö‰∏™Á∫øÁ®ãÁªèÂéÜ‰∏äËø∞ËøáÁ®ãÁ´û‰∫âÂ§±Ë¥•ÔºåÂèòÊàêËøô‰∏™Ê†∑Â≠ê</p><figure><img src="https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230719155542494.png" alt="image-20230719155542494" loading="lazy" decoding="async"></figure><p>Thread-0 Ë∞ÉÁî®unlockÊñπÊ≥ïÈáåÁöÑreleaseÊñπÊ≥ïÈáäÊîæÈîÅÔºåËøõÂÖ•tryRelease(‰ΩøÁî®ctrl+alt+bÊü•ÁúãtryReleaseÊñπÊ≥ïÁöÑÂÖ∑‰Ωì<code>ReentrantLock</code>ÂÆûÁé∞) ÊµÅÁ®ãÔºåÂ¶ÇÊûúÊàêÂäüÔºåËÆæÁΩÆ exclusiveOwnerThread ‰∏∫ nullÔºåstate = 0</p><figure><img src="https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230719155652604.png" alt="image-20230719155652604" loading="lazy" decoding="async"></figure><p>unlockÊñπÊ≥ïÈáåÁöÑreleaseÊñπÊ≥ïÊñπÊ≥ï‰∏≠ÔºåÂ¶ÇÊûúÂΩìÂâçÈòüÂàó‰∏ç‰∏∫ nullÔºåÂπ∂‰∏î head ÁöÑ waitStatus = -1ÔºåËøõÂÖ• unparkSuccessor ÊµÅÁ®ãÔºö unparkSuccessor‰∏≠‰ºöÊâæÂà∞ÈòüÂàó‰∏≠Á¶ª head ÊúÄËøëÁöÑ‰∏Ä‰∏™ NodeÔºàÊ≤°ÂèñÊ∂àÁöÑÔºâÔºåunpark ÊÅ¢Â§çÂÖ∂ËøêË°åÔºåÊú¨‰æã‰∏≠Âç≥‰∏∫ Thread-1 ÂõûÂà∞ Thread-1 ÁöÑ acquireQueued ÊµÅÁ®ã</p><figure><img src="https://jsd.cdn.zzko.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230719155754206.png" alt="image-20230719155754206" loading="lazy" decoding="async"></figure><p>Â¶ÇÊûúÂä†ÈîÅÊàêÂäüÔºàÊ≤°ÊúâÁ´û‰∫âÔºâÔºå‰ºöËÆæÁΩÆ ÔºàacquireQueued ÊñπÊ≥ï‰∏≠Ôºâ</p><ol><li>exclusiveOwnerThread ‰∏∫ Thread-1Ôºåstate = 1</li><li>head ÊåáÂêëÂàöÂàö Thread-1 ÊâÄÂú®ÁöÑ NodeÔºåËØ• Node Ê∏ÖÁ©∫ Thread</li><li>ÂéüÊú¨ÁöÑ head Âõ†‰∏∫‰ªéÈìæË°®Êñ≠ÂºÄÔºåËÄåÂèØË¢´ÂûÉÂúæÂõûÊî∂</li></ol><p>Â¶ÇÊûúËøôÊó∂ÂÄôÊúâÂÖ∂ÂÆÉÁ∫øÁ®ãÊù•Á´û‰∫âÔºàÈùûÂÖ¨Âπ≥ÁöÑ‰ΩìÁé∞ÔºâÔºå‰æãÂ¶ÇËøôÊó∂Êúâ Thread-4 Êù•‰∫Ü</p><figure><img src="https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230719155831915.png" alt="image-20230719155831915" loading="lazy" decoding="async"></figure><p>Â¶ÇÊûú‰∏çÂ∑ßÂèàË¢´ Thread-4 Âç†‰∫ÜÂÖà</p><ol><li>Thread-4 Ë¢´ËÆæÁΩÆ‰∏∫ exclusiveOwnerThreadÔºåstate = 1</li><li>Thread-1 ÂÜçÊ¨°ËøõÂÖ• acquireQueued ÊµÅÁ®ãÔºåËé∑ÂèñÈîÅÂ§±Ë¥•ÔºåÈáçÊñ∞ËøõÂÖ• park ÈòªÂ°û</li></ol><h5 id="Âä†ÈîÅÊ∫êÁ†Å" tabindex="-1">Âä†ÈîÅÊ∫êÁ†Å <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20advanced%20chapter#Âä†ÈîÅÊ∫êÁ†Å" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h5><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6a737d">// Sync ÁªßÊâøËá™ AQS</span></span>
<span class="line"><span style="color:#f97583">static</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">final</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">class</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">NonfairSync</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">extends</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Sync</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">private</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">static</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">final</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">long</span><span style="color:#e1e4e8"> serialVersionUID </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">7316153563782823691L</span><span style="color:#e1e4e8">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">     </span><span style="color:#6a737d">// Âä†ÈîÅÂÆûÁé∞</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">final</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">void</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">lock</span><span style="color:#e1e4e8">() {</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#6a737d">// È¶ñÂÖàÁî® cas Â∞ùËØïÔºà‰ªÖÂ∞ùËØï‰∏ÄÊ¨°ÔºâÂ∞Ü state ‰ªé 0 Êîπ‰∏∫ 1, Â¶ÇÊûúÊàêÂäüË°®Á§∫Ëé∑Âæó‰∫ÜÁã¨Âç†ÈîÅ</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (</span><span style="color:#b392f0">compareAndSetState</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8">, </span><span style="color:#79b8ff">1</span><span style="color:#e1e4e8">))</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#b392f0">setExclusiveOwnerThread</span><span style="color:#e1e4e8">(Thread.</span><span style="color:#b392f0">currentThread</span><span style="color:#e1e4e8">());</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">else</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#6a737d">// Â¶ÇÊûúÂ∞ùËØïÂ§±Ë¥•ÔºåËøõÂÖ• „à†</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#b392f0">acquire</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">1</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">// „à† AQS ÁªßÊâøËøáÊù•ÁöÑÊñπÊ≥ï, Êñπ‰æøÈòÖËØª, ÊîæÂú®Ê≠§Â§Ñ</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">final</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">void</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">acquire</span><span style="color:#e1e4e8">(</span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> </span><span style="color:#ffab70">arg</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#6a737d">// „à° tryAcquire</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#f97583">!</span><span style="color:#b392f0">tryAcquire</span><span style="color:#e1e4e8">(arg) </span><span style="color:#f97583">&amp;&amp;</span></span>
<span class="line"><span style="color:#e1e4e8">            	</span><span style="color:#6a737d">// ÂΩì tryAcquire ËøîÂõû‰∏∫ false Êó∂, ÂÖàË∞ÉÁî® addWaiter „à£, Êé•ÁùÄ acquireQueued „à§</span></span>
<span class="line"><span style="color:#e1e4e8">                 </span><span style="color:#b392f0">acquireQueued</span><span style="color:#e1e4e8">(</span><span style="color:#b392f0">addWaiter</span><span style="color:#e1e4e8">(Node.EXCLUSIVE), arg)</span></span>
<span class="line"><span style="color:#e1e4e8">        ) {</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#b392f0">selfInterrupt</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">        }</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">// „à° ËøõÂÖ• „à¢</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">protected</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">final</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">boolean</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">tryAcquire</span><span style="color:#e1e4e8">(</span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> </span><span style="color:#ffab70">acquires</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">nonfairTryAcquire</span><span style="color:#e1e4e8">(acquires);</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">// „à¢ Sync ÁªßÊâøËøáÊù•ÁöÑÊñπÊ≥ï, Êñπ‰æøÈòÖËØª, ÊîæÂú®Ê≠§Â§Ñ</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">final</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">boolean</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">nonfairTryAcquire</span><span style="color:#e1e4e8">(</span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> </span><span style="color:#ffab70">acquires</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">final</span><span style="color:#e1e4e8"> Thread current </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> Thread.</span><span style="color:#b392f0">currentThread</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> c </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">getState</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#6a737d">// Â¶ÇÊûúËøòÊ≤°ÊúâËé∑ÂæóÈîÅ</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (c </span><span style="color:#f97583">==</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#6a737d">// Â∞ùËØïÁî® cas Ëé∑Âæó, ËøôÈáå‰ΩìÁé∞‰∫ÜÈùûÂÖ¨Âπ≥ÊÄß: ‰∏çÂéªÊ£ÄÊü• AQS ÈòüÂàó</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (</span><span style="color:#b392f0">compareAndSetState</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8">, acquires)) {</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#b392f0">setExclusiveOwnerThread</span><span style="color:#e1e4e8">(current);</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">true</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">            }</span></span>
<span class="line"><span style="color:#e1e4e8">        }</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#6a737d">// Â¶ÇÊûúÂ∑≤ÁªèËé∑Âæó‰∫ÜÈîÅ, Á∫øÁ®ãËøòÊòØÂΩìÂâçÁ∫øÁ®ã, Ë°®Á§∫ÂèëÁîü‰∫ÜÈîÅÈáçÂÖ•</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">else</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (current </span><span style="color:#f97583">==</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">getExclusiveOwnerThread</span><span style="color:#e1e4e8">()) {</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#6a737d">// state++</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> nextc </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> c </span><span style="color:#f97583">+</span><span style="color:#e1e4e8"> acquires;</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (nextc </span><span style="color:#f97583">&lt;</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8">) </span><span style="color:#6a737d">// overflow</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#f97583">throw</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Error</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"Maximum lock count exceeded"</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#b392f0">setState</span><span style="color:#e1e4e8">(nextc);</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">true</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">        }</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#6a737d">// Ëé∑ÂèñÂ§±Ë¥•, ÂõûÂà∞Ë∞ÉÁî®Â§Ñ</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">false</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">// „à£ AQS ÁªßÊâøËøáÊù•ÁöÑÊñπÊ≥ï, Êñπ‰æøÈòÖËØª, ÊîæÂú®Ê≠§Â§Ñ</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">private</span><span style="color:#e1e4e8"> Node </span><span style="color:#b392f0">addWaiter</span><span style="color:#e1e4e8">(Node </span><span style="color:#ffab70">mode</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#6a737d">// Â∞ÜÂΩìÂâçÁ∫øÁ®ãÂÖ≥ËÅîÂà∞‰∏Ä‰∏™ Node ÂØπË±°‰∏ä, Ê®°Âºè‰∏∫Áã¨Âç†Ê®°ÂºèÔºåÊñ∞Âª∫ÁöÑNodeÁöÑwaitstatusÈªòËÆ§‰∏∫0ÔºåÂõ†‰∏∫waitstatusÊòØÊàêÂëòÂèòÈáèÔºåÈªòËÆ§Ë¢´ÂàùÂßãÂåñ‰∏∫0</span></span>
<span class="line"><span style="color:#e1e4e8">        Node node </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Node</span><span style="color:#e1e4e8">(Thread.</span><span style="color:#b392f0">currentThread</span><span style="color:#e1e4e8">(), mode);</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#6a737d">// Â¶ÇÊûú tail ‰∏ç‰∏∫ null, cas Â∞ùËØïÂ∞Ü Node ÂØπË±°Âä†ÂÖ• AQS ÈòüÂàóÂ∞æÈÉ®</span></span>
<span class="line"><span style="color:#e1e4e8">        Node pred </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> tail;</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (pred </span><span style="color:#f97583">!=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">            node.prev </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> pred;</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (</span><span style="color:#b392f0">compareAndSetTail</span><span style="color:#e1e4e8">(pred, node)) {</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#6a737d">// ÂèåÂêëÈìæË°®</span></span>
<span class="line"><span style="color:#e1e4e8">                pred.next </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> node;</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> node;</span></span>
<span class="line"><span style="color:#e1e4e8">            }</span></span>
<span class="line"><span style="color:#e1e4e8">        }</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#6a737d">//Â¶ÇÊûútail‰∏∫nullÔºåÂ∞ùËØïÂ∞Ü Node Âä†ÂÖ• AQS, ËøõÂÖ• „à•</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#b392f0">enq</span><span style="color:#e1e4e8">(node);</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> node;</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">// „à• AQS ÁªßÊâøËøáÊù•ÁöÑÊñπÊ≥ï, Êñπ‰æøÈòÖËØª, ÊîæÂú®Ê≠§Â§Ñ</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">private</span><span style="color:#e1e4e8"> Node </span><span style="color:#b392f0">enq</span><span style="color:#e1e4e8">(</span><span style="color:#f97583">final</span><span style="color:#e1e4e8"> Node </span><span style="color:#ffab70">node</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">for</span><span style="color:#e1e4e8"> (;;) {</span></span>
<span class="line"><span style="color:#e1e4e8">            Node t </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> tail;</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (t </span><span style="color:#f97583">==</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#6a737d">// ËøòÊ≤°Êúâ, ËÆæÁΩÆ head ‰∏∫Âì®ÂÖµËäÇÁÇπÔºà‰∏çÂØπÂ∫îÁ∫øÁ®ãÔºåÁä∂ÊÄÅ‰∏∫ 0Ôºâ</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (</span><span style="color:#b392f0">compareAndSetHead</span><span style="color:#e1e4e8">(</span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Node</span><span style="color:#e1e4e8">())) {</span></span>
<span class="line"><span style="color:#e1e4e8">                    tail </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> head;</span></span>
<span class="line"><span style="color:#e1e4e8">                }</span></span>
<span class="line"><span style="color:#e1e4e8">            } </span><span style="color:#f97583">else</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#6a737d">// cas Â∞ùËØïÂ∞Ü Node ÂØπË±°Âä†ÂÖ• AQS ÈòüÂàóÂ∞æÈÉ®</span></span>
<span class="line"><span style="color:#e1e4e8">                node.prev </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> t;</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (</span><span style="color:#b392f0">compareAndSetTail</span><span style="color:#e1e4e8">(t, node)) {</span></span>
<span class="line"><span style="color:#e1e4e8">                    t.next </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> node;</span></span>
<span class="line"><span style="color:#e1e4e8">                    </span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> t;</span></span>
<span class="line"><span style="color:#e1e4e8">                }</span></span>
<span class="line"><span style="color:#e1e4e8">            }</span></span>
<span class="line"><span style="color:#e1e4e8">        }</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">// „à§ AQS ÁªßÊâøËøáÊù•ÁöÑÊñπÊ≥ï, Êñπ‰æøÈòÖËØª, ÊîæÂú®Ê≠§Â§Ñ</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">final</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">boolean</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">acquireQueued</span><span style="color:#e1e4e8">(</span><span style="color:#f97583">final</span><span style="color:#e1e4e8"> Node </span><span style="color:#ffab70">node</span><span style="color:#e1e4e8">, </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> </span><span style="color:#ffab70">arg</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">boolean</span><span style="color:#e1e4e8"> failed </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">true</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">try</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">boolean</span><span style="color:#e1e4e8"> interrupted </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">false</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">for</span><span style="color:#e1e4e8"> (;;) {</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#f97583">final</span><span style="color:#e1e4e8"> Node p </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> node.</span><span style="color:#b392f0">predecessor</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#6a737d">// ‰∏ä‰∏Ä‰∏™ËäÇÁÇπÊòØ head, Ë°®Á§∫ËΩÆÂà∞Ëá™Â∑±ÔºàÂΩìÂâçÁ∫øÁ®ãÂØπÂ∫îÁöÑ nodeÔºâ‰∫Ü, Â∞ùËØïËé∑Âèñ</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (p </span><span style="color:#f97583">==</span><span style="color:#e1e4e8"> head </span><span style="color:#f97583">&amp;&amp;</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">tryAcquire</span><span style="color:#e1e4e8">(arg)) {</span></span>
<span class="line"><span style="color:#e1e4e8">                    </span><span style="color:#6a737d">// Ëé∑ÂèñÊàêÂäü, ËÆæÁΩÆËá™Â∑±ÔºàÂΩìÂâçÁ∫øÁ®ãÂØπÂ∫îÁöÑ nodeÔºâ‰∏∫ head</span></span>
<span class="line"><span style="color:#e1e4e8">                    </span><span style="color:#b392f0">setHead</span><span style="color:#e1e4e8">(node);</span></span>
<span class="line"><span style="color:#e1e4e8">                    </span><span style="color:#6a737d">// ‰∏ä‰∏Ä‰∏™ËäÇÁÇπ help GC</span></span>
<span class="line"><span style="color:#e1e4e8">                    p.next </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">                    failed </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">false</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">                    </span><span style="color:#6a737d">// ËøîÂõû‰∏≠Êñ≠Ê†áËÆ∞ false</span></span>
<span class="line"><span style="color:#e1e4e8">                    </span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> interrupted;</span></span>
<span class="line"><span style="color:#e1e4e8">                }</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (</span></span>
<span class="line"><span style="color:#e1e4e8">                    </span><span style="color:#6a737d">// Âà§Êñ≠ÊòØÂê¶Â∫îÂΩì park, ËøõÂÖ• „à¶</span></span>
<span class="line"><span style="color:#e1e4e8">                    </span><span style="color:#b392f0">shouldParkAfterFailedAcquire</span><span style="color:#e1e4e8">(p, node) </span><span style="color:#f97583">&amp;&amp;</span></span>
<span class="line"><span style="color:#e1e4e8">                    </span><span style="color:#6a737d">// park Á≠âÂæÖ, Ê≠§Êó∂ Node ÁöÑÁä∂ÊÄÅË¢´ÁΩÆ‰∏∫ Node.SIGNAL „àß</span></span>
<span class="line"><span style="color:#e1e4e8">                    </span><span style="color:#b392f0">parkAndCheckInterrupt</span><span style="color:#e1e4e8">()</span></span>
<span class="line"><span style="color:#e1e4e8">                ) {</span></span>
<span class="line"><span style="color:#e1e4e8">                    interrupted </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">true</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">                }</span></span>
<span class="line"><span style="color:#e1e4e8">            }</span></span>
<span class="line"><span style="color:#e1e4e8">        } </span><span style="color:#f97583">finally</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (failed)</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#b392f0">cancelAcquire</span><span style="color:#e1e4e8">(node);</span></span>
<span class="line"><span style="color:#e1e4e8">        }</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">// „à¶ AQS ÁªßÊâøËøáÊù•ÁöÑÊñπÊ≥ï, Êñπ‰æøÈòÖËØª, ÊîæÂú®Ê≠§Â§Ñ</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">private</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">static</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">boolean</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">shouldParkAfterFailedAcquire</span><span style="color:#e1e4e8">(Node </span><span style="color:#ffab70">pred</span><span style="color:#e1e4e8">, Node </span><span style="color:#ffab70">node</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#6a737d">// Ëé∑Âèñ‰∏ä‰∏Ä‰∏™ËäÇÁÇπÁöÑÁä∂ÊÄÅ</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> ws </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> pred.waitStatus;</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (ws </span><span style="color:#f97583">==</span><span style="color:#e1e4e8"> Node.SIGNAL) {</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#6a737d">// ‰∏ä‰∏Ä‰∏™ËäÇÁÇπÈÉΩÂú®ÈòªÂ°û, ÈÇ£‰πàËá™Â∑±‰πüÈòªÂ°ûÂ•Ω‰∫Ü</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">true</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">        }</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#6a737d">// &gt; 0 Ë°®Á§∫ÂèñÊ∂àÁä∂ÊÄÅ</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (ws </span><span style="color:#f97583">&gt;</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#6a737d">// ‰∏ä‰∏Ä‰∏™ËäÇÁÇπÂèñÊ∂à, ÈÇ£‰πàÈáçÊûÑÂà†Èô§ÂâçÈù¢ÊâÄÊúâÂèñÊ∂àÁöÑËäÇÁÇπ, ËøîÂõûÂà∞Â§ñÂ±ÇÂæ™ÁéØÈáçËØï</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">do</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">                node.prev </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> pred </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> pred.prev;</span></span>
<span class="line"><span style="color:#e1e4e8">            } </span><span style="color:#f97583">while</span><span style="color:#e1e4e8"> (pred.waitStatus </span><span style="color:#f97583">&gt;</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">            pred.next </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> node;</span></span>
<span class="line"><span style="color:#e1e4e8">        } </span><span style="color:#f97583">else</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#6a737d">// ËøôÊ¨°ËøòÊ≤°ÊúâÈòªÂ°û</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#6a737d">// ‰ΩÜ‰∏ãÊ¨°Â¶ÇÊûúÈáçËØï‰∏çÊàêÂäü, ÂàôÈúÄË¶ÅÈòªÂ°ûÔºåËøôÊó∂ÈúÄË¶ÅËÆæÁΩÆ‰∏ä‰∏Ä‰∏™ËäÇÁÇπÁä∂ÊÄÅ‰∏∫ Node.SIGNAL</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#b392f0">compareAndSetWaitStatus</span><span style="color:#e1e4e8">(pred, ws, Node.SIGNAL);</span></span>
<span class="line"><span style="color:#e1e4e8">        }</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">false</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">// „àß ÈòªÂ°ûÂΩìÂâçÁ∫øÁ®ã</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">private</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">final</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">boolean</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">parkAndCheckInterrupt</span><span style="color:#e1e4e8">() {</span></span>
<span class="line"><span style="color:#e1e4e8">        LockSupport.</span><span style="color:#b392f0">park</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">this</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> Thread.</span><span style="color:#b392f0">interrupted</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"><span style="color:#e1e4e8">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6a737d">// Sync ÁªßÊâøËá™ AQS</span></span>
<span class="line"><span style="color:#d73a49">static</span><span style="color:#24292e"> </span><span style="color:#d73a49">final</span><span style="color:#24292e"> </span><span style="color:#d73a49">class</span><span style="color:#24292e"> </span><span style="color:#6f42c1">NonfairSync</span><span style="color:#24292e"> </span><span style="color:#d73a49">extends</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Sync</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">private</span><span style="color:#24292e"> </span><span style="color:#d73a49">static</span><span style="color:#24292e"> </span><span style="color:#d73a49">final</span><span style="color:#24292e"> </span><span style="color:#d73a49">long</span><span style="color:#24292e"> serialVersionUID </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#005cc5">7316153563782823691L</span><span style="color:#24292e">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">     </span><span style="color:#6a737d">// Âä†ÈîÅÂÆûÁé∞</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">final</span><span style="color:#24292e"> </span><span style="color:#d73a49">void</span><span style="color:#24292e"> </span><span style="color:#6f42c1">lock</span><span style="color:#24292e">() {</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6a737d">// È¶ñÂÖàÁî® cas Â∞ùËØïÔºà‰ªÖÂ∞ùËØï‰∏ÄÊ¨°ÔºâÂ∞Ü state ‰ªé 0 Êîπ‰∏∫ 1, Â¶ÇÊûúÊàêÂäüË°®Á§∫Ëé∑Âæó‰∫ÜÁã¨Âç†ÈîÅ</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (</span><span style="color:#6f42c1">compareAndSetState</span><span style="color:#24292e">(</span><span style="color:#005cc5">0</span><span style="color:#24292e">, </span><span style="color:#005cc5">1</span><span style="color:#24292e">))</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#6f42c1">setExclusiveOwnerThread</span><span style="color:#24292e">(Thread.</span><span style="color:#6f42c1">currentThread</span><span style="color:#24292e">());</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">else</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#6a737d">// Â¶ÇÊûúÂ∞ùËØïÂ§±Ë¥•ÔºåËøõÂÖ• „à†</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#6f42c1">acquire</span><span style="color:#24292e">(</span><span style="color:#005cc5">1</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">// „à† AQS ÁªßÊâøËøáÊù•ÁöÑÊñπÊ≥ï, Êñπ‰æøÈòÖËØª, ÊîæÂú®Ê≠§Â§Ñ</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">final</span><span style="color:#24292e"> </span><span style="color:#d73a49">void</span><span style="color:#24292e"> </span><span style="color:#6f42c1">acquire</span><span style="color:#24292e">(</span><span style="color:#d73a49">int</span><span style="color:#24292e"> </span><span style="color:#e36209">arg</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6a737d">// „à° tryAcquire</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#d73a49">!</span><span style="color:#6f42c1">tryAcquire</span><span style="color:#24292e">(arg) </span><span style="color:#d73a49">&amp;&amp;</span></span>
<span class="line"><span style="color:#24292e">            	</span><span style="color:#6a737d">// ÂΩì tryAcquire ËøîÂõû‰∏∫ false Êó∂, ÂÖàË∞ÉÁî® addWaiter „à£, Êé•ÁùÄ acquireQueued „à§</span></span>
<span class="line"><span style="color:#24292e">                 </span><span style="color:#6f42c1">acquireQueued</span><span style="color:#24292e">(</span><span style="color:#6f42c1">addWaiter</span><span style="color:#24292e">(Node.EXCLUSIVE), arg)</span></span>
<span class="line"><span style="color:#24292e">        ) {</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#6f42c1">selfInterrupt</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">        }</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">// „à° ËøõÂÖ• „à¢</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">protected</span><span style="color:#24292e"> </span><span style="color:#d73a49">final</span><span style="color:#24292e"> </span><span style="color:#d73a49">boolean</span><span style="color:#24292e"> </span><span style="color:#6f42c1">tryAcquire</span><span style="color:#24292e">(</span><span style="color:#d73a49">int</span><span style="color:#24292e"> </span><span style="color:#e36209">acquires</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">return</span><span style="color:#24292e"> </span><span style="color:#6f42c1">nonfairTryAcquire</span><span style="color:#24292e">(acquires);</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">// „à¢ Sync ÁªßÊâøËøáÊù•ÁöÑÊñπÊ≥ï, Êñπ‰æøÈòÖËØª, ÊîæÂú®Ê≠§Â§Ñ</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">final</span><span style="color:#24292e"> </span><span style="color:#d73a49">boolean</span><span style="color:#24292e"> </span><span style="color:#6f42c1">nonfairTryAcquire</span><span style="color:#24292e">(</span><span style="color:#d73a49">int</span><span style="color:#24292e"> </span><span style="color:#e36209">acquires</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">final</span><span style="color:#24292e"> Thread current </span><span style="color:#d73a49">=</span><span style="color:#24292e"> Thread.</span><span style="color:#6f42c1">currentThread</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">int</span><span style="color:#24292e"> c </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#6f42c1">getState</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6a737d">// Â¶ÇÊûúËøòÊ≤°ÊúâËé∑ÂæóÈîÅ</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (c </span><span style="color:#d73a49">==</span><span style="color:#24292e"> </span><span style="color:#005cc5">0</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#6a737d">// Â∞ùËØïÁî® cas Ëé∑Âæó, ËøôÈáå‰ΩìÁé∞‰∫ÜÈùûÂÖ¨Âπ≥ÊÄß: ‰∏çÂéªÊ£ÄÊü• AQS ÈòüÂàó</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (</span><span style="color:#6f42c1">compareAndSetState</span><span style="color:#24292e">(</span><span style="color:#005cc5">0</span><span style="color:#24292e">, acquires)) {</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#6f42c1">setExclusiveOwnerThread</span><span style="color:#24292e">(current);</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#d73a49">return</span><span style="color:#24292e"> </span><span style="color:#005cc5">true</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">            }</span></span>
<span class="line"><span style="color:#24292e">        }</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6a737d">// Â¶ÇÊûúÂ∑≤ÁªèËé∑Âæó‰∫ÜÈîÅ, Á∫øÁ®ãËøòÊòØÂΩìÂâçÁ∫øÁ®ã, Ë°®Á§∫ÂèëÁîü‰∫ÜÈîÅÈáçÂÖ•</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">else</span><span style="color:#24292e"> </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (current </span><span style="color:#d73a49">==</span><span style="color:#24292e"> </span><span style="color:#6f42c1">getExclusiveOwnerThread</span><span style="color:#24292e">()) {</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#6a737d">// state++</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">int</span><span style="color:#24292e"> nextc </span><span style="color:#d73a49">=</span><span style="color:#24292e"> c </span><span style="color:#d73a49">+</span><span style="color:#24292e"> acquires;</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (nextc </span><span style="color:#d73a49">&lt;</span><span style="color:#24292e"> </span><span style="color:#005cc5">0</span><span style="color:#24292e">) </span><span style="color:#6a737d">// overflow</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#d73a49">throw</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Error</span><span style="color:#24292e">(</span><span style="color:#032f62">"Maximum lock count exceeded"</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#6f42c1">setState</span><span style="color:#24292e">(nextc);</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">return</span><span style="color:#24292e"> </span><span style="color:#005cc5">true</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">        }</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6a737d">// Ëé∑ÂèñÂ§±Ë¥•, ÂõûÂà∞Ë∞ÉÁî®Â§Ñ</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">return</span><span style="color:#24292e"> </span><span style="color:#005cc5">false</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">// „à£ AQS ÁªßÊâøËøáÊù•ÁöÑÊñπÊ≥ï, Êñπ‰æøÈòÖËØª, ÊîæÂú®Ê≠§Â§Ñ</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">private</span><span style="color:#24292e"> Node </span><span style="color:#6f42c1">addWaiter</span><span style="color:#24292e">(Node </span><span style="color:#e36209">mode</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#6a737d">// Â∞ÜÂΩìÂâçÁ∫øÁ®ãÂÖ≥ËÅîÂà∞‰∏Ä‰∏™ Node ÂØπË±°‰∏ä, Ê®°Âºè‰∏∫Áã¨Âç†Ê®°ÂºèÔºåÊñ∞Âª∫ÁöÑNodeÁöÑwaitstatusÈªòËÆ§‰∏∫0ÔºåÂõ†‰∏∫waitstatusÊòØÊàêÂëòÂèòÈáèÔºåÈªòËÆ§Ë¢´ÂàùÂßãÂåñ‰∏∫0</span></span>
<span class="line"><span style="color:#24292e">        Node node </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Node</span><span style="color:#24292e">(Thread.</span><span style="color:#6f42c1">currentThread</span><span style="color:#24292e">(), mode);</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6a737d">// Â¶ÇÊûú tail ‰∏ç‰∏∫ null, cas Â∞ùËØïÂ∞Ü Node ÂØπË±°Âä†ÂÖ• AQS ÈòüÂàóÂ∞æÈÉ®</span></span>
<span class="line"><span style="color:#24292e">        Node pred </span><span style="color:#d73a49">=</span><span style="color:#24292e"> tail;</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (pred </span><span style="color:#d73a49">!=</span><span style="color:#24292e"> </span><span style="color:#005cc5">null</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">            node.prev </span><span style="color:#d73a49">=</span><span style="color:#24292e"> pred;</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (</span><span style="color:#6f42c1">compareAndSetTail</span><span style="color:#24292e">(pred, node)) {</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#6a737d">// ÂèåÂêëÈìæË°®</span></span>
<span class="line"><span style="color:#24292e">                pred.next </span><span style="color:#d73a49">=</span><span style="color:#24292e"> node;</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#d73a49">return</span><span style="color:#24292e"> node;</span></span>
<span class="line"><span style="color:#24292e">            }</span></span>
<span class="line"><span style="color:#24292e">        }</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6a737d">//Â¶ÇÊûútail‰∏∫nullÔºåÂ∞ùËØïÂ∞Ü Node Âä†ÂÖ• AQS, ËøõÂÖ• „à•</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6f42c1">enq</span><span style="color:#24292e">(node);</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">return</span><span style="color:#24292e"> node;</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">// „à• AQS ÁªßÊâøËøáÊù•ÁöÑÊñπÊ≥ï, Êñπ‰æøÈòÖËØª, ÊîæÂú®Ê≠§Â§Ñ</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">private</span><span style="color:#24292e"> Node </span><span style="color:#6f42c1">enq</span><span style="color:#24292e">(</span><span style="color:#d73a49">final</span><span style="color:#24292e"> Node </span><span style="color:#e36209">node</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">for</span><span style="color:#24292e"> (;;) {</span></span>
<span class="line"><span style="color:#24292e">            Node t </span><span style="color:#d73a49">=</span><span style="color:#24292e"> tail;</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (t </span><span style="color:#d73a49">==</span><span style="color:#24292e"> </span><span style="color:#005cc5">null</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#6a737d">// ËøòÊ≤°Êúâ, ËÆæÁΩÆ head ‰∏∫Âì®ÂÖµËäÇÁÇπÔºà‰∏çÂØπÂ∫îÁ∫øÁ®ãÔºåÁä∂ÊÄÅ‰∏∫ 0Ôºâ</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (</span><span style="color:#6f42c1">compareAndSetHead</span><span style="color:#24292e">(</span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Node</span><span style="color:#24292e">())) {</span></span>
<span class="line"><span style="color:#24292e">                    tail </span><span style="color:#d73a49">=</span><span style="color:#24292e"> head;</span></span>
<span class="line"><span style="color:#24292e">                }</span></span>
<span class="line"><span style="color:#24292e">            } </span><span style="color:#d73a49">else</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#6a737d">// cas Â∞ùËØïÂ∞Ü Node ÂØπË±°Âä†ÂÖ• AQS ÈòüÂàóÂ∞æÈÉ®</span></span>
<span class="line"><span style="color:#24292e">                node.prev </span><span style="color:#d73a49">=</span><span style="color:#24292e"> t;</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (</span><span style="color:#6f42c1">compareAndSetTail</span><span style="color:#24292e">(t, node)) {</span></span>
<span class="line"><span style="color:#24292e">                    t.next </span><span style="color:#d73a49">=</span><span style="color:#24292e"> node;</span></span>
<span class="line"><span style="color:#24292e">                    </span><span style="color:#d73a49">return</span><span style="color:#24292e"> t;</span></span>
<span class="line"><span style="color:#24292e">                }</span></span>
<span class="line"><span style="color:#24292e">            }</span></span>
<span class="line"><span style="color:#24292e">        }</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">// „à§ AQS ÁªßÊâøËøáÊù•ÁöÑÊñπÊ≥ï, Êñπ‰æøÈòÖËØª, ÊîæÂú®Ê≠§Â§Ñ</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">final</span><span style="color:#24292e"> </span><span style="color:#d73a49">boolean</span><span style="color:#24292e"> </span><span style="color:#6f42c1">acquireQueued</span><span style="color:#24292e">(</span><span style="color:#d73a49">final</span><span style="color:#24292e"> Node </span><span style="color:#e36209">node</span><span style="color:#24292e">, </span><span style="color:#d73a49">int</span><span style="color:#24292e"> </span><span style="color:#e36209">arg</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">boolean</span><span style="color:#24292e"> failed </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#005cc5">true</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">try</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">boolean</span><span style="color:#24292e"> interrupted </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#005cc5">false</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">for</span><span style="color:#24292e"> (;;) {</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#d73a49">final</span><span style="color:#24292e"> Node p </span><span style="color:#d73a49">=</span><span style="color:#24292e"> node.</span><span style="color:#6f42c1">predecessor</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#6a737d">// ‰∏ä‰∏Ä‰∏™ËäÇÁÇπÊòØ head, Ë°®Á§∫ËΩÆÂà∞Ëá™Â∑±ÔºàÂΩìÂâçÁ∫øÁ®ãÂØπÂ∫îÁöÑ nodeÔºâ‰∫Ü, Â∞ùËØïËé∑Âèñ</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (p </span><span style="color:#d73a49">==</span><span style="color:#24292e"> head </span><span style="color:#d73a49">&amp;&amp;</span><span style="color:#24292e"> </span><span style="color:#6f42c1">tryAcquire</span><span style="color:#24292e">(arg)) {</span></span>
<span class="line"><span style="color:#24292e">                    </span><span style="color:#6a737d">// Ëé∑ÂèñÊàêÂäü, ËÆæÁΩÆËá™Â∑±ÔºàÂΩìÂâçÁ∫øÁ®ãÂØπÂ∫îÁöÑ nodeÔºâ‰∏∫ head</span></span>
<span class="line"><span style="color:#24292e">                    </span><span style="color:#6f42c1">setHead</span><span style="color:#24292e">(node);</span></span>
<span class="line"><span style="color:#24292e">                    </span><span style="color:#6a737d">// ‰∏ä‰∏Ä‰∏™ËäÇÁÇπ help GC</span></span>
<span class="line"><span style="color:#24292e">                    p.next </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#005cc5">null</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">                    failed </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#005cc5">false</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">                    </span><span style="color:#6a737d">// ËøîÂõû‰∏≠Êñ≠Ê†áËÆ∞ false</span></span>
<span class="line"><span style="color:#24292e">                    </span><span style="color:#d73a49">return</span><span style="color:#24292e"> interrupted;</span></span>
<span class="line"><span style="color:#24292e">                }</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (</span></span>
<span class="line"><span style="color:#24292e">                    </span><span style="color:#6a737d">// Âà§Êñ≠ÊòØÂê¶Â∫îÂΩì park, ËøõÂÖ• „à¶</span></span>
<span class="line"><span style="color:#24292e">                    </span><span style="color:#6f42c1">shouldParkAfterFailedAcquire</span><span style="color:#24292e">(p, node) </span><span style="color:#d73a49">&amp;&amp;</span></span>
<span class="line"><span style="color:#24292e">                    </span><span style="color:#6a737d">// park Á≠âÂæÖ, Ê≠§Êó∂ Node ÁöÑÁä∂ÊÄÅË¢´ÁΩÆ‰∏∫ Node.SIGNAL „àß</span></span>
<span class="line"><span style="color:#24292e">                    </span><span style="color:#6f42c1">parkAndCheckInterrupt</span><span style="color:#24292e">()</span></span>
<span class="line"><span style="color:#24292e">                ) {</span></span>
<span class="line"><span style="color:#24292e">                    interrupted </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#005cc5">true</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">                }</span></span>
<span class="line"><span style="color:#24292e">            }</span></span>
<span class="line"><span style="color:#24292e">        } </span><span style="color:#d73a49">finally</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (failed)</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#6f42c1">cancelAcquire</span><span style="color:#24292e">(node);</span></span>
<span class="line"><span style="color:#24292e">        }</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">// „à¶ AQS ÁªßÊâøËøáÊù•ÁöÑÊñπÊ≥ï, Êñπ‰æøÈòÖËØª, ÊîæÂú®Ê≠§Â§Ñ</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">private</span><span style="color:#24292e"> </span><span style="color:#d73a49">static</span><span style="color:#24292e"> </span><span style="color:#d73a49">boolean</span><span style="color:#24292e"> </span><span style="color:#6f42c1">shouldParkAfterFailedAcquire</span><span style="color:#24292e">(Node </span><span style="color:#e36209">pred</span><span style="color:#24292e">, Node </span><span style="color:#e36209">node</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6a737d">// Ëé∑Âèñ‰∏ä‰∏Ä‰∏™ËäÇÁÇπÁöÑÁä∂ÊÄÅ</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">int</span><span style="color:#24292e"> ws </span><span style="color:#d73a49">=</span><span style="color:#24292e"> pred.waitStatus;</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (ws </span><span style="color:#d73a49">==</span><span style="color:#24292e"> Node.SIGNAL) {</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#6a737d">// ‰∏ä‰∏Ä‰∏™ËäÇÁÇπÈÉΩÂú®ÈòªÂ°û, ÈÇ£‰πàËá™Â∑±‰πüÈòªÂ°ûÂ•Ω‰∫Ü</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">return</span><span style="color:#24292e"> </span><span style="color:#005cc5">true</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">        }</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6a737d">// &gt; 0 Ë°®Á§∫ÂèñÊ∂àÁä∂ÊÄÅ</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (ws </span><span style="color:#d73a49">&gt;</span><span style="color:#24292e"> </span><span style="color:#005cc5">0</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#6a737d">// ‰∏ä‰∏Ä‰∏™ËäÇÁÇπÂèñÊ∂à, ÈÇ£‰πàÈáçÊûÑÂà†Èô§ÂâçÈù¢ÊâÄÊúâÂèñÊ∂àÁöÑËäÇÁÇπ, ËøîÂõûÂà∞Â§ñÂ±ÇÂæ™ÁéØÈáçËØï</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">do</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">                node.prev </span><span style="color:#d73a49">=</span><span style="color:#24292e"> pred </span><span style="color:#d73a49">=</span><span style="color:#24292e"> pred.prev;</span></span>
<span class="line"><span style="color:#24292e">            } </span><span style="color:#d73a49">while</span><span style="color:#24292e"> (pred.waitStatus </span><span style="color:#d73a49">&gt;</span><span style="color:#24292e"> </span><span style="color:#005cc5">0</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">            pred.next </span><span style="color:#d73a49">=</span><span style="color:#24292e"> node;</span></span>
<span class="line"><span style="color:#24292e">        } </span><span style="color:#d73a49">else</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#6a737d">// ËøôÊ¨°ËøòÊ≤°ÊúâÈòªÂ°û</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#6a737d">// ‰ΩÜ‰∏ãÊ¨°Â¶ÇÊûúÈáçËØï‰∏çÊàêÂäü, ÂàôÈúÄË¶ÅÈòªÂ°ûÔºåËøôÊó∂ÈúÄË¶ÅËÆæÁΩÆ‰∏ä‰∏Ä‰∏™ËäÇÁÇπÁä∂ÊÄÅ‰∏∫ Node.SIGNAL</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#6f42c1">compareAndSetWaitStatus</span><span style="color:#24292e">(pred, ws, Node.SIGNAL);</span></span>
<span class="line"><span style="color:#24292e">        }</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">return</span><span style="color:#24292e"> </span><span style="color:#005cc5">false</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">// „àß ÈòªÂ°ûÂΩìÂâçÁ∫øÁ®ã</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">private</span><span style="color:#24292e"> </span><span style="color:#d73a49">final</span><span style="color:#24292e"> </span><span style="color:#d73a49">boolean</span><span style="color:#24292e"> </span><span style="color:#6f42c1">parkAndCheckInterrupt</span><span style="color:#24292e">() {</span></span>
<span class="line"><span style="color:#24292e">        LockSupport.</span><span style="color:#6f42c1">park</span><span style="color:#24292e">(</span><span style="color:#005cc5">this</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">return</span><span style="color:#24292e"> Thread.</span><span style="color:#6f42c1">interrupted</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"><span style="color:#24292e">}</span></span></code></pre></div><blockquote><p><strong>Ê≥®ÊÑè</strong> ÊòØÂê¶ÈúÄË¶Å unpark ÊòØÁî±ÂΩìÂâçËäÇÁÇπÁöÑÂâçÈ©±ËäÇÁÇπÁöÑ <code>waitStatus == Node.SIGNAL</code> Êù•ÂÜ≥ÂÆöÔºåËÄå‰∏çÊòØÊú¨ËäÇÁÇπÁöÑwaitStatus ÂÜ≥ÂÆö</p></blockquote><h5 id="Ëß£ÈîÅÊ∫êÁ†Å" tabindex="-1">Ëß£ÈîÅÊ∫êÁ†Å <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20advanced%20chapter#Ëß£ÈîÅÊ∫êÁ†Å" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h5><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6a737d">// Sync ÁªßÊâøËá™ AQS</span></span>
<span class="line"><span style="color:#f97583">static</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">final</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">class</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">NonfairSync</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">extends</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Sync</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">// Ëß£ÈîÅÂÆûÁé∞</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">void</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">unlock</span><span style="color:#e1e4e8">() {</span></span>
<span class="line"><span style="color:#e1e4e8">        sync.</span><span style="color:#b392f0">release</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">1</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">// AQS ÁªßÊâøËøáÊù•ÁöÑÊñπÊ≥ï, Êñπ‰æøÈòÖËØª, ÊîæÂú®Ê≠§Â§Ñ</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">final</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">boolean</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">release</span><span style="color:#e1e4e8">(</span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> </span><span style="color:#ffab70">arg</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#6a737d">// Â∞ùËØïÈáäÊîæÈîÅ, ËøõÂÖ• „à†</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (</span><span style="color:#b392f0">tryRelease</span><span style="color:#e1e4e8">(arg)) {</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#6a737d">// ÈòüÂàóÂ§¥ËäÇÁÇπ unpark</span></span>
<span class="line"><span style="color:#e1e4e8">            Node h </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> head;</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#6a737d">// ÈòüÂàó‰∏ç‰∏∫ null</span></span>
<span class="line"><span style="color:#e1e4e8">                h </span><span style="color:#f97583">!=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">&amp;&amp;</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#6a737d">// waitStatus == Node.SIGNAL ÊâçÈúÄË¶Å unpark</span></span>
<span class="line"><span style="color:#e1e4e8">                h.waitStatus </span><span style="color:#f97583">!=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">0</span></span>
<span class="line"><span style="color:#e1e4e8">            ) {</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#6a737d">// unpark AQS ‰∏≠Á≠âÂæÖÁöÑÁ∫øÁ®ã, ËøõÂÖ• „à°</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#b392f0">unparkSuccessor</span><span style="color:#e1e4e8">(h);</span></span>
<span class="line"><span style="color:#e1e4e8">            }</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">true</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">        }</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">false</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">// „à† Sync ÁªßÊâøËøáÊù•ÁöÑÊñπÊ≥ï, Êñπ‰æøÈòÖËØª, ÊîæÂú®Ê≠§Â§Ñ</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">protected</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">final</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">boolean</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">tryRelease</span><span style="color:#e1e4e8">(</span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> </span><span style="color:#ffab70">releases</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#6a737d">// state--</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> c </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">getState</span><span style="color:#e1e4e8">() </span><span style="color:#f97583">-</span><span style="color:#e1e4e8"> releases;</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (Thread.</span><span style="color:#b392f0">currentThread</span><span style="color:#e1e4e8">() </span><span style="color:#f97583">!=</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">getExclusiveOwnerThread</span><span style="color:#e1e4e8">())</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">throw</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">IllegalMonitorStateException</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">boolean</span><span style="color:#e1e4e8"> free </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">false</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#6a737d">// ÊîØÊåÅÈîÅÈáçÂÖ•, Âè™Êúâ state Âáè‰∏∫ 0, ÊâçÈáäÊîæÊàêÂäü</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (c </span><span style="color:#f97583">==</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">            free </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">true</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#b392f0">setExclusiveOwnerThread</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">        }</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#b392f0">setState</span><span style="color:#e1e4e8">(c);</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> free;</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">// „à° AQS ÁªßÊâøËøáÊù•ÁöÑÊñπÊ≥ï, Êñπ‰æøÈòÖËØª, ÊîæÂú®Ê≠§Â§Ñ</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">private</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">void</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">unparkSuccessor</span><span style="color:#e1e4e8">(Node </span><span style="color:#ffab70">node</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#6a737d">// Â¶ÇÊûúÁä∂ÊÄÅ‰∏∫ Node.SIGNAL Â∞ùËØïÈáçÁΩÆÁä∂ÊÄÅ‰∏∫ 0, Â¶ÇÊûúÁ∫øÁ®ãËé∑ÂèñÂà∞‰∫ÜÈîÅÈÇ£‰πàÂêéÊù•Â§¥ÁªìÁÇπ‰ºöË¢´ÊäõÂºÉÊéâ</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#6a737d">// ‰∏çÊàêÂäü‰πüÂèØ‰ª•</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> ws </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> node.waitStatus;</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (ws </span><span style="color:#f97583">&lt;</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#b392f0">compareAndSetWaitStatus</span><span style="color:#e1e4e8">(node, ws, </span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">        }</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#6a737d">// ÊâæÂà∞ÈúÄË¶Å unpark ÁöÑËäÇÁÇπ, ‰ΩÜÊú¨ËäÇÁÇπ‰ªé AQS ÈòüÂàó‰∏≠ËÑ±Á¶ª, ÊòØÁî±Âî§ÈÜíËäÇÁÇπÂÆåÊàêÁöÑ</span></span>
<span class="line"><span style="color:#e1e4e8">        Node s </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> node.next;</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#6a737d">// ‰∏çËÄÉËôëÂ∑≤ÂèñÊ∂àÁöÑËäÇÁÇπ, ‰ªé AQS ÈòüÂàó‰ªéÂêéËá≥ÂâçÊâæÂà∞ÈòüÂàóÊúÄÂâçÈù¢ÈúÄË¶Å unpark ÁöÑËäÇÁÇπ</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (s </span><span style="color:#f97583">==</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">||</span><span style="color:#e1e4e8"> s.waitStatus </span><span style="color:#f97583">&gt;</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">            s </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">for</span><span style="color:#e1e4e8"> (Node t </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> tail; t </span><span style="color:#f97583">!=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">&amp;&amp;</span><span style="color:#e1e4e8"> t </span><span style="color:#f97583">!=</span><span style="color:#e1e4e8"> node; t </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> t.prev)</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (t.waitStatus </span><span style="color:#f97583">&lt;=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8">)</span></span>
<span class="line"><span style="color:#e1e4e8">                    s </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> t;</span></span>
<span class="line"><span style="color:#e1e4e8">        }</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (s </span><span style="color:#f97583">!=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8">)</span></span>
<span class="line"><span style="color:#e1e4e8">            LockSupport.</span><span style="color:#b392f0">unpark</span><span style="color:#e1e4e8">(s.thread);</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"><span style="color:#e1e4e8">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6a737d">// Sync ÁªßÊâøËá™ AQS</span></span>
<span class="line"><span style="color:#d73a49">static</span><span style="color:#24292e"> </span><span style="color:#d73a49">final</span><span style="color:#24292e"> </span><span style="color:#d73a49">class</span><span style="color:#24292e"> </span><span style="color:#6f42c1">NonfairSync</span><span style="color:#24292e"> </span><span style="color:#d73a49">extends</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Sync</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">// Ëß£ÈîÅÂÆûÁé∞</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">void</span><span style="color:#24292e"> </span><span style="color:#6f42c1">unlock</span><span style="color:#24292e">() {</span></span>
<span class="line"><span style="color:#24292e">        sync.</span><span style="color:#6f42c1">release</span><span style="color:#24292e">(</span><span style="color:#005cc5">1</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">// AQS ÁªßÊâøËøáÊù•ÁöÑÊñπÊ≥ï, Êñπ‰æøÈòÖËØª, ÊîæÂú®Ê≠§Â§Ñ</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">final</span><span style="color:#24292e"> </span><span style="color:#d73a49">boolean</span><span style="color:#24292e"> </span><span style="color:#6f42c1">release</span><span style="color:#24292e">(</span><span style="color:#d73a49">int</span><span style="color:#24292e"> </span><span style="color:#e36209">arg</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6a737d">// Â∞ùËØïÈáäÊîæÈîÅ, ËøõÂÖ• „à†</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (</span><span style="color:#6f42c1">tryRelease</span><span style="color:#24292e">(arg)) {</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#6a737d">// ÈòüÂàóÂ§¥ËäÇÁÇπ unpark</span></span>
<span class="line"><span style="color:#24292e">            Node h </span><span style="color:#d73a49">=</span><span style="color:#24292e"> head;</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#6a737d">// ÈòüÂàó‰∏ç‰∏∫ null</span></span>
<span class="line"><span style="color:#24292e">                h </span><span style="color:#d73a49">!=</span><span style="color:#24292e"> </span><span style="color:#005cc5">null</span><span style="color:#24292e"> </span><span style="color:#d73a49">&amp;&amp;</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#6a737d">// waitStatus == Node.SIGNAL ÊâçÈúÄË¶Å unpark</span></span>
<span class="line"><span style="color:#24292e">                h.waitStatus </span><span style="color:#d73a49">!=</span><span style="color:#24292e"> </span><span style="color:#005cc5">0</span></span>
<span class="line"><span style="color:#24292e">            ) {</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#6a737d">// unpark AQS ‰∏≠Á≠âÂæÖÁöÑÁ∫øÁ®ã, ËøõÂÖ• „à°</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#6f42c1">unparkSuccessor</span><span style="color:#24292e">(h);</span></span>
<span class="line"><span style="color:#24292e">            }</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">return</span><span style="color:#24292e"> </span><span style="color:#005cc5">true</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">        }</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">return</span><span style="color:#24292e"> </span><span style="color:#005cc5">false</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">// „à† Sync ÁªßÊâøËøáÊù•ÁöÑÊñπÊ≥ï, Êñπ‰æøÈòÖËØª, ÊîæÂú®Ê≠§Â§Ñ</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">protected</span><span style="color:#24292e"> </span><span style="color:#d73a49">final</span><span style="color:#24292e"> </span><span style="color:#d73a49">boolean</span><span style="color:#24292e"> </span><span style="color:#6f42c1">tryRelease</span><span style="color:#24292e">(</span><span style="color:#d73a49">int</span><span style="color:#24292e"> </span><span style="color:#e36209">releases</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6a737d">// state--</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">int</span><span style="color:#24292e"> c </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#6f42c1">getState</span><span style="color:#24292e">() </span><span style="color:#d73a49">-</span><span style="color:#24292e"> releases;</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (Thread.</span><span style="color:#6f42c1">currentThread</span><span style="color:#24292e">() </span><span style="color:#d73a49">!=</span><span style="color:#24292e"> </span><span style="color:#6f42c1">getExclusiveOwnerThread</span><span style="color:#24292e">())</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">throw</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">IllegalMonitorStateException</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">boolean</span><span style="color:#24292e"> free </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#005cc5">false</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6a737d">// ÊîØÊåÅÈîÅÈáçÂÖ•, Âè™Êúâ state Âáè‰∏∫ 0, ÊâçÈáäÊîæÊàêÂäü</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (c </span><span style="color:#d73a49">==</span><span style="color:#24292e"> </span><span style="color:#005cc5">0</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">            free </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#005cc5">true</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#6f42c1">setExclusiveOwnerThread</span><span style="color:#24292e">(</span><span style="color:#005cc5">null</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">        }</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6f42c1">setState</span><span style="color:#24292e">(c);</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">return</span><span style="color:#24292e"> free;</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">// „à° AQS ÁªßÊâøËøáÊù•ÁöÑÊñπÊ≥ï, Êñπ‰æøÈòÖËØª, ÊîæÂú®Ê≠§Â§Ñ</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">private</span><span style="color:#24292e"> </span><span style="color:#d73a49">void</span><span style="color:#24292e"> </span><span style="color:#6f42c1">unparkSuccessor</span><span style="color:#24292e">(Node </span><span style="color:#e36209">node</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6a737d">// Â¶ÇÊûúÁä∂ÊÄÅ‰∏∫ Node.SIGNAL Â∞ùËØïÈáçÁΩÆÁä∂ÊÄÅ‰∏∫ 0, Â¶ÇÊûúÁ∫øÁ®ãËé∑ÂèñÂà∞‰∫ÜÈîÅÈÇ£‰πàÂêéÊù•Â§¥ÁªìÁÇπ‰ºöË¢´ÊäõÂºÉÊéâ</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6a737d">// ‰∏çÊàêÂäü‰πüÂèØ‰ª•</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">int</span><span style="color:#24292e"> ws </span><span style="color:#d73a49">=</span><span style="color:#24292e"> node.waitStatus;</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (ws </span><span style="color:#d73a49">&lt;</span><span style="color:#24292e"> </span><span style="color:#005cc5">0</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#6f42c1">compareAndSetWaitStatus</span><span style="color:#24292e">(node, ws, </span><span style="color:#005cc5">0</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">        }</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6a737d">// ÊâæÂà∞ÈúÄË¶Å unpark ÁöÑËäÇÁÇπ, ‰ΩÜÊú¨ËäÇÁÇπ‰ªé AQS ÈòüÂàó‰∏≠ËÑ±Á¶ª, ÊòØÁî±Âî§ÈÜíËäÇÁÇπÂÆåÊàêÁöÑ</span></span>
<span class="line"><span style="color:#24292e">        Node s </span><span style="color:#d73a49">=</span><span style="color:#24292e"> node.next;</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6a737d">// ‰∏çËÄÉËôëÂ∑≤ÂèñÊ∂àÁöÑËäÇÁÇπ, ‰ªé AQS ÈòüÂàó‰ªéÂêéËá≥ÂâçÊâæÂà∞ÈòüÂàóÊúÄÂâçÈù¢ÈúÄË¶Å unpark ÁöÑËäÇÁÇπ</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (s </span><span style="color:#d73a49">==</span><span style="color:#24292e"> </span><span style="color:#005cc5">null</span><span style="color:#24292e"> </span><span style="color:#d73a49">||</span><span style="color:#24292e"> s.waitStatus </span><span style="color:#d73a49">&gt;</span><span style="color:#24292e"> </span><span style="color:#005cc5">0</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">            s </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#005cc5">null</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">for</span><span style="color:#24292e"> (Node t </span><span style="color:#d73a49">=</span><span style="color:#24292e"> tail; t </span><span style="color:#d73a49">!=</span><span style="color:#24292e"> </span><span style="color:#005cc5">null</span><span style="color:#24292e"> </span><span style="color:#d73a49">&amp;&amp;</span><span style="color:#24292e"> t </span><span style="color:#d73a49">!=</span><span style="color:#24292e"> node; t </span><span style="color:#d73a49">=</span><span style="color:#24292e"> t.prev)</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (t.waitStatus </span><span style="color:#d73a49">&lt;=</span><span style="color:#24292e"> </span><span style="color:#005cc5">0</span><span style="color:#24292e">)</span></span>
<span class="line"><span style="color:#24292e">                    s </span><span style="color:#d73a49">=</span><span style="color:#24292e"> t;</span></span>
<span class="line"><span style="color:#24292e">        }</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (s </span><span style="color:#d73a49">!=</span><span style="color:#24292e"> </span><span style="color:#005cc5">null</span><span style="color:#24292e">)</span></span>
<span class="line"><span style="color:#24292e">            LockSupport.</span><span style="color:#6f42c1">unpark</span><span style="color:#24292e">(s.thread);</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"><span style="color:#24292e">}</span></span></code></pre></div><h4 id="ÂèØÈáçÂÖ•ÂéüÁêÜ" tabindex="-1">ÂèØÈáçÂÖ•ÂéüÁêÜ <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20advanced%20chapter#ÂèØÈáçÂÖ•ÂéüÁêÜ" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h4><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#f97583">static</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">final</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">class</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">NonfairSync</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">extends</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Sync</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">// ...</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">// Sync ÁªßÊâøËøáÊù•ÁöÑÊñπÊ≥ï, Êñπ‰æøÈòÖËØª, ÊîæÂú®Ê≠§Â§Ñ</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">final</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">boolean</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">nonfairTryAcquire</span><span style="color:#e1e4e8">(</span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> </span><span style="color:#ffab70">acquires</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">final</span><span style="color:#e1e4e8"> Thread current </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> Thread.</span><span style="color:#b392f0">currentThread</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> c </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">getState</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (c </span><span style="color:#f97583">==</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (</span><span style="color:#b392f0">compareAndSetState</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8">, acquires)) {</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#b392f0">setExclusiveOwnerThread</span><span style="color:#e1e4e8">(current);</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">true</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">            }</span></span>
<span class="line"><span style="color:#e1e4e8">        }</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#6a737d">// Â¶ÇÊûúÂ∑≤ÁªèËé∑Âæó‰∫ÜÈîÅ, Á∫øÁ®ãËøòÊòØÂΩìÂâçÁ∫øÁ®ã, Ë°®Á§∫ÂèëÁîü‰∫ÜÈîÅÈáçÂÖ•</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">else</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (current </span><span style="color:#f97583">==</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">getExclusiveOwnerThread</span><span style="color:#e1e4e8">()) {</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#6a737d">// state++</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> nextc </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> c </span><span style="color:#f97583">+</span><span style="color:#e1e4e8"> acquires;</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (nextc </span><span style="color:#f97583">&lt;</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8">) </span><span style="color:#6a737d">// overflow</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#f97583">throw</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Error</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"Maximum lock count exceeded"</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#b392f0">setState</span><span style="color:#e1e4e8">(nextc);</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">true</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">        }</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">false</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">// Sync ÁªßÊâøËøáÊù•ÁöÑÊñπÊ≥ï, Êñπ‰æøÈòÖËØª, ÊîæÂú®Ê≠§Â§Ñ</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">protected</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">final</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">boolean</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">tryRelease</span><span style="color:#e1e4e8">(</span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> </span><span style="color:#ffab70">releases</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#6a737d">// state--</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> c </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">getState</span><span style="color:#e1e4e8">() </span><span style="color:#f97583">-</span><span style="color:#e1e4e8"> releases;</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (Thread.</span><span style="color:#b392f0">currentThread</span><span style="color:#e1e4e8">() </span><span style="color:#f97583">!=</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">getExclusiveOwnerThread</span><span style="color:#e1e4e8">())</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">throw</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">IllegalMonitorStateException</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">boolean</span><span style="color:#e1e4e8"> free </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">false</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#6a737d">// ÊîØÊåÅÈîÅÈáçÂÖ•, Âè™Êúâ state Âáè‰∏∫ 0, ÊâçÈáäÊîæÊàêÂäü</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (c </span><span style="color:#f97583">==</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">            free </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">true</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#b392f0">setExclusiveOwnerThread</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">        }</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#b392f0">setState</span><span style="color:#e1e4e8">(c);</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> free;</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"><span style="color:#e1e4e8">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#d73a49">static</span><span style="color:#24292e"> </span><span style="color:#d73a49">final</span><span style="color:#24292e"> </span><span style="color:#d73a49">class</span><span style="color:#24292e"> </span><span style="color:#6f42c1">NonfairSync</span><span style="color:#24292e"> </span><span style="color:#d73a49">extends</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Sync</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">// ...</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">// Sync ÁªßÊâøËøáÊù•ÁöÑÊñπÊ≥ï, Êñπ‰æøÈòÖËØª, ÊîæÂú®Ê≠§Â§Ñ</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">final</span><span style="color:#24292e"> </span><span style="color:#d73a49">boolean</span><span style="color:#24292e"> </span><span style="color:#6f42c1">nonfairTryAcquire</span><span style="color:#24292e">(</span><span style="color:#d73a49">int</span><span style="color:#24292e"> </span><span style="color:#e36209">acquires</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">final</span><span style="color:#24292e"> Thread current </span><span style="color:#d73a49">=</span><span style="color:#24292e"> Thread.</span><span style="color:#6f42c1">currentThread</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">int</span><span style="color:#24292e"> c </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#6f42c1">getState</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (c </span><span style="color:#d73a49">==</span><span style="color:#24292e"> </span><span style="color:#005cc5">0</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (</span><span style="color:#6f42c1">compareAndSetState</span><span style="color:#24292e">(</span><span style="color:#005cc5">0</span><span style="color:#24292e">, acquires)) {</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#6f42c1">setExclusiveOwnerThread</span><span style="color:#24292e">(current);</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#d73a49">return</span><span style="color:#24292e"> </span><span style="color:#005cc5">true</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">            }</span></span>
<span class="line"><span style="color:#24292e">        }</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6a737d">// Â¶ÇÊûúÂ∑≤ÁªèËé∑Âæó‰∫ÜÈîÅ, Á∫øÁ®ãËøòÊòØÂΩìÂâçÁ∫øÁ®ã, Ë°®Á§∫ÂèëÁîü‰∫ÜÈîÅÈáçÂÖ•</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">else</span><span style="color:#24292e"> </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (current </span><span style="color:#d73a49">==</span><span style="color:#24292e"> </span><span style="color:#6f42c1">getExclusiveOwnerThread</span><span style="color:#24292e">()) {</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#6a737d">// state++</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">int</span><span style="color:#24292e"> nextc </span><span style="color:#d73a49">=</span><span style="color:#24292e"> c </span><span style="color:#d73a49">+</span><span style="color:#24292e"> acquires;</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (nextc </span><span style="color:#d73a49">&lt;</span><span style="color:#24292e"> </span><span style="color:#005cc5">0</span><span style="color:#24292e">) </span><span style="color:#6a737d">// overflow</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#d73a49">throw</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Error</span><span style="color:#24292e">(</span><span style="color:#032f62">"Maximum lock count exceeded"</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#6f42c1">setState</span><span style="color:#24292e">(nextc);</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">return</span><span style="color:#24292e"> </span><span style="color:#005cc5">true</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">        }</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">return</span><span style="color:#24292e"> </span><span style="color:#005cc5">false</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">// Sync ÁªßÊâøËøáÊù•ÁöÑÊñπÊ≥ï, Êñπ‰æøÈòÖËØª, ÊîæÂú®Ê≠§Â§Ñ</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">protected</span><span style="color:#24292e"> </span><span style="color:#d73a49">final</span><span style="color:#24292e"> </span><span style="color:#d73a49">boolean</span><span style="color:#24292e"> </span><span style="color:#6f42c1">tryRelease</span><span style="color:#24292e">(</span><span style="color:#d73a49">int</span><span style="color:#24292e"> </span><span style="color:#e36209">releases</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6a737d">// state--</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">int</span><span style="color:#24292e"> c </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#6f42c1">getState</span><span style="color:#24292e">() </span><span style="color:#d73a49">-</span><span style="color:#24292e"> releases;</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (Thread.</span><span style="color:#6f42c1">currentThread</span><span style="color:#24292e">() </span><span style="color:#d73a49">!=</span><span style="color:#24292e"> </span><span style="color:#6f42c1">getExclusiveOwnerThread</span><span style="color:#24292e">())</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">throw</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">IllegalMonitorStateException</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">boolean</span><span style="color:#24292e"> free </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#005cc5">false</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6a737d">// ÊîØÊåÅÈîÅÈáçÂÖ•, Âè™Êúâ state Âáè‰∏∫ 0, ÊâçÈáäÊîæÊàêÂäü</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (c </span><span style="color:#d73a49">==</span><span style="color:#24292e"> </span><span style="color:#005cc5">0</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">            free </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#005cc5">true</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#6f42c1">setExclusiveOwnerThread</span><span style="color:#24292e">(</span><span style="color:#005cc5">null</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">        }</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6f42c1">setState</span><span style="color:#24292e">(c);</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">return</span><span style="color:#24292e"> free;</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"><span style="color:#24292e">}</span></span></code></pre></div><h4 id="ÂèØÊâìÊñ≠ÂéüÁêÜ" tabindex="-1">ÂèØÊâìÊñ≠ÂéüÁêÜ <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20advanced%20chapter#ÂèØÊâìÊñ≠ÂéüÁêÜ" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h4><p>‰∏çÂèØÊâìÊñ≠Ê®°ÂºèÔºöÂú®Ê≠§Ê®°Âºè‰∏ãÔºåÂç≥‰ΩøÂÆÉË¢´ÊâìÊñ≠Ôºå‰ªç‰ºöÈ©ªÁïôÂú® AQS ÈòüÂàó‰∏≠ÔºåÁ≠âËé∑ÂæóÈîÅÂêéÊñπËÉΩÁªßÁª≠ËøêË°åÔºàÊòØÁªßÁª≠ËøêË°åÔºÅÂè™ÊòØÊâìÊñ≠Ê†áËÆ∞Ë¢´ËÆæÁΩÆ‰∏∫trueÔºâ</p><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6a737d">// Sync ÁªßÊâøËá™ AQS</span></span>
<span class="line"><span style="color:#f97583">static</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">final</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">class</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">NonfairSync</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">extends</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Sync</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">// ...</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">private</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">final</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">boolean</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">parkAndCheckInterrupt</span><span style="color:#e1e4e8">() {</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#6a737d">// Â¶ÇÊûúÊâìÊñ≠Ê†áËÆ∞Â∑≤ÁªèÊòØ true, Âàô park ‰ºöÂ§±Êïà</span></span>
<span class="line"><span style="color:#e1e4e8">        LockSupport.</span><span style="color:#b392f0">park</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">this</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#6a737d">// interrupted ‰ºöÊ∏ÖÈô§ÊâìÊñ≠Ê†áËÆ∞</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> Thread.</span><span style="color:#b392f0">interrupted</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">final</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">boolean</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">acquireQueued</span><span style="color:#e1e4e8">(</span><span style="color:#f97583">final</span><span style="color:#e1e4e8"> Node </span><span style="color:#ffab70">node</span><span style="color:#e1e4e8">, </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> </span><span style="color:#ffab70">arg</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">boolean</span><span style="color:#e1e4e8"> failed </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">true</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">try</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">boolean</span><span style="color:#e1e4e8"> interrupted </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">false</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">for</span><span style="color:#e1e4e8"> (;;) {</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#f97583">final</span><span style="color:#e1e4e8"> Node p </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> node.</span><span style="color:#b392f0">predecessor</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (p </span><span style="color:#f97583">==</span><span style="color:#e1e4e8"> head </span><span style="color:#f97583">&amp;&amp;</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">tryAcquire</span><span style="color:#e1e4e8">(arg)) {</span></span>
<span class="line"><span style="color:#e1e4e8">                    </span><span style="color:#b392f0">setHead</span><span style="color:#e1e4e8">(node);</span></span>
<span class="line"><span style="color:#e1e4e8">                    p.next </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">                    failed </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">false</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">                    </span><span style="color:#6a737d">// ËøòÊòØÈúÄË¶ÅËé∑ÂæóÈîÅÂêé, ÊâçËÉΩËøîÂõûÊâìÊñ≠Áä∂ÊÄÅ</span></span>
<span class="line"><span style="color:#e1e4e8">                    </span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> interrupted;</span></span>
<span class="line"><span style="color:#e1e4e8">                }</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (</span></span>
<span class="line"><span style="color:#e1e4e8">                        </span><span style="color:#b392f0">shouldParkAfterFailedAcquire</span><span style="color:#e1e4e8">(p, node) </span><span style="color:#f97583">&amp;&amp;</span></span>
<span class="line"><span style="color:#e1e4e8">                                </span><span style="color:#b392f0">parkAndCheckInterrupt</span><span style="color:#e1e4e8">()</span></span>
<span class="line"><span style="color:#e1e4e8">                ) {</span></span>
<span class="line"><span style="color:#e1e4e8">                    </span><span style="color:#6a737d">// Â¶ÇÊûúÊòØÂõ†‰∏∫ interrupt Ë¢´Âî§ÈÜí, ËøîÂõûÊâìÊñ≠Áä∂ÊÄÅ‰∏∫ true</span></span>
<span class="line"><span style="color:#e1e4e8">                    interrupted </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">true</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">                }</span></span>
<span class="line"><span style="color:#e1e4e8">            }</span></span>
<span class="line"><span style="color:#e1e4e8">        } </span><span style="color:#f97583">finally</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (failed)</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#b392f0">cancelAcquire</span><span style="color:#e1e4e8">(node);</span></span>
<span class="line"><span style="color:#e1e4e8">        }</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">final</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">void</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">acquire</span><span style="color:#e1e4e8">(</span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> </span><span style="color:#ffab70">arg</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#f97583">!</span><span style="color:#b392f0">tryAcquire</span><span style="color:#e1e4e8">(arg) </span><span style="color:#f97583">&amp;&amp;</span></span>
<span class="line"><span style="color:#e1e4e8">                        </span><span style="color:#b392f0">acquireQueued</span><span style="color:#e1e4e8">(</span><span style="color:#b392f0">addWaiter</span><span style="color:#e1e4e8">(Node.EXCLUSIVE), arg)</span></span>
<span class="line"><span style="color:#e1e4e8">        ) {</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#6a737d">// Â¶ÇÊûúÊâìÊñ≠Áä∂ÊÄÅ‰∏∫ true</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#b392f0">selfInterrupt</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">        }</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">static</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">void</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">selfInterrupt</span><span style="color:#e1e4e8">() {</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#6a737d">// ÈáçÊñ∞‰∫ßÁîü‰∏ÄÊ¨°‰∏≠Êñ≠ÔºåËøôÊó∂ÂÄôÁ∫øÁ®ãÊòØÂ¶ÇÊûúÊ≠£Â∏∏ËøêË°åÁöÑÁä∂ÊÄÅÔºåÈÇ£‰πà‰∏çÊòØÂá∫‰∫ésleepÁ≠âÁä∂ÊÄÅÔºåinterruptÊñπÊ≥ïÂ∞±‰∏ç‰ºöÊä•Èîô</span></span>
<span class="line"><span style="color:#e1e4e8">        Thread.</span><span style="color:#b392f0">currentThread</span><span style="color:#e1e4e8">().</span><span style="color:#b392f0">interrupt</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"><span style="color:#e1e4e8">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6a737d">// Sync ÁªßÊâøËá™ AQS</span></span>
<span class="line"><span style="color:#d73a49">static</span><span style="color:#24292e"> </span><span style="color:#d73a49">final</span><span style="color:#24292e"> </span><span style="color:#d73a49">class</span><span style="color:#24292e"> </span><span style="color:#6f42c1">NonfairSync</span><span style="color:#24292e"> </span><span style="color:#d73a49">extends</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Sync</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">// ...</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">private</span><span style="color:#24292e"> </span><span style="color:#d73a49">final</span><span style="color:#24292e"> </span><span style="color:#d73a49">boolean</span><span style="color:#24292e"> </span><span style="color:#6f42c1">parkAndCheckInterrupt</span><span style="color:#24292e">() {</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6a737d">// Â¶ÇÊûúÊâìÊñ≠Ê†áËÆ∞Â∑≤ÁªèÊòØ true, Âàô park ‰ºöÂ§±Êïà</span></span>
<span class="line"><span style="color:#24292e">        LockSupport.</span><span style="color:#6f42c1">park</span><span style="color:#24292e">(</span><span style="color:#005cc5">this</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6a737d">// interrupted ‰ºöÊ∏ÖÈô§ÊâìÊñ≠Ê†áËÆ∞</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">return</span><span style="color:#24292e"> Thread.</span><span style="color:#6f42c1">interrupted</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">final</span><span style="color:#24292e"> </span><span style="color:#d73a49">boolean</span><span style="color:#24292e"> </span><span style="color:#6f42c1">acquireQueued</span><span style="color:#24292e">(</span><span style="color:#d73a49">final</span><span style="color:#24292e"> Node </span><span style="color:#e36209">node</span><span style="color:#24292e">, </span><span style="color:#d73a49">int</span><span style="color:#24292e"> </span><span style="color:#e36209">arg</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">boolean</span><span style="color:#24292e"> failed </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#005cc5">true</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">try</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">boolean</span><span style="color:#24292e"> interrupted </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#005cc5">false</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">for</span><span style="color:#24292e"> (;;) {</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#d73a49">final</span><span style="color:#24292e"> Node p </span><span style="color:#d73a49">=</span><span style="color:#24292e"> node.</span><span style="color:#6f42c1">predecessor</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (p </span><span style="color:#d73a49">==</span><span style="color:#24292e"> head </span><span style="color:#d73a49">&amp;&amp;</span><span style="color:#24292e"> </span><span style="color:#6f42c1">tryAcquire</span><span style="color:#24292e">(arg)) {</span></span>
<span class="line"><span style="color:#24292e">                    </span><span style="color:#6f42c1">setHead</span><span style="color:#24292e">(node);</span></span>
<span class="line"><span style="color:#24292e">                    p.next </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#005cc5">null</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">                    failed </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#005cc5">false</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">                    </span><span style="color:#6a737d">// ËøòÊòØÈúÄË¶ÅËé∑ÂæóÈîÅÂêé, ÊâçËÉΩËøîÂõûÊâìÊñ≠Áä∂ÊÄÅ</span></span>
<span class="line"><span style="color:#24292e">                    </span><span style="color:#d73a49">return</span><span style="color:#24292e"> interrupted;</span></span>
<span class="line"><span style="color:#24292e">                }</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (</span></span>
<span class="line"><span style="color:#24292e">                        </span><span style="color:#6f42c1">shouldParkAfterFailedAcquire</span><span style="color:#24292e">(p, node) </span><span style="color:#d73a49">&amp;&amp;</span></span>
<span class="line"><span style="color:#24292e">                                </span><span style="color:#6f42c1">parkAndCheckInterrupt</span><span style="color:#24292e">()</span></span>
<span class="line"><span style="color:#24292e">                ) {</span></span>
<span class="line"><span style="color:#24292e">                    </span><span style="color:#6a737d">// Â¶ÇÊûúÊòØÂõ†‰∏∫ interrupt Ë¢´Âî§ÈÜí, ËøîÂõûÊâìÊñ≠Áä∂ÊÄÅ‰∏∫ true</span></span>
<span class="line"><span style="color:#24292e">                    interrupted </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#005cc5">true</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">                }</span></span>
<span class="line"><span style="color:#24292e">            }</span></span>
<span class="line"><span style="color:#24292e">        } </span><span style="color:#d73a49">finally</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (failed)</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#6f42c1">cancelAcquire</span><span style="color:#24292e">(node);</span></span>
<span class="line"><span style="color:#24292e">        }</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">final</span><span style="color:#24292e"> </span><span style="color:#d73a49">void</span><span style="color:#24292e"> </span><span style="color:#6f42c1">acquire</span><span style="color:#24292e">(</span><span style="color:#d73a49">int</span><span style="color:#24292e"> </span><span style="color:#e36209">arg</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#d73a49">!</span><span style="color:#6f42c1">tryAcquire</span><span style="color:#24292e">(arg) </span><span style="color:#d73a49">&amp;&amp;</span></span>
<span class="line"><span style="color:#24292e">                        </span><span style="color:#6f42c1">acquireQueued</span><span style="color:#24292e">(</span><span style="color:#6f42c1">addWaiter</span><span style="color:#24292e">(Node.EXCLUSIVE), arg)</span></span>
<span class="line"><span style="color:#24292e">        ) {</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#6a737d">// Â¶ÇÊûúÊâìÊñ≠Áä∂ÊÄÅ‰∏∫ true</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#6f42c1">selfInterrupt</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">        }</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">static</span><span style="color:#24292e"> </span><span style="color:#d73a49">void</span><span style="color:#24292e"> </span><span style="color:#6f42c1">selfInterrupt</span><span style="color:#24292e">() {</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6a737d">// ÈáçÊñ∞‰∫ßÁîü‰∏ÄÊ¨°‰∏≠Êñ≠ÔºåËøôÊó∂ÂÄôÁ∫øÁ®ãÊòØÂ¶ÇÊûúÊ≠£Â∏∏ËøêË°åÁöÑÁä∂ÊÄÅÔºåÈÇ£‰πà‰∏çÊòØÂá∫‰∫ésleepÁ≠âÁä∂ÊÄÅÔºåinterruptÊñπÊ≥ïÂ∞±‰∏ç‰ºöÊä•Èîô</span></span>
<span class="line"><span style="color:#24292e">        Thread.</span><span style="color:#6f42c1">currentThread</span><span style="color:#24292e">().</span><span style="color:#6f42c1">interrupt</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"><span style="color:#24292e">}</span></span></code></pre></div><p>ÂèØÊâìÊñ≠Ê®°Âºè</p><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#f97583">static</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">final</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">class</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">NonfairSync</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">extends</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Sync</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">final</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">void</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">acquireInterruptibly</span><span style="color:#e1e4e8">(</span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> </span><span style="color:#ffab70">arg</span><span style="color:#e1e4e8">) </span><span style="color:#f97583">throws</span><span style="color:#e1e4e8"> InterruptedException {</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (Thread.</span><span style="color:#b392f0">interrupted</span><span style="color:#e1e4e8">())</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">throw</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">InterruptedException</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#6a737d">// Â¶ÇÊûúÊ≤°ÊúâËé∑ÂæóÂà∞ÈîÅ, ËøõÂÖ• „à†</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (</span><span style="color:#f97583">!</span><span style="color:#b392f0">tryAcquire</span><span style="color:#e1e4e8">(arg))</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#b392f0">doAcquireInterruptibly</span><span style="color:#e1e4e8">(arg);</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">// „à† ÂèØÊâìÊñ≠ÁöÑËé∑ÂèñÈîÅÊµÅÁ®ã</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">private</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">void</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">doAcquireInterruptibly</span><span style="color:#e1e4e8">(</span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> </span><span style="color:#ffab70">arg</span><span style="color:#e1e4e8">) </span><span style="color:#f97583">throws</span><span style="color:#e1e4e8"> InterruptedException {</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">final</span><span style="color:#e1e4e8"> Node node </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">addWaiter</span><span style="color:#e1e4e8">(Node.EXCLUSIVE);</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">boolean</span><span style="color:#e1e4e8"> failed </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">true</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">try</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">for</span><span style="color:#e1e4e8"> (;;) {</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#f97583">final</span><span style="color:#e1e4e8"> Node p </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> node.</span><span style="color:#b392f0">predecessor</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (p </span><span style="color:#f97583">==</span><span style="color:#e1e4e8"> head </span><span style="color:#f97583">&amp;&amp;</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">tryAcquire</span><span style="color:#e1e4e8">(arg)) {</span></span>
<span class="line"><span style="color:#e1e4e8">                    </span><span style="color:#b392f0">setHead</span><span style="color:#e1e4e8">(node);</span></span>
<span class="line"><span style="color:#e1e4e8">                    p.next </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8">; </span><span style="color:#6a737d">// help GC</span></span>
<span class="line"><span style="color:#e1e4e8">                    failed </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">false</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">                    </span><span style="color:#f97583">return</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">                }</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (</span><span style="color:#b392f0">shouldParkAfterFailedAcquire</span><span style="color:#e1e4e8">(p, node) </span><span style="color:#f97583">&amp;&amp;</span></span>
<span class="line"><span style="color:#e1e4e8">                        </span><span style="color:#b392f0">parkAndCheckInterrupt</span><span style="color:#e1e4e8">()) {</span></span>
<span class="line"><span style="color:#e1e4e8">                    </span><span style="color:#6a737d">// Âú® park ËøáÁ®ã‰∏≠Â¶ÇÊûúË¢´ interrupt ‰ºöËøõÂÖ•Ê≠§</span></span>
<span class="line"><span style="color:#e1e4e8">                    </span><span style="color:#6a737d">// ËøôÊó∂ÂÄôÊäõÂá∫ÂºÇÂ∏∏, ËÄå‰∏ç‰ºöÂÜçÊ¨°ËøõÂÖ• for (;;)</span></span>
<span class="line"><span style="color:#e1e4e8">                    </span><span style="color:#f97583">throw</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">InterruptedException</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">                }</span></span>
<span class="line"><span style="color:#e1e4e8">            }</span></span>
<span class="line"><span style="color:#e1e4e8">        } </span><span style="color:#f97583">finally</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (failed)</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#b392f0">cancelAcquire</span><span style="color:#e1e4e8">(node);</span></span>
<span class="line"><span style="color:#e1e4e8">        }</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"><span style="color:#e1e4e8">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#d73a49">static</span><span style="color:#24292e"> </span><span style="color:#d73a49">final</span><span style="color:#24292e"> </span><span style="color:#d73a49">class</span><span style="color:#24292e"> </span><span style="color:#6f42c1">NonfairSync</span><span style="color:#24292e"> </span><span style="color:#d73a49">extends</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Sync</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">final</span><span style="color:#24292e"> </span><span style="color:#d73a49">void</span><span style="color:#24292e"> </span><span style="color:#6f42c1">acquireInterruptibly</span><span style="color:#24292e">(</span><span style="color:#d73a49">int</span><span style="color:#24292e"> </span><span style="color:#e36209">arg</span><span style="color:#24292e">) </span><span style="color:#d73a49">throws</span><span style="color:#24292e"> InterruptedException {</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (Thread.</span><span style="color:#6f42c1">interrupted</span><span style="color:#24292e">())</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">throw</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">InterruptedException</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6a737d">// Â¶ÇÊûúÊ≤°ÊúâËé∑ÂæóÂà∞ÈîÅ, ËøõÂÖ• „à†</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (</span><span style="color:#d73a49">!</span><span style="color:#6f42c1">tryAcquire</span><span style="color:#24292e">(arg))</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#6f42c1">doAcquireInterruptibly</span><span style="color:#24292e">(arg);</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">// „à† ÂèØÊâìÊñ≠ÁöÑËé∑ÂèñÈîÅÊµÅÁ®ã</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">private</span><span style="color:#24292e"> </span><span style="color:#d73a49">void</span><span style="color:#24292e"> </span><span style="color:#6f42c1">doAcquireInterruptibly</span><span style="color:#24292e">(</span><span style="color:#d73a49">int</span><span style="color:#24292e"> </span><span style="color:#e36209">arg</span><span style="color:#24292e">) </span><span style="color:#d73a49">throws</span><span style="color:#24292e"> InterruptedException {</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">final</span><span style="color:#24292e"> Node node </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#6f42c1">addWaiter</span><span style="color:#24292e">(Node.EXCLUSIVE);</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">boolean</span><span style="color:#24292e"> failed </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#005cc5">true</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">try</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">for</span><span style="color:#24292e"> (;;) {</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#d73a49">final</span><span style="color:#24292e"> Node p </span><span style="color:#d73a49">=</span><span style="color:#24292e"> node.</span><span style="color:#6f42c1">predecessor</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (p </span><span style="color:#d73a49">==</span><span style="color:#24292e"> head </span><span style="color:#d73a49">&amp;&amp;</span><span style="color:#24292e"> </span><span style="color:#6f42c1">tryAcquire</span><span style="color:#24292e">(arg)) {</span></span>
<span class="line"><span style="color:#24292e">                    </span><span style="color:#6f42c1">setHead</span><span style="color:#24292e">(node);</span></span>
<span class="line"><span style="color:#24292e">                    p.next </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#005cc5">null</span><span style="color:#24292e">; </span><span style="color:#6a737d">// help GC</span></span>
<span class="line"><span style="color:#24292e">                    failed </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#005cc5">false</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">                    </span><span style="color:#d73a49">return</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">                }</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (</span><span style="color:#6f42c1">shouldParkAfterFailedAcquire</span><span style="color:#24292e">(p, node) </span><span style="color:#d73a49">&amp;&amp;</span></span>
<span class="line"><span style="color:#24292e">                        </span><span style="color:#6f42c1">parkAndCheckInterrupt</span><span style="color:#24292e">()) {</span></span>
<span class="line"><span style="color:#24292e">                    </span><span style="color:#6a737d">// Âú® park ËøáÁ®ã‰∏≠Â¶ÇÊûúË¢´ interrupt ‰ºöËøõÂÖ•Ê≠§</span></span>
<span class="line"><span style="color:#24292e">                    </span><span style="color:#6a737d">// ËøôÊó∂ÂÄôÊäõÂá∫ÂºÇÂ∏∏, ËÄå‰∏ç‰ºöÂÜçÊ¨°ËøõÂÖ• for (;;)</span></span>
<span class="line"><span style="color:#24292e">                    </span><span style="color:#d73a49">throw</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">InterruptedException</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">                }</span></span>
<span class="line"><span style="color:#24292e">            }</span></span>
<span class="line"><span style="color:#24292e">        } </span><span style="color:#d73a49">finally</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (failed)</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#6f42c1">cancelAcquire</span><span style="color:#24292e">(node);</span></span>
<span class="line"><span style="color:#24292e">        }</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"><span style="color:#24292e">}</span></span></code></pre></div><h4 id="ÂÖ¨Âπ≥ÈîÅÂÆûÁé∞ÂéüÁêÜ" tabindex="-1">ÂÖ¨Âπ≥ÈîÅÂÆûÁé∞ÂéüÁêÜ <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20advanced%20chapter#ÂÖ¨Âπ≥ÈîÅÂÆûÁé∞ÂéüÁêÜ" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h4><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#f97583">static</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">final</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">class</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">FairSync</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">extends</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Sync</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">private</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">static</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">final</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">long</span><span style="color:#e1e4e8"> serialVersionUID </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">-</span><span style="color:#79b8ff">3000897897090466540L</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">final</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">void</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">lock</span><span style="color:#e1e4e8">() {</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#b392f0">acquire</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">1</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">// AQS ÁªßÊâøËøáÊù•ÁöÑÊñπÊ≥ï, Êñπ‰æøÈòÖËØª, ÊîæÂú®Ê≠§Â§Ñ</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">final</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">void</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">acquire</span><span style="color:#e1e4e8">(</span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> </span><span style="color:#ffab70">arg</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#f97583">!</span><span style="color:#b392f0">tryAcquire</span><span style="color:#e1e4e8">(arg) </span><span style="color:#f97583">&amp;&amp;</span></span>
<span class="line"><span style="color:#e1e4e8">                        </span><span style="color:#b392f0">acquireQueued</span><span style="color:#e1e4e8">(</span><span style="color:#b392f0">addWaiter</span><span style="color:#e1e4e8">(Node.EXCLUSIVE), arg)</span></span>
<span class="line"><span style="color:#e1e4e8">        ) {</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#b392f0">selfInterrupt</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">        }</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">// ‰∏éÈùûÂÖ¨Âπ≥ÈîÅ‰∏ªË¶ÅÂå∫Âà´Âú®‰∫é tryAcquire ÊñπÊ≥ïÁöÑÂÆûÁé∞</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">protected</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">final</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">boolean</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">tryAcquire</span><span style="color:#e1e4e8">(</span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> </span><span style="color:#ffab70">acquires</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">final</span><span style="color:#e1e4e8"> Thread current </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> Thread.</span><span style="color:#b392f0">currentThread</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> c </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">getState</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (c </span><span style="color:#f97583">==</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#6a737d">// ÂÖàÊ£ÄÊü• AQS ÈòüÂàó‰∏≠ÊòØÂê¶ÊúâÂâçÈ©±ËäÇÁÇπ, Ê≤°ÊúâÊâçÂéªÁ´û‰∫â</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (</span><span style="color:#f97583">!</span><span style="color:#b392f0">hasQueuedPredecessors</span><span style="color:#e1e4e8">() </span><span style="color:#f97583">&amp;&amp;</span></span>
<span class="line"><span style="color:#e1e4e8">                    </span><span style="color:#b392f0">compareAndSetState</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8">, acquires)) {</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#b392f0">setExclusiveOwnerThread</span><span style="color:#e1e4e8">(current);</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">true</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">            }</span></span>
<span class="line"><span style="color:#e1e4e8">        }</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">else</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (current </span><span style="color:#f97583">==</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">getExclusiveOwnerThread</span><span style="color:#e1e4e8">()) {</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> nextc </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> c </span><span style="color:#f97583">+</span><span style="color:#e1e4e8"> acquires;</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (nextc </span><span style="color:#f97583">&lt;</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8">)</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#f97583">throw</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Error</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"Maximum lock count exceeded"</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#b392f0">setState</span><span style="color:#e1e4e8">(nextc);</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">true</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">        }</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">false</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">// „à† AQS ÁªßÊâøËøáÊù•ÁöÑÊñπÊ≥ï, Êñπ‰æøÈòÖËØª, ÊîæÂú®Ê≠§Â§Ñ</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">final</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">boolean</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">hasQueuedPredecessors</span><span style="color:#e1e4e8">() {</span></span>
<span class="line"><span style="color:#e1e4e8">        Node t </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> tail;</span></span>
<span class="line"><span style="color:#e1e4e8">        Node h </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> head;</span></span>
<span class="line"><span style="color:#e1e4e8">        Node s;</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#6a737d">// h != t Êó∂Ë°®Á§∫ÈòüÂàó‰∏≠Êúâ Node</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> h </span><span style="color:#f97583">!=</span><span style="color:#e1e4e8"> t </span><span style="color:#f97583">&amp;&amp;</span></span>
<span class="line"><span style="color:#e1e4e8">                (</span></span>
<span class="line"><span style="color:#e1e4e8">                        </span><span style="color:#6a737d">// (s = h.next) == null Ë°®Á§∫ÈòüÂàó‰∏≠ËøòÊúâÊ≤°ÊúâËÄÅ‰∫å</span></span>
<span class="line"><span style="color:#e1e4e8">                        (s </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> h.next) </span><span style="color:#f97583">==</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">||</span><span style="color:#e1e4e8"> </span><span style="color:#6a737d">// ÊàñËÄÖÈòüÂàó‰∏≠ËÄÅ‰∫åÁ∫øÁ®ã‰∏çÊòØÊ≠§Á∫øÁ®ã</span></span>
<span class="line"><span style="color:#e1e4e8">                                s.thread </span><span style="color:#f97583">!=</span><span style="color:#e1e4e8"> Thread.</span><span style="color:#b392f0">currentThread</span><span style="color:#e1e4e8">()</span></span>
<span class="line"><span style="color:#e1e4e8">                );</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"><span style="color:#e1e4e8">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#d73a49">static</span><span style="color:#24292e"> </span><span style="color:#d73a49">final</span><span style="color:#24292e"> </span><span style="color:#d73a49">class</span><span style="color:#24292e"> </span><span style="color:#6f42c1">FairSync</span><span style="color:#24292e"> </span><span style="color:#d73a49">extends</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Sync</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">private</span><span style="color:#24292e"> </span><span style="color:#d73a49">static</span><span style="color:#24292e"> </span><span style="color:#d73a49">final</span><span style="color:#24292e"> </span><span style="color:#d73a49">long</span><span style="color:#24292e"> serialVersionUID </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#d73a49">-</span><span style="color:#005cc5">3000897897090466540L</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">final</span><span style="color:#24292e"> </span><span style="color:#d73a49">void</span><span style="color:#24292e"> </span><span style="color:#6f42c1">lock</span><span style="color:#24292e">() {</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6f42c1">acquire</span><span style="color:#24292e">(</span><span style="color:#005cc5">1</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">// AQS ÁªßÊâøËøáÊù•ÁöÑÊñπÊ≥ï, Êñπ‰æøÈòÖËØª, ÊîæÂú®Ê≠§Â§Ñ</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">final</span><span style="color:#24292e"> </span><span style="color:#d73a49">void</span><span style="color:#24292e"> </span><span style="color:#6f42c1">acquire</span><span style="color:#24292e">(</span><span style="color:#d73a49">int</span><span style="color:#24292e"> </span><span style="color:#e36209">arg</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#d73a49">!</span><span style="color:#6f42c1">tryAcquire</span><span style="color:#24292e">(arg) </span><span style="color:#d73a49">&amp;&amp;</span></span>
<span class="line"><span style="color:#24292e">                        </span><span style="color:#6f42c1">acquireQueued</span><span style="color:#24292e">(</span><span style="color:#6f42c1">addWaiter</span><span style="color:#24292e">(Node.EXCLUSIVE), arg)</span></span>
<span class="line"><span style="color:#24292e">        ) {</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#6f42c1">selfInterrupt</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">        }</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">// ‰∏éÈùûÂÖ¨Âπ≥ÈîÅ‰∏ªË¶ÅÂå∫Âà´Âú®‰∫é tryAcquire ÊñπÊ≥ïÁöÑÂÆûÁé∞</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">protected</span><span style="color:#24292e"> </span><span style="color:#d73a49">final</span><span style="color:#24292e"> </span><span style="color:#d73a49">boolean</span><span style="color:#24292e"> </span><span style="color:#6f42c1">tryAcquire</span><span style="color:#24292e">(</span><span style="color:#d73a49">int</span><span style="color:#24292e"> </span><span style="color:#e36209">acquires</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">final</span><span style="color:#24292e"> Thread current </span><span style="color:#d73a49">=</span><span style="color:#24292e"> Thread.</span><span style="color:#6f42c1">currentThread</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">int</span><span style="color:#24292e"> c </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#6f42c1">getState</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (c </span><span style="color:#d73a49">==</span><span style="color:#24292e"> </span><span style="color:#005cc5">0</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#6a737d">// ÂÖàÊ£ÄÊü• AQS ÈòüÂàó‰∏≠ÊòØÂê¶ÊúâÂâçÈ©±ËäÇÁÇπ, Ê≤°ÊúâÊâçÂéªÁ´û‰∫â</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (</span><span style="color:#d73a49">!</span><span style="color:#6f42c1">hasQueuedPredecessors</span><span style="color:#24292e">() </span><span style="color:#d73a49">&amp;&amp;</span></span>
<span class="line"><span style="color:#24292e">                    </span><span style="color:#6f42c1">compareAndSetState</span><span style="color:#24292e">(</span><span style="color:#005cc5">0</span><span style="color:#24292e">, acquires)) {</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#6f42c1">setExclusiveOwnerThread</span><span style="color:#24292e">(current);</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#d73a49">return</span><span style="color:#24292e"> </span><span style="color:#005cc5">true</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">            }</span></span>
<span class="line"><span style="color:#24292e">        }</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">else</span><span style="color:#24292e"> </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (current </span><span style="color:#d73a49">==</span><span style="color:#24292e"> </span><span style="color:#6f42c1">getExclusiveOwnerThread</span><span style="color:#24292e">()) {</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">int</span><span style="color:#24292e"> nextc </span><span style="color:#d73a49">=</span><span style="color:#24292e"> c </span><span style="color:#d73a49">+</span><span style="color:#24292e"> acquires;</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (nextc </span><span style="color:#d73a49">&lt;</span><span style="color:#24292e"> </span><span style="color:#005cc5">0</span><span style="color:#24292e">)</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#d73a49">throw</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Error</span><span style="color:#24292e">(</span><span style="color:#032f62">"Maximum lock count exceeded"</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#6f42c1">setState</span><span style="color:#24292e">(nextc);</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">return</span><span style="color:#24292e"> </span><span style="color:#005cc5">true</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">        }</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">return</span><span style="color:#24292e"> </span><span style="color:#005cc5">false</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">// „à† AQS ÁªßÊâøËøáÊù•ÁöÑÊñπÊ≥ï, Êñπ‰æøÈòÖËØª, ÊîæÂú®Ê≠§Â§Ñ</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">final</span><span style="color:#24292e"> </span><span style="color:#d73a49">boolean</span><span style="color:#24292e"> </span><span style="color:#6f42c1">hasQueuedPredecessors</span><span style="color:#24292e">() {</span></span>
<span class="line"><span style="color:#24292e">        Node t </span><span style="color:#d73a49">=</span><span style="color:#24292e"> tail;</span></span>
<span class="line"><span style="color:#24292e">        Node h </span><span style="color:#d73a49">=</span><span style="color:#24292e"> head;</span></span>
<span class="line"><span style="color:#24292e">        Node s;</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6a737d">// h != t Êó∂Ë°®Á§∫ÈòüÂàó‰∏≠Êúâ Node</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">return</span><span style="color:#24292e"> h </span><span style="color:#d73a49">!=</span><span style="color:#24292e"> t </span><span style="color:#d73a49">&amp;&amp;</span></span>
<span class="line"><span style="color:#24292e">                (</span></span>
<span class="line"><span style="color:#24292e">                        </span><span style="color:#6a737d">// (s = h.next) == null Ë°®Á§∫ÈòüÂàó‰∏≠ËøòÊúâÊ≤°ÊúâËÄÅ‰∫å</span></span>
<span class="line"><span style="color:#24292e">                        (s </span><span style="color:#d73a49">=</span><span style="color:#24292e"> h.next) </span><span style="color:#d73a49">==</span><span style="color:#24292e"> </span><span style="color:#005cc5">null</span><span style="color:#24292e"> </span><span style="color:#d73a49">||</span><span style="color:#24292e"> </span><span style="color:#6a737d">// ÊàñËÄÖÈòüÂàó‰∏≠ËÄÅ‰∫åÁ∫øÁ®ã‰∏çÊòØÊ≠§Á∫øÁ®ã</span></span>
<span class="line"><span style="color:#24292e">                                s.thread </span><span style="color:#d73a49">!=</span><span style="color:#24292e"> Thread.</span><span style="color:#6f42c1">currentThread</span><span style="color:#24292e">()</span></span>
<span class="line"><span style="color:#24292e">                );</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"><span style="color:#24292e">}</span></span></code></pre></div><h4 id="Êù°‰ª∂ÂèòÈáèÂÆûÁé∞ÂéüÁêÜ" tabindex="-1">Êù°‰ª∂ÂèòÈáèÂÆûÁé∞ÂéüÁêÜ <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20advanced%20chapter#Êù°‰ª∂ÂèòÈáèÂÆûÁé∞ÂéüÁêÜ" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h4><p>ÊØè‰∏™Êù°‰ª∂ÂèòÈáèÂÖ∂ÂÆûÂ∞±ÂØπÂ∫îÁùÄ‰∏Ä‰∏™Á≠âÂæÖÈòüÂàóÔºåÂÖ∂ÂÆûÁé∞Á±ªÊòØ ConditionObject</p><h5 id="await-ÊµÅÁ®ã" tabindex="-1">await ÊµÅÁ®ã <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20advanced%20chapter#await-ÊµÅÁ®ã" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h5><p>ÂºÄÂßã Thread-0 ÊåÅÊúâÈîÅÔºåË∞ÉÁî® awaitÔºåËøõÂÖ• ConditionObject ÁöÑ addConditionWaiter ÊµÅÁ®ã ÂàõÂª∫Êñ∞ÁöÑ Node Áä∂ÊÄÅ‰∏∫ -2ÔºàNode.CONDITIONÔºâÔºåÂÖ≥ËÅî Thread-0ÔºåÂä†ÂÖ•Á≠âÂæÖÈòüÂàóÂ∞æÈÉ®</p><figure><img src="https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230719164220226.png" alt="image-20230719164220226" loading="lazy" decoding="async"></figure><p>Êé•‰∏ãÊù•ËøõÂÖ• AQS ÁöÑ fullyRelease ÊµÅÁ®ãÔºåÈáäÊîæÂêåÊ≠•Âô®‰∏äÁöÑÈîÅ</p><figure><img src="https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230719164232726.png" alt="image-20230719164232726" loading="lazy" decoding="async"></figure><p>unpark AQS ÈòüÂàó‰∏≠ÁöÑ‰∏ã‰∏Ä‰∏™ËäÇÁÇπÔºåÁ´û‰∫âÈîÅÔºåÂÅáËÆæÊ≤°ÊúâÂÖ∂‰ªñÁ´û‰∫âÁ∫øÁ®ãÔºåÈÇ£‰πà Thread-1 Á´û‰∫âÊàêÂäü</p><figure><img src="https://jsd.cdn.zzko.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230719164247506.png" alt="image-20230719164247506" loading="lazy" decoding="async"></figure><p>park ÈòªÂ°û Thread-0</p><figure><img src="https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230719164258904.png" alt="image-20230719164258904" loading="lazy" decoding="async"></figure><h5 id="signal-ÊµÅÁ®ã" tabindex="-1">signal ÊµÅÁ®ã <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20advanced%20chapter#signal-ÊµÅÁ®ã" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h5><p>ÂÅáËÆæ Thread-1 Ë¶ÅÊù•Âî§ÈÜí Thread-0</p><figure><img src="https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230719164323626.png" alt="image-20230719164323626" loading="lazy" decoding="async"></figure><p>ËøõÂÖ• ConditionObject ÁöÑ doSignal ÊµÅÁ®ãÔºåÂèñÂæóÁ≠âÂæÖÈòüÂàó‰∏≠Á¨¨‰∏Ä‰∏™ NodeÔºåÂç≥ Thread-0 ÊâÄÂú® Node</p><figure><img src="https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230719164337750.png" alt="image-20230719164337750" loading="lazy" decoding="async"></figure><p>ÊâßË°å transferForSignal ÊµÅÁ®ãÔºåÂ∞ÜËØ• Node Âä†ÂÖ• AQS ÈòüÂàóÂ∞æÈÉ®ÔºåÂ∞Ü Thread-0 ÁöÑ waitStatus Êîπ‰∏∫ 0ÔºåThread-3 ÁöÑ waitStatus Êîπ‰∏∫ -1</p><figure><img src="https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230719164353059.png" alt="image-20230719164353059" loading="lazy" decoding="async"></figure><p>Thread-1 ÈáäÊîæÈîÅÔºåËøõÂÖ• unlock ÊµÅÁ®ãÔºåÁï•</p><h5 id="Ê∫êÁ†ÅÂàÜÊûê" tabindex="-1">Ê∫êÁ†ÅÂàÜÊûê <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20advanced%20chapter#Ê∫êÁ†ÅÂàÜÊûê" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h5><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">class</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">ConditionObject</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">implements</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Condition</span><span style="color:#e1e4e8">, java.io.</span><span style="color:#b392f0">Serializable</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">private</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">static</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">final</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">long</span><span style="color:#e1e4e8"> serialVersionUID </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">1173984872572414699L</span><span style="color:#e1e4e8">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">// Á¨¨‰∏Ä‰∏™Á≠âÂæÖËäÇÁÇπ</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">private</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">transient</span><span style="color:#e1e4e8"> Node firstWaiter;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">// ÊúÄÂêé‰∏Ä‰∏™Á≠âÂæÖËäÇÁÇπ</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">private</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">transient</span><span style="color:#e1e4e8"> Node lastWaiter;</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">ConditionObject</span><span style="color:#e1e4e8">() { }</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">// „à† Ê∑ªÂä†‰∏Ä‰∏™ Node Ëá≥Á≠âÂæÖÈòüÂàó</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">private</span><span style="color:#e1e4e8"> Node </span><span style="color:#b392f0">addConditionWaiter</span><span style="color:#e1e4e8">() {</span></span>
<span class="line"><span style="color:#e1e4e8">        Node t </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> lastWaiter;</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#6a737d">// ÊâÄÊúâÂ∑≤ÂèñÊ∂àÁöÑ Node ‰ªéÈòüÂàóÈìæË°®Âà†Èô§, ËßÅ „à°</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (t </span><span style="color:#f97583">!=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">&amp;&amp;</span><span style="color:#e1e4e8"> t.waitStatus </span><span style="color:#f97583">!=</span><span style="color:#e1e4e8"> Node.CONDITION) {</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#b392f0">unlinkCancelledWaiters</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">            t </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> lastWaiter;</span></span>
<span class="line"><span style="color:#e1e4e8">        }</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#6a737d">// ÂàõÂª∫‰∏Ä‰∏™ÂÖ≥ËÅîÂΩìÂâçÁ∫øÁ®ãÁöÑÊñ∞ Node, Ê∑ªÂä†Ëá≥ÈòüÂàóÂ∞æÈÉ®</span></span>
<span class="line"><span style="color:#e1e4e8">        Node node </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Node</span><span style="color:#e1e4e8">(Thread.</span><span style="color:#b392f0">currentThread</span><span style="color:#e1e4e8">(), Node.CONDITION);</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (t </span><span style="color:#f97583">==</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8">)</span></span>
<span class="line"><span style="color:#e1e4e8">            firstWaiter </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> node;</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">else</span></span>
<span class="line"><span style="color:#e1e4e8">            t.nextWaiter </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> node;</span></span>
<span class="line"><span style="color:#e1e4e8">        lastWaiter </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> node;</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> node;</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">// Âî§ÈÜí - Â∞ÜÊ≤°ÂèñÊ∂àÁöÑÁ¨¨‰∏Ä‰∏™ËäÇÁÇπËΩ¨ÁßªËá≥ AQS ÈòüÂàó</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">private</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">void</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">doSignal</span><span style="color:#e1e4e8">(Node </span><span style="color:#ffab70">first</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">do</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#6a737d">// Â∑≤ÁªèÊòØÂ∞æËäÇÁÇπ‰∫Ü</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> ( (firstWaiter </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> first.nextWaiter) </span><span style="color:#f97583">==</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">                lastWaiter </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">            }</span></span>
<span class="line"><span style="color:#e1e4e8">            first.nextWaiter </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">        } </span><span style="color:#f97583">while</span><span style="color:#e1e4e8"> (</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#6a737d">// Â∞ÜÁ≠âÂæÖÈòüÂàó‰∏≠ÁöÑ Node ËΩ¨ÁßªËá≥ AQS ÈòüÂàó, ‰∏çÊàêÂäü‰∏îËøòÊúâËäÇÁÇπÂàôÁªßÁª≠Âæ™ÁéØ „à¢</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#f97583">!</span><span style="color:#b392f0">transferForSignal</span><span style="color:#e1e4e8">(first) </span><span style="color:#f97583">&amp;&amp;</span></span>
<span class="line"><span style="color:#e1e4e8">                        </span><span style="color:#6a737d">// ÈòüÂàóËøòÊúâËäÇÁÇπ</span></span>
<span class="line"><span style="color:#e1e4e8">                        (first </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> firstWaiter) </span><span style="color:#f97583">!=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">null</span></span>
<span class="line"><span style="color:#e1e4e8">        );</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">// Â§ñÈÉ®Á±ªÊñπÊ≥ï, Êñπ‰æøÈòÖËØª, ÊîæÂú®Ê≠§Â§Ñ</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">// „à¢ Â¶ÇÊûúËäÇÁÇπÁä∂ÊÄÅÊòØÂèñÊ∂à, ËøîÂõû false Ë°®Á§∫ËΩ¨ÁßªÂ§±Ë¥•, Âê¶ÂàôËΩ¨ÁßªÊàêÂäü</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">final</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">boolean</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">transferForSignal</span><span style="color:#e1e4e8">(Node </span><span style="color:#ffab70">node</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#6a737d">// ËÆæÁΩÆÂΩìÂâçnodeÁä∂ÊÄÅ‰∏∫0ÔºàÂõ†‰∏∫Â§ÑÂú®ÈòüÂàóÊú´Â∞æÔºâÔºåÂ¶ÇÊûúÁä∂ÊÄÅÂ∑≤Áªè‰∏çÊòØ Node.CONDITION, ËØ¥ÊòéË¢´ÂèñÊ∂à‰∫Ü</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (</span><span style="color:#f97583">!</span><span style="color:#b392f0">compareAndSetWaitStatus</span><span style="color:#e1e4e8">(node, Node.CONDITION, </span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8">))</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">false</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#6a737d">// Âä†ÂÖ• AQS ÈòüÂàóÂ∞æÈÉ®</span></span>
<span class="line"><span style="color:#e1e4e8">        Node p </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">enq</span><span style="color:#e1e4e8">(node);</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> ws </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> p.waitStatus;</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#6a737d">// ÊèíÂÖ•ËäÇÁÇπÁöÑ‰∏ä‰∏Ä‰∏™ËäÇÁÇπË¢´ÂèñÊ∂à</span></span>
<span class="line"><span style="color:#e1e4e8">                ws </span><span style="color:#f97583">&gt;</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">||</span></span>
<span class="line"><span style="color:#e1e4e8">                        </span><span style="color:#6a737d">// ÊèíÂÖ•ËäÇÁÇπÁöÑ‰∏ä‰∏Ä‰∏™ËäÇÁÇπ‰∏çËÉΩËÆæÁΩÆÁä∂ÊÄÅ‰∏∫ Node.SIGNAL</span></span>
<span class="line"><span style="color:#e1e4e8">                        </span><span style="color:#f97583">!</span><span style="color:#b392f0">compareAndSetWaitStatus</span><span style="color:#e1e4e8">(p, ws, Node.SIGNAL)</span></span>
<span class="line"><span style="color:#e1e4e8">        ) {</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#6a737d">// unpark ÂèñÊ∂àÈòªÂ°û, ËÆ©Á∫øÁ®ãÈáçÊñ∞ÂêåÊ≠•Áä∂ÊÄÅ</span></span>
<span class="line"><span style="color:#e1e4e8">            LockSupport.</span><span style="color:#b392f0">unpark</span><span style="color:#e1e4e8">(node.thread);</span></span>
<span class="line"><span style="color:#e1e4e8">        }</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">true</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"><span style="color:#6a737d">// ÂÖ®ÈÉ®Âî§ÈÜí - Á≠âÂæÖÈòüÂàóÁöÑÊâÄÊúâËäÇÁÇπËΩ¨ÁßªËá≥ AQS ÈòüÂàó</span></span>
<span class="line"><span style="color:#f97583">private</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">void</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">doSignalAll</span><span style="color:#e1e4e8">(Node </span><span style="color:#ffab70">first</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">    lastWaiter </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> firstWaiter </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">do</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">        Node next </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> first.nextWaiter;</span></span>
<span class="line"><span style="color:#e1e4e8">        first.nextWaiter </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#b392f0">transferForSignal</span><span style="color:#e1e4e8">(first);</span></span>
<span class="line"><span style="color:#e1e4e8">        first </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> next;</span></span>
<span class="line"><span style="color:#e1e4e8">    } </span><span style="color:#f97583">while</span><span style="color:#e1e4e8"> (first </span><span style="color:#f97583">!=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">// „à°</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">private</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">void</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">unlinkCancelledWaiters</span><span style="color:#e1e4e8">() {</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#6a737d">// ...</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">// Âî§ÈÜí - ÂøÖÈ°ªÊåÅÊúâÈîÅÊâçËÉΩÂî§ÈÜí, Âõ†Ê≠§ doSignal ÂÜÖÊó†ÈúÄËÄÉËôëÂä†ÈîÅ</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">final</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">void</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">signal</span><span style="color:#e1e4e8">() {</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#6a737d">// Â¶ÇÊûúÊ≤°ÊúâÊåÅÊúâÈîÅÔºå‰ºöÊäõÂá∫ÂºÇÂ∏∏</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (</span><span style="color:#f97583">!</span><span style="color:#b392f0">isHeldExclusively</span><span style="color:#e1e4e8">())</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">throw</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">IllegalMonitorStateException</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">        Node first </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> firstWaiter;</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (first </span><span style="color:#f97583">!=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8">)</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#b392f0">doSignal</span><span style="color:#e1e4e8">(first);</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">// ÂÖ®ÈÉ®Âî§ÈÜí - ÂøÖÈ°ªÊåÅÊúâÈîÅÊâçËÉΩÂî§ÈÜí, Âõ†Ê≠§ doSignalAll ÂÜÖÊó†ÈúÄËÄÉËôëÂä†ÈîÅ</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">final</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">void</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">signalAll</span><span style="color:#e1e4e8">() {</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (</span><span style="color:#f97583">!</span><span style="color:#b392f0">isHeldExclusively</span><span style="color:#e1e4e8">())</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">throw</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">IllegalMonitorStateException</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">        Node first </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> firstWaiter;</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (first </span><span style="color:#f97583">!=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8">)</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#b392f0">doSignalAll</span><span style="color:#e1e4e8">(first);</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">// ‰∏çÂèØÊâìÊñ≠Á≠âÂæÖ - Áõ¥Âà∞Ë¢´Âî§ÈÜí</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">final</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">void</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">awaitUninterruptibly</span><span style="color:#e1e4e8">() {</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#6a737d">// Ê∑ªÂä†‰∏Ä‰∏™ Node Ëá≥Á≠âÂæÖÈòüÂàó, ËßÅ „à†</span></span>
<span class="line"><span style="color:#e1e4e8">        Node node </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">addConditionWaiter</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#6a737d">// ÈáäÊîæËäÇÁÇπÊåÅÊúâÁöÑÈîÅ, ËßÅ „à£</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> savedState </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">fullyRelease</span><span style="color:#e1e4e8">(node);</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">boolean</span><span style="color:#e1e4e8"> interrupted </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">false</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#6a737d">// Â¶ÇÊûúËØ•ËäÇÁÇπËøòÊ≤°ÊúâËΩ¨ÁßªËá≥ AQS ÈòüÂàó, ÈòªÂ°û</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">while</span><span style="color:#e1e4e8"> (</span><span style="color:#f97583">!</span><span style="color:#b392f0">isOnSyncQueue</span><span style="color:#e1e4e8">(node)) {</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#6a737d">// park ÈòªÂ°û</span></span>
<span class="line"><span style="color:#e1e4e8">            LockSupport.</span><span style="color:#b392f0">park</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">this</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#6a737d">// Â¶ÇÊûúË¢´ÊâìÊñ≠, ‰ªÖËÆæÁΩÆÊâìÊñ≠Áä∂ÊÄÅ</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (Thread.</span><span style="color:#b392f0">interrupted</span><span style="color:#e1e4e8">())</span></span>
<span class="line"><span style="color:#e1e4e8">                interrupted </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">true</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">        }</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#6a737d">// Âî§ÈÜíÂêé, Â∞ùËØïÁ´û‰∫âÈîÅ, Â¶ÇÊûúÂ§±Ë¥•ËøõÂÖ• AQS ÈòüÂàó</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (</span><span style="color:#b392f0">acquireQueued</span><span style="color:#e1e4e8">(node, savedState) </span><span style="color:#f97583">||</span><span style="color:#e1e4e8"> interrupted)</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#b392f0">selfInterrupt</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">// Â§ñÈÉ®Á±ªÊñπÊ≥ï, Êñπ‰æøÈòÖËØª, ÊîæÂú®Ê≠§Â§Ñ</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">// „à£ Âõ†‰∏∫ÊüêÁ∫øÁ®ãÂèØËÉΩÈáçÂÖ•ÔºåÈúÄË¶ÅÂ∞Ü state ÂÖ®ÈÉ®ÈáäÊîæÔºåËé∑ÂèñstateÔºåÁÑ∂ÂêéÊääÂÆÉÂÖ®ÈÉ®ÂáèÊéâÔºå‰ª•ÂÖ®ÈÉ®ÈáäÊîæ</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">final</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">fullyRelease</span><span style="color:#e1e4e8">(Node </span><span style="color:#ffab70">node</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">boolean</span><span style="color:#e1e4e8"> failed </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">true</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">try</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> savedState </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">getState</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#6a737d">// Âî§ÈÜíÁ≠âÂæÖÈòüÂàóÈòüÂàó‰∏≠ÁöÑ‰∏ã‰∏Ä‰∏™ËäÇÁÇπ</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (</span><span style="color:#b392f0">release</span><span style="color:#e1e4e8">(savedState)) {</span></span>
<span class="line"><span style="color:#e1e4e8">                failed </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">false</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> savedState;</span></span>
<span class="line"><span style="color:#e1e4e8">            } </span><span style="color:#f97583">else</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#f97583">throw</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">IllegalMonitorStateException</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">            }</span></span>
<span class="line"><span style="color:#e1e4e8">        } </span><span style="color:#f97583">finally</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (failed)</span></span>
<span class="line"><span style="color:#e1e4e8">                node.waitStatus </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> Node.CANCELLED;</span></span>
<span class="line"><span style="color:#e1e4e8">        }</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">// ÊâìÊñ≠Ê®°Âºè - Âú®ÈÄÄÂá∫Á≠âÂæÖÊó∂ÈáçÊñ∞ËÆæÁΩÆÊâìÊñ≠Áä∂ÊÄÅ</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">private</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">static</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">final</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> REINTERRUPT </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">1</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">// ÊâìÊñ≠Ê®°Âºè - Âú®ÈÄÄÂá∫Á≠âÂæÖÊó∂ÊäõÂá∫ÂºÇÂ∏∏</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">private</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">static</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">final</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> THROW_IE </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">-</span><span style="color:#79b8ff">1</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">// Âà§Êñ≠ÊâìÊñ≠Ê®°Âºè</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">private</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">checkInterruptWhileWaiting</span><span style="color:#e1e4e8">(Node </span><span style="color:#ffab70">node</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> Thread.</span><span style="color:#b392f0">interrupted</span><span style="color:#e1e4e8">() </span><span style="color:#f97583">?</span></span>
<span class="line"><span style="color:#e1e4e8">                (</span><span style="color:#b392f0">transferAfterCancelledWait</span><span style="color:#e1e4e8">(node) </span><span style="color:#f97583">?</span><span style="color:#e1e4e8"> THROW_IE </span><span style="color:#f97583">:</span><span style="color:#e1e4e8"> REINTERRUPT) </span><span style="color:#f97583">:</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">// „à§ Â∫îÁî®ÊâìÊñ≠Ê®°Âºè</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">private</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">void</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">reportInterruptAfterWait</span><span style="color:#e1e4e8">(</span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> </span><span style="color:#ffab70">interruptMode</span><span style="color:#e1e4e8">)</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">throws</span><span style="color:#e1e4e8"> InterruptedException {</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (interruptMode </span><span style="color:#f97583">==</span><span style="color:#e1e4e8"> THROW_IE)</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">throw</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">InterruptedException</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">else</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (interruptMode </span><span style="color:#f97583">==</span><span style="color:#e1e4e8"> REINTERRUPT)</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#b392f0">selfInterrupt</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">// Á≠âÂæÖ - Áõ¥Âà∞Ë¢´Âî§ÈÜíÊàñÊâìÊñ≠</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">final</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">void</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">await</span><span style="color:#e1e4e8">() </span><span style="color:#f97583">throws</span><span style="color:#e1e4e8"> InterruptedException {</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (Thread.</span><span style="color:#b392f0">interrupted</span><span style="color:#e1e4e8">()) {</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">throw</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">InterruptedException</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">        }</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#6a737d">// Ê∑ªÂä†‰∏Ä‰∏™ Node Ëá≥Á≠âÂæÖÈòüÂàó, ËßÅ „à†</span></span>
<span class="line"><span style="color:#e1e4e8">        Node node </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">addConditionWaiter</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#6a737d">// ÈáäÊîæËäÇÁÇπÊåÅÊúâÁöÑÈîÅ</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> savedState </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">fullyRelease</span><span style="color:#e1e4e8">(node);</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> interruptMode </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#6a737d">// Â¶ÇÊûúËØ•ËäÇÁÇπËøòÊ≤°ÊúâËΩ¨ÁßªËá≥ AQS ÈòüÂàó, ÈòªÂ°û</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">while</span><span style="color:#e1e4e8"> (</span><span style="color:#f97583">!</span><span style="color:#b392f0">isOnSyncQueue</span><span style="color:#e1e4e8">(node)) {</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#6a737d">// park ÈòªÂ°û              </span></span>
<span class="line"><span style="color:#e1e4e8">            LockSupport.</span><span style="color:#b392f0">park</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">this</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#6a737d">// Â¶ÇÊûúË¢´ÊâìÊñ≠, ÈÄÄÂá∫Á≠âÂæÖÈòüÂàó</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> ((interruptMode </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">checkInterruptWhileWaiting</span><span style="color:#e1e4e8">(node)) </span><span style="color:#f97583">!=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8">)</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#f97583">break</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">        }</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#6a737d">// ÈÄÄÂá∫Á≠âÂæÖÈòüÂàóÂêé, ËøòÈúÄË¶ÅËé∑Âæó AQS ÈòüÂàóÁöÑÈîÅ</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (</span><span style="color:#b392f0">acquireQueued</span><span style="color:#e1e4e8">(node, savedState) </span><span style="color:#f97583">&amp;&amp;</span><span style="color:#e1e4e8"> interruptMode </span><span style="color:#f97583">!=</span><span style="color:#e1e4e8"> THROW_IE)</span></span>
<span class="line"><span style="color:#e1e4e8">            interruptMode </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> REINTERRUPT;</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#6a737d">// ÊâÄÊúâÂ∑≤ÂèñÊ∂àÁöÑ Node ‰ªéÈòüÂàóÈìæË°®Âà†Èô§, ËßÅ „à°</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (node.nextWaiter </span><span style="color:#f97583">!=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8">)</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#b392f0">unlinkCancelledWaiters</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#6a737d">// Â∫îÁî®ÊâìÊñ≠Ê®°Âºè, ËßÅ „à§</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (interruptMode </span><span style="color:#f97583">!=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8">)</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#b392f0">reportInterruptAfterWait</span><span style="color:#e1e4e8">(interruptMode);</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">// Á≠âÂæÖ - Áõ¥Âà∞Ë¢´Âî§ÈÜíÊàñÊâìÊñ≠ÊàñË∂ÖÊó∂</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">final</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">long</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">awaitNanos</span><span style="color:#e1e4e8">(</span><span style="color:#f97583">long</span><span style="color:#e1e4e8"> </span><span style="color:#ffab70">nanosTimeout</span><span style="color:#e1e4e8">) </span><span style="color:#f97583">throws</span><span style="color:#e1e4e8"> InterruptedException {</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (Thread.</span><span style="color:#b392f0">interrupted</span><span style="color:#e1e4e8">()) {</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">throw</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">InterruptedException</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">        }</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#6a737d">// Ê∑ªÂä†‰∏Ä‰∏™ Node Ëá≥Á≠âÂæÖÈòüÂàó, ËßÅ „à†</span></span>
<span class="line"><span style="color:#e1e4e8">        Node node </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">addConditionWaiter</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#6a737d">// ÈáäÊîæËäÇÁÇπÊåÅÊúâÁöÑÈîÅ</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> savedState </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">fullyRelease</span><span style="color:#e1e4e8">(node);</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#6a737d">// Ëé∑ÂæóÊúÄÂêéÊúüÈôê</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">final</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">long</span><span style="color:#e1e4e8"> deadline </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> System.</span><span style="color:#b392f0">nanoTime</span><span style="color:#e1e4e8">() </span><span style="color:#f97583">+</span><span style="color:#e1e4e8"> nanosTimeout;</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> interruptMode </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#6a737d">// Â¶ÇÊûúËØ•ËäÇÁÇπËøòÊ≤°ÊúâËΩ¨ÁßªËá≥ AQS ÈòüÂàó, ÈòªÂ°û</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">while</span><span style="color:#e1e4e8"> (</span><span style="color:#f97583">!</span><span style="color:#b392f0">isOnSyncQueue</span><span style="color:#e1e4e8">(node)) {</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#6a737d">// Â∑≤Ë∂ÖÊó∂, ÈÄÄÂá∫Á≠âÂæÖÈòüÂàó</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (nanosTimeout </span><span style="color:#f97583">&lt;=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">0L</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#b392f0">transferAfterCancelledWait</span><span style="color:#e1e4e8">(node);</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#f97583">break</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">            }</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#6a737d">// park ÈòªÂ°û‰∏ÄÂÆöÊó∂Èó¥, spinForTimeoutThreshold ‰∏∫ 1000 ns</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (nanosTimeout </span><span style="color:#f97583">&gt;=</span><span style="color:#e1e4e8"> spinForTimeoutThreshold)</span></span>
<span class="line"><span style="color:#e1e4e8">                LockSupport.</span><span style="color:#b392f0">parkNanos</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">this</span><span style="color:#e1e4e8">, nanosTimeout);</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#6a737d">// Â¶ÇÊûúË¢´ÊâìÊñ≠, ÈÄÄÂá∫Á≠âÂæÖÈòüÂàó</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> ((interruptMode </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">checkInterruptWhileWaiting</span><span style="color:#e1e4e8">(node)) </span><span style="color:#f97583">!=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8">)</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#f97583">break</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">            nanosTimeout </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> deadline </span><span style="color:#f97583">-</span><span style="color:#e1e4e8"> System.</span><span style="color:#b392f0">nanoTime</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">        }</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#6a737d">// ÈÄÄÂá∫Á≠âÂæÖÈòüÂàóÂêé, ËøòÈúÄË¶ÅËé∑Âæó AQS ÈòüÂàóÁöÑÈîÅ</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (</span><span style="color:#b392f0">acquireQueued</span><span style="color:#e1e4e8">(node, savedState) </span><span style="color:#f97583">&amp;&amp;</span><span style="color:#e1e4e8"> interruptMode </span><span style="color:#f97583">!=</span><span style="color:#e1e4e8"> THROW_IE)</span></span>
<span class="line"><span style="color:#e1e4e8">            interruptMode </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> REINTERRUPT;</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#6a737d">// ÊâÄÊúâÂ∑≤ÂèñÊ∂àÁöÑ Node ‰ªéÈòüÂàóÈìæË°®Âà†Èô§, ËßÅ „à°</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (node.nextWaiter </span><span style="color:#f97583">!=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8">)</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#b392f0">unlinkCancelledWaiters</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#6a737d">// Â∫îÁî®ÊâìÊñ≠Ê®°Âºè, ËßÅ „à§</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (interruptMode </span><span style="color:#f97583">!=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8">)</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#b392f0">reportInterruptAfterWait</span><span style="color:#e1e4e8">(interruptMode);</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> deadline </span><span style="color:#f97583">-</span><span style="color:#e1e4e8"> System.</span><span style="color:#b392f0">nanoTime</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">// Á≠âÂæÖ - Áõ¥Âà∞Ë¢´Âî§ÈÜíÊàñÊâìÊñ≠ÊàñË∂ÖÊó∂, ÈÄªËæëÁ±ª‰ºº‰∫é awaitNanos</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">final</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">boolean</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">awaitUntil</span><span style="color:#e1e4e8">(Date </span><span style="color:#ffab70">deadline</span><span style="color:#e1e4e8">) </span><span style="color:#f97583">throws</span><span style="color:#e1e4e8"> InterruptedException {</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#6a737d">// ...</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">// Á≠âÂæÖ - Áõ¥Âà∞Ë¢´Âî§ÈÜíÊàñÊâìÊñ≠ÊàñË∂ÖÊó∂, ÈÄªËæëÁ±ª‰ºº‰∫é awaitNanos</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">final</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">boolean</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">await</span><span style="color:#e1e4e8">(</span><span style="color:#f97583">long</span><span style="color:#e1e4e8"> </span><span style="color:#ffab70">time</span><span style="color:#e1e4e8">, TimeUnit </span><span style="color:#ffab70">unit</span><span style="color:#e1e4e8">) </span><span style="color:#f97583">throws</span><span style="color:#e1e4e8"> InterruptedException {</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#6a737d">// ...</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">// Â∑•ÂÖ∑ÊñπÊ≥ï ÁúÅÁï• ...</span></span>
<span class="line"><span style="color:#e1e4e8">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">class</span><span style="color:#24292e"> </span><span style="color:#6f42c1">ConditionObject</span><span style="color:#24292e"> </span><span style="color:#d73a49">implements</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Condition</span><span style="color:#24292e">, java.io.</span><span style="color:#6f42c1">Serializable</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">private</span><span style="color:#24292e"> </span><span style="color:#d73a49">static</span><span style="color:#24292e"> </span><span style="color:#d73a49">final</span><span style="color:#24292e"> </span><span style="color:#d73a49">long</span><span style="color:#24292e"> serialVersionUID </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#005cc5">1173984872572414699L</span><span style="color:#24292e">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">// Á¨¨‰∏Ä‰∏™Á≠âÂæÖËäÇÁÇπ</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">private</span><span style="color:#24292e"> </span><span style="color:#d73a49">transient</span><span style="color:#24292e"> Node firstWaiter;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">// ÊúÄÂêé‰∏Ä‰∏™Á≠âÂæÖËäÇÁÇπ</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">private</span><span style="color:#24292e"> </span><span style="color:#d73a49">transient</span><span style="color:#24292e"> Node lastWaiter;</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#6f42c1">ConditionObject</span><span style="color:#24292e">() { }</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">// „à† Ê∑ªÂä†‰∏Ä‰∏™ Node Ëá≥Á≠âÂæÖÈòüÂàó</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">private</span><span style="color:#24292e"> Node </span><span style="color:#6f42c1">addConditionWaiter</span><span style="color:#24292e">() {</span></span>
<span class="line"><span style="color:#24292e">        Node t </span><span style="color:#d73a49">=</span><span style="color:#24292e"> lastWaiter;</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6a737d">// ÊâÄÊúâÂ∑≤ÂèñÊ∂àÁöÑ Node ‰ªéÈòüÂàóÈìæË°®Âà†Èô§, ËßÅ „à°</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (t </span><span style="color:#d73a49">!=</span><span style="color:#24292e"> </span><span style="color:#005cc5">null</span><span style="color:#24292e"> </span><span style="color:#d73a49">&amp;&amp;</span><span style="color:#24292e"> t.waitStatus </span><span style="color:#d73a49">!=</span><span style="color:#24292e"> Node.CONDITION) {</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#6f42c1">unlinkCancelledWaiters</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">            t </span><span style="color:#d73a49">=</span><span style="color:#24292e"> lastWaiter;</span></span>
<span class="line"><span style="color:#24292e">        }</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6a737d">// ÂàõÂª∫‰∏Ä‰∏™ÂÖ≥ËÅîÂΩìÂâçÁ∫øÁ®ãÁöÑÊñ∞ Node, Ê∑ªÂä†Ëá≥ÈòüÂàóÂ∞æÈÉ®</span></span>
<span class="line"><span style="color:#24292e">        Node node </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Node</span><span style="color:#24292e">(Thread.</span><span style="color:#6f42c1">currentThread</span><span style="color:#24292e">(), Node.CONDITION);</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (t </span><span style="color:#d73a49">==</span><span style="color:#24292e"> </span><span style="color:#005cc5">null</span><span style="color:#24292e">)</span></span>
<span class="line"><span style="color:#24292e">            firstWaiter </span><span style="color:#d73a49">=</span><span style="color:#24292e"> node;</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">else</span></span>
<span class="line"><span style="color:#24292e">            t.nextWaiter </span><span style="color:#d73a49">=</span><span style="color:#24292e"> node;</span></span>
<span class="line"><span style="color:#24292e">        lastWaiter </span><span style="color:#d73a49">=</span><span style="color:#24292e"> node;</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">return</span><span style="color:#24292e"> node;</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">// Âî§ÈÜí - Â∞ÜÊ≤°ÂèñÊ∂àÁöÑÁ¨¨‰∏Ä‰∏™ËäÇÁÇπËΩ¨ÁßªËá≥ AQS ÈòüÂàó</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">private</span><span style="color:#24292e"> </span><span style="color:#d73a49">void</span><span style="color:#24292e"> </span><span style="color:#6f42c1">doSignal</span><span style="color:#24292e">(Node </span><span style="color:#e36209">first</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">do</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#6a737d">// Â∑≤ÁªèÊòØÂ∞æËäÇÁÇπ‰∫Ü</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">if</span><span style="color:#24292e"> ( (firstWaiter </span><span style="color:#d73a49">=</span><span style="color:#24292e"> first.nextWaiter) </span><span style="color:#d73a49">==</span><span style="color:#24292e"> </span><span style="color:#005cc5">null</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">                lastWaiter </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#005cc5">null</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">            }</span></span>
<span class="line"><span style="color:#24292e">            first.nextWaiter </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#005cc5">null</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">        } </span><span style="color:#d73a49">while</span><span style="color:#24292e"> (</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#6a737d">// Â∞ÜÁ≠âÂæÖÈòüÂàó‰∏≠ÁöÑ Node ËΩ¨ÁßªËá≥ AQS ÈòüÂàó, ‰∏çÊàêÂäü‰∏îËøòÊúâËäÇÁÇπÂàôÁªßÁª≠Âæ™ÁéØ „à¢</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#d73a49">!</span><span style="color:#6f42c1">transferForSignal</span><span style="color:#24292e">(first) </span><span style="color:#d73a49">&amp;&amp;</span></span>
<span class="line"><span style="color:#24292e">                        </span><span style="color:#6a737d">// ÈòüÂàóËøòÊúâËäÇÁÇπ</span></span>
<span class="line"><span style="color:#24292e">                        (first </span><span style="color:#d73a49">=</span><span style="color:#24292e"> firstWaiter) </span><span style="color:#d73a49">!=</span><span style="color:#24292e"> </span><span style="color:#005cc5">null</span></span>
<span class="line"><span style="color:#24292e">        );</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">// Â§ñÈÉ®Á±ªÊñπÊ≥ï, Êñπ‰æøÈòÖËØª, ÊîæÂú®Ê≠§Â§Ñ</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">// „à¢ Â¶ÇÊûúËäÇÁÇπÁä∂ÊÄÅÊòØÂèñÊ∂à, ËøîÂõû false Ë°®Á§∫ËΩ¨ÁßªÂ§±Ë¥•, Âê¶ÂàôËΩ¨ÁßªÊàêÂäü</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">final</span><span style="color:#24292e"> </span><span style="color:#d73a49">boolean</span><span style="color:#24292e"> </span><span style="color:#6f42c1">transferForSignal</span><span style="color:#24292e">(Node </span><span style="color:#e36209">node</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6a737d">// ËÆæÁΩÆÂΩìÂâçnodeÁä∂ÊÄÅ‰∏∫0ÔºàÂõ†‰∏∫Â§ÑÂú®ÈòüÂàóÊú´Â∞æÔºâÔºåÂ¶ÇÊûúÁä∂ÊÄÅÂ∑≤Áªè‰∏çÊòØ Node.CONDITION, ËØ¥ÊòéË¢´ÂèñÊ∂à‰∫Ü</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (</span><span style="color:#d73a49">!</span><span style="color:#6f42c1">compareAndSetWaitStatus</span><span style="color:#24292e">(node, Node.CONDITION, </span><span style="color:#005cc5">0</span><span style="color:#24292e">))</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">return</span><span style="color:#24292e"> </span><span style="color:#005cc5">false</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6a737d">// Âä†ÂÖ• AQS ÈòüÂàóÂ∞æÈÉ®</span></span>
<span class="line"><span style="color:#24292e">        Node p </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#6f42c1">enq</span><span style="color:#24292e">(node);</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">int</span><span style="color:#24292e"> ws </span><span style="color:#d73a49">=</span><span style="color:#24292e"> p.waitStatus;</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#6a737d">// ÊèíÂÖ•ËäÇÁÇπÁöÑ‰∏ä‰∏Ä‰∏™ËäÇÁÇπË¢´ÂèñÊ∂à</span></span>
<span class="line"><span style="color:#24292e">                ws </span><span style="color:#d73a49">&gt;</span><span style="color:#24292e"> </span><span style="color:#005cc5">0</span><span style="color:#24292e"> </span><span style="color:#d73a49">||</span></span>
<span class="line"><span style="color:#24292e">                        </span><span style="color:#6a737d">// ÊèíÂÖ•ËäÇÁÇπÁöÑ‰∏ä‰∏Ä‰∏™ËäÇÁÇπ‰∏çËÉΩËÆæÁΩÆÁä∂ÊÄÅ‰∏∫ Node.SIGNAL</span></span>
<span class="line"><span style="color:#24292e">                        </span><span style="color:#d73a49">!</span><span style="color:#6f42c1">compareAndSetWaitStatus</span><span style="color:#24292e">(p, ws, Node.SIGNAL)</span></span>
<span class="line"><span style="color:#24292e">        ) {</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#6a737d">// unpark ÂèñÊ∂àÈòªÂ°û, ËÆ©Á∫øÁ®ãÈáçÊñ∞ÂêåÊ≠•Áä∂ÊÄÅ</span></span>
<span class="line"><span style="color:#24292e">            LockSupport.</span><span style="color:#6f42c1">unpark</span><span style="color:#24292e">(node.thread);</span></span>
<span class="line"><span style="color:#24292e">        }</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">return</span><span style="color:#24292e"> </span><span style="color:#005cc5">true</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"><span style="color:#6a737d">// ÂÖ®ÈÉ®Âî§ÈÜí - Á≠âÂæÖÈòüÂàóÁöÑÊâÄÊúâËäÇÁÇπËΩ¨ÁßªËá≥ AQS ÈòüÂàó</span></span>
<span class="line"><span style="color:#d73a49">private</span><span style="color:#24292e"> </span><span style="color:#d73a49">void</span><span style="color:#24292e"> </span><span style="color:#6f42c1">doSignalAll</span><span style="color:#24292e">(Node </span><span style="color:#e36209">first</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">    lastWaiter </span><span style="color:#d73a49">=</span><span style="color:#24292e"> firstWaiter </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#005cc5">null</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">do</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">        Node next </span><span style="color:#d73a49">=</span><span style="color:#24292e"> first.nextWaiter;</span></span>
<span class="line"><span style="color:#24292e">        first.nextWaiter </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#005cc5">null</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6f42c1">transferForSignal</span><span style="color:#24292e">(first);</span></span>
<span class="line"><span style="color:#24292e">        first </span><span style="color:#d73a49">=</span><span style="color:#24292e"> next;</span></span>
<span class="line"><span style="color:#24292e">    } </span><span style="color:#d73a49">while</span><span style="color:#24292e"> (first </span><span style="color:#d73a49">!=</span><span style="color:#24292e"> </span><span style="color:#005cc5">null</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">// „à°</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">private</span><span style="color:#24292e"> </span><span style="color:#d73a49">void</span><span style="color:#24292e"> </span><span style="color:#6f42c1">unlinkCancelledWaiters</span><span style="color:#24292e">() {</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6a737d">// ...</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">// Âî§ÈÜí - ÂøÖÈ°ªÊåÅÊúâÈîÅÊâçËÉΩÂî§ÈÜí, Âõ†Ê≠§ doSignal ÂÜÖÊó†ÈúÄËÄÉËôëÂä†ÈîÅ</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">final</span><span style="color:#24292e"> </span><span style="color:#d73a49">void</span><span style="color:#24292e"> </span><span style="color:#6f42c1">signal</span><span style="color:#24292e">() {</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6a737d">// Â¶ÇÊûúÊ≤°ÊúâÊåÅÊúâÈîÅÔºå‰ºöÊäõÂá∫ÂºÇÂ∏∏</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (</span><span style="color:#d73a49">!</span><span style="color:#6f42c1">isHeldExclusively</span><span style="color:#24292e">())</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">throw</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">IllegalMonitorStateException</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">        Node first </span><span style="color:#d73a49">=</span><span style="color:#24292e"> firstWaiter;</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (first </span><span style="color:#d73a49">!=</span><span style="color:#24292e"> </span><span style="color:#005cc5">null</span><span style="color:#24292e">)</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#6f42c1">doSignal</span><span style="color:#24292e">(first);</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">// ÂÖ®ÈÉ®Âî§ÈÜí - ÂøÖÈ°ªÊåÅÊúâÈîÅÊâçËÉΩÂî§ÈÜí, Âõ†Ê≠§ doSignalAll ÂÜÖÊó†ÈúÄËÄÉËôëÂä†ÈîÅ</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">final</span><span style="color:#24292e"> </span><span style="color:#d73a49">void</span><span style="color:#24292e"> </span><span style="color:#6f42c1">signalAll</span><span style="color:#24292e">() {</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (</span><span style="color:#d73a49">!</span><span style="color:#6f42c1">isHeldExclusively</span><span style="color:#24292e">())</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">throw</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">IllegalMonitorStateException</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">        Node first </span><span style="color:#d73a49">=</span><span style="color:#24292e"> firstWaiter;</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (first </span><span style="color:#d73a49">!=</span><span style="color:#24292e"> </span><span style="color:#005cc5">null</span><span style="color:#24292e">)</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#6f42c1">doSignalAll</span><span style="color:#24292e">(first);</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">// ‰∏çÂèØÊâìÊñ≠Á≠âÂæÖ - Áõ¥Âà∞Ë¢´Âî§ÈÜí</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">final</span><span style="color:#24292e"> </span><span style="color:#d73a49">void</span><span style="color:#24292e"> </span><span style="color:#6f42c1">awaitUninterruptibly</span><span style="color:#24292e">() {</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6a737d">// Ê∑ªÂä†‰∏Ä‰∏™ Node Ëá≥Á≠âÂæÖÈòüÂàó, ËßÅ „à†</span></span>
<span class="line"><span style="color:#24292e">        Node node </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#6f42c1">addConditionWaiter</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6a737d">// ÈáäÊîæËäÇÁÇπÊåÅÊúâÁöÑÈîÅ, ËßÅ „à£</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">int</span><span style="color:#24292e"> savedState </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#6f42c1">fullyRelease</span><span style="color:#24292e">(node);</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">boolean</span><span style="color:#24292e"> interrupted </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#005cc5">false</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6a737d">// Â¶ÇÊûúËØ•ËäÇÁÇπËøòÊ≤°ÊúâËΩ¨ÁßªËá≥ AQS ÈòüÂàó, ÈòªÂ°û</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">while</span><span style="color:#24292e"> (</span><span style="color:#d73a49">!</span><span style="color:#6f42c1">isOnSyncQueue</span><span style="color:#24292e">(node)) {</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#6a737d">// park ÈòªÂ°û</span></span>
<span class="line"><span style="color:#24292e">            LockSupport.</span><span style="color:#6f42c1">park</span><span style="color:#24292e">(</span><span style="color:#005cc5">this</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#6a737d">// Â¶ÇÊûúË¢´ÊâìÊñ≠, ‰ªÖËÆæÁΩÆÊâìÊñ≠Áä∂ÊÄÅ</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (Thread.</span><span style="color:#6f42c1">interrupted</span><span style="color:#24292e">())</span></span>
<span class="line"><span style="color:#24292e">                interrupted </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#005cc5">true</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">        }</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6a737d">// Âî§ÈÜíÂêé, Â∞ùËØïÁ´û‰∫âÈîÅ, Â¶ÇÊûúÂ§±Ë¥•ËøõÂÖ• AQS ÈòüÂàó</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (</span><span style="color:#6f42c1">acquireQueued</span><span style="color:#24292e">(node, savedState) </span><span style="color:#d73a49">||</span><span style="color:#24292e"> interrupted)</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#6f42c1">selfInterrupt</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">// Â§ñÈÉ®Á±ªÊñπÊ≥ï, Êñπ‰æøÈòÖËØª, ÊîæÂú®Ê≠§Â§Ñ</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">// „à£ Âõ†‰∏∫ÊüêÁ∫øÁ®ãÂèØËÉΩÈáçÂÖ•ÔºåÈúÄË¶ÅÂ∞Ü state ÂÖ®ÈÉ®ÈáäÊîæÔºåËé∑ÂèñstateÔºåÁÑ∂ÂêéÊääÂÆÉÂÖ®ÈÉ®ÂáèÊéâÔºå‰ª•ÂÖ®ÈÉ®ÈáäÊîæ</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">final</span><span style="color:#24292e"> </span><span style="color:#d73a49">int</span><span style="color:#24292e"> </span><span style="color:#6f42c1">fullyRelease</span><span style="color:#24292e">(Node </span><span style="color:#e36209">node</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">boolean</span><span style="color:#24292e"> failed </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#005cc5">true</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">try</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">int</span><span style="color:#24292e"> savedState </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#6f42c1">getState</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#6a737d">// Âî§ÈÜíÁ≠âÂæÖÈòüÂàóÈòüÂàó‰∏≠ÁöÑ‰∏ã‰∏Ä‰∏™ËäÇÁÇπ</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (</span><span style="color:#6f42c1">release</span><span style="color:#24292e">(savedState)) {</span></span>
<span class="line"><span style="color:#24292e">                failed </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#005cc5">false</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#d73a49">return</span><span style="color:#24292e"> savedState;</span></span>
<span class="line"><span style="color:#24292e">            } </span><span style="color:#d73a49">else</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#d73a49">throw</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">IllegalMonitorStateException</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">            }</span></span>
<span class="line"><span style="color:#24292e">        } </span><span style="color:#d73a49">finally</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (failed)</span></span>
<span class="line"><span style="color:#24292e">                node.waitStatus </span><span style="color:#d73a49">=</span><span style="color:#24292e"> Node.CANCELLED;</span></span>
<span class="line"><span style="color:#24292e">        }</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">// ÊâìÊñ≠Ê®°Âºè - Âú®ÈÄÄÂá∫Á≠âÂæÖÊó∂ÈáçÊñ∞ËÆæÁΩÆÊâìÊñ≠Áä∂ÊÄÅ</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">private</span><span style="color:#24292e"> </span><span style="color:#d73a49">static</span><span style="color:#24292e"> </span><span style="color:#d73a49">final</span><span style="color:#24292e"> </span><span style="color:#d73a49">int</span><span style="color:#24292e"> REINTERRUPT </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#005cc5">1</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">// ÊâìÊñ≠Ê®°Âºè - Âú®ÈÄÄÂá∫Á≠âÂæÖÊó∂ÊäõÂá∫ÂºÇÂ∏∏</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">private</span><span style="color:#24292e"> </span><span style="color:#d73a49">static</span><span style="color:#24292e"> </span><span style="color:#d73a49">final</span><span style="color:#24292e"> </span><span style="color:#d73a49">int</span><span style="color:#24292e"> THROW_IE </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#d73a49">-</span><span style="color:#005cc5">1</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">// Âà§Êñ≠ÊâìÊñ≠Ê®°Âºè</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">private</span><span style="color:#24292e"> </span><span style="color:#d73a49">int</span><span style="color:#24292e"> </span><span style="color:#6f42c1">checkInterruptWhileWaiting</span><span style="color:#24292e">(Node </span><span style="color:#e36209">node</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">return</span><span style="color:#24292e"> Thread.</span><span style="color:#6f42c1">interrupted</span><span style="color:#24292e">() </span><span style="color:#d73a49">?</span></span>
<span class="line"><span style="color:#24292e">                (</span><span style="color:#6f42c1">transferAfterCancelledWait</span><span style="color:#24292e">(node) </span><span style="color:#d73a49">?</span><span style="color:#24292e"> THROW_IE </span><span style="color:#d73a49">:</span><span style="color:#24292e"> REINTERRUPT) </span><span style="color:#d73a49">:</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#005cc5">0</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">// „à§ Â∫îÁî®ÊâìÊñ≠Ê®°Âºè</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">private</span><span style="color:#24292e"> </span><span style="color:#d73a49">void</span><span style="color:#24292e"> </span><span style="color:#6f42c1">reportInterruptAfterWait</span><span style="color:#24292e">(</span><span style="color:#d73a49">int</span><span style="color:#24292e"> </span><span style="color:#e36209">interruptMode</span><span style="color:#24292e">)</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">throws</span><span style="color:#24292e"> InterruptedException {</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (interruptMode </span><span style="color:#d73a49">==</span><span style="color:#24292e"> THROW_IE)</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">throw</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">InterruptedException</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">else</span><span style="color:#24292e"> </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (interruptMode </span><span style="color:#d73a49">==</span><span style="color:#24292e"> REINTERRUPT)</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#6f42c1">selfInterrupt</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">// Á≠âÂæÖ - Áõ¥Âà∞Ë¢´Âî§ÈÜíÊàñÊâìÊñ≠</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">final</span><span style="color:#24292e"> </span><span style="color:#d73a49">void</span><span style="color:#24292e"> </span><span style="color:#6f42c1">await</span><span style="color:#24292e">() </span><span style="color:#d73a49">throws</span><span style="color:#24292e"> InterruptedException {</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (Thread.</span><span style="color:#6f42c1">interrupted</span><span style="color:#24292e">()) {</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">throw</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">InterruptedException</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">        }</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6a737d">// Ê∑ªÂä†‰∏Ä‰∏™ Node Ëá≥Á≠âÂæÖÈòüÂàó, ËßÅ „à†</span></span>
<span class="line"><span style="color:#24292e">        Node node </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#6f42c1">addConditionWaiter</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6a737d">// ÈáäÊîæËäÇÁÇπÊåÅÊúâÁöÑÈîÅ</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">int</span><span style="color:#24292e"> savedState </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#6f42c1">fullyRelease</span><span style="color:#24292e">(node);</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">int</span><span style="color:#24292e"> interruptMode </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#005cc5">0</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6a737d">// Â¶ÇÊûúËØ•ËäÇÁÇπËøòÊ≤°ÊúâËΩ¨ÁßªËá≥ AQS ÈòüÂàó, ÈòªÂ°û</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">while</span><span style="color:#24292e"> (</span><span style="color:#d73a49">!</span><span style="color:#6f42c1">isOnSyncQueue</span><span style="color:#24292e">(node)) {</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#6a737d">// park ÈòªÂ°û              </span></span>
<span class="line"><span style="color:#24292e">            LockSupport.</span><span style="color:#6f42c1">park</span><span style="color:#24292e">(</span><span style="color:#005cc5">this</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#6a737d">// Â¶ÇÊûúË¢´ÊâìÊñ≠, ÈÄÄÂá∫Á≠âÂæÖÈòüÂàó</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">if</span><span style="color:#24292e"> ((interruptMode </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#6f42c1">checkInterruptWhileWaiting</span><span style="color:#24292e">(node)) </span><span style="color:#d73a49">!=</span><span style="color:#24292e"> </span><span style="color:#005cc5">0</span><span style="color:#24292e">)</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#d73a49">break</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">        }</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6a737d">// ÈÄÄÂá∫Á≠âÂæÖÈòüÂàóÂêé, ËøòÈúÄË¶ÅËé∑Âæó AQS ÈòüÂàóÁöÑÈîÅ</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (</span><span style="color:#6f42c1">acquireQueued</span><span style="color:#24292e">(node, savedState) </span><span style="color:#d73a49">&amp;&amp;</span><span style="color:#24292e"> interruptMode </span><span style="color:#d73a49">!=</span><span style="color:#24292e"> THROW_IE)</span></span>
<span class="line"><span style="color:#24292e">            interruptMode </span><span style="color:#d73a49">=</span><span style="color:#24292e"> REINTERRUPT;</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6a737d">// ÊâÄÊúâÂ∑≤ÂèñÊ∂àÁöÑ Node ‰ªéÈòüÂàóÈìæË°®Âà†Èô§, ËßÅ „à°</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (node.nextWaiter </span><span style="color:#d73a49">!=</span><span style="color:#24292e"> </span><span style="color:#005cc5">null</span><span style="color:#24292e">)</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#6f42c1">unlinkCancelledWaiters</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6a737d">// Â∫îÁî®ÊâìÊñ≠Ê®°Âºè, ËßÅ „à§</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (interruptMode </span><span style="color:#d73a49">!=</span><span style="color:#24292e"> </span><span style="color:#005cc5">0</span><span style="color:#24292e">)</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#6f42c1">reportInterruptAfterWait</span><span style="color:#24292e">(interruptMode);</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">// Á≠âÂæÖ - Áõ¥Âà∞Ë¢´Âî§ÈÜíÊàñÊâìÊñ≠ÊàñË∂ÖÊó∂</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">final</span><span style="color:#24292e"> </span><span style="color:#d73a49">long</span><span style="color:#24292e"> </span><span style="color:#6f42c1">awaitNanos</span><span style="color:#24292e">(</span><span style="color:#d73a49">long</span><span style="color:#24292e"> </span><span style="color:#e36209">nanosTimeout</span><span style="color:#24292e">) </span><span style="color:#d73a49">throws</span><span style="color:#24292e"> InterruptedException {</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (Thread.</span><span style="color:#6f42c1">interrupted</span><span style="color:#24292e">()) {</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">throw</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">InterruptedException</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">        }</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6a737d">// Ê∑ªÂä†‰∏Ä‰∏™ Node Ëá≥Á≠âÂæÖÈòüÂàó, ËßÅ „à†</span></span>
<span class="line"><span style="color:#24292e">        Node node </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#6f42c1">addConditionWaiter</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6a737d">// ÈáäÊîæËäÇÁÇπÊåÅÊúâÁöÑÈîÅ</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">int</span><span style="color:#24292e"> savedState </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#6f42c1">fullyRelease</span><span style="color:#24292e">(node);</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6a737d">// Ëé∑ÂæóÊúÄÂêéÊúüÈôê</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">final</span><span style="color:#24292e"> </span><span style="color:#d73a49">long</span><span style="color:#24292e"> deadline </span><span style="color:#d73a49">=</span><span style="color:#24292e"> System.</span><span style="color:#6f42c1">nanoTime</span><span style="color:#24292e">() </span><span style="color:#d73a49">+</span><span style="color:#24292e"> nanosTimeout;</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">int</span><span style="color:#24292e"> interruptMode </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#005cc5">0</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6a737d">// Â¶ÇÊûúËØ•ËäÇÁÇπËøòÊ≤°ÊúâËΩ¨ÁßªËá≥ AQS ÈòüÂàó, ÈòªÂ°û</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">while</span><span style="color:#24292e"> (</span><span style="color:#d73a49">!</span><span style="color:#6f42c1">isOnSyncQueue</span><span style="color:#24292e">(node)) {</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#6a737d">// Â∑≤Ë∂ÖÊó∂, ÈÄÄÂá∫Á≠âÂæÖÈòüÂàó</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (nanosTimeout </span><span style="color:#d73a49">&lt;=</span><span style="color:#24292e"> </span><span style="color:#005cc5">0L</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#6f42c1">transferAfterCancelledWait</span><span style="color:#24292e">(node);</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#d73a49">break</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">            }</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#6a737d">// park ÈòªÂ°û‰∏ÄÂÆöÊó∂Èó¥, spinForTimeoutThreshold ‰∏∫ 1000 ns</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (nanosTimeout </span><span style="color:#d73a49">&gt;=</span><span style="color:#24292e"> spinForTimeoutThreshold)</span></span>
<span class="line"><span style="color:#24292e">                LockSupport.</span><span style="color:#6f42c1">parkNanos</span><span style="color:#24292e">(</span><span style="color:#005cc5">this</span><span style="color:#24292e">, nanosTimeout);</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#6a737d">// Â¶ÇÊûúË¢´ÊâìÊñ≠, ÈÄÄÂá∫Á≠âÂæÖÈòüÂàó</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">if</span><span style="color:#24292e"> ((interruptMode </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#6f42c1">checkInterruptWhileWaiting</span><span style="color:#24292e">(node)) </span><span style="color:#d73a49">!=</span><span style="color:#24292e"> </span><span style="color:#005cc5">0</span><span style="color:#24292e">)</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#d73a49">break</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">            nanosTimeout </span><span style="color:#d73a49">=</span><span style="color:#24292e"> deadline </span><span style="color:#d73a49">-</span><span style="color:#24292e"> System.</span><span style="color:#6f42c1">nanoTime</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">        }</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6a737d">// ÈÄÄÂá∫Á≠âÂæÖÈòüÂàóÂêé, ËøòÈúÄË¶ÅËé∑Âæó AQS ÈòüÂàóÁöÑÈîÅ</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (</span><span style="color:#6f42c1">acquireQueued</span><span style="color:#24292e">(node, savedState) </span><span style="color:#d73a49">&amp;&amp;</span><span style="color:#24292e"> interruptMode </span><span style="color:#d73a49">!=</span><span style="color:#24292e"> THROW_IE)</span></span>
<span class="line"><span style="color:#24292e">            interruptMode </span><span style="color:#d73a49">=</span><span style="color:#24292e"> REINTERRUPT;</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6a737d">// ÊâÄÊúâÂ∑≤ÂèñÊ∂àÁöÑ Node ‰ªéÈòüÂàóÈìæË°®Âà†Èô§, ËßÅ „à°</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (node.nextWaiter </span><span style="color:#d73a49">!=</span><span style="color:#24292e"> </span><span style="color:#005cc5">null</span><span style="color:#24292e">)</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#6f42c1">unlinkCancelledWaiters</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6a737d">// Â∫îÁî®ÊâìÊñ≠Ê®°Âºè, ËßÅ „à§</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (interruptMode </span><span style="color:#d73a49">!=</span><span style="color:#24292e"> </span><span style="color:#005cc5">0</span><span style="color:#24292e">)</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#6f42c1">reportInterruptAfterWait</span><span style="color:#24292e">(interruptMode);</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">return</span><span style="color:#24292e"> deadline </span><span style="color:#d73a49">-</span><span style="color:#24292e"> System.</span><span style="color:#6f42c1">nanoTime</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">// Á≠âÂæÖ - Áõ¥Âà∞Ë¢´Âî§ÈÜíÊàñÊâìÊñ≠ÊàñË∂ÖÊó∂, ÈÄªËæëÁ±ª‰ºº‰∫é awaitNanos</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">final</span><span style="color:#24292e"> </span><span style="color:#d73a49">boolean</span><span style="color:#24292e"> </span><span style="color:#6f42c1">awaitUntil</span><span style="color:#24292e">(Date </span><span style="color:#e36209">deadline</span><span style="color:#24292e">) </span><span style="color:#d73a49">throws</span><span style="color:#24292e"> InterruptedException {</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6a737d">// ...</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">// Á≠âÂæÖ - Áõ¥Âà∞Ë¢´Âî§ÈÜíÊàñÊâìÊñ≠ÊàñË∂ÖÊó∂, ÈÄªËæëÁ±ª‰ºº‰∫é awaitNanos</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">final</span><span style="color:#24292e"> </span><span style="color:#d73a49">boolean</span><span style="color:#24292e"> </span><span style="color:#6f42c1">await</span><span style="color:#24292e">(</span><span style="color:#d73a49">long</span><span style="color:#24292e"> </span><span style="color:#e36209">time</span><span style="color:#24292e">, TimeUnit </span><span style="color:#e36209">unit</span><span style="color:#24292e">) </span><span style="color:#d73a49">throws</span><span style="color:#24292e"> InterruptedException {</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6a737d">// ...</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">// Â∑•ÂÖ∑ÊñπÊ≥ï ÁúÅÁï• ...</span></span>
<span class="line"><span style="color:#24292e">}</span></span></code></pre></div><h3 id="_3„ÄÅËØªÂÜôÈîÅ" tabindex="-1">3„ÄÅËØªÂÜôÈîÅ <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20advanced%20chapter#_3„ÄÅËØªÂÜôÈîÅ" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h3><h4 id="reentrantreadwritelock" tabindex="-1">ReentrantReadWriteLock <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20advanced%20chapter#reentrantreadwritelock" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h4><p>ÂΩìËØªÊìç‰ΩúËøúËøúÈ´ò‰∫éÂÜôÊìç‰ΩúÊó∂ÔºåËøôÊó∂ÂÄô‰ΩøÁî® ËØªÂÜôÈîÅ ËÆ© ËØª-ËØª ÂèØ‰ª•Âπ∂ÂèëÔºåÊèêÈ´òÊÄßËÉΩ„ÄÇ Á±ª‰ºº‰∫éÊï∞ÊçÆÂ∫ì‰∏≠ÁöÑ <code>select ... from ... lock in share mode</code> Êèê‰æõ‰∏Ä‰∏™ Êï∞ÊçÆÂÆπÂô®Á±ª ÂÜÖÈÉ®ÂàÜÂà´‰ΩøÁî®ËØªÈîÅ‰øùÊä§Êï∞ÊçÆÁöÑ read() ÊñπÊ≥ïÔºåÂÜôÈîÅ‰øùÊä§Êï∞ÊçÆÁöÑ write() ÊñπÊ≥ï</p><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8">@</span><span style="color:#f97583">Slf4j</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">topic</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#9ecbff">"c.DataContainer"</span><span style="color:#e1e4e8">)</span></span>
<span class="line"><span style="color:#f97583">class</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">DataContainer</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">private</span><span style="color:#e1e4e8"> Object data;</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">private</span><span style="color:#e1e4e8"> ReentrantReadWriteLock rw </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">ReentrantReadWriteLock</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">private</span><span style="color:#e1e4e8"> ReentrantReadWriteLock.ReadLock r </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> rw.</span><span style="color:#b392f0">readLock</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">private</span><span style="color:#e1e4e8"> ReentrantReadWriteLock.WriteLock w </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> rw.</span><span style="color:#b392f0">writeLock</span><span style="color:#e1e4e8">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">public</span><span style="color:#e1e4e8"> Object </span><span style="color:#b392f0">read</span><span style="color:#e1e4e8">() {</span></span>
<span class="line"><span style="color:#e1e4e8">        log.</span><span style="color:#b392f0">debug</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"Ëé∑ÂèñËØªÈîÅ..."</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">        r.</span><span style="color:#b392f0">lock</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">try</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">            log.</span><span style="color:#b392f0">debug</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"ËØªÂèñ"</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#b392f0">sleep</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">1</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> data;</span></span>
<span class="line"><span style="color:#e1e4e8">        } </span><span style="color:#f97583">finally</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">            log.</span><span style="color:#b392f0">debug</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"ÈáäÊîæËØªÈîÅ..."</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">            r.</span><span style="color:#b392f0">unlock</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">        }</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">void</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">write</span><span style="color:#e1e4e8">() {</span></span>
<span class="line"><span style="color:#e1e4e8">        log.</span><span style="color:#b392f0">debug</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"Ëé∑ÂèñÂÜôÈîÅ..."</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">        w.</span><span style="color:#b392f0">lock</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">try</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">            log.</span><span style="color:#b392f0">debug</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"ÂÜôÂÖ•"</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#b392f0">sleep</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">1</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">        } </span><span style="color:#f97583">finally</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">            log.</span><span style="color:#b392f0">debug</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"ÈáäÊîæÂÜôÈîÅ..."</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">            w.</span><span style="color:#b392f0">unlock</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">        }</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"><span style="color:#e1e4e8">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e">@</span><span style="color:#d73a49">Slf4j</span><span style="color:#24292e">(</span><span style="color:#005cc5">topic</span><span style="color:#24292e"> </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#032f62">"c.DataContainer"</span><span style="color:#24292e">)</span></span>
<span class="line"><span style="color:#d73a49">class</span><span style="color:#24292e"> </span><span style="color:#6f42c1">DataContainer</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">private</span><span style="color:#24292e"> Object data;</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">private</span><span style="color:#24292e"> ReentrantReadWriteLock rw </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">ReentrantReadWriteLock</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">private</span><span style="color:#24292e"> ReentrantReadWriteLock.ReadLock r </span><span style="color:#d73a49">=</span><span style="color:#24292e"> rw.</span><span style="color:#6f42c1">readLock</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">private</span><span style="color:#24292e"> ReentrantReadWriteLock.WriteLock w </span><span style="color:#d73a49">=</span><span style="color:#24292e"> rw.</span><span style="color:#6f42c1">writeLock</span><span style="color:#24292e">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">public</span><span style="color:#24292e"> Object </span><span style="color:#6f42c1">read</span><span style="color:#24292e">() {</span></span>
<span class="line"><span style="color:#24292e">        log.</span><span style="color:#6f42c1">debug</span><span style="color:#24292e">(</span><span style="color:#032f62">"Ëé∑ÂèñËØªÈîÅ..."</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">        r.</span><span style="color:#6f42c1">lock</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">try</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">            log.</span><span style="color:#6f42c1">debug</span><span style="color:#24292e">(</span><span style="color:#032f62">"ËØªÂèñ"</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#6f42c1">sleep</span><span style="color:#24292e">(</span><span style="color:#005cc5">1</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">return</span><span style="color:#24292e"> data;</span></span>
<span class="line"><span style="color:#24292e">        } </span><span style="color:#d73a49">finally</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">            log.</span><span style="color:#6f42c1">debug</span><span style="color:#24292e">(</span><span style="color:#032f62">"ÈáäÊîæËØªÈîÅ..."</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">            r.</span><span style="color:#6f42c1">unlock</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">        }</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">void</span><span style="color:#24292e"> </span><span style="color:#6f42c1">write</span><span style="color:#24292e">() {</span></span>
<span class="line"><span style="color:#24292e">        log.</span><span style="color:#6f42c1">debug</span><span style="color:#24292e">(</span><span style="color:#032f62">"Ëé∑ÂèñÂÜôÈîÅ..."</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">        w.</span><span style="color:#6f42c1">lock</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">try</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">            log.</span><span style="color:#6f42c1">debug</span><span style="color:#24292e">(</span><span style="color:#032f62">"ÂÜôÂÖ•"</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#6f42c1">sleep</span><span style="color:#24292e">(</span><span style="color:#005cc5">1</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">        } </span><span style="color:#d73a49">finally</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">            log.</span><span style="color:#6f42c1">debug</span><span style="color:#24292e">(</span><span style="color:#032f62">"ÈáäÊîæÂÜôÈîÅ..."</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">            w.</span><span style="color:#6f42c1">unlock</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">        }</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"><span style="color:#24292e">}</span></span></code></pre></div><p>ÊµãËØï ËØªÈîÅ-ËØªÈîÅ ÂèØ‰ª•Âπ∂Âèë</p><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8">DataContainer dataContainer </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">DataContainer</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Thread</span><span style="color:#e1e4e8">(() </span><span style="color:#f97583">-&gt;</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">dataContainer.</span><span style="color:#b392f0">read</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">}, </span><span style="color:#9ecbff">"t1"</span><span style="color:#e1e4e8">).</span><span style="color:#b392f0">start</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Thread</span><span style="color:#e1e4e8">(() </span><span style="color:#f97583">-&gt;</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">dataContainer.</span><span style="color:#b392f0">read</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">}, </span><span style="color:#9ecbff">"t2"</span><span style="color:#e1e4e8">).</span><span style="color:#b392f0">start</span><span style="color:#e1e4e8">();</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e">DataContainer dataContainer </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">DataContainer</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Thread</span><span style="color:#24292e">(() </span><span style="color:#d73a49">-&gt;</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">dataContainer.</span><span style="color:#6f42c1">read</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">}, </span><span style="color:#032f62">"t1"</span><span style="color:#24292e">).</span><span style="color:#6f42c1">start</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Thread</span><span style="color:#24292e">(() </span><span style="color:#d73a49">-&gt;</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">dataContainer.</span><span style="color:#6f42c1">read</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">}, </span><span style="color:#032f62">"t2"</span><span style="color:#24292e">).</span><span style="color:#6f42c1">start</span><span style="color:#24292e">();</span></span></code></pre></div><figure><img src="https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230719173420253.png" alt="image-20230719173420253" loading="lazy" decoding="async"></figure><p>ÊµãËØï ËØªÈîÅ-ÂÜôÈîÅ Áõ∏‰∫íÈòªÂ°û</p><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8">DataContainer dataContainer </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">DataContainer</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Thread</span><span style="color:#e1e4e8">(() </span><span style="color:#f97583">-&gt;</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">dataContainer.</span><span style="color:#b392f0">read</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">}, </span><span style="color:#9ecbff">"t1"</span><span style="color:#e1e4e8">).</span><span style="color:#b392f0">start</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">Thread.</span><span style="color:#b392f0">sleep</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">100</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Thread</span><span style="color:#e1e4e8">(() </span><span style="color:#f97583">-&gt;</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">dataContainer.</span><span style="color:#b392f0">write</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">}, </span><span style="color:#9ecbff">"t2"</span><span style="color:#e1e4e8">).</span><span style="color:#b392f0">start</span><span style="color:#e1e4e8">();</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e">DataContainer dataContainer </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">DataContainer</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Thread</span><span style="color:#24292e">(() </span><span style="color:#d73a49">-&gt;</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">dataContainer.</span><span style="color:#6f42c1">read</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">}, </span><span style="color:#032f62">"t1"</span><span style="color:#24292e">).</span><span style="color:#6f42c1">start</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">Thread.</span><span style="color:#6f42c1">sleep</span><span style="color:#24292e">(</span><span style="color:#005cc5">100</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Thread</span><span style="color:#24292e">(() </span><span style="color:#d73a49">-&gt;</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">dataContainer.</span><span style="color:#6f42c1">write</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">}, </span><span style="color:#032f62">"t2"</span><span style="color:#24292e">).</span><span style="color:#6f42c1">start</span><span style="color:#24292e">();</span></span></code></pre></div><figure><img src="https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230719173452532.png" alt="image-20230719173452532" loading="lazy" decoding="async"></figure><p>ÂÜôÈîÅ-ÂÜôÈîÅ ‰πüÊòØÁõ∏‰∫íÈòªÂ°ûÁöÑ</p><p><strong>Ê≥®ÊÑè‰∫ãÈ°π</strong></p><ul><li>ËØªÈîÅ‰∏çÊîØÊåÅÊù°‰ª∂ÂèòÈáè</li><li>ÈáçÂÖ•Êó∂ÂçáÁ∫ß‰∏çÊîØÊåÅÔºöÂç≥ÊåÅÊúâËØªÈîÅÁöÑÊÉÖÂÜµ‰∏ãÂéªËé∑ÂèñÂÜôÈîÅÔºå‰ºöÂØºËá¥Ëé∑ÂèñÂÜôÈîÅÊ∞∏‰πÖÁ≠âÂæÖ</li></ul><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8">r.</span><span style="color:#b392f0">lock</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">try</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#6a737d">// ...</span></span>
<span class="line"><span style="color:#e1e4e8">            w.</span><span style="color:#b392f0">lock</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">try</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#6a737d">// ...</span></span>
<span class="line"><span style="color:#e1e4e8">            } </span><span style="color:#f97583">finally</span><span style="color:#e1e4e8">{</span></span>
<span class="line"><span style="color:#e1e4e8">                w.</span><span style="color:#b392f0">unlock</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">            }</span></span>
<span class="line"><span style="color:#e1e4e8">        } </span><span style="color:#f97583">finally</span><span style="color:#e1e4e8">{</span></span>
<span class="line"><span style="color:#e1e4e8">            r.</span><span style="color:#b392f0">unlock</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">        }</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e">r.</span><span style="color:#6f42c1">lock</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">try</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#6a737d">// ...</span></span>
<span class="line"><span style="color:#24292e">            w.</span><span style="color:#6f42c1">lock</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">try</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#6a737d">// ...</span></span>
<span class="line"><span style="color:#24292e">            } </span><span style="color:#d73a49">finally</span><span style="color:#24292e">{</span></span>
<span class="line"><span style="color:#24292e">                w.</span><span style="color:#6f42c1">unlock</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">            }</span></span>
<span class="line"><span style="color:#24292e">        } </span><span style="color:#d73a49">finally</span><span style="color:#24292e">{</span></span>
<span class="line"><span style="color:#24292e">            r.</span><span style="color:#6f42c1">unlock</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">        }</span></span></code></pre></div><ul><li>ÈáçÂÖ•Êó∂ÈôçÁ∫ßÊîØÊåÅÔºöÂç≥ÊåÅÊúâÂÜôÈîÅÁöÑÊÉÖÂÜµ‰∏ãÂéªËé∑ÂèñËØªÈîÅ</li></ul><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#f97583">class</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">CachedData</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">    Object data;</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">// ÊòØÂê¶ÊúâÊïàÔºåÂ¶ÇÊûúÂ§±ÊïàÔºåÈúÄË¶ÅÈáçÊñ∞ËÆ°ÁÆó data</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">volatile</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">boolean</span><span style="color:#e1e4e8"> cacheValid;</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">final</span><span style="color:#e1e4e8"> ReentrantReadWriteLock rwl </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">ReentrantReadWriteLock</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">void</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">processCachedData</span><span style="color:#e1e4e8">() {</span></span>
<span class="line"><span style="color:#e1e4e8">        rwl.</span><span style="color:#b392f0">readLock</span><span style="color:#e1e4e8">().</span><span style="color:#b392f0">lock</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (</span><span style="color:#f97583">!</span><span style="color:#e1e4e8">cacheValid) {</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#6a737d">// Ëé∑ÂèñÂÜôÈîÅÂâçÂøÖÈ°ªÈáäÊîæËØªÈîÅ</span></span>
<span class="line"><span style="color:#e1e4e8">            rwl.</span><span style="color:#b392f0">readLock</span><span style="color:#e1e4e8">().</span><span style="color:#b392f0">unlock</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">            rwl.</span><span style="color:#b392f0">writeLock</span><span style="color:#e1e4e8">().</span><span style="color:#b392f0">lock</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">try</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#6a737d">// Âà§Êñ≠ÊòØÂê¶ÊúâÂÖ∂ÂÆÉÁ∫øÁ®ãÂ∑≤ÁªèËé∑Âèñ‰∫ÜÂÜôÈîÅ„ÄÅÊõ¥Êñ∞‰∫ÜÁºìÂ≠ò, ÈÅøÂÖçÈáçÂ§çÊõ¥Êñ∞</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (</span><span style="color:#f97583">!</span><span style="color:#e1e4e8">cacheValid) {</span></span>
<span class="line"><span style="color:#e1e4e8">                    data </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> ...</span></span>
<span class="line"><span style="color:#e1e4e8">                    cacheValid </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">true</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">                }</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#6a737d">// ÈôçÁ∫ß‰∏∫ËØªÈîÅ, ÈáäÊîæÂÜôÈîÅ, ËøôÊ†∑ËÉΩÂ§üËÆ©ÂÖ∂ÂÆÉÁ∫øÁ®ãËØªÂèñÁºìÂ≠ò</span></span>
<span class="line"><span style="color:#e1e4e8">                rwl.</span><span style="color:#b392f0">readLock</span><span style="color:#e1e4e8">().</span><span style="color:#b392f0">lock</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">            } </span><span style="color:#f97583">finally</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">                rwl.</span><span style="color:#b392f0">writeLock</span><span style="color:#e1e4e8">().</span><span style="color:#b392f0">unlock</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">            }</span></span>
<span class="line"><span style="color:#e1e4e8">        }</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#6a737d">// Ëá™Â∑±Áî®ÂÆåÊï∞ÊçÆ, ÈáäÊîæËØªÈîÅ</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">try</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#b392f0">use</span><span style="color:#e1e4e8">(data);</span></span>
<span class="line"><span style="color:#e1e4e8">        } </span><span style="color:#f97583">finally</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">            rwl.</span><span style="color:#b392f0">readLock</span><span style="color:#e1e4e8">().</span><span style="color:#b392f0">unlock</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">        }</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"><span style="color:#e1e4e8">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#d73a49">class</span><span style="color:#24292e"> </span><span style="color:#6f42c1">CachedData</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">    Object data;</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">// ÊòØÂê¶ÊúâÊïàÔºåÂ¶ÇÊûúÂ§±ÊïàÔºåÈúÄË¶ÅÈáçÊñ∞ËÆ°ÁÆó data</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">volatile</span><span style="color:#24292e"> </span><span style="color:#d73a49">boolean</span><span style="color:#24292e"> cacheValid;</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">final</span><span style="color:#24292e"> ReentrantReadWriteLock rwl </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">ReentrantReadWriteLock</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">void</span><span style="color:#24292e"> </span><span style="color:#6f42c1">processCachedData</span><span style="color:#24292e">() {</span></span>
<span class="line"><span style="color:#24292e">        rwl.</span><span style="color:#6f42c1">readLock</span><span style="color:#24292e">().</span><span style="color:#6f42c1">lock</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (</span><span style="color:#d73a49">!</span><span style="color:#24292e">cacheValid) {</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#6a737d">// Ëé∑ÂèñÂÜôÈîÅÂâçÂøÖÈ°ªÈáäÊîæËØªÈîÅ</span></span>
<span class="line"><span style="color:#24292e">            rwl.</span><span style="color:#6f42c1">readLock</span><span style="color:#24292e">().</span><span style="color:#6f42c1">unlock</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">            rwl.</span><span style="color:#6f42c1">writeLock</span><span style="color:#24292e">().</span><span style="color:#6f42c1">lock</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">try</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#6a737d">// Âà§Êñ≠ÊòØÂê¶ÊúâÂÖ∂ÂÆÉÁ∫øÁ®ãÂ∑≤ÁªèËé∑Âèñ‰∫ÜÂÜôÈîÅ„ÄÅÊõ¥Êñ∞‰∫ÜÁºìÂ≠ò, ÈÅøÂÖçÈáçÂ§çÊõ¥Êñ∞</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (</span><span style="color:#d73a49">!</span><span style="color:#24292e">cacheValid) {</span></span>
<span class="line"><span style="color:#24292e">                    data </span><span style="color:#d73a49">=</span><span style="color:#24292e"> ...</span></span>
<span class="line"><span style="color:#24292e">                    cacheValid </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#005cc5">true</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">                }</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#6a737d">// ÈôçÁ∫ß‰∏∫ËØªÈîÅ, ÈáäÊîæÂÜôÈîÅ, ËøôÊ†∑ËÉΩÂ§üËÆ©ÂÖ∂ÂÆÉÁ∫øÁ®ãËØªÂèñÁºìÂ≠ò</span></span>
<span class="line"><span style="color:#24292e">                rwl.</span><span style="color:#6f42c1">readLock</span><span style="color:#24292e">().</span><span style="color:#6f42c1">lock</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">            } </span><span style="color:#d73a49">finally</span><span style="color:#24292e"> {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">                rwl.</span><span style="color:#6f42c1">writeLock</span><span style="color:#24292e">().</span><span style="color:#6f42c1">unlock</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">            }</span></span>
<span class="line"><span style="color:#24292e">        }</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6a737d">// Ëá™Â∑±Áî®ÂÆåÊï∞ÊçÆ, ÈáäÊîæËØªÈîÅ</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">try</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#6f42c1">use</span><span style="color:#24292e">(data);</span></span>
<span class="line"><span style="color:#24292e">        } </span><span style="color:#d73a49">finally</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">            rwl.</span><span style="color:#6f42c1">readLock</span><span style="color:#24292e">().</span><span style="color:#6f42c1">unlock</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">        }</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"><span style="color:#24292e">}</span></span></code></pre></div><h4 id="Â∫îÁî®‰πãÁºìÂ≠ò" tabindex="-1">Â∫îÁî®‰πãÁºìÂ≠ò <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20advanced%20chapter#Â∫îÁî®‰πãÁºìÂ≠ò" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h4><h5 id="ÁºìÂ≠òÊõ¥Êñ∞Á≠ñÁï•" tabindex="-1">ÁºìÂ≠òÊõ¥Êñ∞Á≠ñÁï• <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20advanced%20chapter#ÁºìÂ≠òÊõ¥Êñ∞Á≠ñÁï•" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h5><p>Êõ¥Êñ∞Êó∂ÔºåÊòØÂÖàÊ∏ÖÁºìÂ≠òËøòÊòØÂÖàÊõ¥Êñ∞Êï∞ÊçÆÂ∫ìÔºü</p><p>ÂÖàÊ∏ÖÁºìÂ≠ò</p><figure><img src="https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230719180038159.png" alt="image-20230719180038159" loading="lazy" decoding="async"></figure><p>ÂÖàÊõ¥Êñ∞Êï∞ÊçÆÂ∫ì</p><figure><img src="https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230719180054603.png" alt="image-20230719180054603" loading="lazy" decoding="async"></figure><p>Ë°•ÂÖÖ‰∏ÄÁßçÊÉÖÂÜµÔºåÂÅáËÆæÊü•ËØ¢Á∫øÁ®ã A Êü•ËØ¢Êï∞ÊçÆÊó∂ÊÅ∞Â•ΩÁºìÂ≠òÊï∞ÊçÆÁî±‰∫éÊó∂Èó¥Âà∞ÊúüÂ§±ÊïàÔºåÊàñÊòØÁ¨¨‰∏ÄÊ¨°Êü•ËØ¢</p><figure><img src="https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230719180125357.png" alt="image-20230719180125357" loading="lazy" decoding="async"></figure><p>ËøôÁßçÊÉÖÂÜµÁöÑÂá∫Áé∞Âá†ÁéáÈùûÂ∏∏Â∞èÔºåËßÅ facebook ËÆ∫Êñá</p><h5 id="ËØªÂÜôÈîÅÂÆûÁé∞‰∏ÄËá¥ÊÄßÁºìÂ≠ò" tabindex="-1">ËØªÂÜôÈîÅÂÆûÁé∞‰∏ÄËá¥ÊÄßÁºìÂ≠ò <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20advanced%20chapter#ËØªÂÜôÈîÅÂÆûÁé∞‰∏ÄËá¥ÊÄßÁºìÂ≠ò" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h5><p>‰ΩøÁî®ËØªÂÜôÈîÅÂÆûÁé∞‰∏Ä‰∏™ÁÆÄÂçïÁöÑÊåâÈúÄÂä†ËΩΩÁºìÂ≠ò</p><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#f97583">class</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">GenericDaoCached</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">extends</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">GenericDao</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">private</span><span style="color:#e1e4e8"> GenericDao dao </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">GenericDao</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">private</span><span style="color:#e1e4e8"> Map&lt;</span><span style="color:#f97583">SqlPair</span><span style="color:#e1e4e8">, </span><span style="color:#f97583">Object</span><span style="color:#e1e4e8">&gt; map </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> HashMap&lt;&gt;();</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">private</span><span style="color:#e1e4e8"> ReentrantReadWriteLock rw </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">ReentrantReadWriteLock</span><span style="color:#e1e4e8">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">    @</span><span style="color:#f97583">Override</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">public</span><span style="color:#e1e4e8"> &lt;</span><span style="color:#f97583">T</span><span style="color:#e1e4e8">&gt; List&lt;</span><span style="color:#f97583">T</span><span style="color:#e1e4e8">&gt; </span><span style="color:#b392f0">queryList</span><span style="color:#e1e4e8">(Class&lt;</span><span style="color:#f97583">T</span><span style="color:#e1e4e8">&gt; </span><span style="color:#ffab70">beanClass</span><span style="color:#e1e4e8">, String </span><span style="color:#ffab70">sql</span><span style="color:#e1e4e8">, Object... </span><span style="color:#ffab70">args</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> dao.</span><span style="color:#b392f0">queryList</span><span style="color:#e1e4e8">(beanClass, sql, args);</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">    @</span><span style="color:#f97583">Override</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">public</span><span style="color:#e1e4e8"> &lt;</span><span style="color:#f97583">T</span><span style="color:#e1e4e8">&gt; T </span><span style="color:#b392f0">queryOne</span><span style="color:#e1e4e8">(Class&lt;</span><span style="color:#f97583">T</span><span style="color:#e1e4e8">&gt; </span><span style="color:#ffab70">beanClass</span><span style="color:#e1e4e8">, String </span><span style="color:#ffab70">sql</span><span style="color:#e1e4e8">, Object... </span><span style="color:#ffab70">args</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#6a737d">// ÂÖà‰ªéÁºìÂ≠ò‰∏≠ÊâæÔºåÊâæÂà∞Áõ¥Êé•ËøîÂõû</span></span>
<span class="line"><span style="color:#e1e4e8">        SqlPair key </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">SqlPair</span><span style="color:#e1e4e8">(sql, args);;</span></span>
<span class="line"><span style="color:#e1e4e8">        rw.</span><span style="color:#b392f0">readLock</span><span style="color:#e1e4e8">().</span><span style="color:#b392f0">lock</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">try</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">            T value </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> (T) map.</span><span style="color:#b392f0">get</span><span style="color:#e1e4e8">(key);</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">if</span><span style="color:#e1e4e8">(value </span><span style="color:#f97583">!=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> value;</span></span>
<span class="line"><span style="color:#e1e4e8">            }</span></span>
<span class="line"><span style="color:#e1e4e8">        } </span><span style="color:#f97583">finally</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">            rw.</span><span style="color:#b392f0">readLock</span><span style="color:#e1e4e8">().</span><span style="color:#b392f0">unlock</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">        }</span></span>
<span class="line"><span style="color:#e1e4e8">        rw.</span><span style="color:#b392f0">writeLock</span><span style="color:#e1e4e8">().</span><span style="color:#b392f0">lock</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">try</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#6a737d">// Â§ö‰∏™Á∫øÁ®ã</span></span>
<span class="line"><span style="color:#e1e4e8">            T value </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> (T) map.</span><span style="color:#b392f0">get</span><span style="color:#e1e4e8">(key);</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">if</span><span style="color:#e1e4e8">(value </span><span style="color:#f97583">==</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#6a737d">// ÁºìÂ≠ò‰∏≠Ê≤°ÊúâÔºåÊü•ËØ¢Êï∞ÊçÆÂ∫ì</span></span>
<span class="line"><span style="color:#e1e4e8">                value </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> dao.</span><span style="color:#b392f0">queryOne</span><span style="color:#e1e4e8">(beanClass, sql, args);</span></span>
<span class="line"><span style="color:#e1e4e8">                map.</span><span style="color:#b392f0">put</span><span style="color:#e1e4e8">(key, value);</span></span>
<span class="line"><span style="color:#e1e4e8">            }</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> value;</span></span>
<span class="line"><span style="color:#e1e4e8">        } </span><span style="color:#f97583">finally</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">            rw.</span><span style="color:#b392f0">writeLock</span><span style="color:#e1e4e8">().</span><span style="color:#b392f0">unlock</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">        }</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">    @</span><span style="color:#f97583">Override</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">update</span><span style="color:#e1e4e8">(String </span><span style="color:#ffab70">sql</span><span style="color:#e1e4e8">, Object... </span><span style="color:#ffab70">args</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">        rw.</span><span style="color:#b392f0">writeLock</span><span style="color:#e1e4e8">().</span><span style="color:#b392f0">lock</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">try</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#6a737d">// ÂÖàÊõ¥Êñ∞Â∫ì</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> update </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> dao.</span><span style="color:#b392f0">update</span><span style="color:#e1e4e8">(sql, args);</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#6a737d">// Ê∏ÖÁ©∫ÁºìÂ≠ò</span></span>
<span class="line"><span style="color:#e1e4e8">            map.</span><span style="color:#b392f0">clear</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> update;</span></span>
<span class="line"><span style="color:#e1e4e8">        } </span><span style="color:#f97583">finally</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">            rw.</span><span style="color:#b392f0">writeLock</span><span style="color:#e1e4e8">().</span><span style="color:#b392f0">unlock</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">        }</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">class</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">SqlPair</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">private</span><span style="color:#e1e4e8"> String sql;</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">private</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">Object</span><span style="color:#e1e4e8">[] args;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">SqlPair</span><span style="color:#e1e4e8">(String </span><span style="color:#ffab70">sql</span><span style="color:#e1e4e8">, </span><span style="color:#f97583">Object</span><span style="color:#e1e4e8">[] </span><span style="color:#ffab70">args</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#79b8ff">this</span><span style="color:#e1e4e8">.sql </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> sql;</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#79b8ff">this</span><span style="color:#e1e4e8">.args </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> args;</span></span>
<span class="line"><span style="color:#e1e4e8">        }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">        @</span><span style="color:#f97583">Override</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">boolean</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">equals</span><span style="color:#e1e4e8">(Object </span><span style="color:#ffab70">o</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (</span><span style="color:#79b8ff">this</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">==</span><span style="color:#e1e4e8"> o) {</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">true</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">            }</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (o </span><span style="color:#f97583">==</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">||</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">getClass</span><span style="color:#e1e4e8">() </span><span style="color:#f97583">!=</span><span style="color:#e1e4e8"> o.</span><span style="color:#b392f0">getClass</span><span style="color:#e1e4e8">()) {</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">false</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">            }</span></span>
<span class="line"><span style="color:#e1e4e8">            SqlPair sqlPair </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> (SqlPair) o;</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> Objects.</span><span style="color:#b392f0">equals</span><span style="color:#e1e4e8">(sql, sqlPair.sql) </span><span style="color:#f97583">&amp;&amp;</span></span>
<span class="line"><span style="color:#e1e4e8">                    Arrays.</span><span style="color:#b392f0">equals</span><span style="color:#e1e4e8">(args, sqlPair.args);</span></span>
<span class="line"><span style="color:#e1e4e8">        }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">        @</span><span style="color:#f97583">Override</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">hashCode</span><span style="color:#e1e4e8">() {</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> result </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> Objects.</span><span style="color:#b392f0">hash</span><span style="color:#e1e4e8">(sql);</span></span>
<span class="line"><span style="color:#e1e4e8">            result </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">31</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">*</span><span style="color:#e1e4e8"> result </span><span style="color:#f97583">+</span><span style="color:#e1e4e8"> Arrays.</span><span style="color:#b392f0">hashCode</span><span style="color:#e1e4e8">(args);</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> result;</span></span>
<span class="line"><span style="color:#e1e4e8">        }</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#d73a49">class</span><span style="color:#24292e"> </span><span style="color:#6f42c1">GenericDaoCached</span><span style="color:#24292e"> </span><span style="color:#d73a49">extends</span><span style="color:#24292e"> </span><span style="color:#6f42c1">GenericDao</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">private</span><span style="color:#24292e"> GenericDao dao </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">GenericDao</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">private</span><span style="color:#24292e"> Map&lt;</span><span style="color:#d73a49">SqlPair</span><span style="color:#24292e">, </span><span style="color:#d73a49">Object</span><span style="color:#24292e">&gt; map </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> HashMap&lt;&gt;();</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">private</span><span style="color:#24292e"> ReentrantReadWriteLock rw </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">ReentrantReadWriteLock</span><span style="color:#24292e">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">    @</span><span style="color:#d73a49">Override</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">public</span><span style="color:#24292e"> &lt;</span><span style="color:#d73a49">T</span><span style="color:#24292e">&gt; List&lt;</span><span style="color:#d73a49">T</span><span style="color:#24292e">&gt; </span><span style="color:#6f42c1">queryList</span><span style="color:#24292e">(Class&lt;</span><span style="color:#d73a49">T</span><span style="color:#24292e">&gt; </span><span style="color:#e36209">beanClass</span><span style="color:#24292e">, String </span><span style="color:#e36209">sql</span><span style="color:#24292e">, Object... </span><span style="color:#e36209">args</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">return</span><span style="color:#24292e"> dao.</span><span style="color:#6f42c1">queryList</span><span style="color:#24292e">(beanClass, sql, args);</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">    @</span><span style="color:#d73a49">Override</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">public</span><span style="color:#24292e"> &lt;</span><span style="color:#d73a49">T</span><span style="color:#24292e">&gt; T </span><span style="color:#6f42c1">queryOne</span><span style="color:#24292e">(Class&lt;</span><span style="color:#d73a49">T</span><span style="color:#24292e">&gt; </span><span style="color:#e36209">beanClass</span><span style="color:#24292e">, String </span><span style="color:#e36209">sql</span><span style="color:#24292e">, Object... </span><span style="color:#e36209">args</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6a737d">// ÂÖà‰ªéÁºìÂ≠ò‰∏≠ÊâæÔºåÊâæÂà∞Áõ¥Êé•ËøîÂõû</span></span>
<span class="line"><span style="color:#24292e">        SqlPair key </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">SqlPair</span><span style="color:#24292e">(sql, args);;</span></span>
<span class="line"><span style="color:#24292e">        rw.</span><span style="color:#6f42c1">readLock</span><span style="color:#24292e">().</span><span style="color:#6f42c1">lock</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">try</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">            T value </span><span style="color:#d73a49">=</span><span style="color:#24292e"> (T) map.</span><span style="color:#6f42c1">get</span><span style="color:#24292e">(key);</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">if</span><span style="color:#24292e">(value </span><span style="color:#d73a49">!=</span><span style="color:#24292e"> </span><span style="color:#005cc5">null</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#d73a49">return</span><span style="color:#24292e"> value;</span></span>
<span class="line"><span style="color:#24292e">            }</span></span>
<span class="line"><span style="color:#24292e">        } </span><span style="color:#d73a49">finally</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">            rw.</span><span style="color:#6f42c1">readLock</span><span style="color:#24292e">().</span><span style="color:#6f42c1">unlock</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">        }</span></span>
<span class="line"><span style="color:#24292e">        rw.</span><span style="color:#6f42c1">writeLock</span><span style="color:#24292e">().</span><span style="color:#6f42c1">lock</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">try</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#6a737d">// Â§ö‰∏™Á∫øÁ®ã</span></span>
<span class="line"><span style="color:#24292e">            T value </span><span style="color:#d73a49">=</span><span style="color:#24292e"> (T) map.</span><span style="color:#6f42c1">get</span><span style="color:#24292e">(key);</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">if</span><span style="color:#24292e">(value </span><span style="color:#d73a49">==</span><span style="color:#24292e"> </span><span style="color:#005cc5">null</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#6a737d">// ÁºìÂ≠ò‰∏≠Ê≤°ÊúâÔºåÊü•ËØ¢Êï∞ÊçÆÂ∫ì</span></span>
<span class="line"><span style="color:#24292e">                value </span><span style="color:#d73a49">=</span><span style="color:#24292e"> dao.</span><span style="color:#6f42c1">queryOne</span><span style="color:#24292e">(beanClass, sql, args);</span></span>
<span class="line"><span style="color:#24292e">                map.</span><span style="color:#6f42c1">put</span><span style="color:#24292e">(key, value);</span></span>
<span class="line"><span style="color:#24292e">            }</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">return</span><span style="color:#24292e"> value;</span></span>
<span class="line"><span style="color:#24292e">        } </span><span style="color:#d73a49">finally</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">            rw.</span><span style="color:#6f42c1">writeLock</span><span style="color:#24292e">().</span><span style="color:#6f42c1">unlock</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">        }</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">    @</span><span style="color:#d73a49">Override</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">int</span><span style="color:#24292e"> </span><span style="color:#6f42c1">update</span><span style="color:#24292e">(String </span><span style="color:#e36209">sql</span><span style="color:#24292e">, Object... </span><span style="color:#e36209">args</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">        rw.</span><span style="color:#6f42c1">writeLock</span><span style="color:#24292e">().</span><span style="color:#6f42c1">lock</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">try</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#6a737d">// ÂÖàÊõ¥Êñ∞Â∫ì</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">int</span><span style="color:#24292e"> update </span><span style="color:#d73a49">=</span><span style="color:#24292e"> dao.</span><span style="color:#6f42c1">update</span><span style="color:#24292e">(sql, args);</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#6a737d">// Ê∏ÖÁ©∫ÁºìÂ≠ò</span></span>
<span class="line"><span style="color:#24292e">            map.</span><span style="color:#6f42c1">clear</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">return</span><span style="color:#24292e"> update;</span></span>
<span class="line"><span style="color:#24292e">        } </span><span style="color:#d73a49">finally</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">            rw.</span><span style="color:#6f42c1">writeLock</span><span style="color:#24292e">().</span><span style="color:#6f42c1">unlock</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">        }</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">class</span><span style="color:#24292e"> </span><span style="color:#6f42c1">SqlPair</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">private</span><span style="color:#24292e"> String sql;</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">private</span><span style="color:#24292e"> </span><span style="color:#d73a49">Object</span><span style="color:#24292e">[] args;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#6f42c1">SqlPair</span><span style="color:#24292e">(String </span><span style="color:#e36209">sql</span><span style="color:#24292e">, </span><span style="color:#d73a49">Object</span><span style="color:#24292e">[] </span><span style="color:#e36209">args</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#005cc5">this</span><span style="color:#24292e">.sql </span><span style="color:#d73a49">=</span><span style="color:#24292e"> sql;</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#005cc5">this</span><span style="color:#24292e">.args </span><span style="color:#d73a49">=</span><span style="color:#24292e"> args;</span></span>
<span class="line"><span style="color:#24292e">        }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">        @</span><span style="color:#d73a49">Override</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">boolean</span><span style="color:#24292e"> </span><span style="color:#6f42c1">equals</span><span style="color:#24292e">(Object </span><span style="color:#e36209">o</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (</span><span style="color:#005cc5">this</span><span style="color:#24292e"> </span><span style="color:#d73a49">==</span><span style="color:#24292e"> o) {</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#d73a49">return</span><span style="color:#24292e"> </span><span style="color:#005cc5">true</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">            }</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (o </span><span style="color:#d73a49">==</span><span style="color:#24292e"> </span><span style="color:#005cc5">null</span><span style="color:#24292e"> </span><span style="color:#d73a49">||</span><span style="color:#24292e"> </span><span style="color:#6f42c1">getClass</span><span style="color:#24292e">() </span><span style="color:#d73a49">!=</span><span style="color:#24292e"> o.</span><span style="color:#6f42c1">getClass</span><span style="color:#24292e">()) {</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#d73a49">return</span><span style="color:#24292e"> </span><span style="color:#005cc5">false</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">            }</span></span>
<span class="line"><span style="color:#24292e">            SqlPair sqlPair </span><span style="color:#d73a49">=</span><span style="color:#24292e"> (SqlPair) o;</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">return</span><span style="color:#24292e"> Objects.</span><span style="color:#6f42c1">equals</span><span style="color:#24292e">(sql, sqlPair.sql) </span><span style="color:#d73a49">&amp;&amp;</span></span>
<span class="line"><span style="color:#24292e">                    Arrays.</span><span style="color:#6f42c1">equals</span><span style="color:#24292e">(args, sqlPair.args);</span></span>
<span class="line"><span style="color:#24292e">        }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">        @</span><span style="color:#d73a49">Override</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">int</span><span style="color:#24292e"> </span><span style="color:#6f42c1">hashCode</span><span style="color:#24292e">() {</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">int</span><span style="color:#24292e"> result </span><span style="color:#d73a49">=</span><span style="color:#24292e"> Objects.</span><span style="color:#6f42c1">hash</span><span style="color:#24292e">(sql);</span></span>
<span class="line"><span style="color:#24292e">            result </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#005cc5">31</span><span style="color:#24292e"> </span><span style="color:#d73a49">*</span><span style="color:#24292e"> result </span><span style="color:#d73a49">+</span><span style="color:#24292e"> Arrays.</span><span style="color:#6f42c1">hashCode</span><span style="color:#24292e">(args);</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">return</span><span style="color:#24292e"> result;</span></span>
<span class="line"><span style="color:#24292e">        }</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">}</span></span></code></pre></div><blockquote><p>Ê≥®ÊÑè</p><ul><li>‰ª•‰∏äÂÆûÁé∞‰ΩìÁé∞ÁöÑÊòØËØªÂÜôÈîÅÁöÑÂ∫îÁî®Ôºå‰øùËØÅÁºìÂ≠òÂíåÊï∞ÊçÆÂ∫ìÁöÑ‰∏ÄËá¥ÊÄßÔºå‰ΩÜÊúâ‰∏ãÈù¢ÁöÑÈóÆÈ¢òÊ≤°ÊúâËÄÉËôë<ul><li>ÈÄÇÂêàËØªÂ§öÂÜôÂ∞ëÔºåÂ¶ÇÊûúÂÜôÊìç‰ΩúÊØîËæÉÈ¢ëÁπÅÔºå‰ª•‰∏äÂÆûÁé∞ÊÄßËÉΩ‰Ωé</li><li>Ê≤°ÊúâËÄÉËôëÁºìÂ≠òÂÆπÈáè</li><li>Ê≤°ÊúâËÄÉËôëÁºìÂ≠òËøáÊúü</li><li>Âè™ÈÄÇÂêàÂçïÊú∫</li><li>Âπ∂ÂèëÊÄßËøòÊòØ‰ΩéÔºåÁõÆÂâçÂè™‰ºöÁî®‰∏ÄÊääÈîÅ</li><li>Êõ¥Êñ∞ÊñπÊ≥ïÂ§™ËøáÁÆÄÂçïÁ≤óÊö¥ÔºåÊ∏ÖÁ©∫‰∫ÜÊâÄÊúâ keyÔºàËÄÉËôëÊåâÁ±ªÂûãÂàÜÂå∫ÊàñÈáçÊñ∞ËÆæËÆ° keyÔºâ</li><li>‰πêËßÇÈîÅÂÆûÁé∞ÔºöÁî® CAS ÂéªÊõ¥Êñ∞</li></ul></li></ul></blockquote><h4 id="ËØªÂÜôÈîÅÂéüÁêÜ" tabindex="-1">ËØªÂÜôÈîÅÂéüÁêÜ <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20advanced%20chapter#ËØªÂÜôÈîÅÂéüÁêÜ" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h4><h5 id="ÂõæËß£ÊµÅÁ®ã" tabindex="-1">ÂõæËß£ÊµÅÁ®ã <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20advanced%20chapter#ÂõæËß£ÊµÅÁ®ã" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h5><p>ËØªÂÜôÈîÅÁî®ÁöÑÊòØÂêå‰∏Ä‰∏™ Sycn ÂêåÊ≠•Âô®ÔºåÂõ†Ê≠§Á≠âÂæÖÈòüÂàó„ÄÅstate Á≠â‰πüÊòØÂêå‰∏Ä‰∏™</p><h6 id="t1-w-lock-t2-r-lock" tabindex="-1">t1 w.lockÔºåt2 r.lock <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20advanced%20chapter#t1-w-lock-t2-r-lock" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h6><p>1Ôºâ t1 ÊàêÂäü‰∏äÈîÅÔºåÊµÅÁ®ã‰∏é ReentrantLock Âä†ÈîÅÁõ∏ÊØîÊ≤°ÊúâÁâπÊÆä‰πãÂ§ÑÔºå‰∏çÂêåÊòØÂÜôÈîÅÁä∂ÊÄÅÂç†‰∫Ü state ÁöÑ‰Ωé 16 ‰ΩçÔºåËÄåËØªÈîÅ ‰ΩøÁî®ÁöÑÊòØ state ÁöÑÈ´ò 16 ‰Ωç</p><figure><img src="https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230719182530369.png" alt="image-20230719182530369" loading="lazy" decoding="async"></figure><p>2Ôºât2 ÊâßË°å r.lockÔºåËøôÊó∂ËøõÂÖ•ËØªÈîÅÁöÑ sync.acquireShared(1) ÊµÅÁ®ãÔºåÈ¶ñÂÖà‰ºöËøõÂÖ• tryAcquireShared ÊµÅÁ®ã„ÄÇÂ¶ÇÊûúÊúâÂÜô ÈîÅÂç†ÊçÆÔºåÈÇ£‰πà tryAcquireShared ËøîÂõû -1 Ë°®Á§∫Â§±Ë¥•</p><blockquote><p>tryAcquireShared ËøîÂõûÂÄºË°®Á§∫</p><ol><li>-1 Ë°®Á§∫Â§±Ë¥•</li><li>0 Ë°®Á§∫ÊàêÂäüÔºå‰ΩÜÂêéÁªßËäÇÁÇπ‰∏ç‰ºöÁªßÁª≠Âî§ÈÜí</li><li>Ê≠£Êï∞Ë°®Á§∫ÊàêÂäüÔºåËÄå‰∏îÊï∞ÂÄºÊòØËøòÊúâÂá†‰∏™ÂêéÁªßËäÇÁÇπÈúÄË¶ÅÂî§ÈÜíÔºåÊàë‰ª¨ËøôÈáåÁöÑËØªÂÜôÈîÅËøîÂõû 1</li></ol></blockquote><figure><img src="https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230719190455870.png" alt="image-20230719190455870" loading="lazy" decoding="async"></figure><p>3ÔºâËøôÊó∂‰ºöËøõÂÖ• <code>sync.doAcquireShared(1)</code> ÊµÅÁ®ãÔºåÈ¶ñÂÖà‰πüÊòØË∞ÉÁî® addWaiter Ê∑ªÂä†ËäÇÁÇπÔºå‰∏çÂêå‰πãÂ§ÑÂú®‰∫éËäÇÁÇπË¢´ËÆæÁΩÆ‰∏∫<code>Node.SHARED</code> Ê®°ÂºèËÄåÈùû <code>Node.EXCLUSIVE</code> Ê®°ÂºèÔºåÊ≥®ÊÑèÊ≠§Êó∂ t2 ‰ªçÂ§Ñ‰∫éÊ¥ªË∑ÉÁä∂ÊÄÅ</p><figure><img src="https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230719190601118.png" alt="image-20230719190601118" loading="lazy" decoding="async"></figure><p>4Ôºât2 ‰ºöÁúãÁúãËá™Â∑±ÁöÑËäÇÁÇπÊòØ‰∏çÊòØËÄÅ‰∫åÔºåÂ¶ÇÊûúÊòØÔºåËøò‰ºöÂÜçÊ¨°Ë∞ÉÁî® tryAcquireShared(1) Êù•Â∞ùËØïËé∑ÂèñÈîÅ</p><p>5ÔºâÂ¶ÇÊûúÊ≤°ÊúâÊàêÂäüÔºåÂú® doAcquireShared ÂÜÖ <code>for (;;)</code> Âæ™ÁéØ‰∏ÄÊ¨°ÔºåÊääÂâçÈ©±ËäÇÁÇπÁöÑ waitStatus Êîπ‰∏∫ -1ÔºåÂÜç <code>for (;;)</code> Âæ™ÁéØ‰∏Ä Ê¨°Â∞ùËØï tryAcquireShared(1) Â¶ÇÊûúËøò‰∏çÊàêÂäüÔºåÈÇ£‰πàÂú® parkAndCheckInterrupt() Â§Ñ park</p><figure><img src="https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230719190714986.png" alt="image-20230719190714986" loading="lazy" decoding="async"></figure><h6 id="t3-r-lock-t4-w-lock" tabindex="-1">t3 r.lockÔºåt4 w.lock <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20advanced%20chapter#t3-r-lock-t4-w-lock" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h6><p>ËøôÁßçÁä∂ÊÄÅ‰∏ãÔºåÂÅáËÆæÂèàÊúâ t3 Âä†ËØªÈîÅÂíå t4 Âä†ÂÜôÈîÅÔºåËøôÊúüÈó¥ t1 ‰ªçÁÑ∂ÊåÅÊúâÈîÅÔºåÂ∞±ÂèòÊàê‰∫Ü‰∏ãÈù¢ÁöÑÊ†∑Â≠ê</p><figure><img src="https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230719192612370.png" alt="image-20230719192612370" loading="lazy" decoding="async"></figure><h6 id="t1-w-unlock" tabindex="-1">t1 w.unlock <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20advanced%20chapter#t1-w-unlock" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h6><p>ËøôÊó∂‰ºöËµ∞Âà∞ÂÜôÈîÅÁöÑ sync.release(1) ÊµÅÁ®ãÔºåË∞ÉÁî® sync.tryRelease(1) ÊàêÂäüÔºåstateÂèò‰∏∫0ÔºåÂèòÊàê‰∏ãÈù¢ÁöÑÊ†∑Â≠ê</p><figure><img src="https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230719192633075.png" alt="image-20230719192633075" loading="lazy" decoding="async"></figure><p>Êé•‰∏ãÊù•ÊâßË°åÂî§ÈÜíÊµÅÁ®ã sync.unparkSuccessorÔºåÂç≥ËÆ©ËÄÅ‰∫åÊÅ¢Â§çËøêË°åÔºåËøôÊó∂ t2 Âú® doAcquireShared ÂÜÖ parkAndCheckInterrupt() Â§ÑÊÅ¢Â§çËøêË°å</p><p>ËøôÂõûÂÜçÊù•‰∏ÄÊ¨° <code>for (;;)</code> ÊâßË°å tryAcquireShared ÊàêÂäüÂàôËÆ©ËØªÈîÅËÆ°Êï∞Âä†‰∏ÄÔºåstateÂèò‰∏∫1</p><figure><img src="https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230719192723097.png" alt="image-20230719192723097" loading="lazy" decoding="async"></figure><p>ËøôÊó∂ t2 Â∑≤ÁªèÊÅ¢Â§çËøêË°åÔºåÊé•‰∏ãÊù• t2 Ë∞ÉÁî® setHeadAndPropagate(node, 1)ÔºåÂÆÉÂéüÊú¨ÊâÄÂú®ËäÇÁÇπË¢´ÁΩÆ‰∏∫Â§¥ËäÇÁÇπ</p><figure><img src="https://jsd.cdn.zzko.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230719192739754.png" alt="image-20230719192739754" loading="lazy" decoding="async"></figure><p>‰∫ãÊÉÖËøòÊ≤°ÂÆåÔºåÂú® setHeadAndPropagate ÊñπÊ≥ïÂÜÖËøò‰ºöÊ£ÄÊü•‰∏ã‰∏Ä‰∏™ËäÇÁÇπÊòØÂê¶ÊòØ sharedÔºåÂ¶ÇÊûúÊòØÂàôË∞ÉÁî®doReleaseShared() Â∞Ü head ÁöÑÁä∂ÊÄÅ‰ªé -1 Êîπ‰∏∫ 0 ÔºàCASÔºâÂπ∂Âî§ÈÜíËÄÅ‰∫åÔºåËøôÊó∂ t3 Âú® doAcquireShared ÂÜÖparkAndCheckInterrupt() Â§ÑÊÅ¢Â§çËøêË°å</p><figure><img src="https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230719192804690.png" alt="image-20230719192804690" loading="lazy" decoding="async"></figure><p>ËøôÂõûÂÜçÊù•‰∏ÄÊ¨° <code>for (;;)</code> ÊâßË°å tryAcquireShared ÊàêÂäüÂàôËÆ©ËØªÈîÅËÆ°Êï∞Âä†‰∏ÄÔºåstateÂèò‰∏∫2ÔºàÂÖ±‰∫´ËØªÈîÅÔºöÂ§ö‰∏™Á∫øÁ®ãÈÉΩÂèØ‰ª•‰øÆÊîπstateÔºâ</p><figure><img src="https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230719192823603.png" alt="image-20230719192823603" loading="lazy" decoding="async"></figure><p>ËøôÊó∂ t3 Â∑≤ÁªèÊÅ¢Â§çËøêË°åÔºåÊé•‰∏ãÊù• t3 Ë∞ÉÁî® setHeadAndPropagate(node, 1)ÔºåÂÆÉÂéüÊú¨ÊâÄÂú®ËäÇÁÇπË¢´ÁΩÆ‰∏∫Â§¥ËäÇÁÇπ</p><figure><img src="https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230719192838777.png" alt="image-20230719192838777" loading="lazy" decoding="async"></figure><p>‰∏ã‰∏Ä‰∏™ËäÇÁÇπ‰∏çÊòØ shared ‰∫ÜÔºåÂõ†Ê≠§‰∏ç‰ºöÁªßÁª≠Âî§ÈÜí t4 ÊâÄÂú®ËäÇÁÇπÔºàËØª-ËØªÂèØ‰ª•Âπ∂ÂèëÔºåÁõ¥Âà∞ÈÅáÂà∞Áã¨Âç†ËäÇÁÇπÊâçÂÅúÊ≠¢Ôºâ</p><h6 id="t2-r-unlock-t3-r-unlock" tabindex="-1">t2 r.unlockÔºåt3 r.unlock <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20advanced%20chapter#t2-r-unlock-t3-r-unlock" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h6><p>t2 ËøõÂÖ• sync.releaseShared(1) ‰∏≠ÔºåË∞ÉÁî® tryReleaseShared(1) ËÆ©ËÆ°Êï∞Âáè‰∏ÄÔºå‰ΩÜÁî±‰∫éËÆ°Êï∞Ëøò‰∏ç‰∏∫Èõ∂</p><figure><img src="https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230719192903709.png" alt="image-20230719192903709" loading="lazy" decoding="async"></figure><p>t3 ËøõÂÖ• sync.releaseShared(1) ‰∏≠ÔºåË∞ÉÁî® tryReleaseShared(1) ËÆ©ËÆ°Êï∞Âáè‰∏ÄÔºåËøôÂõûËÆ°Êï∞‰∏∫Èõ∂‰∫ÜÔºåËøõÂÖ• doReleaseShared() Â∞ÜÂ§¥ËäÇÁÇπ‰ªé -1 Êîπ‰∏∫ 0 Âπ∂Âî§ÈÜíËÄÅ‰∫åÔºåÂç≥</p><figure><img src="https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230719192920793.png" alt="image-20230719192920793" loading="lazy" decoding="async"></figure><p>‰πãÂêé t4 Âú® acquireQueued ‰∏≠ parkAndCheckInterrupt Â§ÑÊÅ¢Â§çËøêË°åÔºåÂÜçÊ¨° <code>for (;;)</code> ËøôÊ¨°Ëá™Â∑±ÊòØËÄÅ‰∫åÔºåÂπ∂‰∏îÊ≤°ÊúâÂÖ∂‰ªñ Á´û‰∫âÔºåtryAcquire(1) ÊàêÂäüÔºå‰øÆÊîπÂ§¥ÁªìÁÇπÔºåÊµÅÁ®ãÁªìÊùü</p><figure><img src="https://jsd.cdn.zzko.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230719192934634.png" alt="image-20230719192934634" loading="lazy" decoding="async"></figure><h5 id="Ê∫êÁ†ÅÂàÜÊûê-1" tabindex="-1">Ê∫êÁ†ÅÂàÜÊûê <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20advanced%20chapter#Ê∫êÁ†ÅÂàÜÊûê-1" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h5><h6 id="ÂÜôÈîÅ‰∏äÈîÅÊµÅÁ®ã" tabindex="-1">ÂÜôÈîÅ‰∏äÈîÅÊµÅÁ®ã <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20advanced%20chapter#ÂÜôÈîÅ‰∏äÈîÅÊµÅÁ®ã" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h6><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#f97583">static</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">final</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">class</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">NonfairSync</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">extends</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Sync</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">// ... ÁúÅÁï•Êó†ÂÖ≥‰ª£Á†Å</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">// Â§ñÈÉ®Á±ª WriteLock ÊñπÊ≥ï, Êñπ‰æøÈòÖËØª, ÊîæÂú®Ê≠§Â§Ñ</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">void</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">lock</span><span style="color:#e1e4e8">() {</span></span>
<span class="line"><span style="color:#e1e4e8">        sync.</span><span style="color:#b392f0">acquire</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">1</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">// AQS ÁªßÊâøËøáÊù•ÁöÑÊñπÊ≥ï, Êñπ‰æøÈòÖËØª, ÊîæÂú®Ê≠§Â§Ñ</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">final</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">void</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">acquire</span><span style="color:#e1e4e8">(</span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> </span><span style="color:#ffab70">arg</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#6a737d">// Â∞ùËØïËé∑ÂæóÂÜôÈîÅÂ§±Ë¥•</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#f97583">!</span><span style="color:#b392f0">tryAcquire</span><span style="color:#e1e4e8">(arg) </span><span style="color:#f97583">&amp;&amp;</span></span>
<span class="line"><span style="color:#e1e4e8">                        </span><span style="color:#6a737d">// Â∞ÜÂΩìÂâçÁ∫øÁ®ãÂÖ≥ËÅîÂà∞‰∏Ä‰∏™ Node ÂØπË±°‰∏ä, Ê®°Âºè‰∏∫Áã¨Âç†Ê®°Âºè</span></span>
<span class="line"><span style="color:#e1e4e8">                        </span><span style="color:#6a737d">// ËøõÂÖ• AQS ÈòüÂàóÈòªÂ°û</span></span>
<span class="line"><span style="color:#e1e4e8">                        </span><span style="color:#b392f0">acquireQueued</span><span style="color:#e1e4e8">(</span><span style="color:#b392f0">addWaiter</span><span style="color:#e1e4e8">(Node.EXCLUSIVE), arg)</span></span>
<span class="line"><span style="color:#e1e4e8">        ) {</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#b392f0">selfInterrupt</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">        }</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">// Sync ÁªßÊâøËøáÊù•ÁöÑÊñπÊ≥ï, Êñπ‰æøÈòÖËØª, ÊîæÂú®Ê≠§Â§Ñ</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">protected</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">final</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">boolean</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">tryAcquire</span><span style="color:#e1e4e8">(</span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> </span><span style="color:#ffab70">acquires</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#6a737d">// Ëé∑Âæó‰Ωé 16 ‰Ωç, ‰ª£Ë°®ÂÜôÈîÅÁöÑ state ËÆ°Êï∞</span></span>
<span class="line"><span style="color:#e1e4e8">        Thread current </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> Thread.</span><span style="color:#b392f0">currentThread</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> c </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">getState</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> w </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">exclusiveCount</span><span style="color:#e1e4e8">(c);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (c </span><span style="color:#f97583">!=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#6a737d">// c != 0 and w == 0 Ë°®Á§∫ÊúâËØªÈîÅËøîÂõûÈîôËØØÔºåËØªÈîÅ‰∏çÊîØÊåÅÈîÅÂçáÁ∫ß, ÊàñËÄÖ</span></span>
<span class="line"><span style="color:#e1e4e8">                    w </span><span style="color:#f97583">==</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">||</span></span>
<span class="line"><span style="color:#e1e4e8">                            </span><span style="color:#6a737d">// c != 0 and w == 0 Ë°®Á§∫ÊúâÂÜôÔºåÂ¶ÇÊûú exclusiveOwnerThread ‰∏çÊòØËá™Â∑±</span></span>
<span class="line"><span style="color:#e1e4e8">                            current </span><span style="color:#f97583">!=</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">getExclusiveOwnerThread</span><span style="color:#e1e4e8">()</span></span>
<span class="line"><span style="color:#e1e4e8">            ) {</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#6a737d">// Ëé∑ÂæóÈîÅÂ§±Ë¥•</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">false</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">            }</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#6a737d">// ÂÜôÈîÅËÆ°Êï∞Ë∂ÖËøá‰Ωé 16 ‰Ωç, Êä•ÂºÇÂ∏∏</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (w </span><span style="color:#f97583">+</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">exclusiveCount</span><span style="color:#e1e4e8">(acquires) </span><span style="color:#f97583">&gt;</span><span style="color:#e1e4e8"> MAX_COUNT)</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#f97583">throw</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Error</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"Maximum lock count exceeded"</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#6a737d">// ÂÜôÈîÅÈáçÂÖ•, Ëé∑ÂæóÈîÅÊàêÂäü</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#b392f0">setState</span><span style="color:#e1e4e8">(c </span><span style="color:#f97583">+</span><span style="color:#e1e4e8"> acquires);</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">true</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">        }</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#6a737d">// Âà§Êñ≠ÂÜôÈîÅÊòØÂê¶ËØ•ÈòªÂ°ûËøôÈáåËøîÂõûfalse, ÊàñËÄÖ</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#b392f0">writerShouldBlock</span><span style="color:#e1e4e8">() </span><span style="color:#f97583">||</span></span>
<span class="line"><span style="color:#e1e4e8">                        </span><span style="color:#6a737d">// Â∞ùËØïÊõ¥ÊîπËÆ°Êï∞Â§±Ë¥•</span></span>
<span class="line"><span style="color:#e1e4e8">                        </span><span style="color:#f97583">!</span><span style="color:#b392f0">compareAndSetState</span><span style="color:#e1e4e8">(c, c </span><span style="color:#f97583">+</span><span style="color:#e1e4e8"> acquires)</span></span>
<span class="line"><span style="color:#e1e4e8">        ) {</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#6a737d">// Ëé∑ÂæóÈîÅÂ§±Ë¥•</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">false</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">        }</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#6a737d">// Ëé∑ÂæóÈîÅÊàêÂäü</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#b392f0">setExclusiveOwnerThread</span><span style="color:#e1e4e8">(current);</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">true</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">// ÈùûÂÖ¨Âπ≥ÈîÅ writerShouldBlock ÊÄªÊòØËøîÂõû false, Êó†ÈúÄÈòªÂ°û</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">final</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">boolean</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">writerShouldBlock</span><span style="color:#e1e4e8">() {</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">false</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"><span style="color:#e1e4e8">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#d73a49">static</span><span style="color:#24292e"> </span><span style="color:#d73a49">final</span><span style="color:#24292e"> </span><span style="color:#d73a49">class</span><span style="color:#24292e"> </span><span style="color:#6f42c1">NonfairSync</span><span style="color:#24292e"> </span><span style="color:#d73a49">extends</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Sync</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">// ... ÁúÅÁï•Êó†ÂÖ≥‰ª£Á†Å</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">// Â§ñÈÉ®Á±ª WriteLock ÊñπÊ≥ï, Êñπ‰æøÈòÖËØª, ÊîæÂú®Ê≠§Â§Ñ</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">void</span><span style="color:#24292e"> </span><span style="color:#6f42c1">lock</span><span style="color:#24292e">() {</span></span>
<span class="line"><span style="color:#24292e">        sync.</span><span style="color:#6f42c1">acquire</span><span style="color:#24292e">(</span><span style="color:#005cc5">1</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">// AQS ÁªßÊâøËøáÊù•ÁöÑÊñπÊ≥ï, Êñπ‰æøÈòÖËØª, ÊîæÂú®Ê≠§Â§Ñ</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">final</span><span style="color:#24292e"> </span><span style="color:#d73a49">void</span><span style="color:#24292e"> </span><span style="color:#6f42c1">acquire</span><span style="color:#24292e">(</span><span style="color:#d73a49">int</span><span style="color:#24292e"> </span><span style="color:#e36209">arg</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#6a737d">// Â∞ùËØïËé∑ÂæóÂÜôÈîÅÂ§±Ë¥•</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#d73a49">!</span><span style="color:#6f42c1">tryAcquire</span><span style="color:#24292e">(arg) </span><span style="color:#d73a49">&amp;&amp;</span></span>
<span class="line"><span style="color:#24292e">                        </span><span style="color:#6a737d">// Â∞ÜÂΩìÂâçÁ∫øÁ®ãÂÖ≥ËÅîÂà∞‰∏Ä‰∏™ Node ÂØπË±°‰∏ä, Ê®°Âºè‰∏∫Áã¨Âç†Ê®°Âºè</span></span>
<span class="line"><span style="color:#24292e">                        </span><span style="color:#6a737d">// ËøõÂÖ• AQS ÈòüÂàóÈòªÂ°û</span></span>
<span class="line"><span style="color:#24292e">                        </span><span style="color:#6f42c1">acquireQueued</span><span style="color:#24292e">(</span><span style="color:#6f42c1">addWaiter</span><span style="color:#24292e">(Node.EXCLUSIVE), arg)</span></span>
<span class="line"><span style="color:#24292e">        ) {</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#6f42c1">selfInterrupt</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">        }</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">// Sync ÁªßÊâøËøáÊù•ÁöÑÊñπÊ≥ï, Êñπ‰æøÈòÖËØª, ÊîæÂú®Ê≠§Â§Ñ</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">protected</span><span style="color:#24292e"> </span><span style="color:#d73a49">final</span><span style="color:#24292e"> </span><span style="color:#d73a49">boolean</span><span style="color:#24292e"> </span><span style="color:#6f42c1">tryAcquire</span><span style="color:#24292e">(</span><span style="color:#d73a49">int</span><span style="color:#24292e"> </span><span style="color:#e36209">acquires</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6a737d">// Ëé∑Âæó‰Ωé 16 ‰Ωç, ‰ª£Ë°®ÂÜôÈîÅÁöÑ state ËÆ°Êï∞</span></span>
<span class="line"><span style="color:#24292e">        Thread current </span><span style="color:#d73a49">=</span><span style="color:#24292e"> Thread.</span><span style="color:#6f42c1">currentThread</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">int</span><span style="color:#24292e"> c </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#6f42c1">getState</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">int</span><span style="color:#24292e"> w </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#6f42c1">exclusiveCount</span><span style="color:#24292e">(c);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (c </span><span style="color:#d73a49">!=</span><span style="color:#24292e"> </span><span style="color:#005cc5">0</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#6a737d">// c != 0 and w == 0 Ë°®Á§∫ÊúâËØªÈîÅËøîÂõûÈîôËØØÔºåËØªÈîÅ‰∏çÊîØÊåÅÈîÅÂçáÁ∫ß, ÊàñËÄÖ</span></span>
<span class="line"><span style="color:#24292e">                    w </span><span style="color:#d73a49">==</span><span style="color:#24292e"> </span><span style="color:#005cc5">0</span><span style="color:#24292e"> </span><span style="color:#d73a49">||</span></span>
<span class="line"><span style="color:#24292e">                            </span><span style="color:#6a737d">// c != 0 and w == 0 Ë°®Á§∫ÊúâÂÜôÔºåÂ¶ÇÊûú exclusiveOwnerThread ‰∏çÊòØËá™Â∑±</span></span>
<span class="line"><span style="color:#24292e">                            current </span><span style="color:#d73a49">!=</span><span style="color:#24292e"> </span><span style="color:#6f42c1">getExclusiveOwnerThread</span><span style="color:#24292e">()</span></span>
<span class="line"><span style="color:#24292e">            ) {</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#6a737d">// Ëé∑ÂæóÈîÅÂ§±Ë¥•</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#d73a49">return</span><span style="color:#24292e"> </span><span style="color:#005cc5">false</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">            }</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#6a737d">// ÂÜôÈîÅËÆ°Êï∞Ë∂ÖËøá‰Ωé 16 ‰Ωç, Êä•ÂºÇÂ∏∏</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (w </span><span style="color:#d73a49">+</span><span style="color:#24292e"> </span><span style="color:#6f42c1">exclusiveCount</span><span style="color:#24292e">(acquires) </span><span style="color:#d73a49">&gt;</span><span style="color:#24292e"> MAX_COUNT)</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#d73a49">throw</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Error</span><span style="color:#24292e">(</span><span style="color:#032f62">"Maximum lock count exceeded"</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#6a737d">// ÂÜôÈîÅÈáçÂÖ•, Ëé∑ÂæóÈîÅÊàêÂäü</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#6f42c1">setState</span><span style="color:#24292e">(c </span><span style="color:#d73a49">+</span><span style="color:#24292e"> acquires);</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">return</span><span style="color:#24292e"> </span><span style="color:#005cc5">true</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">        }</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#6a737d">// Âà§Êñ≠ÂÜôÈîÅÊòØÂê¶ËØ•ÈòªÂ°ûËøôÈáåËøîÂõûfalse, ÊàñËÄÖ</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#6f42c1">writerShouldBlock</span><span style="color:#24292e">() </span><span style="color:#d73a49">||</span></span>
<span class="line"><span style="color:#24292e">                        </span><span style="color:#6a737d">// Â∞ùËØïÊõ¥ÊîπËÆ°Êï∞Â§±Ë¥•</span></span>
<span class="line"><span style="color:#24292e">                        </span><span style="color:#d73a49">!</span><span style="color:#6f42c1">compareAndSetState</span><span style="color:#24292e">(c, c </span><span style="color:#d73a49">+</span><span style="color:#24292e"> acquires)</span></span>
<span class="line"><span style="color:#24292e">        ) {</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#6a737d">// Ëé∑ÂæóÈîÅÂ§±Ë¥•</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">return</span><span style="color:#24292e"> </span><span style="color:#005cc5">false</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">        }</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6a737d">// Ëé∑ÂæóÈîÅÊàêÂäü</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6f42c1">setExclusiveOwnerThread</span><span style="color:#24292e">(current);</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">return</span><span style="color:#24292e"> </span><span style="color:#005cc5">true</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">// ÈùûÂÖ¨Âπ≥ÈîÅ writerShouldBlock ÊÄªÊòØËøîÂõû false, Êó†ÈúÄÈòªÂ°û</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">final</span><span style="color:#24292e"> </span><span style="color:#d73a49">boolean</span><span style="color:#24292e"> </span><span style="color:#6f42c1">writerShouldBlock</span><span style="color:#24292e">() {</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">return</span><span style="color:#24292e"> </span><span style="color:#005cc5">false</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"><span style="color:#24292e">}</span></span></code></pre></div><h6 id="ÂÜôÈîÅÈáäÊîæÊµÅÁ®ã" tabindex="-1">ÂÜôÈîÅÈáäÊîæÊµÅÁ®ã <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20advanced%20chapter#ÂÜôÈîÅÈáäÊîæÊµÅÁ®ã" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h6><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#f97583">static</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">final</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">class</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">NonfairSync</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">extends</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Sync</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">// ... ÁúÅÁï•Êó†ÂÖ≥‰ª£Á†Å</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">// WriteLock ÊñπÊ≥ï, Êñπ‰æøÈòÖËØª, ÊîæÂú®Ê≠§Â§Ñ</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">void</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">unlock</span><span style="color:#e1e4e8">() {</span></span>
<span class="line"><span style="color:#e1e4e8">        sync.</span><span style="color:#b392f0">release</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">1</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">// AQS ÁªßÊâøËøáÊù•ÁöÑÊñπÊ≥ï, Êñπ‰æøÈòÖËØª, ÊîæÂú®Ê≠§Â§Ñ</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">final</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">boolean</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">release</span><span style="color:#e1e4e8">(</span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> </span><span style="color:#ffab70">arg</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#6a737d">// Â∞ùËØïÈáäÊîæÂÜôÈîÅÊàêÂäü</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (</span><span style="color:#b392f0">tryRelease</span><span style="color:#e1e4e8">(arg)) {</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#6a737d">// unpark AQS ‰∏≠Á≠âÂæÖÁöÑÁ∫øÁ®ã</span></span>
<span class="line"><span style="color:#e1e4e8">            Node h </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> head;</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (h </span><span style="color:#f97583">!=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">&amp;&amp;</span><span style="color:#e1e4e8"> h.waitStatus </span><span style="color:#f97583">!=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8">)</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#b392f0">unparkSuccessor</span><span style="color:#e1e4e8">(h);</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">true</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">        }</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">false</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">// Sync ÁªßÊâøËøáÊù•ÁöÑÊñπÊ≥ï, Êñπ‰æøÈòÖËØª, ÊîæÂú®Ê≠§Â§Ñ</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">protected</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">final</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">boolean</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">tryRelease</span><span style="color:#e1e4e8">(</span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> </span><span style="color:#ffab70">releases</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (</span><span style="color:#f97583">!</span><span style="color:#b392f0">isHeldExclusively</span><span style="color:#e1e4e8">())</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">throw</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">IllegalMonitorStateException</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> nextc </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">getState</span><span style="color:#e1e4e8">() </span><span style="color:#f97583">-</span><span style="color:#e1e4e8"> releases;</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#6a737d">// Âõ†‰∏∫ÂèØÈáçÂÖ•ÁöÑÂéüÂõ†, ÂÜôÈîÅËÆ°Êï∞‰∏∫ 0, ÊâçÁÆóÈáäÊîæÊàêÂäü</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">boolean</span><span style="color:#e1e4e8"> free </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">exclusiveCount</span><span style="color:#e1e4e8">(nextc) </span><span style="color:#f97583">==</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (free) {</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#b392f0">setExclusiveOwnerThread</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">        }</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#b392f0">setState</span><span style="color:#e1e4e8">(nextc);</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> free;</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"><span style="color:#e1e4e8">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#d73a49">static</span><span style="color:#24292e"> </span><span style="color:#d73a49">final</span><span style="color:#24292e"> </span><span style="color:#d73a49">class</span><span style="color:#24292e"> </span><span style="color:#6f42c1">NonfairSync</span><span style="color:#24292e"> </span><span style="color:#d73a49">extends</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Sync</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">// ... ÁúÅÁï•Êó†ÂÖ≥‰ª£Á†Å</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">// WriteLock ÊñπÊ≥ï, Êñπ‰æøÈòÖËØª, ÊîæÂú®Ê≠§Â§Ñ</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">void</span><span style="color:#24292e"> </span><span style="color:#6f42c1">unlock</span><span style="color:#24292e">() {</span></span>
<span class="line"><span style="color:#24292e">        sync.</span><span style="color:#6f42c1">release</span><span style="color:#24292e">(</span><span style="color:#005cc5">1</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">// AQS ÁªßÊâøËøáÊù•ÁöÑÊñπÊ≥ï, Êñπ‰æøÈòÖËØª, ÊîæÂú®Ê≠§Â§Ñ</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">final</span><span style="color:#24292e"> </span><span style="color:#d73a49">boolean</span><span style="color:#24292e"> </span><span style="color:#6f42c1">release</span><span style="color:#24292e">(</span><span style="color:#d73a49">int</span><span style="color:#24292e"> </span><span style="color:#e36209">arg</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6a737d">// Â∞ùËØïÈáäÊîæÂÜôÈîÅÊàêÂäü</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (</span><span style="color:#6f42c1">tryRelease</span><span style="color:#24292e">(arg)) {</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#6a737d">// unpark AQS ‰∏≠Á≠âÂæÖÁöÑÁ∫øÁ®ã</span></span>
<span class="line"><span style="color:#24292e">            Node h </span><span style="color:#d73a49">=</span><span style="color:#24292e"> head;</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (h </span><span style="color:#d73a49">!=</span><span style="color:#24292e"> </span><span style="color:#005cc5">null</span><span style="color:#24292e"> </span><span style="color:#d73a49">&amp;&amp;</span><span style="color:#24292e"> h.waitStatus </span><span style="color:#d73a49">!=</span><span style="color:#24292e"> </span><span style="color:#005cc5">0</span><span style="color:#24292e">)</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#6f42c1">unparkSuccessor</span><span style="color:#24292e">(h);</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">return</span><span style="color:#24292e"> </span><span style="color:#005cc5">true</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">        }</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">return</span><span style="color:#24292e"> </span><span style="color:#005cc5">false</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">// Sync ÁªßÊâøËøáÊù•ÁöÑÊñπÊ≥ï, Êñπ‰æøÈòÖËØª, ÊîæÂú®Ê≠§Â§Ñ</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">protected</span><span style="color:#24292e"> </span><span style="color:#d73a49">final</span><span style="color:#24292e"> </span><span style="color:#d73a49">boolean</span><span style="color:#24292e"> </span><span style="color:#6f42c1">tryRelease</span><span style="color:#24292e">(</span><span style="color:#d73a49">int</span><span style="color:#24292e"> </span><span style="color:#e36209">releases</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (</span><span style="color:#d73a49">!</span><span style="color:#6f42c1">isHeldExclusively</span><span style="color:#24292e">())</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">throw</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">IllegalMonitorStateException</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">int</span><span style="color:#24292e"> nextc </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#6f42c1">getState</span><span style="color:#24292e">() </span><span style="color:#d73a49">-</span><span style="color:#24292e"> releases;</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6a737d">// Âõ†‰∏∫ÂèØÈáçÂÖ•ÁöÑÂéüÂõ†, ÂÜôÈîÅËÆ°Êï∞‰∏∫ 0, ÊâçÁÆóÈáäÊîæÊàêÂäü</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">boolean</span><span style="color:#24292e"> free </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#6f42c1">exclusiveCount</span><span style="color:#24292e">(nextc) </span><span style="color:#d73a49">==</span><span style="color:#24292e"> </span><span style="color:#005cc5">0</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (free) {</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#6f42c1">setExclusiveOwnerThread</span><span style="color:#24292e">(</span><span style="color:#005cc5">null</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">        }</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6f42c1">setState</span><span style="color:#24292e">(nextc);</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">return</span><span style="color:#24292e"> free;</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"><span style="color:#24292e">}</span></span></code></pre></div><h6 id="ËØªÈîÅ‰∏äÈîÅÊµÅÁ®ã" tabindex="-1">ËØªÈîÅ‰∏äÈîÅÊµÅÁ®ã <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20advanced%20chapter#ËØªÈîÅ‰∏äÈîÅÊµÅÁ®ã" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h6><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#f97583">static</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">final</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">class</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">NonfairSync</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">extends</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Sync</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">// ReadLock ÊñπÊ≥ï, Êñπ‰æøÈòÖËØª, ÊîæÂú®Ê≠§Â§Ñ</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">void</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">lock</span><span style="color:#e1e4e8">() {</span></span>
<span class="line"><span style="color:#e1e4e8">        sync.</span><span style="color:#b392f0">acquireShared</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">1</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">// AQS ÁªßÊâøËøáÊù•ÁöÑÊñπÊ≥ï, Êñπ‰æøÈòÖËØª, ÊîæÂú®Ê≠§Â§Ñ</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">final</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">void</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">acquireShared</span><span style="color:#e1e4e8">(</span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> </span><span style="color:#ffab70">arg</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#6a737d">// tryAcquireShared ËøîÂõûË¥üÊï∞, Ë°®Á§∫Ëé∑ÂèñËØªÈîÅÂ§±Ë¥•</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (</span><span style="color:#b392f0">tryAcquireShared</span><span style="color:#e1e4e8">(arg) </span><span style="color:#f97583">&lt;</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#b392f0">doAcquireShared</span><span style="color:#e1e4e8">(arg);</span></span>
<span class="line"><span style="color:#e1e4e8">        }</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">// Sync ÁªßÊâøËøáÊù•ÁöÑÊñπÊ≥ï, Êñπ‰æøÈòÖËØª, ÊîæÂú®Ê≠§Â§Ñ</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">protected</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">final</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">tryAcquireShared</span><span style="color:#e1e4e8">(</span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> </span><span style="color:#ffab70">unused</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">        Thread current </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> Thread.</span><span style="color:#b392f0">currentThread</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> c </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">getState</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#6a737d">// Â¶ÇÊûúÊòØÂÖ∂ÂÆÉÁ∫øÁ®ãÊåÅÊúâÂÜôÈîÅ, Ëé∑ÂèñËØªÈîÅÂ§±Ë¥•</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#b392f0">exclusiveCount</span><span style="color:#e1e4e8">(c) </span><span style="color:#f97583">!=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">&amp;&amp;</span></span>
<span class="line"><span style="color:#e1e4e8">                        </span><span style="color:#b392f0">getExclusiveOwnerThread</span><span style="color:#e1e4e8">() </span><span style="color:#f97583">!=</span><span style="color:#e1e4e8"> current</span></span>
<span class="line"><span style="color:#e1e4e8">        ) {</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">-</span><span style="color:#79b8ff">1</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">        }</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> r </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">sharedCount</span><span style="color:#e1e4e8">(c);</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#6a737d">// ËØªÈîÅ‰∏çËØ•ÈòªÂ°û(Â¶ÇÊûúËÄÅ‰∫åÊòØÂÜôÈîÅÔºåËØªÈîÅËØ•ÈòªÂ°û), Âπ∂‰∏î</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#f97583">!</span><span style="color:#b392f0">readerShouldBlock</span><span style="color:#e1e4e8">() </span><span style="color:#f97583">&amp;&amp;</span></span>
<span class="line"><span style="color:#e1e4e8">                        </span><span style="color:#6a737d">// Â∞è‰∫éËØªÈîÅËÆ°Êï∞, Âπ∂‰∏î</span></span>
<span class="line"><span style="color:#e1e4e8">                        r </span><span style="color:#f97583">&lt;</span><span style="color:#e1e4e8"> MAX_COUNT </span><span style="color:#f97583">&amp;&amp;</span></span>
<span class="line"><span style="color:#e1e4e8">                        </span><span style="color:#6a737d">// Â∞ùËØïÂ¢ûÂä†ËÆ°Êï∞ÊàêÂäü</span></span>
<span class="line"><span style="color:#e1e4e8">                        </span><span style="color:#b392f0">compareAndSetState</span><span style="color:#e1e4e8">(c, c </span><span style="color:#f97583">+</span><span style="color:#e1e4e8"> SHARED_UNIT)</span></span>
<span class="line"><span style="color:#e1e4e8">        ) {</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#6a737d">// ... ÁúÅÁï•‰∏çÈáçË¶ÅÁöÑ‰ª£Á†Å</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">1</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">        }</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">fullTryAcquireShared</span><span style="color:#e1e4e8">(current);</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">// ÈùûÂÖ¨Âπ≥ÈîÅ readerShouldBlock Áúã AQS ÈòüÂàó‰∏≠Á¨¨‰∏Ä‰∏™ËäÇÁÇπÊòØÂê¶ÊòØÂÜôÈîÅ</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">// true ÂàôËØ•ÈòªÂ°û, false Âàô‰∏çÈòªÂ°û</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">final</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">boolean</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">readerShouldBlock</span><span style="color:#e1e4e8">() {</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">apparentlyFirstQueuedIsExclusive</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">// AQS ÁªßÊâøËøáÊù•ÁöÑÊñπÊ≥ï, Êñπ‰æøÈòÖËØª, ÊîæÂú®Ê≠§Â§Ñ</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">// ‰∏é tryAcquireShared ÂäüËÉΩÁ±ª‰ºº, ‰ΩÜ‰ºö‰∏çÊñ≠Â∞ùËØï for (;;) Ëé∑ÂèñËØªÈîÅ, ÊâßË°åËøáÁ®ã‰∏≠Êó†ÈòªÂ°û</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">final</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">fullTryAcquireShared</span><span style="color:#e1e4e8">(Thread </span><span style="color:#ffab70">current</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">        HoldCounter rh </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">for</span><span style="color:#e1e4e8"> (;;) {</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> c </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">getState</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (</span><span style="color:#b392f0">exclusiveCount</span><span style="color:#e1e4e8">(c) </span><span style="color:#f97583">!=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (</span><span style="color:#b392f0">getExclusiveOwnerThread</span><span style="color:#e1e4e8">() </span><span style="color:#f97583">!=</span><span style="color:#e1e4e8"> current)</span></span>
<span class="line"><span style="color:#e1e4e8">                    </span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">-</span><span style="color:#79b8ff">1</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">            } </span><span style="color:#f97583">else</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (</span><span style="color:#b392f0">readerShouldBlock</span><span style="color:#e1e4e8">()) {</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#6a737d">// ... ÁúÅÁï•‰∏çÈáçË¶ÅÁöÑ‰ª£Á†Å</span></span>
<span class="line"><span style="color:#e1e4e8">            }</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (</span><span style="color:#b392f0">sharedCount</span><span style="color:#e1e4e8">(c) </span><span style="color:#f97583">==</span><span style="color:#e1e4e8"> MAX_COUNT)</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#f97583">throw</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Error</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"Maximum lock count exceeded"</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (</span><span style="color:#b392f0">compareAndSetState</span><span style="color:#e1e4e8">(c, c </span><span style="color:#f97583">+</span><span style="color:#e1e4e8"> SHARED_UNIT)) {</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#6a737d">// ... ÁúÅÁï•‰∏çÈáçË¶ÅÁöÑ‰ª£Á†Å</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">1</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">            }</span></span>
<span class="line"><span style="color:#e1e4e8">        }</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">// AQS ÁªßÊâøËøáÊù•ÁöÑÊñπÊ≥ï, Êñπ‰æøÈòÖËØª, ÊîæÂú®Ê≠§Â§Ñ</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">private</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">void</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">doAcquireShared</span><span style="color:#e1e4e8">(</span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> </span><span style="color:#ffab70">arg</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#6a737d">// Â∞ÜÂΩìÂâçÁ∫øÁ®ãÂÖ≥ËÅîÂà∞‰∏Ä‰∏™ Node ÂØπË±°‰∏ä, Ê®°Âºè‰∏∫ÂÖ±‰∫´Ê®°Âºè</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">final</span><span style="color:#e1e4e8"> Node node </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">addWaiter</span><span style="color:#e1e4e8">(Node.SHARED);</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">boolean</span><span style="color:#e1e4e8"> failed </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">true</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">try</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">boolean</span><span style="color:#e1e4e8"> interrupted </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">false</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">for</span><span style="color:#e1e4e8"> (;;) {</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#f97583">final</span><span style="color:#e1e4e8"> Node p </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> node.</span><span style="color:#b392f0">predecessor</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (p </span><span style="color:#f97583">==</span><span style="color:#e1e4e8"> head) {</span></span>
<span class="line"><span style="color:#e1e4e8">                    </span><span style="color:#6a737d">// ÂÜç‰∏ÄÊ¨°Â∞ùËØïËé∑ÂèñËØªÈîÅ</span></span>
<span class="line"><span style="color:#e1e4e8">                    </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> r </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">tryAcquireShared</span><span style="color:#e1e4e8">(arg);</span></span>
<span class="line"><span style="color:#e1e4e8">                    </span><span style="color:#6a737d">// ÊàêÂäü</span></span>
<span class="line"><span style="color:#e1e4e8">                    </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (r </span><span style="color:#f97583">&gt;=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">                        </span><span style="color:#6a737d">// „à†</span></span>
<span class="line"><span style="color:#e1e4e8">						</span><span style="color:#6a737d">// r Ë°®Á§∫ÂèØÁî®ËµÑÊ∫êÊï∞, Âú®ËøôÈáåÊÄªÊòØ 1 ÂÖÅËÆ∏‰º†Êí≠</span></span>
<span class="line"><span style="color:#e1e4e8">                        </span><span style="color:#6a737d">//ÔºàÂî§ÈÜí AQS ‰∏≠‰∏ã‰∏Ä‰∏™ Share ËäÇÁÇπÔºâ</span></span>
<span class="line"><span style="color:#e1e4e8">                        </span><span style="color:#b392f0">setHeadAndPropagate</span><span style="color:#e1e4e8">(node, r);</span></span>
<span class="line"><span style="color:#e1e4e8">                        p.next </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8">; </span><span style="color:#6a737d">// help GC</span></span>
<span class="line"><span style="color:#e1e4e8">                        </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (interrupted)</span></span>
<span class="line"><span style="color:#e1e4e8">                            </span><span style="color:#b392f0">selfInterrupt</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">                        failed </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">false</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">                        </span><span style="color:#f97583">return</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">                    }</span></span>
<span class="line"><span style="color:#e1e4e8">                }</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (</span></span>
<span class="line"><span style="color:#e1e4e8">                    </span><span style="color:#6a737d">// ÊòØÂê¶Âú®Ëé∑ÂèñËØªÈîÅÂ§±Ë¥•Êó∂ÈòªÂ°ûÔºàÂâç‰∏Ä‰∏™Èò∂ÊÆµ waitStatus == Node.SIGNALÔºâ</span></span>
<span class="line"><span style="color:#e1e4e8">                        </span><span style="color:#b392f0">shouldParkAfterFailedAcquire</span><span style="color:#e1e4e8">(p, node) </span><span style="color:#f97583">&amp;&amp;</span></span>
<span class="line"><span style="color:#e1e4e8">                                </span><span style="color:#6a737d">// park ÂΩìÂâçÁ∫øÁ®ã</span></span>
<span class="line"><span style="color:#e1e4e8">                                </span><span style="color:#b392f0">parkAndCheckInterrupt</span><span style="color:#e1e4e8">()</span></span>
<span class="line"><span style="color:#e1e4e8">                ) {</span></span>
<span class="line"><span style="color:#e1e4e8">                    interrupted </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">true</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">                }</span></span>
<span class="line"><span style="color:#e1e4e8">            }</span></span>
<span class="line"><span style="color:#e1e4e8">        } </span><span style="color:#f97583">finally</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (failed)</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#b392f0">cancelAcquire</span><span style="color:#e1e4e8">(node);</span></span>
<span class="line"><span style="color:#e1e4e8">        }</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">// „à† AQS ÁªßÊâøËøáÊù•ÁöÑÊñπÊ≥ï, Êñπ‰æøÈòÖËØª, ÊîæÂú®Ê≠§Â§Ñ</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">private</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">void</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">setHeadAndPropagate</span><span style="color:#e1e4e8">(Node </span><span style="color:#ffab70">node</span><span style="color:#e1e4e8">, </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> </span><span style="color:#ffab70">propagate</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">        Node h </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> head; </span><span style="color:#6a737d">// Record old head for check below</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#6a737d">// ËÆæÁΩÆËá™Â∑±‰∏∫ head</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#b392f0">setHead</span><span style="color:#e1e4e8">(node);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#6a737d">// propagate Ë°®Á§∫ÊúâÂÖ±‰∫´ËµÑÊ∫êÔºà‰æãÂ¶ÇÂÖ±‰∫´ËØªÈîÅÊàñ‰ø°Âè∑ÈáèÔºâ</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#6a737d">// Âéü head waitStatus == Node.SIGNAL Êàñ Node.PROPAGATE</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#6a737d">// Áé∞Âú® head waitStatus == Node.SIGNAL Êàñ Node.PROPAGATE</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (propagate </span><span style="color:#f97583">&gt;</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">||</span><span style="color:#e1e4e8"> h </span><span style="color:#f97583">==</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">||</span><span style="color:#e1e4e8"> h.waitStatus </span><span style="color:#f97583">&lt;</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">||</span></span>
<span class="line"><span style="color:#e1e4e8">                (h </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> head) </span><span style="color:#f97583">==</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">||</span><span style="color:#e1e4e8"> h.waitStatus </span><span style="color:#f97583">&lt;</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">            Node s </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> node.next;</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#6a737d">// Â¶ÇÊûúÊòØÊúÄÂêé‰∏Ä‰∏™ËäÇÁÇπÊàñËÄÖÊòØÁ≠âÂæÖÂÖ±‰∫´ËØªÈîÅÁöÑËäÇÁÇπ</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (s </span><span style="color:#f97583">==</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">||</span><span style="color:#e1e4e8"> s.</span><span style="color:#b392f0">isShared</span><span style="color:#e1e4e8">()) {</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#6a737d">// ËøõÂÖ• „à°</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#b392f0">doReleaseShared</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">            }</span></span>
<span class="line"><span style="color:#e1e4e8">        }</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">// „à° AQS ÁªßÊâøËøáÊù•ÁöÑÊñπÊ≥ï, Êñπ‰æøÈòÖËØª, ÊîæÂú®Ê≠§Â§Ñ</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">private</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">void</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">doReleaseShared</span><span style="color:#e1e4e8">() {</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#6a737d">// Â¶ÇÊûú head.waitStatus == Node.SIGNAL ==&gt; 0 ÊàêÂäü, ‰∏ã‰∏Ä‰∏™ËäÇÁÇπ unpark</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#6a737d">// Â¶ÇÊûú head.waitStatus == 0 ==&gt; Node.PROPAGATE, ‰∏∫‰∫ÜËß£ÂÜ≥ bug, ËßÅÂêéÈù¢ÂàÜÊûêÔºåÂèÇËÄÉËøôÈáåÔºöhttp://www.tianxiaobo.com/2018/05/01/AbstractQueuedSynchronizer-%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90-%E7%8B%AC%E5%8D%A0-%E5%85%B1%E4%BA%AB%E6%A8%A1%E5%BC%8F/#5propagate-%E7%8A%B6%E6%80%81%E5%AD%98%E5%9C%A8%E7%9A%84%E6%84%8F%E4%B9%89</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">for</span><span style="color:#e1e4e8"> (;;) {</span></span>
<span class="line"><span style="color:#e1e4e8">            Node h </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> head;</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#6a737d">// ÈòüÂàóËøòÊúâËäÇÁÇπ</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (h </span><span style="color:#f97583">!=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">&amp;&amp;</span><span style="color:#e1e4e8"> h </span><span style="color:#f97583">!=</span><span style="color:#e1e4e8"> tail) {</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> ws </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> h.waitStatus;</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (ws </span><span style="color:#f97583">==</span><span style="color:#e1e4e8"> Node.SIGNAL) {</span></span>
<span class="line"><span style="color:#e1e4e8">                    </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (</span><span style="color:#f97583">!</span><span style="color:#b392f0">compareAndSetWaitStatus</span><span style="color:#e1e4e8">(h, Node.SIGNAL, </span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8">))</span></span>
<span class="line"><span style="color:#e1e4e8">                        </span><span style="color:#f97583">continue</span><span style="color:#e1e4e8">; </span><span style="color:#6a737d">// loop to recheck cases</span></span>
<span class="line"><span style="color:#e1e4e8">                    </span><span style="color:#6a737d">// ‰∏ã‰∏Ä‰∏™ËäÇÁÇπ unpark Â¶ÇÊûúÊàêÂäüËé∑ÂèñËØªÈîÅ</span></span>
<span class="line"><span style="color:#e1e4e8">                    </span><span style="color:#6a737d">// Âπ∂‰∏î‰∏ã‰∏ã‰∏™ËäÇÁÇπËøòÊòØ shared, ÁªßÁª≠ doReleaseShared</span></span>
<span class="line"><span style="color:#e1e4e8">                    </span><span style="color:#b392f0">unparkSuccessor</span><span style="color:#e1e4e8">(h);</span></span>
<span class="line"><span style="color:#e1e4e8">                }</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#f97583">else</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (ws </span><span style="color:#f97583">==</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">&amp;&amp;</span></span>
<span class="line"><span style="color:#e1e4e8">                        </span><span style="color:#f97583">!</span><span style="color:#b392f0">compareAndSetWaitStatus</span><span style="color:#e1e4e8">(h, </span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8">, Node.PROPAGATE))</span></span>
<span class="line"><span style="color:#e1e4e8">                    </span><span style="color:#f97583">continue</span><span style="color:#e1e4e8">; </span><span style="color:#6a737d">// loop on failed CAS</span></span>
<span class="line"><span style="color:#e1e4e8">            }</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (h </span><span style="color:#f97583">==</span><span style="color:#e1e4e8"> head) </span><span style="color:#6a737d">// loop if head changed</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#f97583">break</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">        }</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"><span style="color:#e1e4e8">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#d73a49">static</span><span style="color:#24292e"> </span><span style="color:#d73a49">final</span><span style="color:#24292e"> </span><span style="color:#d73a49">class</span><span style="color:#24292e"> </span><span style="color:#6f42c1">NonfairSync</span><span style="color:#24292e"> </span><span style="color:#d73a49">extends</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Sync</span><span style="color:#24292e"> {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">// ReadLock ÊñπÊ≥ï, Êñπ‰æøÈòÖËØª, ÊîæÂú®Ê≠§Â§Ñ</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">void</span><span style="color:#24292e"> </span><span style="color:#6f42c1">lock</span><span style="color:#24292e">() {</span></span>
<span class="line"><span style="color:#24292e">        sync.</span><span style="color:#6f42c1">acquireShared</span><span style="color:#24292e">(</span><span style="color:#005cc5">1</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">// AQS ÁªßÊâøËøáÊù•ÁöÑÊñπÊ≥ï, Êñπ‰æøÈòÖËØª, ÊîæÂú®Ê≠§Â§Ñ</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">final</span><span style="color:#24292e"> </span><span style="color:#d73a49">void</span><span style="color:#24292e"> </span><span style="color:#6f42c1">acquireShared</span><span style="color:#24292e">(</span><span style="color:#d73a49">int</span><span style="color:#24292e"> </span><span style="color:#e36209">arg</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6a737d">// tryAcquireShared ËøîÂõûË¥üÊï∞, Ë°®Á§∫Ëé∑ÂèñËØªÈîÅÂ§±Ë¥•</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (</span><span style="color:#6f42c1">tryAcquireShared</span><span style="color:#24292e">(arg) </span><span style="color:#d73a49">&lt;</span><span style="color:#24292e"> </span><span style="color:#005cc5">0</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#6f42c1">doAcquireShared</span><span style="color:#24292e">(arg);</span></span>
<span class="line"><span style="color:#24292e">        }</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">// Sync ÁªßÊâøËøáÊù•ÁöÑÊñπÊ≥ï, Êñπ‰æøÈòÖËØª, ÊîæÂú®Ê≠§Â§Ñ</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">protected</span><span style="color:#24292e"> </span><span style="color:#d73a49">final</span><span style="color:#24292e"> </span><span style="color:#d73a49">int</span><span style="color:#24292e"> </span><span style="color:#6f42c1">tryAcquireShared</span><span style="color:#24292e">(</span><span style="color:#d73a49">int</span><span style="color:#24292e"> </span><span style="color:#e36209">unused</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">        Thread current </span><span style="color:#d73a49">=</span><span style="color:#24292e"> Thread.</span><span style="color:#6f42c1">currentThread</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">int</span><span style="color:#24292e"> c </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#6f42c1">getState</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6a737d">// Â¶ÇÊûúÊòØÂÖ∂ÂÆÉÁ∫øÁ®ãÊåÅÊúâÂÜôÈîÅ, Ëé∑ÂèñËØªÈîÅÂ§±Ë¥•</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#6f42c1">exclusiveCount</span><span style="color:#24292e">(c) </span><span style="color:#d73a49">!=</span><span style="color:#24292e"> </span><span style="color:#005cc5">0</span><span style="color:#24292e"> </span><span style="color:#d73a49">&amp;&amp;</span></span>
<span class="line"><span style="color:#24292e">                        </span><span style="color:#6f42c1">getExclusiveOwnerThread</span><span style="color:#24292e">() </span><span style="color:#d73a49">!=</span><span style="color:#24292e"> current</span></span>
<span class="line"><span style="color:#24292e">        ) {</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">return</span><span style="color:#24292e"> </span><span style="color:#d73a49">-</span><span style="color:#005cc5">1</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">        }</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">int</span><span style="color:#24292e"> r </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#6f42c1">sharedCount</span><span style="color:#24292e">(c);</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#6a737d">// ËØªÈîÅ‰∏çËØ•ÈòªÂ°û(Â¶ÇÊûúËÄÅ‰∫åÊòØÂÜôÈîÅÔºåËØªÈîÅËØ•ÈòªÂ°û), Âπ∂‰∏î</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#d73a49">!</span><span style="color:#6f42c1">readerShouldBlock</span><span style="color:#24292e">() </span><span style="color:#d73a49">&amp;&amp;</span></span>
<span class="line"><span style="color:#24292e">                        </span><span style="color:#6a737d">// Â∞è‰∫éËØªÈîÅËÆ°Êï∞, Âπ∂‰∏î</span></span>
<span class="line"><span style="color:#24292e">                        r </span><span style="color:#d73a49">&lt;</span><span style="color:#24292e"> MAX_COUNT </span><span style="color:#d73a49">&amp;&amp;</span></span>
<span class="line"><span style="color:#24292e">                        </span><span style="color:#6a737d">// Â∞ùËØïÂ¢ûÂä†ËÆ°Êï∞ÊàêÂäü</span></span>
<span class="line"><span style="color:#24292e">                        </span><span style="color:#6f42c1">compareAndSetState</span><span style="color:#24292e">(c, c </span><span style="color:#d73a49">+</span><span style="color:#24292e"> SHARED_UNIT)</span></span>
<span class="line"><span style="color:#24292e">        ) {</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#6a737d">// ... ÁúÅÁï•‰∏çÈáçË¶ÅÁöÑ‰ª£Á†Å</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">return</span><span style="color:#24292e"> </span><span style="color:#005cc5">1</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">        }</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">return</span><span style="color:#24292e"> </span><span style="color:#6f42c1">fullTryAcquireShared</span><span style="color:#24292e">(current);</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">// ÈùûÂÖ¨Âπ≥ÈîÅ readerShouldBlock Áúã AQS ÈòüÂàó‰∏≠Á¨¨‰∏Ä‰∏™ËäÇÁÇπÊòØÂê¶ÊòØÂÜôÈîÅ</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">// true ÂàôËØ•ÈòªÂ°û, false Âàô‰∏çÈòªÂ°û</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">final</span><span style="color:#24292e"> </span><span style="color:#d73a49">boolean</span><span style="color:#24292e"> </span><span style="color:#6f42c1">readerShouldBlock</span><span style="color:#24292e">() {</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">return</span><span style="color:#24292e"> </span><span style="color:#6f42c1">apparentlyFirstQueuedIsExclusive</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">// AQS ÁªßÊâøËøáÊù•ÁöÑÊñπÊ≥ï, Êñπ‰æøÈòÖËØª, ÊîæÂú®Ê≠§Â§Ñ</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">// ‰∏é tryAcquireShared ÂäüËÉΩÁ±ª‰ºº, ‰ΩÜ‰ºö‰∏çÊñ≠Â∞ùËØï for (;;) Ëé∑ÂèñËØªÈîÅ, ÊâßË°åËøáÁ®ã‰∏≠Êó†ÈòªÂ°û</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">final</span><span style="color:#24292e"> </span><span style="color:#d73a49">int</span><span style="color:#24292e"> </span><span style="color:#6f42c1">fullTryAcquireShared</span><span style="color:#24292e">(Thread </span><span style="color:#e36209">current</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">        HoldCounter rh </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#005cc5">null</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">for</span><span style="color:#24292e"> (;;) {</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">int</span><span style="color:#24292e"> c </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#6f42c1">getState</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (</span><span style="color:#6f42c1">exclusiveCount</span><span style="color:#24292e">(c) </span><span style="color:#d73a49">!=</span><span style="color:#24292e"> </span><span style="color:#005cc5">0</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (</span><span style="color:#6f42c1">getExclusiveOwnerThread</span><span style="color:#24292e">() </span><span style="color:#d73a49">!=</span><span style="color:#24292e"> current)</span></span>
<span class="line"><span style="color:#24292e">                    </span><span style="color:#d73a49">return</span><span style="color:#24292e"> </span><span style="color:#d73a49">-</span><span style="color:#005cc5">1</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">            } </span><span style="color:#d73a49">else</span><span style="color:#24292e"> </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (</span><span style="color:#6f42c1">readerShouldBlock</span><span style="color:#24292e">()) {</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#6a737d">// ... ÁúÅÁï•‰∏çÈáçË¶ÅÁöÑ‰ª£Á†Å</span></span>
<span class="line"><span style="color:#24292e">            }</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (</span><span style="color:#6f42c1">sharedCount</span><span style="color:#24292e">(c) </span><span style="color:#d73a49">==</span><span style="color:#24292e"> MAX_COUNT)</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#d73a49">throw</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Error</span><span style="color:#24292e">(</span><span style="color:#032f62">"Maximum lock count exceeded"</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (</span><span style="color:#6f42c1">compareAndSetState</span><span style="color:#24292e">(c, c </span><span style="color:#d73a49">+</span><span style="color:#24292e"> SHARED_UNIT)) {</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#6a737d">// ... ÁúÅÁï•‰∏çÈáçË¶ÅÁöÑ‰ª£Á†Å</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#d73a49">return</span><span style="color:#24292e"> </span><span style="color:#005cc5">1</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">            }</span></span>
<span class="line"><span style="color:#24292e">        }</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">// AQS ÁªßÊâøËøáÊù•ÁöÑÊñπÊ≥ï, Êñπ‰æøÈòÖËØª, ÊîæÂú®Ê≠§Â§Ñ</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">private</span><span style="color:#24292e"> </span><span style="color:#d73a49">void</span><span style="color:#24292e"> </span><span style="color:#6f42c1">doAcquireShared</span><span style="color:#24292e">(</span><span style="color:#d73a49">int</span><span style="color:#24292e"> </span><span style="color:#e36209">arg</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6a737d">// Â∞ÜÂΩìÂâçÁ∫øÁ®ãÂÖ≥ËÅîÂà∞‰∏Ä‰∏™ Node ÂØπË±°‰∏ä, Ê®°Âºè‰∏∫ÂÖ±‰∫´Ê®°Âºè</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">final</span><span style="color:#24292e"> Node node </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#6f42c1">addWaiter</span><span style="color:#24292e">(Node.SHARED);</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">boolean</span><span style="color:#24292e"> failed </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#005cc5">true</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">try</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">boolean</span><span style="color:#24292e"> interrupted </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#005cc5">false</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">for</span><span style="color:#24292e"> (;;) {</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#d73a49">final</span><span style="color:#24292e"> Node p </span><span style="color:#d73a49">=</span><span style="color:#24292e"> node.</span><span style="color:#6f42c1">predecessor</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (p </span><span style="color:#d73a49">==</span><span style="color:#24292e"> head) {</span></span>
<span class="line"><span style="color:#24292e">                    </span><span style="color:#6a737d">// ÂÜç‰∏ÄÊ¨°Â∞ùËØïËé∑ÂèñËØªÈîÅ</span></span>
<span class="line"><span style="color:#24292e">                    </span><span style="color:#d73a49">int</span><span style="color:#24292e"> r </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#6f42c1">tryAcquireShared</span><span style="color:#24292e">(arg);</span></span>
<span class="line"><span style="color:#24292e">                    </span><span style="color:#6a737d">// ÊàêÂäü</span></span>
<span class="line"><span style="color:#24292e">                    </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (r </span><span style="color:#d73a49">&gt;=</span><span style="color:#24292e"> </span><span style="color:#005cc5">0</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">                        </span><span style="color:#6a737d">// „à†</span></span>
<span class="line"><span style="color:#24292e">						</span><span style="color:#6a737d">// r Ë°®Á§∫ÂèØÁî®ËµÑÊ∫êÊï∞, Âú®ËøôÈáåÊÄªÊòØ 1 ÂÖÅËÆ∏‰º†Êí≠</span></span>
<span class="line"><span style="color:#24292e">                        </span><span style="color:#6a737d">//ÔºàÂî§ÈÜí AQS ‰∏≠‰∏ã‰∏Ä‰∏™ Share ËäÇÁÇπÔºâ</span></span>
<span class="line"><span style="color:#24292e">                        </span><span style="color:#6f42c1">setHeadAndPropagate</span><span style="color:#24292e">(node, r);</span></span>
<span class="line"><span style="color:#24292e">                        p.next </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#005cc5">null</span><span style="color:#24292e">; </span><span style="color:#6a737d">// help GC</span></span>
<span class="line"><span style="color:#24292e">                        </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (interrupted)</span></span>
<span class="line"><span style="color:#24292e">                            </span><span style="color:#6f42c1">selfInterrupt</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">                        failed </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#005cc5">false</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">                        </span><span style="color:#d73a49">return</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">                    }</span></span>
<span class="line"><span style="color:#24292e">                }</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (</span></span>
<span class="line"><span style="color:#24292e">                    </span><span style="color:#6a737d">// ÊòØÂê¶Âú®Ëé∑ÂèñËØªÈîÅÂ§±Ë¥•Êó∂ÈòªÂ°ûÔºàÂâç‰∏Ä‰∏™Èò∂ÊÆµ waitStatus == Node.SIGNALÔºâ</span></span>
<span class="line"><span style="color:#24292e">                        </span><span style="color:#6f42c1">shouldParkAfterFailedAcquire</span><span style="color:#24292e">(p, node) </span><span style="color:#d73a49">&amp;&amp;</span></span>
<span class="line"><span style="color:#24292e">                                </span><span style="color:#6a737d">// park ÂΩìÂâçÁ∫øÁ®ã</span></span>
<span class="line"><span style="color:#24292e">                                </span><span style="color:#6f42c1">parkAndCheckInterrupt</span><span style="color:#24292e">()</span></span>
<span class="line"><span style="color:#24292e">                ) {</span></span>
<span class="line"><span style="color:#24292e">                    interrupted </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#005cc5">true</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">                }</span></span>
<span class="line"><span style="color:#24292e">            }</span></span>
<span class="line"><span style="color:#24292e">        } </span><span style="color:#d73a49">finally</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (failed)</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#6f42c1">cancelAcquire</span><span style="color:#24292e">(node);</span></span>
<span class="line"><span style="color:#24292e">        }</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">// „à† AQS ÁªßÊâøËøáÊù•ÁöÑÊñπÊ≥ï, Êñπ‰æøÈòÖËØª, ÊîæÂú®Ê≠§Â§Ñ</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">private</span><span style="color:#24292e"> </span><span style="color:#d73a49">void</span><span style="color:#24292e"> </span><span style="color:#6f42c1">setHeadAndPropagate</span><span style="color:#24292e">(Node </span><span style="color:#e36209">node</span><span style="color:#24292e">, </span><span style="color:#d73a49">int</span><span style="color:#24292e"> </span><span style="color:#e36209">propagate</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">        Node h </span><span style="color:#d73a49">=</span><span style="color:#24292e"> head; </span><span style="color:#6a737d">// Record old head for check below</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6a737d">// ËÆæÁΩÆËá™Â∑±‰∏∫ head</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6f42c1">setHead</span><span style="color:#24292e">(node);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6a737d">// propagate Ë°®Á§∫ÊúâÂÖ±‰∫´ËµÑÊ∫êÔºà‰æãÂ¶ÇÂÖ±‰∫´ËØªÈîÅÊàñ‰ø°Âè∑ÈáèÔºâ</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6a737d">// Âéü head waitStatus == Node.SIGNAL Êàñ Node.PROPAGATE</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6a737d">// Áé∞Âú® head waitStatus == Node.SIGNAL Êàñ Node.PROPAGATE</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (propagate </span><span style="color:#d73a49">&gt;</span><span style="color:#24292e"> </span><span style="color:#005cc5">0</span><span style="color:#24292e"> </span><span style="color:#d73a49">||</span><span style="color:#24292e"> h </span><span style="color:#d73a49">==</span><span style="color:#24292e"> </span><span style="color:#005cc5">null</span><span style="color:#24292e"> </span><span style="color:#d73a49">||</span><span style="color:#24292e"> h.waitStatus </span><span style="color:#d73a49">&lt;</span><span style="color:#24292e"> </span><span style="color:#005cc5">0</span><span style="color:#24292e"> </span><span style="color:#d73a49">||</span></span>
<span class="line"><span style="color:#24292e">                (h </span><span style="color:#d73a49">=</span><span style="color:#24292e"> head) </span><span style="color:#d73a49">==</span><span style="color:#24292e"> </span><span style="color:#005cc5">null</span><span style="color:#24292e"> </span><span style="color:#d73a49">||</span><span style="color:#24292e"> h.waitStatus </span><span style="color:#d73a49">&lt;</span><span style="color:#24292e"> </span><span style="color:#005cc5">0</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">            Node s </span><span style="color:#d73a49">=</span><span style="color:#24292e"> node.next;</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#6a737d">// Â¶ÇÊûúÊòØÊúÄÂêé‰∏Ä‰∏™ËäÇÁÇπÊàñËÄÖÊòØÁ≠âÂæÖÂÖ±‰∫´ËØªÈîÅÁöÑËäÇÁÇπ</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (s </span><span style="color:#d73a49">==</span><span style="color:#24292e"> </span><span style="color:#005cc5">null</span><span style="color:#24292e"> </span><span style="color:#d73a49">||</span><span style="color:#24292e"> s.</span><span style="color:#6f42c1">isShared</span><span style="color:#24292e">()) {</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#6a737d">// ËøõÂÖ• „à°</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#6f42c1">doReleaseShared</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">            }</span></span>
<span class="line"><span style="color:#24292e">        }</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">// „à° AQS ÁªßÊâøËøáÊù•ÁöÑÊñπÊ≥ï, Êñπ‰æøÈòÖËØª, ÊîæÂú®Ê≠§Â§Ñ</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">private</span><span style="color:#24292e"> </span><span style="color:#d73a49">void</span><span style="color:#24292e"> </span><span style="color:#6f42c1">doReleaseShared</span><span style="color:#24292e">() {</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6a737d">// Â¶ÇÊûú head.waitStatus == Node.SIGNAL ==&gt; 0 ÊàêÂäü, ‰∏ã‰∏Ä‰∏™ËäÇÁÇπ unpark</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6a737d">// Â¶ÇÊûú head.waitStatus == 0 ==&gt; Node.PROPAGATE, ‰∏∫‰∫ÜËß£ÂÜ≥ bug, ËßÅÂêéÈù¢ÂàÜÊûêÔºåÂèÇËÄÉËøôÈáåÔºöhttp://www.tianxiaobo.com/2018/05/01/AbstractQueuedSynchronizer-%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90-%E7%8B%AC%E5%8D%A0-%E5%85%B1%E4%BA%AB%E6%A8%A1%E5%BC%8F/#5propagate-%E7%8A%B6%E6%80%81%E5%AD%98%E5%9C%A8%E7%9A%84%E6%84%8F%E4%B9%89</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">for</span><span style="color:#24292e"> (;;) {</span></span>
<span class="line"><span style="color:#24292e">            Node h </span><span style="color:#d73a49">=</span><span style="color:#24292e"> head;</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#6a737d">// ÈòüÂàóËøòÊúâËäÇÁÇπ</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (h </span><span style="color:#d73a49">!=</span><span style="color:#24292e"> </span><span style="color:#005cc5">null</span><span style="color:#24292e"> </span><span style="color:#d73a49">&amp;&amp;</span><span style="color:#24292e"> h </span><span style="color:#d73a49">!=</span><span style="color:#24292e"> tail) {</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#d73a49">int</span><span style="color:#24292e"> ws </span><span style="color:#d73a49">=</span><span style="color:#24292e"> h.waitStatus;</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (ws </span><span style="color:#d73a49">==</span><span style="color:#24292e"> Node.SIGNAL) {</span></span>
<span class="line"><span style="color:#24292e">                    </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (</span><span style="color:#d73a49">!</span><span style="color:#6f42c1">compareAndSetWaitStatus</span><span style="color:#24292e">(h, Node.SIGNAL, </span><span style="color:#005cc5">0</span><span style="color:#24292e">))</span></span>
<span class="line"><span style="color:#24292e">                        </span><span style="color:#d73a49">continue</span><span style="color:#24292e">; </span><span style="color:#6a737d">// loop to recheck cases</span></span>
<span class="line"><span style="color:#24292e">                    </span><span style="color:#6a737d">// ‰∏ã‰∏Ä‰∏™ËäÇÁÇπ unpark Â¶ÇÊûúÊàêÂäüËé∑ÂèñËØªÈîÅ</span></span>
<span class="line"><span style="color:#24292e">                    </span><span style="color:#6a737d">// Âπ∂‰∏î‰∏ã‰∏ã‰∏™ËäÇÁÇπËøòÊòØ shared, ÁªßÁª≠ doReleaseShared</span></span>
<span class="line"><span style="color:#24292e">                    </span><span style="color:#6f42c1">unparkSuccessor</span><span style="color:#24292e">(h);</span></span>
<span class="line"><span style="color:#24292e">                }</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#d73a49">else</span><span style="color:#24292e"> </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (ws </span><span style="color:#d73a49">==</span><span style="color:#24292e"> </span><span style="color:#005cc5">0</span><span style="color:#24292e"> </span><span style="color:#d73a49">&amp;&amp;</span></span>
<span class="line"><span style="color:#24292e">                        </span><span style="color:#d73a49">!</span><span style="color:#6f42c1">compareAndSetWaitStatus</span><span style="color:#24292e">(h, </span><span style="color:#005cc5">0</span><span style="color:#24292e">, Node.PROPAGATE))</span></span>
<span class="line"><span style="color:#24292e">                    </span><span style="color:#d73a49">continue</span><span style="color:#24292e">; </span><span style="color:#6a737d">// loop on failed CAS</span></span>
<span class="line"><span style="color:#24292e">            }</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (h </span><span style="color:#d73a49">==</span><span style="color:#24292e"> head) </span><span style="color:#6a737d">// loop if head changed</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#d73a49">break</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">        }</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"><span style="color:#24292e">}</span></span></code></pre></div><h6 id="ËØªÈîÅÈáäÊîæÊµÅÁ®ã" tabindex="-1">ËØªÈîÅÈáäÊîæÊµÅÁ®ã <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20advanced%20chapter#ËØªÈîÅÈáäÊîæÊµÅÁ®ã" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h6><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#f97583">static</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">final</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">class</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">NonfairSync</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">extends</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Sync</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">// ReadLock ÊñπÊ≥ï, Êñπ‰æøÈòÖËØª, ÊîæÂú®Ê≠§Â§Ñ</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">void</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">unlock</span><span style="color:#e1e4e8">() {</span></span>
<span class="line"><span style="color:#e1e4e8">        sync.</span><span style="color:#b392f0">releaseShared</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">1</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">// AQS ÁªßÊâøËøáÊù•ÁöÑÊñπÊ≥ï, Êñπ‰æøÈòÖËØª, ÊîæÂú®Ê≠§Â§Ñ</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">final</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">boolean</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">releaseShared</span><span style="color:#e1e4e8">(</span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> </span><span style="color:#ffab70">arg</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (</span><span style="color:#b392f0">tryReleaseShared</span><span style="color:#e1e4e8">(arg)) {</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#b392f0">doReleaseShared</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">true</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">        }</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">false</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">// Sync ÁªßÊâøËøáÊù•ÁöÑÊñπÊ≥ï, Êñπ‰æøÈòÖËØª, ÊîæÂú®Ê≠§Â§Ñ</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">protected</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">final</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">boolean</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">tryReleaseShared</span><span style="color:#e1e4e8">(</span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> </span><span style="color:#ffab70">unused</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#6a737d">// ... ÁúÅÁï•‰∏çÈáçË¶ÅÁöÑ‰ª£Á†Å</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">for</span><span style="color:#e1e4e8"> (;;) {</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> c </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">getState</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> nextc </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> c </span><span style="color:#f97583">-</span><span style="color:#e1e4e8"> SHARED_UNIT;</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (</span><span style="color:#b392f0">compareAndSetState</span><span style="color:#e1e4e8">(c, nextc)) {</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#6a737d">// ËØªÈîÅÁöÑËÆ°Êï∞‰∏ç‰ºöÂΩ±ÂìçÂÖ∂ÂÆÉËé∑ÂèñËØªÈîÅÁ∫øÁ®ã, ‰ΩÜ‰ºöÂΩ±ÂìçÂÖ∂ÂÆÉËé∑ÂèñÂÜôÈîÅÁ∫øÁ®ã</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#6a737d">// ËÆ°Êï∞‰∏∫ 0 ÊâçÊòØÁúüÊ≠£ÈáäÊîæ</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> nextc </span><span style="color:#f97583">==</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">            }</span></span>
<span class="line"><span style="color:#e1e4e8">        }</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">// AQS ÁªßÊâøËøáÊù•ÁöÑÊñπÊ≥ï, Êñπ‰æøÈòÖËØª, ÊîæÂú®Ê≠§Â§Ñ</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">private</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">void</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">doReleaseShared</span><span style="color:#e1e4e8">() {</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#6a737d">// Â¶ÇÊûú head.waitStatus == Node.SIGNAL ==&gt; 0 ÊàêÂäü, ‰∏ã‰∏Ä‰∏™ËäÇÁÇπ unpark</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#6a737d">// Â¶ÇÊûú head.waitStatus == 0 ==&gt; Node.PROPAGATE</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">for</span><span style="color:#e1e4e8"> (;;) {</span></span>
<span class="line"><span style="color:#e1e4e8">            Node h </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> head;</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (h </span><span style="color:#f97583">!=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">&amp;&amp;</span><span style="color:#e1e4e8"> h </span><span style="color:#f97583">!=</span><span style="color:#e1e4e8"> tail) {</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> ws </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> h.waitStatus;</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#6a737d">// Â¶ÇÊûúÊúâÂÖ∂ÂÆÉÁ∫øÁ®ã‰πüÂú®ÈáäÊîæËØªÈîÅÔºåÈÇ£‰πàÈúÄË¶ÅÂ∞Ü waitStatus ÂÖàÊîπ‰∏∫ 0</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#6a737d">// Èò≤Ê≠¢ unparkSuccessor Ë¢´Â§öÊ¨°ÊâßË°å</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (ws </span><span style="color:#f97583">==</span><span style="color:#e1e4e8"> Node.SIGNAL) {</span></span>
<span class="line"><span style="color:#e1e4e8">                    </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (</span><span style="color:#f97583">!</span><span style="color:#b392f0">compareAndSetWaitStatus</span><span style="color:#e1e4e8">(h, Node.SIGNAL, </span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8">))</span></span>
<span class="line"><span style="color:#e1e4e8">                        </span><span style="color:#f97583">continue</span><span style="color:#e1e4e8">; </span><span style="color:#6a737d">// loop to recheck cases</span></span>
<span class="line"><span style="color:#e1e4e8">                    </span><span style="color:#b392f0">unparkSuccessor</span><span style="color:#e1e4e8">(h);</span></span>
<span class="line"><span style="color:#e1e4e8">                }</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#6a737d">// Â¶ÇÊûúÂ∑≤ÁªèÊòØ 0 ‰∫ÜÔºåÊîπ‰∏∫ -3ÔºåÁî®Êù•Ëß£ÂÜ≥‰º†Êí≠ÊÄßÔºåËßÅÂêéÊñá‰ø°Âè∑Èáè bug ÂàÜÊûê</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#f97583">else</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (ws </span><span style="color:#f97583">==</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">&amp;&amp;</span></span>
<span class="line"><span style="color:#e1e4e8">                        </span><span style="color:#f97583">!</span><span style="color:#b392f0">compareAndSetWaitStatus</span><span style="color:#e1e4e8">(h, </span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8">, Node.PROPAGATE))</span></span>
<span class="line"><span style="color:#e1e4e8">                    </span><span style="color:#f97583">continue</span><span style="color:#e1e4e8">; </span><span style="color:#6a737d">// loop on failed CAS</span></span>
<span class="line"><span style="color:#e1e4e8">            }</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (h </span><span style="color:#f97583">==</span><span style="color:#e1e4e8"> head) </span><span style="color:#6a737d">// loop if head changed</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#f97583">break</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">        }</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"><span style="color:#e1e4e8">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#d73a49">static</span><span style="color:#24292e"> </span><span style="color:#d73a49">final</span><span style="color:#24292e"> </span><span style="color:#d73a49">class</span><span style="color:#24292e"> </span><span style="color:#6f42c1">NonfairSync</span><span style="color:#24292e"> </span><span style="color:#d73a49">extends</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Sync</span><span style="color:#24292e"> {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">// ReadLock ÊñπÊ≥ï, Êñπ‰æøÈòÖËØª, ÊîæÂú®Ê≠§Â§Ñ</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">void</span><span style="color:#24292e"> </span><span style="color:#6f42c1">unlock</span><span style="color:#24292e">() {</span></span>
<span class="line"><span style="color:#24292e">        sync.</span><span style="color:#6f42c1">releaseShared</span><span style="color:#24292e">(</span><span style="color:#005cc5">1</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">// AQS ÁªßÊâøËøáÊù•ÁöÑÊñπÊ≥ï, Êñπ‰æøÈòÖËØª, ÊîæÂú®Ê≠§Â§Ñ</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">final</span><span style="color:#24292e"> </span><span style="color:#d73a49">boolean</span><span style="color:#24292e"> </span><span style="color:#6f42c1">releaseShared</span><span style="color:#24292e">(</span><span style="color:#d73a49">int</span><span style="color:#24292e"> </span><span style="color:#e36209">arg</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (</span><span style="color:#6f42c1">tryReleaseShared</span><span style="color:#24292e">(arg)) {</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#6f42c1">doReleaseShared</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">return</span><span style="color:#24292e"> </span><span style="color:#005cc5">true</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">        }</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">return</span><span style="color:#24292e"> </span><span style="color:#005cc5">false</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">// Sync ÁªßÊâøËøáÊù•ÁöÑÊñπÊ≥ï, Êñπ‰æøÈòÖËØª, ÊîæÂú®Ê≠§Â§Ñ</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">protected</span><span style="color:#24292e"> </span><span style="color:#d73a49">final</span><span style="color:#24292e"> </span><span style="color:#d73a49">boolean</span><span style="color:#24292e"> </span><span style="color:#6f42c1">tryReleaseShared</span><span style="color:#24292e">(</span><span style="color:#d73a49">int</span><span style="color:#24292e"> </span><span style="color:#e36209">unused</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6a737d">// ... ÁúÅÁï•‰∏çÈáçË¶ÅÁöÑ‰ª£Á†Å</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">for</span><span style="color:#24292e"> (;;) {</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">int</span><span style="color:#24292e"> c </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#6f42c1">getState</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">int</span><span style="color:#24292e"> nextc </span><span style="color:#d73a49">=</span><span style="color:#24292e"> c </span><span style="color:#d73a49">-</span><span style="color:#24292e"> SHARED_UNIT;</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (</span><span style="color:#6f42c1">compareAndSetState</span><span style="color:#24292e">(c, nextc)) {</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#6a737d">// ËØªÈîÅÁöÑËÆ°Êï∞‰∏ç‰ºöÂΩ±ÂìçÂÖ∂ÂÆÉËé∑ÂèñËØªÈîÅÁ∫øÁ®ã, ‰ΩÜ‰ºöÂΩ±ÂìçÂÖ∂ÂÆÉËé∑ÂèñÂÜôÈîÅÁ∫øÁ®ã</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#6a737d">// ËÆ°Êï∞‰∏∫ 0 ÊâçÊòØÁúüÊ≠£ÈáäÊîæ</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#d73a49">return</span><span style="color:#24292e"> nextc </span><span style="color:#d73a49">==</span><span style="color:#24292e"> </span><span style="color:#005cc5">0</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">            }</span></span>
<span class="line"><span style="color:#24292e">        }</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">// AQS ÁªßÊâøËøáÊù•ÁöÑÊñπÊ≥ï, Êñπ‰æøÈòÖËØª, ÊîæÂú®Ê≠§Â§Ñ</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">private</span><span style="color:#24292e"> </span><span style="color:#d73a49">void</span><span style="color:#24292e"> </span><span style="color:#6f42c1">doReleaseShared</span><span style="color:#24292e">() {</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6a737d">// Â¶ÇÊûú head.waitStatus == Node.SIGNAL ==&gt; 0 ÊàêÂäü, ‰∏ã‰∏Ä‰∏™ËäÇÁÇπ unpark</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6a737d">// Â¶ÇÊûú head.waitStatus == 0 ==&gt; Node.PROPAGATE</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">for</span><span style="color:#24292e"> (;;) {</span></span>
<span class="line"><span style="color:#24292e">            Node h </span><span style="color:#d73a49">=</span><span style="color:#24292e"> head;</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (h </span><span style="color:#d73a49">!=</span><span style="color:#24292e"> </span><span style="color:#005cc5">null</span><span style="color:#24292e"> </span><span style="color:#d73a49">&amp;&amp;</span><span style="color:#24292e"> h </span><span style="color:#d73a49">!=</span><span style="color:#24292e"> tail) {</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#d73a49">int</span><span style="color:#24292e"> ws </span><span style="color:#d73a49">=</span><span style="color:#24292e"> h.waitStatus;</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#6a737d">// Â¶ÇÊûúÊúâÂÖ∂ÂÆÉÁ∫øÁ®ã‰πüÂú®ÈáäÊîæËØªÈîÅÔºåÈÇ£‰πàÈúÄË¶ÅÂ∞Ü waitStatus ÂÖàÊîπ‰∏∫ 0</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#6a737d">// Èò≤Ê≠¢ unparkSuccessor Ë¢´Â§öÊ¨°ÊâßË°å</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (ws </span><span style="color:#d73a49">==</span><span style="color:#24292e"> Node.SIGNAL) {</span></span>
<span class="line"><span style="color:#24292e">                    </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (</span><span style="color:#d73a49">!</span><span style="color:#6f42c1">compareAndSetWaitStatus</span><span style="color:#24292e">(h, Node.SIGNAL, </span><span style="color:#005cc5">0</span><span style="color:#24292e">))</span></span>
<span class="line"><span style="color:#24292e">                        </span><span style="color:#d73a49">continue</span><span style="color:#24292e">; </span><span style="color:#6a737d">// loop to recheck cases</span></span>
<span class="line"><span style="color:#24292e">                    </span><span style="color:#6f42c1">unparkSuccessor</span><span style="color:#24292e">(h);</span></span>
<span class="line"><span style="color:#24292e">                }</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#6a737d">// Â¶ÇÊûúÂ∑≤ÁªèÊòØ 0 ‰∫ÜÔºåÊîπ‰∏∫ -3ÔºåÁî®Êù•Ëß£ÂÜ≥‰º†Êí≠ÊÄßÔºåËßÅÂêéÊñá‰ø°Âè∑Èáè bug ÂàÜÊûê</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#d73a49">else</span><span style="color:#24292e"> </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (ws </span><span style="color:#d73a49">==</span><span style="color:#24292e"> </span><span style="color:#005cc5">0</span><span style="color:#24292e"> </span><span style="color:#d73a49">&amp;&amp;</span></span>
<span class="line"><span style="color:#24292e">                        </span><span style="color:#d73a49">!</span><span style="color:#6f42c1">compareAndSetWaitStatus</span><span style="color:#24292e">(h, </span><span style="color:#005cc5">0</span><span style="color:#24292e">, Node.PROPAGATE))</span></span>
<span class="line"><span style="color:#24292e">                    </span><span style="color:#d73a49">continue</span><span style="color:#24292e">; </span><span style="color:#6a737d">// loop on failed CAS</span></span>
<span class="line"><span style="color:#24292e">            }</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (h </span><span style="color:#d73a49">==</span><span style="color:#24292e"> head) </span><span style="color:#6a737d">// loop if head changed</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#d73a49">break</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">        }</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"><span style="color:#24292e">}</span></span></code></pre></div><h4 id="stampedlock" tabindex="-1">StampedLock <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20advanced%20chapter#stampedlock" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h4><p>ËØ•Á±ªËá™ JDK 8 Âä†ÂÖ•ÔºåÊòØ‰∏∫‰∫ÜËøõ‰∏ÄÊ≠•‰ºòÂåñËØªÊÄßËÉΩÔºåÂÆÉÁöÑÁâπÁÇπÊòØÂú®‰ΩøÁî®ËØªÈîÅ„ÄÅÂÜôÈîÅÊó∂ÈÉΩÂøÖÈ°ªÈÖçÂêà„ÄêÊà≥„Äë‰ΩøÁî®</p><p>Âä†Ëß£ËØªÈîÅ</p><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#f97583">long</span><span style="color:#e1e4e8"> stamp </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> lock.</span><span style="color:#b392f0">readLock</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">lock.</span><span style="color:#b392f0">unlockRead</span><span style="color:#e1e4e8">(stamp);</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#d73a49">long</span><span style="color:#24292e"> stamp </span><span style="color:#d73a49">=</span><span style="color:#24292e"> lock.</span><span style="color:#6f42c1">readLock</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">lock.</span><span style="color:#6f42c1">unlockRead</span><span style="color:#24292e">(stamp);</span></span></code></pre></div><p>Âä†Ëß£ÂÜôÈîÅ</p><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#f97583">long</span><span style="color:#e1e4e8"> stamp </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> lock.</span><span style="color:#b392f0">writeLock</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">lock.</span><span style="color:#b392f0">unlockWrite</span><span style="color:#e1e4e8">(stamp);</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#d73a49">long</span><span style="color:#24292e"> stamp </span><span style="color:#d73a49">=</span><span style="color:#24292e"> lock.</span><span style="color:#6f42c1">writeLock</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">lock.</span><span style="color:#6f42c1">unlockWrite</span><span style="color:#24292e">(stamp);</span></span></code></pre></div><p>‰πêËßÇËØªÔºåStampedLock ÊîØÊåÅ tryOptimisticRead() ÊñπÊ≥ïÔºà‰πêËßÇËØªÔºâÔºåËØªÂèñÂÆåÊØïÂêéÈúÄË¶ÅÂÅö‰∏ÄÊ¨° Êà≥Ê†°È™å Â¶ÇÊûúÊ†°È™åÈÄö ËøáÔºåË°®Á§∫ËøôÊúüÈó¥Á°ÆÂÆûÊ≤°ÊúâÂÜôÊìç‰ΩúÔºåÊï∞ÊçÆÂèØ‰ª•ÂÆâÂÖ®‰ΩøÁî®ÔºåÂ¶ÇÊûúÊ†°È™åÊ≤°ÈÄöËøáÔºåÈúÄË¶ÅÈáçÊñ∞Ëé∑ÂèñËØªÈîÅÔºå‰øùËØÅÊï∞ÊçÆÂÆâÂÖ®„ÄÇ</p><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#f97583">long</span><span style="color:#e1e4e8"> stamp </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> lock.</span><span style="color:#b392f0">tryOptimisticRead</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#6a737d">// È™åÊà≥</span></span>
<span class="line"><span style="color:#f97583">if</span><span style="color:#e1e4e8">(</span><span style="color:#f97583">!</span><span style="color:#e1e4e8">lock.</span><span style="color:#b392f0">validate</span><span style="color:#e1e4e8">(stamp)){</span></span>
<span class="line"><span style="color:#e1e4e8"> </span><span style="color:#6a737d">// ÈîÅÂçáÁ∫ß</span></span>
<span class="line"><span style="color:#e1e4e8">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#d73a49">long</span><span style="color:#24292e"> stamp </span><span style="color:#d73a49">=</span><span style="color:#24292e"> lock.</span><span style="color:#6f42c1">tryOptimisticRead</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#6a737d">// È™åÊà≥</span></span>
<span class="line"><span style="color:#d73a49">if</span><span style="color:#24292e">(</span><span style="color:#d73a49">!</span><span style="color:#24292e">lock.</span><span style="color:#6f42c1">validate</span><span style="color:#24292e">(stamp)){</span></span>
<span class="line"><span style="color:#24292e"> </span><span style="color:#6a737d">// ÈîÅÂçáÁ∫ß</span></span>
<span class="line"><span style="color:#24292e">}</span></span></code></pre></div><p>Êèê‰æõ‰∏Ä‰∏™ Êï∞ÊçÆÂÆπÂô®Á±ª ÂÜÖÈÉ®ÂàÜÂà´‰ΩøÁî®ËØªÈîÅ‰øùÊä§Êï∞ÊçÆÁöÑ read() ÊñπÊ≥ïÔºåÂÜôÈîÅ‰øùÊä§Êï∞ÊçÆÁöÑ write() ÊñπÊ≥ï</p><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8">@</span><span style="color:#f97583">Slf4j</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">topic</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#9ecbff">"c.DataContainerStamped"</span><span style="color:#e1e4e8">)</span></span>
<span class="line"><span style="color:#f97583">class</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">DataContainerStamped</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">private</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> data;</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">private</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">final</span><span style="color:#e1e4e8"> StampedLock lock </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">StampedLock</span><span style="color:#e1e4e8">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">DataContainerStamped</span><span style="color:#e1e4e8">(</span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> </span><span style="color:#ffab70">data</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#79b8ff">this</span><span style="color:#e1e4e8">.data </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> data;</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">read</span><span style="color:#e1e4e8">(</span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> </span><span style="color:#ffab70">readTime</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">long</span><span style="color:#e1e4e8"> stamp </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> lock.</span><span style="color:#b392f0">tryOptimisticRead</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">        log.</span><span style="color:#b392f0">debug</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"optimistic read locking...{}"</span><span style="color:#e1e4e8">, stamp);</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#b392f0">sleep</span><span style="color:#e1e4e8">(readTime);</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (lock.</span><span style="color:#b392f0">validate</span><span style="color:#e1e4e8">(stamp)) {</span></span>
<span class="line"><span style="color:#e1e4e8">            log.</span><span style="color:#b392f0">debug</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"read finish...{}, data:{}"</span><span style="color:#e1e4e8">, stamp, data);</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> data;</span></span>
<span class="line"><span style="color:#e1e4e8">        }</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#6a737d">// ÈîÅÂçáÁ∫ß - ËØªÈîÅ</span></span>
<span class="line"><span style="color:#e1e4e8">        log.</span><span style="color:#b392f0">debug</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"updating to read lock... {}"</span><span style="color:#e1e4e8">, stamp);</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">try</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">            stamp </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> lock.</span><span style="color:#b392f0">readLock</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">            log.</span><span style="color:#b392f0">debug</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"read lock {}"</span><span style="color:#e1e4e8">, stamp);</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#b392f0">sleep</span><span style="color:#e1e4e8">(readTime);</span></span>
<span class="line"><span style="color:#e1e4e8">            log.</span><span style="color:#b392f0">debug</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"read finish...{}, data:{}"</span><span style="color:#e1e4e8">, stamp, data);</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> data;</span></span>
<span class="line"><span style="color:#e1e4e8">        } </span><span style="color:#f97583">finally</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">            log.</span><span style="color:#b392f0">debug</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"read unlock {}"</span><span style="color:#e1e4e8">, stamp);</span></span>
<span class="line"><span style="color:#e1e4e8">            lock.</span><span style="color:#b392f0">unlockRead</span><span style="color:#e1e4e8">(stamp);</span></span>
<span class="line"><span style="color:#e1e4e8">        }</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">void</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">write</span><span style="color:#e1e4e8">(</span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> </span><span style="color:#ffab70">newData</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">long</span><span style="color:#e1e4e8"> stamp </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> lock.</span><span style="color:#b392f0">writeLock</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">        log.</span><span style="color:#b392f0">debug</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"write lock {}"</span><span style="color:#e1e4e8">, stamp);</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">try</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#b392f0">sleep</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">2</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#79b8ff">this</span><span style="color:#e1e4e8">.data </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> newData;</span></span>
<span class="line"><span style="color:#e1e4e8">        } </span><span style="color:#f97583">finally</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">            log.</span><span style="color:#b392f0">debug</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"write unlock {}"</span><span style="color:#e1e4e8">, stamp);</span></span>
<span class="line"><span style="color:#e1e4e8">            lock.</span><span style="color:#b392f0">unlockWrite</span><span style="color:#e1e4e8">(stamp);</span></span>
<span class="line"><span style="color:#e1e4e8">        }</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"><span style="color:#e1e4e8">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e">@</span><span style="color:#d73a49">Slf4j</span><span style="color:#24292e">(</span><span style="color:#005cc5">topic</span><span style="color:#24292e"> </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#032f62">"c.DataContainerStamped"</span><span style="color:#24292e">)</span></span>
<span class="line"><span style="color:#d73a49">class</span><span style="color:#24292e"> </span><span style="color:#6f42c1">DataContainerStamped</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">private</span><span style="color:#24292e"> </span><span style="color:#d73a49">int</span><span style="color:#24292e"> data;</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">private</span><span style="color:#24292e"> </span><span style="color:#d73a49">final</span><span style="color:#24292e"> StampedLock lock </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">StampedLock</span><span style="color:#24292e">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#6f42c1">DataContainerStamped</span><span style="color:#24292e">(</span><span style="color:#d73a49">int</span><span style="color:#24292e"> </span><span style="color:#e36209">data</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#005cc5">this</span><span style="color:#24292e">.data </span><span style="color:#d73a49">=</span><span style="color:#24292e"> data;</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">int</span><span style="color:#24292e"> </span><span style="color:#6f42c1">read</span><span style="color:#24292e">(</span><span style="color:#d73a49">int</span><span style="color:#24292e"> </span><span style="color:#e36209">readTime</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">long</span><span style="color:#24292e"> stamp </span><span style="color:#d73a49">=</span><span style="color:#24292e"> lock.</span><span style="color:#6f42c1">tryOptimisticRead</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">        log.</span><span style="color:#6f42c1">debug</span><span style="color:#24292e">(</span><span style="color:#032f62">"optimistic read locking...{}"</span><span style="color:#24292e">, stamp);</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6f42c1">sleep</span><span style="color:#24292e">(readTime);</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (lock.</span><span style="color:#6f42c1">validate</span><span style="color:#24292e">(stamp)) {</span></span>
<span class="line"><span style="color:#24292e">            log.</span><span style="color:#6f42c1">debug</span><span style="color:#24292e">(</span><span style="color:#032f62">"read finish...{}, data:{}"</span><span style="color:#24292e">, stamp, data);</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">return</span><span style="color:#24292e"> data;</span></span>
<span class="line"><span style="color:#24292e">        }</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6a737d">// ÈîÅÂçáÁ∫ß - ËØªÈîÅ</span></span>
<span class="line"><span style="color:#24292e">        log.</span><span style="color:#6f42c1">debug</span><span style="color:#24292e">(</span><span style="color:#032f62">"updating to read lock... {}"</span><span style="color:#24292e">, stamp);</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">try</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">            stamp </span><span style="color:#d73a49">=</span><span style="color:#24292e"> lock.</span><span style="color:#6f42c1">readLock</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">            log.</span><span style="color:#6f42c1">debug</span><span style="color:#24292e">(</span><span style="color:#032f62">"read lock {}"</span><span style="color:#24292e">, stamp);</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#6f42c1">sleep</span><span style="color:#24292e">(readTime);</span></span>
<span class="line"><span style="color:#24292e">            log.</span><span style="color:#6f42c1">debug</span><span style="color:#24292e">(</span><span style="color:#032f62">"read finish...{}, data:{}"</span><span style="color:#24292e">, stamp, data);</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">return</span><span style="color:#24292e"> data;</span></span>
<span class="line"><span style="color:#24292e">        } </span><span style="color:#d73a49">finally</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">            log.</span><span style="color:#6f42c1">debug</span><span style="color:#24292e">(</span><span style="color:#032f62">"read unlock {}"</span><span style="color:#24292e">, stamp);</span></span>
<span class="line"><span style="color:#24292e">            lock.</span><span style="color:#6f42c1">unlockRead</span><span style="color:#24292e">(stamp);</span></span>
<span class="line"><span style="color:#24292e">        }</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">void</span><span style="color:#24292e"> </span><span style="color:#6f42c1">write</span><span style="color:#24292e">(</span><span style="color:#d73a49">int</span><span style="color:#24292e"> </span><span style="color:#e36209">newData</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">long</span><span style="color:#24292e"> stamp </span><span style="color:#d73a49">=</span><span style="color:#24292e"> lock.</span><span style="color:#6f42c1">writeLock</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">        log.</span><span style="color:#6f42c1">debug</span><span style="color:#24292e">(</span><span style="color:#032f62">"write lock {}"</span><span style="color:#24292e">, stamp);</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">try</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#6f42c1">sleep</span><span style="color:#24292e">(</span><span style="color:#005cc5">2</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#005cc5">this</span><span style="color:#24292e">.data </span><span style="color:#d73a49">=</span><span style="color:#24292e"> newData;</span></span>
<span class="line"><span style="color:#24292e">        } </span><span style="color:#d73a49">finally</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">            log.</span><span style="color:#6f42c1">debug</span><span style="color:#24292e">(</span><span style="color:#032f62">"write unlock {}"</span><span style="color:#24292e">, stamp);</span></span>
<span class="line"><span style="color:#24292e">            lock.</span><span style="color:#6f42c1">unlockWrite</span><span style="color:#24292e">(stamp);</span></span>
<span class="line"><span style="color:#24292e">        }</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"><span style="color:#24292e">}</span></span></code></pre></div><p>ÊµãËØï ËØª-ËØª ÂèØ‰ª•‰ºòÂåñ</p><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8">DataContainerStamped dataContainer </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">DataContainerStamped</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">1</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Thread</span><span style="color:#e1e4e8">(() </span><span style="color:#f97583">-&gt;</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">            dataContainer.</span><span style="color:#b392f0">read</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">1</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">        }, </span><span style="color:#9ecbff">"t1"</span><span style="color:#e1e4e8">).</span><span style="color:#b392f0">start</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#b392f0">sleep</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">0.5</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Thread</span><span style="color:#e1e4e8">(() </span><span style="color:#f97583">-&gt;</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">            dataContainer.</span><span style="color:#b392f0">read</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">        }, </span><span style="color:#9ecbff">"t2"</span><span style="color:#e1e4e8">).</span><span style="color:#b392f0">start</span><span style="color:#e1e4e8">();</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e">DataContainerStamped dataContainer </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">DataContainerStamped</span><span style="color:#24292e">(</span><span style="color:#005cc5">1</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Thread</span><span style="color:#24292e">(() </span><span style="color:#d73a49">-&gt;</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">            dataContainer.</span><span style="color:#6f42c1">read</span><span style="color:#24292e">(</span><span style="color:#005cc5">1</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">        }, </span><span style="color:#032f62">"t1"</span><span style="color:#24292e">).</span><span style="color:#6f42c1">start</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6f42c1">sleep</span><span style="color:#24292e">(</span><span style="color:#005cc5">0.5</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Thread</span><span style="color:#24292e">(() </span><span style="color:#d73a49">-&gt;</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">            dataContainer.</span><span style="color:#6f42c1">read</span><span style="color:#24292e">(</span><span style="color:#005cc5">0</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">        }, </span><span style="color:#032f62">"t2"</span><span style="color:#24292e">).</span><span style="color:#6f42c1">start</span><span style="color:#24292e">();</span></span></code></pre></div><figure><img src="https://jsd.cdn.zzko.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230719203658874.png" alt="image-20230719203658874" loading="lazy" decoding="async"></figure><p>ÊµãËØï ËØª-ÂÜô Êó∂‰ºòÂåñËØªË°•Âä†ËØªÈîÅ</p><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">static</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">void</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">main</span><span style="color:#e1e4e8">(</span><span style="color:#f97583">String</span><span style="color:#e1e4e8">[] args) {</span></span>
<span class="line"><span style="color:#e1e4e8">DataContainerStamped dataContainer </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">DataContainerStamped</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">1</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Thread</span><span style="color:#e1e4e8">(() </span><span style="color:#f97583">-&gt;</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">dataContainer.</span><span style="color:#b392f0">read</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">1</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">}, </span><span style="color:#9ecbff">"t1"</span><span style="color:#e1e4e8">).</span><span style="color:#b392f0">start</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#b392f0">sleep</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">0.5</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Thread</span><span style="color:#e1e4e8">(() </span><span style="color:#f97583">-&gt;</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">dataContainer.</span><span style="color:#b392f0">write</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">100</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">}, </span><span style="color:#9ecbff">"t2"</span><span style="color:#e1e4e8">).</span><span style="color:#b392f0">start</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">static</span><span style="color:#24292e"> </span><span style="color:#d73a49">void</span><span style="color:#24292e"> </span><span style="color:#6f42c1">main</span><span style="color:#24292e">(</span><span style="color:#d73a49">String</span><span style="color:#24292e">[] args) {</span></span>
<span class="line"><span style="color:#24292e">DataContainerStamped dataContainer </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">DataContainerStamped</span><span style="color:#24292e">(</span><span style="color:#005cc5">1</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Thread</span><span style="color:#24292e">(() </span><span style="color:#d73a49">-&gt;</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">dataContainer.</span><span style="color:#6f42c1">read</span><span style="color:#24292e">(</span><span style="color:#005cc5">1</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">}, </span><span style="color:#032f62">"t1"</span><span style="color:#24292e">).</span><span style="color:#6f42c1">start</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#6f42c1">sleep</span><span style="color:#24292e">(</span><span style="color:#005cc5">0.5</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Thread</span><span style="color:#24292e">(() </span><span style="color:#d73a49">-&gt;</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">dataContainer.</span><span style="color:#6f42c1">write</span><span style="color:#24292e">(</span><span style="color:#005cc5">100</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">}, </span><span style="color:#032f62">"t2"</span><span style="color:#24292e">).</span><span style="color:#6f42c1">start</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">}</span></span></code></pre></div><figure><img src="https://jsd.cdn.zzko.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230719203736562.png" alt="image-20230719203736562" loading="lazy" decoding="async"></figure><blockquote><p><strong>Ê≥®ÊÑè</strong></p><ul><li>StampedLock ‰∏çÊîØÊåÅÊù°‰ª∂ÂèòÈáè</li><li>StampedLock ‰∏çÊîØÊåÅÂèØÈáçÂÖ•</li></ul></blockquote><h3 id="_4„ÄÅsemaphore" tabindex="-1">4„ÄÅSemaphore <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20advanced%20chapter#_4„ÄÅsemaphore" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h3><h4 id="Âü∫Êú¨‰ΩøÁî®" tabindex="-1">Âü∫Êú¨‰ΩøÁî® <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20advanced%20chapter#Âü∫Êú¨‰ΩøÁî®" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h4><p><code>[Ààs…õm…ôÀåf…îr]</code>‰ø°Âè∑ÈáèÔºåÁî®Êù•ÈôêÂà∂ËÉΩÂêåÊó∂ËÆøÈóÆÂÖ±‰∫´ËµÑÊ∫êÁöÑÁ∫øÁ®ã‰∏äÈôê„ÄÇ</p><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">static</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">void</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">main</span><span style="color:#e1e4e8">(</span><span style="color:#f97583">String</span><span style="color:#e1e4e8">[] args) {</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#6a737d">// 1. ÂàõÂª∫ semaphore ÂØπË±°</span></span>
<span class="line"><span style="color:#e1e4e8">        Semaphore semaphore </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Semaphore</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">3</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#6a737d">// 2. 10‰∏™Á∫øÁ®ãÂêåÊó∂ËøêË°å</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">for</span><span style="color:#e1e4e8"> (</span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> i </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8">; i </span><span style="color:#f97583">&lt;</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">10</span><span style="color:#e1e4e8">; i</span><span style="color:#f97583">++</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Thread</span><span style="color:#e1e4e8">(() </span><span style="color:#f97583">-&gt;</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#6a737d">// 3. Ëé∑ÂèñËÆ∏ÂèØ</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#f97583">try</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">                    semaphore.</span><span style="color:#b392f0">acquire</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">                } </span><span style="color:#f97583">catch</span><span style="color:#e1e4e8"> (InterruptedException </span><span style="color:#ffab70">e</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">                    e.</span><span style="color:#b392f0">printStackTrace</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">                }</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#f97583">try</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">                    log.</span><span style="color:#b392f0">debug</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"running..."</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">                    </span><span style="color:#b392f0">sleep</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">1</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">                    log.</span><span style="color:#b392f0">debug</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"end..."</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">                } </span><span style="color:#f97583">finally</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">                    </span><span style="color:#6a737d">// 4. ÈáäÊîæËÆ∏ÂèØ</span></span>
<span class="line"><span style="color:#e1e4e8">                    semaphore.</span><span style="color:#b392f0">release</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">                }</span></span>
<span class="line"><span style="color:#e1e4e8">            }).</span><span style="color:#b392f0">start</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">        }</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">static</span><span style="color:#24292e"> </span><span style="color:#d73a49">void</span><span style="color:#24292e"> </span><span style="color:#6f42c1">main</span><span style="color:#24292e">(</span><span style="color:#d73a49">String</span><span style="color:#24292e">[] args) {</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6a737d">// 1. ÂàõÂª∫ semaphore ÂØπË±°</span></span>
<span class="line"><span style="color:#24292e">        Semaphore semaphore </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Semaphore</span><span style="color:#24292e">(</span><span style="color:#005cc5">3</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6a737d">// 2. 10‰∏™Á∫øÁ®ãÂêåÊó∂ËøêË°å</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">for</span><span style="color:#24292e"> (</span><span style="color:#d73a49">int</span><span style="color:#24292e"> i </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#005cc5">0</span><span style="color:#24292e">; i </span><span style="color:#d73a49">&lt;</span><span style="color:#24292e"> </span><span style="color:#005cc5">10</span><span style="color:#24292e">; i</span><span style="color:#d73a49">++</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Thread</span><span style="color:#24292e">(() </span><span style="color:#d73a49">-&gt;</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#6a737d">// 3. Ëé∑ÂèñËÆ∏ÂèØ</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#d73a49">try</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">                    semaphore.</span><span style="color:#6f42c1">acquire</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">                } </span><span style="color:#d73a49">catch</span><span style="color:#24292e"> (InterruptedException </span><span style="color:#e36209">e</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">                    e.</span><span style="color:#6f42c1">printStackTrace</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">                }</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#d73a49">try</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">                    log.</span><span style="color:#6f42c1">debug</span><span style="color:#24292e">(</span><span style="color:#032f62">"running..."</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">                    </span><span style="color:#6f42c1">sleep</span><span style="color:#24292e">(</span><span style="color:#005cc5">1</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">                    log.</span><span style="color:#6f42c1">debug</span><span style="color:#24292e">(</span><span style="color:#032f62">"end..."</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">                } </span><span style="color:#d73a49">finally</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">                    </span><span style="color:#6a737d">// 4. ÈáäÊîæËÆ∏ÂèØ</span></span>
<span class="line"><span style="color:#24292e">                    semaphore.</span><span style="color:#6f42c1">release</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">                }</span></span>
<span class="line"><span style="color:#24292e">            }).</span><span style="color:#6f42c1">start</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">        }</span></span>
<span class="line"><span style="color:#24292e">    }</span></span></code></pre></div><figure><img src="https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230719204835660.png" alt="image-20230719204835660" loading="lazy" decoding="async"></figure><h4 id="semaphore-Â∫îÁî®" tabindex="-1">Semaphore Â∫îÁî® <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20advanced%20chapter#semaphore-Â∫îÁî®" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h4><ul><li>‰ΩøÁî® Semaphore ÈôêÊµÅÔºåÂú®ËÆøÈóÆÈ´òÂ≥∞ÊúüÊó∂ÔºåËÆ©ËØ∑Ê±ÇÁ∫øÁ®ãÈòªÂ°ûÔºåÈ´òÂ≥∞ÊúüËøáÂéªÂÜçÈáäÊîæËÆ∏ÂèØÔºåÂΩìÁÑ∂ÂÆÉÂè™ÈÄÇÂêàÈôêÂà∂ÂçïÊú∫Á∫øÁ®ãÊï∞ÈáèÔºåÂπ∂‰∏î‰ªÖÊòØÈôêÂà∂Á∫øÁ®ãÊï∞ÔºåËÄå‰∏çÊòØÈôêÂà∂ËµÑÊ∫êÊï∞Ôºà‰æãÂ¶ÇËøûÊé•Êï∞ÔºåËØ∑ÂØπÊØî Tomcat LimitLatch ÁöÑÂÆûÁé∞Ôºâ</li><li>Áî® Semaphore ÂÆûÁé∞ÁÆÄÂçïËøûÊé•Ê±†ÔºåÂØπÊØî„Äé‰∫´ÂÖÉÊ®°Âºè„Äè‰∏ãÁöÑÂÆûÁé∞ÔºàÁî®wait notifyÔºâÔºåÊÄßËÉΩÂíåÂèØËØªÊÄßÊòæÁÑ∂Êõ¥Â•ΩÔºåÊ≥®ÊÑè‰∏ãÈù¢ÁöÑÂÆûÁé∞‰∏≠Á∫øÁ®ãÊï∞ÂíåÊï∞ÊçÆÂ∫ìËøûÊé•Êï∞ÊòØÁõ∏Á≠âÁöÑ</li></ul><p>‰øÆÊîπ‰πãÂâçÁ¨¨‰∏ÉÁ´†ÁöÑËøûÊé•Ê±†‰ª£Á†Å</p><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8">@</span><span style="color:#f97583">Slf4j</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">topic</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#9ecbff">"c.Pool"</span><span style="color:#e1e4e8">)</span></span>
<span class="line"><span style="color:#f97583">class</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Pool</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">// 1. ËøûÊé•Ê±†Â§ßÂ∞è</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">private</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">final</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> poolSize;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">// 2. ËøûÊé•ÂØπË±°Êï∞ÁªÑ</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">private</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">Connection</span><span style="color:#e1e4e8">[] connections;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">// 3. ËøûÊé•Áä∂ÊÄÅÊï∞ÁªÑ 0 Ë°®Á§∫Á©∫Èó≤Ôºå 1 Ë°®Á§∫ÁπÅÂøô</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">private</span><span style="color:#e1e4e8"> AtomicIntegerArray states;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">private</span><span style="color:#e1e4e8"> Semaphore semaphore;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">// 4. ÊûÑÈÄ†ÊñπÊ≥ïÂàùÂßãÂåñ</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Pool</span><span style="color:#e1e4e8">(</span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> </span><span style="color:#ffab70">poolSize</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#79b8ff">this</span><span style="color:#e1e4e8">.poolSize </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> poolSize;</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#6a737d">// ËÆ©ËÆ∏ÂèØÊï∞‰∏éËµÑÊ∫êÊï∞‰∏ÄËá¥</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#79b8ff">this</span><span style="color:#e1e4e8">.semaphore </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Semaphore</span><span style="color:#e1e4e8">(poolSize);</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#79b8ff">this</span><span style="color:#e1e4e8">.connections </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">Connection</span><span style="color:#e1e4e8">[poolSize];</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#79b8ff">this</span><span style="color:#e1e4e8">.states </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">AtomicIntegerArray</span><span style="color:#e1e4e8">(</span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">int</span><span style="color:#e1e4e8">[poolSize]);</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">for</span><span style="color:#e1e4e8"> (</span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> i </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8">; i </span><span style="color:#f97583">&lt;</span><span style="color:#e1e4e8"> poolSize; i</span><span style="color:#f97583">++</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">            connections[i] </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">MockConnection</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"ËøûÊé•"</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">+</span><span style="color:#e1e4e8"> (i</span><span style="color:#f97583">+</span><span style="color:#79b8ff">1</span><span style="color:#e1e4e8">));</span></span>
<span class="line"><span style="color:#e1e4e8">        }</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">// 5. ÂÄüËøûÊé•</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">public</span><span style="color:#e1e4e8"> Connection </span><span style="color:#b392f0">borrow</span><span style="color:#e1e4e8">() {</span><span style="color:#6a737d">// t1, t2, t3</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#6a737d">// Ëé∑ÂèñËÆ∏ÂèØ</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">try</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">            semaphore.</span><span style="color:#b392f0">acquire</span><span style="color:#e1e4e8">(); </span><span style="color:#6a737d">// Ê≤°ÊúâËÆ∏ÂèØÁöÑÁ∫øÁ®ãÔºåÂú®Ê≠§Á≠âÂæÖ</span></span>
<span class="line"><span style="color:#e1e4e8">        } </span><span style="color:#f97583">catch</span><span style="color:#e1e4e8"> (InterruptedException </span><span style="color:#ffab70">e</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">            e.</span><span style="color:#b392f0">printStackTrace</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">        }</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">for</span><span style="color:#e1e4e8"> (</span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> i </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8">; i </span><span style="color:#f97583">&lt;</span><span style="color:#e1e4e8"> poolSize; i</span><span style="color:#f97583">++</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#6a737d">// Ëé∑ÂèñÁ©∫Èó≤ËøûÊé•</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">if</span><span style="color:#e1e4e8">(states.</span><span style="color:#b392f0">get</span><span style="color:#e1e4e8">(i) </span><span style="color:#f97583">==</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (states.</span><span style="color:#b392f0">compareAndSet</span><span style="color:#e1e4e8">(i, </span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8">, </span><span style="color:#79b8ff">1</span><span style="color:#e1e4e8">)) {</span></span>
<span class="line"><span style="color:#e1e4e8">                    log.</span><span style="color:#b392f0">debug</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"borrow {}"</span><span style="color:#e1e4e8">, connections[i]);</span></span>
<span class="line"><span style="color:#e1e4e8">                    </span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> connections[i];</span></span>
<span class="line"><span style="color:#e1e4e8">                }</span></span>
<span class="line"><span style="color:#e1e4e8">            }</span></span>
<span class="line"><span style="color:#e1e4e8">        }</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#6a737d">// ‰∏ç‰ºöÊâßË°åÂà∞ËøôÈáå</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">// 6. ÂΩíËøòËøûÊé•</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">void</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">free</span><span style="color:#e1e4e8">(Connection </span><span style="color:#ffab70">conn</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">for</span><span style="color:#e1e4e8"> (</span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> i </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8">; i </span><span style="color:#f97583">&lt;</span><span style="color:#e1e4e8"> poolSize; i</span><span style="color:#f97583">++</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (connections[i] </span><span style="color:#f97583">==</span><span style="color:#e1e4e8"> conn) {</span></span>
<span class="line"><span style="color:#e1e4e8">                states.</span><span style="color:#b392f0">set</span><span style="color:#e1e4e8">(i, </span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">                log.</span><span style="color:#b392f0">debug</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"free {}"</span><span style="color:#e1e4e8">, conn);</span></span>
<span class="line"><span style="color:#e1e4e8">                semaphore.</span><span style="color:#b392f0">release</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#f97583">break</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">            }</span></span>
<span class="line"><span style="color:#e1e4e8">        }</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"><span style="color:#e1e4e8">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e">@</span><span style="color:#d73a49">Slf4j</span><span style="color:#24292e">(</span><span style="color:#005cc5">topic</span><span style="color:#24292e"> </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#032f62">"c.Pool"</span><span style="color:#24292e">)</span></span>
<span class="line"><span style="color:#d73a49">class</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Pool</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">// 1. ËøûÊé•Ê±†Â§ßÂ∞è</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">private</span><span style="color:#24292e"> </span><span style="color:#d73a49">final</span><span style="color:#24292e"> </span><span style="color:#d73a49">int</span><span style="color:#24292e"> poolSize;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">// 2. ËøûÊé•ÂØπË±°Êï∞ÁªÑ</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">private</span><span style="color:#24292e"> </span><span style="color:#d73a49">Connection</span><span style="color:#24292e">[] connections;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">// 3. ËøûÊé•Áä∂ÊÄÅÊï∞ÁªÑ 0 Ë°®Á§∫Á©∫Èó≤Ôºå 1 Ë°®Á§∫ÁπÅÂøô</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">private</span><span style="color:#24292e"> AtomicIntegerArray states;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">private</span><span style="color:#24292e"> Semaphore semaphore;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">// 4. ÊûÑÈÄ†ÊñπÊ≥ïÂàùÂßãÂåñ</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Pool</span><span style="color:#24292e">(</span><span style="color:#d73a49">int</span><span style="color:#24292e"> </span><span style="color:#e36209">poolSize</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#005cc5">this</span><span style="color:#24292e">.poolSize </span><span style="color:#d73a49">=</span><span style="color:#24292e"> poolSize;</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6a737d">// ËÆ©ËÆ∏ÂèØÊï∞‰∏éËµÑÊ∫êÊï∞‰∏ÄËá¥</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#005cc5">this</span><span style="color:#24292e">.semaphore </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Semaphore</span><span style="color:#24292e">(poolSize);</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#005cc5">this</span><span style="color:#24292e">.connections </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#d73a49">Connection</span><span style="color:#24292e">[poolSize];</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#005cc5">this</span><span style="color:#24292e">.states </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">AtomicIntegerArray</span><span style="color:#24292e">(</span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#d73a49">int</span><span style="color:#24292e">[poolSize]);</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">for</span><span style="color:#24292e"> (</span><span style="color:#d73a49">int</span><span style="color:#24292e"> i </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#005cc5">0</span><span style="color:#24292e">; i </span><span style="color:#d73a49">&lt;</span><span style="color:#24292e"> poolSize; i</span><span style="color:#d73a49">++</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">            connections[i] </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">MockConnection</span><span style="color:#24292e">(</span><span style="color:#032f62">"ËøûÊé•"</span><span style="color:#24292e"> </span><span style="color:#d73a49">+</span><span style="color:#24292e"> (i</span><span style="color:#d73a49">+</span><span style="color:#005cc5">1</span><span style="color:#24292e">));</span></span>
<span class="line"><span style="color:#24292e">        }</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">// 5. ÂÄüËøûÊé•</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">public</span><span style="color:#24292e"> Connection </span><span style="color:#6f42c1">borrow</span><span style="color:#24292e">() {</span><span style="color:#6a737d">// t1, t2, t3</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6a737d">// Ëé∑ÂèñËÆ∏ÂèØ</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">try</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">            semaphore.</span><span style="color:#6f42c1">acquire</span><span style="color:#24292e">(); </span><span style="color:#6a737d">// Ê≤°ÊúâËÆ∏ÂèØÁöÑÁ∫øÁ®ãÔºåÂú®Ê≠§Á≠âÂæÖ</span></span>
<span class="line"><span style="color:#24292e">        } </span><span style="color:#d73a49">catch</span><span style="color:#24292e"> (InterruptedException </span><span style="color:#e36209">e</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">            e.</span><span style="color:#6f42c1">printStackTrace</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">        }</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">for</span><span style="color:#24292e"> (</span><span style="color:#d73a49">int</span><span style="color:#24292e"> i </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#005cc5">0</span><span style="color:#24292e">; i </span><span style="color:#d73a49">&lt;</span><span style="color:#24292e"> poolSize; i</span><span style="color:#d73a49">++</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#6a737d">// Ëé∑ÂèñÁ©∫Èó≤ËøûÊé•</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">if</span><span style="color:#24292e">(states.</span><span style="color:#6f42c1">get</span><span style="color:#24292e">(i) </span><span style="color:#d73a49">==</span><span style="color:#24292e"> </span><span style="color:#005cc5">0</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (states.</span><span style="color:#6f42c1">compareAndSet</span><span style="color:#24292e">(i, </span><span style="color:#005cc5">0</span><span style="color:#24292e">, </span><span style="color:#005cc5">1</span><span style="color:#24292e">)) {</span></span>
<span class="line"><span style="color:#24292e">                    log.</span><span style="color:#6f42c1">debug</span><span style="color:#24292e">(</span><span style="color:#032f62">"borrow {}"</span><span style="color:#24292e">, connections[i]);</span></span>
<span class="line"><span style="color:#24292e">                    </span><span style="color:#d73a49">return</span><span style="color:#24292e"> connections[i];</span></span>
<span class="line"><span style="color:#24292e">                }</span></span>
<span class="line"><span style="color:#24292e">            }</span></span>
<span class="line"><span style="color:#24292e">        }</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6a737d">// ‰∏ç‰ºöÊâßË°åÂà∞ËøôÈáå</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">return</span><span style="color:#24292e"> </span><span style="color:#005cc5">null</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">// 6. ÂΩíËøòËøûÊé•</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">void</span><span style="color:#24292e"> </span><span style="color:#6f42c1">free</span><span style="color:#24292e">(Connection </span><span style="color:#e36209">conn</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">for</span><span style="color:#24292e"> (</span><span style="color:#d73a49">int</span><span style="color:#24292e"> i </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#005cc5">0</span><span style="color:#24292e">; i </span><span style="color:#d73a49">&lt;</span><span style="color:#24292e"> poolSize; i</span><span style="color:#d73a49">++</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (connections[i] </span><span style="color:#d73a49">==</span><span style="color:#24292e"> conn) {</span></span>
<span class="line"><span style="color:#24292e">                states.</span><span style="color:#6f42c1">set</span><span style="color:#24292e">(i, </span><span style="color:#005cc5">0</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">                log.</span><span style="color:#6f42c1">debug</span><span style="color:#24292e">(</span><span style="color:#032f62">"free {}"</span><span style="color:#24292e">, conn);</span></span>
<span class="line"><span style="color:#24292e">                semaphore.</span><span style="color:#6f42c1">release</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#d73a49">break</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">            }</span></span>
<span class="line"><span style="color:#24292e">        }</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"><span style="color:#24292e">}</span></span></code></pre></div><h4 id="semaphore-ÂéüÁêÜ" tabindex="-1">Semaphore ÂéüÁêÜ <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20advanced%20chapter#semaphore-ÂéüÁêÜ" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h4><h5 id="Âä†ÈîÅËß£ÈîÅÊµÅÁ®ã-1" tabindex="-1">Âä†ÈîÅËß£ÈîÅÊµÅÁ®ã <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20advanced%20chapter#Âä†ÈîÅËß£ÈîÅÊµÅÁ®ã-1" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h5><p>Semaphore ÊúâÁÇπÂÉè‰∏Ä‰∏™ÂÅúËΩ¶Âú∫Ôºåpermits Â∞±Â•ΩÂÉèÂÅúËΩ¶‰ΩçÊï∞ÈáèÔºåÂΩìÁ∫øÁ®ãËé∑Âæó‰∫Ü permits Â∞±ÂÉèÊòØËé∑Âæó‰∫ÜÂÅúËΩ¶‰ΩçÔºåÁÑ∂Âêé ÂÅúËΩ¶Âú∫ÊòæÁ§∫Á©∫‰ΩôËΩ¶‰ΩçÂáè‰∏Ä ÂàöÂºÄÂßãÔºåpermitsÔºàstateÔºâ‰∏∫ 3ÔºåËøôÊó∂ 5 ‰∏™Á∫øÁ®ãÊù•Ëé∑ÂèñËµÑÊ∫ê</p><figure><img src="https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230719211330596.png" alt="image-20230719211330596" loading="lazy" decoding="async"></figure><p>ÂÅáËÆæÂÖ∂‰∏≠ Thread-1ÔºåThread-2ÔºåThread-4 cas Á´û‰∫âÊàêÂäüÔºåËÄå Thread-0 Âíå Thread-3 Á´û‰∫âÂ§±Ë¥•ÔºåËøõÂÖ• AQS ÈòüÂàó park ÈòªÂ°û</p><figure><img src="https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230719211343768.png" alt="image-20230719211343768" loading="lazy" decoding="async"></figure><p>ËøôÊó∂ Thread-4 ÈáäÊîæ‰∫Ü permitsÔºåÁä∂ÊÄÅÂ¶Ç‰∏ã</p><figure><img src="https://jsd.cdn.zzko.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230719211353401.png" alt="image-20230719211353401" loading="lazy" decoding="async"></figure><p>Êé•‰∏ãÊù• Thread-0 Á´û‰∫âÊàêÂäüÔºåpermits ÂÜçÊ¨°ËÆæÁΩÆ‰∏∫ 0ÔºåËÆæÁΩÆËá™Â∑±‰∏∫ head ËäÇÁÇπÔºåÊñ≠ÂºÄÂéüÊù•ÁöÑ head ËäÇÁÇπÔºåunpark Êé• ‰∏ãÊù•ÁöÑ Thread-3 ËäÇÁÇπÔºå‰ΩÜÁî±‰∫é permits ÊòØ 0ÔºåÂõ†Ê≠§ Thread-3 Âú®Â∞ùËØï‰∏çÊàêÂäüÂêéÂÜçÊ¨°ËøõÂÖ• park Áä∂ÊÄÅ</p><figure><img src="https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230719211405162.png" alt="image-20230719211405162" loading="lazy" decoding="async"></figure><h5 id="Ê∫êÁ†ÅÂàÜÊûê-2" tabindex="-1">Ê∫êÁ†ÅÂàÜÊûê <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20advanced%20chapter#Ê∫êÁ†ÅÂàÜÊûê-2" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h5><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#f97583">static</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">final</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">class</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">NonfairSync</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">extends</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Sync</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">private</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">static</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">final</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">long</span><span style="color:#e1e4e8"> serialVersionUID </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">-</span><span style="color:#79b8ff">2694183684443567898L</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#b392f0">NonfairSync</span><span style="color:#e1e4e8">(</span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> </span><span style="color:#ffab70">permits</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#6a737d">// permits Âç≥ state</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#79b8ff">super</span><span style="color:#e1e4e8">(permits);</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">// Semaphore ÊñπÊ≥ï, Êñπ‰æøÈòÖËØª, ÊîæÂú®Ê≠§Â§Ñ</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">void</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">acquire</span><span style="color:#e1e4e8">() </span><span style="color:#f97583">throws</span><span style="color:#e1e4e8"> InterruptedException {</span></span>
<span class="line"><span style="color:#e1e4e8">        sync.</span><span style="color:#b392f0">acquireSharedInterruptibly</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">1</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">// AQS ÁªßÊâøËøáÊù•ÁöÑÊñπÊ≥ï, Êñπ‰æøÈòÖËØª, ÊîæÂú®Ê≠§Â§Ñ</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">final</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">void</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">acquireSharedInterruptibly</span><span style="color:#e1e4e8">(</span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> </span><span style="color:#ffab70">arg</span><span style="color:#e1e4e8">)</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">throws</span><span style="color:#e1e4e8"> InterruptedException {</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (Thread.</span><span style="color:#b392f0">interrupted</span><span style="color:#e1e4e8">())</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">throw</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">InterruptedException</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (</span><span style="color:#b392f0">tryAcquireShared</span><span style="color:#e1e4e8">(arg) </span><span style="color:#f97583">&lt;</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8">)</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#b392f0">doAcquireSharedInterruptibly</span><span style="color:#e1e4e8">(arg);</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">// Â∞ùËØïËé∑ÂæóÂÖ±‰∫´ÈîÅ</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">protected</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">tryAcquireShared</span><span style="color:#e1e4e8">(</span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> </span><span style="color:#ffab70">acquires</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">nonfairTryAcquireShared</span><span style="color:#e1e4e8">(acquires);</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">// Sync ÁªßÊâøËøáÊù•ÁöÑÊñπÊ≥ï, Êñπ‰æøÈòÖËØª, ÊîæÂú®Ê≠§Â§Ñ</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">final</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">nonfairTryAcquireShared</span><span style="color:#e1e4e8">(</span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> </span><span style="color:#ffab70">acquires</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">for</span><span style="color:#e1e4e8"> (;;) {</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> available </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">getState</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> remaining </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> available </span><span style="color:#f97583">-</span><span style="color:#e1e4e8"> acquires;</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#6a737d">// Â¶ÇÊûúËÆ∏ÂèØÂ∑≤ÁªèÁî®ÂÆå, ËøîÂõûË¥üÊï∞, Ë°®Á§∫Ëé∑ÂèñÂ§±Ë¥•, ËøõÂÖ• doAcquireSharedInterruptibly</span></span>
<span class="line"><span style="color:#e1e4e8">                    remaining </span><span style="color:#f97583">&lt;</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">||</span></span>
<span class="line"><span style="color:#e1e4e8">                            </span><span style="color:#6a737d">// Â¶ÇÊûú cas ÈáçËØïÊàêÂäü, ËøîÂõûÊ≠£Êï∞, Ë°®Á§∫Ëé∑ÂèñÊàêÂäü</span></span>
<span class="line"><span style="color:#e1e4e8">                            </span><span style="color:#b392f0">compareAndSetState</span><span style="color:#e1e4e8">(available, remaining)</span></span>
<span class="line"><span style="color:#e1e4e8">            ) {</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> remaining;</span></span>
<span class="line"><span style="color:#e1e4e8">            }</span></span>
<span class="line"><span style="color:#e1e4e8">        }</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">// AQS ÁªßÊâøËøáÊù•ÁöÑÊñπÊ≥ï, Êñπ‰æøÈòÖËØª, ÊîæÂú®Ê≠§Â§Ñ</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">private</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">void</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">doAcquireSharedInterruptibly</span><span style="color:#e1e4e8">(</span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> </span><span style="color:#ffab70">arg</span><span style="color:#e1e4e8">) </span><span style="color:#f97583">throws</span><span style="color:#e1e4e8"> InterruptedException {</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">final</span><span style="color:#e1e4e8"> Node node </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">addWaiter</span><span style="color:#e1e4e8">(Node.SHARED);</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">boolean</span><span style="color:#e1e4e8"> failed </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">true</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">try</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">for</span><span style="color:#e1e4e8"> (;;) {</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#f97583">final</span><span style="color:#e1e4e8"> Node p </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> node.</span><span style="color:#b392f0">predecessor</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (p </span><span style="color:#f97583">==</span><span style="color:#e1e4e8"> head) {</span></span>
<span class="line"><span style="color:#e1e4e8">                    </span><span style="color:#6a737d">// ÂÜçÊ¨°Â∞ùËØïËé∑ÂèñËÆ∏ÂèØ</span></span>
<span class="line"><span style="color:#e1e4e8">                    </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> r </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">tryAcquireShared</span><span style="color:#e1e4e8">(arg);</span></span>
<span class="line"><span style="color:#e1e4e8">                    </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (r </span><span style="color:#f97583">&gt;=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">                        </span><span style="color:#6a737d">// ÊàêÂäüÂêéÊú¨Á∫øÁ®ãÂá∫ÈòüÔºàAQSÔºâ, ÊâÄÂú® NodeËÆæÁΩÆ‰∏∫ head</span></span>
<span class="line"><span style="color:#e1e4e8">                        </span><span style="color:#6a737d">// Â¶ÇÊûú head.waitStatus == Node.SIGNAL ==&gt; 0 ÊàêÂäü, ‰∏ã‰∏Ä‰∏™ËäÇÁÇπ unpark</span></span>
<span class="line"><span style="color:#e1e4e8">                        </span><span style="color:#6a737d">// Â¶ÇÊûú head.waitStatus == 0 ==&gt; Node.PROPAGATE</span></span>
<span class="line"><span style="color:#e1e4e8">					  </span><span style="color:#6a737d">// r Ë°®Á§∫ÂèØÁî®ËµÑÊ∫êÊï∞, ‰∏∫ 0 Âàô‰∏ç‰ºöÁªßÁª≠‰º†Êí≠</span></span>
<span class="line"><span style="color:#e1e4e8">                        </span><span style="color:#b392f0">setHeadAndPropagate</span><span style="color:#e1e4e8">(node, r);</span></span>
<span class="line"><span style="color:#e1e4e8">                        p.next </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8">; </span><span style="color:#6a737d">// help GC</span></span>
<span class="line"><span style="color:#e1e4e8">                        failed </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">false</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">                        </span><span style="color:#f97583">return</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">                    }</span></span>
<span class="line"><span style="color:#e1e4e8">                }</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#6a737d">// ‰∏çÊàêÂäü, ËÆæÁΩÆ‰∏ä‰∏Ä‰∏™ËäÇÁÇπ waitStatus = Node.SIGNAL, ‰∏ãËΩÆËøõÂÖ• park ÈòªÂ°û</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (</span><span style="color:#b392f0">shouldParkAfterFailedAcquire</span><span style="color:#e1e4e8">(p, node) </span><span style="color:#f97583">&amp;&amp;</span></span>
<span class="line"><span style="color:#e1e4e8">                        </span><span style="color:#b392f0">parkAndCheckInterrupt</span><span style="color:#e1e4e8">())</span></span>
<span class="line"><span style="color:#e1e4e8">                    </span><span style="color:#f97583">throw</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">InterruptedException</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">            }</span></span>
<span class="line"><span style="color:#e1e4e8">        } </span><span style="color:#f97583">finally</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (failed)</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#b392f0">cancelAcquire</span><span style="color:#e1e4e8">(node);</span></span>
<span class="line"><span style="color:#e1e4e8">        }</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">// Semaphore ÊñπÊ≥ï, Êñπ‰æøÈòÖËØª, ÊîæÂú®Ê≠§Â§Ñ</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">void</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">release</span><span style="color:#e1e4e8">() {</span></span>
<span class="line"><span style="color:#e1e4e8">        sync.</span><span style="color:#b392f0">releaseShared</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">1</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">// AQS ÁªßÊâøËøáÊù•ÁöÑÊñπÊ≥ï, Êñπ‰æøÈòÖËØª, ÊîæÂú®Ê≠§Â§Ñ</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">final</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">boolean</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">releaseShared</span><span style="color:#e1e4e8">(</span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> </span><span style="color:#ffab70">arg</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (</span><span style="color:#b392f0">tryReleaseShared</span><span style="color:#e1e4e8">(arg)) {</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#b392f0">doReleaseShared</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">true</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">        }</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">false</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">// Sync ÁªßÊâøËøáÊù•ÁöÑÊñπÊ≥ï, Êñπ‰æøÈòÖËØª, ÊîæÂú®Ê≠§Â§Ñ</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">protected</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">final</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">boolean</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">tryReleaseShared</span><span style="color:#e1e4e8">(</span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> </span><span style="color:#ffab70">releases</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">for</span><span style="color:#e1e4e8"> (;;) {</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> current </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">getState</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> next </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> current </span><span style="color:#f97583">+</span><span style="color:#e1e4e8"> releases;</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (next </span><span style="color:#f97583">&lt;</span><span style="color:#e1e4e8"> current) </span><span style="color:#6a737d">// overflow</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#f97583">throw</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Error</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"Maximum permit count exceeded"</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (</span><span style="color:#b392f0">compareAndSetState</span><span style="color:#e1e4e8">(current, next))</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">true</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">        }</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"><span style="color:#e1e4e8">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#d73a49">static</span><span style="color:#24292e"> </span><span style="color:#d73a49">final</span><span style="color:#24292e"> </span><span style="color:#d73a49">class</span><span style="color:#24292e"> </span><span style="color:#6f42c1">NonfairSync</span><span style="color:#24292e"> </span><span style="color:#d73a49">extends</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Sync</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">private</span><span style="color:#24292e"> </span><span style="color:#d73a49">static</span><span style="color:#24292e"> </span><span style="color:#d73a49">final</span><span style="color:#24292e"> </span><span style="color:#d73a49">long</span><span style="color:#24292e"> serialVersionUID </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#d73a49">-</span><span style="color:#005cc5">2694183684443567898L</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6f42c1">NonfairSync</span><span style="color:#24292e">(</span><span style="color:#d73a49">int</span><span style="color:#24292e"> </span><span style="color:#e36209">permits</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6a737d">// permits Âç≥ state</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#005cc5">super</span><span style="color:#24292e">(permits);</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">// Semaphore ÊñπÊ≥ï, Êñπ‰æøÈòÖËØª, ÊîæÂú®Ê≠§Â§Ñ</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">void</span><span style="color:#24292e"> </span><span style="color:#6f42c1">acquire</span><span style="color:#24292e">() </span><span style="color:#d73a49">throws</span><span style="color:#24292e"> InterruptedException {</span></span>
<span class="line"><span style="color:#24292e">        sync.</span><span style="color:#6f42c1">acquireSharedInterruptibly</span><span style="color:#24292e">(</span><span style="color:#005cc5">1</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">// AQS ÁªßÊâøËøáÊù•ÁöÑÊñπÊ≥ï, Êñπ‰æøÈòÖËØª, ÊîæÂú®Ê≠§Â§Ñ</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">final</span><span style="color:#24292e"> </span><span style="color:#d73a49">void</span><span style="color:#24292e"> </span><span style="color:#6f42c1">acquireSharedInterruptibly</span><span style="color:#24292e">(</span><span style="color:#d73a49">int</span><span style="color:#24292e"> </span><span style="color:#e36209">arg</span><span style="color:#24292e">)</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">throws</span><span style="color:#24292e"> InterruptedException {</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (Thread.</span><span style="color:#6f42c1">interrupted</span><span style="color:#24292e">())</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">throw</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">InterruptedException</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (</span><span style="color:#6f42c1">tryAcquireShared</span><span style="color:#24292e">(arg) </span><span style="color:#d73a49">&lt;</span><span style="color:#24292e"> </span><span style="color:#005cc5">0</span><span style="color:#24292e">)</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#6f42c1">doAcquireSharedInterruptibly</span><span style="color:#24292e">(arg);</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">// Â∞ùËØïËé∑ÂæóÂÖ±‰∫´ÈîÅ</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">protected</span><span style="color:#24292e"> </span><span style="color:#d73a49">int</span><span style="color:#24292e"> </span><span style="color:#6f42c1">tryAcquireShared</span><span style="color:#24292e">(</span><span style="color:#d73a49">int</span><span style="color:#24292e"> </span><span style="color:#e36209">acquires</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">return</span><span style="color:#24292e"> </span><span style="color:#6f42c1">nonfairTryAcquireShared</span><span style="color:#24292e">(acquires);</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">// Sync ÁªßÊâøËøáÊù•ÁöÑÊñπÊ≥ï, Êñπ‰æøÈòÖËØª, ÊîæÂú®Ê≠§Â§Ñ</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">final</span><span style="color:#24292e"> </span><span style="color:#d73a49">int</span><span style="color:#24292e"> </span><span style="color:#6f42c1">nonfairTryAcquireShared</span><span style="color:#24292e">(</span><span style="color:#d73a49">int</span><span style="color:#24292e"> </span><span style="color:#e36209">acquires</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">for</span><span style="color:#24292e"> (;;) {</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">int</span><span style="color:#24292e"> available </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#6f42c1">getState</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">int</span><span style="color:#24292e"> remaining </span><span style="color:#d73a49">=</span><span style="color:#24292e"> available </span><span style="color:#d73a49">-</span><span style="color:#24292e"> acquires;</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#6a737d">// Â¶ÇÊûúËÆ∏ÂèØÂ∑≤ÁªèÁî®ÂÆå, ËøîÂõûË¥üÊï∞, Ë°®Á§∫Ëé∑ÂèñÂ§±Ë¥•, ËøõÂÖ• doAcquireSharedInterruptibly</span></span>
<span class="line"><span style="color:#24292e">                    remaining </span><span style="color:#d73a49">&lt;</span><span style="color:#24292e"> </span><span style="color:#005cc5">0</span><span style="color:#24292e"> </span><span style="color:#d73a49">||</span></span>
<span class="line"><span style="color:#24292e">                            </span><span style="color:#6a737d">// Â¶ÇÊûú cas ÈáçËØïÊàêÂäü, ËøîÂõûÊ≠£Êï∞, Ë°®Á§∫Ëé∑ÂèñÊàêÂäü</span></span>
<span class="line"><span style="color:#24292e">                            </span><span style="color:#6f42c1">compareAndSetState</span><span style="color:#24292e">(available, remaining)</span></span>
<span class="line"><span style="color:#24292e">            ) {</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#d73a49">return</span><span style="color:#24292e"> remaining;</span></span>
<span class="line"><span style="color:#24292e">            }</span></span>
<span class="line"><span style="color:#24292e">        }</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">// AQS ÁªßÊâøËøáÊù•ÁöÑÊñπÊ≥ï, Êñπ‰æøÈòÖËØª, ÊîæÂú®Ê≠§Â§Ñ</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">private</span><span style="color:#24292e"> </span><span style="color:#d73a49">void</span><span style="color:#24292e"> </span><span style="color:#6f42c1">doAcquireSharedInterruptibly</span><span style="color:#24292e">(</span><span style="color:#d73a49">int</span><span style="color:#24292e"> </span><span style="color:#e36209">arg</span><span style="color:#24292e">) </span><span style="color:#d73a49">throws</span><span style="color:#24292e"> InterruptedException {</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">final</span><span style="color:#24292e"> Node node </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#6f42c1">addWaiter</span><span style="color:#24292e">(Node.SHARED);</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">boolean</span><span style="color:#24292e"> failed </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#005cc5">true</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">try</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">for</span><span style="color:#24292e"> (;;) {</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#d73a49">final</span><span style="color:#24292e"> Node p </span><span style="color:#d73a49">=</span><span style="color:#24292e"> node.</span><span style="color:#6f42c1">predecessor</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (p </span><span style="color:#d73a49">==</span><span style="color:#24292e"> head) {</span></span>
<span class="line"><span style="color:#24292e">                    </span><span style="color:#6a737d">// ÂÜçÊ¨°Â∞ùËØïËé∑ÂèñËÆ∏ÂèØ</span></span>
<span class="line"><span style="color:#24292e">                    </span><span style="color:#d73a49">int</span><span style="color:#24292e"> r </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#6f42c1">tryAcquireShared</span><span style="color:#24292e">(arg);</span></span>
<span class="line"><span style="color:#24292e">                    </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (r </span><span style="color:#d73a49">&gt;=</span><span style="color:#24292e"> </span><span style="color:#005cc5">0</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">                        </span><span style="color:#6a737d">// ÊàêÂäüÂêéÊú¨Á∫øÁ®ãÂá∫ÈòüÔºàAQSÔºâ, ÊâÄÂú® NodeËÆæÁΩÆ‰∏∫ head</span></span>
<span class="line"><span style="color:#24292e">                        </span><span style="color:#6a737d">// Â¶ÇÊûú head.waitStatus == Node.SIGNAL ==&gt; 0 ÊàêÂäü, ‰∏ã‰∏Ä‰∏™ËäÇÁÇπ unpark</span></span>
<span class="line"><span style="color:#24292e">                        </span><span style="color:#6a737d">// Â¶ÇÊûú head.waitStatus == 0 ==&gt; Node.PROPAGATE</span></span>
<span class="line"><span style="color:#24292e">					  </span><span style="color:#6a737d">// r Ë°®Á§∫ÂèØÁî®ËµÑÊ∫êÊï∞, ‰∏∫ 0 Âàô‰∏ç‰ºöÁªßÁª≠‰º†Êí≠</span></span>
<span class="line"><span style="color:#24292e">                        </span><span style="color:#6f42c1">setHeadAndPropagate</span><span style="color:#24292e">(node, r);</span></span>
<span class="line"><span style="color:#24292e">                        p.next </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#005cc5">null</span><span style="color:#24292e">; </span><span style="color:#6a737d">// help GC</span></span>
<span class="line"><span style="color:#24292e">                        failed </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#005cc5">false</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">                        </span><span style="color:#d73a49">return</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">                    }</span></span>
<span class="line"><span style="color:#24292e">                }</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#6a737d">// ‰∏çÊàêÂäü, ËÆæÁΩÆ‰∏ä‰∏Ä‰∏™ËäÇÁÇπ waitStatus = Node.SIGNAL, ‰∏ãËΩÆËøõÂÖ• park ÈòªÂ°û</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (</span><span style="color:#6f42c1">shouldParkAfterFailedAcquire</span><span style="color:#24292e">(p, node) </span><span style="color:#d73a49">&amp;&amp;</span></span>
<span class="line"><span style="color:#24292e">                        </span><span style="color:#6f42c1">parkAndCheckInterrupt</span><span style="color:#24292e">())</span></span>
<span class="line"><span style="color:#24292e">                    </span><span style="color:#d73a49">throw</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">InterruptedException</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">            }</span></span>
<span class="line"><span style="color:#24292e">        } </span><span style="color:#d73a49">finally</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (failed)</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#6f42c1">cancelAcquire</span><span style="color:#24292e">(node);</span></span>
<span class="line"><span style="color:#24292e">        }</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">// Semaphore ÊñπÊ≥ï, Êñπ‰æøÈòÖËØª, ÊîæÂú®Ê≠§Â§Ñ</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">void</span><span style="color:#24292e"> </span><span style="color:#6f42c1">release</span><span style="color:#24292e">() {</span></span>
<span class="line"><span style="color:#24292e">        sync.</span><span style="color:#6f42c1">releaseShared</span><span style="color:#24292e">(</span><span style="color:#005cc5">1</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">// AQS ÁªßÊâøËøáÊù•ÁöÑÊñπÊ≥ï, Êñπ‰æøÈòÖËØª, ÊîæÂú®Ê≠§Â§Ñ</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">final</span><span style="color:#24292e"> </span><span style="color:#d73a49">boolean</span><span style="color:#24292e"> </span><span style="color:#6f42c1">releaseShared</span><span style="color:#24292e">(</span><span style="color:#d73a49">int</span><span style="color:#24292e"> </span><span style="color:#e36209">arg</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (</span><span style="color:#6f42c1">tryReleaseShared</span><span style="color:#24292e">(arg)) {</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#6f42c1">doReleaseShared</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">return</span><span style="color:#24292e"> </span><span style="color:#005cc5">true</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">        }</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">return</span><span style="color:#24292e"> </span><span style="color:#005cc5">false</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">// Sync ÁªßÊâøËøáÊù•ÁöÑÊñπÊ≥ï, Êñπ‰æøÈòÖËØª, ÊîæÂú®Ê≠§Â§Ñ</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">protected</span><span style="color:#24292e"> </span><span style="color:#d73a49">final</span><span style="color:#24292e"> </span><span style="color:#d73a49">boolean</span><span style="color:#24292e"> </span><span style="color:#6f42c1">tryReleaseShared</span><span style="color:#24292e">(</span><span style="color:#d73a49">int</span><span style="color:#24292e"> </span><span style="color:#e36209">releases</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">for</span><span style="color:#24292e"> (;;) {</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">int</span><span style="color:#24292e"> current </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#6f42c1">getState</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">int</span><span style="color:#24292e"> next </span><span style="color:#d73a49">=</span><span style="color:#24292e"> current </span><span style="color:#d73a49">+</span><span style="color:#24292e"> releases;</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (next </span><span style="color:#d73a49">&lt;</span><span style="color:#24292e"> current) </span><span style="color:#6a737d">// overflow</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#d73a49">throw</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Error</span><span style="color:#24292e">(</span><span style="color:#032f62">"Maximum permit count exceeded"</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (</span><span style="color:#6f42c1">compareAndSetState</span><span style="color:#24292e">(current, next))</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#d73a49">return</span><span style="color:#24292e"> </span><span style="color:#005cc5">true</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">        }</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"><span style="color:#24292e">}</span></span></code></pre></div><h5 id="‰∏∫‰ªÄ‰πàË¶ÅÊúâ-propagate" tabindex="-1">‰∏∫‰ªÄ‰πàË¶ÅÊúâ PROPAGATE <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20advanced%20chapter#‰∏∫‰ªÄ‰πàË¶ÅÊúâ-propagate" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h5><p><strong>Êó©ÊúüÊúâ bug</strong></p><ul><li>releaseShared ÊñπÊ≥ï</li></ul><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">final</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">boolean</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">releaseShared</span><span style="color:#e1e4e8">(</span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> arg) {</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (</span><span style="color:#b392f0">tryReleaseShared</span><span style="color:#e1e4e8">(arg)) {</span></span>
<span class="line"><span style="color:#e1e4e8">    	Node h </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> head;</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (h </span><span style="color:#f97583">!=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">&amp;&amp;</span><span style="color:#e1e4e8"> h.waitStatus </span><span style="color:#f97583">!=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8">)</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#b392f0">unparkSuccessor</span><span style="color:#e1e4e8">(h);</span></span>
<span class="line"><span style="color:#e1e4e8">    	</span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">true</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">false</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">final</span><span style="color:#24292e"> </span><span style="color:#d73a49">boolean</span><span style="color:#24292e"> </span><span style="color:#6f42c1">releaseShared</span><span style="color:#24292e">(</span><span style="color:#d73a49">int</span><span style="color:#24292e"> arg) {</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (</span><span style="color:#6f42c1">tryReleaseShared</span><span style="color:#24292e">(arg)) {</span></span>
<span class="line"><span style="color:#24292e">    	Node h </span><span style="color:#d73a49">=</span><span style="color:#24292e"> head;</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (h </span><span style="color:#d73a49">!=</span><span style="color:#24292e"> </span><span style="color:#005cc5">null</span><span style="color:#24292e"> </span><span style="color:#d73a49">&amp;&amp;</span><span style="color:#24292e"> h.waitStatus </span><span style="color:#d73a49">!=</span><span style="color:#24292e"> </span><span style="color:#005cc5">0</span><span style="color:#24292e">)</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#6f42c1">unparkSuccessor</span><span style="color:#24292e">(h);</span></span>
<span class="line"><span style="color:#24292e">    	</span><span style="color:#d73a49">return</span><span style="color:#24292e"> </span><span style="color:#005cc5">true</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">return</span><span style="color:#24292e"> </span><span style="color:#005cc5">false</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">}</span></span></code></pre></div><ul><li>doAcquireShared ÊñπÊ≥ï</li></ul><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#f97583">private</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">void</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">doAcquireShared</span><span style="color:#e1e4e8">(</span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> arg) {</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">final</span><span style="color:#e1e4e8"> Node node </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">addWaiter</span><span style="color:#e1e4e8">(Node.SHARED);</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">boolean</span><span style="color:#e1e4e8"> failed </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">true</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">try</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">boolean</span><span style="color:#e1e4e8"> interrupted </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">false</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">for</span><span style="color:#e1e4e8"> (;;) {</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">final</span><span style="color:#e1e4e8"> Node p </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> node.</span><span style="color:#b392f0">predecessor</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (p </span><span style="color:#f97583">==</span><span style="color:#e1e4e8"> head) {</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> r </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">tryAcquireShared</span><span style="color:#e1e4e8">(arg);</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (r </span><span style="color:#f97583">&gt;=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">                    </span><span style="color:#6a737d">// ËøôÈáå‰ºöÊúâÁ©∫Ê°£</span></span>
<span class="line"><span style="color:#e1e4e8">                    </span><span style="color:#b392f0">setHeadAndPropagate</span><span style="color:#e1e4e8">(node, r);</span></span>
<span class="line"><span style="color:#e1e4e8">                    p.next </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8">; </span><span style="color:#6a737d">// help GC</span></span>
<span class="line"><span style="color:#e1e4e8">                    </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (interrupted)</span></span>
<span class="line"><span style="color:#e1e4e8">                    	</span><span style="color:#b392f0">selfInterrupt</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">                    failed </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">false</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">                    </span><span style="color:#f97583">return</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">                }</span></span>
<span class="line"><span style="color:#e1e4e8">            }</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (</span><span style="color:#b392f0">shouldParkAfterFailedAcquire</span><span style="color:#e1e4e8">(p, node) </span><span style="color:#f97583">&amp;&amp;</span></span>
<span class="line"><span style="color:#e1e4e8">            	</span><span style="color:#b392f0">parkAndCheckInterrupt</span><span style="color:#e1e4e8">())</span></span>
<span class="line"><span style="color:#e1e4e8">                interrupted </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">true</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">        }</span></span>
<span class="line"><span style="color:#e1e4e8">    } </span><span style="color:#f97583">finally</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (failed)</span></span>
<span class="line"><span style="color:#e1e4e8">        	</span><span style="color:#b392f0">cancelAcquire</span><span style="color:#e1e4e8">(node);</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"><span style="color:#e1e4e8">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#d73a49">private</span><span style="color:#24292e"> </span><span style="color:#d73a49">void</span><span style="color:#24292e"> </span><span style="color:#6f42c1">doAcquireShared</span><span style="color:#24292e">(</span><span style="color:#d73a49">int</span><span style="color:#24292e"> arg) {</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">final</span><span style="color:#24292e"> Node node </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#6f42c1">addWaiter</span><span style="color:#24292e">(Node.SHARED);</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">boolean</span><span style="color:#24292e"> failed </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#005cc5">true</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">try</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">boolean</span><span style="color:#24292e"> interrupted </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#005cc5">false</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">for</span><span style="color:#24292e"> (;;) {</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">final</span><span style="color:#24292e"> Node p </span><span style="color:#d73a49">=</span><span style="color:#24292e"> node.</span><span style="color:#6f42c1">predecessor</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (p </span><span style="color:#d73a49">==</span><span style="color:#24292e"> head) {</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#d73a49">int</span><span style="color:#24292e"> r </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#6f42c1">tryAcquireShared</span><span style="color:#24292e">(arg);</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (r </span><span style="color:#d73a49">&gt;=</span><span style="color:#24292e"> </span><span style="color:#005cc5">0</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">                    </span><span style="color:#6a737d">// ËøôÈáå‰ºöÊúâÁ©∫Ê°£</span></span>
<span class="line"><span style="color:#24292e">                    </span><span style="color:#6f42c1">setHeadAndPropagate</span><span style="color:#24292e">(node, r);</span></span>
<span class="line"><span style="color:#24292e">                    p.next </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#005cc5">null</span><span style="color:#24292e">; </span><span style="color:#6a737d">// help GC</span></span>
<span class="line"><span style="color:#24292e">                    </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (interrupted)</span></span>
<span class="line"><span style="color:#24292e">                    	</span><span style="color:#6f42c1">selfInterrupt</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">                    failed </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#005cc5">false</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">                    </span><span style="color:#d73a49">return</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">                }</span></span>
<span class="line"><span style="color:#24292e">            }</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (</span><span style="color:#6f42c1">shouldParkAfterFailedAcquire</span><span style="color:#24292e">(p, node) </span><span style="color:#d73a49">&amp;&amp;</span></span>
<span class="line"><span style="color:#24292e">            	</span><span style="color:#6f42c1">parkAndCheckInterrupt</span><span style="color:#24292e">())</span></span>
<span class="line"><span style="color:#24292e">                interrupted </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#005cc5">true</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">        }</span></span>
<span class="line"><span style="color:#24292e">    } </span><span style="color:#d73a49">finally</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (failed)</span></span>
<span class="line"><span style="color:#24292e">        	</span><span style="color:#6f42c1">cancelAcquire</span><span style="color:#24292e">(node);</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"><span style="color:#24292e">}</span></span></code></pre></div><ul><li>setHeadAndPropagate ÊñπÊ≥ï</li></ul><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#f97583">private</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">void</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">setHeadAndPropagate</span><span style="color:#e1e4e8">(Node node, </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> propagate) {</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#b392f0">setHead</span><span style="color:#e1e4e8">(node);</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">// ÊúâÁ©∫Èó≤ËµÑÊ∫ê</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (propagate </span><span style="color:#f97583">&gt;</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">&amp;&amp;</span><span style="color:#e1e4e8"> node.waitStatus </span><span style="color:#f97583">!=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">        Node s </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> node.next;</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#6a737d">// ‰∏ã‰∏Ä‰∏™</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (s </span><span style="color:#f97583">==</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">||</span><span style="color:#e1e4e8"> s.</span><span style="color:#b392f0">isShared</span><span style="color:#e1e4e8">())</span></span>
<span class="line"><span style="color:#e1e4e8">        	</span><span style="color:#b392f0">unparkSuccessor</span><span style="color:#e1e4e8">(node);</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"><span style="color:#e1e4e8">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#d73a49">private</span><span style="color:#24292e"> </span><span style="color:#d73a49">void</span><span style="color:#24292e"> </span><span style="color:#6f42c1">setHeadAndPropagate</span><span style="color:#24292e">(Node node, </span><span style="color:#d73a49">int</span><span style="color:#24292e"> propagate) {</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6f42c1">setHead</span><span style="color:#24292e">(node);</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">// ÊúâÁ©∫Èó≤ËµÑÊ∫ê</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (propagate </span><span style="color:#d73a49">&gt;</span><span style="color:#24292e"> </span><span style="color:#005cc5">0</span><span style="color:#24292e"> </span><span style="color:#d73a49">&amp;&amp;</span><span style="color:#24292e"> node.waitStatus </span><span style="color:#d73a49">!=</span><span style="color:#24292e"> </span><span style="color:#005cc5">0</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">        Node s </span><span style="color:#d73a49">=</span><span style="color:#24292e"> node.next;</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6a737d">// ‰∏ã‰∏Ä‰∏™</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (s </span><span style="color:#d73a49">==</span><span style="color:#24292e"> </span><span style="color:#005cc5">null</span><span style="color:#24292e"> </span><span style="color:#d73a49">||</span><span style="color:#24292e"> s.</span><span style="color:#6f42c1">isShared</span><span style="color:#24292e">())</span></span>
<span class="line"><span style="color:#24292e">        	</span><span style="color:#6f42c1">unparkSuccessor</span><span style="color:#24292e">(node);</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"><span style="color:#24292e">}</span></span></code></pre></div><ul><li>ÂÅáËÆæÂ≠òÂú®ÊüêÊ¨°Âæ™ÁéØ‰∏≠ÈòüÂàóÈáåÊéíÈòüÁöÑÁªìÁÇπÊÉÖÂÜµ‰∏∫ <code>head(-1)-&gt;t1(-1)-&gt;t2(-1)</code></li><li>ÂÅáËÆæÂ≠òÂú®Â∞ÜË¶Å‰ø°Âè∑ÈáèÈáäÊîæÁöÑ T3 Âíå T4ÔºåÈáäÊîæÈ°∫Â∫è‰∏∫ÂÖà T3 Âêé T4</li></ul><p><strong>Ê≠£Â∏∏ÊµÅÁ®ã</strong></p><figure><img src="https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230719212512897.png" alt="image-20230719212512897" loading="lazy" decoding="async"></figure><p><strong>‰∫ßÁîü bug ÁöÑÊÉÖÂÜµ</strong></p><figure><img src="https://jsd.cdn.zzko.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230719212604635.png" alt="image-20230719212604635" loading="lazy" decoding="async"></figure><p>‰øÆÂ§çÂâçÁâàÊú¨ÊâßË°åÊµÅÁ®ã</p><ol><li>T3 Ë∞ÉÁî® releaseShared(1)ÔºåÁõ¥Êé•Ë∞ÉÁî®‰∫Ü unparkSuccessor(head)Ôºåhead ÁöÑÁ≠âÂæÖÁä∂ÊÄÅ‰ªé -1 Âèò‰∏∫ 0</li><li>T1 Áî±‰∫é T3 ÈáäÊîæ‰ø°Âè∑ÈáèË¢´Âî§ÈÜíÔºåË∞ÉÁî® tryAcquireSharedÔºåÂÅáËÆæËøîÂõûÂÄº‰∏∫ 0ÔºàËé∑ÂèñÈîÅÊàêÂäüÔºå‰ΩÜÊ≤°ÊúâÂâ©‰ΩôËµÑÊ∫êÈáèÔºâ</li><li>T4 Ë∞ÉÁî® releaseShared(1)ÔºåÊ≠§Êó∂ head.waitStatus ‰∏∫ 0ÔºàÊ≠§Êó∂ËØªÂà∞ÁöÑ head Âíå 1 ‰∏≠‰∏∫Âêå‰∏Ä‰∏™headÔºâÔºå‰∏çÊª°Ë∂≥ Êù°‰ª∂ÔºåÂõ†Ê≠§‰∏çË∞ÉÁî® unparkSuccessor(head)</li><li>T1 Ëé∑Âèñ‰ø°Âè∑ÈáèÊàêÂäüÔºåË∞ÉÁî® setHeadAndPropagate Êó∂ÔºåÂõ†‰∏∫‰∏çÊª°Ë∂≥ propagate &gt; 0Ôºà2 ÁöÑËøîÂõûÂÄº‰πüÂ∞±ÊòØ propagateÔºàÂâ©‰ΩôËµÑÊ∫êÈáèÔºâ == 0ÔºâÔºå‰ªéËÄå‰∏ç‰ºöÂî§ÈÜíÂêéÁªßÁªìÁÇπÔºå T2 Á∫øÁ®ãÂæó‰∏çÂà∞Âî§ÈÜí</li></ol><p><strong>bug ‰øÆÂ§çÂêé</strong></p><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#f97583">private</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">void</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">setHeadAndPropagate</span><span style="color:#e1e4e8">(Node node, </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> propagate) {</span></span>
<span class="line"><span style="color:#e1e4e8">        Node h </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> head; </span><span style="color:#6a737d">// Record old head for check below</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#6a737d">// ËÆæÁΩÆËá™Â∑±‰∏∫ head</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#b392f0">setHead</span><span style="color:#e1e4e8">(node);</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#6a737d">// propagate Ë°®Á§∫ÊúâÂÖ±‰∫´ËµÑÊ∫êÔºà‰æãÂ¶ÇÂÖ±‰∫´ËØªÈîÅÊàñ‰ø°Âè∑ÈáèÔºâ</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#6a737d">// Âéü head waitStatus == Node.SIGNAL Êàñ Node.PROPAGATE</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#6a737d">// Áé∞Âú® head waitStatus == Node.SIGNAL Êàñ Node.PROPAGATE</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (propagate </span><span style="color:#f97583">&gt;</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">||</span><span style="color:#e1e4e8"> h </span><span style="color:#f97583">==</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">||</span><span style="color:#e1e4e8"> h.waitStatus </span><span style="color:#f97583">&lt;</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">||</span></span>
<span class="line"><span style="color:#e1e4e8">            (h </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> head) </span><span style="color:#f97583">==</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">||</span><span style="color:#e1e4e8"> h.waitStatus </span><span style="color:#f97583">&lt;</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">            Node s </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> node.next;</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#6a737d">// Â¶ÇÊûúÊòØÊúÄÂêé‰∏Ä‰∏™ËäÇÁÇπÊàñËÄÖÊòØÁ≠âÂæÖÂÖ±‰∫´ËØªÈîÅÁöÑËäÇÁÇπ</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (s </span><span style="color:#f97583">==</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">||</span><span style="color:#e1e4e8"> s.</span><span style="color:#b392f0">isShared</span><span style="color:#e1e4e8">()) {</span></span>
<span class="line"><span style="color:#e1e4e8">            	</span><span style="color:#b392f0">doReleaseShared</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">            }</span></span>
<span class="line"><span style="color:#e1e4e8">        }</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">private</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">void</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">doReleaseShared</span><span style="color:#e1e4e8">() {</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#6a737d">// Â¶ÇÊûú head.waitStatus == Node.SIGNAL ==&gt; 0 ÊàêÂäü, ‰∏ã‰∏Ä‰∏™ËäÇÁÇπ unpark</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#6a737d">// Â¶ÇÊûú head.waitStatus == 0 ==&gt; Node.PROPAGATE</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">for</span><span style="color:#e1e4e8"> (;;) {</span></span>
<span class="line"><span style="color:#e1e4e8">            Node h </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> head;</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (h </span><span style="color:#f97583">!=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">&amp;&amp;</span><span style="color:#e1e4e8"> h </span><span style="color:#f97583">!=</span><span style="color:#e1e4e8"> tail) {</span></span>
<span class="line"><span style="color:#e1e4e8">            	</span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> ws </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> h.waitStatus;</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (ws </span><span style="color:#f97583">==</span><span style="color:#e1e4e8"> Node.SIGNAL) {</span></span>
<span class="line"><span style="color:#e1e4e8">                    </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (</span><span style="color:#f97583">!</span><span style="color:#b392f0">compareAndSetWaitStatus</span><span style="color:#e1e4e8">(h, Node.SIGNAL, </span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8">))</span></span>
<span class="line"><span style="color:#e1e4e8">                    	</span><span style="color:#f97583">continue</span><span style="color:#e1e4e8">; </span><span style="color:#6a737d">// loop to recheck cases</span></span>
<span class="line"><span style="color:#e1e4e8">                    </span><span style="color:#b392f0">unparkSuccessor</span><span style="color:#e1e4e8">(h);</span></span>
<span class="line"><span style="color:#e1e4e8">                }</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#f97583">else</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (ws </span><span style="color:#f97583">==</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">&amp;&amp;</span></span>
<span class="line"><span style="color:#e1e4e8">                		</span><span style="color:#f97583">!</span><span style="color:#b392f0">compareAndSetWaitStatus</span><span style="color:#e1e4e8">(h, </span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8">, Node.PROPAGATE))</span></span>
<span class="line"><span style="color:#e1e4e8">                	</span><span style="color:#f97583">continue</span><span style="color:#e1e4e8">; </span><span style="color:#6a737d">// loop on failed CAS</span></span>
<span class="line"><span style="color:#e1e4e8">            }</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (h </span><span style="color:#f97583">==</span><span style="color:#e1e4e8"> head) </span><span style="color:#6a737d">// loop if head changed</span></span>
<span class="line"><span style="color:#e1e4e8">            	</span><span style="color:#f97583">break</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">        }</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#d73a49">private</span><span style="color:#24292e"> </span><span style="color:#d73a49">void</span><span style="color:#24292e"> </span><span style="color:#6f42c1">setHeadAndPropagate</span><span style="color:#24292e">(Node node, </span><span style="color:#d73a49">int</span><span style="color:#24292e"> propagate) {</span></span>
<span class="line"><span style="color:#24292e">        Node h </span><span style="color:#d73a49">=</span><span style="color:#24292e"> head; </span><span style="color:#6a737d">// Record old head for check below</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6a737d">// ËÆæÁΩÆËá™Â∑±‰∏∫ head</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6f42c1">setHead</span><span style="color:#24292e">(node);</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6a737d">// propagate Ë°®Á§∫ÊúâÂÖ±‰∫´ËµÑÊ∫êÔºà‰æãÂ¶ÇÂÖ±‰∫´ËØªÈîÅÊàñ‰ø°Âè∑ÈáèÔºâ</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6a737d">// Âéü head waitStatus == Node.SIGNAL Êàñ Node.PROPAGATE</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6a737d">// Áé∞Âú® head waitStatus == Node.SIGNAL Êàñ Node.PROPAGATE</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (propagate </span><span style="color:#d73a49">&gt;</span><span style="color:#24292e"> </span><span style="color:#005cc5">0</span><span style="color:#24292e"> </span><span style="color:#d73a49">||</span><span style="color:#24292e"> h </span><span style="color:#d73a49">==</span><span style="color:#24292e"> </span><span style="color:#005cc5">null</span><span style="color:#24292e"> </span><span style="color:#d73a49">||</span><span style="color:#24292e"> h.waitStatus </span><span style="color:#d73a49">&lt;</span><span style="color:#24292e"> </span><span style="color:#005cc5">0</span><span style="color:#24292e"> </span><span style="color:#d73a49">||</span></span>
<span class="line"><span style="color:#24292e">            (h </span><span style="color:#d73a49">=</span><span style="color:#24292e"> head) </span><span style="color:#d73a49">==</span><span style="color:#24292e"> </span><span style="color:#005cc5">null</span><span style="color:#24292e"> </span><span style="color:#d73a49">||</span><span style="color:#24292e"> h.waitStatus </span><span style="color:#d73a49">&lt;</span><span style="color:#24292e"> </span><span style="color:#005cc5">0</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">            Node s </span><span style="color:#d73a49">=</span><span style="color:#24292e"> node.next;</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#6a737d">// Â¶ÇÊûúÊòØÊúÄÂêé‰∏Ä‰∏™ËäÇÁÇπÊàñËÄÖÊòØÁ≠âÂæÖÂÖ±‰∫´ËØªÈîÅÁöÑËäÇÁÇπ</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (s </span><span style="color:#d73a49">==</span><span style="color:#24292e"> </span><span style="color:#005cc5">null</span><span style="color:#24292e"> </span><span style="color:#d73a49">||</span><span style="color:#24292e"> s.</span><span style="color:#6f42c1">isShared</span><span style="color:#24292e">()) {</span></span>
<span class="line"><span style="color:#24292e">            	</span><span style="color:#6f42c1">doReleaseShared</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">            }</span></span>
<span class="line"><span style="color:#24292e">        }</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">private</span><span style="color:#24292e"> </span><span style="color:#d73a49">void</span><span style="color:#24292e"> </span><span style="color:#6f42c1">doReleaseShared</span><span style="color:#24292e">() {</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6a737d">// Â¶ÇÊûú head.waitStatus == Node.SIGNAL ==&gt; 0 ÊàêÂäü, ‰∏ã‰∏Ä‰∏™ËäÇÁÇπ unpark</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6a737d">// Â¶ÇÊûú head.waitStatus == 0 ==&gt; Node.PROPAGATE</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">for</span><span style="color:#24292e"> (;;) {</span></span>
<span class="line"><span style="color:#24292e">            Node h </span><span style="color:#d73a49">=</span><span style="color:#24292e"> head;</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (h </span><span style="color:#d73a49">!=</span><span style="color:#24292e"> </span><span style="color:#005cc5">null</span><span style="color:#24292e"> </span><span style="color:#d73a49">&amp;&amp;</span><span style="color:#24292e"> h </span><span style="color:#d73a49">!=</span><span style="color:#24292e"> tail) {</span></span>
<span class="line"><span style="color:#24292e">            	</span><span style="color:#d73a49">int</span><span style="color:#24292e"> ws </span><span style="color:#d73a49">=</span><span style="color:#24292e"> h.waitStatus;</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (ws </span><span style="color:#d73a49">==</span><span style="color:#24292e"> Node.SIGNAL) {</span></span>
<span class="line"><span style="color:#24292e">                    </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (</span><span style="color:#d73a49">!</span><span style="color:#6f42c1">compareAndSetWaitStatus</span><span style="color:#24292e">(h, Node.SIGNAL, </span><span style="color:#005cc5">0</span><span style="color:#24292e">))</span></span>
<span class="line"><span style="color:#24292e">                    	</span><span style="color:#d73a49">continue</span><span style="color:#24292e">; </span><span style="color:#6a737d">// loop to recheck cases</span></span>
<span class="line"><span style="color:#24292e">                    </span><span style="color:#6f42c1">unparkSuccessor</span><span style="color:#24292e">(h);</span></span>
<span class="line"><span style="color:#24292e">                }</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#d73a49">else</span><span style="color:#24292e"> </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (ws </span><span style="color:#d73a49">==</span><span style="color:#24292e"> </span><span style="color:#005cc5">0</span><span style="color:#24292e"> </span><span style="color:#d73a49">&amp;&amp;</span></span>
<span class="line"><span style="color:#24292e">                		</span><span style="color:#d73a49">!</span><span style="color:#6f42c1">compareAndSetWaitStatus</span><span style="color:#24292e">(h, </span><span style="color:#005cc5">0</span><span style="color:#24292e">, Node.PROPAGATE))</span></span>
<span class="line"><span style="color:#24292e">                	</span><span style="color:#d73a49">continue</span><span style="color:#24292e">; </span><span style="color:#6a737d">// loop on failed CAS</span></span>
<span class="line"><span style="color:#24292e">            }</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (h </span><span style="color:#d73a49">==</span><span style="color:#24292e"> head) </span><span style="color:#6a737d">// loop if head changed</span></span>
<span class="line"><span style="color:#24292e">            	</span><span style="color:#d73a49">break</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">        }</span></span>
<span class="line"><span style="color:#24292e">    }</span></span></code></pre></div><figure><img src="https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230719213104877.png" alt="image-20230719213104877" loading="lazy" decoding="async"></figure><ol><li>T3 Ë∞ÉÁî® releaseShared()ÔºåÁõ¥Êé•Ë∞ÉÁî®‰∫Ü unparkSuccessor(head)Ôºåhead ÁöÑÁ≠âÂæÖÁä∂ÊÄÅ‰ªé -1 Âèò‰∏∫ 0</li><li>T1 Áî±‰∫é T3 ÈáäÊîæ‰ø°Âè∑ÈáèË¢´Âî§ÈÜíÔºåË∞ÉÁî® tryAcquireSharedÔºåÂÅáËÆæËøîÂõûÂÄº‰∏∫ 0ÔºàËé∑ÂèñÈîÅÊàêÂäüÔºå‰ΩÜÊ≤°ÊúâÂâ©‰ΩôËµÑÊ∫êÈáèÔºâ</li><li>T4 Ë∞ÉÁî® releaseShared()ÔºåÊ≠§Êó∂ head.waitStatus ‰∏∫ 0ÔºàÊ≠§Êó∂ËØªÂà∞ÁöÑ head Âíå 1 ‰∏≠‰∏∫Âêå‰∏Ä‰∏™ headÔºâÔºåË∞ÉÁî® doReleaseShared() Â∞ÜÁ≠âÂæÖÁä∂ÊÄÅÁΩÆ‰∏∫ PROPAGATEÔºà-3Ôºâ</li><li>T1 Ëé∑Âèñ‰ø°Âè∑ÈáèÊàêÂäüÔºåË∞ÉÁî® setHeadAndPropagate Êó∂ÔºåËØªÂà∞ h.waitStatus &lt; 0Ôºå‰ªéËÄåË∞ÉÁî® doReleaseShared() Âî§ÈÜí T2</li></ol><h3 id="_5„ÄÅcountdownlatch" tabindex="-1">5„ÄÅCountdownLatch <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20advanced%20chapter#_5„ÄÅcountdownlatch" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h3><p>Áî®Êù•ËøõË°åÁ∫øÁ®ãÂêåÊ≠•Âçè‰ΩúÔºåÁ≠âÂæÖÊâÄÊúâÁ∫øÁ®ãÂÆåÊàêÂÄíËÆ°Êó∂„ÄÇ ÂÖ∂‰∏≠ÊûÑÈÄ†ÂèÇÊï∞Áî®Êù•ÂàùÂßãÂåñÁ≠âÂæÖËÆ°Êï∞ÂÄºÔºåawait() Áî®Êù•Á≠âÂæÖËÆ°Êï∞ÂΩíÈõ∂ÔºåcountDown() Áî®Êù•ËÆ©ËÆ°Êï∞Âáè‰∏Ä</p><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8">CountDownLatch latch </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">CountDownLatch</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">3</span><span style="color:#e1e4e8">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Thread</span><span style="color:#e1e4e8">(() </span><span style="color:#f97583">-&gt;</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">            log.</span><span style="color:#b392f0">debug</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"begin..."</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#b392f0">sleep</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">1</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">            latch.</span><span style="color:#b392f0">countDown</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">            log.</span><span style="color:#b392f0">debug</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"end...{}"</span><span style="color:#e1e4e8">, latch.</span><span style="color:#b392f0">getCount</span><span style="color:#e1e4e8">());</span></span>
<span class="line"><span style="color:#e1e4e8">        }).</span><span style="color:#b392f0">start</span><span style="color:#e1e4e8">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Thread</span><span style="color:#e1e4e8">(() </span><span style="color:#f97583">-&gt;</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">            log.</span><span style="color:#b392f0">debug</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"begin..."</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#b392f0">sleep</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">2</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">            latch.</span><span style="color:#b392f0">countDown</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">            log.</span><span style="color:#b392f0">debug</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"end...{}"</span><span style="color:#e1e4e8">, latch.</span><span style="color:#b392f0">getCount</span><span style="color:#e1e4e8">());</span></span>
<span class="line"><span style="color:#e1e4e8">        }).</span><span style="color:#b392f0">start</span><span style="color:#e1e4e8">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Thread</span><span style="color:#e1e4e8">(() </span><span style="color:#f97583">-&gt;</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">            log.</span><span style="color:#b392f0">debug</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"begin..."</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#b392f0">sleep</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">1.5</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">            latch.</span><span style="color:#b392f0">countDown</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">            log.</span><span style="color:#b392f0">debug</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"end...{}"</span><span style="color:#e1e4e8">, latch.</span><span style="color:#b392f0">getCount</span><span style="color:#e1e4e8">());</span></span>
<span class="line"><span style="color:#e1e4e8">        }).</span><span style="color:#b392f0">start</span><span style="color:#e1e4e8">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">        log.</span><span style="color:#b392f0">debug</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"waiting..."</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">        latch.</span><span style="color:#b392f0">await</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">        log.</span><span style="color:#b392f0">debug</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"wait end..."</span><span style="color:#e1e4e8">);</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e">CountDownLatch latch </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">CountDownLatch</span><span style="color:#24292e">(</span><span style="color:#005cc5">3</span><span style="color:#24292e">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Thread</span><span style="color:#24292e">(() </span><span style="color:#d73a49">-&gt;</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">            log.</span><span style="color:#6f42c1">debug</span><span style="color:#24292e">(</span><span style="color:#032f62">"begin..."</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#6f42c1">sleep</span><span style="color:#24292e">(</span><span style="color:#005cc5">1</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">            latch.</span><span style="color:#6f42c1">countDown</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">            log.</span><span style="color:#6f42c1">debug</span><span style="color:#24292e">(</span><span style="color:#032f62">"end...{}"</span><span style="color:#24292e">, latch.</span><span style="color:#6f42c1">getCount</span><span style="color:#24292e">());</span></span>
<span class="line"><span style="color:#24292e">        }).</span><span style="color:#6f42c1">start</span><span style="color:#24292e">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Thread</span><span style="color:#24292e">(() </span><span style="color:#d73a49">-&gt;</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">            log.</span><span style="color:#6f42c1">debug</span><span style="color:#24292e">(</span><span style="color:#032f62">"begin..."</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#6f42c1">sleep</span><span style="color:#24292e">(</span><span style="color:#005cc5">2</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">            latch.</span><span style="color:#6f42c1">countDown</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">            log.</span><span style="color:#6f42c1">debug</span><span style="color:#24292e">(</span><span style="color:#032f62">"end...{}"</span><span style="color:#24292e">, latch.</span><span style="color:#6f42c1">getCount</span><span style="color:#24292e">());</span></span>
<span class="line"><span style="color:#24292e">        }).</span><span style="color:#6f42c1">start</span><span style="color:#24292e">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Thread</span><span style="color:#24292e">(() </span><span style="color:#d73a49">-&gt;</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">            log.</span><span style="color:#6f42c1">debug</span><span style="color:#24292e">(</span><span style="color:#032f62">"begin..."</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#6f42c1">sleep</span><span style="color:#24292e">(</span><span style="color:#005cc5">1.5</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">            latch.</span><span style="color:#6f42c1">countDown</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">            log.</span><span style="color:#6f42c1">debug</span><span style="color:#24292e">(</span><span style="color:#032f62">"end...{}"</span><span style="color:#24292e">, latch.</span><span style="color:#6f42c1">getCount</span><span style="color:#24292e">());</span></span>
<span class="line"><span style="color:#24292e">        }).</span><span style="color:#6f42c1">start</span><span style="color:#24292e">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">        log.</span><span style="color:#6f42c1">debug</span><span style="color:#24292e">(</span><span style="color:#032f62">"waiting..."</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">        latch.</span><span style="color:#6f42c1">await</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">        log.</span><span style="color:#6f42c1">debug</span><span style="color:#24292e">(</span><span style="color:#032f62">"wait end..."</span><span style="color:#24292e">);</span></span></code></pre></div><figure><img src="https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230719213903076.png" alt="image-20230719213903076" loading="lazy" decoding="async"></figure><p>ÂèØ‰ª•ÈÖçÂêàÁ∫øÁ®ãÊ±†‰ΩøÁî®ÔºåÊîπËøõÂ¶Ç‰∏ã</p><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8">CountDownLatch latch </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">CountDownLatch</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">3</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">        ExecutorService service </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> Executors.</span><span style="color:#b392f0">newFixedThreadPool</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">4</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">        service.</span><span style="color:#b392f0">submit</span><span style="color:#e1e4e8">(() </span><span style="color:#f97583">-&gt;</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">            log.</span><span style="color:#b392f0">debug</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"begin..."</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#b392f0">sleep</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">1</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">            latch.</span><span style="color:#b392f0">countDown</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">            log.</span><span style="color:#b392f0">debug</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"end...{}"</span><span style="color:#e1e4e8">, latch.</span><span style="color:#b392f0">getCount</span><span style="color:#e1e4e8">());</span></span>
<span class="line"><span style="color:#e1e4e8">        });</span></span>
<span class="line"><span style="color:#e1e4e8">        service.</span><span style="color:#b392f0">submit</span><span style="color:#e1e4e8">(() </span><span style="color:#f97583">-&gt;</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">            log.</span><span style="color:#b392f0">debug</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"begin..."</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#b392f0">sleep</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">1.5</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">            latch.</span><span style="color:#b392f0">countDown</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">            log.</span><span style="color:#b392f0">debug</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"end...{}"</span><span style="color:#e1e4e8">, latch.</span><span style="color:#b392f0">getCount</span><span style="color:#e1e4e8">());</span></span>
<span class="line"><span style="color:#e1e4e8">        });</span></span>
<span class="line"><span style="color:#e1e4e8">        service.</span><span style="color:#b392f0">submit</span><span style="color:#e1e4e8">(() </span><span style="color:#f97583">-&gt;</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">            log.</span><span style="color:#b392f0">debug</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"begin..."</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#b392f0">sleep</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">2</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">            latch.</span><span style="color:#b392f0">countDown</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">            log.</span><span style="color:#b392f0">debug</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"end...{}"</span><span style="color:#e1e4e8">, latch.</span><span style="color:#b392f0">getCount</span><span style="color:#e1e4e8">());</span></span>
<span class="line"><span style="color:#e1e4e8">        });</span></span>
<span class="line"><span style="color:#e1e4e8">        service.</span><span style="color:#b392f0">submit</span><span style="color:#e1e4e8">(()</span><span style="color:#f97583">-&gt;</span><span style="color:#e1e4e8">{</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">try</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">                log.</span><span style="color:#b392f0">debug</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"waiting..."</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">                latch.</span><span style="color:#b392f0">await</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">                log.</span><span style="color:#b392f0">debug</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"wait end..."</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">            } </span><span style="color:#f97583">catch</span><span style="color:#e1e4e8"> (InterruptedException </span><span style="color:#ffab70">e</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">                e.</span><span style="color:#b392f0">printStackTrace</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">            }</span></span>
<span class="line"><span style="color:#e1e4e8">        });</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e">CountDownLatch latch </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">CountDownLatch</span><span style="color:#24292e">(</span><span style="color:#005cc5">3</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">        ExecutorService service </span><span style="color:#d73a49">=</span><span style="color:#24292e"> Executors.</span><span style="color:#6f42c1">newFixedThreadPool</span><span style="color:#24292e">(</span><span style="color:#005cc5">4</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">        service.</span><span style="color:#6f42c1">submit</span><span style="color:#24292e">(() </span><span style="color:#d73a49">-&gt;</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">            log.</span><span style="color:#6f42c1">debug</span><span style="color:#24292e">(</span><span style="color:#032f62">"begin..."</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#6f42c1">sleep</span><span style="color:#24292e">(</span><span style="color:#005cc5">1</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">            latch.</span><span style="color:#6f42c1">countDown</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">            log.</span><span style="color:#6f42c1">debug</span><span style="color:#24292e">(</span><span style="color:#032f62">"end...{}"</span><span style="color:#24292e">, latch.</span><span style="color:#6f42c1">getCount</span><span style="color:#24292e">());</span></span>
<span class="line"><span style="color:#24292e">        });</span></span>
<span class="line"><span style="color:#24292e">        service.</span><span style="color:#6f42c1">submit</span><span style="color:#24292e">(() </span><span style="color:#d73a49">-&gt;</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">            log.</span><span style="color:#6f42c1">debug</span><span style="color:#24292e">(</span><span style="color:#032f62">"begin..."</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#6f42c1">sleep</span><span style="color:#24292e">(</span><span style="color:#005cc5">1.5</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">            latch.</span><span style="color:#6f42c1">countDown</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">            log.</span><span style="color:#6f42c1">debug</span><span style="color:#24292e">(</span><span style="color:#032f62">"end...{}"</span><span style="color:#24292e">, latch.</span><span style="color:#6f42c1">getCount</span><span style="color:#24292e">());</span></span>
<span class="line"><span style="color:#24292e">        });</span></span>
<span class="line"><span style="color:#24292e">        service.</span><span style="color:#6f42c1">submit</span><span style="color:#24292e">(() </span><span style="color:#d73a49">-&gt;</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">            log.</span><span style="color:#6f42c1">debug</span><span style="color:#24292e">(</span><span style="color:#032f62">"begin..."</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#6f42c1">sleep</span><span style="color:#24292e">(</span><span style="color:#005cc5">2</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">            latch.</span><span style="color:#6f42c1">countDown</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">            log.</span><span style="color:#6f42c1">debug</span><span style="color:#24292e">(</span><span style="color:#032f62">"end...{}"</span><span style="color:#24292e">, latch.</span><span style="color:#6f42c1">getCount</span><span style="color:#24292e">());</span></span>
<span class="line"><span style="color:#24292e">        });</span></span>
<span class="line"><span style="color:#24292e">        service.</span><span style="color:#6f42c1">submit</span><span style="color:#24292e">(()</span><span style="color:#d73a49">-&gt;</span><span style="color:#24292e">{</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">try</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">                log.</span><span style="color:#6f42c1">debug</span><span style="color:#24292e">(</span><span style="color:#032f62">"waiting..."</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">                latch.</span><span style="color:#6f42c1">await</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">                log.</span><span style="color:#6f42c1">debug</span><span style="color:#24292e">(</span><span style="color:#032f62">"wait end..."</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">            } </span><span style="color:#d73a49">catch</span><span style="color:#24292e"> (InterruptedException </span><span style="color:#e36209">e</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">                e.</span><span style="color:#6f42c1">printStackTrace</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">            }</span></span>
<span class="line"><span style="color:#24292e">        });</span></span></code></pre></div><figure><img src="https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230719214200332.png" alt="image-20230719214200332" loading="lazy" decoding="async"></figure><h4 id="Â∫îÁî®‰πãÂêåÊ≠•Á≠âÂæÖÂ§öÁ∫øÁ®ãÂáÜÂ§áÂÆåÊØï" tabindex="-1">Â∫îÁî®‰πãÂêåÊ≠•Á≠âÂæÖÂ§öÁ∫øÁ®ãÂáÜÂ§áÂÆåÊØï <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20advanced%20chapter#Â∫îÁî®‰πãÂêåÊ≠•Á≠âÂæÖÂ§öÁ∫øÁ®ãÂáÜÂ§áÂÆåÊØï" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h4><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8">AtomicInteger num </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">AtomicInteger</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">        ExecutorService service </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> Executors.</span><span style="color:#b392f0">newFixedThreadPool</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">10</span><span style="color:#e1e4e8">, (r) </span><span style="color:#f97583">-&gt;</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Thread</span><span style="color:#e1e4e8">(r, </span><span style="color:#9ecbff">"t"</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">+</span><span style="color:#e1e4e8"> num.</span><span style="color:#b392f0">getAndIncrement</span><span style="color:#e1e4e8">());</span></span>
<span class="line"><span style="color:#e1e4e8">        });</span></span>
<span class="line"><span style="color:#e1e4e8">        CountDownLatch latch </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">CountDownLatch</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">10</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">String</span><span style="color:#e1e4e8">[] all </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">String</span><span style="color:#e1e4e8">[</span><span style="color:#79b8ff">10</span><span style="color:#e1e4e8">];</span></span>
<span class="line"><span style="color:#e1e4e8">        Random r </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Random</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">for</span><span style="color:#e1e4e8"> (</span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> j </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8">; j </span><span style="color:#f97583">&lt;</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">10</span><span style="color:#e1e4e8">; j</span><span style="color:#f97583">++</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> x </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> j;</span></span>
<span class="line"><span style="color:#e1e4e8">            service.</span><span style="color:#b392f0">submit</span><span style="color:#e1e4e8">(() </span><span style="color:#f97583">-&gt;</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#f97583">for</span><span style="color:#e1e4e8"> (</span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> i </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8">; i </span><span style="color:#f97583">&lt;=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">100</span><span style="color:#e1e4e8">; i</span><span style="color:#f97583">++</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">                    </span><span style="color:#f97583">try</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">                        Thread.</span><span style="color:#b392f0">sleep</span><span style="color:#e1e4e8">(r.</span><span style="color:#b392f0">nextInt</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">100</span><span style="color:#e1e4e8">));</span></span>
<span class="line"><span style="color:#e1e4e8">                    } </span><span style="color:#f97583">catch</span><span style="color:#e1e4e8"> (InterruptedException </span><span style="color:#ffab70">e</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">                    }</span></span>
<span class="line"><span style="color:#e1e4e8">                    all[x] </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> Thread.</span><span style="color:#b392f0">currentThread</span><span style="color:#e1e4e8">().</span><span style="color:#b392f0">getName</span><span style="color:#e1e4e8">() </span><span style="color:#f97583">+</span><span style="color:#e1e4e8"> </span><span style="color:#9ecbff">"("</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">+</span><span style="color:#e1e4e8"> (i </span><span style="color:#f97583">+</span><span style="color:#e1e4e8"> </span><span style="color:#9ecbff">"%"</span><span style="color:#e1e4e8">) </span><span style="color:#f97583">+</span><span style="color:#e1e4e8"> </span><span style="color:#9ecbff">")"</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">                    System.out.</span><span style="color:#b392f0">print</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"</span><span style="color:#79b8ff">\r</span><span style="color:#9ecbff">"</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">+</span><span style="color:#e1e4e8"> Arrays.</span><span style="color:#b392f0">toString</span><span style="color:#e1e4e8">(all));</span></span>
<span class="line"><span style="color:#e1e4e8">                }</span></span>
<span class="line"><span style="color:#e1e4e8">                latch.</span><span style="color:#b392f0">countDown</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">            });</span></span>
<span class="line"><span style="color:#e1e4e8">        }</span></span>
<span class="line"><span style="color:#e1e4e8">        latch.</span><span style="color:#b392f0">await</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#6a737d">// \nÂõûËΩ¶</span></span>
<span class="line"><span style="color:#e1e4e8">        System.out.</span><span style="color:#b392f0">println</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"</span><span style="color:#79b8ff">\n</span><span style="color:#9ecbff">Ê∏∏ÊàèÂºÄÂßã..."</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">        service.</span><span style="color:#b392f0">shutdown</span><span style="color:#e1e4e8">();</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e">AtomicInteger num </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">AtomicInteger</span><span style="color:#24292e">(</span><span style="color:#005cc5">0</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">        ExecutorService service </span><span style="color:#d73a49">=</span><span style="color:#24292e"> Executors.</span><span style="color:#6f42c1">newFixedThreadPool</span><span style="color:#24292e">(</span><span style="color:#005cc5">10</span><span style="color:#24292e">, (r) </span><span style="color:#d73a49">-&gt;</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">return</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Thread</span><span style="color:#24292e">(r, </span><span style="color:#032f62">"t"</span><span style="color:#24292e"> </span><span style="color:#d73a49">+</span><span style="color:#24292e"> num.</span><span style="color:#6f42c1">getAndIncrement</span><span style="color:#24292e">());</span></span>
<span class="line"><span style="color:#24292e">        });</span></span>
<span class="line"><span style="color:#24292e">        CountDownLatch latch </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">CountDownLatch</span><span style="color:#24292e">(</span><span style="color:#005cc5">10</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">String</span><span style="color:#24292e">[] all </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#d73a49">String</span><span style="color:#24292e">[</span><span style="color:#005cc5">10</span><span style="color:#24292e">];</span></span>
<span class="line"><span style="color:#24292e">        Random r </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Random</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">for</span><span style="color:#24292e"> (</span><span style="color:#d73a49">int</span><span style="color:#24292e"> j </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#005cc5">0</span><span style="color:#24292e">; j </span><span style="color:#d73a49">&lt;</span><span style="color:#24292e"> </span><span style="color:#005cc5">10</span><span style="color:#24292e">; j</span><span style="color:#d73a49">++</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">int</span><span style="color:#24292e"> x </span><span style="color:#d73a49">=</span><span style="color:#24292e"> j;</span></span>
<span class="line"><span style="color:#24292e">            service.</span><span style="color:#6f42c1">submit</span><span style="color:#24292e">(() </span><span style="color:#d73a49">-&gt;</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#d73a49">for</span><span style="color:#24292e"> (</span><span style="color:#d73a49">int</span><span style="color:#24292e"> i </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#005cc5">0</span><span style="color:#24292e">; i </span><span style="color:#d73a49">&lt;=</span><span style="color:#24292e"> </span><span style="color:#005cc5">100</span><span style="color:#24292e">; i</span><span style="color:#d73a49">++</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">                    </span><span style="color:#d73a49">try</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">                        Thread.</span><span style="color:#6f42c1">sleep</span><span style="color:#24292e">(r.</span><span style="color:#6f42c1">nextInt</span><span style="color:#24292e">(</span><span style="color:#005cc5">100</span><span style="color:#24292e">));</span></span>
<span class="line"><span style="color:#24292e">                    } </span><span style="color:#d73a49">catch</span><span style="color:#24292e"> (InterruptedException </span><span style="color:#e36209">e</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">                    }</span></span>
<span class="line"><span style="color:#24292e">                    all[x] </span><span style="color:#d73a49">=</span><span style="color:#24292e"> Thread.</span><span style="color:#6f42c1">currentThread</span><span style="color:#24292e">().</span><span style="color:#6f42c1">getName</span><span style="color:#24292e">() </span><span style="color:#d73a49">+</span><span style="color:#24292e"> </span><span style="color:#032f62">"("</span><span style="color:#24292e"> </span><span style="color:#d73a49">+</span><span style="color:#24292e"> (i </span><span style="color:#d73a49">+</span><span style="color:#24292e"> </span><span style="color:#032f62">"%"</span><span style="color:#24292e">) </span><span style="color:#d73a49">+</span><span style="color:#24292e"> </span><span style="color:#032f62">")"</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">                    System.out.</span><span style="color:#6f42c1">print</span><span style="color:#24292e">(</span><span style="color:#032f62">"</span><span style="color:#005cc5">\r</span><span style="color:#032f62">"</span><span style="color:#24292e"> </span><span style="color:#d73a49">+</span><span style="color:#24292e"> Arrays.</span><span style="color:#6f42c1">toString</span><span style="color:#24292e">(all));</span></span>
<span class="line"><span style="color:#24292e">                }</span></span>
<span class="line"><span style="color:#24292e">                latch.</span><span style="color:#6f42c1">countDown</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">            });</span></span>
<span class="line"><span style="color:#24292e">        }</span></span>
<span class="line"><span style="color:#24292e">        latch.</span><span style="color:#6f42c1">await</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6a737d">// \nÂõûËΩ¶</span></span>
<span class="line"><span style="color:#24292e">        System.out.</span><span style="color:#6f42c1">println</span><span style="color:#24292e">(</span><span style="color:#032f62">"</span><span style="color:#005cc5">\n</span><span style="color:#032f62">Ê∏∏ÊàèÂºÄÂßã..."</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">        service.</span><span style="color:#6f42c1">shutdown</span><span style="color:#24292e">();</span></span></code></pre></div><figure><img src="https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230719215611206.png" alt="image-20230719215611206" loading="lazy" decoding="async"></figure><h4 id="Â∫îÁî®‰πãÂêåÊ≠•Á≠âÂæÖÂ§ö‰∏™ËøúÁ®ãË∞ÉÁî®ÁªìÊùü" tabindex="-1">Â∫îÁî®‰πãÂêåÊ≠•Á≠âÂæÖÂ§ö‰∏™ËøúÁ®ãË∞ÉÁî®ÁªìÊùü <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20advanced%20chapter#Â∫îÁî®‰πãÂêåÊ≠•Á≠âÂæÖÂ§ö‰∏™ËøúÁ®ãË∞ÉÁî®ÁªìÊùü" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h4><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8">@</span><span style="color:#f97583">RestController</span></span>
<span class="line"><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">class</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">TestCountDownlatchController</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">    @</span><span style="color:#f97583">GetMapping</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"/order/{id}"</span><span style="color:#e1e4e8">)</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">public</span><span style="color:#e1e4e8"> Map&lt;</span><span style="color:#f97583">String</span><span style="color:#e1e4e8">, </span><span style="color:#f97583">Object</span><span style="color:#e1e4e8">&gt; </span><span style="color:#b392f0">order</span><span style="color:#e1e4e8">(@</span><span style="color:#f97583">PathVariable</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> </span><span style="color:#ffab70">id</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">        HashMap&lt;</span><span style="color:#f97583">String</span><span style="color:#e1e4e8">, </span><span style="color:#f97583">Object</span><span style="color:#e1e4e8">&gt; map </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> HashMap&lt;&gt;();</span></span>
<span class="line"><span style="color:#e1e4e8">        map.</span><span style="color:#b392f0">put</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"id"</span><span style="color:#e1e4e8">, id);</span></span>
<span class="line"><span style="color:#e1e4e8">        map.</span><span style="color:#b392f0">put</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"total"</span><span style="color:#e1e4e8">, </span><span style="color:#9ecbff">"2300.00"</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#b392f0">sleep</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">2000</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> map;</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">    @</span><span style="color:#f97583">GetMapping</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"/product/{id}"</span><span style="color:#e1e4e8">)</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">public</span><span style="color:#e1e4e8"> Map&lt;</span><span style="color:#f97583">String</span><span style="color:#e1e4e8">, </span><span style="color:#f97583">Object</span><span style="color:#e1e4e8">&gt; </span><span style="color:#b392f0">product</span><span style="color:#e1e4e8">(@</span><span style="color:#f97583">PathVariable</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> </span><span style="color:#ffab70">id</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">        HashMap&lt;</span><span style="color:#f97583">String</span><span style="color:#e1e4e8">, </span><span style="color:#f97583">Object</span><span style="color:#e1e4e8">&gt; map </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> HashMap&lt;&gt;();</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (id </span><span style="color:#f97583">==</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">1</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">            map.</span><span style="color:#b392f0">put</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"name"</span><span style="color:#e1e4e8">, </span><span style="color:#9ecbff">"Â∞èÁà±Èü≥ÁÆ±"</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">            map.</span><span style="color:#b392f0">put</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"price"</span><span style="color:#e1e4e8">, </span><span style="color:#79b8ff">300</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">        } </span><span style="color:#f97583">else</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (id </span><span style="color:#f97583">==</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">2</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">            map.</span><span style="color:#b392f0">put</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"name"</span><span style="color:#e1e4e8">, </span><span style="color:#9ecbff">"Â∞èÁ±≥ÊâãÊú∫"</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">            map.</span><span style="color:#b392f0">put</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"price"</span><span style="color:#e1e4e8">, </span><span style="color:#79b8ff">2000</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">        }</span></span>
<span class="line"><span style="color:#e1e4e8">        map.</span><span style="color:#b392f0">put</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"id"</span><span style="color:#e1e4e8">, id);</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#b392f0">sleep</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">1000</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> map;</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">    @</span><span style="color:#f97583">GetMapping</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"/logistics/{id}"</span><span style="color:#e1e4e8">)</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">public</span><span style="color:#e1e4e8"> Map&lt;</span><span style="color:#f97583">String</span><span style="color:#e1e4e8">, </span><span style="color:#f97583">Object</span><span style="color:#e1e4e8">&gt; </span><span style="color:#b392f0">logistics</span><span style="color:#e1e4e8">(@</span><span style="color:#f97583">PathVariable</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> </span><span style="color:#ffab70">id</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">        HashMap&lt;</span><span style="color:#f97583">String</span><span style="color:#e1e4e8">, </span><span style="color:#f97583">Object</span><span style="color:#e1e4e8">&gt; map </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> HashMap&lt;&gt;();</span></span>
<span class="line"><span style="color:#e1e4e8">        map.</span><span style="color:#b392f0">put</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"id"</span><span style="color:#e1e4e8">, id);</span></span>
<span class="line"><span style="color:#e1e4e8">        map.</span><span style="color:#b392f0">put</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"name"</span><span style="color:#e1e4e8">, </span><span style="color:#9ecbff">"‰∏≠ÈÄöÂø´ÈÄí"</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#b392f0">sleep</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">2500</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> map;</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">private</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">void</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">sleep</span><span style="color:#e1e4e8">(</span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> </span><span style="color:#ffab70">millis</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">try</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">            Thread.</span><span style="color:#b392f0">sleep</span><span style="color:#e1e4e8">(millis);</span></span>
<span class="line"><span style="color:#e1e4e8">        } </span><span style="color:#f97583">catch</span><span style="color:#e1e4e8"> (InterruptedException </span><span style="color:#ffab70">e</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">            e.</span><span style="color:#b392f0">printStackTrace</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">        }</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"><span style="color:#e1e4e8">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e">@</span><span style="color:#d73a49">RestController</span></span>
<span class="line"><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">class</span><span style="color:#24292e"> </span><span style="color:#6f42c1">TestCountDownlatchController</span><span style="color:#24292e"> {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">    @</span><span style="color:#d73a49">GetMapping</span><span style="color:#24292e">(</span><span style="color:#032f62">"/order/{id}"</span><span style="color:#24292e">)</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">public</span><span style="color:#24292e"> Map&lt;</span><span style="color:#d73a49">String</span><span style="color:#24292e">, </span><span style="color:#d73a49">Object</span><span style="color:#24292e">&gt; </span><span style="color:#6f42c1">order</span><span style="color:#24292e">(@</span><span style="color:#d73a49">PathVariable</span><span style="color:#24292e"> </span><span style="color:#d73a49">int</span><span style="color:#24292e"> </span><span style="color:#e36209">id</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">        HashMap&lt;</span><span style="color:#d73a49">String</span><span style="color:#24292e">, </span><span style="color:#d73a49">Object</span><span style="color:#24292e">&gt; map </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> HashMap&lt;&gt;();</span></span>
<span class="line"><span style="color:#24292e">        map.</span><span style="color:#6f42c1">put</span><span style="color:#24292e">(</span><span style="color:#032f62">"id"</span><span style="color:#24292e">, id);</span></span>
<span class="line"><span style="color:#24292e">        map.</span><span style="color:#6f42c1">put</span><span style="color:#24292e">(</span><span style="color:#032f62">"total"</span><span style="color:#24292e">, </span><span style="color:#032f62">"2300.00"</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6f42c1">sleep</span><span style="color:#24292e">(</span><span style="color:#005cc5">2000</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">return</span><span style="color:#24292e"> map;</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">    @</span><span style="color:#d73a49">GetMapping</span><span style="color:#24292e">(</span><span style="color:#032f62">"/product/{id}"</span><span style="color:#24292e">)</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">public</span><span style="color:#24292e"> Map&lt;</span><span style="color:#d73a49">String</span><span style="color:#24292e">, </span><span style="color:#d73a49">Object</span><span style="color:#24292e">&gt; </span><span style="color:#6f42c1">product</span><span style="color:#24292e">(@</span><span style="color:#d73a49">PathVariable</span><span style="color:#24292e"> </span><span style="color:#d73a49">int</span><span style="color:#24292e"> </span><span style="color:#e36209">id</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">        HashMap&lt;</span><span style="color:#d73a49">String</span><span style="color:#24292e">, </span><span style="color:#d73a49">Object</span><span style="color:#24292e">&gt; map </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> HashMap&lt;&gt;();</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (id </span><span style="color:#d73a49">==</span><span style="color:#24292e"> </span><span style="color:#005cc5">1</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">            map.</span><span style="color:#6f42c1">put</span><span style="color:#24292e">(</span><span style="color:#032f62">"name"</span><span style="color:#24292e">, </span><span style="color:#032f62">"Â∞èÁà±Èü≥ÁÆ±"</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">            map.</span><span style="color:#6f42c1">put</span><span style="color:#24292e">(</span><span style="color:#032f62">"price"</span><span style="color:#24292e">, </span><span style="color:#005cc5">300</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">        } </span><span style="color:#d73a49">else</span><span style="color:#24292e"> </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (id </span><span style="color:#d73a49">==</span><span style="color:#24292e"> </span><span style="color:#005cc5">2</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">            map.</span><span style="color:#6f42c1">put</span><span style="color:#24292e">(</span><span style="color:#032f62">"name"</span><span style="color:#24292e">, </span><span style="color:#032f62">"Â∞èÁ±≥ÊâãÊú∫"</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">            map.</span><span style="color:#6f42c1">put</span><span style="color:#24292e">(</span><span style="color:#032f62">"price"</span><span style="color:#24292e">, </span><span style="color:#005cc5">2000</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">        }</span></span>
<span class="line"><span style="color:#24292e">        map.</span><span style="color:#6f42c1">put</span><span style="color:#24292e">(</span><span style="color:#032f62">"id"</span><span style="color:#24292e">, id);</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6f42c1">sleep</span><span style="color:#24292e">(</span><span style="color:#005cc5">1000</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">return</span><span style="color:#24292e"> map;</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">    @</span><span style="color:#d73a49">GetMapping</span><span style="color:#24292e">(</span><span style="color:#032f62">"/logistics/{id}"</span><span style="color:#24292e">)</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">public</span><span style="color:#24292e"> Map&lt;</span><span style="color:#d73a49">String</span><span style="color:#24292e">, </span><span style="color:#d73a49">Object</span><span style="color:#24292e">&gt; </span><span style="color:#6f42c1">logistics</span><span style="color:#24292e">(@</span><span style="color:#d73a49">PathVariable</span><span style="color:#24292e"> </span><span style="color:#d73a49">int</span><span style="color:#24292e"> </span><span style="color:#e36209">id</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">        HashMap&lt;</span><span style="color:#d73a49">String</span><span style="color:#24292e">, </span><span style="color:#d73a49">Object</span><span style="color:#24292e">&gt; map </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> HashMap&lt;&gt;();</span></span>
<span class="line"><span style="color:#24292e">        map.</span><span style="color:#6f42c1">put</span><span style="color:#24292e">(</span><span style="color:#032f62">"id"</span><span style="color:#24292e">, id);</span></span>
<span class="line"><span style="color:#24292e">        map.</span><span style="color:#6f42c1">put</span><span style="color:#24292e">(</span><span style="color:#032f62">"name"</span><span style="color:#24292e">, </span><span style="color:#032f62">"‰∏≠ÈÄöÂø´ÈÄí"</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6f42c1">sleep</span><span style="color:#24292e">(</span><span style="color:#005cc5">2500</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">return</span><span style="color:#24292e"> map;</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">private</span><span style="color:#24292e"> </span><span style="color:#d73a49">void</span><span style="color:#24292e"> </span><span style="color:#6f42c1">sleep</span><span style="color:#24292e">(</span><span style="color:#d73a49">int</span><span style="color:#24292e"> </span><span style="color:#e36209">millis</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">try</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">            Thread.</span><span style="color:#6f42c1">sleep</span><span style="color:#24292e">(millis);</span></span>
<span class="line"><span style="color:#24292e">        } </span><span style="color:#d73a49">catch</span><span style="color:#24292e"> (InterruptedException </span><span style="color:#e36209">e</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">            e.</span><span style="color:#6f42c1">printStackTrace</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">        }</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"><span style="color:#24292e">}</span></span></code></pre></div><p>rest ËøúÁ®ãË∞ÉÁî®</p><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8">RestTemplate restTemplate </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">RestTemplate</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">        log.</span><span style="color:#b392f0">debug</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"begin"</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">        ExecutorService service </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> Executors.</span><span style="color:#b392f0">newCachedThreadPool</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">        CountDownLatch latch </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">CountDownLatch</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">4</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">        Future&lt;Map&lt;</span><span style="color:#f97583">String</span><span style="color:#e1e4e8">,</span><span style="color:#f97583">Object</span><span style="color:#e1e4e8">&gt;&gt; f1 </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> service.</span><span style="color:#b392f0">submit</span><span style="color:#e1e4e8">(() </span><span style="color:#f97583">-&gt;</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">            Map&lt;</span><span style="color:#f97583">String</span><span style="color:#e1e4e8">, </span><span style="color:#f97583">Object</span><span style="color:#e1e4e8">&gt; response </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> restTemplate.</span><span style="color:#b392f0">getForObject</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"http://localhost:8080/order/{1}"</span><span style="color:#e1e4e8">, Map.class, </span><span style="color:#79b8ff">1</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> response;</span></span>
<span class="line"><span style="color:#e1e4e8">        });</span></span>
<span class="line"><span style="color:#e1e4e8">        Future&lt;Map&lt;</span><span style="color:#f97583">String</span><span style="color:#e1e4e8">, </span><span style="color:#f97583">Object</span><span style="color:#e1e4e8">&gt;&gt; f2 </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> service.</span><span style="color:#b392f0">submit</span><span style="color:#e1e4e8">(() </span><span style="color:#f97583">-&gt;</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">            Map&lt;</span><span style="color:#f97583">String</span><span style="color:#e1e4e8">, </span><span style="color:#f97583">Object</span><span style="color:#e1e4e8">&gt; response1 </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> restTemplate.</span><span style="color:#b392f0">getForObject</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"http://localhost:8080/product/{1}"</span><span style="color:#e1e4e8">, Map.class, </span><span style="color:#79b8ff">1</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> response1;</span></span>
<span class="line"><span style="color:#e1e4e8">        });</span></span>
<span class="line"><span style="color:#e1e4e8">        Future&lt;Map&lt;</span><span style="color:#f97583">String</span><span style="color:#e1e4e8">, </span><span style="color:#f97583">Object</span><span style="color:#e1e4e8">&gt;&gt; f3 </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> service.</span><span style="color:#b392f0">submit</span><span style="color:#e1e4e8">(() </span><span style="color:#f97583">-&gt;</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">            Map&lt;</span><span style="color:#f97583">String</span><span style="color:#e1e4e8">, </span><span style="color:#f97583">Object</span><span style="color:#e1e4e8">&gt; response1 </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> restTemplate.</span><span style="color:#b392f0">getForObject</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"http://localhost:8080/product/{1}"</span><span style="color:#e1e4e8">, Map.class, </span><span style="color:#79b8ff">2</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> response1;</span></span>
<span class="line"><span style="color:#e1e4e8">        });</span></span>
<span class="line"><span style="color:#e1e4e8">        Future&lt;Map&lt;</span><span style="color:#f97583">String</span><span style="color:#e1e4e8">, </span><span style="color:#f97583">Object</span><span style="color:#e1e4e8">&gt;&gt; f4 </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> service.</span><span style="color:#b392f0">submit</span><span style="color:#e1e4e8">(() </span><span style="color:#f97583">-&gt;</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">            Map&lt;</span><span style="color:#f97583">String</span><span style="color:#e1e4e8">, </span><span style="color:#f97583">Object</span><span style="color:#e1e4e8">&gt; response3 </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> restTemplate.</span><span style="color:#b392f0">getForObject</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"http://localhost:8080/logistics/{1}"</span><span style="color:#e1e4e8">, Map.class, </span><span style="color:#79b8ff">1</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> response3;</span></span>
<span class="line"><span style="color:#e1e4e8">        });</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">        System.out.</span><span style="color:#b392f0">println</span><span style="color:#e1e4e8">(f1.</span><span style="color:#b392f0">get</span><span style="color:#e1e4e8">());</span></span>
<span class="line"><span style="color:#e1e4e8">        System.out.</span><span style="color:#b392f0">println</span><span style="color:#e1e4e8">(f2.</span><span style="color:#b392f0">get</span><span style="color:#e1e4e8">());</span></span>
<span class="line"><span style="color:#e1e4e8">        System.out.</span><span style="color:#b392f0">println</span><span style="color:#e1e4e8">(f3.</span><span style="color:#b392f0">get</span><span style="color:#e1e4e8">());</span></span>
<span class="line"><span style="color:#e1e4e8">        System.out.</span><span style="color:#b392f0">println</span><span style="color:#e1e4e8">(f4.</span><span style="color:#b392f0">get</span><span style="color:#e1e4e8">());</span></span>
<span class="line"><span style="color:#e1e4e8">        log.</span><span style="color:#b392f0">debug</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"ÊâßË°åÂÆåÊØï"</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">        service.</span><span style="color:#b392f0">shutdown</span><span style="color:#e1e4e8">();</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e">RestTemplate restTemplate </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">RestTemplate</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">        log.</span><span style="color:#6f42c1">debug</span><span style="color:#24292e">(</span><span style="color:#032f62">"begin"</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">        ExecutorService service </span><span style="color:#d73a49">=</span><span style="color:#24292e"> Executors.</span><span style="color:#6f42c1">newCachedThreadPool</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">        CountDownLatch latch </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">CountDownLatch</span><span style="color:#24292e">(</span><span style="color:#005cc5">4</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">        Future&lt;Map&lt;</span><span style="color:#d73a49">String</span><span style="color:#24292e">,</span><span style="color:#d73a49">Object</span><span style="color:#24292e">&gt;&gt; f1 </span><span style="color:#d73a49">=</span><span style="color:#24292e"> service.</span><span style="color:#6f42c1">submit</span><span style="color:#24292e">(() </span><span style="color:#d73a49">-&gt;</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">            Map&lt;</span><span style="color:#d73a49">String</span><span style="color:#24292e">, </span><span style="color:#d73a49">Object</span><span style="color:#24292e">&gt; response </span><span style="color:#d73a49">=</span><span style="color:#24292e"> restTemplate.</span><span style="color:#6f42c1">getForObject</span><span style="color:#24292e">(</span><span style="color:#032f62">"http://localhost:8080/order/{1}"</span><span style="color:#24292e">, Map.class, </span><span style="color:#005cc5">1</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">return</span><span style="color:#24292e"> response;</span></span>
<span class="line"><span style="color:#24292e">        });</span></span>
<span class="line"><span style="color:#24292e">        Future&lt;Map&lt;</span><span style="color:#d73a49">String</span><span style="color:#24292e">, </span><span style="color:#d73a49">Object</span><span style="color:#24292e">&gt;&gt; f2 </span><span style="color:#d73a49">=</span><span style="color:#24292e"> service.</span><span style="color:#6f42c1">submit</span><span style="color:#24292e">(() </span><span style="color:#d73a49">-&gt;</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">            Map&lt;</span><span style="color:#d73a49">String</span><span style="color:#24292e">, </span><span style="color:#d73a49">Object</span><span style="color:#24292e">&gt; response1 </span><span style="color:#d73a49">=</span><span style="color:#24292e"> restTemplate.</span><span style="color:#6f42c1">getForObject</span><span style="color:#24292e">(</span><span style="color:#032f62">"http://localhost:8080/product/{1}"</span><span style="color:#24292e">, Map.class, </span><span style="color:#005cc5">1</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">return</span><span style="color:#24292e"> response1;</span></span>
<span class="line"><span style="color:#24292e">        });</span></span>
<span class="line"><span style="color:#24292e">        Future&lt;Map&lt;</span><span style="color:#d73a49">String</span><span style="color:#24292e">, </span><span style="color:#d73a49">Object</span><span style="color:#24292e">&gt;&gt; f3 </span><span style="color:#d73a49">=</span><span style="color:#24292e"> service.</span><span style="color:#6f42c1">submit</span><span style="color:#24292e">(() </span><span style="color:#d73a49">-&gt;</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">            Map&lt;</span><span style="color:#d73a49">String</span><span style="color:#24292e">, </span><span style="color:#d73a49">Object</span><span style="color:#24292e">&gt; response1 </span><span style="color:#d73a49">=</span><span style="color:#24292e"> restTemplate.</span><span style="color:#6f42c1">getForObject</span><span style="color:#24292e">(</span><span style="color:#032f62">"http://localhost:8080/product/{1}"</span><span style="color:#24292e">, Map.class, </span><span style="color:#005cc5">2</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">return</span><span style="color:#24292e"> response1;</span></span>
<span class="line"><span style="color:#24292e">        });</span></span>
<span class="line"><span style="color:#24292e">        Future&lt;Map&lt;</span><span style="color:#d73a49">String</span><span style="color:#24292e">, </span><span style="color:#d73a49">Object</span><span style="color:#24292e">&gt;&gt; f4 </span><span style="color:#d73a49">=</span><span style="color:#24292e"> service.</span><span style="color:#6f42c1">submit</span><span style="color:#24292e">(() </span><span style="color:#d73a49">-&gt;</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">            Map&lt;</span><span style="color:#d73a49">String</span><span style="color:#24292e">, </span><span style="color:#d73a49">Object</span><span style="color:#24292e">&gt; response3 </span><span style="color:#d73a49">=</span><span style="color:#24292e"> restTemplate.</span><span style="color:#6f42c1">getForObject</span><span style="color:#24292e">(</span><span style="color:#032f62">"http://localhost:8080/logistics/{1}"</span><span style="color:#24292e">, Map.class, </span><span style="color:#005cc5">1</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">return</span><span style="color:#24292e"> response3;</span></span>
<span class="line"><span style="color:#24292e">        });</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">        System.out.</span><span style="color:#6f42c1">println</span><span style="color:#24292e">(f1.</span><span style="color:#6f42c1">get</span><span style="color:#24292e">());</span></span>
<span class="line"><span style="color:#24292e">        System.out.</span><span style="color:#6f42c1">println</span><span style="color:#24292e">(f2.</span><span style="color:#6f42c1">get</span><span style="color:#24292e">());</span></span>
<span class="line"><span style="color:#24292e">        System.out.</span><span style="color:#6f42c1">println</span><span style="color:#24292e">(f3.</span><span style="color:#6f42c1">get</span><span style="color:#24292e">());</span></span>
<span class="line"><span style="color:#24292e">        System.out.</span><span style="color:#6f42c1">println</span><span style="color:#24292e">(f4.</span><span style="color:#6f42c1">get</span><span style="color:#24292e">());</span></span>
<span class="line"><span style="color:#24292e">        log.</span><span style="color:#6f42c1">debug</span><span style="color:#24292e">(</span><span style="color:#032f62">"ÊâßË°åÂÆåÊØï"</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">        service.</span><span style="color:#6f42c1">shutdown</span><span style="color:#24292e">();</span></span></code></pre></div><blockquote><p>CountDownLatchÂÖÅËÆ∏ count ‰∏™Á∫øÁ®ãÈòªÂ°ûÂú®‰∏Ä‰∏™Âú∞ÊñπÔºåÁõ¥Ëá≥ÊâÄÊúâÁ∫øÁ®ãÁöÑ‰ªªÂä°ÈÉΩÊâßË°åÂÆåÊØï„ÄÇÂú® Java Âπ∂Âèë‰∏≠Ôºåcountdownlatch ÁöÑÊ¶ÇÂøµÊòØ‰∏Ä‰∏™Â∏∏ËßÅÁöÑÈù¢ËØïÈ¢òÔºåÊâÄ‰ª•‰∏ÄÂÆöË¶ÅÁ°Æ‰øù‰Ω†ÂæàÂ•ΩÁöÑÁêÜËß£‰∫ÜÂÆÉ„ÄÇ</p><p>CountDownLatchÊòØÂÖ±‰∫´ÈîÅÁöÑ‰∏ÄÁßçÂÆûÁé∞,ÂÆÉÈªòËÆ§ÊûÑÈÄ† AQS ÁöÑ state ÂÄº‰∏∫ count„ÄÇÂΩìÁ∫øÁ®ã‰ΩøÁî®countDownÊñπÊ≥ïÊó∂,ÂÖ∂ÂÆû‰ΩøÁî®‰∫Ü<code>tryReleaseShared</code>ÊñπÊ≥ï‰ª•CASÁöÑÊìç‰ΩúÊù•ÂáèÂ∞ëstate,Áõ¥Ëá≥state‰∏∫0Â∞±‰ª£Ë°®ÊâÄÊúâÁöÑÁ∫øÁ®ãÈÉΩË∞ÉÁî®‰∫ÜcountDownÊñπÊ≥ï„ÄÇÂΩìË∞ÉÁî®awaitÊñπÊ≥ïÁöÑÊó∂ÂÄôÔºåÂ¶ÇÊûústate‰∏ç‰∏∫0ÔºåÂ∞±‰ª£Ë°®‰ªçÁÑ∂ÊúâÁ∫øÁ®ãÊ≤°ÊúâË∞ÉÁî®countDownÊñπÊ≥ïÔºåÈÇ£‰πàÂ∞±ÊääÂ∑≤ÁªèË∞ÉÁî®ËøácountDownÁöÑÁ∫øÁ®ãÈÉΩÊîæÂÖ•ÈòªÂ°ûÈòüÂàóPark,Âπ∂Ëá™ÊóãCASÂà§Êñ≠state == 0ÔºåÁõ¥Ëá≥ÊúÄÂêé‰∏Ä‰∏™Á∫øÁ®ãË∞ÉÁî®‰∫ÜcountDownÔºå‰ΩøÂæóstate == 0Ôºå‰∫éÊòØÈòªÂ°ûÁöÑÁ∫øÁ®ã‰æøÂà§Êñ≠ÊàêÂäüÔºåÂÖ®ÈÉ®ÂæÄ‰∏ãÊâßË°å„ÄÇ</p><p>Áî®Êù•ËøõË°åÁ∫øÁ®ãÂêåÊ≠•Âçè‰ΩúÔºåÁ≠âÂæÖÊâÄÊúâÁ∫øÁ®ãÂÆåÊàêÂÄíËÆ°Êó∂„ÄÇ ÂÖ∂‰∏≠ÊûÑÈÄ†ÂèÇÊï∞Áî®Êù•ÂàùÂßãÂåñÁ≠âÂæÖËÆ°Êï∞ÂÄºÔºåawait() Áî®Êù•Á≠âÂæÖËÆ°Êï∞ÂΩíÈõ∂ÔºåcountDown() Áî®Êù•ËÆ©ËÆ°Êï∞Âáè‰∏Ä</p></blockquote><h3 id="_6„ÄÅcyclicbarrier" tabindex="-1">6„ÄÅCyclicBarrier <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20advanced%20chapter#_6„ÄÅcyclicbarrier" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h3><p>CyclicBarri<code>[Ààsa…™kl…™k Ààb√¶ri…ö]</code> Âæ™ÁéØÊ†ÖÊ†èÔºåÁî®Êù•ËøõË°åÁ∫øÁ®ãÂçè‰ΩúÔºåÁ≠âÂæÖÁ∫øÁ®ãÊª°Ë∂≥Êüê‰∏™ËÆ°Êï∞„ÄÇÊûÑÈÄ†Êó∂ËÆæÁΩÆ„ÄéËÆ°Êï∞‰∏™Êï∞„ÄèÔºåÊØè‰∏™Á∫øÁ®ãÊâßË°åÂà∞Êüê‰∏™ÈúÄË¶Å‚ÄúÂêåÊ≠•‚ÄùÁöÑÊó∂ÂàªË∞ÉÁî® await() ÊñπÊ≥ïËøõË°åÁ≠âÂæÖÔºåÂΩìÁ≠âÂæÖÁöÑÁ∫øÁ®ãÊï∞Êª°Ë∂≥„ÄéËÆ°Êï∞‰∏™Êï∞„ÄèÊó∂ÔºåÁªßÁª≠ÊâßË°å„ÄÇË∑üCountdownLatch‰∏ÄÊ†∑Ôºå‰ΩÜËøô‰∏™ÂèØ‰ª•ÈáçÁî®</p><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8">CyclicBarrier cb </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">CyclicBarrier</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">2</span><span style="color:#e1e4e8">); </span><span style="color:#6a737d">// ‰∏™Êï∞‰∏∫2Êó∂Êâç‰ºöÁªßÁª≠ÊâßË°å</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">for</span><span style="color:#e1e4e8"> (</span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> i</span><span style="color:#f97583">=</span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8">;i</span><span style="color:#f97583">&lt;</span><span style="color:#79b8ff">3</span><span style="color:#e1e4e8">;i</span><span style="color:#f97583">++</span><span style="color:#e1e4e8">){</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Thread</span><span style="color:#e1e4e8">(()</span><span style="color:#f97583">-&gt;</span><span style="color:#e1e4e8">{</span></span>
<span class="line"><span style="color:#e1e4e8">                System.out.</span><span style="color:#b392f0">println</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"Á∫øÁ®ã1ÂºÄÂßã.."</span><span style="color:#f97583">+new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Date</span><span style="color:#e1e4e8">());</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#f97583">try</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">                    cb.</span><span style="color:#b392f0">await</span><span style="color:#e1e4e8">(); </span><span style="color:#6a737d">// ÂΩì‰∏™Êï∞‰∏çË∂≥Êó∂ÔºåÁ≠âÂæÖ</span></span>
<span class="line"><span style="color:#e1e4e8">                } </span><span style="color:#f97583">catch</span><span style="color:#e1e4e8"> (InterruptedException | BrokenBarrierException </span><span style="color:#ffab70">e</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">                    e.</span><span style="color:#b392f0">printStackTrace</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">                }</span></span>
<span class="line"><span style="color:#e1e4e8">                System.out.</span><span style="color:#b392f0">println</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"Á∫øÁ®ã1ÁªßÁª≠Âêë‰∏ãËøêË°å..."</span><span style="color:#f97583">+new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Date</span><span style="color:#e1e4e8">());</span></span>
<span class="line"><span style="color:#e1e4e8">            }).</span><span style="color:#b392f0">start</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Thread</span><span style="color:#e1e4e8">(()</span><span style="color:#f97583">-&gt;</span><span style="color:#e1e4e8">{</span></span>
<span class="line"><span style="color:#e1e4e8">                System.out.</span><span style="color:#b392f0">println</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"Á∫øÁ®ã2ÂºÄÂßã.."</span><span style="color:#f97583">+new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Date</span><span style="color:#e1e4e8">());</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#f97583">try</span><span style="color:#e1e4e8"> { Thread.</span><span style="color:#b392f0">sleep</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">2000</span><span style="color:#e1e4e8">); } </span><span style="color:#f97583">catch</span><span style="color:#e1e4e8"> (InterruptedException </span><span style="color:#ffab70">e</span><span style="color:#e1e4e8">) { }</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#f97583">try</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">                    cb.</span><span style="color:#b392f0">await</span><span style="color:#e1e4e8">(); </span><span style="color:#6a737d">// 2 ÁßíÂêéÔºåÁ∫øÁ®ã‰∏™Êï∞Â§ü2ÔºåÁªßÁª≠ËøêË°å</span></span>
<span class="line"><span style="color:#e1e4e8">                } </span><span style="color:#f97583">catch</span><span style="color:#e1e4e8"> (InterruptedException | BrokenBarrierException </span><span style="color:#ffab70">e</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">                    e.</span><span style="color:#b392f0">printStackTrace</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">                }</span></span>
<span class="line"><span style="color:#e1e4e8">                System.out.</span><span style="color:#b392f0">println</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"Á∫øÁ®ã2ÁªßÁª≠Âêë‰∏ãËøêË°å..."</span><span style="color:#f97583">+new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Date</span><span style="color:#e1e4e8">());</span></span>
<span class="line"><span style="color:#e1e4e8">            }).</span><span style="color:#b392f0">start</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">        }</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e">CyclicBarrier cb </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">CyclicBarrier</span><span style="color:#24292e">(</span><span style="color:#005cc5">2</span><span style="color:#24292e">); </span><span style="color:#6a737d">// ‰∏™Êï∞‰∏∫2Êó∂Êâç‰ºöÁªßÁª≠ÊâßË°å</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">for</span><span style="color:#24292e"> (</span><span style="color:#d73a49">int</span><span style="color:#24292e"> i</span><span style="color:#d73a49">=</span><span style="color:#005cc5">0</span><span style="color:#24292e">;i</span><span style="color:#d73a49">&lt;</span><span style="color:#005cc5">3</span><span style="color:#24292e">;i</span><span style="color:#d73a49">++</span><span style="color:#24292e">){</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Thread</span><span style="color:#24292e">(()</span><span style="color:#d73a49">-&gt;</span><span style="color:#24292e">{</span></span>
<span class="line"><span style="color:#24292e">                System.out.</span><span style="color:#6f42c1">println</span><span style="color:#24292e">(</span><span style="color:#032f62">"Á∫øÁ®ã1ÂºÄÂßã.."</span><span style="color:#d73a49">+new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Date</span><span style="color:#24292e">());</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#d73a49">try</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">                    cb.</span><span style="color:#6f42c1">await</span><span style="color:#24292e">(); </span><span style="color:#6a737d">// ÂΩì‰∏™Êï∞‰∏çË∂≥Êó∂ÔºåÁ≠âÂæÖ</span></span>
<span class="line"><span style="color:#24292e">                } </span><span style="color:#d73a49">catch</span><span style="color:#24292e"> (InterruptedException | BrokenBarrierException </span><span style="color:#e36209">e</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">                    e.</span><span style="color:#6f42c1">printStackTrace</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">                }</span></span>
<span class="line"><span style="color:#24292e">                System.out.</span><span style="color:#6f42c1">println</span><span style="color:#24292e">(</span><span style="color:#032f62">"Á∫øÁ®ã1ÁªßÁª≠Âêë‰∏ãËøêË°å..."</span><span style="color:#d73a49">+new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Date</span><span style="color:#24292e">());</span></span>
<span class="line"><span style="color:#24292e">            }).</span><span style="color:#6f42c1">start</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Thread</span><span style="color:#24292e">(()</span><span style="color:#d73a49">-&gt;</span><span style="color:#24292e">{</span></span>
<span class="line"><span style="color:#24292e">                System.out.</span><span style="color:#6f42c1">println</span><span style="color:#24292e">(</span><span style="color:#032f62">"Á∫øÁ®ã2ÂºÄÂßã.."</span><span style="color:#d73a49">+new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Date</span><span style="color:#24292e">());</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#d73a49">try</span><span style="color:#24292e"> { Thread.</span><span style="color:#6f42c1">sleep</span><span style="color:#24292e">(</span><span style="color:#005cc5">2000</span><span style="color:#24292e">); } </span><span style="color:#d73a49">catch</span><span style="color:#24292e"> (InterruptedException </span><span style="color:#e36209">e</span><span style="color:#24292e">) { }</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#d73a49">try</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">                    cb.</span><span style="color:#6f42c1">await</span><span style="color:#24292e">(); </span><span style="color:#6a737d">// 2 ÁßíÂêéÔºåÁ∫øÁ®ã‰∏™Êï∞Â§ü2ÔºåÁªßÁª≠ËøêË°å</span></span>
<span class="line"><span style="color:#24292e">                } </span><span style="color:#d73a49">catch</span><span style="color:#24292e"> (InterruptedException | BrokenBarrierException </span><span style="color:#e36209">e</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">                    e.</span><span style="color:#6f42c1">printStackTrace</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">                }</span></span>
<span class="line"><span style="color:#24292e">                System.out.</span><span style="color:#6f42c1">println</span><span style="color:#24292e">(</span><span style="color:#032f62">"Á∫øÁ®ã2ÁªßÁª≠Âêë‰∏ãËøêË°å..."</span><span style="color:#d73a49">+new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Date</span><span style="color:#24292e">());</span></span>
<span class="line"><span style="color:#24292e">            }).</span><span style="color:#6f42c1">start</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">        }</span></span></code></pre></div><p><strong>‰ΩøÁî®</strong>ÔºàÁ∫øÁ®ãÊï∞ÈúÄ‰∏éËÆ°Êï∞‰∏ÄÊ†∑ÔºåÂê¶ÂàôÁªìÊûú‰ºöÊúâÂÅèÂ∑ÆÔºâ</p><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8">ExecutorService service </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> Executors.</span><span style="color:#b392f0">newFixedThreadPool</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">3</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">        CyclicBarrier barrier </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">CyclicBarrier</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">2</span><span style="color:#e1e4e8">, ()</span><span style="color:#f97583">-&gt;</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#6a737d">//			3‰∏™Á∫øÁ®ãÂÖ∂ÂÆûÊòØ2‰∏™‰ªªÂä°1ÂÆåÊàêÁöÑËÆ°Êï∞Âáè0ÔºåÂπ∂‰∏çÊòØ‰ªªÂä°1Âíå‰ªªÂä°2</span></span>
<span class="line"><span style="color:#e1e4e8">            log.</span><span style="color:#b392f0">debug</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"task1, task2 finish..."</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">        });</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">for</span><span style="color:#e1e4e8"> (</span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> i </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8">; i </span><span style="color:#f97583">&lt;</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">3</span><span style="color:#e1e4e8">; i</span><span style="color:#f97583">++</span><span style="color:#e1e4e8">) { </span><span style="color:#6a737d">// task1(1s)  task2(2s)  task1(1s)</span></span>
<span class="line"><span style="color:#e1e4e8">            service.</span><span style="color:#b392f0">submit</span><span style="color:#e1e4e8">(() </span><span style="color:#f97583">-&gt;</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">                log.</span><span style="color:#b392f0">debug</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"task1 begin..."</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#b392f0">sleep</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">1</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#f97583">try</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">                    barrier.</span><span style="color:#b392f0">await</span><span style="color:#e1e4e8">(); </span><span style="color:#6a737d">// 2-1=1</span></span>
<span class="line"><span style="color:#e1e4e8">                } </span><span style="color:#f97583">catch</span><span style="color:#e1e4e8"> (InterruptedException | BrokenBarrierException </span><span style="color:#ffab70">e</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">                    e.</span><span style="color:#b392f0">printStackTrace</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">                }</span></span>
<span class="line"><span style="color:#e1e4e8">            });</span></span>
<span class="line"><span style="color:#e1e4e8">            service.</span><span style="color:#b392f0">submit</span><span style="color:#e1e4e8">(() </span><span style="color:#f97583">-&gt;</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">                log.</span><span style="color:#b392f0">debug</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"task2 begin..."</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#b392f0">sleep</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">2</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#f97583">try</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">                    barrier.</span><span style="color:#b392f0">await</span><span style="color:#e1e4e8">(); </span><span style="color:#6a737d">// 1-1=0</span></span>
<span class="line"><span style="color:#e1e4e8">                } </span><span style="color:#f97583">catch</span><span style="color:#e1e4e8"> (InterruptedException | BrokenBarrierException </span><span style="color:#ffab70">e</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">                    e.</span><span style="color:#b392f0">printStackTrace</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">                }</span></span>
<span class="line"><span style="color:#e1e4e8">            });</span></span>
<span class="line"><span style="color:#e1e4e8">        }</span></span>
<span class="line"><span style="color:#e1e4e8">        service.</span><span style="color:#b392f0">shutdown</span><span style="color:#e1e4e8">();</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e">ExecutorService service </span><span style="color:#d73a49">=</span><span style="color:#24292e"> Executors.</span><span style="color:#6f42c1">newFixedThreadPool</span><span style="color:#24292e">(</span><span style="color:#005cc5">3</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">        CyclicBarrier barrier </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">CyclicBarrier</span><span style="color:#24292e">(</span><span style="color:#005cc5">2</span><span style="color:#24292e">, ()</span><span style="color:#d73a49">-&gt;</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#6a737d">//			3‰∏™Á∫øÁ®ãÂÖ∂ÂÆûÊòØ2‰∏™‰ªªÂä°1ÂÆåÊàêÁöÑËÆ°Êï∞Âáè0ÔºåÂπ∂‰∏çÊòØ‰ªªÂä°1Âíå‰ªªÂä°2</span></span>
<span class="line"><span style="color:#24292e">            log.</span><span style="color:#6f42c1">debug</span><span style="color:#24292e">(</span><span style="color:#032f62">"task1, task2 finish..."</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">        });</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">for</span><span style="color:#24292e"> (</span><span style="color:#d73a49">int</span><span style="color:#24292e"> i </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#005cc5">0</span><span style="color:#24292e">; i </span><span style="color:#d73a49">&lt;</span><span style="color:#24292e"> </span><span style="color:#005cc5">3</span><span style="color:#24292e">; i</span><span style="color:#d73a49">++</span><span style="color:#24292e">) { </span><span style="color:#6a737d">// task1(1s)  task2(2s)  task1(1s)</span></span>
<span class="line"><span style="color:#24292e">            service.</span><span style="color:#6f42c1">submit</span><span style="color:#24292e">(() </span><span style="color:#d73a49">-&gt;</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">                log.</span><span style="color:#6f42c1">debug</span><span style="color:#24292e">(</span><span style="color:#032f62">"task1 begin..."</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#6f42c1">sleep</span><span style="color:#24292e">(</span><span style="color:#005cc5">1</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#d73a49">try</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">                    barrier.</span><span style="color:#6f42c1">await</span><span style="color:#24292e">(); </span><span style="color:#6a737d">// 2-1=1</span></span>
<span class="line"><span style="color:#24292e">                } </span><span style="color:#d73a49">catch</span><span style="color:#24292e"> (InterruptedException | BrokenBarrierException </span><span style="color:#e36209">e</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">                    e.</span><span style="color:#6f42c1">printStackTrace</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">                }</span></span>
<span class="line"><span style="color:#24292e">            });</span></span>
<span class="line"><span style="color:#24292e">            service.</span><span style="color:#6f42c1">submit</span><span style="color:#24292e">(() </span><span style="color:#d73a49">-&gt;</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">                log.</span><span style="color:#6f42c1">debug</span><span style="color:#24292e">(</span><span style="color:#032f62">"task2 begin..."</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#6f42c1">sleep</span><span style="color:#24292e">(</span><span style="color:#005cc5">2</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#d73a49">try</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">                    barrier.</span><span style="color:#6f42c1">await</span><span style="color:#24292e">(); </span><span style="color:#6a737d">// 1-1=0</span></span>
<span class="line"><span style="color:#24292e">                } </span><span style="color:#d73a49">catch</span><span style="color:#24292e"> (InterruptedException | BrokenBarrierException </span><span style="color:#e36209">e</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">                    e.</span><span style="color:#6f42c1">printStackTrace</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">                }</span></span>
<span class="line"><span style="color:#24292e">            });</span></span>
<span class="line"><span style="color:#24292e">        }</span></span>
<span class="line"><span style="color:#24292e">        service.</span><span style="color:#6f42c1">shutdown</span><span style="color:#24292e">();</span></span></code></pre></div><figure><img src="https://jsd.cdn.zzko.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230719223801911.png" alt="image-20230719223801911" loading="lazy" decoding="async"></figure><blockquote><p><strong>Ê≥®ÊÑè</strong> CyclicBarrier ‰∏é CountDownLatch ÁöÑ‰∏ªË¶ÅÂå∫Âà´Âú®‰∫é CyclicBarrier ÊòØÂèØ‰ª•ÈáçÁî®ÁöÑ CyclicBarrier ÂèØ‰ª•Ë¢´ÊØî Âñª‰∏∫„Äé‰∫∫Êª°ÂèëËΩ¶„Äè</p></blockquote><h3 id="_7„ÄÅÁ∫øÁ®ãÂÆâÂÖ®ÈõÜÂêàÁ±ªÊ¶ÇËø∞" tabindex="-1">7„ÄÅÁ∫øÁ®ãÂÆâÂÖ®ÈõÜÂêàÁ±ªÊ¶ÇËø∞ <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20advanced%20chapter#_7„ÄÅÁ∫øÁ®ãÂÆâÂÖ®ÈõÜÂêàÁ±ªÊ¶ÇËø∞" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h3><figure><img src="https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230720102336819.png" alt="image-20230720102336819" loading="lazy" decoding="async"></figure><p>Á∫øÁ®ãÂÆâÂÖ®ÈõÜÂêàÁ±ªÂèØ‰ª•ÂàÜ‰∏∫‰∏âÂ§ßÁ±ªÔºö</p><ul><li>ÈÅóÁïôÁöÑÁ∫øÁ®ãÂÆâÂÖ®ÈõÜÂêàÂ¶Ç Hashtable Ôºå Vector</li><li>‰ΩøÁî® Collections Ë£ÖÈ•∞ÁöÑÁ∫øÁ®ãÂÆâÂÖ®ÈõÜÂêàÔºåÂ¶ÇÔºö<ul><li>Collections.synchronizedCollection</li><li>Collections.synchronizedList</li><li>Collections.synchronizedMap</li><li>Collections.synchronizedSet</li><li>Collections.synchronizedNavigableMap</li><li>Collections.synchronizedNavigableSet</li><li>Collections.synchronizedSortedMap</li><li>Collections.synchronizedSortedSet</li></ul></li><li>java.util.concurrent.*</li></ul><p>ÈáçÁÇπ‰ªãÁªç java.util.concurrent.* ‰∏ãÁöÑÁ∫øÁ®ãÂÆâÂÖ®ÈõÜÂêàÁ±ªÔºåÂèØ‰ª•ÂèëÁé∞ÂÆÉ‰ª¨ÊúâËßÑÂæãÔºåÈáåÈù¢ÂåÖÂê´‰∏âÁ±ªÂÖ≥ÈîÆËØçÔºöBlocking„ÄÅCopyOnWrite„ÄÅConcurrent</p><ul><li>Blocking Â§ßÈÉ®ÂàÜÂÆûÁé∞Âü∫‰∫éÈîÅÔºåÂπ∂Êèê‰æõÁî®Êù•ÈòªÂ°ûÁöÑÊñπÊ≥ï</li><li>CopyOnWrite ‰πãÁ±ªÂÆπÂô®‰øÆÊîπÂºÄÈîÄÁõ∏ÂØπËæÉÈáç</li><li>Concurrent Á±ªÂûãÁöÑÂÆπÂô®<ul><li>ÂÜÖÈÉ®ÂæàÂ§öÊìç‰Ωú‰ΩøÁî® cas ‰ºòÂåñÔºå‰∏ÄËà¨ÂèØ‰ª•Êèê‰æõËæÉÈ´òÂêûÂêêÈáè</li><li>Âº±‰∏ÄËá¥ÊÄß<ul><li>ÈÅçÂéÜÊó∂Âº±‰∏ÄËá¥ÊÄßÔºå‰æãÂ¶ÇÔºåÂΩìÂà©Áî®Ëø≠‰ª£Âô®ÈÅçÂéÜÊó∂ÔºåÂ¶ÇÊûúÂÆπÂô®ÂèëÁîü‰øÆÊîπÔºåËø≠‰ª£Âô®‰ªçÁÑ∂ÂèØ‰ª•ÁªßÁª≠ËøõË°åÈÅçÂéÜÔºåËøôÊó∂ÂÜÖÂÆπÊòØÊóßÁöÑ</li><li>Ê±ÇÂ§ßÂ∞èÂº±‰∏ÄËá¥ÊÄßÔºåsize Êìç‰ΩúÊú™ÂøÖÊòØ 100% ÂáÜÁ°Æ</li><li>ËØªÂèñÂº±‰∏ÄËá¥ÊÄß</li></ul></li></ul></li></ul><blockquote><p>ÈÅçÂéÜÊó∂Â¶ÇÊûúÂèëÁîü‰∫Ü‰øÆÊîπÔºåÂØπ‰∫éÈùûÂÆâÂÖ®ÂÆπÂô®Êù•ËÆ≤Ôºå‰ΩøÁî® fail-fast Êú∫Âà∂‰πüÂ∞±ÊòØËÆ©ÈÅçÂéÜÁ´ãÂàªÂ§±Ë¥•ÔºåÊäõÂá∫ConcurrentModificationExceptionÔºå‰∏çÂÜçÁªßÁª≠ÈÅçÂéÜ</p></blockquote><h3 id="_8„ÄÅconcurrenthashmap" tabindex="-1">8„ÄÅConcurrentHashMap <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20advanced%20chapter#_8„ÄÅconcurrenthashmap" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h3><h4 id="ÁªÉ‰π†-ÂçïËØçËÆ°Êï∞" tabindex="-1">ÁªÉ‰π†ÔºöÂçïËØçËÆ°Êï∞ <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20advanced%20chapter#ÁªÉ‰π†-ÂçïËØçËÆ°Êï∞" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h4><p>ÁîüÊàêÊµãËØïÊï∞ÊçÆ</p><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#f97583">static</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">final</span><span style="color:#e1e4e8"> String ALPHA </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#9ecbff">"abcedfghijklmnopqrstuvwxyz"</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">static</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">void</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">main</span><span style="color:#e1e4e8">(</span><span style="color:#f97583">String</span><span style="color:#e1e4e8">[] args) {</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> length </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> ALPHA.</span><span style="color:#b392f0">length</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> count </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">200</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">    List&lt;</span><span style="color:#f97583">String</span><span style="color:#e1e4e8">&gt; list </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> ArrayList&lt;&gt;(length </span><span style="color:#f97583">*</span><span style="color:#e1e4e8"> count);</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">for</span><span style="color:#e1e4e8"> (</span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> i </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8">; i </span><span style="color:#f97583">&lt;</span><span style="color:#e1e4e8"> length; i</span><span style="color:#f97583">++</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">char</span><span style="color:#e1e4e8"> ch </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> ALPHA.</span><span style="color:#b392f0">charAt</span><span style="color:#e1e4e8">(i);</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">for</span><span style="color:#e1e4e8"> (</span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> j </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8">; j </span><span style="color:#f97583">&lt;</span><span style="color:#e1e4e8"> count; j</span><span style="color:#f97583">++</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">        list.</span><span style="color:#b392f0">add</span><span style="color:#e1e4e8">(String.</span><span style="color:#b392f0">valueOf</span><span style="color:#e1e4e8">(ch));</span></span>
<span class="line"><span style="color:#e1e4e8">        }</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"><span style="color:#e1e4e8">    Collections.</span><span style="color:#b392f0">shuffle</span><span style="color:#e1e4e8">(list);</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">for</span><span style="color:#e1e4e8"> (</span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> i </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8">; i </span><span style="color:#f97583">&lt;</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">26</span><span style="color:#e1e4e8">; i</span><span style="color:#f97583">++</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">    	</span><span style="color:#f97583">try</span><span style="color:#e1e4e8"> (PrintWriter out </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">PrintWriter</span><span style="color:#e1e4e8">(</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">OutputStreamWriter</span><span style="color:#e1e4e8">(</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">FileOutputStream</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"tmp/"</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">+</span><span style="color:#e1e4e8"> (i</span><span style="color:#f97583">+</span><span style="color:#79b8ff">1</span><span style="color:#e1e4e8">) </span><span style="color:#f97583">+</span><span style="color:#e1e4e8"> </span><span style="color:#9ecbff">".txt"</span><span style="color:#e1e4e8">)))) {</span></span>
<span class="line"><span style="color:#e1e4e8">        String collect </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> list.</span><span style="color:#b392f0">subList</span><span style="color:#e1e4e8">(i </span><span style="color:#f97583">*</span><span style="color:#e1e4e8"> count, (i </span><span style="color:#f97583">+</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">1</span><span style="color:#e1e4e8">) </span><span style="color:#f97583">*</span><span style="color:#e1e4e8"> count).</span><span style="color:#b392f0">stream</span><span style="color:#e1e4e8">()</span></span>
<span class="line"><span style="color:#e1e4e8">        .</span><span style="color:#b392f0">collect</span><span style="color:#e1e4e8">(Collectors.</span><span style="color:#b392f0">joining</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"</span><span style="color:#79b8ff">\n</span><span style="color:#9ecbff">"</span><span style="color:#e1e4e8">));</span></span>
<span class="line"><span style="color:#e1e4e8">        out.</span><span style="color:#b392f0">print</span><span style="color:#e1e4e8">(collect);</span></span>
<span class="line"><span style="color:#e1e4e8">        } </span><span style="color:#f97583">catch</span><span style="color:#e1e4e8"> (IOException </span><span style="color:#ffab70">e</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">        }</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"><span style="color:#e1e4e8">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#d73a49">static</span><span style="color:#24292e"> </span><span style="color:#d73a49">final</span><span style="color:#24292e"> String ALPHA </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#032f62">"abcedfghijklmnopqrstuvwxyz"</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">static</span><span style="color:#24292e"> </span><span style="color:#d73a49">void</span><span style="color:#24292e"> </span><span style="color:#6f42c1">main</span><span style="color:#24292e">(</span><span style="color:#d73a49">String</span><span style="color:#24292e">[] args) {</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">int</span><span style="color:#24292e"> length </span><span style="color:#d73a49">=</span><span style="color:#24292e"> ALPHA.</span><span style="color:#6f42c1">length</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">int</span><span style="color:#24292e"> count </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#005cc5">200</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">    List&lt;</span><span style="color:#d73a49">String</span><span style="color:#24292e">&gt; list </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> ArrayList&lt;&gt;(length </span><span style="color:#d73a49">*</span><span style="color:#24292e"> count);</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">for</span><span style="color:#24292e"> (</span><span style="color:#d73a49">int</span><span style="color:#24292e"> i </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#005cc5">0</span><span style="color:#24292e">; i </span><span style="color:#d73a49">&lt;</span><span style="color:#24292e"> length; i</span><span style="color:#d73a49">++</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">char</span><span style="color:#24292e"> ch </span><span style="color:#d73a49">=</span><span style="color:#24292e"> ALPHA.</span><span style="color:#6f42c1">charAt</span><span style="color:#24292e">(i);</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">for</span><span style="color:#24292e"> (</span><span style="color:#d73a49">int</span><span style="color:#24292e"> j </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#005cc5">0</span><span style="color:#24292e">; j </span><span style="color:#d73a49">&lt;</span><span style="color:#24292e"> count; j</span><span style="color:#d73a49">++</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">        list.</span><span style="color:#6f42c1">add</span><span style="color:#24292e">(String.</span><span style="color:#6f42c1">valueOf</span><span style="color:#24292e">(ch));</span></span>
<span class="line"><span style="color:#24292e">        }</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"><span style="color:#24292e">    Collections.</span><span style="color:#6f42c1">shuffle</span><span style="color:#24292e">(list);</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">for</span><span style="color:#24292e"> (</span><span style="color:#d73a49">int</span><span style="color:#24292e"> i </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#005cc5">0</span><span style="color:#24292e">; i </span><span style="color:#d73a49">&lt;</span><span style="color:#24292e"> </span><span style="color:#005cc5">26</span><span style="color:#24292e">; i</span><span style="color:#d73a49">++</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">    	</span><span style="color:#d73a49">try</span><span style="color:#24292e"> (PrintWriter out </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">PrintWriter</span><span style="color:#24292e">(</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">OutputStreamWriter</span><span style="color:#24292e">(</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">FileOutputStream</span><span style="color:#24292e">(</span><span style="color:#032f62">"tmp/"</span><span style="color:#24292e"> </span><span style="color:#d73a49">+</span><span style="color:#24292e"> (i</span><span style="color:#d73a49">+</span><span style="color:#005cc5">1</span><span style="color:#24292e">) </span><span style="color:#d73a49">+</span><span style="color:#24292e"> </span><span style="color:#032f62">".txt"</span><span style="color:#24292e">)))) {</span></span>
<span class="line"><span style="color:#24292e">        String collect </span><span style="color:#d73a49">=</span><span style="color:#24292e"> list.</span><span style="color:#6f42c1">subList</span><span style="color:#24292e">(i </span><span style="color:#d73a49">*</span><span style="color:#24292e"> count, (i </span><span style="color:#d73a49">+</span><span style="color:#24292e"> </span><span style="color:#005cc5">1</span><span style="color:#24292e">) </span><span style="color:#d73a49">*</span><span style="color:#24292e"> count).</span><span style="color:#6f42c1">stream</span><span style="color:#24292e">()</span></span>
<span class="line"><span style="color:#24292e">        .</span><span style="color:#6f42c1">collect</span><span style="color:#24292e">(Collectors.</span><span style="color:#6f42c1">joining</span><span style="color:#24292e">(</span><span style="color:#032f62">"</span><span style="color:#005cc5">\n</span><span style="color:#032f62">"</span><span style="color:#24292e">));</span></span>
<span class="line"><span style="color:#24292e">        out.</span><span style="color:#6f42c1">print</span><span style="color:#24292e">(collect);</span></span>
<span class="line"><span style="color:#24292e">        } </span><span style="color:#d73a49">catch</span><span style="color:#24292e"> (IOException </span><span style="color:#e36209">e</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">        }</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"><span style="color:#24292e">}</span></span></code></pre></div><p>Ê®°Áâà‰ª£Á†ÅÔºåÊ®°Áâà‰ª£Á†Å‰∏≠Â∞ÅË£Ö‰∫ÜÂ§öÁ∫øÁ®ãËØªÂèñÊñá‰ª∂ÁöÑ‰ª£Á†Å</p><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#f97583">private</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">static</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">&lt;</span><span style="color:#e1e4e8">V</span><span style="color:#f97583">&gt;</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">void</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">demo</span><span style="color:#e1e4e8">(Supplier</span><span style="color:#f97583">&lt;</span><span style="color:#e1e4e8">Map</span><span style="color:#f97583">&lt;</span><span style="color:#e1e4e8">String, V</span><span style="color:#f97583">&gt;&gt;</span><span style="color:#e1e4e8"> supplier, BiConsumer</span><span style="color:#f97583">&lt;</span><span style="color:#e1e4e8">Map</span><span style="color:#f97583">&lt;</span><span style="color:#e1e4e8">String, V</span><span style="color:#f97583">&gt;</span><span style="color:#e1e4e8">, List</span><span style="color:#f97583">&lt;</span><span style="color:#e1e4e8">String</span><span style="color:#f97583">&gt;&gt;</span><span style="color:#e1e4e8"> consumer) {</span></span>
<span class="line"><span style="color:#e1e4e8">    Map&lt;</span><span style="color:#f97583">String</span><span style="color:#e1e4e8">, </span><span style="color:#f97583">V</span><span style="color:#e1e4e8">&gt; counterMap </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> supplier.</span><span style="color:#b392f0">get</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">// key value</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">// a   200</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">// b   200</span></span>
<span class="line"><span style="color:#e1e4e8">    List&lt;</span><span style="color:#f97583">Thread</span><span style="color:#e1e4e8">&gt; ts </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> ArrayList&lt;&gt;();</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">for</span><span style="color:#e1e4e8"> (</span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> i </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">1</span><span style="color:#e1e4e8">; i </span><span style="color:#f97583">&lt;=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">26</span><span style="color:#e1e4e8">; i</span><span style="color:#f97583">++</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> idx </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> i;</span></span>
<span class="line"><span style="color:#e1e4e8">        Thread thread </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Thread</span><span style="color:#e1e4e8">(() </span><span style="color:#f97583">-&gt;</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">            List&lt;</span><span style="color:#f97583">String</span><span style="color:#e1e4e8">&gt; words </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">readFromFile</span><span style="color:#e1e4e8">(idx);</span></span>
<span class="line"><span style="color:#e1e4e8">            consumer.</span><span style="color:#b392f0">accept</span><span style="color:#e1e4e8">(counterMap, words);</span></span>
<span class="line"><span style="color:#e1e4e8">        });</span></span>
<span class="line"><span style="color:#e1e4e8">        ts.</span><span style="color:#b392f0">add</span><span style="color:#e1e4e8">(thread);</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">    ts.</span><span style="color:#b392f0">forEach</span><span style="color:#e1e4e8">(t </span><span style="color:#f97583">-&gt;</span><span style="color:#e1e4e8"> t.</span><span style="color:#b392f0">start</span><span style="color:#e1e4e8">());</span></span>
<span class="line"><span style="color:#e1e4e8">    ts.</span><span style="color:#b392f0">forEach</span><span style="color:#e1e4e8">(t </span><span style="color:#f97583">-&gt;</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">try</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">            t.</span><span style="color:#b392f0">join</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">        } </span><span style="color:#f97583">catch</span><span style="color:#e1e4e8"> (InterruptedException </span><span style="color:#ffab70">e</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">            e.</span><span style="color:#b392f0">printStackTrace</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">        }</span></span>
<span class="line"><span style="color:#e1e4e8">    });</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">    System.out.</span><span style="color:#b392f0">println</span><span style="color:#e1e4e8">(counterMap);</span></span>
<span class="line"><span style="color:#e1e4e8">}</span></span>
<span class="line"><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">static</span><span style="color:#e1e4e8"> List</span><span style="color:#f97583">&lt;</span><span style="color:#e1e4e8">String</span><span style="color:#f97583">&gt;</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">readFromFile</span><span style="color:#e1e4e8">(</span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> i) {</span></span>
<span class="line"><span style="color:#e1e4e8">        ArrayList&lt;</span><span style="color:#f97583">String</span><span style="color:#e1e4e8">&gt; words </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> ArrayList&lt;&gt;();</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">try</span><span style="color:#e1e4e8"> (BufferedReader in </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">BufferedReader</span><span style="color:#e1e4e8">(</span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">InputStreamReader</span><span style="color:#e1e4e8">(</span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">FileInputStream</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"tmp/"</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">+</span><span style="color:#e1e4e8"> i </span><span style="color:#f97583">+</span><span style="color:#e1e4e8"> </span><span style="color:#9ecbff">".txt"</span><span style="color:#e1e4e8">)))) {</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">while</span><span style="color:#e1e4e8"> (</span><span style="color:#79b8ff">true</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">                String word </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> in.</span><span style="color:#b392f0">readLine</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (word </span><span style="color:#f97583">==</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">                    </span><span style="color:#f97583">break</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">                }</span></span>
<span class="line"><span style="color:#e1e4e8">                words.</span><span style="color:#b392f0">add</span><span style="color:#e1e4e8">(word);</span></span>
<span class="line"><span style="color:#e1e4e8">            }</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> words;</span></span>
<span class="line"><span style="color:#e1e4e8">        } </span><span style="color:#f97583">catch</span><span style="color:#e1e4e8"> (IOException </span><span style="color:#ffab70">e</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">throw</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">RuntimeException</span><span style="color:#e1e4e8">(e);</span></span>
<span class="line"><span style="color:#e1e4e8">        }</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#d73a49">private</span><span style="color:#24292e"> </span><span style="color:#d73a49">static</span><span style="color:#24292e"> </span><span style="color:#d73a49">&lt;</span><span style="color:#24292e">V</span><span style="color:#d73a49">&gt;</span><span style="color:#24292e"> </span><span style="color:#d73a49">void</span><span style="color:#24292e"> </span><span style="color:#6f42c1">demo</span><span style="color:#24292e">(Supplier</span><span style="color:#d73a49">&lt;</span><span style="color:#24292e">Map</span><span style="color:#d73a49">&lt;</span><span style="color:#24292e">String, V</span><span style="color:#d73a49">&gt;&gt;</span><span style="color:#24292e"> supplier, BiConsumer</span><span style="color:#d73a49">&lt;</span><span style="color:#24292e">Map</span><span style="color:#d73a49">&lt;</span><span style="color:#24292e">String, V</span><span style="color:#d73a49">&gt;</span><span style="color:#24292e">, List</span><span style="color:#d73a49">&lt;</span><span style="color:#24292e">String</span><span style="color:#d73a49">&gt;&gt;</span><span style="color:#24292e"> consumer) {</span></span>
<span class="line"><span style="color:#24292e">    Map&lt;</span><span style="color:#d73a49">String</span><span style="color:#24292e">, </span><span style="color:#d73a49">V</span><span style="color:#24292e">&gt; counterMap </span><span style="color:#d73a49">=</span><span style="color:#24292e"> supplier.</span><span style="color:#6f42c1">get</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">// key value</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">// a   200</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">// b   200</span></span>
<span class="line"><span style="color:#24292e">    List&lt;</span><span style="color:#d73a49">Thread</span><span style="color:#24292e">&gt; ts </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> ArrayList&lt;&gt;();</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">for</span><span style="color:#24292e"> (</span><span style="color:#d73a49">int</span><span style="color:#24292e"> i </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#005cc5">1</span><span style="color:#24292e">; i </span><span style="color:#d73a49">&lt;=</span><span style="color:#24292e"> </span><span style="color:#005cc5">26</span><span style="color:#24292e">; i</span><span style="color:#d73a49">++</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">int</span><span style="color:#24292e"> idx </span><span style="color:#d73a49">=</span><span style="color:#24292e"> i;</span></span>
<span class="line"><span style="color:#24292e">        Thread thread </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Thread</span><span style="color:#24292e">(() </span><span style="color:#d73a49">-&gt;</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">            List&lt;</span><span style="color:#d73a49">String</span><span style="color:#24292e">&gt; words </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#6f42c1">readFromFile</span><span style="color:#24292e">(idx);</span></span>
<span class="line"><span style="color:#24292e">            consumer.</span><span style="color:#6f42c1">accept</span><span style="color:#24292e">(counterMap, words);</span></span>
<span class="line"><span style="color:#24292e">        });</span></span>
<span class="line"><span style="color:#24292e">        ts.</span><span style="color:#6f42c1">add</span><span style="color:#24292e">(thread);</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">    ts.</span><span style="color:#6f42c1">forEach</span><span style="color:#24292e">(t </span><span style="color:#d73a49">-&gt;</span><span style="color:#24292e"> t.</span><span style="color:#6f42c1">start</span><span style="color:#24292e">());</span></span>
<span class="line"><span style="color:#24292e">    ts.</span><span style="color:#6f42c1">forEach</span><span style="color:#24292e">(t </span><span style="color:#d73a49">-&gt;</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">try</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">            t.</span><span style="color:#6f42c1">join</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">        } </span><span style="color:#d73a49">catch</span><span style="color:#24292e"> (InterruptedException </span><span style="color:#e36209">e</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">            e.</span><span style="color:#6f42c1">printStackTrace</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">        }</span></span>
<span class="line"><span style="color:#24292e">    });</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">    System.out.</span><span style="color:#6f42c1">println</span><span style="color:#24292e">(counterMap);</span></span>
<span class="line"><span style="color:#24292e">}</span></span>
<span class="line"><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">static</span><span style="color:#24292e"> List</span><span style="color:#d73a49">&lt;</span><span style="color:#24292e">String</span><span style="color:#d73a49">&gt;</span><span style="color:#24292e"> </span><span style="color:#6f42c1">readFromFile</span><span style="color:#24292e">(</span><span style="color:#d73a49">int</span><span style="color:#24292e"> i) {</span></span>
<span class="line"><span style="color:#24292e">        ArrayList&lt;</span><span style="color:#d73a49">String</span><span style="color:#24292e">&gt; words </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> ArrayList&lt;&gt;();</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">try</span><span style="color:#24292e"> (BufferedReader in </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">BufferedReader</span><span style="color:#24292e">(</span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">InputStreamReader</span><span style="color:#24292e">(</span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">FileInputStream</span><span style="color:#24292e">(</span><span style="color:#032f62">"tmp/"</span><span style="color:#24292e"> </span><span style="color:#d73a49">+</span><span style="color:#24292e"> i </span><span style="color:#d73a49">+</span><span style="color:#24292e"> </span><span style="color:#032f62">".txt"</span><span style="color:#24292e">)))) {</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">while</span><span style="color:#24292e"> (</span><span style="color:#005cc5">true</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">                String word </span><span style="color:#d73a49">=</span><span style="color:#24292e"> in.</span><span style="color:#6f42c1">readLine</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (word </span><span style="color:#d73a49">==</span><span style="color:#24292e"> </span><span style="color:#005cc5">null</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">                    </span><span style="color:#d73a49">break</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">                }</span></span>
<span class="line"><span style="color:#24292e">                words.</span><span style="color:#6f42c1">add</span><span style="color:#24292e">(word);</span></span>
<span class="line"><span style="color:#24292e">            }</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">return</span><span style="color:#24292e"> words;</span></span>
<span class="line"><span style="color:#24292e">        } </span><span style="color:#d73a49">catch</span><span style="color:#24292e"> (IOException </span><span style="color:#e36209">e</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">throw</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">RuntimeException</span><span style="color:#24292e">(e);</span></span>
<span class="line"><span style="color:#24292e">        }</span></span>
<span class="line"><span style="color:#24292e">    }</span></span></code></pre></div><p>‰Ω†Ë¶ÅÂÅöÁöÑÊòØÂÆûÁé∞‰∏§‰∏™ÂèÇÊï∞</p><ul><li>‰∏ÄÊòØÊèê‰æõ‰∏Ä‰∏™ map ÈõÜÂêàÔºåÁî®Êù•Â≠òÊîæÊØè‰∏™ÂçïËØçÁöÑËÆ°Êï∞ÁªìÊûúÔºåkey ‰∏∫ÂçïËØçÔºåvalue ‰∏∫ËÆ°Êï∞</li><li>‰∫åÊòØÊèê‰æõ‰∏ÄÁªÑÊìç‰ΩúÔºå‰øùËØÅËÆ°Êï∞ÁöÑÂÆâÂÖ®ÊÄßÔºå‰ºö‰º†ÈÄí map ÈõÜÂêà‰ª•Âèä ÂçïËØç List</li></ul><p>Ê≠£Á°ÆÁªìÊûúËæìÂá∫Â∫îËØ•ÊòØÊØè‰∏™ÂçïËØçÂá∫Áé∞ 200 Ê¨°</p><figure><img src="https://jsd.cdn.zzko.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230720104641336.png" alt="image-20230720104641336" loading="lazy" decoding="async"></figure><p>ÈîôËØØÂÆûÁé∞</p><figure><img src="https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230720104829263.png" alt="image-20230720104829263" loading="lazy" decoding="async"></figure><p>Êç¢ÊàêConcurrentHashMapÁªìÊûú‰πü‰∏ÄÊ†∑ÔºåÂõ†‰∏∫ÂØπÊï∞ÊçÆÁöÑËé∑Âèñ„ÄÅËÆ°ÁÆó„ÄÅËÆæÁΩÆÁ≠âÁªÑÂêàÊìç‰Ωú‰∏çÊòØÂéüÂ≠êÊìç‰Ωú</p><figure><img src="https://jsd.cdn.zzko.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230720104953284.png" alt="image-20230720104953284" loading="lazy" decoding="async"></figure><p>Ê≠£Á°ÆÂÆûÁé∞</p><ul><li><p>ÁÆÄÂçïÁ≤óÊö¥Â∞±ÊòØÂä†synchronizedÈîÅ</p></li><li><p>computeIfAbsent+LongAdder</p></li></ul><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">static</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">void</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">main</span><span style="color:#e1e4e8">(</span><span style="color:#f97583">String</span><span style="color:#e1e4e8">[] args) {</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#b392f0">demo</span><span style="color:#e1e4e8">(</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#6a737d">// ÂàõÂª∫ map ÈõÜÂêà</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#6a737d">// ÂàõÂª∫ ConcurrentHashMap ÂØπ‰∏çÂØπÔºü</span></span>
<span class="line"><span style="color:#e1e4e8">            () </span><span style="color:#f97583">-&gt;</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> ConcurrentHashMap&lt;</span><span style="color:#f97583">String</span><span style="color:#e1e4e8">, </span><span style="color:#f97583">LongAdder</span><span style="color:#e1e4e8">&gt;(</span><span style="color:#79b8ff">8</span><span style="color:#e1e4e8">,</span><span style="color:#79b8ff">0.75f</span><span style="color:#e1e4e8">,</span><span style="color:#79b8ff">8</span><span style="color:#e1e4e8">),</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">            (map, words) </span><span style="color:#f97583">-&gt;</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#f97583">for</span><span style="color:#e1e4e8"> (String word </span><span style="color:#f97583">:</span><span style="color:#e1e4e8"> words) {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">                    </span><span style="color:#6a737d">// Â¶ÇÊûúÁº∫Â∞ë‰∏Ä‰∏™ keyÔºåÂàôËÆ°ÁÆóÁîüÊàê‰∏Ä‰∏™ value , ÁÑ∂ÂêéÂ∞Ü  key value ÊîæÂÖ• map</span></span>
<span class="line"><span style="color:#e1e4e8">                    </span><span style="color:#6a737d">//                  a      0</span></span>
<span class="line"><span style="color:#e1e4e8">                    LongAdder value </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> map.</span><span style="color:#b392f0">computeIfAbsent</span><span style="color:#e1e4e8">(word, (key) </span><span style="color:#f97583">-&gt;</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">LongAdder</span><span style="color:#e1e4e8">());</span></span>
<span class="line"><span style="color:#e1e4e8">                    </span><span style="color:#6a737d">// ÊâßË°åÁ¥ØÂä†</span></span>
<span class="line"><span style="color:#e1e4e8">                    value.</span><span style="color:#b392f0">increment</span><span style="color:#e1e4e8">(); </span><span style="color:#6a737d">// 2</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">                    </span><span style="color:#6a737d">/*// Ê£ÄÊü• key ÊúâÊ≤°Êúâ</span></span>
<span class="line"><span style="color:#6a737d">                    Integer counter = map.get(word);</span></span>
<span class="line"><span style="color:#6a737d">                    int newValue = counter == null ? 1 : counter + 1;</span></span>
<span class="line"><span style="color:#6a737d">                    // Ê≤°Êúâ Âàô put</span></span>
<span class="line"><span style="color:#6a737d">                    map.put(word, newValue);*/</span></span>
<span class="line"><span style="color:#e1e4e8">                }</span></span>
<span class="line"><span style="color:#e1e4e8">            }</span></span>
<span class="line"><span style="color:#e1e4e8">    );</span></span>
<span class="line"><span style="color:#e1e4e8">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">static</span><span style="color:#24292e"> </span><span style="color:#d73a49">void</span><span style="color:#24292e"> </span><span style="color:#6f42c1">main</span><span style="color:#24292e">(</span><span style="color:#d73a49">String</span><span style="color:#24292e">[] args) {</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6f42c1">demo</span><span style="color:#24292e">(</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#6a737d">// ÂàõÂª∫ map ÈõÜÂêà</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#6a737d">// ÂàõÂª∫ ConcurrentHashMap ÂØπ‰∏çÂØπÔºü</span></span>
<span class="line"><span style="color:#24292e">            () </span><span style="color:#d73a49">-&gt;</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> ConcurrentHashMap&lt;</span><span style="color:#d73a49">String</span><span style="color:#24292e">, </span><span style="color:#d73a49">LongAdder</span><span style="color:#24292e">&gt;(</span><span style="color:#005cc5">8</span><span style="color:#24292e">,</span><span style="color:#005cc5">0.75f</span><span style="color:#24292e">,</span><span style="color:#005cc5">8</span><span style="color:#24292e">),</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">            (map, words) </span><span style="color:#d73a49">-&gt;</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#d73a49">for</span><span style="color:#24292e"> (String word </span><span style="color:#d73a49">:</span><span style="color:#24292e"> words) {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">                    </span><span style="color:#6a737d">// Â¶ÇÊûúÁº∫Â∞ë‰∏Ä‰∏™ keyÔºåÂàôËÆ°ÁÆóÁîüÊàê‰∏Ä‰∏™ value , ÁÑ∂ÂêéÂ∞Ü  key value ÊîæÂÖ• map</span></span>
<span class="line"><span style="color:#24292e">                    </span><span style="color:#6a737d">//                  a      0</span></span>
<span class="line"><span style="color:#24292e">                    LongAdder value </span><span style="color:#d73a49">=</span><span style="color:#24292e"> map.</span><span style="color:#6f42c1">computeIfAbsent</span><span style="color:#24292e">(word, (key) </span><span style="color:#d73a49">-&gt;</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">LongAdder</span><span style="color:#24292e">());</span></span>
<span class="line"><span style="color:#24292e">                    </span><span style="color:#6a737d">// ÊâßË°åÁ¥ØÂä†</span></span>
<span class="line"><span style="color:#24292e">                    value.</span><span style="color:#6f42c1">increment</span><span style="color:#24292e">(); </span><span style="color:#6a737d">// 2</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">                    </span><span style="color:#6a737d">/*// Ê£ÄÊü• key ÊúâÊ≤°Êúâ</span></span>
<span class="line"><span style="color:#6a737d">                    Integer counter = map.get(word);</span></span>
<span class="line"><span style="color:#6a737d">                    int newValue = counter == null ? 1 : counter + 1;</span></span>
<span class="line"><span style="color:#6a737d">                    // Ê≤°Êúâ Âàô put</span></span>
<span class="line"><span style="color:#6a737d">                    map.put(word, newValue);*/</span></span>
<span class="line"><span style="color:#24292e">                }</span></span>
<span class="line"><span style="color:#24292e">            }</span></span>
<span class="line"><span style="color:#24292e">    );</span></span>
<span class="line"><span style="color:#24292e">}</span></span></code></pre></div><ul><li>merge+sum</li></ul><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#b392f0">demo</span><span style="color:#e1e4e8">(</span></span>
<span class="line"><span style="color:#e1e4e8">    	() </span><span style="color:#f97583">-&gt;</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> ConcurrentHashMap&lt;</span><span style="color:#f97583">String</span><span style="color:#e1e4e8">, </span><span style="color:#f97583">Integer</span><span style="color:#e1e4e8">&gt;(),</span></span>
<span class="line"><span style="color:#e1e4e8">            (map, words) </span><span style="color:#f97583">-&gt;</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#f97583">for</span><span style="color:#e1e4e8"> (String word </span><span style="color:#f97583">:</span><span style="color:#e1e4e8"> words) {</span></span>
<span class="line"><span style="color:#e1e4e8">                    </span><span style="color:#6a737d">// ÂáΩÊï∞ÂºèÁºñÁ®ãÔºåÊó†ÈúÄÂéüÂ≠êÂèòÈáè</span></span>
<span class="line"><span style="color:#e1e4e8">                    map.</span><span style="color:#b392f0">merge</span><span style="color:#e1e4e8">(word, </span><span style="color:#79b8ff">1</span><span style="color:#e1e4e8">, Integer</span><span style="color:#f97583">::</span><span style="color:#e1e4e8">sum);</span></span>
<span class="line"><span style="color:#e1e4e8">                }</span></span>
<span class="line"><span style="color:#e1e4e8">            }</span></span>
<span class="line"><span style="color:#e1e4e8">);</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6f42c1">demo</span><span style="color:#24292e">(</span></span>
<span class="line"><span style="color:#24292e">    	() </span><span style="color:#d73a49">-&gt;</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> ConcurrentHashMap&lt;</span><span style="color:#d73a49">String</span><span style="color:#24292e">, </span><span style="color:#d73a49">Integer</span><span style="color:#24292e">&gt;(),</span></span>
<span class="line"><span style="color:#24292e">            (map, words) </span><span style="color:#d73a49">-&gt;</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#d73a49">for</span><span style="color:#24292e"> (String word </span><span style="color:#d73a49">:</span><span style="color:#24292e"> words) {</span></span>
<span class="line"><span style="color:#24292e">                    </span><span style="color:#6a737d">// ÂáΩÊï∞ÂºèÁºñÁ®ãÔºåÊó†ÈúÄÂéüÂ≠êÂèòÈáè</span></span>
<span class="line"><span style="color:#24292e">                    map.</span><span style="color:#6f42c1">merge</span><span style="color:#24292e">(word, </span><span style="color:#005cc5">1</span><span style="color:#24292e">, Integer</span><span style="color:#d73a49">::</span><span style="color:#24292e">sum);</span></span>
<span class="line"><span style="color:#24292e">                }</span></span>
<span class="line"><span style="color:#24292e">            }</span></span>
<span class="line"><span style="color:#24292e">);</span></span></code></pre></div><h4 id="concurrenthashmap-ÂéüÁêÜ" tabindex="-1">ConcurrentHashMap ÂéüÁêÜ <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20advanced%20chapter#concurrenthashmap-ÂéüÁêÜ" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h4><h5 id="jdk-7-hashmap-Âπ∂ÂèëÊ≠ªÈìæ" tabindex="-1">JDK 7 HashMap Âπ∂ÂèëÊ≠ªÈìæ <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20advanced%20chapter#jdk-7-hashmap-Âπ∂ÂèëÊ≠ªÈìæ" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h5><h6 id="ÊµãËØï‰ª£Á†Å" tabindex="-1">ÊµãËØï‰ª£Á†Å <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20advanced%20chapter#ÊµãËØï‰ª£Á†Å" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h6><p>Ê≥®ÊÑè</p><ul><li>Ë¶ÅÂú® JDK 7 ‰∏ãËøêË°åÔºåÂê¶ÂàôÊâ©ÂÆπÊú∫Âà∂Âíå hash ÁöÑËÆ°ÁÆóÊñπÊ≥ïÈÉΩÂèò‰∫Ü</li><li>‰ª•‰∏ãÊµãËØï‰ª£Á†ÅÊòØÁ≤æÂøÉÂáÜÂ§áÁöÑÔºå‰∏çË¶ÅÈöè‰æøÊîπÂä®</li></ul><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">static</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">void</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">main</span><span style="color:#e1e4e8">(</span><span style="color:#f97583">String</span><span style="color:#e1e4e8">[] args) {</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">// ÊµãËØï java 7 ‰∏≠Âì™‰∫õÊï∞Â≠óÁöÑ hash ÁªìÊûúÁõ∏Á≠â</span></span>
<span class="line"><span style="color:#e1e4e8">    System.out.</span><span style="color:#b392f0">println</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"ÈïøÂ∫¶‰∏∫16Êó∂ÔºåÊ°∂‰∏ãÊ†á‰∏∫1ÁöÑkey"</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">for</span><span style="color:#e1e4e8"> (</span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> i </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8">; i </span><span style="color:#f97583">&lt;</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">64</span><span style="color:#e1e4e8">; i</span><span style="color:#f97583">++</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (</span><span style="color:#b392f0">hash</span><span style="color:#e1e4e8">(i) </span><span style="color:#f97583">%</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">16</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">==</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">1</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">            System.out.</span><span style="color:#b392f0">println</span><span style="color:#e1e4e8">(i);</span></span>
<span class="line"><span style="color:#e1e4e8">        }</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"><span style="color:#e1e4e8">    System.out.</span><span style="color:#b392f0">println</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"ÈïøÂ∫¶‰∏∫32Êó∂ÔºåÊ°∂‰∏ãÊ†á‰∏∫1ÁöÑkey"</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">for</span><span style="color:#e1e4e8"> (</span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> i </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8">; i </span><span style="color:#f97583">&lt;</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">64</span><span style="color:#e1e4e8">; i</span><span style="color:#f97583">++</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (</span><span style="color:#b392f0">hash</span><span style="color:#e1e4e8">(i) </span><span style="color:#f97583">%</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">32</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">==</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">1</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">            System.out.</span><span style="color:#b392f0">println</span><span style="color:#e1e4e8">(i);</span></span>
<span class="line"><span style="color:#e1e4e8">        }</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">// 1, 35, 16, 50 ÂΩìÂ§ßÂ∞è‰∏∫16Êó∂ÔºåÂÆÉ‰ª¨Âú®‰∏Ä‰∏™Ê°∂ÂÜÖ</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">final</span><span style="color:#e1e4e8"> HashMap&lt;</span><span style="color:#f97583">Integer</span><span style="color:#e1e4e8">, </span><span style="color:#f97583">Integer</span><span style="color:#e1e4e8">&gt; map </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> HashMap&lt;</span><span style="color:#f97583">Integer</span><span style="color:#e1e4e8">, </span><span style="color:#f97583">Integer</span><span style="color:#e1e4e8">&gt;();</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">// Êîæ 12 ‰∏™ÂÖÉÁ¥†</span></span>
<span class="line"><span style="color:#e1e4e8">    map.</span><span style="color:#b392f0">put</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">2</span><span style="color:#e1e4e8">, </span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">    map.</span><span style="color:#b392f0">put</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">3</span><span style="color:#e1e4e8">, </span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">    map.</span><span style="color:#b392f0">put</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">4</span><span style="color:#e1e4e8">, </span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">    map.</span><span style="color:#b392f0">put</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">5</span><span style="color:#e1e4e8">, </span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">    map.</span><span style="color:#b392f0">put</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">6</span><span style="color:#e1e4e8">, </span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">    map.</span><span style="color:#b392f0">put</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">7</span><span style="color:#e1e4e8">, </span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">    map.</span><span style="color:#b392f0">put</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">8</span><span style="color:#e1e4e8">, </span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">    map.</span><span style="color:#b392f0">put</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">9</span><span style="color:#e1e4e8">, </span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">    map.</span><span style="color:#b392f0">put</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">10</span><span style="color:#e1e4e8">, </span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">    map.</span><span style="color:#b392f0">put</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">16</span><span style="color:#e1e4e8">, </span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">    map.</span><span style="color:#b392f0">put</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">35</span><span style="color:#e1e4e8">, </span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">    map.</span><span style="color:#b392f0">put</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">1</span><span style="color:#e1e4e8">, </span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">    System.out.</span><span style="color:#b392f0">println</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"Êâ©ÂÆπÂâçÂ§ßÂ∞è[main]:"</span><span style="color:#f97583">+</span><span style="color:#e1e4e8">map.</span><span style="color:#b392f0">size</span><span style="color:#e1e4e8">());</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Thread</span><span style="color:#e1e4e8">() {</span></span>
<span class="line"><span style="color:#e1e4e8">        @</span><span style="color:#f97583">Override</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">void</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">run</span><span style="color:#e1e4e8">() {</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#6a737d">// ÊîæÁ¨¨ 13 ‰∏™ÂÖÉÁ¥†, ÂèëÁîüÊâ©ÂÆπ</span></span>
<span class="line"><span style="color:#e1e4e8">            map.</span><span style="color:#b392f0">put</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">50</span><span style="color:#e1e4e8">, </span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">            System.out.</span><span style="color:#b392f0">println</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"Êâ©ÂÆπÂêéÂ§ßÂ∞è[Thread-0]:"</span><span style="color:#f97583">+</span><span style="color:#e1e4e8">map.</span><span style="color:#b392f0">size</span><span style="color:#e1e4e8">());</span></span>
<span class="line"><span style="color:#e1e4e8">        }</span></span>
<span class="line"><span style="color:#e1e4e8">    }.</span><span style="color:#b392f0">start</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Thread</span><span style="color:#e1e4e8">() {</span></span>
<span class="line"><span style="color:#e1e4e8">        @</span><span style="color:#f97583">Override</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">void</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">run</span><span style="color:#e1e4e8">() {</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#6a737d">// ÊîæÁ¨¨ 13 ‰∏™ÂÖÉÁ¥†, ÂèëÁîüÊâ©ÂÆπ</span></span>
<span class="line"><span style="color:#e1e4e8">            map.</span><span style="color:#b392f0">put</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">50</span><span style="color:#e1e4e8">, </span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">            System.out.</span><span style="color:#b392f0">println</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"Êâ©ÂÆπÂêéÂ§ßÂ∞è[Thread-1]:"</span><span style="color:#f97583">+</span><span style="color:#e1e4e8">map.</span><span style="color:#b392f0">size</span><span style="color:#e1e4e8">());</span></span>
<span class="line"><span style="color:#e1e4e8">        }</span></span>
<span class="line"><span style="color:#e1e4e8">    }.</span><span style="color:#b392f0">start</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#f97583">final</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">static</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">hash</span><span style="color:#e1e4e8">(Object k) {</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> h </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (</span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">!=</span><span style="color:#e1e4e8"> h </span><span style="color:#f97583">&amp;&amp;</span><span style="color:#e1e4e8"> k </span><span style="color:#f97583">instanceof</span><span style="color:#e1e4e8"> String) {</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> sun.misc.Hashing.</span><span style="color:#b392f0">stringHash32</span><span style="color:#e1e4e8">((String) k);</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"><span style="color:#e1e4e8">    h </span><span style="color:#f97583">^=</span><span style="color:#e1e4e8"> k.</span><span style="color:#b392f0">hashCode</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">    h </span><span style="color:#f97583">^=</span><span style="color:#e1e4e8"> (h </span><span style="color:#f97583">&gt;&gt;&gt;</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">20</span><span style="color:#e1e4e8">) </span><span style="color:#f97583">^</span><span style="color:#e1e4e8"> (h </span><span style="color:#f97583">&gt;&gt;&gt;</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">12</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> h </span><span style="color:#f97583">^</span><span style="color:#e1e4e8"> (h </span><span style="color:#f97583">&gt;&gt;&gt;</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">7</span><span style="color:#e1e4e8">) </span><span style="color:#f97583">^</span><span style="color:#e1e4e8"> (h </span><span style="color:#f97583">&gt;&gt;&gt;</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">4</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">static</span><span style="color:#24292e"> </span><span style="color:#d73a49">void</span><span style="color:#24292e"> </span><span style="color:#6f42c1">main</span><span style="color:#24292e">(</span><span style="color:#d73a49">String</span><span style="color:#24292e">[] args) {</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">// ÊµãËØï java 7 ‰∏≠Âì™‰∫õÊï∞Â≠óÁöÑ hash ÁªìÊûúÁõ∏Á≠â</span></span>
<span class="line"><span style="color:#24292e">    System.out.</span><span style="color:#6f42c1">println</span><span style="color:#24292e">(</span><span style="color:#032f62">"ÈïøÂ∫¶‰∏∫16Êó∂ÔºåÊ°∂‰∏ãÊ†á‰∏∫1ÁöÑkey"</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">for</span><span style="color:#24292e"> (</span><span style="color:#d73a49">int</span><span style="color:#24292e"> i </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#005cc5">0</span><span style="color:#24292e">; i </span><span style="color:#d73a49">&lt;</span><span style="color:#24292e"> </span><span style="color:#005cc5">64</span><span style="color:#24292e">; i</span><span style="color:#d73a49">++</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (</span><span style="color:#6f42c1">hash</span><span style="color:#24292e">(i) </span><span style="color:#d73a49">%</span><span style="color:#24292e"> </span><span style="color:#005cc5">16</span><span style="color:#24292e"> </span><span style="color:#d73a49">==</span><span style="color:#24292e"> </span><span style="color:#005cc5">1</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">            System.out.</span><span style="color:#6f42c1">println</span><span style="color:#24292e">(i);</span></span>
<span class="line"><span style="color:#24292e">        }</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"><span style="color:#24292e">    System.out.</span><span style="color:#6f42c1">println</span><span style="color:#24292e">(</span><span style="color:#032f62">"ÈïøÂ∫¶‰∏∫32Êó∂ÔºåÊ°∂‰∏ãÊ†á‰∏∫1ÁöÑkey"</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">for</span><span style="color:#24292e"> (</span><span style="color:#d73a49">int</span><span style="color:#24292e"> i </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#005cc5">0</span><span style="color:#24292e">; i </span><span style="color:#d73a49">&lt;</span><span style="color:#24292e"> </span><span style="color:#005cc5">64</span><span style="color:#24292e">; i</span><span style="color:#d73a49">++</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (</span><span style="color:#6f42c1">hash</span><span style="color:#24292e">(i) </span><span style="color:#d73a49">%</span><span style="color:#24292e"> </span><span style="color:#005cc5">32</span><span style="color:#24292e"> </span><span style="color:#d73a49">==</span><span style="color:#24292e"> </span><span style="color:#005cc5">1</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">            System.out.</span><span style="color:#6f42c1">println</span><span style="color:#24292e">(i);</span></span>
<span class="line"><span style="color:#24292e">        }</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">// 1, 35, 16, 50 ÂΩìÂ§ßÂ∞è‰∏∫16Êó∂ÔºåÂÆÉ‰ª¨Âú®‰∏Ä‰∏™Ê°∂ÂÜÖ</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">final</span><span style="color:#24292e"> HashMap&lt;</span><span style="color:#d73a49">Integer</span><span style="color:#24292e">, </span><span style="color:#d73a49">Integer</span><span style="color:#24292e">&gt; map </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> HashMap&lt;</span><span style="color:#d73a49">Integer</span><span style="color:#24292e">, </span><span style="color:#d73a49">Integer</span><span style="color:#24292e">&gt;();</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">// Êîæ 12 ‰∏™ÂÖÉÁ¥†</span></span>
<span class="line"><span style="color:#24292e">    map.</span><span style="color:#6f42c1">put</span><span style="color:#24292e">(</span><span style="color:#005cc5">2</span><span style="color:#24292e">, </span><span style="color:#005cc5">null</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">    map.</span><span style="color:#6f42c1">put</span><span style="color:#24292e">(</span><span style="color:#005cc5">3</span><span style="color:#24292e">, </span><span style="color:#005cc5">null</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">    map.</span><span style="color:#6f42c1">put</span><span style="color:#24292e">(</span><span style="color:#005cc5">4</span><span style="color:#24292e">, </span><span style="color:#005cc5">null</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">    map.</span><span style="color:#6f42c1">put</span><span style="color:#24292e">(</span><span style="color:#005cc5">5</span><span style="color:#24292e">, </span><span style="color:#005cc5">null</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">    map.</span><span style="color:#6f42c1">put</span><span style="color:#24292e">(</span><span style="color:#005cc5">6</span><span style="color:#24292e">, </span><span style="color:#005cc5">null</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">    map.</span><span style="color:#6f42c1">put</span><span style="color:#24292e">(</span><span style="color:#005cc5">7</span><span style="color:#24292e">, </span><span style="color:#005cc5">null</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">    map.</span><span style="color:#6f42c1">put</span><span style="color:#24292e">(</span><span style="color:#005cc5">8</span><span style="color:#24292e">, </span><span style="color:#005cc5">null</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">    map.</span><span style="color:#6f42c1">put</span><span style="color:#24292e">(</span><span style="color:#005cc5">9</span><span style="color:#24292e">, </span><span style="color:#005cc5">null</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">    map.</span><span style="color:#6f42c1">put</span><span style="color:#24292e">(</span><span style="color:#005cc5">10</span><span style="color:#24292e">, </span><span style="color:#005cc5">null</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">    map.</span><span style="color:#6f42c1">put</span><span style="color:#24292e">(</span><span style="color:#005cc5">16</span><span style="color:#24292e">, </span><span style="color:#005cc5">null</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">    map.</span><span style="color:#6f42c1">put</span><span style="color:#24292e">(</span><span style="color:#005cc5">35</span><span style="color:#24292e">, </span><span style="color:#005cc5">null</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">    map.</span><span style="color:#6f42c1">put</span><span style="color:#24292e">(</span><span style="color:#005cc5">1</span><span style="color:#24292e">, </span><span style="color:#005cc5">null</span><span style="color:#24292e">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292e">    System.out.</span><span style="color:#6f42c1">println</span><span style="color:#24292e">(</span><span style="color:#032f62">"Êâ©ÂÆπÂâçÂ§ßÂ∞è[main]:"</span><span style="color:#d73a49">+</span><span style="color:#24292e">map.</span><span style="color:#6f42c1">size</span><span style="color:#24292e">());</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Thread</span><span style="color:#24292e">() {</span></span>
<span class="line"><span style="color:#24292e">        @</span><span style="color:#d73a49">Override</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">void</span><span style="color:#24292e"> </span><span style="color:#6f42c1">run</span><span style="color:#24292e">() {</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#6a737d">// ÊîæÁ¨¨ 13 ‰∏™ÂÖÉÁ¥†, ÂèëÁîüÊâ©ÂÆπ</span></span>
<span class="line"><span style="color:#24292e">            map.</span><span style="color:#6f42c1">put</span><span style="color:#24292e">(</span><span style="color:#005cc5">50</span><span style="color:#24292e">, </span><span style="color:#005cc5">null</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">            System.out.</span><span style="color:#6f42c1">println</span><span style="color:#24292e">(</span><span style="color:#032f62">"Êâ©ÂÆπÂêéÂ§ßÂ∞è[Thread-0]:"</span><span style="color:#d73a49">+</span><span style="color:#24292e">map.</span><span style="color:#6f42c1">size</span><span style="color:#24292e">());</span></span>
<span class="line"><span style="color:#24292e">        }</span></span>
<span class="line"><span style="color:#24292e">    }.</span><span style="color:#6f42c1">start</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Thread</span><span style="color:#24292e">() {</span></span>
<span class="line"><span style="color:#24292e">        @</span><span style="color:#d73a49">Override</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">void</span><span style="color:#24292e"> </span><span style="color:#6f42c1">run</span><span style="color:#24292e">() {</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#6a737d">// ÊîæÁ¨¨ 13 ‰∏™ÂÖÉÁ¥†, ÂèëÁîüÊâ©ÂÆπ</span></span>
<span class="line"><span style="color:#24292e">            map.</span><span style="color:#6f42c1">put</span><span style="color:#24292e">(</span><span style="color:#005cc5">50</span><span style="color:#24292e">, </span><span style="color:#005cc5">null</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">            System.out.</span><span style="color:#6f42c1">println</span><span style="color:#24292e">(</span><span style="color:#032f62">"Êâ©ÂÆπÂêéÂ§ßÂ∞è[Thread-1]:"</span><span style="color:#d73a49">+</span><span style="color:#24292e">map.</span><span style="color:#6f42c1">size</span><span style="color:#24292e">());</span></span>
<span class="line"><span style="color:#24292e">        }</span></span>
<span class="line"><span style="color:#24292e">    }.</span><span style="color:#6f42c1">start</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#d73a49">final</span><span style="color:#24292e"> </span><span style="color:#d73a49">static</span><span style="color:#24292e"> </span><span style="color:#d73a49">int</span><span style="color:#24292e"> </span><span style="color:#6f42c1">hash</span><span style="color:#24292e">(Object k) {</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">int</span><span style="color:#24292e"> h </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#005cc5">0</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (</span><span style="color:#005cc5">0</span><span style="color:#24292e"> </span><span style="color:#d73a49">!=</span><span style="color:#24292e"> h </span><span style="color:#d73a49">&amp;&amp;</span><span style="color:#24292e"> k </span><span style="color:#d73a49">instanceof</span><span style="color:#24292e"> String) {</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">return</span><span style="color:#24292e"> sun.misc.Hashing.</span><span style="color:#6f42c1">stringHash32</span><span style="color:#24292e">((String) k);</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"><span style="color:#24292e">    h </span><span style="color:#d73a49">^=</span><span style="color:#24292e"> k.</span><span style="color:#6f42c1">hashCode</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">    h </span><span style="color:#d73a49">^=</span><span style="color:#24292e"> (h </span><span style="color:#d73a49">&gt;&gt;&gt;</span><span style="color:#24292e"> </span><span style="color:#005cc5">20</span><span style="color:#24292e">) </span><span style="color:#d73a49">^</span><span style="color:#24292e"> (h </span><span style="color:#d73a49">&gt;&gt;&gt;</span><span style="color:#24292e"> </span><span style="color:#005cc5">12</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">return</span><span style="color:#24292e"> h </span><span style="color:#d73a49">^</span><span style="color:#24292e"> (h </span><span style="color:#d73a49">&gt;&gt;&gt;</span><span style="color:#24292e"> </span><span style="color:#005cc5">7</span><span style="color:#24292e">) </span><span style="color:#d73a49">^</span><span style="color:#24292e"> (h </span><span style="color:#d73a49">&gt;&gt;&gt;</span><span style="color:#24292e"> </span><span style="color:#005cc5">4</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">}</span></span></code></pre></div><figure><img src="https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230720115250416.png" alt="image-20230720115250416" loading="lazy" decoding="async"></figure><h6 id="Ê≠ªÈìæÂ§çÁé∞" tabindex="-1">Ê≠ªÈìæÂ§çÁé∞ <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20advanced%20chapter#Ê≠ªÈìæÂ§çÁé∞" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h6><p>Ë∞ÉËØïÂ∑•ÂÖ∑‰ΩøÁî® idea Âú® HashMap Ê∫êÁ†Å 590 Ë°åÂä†Êñ≠ÁÇπ</p><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#f97583">int</span><span style="color:#e1e4e8"> newCapacity </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> newTable.length;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#d73a49">int</span><span style="color:#24292e"> newCapacity </span><span style="color:#d73a49">=</span><span style="color:#24292e"> newTable.length;</span></span></code></pre></div><p>Êâ©ÂÆπÂâçÈìæË°® [1]=&gt;1-&gt;35-&gt;16</p><figure><img src="https://jsd.cdn.zzko.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230720120415589.png" alt="image-20230720120415589" loading="lazy" decoding="async"></figure><p>Êñ≠ÁÇπÁöÑÊù°‰ª∂Â¶Ç‰∏ãÔºåÁõÆÁöÑÊòØËÆ© HashMap Âú®Êâ©ÂÆπ‰∏∫ 32 Êó∂ÔºåÂπ∂‰∏îÁ∫øÁ®ã‰∏∫ Thread-0 Êàñ Thread-1 Êó∂ÂÅú‰∏ãÊù•</p><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8">newTable.length</span><span style="color:#f97583">==</span><span style="color:#79b8ff">32</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">&amp;&amp;</span></span>
<span class="line"><span style="color:#e1e4e8">(</span></span>
<span class="line"><span style="color:#e1e4e8">Thread.</span><span style="color:#b392f0">currentThread</span><span style="color:#e1e4e8">().</span><span style="color:#b392f0">getName</span><span style="color:#e1e4e8">().</span><span style="color:#b392f0">equals</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"Thread-0"</span><span style="color:#e1e4e8">)</span><span style="color:#f97583">||</span></span>
<span class="line"><span style="color:#e1e4e8">Thread.</span><span style="color:#b392f0">currentThread</span><span style="color:#e1e4e8">().</span><span style="color:#b392f0">getName</span><span style="color:#e1e4e8">().</span><span style="color:#b392f0">equals</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"Thread-1"</span><span style="color:#e1e4e8">)</span></span>
<span class="line"><span style="color:#e1e4e8">)</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e">newTable.length</span><span style="color:#d73a49">==</span><span style="color:#005cc5">32</span><span style="color:#24292e"> </span><span style="color:#d73a49">&amp;&amp;</span></span>
<span class="line"><span style="color:#24292e">(</span></span>
<span class="line"><span style="color:#24292e">Thread.</span><span style="color:#6f42c1">currentThread</span><span style="color:#24292e">().</span><span style="color:#6f42c1">getName</span><span style="color:#24292e">().</span><span style="color:#6f42c1">equals</span><span style="color:#24292e">(</span><span style="color:#032f62">"Thread-0"</span><span style="color:#24292e">)</span><span style="color:#d73a49">||</span></span>
<span class="line"><span style="color:#24292e">Thread.</span><span style="color:#6f42c1">currentThread</span><span style="color:#24292e">().</span><span style="color:#6f42c1">getName</span><span style="color:#24292e">().</span><span style="color:#6f42c1">equals</span><span style="color:#24292e">(</span><span style="color:#032f62">"Thread-1"</span><span style="color:#24292e">)</span></span>
<span class="line"><span style="color:#24292e">)</span></span></code></pre></div><p>Êñ≠ÁÇπÊöÇÂÅúÊñπÂºèÈÄâÊã© ThreadÔºåÂê¶ÂàôÂú®Ë∞ÉËØï Thread-0 Êó∂ÔºåThread-1 Êó†Ê≥ïÊÅ¢Â§çËøêË°å ËøêË°å‰ª£Á†ÅÔºåÁ®ãÂ∫èÂú®È¢ÑÊñôÁöÑÊñ≠ÁÇπ‰ΩçÁΩÆÂÅú‰∫Ü‰∏ãÊù•ÔºåËæìÂá∫</p><figure><img src="https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230720234932862.png" alt="image-20230720234932862" loading="lazy" decoding="async"></figure><p>Êé•‰∏ãÊù•ËøõÂÖ•Êâ©ÂÆπÊµÅÁ®ãË∞ÉËØï Âú® HashMap Ê∫êÁ†Å 594 Ë°åÂä†Êñ≠ÁÇπ</p><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8">Entry&lt;</span><span style="color:#f97583">K</span><span style="color:#e1e4e8">,</span><span style="color:#f97583">V</span><span style="color:#e1e4e8">&gt; next </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> e.next; </span><span style="color:#6a737d">// 593</span></span>
<span class="line"><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (rehash) </span><span style="color:#6a737d">// 594</span></span>
<span class="line"><span style="color:#6a737d">// ...</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e">Entry&lt;</span><span style="color:#d73a49">K</span><span style="color:#24292e">,</span><span style="color:#d73a49">V</span><span style="color:#24292e">&gt; next </span><span style="color:#d73a49">=</span><span style="color:#24292e"> e.next; </span><span style="color:#6a737d">// 593</span></span>
<span class="line"><span style="color:#d73a49">if</span><span style="color:#24292e"> (rehash) </span><span style="color:#6a737d">// 594</span></span>
<span class="line"><span style="color:#6a737d">// ...</span></span></code></pre></div><p>ËøôÊòØ‰∏∫‰∫ÜËßÇÂØü e ËäÇÁÇπÂíå next ËäÇÁÇπÁöÑÁä∂ÊÄÅÔºåThread-0 ÂçïÊ≠•ÊâßË°åÂà∞ 594 Ë°åÔºåÂÜç 594 Â§ÑÂÜçÊ∑ªÂä†‰∏Ä‰∏™Êñ≠ÁÇπÔºàÊù°‰ª∂ <code>Thread.currentThread().getName().equals("Thread-0")</code>Ôºâ</p><p>ËøôÊó∂ÂèØ‰ª•Âú® Variables Èù¢ÊùøËßÇÂØüÂà∞ e Âíå next ÂèòÈáèÔºå‰ΩøÁî® view as -&gt; Object Êü•ÁúãËäÇÁÇπÁä∂ÊÄÅ</p><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#b392f0">e</span><span style="color:#e1e4e8"> (</span><span style="color:#79b8ff">1</span><span style="color:#e1e4e8">)</span><span style="color:#f97583">-&gt;</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">35</span><span style="color:#e1e4e8">)</span><span style="color:#f97583">-&gt;</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">16</span><span style="color:#e1e4e8">)</span><span style="color:#f97583">-&gt;</span><span style="color:#79b8ff">null</span></span>
<span class="line"><span style="color:#b392f0">next</span><span style="color:#e1e4e8"> (</span><span style="color:#79b8ff">35</span><span style="color:#e1e4e8">)</span><span style="color:#f97583">-&gt;</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">16</span><span style="color:#e1e4e8">)</span><span style="color:#f97583">-&gt;</span><span style="color:#79b8ff">null</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6f42c1">e</span><span style="color:#24292e"> (</span><span style="color:#005cc5">1</span><span style="color:#24292e">)</span><span style="color:#d73a49">-&gt;</span><span style="color:#24292e">(</span><span style="color:#005cc5">35</span><span style="color:#24292e">)</span><span style="color:#d73a49">-&gt;</span><span style="color:#24292e">(</span><span style="color:#005cc5">16</span><span style="color:#24292e">)</span><span style="color:#d73a49">-&gt;</span><span style="color:#005cc5">null</span></span>
<span class="line"><span style="color:#6f42c1">next</span><span style="color:#24292e"> (</span><span style="color:#005cc5">35</span><span style="color:#24292e">)</span><span style="color:#d73a49">-&gt;</span><span style="color:#24292e">(</span><span style="color:#005cc5">16</span><span style="color:#24292e">)</span><span style="color:#d73a49">-&gt;</span><span style="color:#005cc5">null</span></span></code></pre></div><p>Âú® Threads Èù¢ÊùøÈÄâ‰∏≠ Thread-1 ÊÅ¢Â§çËøêË°åÔºåÂèØ‰ª•ÁúãÂà∞ÊéßÂà∂Âè∞ËæìÂá∫Êñ∞ÁöÑÂÜÖÂÆπÂ¶Ç‰∏ãÔºåThread-1 Êâ©ÂÆπÂ∑≤ÂÆåÊàê</p><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8">newTable[</span><span style="color:#79b8ff">1</span><span style="color:#e1e4e8">] (</span><span style="color:#79b8ff">35</span><span style="color:#e1e4e8">)</span><span style="color:#f97583">-&gt;</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">1</span><span style="color:#e1e4e8">)</span><span style="color:#f97583">-&gt;</span><span style="color:#79b8ff">null</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e">newTable[</span><span style="color:#005cc5">1</span><span style="color:#24292e">] (</span><span style="color:#005cc5">35</span><span style="color:#24292e">)</span><span style="color:#d73a49">-&gt;</span><span style="color:#24292e">(</span><span style="color:#005cc5">1</span><span style="color:#24292e">)</span><span style="color:#d73a49">-&gt;</span><span style="color:#005cc5">null</span></span></code></pre></div><figure><img src="https://jsd.cdn.zzko.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230720121455212.png" alt="image-20230720121455212" loading="lazy" decoding="async"></figure><p>Â∞ÜË¶ÅËøÅÁßªÂà∞Êñ∞ÈìæË°®ÁöÑ‰ΩçÁΩÆÔºå16ÔºàËÆ°ÁÆóÁöÑÊ°∂‰∏ãÊ†á‰∏ç‰∏ÄÊ†∑ÔºâËøÅÁßªÂà∞‰∏çÂêåÂú∞Êñπ</p><figure><img src="https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230720122243893.png" alt="image-20230720122243893" loading="lazy" decoding="async"></figure><p>ËøôÊó∂ Thread-1ÂÆåÊàêÊâ©ÂÆπÂπ∂Ê∂àÂ§±</p><figure><img src="https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230720121649327.png" alt="image-20230720121649327" loading="lazy" decoding="async"></figure><figure><img src="https://jsd.cdn.zzko.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230720121911063.png" alt="image-20230720121911063" loading="lazy" decoding="async"></figure><p>ËøôÊó∂ Thread-0 ËøòÂÅúÂú® 594 Â§ÑÔºå Variables Èù¢ÊùøÂèòÈáèÁöÑÁä∂ÊÄÅÂ∑≤ÁªèÂèòÂåñ‰∏∫</p><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#b392f0">e</span><span style="color:#e1e4e8"> (</span><span style="color:#79b8ff">1</span><span style="color:#e1e4e8">)</span><span style="color:#f97583">-&gt;</span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8"> </span><span style="color:#6a737d">//Âõ†‰∏∫Thread-0Á∫øÁ®ãÂàáÊç¢ÂõûÊù•ÊÅ¢Â§çÂéüÊù•Áä∂ÊÄÅÔºåeÁöÑÂèòÈáè‰∏∫1</span></span>
<span class="line"><span style="color:#b392f0">next</span><span style="color:#e1e4e8"> (</span><span style="color:#79b8ff">35</span><span style="color:#e1e4e8">)</span><span style="color:#f97583">-&gt;</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">1</span><span style="color:#e1e4e8">)</span><span style="color:#f97583">-&gt;</span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8"> </span><span style="color:#6a737d">//Êâ©ÂÆπÂêéÊèíÂÖ•ÈìæË°®ÊñπÂºè‰∏∫Â§¥ÊèíÊ≥ï</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6f42c1">e</span><span style="color:#24292e"> (</span><span style="color:#005cc5">1</span><span style="color:#24292e">)</span><span style="color:#d73a49">-&gt;</span><span style="color:#005cc5">null</span><span style="color:#24292e"> </span><span style="color:#6a737d">//Âõ†‰∏∫Thread-0Á∫øÁ®ãÂàáÊç¢ÂõûÊù•ÊÅ¢Â§çÂéüÊù•Áä∂ÊÄÅÔºåeÁöÑÂèòÈáè‰∏∫1</span></span>
<span class="line"><span style="color:#6f42c1">next</span><span style="color:#24292e"> (</span><span style="color:#005cc5">35</span><span style="color:#24292e">)</span><span style="color:#d73a49">-&gt;</span><span style="color:#24292e">(</span><span style="color:#005cc5">1</span><span style="color:#24292e">)</span><span style="color:#d73a49">-&gt;</span><span style="color:#005cc5">null</span><span style="color:#24292e"> </span><span style="color:#6a737d">//Êâ©ÂÆπÂêéÊèíÂÖ•ÈìæË°®ÊñπÂºè‰∏∫Â§¥ÊèíÊ≥ï</span></span></code></pre></div><p>‰∏∫‰ªÄ‰πàÂë¢ÔºåÂõ†‰∏∫ Thread-1 Êâ©ÂÆπÊó∂ÈìæË°®‰πüÊòØÂêéÂä†ÂÖ•ÁöÑÂÖÉÁ¥†ÊîæÂÖ•ÈìæË°®Â§¥ÔºåÂõ†Ê≠§ÈìæË°®Â∞±ÂÄíËøáÊù•‰∫ÜÔºå‰ΩÜ Thread-1 ËôΩÁÑ∂Áªì ÊûúÊ≠£Á°ÆÔºå‰ΩÜÂÆÉÁªìÊùüÂêé Thread-0 ËøòË¶ÅÁªßÁª≠ËøêË°å Êé•‰∏ãÊù•Â∞±ÂèØ‰ª•ÂçïÊ≠•Ë∞ÉËØïÔºàF8ÔºâËßÇÂØüÊ≠ªÈìæÁöÑ‰∫ßÁîü‰∫Ü ‰∏ã‰∏ÄËΩÆÂæ™ÁéØÂà∞ 594ÔºåÂ∞Ü e Êê¨ËøÅÂà∞ newTable ÈìæË°®Â§¥</p><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8">newTable[</span><span style="color:#79b8ff">1</span><span style="color:#e1e4e8">] (</span><span style="color:#79b8ff">1</span><span style="color:#e1e4e8">)</span><span style="color:#f97583">-&gt;</span><span style="color:#79b8ff">null</span></span>
<span class="line"><span style="color:#b392f0">e</span><span style="color:#e1e4e8"> (</span><span style="color:#79b8ff">35</span><span style="color:#e1e4e8">)</span><span style="color:#f97583">-&gt;</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">1</span><span style="color:#e1e4e8">)</span><span style="color:#f97583">-&gt;</span><span style="color:#79b8ff">null</span></span>
<span class="line"><span style="color:#b392f0">next</span><span style="color:#e1e4e8"> (</span><span style="color:#79b8ff">1</span><span style="color:#e1e4e8">)</span><span style="color:#f97583">-&gt;</span><span style="color:#79b8ff">null</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e">newTable[</span><span style="color:#005cc5">1</span><span style="color:#24292e">] (</span><span style="color:#005cc5">1</span><span style="color:#24292e">)</span><span style="color:#d73a49">-&gt;</span><span style="color:#005cc5">null</span></span>
<span class="line"><span style="color:#6f42c1">e</span><span style="color:#24292e"> (</span><span style="color:#005cc5">35</span><span style="color:#24292e">)</span><span style="color:#d73a49">-&gt;</span><span style="color:#24292e">(</span><span style="color:#005cc5">1</span><span style="color:#24292e">)</span><span style="color:#d73a49">-&gt;</span><span style="color:#005cc5">null</span></span>
<span class="line"><span style="color:#6f42c1">next</span><span style="color:#24292e"> (</span><span style="color:#005cc5">1</span><span style="color:#24292e">)</span><span style="color:#d73a49">-&gt;</span><span style="color:#005cc5">null</span></span></code></pre></div><p>ÊúÄÂÖàËøÅÁßªÁöÑÊòØe=1</p><figure><img src="https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230720123629963.png" alt="image-20230720123629963" loading="lazy" decoding="async"></figure><p>‰∏ã‰∏ÄËΩÆËøÅÁßªÂØπË±°‰∏∫35ÔºånextÂèà‰∏∫1</p><figure><img src="https://jsd.cdn.zzko.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230720123832412.png" alt="image-20230720123832412" loading="lazy" decoding="async"></figure><p>‰∏ã‰∏ÄËΩÆËøÅÁßªÂØπË±°Âèà‰∏∫1Ôºånext‰∏∫null</p><figure><img src="https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230720124011252.png" alt="image-20230720124011252" loading="lazy" decoding="async"></figure><p>‰∏ã‰∏ÄËΩÆÂæ™ÁéØÂà∞ 594ÔºåÂ∞Ü e Êê¨ËøÅÂà∞ newTable ÈìæË°®Â§¥</p><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8">newTable[</span><span style="color:#79b8ff">1</span><span style="color:#e1e4e8">] (</span><span style="color:#79b8ff">35</span><span style="color:#e1e4e8">)</span><span style="color:#f97583">-&gt;</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">1</span><span style="color:#e1e4e8">)</span><span style="color:#f97583">-&gt;</span><span style="color:#79b8ff">null</span></span>
<span class="line"><span style="color:#b392f0">e</span><span style="color:#e1e4e8"> (</span><span style="color:#79b8ff">1</span><span style="color:#e1e4e8">)</span><span style="color:#f97583">-&gt;</span><span style="color:#79b8ff">null</span></span>
<span class="line"><span style="color:#e1e4e8">next </span><span style="color:#79b8ff">null</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e">newTable[</span><span style="color:#005cc5">1</span><span style="color:#24292e">] (</span><span style="color:#005cc5">35</span><span style="color:#24292e">)</span><span style="color:#d73a49">-&gt;</span><span style="color:#24292e">(</span><span style="color:#005cc5">1</span><span style="color:#24292e">)</span><span style="color:#d73a49">-&gt;</span><span style="color:#005cc5">null</span></span>
<span class="line"><span style="color:#6f42c1">e</span><span style="color:#24292e"> (</span><span style="color:#005cc5">1</span><span style="color:#24292e">)</span><span style="color:#d73a49">-&gt;</span><span style="color:#005cc5">null</span></span>
<span class="line"><span style="color:#24292e">next </span><span style="color:#005cc5">null</span></span></code></pre></div><p>Âú®ËøÅÁßªËøáÁ®ã‰∏≠ÂèëÁîü‰∫ÜÊ≠ªÈìæ[1]=&gt;1-&gt;35-&gt;1ÔºåËøôÂ∞±‰ºöÂØºËá¥2,3,4...ËäÇÁÇπÁöÑËøÅÁßª‰πüÊó†Ê≥ïÁªßÁª≠ËøêË°åÔºåÁ®ãÂ∫èÁõ¥Êé•ÈòªÂ°û‰ΩèÔºåÂÅúÊ≠¢Á®ãÂ∫è‰πüË¶ÅÁ≠âÂçäÂ§©</p><figure><img src="https://jsd.cdn.zzko.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230720124644341.png" alt="image-20230720124644341" loading="lazy" decoding="async"></figure><p>ÂÜçÁúãÁúãÊ∫êÁ†Å</p><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8">e.next </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> newTable[</span><span style="color:#79b8ff">1</span><span style="color:#e1e4e8">];</span></span>
<span class="line"><span style="color:#6a737d">// ËøôÊó∂ e (1,35)</span></span>
<span class="line"><span style="color:#6a737d">// ËÄå newTable[1] (35,1)-&gt;(1,35) Âõ†‰∏∫ÊòØÂêå‰∏Ä‰∏™ÂØπË±°</span></span>
<span class="line"><span style="color:#e1e4e8">newTable[</span><span style="color:#79b8ff">1</span><span style="color:#e1e4e8">] </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> e;</span></span>
<span class="line"><span style="color:#6a737d">// ÂÜçÂ∞ùËØïÂ∞Ü e ‰Ωú‰∏∫ÈìæË°®Â§¥, Ê≠ªÈìæÂ∑≤Êàê</span></span>
<span class="line"><span style="color:#e1e4e8">e </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> next;</span></span>
<span class="line"><span style="color:#6a737d">// ËôΩÁÑ∂ next ÊòØ null, ‰ºöËøõÂÖ•‰∏ã‰∏Ä‰∏™ÈìæË°®ÁöÑÂ§çÂà∂, ‰ΩÜÊ≠ªÈìæÂ∑≤ÁªèÂΩ¢Êàê‰∫Ü</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e">e.next </span><span style="color:#d73a49">=</span><span style="color:#24292e"> newTable[</span><span style="color:#005cc5">1</span><span style="color:#24292e">];</span></span>
<span class="line"><span style="color:#6a737d">// ËøôÊó∂ e (1,35)</span></span>
<span class="line"><span style="color:#6a737d">// ËÄå newTable[1] (35,1)-&gt;(1,35) Âõ†‰∏∫ÊòØÂêå‰∏Ä‰∏™ÂØπË±°</span></span>
<span class="line"><span style="color:#24292e">newTable[</span><span style="color:#005cc5">1</span><span style="color:#24292e">] </span><span style="color:#d73a49">=</span><span style="color:#24292e"> e;</span></span>
<span class="line"><span style="color:#6a737d">// ÂÜçÂ∞ùËØïÂ∞Ü e ‰Ωú‰∏∫ÈìæË°®Â§¥, Ê≠ªÈìæÂ∑≤Êàê</span></span>
<span class="line"><span style="color:#24292e">e </span><span style="color:#d73a49">=</span><span style="color:#24292e"> next;</span></span>
<span class="line"><span style="color:#6a737d">// ËôΩÁÑ∂ next ÊòØ null, ‰ºöËøõÂÖ•‰∏ã‰∏Ä‰∏™ÈìæË°®ÁöÑÂ§çÂà∂, ‰ΩÜÊ≠ªÈìæÂ∑≤ÁªèÂΩ¢Êàê‰∫Ü</span></span></code></pre></div><h6 id="Ê∫êÁ†ÅÂàÜÊûê-3" tabindex="-1">Ê∫êÁ†ÅÂàÜÊûê <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20advanced%20chapter#Ê∫êÁ†ÅÂàÜÊûê-3" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h6><p>HashMap ÁöÑÂπ∂ÂèëÊ≠ªÈìæÂèëÁîüÂú®Êâ©ÂÆπÊó∂</p><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6a737d">// Â∞Ü table ËøÅÁßªËá≥ newTable</span></span>
<span class="line"><span style="color:#f97583">void</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">transfer</span><span style="color:#e1e4e8">(</span><span style="color:#f97583">Entry</span><span style="color:#e1e4e8">[] newTable, </span><span style="color:#f97583">boolean</span><span style="color:#e1e4e8"> rehash) {</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> newCapacity </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> newTable.length;</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">for</span><span style="color:#e1e4e8"> (Entry&lt;</span><span style="color:#f97583">K</span><span style="color:#e1e4e8">,</span><span style="color:#f97583">V</span><span style="color:#e1e4e8">&gt; e </span><span style="color:#f97583">:</span><span style="color:#e1e4e8"> table) {</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">while</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">!=</span><span style="color:#e1e4e8"> e) {</span></span>
<span class="line"><span style="color:#e1e4e8">            Entry&lt;</span><span style="color:#f97583">K</span><span style="color:#e1e4e8">,</span><span style="color:#f97583">V</span><span style="color:#e1e4e8">&gt; next </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> e.next;</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#6a737d">// 1 Â§Ñ</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (rehash) {</span></span>
<span class="line"><span style="color:#e1e4e8">            	e.hash </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">==</span><span style="color:#e1e4e8"> e.key </span><span style="color:#f97583">?</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">:</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">hash</span><span style="color:#e1e4e8">(e.key);</span></span>
<span class="line"><span style="color:#e1e4e8">            }</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> i </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">indexFor</span><span style="color:#e1e4e8">(e.hash, newCapacity);</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#6a737d">// 2 Â§Ñ</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#6a737d">// Â∞ÜÊñ∞ÂÖÉÁ¥†Âä†ÂÖ• newTable[i], Âéü newTable[i] ‰Ωú‰∏∫Êñ∞ÂÖÉÁ¥†ÁöÑ next</span></span>
<span class="line"><span style="color:#e1e4e8">            e.next </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> newTable[i];</span></span>
<span class="line"><span style="color:#e1e4e8">            newTable[i] </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> e;</span></span>
<span class="line"><span style="color:#e1e4e8">            e </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> next;</span></span>
<span class="line"><span style="color:#e1e4e8">        }</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"><span style="color:#e1e4e8">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6a737d">// Â∞Ü table ËøÅÁßªËá≥ newTable</span></span>
<span class="line"><span style="color:#d73a49">void</span><span style="color:#24292e"> </span><span style="color:#6f42c1">transfer</span><span style="color:#24292e">(</span><span style="color:#d73a49">Entry</span><span style="color:#24292e">[] newTable, </span><span style="color:#d73a49">boolean</span><span style="color:#24292e"> rehash) {</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">int</span><span style="color:#24292e"> newCapacity </span><span style="color:#d73a49">=</span><span style="color:#24292e"> newTable.length;</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">for</span><span style="color:#24292e"> (Entry&lt;</span><span style="color:#d73a49">K</span><span style="color:#24292e">,</span><span style="color:#d73a49">V</span><span style="color:#24292e">&gt; e </span><span style="color:#d73a49">:</span><span style="color:#24292e"> table) {</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">while</span><span style="color:#24292e">(</span><span style="color:#005cc5">null</span><span style="color:#24292e"> </span><span style="color:#d73a49">!=</span><span style="color:#24292e"> e) {</span></span>
<span class="line"><span style="color:#24292e">            Entry&lt;</span><span style="color:#d73a49">K</span><span style="color:#24292e">,</span><span style="color:#d73a49">V</span><span style="color:#24292e">&gt; next </span><span style="color:#d73a49">=</span><span style="color:#24292e"> e.next;</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#6a737d">// 1 Â§Ñ</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (rehash) {</span></span>
<span class="line"><span style="color:#24292e">            	e.hash </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#005cc5">null</span><span style="color:#24292e"> </span><span style="color:#d73a49">==</span><span style="color:#24292e"> e.key </span><span style="color:#d73a49">?</span><span style="color:#24292e"> </span><span style="color:#005cc5">0</span><span style="color:#24292e"> </span><span style="color:#d73a49">:</span><span style="color:#24292e"> </span><span style="color:#6f42c1">hash</span><span style="color:#24292e">(e.key);</span></span>
<span class="line"><span style="color:#24292e">            }</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">int</span><span style="color:#24292e"> i </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#6f42c1">indexFor</span><span style="color:#24292e">(e.hash, newCapacity);</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#6a737d">// 2 Â§Ñ</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#6a737d">// Â∞ÜÊñ∞ÂÖÉÁ¥†Âä†ÂÖ• newTable[i], Âéü newTable[i] ‰Ωú‰∏∫Êñ∞ÂÖÉÁ¥†ÁöÑ next</span></span>
<span class="line"><span style="color:#24292e">            e.next </span><span style="color:#d73a49">=</span><span style="color:#24292e"> newTable[i];</span></span>
<span class="line"><span style="color:#24292e">            newTable[i] </span><span style="color:#d73a49">=</span><span style="color:#24292e"> e;</span></span>
<span class="line"><span style="color:#24292e">            e </span><span style="color:#d73a49">=</span><span style="color:#24292e"> next;</span></span>
<span class="line"><span style="color:#24292e">        }</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"><span style="color:#24292e">}</span></span></code></pre></div><p>ÂÅáËÆæ map ‰∏≠ÂàùÂßãÂÖÉÁ¥†ÊòØ</p><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8">ÂéüÂßãÈìæË°®ÔºåÊ†ºÂºèÔºö[‰∏ãÊ†á] (key,next)</span></span>
<span class="line"><span style="color:#e1e4e8">[</span><span style="color:#79b8ff">1</span><span style="color:#e1e4e8">] (</span><span style="color:#79b8ff">1</span><span style="color:#e1e4e8">,</span><span style="color:#79b8ff">35</span><span style="color:#e1e4e8">)</span><span style="color:#f97583">-&gt;</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">35</span><span style="color:#e1e4e8">,</span><span style="color:#79b8ff">16</span><span style="color:#e1e4e8">)</span><span style="color:#f97583">-&gt;</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">16</span><span style="color:#e1e4e8">,</span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8">)</span></span>
<span class="line"><span style="color:#e1e4e8">Á∫øÁ®ã a ÊâßË°åÂà∞ </span><span style="color:#79b8ff">1</span><span style="color:#e1e4e8"> Â§Ñ ÔºåÊ≠§Êó∂Â±ÄÈÉ®ÂèòÈáè e ‰∏∫ (</span><span style="color:#79b8ff">1</span><span style="color:#e1e4e8">,</span><span style="color:#79b8ff">35</span><span style="color:#e1e4e8">)ÔºåËÄåÂ±ÄÈÉ®ÂèòÈáè next ‰∏∫ (</span><span style="color:#79b8ff">35</span><span style="color:#e1e4e8">,</span><span style="color:#79b8ff">16</span><span style="color:#e1e4e8">) Á∫øÁ®ã a ÊåÇËµ∑</span></span>
<span class="line"><span style="color:#e1e4e8">Á∫øÁ®ã b ÂºÄÂßãÊâßË°å</span></span>
<span class="line"><span style="color:#e1e4e8">Á¨¨‰∏ÄÊ¨°Âæ™ÁéØ</span></span>
<span class="line"><span style="color:#e1e4e8">[</span><span style="color:#79b8ff">1</span><span style="color:#e1e4e8">] (</span><span style="color:#79b8ff">1</span><span style="color:#e1e4e8">,</span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8">)</span></span>
<span class="line"><span style="color:#e1e4e8">Á¨¨‰∫åÊ¨°Âæ™ÁéØ</span></span>
<span class="line"><span style="color:#e1e4e8">[</span><span style="color:#79b8ff">1</span><span style="color:#e1e4e8">] (</span><span style="color:#79b8ff">35</span><span style="color:#e1e4e8">,</span><span style="color:#79b8ff">1</span><span style="color:#e1e4e8">)</span><span style="color:#f97583">-&gt;</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">1</span><span style="color:#e1e4e8">,</span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8">)</span></span>
<span class="line"><span style="color:#e1e4e8">Á¨¨‰∏âÊ¨°Âæ™ÁéØ</span></span>
<span class="line"><span style="color:#e1e4e8">[</span><span style="color:#79b8ff">1</span><span style="color:#e1e4e8">] (</span><span style="color:#79b8ff">35</span><span style="color:#e1e4e8">,</span><span style="color:#79b8ff">1</span><span style="color:#e1e4e8">)</span><span style="color:#f97583">-&gt;</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">1</span><span style="color:#e1e4e8">,</span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8">)</span></span>
<span class="line"><span style="color:#e1e4e8">[</span><span style="color:#79b8ff">17</span><span style="color:#e1e4e8">] (</span><span style="color:#79b8ff">16</span><span style="color:#e1e4e8">,</span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8">)</span></span>
<span class="line"><span style="color:#e1e4e8">ÂàáÊç¢ÂõûÁ∫øÁ®ã aÔºåÊ≠§Êó∂Â±ÄÈÉ®ÂèòÈáè e Âíå next Ë¢´ÊÅ¢Â§çÔºåÂºïÁî®Ê≤°Âèò‰ΩÜÂÜÖÂÆπÂèò‰∫ÜÔºöe ÁöÑÂÜÖÂÆπË¢´Êîπ‰∏∫ (</span><span style="color:#79b8ff">1</span><span style="color:#e1e4e8">,</span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8">)ÔºåËÄå next ÁöÑÂÜÖ</span></span>
<span class="line"><span style="color:#e1e4e8">ÂÆπË¢´Êîπ‰∏∫ (</span><span style="color:#79b8ff">35</span><span style="color:#e1e4e8">,</span><span style="color:#79b8ff">1</span><span style="color:#e1e4e8">) Âπ∂ÈìæÂêë (</span><span style="color:#79b8ff">1</span><span style="color:#e1e4e8">,</span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8">)</span></span>
<span class="line"><span style="color:#e1e4e8">Á¨¨‰∏ÄÊ¨°Âæ™ÁéØ</span></span>
<span class="line"><span style="color:#e1e4e8">[</span><span style="color:#79b8ff">1</span><span style="color:#e1e4e8">] (</span><span style="color:#79b8ff">1</span><span style="color:#e1e4e8">,</span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8">)</span></span>
<span class="line"><span style="color:#e1e4e8">Á¨¨‰∫åÊ¨°Âæ™ÁéØÔºåÊ≥®ÊÑèËøôÊó∂ e ÊòØ (</span><span style="color:#79b8ff">35</span><span style="color:#e1e4e8">,</span><span style="color:#79b8ff">1</span><span style="color:#e1e4e8">) Âπ∂ÈìæÂêë (</span><span style="color:#79b8ff">1</span><span style="color:#e1e4e8">,</span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8">) ÊâÄ‰ª• next ÂèàÊòØ (</span><span style="color:#79b8ff">1</span><span style="color:#e1e4e8">,</span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8">)</span></span>
<span class="line"><span style="color:#e1e4e8">[</span><span style="color:#79b8ff">1</span><span style="color:#e1e4e8">] (</span><span style="color:#79b8ff">35</span><span style="color:#e1e4e8">,</span><span style="color:#79b8ff">1</span><span style="color:#e1e4e8">)</span><span style="color:#f97583">-&gt;</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">1</span><span style="color:#e1e4e8">,</span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8">)</span></span>
<span class="line"><span style="color:#e1e4e8">Á¨¨‰∏âÊ¨°Âæ™ÁéØÔºåe ÊòØ (</span><span style="color:#79b8ff">1</span><span style="color:#e1e4e8">,</span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8">)ÔºåËÄå next ÊòØ </span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8">Ôºå‰ΩÜ e Ë¢´ÊîæÂÖ•ÈìæË°®Â§¥ÔºåËøôÊ†∑ e.next ÂèòÊàê‰∫Ü </span><span style="color:#79b8ff">35</span><span style="color:#e1e4e8"> Ôºà</span><span style="color:#79b8ff">2</span><span style="color:#e1e4e8"> Â§ÑÔºâ</span></span>
<span class="line"><span style="color:#e1e4e8">[</span><span style="color:#79b8ff">1</span><span style="color:#e1e4e8">] (</span><span style="color:#79b8ff">1</span><span style="color:#e1e4e8">,</span><span style="color:#79b8ff">35</span><span style="color:#e1e4e8">)</span><span style="color:#f97583">-&gt;</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">35</span><span style="color:#e1e4e8">,</span><span style="color:#79b8ff">1</span><span style="color:#e1e4e8">)</span><span style="color:#f97583">-&gt;</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">1</span><span style="color:#e1e4e8">,</span><span style="color:#79b8ff">35</span><span style="color:#e1e4e8">)</span></span>
<span class="line"><span style="color:#e1e4e8">Â∑≤ÁªèÊòØÊ≠ªÈìæ‰∫Ü</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e">ÂéüÂßãÈìæË°®ÔºåÊ†ºÂºèÔºö[‰∏ãÊ†á] (key,next)</span></span>
<span class="line"><span style="color:#24292e">[</span><span style="color:#005cc5">1</span><span style="color:#24292e">] (</span><span style="color:#005cc5">1</span><span style="color:#24292e">,</span><span style="color:#005cc5">35</span><span style="color:#24292e">)</span><span style="color:#d73a49">-&gt;</span><span style="color:#24292e">(</span><span style="color:#005cc5">35</span><span style="color:#24292e">,</span><span style="color:#005cc5">16</span><span style="color:#24292e">)</span><span style="color:#d73a49">-&gt;</span><span style="color:#24292e">(</span><span style="color:#005cc5">16</span><span style="color:#24292e">,</span><span style="color:#005cc5">null</span><span style="color:#24292e">)</span></span>
<span class="line"><span style="color:#24292e">Á∫øÁ®ã a ÊâßË°åÂà∞ </span><span style="color:#005cc5">1</span><span style="color:#24292e"> Â§Ñ ÔºåÊ≠§Êó∂Â±ÄÈÉ®ÂèòÈáè e ‰∏∫ (</span><span style="color:#005cc5">1</span><span style="color:#24292e">,</span><span style="color:#005cc5">35</span><span style="color:#24292e">)ÔºåËÄåÂ±ÄÈÉ®ÂèòÈáè next ‰∏∫ (</span><span style="color:#005cc5">35</span><span style="color:#24292e">,</span><span style="color:#005cc5">16</span><span style="color:#24292e">) Á∫øÁ®ã a ÊåÇËµ∑</span></span>
<span class="line"><span style="color:#24292e">Á∫øÁ®ã b ÂºÄÂßãÊâßË°å</span></span>
<span class="line"><span style="color:#24292e">Á¨¨‰∏ÄÊ¨°Âæ™ÁéØ</span></span>
<span class="line"><span style="color:#24292e">[</span><span style="color:#005cc5">1</span><span style="color:#24292e">] (</span><span style="color:#005cc5">1</span><span style="color:#24292e">,</span><span style="color:#005cc5">null</span><span style="color:#24292e">)</span></span>
<span class="line"><span style="color:#24292e">Á¨¨‰∫åÊ¨°Âæ™ÁéØ</span></span>
<span class="line"><span style="color:#24292e">[</span><span style="color:#005cc5">1</span><span style="color:#24292e">] (</span><span style="color:#005cc5">35</span><span style="color:#24292e">,</span><span style="color:#005cc5">1</span><span style="color:#24292e">)</span><span style="color:#d73a49">-&gt;</span><span style="color:#24292e">(</span><span style="color:#005cc5">1</span><span style="color:#24292e">,</span><span style="color:#005cc5">null</span><span style="color:#24292e">)</span></span>
<span class="line"><span style="color:#24292e">Á¨¨‰∏âÊ¨°Âæ™ÁéØ</span></span>
<span class="line"><span style="color:#24292e">[</span><span style="color:#005cc5">1</span><span style="color:#24292e">] (</span><span style="color:#005cc5">35</span><span style="color:#24292e">,</span><span style="color:#005cc5">1</span><span style="color:#24292e">)</span><span style="color:#d73a49">-&gt;</span><span style="color:#24292e">(</span><span style="color:#005cc5">1</span><span style="color:#24292e">,</span><span style="color:#005cc5">null</span><span style="color:#24292e">)</span></span>
<span class="line"><span style="color:#24292e">[</span><span style="color:#005cc5">17</span><span style="color:#24292e">] (</span><span style="color:#005cc5">16</span><span style="color:#24292e">,</span><span style="color:#005cc5">null</span><span style="color:#24292e">)</span></span>
<span class="line"><span style="color:#24292e">ÂàáÊç¢ÂõûÁ∫øÁ®ã aÔºåÊ≠§Êó∂Â±ÄÈÉ®ÂèòÈáè e Âíå next Ë¢´ÊÅ¢Â§çÔºåÂºïÁî®Ê≤°Âèò‰ΩÜÂÜÖÂÆπÂèò‰∫ÜÔºöe ÁöÑÂÜÖÂÆπË¢´Êîπ‰∏∫ (</span><span style="color:#005cc5">1</span><span style="color:#24292e">,</span><span style="color:#005cc5">null</span><span style="color:#24292e">)ÔºåËÄå next ÁöÑÂÜÖ</span></span>
<span class="line"><span style="color:#24292e">ÂÆπË¢´Êîπ‰∏∫ (</span><span style="color:#005cc5">35</span><span style="color:#24292e">,</span><span style="color:#005cc5">1</span><span style="color:#24292e">) Âπ∂ÈìæÂêë (</span><span style="color:#005cc5">1</span><span style="color:#24292e">,</span><span style="color:#005cc5">null</span><span style="color:#24292e">)</span></span>
<span class="line"><span style="color:#24292e">Á¨¨‰∏ÄÊ¨°Âæ™ÁéØ</span></span>
<span class="line"><span style="color:#24292e">[</span><span style="color:#005cc5">1</span><span style="color:#24292e">] (</span><span style="color:#005cc5">1</span><span style="color:#24292e">,</span><span style="color:#005cc5">null</span><span style="color:#24292e">)</span></span>
<span class="line"><span style="color:#24292e">Á¨¨‰∫åÊ¨°Âæ™ÁéØÔºåÊ≥®ÊÑèËøôÊó∂ e ÊòØ (</span><span style="color:#005cc5">35</span><span style="color:#24292e">,</span><span style="color:#005cc5">1</span><span style="color:#24292e">) Âπ∂ÈìæÂêë (</span><span style="color:#005cc5">1</span><span style="color:#24292e">,</span><span style="color:#005cc5">null</span><span style="color:#24292e">) ÊâÄ‰ª• next ÂèàÊòØ (</span><span style="color:#005cc5">1</span><span style="color:#24292e">,</span><span style="color:#005cc5">null</span><span style="color:#24292e">)</span></span>
<span class="line"><span style="color:#24292e">[</span><span style="color:#005cc5">1</span><span style="color:#24292e">] (</span><span style="color:#005cc5">35</span><span style="color:#24292e">,</span><span style="color:#005cc5">1</span><span style="color:#24292e">)</span><span style="color:#d73a49">-&gt;</span><span style="color:#24292e">(</span><span style="color:#005cc5">1</span><span style="color:#24292e">,</span><span style="color:#005cc5">null</span><span style="color:#24292e">)</span></span>
<span class="line"><span style="color:#24292e">Á¨¨‰∏âÊ¨°Âæ™ÁéØÔºåe ÊòØ (</span><span style="color:#005cc5">1</span><span style="color:#24292e">,</span><span style="color:#005cc5">null</span><span style="color:#24292e">)ÔºåËÄå next ÊòØ </span><span style="color:#005cc5">null</span><span style="color:#24292e">Ôºå‰ΩÜ e Ë¢´ÊîæÂÖ•ÈìæË°®Â§¥ÔºåËøôÊ†∑ e.next ÂèòÊàê‰∫Ü </span><span style="color:#005cc5">35</span><span style="color:#24292e"> Ôºà</span><span style="color:#005cc5">2</span><span style="color:#24292e"> Â§ÑÔºâ</span></span>
<span class="line"><span style="color:#24292e">[</span><span style="color:#005cc5">1</span><span style="color:#24292e">] (</span><span style="color:#005cc5">1</span><span style="color:#24292e">,</span><span style="color:#005cc5">35</span><span style="color:#24292e">)</span><span style="color:#d73a49">-&gt;</span><span style="color:#24292e">(</span><span style="color:#005cc5">35</span><span style="color:#24292e">,</span><span style="color:#005cc5">1</span><span style="color:#24292e">)</span><span style="color:#d73a49">-&gt;</span><span style="color:#24292e">(</span><span style="color:#005cc5">1</span><span style="color:#24292e">,</span><span style="color:#005cc5">35</span><span style="color:#24292e">)</span></span>
<span class="line"><span style="color:#24292e">Â∑≤ÁªèÊòØÊ≠ªÈìæ‰∫Ü</span></span></code></pre></div><h6 id="Â∞èÁªì" tabindex="-1">Â∞èÁªì <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20advanced%20chapter#Â∞èÁªì" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h6><ul><li>Á©∂ÂÖ∂ÂéüÂõ†ÔºåÊòØÂõ†‰∏∫Âú®Â§öÁ∫øÁ®ãÁéØÂ¢É‰∏ã‰ΩøÁî®‰∫ÜÈùûÁ∫øÁ®ãÂÆâÂÖ®ÁöÑ map ÈõÜÂêà</li><li>JDK 8 ËôΩÁÑ∂Â∞ÜÊâ©ÂÆπÁÆóÊ≥ïÂÅö‰∫ÜË∞ÉÊï¥Ôºå‰∏çÂÜçÂ∞ÜÂÖÉÁ¥†Âä†ÂÖ•ÈìæË°®Â§¥ÔºàËÄåÊòØ‰øùÊåÅ‰∏éÊâ©ÂÆπÂâç‰∏ÄÊ†∑ÁöÑÈ°∫Â∫èÔºâÔºå‰ΩÜ‰ªç‰∏çÊÑèÂë≥ÁùÄËÉΩÂ§üÂú®Â§öÁ∫øÁ®ãÁéØÂ¢É‰∏ãËÉΩÂ§üÂÆâÂÖ®Êâ©ÂÆπÔºåËøò‰ºöÂá∫Áé∞ÂÖ∂ÂÆÉÈóÆÈ¢òÔºàÂ¶ÇÊâ©ÂÆπ‰∏¢Êï∞ÊçÆÔºâ</li></ul><h5 id="jdk-8-concurrenthashmap" tabindex="-1">JDK 8 ConcurrentHashMap <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20advanced%20chapter#jdk-8-concurrenthashmap" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h5><h6 id="ÈáçË¶ÅÂ±ûÊÄßÂíåÂÜÖÈÉ®Á±ª" tabindex="-1">ÈáçË¶ÅÂ±ûÊÄßÂíåÂÜÖÈÉ®Á±ª <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20advanced%20chapter#ÈáçË¶ÅÂ±ûÊÄßÂíåÂÜÖÈÉ®Á±ª" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h6><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6a737d">// ÈªòËÆ§‰∏∫ 0</span></span>
<span class="line"><span style="color:#6a737d">// ÂΩìÂàùÂßãÂåñÊó∂, ‰∏∫ -1</span></span>
<span class="line"><span style="color:#6a737d">// ÂΩìÊâ©ÂÆπÊó∂, ‰∏∫ -(1 + Êâ©ÂÆπÁ∫øÁ®ãÊï∞)</span></span>
<span class="line"><span style="color:#6a737d">// ÂΩìÂàùÂßãÂåñÊàñÊâ©ÂÆπÂÆåÊàêÂêéÔºå‰∏∫ ‰∏ã‰∏ÄÊ¨°ÁöÑÊâ©ÂÆπÁöÑÈòàÂÄºÂ§ßÂ∞è</span></span>
<span class="line"><span style="color:#f97583">private</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">transient</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">volatile</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> sizeCtl;</span></span>
<span class="line"><span style="color:#6a737d">// Êï¥‰∏™ ConcurrentHashMap Â∞±ÊòØ‰∏Ä‰∏™ Node[]</span></span>
<span class="line"><span style="color:#f97583">static</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">class</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Node</span><span style="color:#e1e4e8">&lt;</span><span style="color:#f97583">K</span><span style="color:#e1e4e8">,</span><span style="color:#f97583">V</span><span style="color:#e1e4e8">&gt; </span><span style="color:#f97583">implements</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Map.Entry</span><span style="color:#e1e4e8">&lt;</span><span style="color:#f97583">K</span><span style="color:#e1e4e8">,</span><span style="color:#f97583">V</span><span style="color:#e1e4e8">&gt; {}</span></span>
<span class="line"><span style="color:#6a737d">// hash Ë°®</span></span>
<span class="line"><span style="color:#f97583">transient</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">volatile</span><span style="color:#e1e4e8"> Node&lt;</span><span style="color:#f97583">K</span><span style="color:#e1e4e8">,</span><span style="color:#f97583">V</span><span style="color:#e1e4e8">&gt;[] table;</span></span>
<span class="line"><span style="color:#6a737d">// Êâ©ÂÆπÊó∂ÁöÑ Êñ∞ hash Ë°®</span></span>
<span class="line"><span style="color:#f97583">private</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">transient</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">volatile</span><span style="color:#e1e4e8"> Node&lt;</span><span style="color:#f97583">K</span><span style="color:#e1e4e8">,</span><span style="color:#f97583">V</span><span style="color:#e1e4e8">&gt;[] nextTable;</span></span>
<span class="line"><span style="color:#6a737d">// Êâ©ÂÆπÊó∂Â¶ÇÊûúÊüê‰∏™ bin ËøÅÁßªÂÆåÊØï, Áî® ForwardingNode ‰Ωú‰∏∫Êóß table bin ÁöÑÂ§¥ÁªìÁÇπ</span></span>
<span class="line"><span style="color:#f97583">static</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">final</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">class</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">ForwardingNode</span><span style="color:#e1e4e8">&lt;</span><span style="color:#f97583">K</span><span style="color:#e1e4e8">,</span><span style="color:#f97583">V</span><span style="color:#e1e4e8">&gt; </span><span style="color:#f97583">extends</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Node</span><span style="color:#e1e4e8">&lt;</span><span style="color:#f97583">K</span><span style="color:#e1e4e8">,</span><span style="color:#f97583">V</span><span style="color:#e1e4e8">&gt; {}</span></span>
<span class="line"><span style="color:#6a737d">// Áî®Âú® compute ‰ª•Âèä computeIfAbsent Êó∂, Áî®Êù•Âç†‰Ωç, ËÆ°ÁÆóÂÆåÊàêÂêéÊõøÊç¢‰∏∫ÊôÆÈÄö Node</span></span>
<span class="line"><span style="color:#f97583">static</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">final</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">class</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">ReservationNode</span><span style="color:#e1e4e8">&lt;</span><span style="color:#f97583">K</span><span style="color:#e1e4e8">,</span><span style="color:#f97583">V</span><span style="color:#e1e4e8">&gt; </span><span style="color:#f97583">extends</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Node</span><span style="color:#e1e4e8">&lt;</span><span style="color:#f97583">K</span><span style="color:#e1e4e8">,</span><span style="color:#f97583">V</span><span style="color:#e1e4e8">&gt; {}</span></span>
<span class="line"><span style="color:#6a737d">// ‰Ωú‰∏∫ treebin ÁöÑÂ§¥ËäÇÁÇπ, Â≠òÂÇ® root Âíå first</span></span>
<span class="line"><span style="color:#f97583">static</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">final</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">class</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">TreeBin</span><span style="color:#e1e4e8">&lt;</span><span style="color:#f97583">K</span><span style="color:#e1e4e8">,</span><span style="color:#f97583">V</span><span style="color:#e1e4e8">&gt; </span><span style="color:#f97583">extends</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Node</span><span style="color:#e1e4e8">&lt;</span><span style="color:#f97583">K</span><span style="color:#e1e4e8">,</span><span style="color:#f97583">V</span><span style="color:#e1e4e8">&gt; {}</span></span>
<span class="line"><span style="color:#6a737d">// ‰Ωú‰∏∫ treebin ÁöÑËäÇÁÇπ, Â≠òÂÇ® parent, left, right</span></span>
<span class="line"><span style="color:#f97583">static</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">final</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">class</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">TreeNode</span><span style="color:#e1e4e8">&lt;</span><span style="color:#f97583">K</span><span style="color:#e1e4e8">,</span><span style="color:#f97583">V</span><span style="color:#e1e4e8">&gt; </span><span style="color:#f97583">extends</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Node</span><span style="color:#e1e4e8">&lt;</span><span style="color:#f97583">K</span><span style="color:#e1e4e8">,</span><span style="color:#f97583">V</span><span style="color:#e1e4e8">&gt; {}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6a737d">// ÈªòËÆ§‰∏∫ 0</span></span>
<span class="line"><span style="color:#6a737d">// ÂΩìÂàùÂßãÂåñÊó∂, ‰∏∫ -1</span></span>
<span class="line"><span style="color:#6a737d">// ÂΩìÊâ©ÂÆπÊó∂, ‰∏∫ -(1 + Êâ©ÂÆπÁ∫øÁ®ãÊï∞)</span></span>
<span class="line"><span style="color:#6a737d">// ÂΩìÂàùÂßãÂåñÊàñÊâ©ÂÆπÂÆåÊàêÂêéÔºå‰∏∫ ‰∏ã‰∏ÄÊ¨°ÁöÑÊâ©ÂÆπÁöÑÈòàÂÄºÂ§ßÂ∞è</span></span>
<span class="line"><span style="color:#d73a49">private</span><span style="color:#24292e"> </span><span style="color:#d73a49">transient</span><span style="color:#24292e"> </span><span style="color:#d73a49">volatile</span><span style="color:#24292e"> </span><span style="color:#d73a49">int</span><span style="color:#24292e"> sizeCtl;</span></span>
<span class="line"><span style="color:#6a737d">// Êï¥‰∏™ ConcurrentHashMap Â∞±ÊòØ‰∏Ä‰∏™ Node[]</span></span>
<span class="line"><span style="color:#d73a49">static</span><span style="color:#24292e"> </span><span style="color:#d73a49">class</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Node</span><span style="color:#24292e">&lt;</span><span style="color:#d73a49">K</span><span style="color:#24292e">,</span><span style="color:#d73a49">V</span><span style="color:#24292e">&gt; </span><span style="color:#d73a49">implements</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Map.Entry</span><span style="color:#24292e">&lt;</span><span style="color:#d73a49">K</span><span style="color:#24292e">,</span><span style="color:#d73a49">V</span><span style="color:#24292e">&gt; {}</span></span>
<span class="line"><span style="color:#6a737d">// hash Ë°®</span></span>
<span class="line"><span style="color:#d73a49">transient</span><span style="color:#24292e"> </span><span style="color:#d73a49">volatile</span><span style="color:#24292e"> Node&lt;</span><span style="color:#d73a49">K</span><span style="color:#24292e">,</span><span style="color:#d73a49">V</span><span style="color:#24292e">&gt;[] table;</span></span>
<span class="line"><span style="color:#6a737d">// Êâ©ÂÆπÊó∂ÁöÑ Êñ∞ hash Ë°®</span></span>
<span class="line"><span style="color:#d73a49">private</span><span style="color:#24292e"> </span><span style="color:#d73a49">transient</span><span style="color:#24292e"> </span><span style="color:#d73a49">volatile</span><span style="color:#24292e"> Node&lt;</span><span style="color:#d73a49">K</span><span style="color:#24292e">,</span><span style="color:#d73a49">V</span><span style="color:#24292e">&gt;[] nextTable;</span></span>
<span class="line"><span style="color:#6a737d">// Êâ©ÂÆπÊó∂Â¶ÇÊûúÊüê‰∏™ bin ËøÅÁßªÂÆåÊØï, Áî® ForwardingNode ‰Ωú‰∏∫Êóß table bin ÁöÑÂ§¥ÁªìÁÇπ</span></span>
<span class="line"><span style="color:#d73a49">static</span><span style="color:#24292e"> </span><span style="color:#d73a49">final</span><span style="color:#24292e"> </span><span style="color:#d73a49">class</span><span style="color:#24292e"> </span><span style="color:#6f42c1">ForwardingNode</span><span style="color:#24292e">&lt;</span><span style="color:#d73a49">K</span><span style="color:#24292e">,</span><span style="color:#d73a49">V</span><span style="color:#24292e">&gt; </span><span style="color:#d73a49">extends</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Node</span><span style="color:#24292e">&lt;</span><span style="color:#d73a49">K</span><span style="color:#24292e">,</span><span style="color:#d73a49">V</span><span style="color:#24292e">&gt; {}</span></span>
<span class="line"><span style="color:#6a737d">// Áî®Âú® compute ‰ª•Âèä computeIfAbsent Êó∂, Áî®Êù•Âç†‰Ωç, ËÆ°ÁÆóÂÆåÊàêÂêéÊõøÊç¢‰∏∫ÊôÆÈÄö Node</span></span>
<span class="line"><span style="color:#d73a49">static</span><span style="color:#24292e"> </span><span style="color:#d73a49">final</span><span style="color:#24292e"> </span><span style="color:#d73a49">class</span><span style="color:#24292e"> </span><span style="color:#6f42c1">ReservationNode</span><span style="color:#24292e">&lt;</span><span style="color:#d73a49">K</span><span style="color:#24292e">,</span><span style="color:#d73a49">V</span><span style="color:#24292e">&gt; </span><span style="color:#d73a49">extends</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Node</span><span style="color:#24292e">&lt;</span><span style="color:#d73a49">K</span><span style="color:#24292e">,</span><span style="color:#d73a49">V</span><span style="color:#24292e">&gt; {}</span></span>
<span class="line"><span style="color:#6a737d">// ‰Ωú‰∏∫ treebin ÁöÑÂ§¥ËäÇÁÇπ, Â≠òÂÇ® root Âíå first</span></span>
<span class="line"><span style="color:#d73a49">static</span><span style="color:#24292e"> </span><span style="color:#d73a49">final</span><span style="color:#24292e"> </span><span style="color:#d73a49">class</span><span style="color:#24292e"> </span><span style="color:#6f42c1">TreeBin</span><span style="color:#24292e">&lt;</span><span style="color:#d73a49">K</span><span style="color:#24292e">,</span><span style="color:#d73a49">V</span><span style="color:#24292e">&gt; </span><span style="color:#d73a49">extends</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Node</span><span style="color:#24292e">&lt;</span><span style="color:#d73a49">K</span><span style="color:#24292e">,</span><span style="color:#d73a49">V</span><span style="color:#24292e">&gt; {}</span></span>
<span class="line"><span style="color:#6a737d">// ‰Ωú‰∏∫ treebin ÁöÑËäÇÁÇπ, Â≠òÂÇ® parent, left, right</span></span>
<span class="line"><span style="color:#d73a49">static</span><span style="color:#24292e"> </span><span style="color:#d73a49">final</span><span style="color:#24292e"> </span><span style="color:#d73a49">class</span><span style="color:#24292e"> </span><span style="color:#6f42c1">TreeNode</span><span style="color:#24292e">&lt;</span><span style="color:#d73a49">K</span><span style="color:#24292e">,</span><span style="color:#d73a49">V</span><span style="color:#24292e">&gt; </span><span style="color:#d73a49">extends</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Node</span><span style="color:#24292e">&lt;</span><span style="color:#d73a49">K</span><span style="color:#24292e">,</span><span style="color:#d73a49">V</span><span style="color:#24292e">&gt; {}</span></span></code></pre></div><blockquote><p>sizeCtlÔºösizeControllÔºå‰ΩúÁî®‰∫éÊâ©ÂÆπÔºåÁ¨¨‰∏ÄÊ¨°hashË°®ÁöÑÊï∞ÁªÑÂàùÂßãÂåñÊó∂ËÆæ‰∏∫-1ÔºåÂç≥Êï∞ÁªÑÊòØÊáíÊÉ∞ÂàùÂßãÂåñÁöÑÔºåÂàöÂºÄÂßãÁöÑÊï∞ÁªÑÊòØÊ≤°ÊúâÂàùÂßãÂåñÁöÑÔºåÂΩìÁ¨¨‰∏ÄÊ¨°Áî®Âà∞Êï∞ÁªÑÊó∂ÊâçÂàùÂßãÂåñ</p><p>Node&lt;K,V&gt;ÔºöhashË°®ÁöÑÈìæË°®ÁªìÊûÑÁî±Ê≠§ÊñπÊ≥ïÊù•ÂÆåÊàêÔºåkÔºåvÔºåhashÔºånext...</p></blockquote><h6 id="ÈáçË¶ÅÊñπÊ≥ï" tabindex="-1">ÈáçË¶ÅÊñπÊ≥ï <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20advanced%20chapter#ÈáçË¶ÅÊñπÊ≥ï" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h6><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6a737d">// Ëé∑Âèñ Node[] ‰∏≠Á¨¨ i ‰∏™ Node</span></span>
<span class="line"><span style="color:#f97583">static</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">final</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">&lt;</span><span style="color:#e1e4e8">K,V</span><span style="color:#f97583">&gt;</span><span style="color:#e1e4e8"> Node</span><span style="color:#f97583">&lt;</span><span style="color:#e1e4e8">K,V</span><span style="color:#f97583">&gt;</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">tabAt</span><span style="color:#e1e4e8">(Node</span><span style="color:#f97583">&lt;</span><span style="color:#e1e4e8">K,V</span><span style="color:#f97583">&gt;</span><span style="color:#e1e4e8">[] tab, </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> i)</span></span>
<span class="line"><span style="color:#6a737d">// cas ‰øÆÊîπ Node[] ‰∏≠Á¨¨ i ‰∏™ Node ÁöÑÂÄº, c ‰∏∫ÊóßÂÄº, v ‰∏∫Êñ∞ÂÄº</span></span>
<span class="line"><span style="color:#f97583">static</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">final</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">&lt;</span><span style="color:#e1e4e8">K,V</span><span style="color:#f97583">&gt;</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">boolean</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">casTabAt</span><span style="color:#e1e4e8">(Node</span><span style="color:#f97583">&lt;</span><span style="color:#e1e4e8">K,V</span><span style="color:#f97583">&gt;</span><span style="color:#e1e4e8">[] tab, </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> i, Node</span><span style="color:#f97583">&lt;</span><span style="color:#e1e4e8">K,V</span><span style="color:#f97583">&gt;</span><span style="color:#e1e4e8"> c, Node</span><span style="color:#f97583">&lt;</span><span style="color:#e1e4e8">K,V</span><span style="color:#f97583">&gt;</span><span style="color:#e1e4e8"> v)</span></span>
<span class="line"><span style="color:#6a737d">// Áõ¥Êé•‰øÆÊîπ Node[] ‰∏≠Á¨¨ i ‰∏™ Node ÁöÑÂÄº, v ‰∏∫Êñ∞ÂÄº</span></span>
<span class="line"><span style="color:#f97583">static</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">final</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">&lt;</span><span style="color:#e1e4e8">K,V</span><span style="color:#f97583">&gt;</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">void</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">setTabAt</span><span style="color:#e1e4e8">(Node</span><span style="color:#f97583">&lt;</span><span style="color:#e1e4e8">K,V</span><span style="color:#f97583">&gt;</span><span style="color:#e1e4e8">[] tab, </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> i, Node</span><span style="color:#f97583">&lt;</span><span style="color:#e1e4e8">K,V</span><span style="color:#f97583">&gt;</span><span style="color:#e1e4e8"> v)</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6a737d">// Ëé∑Âèñ Node[] ‰∏≠Á¨¨ i ‰∏™ Node</span></span>
<span class="line"><span style="color:#d73a49">static</span><span style="color:#24292e"> </span><span style="color:#d73a49">final</span><span style="color:#24292e"> </span><span style="color:#d73a49">&lt;</span><span style="color:#24292e">K,V</span><span style="color:#d73a49">&gt;</span><span style="color:#24292e"> Node</span><span style="color:#d73a49">&lt;</span><span style="color:#24292e">K,V</span><span style="color:#d73a49">&gt;</span><span style="color:#24292e"> </span><span style="color:#6f42c1">tabAt</span><span style="color:#24292e">(Node</span><span style="color:#d73a49">&lt;</span><span style="color:#24292e">K,V</span><span style="color:#d73a49">&gt;</span><span style="color:#24292e">[] tab, </span><span style="color:#d73a49">int</span><span style="color:#24292e"> i)</span></span>
<span class="line"><span style="color:#6a737d">// cas ‰øÆÊîπ Node[] ‰∏≠Á¨¨ i ‰∏™ Node ÁöÑÂÄº, c ‰∏∫ÊóßÂÄº, v ‰∏∫Êñ∞ÂÄº</span></span>
<span class="line"><span style="color:#d73a49">static</span><span style="color:#24292e"> </span><span style="color:#d73a49">final</span><span style="color:#24292e"> </span><span style="color:#d73a49">&lt;</span><span style="color:#24292e">K,V</span><span style="color:#d73a49">&gt;</span><span style="color:#24292e"> </span><span style="color:#d73a49">boolean</span><span style="color:#24292e"> </span><span style="color:#6f42c1">casTabAt</span><span style="color:#24292e">(Node</span><span style="color:#d73a49">&lt;</span><span style="color:#24292e">K,V</span><span style="color:#d73a49">&gt;</span><span style="color:#24292e">[] tab, </span><span style="color:#d73a49">int</span><span style="color:#24292e"> i, Node</span><span style="color:#d73a49">&lt;</span><span style="color:#24292e">K,V</span><span style="color:#d73a49">&gt;</span><span style="color:#24292e"> c, Node</span><span style="color:#d73a49">&lt;</span><span style="color:#24292e">K,V</span><span style="color:#d73a49">&gt;</span><span style="color:#24292e"> v)</span></span>
<span class="line"><span style="color:#6a737d">// Áõ¥Êé•‰øÆÊîπ Node[] ‰∏≠Á¨¨ i ‰∏™ Node ÁöÑÂÄº, v ‰∏∫Êñ∞ÂÄº</span></span>
<span class="line"><span style="color:#d73a49">static</span><span style="color:#24292e"> </span><span style="color:#d73a49">final</span><span style="color:#24292e"> </span><span style="color:#d73a49">&lt;</span><span style="color:#24292e">K,V</span><span style="color:#d73a49">&gt;</span><span style="color:#24292e"> </span><span style="color:#d73a49">void</span><span style="color:#24292e"> </span><span style="color:#6f42c1">setTabAt</span><span style="color:#24292e">(Node</span><span style="color:#d73a49">&lt;</span><span style="color:#24292e">K,V</span><span style="color:#d73a49">&gt;</span><span style="color:#24292e">[] tab, </span><span style="color:#d73a49">int</span><span style="color:#24292e"> i, Node</span><span style="color:#d73a49">&lt;</span><span style="color:#24292e">K,V</span><span style="color:#d73a49">&gt;</span><span style="color:#24292e"> v)</span></span></code></pre></div><h6 id="ÊûÑÈÄ†Âô®ÂàÜÊûê" tabindex="-1">ÊûÑÈÄ†Âô®ÂàÜÊûê <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20advanced%20chapter#ÊûÑÈÄ†Âô®ÂàÜÊûê" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h6><p>ÂèØ‰ª•ÁúãÂà∞ÂÆûÁé∞‰∫ÜÊáíÊÉ∞ÂàùÂßãÂåñÔºåÂú®ÊûÑÈÄ†ÊñπÊ≥ï‰∏≠‰ªÖ‰ªÖËÆ°ÁÆó‰∫Ü table ÁöÑÂ§ßÂ∞èÔºå‰ª•ÂêéÂú®Á¨¨‰∏ÄÊ¨°‰ΩøÁî®Êó∂Êâç‰ºöÁúüÊ≠£ÂàõÂª∫</p><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">ConcurrentHashMap</span><span style="color:#e1e4e8">(</span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> initialCapacity, </span><span style="color:#f97583">float</span><span style="color:#e1e4e8"> loadFactor, </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> concurrencyLevel) {</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (</span><span style="color:#f97583">!</span><span style="color:#e1e4e8">(loadFactor </span><span style="color:#f97583">&gt;</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">0.0f</span><span style="color:#e1e4e8">) </span><span style="color:#f97583">||</span><span style="color:#e1e4e8"> initialCapacity </span><span style="color:#f97583">&lt;</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">||</span><span style="color:#e1e4e8"> concurrencyLevel </span><span style="color:#f97583">&lt;=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8">)</span></span>
<span class="line"><span style="color:#e1e4e8">   	 	</span><span style="color:#f97583">throw</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">IllegalArgumentException</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (initialCapacity </span><span style="color:#f97583">&lt;</span><span style="color:#e1e4e8"> concurrencyLevel) </span><span style="color:#6a737d">// Use at least as many bins</span></span>
<span class="line"><span style="color:#e1e4e8">    	initialCapacity </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> concurrencyLevel; </span><span style="color:#6a737d">// as estimated threads</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">long</span><span style="color:#e1e4e8"> size </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> (</span><span style="color:#f97583">long</span><span style="color:#e1e4e8">)(</span><span style="color:#79b8ff">1.0</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">+</span><span style="color:#e1e4e8"> (</span><span style="color:#f97583">long</span><span style="color:#e1e4e8">)initialCapacity </span><span style="color:#f97583">/</span><span style="color:#e1e4e8"> loadFactor);</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">// tableSizeFor ‰ªçÁÑ∂ÊòØ‰øùËØÅËÆ°ÁÆóÁöÑÂ§ßÂ∞èÊòØ 2^n, Âç≥ 16,32,64 ...</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> cap </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> (size </span><span style="color:#f97583">&gt;=</span><span style="color:#e1e4e8"> (</span><span style="color:#f97583">long</span><span style="color:#e1e4e8">)MAXIMUM_CAPACITY) </span><span style="color:#f97583">?</span></span>
<span class="line"><span style="color:#e1e4e8">    	MAXIMUM_CAPACITY </span><span style="color:#f97583">:</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">tableSizeFor</span><span style="color:#e1e4e8">((</span><span style="color:#f97583">int</span><span style="color:#e1e4e8">)size);</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#79b8ff">this</span><span style="color:#e1e4e8">.sizeCtl </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> cap;</span></span>
<span class="line"><span style="color:#e1e4e8">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#6f42c1">ConcurrentHashMap</span><span style="color:#24292e">(</span><span style="color:#d73a49">int</span><span style="color:#24292e"> initialCapacity, </span><span style="color:#d73a49">float</span><span style="color:#24292e"> loadFactor, </span><span style="color:#d73a49">int</span><span style="color:#24292e"> concurrencyLevel) {</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (</span><span style="color:#d73a49">!</span><span style="color:#24292e">(loadFactor </span><span style="color:#d73a49">&gt;</span><span style="color:#24292e"> </span><span style="color:#005cc5">0.0f</span><span style="color:#24292e">) </span><span style="color:#d73a49">||</span><span style="color:#24292e"> initialCapacity </span><span style="color:#d73a49">&lt;</span><span style="color:#24292e"> </span><span style="color:#005cc5">0</span><span style="color:#24292e"> </span><span style="color:#d73a49">||</span><span style="color:#24292e"> concurrencyLevel </span><span style="color:#d73a49">&lt;=</span><span style="color:#24292e"> </span><span style="color:#005cc5">0</span><span style="color:#24292e">)</span></span>
<span class="line"><span style="color:#24292e">   	 	</span><span style="color:#d73a49">throw</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">IllegalArgumentException</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (initialCapacity </span><span style="color:#d73a49">&lt;</span><span style="color:#24292e"> concurrencyLevel) </span><span style="color:#6a737d">// Use at least as many bins</span></span>
<span class="line"><span style="color:#24292e">    	initialCapacity </span><span style="color:#d73a49">=</span><span style="color:#24292e"> concurrencyLevel; </span><span style="color:#6a737d">// as estimated threads</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">long</span><span style="color:#24292e"> size </span><span style="color:#d73a49">=</span><span style="color:#24292e"> (</span><span style="color:#d73a49">long</span><span style="color:#24292e">)(</span><span style="color:#005cc5">1.0</span><span style="color:#24292e"> </span><span style="color:#d73a49">+</span><span style="color:#24292e"> (</span><span style="color:#d73a49">long</span><span style="color:#24292e">)initialCapacity </span><span style="color:#d73a49">/</span><span style="color:#24292e"> loadFactor);</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">// tableSizeFor ‰ªçÁÑ∂ÊòØ‰øùËØÅËÆ°ÁÆóÁöÑÂ§ßÂ∞èÊòØ 2^n, Âç≥ 16,32,64 ...</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">int</span><span style="color:#24292e"> cap </span><span style="color:#d73a49">=</span><span style="color:#24292e"> (size </span><span style="color:#d73a49">&gt;=</span><span style="color:#24292e"> (</span><span style="color:#d73a49">long</span><span style="color:#24292e">)MAXIMUM_CAPACITY) </span><span style="color:#d73a49">?</span></span>
<span class="line"><span style="color:#24292e">    	MAXIMUM_CAPACITY </span><span style="color:#d73a49">:</span><span style="color:#24292e"> </span><span style="color:#6f42c1">tableSizeFor</span><span style="color:#24292e">((</span><span style="color:#d73a49">int</span><span style="color:#24292e">)size);</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#005cc5">this</span><span style="color:#24292e">.sizeCtl </span><span style="color:#d73a49">=</span><span style="color:#24292e"> cap;</span></span>
<span class="line"><span style="color:#24292e">}</span></span></code></pre></div><blockquote><p>initialCapacityÔºöÂàùÂßãÂÆπÈáèÔºõloadFactorÔºöÊâ©ÂÆπÂõ†Â≠ê/Ë¥üËΩΩÂõ†Â≠êÔºõconcurrencyLevelÔºöÂπ∂ÂèëÂ∫¶</p><p>initialCapacity=8 &lt; concurrencyLevel=16 -&gt;initialCapacity=16</p><p>ÂΩìÂàùÂßãÂÆπÈáè‰∏çÊòØ2^nÔºåÈÄöËøátableSizeFor((int)size‰πü‰ºöÂèò‰∏∫2^n</p></blockquote><h6 id="get-ÊµÅÁ®ã" tabindex="-1">get ÊµÅÁ®ã <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20advanced%20chapter#get-ÊµÅÁ®ã" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h6><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#f97583">public</span><span style="color:#e1e4e8"> V </span><span style="color:#b392f0">get</span><span style="color:#e1e4e8">(Object key) {</span></span>
<span class="line"><span style="color:#e1e4e8">    Node&lt;</span><span style="color:#f97583">K</span><span style="color:#e1e4e8">,</span><span style="color:#f97583">V</span><span style="color:#e1e4e8">&gt;[] tab; Node&lt;</span><span style="color:#f97583">K</span><span style="color:#e1e4e8">,</span><span style="color:#f97583">V</span><span style="color:#e1e4e8">&gt; e, p; </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> n, eh; K ek;</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">// spread ÊñπÊ≥ïËÉΩÁ°Æ‰øùËøîÂõûÁªìÊûúÊòØÊ≠£Êï∞</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> h </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">spread</span><span style="color:#e1e4e8">(key.</span><span style="color:#b392f0">hashCode</span><span style="color:#e1e4e8">());</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> ((tab </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> table) </span><span style="color:#f97583">!=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">&amp;&amp;</span><span style="color:#e1e4e8"> (n </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> tab.length) </span><span style="color:#f97583">&gt;</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">&amp;&amp;</span></span>
<span class="line"><span style="color:#e1e4e8">        (e </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">tabAt</span><span style="color:#e1e4e8">(tab, (n </span><span style="color:#f97583">-</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">1</span><span style="color:#e1e4e8">) </span><span style="color:#f97583">&amp;</span><span style="color:#e1e4e8"> h)) </span><span style="color:#f97583">!=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#6a737d">// Â¶ÇÊûúÂ§¥ÁªìÁÇπÂ∑≤ÁªèÊòØË¶ÅÊü•ÊâæÁöÑ key</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> ((eh </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> e.hash) </span><span style="color:#f97583">==</span><span style="color:#e1e4e8"> h) {</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> ((ek </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> e.key) </span><span style="color:#f97583">==</span><span style="color:#e1e4e8"> key </span><span style="color:#f97583">||</span><span style="color:#e1e4e8"> (ek </span><span style="color:#f97583">!=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">&amp;&amp;</span><span style="color:#e1e4e8"> key.</span><span style="color:#b392f0">equals</span><span style="color:#e1e4e8">(ek)))</span></span>
<span class="line"><span style="color:#e1e4e8">            	</span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> e.val;</span></span>
<span class="line"><span style="color:#e1e4e8">        }</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#6a737d">// hash ‰∏∫Ë¥üÊï∞Ë°®Á§∫ËØ• bin Âú®Êâ©ÂÆπ‰∏≠ÊàñÊòØ treebin, ËøôÊó∂Ë∞ÉÁî® find ÊñπÊ≥ïÊù•Êü•Êâæ</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">else</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (eh </span><span style="color:#f97583">&lt;</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8">)</span></span>
<span class="line"><span style="color:#e1e4e8">        	</span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> (p </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> e.</span><span style="color:#b392f0">find</span><span style="color:#e1e4e8">(h, key)) </span><span style="color:#f97583">!=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">?</span><span style="color:#e1e4e8"> p.val </span><span style="color:#f97583">:</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#6a737d">// Ê≠£Â∏∏ÈÅçÂéÜÈìæË°®, Áî® equals ÊØîËæÉ</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">while</span><span style="color:#e1e4e8"> ((e </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> e.next) </span><span style="color:#f97583">!=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (e.hash </span><span style="color:#f97583">==</span><span style="color:#e1e4e8"> h </span><span style="color:#f97583">&amp;&amp;</span></span>
<span class="line"><span style="color:#e1e4e8">                ((ek </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> e.key) </span><span style="color:#f97583">==</span><span style="color:#e1e4e8"> key </span><span style="color:#f97583">||</span><span style="color:#e1e4e8"> (ek </span><span style="color:#f97583">!=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">&amp;&amp;</span><span style="color:#e1e4e8"> key.</span><span style="color:#b392f0">equals</span><span style="color:#e1e4e8">(ek))))</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> e.val;</span></span>
<span class="line"><span style="color:#e1e4e8">        }</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#d73a49">public</span><span style="color:#24292e"> V </span><span style="color:#6f42c1">get</span><span style="color:#24292e">(Object key) {</span></span>
<span class="line"><span style="color:#24292e">    Node&lt;</span><span style="color:#d73a49">K</span><span style="color:#24292e">,</span><span style="color:#d73a49">V</span><span style="color:#24292e">&gt;[] tab; Node&lt;</span><span style="color:#d73a49">K</span><span style="color:#24292e">,</span><span style="color:#d73a49">V</span><span style="color:#24292e">&gt; e, p; </span><span style="color:#d73a49">int</span><span style="color:#24292e"> n, eh; K ek;</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">// spread ÊñπÊ≥ïËÉΩÁ°Æ‰øùËøîÂõûÁªìÊûúÊòØÊ≠£Êï∞</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">int</span><span style="color:#24292e"> h </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#6f42c1">spread</span><span style="color:#24292e">(key.</span><span style="color:#6f42c1">hashCode</span><span style="color:#24292e">());</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">if</span><span style="color:#24292e"> ((tab </span><span style="color:#d73a49">=</span><span style="color:#24292e"> table) </span><span style="color:#d73a49">!=</span><span style="color:#24292e"> </span><span style="color:#005cc5">null</span><span style="color:#24292e"> </span><span style="color:#d73a49">&amp;&amp;</span><span style="color:#24292e"> (n </span><span style="color:#d73a49">=</span><span style="color:#24292e"> tab.length) </span><span style="color:#d73a49">&gt;</span><span style="color:#24292e"> </span><span style="color:#005cc5">0</span><span style="color:#24292e"> </span><span style="color:#d73a49">&amp;&amp;</span></span>
<span class="line"><span style="color:#24292e">        (e </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#6f42c1">tabAt</span><span style="color:#24292e">(tab, (n </span><span style="color:#d73a49">-</span><span style="color:#24292e"> </span><span style="color:#005cc5">1</span><span style="color:#24292e">) </span><span style="color:#d73a49">&amp;</span><span style="color:#24292e"> h)) </span><span style="color:#d73a49">!=</span><span style="color:#24292e"> </span><span style="color:#005cc5">null</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6a737d">// Â¶ÇÊûúÂ§¥ÁªìÁÇπÂ∑≤ÁªèÊòØË¶ÅÊü•ÊâæÁöÑ key</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">if</span><span style="color:#24292e"> ((eh </span><span style="color:#d73a49">=</span><span style="color:#24292e"> e.hash) </span><span style="color:#d73a49">==</span><span style="color:#24292e"> h) {</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">if</span><span style="color:#24292e"> ((ek </span><span style="color:#d73a49">=</span><span style="color:#24292e"> e.key) </span><span style="color:#d73a49">==</span><span style="color:#24292e"> key </span><span style="color:#d73a49">||</span><span style="color:#24292e"> (ek </span><span style="color:#d73a49">!=</span><span style="color:#24292e"> </span><span style="color:#005cc5">null</span><span style="color:#24292e"> </span><span style="color:#d73a49">&amp;&amp;</span><span style="color:#24292e"> key.</span><span style="color:#6f42c1">equals</span><span style="color:#24292e">(ek)))</span></span>
<span class="line"><span style="color:#24292e">            	</span><span style="color:#d73a49">return</span><span style="color:#24292e"> e.val;</span></span>
<span class="line"><span style="color:#24292e">        }</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6a737d">// hash ‰∏∫Ë¥üÊï∞Ë°®Á§∫ËØ• bin Âú®Êâ©ÂÆπ‰∏≠ÊàñÊòØ treebin, ËøôÊó∂Ë∞ÉÁî® find ÊñπÊ≥ïÊù•Êü•Êâæ</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">else</span><span style="color:#24292e"> </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (eh </span><span style="color:#d73a49">&lt;</span><span style="color:#24292e"> </span><span style="color:#005cc5">0</span><span style="color:#24292e">)</span></span>
<span class="line"><span style="color:#24292e">        	</span><span style="color:#d73a49">return</span><span style="color:#24292e"> (p </span><span style="color:#d73a49">=</span><span style="color:#24292e"> e.</span><span style="color:#6f42c1">find</span><span style="color:#24292e">(h, key)) </span><span style="color:#d73a49">!=</span><span style="color:#24292e"> </span><span style="color:#005cc5">null</span><span style="color:#24292e"> </span><span style="color:#d73a49">?</span><span style="color:#24292e"> p.val </span><span style="color:#d73a49">:</span><span style="color:#24292e"> </span><span style="color:#005cc5">null</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6a737d">// Ê≠£Â∏∏ÈÅçÂéÜÈìæË°®, Áî® equals ÊØîËæÉ</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">while</span><span style="color:#24292e"> ((e </span><span style="color:#d73a49">=</span><span style="color:#24292e"> e.next) </span><span style="color:#d73a49">!=</span><span style="color:#24292e"> </span><span style="color:#005cc5">null</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (e.hash </span><span style="color:#d73a49">==</span><span style="color:#24292e"> h </span><span style="color:#d73a49">&amp;&amp;</span></span>
<span class="line"><span style="color:#24292e">                ((ek </span><span style="color:#d73a49">=</span><span style="color:#24292e"> e.key) </span><span style="color:#d73a49">==</span><span style="color:#24292e"> key </span><span style="color:#d73a49">||</span><span style="color:#24292e"> (ek </span><span style="color:#d73a49">!=</span><span style="color:#24292e"> </span><span style="color:#005cc5">null</span><span style="color:#24292e"> </span><span style="color:#d73a49">&amp;&amp;</span><span style="color:#24292e"> key.</span><span style="color:#6f42c1">equals</span><span style="color:#24292e">(ek))))</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#d73a49">return</span><span style="color:#24292e"> e.val;</span></span>
<span class="line"><span style="color:#24292e">        }</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">return</span><span style="color:#24292e"> </span><span style="color:#005cc5">null</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">}</span></span></code></pre></div><blockquote><p>getÊñπÊ≥ïÂÖ®Á®ãÊ≤°ÊúâÂä†ÈîÅÔºåÊÄßËÉΩÈ´òÔºõhÊòØÁúüÊ≠£Âéªget/putÁî®Âà∞ÁöÑkeyÁöÑhashÁ†Å</p><p><code>e = tabAt(tab, (n - 1) &amp; h</code> ÊâæÂà∞Ê°∂‰∏ãÊ†áÁöÑÂ§¥ËäÇÁÇπ</p><p><code>(eh = e.hash) == h</code>ÔºöÂ§¥ËäÇÁÇπÁöÑhashÊòØÂê¶‰∏∫Ë¶ÅÊâæÁöÑkeyÁöÑhashÔºõËã•hash‰∏ÄÊ†∑ÂÜçÂà§Êñ≠ÊòØÂê¶‰∏∫Âêå‰∏ÄÂØπË±°ÔºåÊòØÂàôÁõ¥Êé•ËøîÂõû</p><p><code>eh &lt; 0</code>ÔºöÂ§¥ËäÇÁÇπhash‰∏∫Ë¥üÊï∞Ôºö1„ÄÅÈìæË°®Âú®Êâ©ÂÆπÂΩì‰∏≠Ôºå‰ºöÊääÊâ©ÂÆπÊ†èÈáåÁöÑÈìæË°®Â§¥ÈÉ®Âèò‰∏∫forwardingNodeÔºåÂÖ∂ÂèñÂÄºÂ∞±ÊòØË¥üÊï∞ÔºåË∞ÉÁî®ÂÖ∂findÊñπÊ≥ïÂà∞Êñ∞ÁöÑtableÈáåÂéªÊâæ‰Ω†ÁöÑkeyÔºõ<img src="https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230720145239444.png" alt="image-20230720145239444"></p><p>2„ÄÅÂΩìËäÇÁÇπ‰∏∫Ê†ëËäÇÁÇπÊó∂ÔºåtreebinËäÇÁÇπ‰πüË¶ÜÁõñ‰∫ÜfindÊñπÊ≥ï</p><figure><img src="https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230720145605684.png" alt="image-20230720145605684" loading="lazy" decoding="async"></figure><p>ÂÖ∂‰ªñÊÉÖÂÜµÊ≠£Â∏∏ÈÅçÂéÜ</p></blockquote><h6 id="put-ÊµÅÁ®ã" tabindex="-1">put ÊµÅÁ®ã <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20advanced%20chapter#put-ÊµÅÁ®ã" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h6><p>‰ª•‰∏ãÊï∞ÁªÑÁÆÄÁß∞ÔºàtableÔºâÔºåÈìæË°®ÁÆÄÁß∞ÔºàbinÔºâ</p><blockquote><p>onlyIfAbsentÔºötrueË°®Á§∫Âè™ÊúâÁ¨¨‰∏ÄÊ¨°‰Ω†put‰Ω†ÁöÑÈîÆÂíåÂÄºÊó∂Êâç‰ºöÂ∞ÜËøô‰∏™ÈîÆÂíåÂÄºÊîæÂà∞map‰∏≠ÔºåÁ¨¨‰∫åÊ¨°ÂÜçputÁõ∏ÂêåÁöÑkeyÊó∂Â∞±‰ºöÂèëÁé∞map‰∏≠Â∑≤ÁªèÊúâ‰∫ÜÂ∞±‰∏ç‰ºöÂÅö‰ªª‰ΩïÊìç‰ΩúÔºå‰∏ç‰ºöÁî®Êñ∞ÂÄºË¶ÜÁõñÊóßÂÄºÔºõfalseÂ∞±‰ºöÊØèÊ¨°putÊñ∞ÂÄºÈÉΩË¶ÜÁõñÊéâÊóßÂÄº</p><p>‰∏çÂÖÅËÆ∏ÊúâÁ©∫ÁöÑkeyÊàñvalueÔºåÂê¶ÂàôÊäõÂºÇÂ∏∏Ôºõspread‰øùËØÅhashÁ†Å‰∏∫Ê≠£Êï¥Êï∞</p><p>ÊáíÊÉ∞ÂàùÂßãÂåñÔºåÂΩìÁ¨¨‰∏ÄÊ¨°putÊó∂ÊâçÂàõÂª∫Êï∞ÁªÑÔºåÂàùÂßãÂåñ table ‰ΩøÁî®‰∫Ü cas, Êó†ÈúÄ synchronized ÂàõÂª∫ÊàêÂäü</p><p>Âú®Êâ©ÂÆπÊó∂ÔºåÂÖ∂‰ªñÁ∫øÁ®ãputÁöÑÊòØforwardingNodeÊ†áËÆ∞ÁöÑÊôÆÈÄöËäÇÁÇπÔºàÈùûÈìæË°®ÔºâÔºåÂ∞±‰ºöÂéªÂ∏ÆÂøôÊâ©ÂÆπÔºå‰∏ç‰ºöÂπ≤Á≠â</p><p>Ê°∂‰∏ãÊ†áÂÜ≤Á™ÅÊó∂ÊâçÂä†synchronizedÈîÅÔºõfh &gt;= 0Ë°®Á§∫ÊôÆÈÄöËäÇÁÇπÁöÑÈìæË°®</p><p>binCount&gt;=0Ë°®Á§∫Ê°∂‰∏ãÊ†áÂÜ≤Á™ÅÔºåÈÄöËøáËØ•ÂèòÈáè‰ºòÂåñÈìæË°®</p><p>addCountÁ±ª‰ºº‰∫éLongAdderÔºàÁ¥ØÂä†ÂçïÂÖÉcellÔºâÂéüÂ≠êËÆ°Êï∞ÔºåÁª¥Êä§Êï¥‰∏™hashmapÁöÑsizeËÆ°Êï∞ÔºåÂ¶ÇÊûúsizeËÆ°Êï∞Ë∂ÖËøáÈòàÂÄºÂ∞±‰ºöÂèëÁîüÊâ©ÂÆπ</p><p>initTableÔºöÊáíÊÉ∞ÂàùÂßãÂåñÔºåË∞ÉÁî®ËØ•ÊñπÊ≥ï‰∏∫‰∫Ü‰øùËØÅÁ∫øÁ®ãÂÆâÂÖ®ÔºåÂè™ËÉΩËÆ©‰∏Ä‰∏™Á∫øÁ®ãÊàêÂäüÂàõÂª∫hashË°®ÔºåÂÖ∂‰ªñÁ∫øÁ®ãÂ∞±‰∏çËÉΩÂÜçÂàõÂª∫‰∫ÜÔºõÈÄöËøáCASÊìç‰ΩúÂ∞ùËØïÂ∞ÜsizeCtlËÆæ‰∏∫-1ÂÆåÊàêÂàùÂßãÂåñÂàõÂª∫hashË°®ÔºåÊú™ÂàõÂª∫hash‰∏îÊú™ËÆæÂàùÂßãÂÆπÈáèÂàôÈªòËÆ§‰∏∫16ÔºåÁÑ∂ÂêéÂàõÂª∫NodeÊï∞ÁªÑÔºåÂπ∂ËÆ°ÁÆó‰∏ãÊ¨°Êâ©ÂÆπÊó∂ÁöÑÈòàÂÄº</p></blockquote><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#f97583">public</span><span style="color:#e1e4e8"> V </span><span style="color:#b392f0">put</span><span style="color:#e1e4e8">(K key, V value) {</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">putVal</span><span style="color:#e1e4e8">(key, value, </span><span style="color:#79b8ff">false</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">}</span></span>
<span class="line"><span style="color:#f97583">final</span><span style="color:#e1e4e8"> V </span><span style="color:#b392f0">putVal</span><span style="color:#e1e4e8">(K key, V value, </span><span style="color:#f97583">boolean</span><span style="color:#e1e4e8"> onlyIfAbsent) {</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (key </span><span style="color:#f97583">==</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">||</span><span style="color:#e1e4e8"> value </span><span style="color:#f97583">==</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8">) </span><span style="color:#f97583">throw</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">NullPointerException</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">// ÂÖ∂‰∏≠ spread ÊñπÊ≥ï‰ºöÁªºÂêàÈ´ò‰Ωç‰Ωé‰Ωç, ÂÖ∑ÊúâÊõ¥Â•ΩÁöÑ hash ÊÄß</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> hash </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">spread</span><span style="color:#e1e4e8">(key.</span><span style="color:#b392f0">hashCode</span><span style="color:#e1e4e8">());</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> binCount </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">for</span><span style="color:#e1e4e8"> (Node&lt;</span><span style="color:#f97583">K</span><span style="color:#e1e4e8">,</span><span style="color:#f97583">V</span><span style="color:#e1e4e8">&gt;[] tab </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> table;;) {</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#6a737d">// f ÊòØÈìæË°®Â§¥ËäÇÁÇπ</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#6a737d">// fh ÊòØÈìæË°®Â§¥ÁªìÁÇπÁöÑ hash</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#6a737d">// i ÊòØÈìæË°®Âú® table ‰∏≠ÁöÑ‰∏ãÊ†á</span></span>
<span class="line"><span style="color:#e1e4e8">        Node&lt;</span><span style="color:#f97583">K</span><span style="color:#e1e4e8">,</span><span style="color:#f97583">V</span><span style="color:#e1e4e8">&gt; f; </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> n, i, fh;</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#6a737d">// Ë¶ÅÂàõÂª∫ table</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (tab </span><span style="color:#f97583">==</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">||</span><span style="color:#e1e4e8"> (n </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> tab.length) </span><span style="color:#f97583">==</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8">)</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#6a737d">// ÂàùÂßãÂåñ table ‰ΩøÁî®‰∫Ü cas, Êó†ÈúÄ synchronized ÂàõÂª∫ÊàêÂäü, ËøõÂÖ•‰∏ã‰∏ÄËΩÆÂæ™ÁéØ</span></span>
<span class="line"><span style="color:#e1e4e8">            tab </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">initTable</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#6a737d">// Ë¶ÅÂàõÂª∫ÈìæË°®Â§¥ËäÇÁÇπ</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">else</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> ((f </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">tabAt</span><span style="color:#e1e4e8">(tab, i </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> (n </span><span style="color:#f97583">-</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">1</span><span style="color:#e1e4e8">) </span><span style="color:#f97583">&amp;</span><span style="color:#e1e4e8"> hash)) </span><span style="color:#f97583">==</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#6a737d">// Ê∑ªÂä†ÈìæË°®Â§¥‰ΩøÁî®‰∫Ü cas, Êó†ÈúÄ synchronized</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (</span><span style="color:#b392f0">casTabAt</span><span style="color:#e1e4e8">(tab, i, </span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8">,</span></span>
<span class="line"><span style="color:#e1e4e8">            		</span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> Node&lt;</span><span style="color:#f97583">K</span><span style="color:#e1e4e8">,</span><span style="color:#f97583">V</span><span style="color:#e1e4e8">&gt;(hash, key, value, </span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8">)))</span></span>
<span class="line"><span style="color:#e1e4e8">        	</span><span style="color:#f97583">break</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">        }</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#6a737d">// Â∏ÆÂøôÊâ©ÂÆπ</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">else</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> ((fh </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> f.hash) </span><span style="color:#f97583">==</span><span style="color:#e1e4e8"> MOVED)</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#6a737d">// Â∏ÆÂøô‰πãÂêé, ËøõÂÖ•‰∏ã‰∏ÄËΩÆÂæ™ÁéØ</span></span>
<span class="line"><span style="color:#e1e4e8">            tab </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">helpTransfer</span><span style="color:#e1e4e8">(tab, f);</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">else</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">            V oldVal </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#6a737d">// ÈîÅ‰ΩèÈìæË°®Â§¥ËäÇÁÇπ</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">synchronized</span><span style="color:#e1e4e8"> (f) {</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#6a737d">// ÂÜçÊ¨°Á°ÆËÆ§ÈìæË°®Â§¥ËäÇÁÇπÊ≤°ÊúâË¢´ÁßªÂä®</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (</span><span style="color:#b392f0">tabAt</span><span style="color:#e1e4e8">(tab, i) </span><span style="color:#f97583">==</span><span style="color:#e1e4e8"> f) {</span></span>
<span class="line"><span style="color:#e1e4e8">                    </span><span style="color:#6a737d">// ÈìæË°®</span></span>
<span class="line"><span style="color:#e1e4e8">                    </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (fh </span><span style="color:#f97583">&gt;=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">                        binCount </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">1</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">                        </span><span style="color:#6a737d">// ÈÅçÂéÜÈìæË°®</span></span>
<span class="line"><span style="color:#e1e4e8">                        </span><span style="color:#f97583">for</span><span style="color:#e1e4e8"> (Node&lt;</span><span style="color:#f97583">K</span><span style="color:#e1e4e8">,</span><span style="color:#f97583">V</span><span style="color:#e1e4e8">&gt; e </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> f;; </span><span style="color:#f97583">++</span><span style="color:#e1e4e8">binCount) {</span></span>
<span class="line"><span style="color:#e1e4e8">                            K ek;</span></span>
<span class="line"><span style="color:#e1e4e8">                            </span><span style="color:#6a737d">// ÊâæÂà∞Áõ∏ÂêåÁöÑ key</span></span>
<span class="line"><span style="color:#e1e4e8">                            </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (e.hash </span><span style="color:#f97583">==</span><span style="color:#e1e4e8"> hash </span><span style="color:#f97583">&amp;&amp;</span></span>
<span class="line"><span style="color:#e1e4e8">                                ((ek </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> e.key) </span><span style="color:#f97583">==</span><span style="color:#e1e4e8"> key </span><span style="color:#f97583">||</span></span>
<span class="line"><span style="color:#e1e4e8">                                 (ek </span><span style="color:#f97583">!=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">&amp;&amp;</span><span style="color:#e1e4e8"> key.</span><span style="color:#b392f0">equals</span><span style="color:#e1e4e8">(ek)))) {</span></span>
<span class="line"><span style="color:#e1e4e8">                                oldVal </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> e.val;</span></span>
<span class="line"><span style="color:#e1e4e8">                                </span><span style="color:#6a737d">// Êõ¥Êñ∞</span></span>
<span class="line"><span style="color:#e1e4e8">                                </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (</span><span style="color:#f97583">!</span><span style="color:#e1e4e8">onlyIfAbsent)</span></span>
<span class="line"><span style="color:#e1e4e8">                                    </span><span style="color:#6a737d">//Êñ∞ÂÄºË¶ÜÁõñÊóßÂÄº</span></span>
<span class="line"><span style="color:#e1e4e8">                                     e.val </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> value;</span></span>
<span class="line"><span style="color:#e1e4e8">                                </span><span style="color:#f97583">break</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">                            }</span></span>
<span class="line"><span style="color:#e1e4e8">                            Node&lt;</span><span style="color:#f97583">K</span><span style="color:#e1e4e8">,</span><span style="color:#f97583">V</span><span style="color:#e1e4e8">&gt; pred </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> e;</span></span>
<span class="line"><span style="color:#e1e4e8">                            </span></span>
<span class="line"><span style="color:#e1e4e8">                            </span><span style="color:#6a737d">// Â∑≤ÁªèÊòØÊúÄÂêéÁöÑËäÇÁÇπ‰∫Ü, Êñ∞Â¢û Node, ËøΩÂä†Ëá≥ÈìæË°®Â∞æ</span></span>
<span class="line"><span style="color:#e1e4e8">                            </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> ((e </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> e.next) </span><span style="color:#f97583">==</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">                                pred.next </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> Node&lt;</span><span style="color:#f97583">K</span><span style="color:#e1e4e8">,</span><span style="color:#f97583">V</span><span style="color:#e1e4e8">&gt;(hash, key,</span></span>
<span class="line"><span style="color:#e1e4e8">                                value, </span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">                                </span><span style="color:#f97583">break</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">                            }</span></span>
<span class="line"><span style="color:#e1e4e8">                        }</span></span>
<span class="line"><span style="color:#e1e4e8">                    }</span></span>
<span class="line"><span style="color:#e1e4e8">                    </span><span style="color:#6a737d">// Á∫¢ÈªëÊ†ë</span></span>
<span class="line"><span style="color:#e1e4e8">                    </span><span style="color:#f97583">else</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (f </span><span style="color:#f97583">instanceof</span><span style="color:#e1e4e8"> TreeBin) {</span></span>
<span class="line"><span style="color:#e1e4e8">                        Node&lt;</span><span style="color:#f97583">K</span><span style="color:#e1e4e8">,</span><span style="color:#f97583">V</span><span style="color:#e1e4e8">&gt; p;</span></span>
<span class="line"><span style="color:#e1e4e8">                        binCount </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">2</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">                        </span><span style="color:#6a737d">// putTreeVal ‰ºöÁúã key ÊòØÂê¶Â∑≤ÁªèÂú®Ê†ë‰∏≠, ÊòØ, ÂàôËøîÂõûÂØπÂ∫îÁöÑ TreeNode</span></span>
<span class="line"><span style="color:#e1e4e8">                        </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> ((p </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> ((TreeBin</span><span style="color:#f97583">&lt;</span><span style="color:#e1e4e8">K,V</span><span style="color:#f97583">&gt;</span><span style="color:#e1e4e8">)f).</span><span style="color:#b392f0">putTreeVal</span><span style="color:#e1e4e8">(hash, key,</span></span>
<span class="line"><span style="color:#e1e4e8">                                    value)) </span><span style="color:#f97583">!=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">                            oldVal </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> p.val;</span></span>
<span class="line"><span style="color:#e1e4e8">                            </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (</span><span style="color:#f97583">!</span><span style="color:#e1e4e8">onlyIfAbsent)</span></span>
<span class="line"><span style="color:#e1e4e8">                                p.val </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> value;</span></span>
<span class="line"><span style="color:#e1e4e8">                		}</span></span>
<span class="line"><span style="color:#e1e4e8">                	}</span></span>
<span class="line"><span style="color:#e1e4e8">            	}</span></span>
<span class="line"><span style="color:#e1e4e8">           </span><span style="color:#6a737d">// ÈáäÊîæÈìæË°®Â§¥ËäÇÁÇπÁöÑÈîÅ</span></span>
<span class="line"><span style="color:#e1e4e8">           }</span></span>
<span class="line"><span style="color:#e1e4e8">           </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (binCount </span><span style="color:#f97583">!=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (binCount </span><span style="color:#f97583">&gt;=</span><span style="color:#e1e4e8"> TREEIFY_THRESHOLD)</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#6a737d">// Â¶ÇÊûúÈìæË°®ÈïøÂ∫¶ &gt;= Ê†ëÂåñÈòàÂÄº(8), ËøõË°åÈìæË°®ËΩ¨‰∏∫Á∫¢ÈªëÊ†ë</span></span>
<span class="line"><span style="color:#e1e4e8">                	</span><span style="color:#b392f0">treeifyBin</span><span style="color:#e1e4e8">(tab, i);</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (oldVal </span><span style="color:#f97583">!=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8">)</span></span>
<span class="line"><span style="color:#e1e4e8">                	</span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> oldVal;</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#f97583">break</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">            }</span></span>
<span class="line"><span style="color:#e1e4e8">       	}</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">// Â¢ûÂä† size ËÆ°Êï∞</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#b392f0">addCount</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">1L</span><span style="color:#e1e4e8">, binCount);</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">}</span></span>
<span class="line"><span style="color:#f97583">private</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">final</span><span style="color:#e1e4e8"> Node</span><span style="color:#f97583">&lt;</span><span style="color:#e1e4e8">K,V</span><span style="color:#f97583">&gt;</span><span style="color:#e1e4e8">[] </span><span style="color:#b392f0">initTable</span><span style="color:#e1e4e8">() {</span></span>
<span class="line"><span style="color:#e1e4e8">    Node&lt;</span><span style="color:#f97583">K</span><span style="color:#e1e4e8">,</span><span style="color:#f97583">V</span><span style="color:#e1e4e8">&gt;[] tab; </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> sc;</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">while</span><span style="color:#e1e4e8"> ((tab </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> table) </span><span style="color:#f97583">==</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">||</span><span style="color:#e1e4e8"> tab.length </span><span style="color:#f97583">==</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> ((sc </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> sizeCtl) </span><span style="color:#f97583">&lt;</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8">)</span></span>
<span class="line"><span style="color:#e1e4e8">        	Thread.</span><span style="color:#b392f0">yield</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#6a737d">// Â∞ùËØïÂ∞Ü sizeCtl ËÆæÁΩÆ‰∏∫ -1ÔºàË°®Á§∫ÂàùÂßãÂåñ tableÔºâ</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">else</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (U.</span><span style="color:#b392f0">compareAndSwapInt</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">this</span><span style="color:#e1e4e8">, SIZECTL, sc, </span><span style="color:#f97583">-</span><span style="color:#79b8ff">1</span><span style="color:#e1e4e8">)) {</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#6a737d">// Ëé∑ÂæóÈîÅ, ÂàõÂª∫ table, ËøôÊó∂ÂÖ∂ÂÆÉÁ∫øÁ®ã‰ºöÂú® while() Âæ™ÁéØ‰∏≠ yield Áõ¥Ëá≥ table ÂàõÂª∫</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">try</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> ((tab </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> table) </span><span style="color:#f97583">==</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">||</span><span style="color:#e1e4e8"> tab.length </span><span style="color:#f97583">==</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">                    </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> n </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> (sc </span><span style="color:#f97583">&gt;</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8">) </span><span style="color:#f97583">?</span><span style="color:#e1e4e8"> sc </span><span style="color:#f97583">:</span><span style="color:#e1e4e8"> DEFAULT_CAPACITY;</span></span>
<span class="line"><span style="color:#e1e4e8">                    Node&lt;</span><span style="color:#f97583">K</span><span style="color:#e1e4e8">,</span><span style="color:#f97583">V</span><span style="color:#e1e4e8">&gt;[] nt </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> (Node</span><span style="color:#f97583">&lt;</span><span style="color:#e1e4e8">K,V</span><span style="color:#f97583">&gt;</span><span style="color:#e1e4e8">[])</span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> Node&lt;</span><span style="color:#f97583">?</span><span style="color:#e1e4e8">,</span><span style="color:#f97583">?</span><span style="color:#e1e4e8">&gt;[n];</span></span>
<span class="line"><span style="color:#e1e4e8">                    table </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> tab </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> nt;</span></span>
<span class="line"><span style="color:#e1e4e8">                    sc </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> n </span><span style="color:#f97583">-</span><span style="color:#e1e4e8"> (n </span><span style="color:#f97583">&gt;&gt;&gt;</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">2</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">                }</span></span>
<span class="line"><span style="color:#e1e4e8">            } </span><span style="color:#f97583">finally</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">                sizeCtl </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> sc;</span></span>
<span class="line"><span style="color:#e1e4e8">            }</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">break</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">        }</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> tab;</span></span>
<span class="line"><span style="color:#e1e4e8">}</span></span>
<span class="line"><span style="color:#6a737d">// check ÊòØ‰πãÂâç binCount ÁöÑ‰∏™Êï∞</span></span>
<span class="line"><span style="color:#f97583">private</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">final</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">void</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">addCount</span><span style="color:#e1e4e8">(</span><span style="color:#f97583">long</span><span style="color:#e1e4e8"> x, </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> check) {</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">CounterCell</span><span style="color:#e1e4e8">[] as; </span><span style="color:#f97583">long</span><span style="color:#e1e4e8"> b, s;</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#6a737d">// Â∑≤ÁªèÊúâ‰∫Ü counterCells, Âêë cell Á¥ØÂä†</span></span>
<span class="line"><span style="color:#e1e4e8">        (as </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> counterCells) </span><span style="color:#f97583">!=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">||</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#6a737d">// ËøòÊ≤°Êúâ, Âêë baseCount Á¥ØÂä†</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">!</span><span style="color:#e1e4e8">U.</span><span style="color:#b392f0">compareAndSwapLong</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">this</span><span style="color:#e1e4e8">, BASECOUNT, b </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> baseCount, s </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> b </span><span style="color:#f97583">+</span><span style="color:#e1e4e8"> x)</span></span>
<span class="line"><span style="color:#e1e4e8">    ) {</span></span>
<span class="line"><span style="color:#e1e4e8">        CounterCell a; </span><span style="color:#f97583">long</span><span style="color:#e1e4e8"> v; </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> m;</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">boolean</span><span style="color:#e1e4e8"> uncontended </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">true</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#6a737d">// ËøòÊ≤°Êúâ counterCells</span></span>
<span class="line"><span style="color:#e1e4e8">            as </span><span style="color:#f97583">==</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">||</span><span style="color:#e1e4e8"> (m </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> as.length </span><span style="color:#f97583">-</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">1</span><span style="color:#e1e4e8">) </span><span style="color:#f97583">&lt;</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">||</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#6a737d">// ËøòÊ≤°Êúâ cell</span></span>
<span class="line"><span style="color:#e1e4e8">            (a </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> as[ThreadLocalRandom.</span><span style="color:#b392f0">getProbe</span><span style="color:#e1e4e8">() </span><span style="color:#f97583">&amp;</span><span style="color:#e1e4e8"> m]) </span><span style="color:#f97583">==</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">||</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#6a737d">// cell cas Â¢ûÂä†ËÆ°Êï∞Â§±Ë¥•</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">!</span><span style="color:#e1e4e8">(uncontended </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> U.</span><span style="color:#b392f0">compareAndSwapLong</span><span style="color:#e1e4e8">(a, CELLVALUE, v </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> a.value, v </span><span style="color:#f97583">+</span><span style="color:#e1e4e8"> x))</span></span>
<span class="line"><span style="color:#e1e4e8">        	) {</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#6a737d">// ÂàõÂª∫Á¥ØÂä†ÂçïÂÖÉÊï∞ÁªÑÂíåcell, Á¥ØÂä†ÈáçËØï</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#b392f0">fullAddCount</span><span style="color:#e1e4e8">(x, uncontended);</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">return</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">        }</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (check </span><span style="color:#f97583">&lt;=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">1</span><span style="color:#e1e4e8">)</span></span>
<span class="line"><span style="color:#e1e4e8">        	</span><span style="color:#f97583">return</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#6a737d">// Ëé∑ÂèñÂÖÉÁ¥†‰∏™Êï∞</span></span>
<span class="line"><span style="color:#e1e4e8">        s </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">sumCount</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (check </span><span style="color:#f97583">&gt;=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">    Node&lt;</span><span style="color:#f97583">K</span><span style="color:#e1e4e8">,</span><span style="color:#f97583">V</span><span style="color:#e1e4e8">&gt;[] tab, nt; </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> n, sc;</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">while</span><span style="color:#e1e4e8"> (s </span><span style="color:#f97583">&gt;=</span><span style="color:#e1e4e8"> (</span><span style="color:#f97583">long</span><span style="color:#e1e4e8">)(sc </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> sizeCtl) </span><span style="color:#f97583">&amp;&amp;</span><span style="color:#e1e4e8"> (tab </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> table) </span><span style="color:#f97583">!=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">&amp;&amp;</span></span>
<span class="line"><span style="color:#e1e4e8">           (n </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> tab.length) </span><span style="color:#f97583">&lt;</span><span style="color:#e1e4e8"> MAXIMUM_CAPACITY) {</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> rs </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">resizeStamp</span><span style="color:#e1e4e8">(n);</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (sc </span><span style="color:#f97583">&lt;</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> ((sc </span><span style="color:#f97583">&gt;&gt;&gt;</span><span style="color:#e1e4e8"> RESIZE_STAMP_SHIFT) </span><span style="color:#f97583">!=</span><span style="color:#e1e4e8"> rs </span><span style="color:#f97583">||</span><span style="color:#e1e4e8"> sc </span><span style="color:#f97583">==</span><span style="color:#e1e4e8"> rs </span><span style="color:#f97583">+</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">1</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">||</span></span>
<span class="line"><span style="color:#e1e4e8">                sc </span><span style="color:#f97583">==</span><span style="color:#e1e4e8"> rs </span><span style="color:#f97583">+</span><span style="color:#e1e4e8"> MAX_RESIZERS </span><span style="color:#f97583">||</span><span style="color:#e1e4e8"> (nt </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> nextTable) </span><span style="color:#f97583">==</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">||</span></span>
<span class="line"><span style="color:#e1e4e8">                transferIndex </span><span style="color:#f97583">&lt;=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8">)</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#f97583">break</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#6a737d">// newtable Â∑≤ÁªèÂàõÂª∫‰∫ÜÔºåÂ∏ÆÂøôÊâ©ÂÆπ</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (U.</span><span style="color:#b392f0">compareAndSwapInt</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">this</span><span style="color:#e1e4e8">, SIZECTL, sc, sc </span><span style="color:#f97583">+</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">1</span><span style="color:#e1e4e8">))</span></span>
<span class="line"><span style="color:#e1e4e8">            	</span><span style="color:#b392f0">transfer</span><span style="color:#e1e4e8">(tab, nt);</span></span>
<span class="line"><span style="color:#e1e4e8">            }</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#6a737d">// ÈúÄË¶ÅÊâ©ÂÆπÔºåËøôÊó∂ newtable Êú™ÂàõÂª∫</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">else</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (U.</span><span style="color:#b392f0">compareAndSwapInt</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">this</span><span style="color:#e1e4e8">, SIZECTL, sc,</span></span>
<span class="line"><span style="color:#e1e4e8">            			(rs </span><span style="color:#f97583">&lt;&lt;</span><span style="color:#e1e4e8"> RESIZE_STAMP_SHIFT) </span><span style="color:#f97583">+</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">2</span><span style="color:#e1e4e8">))</span></span>
<span class="line"><span style="color:#e1e4e8">            	</span><span style="color:#b392f0">transfer</span><span style="color:#e1e4e8">(tab, </span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">            s </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">sumCount</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">        }</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"><span style="color:#e1e4e8">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#d73a49">public</span><span style="color:#24292e"> V </span><span style="color:#6f42c1">put</span><span style="color:#24292e">(K key, V value) {</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">return</span><span style="color:#24292e"> </span><span style="color:#6f42c1">putVal</span><span style="color:#24292e">(key, value, </span><span style="color:#005cc5">false</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">}</span></span>
<span class="line"><span style="color:#d73a49">final</span><span style="color:#24292e"> V </span><span style="color:#6f42c1">putVal</span><span style="color:#24292e">(K key, V value, </span><span style="color:#d73a49">boolean</span><span style="color:#24292e"> onlyIfAbsent) {</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (key </span><span style="color:#d73a49">==</span><span style="color:#24292e"> </span><span style="color:#005cc5">null</span><span style="color:#24292e"> </span><span style="color:#d73a49">||</span><span style="color:#24292e"> value </span><span style="color:#d73a49">==</span><span style="color:#24292e"> </span><span style="color:#005cc5">null</span><span style="color:#24292e">) </span><span style="color:#d73a49">throw</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">NullPointerException</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">// ÂÖ∂‰∏≠ spread ÊñπÊ≥ï‰ºöÁªºÂêàÈ´ò‰Ωç‰Ωé‰Ωç, ÂÖ∑ÊúâÊõ¥Â•ΩÁöÑ hash ÊÄß</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">int</span><span style="color:#24292e"> hash </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#6f42c1">spread</span><span style="color:#24292e">(key.</span><span style="color:#6f42c1">hashCode</span><span style="color:#24292e">());</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">int</span><span style="color:#24292e"> binCount </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#005cc5">0</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">for</span><span style="color:#24292e"> (Node&lt;</span><span style="color:#d73a49">K</span><span style="color:#24292e">,</span><span style="color:#d73a49">V</span><span style="color:#24292e">&gt;[] tab </span><span style="color:#d73a49">=</span><span style="color:#24292e"> table;;) {</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6a737d">// f ÊòØÈìæË°®Â§¥ËäÇÁÇπ</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6a737d">// fh ÊòØÈìæË°®Â§¥ÁªìÁÇπÁöÑ hash</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6a737d">// i ÊòØÈìæË°®Âú® table ‰∏≠ÁöÑ‰∏ãÊ†á</span></span>
<span class="line"><span style="color:#24292e">        Node&lt;</span><span style="color:#d73a49">K</span><span style="color:#24292e">,</span><span style="color:#d73a49">V</span><span style="color:#24292e">&gt; f; </span><span style="color:#d73a49">int</span><span style="color:#24292e"> n, i, fh;</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6a737d">// Ë¶ÅÂàõÂª∫ table</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (tab </span><span style="color:#d73a49">==</span><span style="color:#24292e"> </span><span style="color:#005cc5">null</span><span style="color:#24292e"> </span><span style="color:#d73a49">||</span><span style="color:#24292e"> (n </span><span style="color:#d73a49">=</span><span style="color:#24292e"> tab.length) </span><span style="color:#d73a49">==</span><span style="color:#24292e"> </span><span style="color:#005cc5">0</span><span style="color:#24292e">)</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#6a737d">// ÂàùÂßãÂåñ table ‰ΩøÁî®‰∫Ü cas, Êó†ÈúÄ synchronized ÂàõÂª∫ÊàêÂäü, ËøõÂÖ•‰∏ã‰∏ÄËΩÆÂæ™ÁéØ</span></span>
<span class="line"><span style="color:#24292e">            tab </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#6f42c1">initTable</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6a737d">// Ë¶ÅÂàõÂª∫ÈìæË°®Â§¥ËäÇÁÇπ</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">else</span><span style="color:#24292e"> </span><span style="color:#d73a49">if</span><span style="color:#24292e"> ((f </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#6f42c1">tabAt</span><span style="color:#24292e">(tab, i </span><span style="color:#d73a49">=</span><span style="color:#24292e"> (n </span><span style="color:#d73a49">-</span><span style="color:#24292e"> </span><span style="color:#005cc5">1</span><span style="color:#24292e">) </span><span style="color:#d73a49">&amp;</span><span style="color:#24292e"> hash)) </span><span style="color:#d73a49">==</span><span style="color:#24292e"> </span><span style="color:#005cc5">null</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#6a737d">// Ê∑ªÂä†ÈìæË°®Â§¥‰ΩøÁî®‰∫Ü cas, Êó†ÈúÄ synchronized</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (</span><span style="color:#6f42c1">casTabAt</span><span style="color:#24292e">(tab, i, </span><span style="color:#005cc5">null</span><span style="color:#24292e">,</span></span>
<span class="line"><span style="color:#24292e">            		</span><span style="color:#d73a49">new</span><span style="color:#24292e"> Node&lt;</span><span style="color:#d73a49">K</span><span style="color:#24292e">,</span><span style="color:#d73a49">V</span><span style="color:#24292e">&gt;(hash, key, value, </span><span style="color:#005cc5">null</span><span style="color:#24292e">)))</span></span>
<span class="line"><span style="color:#24292e">        	</span><span style="color:#d73a49">break</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">        }</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6a737d">// Â∏ÆÂøôÊâ©ÂÆπ</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">else</span><span style="color:#24292e"> </span><span style="color:#d73a49">if</span><span style="color:#24292e"> ((fh </span><span style="color:#d73a49">=</span><span style="color:#24292e"> f.hash) </span><span style="color:#d73a49">==</span><span style="color:#24292e"> MOVED)</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#6a737d">// Â∏ÆÂøô‰πãÂêé, ËøõÂÖ•‰∏ã‰∏ÄËΩÆÂæ™ÁéØ</span></span>
<span class="line"><span style="color:#24292e">            tab </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#6f42c1">helpTransfer</span><span style="color:#24292e">(tab, f);</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">else</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">            V oldVal </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#005cc5">null</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#6a737d">// ÈîÅ‰ΩèÈìæË°®Â§¥ËäÇÁÇπ</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">synchronized</span><span style="color:#24292e"> (f) {</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#6a737d">// ÂÜçÊ¨°Á°ÆËÆ§ÈìæË°®Â§¥ËäÇÁÇπÊ≤°ÊúâË¢´ÁßªÂä®</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (</span><span style="color:#6f42c1">tabAt</span><span style="color:#24292e">(tab, i) </span><span style="color:#d73a49">==</span><span style="color:#24292e"> f) {</span></span>
<span class="line"><span style="color:#24292e">                    </span><span style="color:#6a737d">// ÈìæË°®</span></span>
<span class="line"><span style="color:#24292e">                    </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (fh </span><span style="color:#d73a49">&gt;=</span><span style="color:#24292e"> </span><span style="color:#005cc5">0</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">                        binCount </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#005cc5">1</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">                        </span><span style="color:#6a737d">// ÈÅçÂéÜÈìæË°®</span></span>
<span class="line"><span style="color:#24292e">                        </span><span style="color:#d73a49">for</span><span style="color:#24292e"> (Node&lt;</span><span style="color:#d73a49">K</span><span style="color:#24292e">,</span><span style="color:#d73a49">V</span><span style="color:#24292e">&gt; e </span><span style="color:#d73a49">=</span><span style="color:#24292e"> f;; </span><span style="color:#d73a49">++</span><span style="color:#24292e">binCount) {</span></span>
<span class="line"><span style="color:#24292e">                            K ek;</span></span>
<span class="line"><span style="color:#24292e">                            </span><span style="color:#6a737d">// ÊâæÂà∞Áõ∏ÂêåÁöÑ key</span></span>
<span class="line"><span style="color:#24292e">                            </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (e.hash </span><span style="color:#d73a49">==</span><span style="color:#24292e"> hash </span><span style="color:#d73a49">&amp;&amp;</span></span>
<span class="line"><span style="color:#24292e">                                ((ek </span><span style="color:#d73a49">=</span><span style="color:#24292e"> e.key) </span><span style="color:#d73a49">==</span><span style="color:#24292e"> key </span><span style="color:#d73a49">||</span></span>
<span class="line"><span style="color:#24292e">                                 (ek </span><span style="color:#d73a49">!=</span><span style="color:#24292e"> </span><span style="color:#005cc5">null</span><span style="color:#24292e"> </span><span style="color:#d73a49">&amp;&amp;</span><span style="color:#24292e"> key.</span><span style="color:#6f42c1">equals</span><span style="color:#24292e">(ek)))) {</span></span>
<span class="line"><span style="color:#24292e">                                oldVal </span><span style="color:#d73a49">=</span><span style="color:#24292e"> e.val;</span></span>
<span class="line"><span style="color:#24292e">                                </span><span style="color:#6a737d">// Êõ¥Êñ∞</span></span>
<span class="line"><span style="color:#24292e">                                </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (</span><span style="color:#d73a49">!</span><span style="color:#24292e">onlyIfAbsent)</span></span>
<span class="line"><span style="color:#24292e">                                    </span><span style="color:#6a737d">//Êñ∞ÂÄºË¶ÜÁõñÊóßÂÄº</span></span>
<span class="line"><span style="color:#24292e">                                     e.val </span><span style="color:#d73a49">=</span><span style="color:#24292e"> value;</span></span>
<span class="line"><span style="color:#24292e">                                </span><span style="color:#d73a49">break</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">                            }</span></span>
<span class="line"><span style="color:#24292e">                            Node&lt;</span><span style="color:#d73a49">K</span><span style="color:#24292e">,</span><span style="color:#d73a49">V</span><span style="color:#24292e">&gt; pred </span><span style="color:#d73a49">=</span><span style="color:#24292e"> e;</span></span>
<span class="line"><span style="color:#24292e">                            </span></span>
<span class="line"><span style="color:#24292e">                            </span><span style="color:#6a737d">// Â∑≤ÁªèÊòØÊúÄÂêéÁöÑËäÇÁÇπ‰∫Ü, Êñ∞Â¢û Node, ËøΩÂä†Ëá≥ÈìæË°®Â∞æ</span></span>
<span class="line"><span style="color:#24292e">                            </span><span style="color:#d73a49">if</span><span style="color:#24292e"> ((e </span><span style="color:#d73a49">=</span><span style="color:#24292e"> e.next) </span><span style="color:#d73a49">==</span><span style="color:#24292e"> </span><span style="color:#005cc5">null</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">                                pred.next </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> Node&lt;</span><span style="color:#d73a49">K</span><span style="color:#24292e">,</span><span style="color:#d73a49">V</span><span style="color:#24292e">&gt;(hash, key,</span></span>
<span class="line"><span style="color:#24292e">                                value, </span><span style="color:#005cc5">null</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">                                </span><span style="color:#d73a49">break</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">                            }</span></span>
<span class="line"><span style="color:#24292e">                        }</span></span>
<span class="line"><span style="color:#24292e">                    }</span></span>
<span class="line"><span style="color:#24292e">                    </span><span style="color:#6a737d">// Á∫¢ÈªëÊ†ë</span></span>
<span class="line"><span style="color:#24292e">                    </span><span style="color:#d73a49">else</span><span style="color:#24292e"> </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (f </span><span style="color:#d73a49">instanceof</span><span style="color:#24292e"> TreeBin) {</span></span>
<span class="line"><span style="color:#24292e">                        Node&lt;</span><span style="color:#d73a49">K</span><span style="color:#24292e">,</span><span style="color:#d73a49">V</span><span style="color:#24292e">&gt; p;</span></span>
<span class="line"><span style="color:#24292e">                        binCount </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#005cc5">2</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">                        </span><span style="color:#6a737d">// putTreeVal ‰ºöÁúã key ÊòØÂê¶Â∑≤ÁªèÂú®Ê†ë‰∏≠, ÊòØ, ÂàôËøîÂõûÂØπÂ∫îÁöÑ TreeNode</span></span>
<span class="line"><span style="color:#24292e">                        </span><span style="color:#d73a49">if</span><span style="color:#24292e"> ((p </span><span style="color:#d73a49">=</span><span style="color:#24292e"> ((TreeBin</span><span style="color:#d73a49">&lt;</span><span style="color:#24292e">K,V</span><span style="color:#d73a49">&gt;</span><span style="color:#24292e">)f).</span><span style="color:#6f42c1">putTreeVal</span><span style="color:#24292e">(hash, key,</span></span>
<span class="line"><span style="color:#24292e">                                    value)) </span><span style="color:#d73a49">!=</span><span style="color:#24292e"> </span><span style="color:#005cc5">null</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">                            oldVal </span><span style="color:#d73a49">=</span><span style="color:#24292e"> p.val;</span></span>
<span class="line"><span style="color:#24292e">                            </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (</span><span style="color:#d73a49">!</span><span style="color:#24292e">onlyIfAbsent)</span></span>
<span class="line"><span style="color:#24292e">                                p.val </span><span style="color:#d73a49">=</span><span style="color:#24292e"> value;</span></span>
<span class="line"><span style="color:#24292e">                		}</span></span>
<span class="line"><span style="color:#24292e">                	}</span></span>
<span class="line"><span style="color:#24292e">            	}</span></span>
<span class="line"><span style="color:#24292e">           </span><span style="color:#6a737d">// ÈáäÊîæÈìæË°®Â§¥ËäÇÁÇπÁöÑÈîÅ</span></span>
<span class="line"><span style="color:#24292e">           }</span></span>
<span class="line"><span style="color:#24292e">           </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (binCount </span><span style="color:#d73a49">!=</span><span style="color:#24292e"> </span><span style="color:#005cc5">0</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (binCount </span><span style="color:#d73a49">&gt;=</span><span style="color:#24292e"> TREEIFY_THRESHOLD)</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#6a737d">// Â¶ÇÊûúÈìæË°®ÈïøÂ∫¶ &gt;= Ê†ëÂåñÈòàÂÄº(8), ËøõË°åÈìæË°®ËΩ¨‰∏∫Á∫¢ÈªëÊ†ë</span></span>
<span class="line"><span style="color:#24292e">                	</span><span style="color:#6f42c1">treeifyBin</span><span style="color:#24292e">(tab, i);</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (oldVal </span><span style="color:#d73a49">!=</span><span style="color:#24292e"> </span><span style="color:#005cc5">null</span><span style="color:#24292e">)</span></span>
<span class="line"><span style="color:#24292e">                	</span><span style="color:#d73a49">return</span><span style="color:#24292e"> oldVal;</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#d73a49">break</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">            }</span></span>
<span class="line"><span style="color:#24292e">       	}</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">// Â¢ûÂä† size ËÆ°Êï∞</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6f42c1">addCount</span><span style="color:#24292e">(</span><span style="color:#005cc5">1L</span><span style="color:#24292e">, binCount);</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">return</span><span style="color:#24292e"> </span><span style="color:#005cc5">null</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">}</span></span>
<span class="line"><span style="color:#d73a49">private</span><span style="color:#24292e"> </span><span style="color:#d73a49">final</span><span style="color:#24292e"> Node</span><span style="color:#d73a49">&lt;</span><span style="color:#24292e">K,V</span><span style="color:#d73a49">&gt;</span><span style="color:#24292e">[] </span><span style="color:#6f42c1">initTable</span><span style="color:#24292e">() {</span></span>
<span class="line"><span style="color:#24292e">    Node&lt;</span><span style="color:#d73a49">K</span><span style="color:#24292e">,</span><span style="color:#d73a49">V</span><span style="color:#24292e">&gt;[] tab; </span><span style="color:#d73a49">int</span><span style="color:#24292e"> sc;</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">while</span><span style="color:#24292e"> ((tab </span><span style="color:#d73a49">=</span><span style="color:#24292e"> table) </span><span style="color:#d73a49">==</span><span style="color:#24292e"> </span><span style="color:#005cc5">null</span><span style="color:#24292e"> </span><span style="color:#d73a49">||</span><span style="color:#24292e"> tab.length </span><span style="color:#d73a49">==</span><span style="color:#24292e"> </span><span style="color:#005cc5">0</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">if</span><span style="color:#24292e"> ((sc </span><span style="color:#d73a49">=</span><span style="color:#24292e"> sizeCtl) </span><span style="color:#d73a49">&lt;</span><span style="color:#24292e"> </span><span style="color:#005cc5">0</span><span style="color:#24292e">)</span></span>
<span class="line"><span style="color:#24292e">        	Thread.</span><span style="color:#6f42c1">yield</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6a737d">// Â∞ùËØïÂ∞Ü sizeCtl ËÆæÁΩÆ‰∏∫ -1ÔºàË°®Á§∫ÂàùÂßãÂåñ tableÔºâ</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">else</span><span style="color:#24292e"> </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (U.</span><span style="color:#6f42c1">compareAndSwapInt</span><span style="color:#24292e">(</span><span style="color:#005cc5">this</span><span style="color:#24292e">, SIZECTL, sc, </span><span style="color:#d73a49">-</span><span style="color:#005cc5">1</span><span style="color:#24292e">)) {</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#6a737d">// Ëé∑ÂæóÈîÅ, ÂàõÂª∫ table, ËøôÊó∂ÂÖ∂ÂÆÉÁ∫øÁ®ã‰ºöÂú® while() Âæ™ÁéØ‰∏≠ yield Áõ¥Ëá≥ table ÂàõÂª∫</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">try</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#d73a49">if</span><span style="color:#24292e"> ((tab </span><span style="color:#d73a49">=</span><span style="color:#24292e"> table) </span><span style="color:#d73a49">==</span><span style="color:#24292e"> </span><span style="color:#005cc5">null</span><span style="color:#24292e"> </span><span style="color:#d73a49">||</span><span style="color:#24292e"> tab.length </span><span style="color:#d73a49">==</span><span style="color:#24292e"> </span><span style="color:#005cc5">0</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">                    </span><span style="color:#d73a49">int</span><span style="color:#24292e"> n </span><span style="color:#d73a49">=</span><span style="color:#24292e"> (sc </span><span style="color:#d73a49">&gt;</span><span style="color:#24292e"> </span><span style="color:#005cc5">0</span><span style="color:#24292e">) </span><span style="color:#d73a49">?</span><span style="color:#24292e"> sc </span><span style="color:#d73a49">:</span><span style="color:#24292e"> DEFAULT_CAPACITY;</span></span>
<span class="line"><span style="color:#24292e">                    Node&lt;</span><span style="color:#d73a49">K</span><span style="color:#24292e">,</span><span style="color:#d73a49">V</span><span style="color:#24292e">&gt;[] nt </span><span style="color:#d73a49">=</span><span style="color:#24292e"> (Node</span><span style="color:#d73a49">&lt;</span><span style="color:#24292e">K,V</span><span style="color:#d73a49">&gt;</span><span style="color:#24292e">[])</span><span style="color:#d73a49">new</span><span style="color:#24292e"> Node&lt;</span><span style="color:#d73a49">?</span><span style="color:#24292e">,</span><span style="color:#d73a49">?</span><span style="color:#24292e">&gt;[n];</span></span>
<span class="line"><span style="color:#24292e">                    table </span><span style="color:#d73a49">=</span><span style="color:#24292e"> tab </span><span style="color:#d73a49">=</span><span style="color:#24292e"> nt;</span></span>
<span class="line"><span style="color:#24292e">                    sc </span><span style="color:#d73a49">=</span><span style="color:#24292e"> n </span><span style="color:#d73a49">-</span><span style="color:#24292e"> (n </span><span style="color:#d73a49">&gt;&gt;&gt;</span><span style="color:#24292e"> </span><span style="color:#005cc5">2</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">                }</span></span>
<span class="line"><span style="color:#24292e">            } </span><span style="color:#d73a49">finally</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">                sizeCtl </span><span style="color:#d73a49">=</span><span style="color:#24292e"> sc;</span></span>
<span class="line"><span style="color:#24292e">            }</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">break</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">        }</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">return</span><span style="color:#24292e"> tab;</span></span>
<span class="line"><span style="color:#24292e">}</span></span>
<span class="line"><span style="color:#6a737d">// check ÊòØ‰πãÂâç binCount ÁöÑ‰∏™Êï∞</span></span>
<span class="line"><span style="color:#d73a49">private</span><span style="color:#24292e"> </span><span style="color:#d73a49">final</span><span style="color:#24292e"> </span><span style="color:#d73a49">void</span><span style="color:#24292e"> </span><span style="color:#6f42c1">addCount</span><span style="color:#24292e">(</span><span style="color:#d73a49">long</span><span style="color:#24292e"> x, </span><span style="color:#d73a49">int</span><span style="color:#24292e"> check) {</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">CounterCell</span><span style="color:#24292e">[] as; </span><span style="color:#d73a49">long</span><span style="color:#24292e"> b, s;</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6a737d">// Â∑≤ÁªèÊúâ‰∫Ü counterCells, Âêë cell Á¥ØÂä†</span></span>
<span class="line"><span style="color:#24292e">        (as </span><span style="color:#d73a49">=</span><span style="color:#24292e"> counterCells) </span><span style="color:#d73a49">!=</span><span style="color:#24292e"> </span><span style="color:#005cc5">null</span><span style="color:#24292e"> </span><span style="color:#d73a49">||</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6a737d">// ËøòÊ≤°Êúâ, Âêë baseCount Á¥ØÂä†</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">!</span><span style="color:#24292e">U.</span><span style="color:#6f42c1">compareAndSwapLong</span><span style="color:#24292e">(</span><span style="color:#005cc5">this</span><span style="color:#24292e">, BASECOUNT, b </span><span style="color:#d73a49">=</span><span style="color:#24292e"> baseCount, s </span><span style="color:#d73a49">=</span><span style="color:#24292e"> b </span><span style="color:#d73a49">+</span><span style="color:#24292e"> x)</span></span>
<span class="line"><span style="color:#24292e">    ) {</span></span>
<span class="line"><span style="color:#24292e">        CounterCell a; </span><span style="color:#d73a49">long</span><span style="color:#24292e"> v; </span><span style="color:#d73a49">int</span><span style="color:#24292e"> m;</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">boolean</span><span style="color:#24292e"> uncontended </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#005cc5">true</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#6a737d">// ËøòÊ≤°Êúâ counterCells</span></span>
<span class="line"><span style="color:#24292e">            as </span><span style="color:#d73a49">==</span><span style="color:#24292e"> </span><span style="color:#005cc5">null</span><span style="color:#24292e"> </span><span style="color:#d73a49">||</span><span style="color:#24292e"> (m </span><span style="color:#d73a49">=</span><span style="color:#24292e"> as.length </span><span style="color:#d73a49">-</span><span style="color:#24292e"> </span><span style="color:#005cc5">1</span><span style="color:#24292e">) </span><span style="color:#d73a49">&lt;</span><span style="color:#24292e"> </span><span style="color:#005cc5">0</span><span style="color:#24292e"> </span><span style="color:#d73a49">||</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#6a737d">// ËøòÊ≤°Êúâ cell</span></span>
<span class="line"><span style="color:#24292e">            (a </span><span style="color:#d73a49">=</span><span style="color:#24292e"> as[ThreadLocalRandom.</span><span style="color:#6f42c1">getProbe</span><span style="color:#24292e">() </span><span style="color:#d73a49">&amp;</span><span style="color:#24292e"> m]) </span><span style="color:#d73a49">==</span><span style="color:#24292e"> </span><span style="color:#005cc5">null</span><span style="color:#24292e"> </span><span style="color:#d73a49">||</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#6a737d">// cell cas Â¢ûÂä†ËÆ°Êï∞Â§±Ë¥•</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">!</span><span style="color:#24292e">(uncontended </span><span style="color:#d73a49">=</span><span style="color:#24292e"> U.</span><span style="color:#6f42c1">compareAndSwapLong</span><span style="color:#24292e">(a, CELLVALUE, v </span><span style="color:#d73a49">=</span><span style="color:#24292e"> a.value, v </span><span style="color:#d73a49">+</span><span style="color:#24292e"> x))</span></span>
<span class="line"><span style="color:#24292e">        	) {</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#6a737d">// ÂàõÂª∫Á¥ØÂä†ÂçïÂÖÉÊï∞ÁªÑÂíåcell, Á¥ØÂä†ÈáçËØï</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#6f42c1">fullAddCount</span><span style="color:#24292e">(x, uncontended);</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">return</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">        }</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (check </span><span style="color:#d73a49">&lt;=</span><span style="color:#24292e"> </span><span style="color:#005cc5">1</span><span style="color:#24292e">)</span></span>
<span class="line"><span style="color:#24292e">        	</span><span style="color:#d73a49">return</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6a737d">// Ëé∑ÂèñÂÖÉÁ¥†‰∏™Êï∞</span></span>
<span class="line"><span style="color:#24292e">        s </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#6f42c1">sumCount</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (check </span><span style="color:#d73a49">&gt;=</span><span style="color:#24292e"> </span><span style="color:#005cc5">0</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">    Node&lt;</span><span style="color:#d73a49">K</span><span style="color:#24292e">,</span><span style="color:#d73a49">V</span><span style="color:#24292e">&gt;[] tab, nt; </span><span style="color:#d73a49">int</span><span style="color:#24292e"> n, sc;</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">while</span><span style="color:#24292e"> (s </span><span style="color:#d73a49">&gt;=</span><span style="color:#24292e"> (</span><span style="color:#d73a49">long</span><span style="color:#24292e">)(sc </span><span style="color:#d73a49">=</span><span style="color:#24292e"> sizeCtl) </span><span style="color:#d73a49">&amp;&amp;</span><span style="color:#24292e"> (tab </span><span style="color:#d73a49">=</span><span style="color:#24292e"> table) </span><span style="color:#d73a49">!=</span><span style="color:#24292e"> </span><span style="color:#005cc5">null</span><span style="color:#24292e"> </span><span style="color:#d73a49">&amp;&amp;</span></span>
<span class="line"><span style="color:#24292e">           (n </span><span style="color:#d73a49">=</span><span style="color:#24292e"> tab.length) </span><span style="color:#d73a49">&lt;</span><span style="color:#24292e"> MAXIMUM_CAPACITY) {</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">int</span><span style="color:#24292e"> rs </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#6f42c1">resizeStamp</span><span style="color:#24292e">(n);</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (sc </span><span style="color:#d73a49">&lt;</span><span style="color:#24292e"> </span><span style="color:#005cc5">0</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">if</span><span style="color:#24292e"> ((sc </span><span style="color:#d73a49">&gt;&gt;&gt;</span><span style="color:#24292e"> RESIZE_STAMP_SHIFT) </span><span style="color:#d73a49">!=</span><span style="color:#24292e"> rs </span><span style="color:#d73a49">||</span><span style="color:#24292e"> sc </span><span style="color:#d73a49">==</span><span style="color:#24292e"> rs </span><span style="color:#d73a49">+</span><span style="color:#24292e"> </span><span style="color:#005cc5">1</span><span style="color:#24292e"> </span><span style="color:#d73a49">||</span></span>
<span class="line"><span style="color:#24292e">                sc </span><span style="color:#d73a49">==</span><span style="color:#24292e"> rs </span><span style="color:#d73a49">+</span><span style="color:#24292e"> MAX_RESIZERS </span><span style="color:#d73a49">||</span><span style="color:#24292e"> (nt </span><span style="color:#d73a49">=</span><span style="color:#24292e"> nextTable) </span><span style="color:#d73a49">==</span><span style="color:#24292e"> </span><span style="color:#005cc5">null</span><span style="color:#24292e"> </span><span style="color:#d73a49">||</span></span>
<span class="line"><span style="color:#24292e">                transferIndex </span><span style="color:#d73a49">&lt;=</span><span style="color:#24292e"> </span><span style="color:#005cc5">0</span><span style="color:#24292e">)</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#d73a49">break</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#6a737d">// newtable Â∑≤ÁªèÂàõÂª∫‰∫ÜÔºåÂ∏ÆÂøôÊâ©ÂÆπ</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (U.</span><span style="color:#6f42c1">compareAndSwapInt</span><span style="color:#24292e">(</span><span style="color:#005cc5">this</span><span style="color:#24292e">, SIZECTL, sc, sc </span><span style="color:#d73a49">+</span><span style="color:#24292e"> </span><span style="color:#005cc5">1</span><span style="color:#24292e">))</span></span>
<span class="line"><span style="color:#24292e">            	</span><span style="color:#6f42c1">transfer</span><span style="color:#24292e">(tab, nt);</span></span>
<span class="line"><span style="color:#24292e">            }</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#6a737d">// ÈúÄË¶ÅÊâ©ÂÆπÔºåËøôÊó∂ newtable Êú™ÂàõÂª∫</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">else</span><span style="color:#24292e"> </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (U.</span><span style="color:#6f42c1">compareAndSwapInt</span><span style="color:#24292e">(</span><span style="color:#005cc5">this</span><span style="color:#24292e">, SIZECTL, sc,</span></span>
<span class="line"><span style="color:#24292e">            			(rs </span><span style="color:#d73a49">&lt;&lt;</span><span style="color:#24292e"> RESIZE_STAMP_SHIFT) </span><span style="color:#d73a49">+</span><span style="color:#24292e"> </span><span style="color:#005cc5">2</span><span style="color:#24292e">))</span></span>
<span class="line"><span style="color:#24292e">            	</span><span style="color:#6f42c1">transfer</span><span style="color:#24292e">(tab, </span><span style="color:#005cc5">null</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">            s </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#6f42c1">sumCount</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">        }</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"><span style="color:#24292e">}</span></span></code></pre></div><h6 id="size-ËÆ°ÁÆóÊµÅÁ®ã" tabindex="-1">size ËÆ°ÁÆóÊµÅÁ®ã <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20advanced%20chapter#size-ËÆ°ÁÆóÊµÅÁ®ã" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h6><p>size ËÆ°ÁÆóÂÆûÈôÖÂèëÁîüÂú® putÔºåremove ÊîπÂèòÈõÜÂêàÂÖÉÁ¥†ÁöÑÊìç‰Ωú‰πã‰∏≠</p><ul><li>Ê≤°ÊúâÁ´û‰∫âÂèëÁîüÔºåÂêë baseCount Á¥ØÂä†ËÆ°Êï∞</li><li>ÊúâÁ´û‰∫âÂèëÁîüÔºåÊñ∞Âª∫ counterCellsÔºåÂêëÂÖ∂‰∏≠ÁöÑ‰∏Ä‰∏™ cell Á¥ØÂä†ËÆ°Êï∞<ul><li>counterCells ÂàùÂßãÊúâ‰∏§‰∏™ cell</li><li>Â¶ÇÊûúËÆ°Êï∞Á´û‰∫âÊØîËæÉÊøÄÁÉàÔºå‰ºöÂàõÂª∫Êñ∞ÁöÑ cell Êù•Á¥ØÂä†ËÆ°Êï∞</li></ul></li></ul><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">size</span><span style="color:#e1e4e8">() {</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">long</span><span style="color:#e1e4e8"> n </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">sumCount</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> ((n </span><span style="color:#f97583">&lt;</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">0L</span><span style="color:#e1e4e8">) </span><span style="color:#f97583">?</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">:</span></span>
<span class="line"><span style="color:#e1e4e8">            (n </span><span style="color:#f97583">&gt;</span><span style="color:#e1e4e8"> (</span><span style="color:#f97583">long</span><span style="color:#e1e4e8">)Integer.MAX_VALUE) </span><span style="color:#f97583">?</span><span style="color:#e1e4e8"> Integer.MAX_VALUE </span><span style="color:#f97583">:</span></span>
<span class="line"><span style="color:#e1e4e8">            (</span><span style="color:#f97583">int</span><span style="color:#e1e4e8">)n);</span></span>
<span class="line"><span style="color:#e1e4e8">}</span></span>
<span class="line"><span style="color:#f97583">final</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">long</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">sumCount</span><span style="color:#e1e4e8">() {</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">CounterCell</span><span style="color:#e1e4e8">[] as </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> counterCells; CounterCell a;</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">// Â∞Ü baseCount ËÆ°Êï∞‰∏éÊâÄÊúâ cell ËÆ°Êï∞Á¥ØÂä†</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">long</span><span style="color:#e1e4e8"> sum </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> baseCount;</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (as </span><span style="color:#f97583">!=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">for</span><span style="color:#e1e4e8"> (</span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> i </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8">; i </span><span style="color:#f97583">&lt;</span><span style="color:#e1e4e8"> as.length; </span><span style="color:#f97583">++</span><span style="color:#e1e4e8">i) {</span></span>
<span class="line"><span style="color:#e1e4e8">        	</span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> ((a </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> as[i]) </span><span style="color:#f97583">!=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8">)</span></span>
<span class="line"><span style="color:#e1e4e8">        		sum </span><span style="color:#f97583">+=</span><span style="color:#e1e4e8"> a.value;</span></span>
<span class="line"><span style="color:#e1e4e8">        }</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> sum;</span></span>
<span class="line"><span style="color:#e1e4e8">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">int</span><span style="color:#24292e"> </span><span style="color:#6f42c1">size</span><span style="color:#24292e">() {</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">long</span><span style="color:#24292e"> n </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#6f42c1">sumCount</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">return</span><span style="color:#24292e"> ((n </span><span style="color:#d73a49">&lt;</span><span style="color:#24292e"> </span><span style="color:#005cc5">0L</span><span style="color:#24292e">) </span><span style="color:#d73a49">?</span><span style="color:#24292e"> </span><span style="color:#005cc5">0</span><span style="color:#24292e"> </span><span style="color:#d73a49">:</span></span>
<span class="line"><span style="color:#24292e">            (n </span><span style="color:#d73a49">&gt;</span><span style="color:#24292e"> (</span><span style="color:#d73a49">long</span><span style="color:#24292e">)Integer.MAX_VALUE) </span><span style="color:#d73a49">?</span><span style="color:#24292e"> Integer.MAX_VALUE </span><span style="color:#d73a49">:</span></span>
<span class="line"><span style="color:#24292e">            (</span><span style="color:#d73a49">int</span><span style="color:#24292e">)n);</span></span>
<span class="line"><span style="color:#24292e">}</span></span>
<span class="line"><span style="color:#d73a49">final</span><span style="color:#24292e"> </span><span style="color:#d73a49">long</span><span style="color:#24292e"> </span><span style="color:#6f42c1">sumCount</span><span style="color:#24292e">() {</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">CounterCell</span><span style="color:#24292e">[] as </span><span style="color:#d73a49">=</span><span style="color:#24292e"> counterCells; CounterCell a;</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">// Â∞Ü baseCount ËÆ°Êï∞‰∏éÊâÄÊúâ cell ËÆ°Êï∞Á¥ØÂä†</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">long</span><span style="color:#24292e"> sum </span><span style="color:#d73a49">=</span><span style="color:#24292e"> baseCount;</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (as </span><span style="color:#d73a49">!=</span><span style="color:#24292e"> </span><span style="color:#005cc5">null</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">for</span><span style="color:#24292e"> (</span><span style="color:#d73a49">int</span><span style="color:#24292e"> i </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#005cc5">0</span><span style="color:#24292e">; i </span><span style="color:#d73a49">&lt;</span><span style="color:#24292e"> as.length; </span><span style="color:#d73a49">++</span><span style="color:#24292e">i) {</span></span>
<span class="line"><span style="color:#24292e">        	</span><span style="color:#d73a49">if</span><span style="color:#24292e"> ((a </span><span style="color:#d73a49">=</span><span style="color:#24292e"> as[i]) </span><span style="color:#d73a49">!=</span><span style="color:#24292e"> </span><span style="color:#005cc5">null</span><span style="color:#24292e">)</span></span>
<span class="line"><span style="color:#24292e">        		sum </span><span style="color:#d73a49">+=</span><span style="color:#24292e"> a.value;</span></span>
<span class="line"><span style="color:#24292e">        }</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">return</span><span style="color:#24292e"> sum;</span></span>
<span class="line"><span style="color:#24292e">}</span></span></code></pre></div><h6 id="Êâ©ÂÆπ" tabindex="-1">Êâ©ÂÆπ <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20advanced%20chapter#Êâ©ÂÆπ" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h6><blockquote><p>‰º†ÂÖ•ÂéüÂßãÁöÑtableÂíåÊñ∞ÁöÑtableÔºåÊñ∞ÁöÑtable‰πüÊòØÊáíÊÉ∞ÂàùÂßãÂåñÔºå‰∏ÄÂºÄÂßã‰∏∫nullÔºåËøôÊó∂Â∞±‰ºöÊääÂÆÉÂàõÂª∫Âá∫Êù•ÔºåÂç≥ÊääÂéüÊúâÁöÑÂÆπÈáèÂ∑¶Áßª1‰Ωç(*2)ÔºåÊääÊñ∞ÂàõÂª∫ÁöÑÊï∞ÁªÑËµãÂÄºÁªôÊñ∞tableÔºåÂàõÂª∫ÂÆåÂêéÂ∞±‰ºö‰ªéÂéüÊù•ÁöÑtableËøõË°åËäÇÁÇπÁöÑÊê¨ËøÅÔºà‰ª•ÈìæË°®‰∏∫Âçï‰ΩçËøõË°åÁßªÂä®ÔºâÔºåÂΩìÈìæË°®Â§¥‰∏∫nullË°®Á§∫Â∑≤ÁªèÊê¨ËøÅÂÆå‰∫ÜÔºåÊ†áËÆ∞‰∏∫forwardingNodeÔºåÂΩìÊú¨Ê¨°Âæ™ÁéØÁúãÂà∞Ê≠§Ê†áËÆ∞Â∞±ËøõÂÖ•‰∏ã‰∏ÄÊ¨°Âæ™ÁéØËøÅÁßª‰∏ã‰∏Ä‰∏™ËäÇÁÇπÔºõÂΩìÈìæË°®ÊòØÊúâÂÖÉÁ¥†ÁöÑÔºåÂ∞±‰ºöÁî®synchronizedÈîÅÈîÅ‰ΩèËøô‰∏™ÈìæË°®ËøõË°åËøÅÁßªÂ§ÑÁêÜÔºåÁúãÊòØÊôÆÈÄöÈìæË°®ËäÇÁÇπËøòÊòØÊ†ëËäÇÁÇπÊù•ÂÆåÊàê‰∏çÂêåÁöÑËøÅÁßªÂ∑•‰Ωú</p></blockquote><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#f97583">private</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">final</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">void</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">transfer</span><span style="color:#e1e4e8">(Node</span><span style="color:#f97583">&lt;</span><span style="color:#e1e4e8">K,V</span><span style="color:#f97583">&gt;</span><span style="color:#e1e4e8">[] tab, Node</span><span style="color:#f97583">&lt;</span><span style="color:#e1e4e8">K,V</span><span style="color:#f97583">&gt;</span><span style="color:#e1e4e8">[] nextTab) {</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> n </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> tab.length, stride;</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> ((stride </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> (NCPU </span><span style="color:#f97583">&gt;</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">1</span><span style="color:#e1e4e8">) </span><span style="color:#f97583">?</span><span style="color:#e1e4e8"> (n </span><span style="color:#f97583">&gt;&gt;&gt;</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">3</span><span style="color:#e1e4e8">) </span><span style="color:#f97583">/</span><span style="color:#e1e4e8"> NCPU </span><span style="color:#f97583">:</span><span style="color:#e1e4e8"> n) </span><span style="color:#f97583">&lt;</span><span style="color:#e1e4e8"> MIN_TRANSFER_STRIDE)</span></span>
<span class="line"><span style="color:#e1e4e8">        stride </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> MIN_TRANSFER_STRIDE; </span><span style="color:#6a737d">// subdivide range</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (nextTab </span><span style="color:#f97583">==</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8">) {            </span><span style="color:#6a737d">// initiating</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">try</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">            @</span><span style="color:#f97583">SuppressWarnings</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"unchecked"</span><span style="color:#e1e4e8">)</span></span>
<span class="line"><span style="color:#e1e4e8">            Node&lt;</span><span style="color:#f97583">K</span><span style="color:#e1e4e8">,</span><span style="color:#f97583">V</span><span style="color:#e1e4e8">&gt;[] nt </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> (Node</span><span style="color:#f97583">&lt;</span><span style="color:#e1e4e8">K,V</span><span style="color:#f97583">&gt;</span><span style="color:#e1e4e8">[])</span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> Node&lt;</span><span style="color:#f97583">?</span><span style="color:#e1e4e8">,</span><span style="color:#f97583">?</span><span style="color:#e1e4e8">&gt;[n </span><span style="color:#f97583">&lt;&lt;</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">1</span><span style="color:#e1e4e8">];</span></span>
<span class="line"><span style="color:#e1e4e8">            nextTab </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> nt;</span></span>
<span class="line"><span style="color:#e1e4e8">        } </span><span style="color:#f97583">catch</span><span style="color:#e1e4e8"> (Throwable </span><span style="color:#ffab70">ex</span><span style="color:#e1e4e8">) {      </span><span style="color:#6a737d">// try to cope with OOME</span></span>
<span class="line"><span style="color:#e1e4e8">            sizeCtl </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> Integer.MAX_VALUE;</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">return</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">        }</span></span>
<span class="line"><span style="color:#e1e4e8">        nextTable </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> nextTab;</span></span>
<span class="line"><span style="color:#e1e4e8">        transferIndex </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> n;</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> nextn </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> nextTab.length;</span></span>
<span class="line"><span style="color:#e1e4e8">    ForwardingNode&lt;</span><span style="color:#f97583">K</span><span style="color:#e1e4e8">,</span><span style="color:#f97583">V</span><span style="color:#e1e4e8">&gt; fwd </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> ForwardingNode&lt;</span><span style="color:#f97583">K</span><span style="color:#e1e4e8">,</span><span style="color:#f97583">V</span><span style="color:#e1e4e8">&gt;(nextTab);</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">boolean</span><span style="color:#e1e4e8"> advance </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">true</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">boolean</span><span style="color:#e1e4e8"> finishing </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">false</span><span style="color:#e1e4e8">; </span><span style="color:#6a737d">// to ensure sweep before committing nextTab</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">for</span><span style="color:#e1e4e8"> (</span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> i </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8">, bound </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8">;;) {</span></span>
<span class="line"><span style="color:#e1e4e8">        Node&lt;</span><span style="color:#f97583">K</span><span style="color:#e1e4e8">,</span><span style="color:#f97583">V</span><span style="color:#e1e4e8">&gt; f; </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> fh;</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">while</span><span style="color:#e1e4e8"> (advance) {</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> nextIndex, nextBound;</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (</span><span style="color:#f97583">--</span><span style="color:#e1e4e8">i </span><span style="color:#f97583">&gt;=</span><span style="color:#e1e4e8"> bound </span><span style="color:#f97583">||</span><span style="color:#e1e4e8"> finishing)</span></span>
<span class="line"><span style="color:#e1e4e8">                advance </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">false</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">else</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> ((nextIndex </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> transferIndex) </span><span style="color:#f97583">&lt;=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">                i </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">-</span><span style="color:#79b8ff">1</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">                advance </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">false</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">            }</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">else</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (U.compareAndSwapInt</span></span>
<span class="line"><span style="color:#e1e4e8">                     (</span><span style="color:#79b8ff">this</span><span style="color:#e1e4e8">, TRANSFERINDEX, nextIndex,</span></span>
<span class="line"><span style="color:#e1e4e8">                      nextBound </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> (nextIndex </span><span style="color:#f97583">&gt;</span><span style="color:#e1e4e8"> stride </span><span style="color:#f97583">?</span></span>
<span class="line"><span style="color:#e1e4e8">                                   nextIndex </span><span style="color:#f97583">-</span><span style="color:#e1e4e8"> stride </span><span style="color:#f97583">:</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8">))) {</span></span>
<span class="line"><span style="color:#e1e4e8">                bound </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> nextBound;</span></span>
<span class="line"><span style="color:#e1e4e8">                i </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> nextIndex </span><span style="color:#f97583">-</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">1</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">                advance </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">false</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">            }</span></span>
<span class="line"><span style="color:#e1e4e8">        }</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (i </span><span style="color:#f97583">&lt;</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">||</span><span style="color:#e1e4e8"> i </span><span style="color:#f97583">&gt;=</span><span style="color:#e1e4e8"> n </span><span style="color:#f97583">||</span><span style="color:#e1e4e8"> i </span><span style="color:#f97583">+</span><span style="color:#e1e4e8"> n </span><span style="color:#f97583">&gt;=</span><span style="color:#e1e4e8"> nextn) {</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> sc;</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (finishing) {</span></span>
<span class="line"><span style="color:#e1e4e8">                nextTable </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">                table </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> nextTab;</span></span>
<span class="line"><span style="color:#e1e4e8">                sizeCtl </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> (n </span><span style="color:#f97583">&lt;&lt;</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">1</span><span style="color:#e1e4e8">) </span><span style="color:#f97583">-</span><span style="color:#e1e4e8"> (n </span><span style="color:#f97583">&gt;&gt;&gt;</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">1</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#f97583">return</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">            }</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (U.</span><span style="color:#b392f0">compareAndSwapInt</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">this</span><span style="color:#e1e4e8">, SIZECTL, sc </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> sizeCtl, sc </span><span style="color:#f97583">-</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">1</span><span style="color:#e1e4e8">)) {</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> ((sc </span><span style="color:#f97583">-</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">2</span><span style="color:#e1e4e8">) </span><span style="color:#f97583">!=</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">resizeStamp</span><span style="color:#e1e4e8">(n) </span><span style="color:#f97583">&lt;&lt;</span><span style="color:#e1e4e8"> RESIZE_STAMP_SHIFT)</span></span>
<span class="line"><span style="color:#e1e4e8">                    </span><span style="color:#f97583">return</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">                finishing </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> advance </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">true</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">                i </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> n; </span><span style="color:#6a737d">// recheck before commit</span></span>
<span class="line"><span style="color:#e1e4e8">            }</span></span>
<span class="line"><span style="color:#e1e4e8">        }</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">else</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> ((f </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">tabAt</span><span style="color:#e1e4e8">(tab, i)) </span><span style="color:#f97583">==</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8">)</span></span>
<span class="line"><span style="color:#e1e4e8">            advance </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">casTabAt</span><span style="color:#e1e4e8">(tab, i, </span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8">, fwd);</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">else</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> ((fh </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> f.hash) </span><span style="color:#f97583">==</span><span style="color:#e1e4e8"> MOVED)</span></span>
<span class="line"><span style="color:#e1e4e8">            advance </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">true</span><span style="color:#e1e4e8">; </span><span style="color:#6a737d">// already processed</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">else</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">synchronized</span><span style="color:#e1e4e8"> (f) {</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (</span><span style="color:#b392f0">tabAt</span><span style="color:#e1e4e8">(tab, i) </span><span style="color:#f97583">==</span><span style="color:#e1e4e8"> f) {</span></span>
<span class="line"><span style="color:#e1e4e8">                    Node&lt;</span><span style="color:#f97583">K</span><span style="color:#e1e4e8">,</span><span style="color:#f97583">V</span><span style="color:#e1e4e8">&gt; ln, hn;</span></span>
<span class="line"><span style="color:#e1e4e8">                    </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (fh </span><span style="color:#f97583">&gt;=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">                        </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> runBit </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> fh </span><span style="color:#f97583">&amp;</span><span style="color:#e1e4e8"> n;</span></span>
<span class="line"><span style="color:#e1e4e8">                        Node&lt;</span><span style="color:#f97583">K</span><span style="color:#e1e4e8">,</span><span style="color:#f97583">V</span><span style="color:#e1e4e8">&gt; lastRun </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> f;</span></span>
<span class="line"><span style="color:#e1e4e8">                        </span><span style="color:#f97583">for</span><span style="color:#e1e4e8"> (Node&lt;</span><span style="color:#f97583">K</span><span style="color:#e1e4e8">,</span><span style="color:#f97583">V</span><span style="color:#e1e4e8">&gt; p </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> f.next; p </span><span style="color:#f97583">!=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8">; p </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> p.next) {</span></span>
<span class="line"><span style="color:#e1e4e8">                            </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> b </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> p.hash </span><span style="color:#f97583">&amp;</span><span style="color:#e1e4e8"> n;</span></span>
<span class="line"><span style="color:#e1e4e8">                            </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (b </span><span style="color:#f97583">!=</span><span style="color:#e1e4e8"> runBit) {</span></span>
<span class="line"><span style="color:#e1e4e8">                                runBit </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> b;</span></span>
<span class="line"><span style="color:#e1e4e8">                                lastRun </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> p;</span></span>
<span class="line"><span style="color:#e1e4e8">                            }</span></span>
<span class="line"><span style="color:#e1e4e8">                        }</span></span>
<span class="line"><span style="color:#e1e4e8">                        </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (runBit </span><span style="color:#f97583">==</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">                            ln </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> lastRun;</span></span>
<span class="line"><span style="color:#e1e4e8">                            hn </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">                        }</span></span>
<span class="line"><span style="color:#e1e4e8">                        </span><span style="color:#f97583">else</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">                            hn </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> lastRun;</span></span>
<span class="line"><span style="color:#e1e4e8">                            ln </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">                        }</span></span>
<span class="line"><span style="color:#e1e4e8">                        </span><span style="color:#f97583">for</span><span style="color:#e1e4e8"> (Node&lt;</span><span style="color:#f97583">K</span><span style="color:#e1e4e8">,</span><span style="color:#f97583">V</span><span style="color:#e1e4e8">&gt; p </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> f; p </span><span style="color:#f97583">!=</span><span style="color:#e1e4e8"> lastRun; p </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> p.next) {</span></span>
<span class="line"><span style="color:#e1e4e8">                            </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> ph </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> p.hash; K pk </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> p.key; V pv </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> p.val;</span></span>
<span class="line"><span style="color:#e1e4e8">                            </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> ((ph </span><span style="color:#f97583">&amp;</span><span style="color:#e1e4e8"> n) </span><span style="color:#f97583">==</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8">)</span></span>
<span class="line"><span style="color:#e1e4e8">                                ln </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> Node&lt;</span><span style="color:#f97583">K</span><span style="color:#e1e4e8">,</span><span style="color:#f97583">V</span><span style="color:#e1e4e8">&gt;(ph, pk, pv, ln);</span></span>
<span class="line"><span style="color:#e1e4e8">                            </span><span style="color:#f97583">else</span></span>
<span class="line"><span style="color:#e1e4e8">                                hn </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> Node&lt;</span><span style="color:#f97583">K</span><span style="color:#e1e4e8">,</span><span style="color:#f97583">V</span><span style="color:#e1e4e8">&gt;(ph, pk, pv, hn);</span></span>
<span class="line"><span style="color:#e1e4e8">                        }</span></span>
<span class="line"><span style="color:#e1e4e8">                        </span><span style="color:#b392f0">setTabAt</span><span style="color:#e1e4e8">(nextTab, i, ln);</span></span>
<span class="line"><span style="color:#e1e4e8">                        </span><span style="color:#b392f0">setTabAt</span><span style="color:#e1e4e8">(nextTab, i </span><span style="color:#f97583">+</span><span style="color:#e1e4e8"> n, hn);</span></span>
<span class="line"><span style="color:#e1e4e8">                        </span><span style="color:#b392f0">setTabAt</span><span style="color:#e1e4e8">(tab, i, fwd);</span></span>
<span class="line"><span style="color:#e1e4e8">                        advance </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">true</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">                    }</span></span>
<span class="line"><span style="color:#e1e4e8">                    </span><span style="color:#f97583">else</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (f </span><span style="color:#f97583">instanceof</span><span style="color:#e1e4e8"> TreeBin) {</span></span>
<span class="line"><span style="color:#e1e4e8">                        TreeBin&lt;</span><span style="color:#f97583">K</span><span style="color:#e1e4e8">,</span><span style="color:#f97583">V</span><span style="color:#e1e4e8">&gt; t </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> (TreeBin</span><span style="color:#f97583">&lt;</span><span style="color:#e1e4e8">K,V</span><span style="color:#f97583">&gt;</span><span style="color:#e1e4e8">)f;</span></span>
<span class="line"><span style="color:#e1e4e8">                        TreeNode&lt;</span><span style="color:#f97583">K</span><span style="color:#e1e4e8">,</span><span style="color:#f97583">V</span><span style="color:#e1e4e8">&gt; lo </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8">, loTail </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">                        TreeNode&lt;</span><span style="color:#f97583">K</span><span style="color:#e1e4e8">,</span><span style="color:#f97583">V</span><span style="color:#e1e4e8">&gt; hi </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8">, hiTail </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">                        </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> lc </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8">, hc </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">                        </span><span style="color:#f97583">for</span><span style="color:#e1e4e8"> (Node&lt;</span><span style="color:#f97583">K</span><span style="color:#e1e4e8">,</span><span style="color:#f97583">V</span><span style="color:#e1e4e8">&gt; e </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> t.first; e </span><span style="color:#f97583">!=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8">; e </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> e.next) {</span></span>
<span class="line"><span style="color:#e1e4e8">                            </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> h </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> e.hash;</span></span>
<span class="line"><span style="color:#e1e4e8">                            TreeNode&lt;</span><span style="color:#f97583">K</span><span style="color:#e1e4e8">,</span><span style="color:#f97583">V</span><span style="color:#e1e4e8">&gt; p </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> TreeNode&lt;</span><span style="color:#f97583">K</span><span style="color:#e1e4e8">,</span><span style="color:#f97583">V</span><span style="color:#e1e4e8">&gt;</span></span>
<span class="line"><span style="color:#e1e4e8">                                (h, e.key, e.val, </span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8">, </span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">                            </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> ((h </span><span style="color:#f97583">&amp;</span><span style="color:#e1e4e8"> n) </span><span style="color:#f97583">==</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">                                </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> ((p.prev </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> loTail) </span><span style="color:#f97583">==</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8">)</span></span>
<span class="line"><span style="color:#e1e4e8">                                    lo </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> p;</span></span>
<span class="line"><span style="color:#e1e4e8">                                </span><span style="color:#f97583">else</span></span>
<span class="line"><span style="color:#e1e4e8">                                    loTail.next </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> p;</span></span>
<span class="line"><span style="color:#e1e4e8">                                loTail </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> p;</span></span>
<span class="line"><span style="color:#e1e4e8">                                </span><span style="color:#f97583">++</span><span style="color:#e1e4e8">lc;</span></span>
<span class="line"><span style="color:#e1e4e8">                            }</span></span>
<span class="line"><span style="color:#e1e4e8">                            </span><span style="color:#f97583">else</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">                                </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> ((p.prev </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> hiTail) </span><span style="color:#f97583">==</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8">)</span></span>
<span class="line"><span style="color:#e1e4e8">                                    hi </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> p;</span></span>
<span class="line"><span style="color:#e1e4e8">                                </span><span style="color:#f97583">else</span></span>
<span class="line"><span style="color:#e1e4e8">                                    hiTail.next </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> p;</span></span>
<span class="line"><span style="color:#e1e4e8">                                hiTail </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> p;</span></span>
<span class="line"><span style="color:#e1e4e8">                                </span><span style="color:#f97583">++</span><span style="color:#e1e4e8">hc;</span></span>
<span class="line"><span style="color:#e1e4e8">                            }</span></span>
<span class="line"><span style="color:#e1e4e8">                        }</span></span>
<span class="line"><span style="color:#e1e4e8">                        ln </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> (lc </span><span style="color:#f97583">&lt;=</span><span style="color:#e1e4e8"> UNTREEIFY_THRESHOLD) </span><span style="color:#f97583">?</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">untreeify</span><span style="color:#e1e4e8">(lo) </span><span style="color:#f97583">:</span></span>
<span class="line"><span style="color:#e1e4e8">                            (hc </span><span style="color:#f97583">!=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8">) </span><span style="color:#f97583">?</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> TreeBin&lt;</span><span style="color:#f97583">K</span><span style="color:#e1e4e8">,</span><span style="color:#f97583">V</span><span style="color:#e1e4e8">&gt;(lo) </span><span style="color:#f97583">:</span><span style="color:#e1e4e8"> t;</span></span>
<span class="line"><span style="color:#e1e4e8">                        hn </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> (hc </span><span style="color:#f97583">&lt;=</span><span style="color:#e1e4e8"> UNTREEIFY_THRESHOLD) </span><span style="color:#f97583">?</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">untreeify</span><span style="color:#e1e4e8">(hi) </span><span style="color:#f97583">:</span></span>
<span class="line"><span style="color:#e1e4e8">                            (lc </span><span style="color:#f97583">!=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8">) </span><span style="color:#f97583">?</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> TreeBin&lt;</span><span style="color:#f97583">K</span><span style="color:#e1e4e8">,</span><span style="color:#f97583">V</span><span style="color:#e1e4e8">&gt;(hi) </span><span style="color:#f97583">:</span><span style="color:#e1e4e8"> t;</span></span>
<span class="line"><span style="color:#e1e4e8">                        </span><span style="color:#b392f0">setTabAt</span><span style="color:#e1e4e8">(nextTab, i, ln);</span></span>
<span class="line"><span style="color:#e1e4e8">                        </span><span style="color:#b392f0">setTabAt</span><span style="color:#e1e4e8">(nextTab, i </span><span style="color:#f97583">+</span><span style="color:#e1e4e8"> n, hn);</span></span>
<span class="line"><span style="color:#e1e4e8">                        </span><span style="color:#b392f0">setTabAt</span><span style="color:#e1e4e8">(tab, i, fwd);</span></span>
<span class="line"><span style="color:#e1e4e8">                        advance </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">true</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">                    }</span></span>
<span class="line"><span style="color:#e1e4e8">                }</span></span>
<span class="line"><span style="color:#e1e4e8">            }</span></span>
<span class="line"><span style="color:#e1e4e8">        }</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"><span style="color:#e1e4e8">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#d73a49">private</span><span style="color:#24292e"> </span><span style="color:#d73a49">final</span><span style="color:#24292e"> </span><span style="color:#d73a49">void</span><span style="color:#24292e"> </span><span style="color:#6f42c1">transfer</span><span style="color:#24292e">(Node</span><span style="color:#d73a49">&lt;</span><span style="color:#24292e">K,V</span><span style="color:#d73a49">&gt;</span><span style="color:#24292e">[] tab, Node</span><span style="color:#d73a49">&lt;</span><span style="color:#24292e">K,V</span><span style="color:#d73a49">&gt;</span><span style="color:#24292e">[] nextTab) {</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">int</span><span style="color:#24292e"> n </span><span style="color:#d73a49">=</span><span style="color:#24292e"> tab.length, stride;</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">if</span><span style="color:#24292e"> ((stride </span><span style="color:#d73a49">=</span><span style="color:#24292e"> (NCPU </span><span style="color:#d73a49">&gt;</span><span style="color:#24292e"> </span><span style="color:#005cc5">1</span><span style="color:#24292e">) </span><span style="color:#d73a49">?</span><span style="color:#24292e"> (n </span><span style="color:#d73a49">&gt;&gt;&gt;</span><span style="color:#24292e"> </span><span style="color:#005cc5">3</span><span style="color:#24292e">) </span><span style="color:#d73a49">/</span><span style="color:#24292e"> NCPU </span><span style="color:#d73a49">:</span><span style="color:#24292e"> n) </span><span style="color:#d73a49">&lt;</span><span style="color:#24292e"> MIN_TRANSFER_STRIDE)</span></span>
<span class="line"><span style="color:#24292e">        stride </span><span style="color:#d73a49">=</span><span style="color:#24292e"> MIN_TRANSFER_STRIDE; </span><span style="color:#6a737d">// subdivide range</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (nextTab </span><span style="color:#d73a49">==</span><span style="color:#24292e"> </span><span style="color:#005cc5">null</span><span style="color:#24292e">) {            </span><span style="color:#6a737d">// initiating</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">try</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">            @</span><span style="color:#d73a49">SuppressWarnings</span><span style="color:#24292e">(</span><span style="color:#032f62">"unchecked"</span><span style="color:#24292e">)</span></span>
<span class="line"><span style="color:#24292e">            Node&lt;</span><span style="color:#d73a49">K</span><span style="color:#24292e">,</span><span style="color:#d73a49">V</span><span style="color:#24292e">&gt;[] nt </span><span style="color:#d73a49">=</span><span style="color:#24292e"> (Node</span><span style="color:#d73a49">&lt;</span><span style="color:#24292e">K,V</span><span style="color:#d73a49">&gt;</span><span style="color:#24292e">[])</span><span style="color:#d73a49">new</span><span style="color:#24292e"> Node&lt;</span><span style="color:#d73a49">?</span><span style="color:#24292e">,</span><span style="color:#d73a49">?</span><span style="color:#24292e">&gt;[n </span><span style="color:#d73a49">&lt;&lt;</span><span style="color:#24292e"> </span><span style="color:#005cc5">1</span><span style="color:#24292e">];</span></span>
<span class="line"><span style="color:#24292e">            nextTab </span><span style="color:#d73a49">=</span><span style="color:#24292e"> nt;</span></span>
<span class="line"><span style="color:#24292e">        } </span><span style="color:#d73a49">catch</span><span style="color:#24292e"> (Throwable </span><span style="color:#e36209">ex</span><span style="color:#24292e">) {      </span><span style="color:#6a737d">// try to cope with OOME</span></span>
<span class="line"><span style="color:#24292e">            sizeCtl </span><span style="color:#d73a49">=</span><span style="color:#24292e"> Integer.MAX_VALUE;</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">return</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">        }</span></span>
<span class="line"><span style="color:#24292e">        nextTable </span><span style="color:#d73a49">=</span><span style="color:#24292e"> nextTab;</span></span>
<span class="line"><span style="color:#24292e">        transferIndex </span><span style="color:#d73a49">=</span><span style="color:#24292e"> n;</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">int</span><span style="color:#24292e"> nextn </span><span style="color:#d73a49">=</span><span style="color:#24292e"> nextTab.length;</span></span>
<span class="line"><span style="color:#24292e">    ForwardingNode&lt;</span><span style="color:#d73a49">K</span><span style="color:#24292e">,</span><span style="color:#d73a49">V</span><span style="color:#24292e">&gt; fwd </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> ForwardingNode&lt;</span><span style="color:#d73a49">K</span><span style="color:#24292e">,</span><span style="color:#d73a49">V</span><span style="color:#24292e">&gt;(nextTab);</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">boolean</span><span style="color:#24292e"> advance </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#005cc5">true</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">boolean</span><span style="color:#24292e"> finishing </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#005cc5">false</span><span style="color:#24292e">; </span><span style="color:#6a737d">// to ensure sweep before committing nextTab</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">for</span><span style="color:#24292e"> (</span><span style="color:#d73a49">int</span><span style="color:#24292e"> i </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#005cc5">0</span><span style="color:#24292e">, bound </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#005cc5">0</span><span style="color:#24292e">;;) {</span></span>
<span class="line"><span style="color:#24292e">        Node&lt;</span><span style="color:#d73a49">K</span><span style="color:#24292e">,</span><span style="color:#d73a49">V</span><span style="color:#24292e">&gt; f; </span><span style="color:#d73a49">int</span><span style="color:#24292e"> fh;</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">while</span><span style="color:#24292e"> (advance) {</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">int</span><span style="color:#24292e"> nextIndex, nextBound;</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (</span><span style="color:#d73a49">--</span><span style="color:#24292e">i </span><span style="color:#d73a49">&gt;=</span><span style="color:#24292e"> bound </span><span style="color:#d73a49">||</span><span style="color:#24292e"> finishing)</span></span>
<span class="line"><span style="color:#24292e">                advance </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#005cc5">false</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">else</span><span style="color:#24292e"> </span><span style="color:#d73a49">if</span><span style="color:#24292e"> ((nextIndex </span><span style="color:#d73a49">=</span><span style="color:#24292e"> transferIndex) </span><span style="color:#d73a49">&lt;=</span><span style="color:#24292e"> </span><span style="color:#005cc5">0</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">                i </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#d73a49">-</span><span style="color:#005cc5">1</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">                advance </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#005cc5">false</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">            }</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">else</span><span style="color:#24292e"> </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (U.compareAndSwapInt</span></span>
<span class="line"><span style="color:#24292e">                     (</span><span style="color:#005cc5">this</span><span style="color:#24292e">, TRANSFERINDEX, nextIndex,</span></span>
<span class="line"><span style="color:#24292e">                      nextBound </span><span style="color:#d73a49">=</span><span style="color:#24292e"> (nextIndex </span><span style="color:#d73a49">&gt;</span><span style="color:#24292e"> stride </span><span style="color:#d73a49">?</span></span>
<span class="line"><span style="color:#24292e">                                   nextIndex </span><span style="color:#d73a49">-</span><span style="color:#24292e"> stride </span><span style="color:#d73a49">:</span><span style="color:#24292e"> </span><span style="color:#005cc5">0</span><span style="color:#24292e">))) {</span></span>
<span class="line"><span style="color:#24292e">                bound </span><span style="color:#d73a49">=</span><span style="color:#24292e"> nextBound;</span></span>
<span class="line"><span style="color:#24292e">                i </span><span style="color:#d73a49">=</span><span style="color:#24292e"> nextIndex </span><span style="color:#d73a49">-</span><span style="color:#24292e"> </span><span style="color:#005cc5">1</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">                advance </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#005cc5">false</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">            }</span></span>
<span class="line"><span style="color:#24292e">        }</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (i </span><span style="color:#d73a49">&lt;</span><span style="color:#24292e"> </span><span style="color:#005cc5">0</span><span style="color:#24292e"> </span><span style="color:#d73a49">||</span><span style="color:#24292e"> i </span><span style="color:#d73a49">&gt;=</span><span style="color:#24292e"> n </span><span style="color:#d73a49">||</span><span style="color:#24292e"> i </span><span style="color:#d73a49">+</span><span style="color:#24292e"> n </span><span style="color:#d73a49">&gt;=</span><span style="color:#24292e"> nextn) {</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">int</span><span style="color:#24292e"> sc;</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (finishing) {</span></span>
<span class="line"><span style="color:#24292e">                nextTable </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#005cc5">null</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">                table </span><span style="color:#d73a49">=</span><span style="color:#24292e"> nextTab;</span></span>
<span class="line"><span style="color:#24292e">                sizeCtl </span><span style="color:#d73a49">=</span><span style="color:#24292e"> (n </span><span style="color:#d73a49">&lt;&lt;</span><span style="color:#24292e"> </span><span style="color:#005cc5">1</span><span style="color:#24292e">) </span><span style="color:#d73a49">-</span><span style="color:#24292e"> (n </span><span style="color:#d73a49">&gt;&gt;&gt;</span><span style="color:#24292e"> </span><span style="color:#005cc5">1</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#d73a49">return</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">            }</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (U.</span><span style="color:#6f42c1">compareAndSwapInt</span><span style="color:#24292e">(</span><span style="color:#005cc5">this</span><span style="color:#24292e">, SIZECTL, sc </span><span style="color:#d73a49">=</span><span style="color:#24292e"> sizeCtl, sc </span><span style="color:#d73a49">-</span><span style="color:#24292e"> </span><span style="color:#005cc5">1</span><span style="color:#24292e">)) {</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#d73a49">if</span><span style="color:#24292e"> ((sc </span><span style="color:#d73a49">-</span><span style="color:#24292e"> </span><span style="color:#005cc5">2</span><span style="color:#24292e">) </span><span style="color:#d73a49">!=</span><span style="color:#24292e"> </span><span style="color:#6f42c1">resizeStamp</span><span style="color:#24292e">(n) </span><span style="color:#d73a49">&lt;&lt;</span><span style="color:#24292e"> RESIZE_STAMP_SHIFT)</span></span>
<span class="line"><span style="color:#24292e">                    </span><span style="color:#d73a49">return</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">                finishing </span><span style="color:#d73a49">=</span><span style="color:#24292e"> advance </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#005cc5">true</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">                i </span><span style="color:#d73a49">=</span><span style="color:#24292e"> n; </span><span style="color:#6a737d">// recheck before commit</span></span>
<span class="line"><span style="color:#24292e">            }</span></span>
<span class="line"><span style="color:#24292e">        }</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">else</span><span style="color:#24292e"> </span><span style="color:#d73a49">if</span><span style="color:#24292e"> ((f </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#6f42c1">tabAt</span><span style="color:#24292e">(tab, i)) </span><span style="color:#d73a49">==</span><span style="color:#24292e"> </span><span style="color:#005cc5">null</span><span style="color:#24292e">)</span></span>
<span class="line"><span style="color:#24292e">            advance </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#6f42c1">casTabAt</span><span style="color:#24292e">(tab, i, </span><span style="color:#005cc5">null</span><span style="color:#24292e">, fwd);</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">else</span><span style="color:#24292e"> </span><span style="color:#d73a49">if</span><span style="color:#24292e"> ((fh </span><span style="color:#d73a49">=</span><span style="color:#24292e"> f.hash) </span><span style="color:#d73a49">==</span><span style="color:#24292e"> MOVED)</span></span>
<span class="line"><span style="color:#24292e">            advance </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#005cc5">true</span><span style="color:#24292e">; </span><span style="color:#6a737d">// already processed</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">else</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">synchronized</span><span style="color:#24292e"> (f) {</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (</span><span style="color:#6f42c1">tabAt</span><span style="color:#24292e">(tab, i) </span><span style="color:#d73a49">==</span><span style="color:#24292e"> f) {</span></span>
<span class="line"><span style="color:#24292e">                    Node&lt;</span><span style="color:#d73a49">K</span><span style="color:#24292e">,</span><span style="color:#d73a49">V</span><span style="color:#24292e">&gt; ln, hn;</span></span>
<span class="line"><span style="color:#24292e">                    </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (fh </span><span style="color:#d73a49">&gt;=</span><span style="color:#24292e"> </span><span style="color:#005cc5">0</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">                        </span><span style="color:#d73a49">int</span><span style="color:#24292e"> runBit </span><span style="color:#d73a49">=</span><span style="color:#24292e"> fh </span><span style="color:#d73a49">&amp;</span><span style="color:#24292e"> n;</span></span>
<span class="line"><span style="color:#24292e">                        Node&lt;</span><span style="color:#d73a49">K</span><span style="color:#24292e">,</span><span style="color:#d73a49">V</span><span style="color:#24292e">&gt; lastRun </span><span style="color:#d73a49">=</span><span style="color:#24292e"> f;</span></span>
<span class="line"><span style="color:#24292e">                        </span><span style="color:#d73a49">for</span><span style="color:#24292e"> (Node&lt;</span><span style="color:#d73a49">K</span><span style="color:#24292e">,</span><span style="color:#d73a49">V</span><span style="color:#24292e">&gt; p </span><span style="color:#d73a49">=</span><span style="color:#24292e"> f.next; p </span><span style="color:#d73a49">!=</span><span style="color:#24292e"> </span><span style="color:#005cc5">null</span><span style="color:#24292e">; p </span><span style="color:#d73a49">=</span><span style="color:#24292e"> p.next) {</span></span>
<span class="line"><span style="color:#24292e">                            </span><span style="color:#d73a49">int</span><span style="color:#24292e"> b </span><span style="color:#d73a49">=</span><span style="color:#24292e"> p.hash </span><span style="color:#d73a49">&amp;</span><span style="color:#24292e"> n;</span></span>
<span class="line"><span style="color:#24292e">                            </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (b </span><span style="color:#d73a49">!=</span><span style="color:#24292e"> runBit) {</span></span>
<span class="line"><span style="color:#24292e">                                runBit </span><span style="color:#d73a49">=</span><span style="color:#24292e"> b;</span></span>
<span class="line"><span style="color:#24292e">                                lastRun </span><span style="color:#d73a49">=</span><span style="color:#24292e"> p;</span></span>
<span class="line"><span style="color:#24292e">                            }</span></span>
<span class="line"><span style="color:#24292e">                        }</span></span>
<span class="line"><span style="color:#24292e">                        </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (runBit </span><span style="color:#d73a49">==</span><span style="color:#24292e"> </span><span style="color:#005cc5">0</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">                            ln </span><span style="color:#d73a49">=</span><span style="color:#24292e"> lastRun;</span></span>
<span class="line"><span style="color:#24292e">                            hn </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#005cc5">null</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">                        }</span></span>
<span class="line"><span style="color:#24292e">                        </span><span style="color:#d73a49">else</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">                            hn </span><span style="color:#d73a49">=</span><span style="color:#24292e"> lastRun;</span></span>
<span class="line"><span style="color:#24292e">                            ln </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#005cc5">null</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">                        }</span></span>
<span class="line"><span style="color:#24292e">                        </span><span style="color:#d73a49">for</span><span style="color:#24292e"> (Node&lt;</span><span style="color:#d73a49">K</span><span style="color:#24292e">,</span><span style="color:#d73a49">V</span><span style="color:#24292e">&gt; p </span><span style="color:#d73a49">=</span><span style="color:#24292e"> f; p </span><span style="color:#d73a49">!=</span><span style="color:#24292e"> lastRun; p </span><span style="color:#d73a49">=</span><span style="color:#24292e"> p.next) {</span></span>
<span class="line"><span style="color:#24292e">                            </span><span style="color:#d73a49">int</span><span style="color:#24292e"> ph </span><span style="color:#d73a49">=</span><span style="color:#24292e"> p.hash; K pk </span><span style="color:#d73a49">=</span><span style="color:#24292e"> p.key; V pv </span><span style="color:#d73a49">=</span><span style="color:#24292e"> p.val;</span></span>
<span class="line"><span style="color:#24292e">                            </span><span style="color:#d73a49">if</span><span style="color:#24292e"> ((ph </span><span style="color:#d73a49">&amp;</span><span style="color:#24292e"> n) </span><span style="color:#d73a49">==</span><span style="color:#24292e"> </span><span style="color:#005cc5">0</span><span style="color:#24292e">)</span></span>
<span class="line"><span style="color:#24292e">                                ln </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> Node&lt;</span><span style="color:#d73a49">K</span><span style="color:#24292e">,</span><span style="color:#d73a49">V</span><span style="color:#24292e">&gt;(ph, pk, pv, ln);</span></span>
<span class="line"><span style="color:#24292e">                            </span><span style="color:#d73a49">else</span></span>
<span class="line"><span style="color:#24292e">                                hn </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> Node&lt;</span><span style="color:#d73a49">K</span><span style="color:#24292e">,</span><span style="color:#d73a49">V</span><span style="color:#24292e">&gt;(ph, pk, pv, hn);</span></span>
<span class="line"><span style="color:#24292e">                        }</span></span>
<span class="line"><span style="color:#24292e">                        </span><span style="color:#6f42c1">setTabAt</span><span style="color:#24292e">(nextTab, i, ln);</span></span>
<span class="line"><span style="color:#24292e">                        </span><span style="color:#6f42c1">setTabAt</span><span style="color:#24292e">(nextTab, i </span><span style="color:#d73a49">+</span><span style="color:#24292e"> n, hn);</span></span>
<span class="line"><span style="color:#24292e">                        </span><span style="color:#6f42c1">setTabAt</span><span style="color:#24292e">(tab, i, fwd);</span></span>
<span class="line"><span style="color:#24292e">                        advance </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#005cc5">true</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">                    }</span></span>
<span class="line"><span style="color:#24292e">                    </span><span style="color:#d73a49">else</span><span style="color:#24292e"> </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (f </span><span style="color:#d73a49">instanceof</span><span style="color:#24292e"> TreeBin) {</span></span>
<span class="line"><span style="color:#24292e">                        TreeBin&lt;</span><span style="color:#d73a49">K</span><span style="color:#24292e">,</span><span style="color:#d73a49">V</span><span style="color:#24292e">&gt; t </span><span style="color:#d73a49">=</span><span style="color:#24292e"> (TreeBin</span><span style="color:#d73a49">&lt;</span><span style="color:#24292e">K,V</span><span style="color:#d73a49">&gt;</span><span style="color:#24292e">)f;</span></span>
<span class="line"><span style="color:#24292e">                        TreeNode&lt;</span><span style="color:#d73a49">K</span><span style="color:#24292e">,</span><span style="color:#d73a49">V</span><span style="color:#24292e">&gt; lo </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#005cc5">null</span><span style="color:#24292e">, loTail </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#005cc5">null</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">                        TreeNode&lt;</span><span style="color:#d73a49">K</span><span style="color:#24292e">,</span><span style="color:#d73a49">V</span><span style="color:#24292e">&gt; hi </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#005cc5">null</span><span style="color:#24292e">, hiTail </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#005cc5">null</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">                        </span><span style="color:#d73a49">int</span><span style="color:#24292e"> lc </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#005cc5">0</span><span style="color:#24292e">, hc </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#005cc5">0</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">                        </span><span style="color:#d73a49">for</span><span style="color:#24292e"> (Node&lt;</span><span style="color:#d73a49">K</span><span style="color:#24292e">,</span><span style="color:#d73a49">V</span><span style="color:#24292e">&gt; e </span><span style="color:#d73a49">=</span><span style="color:#24292e"> t.first; e </span><span style="color:#d73a49">!=</span><span style="color:#24292e"> </span><span style="color:#005cc5">null</span><span style="color:#24292e">; e </span><span style="color:#d73a49">=</span><span style="color:#24292e"> e.next) {</span></span>
<span class="line"><span style="color:#24292e">                            </span><span style="color:#d73a49">int</span><span style="color:#24292e"> h </span><span style="color:#d73a49">=</span><span style="color:#24292e"> e.hash;</span></span>
<span class="line"><span style="color:#24292e">                            TreeNode&lt;</span><span style="color:#d73a49">K</span><span style="color:#24292e">,</span><span style="color:#d73a49">V</span><span style="color:#24292e">&gt; p </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> TreeNode&lt;</span><span style="color:#d73a49">K</span><span style="color:#24292e">,</span><span style="color:#d73a49">V</span><span style="color:#24292e">&gt;</span></span>
<span class="line"><span style="color:#24292e">                                (h, e.key, e.val, </span><span style="color:#005cc5">null</span><span style="color:#24292e">, </span><span style="color:#005cc5">null</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">                            </span><span style="color:#d73a49">if</span><span style="color:#24292e"> ((h </span><span style="color:#d73a49">&amp;</span><span style="color:#24292e"> n) </span><span style="color:#d73a49">==</span><span style="color:#24292e"> </span><span style="color:#005cc5">0</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">                                </span><span style="color:#d73a49">if</span><span style="color:#24292e"> ((p.prev </span><span style="color:#d73a49">=</span><span style="color:#24292e"> loTail) </span><span style="color:#d73a49">==</span><span style="color:#24292e"> </span><span style="color:#005cc5">null</span><span style="color:#24292e">)</span></span>
<span class="line"><span style="color:#24292e">                                    lo </span><span style="color:#d73a49">=</span><span style="color:#24292e"> p;</span></span>
<span class="line"><span style="color:#24292e">                                </span><span style="color:#d73a49">else</span></span>
<span class="line"><span style="color:#24292e">                                    loTail.next </span><span style="color:#d73a49">=</span><span style="color:#24292e"> p;</span></span>
<span class="line"><span style="color:#24292e">                                loTail </span><span style="color:#d73a49">=</span><span style="color:#24292e"> p;</span></span>
<span class="line"><span style="color:#24292e">                                </span><span style="color:#d73a49">++</span><span style="color:#24292e">lc;</span></span>
<span class="line"><span style="color:#24292e">                            }</span></span>
<span class="line"><span style="color:#24292e">                            </span><span style="color:#d73a49">else</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">                                </span><span style="color:#d73a49">if</span><span style="color:#24292e"> ((p.prev </span><span style="color:#d73a49">=</span><span style="color:#24292e"> hiTail) </span><span style="color:#d73a49">==</span><span style="color:#24292e"> </span><span style="color:#005cc5">null</span><span style="color:#24292e">)</span></span>
<span class="line"><span style="color:#24292e">                                    hi </span><span style="color:#d73a49">=</span><span style="color:#24292e"> p;</span></span>
<span class="line"><span style="color:#24292e">                                </span><span style="color:#d73a49">else</span></span>
<span class="line"><span style="color:#24292e">                                    hiTail.next </span><span style="color:#d73a49">=</span><span style="color:#24292e"> p;</span></span>
<span class="line"><span style="color:#24292e">                                hiTail </span><span style="color:#d73a49">=</span><span style="color:#24292e"> p;</span></span>
<span class="line"><span style="color:#24292e">                                </span><span style="color:#d73a49">++</span><span style="color:#24292e">hc;</span></span>
<span class="line"><span style="color:#24292e">                            }</span></span>
<span class="line"><span style="color:#24292e">                        }</span></span>
<span class="line"><span style="color:#24292e">                        ln </span><span style="color:#d73a49">=</span><span style="color:#24292e"> (lc </span><span style="color:#d73a49">&lt;=</span><span style="color:#24292e"> UNTREEIFY_THRESHOLD) </span><span style="color:#d73a49">?</span><span style="color:#24292e"> </span><span style="color:#6f42c1">untreeify</span><span style="color:#24292e">(lo) </span><span style="color:#d73a49">:</span></span>
<span class="line"><span style="color:#24292e">                            (hc </span><span style="color:#d73a49">!=</span><span style="color:#24292e"> </span><span style="color:#005cc5">0</span><span style="color:#24292e">) </span><span style="color:#d73a49">?</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> TreeBin&lt;</span><span style="color:#d73a49">K</span><span style="color:#24292e">,</span><span style="color:#d73a49">V</span><span style="color:#24292e">&gt;(lo) </span><span style="color:#d73a49">:</span><span style="color:#24292e"> t;</span></span>
<span class="line"><span style="color:#24292e">                        hn </span><span style="color:#d73a49">=</span><span style="color:#24292e"> (hc </span><span style="color:#d73a49">&lt;=</span><span style="color:#24292e"> UNTREEIFY_THRESHOLD) </span><span style="color:#d73a49">?</span><span style="color:#24292e"> </span><span style="color:#6f42c1">untreeify</span><span style="color:#24292e">(hi) </span><span style="color:#d73a49">:</span></span>
<span class="line"><span style="color:#24292e">                            (lc </span><span style="color:#d73a49">!=</span><span style="color:#24292e"> </span><span style="color:#005cc5">0</span><span style="color:#24292e">) </span><span style="color:#d73a49">?</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> TreeBin&lt;</span><span style="color:#d73a49">K</span><span style="color:#24292e">,</span><span style="color:#d73a49">V</span><span style="color:#24292e">&gt;(hi) </span><span style="color:#d73a49">:</span><span style="color:#24292e"> t;</span></span>
<span class="line"><span style="color:#24292e">                        </span><span style="color:#6f42c1">setTabAt</span><span style="color:#24292e">(nextTab, i, ln);</span></span>
<span class="line"><span style="color:#24292e">                        </span><span style="color:#6f42c1">setTabAt</span><span style="color:#24292e">(nextTab, i </span><span style="color:#d73a49">+</span><span style="color:#24292e"> n, hn);</span></span>
<span class="line"><span style="color:#24292e">                        </span><span style="color:#6f42c1">setTabAt</span><span style="color:#24292e">(tab, i, fwd);</span></span>
<span class="line"><span style="color:#24292e">                        advance </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#005cc5">true</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">                    }</span></span>
<span class="line"><span style="color:#24292e">                }</span></span>
<span class="line"><span style="color:#24292e">            }</span></span>
<span class="line"><span style="color:#24292e">        }</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"><span style="color:#24292e">}</span></span></code></pre></div><p>Java 8 Êï∞ÁªÑÔºàNodeÔºâ +Ôºà ÈìæË°® Node | Á∫¢ÈªëÊ†ë TreeNode Ôºâ ‰ª•‰∏ãÊï∞ÁªÑÁÆÄÁß∞ÔºàtableÔºâÔºåÈìæË°®ÁÆÄÁß∞ÔºàbinÔºâ</p><ul><li>ÂàùÂßãÂåñÔºå‰ΩøÁî® cas Êù•‰øùËØÅÂπ∂ÂèëÂÆâÂÖ®ÔºåÊáíÊÉ∞ÂàùÂßãÂåñ table</li><li>Ê†ëÂåñÔºåÂΩì table.length &lt; 64 Êó∂ÔºåÂÖàÂ∞ùËØïÊâ©ÂÆπÔºåË∂ÖËøá 64 Êó∂ÔºåÂπ∂‰∏î bin.length &gt; 8 Êó∂Ôºå‰ºöÂ∞ÜÈìæË°®Ê†ëÂåñÔºåÊ†ëÂåñËøáÁ®ã‰ºöÁî® synchronized ÈîÅ‰ΩèÈìæË°®Â§¥</li><li>putÔºåÂ¶ÇÊûúËØ• bin Â∞öÊú™ÂàõÂª∫ÔºåÂè™ÈúÄË¶Å‰ΩøÁî® cas ÂàõÂª∫ binÔºõÂ¶ÇÊûúÂ∑≤ÁªèÊúâ‰∫ÜÔºåÈîÅ‰ΩèÈìæË°®Â§¥ËøõË°åÂêéÁª≠ put Êìç‰ΩúÔºåÂÖÉÁ¥†Ê∑ªÂä†Ëá≥ bin ÁöÑÂ∞æÈÉ®</li><li>getÔºåÊó†ÈîÅÊìç‰Ωú‰ªÖÈúÄË¶Å‰øùËØÅÂèØËßÅÊÄßÔºåÊâ©ÂÆπËøáÁ®ã‰∏≠ get Êìç‰ΩúÊãøÂà∞ÁöÑÊòØ ForwardingNode ÂÆÉ‰ºöËÆ© get Êìç‰ΩúÂú®Êñ∞table ËøõË°åÊêúÁ¥¢</li><li>Êâ©ÂÆπÔºåÊâ©ÂÆπÊó∂‰ª• bin ‰∏∫Âçï‰ΩçËøõË°åÔºåÈúÄË¶ÅÂØπ bin ËøõË°å synchronizedÔºå‰ΩÜËøôÊó∂Â¶ôÁöÑÊòØÂÖ∂ÂÆÉÁ´û‰∫âÁ∫øÁ®ã‰πü‰∏çÊòØÊó†‰∫ãÂèØÂÅöÔºåÂÆÉ‰ª¨‰ºöÂ∏ÆÂä©ÊääÂÖ∂ÂÆÉ bin ËøõË°åÊâ©ÂÆπÔºåÊâ©ÂÆπÊó∂Âπ≥ÂùáÂè™Êúâ 1/6 ÁöÑËäÇÁÇπ‰ºöÊääÂ§çÂà∂Âà∞Êñ∞ table ‰∏≠</li><li>sizeÔºåÂÖÉÁ¥†‰∏™Êï∞‰øùÂ≠òÂú® baseCount ‰∏≠ÔºåÂπ∂ÂèëÊó∂ÁöÑ‰∏™Êï∞ÂèòÂä®‰øùÂ≠òÂú® CounterCell[] ÂΩì‰∏≠„ÄÇÊúÄÂêéÁªüËÆ°Êï∞ÈáèÊó∂Á¥ØÂä†Âç≥ÂèØ</li></ul><p>Ê∫êÁ†ÅÂàÜÊûê <a target="_blank" rel="noreferrer" href="http://www.importnew.com/28263.html"><!--[-->http://www.importnew.com/28263.html<!--]--><!----></a> ÂÖ∂ÂÆÉÂÆûÁé∞ <a target="_blank" rel="noreferrer" href="https://github.com/boundary/high-scale-lib"><!--[-->Cliff Click's high scale lib<!--]--><!----></a></p><h5 id="jdk-7-concurrenthashmap" tabindex="-1">JDK 7 ConcurrentHashMap <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20advanced%20chapter#jdk-7-concurrenthashmap" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h5><p>ÂÆÉÁª¥Êä§‰∫Ü‰∏Ä‰∏™ segmentÔºàÂàÜÊÆµÔºâ Êï∞ÁªÑÔºåÊØè‰∏™ segment ÂØπÂ∫î‰∏ÄÊääÈîÅ</p><ul><li>‰ºòÁÇπÔºöÂ¶ÇÊûúÂ§ö‰∏™Á∫øÁ®ãËÆøÈóÆ‰∏çÂêåÁöÑ segmentÔºåÂÆûÈôÖÊòØÊ≤°ÊúâÂÜ≤Á™ÅÁöÑÔºåËøô‰∏é jdk8 ‰∏≠ÊòØÁ±ª‰ººÁöÑ</li><li>Áº∫ÁÇπÔºöSegments Êï∞ÁªÑÈªòËÆ§Â§ßÂ∞è‰∏∫16ÔºåËøô‰∏™ÂÆπÈáèÂàùÂßãÂåñÊåáÂÆöÂêéÂ∞±‰∏çËÉΩÊîπÂèò‰∫ÜÔºåÂπ∂‰∏î‰∏çÊòØÊáíÊÉ∞ÂàùÂßãÂåñ</li></ul><h6 id="ÊûÑÈÄ†Âô®ÂàÜÊûê-1" tabindex="-1">ÊûÑÈÄ†Âô®ÂàÜÊûê <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20advanced%20chapter#ÊûÑÈÄ†Âô®ÂàÜÊûê-1" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h6><blockquote><p>segmentShiftÔºöÁßª‰ΩçÂ±ûÊÄßÔºõÂΩìsegmentsÊï∞ÁªÑÂ§ßÂ∞è‰∏∫16ÔºåÂàôsegmentShift=32-4=28</p><p>segmentMaskÔºöÊé©Á†ÅÂ±ûÊÄßÔºõÂΩìsegmentsÊï∞ÁªÑÂ§ßÂ∞è‰∏∫16ÔºåÂàôsegmentMask=15 Âç≥ 0000 0000 0000 1111</p><p>‰∏§ËÄÖÁöÑÁõÆÁöÑÊòØÂ∞ÜÊù•‰Ω†put/get‰Ω†ÁöÑkeyÊó∂ÔºåÈÄöËøáÁßª‰ΩçÂíåÊé©Á†ÅËÆ°ÁÆóÁ°ÆÂÆökeyÂà∞Â∫ïÂØπÂ∫îsegmentÊï∞ÁªÑ‰∏≠ÁöÑÂì™‰∏™ÂÖÉÁ¥†</p></blockquote><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">ConcurrentHashMap</span><span style="color:#e1e4e8">(</span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> initialCapacity, </span><span style="color:#f97583">float</span><span style="color:#e1e4e8"> loadFactor, </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> concurrencyLevel) {</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (</span><span style="color:#f97583">!</span><span style="color:#e1e4e8">(loadFactor </span><span style="color:#f97583">&gt;</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8">) </span><span style="color:#f97583">||</span><span style="color:#e1e4e8"> initialCapacity </span><span style="color:#f97583">&lt;</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">||</span><span style="color:#e1e4e8"> concurrencyLevel </span><span style="color:#f97583">&lt;=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8">)</span></span>
<span class="line"><span style="color:#e1e4e8">    	</span><span style="color:#f97583">throw</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">IllegalArgumentException</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (concurrencyLevel </span><span style="color:#f97583">&gt;</span><span style="color:#e1e4e8"> MAX_SEGMENTS)</span></span>
<span class="line"><span style="color:#e1e4e8">    	concurrencyLevel </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> MAX_SEGMENTS;</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">// ssize ÂøÖÈ°ªÊòØ 2^n, Âç≥ 2, 4, 8, 16 ... Ë°®Á§∫‰∫Ü segments Êï∞ÁªÑÁöÑÂ§ßÂ∞è</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> sshift </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> ssize </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">1</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">while</span><span style="color:#e1e4e8"> (ssize </span><span style="color:#f97583">&lt;</span><span style="color:#e1e4e8"> concurrencyLevel) {</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">++</span><span style="color:#e1e4e8">sshift;</span></span>
<span class="line"><span style="color:#e1e4e8">        ssize </span><span style="color:#f97583">&lt;&lt;=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">1</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">// segmentShift ÈªòËÆ§ÊòØ 32 - 4 = 28</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#79b8ff">this</span><span style="color:#e1e4e8">.segmentShift </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">32</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">-</span><span style="color:#e1e4e8"> sshift;</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">// segmentMask ÈªòËÆ§ÊòØ 15 Âç≥ 0000 0000 0000 1111</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#79b8ff">this</span><span style="color:#e1e4e8">.segmentMask </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> ssize </span><span style="color:#f97583">-</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">1</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (initialCapacity </span><span style="color:#f97583">&gt;</span><span style="color:#e1e4e8"> MAXIMUM_CAPACITY)</span></span>
<span class="line"><span style="color:#e1e4e8">    	initialCapacity </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> MAXIMUM_CAPACITY;</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> c </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> initialCapacity </span><span style="color:#f97583">/</span><span style="color:#e1e4e8"> ssize;</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (c </span><span style="color:#f97583">*</span><span style="color:#e1e4e8"> ssize </span><span style="color:#f97583">&lt;</span><span style="color:#e1e4e8"> initialCapacity)</span></span>
<span class="line"><span style="color:#e1e4e8">    	</span><span style="color:#f97583">++</span><span style="color:#e1e4e8">c;</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> cap </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> MIN_SEGMENT_TABLE_CAPACITY;</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">while</span><span style="color:#e1e4e8"> (cap </span><span style="color:#f97583">&lt;</span><span style="color:#e1e4e8"> c)</span></span>
<span class="line"><span style="color:#e1e4e8">    	cap </span><span style="color:#f97583">&lt;&lt;=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">1</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">// ÂàõÂª∫ segments and segments[0]</span></span>
<span class="line"><span style="color:#e1e4e8">    Segment&lt;</span><span style="color:#f97583">K</span><span style="color:#e1e4e8">,</span><span style="color:#f97583">V</span><span style="color:#e1e4e8">&gt; s0 </span><span style="color:#f97583">=</span></span>
<span class="line"><span style="color:#e1e4e8">    	</span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> Segment&lt;</span><span style="color:#f97583">K</span><span style="color:#e1e4e8">,</span><span style="color:#f97583">V</span><span style="color:#e1e4e8">&gt;(loadFactor, (</span><span style="color:#f97583">int</span><span style="color:#e1e4e8">)(cap </span><span style="color:#f97583">*</span><span style="color:#e1e4e8"> loadFactor),</span></span>
<span class="line"><span style="color:#e1e4e8">    						(HashEntry</span><span style="color:#f97583">&lt;</span><span style="color:#e1e4e8">K,V</span><span style="color:#f97583">&gt;</span><span style="color:#e1e4e8">[])</span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">HashEntry</span><span style="color:#e1e4e8">[cap]);</span></span>
<span class="line"><span style="color:#e1e4e8">    Segment&lt;</span><span style="color:#f97583">K</span><span style="color:#e1e4e8">,</span><span style="color:#f97583">V</span><span style="color:#e1e4e8">&gt;[] ss </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> (Segment</span><span style="color:#f97583">&lt;</span><span style="color:#e1e4e8">K,V</span><span style="color:#f97583">&gt;</span><span style="color:#e1e4e8">[])</span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">Segment</span><span style="color:#e1e4e8">[ssize];</span></span>
<span class="line"><span style="color:#e1e4e8">    UNSAFE.</span><span style="color:#b392f0">putOrderedObject</span><span style="color:#e1e4e8">(ss, SBASE, s0); </span><span style="color:#6a737d">// ordered write of segments[0]</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#79b8ff">this</span><span style="color:#e1e4e8">.segments </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> ss;</span></span>
<span class="line"><span style="color:#e1e4e8">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#6f42c1">ConcurrentHashMap</span><span style="color:#24292e">(</span><span style="color:#d73a49">int</span><span style="color:#24292e"> initialCapacity, </span><span style="color:#d73a49">float</span><span style="color:#24292e"> loadFactor, </span><span style="color:#d73a49">int</span><span style="color:#24292e"> concurrencyLevel) {</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (</span><span style="color:#d73a49">!</span><span style="color:#24292e">(loadFactor </span><span style="color:#d73a49">&gt;</span><span style="color:#24292e"> </span><span style="color:#005cc5">0</span><span style="color:#24292e">) </span><span style="color:#d73a49">||</span><span style="color:#24292e"> initialCapacity </span><span style="color:#d73a49">&lt;</span><span style="color:#24292e"> </span><span style="color:#005cc5">0</span><span style="color:#24292e"> </span><span style="color:#d73a49">||</span><span style="color:#24292e"> concurrencyLevel </span><span style="color:#d73a49">&lt;=</span><span style="color:#24292e"> </span><span style="color:#005cc5">0</span><span style="color:#24292e">)</span></span>
<span class="line"><span style="color:#24292e">    	</span><span style="color:#d73a49">throw</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">IllegalArgumentException</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (concurrencyLevel </span><span style="color:#d73a49">&gt;</span><span style="color:#24292e"> MAX_SEGMENTS)</span></span>
<span class="line"><span style="color:#24292e">    	concurrencyLevel </span><span style="color:#d73a49">=</span><span style="color:#24292e"> MAX_SEGMENTS;</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">// ssize ÂøÖÈ°ªÊòØ 2^n, Âç≥ 2, 4, 8, 16 ... Ë°®Á§∫‰∫Ü segments Êï∞ÁªÑÁöÑÂ§ßÂ∞è</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">int</span><span style="color:#24292e"> sshift </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#005cc5">0</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">int</span><span style="color:#24292e"> ssize </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#005cc5">1</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">while</span><span style="color:#24292e"> (ssize </span><span style="color:#d73a49">&lt;</span><span style="color:#24292e"> concurrencyLevel) {</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">++</span><span style="color:#24292e">sshift;</span></span>
<span class="line"><span style="color:#24292e">        ssize </span><span style="color:#d73a49">&lt;&lt;=</span><span style="color:#24292e"> </span><span style="color:#005cc5">1</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">// segmentShift ÈªòËÆ§ÊòØ 32 - 4 = 28</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#005cc5">this</span><span style="color:#24292e">.segmentShift </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#005cc5">32</span><span style="color:#24292e"> </span><span style="color:#d73a49">-</span><span style="color:#24292e"> sshift;</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">// segmentMask ÈªòËÆ§ÊòØ 15 Âç≥ 0000 0000 0000 1111</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#005cc5">this</span><span style="color:#24292e">.segmentMask </span><span style="color:#d73a49">=</span><span style="color:#24292e"> ssize </span><span style="color:#d73a49">-</span><span style="color:#24292e"> </span><span style="color:#005cc5">1</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (initialCapacity </span><span style="color:#d73a49">&gt;</span><span style="color:#24292e"> MAXIMUM_CAPACITY)</span></span>
<span class="line"><span style="color:#24292e">    	initialCapacity </span><span style="color:#d73a49">=</span><span style="color:#24292e"> MAXIMUM_CAPACITY;</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">int</span><span style="color:#24292e"> c </span><span style="color:#d73a49">=</span><span style="color:#24292e"> initialCapacity </span><span style="color:#d73a49">/</span><span style="color:#24292e"> ssize;</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (c </span><span style="color:#d73a49">*</span><span style="color:#24292e"> ssize </span><span style="color:#d73a49">&lt;</span><span style="color:#24292e"> initialCapacity)</span></span>
<span class="line"><span style="color:#24292e">    	</span><span style="color:#d73a49">++</span><span style="color:#24292e">c;</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">int</span><span style="color:#24292e"> cap </span><span style="color:#d73a49">=</span><span style="color:#24292e"> MIN_SEGMENT_TABLE_CAPACITY;</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">while</span><span style="color:#24292e"> (cap </span><span style="color:#d73a49">&lt;</span><span style="color:#24292e"> c)</span></span>
<span class="line"><span style="color:#24292e">    	cap </span><span style="color:#d73a49">&lt;&lt;=</span><span style="color:#24292e"> </span><span style="color:#005cc5">1</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">// ÂàõÂª∫ segments and segments[0]</span></span>
<span class="line"><span style="color:#24292e">    Segment&lt;</span><span style="color:#d73a49">K</span><span style="color:#24292e">,</span><span style="color:#d73a49">V</span><span style="color:#24292e">&gt; s0 </span><span style="color:#d73a49">=</span></span>
<span class="line"><span style="color:#24292e">    	</span><span style="color:#d73a49">new</span><span style="color:#24292e"> Segment&lt;</span><span style="color:#d73a49">K</span><span style="color:#24292e">,</span><span style="color:#d73a49">V</span><span style="color:#24292e">&gt;(loadFactor, (</span><span style="color:#d73a49">int</span><span style="color:#24292e">)(cap </span><span style="color:#d73a49">*</span><span style="color:#24292e"> loadFactor),</span></span>
<span class="line"><span style="color:#24292e">    						(HashEntry</span><span style="color:#d73a49">&lt;</span><span style="color:#24292e">K,V</span><span style="color:#d73a49">&gt;</span><span style="color:#24292e">[])</span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#d73a49">HashEntry</span><span style="color:#24292e">[cap]);</span></span>
<span class="line"><span style="color:#24292e">    Segment&lt;</span><span style="color:#d73a49">K</span><span style="color:#24292e">,</span><span style="color:#d73a49">V</span><span style="color:#24292e">&gt;[] ss </span><span style="color:#d73a49">=</span><span style="color:#24292e"> (Segment</span><span style="color:#d73a49">&lt;</span><span style="color:#24292e">K,V</span><span style="color:#d73a49">&gt;</span><span style="color:#24292e">[])</span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#d73a49">Segment</span><span style="color:#24292e">[ssize];</span></span>
<span class="line"><span style="color:#24292e">    UNSAFE.</span><span style="color:#6f42c1">putOrderedObject</span><span style="color:#24292e">(ss, SBASE, s0); </span><span style="color:#6a737d">// ordered write of segments[0]</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#005cc5">this</span><span style="color:#24292e">.segments </span><span style="color:#d73a49">=</span><span style="color:#24292e"> ss;</span></span>
<span class="line"><span style="color:#24292e">}</span></span></code></pre></div><p>ÊûÑÈÄ†ÂÆåÊàêÔºåÂ¶Ç‰∏ãÂõæÊâÄÁ§∫</p><figure><img src="https://jsd.cdn.zzko.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230720153932589.png" alt="image-20230720153932589" loading="lazy" decoding="async"></figure><p>ÂèØ‰ª•ÁúãÂà∞ ConcurrentHashMap Ê≤°ÊúâÂÆûÁé∞ÊáíÊÉ∞ÂàùÂßãÂåñÔºåÁ©∫Èó¥Âç†Áî®‰∏çÂèãÂ•Ω ÂÖ∂‰∏≠ this.segmentShift Âíå this.segmentMask ÁöÑ‰ΩúÁî®ÊòØÂÜ≥ÂÆöÂ∞Ü key ÁöÑ hash ÁªìÊûúÂåπÈÖçÂà∞Âì™‰∏™ segment ‰æãÂ¶ÇÔºåÊ†πÊçÆÊüê‰∏Ä hash ÂÄºÊ±Ç segment ‰ΩçÁΩÆÔºåÂÖàÂ∞ÜÈ´ò‰ΩçÂêë‰Ωé‰ΩçÁßªÂä® <code>this.segmentShift</code> ‰Ωç</p><figure><img src="https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230720153953515.png" alt="image-20230720153953515" loading="lazy" decoding="async"></figure><p>ÁªìÊûúÂÜç‰∏é this.segmentMask ÂÅö‰Ωç‰∫éËøêÁÆóÔºà&amp;ÔºâÔºåÊúÄÁªàÂæóÂà∞ 1010 Âç≥‰∏ãÊ†á‰∏∫ 10 ÁöÑ segment</p><figure><img src="https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230720154003822.png" alt="image-20230720154003822" loading="lazy" decoding="async"></figure><p>put ÊµÅÁ®ã</p><blockquote><p>Èô§‰∫ÜsegmentÊï∞ÁªÑÂíåsegment[0]‰∏çÊòØÊáíÊÉ∞ÂàùÂßãÂåñÔºåÂÖ∂‰ªñ‰ΩçÁΩÆÈÉΩÊòØÊáíÊÉ∞ÂàùÂßãÂåñÔºà<code>segment[1]-hashEntry&lt;key,value&gt;</code>...Ôºâ</p><p>concurrentHashMapÁöÑputÊñπÊ≥ïÊòØË∞ÉÁî®segmentÁöÑputÊñπÊ≥ï</p></blockquote><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#f97583">public</span><span style="color:#e1e4e8"> V </span><span style="color:#b392f0">put</span><span style="color:#e1e4e8">(K key, V value) {</span></span>
<span class="line"><span style="color:#e1e4e8">    Segment&lt;</span><span style="color:#f97583">K</span><span style="color:#e1e4e8">,</span><span style="color:#f97583">V</span><span style="color:#e1e4e8">&gt; s;</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (value </span><span style="color:#f97583">==</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8">)</span></span>
<span class="line"><span style="color:#e1e4e8">    	</span><span style="color:#f97583">throw</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">NullPointerException</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> hash </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">hash</span><span style="color:#e1e4e8">(key);</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">// ËÆ°ÁÆóÂá∫ segment ‰∏ãÊ†á</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> j </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> (hash </span><span style="color:#f97583">&gt;&gt;&gt;</span><span style="color:#e1e4e8"> segmentShift) </span><span style="color:#f97583">&amp;</span><span style="color:#e1e4e8"> segmentMask;</span></span>
<span class="line"><span style="color:#e1e4e8">    </span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">// Ëé∑Âæó segment ÂØπË±°, Âà§Êñ≠ÊòØÂê¶‰∏∫ null, ÊòØÂàôÂàõÂª∫ËØ• segment</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> ((s </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> (Segment</span><span style="color:#f97583">&lt;</span><span style="color:#e1e4e8">K,V</span><span style="color:#f97583">&gt;</span><span style="color:#e1e4e8">)UNSAFE.getObject</span></span>
<span class="line"><span style="color:#e1e4e8">    	(segments, (j </span><span style="color:#f97583">&lt;&lt;</span><span style="color:#e1e4e8"> SSHIFT) </span><span style="color:#f97583">+</span><span style="color:#e1e4e8"> SBASE)) </span><span style="color:#f97583">==</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#6a737d">// ËøôÊó∂‰∏çËÉΩÁ°ÆÂÆöÊòØÂê¶ÁúüÁöÑ‰∏∫ null, Âõ†‰∏∫ÂÖ∂ÂÆÉÁ∫øÁ®ã‰πüÂèëÁé∞ËØ• segment ‰∏∫ null,</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#6a737d">// Âõ†Ê≠§Âú® ensureSegment ÈáåÁî® cas ÊñπÂºè‰øùËØÅËØ• segment ÂÆâÂÖ®ÊÄß</span></span>
<span class="line"><span style="color:#e1e4e8">        s </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">ensureSegment</span><span style="color:#e1e4e8">(j);</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">// ËøõÂÖ• segment ÁöÑput ÊµÅÁ®ã</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> s.</span><span style="color:#b392f0">put</span><span style="color:#e1e4e8">(key, hash, value, </span><span style="color:#79b8ff">false</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#d73a49">public</span><span style="color:#24292e"> V </span><span style="color:#6f42c1">put</span><span style="color:#24292e">(K key, V value) {</span></span>
<span class="line"><span style="color:#24292e">    Segment&lt;</span><span style="color:#d73a49">K</span><span style="color:#24292e">,</span><span style="color:#d73a49">V</span><span style="color:#24292e">&gt; s;</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (value </span><span style="color:#d73a49">==</span><span style="color:#24292e"> </span><span style="color:#005cc5">null</span><span style="color:#24292e">)</span></span>
<span class="line"><span style="color:#24292e">    	</span><span style="color:#d73a49">throw</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">NullPointerException</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">int</span><span style="color:#24292e"> hash </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#6f42c1">hash</span><span style="color:#24292e">(key);</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">// ËÆ°ÁÆóÂá∫ segment ‰∏ãÊ†á</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">int</span><span style="color:#24292e"> j </span><span style="color:#d73a49">=</span><span style="color:#24292e"> (hash </span><span style="color:#d73a49">&gt;&gt;&gt;</span><span style="color:#24292e"> segmentShift) </span><span style="color:#d73a49">&amp;</span><span style="color:#24292e"> segmentMask;</span></span>
<span class="line"><span style="color:#24292e">    </span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">// Ëé∑Âæó segment ÂØπË±°, Âà§Êñ≠ÊòØÂê¶‰∏∫ null, ÊòØÂàôÂàõÂª∫ËØ• segment</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">if</span><span style="color:#24292e"> ((s </span><span style="color:#d73a49">=</span><span style="color:#24292e"> (Segment</span><span style="color:#d73a49">&lt;</span><span style="color:#24292e">K,V</span><span style="color:#d73a49">&gt;</span><span style="color:#24292e">)UNSAFE.getObject</span></span>
<span class="line"><span style="color:#24292e">    	(segments, (j </span><span style="color:#d73a49">&lt;&lt;</span><span style="color:#24292e"> SSHIFT) </span><span style="color:#d73a49">+</span><span style="color:#24292e"> SBASE)) </span><span style="color:#d73a49">==</span><span style="color:#24292e"> </span><span style="color:#005cc5">null</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6a737d">// ËøôÊó∂‰∏çËÉΩÁ°ÆÂÆöÊòØÂê¶ÁúüÁöÑ‰∏∫ null, Âõ†‰∏∫ÂÖ∂ÂÆÉÁ∫øÁ®ã‰πüÂèëÁé∞ËØ• segment ‰∏∫ null,</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6a737d">// Âõ†Ê≠§Âú® ensureSegment ÈáåÁî® cas ÊñπÂºè‰øùËØÅËØ• segment ÂÆâÂÖ®ÊÄß</span></span>
<span class="line"><span style="color:#24292e">        s </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#6f42c1">ensureSegment</span><span style="color:#24292e">(j);</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">// ËøõÂÖ• segment ÁöÑput ÊµÅÁ®ã</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">return</span><span style="color:#24292e"> s.</span><span style="color:#6f42c1">put</span><span style="color:#24292e">(key, hash, value, </span><span style="color:#005cc5">false</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">}</span></span></code></pre></div><p>segment ÁªßÊâø‰∫ÜÂèØÈáçÂÖ•ÈîÅÔºàReentrantLockÔºâÔºåÂÆÉÁöÑ put ÊñπÊ≥ï‰∏∫</p><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#f97583">final</span><span style="color:#e1e4e8"> V </span><span style="color:#b392f0">put</span><span style="color:#e1e4e8">(K key, </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> hash, V value, </span><span style="color:#f97583">boolean</span><span style="color:#e1e4e8"> onlyIfAbsent) {</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">// Â∞ùËØïÂä†ÈîÅ</span></span>
<span class="line"><span style="color:#e1e4e8">    HashEntry&lt;</span><span style="color:#f97583">K</span><span style="color:#e1e4e8">,</span><span style="color:#f97583">V</span><span style="color:#e1e4e8">&gt; node </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">tryLock</span><span style="color:#e1e4e8">() </span><span style="color:#f97583">?</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">:</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">// Â¶ÇÊûú‰∏çÊàêÂäü, ËøõÂÖ• scanAndLockForPut ÊµÅÁ®ã</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">// Â¶ÇÊûúÊòØÂ§öÊ†∏ cpu ÊúÄÂ§ö tryLock 64 Ê¨°, ËøõÂÖ• lock ÊµÅÁ®ã</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">// Âú®Â∞ùËØïÊúüÈó¥, ËøòÂèØ‰ª•È°∫‰æøÁúãËØ•ËäÇÁÇπÂú®ÈìæË°®‰∏≠ÊúâÊ≤°Êúâ, Â¶ÇÊûúÊ≤°ÊúâÈ°∫‰æøÂàõÂª∫Âá∫Êù•</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#b392f0">scanAndLockForPut</span><span style="color:#e1e4e8">(key, hash, value);</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">// ÊâßË°åÂà∞ËøôÈáå segment Â∑≤ÁªèË¢´ÊàêÂäüÂä†ÈîÅ, ÂèØ‰ª•ÂÆâÂÖ®ÊâßË°å</span></span>
<span class="line"><span style="color:#e1e4e8">    V oldValue;</span></span>
<span class="line"><span style="color:#e1e4e8">    </span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">try</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">        HashEntry&lt;</span><span style="color:#f97583">K</span><span style="color:#e1e4e8">,</span><span style="color:#f97583">V</span><span style="color:#e1e4e8">&gt;[] tab </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> table;</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> index </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> (tab.length </span><span style="color:#f97583">-</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">1</span><span style="color:#e1e4e8">) </span><span style="color:#f97583">&amp;</span><span style="color:#e1e4e8"> hash;</span></span>
<span class="line"><span style="color:#e1e4e8">        HashEntry&lt;</span><span style="color:#f97583">K</span><span style="color:#e1e4e8">,</span><span style="color:#f97583">V</span><span style="color:#e1e4e8">&gt; first </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">entryAt</span><span style="color:#e1e4e8">(tab, index);</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">for</span><span style="color:#e1e4e8"> (HashEntry&lt;</span><span style="color:#f97583">K</span><span style="color:#e1e4e8">,</span><span style="color:#f97583">V</span><span style="color:#e1e4e8">&gt; e </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> first;;) {</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (e </span><span style="color:#f97583">!=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#6a737d">// Êõ¥Êñ∞</span></span>
<span class="line"><span style="color:#e1e4e8">                K k;</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> ((k </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> e.key) </span><span style="color:#f97583">==</span><span style="color:#e1e4e8"> key </span><span style="color:#f97583">||</span></span>
<span class="line"><span style="color:#e1e4e8">                        (e.hash </span><span style="color:#f97583">==</span><span style="color:#e1e4e8"> hash </span><span style="color:#f97583">&amp;&amp;</span><span style="color:#e1e4e8"> key.</span><span style="color:#b392f0">equals</span><span style="color:#e1e4e8">(k))) {</span></span>
<span class="line"><span style="color:#e1e4e8">                    oldValue </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> e.value;</span></span>
<span class="line"><span style="color:#e1e4e8">                    </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (</span><span style="color:#f97583">!</span><span style="color:#e1e4e8">onlyIfAbsent) {</span></span>
<span class="line"><span style="color:#e1e4e8">                        e.value </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> value;</span></span>
<span class="line"><span style="color:#e1e4e8">                        </span><span style="color:#f97583">++</span><span style="color:#e1e4e8">modCount;</span></span>
<span class="line"><span style="color:#e1e4e8">                    }</span></span>
<span class="line"><span style="color:#e1e4e8">                    </span><span style="color:#f97583">break</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">                }</span></span>
<span class="line"><span style="color:#e1e4e8">                e </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> e.next;</span></span>
<span class="line"><span style="color:#e1e4e8">            }</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">else</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#6a737d">// Êñ∞Â¢û</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#6a737d">// 1) ‰πãÂâçÁ≠âÂæÖÈîÅÊó∂, node Â∑≤ÁªèË¢´ÂàõÂª∫, next ÊåáÂêëÈìæË°®Â§¥</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (node </span><span style="color:#f97583">!=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8">)</span></span>
<span class="line"><span style="color:#e1e4e8">                    node.</span><span style="color:#b392f0">setNext</span><span style="color:#e1e4e8">(first);</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#f97583">else</span></span>
<span class="line"><span style="color:#e1e4e8">                    </span><span style="color:#6a737d">// 2) ÂàõÂª∫Êñ∞ node</span></span>
<span class="line"><span style="color:#e1e4e8">                    node </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> HashEntry&lt;</span><span style="color:#f97583">K</span><span style="color:#e1e4e8">,</span><span style="color:#f97583">V</span><span style="color:#e1e4e8">&gt;(hash, key, value, first);</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> c </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> count </span><span style="color:#f97583">+</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">1</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#6a737d">// 3) Êâ©ÂÆπ</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (c </span><span style="color:#f97583">&gt;</span><span style="color:#e1e4e8"> threshold </span><span style="color:#f97583">&amp;&amp;</span><span style="color:#e1e4e8"> tab.length </span><span style="color:#f97583">&lt;</span><span style="color:#e1e4e8"> MAXIMUM_CAPACITY)</span></span>
<span class="line"><span style="color:#e1e4e8">                    </span><span style="color:#b392f0">rehash</span><span style="color:#e1e4e8">(node);</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#f97583">else</span></span>
<span class="line"><span style="color:#e1e4e8">                    </span><span style="color:#6a737d">// Â∞Ü node ‰Ωú‰∏∫ÈìæË°®Â§¥</span></span>
<span class="line"><span style="color:#e1e4e8">                    </span><span style="color:#b392f0">setEntryAt</span><span style="color:#e1e4e8">(tab, index, node);</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#f97583">++</span><span style="color:#e1e4e8">modCount;</span></span>
<span class="line"><span style="color:#e1e4e8">                count </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> c;</span></span>
<span class="line"><span style="color:#e1e4e8">                oldValue </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#f97583">break</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">            }</span></span>
<span class="line"><span style="color:#e1e4e8">        }</span></span>
<span class="line"><span style="color:#e1e4e8">    } </span><span style="color:#f97583">finally</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#b392f0">unlock</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> oldValue;</span></span>
<span class="line"><span style="color:#e1e4e8">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#d73a49">final</span><span style="color:#24292e"> V </span><span style="color:#6f42c1">put</span><span style="color:#24292e">(K key, </span><span style="color:#d73a49">int</span><span style="color:#24292e"> hash, V value, </span><span style="color:#d73a49">boolean</span><span style="color:#24292e"> onlyIfAbsent) {</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">// Â∞ùËØïÂä†ÈîÅ</span></span>
<span class="line"><span style="color:#24292e">    HashEntry&lt;</span><span style="color:#d73a49">K</span><span style="color:#24292e">,</span><span style="color:#d73a49">V</span><span style="color:#24292e">&gt; node </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#6f42c1">tryLock</span><span style="color:#24292e">() </span><span style="color:#d73a49">?</span><span style="color:#24292e"> </span><span style="color:#005cc5">null</span><span style="color:#24292e"> </span><span style="color:#d73a49">:</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">// Â¶ÇÊûú‰∏çÊàêÂäü, ËøõÂÖ• scanAndLockForPut ÊµÅÁ®ã</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">// Â¶ÇÊûúÊòØÂ§öÊ†∏ cpu ÊúÄÂ§ö tryLock 64 Ê¨°, ËøõÂÖ• lock ÊµÅÁ®ã</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">// Âú®Â∞ùËØïÊúüÈó¥, ËøòÂèØ‰ª•È°∫‰æøÁúãËØ•ËäÇÁÇπÂú®ÈìæË°®‰∏≠ÊúâÊ≤°Êúâ, Â¶ÇÊûúÊ≤°ÊúâÈ°∫‰æøÂàõÂª∫Âá∫Êù•</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6f42c1">scanAndLockForPut</span><span style="color:#24292e">(key, hash, value);</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">// ÊâßË°åÂà∞ËøôÈáå segment Â∑≤ÁªèË¢´ÊàêÂäüÂä†ÈîÅ, ÂèØ‰ª•ÂÆâÂÖ®ÊâßË°å</span></span>
<span class="line"><span style="color:#24292e">    V oldValue;</span></span>
<span class="line"><span style="color:#24292e">    </span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">try</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">        HashEntry&lt;</span><span style="color:#d73a49">K</span><span style="color:#24292e">,</span><span style="color:#d73a49">V</span><span style="color:#24292e">&gt;[] tab </span><span style="color:#d73a49">=</span><span style="color:#24292e"> table;</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">int</span><span style="color:#24292e"> index </span><span style="color:#d73a49">=</span><span style="color:#24292e"> (tab.length </span><span style="color:#d73a49">-</span><span style="color:#24292e"> </span><span style="color:#005cc5">1</span><span style="color:#24292e">) </span><span style="color:#d73a49">&amp;</span><span style="color:#24292e"> hash;</span></span>
<span class="line"><span style="color:#24292e">        HashEntry&lt;</span><span style="color:#d73a49">K</span><span style="color:#24292e">,</span><span style="color:#d73a49">V</span><span style="color:#24292e">&gt; first </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#6f42c1">entryAt</span><span style="color:#24292e">(tab, index);</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">for</span><span style="color:#24292e"> (HashEntry&lt;</span><span style="color:#d73a49">K</span><span style="color:#24292e">,</span><span style="color:#d73a49">V</span><span style="color:#24292e">&gt; e </span><span style="color:#d73a49">=</span><span style="color:#24292e"> first;;) {</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (e </span><span style="color:#d73a49">!=</span><span style="color:#24292e"> </span><span style="color:#005cc5">null</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#6a737d">// Êõ¥Êñ∞</span></span>
<span class="line"><span style="color:#24292e">                K k;</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#d73a49">if</span><span style="color:#24292e"> ((k </span><span style="color:#d73a49">=</span><span style="color:#24292e"> e.key) </span><span style="color:#d73a49">==</span><span style="color:#24292e"> key </span><span style="color:#d73a49">||</span></span>
<span class="line"><span style="color:#24292e">                        (e.hash </span><span style="color:#d73a49">==</span><span style="color:#24292e"> hash </span><span style="color:#d73a49">&amp;&amp;</span><span style="color:#24292e"> key.</span><span style="color:#6f42c1">equals</span><span style="color:#24292e">(k))) {</span></span>
<span class="line"><span style="color:#24292e">                    oldValue </span><span style="color:#d73a49">=</span><span style="color:#24292e"> e.value;</span></span>
<span class="line"><span style="color:#24292e">                    </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (</span><span style="color:#d73a49">!</span><span style="color:#24292e">onlyIfAbsent) {</span></span>
<span class="line"><span style="color:#24292e">                        e.value </span><span style="color:#d73a49">=</span><span style="color:#24292e"> value;</span></span>
<span class="line"><span style="color:#24292e">                        </span><span style="color:#d73a49">++</span><span style="color:#24292e">modCount;</span></span>
<span class="line"><span style="color:#24292e">                    }</span></span>
<span class="line"><span style="color:#24292e">                    </span><span style="color:#d73a49">break</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">                }</span></span>
<span class="line"><span style="color:#24292e">                e </span><span style="color:#d73a49">=</span><span style="color:#24292e"> e.next;</span></span>
<span class="line"><span style="color:#24292e">            }</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">else</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#6a737d">// Êñ∞Â¢û</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#6a737d">// 1) ‰πãÂâçÁ≠âÂæÖÈîÅÊó∂, node Â∑≤ÁªèË¢´ÂàõÂª∫, next ÊåáÂêëÈìæË°®Â§¥</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (node </span><span style="color:#d73a49">!=</span><span style="color:#24292e"> </span><span style="color:#005cc5">null</span><span style="color:#24292e">)</span></span>
<span class="line"><span style="color:#24292e">                    node.</span><span style="color:#6f42c1">setNext</span><span style="color:#24292e">(first);</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#d73a49">else</span></span>
<span class="line"><span style="color:#24292e">                    </span><span style="color:#6a737d">// 2) ÂàõÂª∫Êñ∞ node</span></span>
<span class="line"><span style="color:#24292e">                    node </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> HashEntry&lt;</span><span style="color:#d73a49">K</span><span style="color:#24292e">,</span><span style="color:#d73a49">V</span><span style="color:#24292e">&gt;(hash, key, value, first);</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#d73a49">int</span><span style="color:#24292e"> c </span><span style="color:#d73a49">=</span><span style="color:#24292e"> count </span><span style="color:#d73a49">+</span><span style="color:#24292e"> </span><span style="color:#005cc5">1</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#6a737d">// 3) Êâ©ÂÆπ</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (c </span><span style="color:#d73a49">&gt;</span><span style="color:#24292e"> threshold </span><span style="color:#d73a49">&amp;&amp;</span><span style="color:#24292e"> tab.length </span><span style="color:#d73a49">&lt;</span><span style="color:#24292e"> MAXIMUM_CAPACITY)</span></span>
<span class="line"><span style="color:#24292e">                    </span><span style="color:#6f42c1">rehash</span><span style="color:#24292e">(node);</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#d73a49">else</span></span>
<span class="line"><span style="color:#24292e">                    </span><span style="color:#6a737d">// Â∞Ü node ‰Ωú‰∏∫ÈìæË°®Â§¥</span></span>
<span class="line"><span style="color:#24292e">                    </span><span style="color:#6f42c1">setEntryAt</span><span style="color:#24292e">(tab, index, node);</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#d73a49">++</span><span style="color:#24292e">modCount;</span></span>
<span class="line"><span style="color:#24292e">                count </span><span style="color:#d73a49">=</span><span style="color:#24292e"> c;</span></span>
<span class="line"><span style="color:#24292e">                oldValue </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#005cc5">null</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#d73a49">break</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">            }</span></span>
<span class="line"><span style="color:#24292e">        }</span></span>
<span class="line"><span style="color:#24292e">    } </span><span style="color:#d73a49">finally</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6f42c1">unlock</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">return</span><span style="color:#24292e"> oldValue;</span></span>
<span class="line"><span style="color:#24292e">}</span></span></code></pre></div><blockquote><p>Âú®Â∞ùËØïÂä†ÈîÅÊúüÈó¥, ËøòÂèØ‰ª•È°∫‰æøÁúã‰Ω†Ë¶ÅputÁöÑËäÇÁÇπÔºà<code>HashEntry&lt;K,V&gt; node</code>-&gt; &lt;- (k,v) -&gt;ÔºâÂú®ÈìæË°®‰∏≠ÊúâÊ≤°Êúâ, Â¶ÇÊûúÊ≤°ÊúâÈ°∫‰æøÂàõÂª∫Âá∫Êù•</p><p>Êõ¥Êñ∞ÁöÑÊó∂ÂÄôÔºåËã•ÊòØÂêå‰∏Ä‰∏™ÂØπË±°ÁöÑÂÄº‰ºöË¢´Êñ∞ÁöÑÂÄºË¶ÜÁõñÊéâ</p><p>Êñ∞Â¢ûÁöÑÊó∂ÂÄôÔºåÔºà1ÔºâÂõ†‰∏∫Â∞ùËØïÂä†ÈîÅÊúüÈó¥nodeÂ∞±ÂàõÂª∫Âá∫Êù•‰∫ÜÔºåÈÇ£‰πàÊñ∞Â¢ûÁöÑÂÄºÂ∞±‰ºöÊèíÂÖ•ÈìæË°®Â§¥ÔºàÂ§¥ÊèíÊ≥ïÔºåÁ∫øÁ®ãÂÆâÂÖ®Ôºå‰∏ç‰ºöÂèëÁîüÊ≠ªÈìæÔºâÔºõÔºà2ÔºâËã•nodeËøòÊ≤°ÂàõÂª∫Â∞±‰ºöÂÖàÂéªÂàõÂª∫Âá∫Êù•ÔºõÔºà3ÔºâË∂ÖËøáÈòàÂÄºÂ∞±Êâ©ÂÆπÔºåÊú™Ë∂ÖËøáÂ∞±Â∞ÜÊñ∞Â¢ûËäÇÁÇπ‰Ωú‰∏∫ÈìæË°®Â§¥</p></blockquote><h6 id="rehash-ÊµÅÁ®ã" tabindex="-1">rehash ÊµÅÁ®ã <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20advanced%20chapter#rehash-ÊµÅÁ®ã" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h6><p>ÂèëÁîüÂú® put ‰∏≠ÔºåÂõ†‰∏∫Ê≠§Êó∂Â∑≤ÁªèËé∑Âæó‰∫ÜÈîÅÔºåÂõ†Ê≠§ rehash Êó∂‰∏çÈúÄË¶ÅËÄÉËôëÁ∫øÁ®ãÂÆâÂÖ®</p><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#f97583">private</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">void</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">rehash</span><span style="color:#e1e4e8">(HashEntry</span><span style="color:#f97583">&lt;</span><span style="color:#e1e4e8">K,V</span><span style="color:#f97583">&gt;</span><span style="color:#e1e4e8"> node) {</span></span>
<span class="line"><span style="color:#e1e4e8">        HashEntry&lt;</span><span style="color:#f97583">K</span><span style="color:#e1e4e8">,</span><span style="color:#f97583">V</span><span style="color:#e1e4e8">&gt;[] oldTable </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> table;</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> oldCapacity </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> oldTable.length;</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> newCapacity </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> oldCapacity </span><span style="color:#f97583">&lt;&lt;</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">1</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">        threshold </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> (</span><span style="color:#f97583">int</span><span style="color:#e1e4e8">)(newCapacity </span><span style="color:#f97583">*</span><span style="color:#e1e4e8"> loadFactor);</span></span>
<span class="line"><span style="color:#e1e4e8">        HashEntry&lt;</span><span style="color:#f97583">K</span><span style="color:#e1e4e8">,</span><span style="color:#f97583">V</span><span style="color:#e1e4e8">&gt;[] newTable </span><span style="color:#f97583">=</span></span>
<span class="line"><span style="color:#e1e4e8">                (HashEntry</span><span style="color:#f97583">&lt;</span><span style="color:#e1e4e8">K,V</span><span style="color:#f97583">&gt;</span><span style="color:#e1e4e8">[]) </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">HashEntry</span><span style="color:#e1e4e8">[newCapacity];</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> sizeMask </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> newCapacity </span><span style="color:#f97583">-</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">1</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">for</span><span style="color:#e1e4e8"> (</span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> i </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8">; i </span><span style="color:#f97583">&lt;</span><span style="color:#e1e4e8"> oldCapacity ; i</span><span style="color:#f97583">++</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">            HashEntry&lt;</span><span style="color:#f97583">K</span><span style="color:#e1e4e8">,</span><span style="color:#f97583">V</span><span style="color:#e1e4e8">&gt; e </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> oldTable[i];</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (e </span><span style="color:#f97583">!=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">                HashEntry&lt;</span><span style="color:#f97583">K</span><span style="color:#e1e4e8">,</span><span style="color:#f97583">V</span><span style="color:#e1e4e8">&gt; next </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> e.next;</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> idx </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> e.hash </span><span style="color:#f97583">&amp;</span><span style="color:#e1e4e8"> sizeMask;</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (next </span><span style="color:#f97583">==</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8">) </span><span style="color:#6a737d">// Single node on list</span></span>
<span class="line"><span style="color:#e1e4e8">                    newTable[idx] </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> e;</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#f97583">else</span><span style="color:#e1e4e8"> { </span><span style="color:#6a737d">// Reuse consecutive sequence at same slot</span></span>
<span class="line"><span style="color:#e1e4e8">                    HashEntry&lt;</span><span style="color:#f97583">K</span><span style="color:#e1e4e8">,</span><span style="color:#f97583">V</span><span style="color:#e1e4e8">&gt; lastRun </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> e;</span></span>
<span class="line"><span style="color:#e1e4e8">                    </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> lastIdx </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> idx;</span></span>
<span class="line"><span style="color:#e1e4e8">					</span><span style="color:#6a737d">// Ëøá‰∏ÄÈÅçÈìæË°®, Â∞ΩÂèØËÉΩÊää rehash Âêé idx ‰∏çÂèòÁöÑËäÇÁÇπÈáçÁî®</span></span>
<span class="line"><span style="color:#e1e4e8">                    </span><span style="color:#f97583">for</span><span style="color:#e1e4e8"> (HashEntry&lt;</span><span style="color:#f97583">K</span><span style="color:#e1e4e8">,</span><span style="color:#f97583">V</span><span style="color:#e1e4e8">&gt; last </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> next;</span></span>
<span class="line"><span style="color:#e1e4e8">                         last </span><span style="color:#f97583">!=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">                         last </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> last.next) {</span></span>
<span class="line"><span style="color:#e1e4e8">                        </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> k </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> last.hash </span><span style="color:#f97583">&amp;</span><span style="color:#e1e4e8"> sizeMask;</span></span>
<span class="line"><span style="color:#e1e4e8">                        </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (k </span><span style="color:#f97583">!=</span><span style="color:#e1e4e8"> lastIdx) {</span></span>
<span class="line"><span style="color:#e1e4e8">                            lastIdx </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> k;</span></span>
<span class="line"><span style="color:#e1e4e8">                            lastRun </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> last;</span></span>
<span class="line"><span style="color:#e1e4e8">                        }</span></span>
<span class="line"><span style="color:#e1e4e8">                    }</span></span>
<span class="line"><span style="color:#e1e4e8">                    newTable[lastIdx] </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> lastRun;</span></span>
<span class="line"><span style="color:#e1e4e8">					</span><span style="color:#6a737d">// Ââ©‰ΩôËäÇÁÇπÈúÄË¶ÅÊñ∞Âª∫</span></span>
<span class="line"><span style="color:#e1e4e8">                    </span><span style="color:#f97583">for</span><span style="color:#e1e4e8"> (HashEntry&lt;</span><span style="color:#f97583">K</span><span style="color:#e1e4e8">,</span><span style="color:#f97583">V</span><span style="color:#e1e4e8">&gt; p </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> e; p </span><span style="color:#f97583">!=</span><span style="color:#e1e4e8"> lastRun; p </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> p.next) {</span></span>
<span class="line"><span style="color:#e1e4e8">                        V v </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> p.value;</span></span>
<span class="line"><span style="color:#e1e4e8">                        </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> h </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> p.hash;</span></span>
<span class="line"><span style="color:#e1e4e8">                        </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> k </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> h </span><span style="color:#f97583">&amp;</span><span style="color:#e1e4e8"> sizeMask;</span></span>
<span class="line"><span style="color:#e1e4e8">                        HashEntry&lt;</span><span style="color:#f97583">K</span><span style="color:#e1e4e8">,</span><span style="color:#f97583">V</span><span style="color:#e1e4e8">&gt; n </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> newTable[k];</span></span>
<span class="line"><span style="color:#e1e4e8">                        newTable[k] </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> HashEntry&lt;</span><span style="color:#f97583">K</span><span style="color:#e1e4e8">,</span><span style="color:#f97583">V</span><span style="color:#e1e4e8">&gt;(h, p.key, v, n);</span></span>
<span class="line"><span style="color:#e1e4e8">                    }</span></span>
<span class="line"><span style="color:#e1e4e8">                }</span></span>
<span class="line"><span style="color:#e1e4e8">            }</span></span>
<span class="line"><span style="color:#e1e4e8">        }</span></span>
<span class="line"><span style="color:#e1e4e8">		</span><span style="color:#6a737d">// Êâ©ÂÆπÂÆåÊàê, ÊâçÂä†ÂÖ•Êñ∞ÁöÑËäÇÁÇπ</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> nodeIndex </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> node.hash </span><span style="color:#f97583">&amp;</span><span style="color:#e1e4e8"> sizeMask; </span><span style="color:#6a737d">// add the new node</span></span>
<span class="line"><span style="color:#e1e4e8">        node.</span><span style="color:#b392f0">setNext</span><span style="color:#e1e4e8">(newTable[nodeIndex]);</span></span>
<span class="line"><span style="color:#e1e4e8">        newTable[nodeIndex] </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> node;</span></span>
<span class="line"><span style="color:#e1e4e8">		</span><span style="color:#6a737d">// ÊõøÊç¢‰∏∫Êñ∞ÁöÑ HashEntry table</span></span>
<span class="line"><span style="color:#e1e4e8">        table </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> newTable;</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#d73a49">private</span><span style="color:#24292e"> </span><span style="color:#d73a49">void</span><span style="color:#24292e"> </span><span style="color:#6f42c1">rehash</span><span style="color:#24292e">(HashEntry</span><span style="color:#d73a49">&lt;</span><span style="color:#24292e">K,V</span><span style="color:#d73a49">&gt;</span><span style="color:#24292e"> node) {</span></span>
<span class="line"><span style="color:#24292e">        HashEntry&lt;</span><span style="color:#d73a49">K</span><span style="color:#24292e">,</span><span style="color:#d73a49">V</span><span style="color:#24292e">&gt;[] oldTable </span><span style="color:#d73a49">=</span><span style="color:#24292e"> table;</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">int</span><span style="color:#24292e"> oldCapacity </span><span style="color:#d73a49">=</span><span style="color:#24292e"> oldTable.length;</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">int</span><span style="color:#24292e"> newCapacity </span><span style="color:#d73a49">=</span><span style="color:#24292e"> oldCapacity </span><span style="color:#d73a49">&lt;&lt;</span><span style="color:#24292e"> </span><span style="color:#005cc5">1</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">        threshold </span><span style="color:#d73a49">=</span><span style="color:#24292e"> (</span><span style="color:#d73a49">int</span><span style="color:#24292e">)(newCapacity </span><span style="color:#d73a49">*</span><span style="color:#24292e"> loadFactor);</span></span>
<span class="line"><span style="color:#24292e">        HashEntry&lt;</span><span style="color:#d73a49">K</span><span style="color:#24292e">,</span><span style="color:#d73a49">V</span><span style="color:#24292e">&gt;[] newTable </span><span style="color:#d73a49">=</span></span>
<span class="line"><span style="color:#24292e">                (HashEntry</span><span style="color:#d73a49">&lt;</span><span style="color:#24292e">K,V</span><span style="color:#d73a49">&gt;</span><span style="color:#24292e">[]) </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#d73a49">HashEntry</span><span style="color:#24292e">[newCapacity];</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">int</span><span style="color:#24292e"> sizeMask </span><span style="color:#d73a49">=</span><span style="color:#24292e"> newCapacity </span><span style="color:#d73a49">-</span><span style="color:#24292e"> </span><span style="color:#005cc5">1</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">for</span><span style="color:#24292e"> (</span><span style="color:#d73a49">int</span><span style="color:#24292e"> i </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#005cc5">0</span><span style="color:#24292e">; i </span><span style="color:#d73a49">&lt;</span><span style="color:#24292e"> oldCapacity ; i</span><span style="color:#d73a49">++</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">            HashEntry&lt;</span><span style="color:#d73a49">K</span><span style="color:#24292e">,</span><span style="color:#d73a49">V</span><span style="color:#24292e">&gt; e </span><span style="color:#d73a49">=</span><span style="color:#24292e"> oldTable[i];</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (e </span><span style="color:#d73a49">!=</span><span style="color:#24292e"> </span><span style="color:#005cc5">null</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">                HashEntry&lt;</span><span style="color:#d73a49">K</span><span style="color:#24292e">,</span><span style="color:#d73a49">V</span><span style="color:#24292e">&gt; next </span><span style="color:#d73a49">=</span><span style="color:#24292e"> e.next;</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#d73a49">int</span><span style="color:#24292e"> idx </span><span style="color:#d73a49">=</span><span style="color:#24292e"> e.hash </span><span style="color:#d73a49">&amp;</span><span style="color:#24292e"> sizeMask;</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (next </span><span style="color:#d73a49">==</span><span style="color:#24292e"> </span><span style="color:#005cc5">null</span><span style="color:#24292e">) </span><span style="color:#6a737d">// Single node on list</span></span>
<span class="line"><span style="color:#24292e">                    newTable[idx] </span><span style="color:#d73a49">=</span><span style="color:#24292e"> e;</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#d73a49">else</span><span style="color:#24292e"> { </span><span style="color:#6a737d">// Reuse consecutive sequence at same slot</span></span>
<span class="line"><span style="color:#24292e">                    HashEntry&lt;</span><span style="color:#d73a49">K</span><span style="color:#24292e">,</span><span style="color:#d73a49">V</span><span style="color:#24292e">&gt; lastRun </span><span style="color:#d73a49">=</span><span style="color:#24292e"> e;</span></span>
<span class="line"><span style="color:#24292e">                    </span><span style="color:#d73a49">int</span><span style="color:#24292e"> lastIdx </span><span style="color:#d73a49">=</span><span style="color:#24292e"> idx;</span></span>
<span class="line"><span style="color:#24292e">					</span><span style="color:#6a737d">// Ëøá‰∏ÄÈÅçÈìæË°®, Â∞ΩÂèØËÉΩÊää rehash Âêé idx ‰∏çÂèòÁöÑËäÇÁÇπÈáçÁî®</span></span>
<span class="line"><span style="color:#24292e">                    </span><span style="color:#d73a49">for</span><span style="color:#24292e"> (HashEntry&lt;</span><span style="color:#d73a49">K</span><span style="color:#24292e">,</span><span style="color:#d73a49">V</span><span style="color:#24292e">&gt; last </span><span style="color:#d73a49">=</span><span style="color:#24292e"> next;</span></span>
<span class="line"><span style="color:#24292e">                         last </span><span style="color:#d73a49">!=</span><span style="color:#24292e"> </span><span style="color:#005cc5">null</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">                         last </span><span style="color:#d73a49">=</span><span style="color:#24292e"> last.next) {</span></span>
<span class="line"><span style="color:#24292e">                        </span><span style="color:#d73a49">int</span><span style="color:#24292e"> k </span><span style="color:#d73a49">=</span><span style="color:#24292e"> last.hash </span><span style="color:#d73a49">&amp;</span><span style="color:#24292e"> sizeMask;</span></span>
<span class="line"><span style="color:#24292e">                        </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (k </span><span style="color:#d73a49">!=</span><span style="color:#24292e"> lastIdx) {</span></span>
<span class="line"><span style="color:#24292e">                            lastIdx </span><span style="color:#d73a49">=</span><span style="color:#24292e"> k;</span></span>
<span class="line"><span style="color:#24292e">                            lastRun </span><span style="color:#d73a49">=</span><span style="color:#24292e"> last;</span></span>
<span class="line"><span style="color:#24292e">                        }</span></span>
<span class="line"><span style="color:#24292e">                    }</span></span>
<span class="line"><span style="color:#24292e">                    newTable[lastIdx] </span><span style="color:#d73a49">=</span><span style="color:#24292e"> lastRun;</span></span>
<span class="line"><span style="color:#24292e">					</span><span style="color:#6a737d">// Ââ©‰ΩôËäÇÁÇπÈúÄË¶ÅÊñ∞Âª∫</span></span>
<span class="line"><span style="color:#24292e">                    </span><span style="color:#d73a49">for</span><span style="color:#24292e"> (HashEntry&lt;</span><span style="color:#d73a49">K</span><span style="color:#24292e">,</span><span style="color:#d73a49">V</span><span style="color:#24292e">&gt; p </span><span style="color:#d73a49">=</span><span style="color:#24292e"> e; p </span><span style="color:#d73a49">!=</span><span style="color:#24292e"> lastRun; p </span><span style="color:#d73a49">=</span><span style="color:#24292e"> p.next) {</span></span>
<span class="line"><span style="color:#24292e">                        V v </span><span style="color:#d73a49">=</span><span style="color:#24292e"> p.value;</span></span>
<span class="line"><span style="color:#24292e">                        </span><span style="color:#d73a49">int</span><span style="color:#24292e"> h </span><span style="color:#d73a49">=</span><span style="color:#24292e"> p.hash;</span></span>
<span class="line"><span style="color:#24292e">                        </span><span style="color:#d73a49">int</span><span style="color:#24292e"> k </span><span style="color:#d73a49">=</span><span style="color:#24292e"> h </span><span style="color:#d73a49">&amp;</span><span style="color:#24292e"> sizeMask;</span></span>
<span class="line"><span style="color:#24292e">                        HashEntry&lt;</span><span style="color:#d73a49">K</span><span style="color:#24292e">,</span><span style="color:#d73a49">V</span><span style="color:#24292e">&gt; n </span><span style="color:#d73a49">=</span><span style="color:#24292e"> newTable[k];</span></span>
<span class="line"><span style="color:#24292e">                        newTable[k] </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> HashEntry&lt;</span><span style="color:#d73a49">K</span><span style="color:#24292e">,</span><span style="color:#d73a49">V</span><span style="color:#24292e">&gt;(h, p.key, v, n);</span></span>
<span class="line"><span style="color:#24292e">                    }</span></span>
<span class="line"><span style="color:#24292e">                }</span></span>
<span class="line"><span style="color:#24292e">            }</span></span>
<span class="line"><span style="color:#24292e">        }</span></span>
<span class="line"><span style="color:#24292e">		</span><span style="color:#6a737d">// Êâ©ÂÆπÂÆåÊàê, ÊâçÂä†ÂÖ•Êñ∞ÁöÑËäÇÁÇπ</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">int</span><span style="color:#24292e"> nodeIndex </span><span style="color:#d73a49">=</span><span style="color:#24292e"> node.hash </span><span style="color:#d73a49">&amp;</span><span style="color:#24292e"> sizeMask; </span><span style="color:#6a737d">// add the new node</span></span>
<span class="line"><span style="color:#24292e">        node.</span><span style="color:#6f42c1">setNext</span><span style="color:#24292e">(newTable[nodeIndex]);</span></span>
<span class="line"><span style="color:#24292e">        newTable[nodeIndex] </span><span style="color:#d73a49">=</span><span style="color:#24292e"> node;</span></span>
<span class="line"><span style="color:#24292e">		</span><span style="color:#6a737d">// ÊõøÊç¢‰∏∫Êñ∞ÁöÑ HashEntry table</span></span>
<span class="line"><span style="color:#24292e">        table </span><span style="color:#d73a49">=</span><span style="color:#24292e"> newTable;</span></span>
<span class="line"><span style="color:#24292e">    }</span></span></code></pre></div><blockquote><p>Êâ©ÂÆπÊó∂ÔºåÊúâÁöÑËäÇÁÇπÔºàÈáçÊñ∞ËÆ°ÁÆóÂæóÂá∫Ê°∂‰∏ãÊ†á‰∏ÄÊ†∑ÁöÑÔºâÊòØÊê¨ËøÅËøáÂéªÊñ∞ÁöÑÊï∞ÁªÑÔºàÊ≤°Êúâ‰ΩøÁî®Â§¥ÊèíÊ≥ïÔºåÁõ¥Êé•ÊòØÂéüÂ∞Å‰∏çÂä®Âú∞Âπ≥ÁßªËøáÂéªÔºâÔºåÊúâÁöÑËäÇÁÇπÔºàÈáçÊñ∞ËÆ°ÁÆóÂæóÂá∫Ê°∂‰∏ãÊ†á‰∏ç‰∏ÄÊ†∑ÁöÑÔºâÂàôÂàõÂª∫Êñ∞ÁöÑÔºåÂéüÊúâÁöÑ‰ºöÊäõÂºÉÊéâÔºàÂéüÊúâÁöÑËäÇÁÇπË¢´ÁïôÂú®ÂéüÊúâÁöÑHashEntry‰∏≠Ôºâ</p><figure><img src="https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230720194508341.png" alt="image-20230720194508341" loading="lazy" decoding="async"></figure><p>ËäÇÁÇπÁöÑÊñ∞Â¢ûÊìç‰ΩúÂèëÁîüÂú®Êâ©ÂÆπÂÆåÊàê‰πãÂêéÔºåÁ≠âËäÇÁÇπÊñ∞Â¢ûÂÆåÂêéÂ∞±‰ºöÊääÊóßÁöÑtableÔºàHashEntryÊï∞ÁªÑÔºâÊõøÊç¢‰∏∫Êñ∞ÁöÑtable</p></blockquote><h6 id="get-ÊµÅÁ®ã-1" tabindex="-1">get ÊµÅÁ®ã <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20advanced%20chapter#get-ÊµÅÁ®ã-1" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h6><p>get Êó∂Âπ∂Êú™Âä†ÈîÅÔºåÁî®‰∫Ü UNSAFE ÊñπÊ≥ï‰øùËØÅ‰∫ÜÂèØËßÅÊÄßÔºåÊâ©ÂÆπËøáÁ®ã‰∏≠Ôºåget ÂÖàÂèëÁîüÂ∞±‰ªéÊóßË°®ÂèñÂÜÖÂÆπÔºåget ÂêéÂèëÁîüÂ∞±‰ªéÊñ∞Ë°®ÂèñÂÜÖÂÆπ</p><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#f97583">public</span><span style="color:#e1e4e8"> V </span><span style="color:#b392f0">get</span><span style="color:#e1e4e8">(Object key) {</span></span>
<span class="line"><span style="color:#e1e4e8">    Segment&lt;</span><span style="color:#f97583">K</span><span style="color:#e1e4e8">,</span><span style="color:#f97583">V</span><span style="color:#e1e4e8">&gt; s; </span><span style="color:#6a737d">// manually integrate access methods to reduce overhead</span></span>
<span class="line"><span style="color:#e1e4e8">    HashEntry&lt;</span><span style="color:#f97583">K</span><span style="color:#e1e4e8">,</span><span style="color:#f97583">V</span><span style="color:#e1e4e8">&gt;[] tab;</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> h </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">hash</span><span style="color:#e1e4e8">(key);</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">// u ‰∏∫ segment ÂØπË±°Âú®Êï∞ÁªÑ‰∏≠ÁöÑÂÅèÁßªÈáè</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">long</span><span style="color:#e1e4e8"> u </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> (((h </span><span style="color:#f97583">&gt;&gt;&gt;</span><span style="color:#e1e4e8"> segmentShift) </span><span style="color:#f97583">&amp;</span><span style="color:#e1e4e8"> segmentMask) </span><span style="color:#f97583">&lt;&lt;</span><span style="color:#e1e4e8"> SSHIFT) </span><span style="color:#f97583">+</span><span style="color:#e1e4e8"> SBASE;</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">// s Âç≥‰∏∫ segment</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> ((s </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> (Segment</span><span style="color:#f97583">&lt;</span><span style="color:#e1e4e8">K,V</span><span style="color:#f97583">&gt;</span><span style="color:#e1e4e8">)UNSAFE.</span><span style="color:#b392f0">getObjectVolatile</span><span style="color:#e1e4e8">(segments, u)) </span><span style="color:#f97583">!=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">&amp;&amp;</span></span>
<span class="line"><span style="color:#e1e4e8">    	(tab </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> s.table) </span><span style="color:#f97583">!=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">for</span><span style="color:#e1e4e8"> (HashEntry&lt;</span><span style="color:#f97583">K</span><span style="color:#e1e4e8">,</span><span style="color:#f97583">V</span><span style="color:#e1e4e8">&gt; e </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> (HashEntry</span><span style="color:#f97583">&lt;</span><span style="color:#e1e4e8">K,V</span><span style="color:#f97583">&gt;</span><span style="color:#e1e4e8">) UNSAFE.getObjectVolatile</span></span>
<span class="line"><span style="color:#e1e4e8">             (tab, ((</span><span style="color:#f97583">long</span><span style="color:#e1e4e8">)(((tab.length </span><span style="color:#f97583">-</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">1</span><span style="color:#e1e4e8">) </span><span style="color:#f97583">&amp;</span><span style="color:#e1e4e8"> h)) </span><span style="color:#f97583">&lt;&lt;</span><span style="color:#e1e4e8"> TSHIFT) </span><span style="color:#f97583">+</span><span style="color:#e1e4e8"> TBASE);</span></span>
<span class="line"><span style="color:#e1e4e8">             e </span><span style="color:#f97583">!=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8">; e </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> e.next) {</span></span>
<span class="line"><span style="color:#e1e4e8">            K k;</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> ((k </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> e.key) </span><span style="color:#f97583">==</span><span style="color:#e1e4e8"> key </span><span style="color:#f97583">||</span><span style="color:#e1e4e8"> (e.hash </span><span style="color:#f97583">==</span><span style="color:#e1e4e8"> h </span><span style="color:#f97583">&amp;&amp;</span><span style="color:#e1e4e8"> key.</span><span style="color:#b392f0">equals</span><span style="color:#e1e4e8">(k)))</span></span>
<span class="line"><span style="color:#e1e4e8">            	</span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> e.value;</span></span>
<span class="line"><span style="color:#e1e4e8">        }</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#d73a49">public</span><span style="color:#24292e"> V </span><span style="color:#6f42c1">get</span><span style="color:#24292e">(Object key) {</span></span>
<span class="line"><span style="color:#24292e">    Segment&lt;</span><span style="color:#d73a49">K</span><span style="color:#24292e">,</span><span style="color:#d73a49">V</span><span style="color:#24292e">&gt; s; </span><span style="color:#6a737d">// manually integrate access methods to reduce overhead</span></span>
<span class="line"><span style="color:#24292e">    HashEntry&lt;</span><span style="color:#d73a49">K</span><span style="color:#24292e">,</span><span style="color:#d73a49">V</span><span style="color:#24292e">&gt;[] tab;</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">int</span><span style="color:#24292e"> h </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#6f42c1">hash</span><span style="color:#24292e">(key);</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">// u ‰∏∫ segment ÂØπË±°Âú®Êï∞ÁªÑ‰∏≠ÁöÑÂÅèÁßªÈáè</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">long</span><span style="color:#24292e"> u </span><span style="color:#d73a49">=</span><span style="color:#24292e"> (((h </span><span style="color:#d73a49">&gt;&gt;&gt;</span><span style="color:#24292e"> segmentShift) </span><span style="color:#d73a49">&amp;</span><span style="color:#24292e"> segmentMask) </span><span style="color:#d73a49">&lt;&lt;</span><span style="color:#24292e"> SSHIFT) </span><span style="color:#d73a49">+</span><span style="color:#24292e"> SBASE;</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">// s Âç≥‰∏∫ segment</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">if</span><span style="color:#24292e"> ((s </span><span style="color:#d73a49">=</span><span style="color:#24292e"> (Segment</span><span style="color:#d73a49">&lt;</span><span style="color:#24292e">K,V</span><span style="color:#d73a49">&gt;</span><span style="color:#24292e">)UNSAFE.</span><span style="color:#6f42c1">getObjectVolatile</span><span style="color:#24292e">(segments, u)) </span><span style="color:#d73a49">!=</span><span style="color:#24292e"> </span><span style="color:#005cc5">null</span><span style="color:#24292e"> </span><span style="color:#d73a49">&amp;&amp;</span></span>
<span class="line"><span style="color:#24292e">    	(tab </span><span style="color:#d73a49">=</span><span style="color:#24292e"> s.table) </span><span style="color:#d73a49">!=</span><span style="color:#24292e"> </span><span style="color:#005cc5">null</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">for</span><span style="color:#24292e"> (HashEntry&lt;</span><span style="color:#d73a49">K</span><span style="color:#24292e">,</span><span style="color:#d73a49">V</span><span style="color:#24292e">&gt; e </span><span style="color:#d73a49">=</span><span style="color:#24292e"> (HashEntry</span><span style="color:#d73a49">&lt;</span><span style="color:#24292e">K,V</span><span style="color:#d73a49">&gt;</span><span style="color:#24292e">) UNSAFE.getObjectVolatile</span></span>
<span class="line"><span style="color:#24292e">             (tab, ((</span><span style="color:#d73a49">long</span><span style="color:#24292e">)(((tab.length </span><span style="color:#d73a49">-</span><span style="color:#24292e"> </span><span style="color:#005cc5">1</span><span style="color:#24292e">) </span><span style="color:#d73a49">&amp;</span><span style="color:#24292e"> h)) </span><span style="color:#d73a49">&lt;&lt;</span><span style="color:#24292e"> TSHIFT) </span><span style="color:#d73a49">+</span><span style="color:#24292e"> TBASE);</span></span>
<span class="line"><span style="color:#24292e">             e </span><span style="color:#d73a49">!=</span><span style="color:#24292e"> </span><span style="color:#005cc5">null</span><span style="color:#24292e">; e </span><span style="color:#d73a49">=</span><span style="color:#24292e"> e.next) {</span></span>
<span class="line"><span style="color:#24292e">            K k;</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">if</span><span style="color:#24292e"> ((k </span><span style="color:#d73a49">=</span><span style="color:#24292e"> e.key) </span><span style="color:#d73a49">==</span><span style="color:#24292e"> key </span><span style="color:#d73a49">||</span><span style="color:#24292e"> (e.hash </span><span style="color:#d73a49">==</span><span style="color:#24292e"> h </span><span style="color:#d73a49">&amp;&amp;</span><span style="color:#24292e"> key.</span><span style="color:#6f42c1">equals</span><span style="color:#24292e">(k)))</span></span>
<span class="line"><span style="color:#24292e">            	</span><span style="color:#d73a49">return</span><span style="color:#24292e"> e.value;</span></span>
<span class="line"><span style="color:#24292e">        }</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">return</span><span style="color:#24292e"> </span><span style="color:#005cc5">null</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">}</span></span></code></pre></div><blockquote><p>ÂÆö‰ΩçÊ°∂‰∏ãÊ†áË∞ÉÁî®‰∫ÜUNSAFE.getObjectVolatileÔºåÁî®‰∫ÜÂæàÂ§öÁöÑÁßª‰ΩçËøêÁÆóÔºåÂÖ∂ÂÆûJDK8‰πüÊòØ‰∏ÄÊ†∑ÁöÑÔºåÂè™‰∏çËøáÂ∞ÅË£ÖÊàê‰∫ÜtabAtÊñπÊ≥ïÔºåÊääÁßª‰ΩçÊìç‰ΩúÂ∞ÅË£ÖËµ∑Êù•‰∫ÜÔºå‰Ω†Áúã‰∏çÂà∞ÔºåÂÖ∂ÂÜÖÈÉ®ÈÉΩÊòØË∞ÉÁî®‰∫ÜUNSAFE.getObjectVolatileÔºåÂõ†‰∏∫segmentËøòÊòØÈìæË°®Â§¥ÂÆÉ‰ª¨ÈÉΩÊòØÂú®Êï∞ÁªÑÈáåÔºåÊï∞ÁªÑÈáåÁöÑÂÜÖÂÆπ‰Ω†ÂÖâÂä†volatileÊù•‰øÆÈ•∞Êï∞ÁªÑÊú¨Ë∫´ÊòØ‰∏çË°åÁöÑÔºåÂÆÉ‰ª¨Â±û‰∫éÊï∞ÁªÑÁöÑÂÖÉÁ¥†ÔºåÊâÄ‰ª•ÂøÖÈ°ªÈÖçÂêàUNSAFE.getObjectVolatileÊù•‰øùËØÅÂÆÉ‰ª¨ÁöÑÂèØËßÅÊÄßÔºõ</p><p>ÂÆö‰ΩçÂà∞Ê°∂‰∏ãÊ†áÁúãÊòØ‰∏çÊòØÂêå‰∏Ä‰∏™ÂØπË±°Ôºàhash&amp;equalsÔºâÔºåÊòØÁõ¥Êé•ËøîÂõûÔºõÂæ™ÁéØÁªìÊùü‰ªçÊú™ÊâæÂà∞Â∞±ËøîÂõûnull</p></blockquote><h6 id="size-ËÆ°ÁÆóÊµÅÁ®ã-1" tabindex="-1">size ËÆ°ÁÆóÊµÅÁ®ã <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20advanced%20chapter#size-ËÆ°ÁÆóÊµÅÁ®ã-1" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h6><ul><li>ËÆ°ÁÆóÂÖÉÁ¥†‰∏™Êï∞ÂâçÔºåÂÖà‰∏çÂä†ÈîÅËÆ°ÁÆó‰∏§Ê¨°ÔºåÂ¶ÇÊûúÂâçÂêé‰∏§Ê¨°ÁªìÊûúÈÉΩ‰∏ÄÊ†∑ÔºåËÆ§‰∏∫‰∏™Êï∞Ê≠£Á°ÆËøîÂõû</li><li>Â¶ÇÊûú‰∏ç‰∏ÄÊ†∑ÔºåËøõË°åÈáçËØïÔºåÈáçËØïÊ¨°Êï∞Ë∂ÖËøá 3ÔºåÂ∞ÜÊâÄÊúâ segment ÈîÅ‰ΩèÔºåÈáçÊñ∞ËÆ°ÁÆó‰∏™Êï∞ËøîÂõû</li></ul><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">size</span><span style="color:#e1e4e8">() {</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#6a737d">// Try a few times to get accurate count. On failure due to</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#6a737d">// continuous async changes in table, resort to locking.</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">final</span><span style="color:#e1e4e8"> Segment&lt;</span><span style="color:#f97583">K</span><span style="color:#e1e4e8">,</span><span style="color:#f97583">V</span><span style="color:#e1e4e8">&gt;[] segments </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">this</span><span style="color:#e1e4e8">.segments;</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> size;</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">boolean</span><span style="color:#e1e4e8"> overflow; </span><span style="color:#6a737d">// true if size overflows 32 bits</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">long</span><span style="color:#e1e4e8"> sum; </span><span style="color:#6a737d">// sum of modCounts</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">long</span><span style="color:#e1e4e8"> last </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">0L</span><span style="color:#e1e4e8">; </span><span style="color:#6a737d">// previous sum</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> retries </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">-</span><span style="color:#79b8ff">1</span><span style="color:#e1e4e8">; </span><span style="color:#6a737d">// first iteration isn't retry</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">try</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">for</span><span style="color:#e1e4e8"> (;;) {</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (retries</span><span style="color:#f97583">++</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">==</span><span style="color:#e1e4e8"> RETRIES_BEFORE_LOCK) {</span></span>
<span class="line"><span style="color:#e1e4e8">                    </span><span style="color:#6a737d">// Ë∂ÖËøáÈáçËØïÊ¨°Êï∞, ÈúÄË¶ÅÂàõÂª∫ÊâÄÊúâ segment Âπ∂Âä†ÈîÅ</span></span>
<span class="line"><span style="color:#e1e4e8">                    </span><span style="color:#f97583">for</span><span style="color:#e1e4e8"> (</span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> j </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8">; j </span><span style="color:#f97583">&lt;</span><span style="color:#e1e4e8"> segments.length; </span><span style="color:#f97583">++</span><span style="color:#e1e4e8">j)</span></span>
<span class="line"><span style="color:#e1e4e8">                        </span><span style="color:#b392f0">ensureSegment</span><span style="color:#e1e4e8">(j).</span><span style="color:#b392f0">lock</span><span style="color:#e1e4e8">(); </span><span style="color:#6a737d">// force creation</span></span>
<span class="line"><span style="color:#e1e4e8">                }</span></span>
<span class="line"><span style="color:#e1e4e8">                sum </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">0L</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">                size </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">                overflow </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">false</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#f97583">for</span><span style="color:#e1e4e8"> (</span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> j </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8">; j </span><span style="color:#f97583">&lt;</span><span style="color:#e1e4e8"> segments.length; </span><span style="color:#f97583">++</span><span style="color:#e1e4e8">j) {</span></span>
<span class="line"><span style="color:#e1e4e8">                    Segment&lt;</span><span style="color:#f97583">K</span><span style="color:#e1e4e8">,</span><span style="color:#f97583">V</span><span style="color:#e1e4e8">&gt; seg </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">segmentAt</span><span style="color:#e1e4e8">(segments, j);</span></span>
<span class="line"><span style="color:#e1e4e8">                    </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (seg </span><span style="color:#f97583">!=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">                        sum </span><span style="color:#f97583">+=</span><span style="color:#e1e4e8"> seg.modCount;</span></span>
<span class="line"><span style="color:#e1e4e8">                        </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> c </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> seg.count;</span></span>
<span class="line"><span style="color:#e1e4e8">                        </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (c </span><span style="color:#f97583">&lt;</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">||</span><span style="color:#e1e4e8"> (size </span><span style="color:#f97583">+=</span><span style="color:#e1e4e8"> c) </span><span style="color:#f97583">&lt;</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8">)</span></span>
<span class="line"><span style="color:#e1e4e8">                            overflow </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">true</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">                    }</span></span>
<span class="line"><span style="color:#e1e4e8">                }</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (sum </span><span style="color:#f97583">==</span><span style="color:#e1e4e8"> last)</span></span>
<span class="line"><span style="color:#e1e4e8">                    </span><span style="color:#f97583">break</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">                last </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> sum;</span></span>
<span class="line"><span style="color:#e1e4e8">            }</span></span>
<span class="line"><span style="color:#e1e4e8">        } </span><span style="color:#f97583">finally</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (retries </span><span style="color:#f97583">&gt;</span><span style="color:#e1e4e8"> RETRIES_BEFORE_LOCK) {</span></span>
<span class="line"><span style="color:#e1e4e8">                </span><span style="color:#f97583">for</span><span style="color:#e1e4e8"> (</span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> j </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8">; j </span><span style="color:#f97583">&lt;</span><span style="color:#e1e4e8"> segments.length; </span><span style="color:#f97583">++</span><span style="color:#e1e4e8">j)</span></span>
<span class="line"><span style="color:#e1e4e8">                    </span><span style="color:#b392f0">segmentAt</span><span style="color:#e1e4e8">(segments, j).</span><span style="color:#b392f0">unlock</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">            }</span></span>
<span class="line"><span style="color:#e1e4e8">        }</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> overflow </span><span style="color:#f97583">?</span><span style="color:#e1e4e8"> Integer.MAX_VALUE </span><span style="color:#f97583">:</span><span style="color:#e1e4e8"> size;</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">int</span><span style="color:#24292e"> </span><span style="color:#6f42c1">size</span><span style="color:#24292e">() {</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6a737d">// Try a few times to get accurate count. On failure due to</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6a737d">// continuous async changes in table, resort to locking.</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">final</span><span style="color:#24292e"> Segment&lt;</span><span style="color:#d73a49">K</span><span style="color:#24292e">,</span><span style="color:#d73a49">V</span><span style="color:#24292e">&gt;[] segments </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#005cc5">this</span><span style="color:#24292e">.segments;</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">int</span><span style="color:#24292e"> size;</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">boolean</span><span style="color:#24292e"> overflow; </span><span style="color:#6a737d">// true if size overflows 32 bits</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">long</span><span style="color:#24292e"> sum; </span><span style="color:#6a737d">// sum of modCounts</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">long</span><span style="color:#24292e"> last </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#005cc5">0L</span><span style="color:#24292e">; </span><span style="color:#6a737d">// previous sum</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">int</span><span style="color:#24292e"> retries </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#d73a49">-</span><span style="color:#005cc5">1</span><span style="color:#24292e">; </span><span style="color:#6a737d">// first iteration isn't retry</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">try</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">for</span><span style="color:#24292e"> (;;) {</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (retries</span><span style="color:#d73a49">++</span><span style="color:#24292e"> </span><span style="color:#d73a49">==</span><span style="color:#24292e"> RETRIES_BEFORE_LOCK) {</span></span>
<span class="line"><span style="color:#24292e">                    </span><span style="color:#6a737d">// Ë∂ÖËøáÈáçËØïÊ¨°Êï∞, ÈúÄË¶ÅÂàõÂª∫ÊâÄÊúâ segment Âπ∂Âä†ÈîÅ</span></span>
<span class="line"><span style="color:#24292e">                    </span><span style="color:#d73a49">for</span><span style="color:#24292e"> (</span><span style="color:#d73a49">int</span><span style="color:#24292e"> j </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#005cc5">0</span><span style="color:#24292e">; j </span><span style="color:#d73a49">&lt;</span><span style="color:#24292e"> segments.length; </span><span style="color:#d73a49">++</span><span style="color:#24292e">j)</span></span>
<span class="line"><span style="color:#24292e">                        </span><span style="color:#6f42c1">ensureSegment</span><span style="color:#24292e">(j).</span><span style="color:#6f42c1">lock</span><span style="color:#24292e">(); </span><span style="color:#6a737d">// force creation</span></span>
<span class="line"><span style="color:#24292e">                }</span></span>
<span class="line"><span style="color:#24292e">                sum </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#005cc5">0L</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">                size </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#005cc5">0</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">                overflow </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#005cc5">false</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#d73a49">for</span><span style="color:#24292e"> (</span><span style="color:#d73a49">int</span><span style="color:#24292e"> j </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#005cc5">0</span><span style="color:#24292e">; j </span><span style="color:#d73a49">&lt;</span><span style="color:#24292e"> segments.length; </span><span style="color:#d73a49">++</span><span style="color:#24292e">j) {</span></span>
<span class="line"><span style="color:#24292e">                    Segment&lt;</span><span style="color:#d73a49">K</span><span style="color:#24292e">,</span><span style="color:#d73a49">V</span><span style="color:#24292e">&gt; seg </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#6f42c1">segmentAt</span><span style="color:#24292e">(segments, j);</span></span>
<span class="line"><span style="color:#24292e">                    </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (seg </span><span style="color:#d73a49">!=</span><span style="color:#24292e"> </span><span style="color:#005cc5">null</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">                        sum </span><span style="color:#d73a49">+=</span><span style="color:#24292e"> seg.modCount;</span></span>
<span class="line"><span style="color:#24292e">                        </span><span style="color:#d73a49">int</span><span style="color:#24292e"> c </span><span style="color:#d73a49">=</span><span style="color:#24292e"> seg.count;</span></span>
<span class="line"><span style="color:#24292e">                        </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (c </span><span style="color:#d73a49">&lt;</span><span style="color:#24292e"> </span><span style="color:#005cc5">0</span><span style="color:#24292e"> </span><span style="color:#d73a49">||</span><span style="color:#24292e"> (size </span><span style="color:#d73a49">+=</span><span style="color:#24292e"> c) </span><span style="color:#d73a49">&lt;</span><span style="color:#24292e"> </span><span style="color:#005cc5">0</span><span style="color:#24292e">)</span></span>
<span class="line"><span style="color:#24292e">                            overflow </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#005cc5">true</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">                    }</span></span>
<span class="line"><span style="color:#24292e">                }</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (sum </span><span style="color:#d73a49">==</span><span style="color:#24292e"> last)</span></span>
<span class="line"><span style="color:#24292e">                    </span><span style="color:#d73a49">break</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">                last </span><span style="color:#d73a49">=</span><span style="color:#24292e"> sum;</span></span>
<span class="line"><span style="color:#24292e">            }</span></span>
<span class="line"><span style="color:#24292e">        } </span><span style="color:#d73a49">finally</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (retries </span><span style="color:#d73a49">&gt;</span><span style="color:#24292e"> RETRIES_BEFORE_LOCK) {</span></span>
<span class="line"><span style="color:#24292e">                </span><span style="color:#d73a49">for</span><span style="color:#24292e"> (</span><span style="color:#d73a49">int</span><span style="color:#24292e"> j </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#005cc5">0</span><span style="color:#24292e">; j </span><span style="color:#d73a49">&lt;</span><span style="color:#24292e"> segments.length; </span><span style="color:#d73a49">++</span><span style="color:#24292e">j)</span></span>
<span class="line"><span style="color:#24292e">                    </span><span style="color:#6f42c1">segmentAt</span><span style="color:#24292e">(segments, j).</span><span style="color:#6f42c1">unlock</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">            }</span></span>
<span class="line"><span style="color:#24292e">        }</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">return</span><span style="color:#24292e"> overflow </span><span style="color:#d73a49">?</span><span style="color:#24292e"> Integer.MAX_VALUE </span><span style="color:#d73a49">:</span><span style="color:#24292e"> size;</span></span>
<span class="line"><span style="color:#24292e">    }</span></span></code></pre></div><blockquote><p>È¶ñÂÖàÈÅçÂéÜÊâÄÊúâÁöÑsegmentÔºåÂè™Ë¶Åsegment‰∏ç‰∏∫Á©∫Â∞±ËøõË°å‰∏Ä‰∏™ËÆ°Êï∞ÔºåÁªüËÆ°segmentÂÜÖ‰øÆÊîπÁöÑÊ¨°Êï∞Ôºàput/removeÔºâÂíåÂÖÉÁ¥†‰∏™Êï∞</p><p><code>c &lt; 0 || (size += c) &lt; 0</code>Ë°®Á§∫ÂÖÉÁ¥†‰∏™Êï∞Ë∂ÖÂá∫ÊúÄÂ§ßËåÉÂõ¥ÂØºËá¥Ê∫¢Âá∫ÔºåÂç≥ÁªüËÆ°Â§±Ë¥•</p><p>Â∞ÜÂÖÉÁ¥†‰∏™Êï∞Âä†Âà∞sizeÁî±sumÂèòÈáè‰øùËØÅÔºåÂè™Ë¶ÅÂâç‰∏ÄÊ¨°ÁöÑ‰øÆÊîπÊ¨°Êï∞ÂíåËøô‰∏ÄÊ¨°ÁöÑ‰øÆÊîπÊ¨°Êï∞‰∏ÄËá¥ËØ¥ÊòéÊ≤°ÊúâÂÖ∂‰ªñÁ∫øÁ®ãÂπ≤Êâ∞ÔºåÂàô‰ªªÂä°Ëøô‰∏™ËÆ°Êï∞ÊòØÂáÜÁ°ÆÁöÑÔºåÈÄÄÂá∫Âæ™ÁéØÔºõËã•‰∏ç‰∏ÄËá¥ÔºåÂàôÈáçËØï3Ê¨°Êù•Ê∑ªÂä†sizeËÆ°Êï∞ÔºåË∂ÖËøáÈáçËØïÊ¨°Êï∞ÔºåÂàôÈîÅ‰ΩèÊâÄÊúâÁöÑsegmentÔºåÂÜçÈáçÊñ∞ËÆ°Êï∞ÔºåËøôÊ¨°‰ºöÊØîËæÉÂáÜÁ°ÆÔºåËÆ°Êï∞ÂÆåÊàêÈÅçÂéÜsegmentËøõË°åËß£ÈîÅ</p></blockquote><h3 id="_9„ÄÅlinkedblockingqueue-ÂéüÁêÜ" tabindex="-1">9„ÄÅLinkedBlockingQueue ÂéüÁêÜ <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20advanced%20chapter#_9„ÄÅlinkedblockingqueue-ÂéüÁêÜ" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h3><h4 id="Âü∫Êú¨ÁöÑÂÖ•ÈòüÂá∫Èòü" tabindex="-1">Âü∫Êú¨ÁöÑÂÖ•ÈòüÂá∫Èòü <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20advanced%20chapter#Âü∫Êú¨ÁöÑÂÖ•ÈòüÂá∫Èòü" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h4><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">class</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">LinkedBlockingQueue</span><span style="color:#e1e4e8">&lt;</span><span style="color:#f97583">E</span><span style="color:#e1e4e8">&gt; </span><span style="color:#f97583">extends</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">AbstractQueue</span><span style="color:#e1e4e8">&lt;</span><span style="color:#f97583">E</span><span style="color:#e1e4e8">&gt; </span><span style="color:#f97583">implements</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">BlockingQueue</span><span style="color:#e1e4e8">&lt;</span><span style="color:#f97583">E</span><span style="color:#e1e4e8">&gt;, java.io.</span><span style="color:#b392f0">Serializable</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">static</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">class</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Node</span><span style="color:#e1e4e8">&lt;</span><span style="color:#f97583">E</span><span style="color:#e1e4e8">&gt; {</span></span>
<span class="line"><span style="color:#e1e4e8">        E item;</span></span>
<span class="line"><span style="color:#6a737d">        /**</span></span>
<span class="line"><span style="color:#6a737d">        * ‰∏ãÂàó‰∏âÁßçÊÉÖÂÜµ‰πã‰∏Ä</span></span>
<span class="line"><span style="color:#6a737d">        * - ÁúüÊ≠£ÁöÑÂêéÁªßËäÇÁÇπ</span></span>
<span class="line"><span style="color:#6a737d">        * - Ëá™Â∑±, ÂèëÁîüÂú®Âá∫ÈòüÊó∂</span></span>
<span class="line"><span style="color:#6a737d">        * - null, Ë°®Á§∫ÊòØÊ≤°ÊúâÂêéÁªßËäÇÁÇπ, ÊòØÊúÄÂêé‰∫Ü</span></span>
<span class="line"><span style="color:#6a737d">        */</span></span>
<span class="line"><span style="color:#e1e4e8">        Node&lt;</span><span style="color:#f97583">E</span><span style="color:#e1e4e8">&gt; next;</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#b392f0">Node</span><span style="color:#e1e4e8">(E </span><span style="color:#ffab70">x</span><span style="color:#e1e4e8">) { item </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> x; }</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"><span style="color:#e1e4e8">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">class</span><span style="color:#24292e"> </span><span style="color:#6f42c1">LinkedBlockingQueue</span><span style="color:#24292e">&lt;</span><span style="color:#d73a49">E</span><span style="color:#24292e">&gt; </span><span style="color:#d73a49">extends</span><span style="color:#24292e"> </span><span style="color:#6f42c1">AbstractQueue</span><span style="color:#24292e">&lt;</span><span style="color:#d73a49">E</span><span style="color:#24292e">&gt; </span><span style="color:#d73a49">implements</span><span style="color:#24292e"> </span><span style="color:#6f42c1">BlockingQueue</span><span style="color:#24292e">&lt;</span><span style="color:#d73a49">E</span><span style="color:#24292e">&gt;, java.io.</span><span style="color:#6f42c1">Serializable</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">static</span><span style="color:#24292e"> </span><span style="color:#d73a49">class</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Node</span><span style="color:#24292e">&lt;</span><span style="color:#d73a49">E</span><span style="color:#24292e">&gt; {</span></span>
<span class="line"><span style="color:#24292e">        E item;</span></span>
<span class="line"><span style="color:#6a737d">        /**</span></span>
<span class="line"><span style="color:#6a737d">        * ‰∏ãÂàó‰∏âÁßçÊÉÖÂÜµ‰πã‰∏Ä</span></span>
<span class="line"><span style="color:#6a737d">        * - ÁúüÊ≠£ÁöÑÂêéÁªßËäÇÁÇπ</span></span>
<span class="line"><span style="color:#6a737d">        * - Ëá™Â∑±, ÂèëÁîüÂú®Âá∫ÈòüÊó∂</span></span>
<span class="line"><span style="color:#6a737d">        * - null, Ë°®Á§∫ÊòØÊ≤°ÊúâÂêéÁªßËäÇÁÇπ, ÊòØÊúÄÂêé‰∫Ü</span></span>
<span class="line"><span style="color:#6a737d">        */</span></span>
<span class="line"><span style="color:#24292e">        Node&lt;</span><span style="color:#d73a49">E</span><span style="color:#24292e">&gt; next;</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6f42c1">Node</span><span style="color:#24292e">(E </span><span style="color:#e36209">x</span><span style="color:#24292e">) { item </span><span style="color:#d73a49">=</span><span style="color:#24292e"> x; }</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"><span style="color:#24292e">}</span></span></code></pre></div><p>ÂàùÂßãÂåñÈìæË°® <code>last = head = new Node&lt;E&gt;(null);</code>=&gt; <code>last = new Node&lt;E&gt;(null);head = new Node&lt;E&gt;(null);</code>Dummy ËäÇÁÇπÁî®Êù•Âç†‰ΩçÔºåitem ‰∏∫ null</p><figure><img src="https://jsd.cdn.zzko.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230720202031710.png" alt="image-20230720202031710" loading="lazy" decoding="async"></figure><p>ÂΩì‰∏Ä‰∏™ËäÇÁÇπÂÖ•Èòü <code>last = last.next = node;</code>=&gt; <code>last.next = node;last = node;</code></p><figure><img src="https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230720202045345.png" alt="image-20230720202045345" loading="lazy" decoding="async"></figure><p>ÂÜçÊù•‰∏Ä‰∏™ËäÇÁÇπÂÖ•Èòü <code>last = last.next = node;</code></p><figure><img src="https://jsd.cdn.zzko.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230720202116388.png" alt="image-20230720202116388" loading="lazy" decoding="async"></figure><p>Âá∫Èòü</p><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8">Node&lt;</span><span style="color:#f97583">E</span><span style="color:#e1e4e8">&gt; h </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> head;</span></span>
<span class="line"><span style="color:#e1e4e8">Node&lt;</span><span style="color:#f97583">E</span><span style="color:#e1e4e8">&gt; first </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> h.next;</span></span>
<span class="line"><span style="color:#e1e4e8">h.next </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> h; </span><span style="color:#6a737d">// help GC</span></span>
<span class="line"><span style="color:#e1e4e8">head </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> first;</span></span>
<span class="line"><span style="color:#e1e4e8">E x </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> first.item;</span></span>
<span class="line"><span style="color:#e1e4e8">first.item </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#f97583">return</span><span style="color:#e1e4e8"> x;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e">Node&lt;</span><span style="color:#d73a49">E</span><span style="color:#24292e">&gt; h </span><span style="color:#d73a49">=</span><span style="color:#24292e"> head;</span></span>
<span class="line"><span style="color:#24292e">Node&lt;</span><span style="color:#d73a49">E</span><span style="color:#24292e">&gt; first </span><span style="color:#d73a49">=</span><span style="color:#24292e"> h.next;</span></span>
<span class="line"><span style="color:#24292e">h.next </span><span style="color:#d73a49">=</span><span style="color:#24292e"> h; </span><span style="color:#6a737d">// help GC</span></span>
<span class="line"><span style="color:#24292e">head </span><span style="color:#d73a49">=</span><span style="color:#24292e"> first;</span></span>
<span class="line"><span style="color:#24292e">E x </span><span style="color:#d73a49">=</span><span style="color:#24292e"> first.item;</span></span>
<span class="line"><span style="color:#24292e">first.item </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#005cc5">null</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#d73a49">return</span><span style="color:#24292e"> x;</span></span></code></pre></div><p>h = head</p><figure><img src="https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230720202154330.png" alt="image-20230720202154330" loading="lazy" decoding="async"></figure><p>first = h.next</p><figure><img src="https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230720202208218.png" alt="image-20230720202208218" loading="lazy" decoding="async"></figure><p>h.next = h</p><figure><img src="https://jsd.cdn.zzko.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230720202219603.png" alt="image-20230720202219603" loading="lazy" decoding="async"></figure><p>head = first</p><figure><img src="https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230720202231300.png" alt="image-20230720202231300" loading="lazy" decoding="async"></figure><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8">E x </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> first.item;</span></span>
<span class="line"><span style="color:#e1e4e8">first.item </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#f97583">return</span><span style="color:#e1e4e8"> x;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e">E x </span><span style="color:#d73a49">=</span><span style="color:#24292e"> first.item;</span></span>
<span class="line"><span style="color:#24292e">first.item </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#005cc5">null</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#d73a49">return</span><span style="color:#24292e"> x;</span></span></code></pre></div><figure><img src="https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230720202247035.png" alt="image-20230720202247035" loading="lazy" decoding="async"></figure><h4 id="Âä†ÈîÅÂàÜÊûê" tabindex="-1">Âä†ÈîÅÂàÜÊûê <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20advanced%20chapter#Âä†ÈîÅÂàÜÊûê" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h4><p>==È´òÊòé‰πãÂ§Ñ==Âú®‰∫éÁî®‰∫Ü‰∏§ÊääÈîÅÂíå dummy ËäÇÁÇπ</p><ul><li>Áî®‰∏ÄÊääÈîÅÔºåÂêå‰∏ÄÊó∂ÂàªÔºåÊúÄÂ§öÂè™ÂÖÅËÆ∏Êúâ‰∏Ä‰∏™Á∫øÁ®ãÔºàÁîü‰∫ßËÄÖÊàñÊ∂àË¥πËÄÖÔºå‰∫åÈÄâ‰∏ÄÔºâÊâßË°å</li><li>Áî®‰∏§ÊääÈîÅÔºåÂêå‰∏ÄÊó∂ÂàªÔºåÂèØ‰ª•ÂÖÅËÆ∏‰∏§‰∏™Á∫øÁ®ãÂêåÊó∂Ôºà‰∏Ä‰∏™Áîü‰∫ßËÄÖ‰∏é‰∏Ä‰∏™Ê∂àË¥πËÄÖÔºâÊâßË°å<ul><li>Ê∂àË¥πËÄÖ‰∏éÊ∂àË¥πËÄÖÁ∫øÁ®ã‰ªçÁÑ∂‰∏≤Ë°å</li><li>Áîü‰∫ßËÄÖ‰∏éÁîü‰∫ßËÄÖÁ∫øÁ®ã‰ªçÁÑ∂‰∏≤Ë°å</li></ul></li></ul><p>Á∫øÁ®ãÂÆâÂÖ®ÂàÜÊûê</p><ul><li>ÂΩìËäÇÁÇπÊÄªÊï∞Â§ß‰∫é 2 Êó∂ÔºàÂåÖÊã¨ dummy ËäÇÁÇπÔºâÔºåputLock ‰øùËØÅÁöÑÊòØ last ËäÇÁÇπÁöÑÁ∫øÁ®ãÂÆâÂÖ®ÔºåtakeLock ‰øùËØÅÁöÑÊòØhead ËäÇÁÇπÁöÑÁ∫øÁ®ãÂÆâÂÖ®„ÄÇ‰∏§ÊääÈîÅ‰øùËØÅ‰∫ÜÂÖ•ÈòüÂíåÂá∫ÈòüÊ≤°ÊúâÁ´û‰∫â</li><li>ÂΩìËäÇÁÇπÊÄªÊï∞Á≠â‰∫é 2 Êó∂ÔºàÂç≥‰∏Ä‰∏™ dummy ËäÇÁÇπÔºå‰∏Ä‰∏™Ê≠£Â∏∏ËäÇÁÇπÔºâËøôÊó∂ÂÄôÔºå‰ªçÁÑ∂ÊòØ‰∏§ÊääÈîÅÈîÅ‰∏§‰∏™ÂØπË±°Ôºå‰∏ç‰ºöÁ´û‰∫â</li><li>ÂΩìËäÇÁÇπÊÄªÊï∞Á≠â‰∫é 1 Êó∂ÔºàÂ∞±‰∏Ä‰∏™ dummy ËäÇÁÇπÔºâËøôÊó∂ take Á∫øÁ®ã‰ºöË¢´ notEmpty Êù°‰ª∂ÈòªÂ°ûÔºåÊúâÁ´û‰∫âÔºå‰ºöÈòªÂ°û</li></ul><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6a737d">// Áî®‰∫é put(ÈòªÂ°û) offer(ÈùûÈòªÂ°û)</span></span>
<span class="line"><span style="color:#f97583">private</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">final</span><span style="color:#e1e4e8"> ReentrantLock putLock </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">ReentrantLock</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#6a737d">// Áî®Êà∑ take(ÈòªÂ°û) poll(ÈùûÈòªÂ°û)</span></span>
<span class="line"><span style="color:#f97583">private</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">final</span><span style="color:#e1e4e8"> ReentrantLock takeLock </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">ReentrantLock</span><span style="color:#e1e4e8">();</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6a737d">// Áî®‰∫é put(ÈòªÂ°û) offer(ÈùûÈòªÂ°û)</span></span>
<span class="line"><span style="color:#d73a49">private</span><span style="color:#24292e"> </span><span style="color:#d73a49">final</span><span style="color:#24292e"> ReentrantLock putLock </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">ReentrantLock</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#6a737d">// Áî®Êà∑ take(ÈòªÂ°û) poll(ÈùûÈòªÂ°û)</span></span>
<span class="line"><span style="color:#d73a49">private</span><span style="color:#24292e"> </span><span style="color:#d73a49">final</span><span style="color:#24292e"> ReentrantLock takeLock </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">ReentrantLock</span><span style="color:#24292e">();</span></span></code></pre></div><p>put Êìç‰Ωú</p><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">void</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">put</span><span style="color:#e1e4e8">(E e) throws InterruptedException {</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (e </span><span style="color:#f97583">==</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">null</span><span style="color:#e1e4e8">) </span><span style="color:#f97583">throw</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">NullPointerException</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> c </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">-</span><span style="color:#79b8ff">1</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">        Node&lt;</span><span style="color:#f97583">E</span><span style="color:#e1e4e8">&gt; node </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> Node&lt;</span><span style="color:#f97583">E</span><span style="color:#e1e4e8">&gt;(e);</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">final</span><span style="color:#e1e4e8"> ReentrantLock putLock </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">this</span><span style="color:#e1e4e8">.putLock;</span></span>
<span class="line"><span style="color:#e1e4e8">		</span><span style="color:#6a737d">// count Áî®Êù•Áª¥Êä§ÂÖÉÁ¥†ËÆ°Êï∞</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">final</span><span style="color:#e1e4e8"> AtomicInteger count </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">this</span><span style="color:#e1e4e8">.count;</span></span>
<span class="line"><span style="color:#e1e4e8">        putLock.</span><span style="color:#b392f0">lockInterruptibly</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">try</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">			</span><span style="color:#6a737d">// Êª°‰∫ÜÁ≠âÂæÖ</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">while</span><span style="color:#e1e4e8"> (count.</span><span style="color:#b392f0">get</span><span style="color:#e1e4e8">() </span><span style="color:#f97583">==</span><span style="color:#e1e4e8"> capacity) {</span></span>
<span class="line"><span style="color:#e1e4e8">				</span><span style="color:#6a737d">// ÂÄíËøáÊù•ËØªÂ∞±Â•Ω: Á≠âÂæÖ notFull</span></span>
<span class="line"><span style="color:#e1e4e8">                notFull.</span><span style="color:#b392f0">await</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">            }</span></span>
<span class="line"><span style="color:#e1e4e8">			</span><span style="color:#6a737d">// ÊúâÁ©∫‰Ωç, ÂÖ•Èòü‰∏îËÆ°Êï∞Âä†‰∏Ä</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#b392f0">enqueue</span><span style="color:#e1e4e8">(node);</span></span>
<span class="line"><span style="color:#e1e4e8">            c </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> count.</span><span style="color:#b392f0">getAndIncrement</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">			</span><span style="color:#6a737d">// Èô§‰∫ÜËá™Â∑± put ‰ª•Â§ñ, ÈòüÂàóËøòÊúâÁ©∫‰Ωç, Áî±Ëá™Â∑±Âè´ÈÜíÂÖ∂‰ªñ put Á∫øÁ®ã</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (c </span><span style="color:#f97583">+</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">1</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">&lt;</span><span style="color:#e1e4e8"> capacity)</span></span>
<span class="line"><span style="color:#e1e4e8">                notFull.</span><span style="color:#b392f0">signal</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">        } </span><span style="color:#f97583">finally</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">            putLock.</span><span style="color:#b392f0">unlock</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">        }</span></span>
<span class="line"><span style="color:#e1e4e8">		</span><span style="color:#6a737d">// Â¶ÇÊûúÈòüÂàó‰∏≠Êúâ‰∏Ä‰∏™ÂÖÉÁ¥†, Âè´ÈÜí take Á∫øÁ®ã</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (c </span><span style="color:#f97583">==</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8">)</span></span>
<span class="line"><span style="color:#e1e4e8">			</span><span style="color:#6a737d">// ËøôÈáåË∞ÉÁî®ÁöÑÊòØ notEmpty.signal() ËÄå‰∏çÊòØ notEmpty.signalAll() ÊòØ‰∏∫‰∫ÜÂáèÂ∞ëÁ´û‰∫â</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#b392f0">signalNotEmpty</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">void</span><span style="color:#24292e"> </span><span style="color:#6f42c1">put</span><span style="color:#24292e">(E e) throws InterruptedException {</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (e </span><span style="color:#d73a49">==</span><span style="color:#24292e"> </span><span style="color:#005cc5">null</span><span style="color:#24292e">) </span><span style="color:#d73a49">throw</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">NullPointerException</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">int</span><span style="color:#24292e"> c </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#d73a49">-</span><span style="color:#005cc5">1</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">        Node&lt;</span><span style="color:#d73a49">E</span><span style="color:#24292e">&gt; node </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> Node&lt;</span><span style="color:#d73a49">E</span><span style="color:#24292e">&gt;(e);</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">final</span><span style="color:#24292e"> ReentrantLock putLock </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#005cc5">this</span><span style="color:#24292e">.putLock;</span></span>
<span class="line"><span style="color:#24292e">		</span><span style="color:#6a737d">// count Áî®Êù•Áª¥Êä§ÂÖÉÁ¥†ËÆ°Êï∞</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">final</span><span style="color:#24292e"> AtomicInteger count </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#005cc5">this</span><span style="color:#24292e">.count;</span></span>
<span class="line"><span style="color:#24292e">        putLock.</span><span style="color:#6f42c1">lockInterruptibly</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">try</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">			</span><span style="color:#6a737d">// Êª°‰∫ÜÁ≠âÂæÖ</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">while</span><span style="color:#24292e"> (count.</span><span style="color:#6f42c1">get</span><span style="color:#24292e">() </span><span style="color:#d73a49">==</span><span style="color:#24292e"> capacity) {</span></span>
<span class="line"><span style="color:#24292e">				</span><span style="color:#6a737d">// ÂÄíËøáÊù•ËØªÂ∞±Â•Ω: Á≠âÂæÖ notFull</span></span>
<span class="line"><span style="color:#24292e">                notFull.</span><span style="color:#6f42c1">await</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">            }</span></span>
<span class="line"><span style="color:#24292e">			</span><span style="color:#6a737d">// ÊúâÁ©∫‰Ωç, ÂÖ•Èòü‰∏îËÆ°Êï∞Âä†‰∏Ä</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#6f42c1">enqueue</span><span style="color:#24292e">(node);</span></span>
<span class="line"><span style="color:#24292e">            c </span><span style="color:#d73a49">=</span><span style="color:#24292e"> count.</span><span style="color:#6f42c1">getAndIncrement</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">			</span><span style="color:#6a737d">// Èô§‰∫ÜËá™Â∑± put ‰ª•Â§ñ, ÈòüÂàóËøòÊúâÁ©∫‰Ωç, Áî±Ëá™Â∑±Âè´ÈÜíÂÖ∂‰ªñ put Á∫øÁ®ã</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (c </span><span style="color:#d73a49">+</span><span style="color:#24292e"> </span><span style="color:#005cc5">1</span><span style="color:#24292e"> </span><span style="color:#d73a49">&lt;</span><span style="color:#24292e"> capacity)</span></span>
<span class="line"><span style="color:#24292e">                notFull.</span><span style="color:#6f42c1">signal</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">        } </span><span style="color:#d73a49">finally</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">            putLock.</span><span style="color:#6f42c1">unlock</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">        }</span></span>
<span class="line"><span style="color:#24292e">		</span><span style="color:#6a737d">// Â¶ÇÊûúÈòüÂàó‰∏≠Êúâ‰∏Ä‰∏™ÂÖÉÁ¥†, Âè´ÈÜí take Á∫øÁ®ã</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (c </span><span style="color:#d73a49">==</span><span style="color:#24292e"> </span><span style="color:#005cc5">0</span><span style="color:#24292e">)</span></span>
<span class="line"><span style="color:#24292e">			</span><span style="color:#6a737d">// ËøôÈáåË∞ÉÁî®ÁöÑÊòØ notEmpty.signal() ËÄå‰∏çÊòØ notEmpty.signalAll() ÊòØ‰∏∫‰∫ÜÂáèÂ∞ëÁ´û‰∫â</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#6f42c1">signalNotEmpty</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">    }</span></span></code></pre></div><p>take Êìç‰Ωú</p><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#f97583">public</span><span style="color:#e1e4e8"> E </span><span style="color:#b392f0">take</span><span style="color:#e1e4e8">() throws InterruptedException {</span></span>
<span class="line"><span style="color:#e1e4e8">    E x;</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> c </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">-</span><span style="color:#79b8ff">1</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">final</span><span style="color:#e1e4e8"> AtomicInteger count </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">this</span><span style="color:#e1e4e8">.count;</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">final</span><span style="color:#e1e4e8"> ReentrantLock takeLock </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">this</span><span style="color:#e1e4e8">.takeLock;</span></span>
<span class="line"><span style="color:#e1e4e8">    takeLock.</span><span style="color:#b392f0">lockInterruptibly</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">try</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#6a737d">//Á©∫Á≠âÂæÖ</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">while</span><span style="color:#e1e4e8"> (count.</span><span style="color:#b392f0">get</span><span style="color:#e1e4e8">() </span><span style="color:#f97583">==</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">            </span><span style="color:#6a737d">//Á≠âÂæÖ‰∏çÁ©∫</span></span>
<span class="line"><span style="color:#e1e4e8">        	notEmpty.</span><span style="color:#b392f0">await</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">        }</span></span>
<span class="line"><span style="color:#e1e4e8">        x </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">dequeue</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">        c </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> count.</span><span style="color:#b392f0">getAndDecrement</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (c </span><span style="color:#f97583">&gt;</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">1</span><span style="color:#e1e4e8">)</span></span>
<span class="line"><span style="color:#e1e4e8">        	notEmpty.</span><span style="color:#b392f0">signal</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">    } </span><span style="color:#f97583">finally</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">    	takeLock.</span><span style="color:#b392f0">unlock</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">// Â¶ÇÊûúÈòüÂàó‰∏≠Âè™Êúâ‰∏Ä‰∏™Á©∫‰ΩçÊó∂, Âè´ÈÜí put Á∫øÁ®ã</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">// Â¶ÇÊûúÊúâÂ§ö‰∏™Á∫øÁ®ãËøõË°åÂá∫Èòü, Á¨¨‰∏Ä‰∏™Á∫øÁ®ãÊª°Ë∂≥ c == capacity, ‰ΩÜÂêéÁª≠Á∫øÁ®ã c &lt; capacity</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (c </span><span style="color:#f97583">==</span><span style="color:#e1e4e8"> capacity)</span></span>
<span class="line"><span style="color:#e1e4e8">    	</span><span style="color:#6a737d">// ËøôÈáåË∞ÉÁî®ÁöÑÊòØ notFull.signal() ËÄå‰∏çÊòØ notFull.signalAll() ÊòØ‰∏∫‰∫ÜÂáèÂ∞ëÁ´û‰∫â</span></span>
<span class="line"><span style="color:#e1e4e8">    	</span><span style="color:#b392f0">signalNotFull</span><span style="color:#e1e4e8">()</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> x;</span></span>
<span class="line"><span style="color:#e1e4e8">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#d73a49">public</span><span style="color:#24292e"> E </span><span style="color:#6f42c1">take</span><span style="color:#24292e">() throws InterruptedException {</span></span>
<span class="line"><span style="color:#24292e">    E x;</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">int</span><span style="color:#24292e"> c </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#d73a49">-</span><span style="color:#005cc5">1</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">final</span><span style="color:#24292e"> AtomicInteger count </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#005cc5">this</span><span style="color:#24292e">.count;</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">final</span><span style="color:#24292e"> ReentrantLock takeLock </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#005cc5">this</span><span style="color:#24292e">.takeLock;</span></span>
<span class="line"><span style="color:#24292e">    takeLock.</span><span style="color:#6f42c1">lockInterruptibly</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">try</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6a737d">//Á©∫Á≠âÂæÖ</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">while</span><span style="color:#24292e"> (count.</span><span style="color:#6f42c1">get</span><span style="color:#24292e">() </span><span style="color:#d73a49">==</span><span style="color:#24292e"> </span><span style="color:#005cc5">0</span><span style="color:#24292e">) {</span></span>
<span class="line"><span style="color:#24292e">            </span><span style="color:#6a737d">//Á≠âÂæÖ‰∏çÁ©∫</span></span>
<span class="line"><span style="color:#24292e">        	notEmpty.</span><span style="color:#6f42c1">await</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">        }</span></span>
<span class="line"><span style="color:#24292e">        x </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#6f42c1">dequeue</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">        c </span><span style="color:#d73a49">=</span><span style="color:#24292e"> count.</span><span style="color:#6f42c1">getAndDecrement</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (c </span><span style="color:#d73a49">&gt;</span><span style="color:#24292e"> </span><span style="color:#005cc5">1</span><span style="color:#24292e">)</span></span>
<span class="line"><span style="color:#24292e">        	notEmpty.</span><span style="color:#6f42c1">signal</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">    } </span><span style="color:#d73a49">finally</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">    	takeLock.</span><span style="color:#6f42c1">unlock</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">// Â¶ÇÊûúÈòüÂàó‰∏≠Âè™Êúâ‰∏Ä‰∏™Á©∫‰ΩçÊó∂, Âè´ÈÜí put Á∫øÁ®ã</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">// Â¶ÇÊûúÊúâÂ§ö‰∏™Á∫øÁ®ãËøõË°åÂá∫Èòü, Á¨¨‰∏Ä‰∏™Á∫øÁ®ãÊª°Ë∂≥ c == capacity, ‰ΩÜÂêéÁª≠Á∫øÁ®ã c &lt; capacity</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">if</span><span style="color:#24292e"> (c </span><span style="color:#d73a49">==</span><span style="color:#24292e"> capacity)</span></span>
<span class="line"><span style="color:#24292e">    	</span><span style="color:#6a737d">// ËøôÈáåË∞ÉÁî®ÁöÑÊòØ notFull.signal() ËÄå‰∏çÊòØ notFull.signalAll() ÊòØ‰∏∫‰∫ÜÂáèÂ∞ëÁ´û‰∫â</span></span>
<span class="line"><span style="color:#24292e">    	</span><span style="color:#6f42c1">signalNotFull</span><span style="color:#24292e">()</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">return</span><span style="color:#24292e"> x;</span></span>
<span class="line"><span style="color:#24292e">}</span></span></code></pre></div><blockquote><p>Áî± put Âî§ÈÜí put ÊòØ‰∏∫‰∫ÜÈÅøÂÖç‰ø°Âè∑‰∏çË∂≥</p></blockquote><h4 id="ÊÄßËÉΩÊØîËæÉ" tabindex="-1">ÊÄßËÉΩÊØîËæÉ <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20advanced%20chapter#ÊÄßËÉΩÊØîËæÉ" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h4><p>‰∏ªË¶ÅÂàó‰∏æ LinkedBlockingQueue ‰∏é ArrayBlockingQueue ÁöÑÊÄßËÉΩÊØîËæÉ</p><ul><li>Linked ÊîØÊåÅÊúâÁïåÔºåArray Âº∫Âà∂ÊúâÁïå</li><li>Linked ÂÆûÁé∞ÊòØÈìæË°®ÔºåArray ÂÆûÁé∞ÊòØÊï∞ÁªÑ</li><li>Linked ÊòØÊáíÊÉ∞ÁöÑÔºåËÄå Array ÈúÄË¶ÅÊèêÂâçÂàùÂßãÂåñ Node Êï∞ÁªÑ</li><li>Linked ÊØèÊ¨°ÂÖ•Èòü‰ºöÁîüÊàêÊñ∞ NodeÔºåËÄå Array ÁöÑ Node ÊòØÊèêÂâçÂàõÂª∫Â•ΩÁöÑÔºàÂØπNodeÂØπË±°ÁöÑÈáçÁî®ÔºåÂáèÂ∞ëÂûÉÂúæÂõûÊî∂Ôºâ</li><li>Linked ‰∏§ÊääÈîÅÔºåArray ‰∏ÄÊääÈîÅÔºàÊÄßËÉΩ‰∏çÂ¶ÇLinkedÔºâ</li></ul><h3 id="_10„ÄÅconcurrentlinkedqueue" tabindex="-1">10„ÄÅConcurrentLinkedQueue <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20advanced%20chapter#_10„ÄÅconcurrentlinkedqueue" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h3><p>ConcurrentLinkedQueue ÁöÑËÆæËÆ°‰∏é LinkedBlockingQueue ÈùûÂ∏∏ÂÉèÔºå‰πüÊòØ</p><ul><li>‰∏§Êää„ÄêÈîÅ„ÄëÔºåÂêå‰∏ÄÊó∂ÂàªÔºåÂèØ‰ª•ÂÖÅËÆ∏‰∏§‰∏™Á∫øÁ®ãÂêåÊó∂Ôºà‰∏Ä‰∏™Áîü‰∫ßËÄÖ‰∏é‰∏Ä‰∏™Ê∂àË¥πËÄÖÔºâÊâßË°å</li><li>dummy ËäÇÁÇπÁöÑÂºïÂÖ•ËÆ©‰∏§Êää„ÄêÈîÅ„ÄëÂ∞ÜÊù•ÈîÅ‰ΩèÁöÑÊòØ‰∏çÂêåÂØπË±°ÔºåÈÅøÂÖçÁ´û‰∫â</li><li>Âè™ÊòØËøô„ÄêÈîÅ„Äë‰ΩøÁî®‰∫Ü cas Êù•ÂÆûÁé∞</li></ul><p>‰∫ãÂÆû‰∏äÔºåConcurrentLinkedQueue Â∫îÁî®ËøòÊòØÈùûÂ∏∏ÂπøÊ≥õÁöÑ ‰æãÂ¶Ç‰πãÂâçËÆ≤ÁöÑ Tomcat ÁöÑ Connector ÁªìÊûÑÊó∂ÔºåAcceptor ‰Ωú‰∏∫Áîü‰∫ßËÄÖÂêë Poller Ê∂àË¥πËÄÖ‰º†ÈÄí‰∫ã‰ª∂‰ø°ÊÅØÊó∂ÔºåÊ≠£ÊòØÈááÁî®‰∫ÜConcurrentLinkedQueue Â∞Ü SocketChannel Áªô Poller ‰ΩøÁî®</p><figure><img src="https://jsd.cdn.zzko.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230720205507789.png" alt="image-20230720205507789" loading="lazy" decoding="async"></figure><h3 id="_11„ÄÅcopyonwritearraylist" tabindex="-1">11„ÄÅCopyOnWriteArrayList <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20advanced%20chapter#_11„ÄÅcopyonwritearraylist" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h3><p>CopyOnWriteArraySet ÊòØÂÆÉÁöÑÈ©¨Áî≤ Â∫ïÂ±ÇÂÆûÁé∞ÈááÁî®‰∫Ü ÂÜôÂÖ•Êó∂Êã∑Ë¥ù ÁöÑÊÄùÊÉ≥ÔºåÂ¢ûÂà†ÊîπÊìç‰Ωú‰ºöÂ∞ÜÂ∫ïÂ±ÇÊï∞ÁªÑÊã∑Ë¥ù‰∏Ä‰ªΩÔºåÊõ¥ÊîπÊìç‰ΩúÂú®Êñ∞Êï∞ÁªÑ‰∏äÊâßË°åÔºåËøôÊó∂‰∏çÂΩ±ÂìçÂÖ∂ÂÆÉÁ∫øÁ®ãÁöÑÂπ∂ÂèëËØªÔºåËØªÂÜôÂàÜÁ¶ª„ÄÇ ‰ª•Êñ∞Â¢û‰∏∫‰æãÔºö</p><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">boolean</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">add</span><span style="color:#e1e4e8">(E e) {</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">synchronized</span><span style="color:#e1e4e8"> (lock) {</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#6a737d">// Ëé∑ÂèñÊóßÁöÑÊï∞ÁªÑ</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">Object</span><span style="color:#e1e4e8">[] es </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">getArray</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">int</span><span style="color:#e1e4e8"> len </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> es.length;</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#6a737d">// Êã∑Ë¥ùÊñ∞ÁöÑÊï∞ÁªÑÔºàËøôÈáåÊòØÊØîËæÉËÄóÊó∂ÁöÑÊìç‰ΩúÔºå‰ΩÜ‰∏çÂΩ±ÂìçÂÖ∂ÂÆÉËØªÁ∫øÁ®ãÔºâ</span></span>
<span class="line"><span style="color:#e1e4e8">        es </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> Arrays.</span><span style="color:#b392f0">copyOf</span><span style="color:#e1e4e8">(es, len </span><span style="color:#f97583">+</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">1</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#6a737d">// Ê∑ªÂä†Êñ∞ÂÖÉÁ¥†</span></span>
<span class="line"><span style="color:#e1e4e8">        es[len] </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> e;</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#6a737d">// ÊõøÊç¢ÊóßÁöÑÊï∞ÁªÑ</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#b392f0">setArray</span><span style="color:#e1e4e8">(es);</span></span>
<span class="line"><span style="color:#e1e4e8">        </span><span style="color:#f97583">return</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">true</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"><span style="color:#e1e4e8">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">boolean</span><span style="color:#24292e"> </span><span style="color:#6f42c1">add</span><span style="color:#24292e">(E e) {</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">synchronized</span><span style="color:#24292e"> (lock) {</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6a737d">// Ëé∑ÂèñÊóßÁöÑÊï∞ÁªÑ</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">Object</span><span style="color:#24292e">[] es </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#6f42c1">getArray</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">int</span><span style="color:#24292e"> len </span><span style="color:#d73a49">=</span><span style="color:#24292e"> es.length;</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6a737d">// Êã∑Ë¥ùÊñ∞ÁöÑÊï∞ÁªÑÔºàËøôÈáåÊòØÊØîËæÉËÄóÊó∂ÁöÑÊìç‰ΩúÔºå‰ΩÜ‰∏çÂΩ±ÂìçÂÖ∂ÂÆÉËØªÁ∫øÁ®ãÔºâ</span></span>
<span class="line"><span style="color:#24292e">        es </span><span style="color:#d73a49">=</span><span style="color:#24292e"> Arrays.</span><span style="color:#6f42c1">copyOf</span><span style="color:#24292e">(es, len </span><span style="color:#d73a49">+</span><span style="color:#24292e"> </span><span style="color:#005cc5">1</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6a737d">// Ê∑ªÂä†Êñ∞ÂÖÉÁ¥†</span></span>
<span class="line"><span style="color:#24292e">        es[len] </span><span style="color:#d73a49">=</span><span style="color:#24292e"> e;</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6a737d">// ÊõøÊç¢ÊóßÁöÑÊï∞ÁªÑ</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#6f42c1">setArray</span><span style="color:#24292e">(es);</span></span>
<span class="line"><span style="color:#24292e">        </span><span style="color:#d73a49">return</span><span style="color:#24292e"> </span><span style="color:#005cc5">true</span><span style="color:#24292e">;</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"><span style="color:#24292e">}</span></span></code></pre></div><blockquote><p>CopyOnWriteArraySetË∑ülistÁöÑÂå∫Âà´ÊòØsetÁöÑÂÖÉÁ¥†ÊòØÂîØ‰∏ÄÁöÑÔºåsetË∞ÉÁî®addÊñπÊ≥ïÊó∂È¶ñÂÖàË∞ÉÁî®addIfAbsentÊñπÊ≥ïÁúã‰Ω†ÁöÑËøô‰∏™ÂéüÁ¥†ÊúâÊ≤°ÊúâÔºåÊ≤°ÊúâÊâçÊ∑ªÂä†ÔºõCopyOnWriteArraySetÊòØÂèØ‰ª•ËØªËØªÂπ∂ÂèëÔºåËØªÂÜôÂπ∂ÂèëÔºåÂÜôÂÜôÊâçÈòªÂ°û</p><p>ËøôÈáåÁöÑÊ∫êÁ†ÅÁâàÊú¨ÊòØ Java 11ÔºåÂú® Java 1.8 ‰∏≠‰ΩøÁî®ÁöÑÊòØÂèØÈáçÂÖ•ÈîÅÔºàReentrantLockÔºâËÄå‰∏çÊòØ synchronized</p></blockquote><p>ÂÖ∂ÂÆÉËØªÊìç‰ΩúÂπ∂Êú™Âä†ÈîÅÔºå‰æãÂ¶ÇÔºö</p><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#f97583">public</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">void</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">forEach</span><span style="color:#e1e4e8">(Consumer</span><span style="color:#f97583">&lt;?</span><span style="color:#e1e4e8"> </span><span style="color:#79b8ff">super</span><span style="color:#e1e4e8"> E</span><span style="color:#f97583">&gt;</span><span style="color:#e1e4e8"> action) {</span></span>
<span class="line"><span style="color:#e1e4e8">    Objects.</span><span style="color:#b392f0">requireNonNull</span><span style="color:#e1e4e8">(action);</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#f97583">for</span><span style="color:#e1e4e8"> (Object x </span><span style="color:#f97583">:</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">getArray</span><span style="color:#e1e4e8">()) {</span></span>
<span class="line"><span style="color:#e1e4e8">        @</span><span style="color:#f97583">SuppressWarnings</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"unchecked"</span><span style="color:#e1e4e8">) E e </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> (E) x;</span></span>
<span class="line"><span style="color:#e1e4e8">        action.</span><span style="color:#b392f0">accept</span><span style="color:#e1e4e8">(e);</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"><span style="color:#e1e4e8">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#d73a49">public</span><span style="color:#24292e"> </span><span style="color:#d73a49">void</span><span style="color:#24292e"> </span><span style="color:#6f42c1">forEach</span><span style="color:#24292e">(Consumer</span><span style="color:#d73a49">&lt;?</span><span style="color:#24292e"> </span><span style="color:#005cc5">super</span><span style="color:#24292e"> E</span><span style="color:#d73a49">&gt;</span><span style="color:#24292e"> action) {</span></span>
<span class="line"><span style="color:#24292e">    Objects.</span><span style="color:#6f42c1">requireNonNull</span><span style="color:#24292e">(action);</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#d73a49">for</span><span style="color:#24292e"> (Object x </span><span style="color:#d73a49">:</span><span style="color:#24292e"> </span><span style="color:#6f42c1">getArray</span><span style="color:#24292e">()) {</span></span>
<span class="line"><span style="color:#24292e">        @</span><span style="color:#d73a49">SuppressWarnings</span><span style="color:#24292e">(</span><span style="color:#032f62">"unchecked"</span><span style="color:#24292e">) E e </span><span style="color:#d73a49">=</span><span style="color:#24292e"> (E) x;</span></span>
<span class="line"><span style="color:#24292e">        action.</span><span style="color:#6f42c1">accept</span><span style="color:#24292e">(e);</span></span>
<span class="line"><span style="color:#24292e">    }</span></span>
<span class="line"><span style="color:#24292e">}</span></span></code></pre></div><p>ÈÄÇÂêà„ÄéËØªÂ§öÂÜôÂ∞ë„ÄèÁöÑÂ∫îÁî®Âú∫ÊôØ</p><h4 id="get-Âº±‰∏ÄËá¥ÊÄß" tabindex="-1">get Âº±‰∏ÄËá¥ÊÄß <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20advanced%20chapter#get-Âº±‰∏ÄËá¥ÊÄß" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h4><figure><img src="https://jsd.cdn.zzko.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230720205728245.png" alt="image-20230720205728245" loading="lazy" decoding="async"></figure><figure><img src="https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230720205736316.png" alt="image-20230720205736316" loading="lazy" decoding="async"></figure><blockquote><p>‰∏çÂÆπÊòìÊµãËØïÔºå‰ΩÜÈóÆÈ¢òÁ°ÆÂÆûÂ≠òÂú®ÔºåThread-0ËøòÊòØÂèØ‰ª•ËØªÂèñÂà∞Â∞±Êï∞ÁªÑÁöÑ1ÔºåÂºïÁî®ËøòÊú™ÊîπÂèò</p></blockquote><h4 id="Ëø≠‰ª£Âô®Âº±‰∏ÄËá¥ÊÄß" tabindex="-1">Ëø≠‰ª£Âô®Âº±‰∏ÄËá¥ÊÄß <a aria-current="page" href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20advanced%20chapter#Ëø≠‰ª£Âô®Âº±‰∏ÄËá¥ÊÄß" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h4><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8">CopyOnWriteArrayList&lt;</span><span style="color:#f97583">Integer</span><span style="color:#e1e4e8">&gt; list </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> </span><span style="color:#f97583">new</span><span style="color:#e1e4e8"> CopyOnWriteArrayList&lt;&gt;();</span></span>
<span class="line"><span style="color:#e1e4e8">list.</span><span style="color:#b392f0">add</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">1</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">list.</span><span style="color:#b392f0">add</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">2</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">list.</span><span style="color:#b392f0">add</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">3</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">Iterator&lt;</span><span style="color:#f97583">Integer</span><span style="color:#e1e4e8">&gt; iter </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> list.</span><span style="color:#b392f0">iterator</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#f97583">new</span><span style="color:#e1e4e8"> </span><span style="color:#b392f0">Thread</span><span style="color:#e1e4e8">(() </span><span style="color:#f97583">-&gt;</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">//Âà†Èô§ÁöÑÊòØÊñ∞Êï∞ÁªÑ</span></span>
<span class="line"><span style="color:#e1e4e8">    list.</span><span style="color:#b392f0">remove</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">    System.out.</span><span style="color:#b392f0">println</span><span style="color:#e1e4e8">(list);</span></span>
<span class="line"><span style="color:#e1e4e8">}).</span><span style="color:#b392f0">start</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#b392f0">sleep1s</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#f97583">while</span><span style="color:#e1e4e8"> (iter.</span><span style="color:#b392f0">hasNext</span><span style="color:#e1e4e8">()) {</span></span>
<span class="line"><span style="color:#e1e4e8">    </span><span style="color:#6a737d">//‰∏ªÁ∫øÁ®ãÈÅçÂéÜÁöÑËøòÊòØÊú™Âà†Èô§ÁöÑÊóßÊï∞ÁªÑ</span></span>
<span class="line"><span style="color:#e1e4e8">	System.out.</span><span style="color:#b392f0">println</span><span style="color:#e1e4e8">(iter.</span><span style="color:#b392f0">next</span><span style="color:#e1e4e8">());</span></span>
<span class="line"><span style="color:#e1e4e8">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e">CopyOnWriteArrayList&lt;</span><span style="color:#d73a49">Integer</span><span style="color:#24292e">&gt; list </span><span style="color:#d73a49">=</span><span style="color:#24292e"> </span><span style="color:#d73a49">new</span><span style="color:#24292e"> CopyOnWriteArrayList&lt;&gt;();</span></span>
<span class="line"><span style="color:#24292e">list.</span><span style="color:#6f42c1">add</span><span style="color:#24292e">(</span><span style="color:#005cc5">1</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">list.</span><span style="color:#6f42c1">add</span><span style="color:#24292e">(</span><span style="color:#005cc5">2</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">list.</span><span style="color:#6f42c1">add</span><span style="color:#24292e">(</span><span style="color:#005cc5">3</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">Iterator&lt;</span><span style="color:#d73a49">Integer</span><span style="color:#24292e">&gt; iter </span><span style="color:#d73a49">=</span><span style="color:#24292e"> list.</span><span style="color:#6f42c1">iterator</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#d73a49">new</span><span style="color:#24292e"> </span><span style="color:#6f42c1">Thread</span><span style="color:#24292e">(() </span><span style="color:#d73a49">-&gt;</span><span style="color:#24292e"> {</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">//Âà†Èô§ÁöÑÊòØÊñ∞Êï∞ÁªÑ</span></span>
<span class="line"><span style="color:#24292e">    list.</span><span style="color:#6f42c1">remove</span><span style="color:#24292e">(</span><span style="color:#005cc5">0</span><span style="color:#24292e">);</span></span>
<span class="line"><span style="color:#24292e">    System.out.</span><span style="color:#6f42c1">println</span><span style="color:#24292e">(list);</span></span>
<span class="line"><span style="color:#24292e">}).</span><span style="color:#6f42c1">start</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#6f42c1">sleep1s</span><span style="color:#24292e">();</span></span>
<span class="line"><span style="color:#d73a49">while</span><span style="color:#24292e"> (iter.</span><span style="color:#6f42c1">hasNext</span><span style="color:#24292e">()) {</span></span>
<span class="line"><span style="color:#24292e">    </span><span style="color:#6a737d">//‰∏ªÁ∫øÁ®ãÈÅçÂéÜÁöÑËøòÊòØÊú™Âà†Èô§ÁöÑÊóßÊï∞ÁªÑ</span></span>
<span class="line"><span style="color:#24292e">	System.out.</span><span style="color:#6f42c1">println</span><span style="color:#24292e">(iter.</span><span style="color:#6f42c1">next</span><span style="color:#24292e">());</span></span>
<span class="line"><span style="color:#24292e">}</span></span></code></pre></div><blockquote><p>‰∏çË¶ÅËßâÂæóÂº±‰∏ÄËá¥ÊÄßÂ∞±‰∏çÂ•Ω</p><ul><li>Êï∞ÊçÆÂ∫ìÁöÑ MVCC ÈÉΩÊòØÂº±‰∏ÄËá¥ÊÄßÁöÑË°®Áé∞ÔºàMySQLÁöÑÂèØÈáçÂ§çÂ∫¶-&gt;MVCCÔºâ</li><li>Âπ∂ÂèëÈ´òÂíå‰∏ÄËá¥ÊÄßÊòØÁüõÁõæÁöÑÔºåÈúÄË¶ÅÊùÉË°°</li></ul></blockquote><!--]--><!--[--><!--]--><!--]--><!----><!----></article><!--]--><!--[--><!--[--><!--[--><div class="yun-sponsor-container flex-center flex-col" m="t-6"><button class="sponsor-button yun-icon-btn shadow hover:shadow-md" title="Â§öÂ∞ëÈÉΩÊòØÊîØÊåÅÔºÅ" text="red-400"><div i-ri-heart-line></div></button><div m="y-4" class="qrcode-container qrcode flex-center flex-col"><div class="sponsor-description" mb="4" text="sm">ËøôÊòØÂÖ≥‰∫éËµûÂä©ÁöÑ‰∏Ä‰∫õÊèèËø∞</div><div class="flex justify-around"><!--[--><a class="flex-center flex-col animate-iteration-1 animate-fade-in" href="https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/alipay.jpg" target="_blank" style="color:#00a3ee"><img class="sponsor-method-img" border="~ rounded" p="1" loading="lazy" src="https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/alipay.jpg" title="ÊîØ‰ªòÂÆù"><div text="xl" m="2" class="i-ri-alipay-line"></div></a><a class="flex-center flex-col animate-iteration-1 animate-fade-in" href="https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/wechat.png" target="_blank" style="color:#2dc100"><img class="sponsor-method-img" border="~ rounded" p="1" loading="lazy" src="https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/wechat.png" title="ÂæÆ‰ø°ÊîØ‰ªò"><div text="xl" m="2" class="i-ri-wechat-pay-line"></div></a><!--]--></div></div></div><ul class="post-copyright" m="y-4"><li class="post-copyright-author"><strong>Êú¨Êñá‰ΩúËÄÖÔºö</strong><span>imklaus</span></li><li class="post-copyright-link"><strong>Êú¨ÊñáÈìæÊé•Ôºö</strong><a href="https://imlklaus.github.io/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20advanced%20chapter" target="_blank" title="Êú¨ÊñáÈìæÊé•">https://imlklaus.github.io/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20advanced%20chapter</a></li><li class="post-copyright-license"><strong>ÁâàÊùÉÂ£∞ÊòéÔºö</strong><span>Êú¨ÂçöÂÆ¢ÊâÄÊúâÊñáÁ´†Èô§ÁâπÂà´Â£∞ÊòéÂ§ñÔºåÂùáÈªòËÆ§ÈááÁî® <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" target="_blank" rel="noopener" title="CC BY-NC-SA 4.0 ">CC BY-NC-SA</a> ËÆ∏ÂèØÂçèËÆÆ„ÄÇ</span></li></ul><!--]--><!--]--><!--]--></div><!--]--><!----></div><!--[--><!--]--><!--[--><div class="post-nav"><div class="post-nav-item"><a href="/posts/concurrent%20programming%20compilation%20edition%20-%20basic,%20synchronous,%20memory" class="post-nav-prev" title="Âπ∂ÂèëÁºñÁ®ãÊï¥ÁêÜÁâà-Âü∫Á°Ä/ÂêåÊ≠•/ÂÜÖÂ≠ò"><div class="icon" i-ri-arrow-left-s-line></div><span class="title truncate" text="sm">Âπ∂ÂèëÁºñÁ®ãÊï¥ÁêÜÁâà-Âü∫Á°Ä/ÂêåÊ≠•/ÂÜÖÂ≠ò</span></a></div><div class="post-nav-item"><a href="/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20intermediate%20level" class="post-nav-next" title="Ê∑±ÂÖ•Â≠¶‰π†JavaÂπ∂ÂèëÁºñÁ®ã-‰∏≠Á∫ßÁØá"><span class="title truncate" text="sm">Ê∑±ÂÖ•Â≠¶‰π†JavaÂπ∂ÂèëÁºñÁ®ã-‰∏≠Á∫ßÁØá</span><div class="icon" i-ri-arrow-right-s-line></div></a></div></div><!--]--><!--[--><!--]--><!--[--><div class="yun-card flex-center comment sm:p-6 lg:px-12 xl:px-16" flex="col" min-h="100px" bg="$va-c-bg-light" w="full" p="4"><!----><!----><!--[--><!----><!--]--><!----></div><!--]--><!--[--><!--]--><footer class="va-footer p-4 text-$va-c-text-light" text="center sm"><!----><div class="copyright flex justify-center items-center gap-2" p="1"><span>¬©<!----> 2023</span><a class="animate-pulse inline-flex" href="https://imlklaus.github.io/" target="_blank" title="ÂõûÂà∞È¶ñÈ°µ"><div class="i-ri-heart-line"></div></a><span>imklaus</span></div><div class="powered" m="2"><span>Áî± <a href="https://github.com/YunYouJun/valaxy" target="_blank" rel="noopener">Valaxy</a> v0.14.61 È©±Âä®</span> | <span>‰∏ªÈ¢ò - <a href="https://github.com/YunYouJun/valaxy/tree/main/packages/valaxy-theme-yun" title="valaxy-theme-yun" target="_blank">Yun</a> v0.14.61</span></div><div><div class="test" id="htmer_time"><span></span></div></div><!--[--><!--]--></footer><!--[--><!--]--></div><!--]--><!--[--><!--[--><button class="xl:hidden toc-btn shadow fixed yun-icon-btn z-350" opacity="75" right="2" bottom="19"><div i-ri-file-list-line></div></button><!----><!--  --><aside class="va-card yun-aside" m="l-4" text="center" overflow="auto"><div class="aside-container" flex="~ col"><h2 m="t-6 b-2" font="serif black">ÊñáÁ´†ÁõÆÂΩï</h2><div style="display:none" data-v-22b646a4><div class="content" data-v-22b646a4><div class="outline-title" data-v-22b646a4>On this page</div><div class="outline-marker" data-v-22b646a4></div><nav aria-labelledby="doc-outline-aria-label" data-v-22b646a4><span id="doc-outline-aria-label" class="visually-hidden" data-v-22b646a4>Table of Contents for current page</span><ul class="root va-toc relative z-1 css-i18n-toc" data-v-22b646a4 data-v-67cacb06><!--[--><!--]--></ul></nav></div></div><div class="flex-grow"></div><div class="custom-container"><!--[--><!--]--></div></div></aside><!--]--><!--]--></div></main><a href="#" class="back-to-top yun-icon-btn"><div w="8" h="8" i-ri-arrow-up-s-line></div><svg class="progress-circle-container" viewBox="0 0 100 100"><circle stroke-dasharray="301.59289474462014 301.59289474462014" stroke-dashoffset="301.59289474462014" class="progress-circle" cx="50" cy="50" r="48" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg></a><!--]--><!--]--></div><script>window.__INITIAL_STATE__='{"pinia":{"app":{"isSidebarOpen":false,"isRightSidebarOpen":false},"site":{}}}'</script><script type="application/ld+json" id="schema-org-graph" data-hid="3437552">{
  "@context": "https://schema.org",
  "@graph": [
    {
      "@id": "https://imlklaus.github.io/#identity",
      "@type": "Person",
      "name": "imklaus",
      "url": "https://imlklaus.github.io/",
      "image": {
        "@id": "https://imlklaus.github.io/#/schema/image/11067b0"
      },
      "sameAs": [
        "/atom.xml",
        "https://github.com/imLKlauS",
        "https://music.163.com/#/user/home?id=102158629",
        "https://space.bilibili.com/19430480",
        "https://t.me/elpsycn",
        "q1064779584@163.com",
        "https://www.travellings.cn/go.html"
      ]
    },
    {
      "@id": "https://imlklaus.github.io/#website",
      "@type": "WebSite",
      "dateModified": "2023-10-03T08:05:29.537Z",
      "datePublished": "2023-07-07T22:52:11.000Z",
      "inLanguage": "zh-CN",
      "name": "Ê∑±ÂÖ•Â≠¶‰π†JavaÂπ∂ÂèëÁºñÁ®ã-È´òÁ∫ßÁØá",
      "url": "https://imlklaus.github.io/",
      "publisher": {
        "@id": "https://imlklaus.github.io/#identity"
      }
    },
    {
      "@id": "https://imlklaus.github.io/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20advanced%20chapter/#webpage",
      "@type": "WebPage",
      "description": true,
      "name": "Ê∑±ÂÖ•Â≠¶‰π†JavaÂπ∂ÂèëÁºñÁ®ã-È´òÁ∫ßÁØá",
      "url": "https://imlklaus.github.io/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20advanced%20chapter",
      "about": {
        "@id": "https://imlklaus.github.io/#identity"
      },
      "isPartOf": {
        "@id": "https://imlklaus.github.io/#website"
      },
      "potentialAction": [
        {
          "@type": "ReadAction",
          "target": [
            "https://imlklaus.github.io/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20advanced%20chapter"
          ]
        }
      ]
    },
    {
      "@id": "https://imlklaus.github.io/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20advanced%20chapter/#article",
      "description": true,
      "headline": "Ê∑±ÂÖ•Â≠¶‰π†JavaÂπ∂ÂèëÁºñÁ®ã-È´òÁ∫ßÁØá",
      "inLanguage": "zh-CN",
      "thumbnailUrl": "https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/wallhaven-j52r8w_1920x1080.png",
      "@type": [
        "Article",
        "BlogPosting"
      ],
      "author": {
        "@id": "https://imlklaus.github.io/#/schema/person/45376ff"
      },
      "image": {
        "@id": "https://imlklaus.github.io/#/schema/image/7437fe4"
      },
      "isPartOf": {
        "@id": "https://imlklaus.github.io/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20advanced%20chapter/#webpage"
      },
      "mainEntityOfPage": {
        "@id": "https://imlklaus.github.io/posts/deep%20study%20of%20java%20concurrent%20programming%20-%20advanced%20chapter/#webpage"
      },
      "publisher": {
        "@id": "https://imlklaus.github.io/#identity"
      }
    },
    {
      "@id": "https://imlklaus.github.io/#/schema/person/45376ff",
      "@type": "Person",
      "name": "imklaus",
      "url": "https://valaxy.site"
    },
    {
      "@id": "https://imlklaus.github.io/#/schema/image/11067b0",
      "@type": "ImageObject",
      "contentUrl": "https://imlklaus.github.io/images/avatar.jpg",
      "inLanguage": "zh-CN",
      "url": "https://imlklaus.github.io/images/avatar.jpg"
    },
    {
      "@id": "https://imlklaus.github.io/#/schema/image/7437fe4",
      "@type": "ImageObject",
      "contentUrl": "https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/wallhaven-j52r8w_1920x1080.png",
      "inLanguage": "zh-CN",
      "url": "https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/wallhaven-j52r8w_1920x1080.png"
    }
  ]
}</script><link rel="stylesheet" href="/assets/index-e381b313.css"></body></html>